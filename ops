#!/bin/bash

# MonoPilot Ops CLI
# Unified validation and maintenance scripts for code quality gates.
# Context-aware validation - run only when modifying relevant file types.

set -e

function show_help {
    echo -e "\033[1;34mMonoPilot Ops CLI\033[0m"
    echo "Usage: ./ops [command]"
    echo ""
    echo "Commands:"
    echo -e "  \033[1;32mcheck\033[0m      Run full project validation (Docs + TypeScript)."
    echo "             Run when modifying .ts/.tsx files before completing work."
    echo "             Skip for docs-only (.md) or config-only (.json/.yaml) changes."
    echo -e "  \033[1;32manalyze\033[0m    Analyze token usage and context budget."
    echo -e "  \033[1;32mfix\033[0m        Run linting and auto-fixes."
    echo -e "  \033[1;32mdb:seed\033[0m    Seed the database with E2E test data."
    echo -e "  \033[1;32mdb:verify\033[0m  Verify database connection and schema."
    echo ""
    echo -e "\033[1;34mE2E Test Helpers:\033[0m"
    echo -e "  \033[1;32me2e:scaffold\033[0m <module/feature> <type> - Generate E2E test template"
    echo -e "  \033[1;32me2e:extract-selectors\033[0m <file>       - Extract testable selectors from component"
    echo -e "  \033[1;32me2e:detect-type\033[0m <file>            - Auto-detect test type (crud/form/flow/auth)"
    echo -e "  \033[1;32me2e:run\033[0m <module>                  - Run E2E tests for module"
    echo ""
    echo "Agent Guidelines:"
    echo "  - Code changes (.ts/.tsx): Run './ops check' before completing"
    echo "  - Docs only (.md): Skip './ops check'"
    echo "  - Tests (.spec.ts): Run test suite instead of './ops check'"
    echo "  - Config only (.json/.yaml): Skip './ops check'"
    echo ""
}

COMMAND=$1

case "$COMMAND" in
    check)
        echo -e "\n\033[1;34müîç Running Pre-Commit/Task Validation...\033[0m"
        
        echo -e "\n\033[1;36m1. Validating Documentation & Structure...\033[0m"
        bash scripts/validate-docs.sh
        
        echo -e "\n\033[1;36m2. Checking TypeScript Status...\033[0m"
        bash scripts/type-check-status.sh
        
        echo -e "\n\033[1;32m‚úÖ All Checks Passed. You are ready to commit/finish.\033[0m"
        ;;
        
    analyze)
        echo -e "\n\033[1;34müìä Analyzing Project Context...\033[0m"
        bash scripts/token-counter.sh --verbose
        ;;
        
    fix)
        echo -e "\n\033[1;34müîß Running Auto-Fixes...\033[0m"
        echo "Running lint fix..."
        cd apps/frontend && pnpm lint --fix
        echo -e "\n\033[1;32m‚úÖ Fixes applied.\033[0m"
        ;;
        
    db:seed)
        echo -e "\n\033[1;34müå± Seeding E2E Data...\033[0m"
        npx ts-node scripts/seed-e2e-test-data.ts
        ;;
        
    db:verify)
        echo -e "\n\033[1;34müêò Verifying Database...\033[0m"
        # Using a simple check script if available, or just listing tables as a check
        if [ -f "scripts/check-tables.mjs" ]; then
            node scripts/check-tables.mjs
        else
           echo "Verification script not found."
        fi
        ;;

    e2e:extract-selectors)
        echo -e "\n\033[1;34müîç Extracting Selectors...\033[0m"
        bash scripts/extract-selectors.sh "$2"
        ;;

    e2e:detect-type)
        echo -e "\n\033[1;34mü§ñ Detecting Test Type...\033[0m"
        bash scripts/detect-test-type.sh "$2"
        ;;

    e2e:scaffold)
        echo -e "\n\033[1;34müìù Scaffolding E2E Test...\033[0m"
        pnpm test:gen "$2" "$3" "${@:4}"
        ;;

    e2e:run)
        echo -e "\n\033[1;34müß™ Running E2E Tests...\033[0m"
        pnpm test:e2e "e2e/tests/$2" "${@:3}"
        ;;

    *)
        show_help
        exit 1
        ;;
esac
