# Handoff: 02.16 Product Advanced Features - Backend

## Story
4 features: Image upload, Product clone, Barcode generation, Categories + Tags.

## Tests to Make Pass
- `apps/frontend/lib/services/__tests__/product-clone-service.test.ts` (38 tests, RED)

## Files to Create

### Migrations
1. `supabase/migrations/XXX_product_images.sql` - product_images table
2. `supabase/migrations/XXX_product_categories.sql` - product_categories table (hierarchical, 3 levels max)
3. `supabase/migrations/XXX_product_tags.sql` - product_tags + product_tag_assignments tables
4. `supabase/migrations/XXX_products_extension.sql` - Add category_id, barcode_url to products

### Services (all in `apps/frontend/lib/services/`)
1. `product-clone-service.ts` - clone(), generateSuggestedCode(), validateCloneCode()
2. `product-image-service.ts` - upload(), getByProductId(), delete(), generateThumbnail()
3. `barcode-service.ts` - generate(), validate() (Code128, EAN-13)
4. `product-category-service.ts` - list(), getTree(), create(), update(), delete()
5. `product-tag-service.ts` - list(), create(), update(), delete(), assignToProduct(), getByProductId()

### Validation
- `apps/frontend/lib/validation/product-advanced.ts` - Zod schemas for clone, barcode, category, tag

### API Routes
- `apps/frontend/app/api/technical/products/[id]/clone/route.ts` (POST)
- `apps/frontend/app/api/technical/products/[id]/image/route.ts` (POST, GET, DELETE)
- `apps/frontend/app/api/technical/products/[id]/barcode/route.ts` (POST, GET)
- `apps/frontend/app/api/technical/product-categories/route.ts` (GET, POST)
- `apps/frontend/app/api/technical/product-categories/[id]/route.ts` (GET, PUT, DELETE)
- `apps/frontend/app/api/technical/product-tags/route.ts` (GET, POST)
- `apps/frontend/app/api/technical/product-tags/[id]/route.ts` (PUT, DELETE)

## Key Business Rules
- Clone: always version=1, SKU uniqueness, -COPY suffix suggestion
- Image: max 5MB, JPG/PNG/WebP only, auto-thumbnail 200x200
- Barcode: Code128 (any string), EAN-13 (13 digits with valid check digit)
- Categories: max 3 levels deep, cannot delete with children or products
- Tags: max 50 chars, many-to-many via product_tag_assignments

## RLS
- All tables: `org_id = (SELECT org_id FROM users WHERE id = auth.uid())`
- product_tag_assignments: via products.org_id join
