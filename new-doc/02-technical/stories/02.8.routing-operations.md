# 02.8 - Routing Operations (Steps) Management

**Priority**: P0 (MVP)
**Story Points**: L (complex - many operation fields, reordering, parallel operations)
**Type**: full-stack

**State:** ready
**Primary PRD:** `docs/1-BASELINE/product/modules/technical.md` (FR-2.41, FR-2.43, FR-2.44, FR-2.45, FR-2.48)
**UX Wireframes:** TEC-008a (Routing Detail), TEC-008 (Routing Modal - for context)

## Goal

Implement complete routing operations (production steps) management including CRUD operations, sequence numbering with parallel operation support, setup/run/cleanup times, work center assignment, operation instructions, and file attachments. This is the core production workflow definition that determines how products are manufactured.

## MVP Scope

This story implements Phase 0 (MVP) functionality only. Features listed in "Future Phases" are deferred to Phase 1+ and should be handled per Epic 02.0 "Future Feature Handling" guidance (hide completely or show as "Coming Soon").

## Scope

**In scope**
- GET /api/technical/routings/:id/operations (list all operations for a routing)
- POST /api/technical/routings/:id/operations (add operation to routing)
- PUT /api/technical/routings/:id/operations/:opId (update operation)
- DELETE /api/technical/routings/:id/operations/:opId (remove operation)
- PATCH /api/technical/routings/:id/operations/:opId/reorder (move up/down)
- **POST /api/technical/routings/:id/operations/:opId/attachments (upload attachment - FR-2.45)**
- **DELETE /api/technical/routings/:id/operations/:opId/attachments/:attachId (remove attachment - FR-2.45)**
- Operations table with inline actions (edit, delete, reorder arrows)
- Add/Edit operation modal with all fields
- Operation fields: sequence, name, description, machine_id, setup_time, duration, cleanup_time, labor_cost_per_hour, instructions
- **Operation attachments for work instructions (PDFs, images, documents - FR-2.45)**
- Sequence management with parallel operations support (FR-2.48)
- Auto-suggest next sequence number
- Up/Down reordering with sequence swapping
- Work center (machine) dropdown from machines table (OPTIONAL - graceful empty state)
- Cost & duration summary panel with expandable breakdown
- Related BOMs section showing routing usage

## Future Phases (Not in MVP)

### Phase 1
- Drag-and-drop reordering - Visual drag interface for operation sequencing
- Operation templates - Save operations as reusable templates
- Bulk operation import - Import multiple operations from CSV/Excel

### Phase 2
- Machine utilization tracking - Track actual vs planned machine usage
- Operation dependencies/sequencing - Complex dependencies beyond parallel ops
- Time tracking analytics - Historical operation duration analysis
- Gantt chart visualization - Visual timeline of operations
- Resource conflict detection - Warn about machine scheduling conflicts

**Implementation**: See Epic 02.0 "Future Feature Handling" for how to handle these in UI/API.

## Dependencies

### Cross-Epic Dependencies
- **02.7** - Routings CRUD (routings table must exist)
- **01.1** - Org Context + Base RLS (organizations, users tables)

### Optional Dependencies
- **Machines table** (from Settings Phase 1B - Infrastructure)
  - `machine_id` FK is NULLABLE - operations work without machine assignment
  - UI shows empty dropdown if no machines exist with message: "No machines configured. Go to Settings > Infrastructure to add machines."
  - Most food manufacturing SMBs don't track machine-level operations initially

### Migration Dependencies
- **Migration 044** - Added routing_operations.cleanup_time and instructions fields
- **Migration 050** - Removed unique sequence constraint (allows parallel operations)

## Acceptance Criteria (Given/When/Then)

### Operations List (TEC-008a)
- GIVEN user navigates to routing detail `/technical/routings/:id`, WHEN operations section loads, THEN operations display in sequence order within 500ms for up to 50 operations.
- GIVEN routing has 10 operations, WHEN operations table renders, THEN each row shows: sequence, name, machine name, duration (min), setup time (min), yield%, labor cost/hr, and action buttons.
- GIVEN operations table displayed, WHEN sequence numbers contain duplicates (parallel ops), THEN "(Parallel)" indicator appends to operation name.
- GIVEN routing has operations, WHEN summary panel renders, THEN displays: total operations count, total duration (formatted as "Xh Ym"), total setup time, total cleanup time, total labor cost, average yield.
- GIVEN user clicks "[i View Breakdown]", WHEN panel expands, THEN per-operation breakdown displays with individual times and costs.

### Add Operation
- GIVEN user clicks "[+ Add Operation]", WHEN modal opens, THEN form displays: sequence (auto-filled), name, description, machine dropdown, duration, setup_time, cleanup_time, yield%, instructions textarea, labor_cost_per_hour.
- GIVEN routing has operations with sequences 1, 2, 3, WHEN add modal opens, THEN sequence field auto-fills with "4" (max + 1).
- GIVEN user enters sequence "2" which already exists, WHEN typing completes, THEN info message shows "[i] Sequence 2 is already used by 'Proofing'. This operation will run in parallel." (NOT blocking error).
- GIVEN valid operation data (sequence=4, name="Cooling", duration=20), WHEN "Add Operation" clicked, THEN operation created, modal closes, table refreshes, toast shows success.
- GIVEN user enters name with fewer than 3 characters, WHEN save attempted, THEN error "Name must be at least 3 characters" displays inline.

### Edit Operation
- GIVEN user clicks [Edit] on existing operation, WHEN modal opens, THEN form pre-populates with current operation data including instructions.
- GIVEN user changes duration from 30 to 45, WHEN save completes, THEN updated duration displays immediately in operations table and summary recalculates.
- GIVEN user edits instructions text to 2001 characters, WHEN save attempted, THEN error "Instructions must be less than 2000 characters" displays.
- GIVEN user assigns machine from "None" to "Mixer-01", WHEN save completes, THEN machine column shows "Mixer-01".

### Delete Operation
- GIVEN user clicks [Del] on operation, WHEN confirmation dialog shows, THEN message reads "Delete operation 'Mixing'? This action cannot be undone."
- GIVEN user confirms delete, WHEN deletion completes, THEN operation removed from table within 500ms and summary recalculates.
- GIVEN user cancels delete, WHEN dialog dismissed, THEN operation remains unchanged.

### Reorder Operations (Up/Down)
- GIVEN operation at sequence 2, WHEN user clicks [^] (move up), THEN operation swaps sequence with operation at sequence 1.
- GIVEN operation at sequence 1 (first), WHEN [^] button rendered, THEN button is disabled.
- GIVEN operation at max sequence (last), WHEN [v] button rendered, THEN button is disabled.
- GIVEN reorder completes, WHEN table refreshes, THEN no toast shown (instant visual feedback sufficient).
- GIVEN parallel operations at sequence 2 (two operations), WHEN one is moved up, THEN ONLY that operation swaps with sequence 1 (other parallel op remains at 2).

### Parallel Operations (FR-2.48 - Simple Version)
- GIVEN user creates operation with sequence 2 where sequence 2 already exists, WHEN save completes, THEN both operations have sequence 2 (parallel execution).
- GIVEN operations table has two ops at sequence 2, WHEN table renders, THEN both show "(Parallel)" suffix: "Proofing (Parallel)", "Heating (Parallel)".
- GIVEN parallel operations exist, WHEN total duration calculated, THEN parallel ops use MAX duration (not SUM).
- GIVEN parallel operations exist, WHEN total cost calculated, THEN parallel ops SUM their costs (all incur cost, even if running simultaneously).

### Time Tracking (FR-2.43)
- GIVEN user enters setup_time=5, duration=30, cleanup_time=3, WHEN operation saved, THEN total operation time = 38 minutes.
- GIVEN cleanup_time field left empty, WHEN operation saved, THEN cleanup_time defaults to 0.
- GIVEN user enters negative setup_time, WHEN validation runs, THEN error "Setup time cannot be negative" displays.

### Machine Assignment (FR-2.44) - Optional

**GIVEN** user opens operation modal
**WHEN** machines table is empty (no machines configured)
**THEN** machine dropdown shows:
  - Empty state: "No machines configured"
  - Link: "Add machines in Settings"
  - Option: "None/Skip" (saves machine_id as NULL)

**GIVEN** user opens operation modal
**WHEN** machines table has entries
**THEN** machine dropdown shows:
  - "None/Clear" option (machine_id = NULL)
  - List of machines: "{machine_code} - {machine_name}"
  - Machine select saves machine_id FK

**Validation**:
- machine_id is NULLABLE (NULL = operation not assigned to specific machine)
- If machine_id provided, must exist in machines table (FK constraint)

### Operation Instructions (FR-2.45)
- GIVEN user opens operation modal, WHEN instructions field visible, THEN textarea shows placeholder and max 2000 chars help text.
- GIVEN user enters 1500 characters of instructions, WHEN operation saved, THEN instructions stored and retrievable on edit.
- GIVEN operation has instructions, WHEN view mode (read-only), THEN instructions display with proper formatting.

### Operation Attachments (FR-2.45)
- GIVEN user opens operation modal, WHEN attachments section visible, THEN upload area shows "Drop files or click to upload" with accepted formats (PDF, PNG, JPG, DOCX).
- GIVEN user clicks upload area, WHEN file picker opens, THEN only allowed file types can be selected.
- GIVEN user selects a 5MB PDF file, WHEN upload completes, THEN file appears in attachments list with name, size, and delete button.
- GIVEN user attempts to upload a 15MB file, WHEN validation runs, THEN error "File size must be less than 10MB" displays.
- GIVEN operation has 3 attachments, WHEN attachments section renders, THEN all files display with download links.
- GIVEN user clicks delete on attachment, WHEN confirmation accepted, THEN attachment removed from list and storage.
- GIVEN user clicks attachment name, WHEN clicked, THEN file opens in new tab (PDF) or downloads (other types).
- GIVEN operation has attachments, WHEN viewing operations table, THEN attachment count badge shows (e.g., "3 files").
- GIVEN maximum 5 attachments per operation, WHEN user tries to add 6th, THEN error "Maximum 5 attachments per operation" displays.

### Cost Summary Panel
- GIVEN routing has 4 operations with labor costs, WHEN summary panel renders, THEN "Total Labor Cost" shows SUM of all operation costs.
- GIVEN operation has labor_cost_per_hour=15 and total_time=60 minutes, WHEN operation cost calculated, THEN displays $15.00 (1 hour x $15/hr).
- GIVEN user expands breakdown, WHEN breakdown visible, THEN shows per-operation: "Mixing: $12.00 (45 min x $16/hr + setup)".

### Related BOMs Section
- GIVEN routing is used by 3 BOMs, WHEN related BOMs section renders, THEN shows list: "PRD-BREAD-01 (White Bread) v1.0", etc.
- GIVEN routing not used by any BOMs, WHEN section renders, THEN shows "Not used yet".
- GIVEN routing used by >5 BOMs, WHEN section renders, THEN shows first 5 with "[View All BOMs ->]" link.

### Empty State
- GIVEN routing has no operations, WHEN operations section renders, THEN empty state shows clipboard icon, "No operations yet", and "[+ Add First Operation]" button.
- GIVEN empty state displayed, WHEN help banner shown, THEN example: "1. Mixing (15 min) -> 2. Proofing (45 min) -> 3. Baking (30 min)".

### Permission Enforcement
- GIVEN user without technical write permission, WHEN routing detail loaded, THEN "[+ Add Operation]", [Edit], [Del] buttons hidden.
- GIVEN user with technical read-only permission, WHEN page displayed, THEN view-only mode (no edit controls).

### AC-8.1: Future Features Handling

**GIVEN** user is viewing operations table, add/edit modal, or routing detail
**WHEN** MVP is active (Phase 0)
**THEN** the following Phase 1+ features are HIDDEN:
  - Drag-and-drop reordering (Phase 1) - use arrows instead
  - "Save as Template" button (Phase 1)
  - "Import Operations" button (Phase 1)
  - Machine utilization indicators (Phase 2)
  - Time tracking analytics charts (Phase 2)
  - Gantt chart view toggle (Phase 2)

**Developer Note**:
- Hide these features completely (recommended)
- OR show as "Coming Soon" with disabled state
- See Epic 02.0 "Future Feature Handling" for implementation pattern

**Code Comment Pattern**:
```typescript
{/* Phase 1: Drag-and-drop reordering
<DragDropContext onDragEnd={handleDragEnd}>
  ...
</DragDropContext>
*/}

{/* Phase 1: Operation Templates
<Button>Save as Template</Button>
*/}

{/* Phase 2: Machine Utilization
<MachineUtilizationBadge machineId={op.machine_id} />
*/}

{/* Phase 2: Gantt View
<Button onClick={() => setViewMode('gantt')}>Gantt View</Button>
*/}
```

## Implementation Notes

### API Endpoints

```typescript
// GET /api/technical/routings/:id
// Returns routing header + operations + related BOMs
interface RoutingDetailResponse {
  routing: {
    id: string;
    org_id: string;
    code: string;
    name: string;
    description: string | null;
    status: "Active" | "Inactive";
    is_reusable: boolean;
    version: number;
    setup_cost: number;
    working_cost_per_unit: number;
    overhead_percent: number;
    currency: string;
    created_at: string;
    updated_at: string;
  };
  operations: RoutingOperation[];
  related_boms: RelatedBOM[];
  summary: OperationsSummary;
}

// GET /api/technical/routings/:id/operations
interface OperationsListResponse {
  operations: RoutingOperation[];
  summary: OperationsSummary;
}

interface RoutingOperation {
  id: string;
  routing_id: string;
  sequence: number;
  name: string;
  description: string | null;
  machine_id: string | null;
  machine_name: string | null;  // Joined from machines table
  setup_time: number;           // minutes, default 0
  duration: number;             // minutes, required
  cleanup_time: number;         // minutes, default 0
  labor_cost_per_hour: number;  // decimal, default 0
  instructions: string | null;  // max 2000 chars
  attachments: OperationAttachment[]; // FR-2.45
  attachment_count: number;     // FR-2.45
  created_at: string;
  updated_at: string;
}

// FR-2.45: Operation attachments
interface OperationAttachment {
  id: string;
  operation_id: string;
  file_name: string;
  file_type: string;            // 'pdf', 'png', 'jpg', 'docx'
  file_size: number;            // bytes
  storage_path: string;         // Supabase storage path
  uploaded_by: string;
  uploaded_at: string;
}

interface OperationsSummary {
  total_operations: number;
  total_duration: number;       // minutes (considers parallel ops: MAX per sequence)
  total_setup_time: number;     // minutes
  total_cleanup_time: number;   // minutes
  total_labor_cost: number;     // decimal (SUM all ops, even parallel)
  average_yield: number;        // weighted by duration
}

interface RelatedBOM {
  id: string;
  product_code: string;
  product_name: string;
  version: string;
}

// POST /api/technical/routings/:id/operations
interface CreateOperationRequest {
  sequence: number;               // Required, can duplicate for parallel
  name: string;                   // Required, 3-100 chars
  description?: string | null;    // Optional, max 500 chars
  machine_id?: string | null;     // Optional, FK to machines (NULLABLE)
  setup_time?: number;            // Optional, default 0
  duration: number;               // Required, positive integer
  cleanup_time?: number;          // Optional, default 0
  labor_cost_per_hour?: number;   // Optional, default 0
  instructions?: string | null;   // Optional, max 2000 chars
}

// PUT /api/technical/routings/:id/operations/:opId
interface UpdateOperationRequest {
  sequence?: number;
  name?: string;
  description?: string | null;
  machine_id?: string | null;
  setup_time?: number;
  duration?: number;
  cleanup_time?: number;
  labor_cost_per_hour?: number;
  instructions?: string | null;
}

// DELETE /api/technical/routings/:id/operations/:opId
// Returns { success: true, message: "Operation deleted" }
// Also deletes all attachments from storage

// PATCH /api/technical/routings/:id/operations/:opId/reorder
interface ReorderRequest {
  direction: "up" | "down";
}
interface ReorderResponse {
  success: true;
  updated_operations: Array<{ id: string; sequence: number }>;
}

// POST /api/technical/routings/:id/operations/:opId/attachments (FR-2.45)
// Content-Type: multipart/form-data
// Body: { file: File }
interface UploadAttachmentResponse {
  attachment: OperationAttachment;
}

// GET /api/technical/routings/:id/operations/:opId/attachments/:attachId/download (FR-2.45)
// Returns: signed URL for file download

// DELETE /api/technical/routings/:id/operations/:opId/attachments/:attachId (FR-2.45)
// Returns: { success: true }
```

### Database

#### routing_operations table (existing, enhanced by migrations 044, 050)
```sql
routing_operations:
  id UUID PRIMARY KEY,
  routing_id UUID NOT NULL REFERENCES routings(id) ON DELETE CASCADE,
  sequence INTEGER NOT NULL,
  name TEXT NOT NULL,
  description TEXT,
  machine_id UUID REFERENCES machines(id),  -- NULLABLE - operations work without machines
  setup_time INTEGER DEFAULT 0,       -- minutes
  duration INTEGER NOT NULL,          -- minutes
  cleanup_time INTEGER DEFAULT 0,     -- minutes (migration 044)
  labor_cost_per_hour DECIMAL(15,4) DEFAULT 0,
  instructions TEXT,                  -- max 2000 chars (migration 044)
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()

-- NOTE: UNIQUE(routing_id, sequence) removed by migration 050
-- Allows duplicate sequences for parallel operations

-- NOTE: machine_id FK is NULLABLE
-- If machines table is empty, operations still work (machine_id = NULL)
```

#### operation_attachments table (FR-2.45 - new migration required)
```sql
-- New table for operation attachments
CREATE TABLE operation_attachments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id),
  operation_id UUID NOT NULL REFERENCES routing_operations(id) ON DELETE CASCADE,
  file_name TEXT NOT NULL,
  file_type TEXT NOT NULL CHECK (file_type IN ('pdf', 'png', 'jpg', 'jpeg', 'docx')),
  file_size INTEGER NOT NULL CHECK (file_size > 0 AND file_size <= 10485760), -- 10MB max
  storage_path TEXT NOT NULL,
  uploaded_by UUID REFERENCES users(id),
  uploaded_at TIMESTAMPTZ DEFAULT NOW()
);

-- Indexes
CREATE INDEX idx_operation_attachments_operation ON operation_attachments(operation_id);

-- RLS Policy
ALTER TABLE operation_attachments ENABLE ROW LEVEL SECURITY;

CREATE POLICY "operation_attachments_org_isolation"
ON operation_attachments FOR ALL
USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

-- Limit attachments per operation (max 5)
CREATE OR REPLACE FUNCTION check_attachment_limit()
RETURNS TRIGGER AS $$
BEGIN
  IF (SELECT COUNT(*) FROM operation_attachments WHERE operation_id = NEW.operation_id) >= 5 THEN
    RAISE EXCEPTION 'Maximum 5 attachments per operation';
  END IF;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER attachment_limit_check
BEFORE INSERT ON operation_attachments
FOR EACH ROW EXECUTE FUNCTION check_attachment_limit();
```

### Supabase Storage Configuration (FR-2.45)

```typescript
// Storage bucket for operation attachments
const BUCKET_NAME = 'operation-attachments';

// Allowed MIME types
const ALLOWED_TYPES = [
  'application/pdf',
  'image/png',
  'image/jpeg',
  'application/vnd.openxmlformats-officedocument.wordprocessingml.document'
];

// File size limit
const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB

// Storage path pattern: {org_id}/{routing_id}/{operation_id}/{file_name}
function getStoragePath(orgId: string, routingId: string, operationId: string, fileName: string): string {
  const timestamp = Date.now();
  const sanitizedName = fileName.replace(/[^a-zA-Z0-9.-]/g, '_');
  return `${orgId}/${routingId}/${operationId}/${timestamp}_${sanitizedName}`;
}
```

### Frontend Components

```
app/(authenticated)/technical/routings/[id]/page.tsx  -- Routing detail page (TEC-008a)
components/technical/routings/
  RoutingDetailHeader.tsx       -- Routing header info (read-only)
  OperationsTable.tsx           -- Operations table with actions
  OperationRow.tsx              -- Single operation row
  OperationModal.tsx            -- Add/Edit operation modal
  OperationsSummaryPanel.tsx    -- Cost & duration summary
  RelatedBOMsSection.tsx        -- BOMs using this routing
  OperationsEmptyState.tsx      -- Empty state with example
  OperationAttachments.tsx      -- Attachments section in modal (FR-2.45)
  AttachmentUpload.tsx          -- File upload component (FR-2.45)
  AttachmentList.tsx            -- List of attachments with actions (FR-2.45)
  MachineDropdown.tsx           -- Machine selector with empty state handling
```

### Services

```typescript
// lib/services/routing-operations-service.ts
export async function getRoutingWithOperations(routingId: string): Promise<RoutingDetailResponse>
export async function getOperations(routingId: string): Promise<OperationsListResponse>
export async function createOperation(routingId: string, data: CreateOperationRequest): Promise<RoutingOperation>
export async function updateOperation(routingId: string, opId: string, data: UpdateOperationRequest): Promise<RoutingOperation>
export async function deleteOperation(routingId: string, opId: string): Promise<void>
export async function reorderOperation(routingId: string, opId: string, direction: "up" | "down"): Promise<ReorderResponse>
export async function getNextSequence(routingId: string): Promise<number>
export function calculateSummary(operations: RoutingOperation[]): OperationsSummary
export function detectParallelOperations(operations: RoutingOperation[]): Map<number, string[]>

// FR-2.45: Attachment operations
export async function uploadAttachment(routingId: string, opId: string, file: File): Promise<OperationAttachment>
export async function deleteAttachment(routingId: string, opId: string, attachId: string): Promise<void>
export async function getAttachmentDownloadUrl(routingId: string, opId: string, attachId: string): Promise<string>
export async function getAttachments(operationId: string): Promise<OperationAttachment[]>

// Machine availability check
export async function getMachinesForDropdown(): Promise<Machine[]>
export async function hasMachinesConfigured(): Promise<boolean>
```

### Validation (Zod)

```typescript
const operationFormSchema = z.object({
  sequence: z.number()
    .int("Sequence must be an integer")
    .min(1, "Sequence must be at least 1"),
  name: z.string()
    .min(3, "Name must be at least 3 characters")
    .max(100, "Name must be less than 100 characters"),
  description: z.string()
    .max(500, "Description must be less than 500 characters")
    .nullable()
    .optional(),
  machine_id: z.string().uuid().nullable().optional(), // NULLABLE - works without machines
  setup_time: z.number()
    .int("Setup time must be an integer")
    .min(0, "Setup time cannot be negative")
    .default(0),
  duration: z.number()
    .int("Duration must be an integer")
    .min(1, "Duration must be at least 1 minute"),
  cleanup_time: z.number()
    .int("Cleanup time must be an integer")
    .min(0, "Cleanup time cannot be negative")
    .default(0),
  labor_cost_per_hour: z.number()
    .min(0, "Labor cost cannot be negative")
    .default(0),
  instructions: z.string()
    .max(2000, "Instructions must be less than 2000 characters")
    .nullable()
    .optional(),
});

// FR-2.45: Attachment validation
const ALLOWED_TYPES = ['application/pdf', 'image/png', 'image/jpeg', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'];

const attachmentSchema = z.object({
  file: z.instanceof(File)
    .refine(file => file.size <= 10 * 1024 * 1024, "File size must be less than 10MB")
    .refine(file => ALLOWED_TYPES.includes(file.type), "File type not allowed (PDF, PNG, JPG, DOCX only)"),
});
```

### Key Business Rules

1. **Sequence numbering**: Sequences can be duplicated (parallel operations - FR-2.48)
2. **Parallel operations**: Same sequence = run simultaneously
3. **Duration calculation**: For parallel ops, use MAX duration per sequence group
4. **Cost calculation**: Sum ALL operation costs (parallel ops both incur cost)
5. **Total operation time**: setup_time + duration + cleanup_time
6. **Auto-sequence**: New operations default to max(sequences) + 1
7. **Reorder logic**: Swap sequences between adjacent operations
8. **Machine optional**: Operations can run without assigned machine/work center (NULLABLE FK)
9. **Instructions limit**: Max 2000 characters for operator instructions
10. **Attachments limit**: Max 5 files per operation, 10MB each (FR-2.45)
11. **Attachment types**: PDF, PNG, JPG, DOCX only (FR-2.45)
12. **Attachment cleanup**: Delete from storage when operation deleted (FR-2.45)

### Parallel Operations Detection

```typescript
// Detect and mark parallel operations
const detectParallelOperations = (operations: RoutingOperation[]) => {
  const sequenceCounts = operations.reduce((acc, op) => {
    acc[op.sequence] = (acc[op.sequence] || 0) + 1;
    return acc;
  }, {} as Record<number, number>);

  return operations.map(op => ({
    ...op,
    isParallel: sequenceCounts[op.sequence] > 1,
    displayName: sequenceCounts[op.sequence] > 1
      ? `${op.name} (Parallel)`
      : op.name
  }));
};
```

### Duration Calculation with Parallel Ops

```typescript
const calculateTotalDuration = (operations: RoutingOperation[]) => {
  // Group by sequence
  const grouped = operations.reduce((acc, op) => {
    if (!acc[op.sequence]) acc[op.sequence] = [];
    acc[op.sequence].push(op);
    return acc;
  }, {} as Record<number, RoutingOperation[]>);

  // For each sequence group, take MAX total time
  return Object.values(grouped).reduce((total, group) => {
    const maxTime = Math.max(...group.map(op =>
      op.setup_time + op.duration + op.cleanup_time
    ));
    return total + maxTime;
  }, 0);
};
```

### Machine Dropdown with Empty State Handling

```tsx
// components/technical/routings/MachineDropdown.tsx
interface MachineDropdownProps {
  value: string | null;
  onChange: (machineId: string | null) => void;
}

export function MachineDropdown({ value, onChange }: MachineDropdownProps) {
  const { data: machines, isLoading } = useQuery({
    queryKey: ['machines'],
    queryFn: getMachinesForDropdown
  });

  if (isLoading) return <Skeleton />;

  if (!machines || machines.length === 0) {
    return (
      <div className="text-sm text-muted-foreground">
        <p>No machines configured</p>
        <Link href="/settings/infrastructure" className="text-primary underline">
          Add machines in Settings
        </Link>
      </div>
    );
  }

  return (
    <Select value={value || 'none'} onValueChange={(v) => onChange(v === 'none' ? null : v)}>
      <SelectTrigger>
        <SelectValue placeholder="Select machine (optional)" />
      </SelectTrigger>
      <SelectContent>
        <SelectItem value="none">None / Not assigned</SelectItem>
        {machines.map(m => (
          <SelectItem key={m.id} value={m.id}>
            {m.code} - {m.name}
          </SelectItem>
        ))}
      </SelectContent>
    </Select>
  );
}
```

### Attachment Upload Component (FR-2.45)

```tsx
// components/technical/routings/AttachmentUpload.tsx
interface AttachmentUploadProps {
  operationId: string;
  routingId: string;
  currentCount: number;
  maxCount: number;
  onUploadComplete: (attachment: OperationAttachment) => void;
}

// Drag-and-drop zone with file validation
<div className="border-2 border-dashed border-gray-300 rounded-lg p-6">
  <input
    type="file"
    accept=".pdf,.png,.jpg,.jpeg,.docx"
    onChange={handleFileSelect}
    disabled={currentCount >= maxCount}
  />
  <p className="text-sm text-gray-500">
    Drop files or click to upload (PDF, PNG, JPG, DOCX - max 10MB)
  </p>
  <p className="text-xs text-gray-400">
    {currentCount}/{maxCount} attachments
  </p>
</div>
```

## Deliverables

- API route: `/api/technical/routings/:id` (GET - full detail)
- API route: `/api/technical/routings/:id/operations` (GET, POST)
- API route: `/api/technical/routings/:id/operations/:opId` (PUT, DELETE)
- API route: `/api/technical/routings/:id/operations/:opId/reorder` (PATCH)
- **API route: `/api/technical/routings/:id/operations/:opId/attachments` (POST) - FR-2.45**
- **API route: `/api/technical/routings/:id/operations/:opId/attachments/:attachId` (GET, DELETE) - FR-2.45**
- Routing detail page at `/technical/routings/[id]/page.tsx`
- OperationsTable component with reorder arrows
- OperationModal component (create/edit)
- OperationsSummaryPanel with expandable breakdown
- RelatedBOMsSection component
- **MachineDropdown component with empty state handling**
- **OperationAttachments component (FR-2.45)**
- **AttachmentUpload component (FR-2.45)**
- **AttachmentList component (FR-2.45)**
- routing-operations-service.ts
- Zod validation schemas
- **Supabase storage bucket configuration (FR-2.45)**
- **Database migration for operation_attachments table (FR-2.45)**
- Integration tests for all API endpoints
- Unit tests for routing-operations-service (>80% coverage)

## Definition of Done

- [ ] Operations table displays within 500ms for 50 operations
- [ ] Add operation with all fields works end-to-end
- [ ] Edit operation updates immediately in UI
- [ ] Delete operation with confirmation works
- [ ] Reorder (up/down) swaps sequences correctly
- [ ] Parallel operations detected and marked with "(Parallel)"
- [ ] Duplicate sequence shows info message (not blocking error)
- [ ] Duration calculated correctly with parallel ops (MAX per sequence)
- [ ] Cost calculated correctly (SUM all ops including parallel)
- [ ] Setup/duration/cleanup times all saved and displayed
- [ ] Instructions field accepts up to 2000 characters
- [ ] **Machine dropdown shows empty state when no machines configured**
- [ ] **Operations work correctly with machine_id = NULL**
- [ ] **Machine dropdown populates from machines table when available**
- [ ] Summary panel shows totals and expands to breakdown
- [ ] Related BOMs section shows routing usage
- [ ] Empty state displays with example workflow
- [ ] **Attachments upload works for PDF, PNG, JPG, DOCX (FR-2.45)**
- [ ] **Attachment file size limited to 10MB (FR-2.45)**
- [ ] **Maximum 5 attachments per operation enforced (FR-2.45)**
- [ ] **Attachments can be downloaded/viewed (FR-2.45)**
- [ ] **Attachments deleted when operation deleted (FR-2.45)**
- [ ] **Attachment count badge shows in operations table (FR-2.45)**
- [ ] Permission checks hide unauthorized actions
- [ ] All API endpoints have integration tests
- [ ] Unit tests cover routing-operations-service (>80% coverage)
- [ ] TEC-008a wireframe fully implemented
- [ ] Phase 1+ features are hidden per "Future Feature Handling" guidance
