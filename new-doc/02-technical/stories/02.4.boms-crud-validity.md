# 02.4 - BOMs CRUD + Date Validity

**Priority**: P0 (MVP)
**Story Points**: M (Medium)
**Type:** frontend + backend

**State:** ready
**Primary PRD:** `docs/1-BASELINE/product/modules/technical.md` (FR-2.20, FR-2.22, FR-2.23)
**UX Wireframes:** TEC-005 (BOMs List), TEC-006 (BOM Modal), TEC-006b (BOM Version Timeline)

---

## MVP Scope

This story implements Phase 0 (MVP) functionality only. Features listed in "Future Phases" are deferred and should be handled per Epic 02.0 "Future Feature Handling" guidance.

---

## Goal

Implement complete Bill of Materials CRUD operations including BOM list page with search/filters, create/edit page with date validation, version control system, and date-based validity (effective_from/effective_to) with overlap prevention.

## User Story

As a **Production Manager**, I want to **create and manage Bills of Materials with date-based validity** so that **I can control which recipe version is active for production at any given time**.

## Scope

**In scope (MVP)**
- GET /api/technical/boms (list with pagination, search, filters by product/status/date)
- POST /api/technical/boms (create new BOM)
- PUT /api/technical/boms/:id (update existing BOM header)
- DELETE /api/technical/boms/:id (delete BOM if not used in Work Orders)
- BOM list page at `/technical/boms` with DataTable
- Create/Edit BOM page with form validation
- BOM header fields: product_id, version, effective_from, effective_to, status, output_qty, output_uom
- Date validity: effective_from required, effective_to optional (NULL = no end)
- Date overlap prevention (database trigger enforces no overlaps for same product)
- BOM status management: draft, active, phased_out, inactive
- Version auto-increment within product scope (v1, v2, v3...)
- **Version timeline visualization (FR-2.23) - show all BOM versions for a product on a timeline**

**Out of scope (this story)**
- BOM items management (covered in 02.5a, 02.5b)
- BOM clone/copy functionality (FR-2.24 - covered in 02.6)
- BOM comparison/diff view (FR-2.25 - covered in 02.14)
- Conditional BOM items (FR-2.26 - covered in 02.5b)
- Byproducts management (FR-2.27 - covered in 02.5b)
- Advanced settings: routing assignment, packaging fields
- Cost summary panel (depends on BOM items + costing service)

## Dependencies
- **02.1** - Products CRUD (required for product_id foreign key and product selector)
- **01.1** - Org context + RLS (required for tenant isolation)

## Acceptance Criteria (Given/When/Then)

### AC-1: BOM List Page

**Given** user navigates to `/technical/boms`
**When** page loads
**Then** BOM list displays within 500ms for up to 500 BOMs

**Given** BOM list displayed
**When** user searches "BREAD"
**Then** filtered results show only BOMs for products containing "BREAD" in code or name within 300ms

**Given** BOM list displayed
**When** user filters by status "Active"
**Then** only Active BOMs appear

**Given** BOM list displayed
**When** user filters by product type "Finished Good"
**Then** only BOMs for FG products appear

**Given** BOM list displayed
**When** user filters by date "Currently Effective"
**Then** only BOMs where current date is between effective_from and effective_to (or effective_to is NULL) appear

**Given** BOM list has pagination
**When** page 2 clicked
**Then** next 50 BOMs display

**Given** BOM table rendered
**When** viewing BOM row
**Then** shows: Product (code + name), Version (v1), Status (badge), Eff. From (date), Eff. To (date or "-"), Output (qty + uom)

### AC-2: Create BOM

**Given** user clicks "[+ Create BOM]"
**When** page loads
**Then** create form displays with empty fields and version set to "v1"

**Given** user selects product "FG-001 Honey Bread"
**When** form updates
**Then** version auto-calculates to next available (v1 if first, v2 if v1 exists)

**Given** valid BOM data (product: FG-001, effective_from: today, output_qty: 100, output_uom: kg)
**When** "[Save BOM]" clicked
**Then** BOM created with status "draft" and redirects to BOM detail page

**Given** product already has BOM with effective_from=2024-01-01, effective_to=NULL (no end)
**When** user creates new BOM with effective_from=2024-06-01 (overlaps)
**Then** error "Date range overlaps with existing BOM v1 (2024-01-01 to ongoing)" displays

**Given** product has no existing BOMs
**When** BOM created with status "active"
**Then** BOM saved as active (no overlap check needed)

**Given** effective_to date set before effective_from
**When** save attempted
**Then** error "Effective To must be after Effective From" displays inline

**Given** output_qty is 0 or negative
**When** save attempted
**Then** error "Output quantity must be greater than 0" displays inline

### AC-3: Edit BOM

**Given** user clicks edit on existing BOM v2 (Active)
**When** page loads
**Then** current BOM data pre-populates form with product field locked

**Given** user updates effective_to from NULL to "2024-12-31"
**When** save completes
**Then** updated date displays in list

**Given** user attempts to change product_id on existing BOM
**Then** product field is disabled with tooltip "Product cannot be changed after BOM creation"

**Given** BOM is Active and user changes status to "Inactive"
**When** save completes
**Then** BOM status updates and warning toast "BOM deactivated - no longer available for production" displays

### AC-4: Date Overlap Prevention

**Given** product FG-001 has BOM v1 (2024-01-01 to 2024-06-30) and BOM v2 (2024-07-01 to NULL)
**When** user creates BOM v3 with effective_from=2024-04-01
**Then** error "Date range overlaps with BOM v1"

**Given** product FG-001 has BOM v1 (2024-01-01 to 2024-06-30)
**When** user creates BOM v2 with effective_from=2024-07-01
**Then** BOM v2 created successfully (no overlap)

**Given** user creates BOM with effective_to=NULL
**When** another BOM exists with effective_to=NULL for same product
**Then** error "Only one BOM can have no end date per product"

### AC-5: Version Control

**Given** product FG-001 has BOMs v1, v2
**When** user creates new BOM for FG-001
**Then** version auto-set to v3

**Given** BOM list for product FG-001
**When** viewing version column
**Then** versions display chronologically (v1, v2, v3) with newest at top by effective_from

**Given** BOM detail page
**When** viewing header
**Then** shows "BOM v2 - FG-001 Honey Bread" with status badge

### AC-6: Version Timeline Visualization (FR-2.23)

**Given** user clicks "[View Timeline]" or "[Timeline]" icon on BOM list row
**When** timeline modal/panel opens
**Then** all BOM versions for that product display on a horizontal timeline

**Given** timeline displayed
**When** viewing timeline bars
**Then** each version shows: version number (v1, v2, v3), effective date range, status (color-coded), and is clickable

**Given** timeline displayed for product with 3 versions
**When** user hovers over version bar
**Then** tooltip shows: version, status, effective dates, output qty, notes preview

**Given** timeline displayed
**When** user clicks on a version bar
**Then** navigates to that BOM detail page

**Given** product has overlapping draft BOMs
**When** timeline renders
**Then** overlapping regions are highlighted with warning color

**Given** timeline displayed
**When** current date is within a version's effective range
**Then** that version is highlighted as "Currently Active"

**Given** timeline displayed
**When** versions have gaps between effective dates
**Then** gaps are visually indicated (no coverage period)

### AC-7: Delete BOM

**Given** user clicks delete on BOM v1 (Draft)
**When** confirmation dialog accepted
**Then** BOM deleted and removed from list

**Given** BOM v2 is referenced by Work Order WO-001
**When** delete attempted
**Then** error "Cannot delete BOM used in Work Orders: WO-001"

**Given** user clicks delete on BOM
**Then** confirmation dialog shows "Delete BOM v2 for FG-001 Honey Bread? This will also delete all BOM items. This action cannot be undone."

### AC-8: Permission Enforcement

**Given** user has role VIEWER (read-only)
**When** `/technical/boms` loaded
**Then** "[+ Create BOM]" button hidden, edit/delete actions hidden

**Given** user has role PROD_MANAGER
**When** `/technical/boms` loaded
**Then** create/edit/delete actions available

**Given** user has role ADMIN
**When** delete action clicked
**Then** delete proceeds (only Admin can delete)

### AC-9: Future Features (Phase 1+)

Features deferred to Phase 1+:
- **Routing assignment** (routing_id) - Hidden field in MVP form (see Epic 02.0 guidance)
- **Packaging fields** (units_per_box, boxes_per_pallet) - Hidden in MVP
- **Cost summary panel** - Not shown until 02.9 complete

**Developer**: Choose hiding strategy per Epic 02.0 "Future Feature Handling" (recommended: hide completely for form fields).

## Implementation Notes

### API Endpoints

```typescript
// GET /api/technical/boms
// Query params: page, limit, search, product_id, status, product_type, effective_date, sortBy, sortOrder
interface BOMsListResponse {
  boms: BOMWithProduct[];
  total: number;
  page: number;
  limit: number;
}

interface BOMWithProduct {
  id: string;
  org_id: string;
  product_id: string;
  product: {
    id: string;
    code: string;
    name: string;
    type: string;
    uom: string;
  };
  version: number;
  status: 'draft' | 'active' | 'phased_out' | 'inactive';
  effective_from: string; // ISO date
  effective_to: string | null;
  output_qty: number;
  output_uom: string;
  routing_id: string | null;
  units_per_box: number | null;
  boxes_per_pallet: number | null;
  notes: string | null;
  created_at: string;
  updated_at: string;
}

// POST /api/technical/boms
interface CreateBOMRequest {
  product_id: string;
  effective_from: string; // ISO date, required
  effective_to?: string | null; // ISO date, optional
  status?: 'draft' | 'active'; // default: 'draft'
  output_qty: number; // required, > 0
  output_uom: string; // required
  notes?: string;
}

// PUT /api/technical/boms/:id
interface UpdateBOMRequest {
  effective_from?: string;
  effective_to?: string | null;
  status?: 'draft' | 'active' | 'phased_out' | 'inactive';
  output_qty?: number;
  output_uom?: string;
  notes?: string;
}

// DELETE /api/technical/boms/:id
// Returns 400 if BOM is used in Work Orders

// GET /api/technical/boms/timeline/:productId (FR-2.23)
interface BOMTimelineResponse {
  product: {
    id: string;
    code: string;
    name: string;
  };
  versions: BOMTimelineVersion[];
  current_date: string;
}

interface BOMTimelineVersion {
  id: string;
  version: number;
  status: 'draft' | 'active' | 'phased_out' | 'inactive';
  effective_from: string;
  effective_to: string | null;
  output_qty: number;
  output_uom: string;
  notes: string | null;
  is_currently_active: boolean;
  has_overlap: boolean;
}
```

### Database

```sql
-- boms table (existing)
id UUID PRIMARY KEY,
org_id UUID NOT NULL REFERENCES organizations(id),
product_id UUID NOT NULL REFERENCES products(id),
version INTEGER NOT NULL DEFAULT 1,
bom_type TEXT DEFAULT 'standard',
routing_id UUID REFERENCES routings(id),
effective_from DATE NOT NULL,
effective_to DATE,
status TEXT NOT NULL DEFAULT 'draft' CHECK (status IN ('draft', 'active', 'phased_out', 'inactive')),
output_qty DECIMAL(15,6) NOT NULL CHECK (output_qty > 0),
output_uom TEXT NOT NULL,
units_per_box INTEGER,
boxes_per_pallet INTEGER,
notes TEXT,
created_at TIMESTAMPTZ DEFAULT NOW(),
updated_at TIMESTAMPTZ DEFAULT NOW(),
created_by UUID REFERENCES users(id),
updated_by UUID REFERENCES users(id),
UNIQUE(org_id, product_id, version)

-- Date overlap prevention trigger (existing)
CREATE OR REPLACE FUNCTION check_bom_date_overlap()
RETURNS TRIGGER AS $$
BEGIN
  IF EXISTS (
    SELECT 1 FROM boms
    WHERE org_id = NEW.org_id
      AND product_id = NEW.product_id
      AND id != COALESCE(NEW.id, '00000000-0000-0000-0000-000000000000'::uuid)
      AND daterange(effective_from, effective_to, '[]') &&
          daterange(NEW.effective_from, NEW.effective_to, '[]')
  ) THEN
    RAISE EXCEPTION 'Date range overlaps with existing BOM for this product';
  END IF;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;
```

### Frontend Components

```
app/(authenticated)/technical/boms/page.tsx         -- List page
app/(authenticated)/technical/boms/new/page.tsx     -- Create page
app/(authenticated)/technical/boms/[id]/page.tsx    -- Detail page
app/(authenticated)/technical/boms/[id]/edit/page.tsx -- Edit page

components/technical/bom/
  BOMsDataTable.tsx      -- Table with sorting, filtering, pagination
  BOMHeaderForm.tsx      -- Reusable form for BOM header fields
  ProductSelector.tsx    -- Combobox for product search/select
  BOMStatusBadge.tsx     -- Status indicator
  DeleteBOMDialog.tsx    -- Confirmation dialog
  BOMVersionTimeline.tsx -- Timeline visualization (FR-2.23)
  BOMTimelineModal.tsx   -- Modal wrapper (FR-2.23)
  BOMTimelineBar.tsx     -- Individual version bar (FR-2.23)
```

### Services

```typescript
// lib/services/bom-service.ts
export async function listBOMs(filters): Promise<BOMsListResponse>
export async function getBOM(id: string): Promise<BOMWithProduct>
export async function createBOM(data: CreateBOMRequest): Promise<BOM>
export async function updateBOM(id: string, data: UpdateBOMRequest): Promise<BOM>
export async function deleteBOM(id: string): Promise<void>
export async function getNextVersion(productId: string): Promise<number>
export async function checkDateOverlap(productId: string, from: string, to: string | null, excludeId?: string): Promise<boolean>
export async function getBOMTimeline(productId: string): Promise<BOMTimelineResponse>
```

### Validation (Zod)

```typescript
const createBOMSchema = z.object({
  product_id: z.string().uuid("Invalid product"),
  effective_from: z.string().refine((val) => !isNaN(Date.parse(val)), "Invalid date"),
  effective_to: z.string().refine((val) => !val || !isNaN(Date.parse(val)), "Invalid date").nullable().optional(),
  status: z.enum(['draft', 'active']).default('draft'),
  output_qty: z.number().positive("Output quantity must be greater than 0").max(999999999, "Output quantity too large"),
  output_uom: z.string().min(1, "Unit of measure is required").max(20),
  notes: z.string().max(2000).optional(),
}).refine((data) => {
  if (data.effective_to && data.effective_from) {
    return new Date(data.effective_to) >= new Date(data.effective_from);
  }
  return true;
}, {
  message: "Effective To must be after Effective From",
  path: ["effective_to"],
});
```

## Deliverables

- API routes for BOM CRUD operations
- API route for BOM timeline: GET /api/technical/boms/timeline/:productId
- BOMs list page with DataTable, search, filters
- Create BOM page with validation
- Edit BOM page with product field locked
- Date overlap prevention (server-side validation + database trigger)
- Version auto-increment logic
- Delete with Work Order reference check
- Permission-based UI rendering
- BOMVersionTimeline component (FR-2.23)
- BOMTimelineModal component (FR-2.23)
- Zod validation schemas
- Integration tests for API endpoints
- Unit tests for bom-service

## Definition of Done

- [ ] BOM list page loads within 500ms for 500 BOMs
- [ ] Create BOM with auto-versioning works end-to-end
- [ ] Edit BOM updates immediately in UI (product field locked)
- [ ] Date overlap prevented by database trigger with clear error message
- [ ] Delete blocked if BOM used in Work Orders
- [ ] Status badge displays correct colors (Draft/Active/Phased/Inactive)
- [ ] Filters work: status, product type, date range, search
- [ ] Version numbers display correctly (v1, v2, v3)
- [ ] Version timeline displays all versions with correct date ranges (FR-2.23)
- [ ] Timeline highlights currently active version (FR-2.23)
- [ ] Timeline shows overlap warnings visually (FR-2.23)
- [ ] Timeline bars are clickable and navigate to BOM detail (FR-2.23)
- [ ] Timeline tooltip shows version details on hover (FR-2.23)
- [ ] Permission checks hide unauthorized actions (create/edit/delete)
- [ ] All API endpoints have integration tests
- [ ] Unit tests cover bom-service (>80% coverage)
- [ ] Zod schemas validate all input fields
- [ ] Empty state shows "Create Your First BOM" CTA
- [ ] Error states display clear messages with retry option

---

## Future Phases (Not in MVP)

### Phase 1
- **Routing assignment** (routing_id field) - Link BOM to routing for operation-based consumption
- **Packaging fields** (units_per_box, boxes_per_pallet) - For pallet/case calculations
- **Cost summary panel** - Real-time cost display (after 02.9)

### Phase 2
- **BOM comparison view** (FR-2.25) - Side-by-side version comparison
- **Import/Export to CSV** - Bulk BOM data operations

**Implementation**: See Epic 02.0 "Future Feature Handling" section.

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | Original | BOMs CRUD + Date Validity | - |
| 2.0 | 2025-12-16 | Added Priority header, MVP Scope section, Future Phases section, AC-9 placeholder guidance | ARCHITECT-AGENT |
