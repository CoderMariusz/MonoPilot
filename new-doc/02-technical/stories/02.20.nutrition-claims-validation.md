# 02.20 - Nutrition Claims Validation

**Story ID:** 02.20
**Epic:** 02 - Technical
**Phase:** Phase 2
**Complexity:** S (Small)
**Estimate:** 2-3 days
**Type:** Backend + Frontend
**State:** ready

**Primary PRD:** `docs/1-BASELINE/product/modules/technical.md` (FR-2.83)
**Related Guide:** `docs/3-ARCHITECTURE/guides/fda-labeling-compliance.md`

## PRD References

| FR ID | Requirement | Priority | Phase | Covered |
|-------|-------------|----------|-------|---------|
| FR-2.83 | Nutrition claims validation | P2 | Future | Yes |

## User Story

**As a** food product manager,
**I want** to validate nutrition claims against FDA rules,
**So that** I can ensure my product labels are compliant and avoid regulatory issues.

**As a** quality assurance specialist,
**I want** to see which nutrition claims my products are eligible for,
**So that** I can make informed decisions about product marketing.

## Goal

Implement FDA nutrition claims validation system that checks product nutrition data against regulatory thresholds. Users can validate claims like "Low Fat", "High Fiber", "Good Source of Protein" based on per-serving and per-100g values. The system tracks approved claims per product and provides clear pass/fail results with reasons.

## Scope

**In scope:**
- FDA nutrition claims rule definitions (21 CFR 101.62)
- Claim eligibility checker (per 100g and per serving)
- Pass/fail validation with reasons
- Product approved claims management
- Claim usage tracking
- 5 core claims: Low Fat, Low Sodium, High Fiber, Good Source of Protein, Reduced Sugar

**Out of scope:**
- EU nutrition claims (Phase 2)
- Health claims (e.g., "heart healthy") - requires FDA pre-approval
- Structure/function claims
- Allergen-free claims
- Organic/Non-GMO claims (different regulatory framework)

## Dependencies

| Story | Requirement | Status |
|-------|-------------|--------|
| 02.13 | Nutrition Calculation | Required - provides nutrition data |
| 01.1 | Org Context + Base RLS | Required - provides auth context |

## Acceptance Criteria (Given/When/Then)

### Claim Eligibility Check

#### Low Fat Claim (21 CFR 101.62(b))
- GIVEN product has nutrition data with fat_g=2.5 per serving, WHEN "Low Fat" claim checked, THEN result is PASS (<=3g per serving).
- GIVEN product has nutrition data with fat_g=4.0 per serving, WHEN "Low Fat" claim checked, THEN result is FAIL with reason "Fat exceeds 3g per serving (4.0g)".
- GIVEN product has nutrition data with fat_g=2.8 per 100g and serving=50g, WHEN checked, THEN per-serving (1.4g) and per-100g (2.8g) both shown.

#### Low Sodium Claim (21 CFR 101.62(c))
- GIVEN product has nutrition data with sodium_mg=120 per serving, WHEN "Low Sodium" claim checked, THEN result is PASS (<=140mg per serving).
- GIVEN product has nutrition data with sodium_mg=180 per serving, WHEN "Low Sodium" claim checked, THEN result is FAIL with reason "Sodium exceeds 140mg per serving (180mg)".
- GIVEN product passes Low Sodium per serving but exceeds per 100g limit, WHEN checked, THEN warning shown about per-100g value.

#### High Fiber Claim (21 CFR 101.62(d))
- GIVEN product has nutrition data with fiber_g=6.0 per serving, WHEN "High Fiber" claim checked, THEN result is PASS (>=5g per serving).
- GIVEN product has nutrition data with fiber_g=4.0 per serving, WHEN "High Fiber" claim checked, THEN result is FAIL with reason "Fiber below 5g per serving (4.0g)".
- GIVEN product has fiber_g=4.5 per serving (10-19% DV), WHEN checked, THEN "Good Source of Fiber" suggested as alternative.

#### Good Source of Protein Claim (21 CFR 101.54)
- GIVEN product has protein_g=6.0 per serving (12% DV), WHEN "Good Source of Protein" claim checked, THEN result is PASS (>=10% DV).
- GIVEN product has protein_g=12.0 per serving (24% DV), WHEN "Good Source of Protein" claim checked, THEN result is PASS with note "Qualifies for HIGH source (>=20% DV)".
- GIVEN product has protein_g=4.0 per serving (8% DV), WHEN "Good Source of Protein" claim checked, THEN result is FAIL with reason "Protein below 10% DV (8% DV)".

#### Reduced Sugar Claim (21 CFR 101.60(c))
- GIVEN product has sugar_g=8.0 and reference product has sugar_g=12.0, WHEN "Reduced Sugar" claim checked, THEN result is PASS (33% reduction, >=25% required).
- GIVEN product has sugar_g=10.0 and reference product has sugar_g=12.0, WHEN "Reduced Sugar" claim checked, THEN result is FAIL with reason "Sugar reduction only 17% (requires 25%)".
- GIVEN no reference product specified, WHEN "Reduced Sugar" claim checked, THEN prompt to select reference product.

### Claim Validation UI

#### Product Claims Panel
- GIVEN user opens product nutrition panel, WHEN claims tab clicked, THEN list of all available claims displays with eligibility status.
- GIVEN claims list displayed, WHEN claim shows PASS, THEN green checkmark and "Eligible" badge shown.
- GIVEN claims list displayed, WHEN claim shows FAIL, THEN red X and reason text shown.
- GIVEN claims list displayed, WHEN claim shows WARNING, THEN yellow warning icon with details shown.

#### Claim Details Modal
- GIVEN user clicks claim name, WHEN modal opens, THEN full FDA rule text, thresholds, and calculation breakdown shown.
- GIVEN claim details modal open, WHEN product values shown, THEN per-serving and per-100g values both displayed.
- GIVEN claim PASSES, WHEN modal open, THEN "Add to Approved Claims" button visible.
- GIVEN claim FAILS, WHEN modal open, THEN "What would need to change" section shows required values.

### Approved Claims Management

#### Add Approved Claim
- GIVEN product passes claim validation, WHEN user clicks "Add to Approved Claims", THEN claim saved to product.
- GIVEN claim added, WHEN saved, THEN validation timestamp and user recorded.
- GIVEN claim added, WHEN nutrition data changes, THEN warning shown that re-validation needed.

#### View Approved Claims
- GIVEN product has approved claims, WHEN product detail viewed, THEN approved claims badge shown.
- GIVEN product list viewed, WHEN filter by claims applied, THEN only products with selected claims shown.
- GIVEN admin views product, WHEN approved claims section expanded, THEN validation history shown.

#### Remove Approved Claim
- GIVEN product has approved claim, WHEN user clicks "Remove Claim", THEN confirmation dialog appears.
- GIVEN confirmation dialog, WHEN confirmed, THEN claim removed and audit log entry created.

### Claim Re-validation

- GIVEN product has approved "Low Fat" claim, WHEN nutrition data updated to fat_g=4.0, THEN warning "Claim may no longer be valid" shown.
- GIVEN stale claim warning shown, WHEN user clicks "Re-validate", THEN validation runs and status updated.
- GIVEN claim fails re-validation, WHEN result shown, THEN option to remove claim provided.

### API Endpoints

- GIVEN authenticated user, WHEN POST /api/technical/nutrition/claims/validate called, THEN all claims checked against product nutrition.
- GIVEN authenticated user, WHEN GET /api/technical/nutrition/claims/rules called, THEN list of available claim rules returned.
- GIVEN authenticated user, WHEN POST /api/technical/products/:id/claims called with claim_code, THEN claim added to product.
- GIVEN authenticated user, WHEN DELETE /api/technical/products/:id/claims/:claimCode called, THEN claim removed from product.
- GIVEN authenticated user, WHEN GET /api/technical/products/:id/claims called, THEN approved claims for product returned.

### Multi-tenancy

- GIVEN User A from Org A, WHEN validating claims, THEN only Org A product data accessible.
- GIVEN Product A belongs to Org A, WHEN User B from Org B requests claims, THEN 404 Not Found returned (not 403).

## Technical Specification

### Database Schema

#### nutrition_claim_rules table (reference data)

```sql
-- Static reference table for FDA claim rules
CREATE TABLE IF NOT EXISTS nutrition_claim_rules (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  claim_code VARCHAR(50) NOT NULL UNIQUE,
  claim_name VARCHAR(100) NOT NULL,
  claim_category VARCHAR(50) NOT NULL, -- 'nutrient_content', 'health', 'structure_function'

  -- FDA Reference
  cfr_reference VARCHAR(50), -- e.g., '21 CFR 101.62(b)'
  fda_definition TEXT,

  -- Validation rules (JSONB for flexibility)
  validation_rules JSONB NOT NULL,
  -- Example: {
  --   "nutrient": "fat_g",
  --   "per_serving": { "max": 3.0, "unit": "g" },
  --   "per_100g": { "max": 3.0, "unit": "g" },
  --   "comparison_type": "max",
  --   "requires_reference": false
  -- }

  -- Display
  display_order INTEGER DEFAULT 0,
  is_active BOOLEAN DEFAULT true,

  -- Timestamps
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);

-- Insert core FDA claims
INSERT INTO nutrition_claim_rules (claim_code, claim_name, claim_category, cfr_reference, fda_definition, validation_rules, display_order) VALUES
('low_fat', 'Low Fat', 'nutrient_content', '21 CFR 101.62(b)',
 'A food may bear the claim "low fat" if the food contains 3g or less of fat per reference amount customarily consumed (serving).',
 '{"nutrient": "fat_g", "per_serving": {"max": 3.0, "unit": "g"}, "comparison_type": "max", "requires_reference": false}',
 1),

('low_sodium', 'Low Sodium', 'nutrient_content', '21 CFR 101.62(c)',
 'A food may bear the claim "low sodium" if the food contains 140mg or less of sodium per reference amount customarily consumed (serving).',
 '{"nutrient": "sodium_mg", "per_serving": {"max": 140, "unit": "mg"}, "comparison_type": "max", "requires_reference": false}',
 2),

('high_fiber', 'High Fiber', 'nutrient_content', '21 CFR 101.54(d)',
 'A food may bear the claim "high fiber" if the food contains 5g or more of dietary fiber per reference amount customarily consumed (serving) and meets Low Fat criteria or discloses fat content.',
 '{"nutrient": "fiber_g", "per_serving": {"min": 5.0, "unit": "g"}, "comparison_type": "min", "requires_reference": false, "additional_rules": {"low_fat_required": true}}',
 3),

('good_source_protein', 'Good Source of Protein', 'nutrient_content', '21 CFR 101.54',
 'A food may bear the claim "good source of protein" if the food contains 10-19% of the Daily Value (DV) for protein per reference amount customarily consumed (serving).',
 '{"nutrient": "protein_g", "per_serving_dv": {"min": 10, "max": 19, "dv": 50, "unit": "g"}, "comparison_type": "dv_range", "requires_reference": false}',
 4),

('reduced_sugar', 'Reduced Sugar', 'nutrient_content', '21 CFR 101.60(c)',
 'A food may bear the claim "reduced sugar" if the food contains at least 25% less sugar than the reference food.',
 '{"nutrient": "sugar_g", "reduction_percent": {"min": 25}, "comparison_type": "reduction", "requires_reference": true}',
 5)
ON CONFLICT (claim_code) DO NOTHING;

-- Indexes
CREATE INDEX IF NOT EXISTS idx_nutrition_claim_rules_category ON nutrition_claim_rules(claim_category);
CREATE INDEX IF NOT EXISTS idx_nutrition_claim_rules_active ON nutrition_claim_rules(is_active);
```

#### product_nutrition_claims table

```sql
-- Product-level approved claims
CREATE TABLE IF NOT EXISTS product_nutrition_claims (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  product_id UUID NOT NULL REFERENCES products(id) ON DELETE CASCADE,
  claim_code VARCHAR(50) NOT NULL REFERENCES nutrition_claim_rules(claim_code),

  -- Validation snapshot
  validated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  validated_by UUID REFERENCES auth.users(id),
  validation_result JSONB NOT NULL,
  -- Example: {
  --   "passed": true,
  --   "nutrient_value": 2.5,
  --   "threshold": 3.0,
  --   "unit": "g",
  --   "per_serving": true,
  --   "serving_size": 50,
  --   "nutrition_snapshot_id": "uuid"
  -- }

  -- Reference product (for "reduced" claims)
  reference_product_id UUID REFERENCES products(id),

  -- Status
  is_valid BOOLEAN DEFAULT true,
  invalidated_at TIMESTAMPTZ,
  invalidation_reason TEXT,

  -- Timestamps
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now(),

  -- Constraints
  CONSTRAINT product_claims_unique UNIQUE(org_id, product_id, claim_code)
);

-- Indexes
CREATE INDEX IF NOT EXISTS idx_product_claims_org_product ON product_nutrition_claims(org_id, product_id);
CREATE INDEX IF NOT EXISTS idx_product_claims_claim ON product_nutrition_claims(claim_code);
CREATE INDEX IF NOT EXISTS idx_product_claims_valid ON product_nutrition_claims(is_valid);

-- RLS Policies
ALTER TABLE product_nutrition_claims ENABLE ROW LEVEL SECURITY;

CREATE POLICY "product_claims_org_isolation_select" ON product_nutrition_claims
  FOR SELECT USING (
    org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  );

CREATE POLICY "product_claims_org_isolation_insert" ON product_nutrition_claims
  FOR INSERT WITH CHECK (
    org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  );

CREATE POLICY "product_claims_org_isolation_update" ON product_nutrition_claims
  FOR UPDATE USING (
    org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  );

CREATE POLICY "product_claims_org_isolation_delete" ON product_nutrition_claims
  FOR DELETE USING (
    org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  );

-- Grants
GRANT SELECT ON nutrition_claim_rules TO authenticated;
GRANT SELECT, INSERT, UPDATE, DELETE ON product_nutrition_claims TO authenticated;
```

### API Endpoints

```
# Claim Rules (Reference Data)
GET    /api/technical/nutrition/claims/rules              - List all available claim rules

# Claim Validation
POST   /api/technical/nutrition/claims/validate           - Validate product against all claims
       Body: { product_id: string, serving_size_g?: number }
       Response: { claims: [{ claim_code, passed, reason, values }] }

POST   /api/technical/nutrition/claims/validate/:claimCode - Validate single claim
       Body: { product_id: string, reference_product_id?: string }
       Response: { passed, reason, nutrient_value, threshold, recommendation }

# Product Claims Management
GET    /api/technical/products/:id/claims                 - Get product's approved claims
POST   /api/technical/products/:id/claims                 - Add approved claim to product
       Body: { claim_code: string, reference_product_id?: string }
DELETE /api/technical/products/:id/claims/:claimCode      - Remove claim from product

# Bulk Operations
POST   /api/technical/products/:id/claims/revalidate      - Re-validate all product claims
GET    /api/technical/products/claims/summary             - Products summary by claim eligibility
```

### Service Methods

**Location:** `lib/services/nutrition-claims-service.ts`

```typescript
interface NutritionClaimsService {
  // Claim Rules
  getClaimRules(): Promise<ClaimRule[]>;
  getClaimRule(claimCode: string): Promise<ClaimRule | null>;

  // Validation
  validateAllClaims(productId: string, servingSizeG?: number): Promise<ClaimValidationResult[]>;
  validateClaim(productId: string, claimCode: string, referenceProductId?: string): Promise<ClaimValidationResult>;

  // Product Claims
  getProductClaims(productId: string): Promise<ProductClaim[]>;
  addProductClaim(productId: string, claimCode: string, referenceProductId?: string): Promise<ProductClaim>;
  removeProductClaim(productId: string, claimCode: string): Promise<void>;
  revalidateProductClaims(productId: string): Promise<ClaimValidationResult[]>;

  // Helpers
  calculatePerServing(nutrition: ProductNutrition, servingSizeG: number): NutrientProfile;
  calculatePercentDV(value: number, dailyValue: number): number;
  checkClaimThreshold(value: number, rule: ClaimRule): ClaimCheckResult;
}

interface ClaimRule {
  claim_code: string;
  claim_name: string;
  claim_category: string;
  cfr_reference: string;
  fda_definition: string;
  validation_rules: {
    nutrient: string;
    per_serving?: { min?: number; max?: number; unit: string };
    per_serving_dv?: { min?: number; max?: number; dv: number; unit: string };
    per_100g?: { min?: number; max?: number; unit: string };
    reduction_percent?: { min: number };
    comparison_type: 'min' | 'max' | 'dv_range' | 'reduction';
    requires_reference: boolean;
    additional_rules?: Record<string, any>;
  };
  display_order: number;
  is_active: boolean;
}

interface ClaimValidationResult {
  claim_code: string;
  claim_name: string;
  passed: boolean;
  status: 'pass' | 'fail' | 'warning' | 'not_applicable';
  reason: string;
  nutrient_value: number;
  threshold: number;
  unit: string;
  per_serving: number;
  per_100g: number;
  percent_dv?: number;
  recommendation?: string;
  requires_reference: boolean;
  reference_product?: { id: string; name: string; value: number };
}

interface ProductClaim {
  id: string;
  product_id: string;
  claim_code: string;
  claim_name: string;
  validated_at: string;
  validated_by: string;
  is_valid: boolean;
  validation_result: ClaimValidationResult;
  reference_product_id?: string;
}

interface ClaimCheckResult {
  passed: boolean;
  reason: string;
  recommendation?: string;
}
```

### Zod Validation Schemas

**Location:** `lib/validation/nutrition-claims.ts`

```typescript
import { z } from 'zod';

// Claim rule response schema
export const claimRuleSchema = z.object({
  claim_code: z.string(),
  claim_name: z.string(),
  claim_category: z.enum(['nutrient_content', 'health', 'structure_function']),
  cfr_reference: z.string().nullable(),
  fda_definition: z.string(),
  validation_rules: z.object({
    nutrient: z.string(),
    per_serving: z.object({
      min: z.number().optional(),
      max: z.number().optional(),
      unit: z.string(),
    }).optional(),
    per_serving_dv: z.object({
      min: z.number().optional(),
      max: z.number().optional(),
      dv: z.number(),
      unit: z.string(),
    }).optional(),
    per_100g: z.object({
      min: z.number().optional(),
      max: z.number().optional(),
      unit: z.string(),
    }).optional(),
    reduction_percent: z.object({
      min: z.number(),
    }).optional(),
    comparison_type: z.enum(['min', 'max', 'dv_range', 'reduction']),
    requires_reference: z.boolean(),
    additional_rules: z.record(z.any()).optional(),
  }),
  display_order: z.number(),
  is_active: z.boolean(),
});

export const claimRulesListSchema = z.array(claimRuleSchema);

// Validation request schemas
export const validateClaimsRequestSchema = z.object({
  product_id: z.string().uuid(),
  serving_size_g: z.number().positive().optional(),
});

export const validateSingleClaimRequestSchema = z.object({
  product_id: z.string().uuid(),
  reference_product_id: z.string().uuid().optional(),
});

// Validation result schema
export const claimValidationResultSchema = z.object({
  claim_code: z.string(),
  claim_name: z.string(),
  passed: z.boolean(),
  status: z.enum(['pass', 'fail', 'warning', 'not_applicable']),
  reason: z.string(),
  nutrient_value: z.number(),
  threshold: z.number(),
  unit: z.string(),
  per_serving: z.number(),
  per_100g: z.number(),
  percent_dv: z.number().optional(),
  recommendation: z.string().optional(),
  requires_reference: z.boolean(),
  reference_product: z.object({
    id: z.string(),
    name: z.string(),
    value: z.number(),
  }).optional(),
});

export const claimValidationResultsSchema = z.array(claimValidationResultSchema);

// Add claim request schema
export const addProductClaimRequestSchema = z.object({
  claim_code: z.string().min(1, 'Claim code is required'),
  reference_product_id: z.string().uuid().optional(),
});

// Product claim response schema
export const productClaimSchema = z.object({
  id: z.string().uuid(),
  product_id: z.string().uuid(),
  claim_code: z.string(),
  claim_name: z.string(),
  validated_at: z.string().datetime(),
  validated_by: z.string().uuid().nullable(),
  is_valid: z.boolean(),
  validation_result: claimValidationResultSchema,
  reference_product_id: z.string().uuid().nullable(),
});

export const productClaimsListSchema = z.array(productClaimSchema);
```

### FDA Claim Thresholds Reference

```typescript
// lib/types/nutrition-claims.ts

export const FDA_CLAIM_THRESHOLDS = {
  // Low Claims (21 CFR 101.62)
  low_fat: {
    per_serving_max_g: 3.0,
    per_100g_max_g: 3.0,
  },
  low_saturated_fat: {
    per_serving_max_g: 1.0,
    per_100g_max_g: 1.0,
    trans_fat_combined_max_g: 1.0,
  },
  low_sodium: {
    per_serving_max_mg: 140,
    per_100g_max_mg: 140,
  },
  low_cholesterol: {
    per_serving_max_mg: 20,
    per_100g_max_mg: 20,
    requires_low_saturated_fat: true,
  },
  low_calorie: {
    per_serving_max_kcal: 40,
    per_100g_max_kcal: 40,
  },

  // High/Good Source Claims (21 CFR 101.54)
  high_fiber: {
    per_serving_min_g: 5.0,
    dv_min_percent: 20,
    requires_low_fat: true,
  },
  good_source_fiber: {
    per_serving_min_g: 2.5,
    dv_min_percent: 10,
    dv_max_percent: 19,
  },
  high_protein: {
    dv_min_percent: 20,
  },
  good_source_protein: {
    dv_min_percent: 10,
    dv_max_percent: 19,
  },

  // Reduced Claims (21 CFR 101.60)
  reduced_fat: {
    reduction_min_percent: 25,
    requires_reference: true,
  },
  reduced_sugar: {
    reduction_min_percent: 25,
    requires_reference: true,
  },
  reduced_sodium: {
    reduction_min_percent: 25,
    requires_reference: true,
  },
  reduced_calories: {
    reduction_min_percent: 25,
    requires_reference: true,
  },

  // Free Claims (21 CFR 101.60)
  fat_free: {
    per_serving_max_g: 0.5,
  },
  sugar_free: {
    per_serving_max_g: 0.5,
  },
  sodium_free: {
    per_serving_max_mg: 5,
  },
  calorie_free: {
    per_serving_max_kcal: 5,
  },
} as const;

export const FDA_DAILY_VALUES_FOR_CLAIMS = {
  protein_g: 50,
  fiber_g: 28,
  fat_g: 78,
  saturated_fat_g: 20,
  cholesterol_mg: 300,
  sodium_mg: 2300,
  carbohydrate_g: 275,
  sugar_g: 50, // Added sugars
  vitamin_d_mcg: 20,
  calcium_mg: 1300,
  iron_mg: 18,
  potassium_mg: 4700,
} as const;
```

## UI Components

### Pages

- `app/(authenticated)/technical/products/:id/claims/page.tsx` - Product claims management page (optional standalone)

### Components

**Location:** `components/technical/nutrition/`

```
ClaimsValidationPanel.tsx    - Main claims validation panel in nutrition modal
ClaimCard.tsx                - Individual claim display with status
ClaimValidationResult.tsx    - Detailed validation result display
ClaimDetailsModal.tsx        - Full claim details with FDA reference
AddClaimDialog.tsx           - Dialog to add approved claim
ReferenceProductSelector.tsx - Selector for "reduced" claims reference
ApprovedClaimsBadge.tsx      - Badge showing product's approved claims
ClaimsFilterDropdown.tsx     - Filter products by claim eligibility
```

### Component Details

**ClaimsValidationPanel.tsx**
```tsx
interface ClaimsValidationPanelProps {
  productId: string;
  nutrition: ProductNutrition;
  servingSizeG: number;
  onClaimAdded?: (claim: ProductClaim) => void;
}

// Displays list of all claims with eligibility status
// PASS: Green checkmark, "Eligible" badge, "Add Claim" button
// FAIL: Red X, reason text, "What would need to change" link
// WARNING: Yellow icon, details expandable
```

**ClaimCard.tsx**
```tsx
interface ClaimCardProps {
  claim: ClaimRule;
  validationResult: ClaimValidationResult;
  isApproved: boolean;
  onViewDetails: () => void;
  onAddClaim: () => void;
  onRemoveClaim: () => void;
}

// Layout:
// +------------------------------------------+
// | [icon] Low Fat                 [Eligible] |
// | <=3g fat per serving                      |
// | Your value: 2.5g (PASS)                   |
// |                    [Details] [Add Claim]  |
// +------------------------------------------+
```

**ClaimDetailsModal.tsx**
```tsx
interface ClaimDetailsModalProps {
  claim: ClaimRule;
  validationResult: ClaimValidationResult;
  onClose: () => void;
  onAddClaim: () => void;
}

// Displays:
// - Full FDA definition text
// - CFR reference link
// - Threshold breakdown (per serving, per 100g, % DV)
// - Product's current values
// - Calculation methodology
// - If FAIL: "What would need to change" section
```

### UI Patterns

**Claims Panel Layout:**
```
+--------------------------------------------------+
| Nutrition Claims Eligibility                      |
|                                                   |
| [icon] Low Fat          [Eligible]   [Add Claim]  |
| [icon] Low Sodium       [Eligible]   [Add Claim]  |
| [icon] High Fiber       [Not Eligible]            |
|        Requires 5g fiber (you have 3.2g)          |
| [icon] Good Source      [Eligible]   [Add Claim]  |
|        of Protein                                 |
| [icon] Reduced Sugar    [Select Reference]        |
|        Requires comparison product                |
|                                                   |
| Approved Claims: Low Fat, Good Source of Protein  |
+--------------------------------------------------+
```

**Claim Status Badges:**
```
[checkmark] Eligible     - Green background
[X] Not Eligible         - Red background
[!] Warning              - Yellow background
[?] Needs Reference      - Gray background
```

## Test Cases

### Unit Tests

**nutrition-claims-service.test.ts**
```typescript
describe('NutritionClaimsService', () => {
  describe('validateClaim - Low Fat', () => {
    it('passes when fat <= 3g per serving');
    it('fails when fat > 3g per serving');
    it('returns correct reason text on failure');
    it('calculates per-serving correctly from per-100g');
  });

  describe('validateClaim - Low Sodium', () => {
    it('passes when sodium <= 140mg per serving');
    it('fails when sodium > 140mg per serving');
    it('handles missing sodium data gracefully');
  });

  describe('validateClaim - High Fiber', () => {
    it('passes when fiber >= 5g per serving');
    it('fails when fiber < 5g per serving');
    it('suggests "Good Source" alternative when 2.5-5g');
    it('checks Low Fat requirement when high_fiber');
  });

  describe('validateClaim - Good Source of Protein', () => {
    it('passes when protein is 10-19% DV');
    it('suggests "High" when protein >= 20% DV');
    it('fails when protein < 10% DV');
    it('calculates % DV correctly');
  });

  describe('validateClaim - Reduced Sugar', () => {
    it('passes when reduction >= 25%');
    it('fails when reduction < 25%');
    it('requires reference product');
    it('calculates reduction percentage correctly');
  });

  describe('validateAllClaims', () => {
    it('returns results for all active claims');
    it('handles missing nutrition data');
    it('respects serving size parameter');
  });
});
```

### Integration Tests

**nutrition-claims-api.test.ts**
```typescript
describe('Nutrition Claims API', () => {
  describe('GET /api/technical/nutrition/claims/rules', () => {
    it('returns all active claim rules');
    it('returns 401 for unauthenticated');
  });

  describe('POST /api/technical/nutrition/claims/validate', () => {
    it('validates product against all claims');
    it('returns detailed results for each claim');
    it('respects org isolation');
    it('handles missing nutrition data');
  });

  describe('POST /api/technical/products/:id/claims', () => {
    it('adds claim when validation passes');
    it('rejects claim when validation fails');
    it('records validation snapshot');
    it('requires reference product for reduced claims');
  });

  describe('DELETE /api/technical/products/:id/claims/:claimCode', () => {
    it('removes claim from product');
    it('creates audit log entry');
    it('returns 404 for non-existent claim');
  });

  describe('POST /api/technical/products/:id/claims/revalidate', () => {
    it('re-validates all product claims');
    it('marks invalid claims appropriately');
    it('updates validation timestamps');
  });
});
```

### E2E Tests

**nutrition-claims.spec.ts**
```typescript
describe('Nutrition Claims Validation', () => {
  it('displays claims eligibility panel in nutrition modal');
  it('shows pass/fail status for each claim');
  it('opens claim details modal on click');
  it('adds approved claim with button');
  it('shows warning when nutrition changes');
  it('re-validates claims on demand');
  it('filters products by claim eligibility');
});
```

## Security Considerations

1. **Data Access**
   - RLS policies enforce org_id isolation
   - Users can only validate/manage claims for their org's products
   - Cross-tenant access returns 404 (not 403)

2. **Audit Trail**
   - All claim additions/removals logged
   - Validation snapshots preserved
   - User and timestamp recorded

3. **Data Integrity**
   - Claims linked to nutrition data version
   - Stale claims flagged for re-validation
   - Reference data (claim rules) is read-only for users

## Deliverables

- [ ] `nutrition_claim_rules` reference table migration
- [ ] `product_nutrition_claims` table migration
- [ ] RLS policies for product claims
- [ ] Nutrition claims service (`lib/services/nutrition-claims-service.ts`)
- [ ] Zod schemas (`lib/validation/nutrition-claims.ts`)
- [ ] API routes for claim rules and validation
- [ ] API routes for product claims management
- [ ] ClaimsValidationPanel component
- [ ] ClaimCard component
- [ ] ClaimDetailsModal component
- [ ] AddClaimDialog component
- [ ] ApprovedClaimsBadge component
- [ ] Unit tests (>80% coverage)
- [ ] Integration tests
- [ ] E2E tests

## Definition of Done

- [ ] Low Fat claim validates correctly (<=3g per serving)
- [ ] Low Sodium claim validates correctly (<=140mg per serving)
- [ ] High Fiber claim validates correctly (>=5g per serving)
- [ ] Good Source of Protein validates correctly (10-19% DV)
- [ ] Reduced Sugar validates correctly (>=25% reduction with reference)
- [ ] Claims panel displays eligibility status for all claims
- [ ] Eligible claims can be added to product
- [ ] Approved claims shown on product detail
- [ ] Re-validation warns when nutrition data changes
- [ ] Cross-tenant access returns 404
- [ ] Audit trail records all claim changes
- [ ] Unit test coverage >= 80%
- [ ] Integration tests pass
- [ ] E2E tests pass

## References

- **FDA 21 CFR 101.54** - Nutrient content claims for "High", "Good Source", and "More"
- **FDA 21 CFR 101.60** - Nutrient content claims for "Free", "Low", "Reduced"
- **FDA 21 CFR 101.62** - Nutrient content claims for fat, saturated fat, and cholesterol
- **FDA 21 CFR 101.65** - Implied nutrient content claims
- **MonoPilot Story 02.13** - Nutrition Calculation (dependency)
- **MonoPilot FDA Compliance Guide** - `docs/3-ARCHITECTURE/guides/fda-labeling-compliance.md`
