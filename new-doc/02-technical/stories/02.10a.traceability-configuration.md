# 02.10a - Traceability Configuration + GS1 Encoding

**State:** ready
**Type:** backend + frontend
**Estimate:** M
**Primary PRD:** `docs/1-BASELINE/product/modules/technical.md` (FR-2.60, FR-2.64)
**UX Wireframes:** TEC-016 (Traceability Search - Framework), TEC-014 (Shelf Life Config - lot tracking aspects)

## Goal

Implement traceability CONFIGURATION for products including lot number format setup per product, batch size defaults, traceability level selection (lot/batch/serial), expiry date rules, and GS1 compliance settings for lot encoding. This story establishes the configuration foundation - actual trace queries are deferred to 02.10b (after Epic 05 - Warehouse).

## Scope

**Phase 1 Scope (This Story - 02.10a)**

**In scope**
- Lot number format configuration per product (prefix, pattern, auto-increment)
- Batch size defaults per product (standard batch, minimum batch, maximum batch)
- Traceability level selection: lot, batch, or serial per product
- Expiry date calculation rules (fixed days, rolling from ingredients, manual)
- GS1-128 lot encoding settings (AI 10 for lot, AI 17 for expiry)
- GS1 encoding service (standalone utility)
- Lot configuration modal for product-level settings
- Traceability search page FRAMEWORK (shows empty state until Epic 05)
- GET/PUT /api/technical/traceability/products/:id/config

**Out of scope (Deferred to 02.10b)**
- Forward traceability API (where-used query) - requires `license_plates` table
- Backward traceability API (what-consumed query) - requires `lp_genealogy` table
- Recall simulation API with impact assessment - requires LP data
- Genealogy tree data structure for lot relationships - requires LP data
- Traceability matrix report generation - requires LP data
- List/tree/matrix views with actual data

**Phase 2 Scope (Story 02.10b - After Epic 05)**
- Forward/backward trace queries (requires license_plates table)
- Recall simulation
- Genealogy tree visualization
- Matrix report export

## Dependencies

### Cross-Epic Dependencies
- **02.1** - Products CRUD (products table must exist)
- **01.1** - Org Context + Base RLS (organizations, users tables)

### NO Warehouse/LP Dependency
This story implements traceability CONFIGURATION only. Actual trace queries (forward/backward trace, genealogy tree) are deferred to 02.10b after Epic 05 (Warehouse - License Plates).

## Acceptance Criteria (Given/When/Then)

### Lot Number Format Configuration
- GIVEN a user editing product lot settings, WHEN they configure lot format as "LOT-{YYYY}-{SEQ:6}", THEN the pattern is saved and validated for correct placeholders.
- GIVEN a user configuring lot format, WHEN they enter an invalid placeholder (e.g., {INVALID}), THEN validation error is displayed.
- GIVEN multiple products, WHEN each has a unique lot format prefix, THEN lot numbers remain unique within the organization.

### Batch Size Defaults
- GIVEN a user setting batch defaults, WHEN they enter standard_batch_size=1000, min_batch=500, max_batch=2000, THEN values are validated (min <= standard <= max).
- GIVEN batch defaults configured, WHEN a work order is created for that product (Epic 03), THEN batch size defaults are pre-populated.
- GIVEN min_batch > max_batch, WHEN user attempts to save, THEN validation error prevents save.

### Traceability Level Selection
- GIVEN a user configuring traceability, WHEN they select "lot" level, THEN product tracks at lot granularity (multiple units per lot).
- GIVEN a user configuring traceability, WHEN they select "batch" level, THEN product tracks at batch granularity (production run based).
- GIVEN a user configuring traceability, WHEN they select "serial" level, THEN product tracks at unit level (1 unit = 1 serial number).
- GIVEN product type is "FG" (finished goods), WHEN traceability is not configured, THEN default to "lot" level with warning.

### Expiry Date Rules
- GIVEN expiry_calculation_method = "fixed_days", WHEN configuration saved, THEN system stores method for future lot creation.
- GIVEN expiry_calculation_method = "rolling", WHEN configuration saved, THEN processing_buffer_days field is required.
- GIVEN expiry_calculation_method = "manual", WHEN configuration saved, THEN system records manual entry required.

### GS1 Compliance Settings
- GIVEN GS1 lot encoding enabled, WHEN configuration saved, THEN gs1_lot_encoding_enabled = true stored.
- GIVEN GS1 expiry encoding enabled, WHEN configuration saved, THEN gs1_expiry_encoding_enabled = true stored.
- GIVEN lot number exceeds 20 characters, WHEN validation runs, THEN warning is displayed (GS1 AI 10 max length).

### GS1 Encoding Service
- GIVEN lot number "LOT-2025-000001", WHEN encodeLotNumber() called, THEN returns GS1-128 AI 10 encoded string.
- GIVEN expiry date 2025-06-15, WHEN encodeExpiryDate() called, THEN returns "250615" (YYMMDD format).
- GIVEN GTIN "12345678901234", WHEN validateGTIN14() called, THEN validates check digit.

### Traceability Search Page (Framework Only)
- GIVEN user navigates to /technical/traceability, WHEN page loads, THEN shows search form with direction toggle.
- GIVEN user attempts to search before Epic 05, WHEN search executed, THEN shows empty state: "License Plates and genealogy tracking will be available in Epic 05 (Warehouse)".
- GIVEN traceability page rendered, WHEN list/tree/matrix view toggles clicked, THEN shows "Coming Soon" placeholder.

### Multi-tenancy
- GIVEN User A from Org A, WHEN they save traceability config, THEN config stored with org_id isolation.
- GIVEN User A attempts to access config for Product X from Org B, WHEN API called, THEN 404 Not Found returned.

## Implementation Notes

### API Endpoints

```
# Traceability Configuration
GET    /api/technical/traceability/products/:id/config    - Get lot/batch config for product
PUT    /api/technical/traceability/products/:id/config    - Update lot/batch config
```

**Request/Response Schemas:**

```typescript
// Traceability Config
interface TraceabilityConfig {
  product_id: string;
  lot_number_format: string;           // e.g., "LOT-{YYYY}-{SEQ:6}"
  lot_number_prefix: string;           // e.g., "LOT-"
  lot_number_sequence_length: number;  // e.g., 6
  traceability_level: 'lot' | 'batch' | 'serial';
  standard_batch_size: number;
  min_batch_size: number;
  max_batch_size: number;
  expiry_calculation_method: 'fixed_days' | 'rolling' | 'manual';
  processing_buffer_days: number;      // for rolling expiry
  gs1_lot_encoding_enabled: boolean;
  gs1_expiry_encoding_enabled: boolean;
  gs1_sscc_enabled: boolean;
  updated_at: Date;
  updated_by: string;
}
```

### Database

**New Table: product_traceability_config**
```sql
CREATE TABLE product_traceability_config (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id),
  product_id UUID NOT NULL REFERENCES products(id) UNIQUE,
  lot_number_format TEXT NOT NULL DEFAULT 'LOT-{YYYY}-{SEQ:6}',
  lot_number_prefix TEXT NOT NULL DEFAULT 'LOT-',
  lot_number_sequence_length INTEGER NOT NULL DEFAULT 6,
  traceability_level TEXT NOT NULL DEFAULT 'lot' CHECK (traceability_level IN ('lot', 'batch', 'serial')),
  standard_batch_size DECIMAL(15,4),
  min_batch_size DECIMAL(15,4),
  max_batch_size DECIMAL(15,4),
  expiry_calculation_method TEXT NOT NULL DEFAULT 'fixed_days' CHECK (expiry_calculation_method IN ('fixed_days', 'rolling', 'manual')),
  processing_buffer_days INTEGER DEFAULT 0,
  gs1_lot_encoding_enabled BOOLEAN NOT NULL DEFAULT true,
  gs1_expiry_encoding_enabled BOOLEAN NOT NULL DEFAULT true,
  gs1_sscc_enabled BOOLEAN NOT NULL DEFAULT false,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  created_by UUID REFERENCES users(id),
  updated_by UUID REFERENCES users(id),
  CONSTRAINT batch_size_check CHECK (
    min_batch_size IS NULL OR max_batch_size IS NULL OR min_batch_size <= max_batch_size
  ),
  CONSTRAINT standard_batch_check CHECK (
    standard_batch_size IS NULL OR
    (min_batch_size IS NULL OR standard_batch_size >= min_batch_size) AND
    (max_batch_size IS NULL OR standard_batch_size <= max_batch_size)
  )
);

-- RLS Policy
ALTER TABLE product_traceability_config ENABLE ROW LEVEL SECURITY;

CREATE POLICY "product_traceability_config_org_isolation" ON product_traceability_config
FOR ALL USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

-- Indexes
CREATE INDEX idx_product_traceability_config_product ON product_traceability_config(product_id);
CREATE INDEX idx_product_traceability_config_org ON product_traceability_config(org_id);
```

### Frontend Components

**Pages:**
- `app/(authenticated)/technical/traceability/page.tsx` - Traceability search page (framework)

**Components:**
- `components/technical/traceability/TraceabilitySearch.tsx` - Search form with direction toggle
- `components/technical/traceability/TraceabilityEmptyState.tsx` - Empty state for pre-Epic 05
- `components/technical/traceability/LotConfigModal.tsx` - Product lot configuration modal
- `components/technical/products/TraceabilityConfigSection.tsx` - Product form section

### Services

**Traceability Config Service:** `lib/services/traceability-config-service.ts`
```typescript
interface TraceabilityConfigService {
  getProductConfig(productId: string): Promise<TraceabilityConfig | null>;
  updateProductConfig(productId: string, config: Partial<TraceabilityConfig>): Promise<TraceabilityConfig>;

  // Lot number utilities (used by future Epic 05)
  validateLotFormat(format: string): boolean;
  parseLotFormat(format: string): LotFormatParts;
}
```

**GS1 Service:** `lib/services/gs1-service.ts`
```typescript
interface GS1Service {
  encodeLotNumber(lotNumber: string): string;         // AI 10
  encodeExpiryDate(expiryDate: Date): string;         // AI 17 (YYMMDD)
  encodeSSCC(sscc: string): string;                   // AI 00
  generateGS1128Barcode(data: GS1Data): string;       // Full GS1-128 barcode
  validateGTIN14(gtin: string): boolean;
  calculateCheckDigit(gtin: string): number;
}
```

### Validation Schemas

**Location:** `lib/validation/traceability.ts`

```typescript
const traceabilityConfigSchema = z.object({
  lot_number_format: z.string()
    .min(5)
    .max(50)
    .regex(/^[A-Z0-9\-{}\:]+$/, "Invalid format. Use uppercase, numbers, hyphens, and placeholders like {YYYY}, {SEQ:6}"),
  lot_number_prefix: z.string().min(1).max(20),
  lot_number_sequence_length: z.number().int().min(4).max(10),
  traceability_level: z.enum(['lot', 'batch', 'serial']),
  standard_batch_size: z.number().positive().optional().nullable(),
  min_batch_size: z.number().positive().optional().nullable(),
  max_batch_size: z.number().positive().optional().nullable(),
  expiry_calculation_method: z.enum(['fixed_days', 'rolling', 'manual']),
  processing_buffer_days: z.number().int().min(0).max(365).default(0),
  gs1_lot_encoding_enabled: z.boolean().default(true),
  gs1_expiry_encoding_enabled: z.boolean().default(true),
  gs1_sscc_enabled: z.boolean().default(false),
}).refine(data => {
  if (data.min_batch_size && data.max_batch_size) {
    return data.min_batch_size <= data.max_batch_size;
  }
  return true;
}, { message: "Minimum batch size cannot exceed maximum batch size" })
.refine(data => {
  if (data.standard_batch_size && data.min_batch_size) {
    return data.standard_batch_size >= data.min_batch_size;
  }
  return true;
}, { message: "Standard batch size must be >= minimum" })
.refine(data => {
  if (data.standard_batch_size && data.max_batch_size) {
    return data.standard_batch_size <= data.max_batch_size;
  }
  return true;
}, { message: "Standard batch size must be <= maximum" });
```

### Lot Number Format Placeholders

| Placeholder | Description | Example |
|-------------|-------------|---------|
| `{YYYY}` | 4-digit year | 2025 |
| `{YY}` | 2-digit year | 25 |
| `{MM}` | 2-digit month | 01-12 |
| `{DD}` | 2-digit day | 01-31 |
| `{SEQ:N}` | N-digit sequence | 000001 |
| `{JULIAN}` | Julian day (001-366) | 015 |
| `{PROD}` | Product code prefix | BRD |
| `{LINE}` | Production line code | L01 |

**Example Formats:**
- `LOT-{YYYY}-{SEQ:6}` -> LOT-2025-000001
- `{PROD}-{YYMMDD}-{SEQ:4}` -> BRD-250115-0001
- `{JULIAN}{YY}-{SEQ:5}` -> 01525-00001 (Julian day 15, year 25)

## Deliverables

- [ ] Database migration for product_traceability_config table
- [ ] Traceability config API endpoints (GET/PUT)
- [ ] Traceability config service (`lib/services/traceability-config-service.ts`)
- [ ] GS1 encoding service (`lib/services/gs1-service.ts`)
- [ ] Zod validation schemas (`lib/validation/traceability.ts`)
- [ ] Traceability search page framework (`/technical/traceability`) with empty state
- [ ] TraceabilitySearch component with direction toggle
- [ ] LotConfigModal component for product settings
- [ ] TraceabilityConfigSection for product form
- [ ] RLS policies for traceability config table
- [ ] Unit tests for GS1 service (>90% coverage)
- [ ] Unit tests for traceability config service (>80% coverage)
- [ ] Integration tests for config APIs

## Definition of Done

- [ ] Lot number format configuration saves and validates correctly
- [ ] Batch size constraints enforced (min <= standard <= max)
- [ ] Traceability level selection persists per product
- [ ] Expiry calculation method options available (fixed, rolling, manual)
- [ ] GS1 encoding service correctly encodes AI 10 (lot) and AI 17 (expiry)
- [ ] GS1 GTIN-14 validation works correctly
- [ ] Traceability search page shows framework with empty state
- [ ] Empty state message explains Epic 05 dependency
- [ ] RLS enforces org isolation on config table
- [ ] Cross-tenant config access returns 404
- [ ] Unit tests pass with >= 80% coverage
- [ ] Integration tests cover config CRUD
- [ ] Loading states displayed during save operations
- [ ] Error states handled with validation messages

---

## Relationship to Story 02.10b

This story (02.10a) provides the **configuration foundation**. Story 02.10b will build on this foundation after Epic 05 (Warehouse) provides the `license_plates` and `lp_genealogy` tables.

```
02.10a (This Story)          02.10b (Deferred)
------------------          -----------------
- Config tables             - Forward trace queries
- GS1 service               - Backward trace queries
- Lot format setup          - Recall simulation
- Search page framework     - Genealogy tree view
                            - Matrix report export

Dependencies:               Dependencies:
- 02.1 (Products)           - 02.10a (Config)
- 01.1 (Org/RLS)           - Epic 05 (Warehouse/LP)
```
