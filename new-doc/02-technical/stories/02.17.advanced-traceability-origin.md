# 02.17 - Advanced Traceability & Origin Tracking

**Story ID:** 02.17
**Epic:** 02 - Technical
**Phase:** Phase 2 (P2)
**Complexity:** M (Medium)
**Estimate:** 3-4 days
**Type:** Backend + Frontend
**State:** ready

**Primary PRD:** `docs/1-BASELINE/product/modules/TECHNICAL.md` (FR-2.66, FR-2.67)
**Related Stories:** 02.10a (Traceability Configuration), 02.10b (Traceability Queries)

## PRD References

| FR ID | Requirement | Priority | Phase | Covered |
|-------|-------------|----------|-------|---------|
| FR-2.66 | Ingredient origin tracking | P2 | Future | Yes |
| FR-2.67 | Cross-contamination tracking | P2 | Future | Yes |

## User Story

**As a** quality manager,
**I want** to track ingredient origin (country, supplier, farm, certifications) and cross-contamination risks,
**So that** I can comply with food safety regulations, respond to recalls by origin, and manage allergen cross-contamination in production.

**As a** production planner,
**I want** to see which production lines have shared allergen exposure,
**So that** I can schedule production to minimize cross-contamination risk and plan appropriate cleaning cycles.

## Goal

Implement advanced traceability features for ingredient origin tracking and cross-contamination risk management. This extends the base traceability (02.10a/b) with:
1. **Origin tracking**: Country of origin, supplier/farm info, certifications (organic, halal, kosher)
2. **Cross-contamination tracking**: Allergen transfer risk on shared production lines, cleaning validation

## Scope

**In scope:**
- Ingredient origin configuration (country, region, farm, supplier)
- Origin certifications (organic, non-GMO, halal, kosher, fair-trade)
- Origin-based queries ("show all lots from country X")
- Cross-contamination risk matrix (allergen x production line)
- Production line allergen history tracking
- Cleaning validation records for allergen changeover
- Contamination risk assessment per lot
- Integration with existing traceability (02.10a product config)

**Out of scope:**
- Supplier qualification/audit management (future: Supplier module)
- Real-time contamination sensors/IoT integration (future: OEE module)
- Blockchain-based supply chain verification (future enhancement)
- Environmental contamination (air, water) tracking

## Dependencies

| Story | Requirement | Status |
|-------|-------------|--------|
| 02.10a | Traceability Configuration | Required - provides base config table |
| 02.10b | Traceability Queries | Required - provides genealogy structure |
| 01.12 | Allergens (Global) | Required - EU allergen reference |
| Epic 05 | Warehouse (License Plates) | Soft - origin links to LP lots |

## Acceptance Criteria (Given/When/Then)

### Origin Tracking (FR-2.66)

#### Origin Configuration
- GIVEN user editing ingredient origin, WHEN they select country "Poland", region "Mazovia", THEN origin is saved with ISO country code (PL).
- GIVEN user adding supplier farm info, WHEN they enter farm name, farm ID, address, THEN farm is linked to ingredient origin.
- GIVEN user configuring origin certifications, WHEN they select "Organic", "Halal", THEN certifications are stored with validity dates.
- GIVEN origin configured for ingredient, WHEN lot is received, THEN lot inherits origin from ingredient (can be overridden).

#### Origin Queries
- GIVEN lots with different origins, WHEN user filters by country "Germany", THEN only German-origin lots are returned.
- GIVEN recall for "Farm XYZ" products, WHEN origin-based query runs, THEN all lots from that farm are identified.
- GIVEN certification expiry date passed, WHEN origin report runs, THEN warning shows for expired certifications.
- GIVEN multiple suppliers for same ingredient, WHEN origin report generated, THEN shows supplier distribution with percentages.

#### Origin Certifications
- GIVEN user adds "Organic" certification, WHEN expiry date is past, THEN validation error "Certification expired" displays.
- GIVEN active certifications exist, WHEN product label generated, THEN certifications appear on label (e.g., "Certified Organic").
- GIVEN certification renewal needed, WHEN expiry <30 days, THEN dashboard warning displays.

### Cross-Contamination Tracking (FR-2.67)

#### Allergen Line History
- GIVEN production line L1 ran product with "Gluten", WHEN history queried, THEN shows last 10 products with allergens.
- GIVEN line L1 has allergen history [Gluten, Milk, Eggs], WHEN new product with "Peanuts" scheduled, THEN cross-contamination risk calculated.
- GIVEN cleaning performed after allergen product, WHEN cleaning record saved, THEN line allergen status is "Clear" until next allergen run.

#### Risk Matrix
- GIVEN 5 production lines and 14 allergens, WHEN contamination matrix requested, THEN 5x14 matrix shows risk levels (None/Low/Medium/High).
- GIVEN line L1 ran "Gluten" 2 hours ago, WHEN matrix displayed, THEN L1 x Gluten shows "High" risk.
- GIVEN line L1 cleaned and validated, WHEN matrix refreshed, THEN L1 x Gluten shows "None" risk.

#### Cleaning Validation
- GIVEN allergen changeover required, WHEN user records cleaning, THEN cleaning record includes: method, duration, validator, timestamp.
- GIVEN cleaning record exists, WHEN validation status checked, THEN shows: "Validated" / "Pending Validation" / "Failed".
- GIVEN cleaning validation failed, WHEN next production attempted, THEN warning displays "Cleaning validation required".

#### Contamination Assessment
- GIVEN lot LP-001 produced on line with prior allergen exposure, WHEN contamination assessment runs, THEN shows: allergens present on line, time since last cleaning, risk level.
- GIVEN contamination risk is "High", WHEN lot status checked, THEN "May Contain" allergen flag suggested.
- GIVEN contamination assessment result, WHEN saved, THEN stored with lot for traceability.

### Multi-tenancy
- GIVEN User A from Org A, WHEN saving origin data, THEN org_id isolation enforced.
- GIVEN User A attempts to view Org B origin data, WHEN API called, THEN 404 Not Found returns.

## Technical Specification

### Database Schema

#### ingredient_origin table

```sql
CREATE TABLE ingredient_origin (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  product_id UUID NOT NULL REFERENCES products(id) ON DELETE CASCADE,

  -- Country/Region
  country_code VARCHAR(2) NOT NULL,              -- ISO 3166-1 alpha-2 (PL, DE, US)
  country_name VARCHAR(100) NOT NULL,            -- Poland, Germany, United States
  region VARCHAR(100),                           -- Mazovia, Bavaria, California
  sub_region VARCHAR(100),                       -- County/Province (optional)

  -- Supplier/Farm
  supplier_id UUID REFERENCES suppliers(id),     -- Link to supplier (if exists)
  farm_name VARCHAR(255),                        -- Farm/producer name
  farm_id VARCHAR(50),                           -- Farm registration ID
  farm_address TEXT,                             -- Farm address (optional)
  farm_coordinates POINT,                        -- GPS coordinates (optional)

  -- Metadata
  is_primary BOOLEAN NOT NULL DEFAULT true,      -- Primary origin (for multi-source)
  percentage DECIMAL(5,2) DEFAULT 100,           -- % from this origin (for blends)
  notes TEXT,

  -- Audit
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  created_by UUID REFERENCES users(id),
  updated_by UUID REFERENCES users(id),

  -- Constraints
  CONSTRAINT check_country_code CHECK (country_code ~ '^[A-Z]{2}$'),
  CONSTRAINT check_percentage CHECK (percentage > 0 AND percentage <= 100),
  CONSTRAINT unique_product_origin UNIQUE (org_id, product_id, supplier_id, farm_id)
);

-- Indexes
CREATE INDEX idx_ingredient_origin_org ON ingredient_origin(org_id);
CREATE INDEX idx_ingredient_origin_product ON ingredient_origin(product_id);
CREATE INDEX idx_ingredient_origin_country ON ingredient_origin(country_code);
CREATE INDEX idx_ingredient_origin_supplier ON ingredient_origin(supplier_id);
```

#### origin_certifications table

```sql
CREATE TABLE origin_certifications (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  origin_id UUID NOT NULL REFERENCES ingredient_origin(id) ON DELETE CASCADE,

  -- Certification details
  certification_type VARCHAR(50) NOT NULL,       -- 'organic', 'halal', 'kosher', 'non_gmo', 'fair_trade'
  certification_name VARCHAR(255) NOT NULL,      -- "USDA Organic", "Islamic Food Council Halal"
  certifying_body VARCHAR(255) NOT NULL,         -- Certifying organization
  certificate_number VARCHAR(100),               -- Certificate ID

  -- Validity
  issued_date DATE NOT NULL,
  expiry_date DATE NOT NULL,
  is_active BOOLEAN NOT NULL DEFAULT true,

  -- Documentation
  certificate_url TEXT,                          -- Link to certificate document
  notes TEXT,

  -- Audit
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  created_by UUID REFERENCES users(id),

  -- Constraints
  CONSTRAINT check_certification_type CHECK (
    certification_type IN ('organic', 'halal', 'kosher', 'non_gmo', 'fair_trade', 'gluten_free', 'vegan', 'other')
  ),
  CONSTRAINT check_expiry_after_issued CHECK (expiry_date > issued_date)
);

-- Indexes
CREATE INDEX idx_origin_certifications_org ON origin_certifications(org_id);
CREATE INDEX idx_origin_certifications_origin ON origin_certifications(origin_id);
CREATE INDEX idx_origin_certifications_type ON origin_certifications(certification_type);
CREATE INDEX idx_origin_certifications_expiry ON origin_certifications(expiry_date);
```

#### line_allergen_history table

```sql
CREATE TABLE line_allergen_history (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  line_id UUID NOT NULL REFERENCES production_lines(id) ON DELETE CASCADE,

  -- Allergen exposure
  allergen_id UUID NOT NULL REFERENCES allergens(id),
  work_order_id UUID REFERENCES work_orders(id),
  product_id UUID REFERENCES products(id),

  -- Timing
  started_at TIMESTAMPTZ NOT NULL,
  ended_at TIMESTAMPTZ,

  -- Quantity
  quantity DECIMAL(15,4),
  uom VARCHAR(10),

  -- Status
  status VARCHAR(20) NOT NULL DEFAULT 'active',  -- 'active', 'completed', 'cleaned'

  -- Audit
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  created_by UUID REFERENCES users(id),

  -- Constraints
  CONSTRAINT check_status CHECK (status IN ('active', 'completed', 'cleaned'))
);

-- Indexes
CREATE INDEX idx_line_allergen_history_org ON line_allergen_history(org_id);
CREATE INDEX idx_line_allergen_history_line ON line_allergen_history(line_id);
CREATE INDEX idx_line_allergen_history_allergen ON line_allergen_history(allergen_id);
CREATE INDEX idx_line_allergen_history_started ON line_allergen_history(started_at DESC);
CREATE INDEX idx_line_allergen_history_status ON line_allergen_history(status);
```

#### cleaning_validations table

```sql
CREATE TABLE cleaning_validations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  line_id UUID NOT NULL REFERENCES production_lines(id) ON DELETE CASCADE,

  -- Cleaning details
  cleaning_method VARCHAR(50) NOT NULL,          -- 'wet', 'dry', 'allergen_wash', 'sanitize'
  cleaning_duration_minutes INTEGER NOT NULL,
  cleaning_started_at TIMESTAMPTZ NOT NULL,
  cleaning_ended_at TIMESTAMPTZ NOT NULL,

  -- Target allergens
  target_allergens UUID[] NOT NULL,              -- Array of allergen IDs being cleared

  -- Validation
  validated_by UUID REFERENCES users(id),
  validated_at TIMESTAMPTZ,
  validation_status VARCHAR(20) NOT NULL DEFAULT 'pending',  -- 'pending', 'passed', 'failed'
  validation_method VARCHAR(50),                 -- 'visual', 'swab_test', 'atp_test'
  validation_result TEXT,                        -- Test results/notes

  -- Previous allergen context
  previous_product_id UUID REFERENCES products(id),
  previous_allergens UUID[],                     -- Allergens from previous run

  -- Audit
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  created_by UUID REFERENCES users(id),

  -- Constraints
  CONSTRAINT check_cleaning_method CHECK (
    cleaning_method IN ('wet', 'dry', 'allergen_wash', 'sanitize', 'full_cip', 'other')
  ),
  CONSTRAINT check_validation_status CHECK (
    validation_status IN ('pending', 'passed', 'failed', 'waived')
  ),
  CONSTRAINT check_duration CHECK (cleaning_duration_minutes > 0)
);

-- Indexes
CREATE INDEX idx_cleaning_validations_org ON cleaning_validations(org_id);
CREATE INDEX idx_cleaning_validations_line ON cleaning_validations(line_id);
CREATE INDEX idx_cleaning_validations_status ON cleaning_validations(validation_status);
CREATE INDEX idx_cleaning_validations_date ON cleaning_validations(cleaning_started_at DESC);
```

#### lot_contamination_assessments table

```sql
CREATE TABLE lot_contamination_assessments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  lot_id UUID NOT NULL,                          -- Reference to license_plates (Epic 05)

  -- Assessment context
  line_id UUID NOT NULL REFERENCES production_lines(id),
  work_order_id UUID REFERENCES work_orders(id),
  assessed_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),

  -- Risk assessment
  overall_risk_level VARCHAR(10) NOT NULL,       -- 'none', 'low', 'medium', 'high'
  allergen_risks JSONB NOT NULL DEFAULT '[]',    -- [{allergen_id, risk_level, reason}]

  -- Line state at production
  hours_since_last_cleaning DECIMAL(6,2),
  last_cleaning_id UUID REFERENCES cleaning_validations(id),
  previous_allergens_on_line UUID[],

  -- Decision
  may_contain_allergens UUID[],                  -- Suggested "may contain" allergens
  decision_notes TEXT,
  approved_by UUID REFERENCES users(id),
  approved_at TIMESTAMPTZ,

  -- Audit
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  created_by UUID REFERENCES users(id),

  -- Constraints
  CONSTRAINT check_risk_level CHECK (overall_risk_level IN ('none', 'low', 'medium', 'high'))
);

-- Indexes
CREATE INDEX idx_lot_contamination_org ON lot_contamination_assessments(org_id);
CREATE INDEX idx_lot_contamination_lot ON lot_contamination_assessments(lot_id);
CREATE INDEX idx_lot_contamination_line ON lot_contamination_assessments(line_id);
CREATE INDEX idx_lot_contamination_risk ON lot_contamination_assessments(overall_risk_level);
```

### RLS Policies

```sql
-- ingredient_origin
ALTER TABLE ingredient_origin ENABLE ROW LEVEL SECURITY;

CREATE POLICY ingredient_origin_org_isolation ON ingredient_origin
FOR ALL USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

-- origin_certifications
ALTER TABLE origin_certifications ENABLE ROW LEVEL SECURITY;

CREATE POLICY origin_certifications_org_isolation ON origin_certifications
FOR ALL USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

-- line_allergen_history
ALTER TABLE line_allergen_history ENABLE ROW LEVEL SECURITY;

CREATE POLICY line_allergen_history_org_isolation ON line_allergen_history
FOR ALL USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

-- cleaning_validations
ALTER TABLE cleaning_validations ENABLE ROW LEVEL SECURITY;

CREATE POLICY cleaning_validations_org_isolation ON cleaning_validations
FOR ALL USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

-- lot_contamination_assessments
ALTER TABLE lot_contamination_assessments ENABLE ROW LEVEL SECURITY;

CREATE POLICY lot_contamination_org_isolation ON lot_contamination_assessments
FOR ALL USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));
```

### API Endpoints

```
# Origin Management
GET    /api/technical/origin/products/:productId         - Get origin for product
POST   /api/technical/origin/products/:productId         - Add origin to product
PUT    /api/technical/origin/:originId                   - Update origin
DELETE /api/technical/origin/:originId                   - Delete origin

# Origin Certifications
GET    /api/technical/origin/:originId/certifications    - List certifications
POST   /api/technical/origin/:originId/certifications    - Add certification
PUT    /api/technical/origin/certifications/:certId      - Update certification
DELETE /api/technical/origin/certifications/:certId      - Delete certification

# Origin Queries
GET    /api/technical/origin/query                       - Query by country/supplier/farm
GET    /api/technical/origin/expiring-certifications     - List expiring certifications

# Cross-Contamination
GET    /api/technical/contamination/lines/:lineId/history         - Line allergen history
POST   /api/technical/contamination/lines/:lineId/allergen        - Record allergen exposure
GET    /api/technical/contamination/matrix                        - Get contamination risk matrix
GET    /api/technical/contamination/lines/:lineId/risk            - Get line risk assessment

# Cleaning Validations
GET    /api/technical/contamination/lines/:lineId/cleanings       - List cleaning records
POST   /api/technical/contamination/lines/:lineId/cleanings       - Record cleaning
PUT    /api/technical/contamination/cleanings/:cleaningId         - Update cleaning
POST   /api/technical/contamination/cleanings/:cleaningId/validate - Validate cleaning

# Lot Contamination Assessment
POST   /api/technical/contamination/lots/:lotId/assess            - Assess lot contamination
GET    /api/technical/contamination/lots/:lotId/assessment        - Get lot assessment
```

### Service Methods

**Location:** `lib/services/origin-service.ts`

```typescript
interface OriginService {
  // Origin CRUD
  getProductOrigins(productId: string): Promise<IngredientOrigin[]>;
  addOrigin(productId: string, origin: CreateOriginDTO): Promise<IngredientOrigin>;
  updateOrigin(originId: string, data: UpdateOriginDTO): Promise<IngredientOrigin>;
  deleteOrigin(originId: string): Promise<void>;

  // Certifications
  getCertifications(originId: string): Promise<OriginCertification[]>;
  addCertification(originId: string, cert: CreateCertificationDTO): Promise<OriginCertification>;
  updateCertification(certId: string, data: UpdateCertificationDTO): Promise<OriginCertification>;
  deleteCertification(certId: string): Promise<void>;

  // Queries
  queryByCountry(countryCode: string): Promise<OriginQueryResult[]>;
  queryBySupplier(supplierId: string): Promise<OriginQueryResult[]>;
  queryByFarm(farmId: string): Promise<OriginQueryResult[]>;
  getExpiringCertifications(daysAhead: number): Promise<ExpiringCertification[]>;
}

interface IngredientOrigin {
  id: string;
  product_id: string;
  country_code: string;
  country_name: string;
  region?: string;
  supplier_id?: string;
  farm_name?: string;
  farm_id?: string;
  is_primary: boolean;
  percentage: number;
  certifications?: OriginCertification[];
}

interface OriginCertification {
  id: string;
  certification_type: CertificationType;
  certification_name: string;
  certifying_body: string;
  certificate_number?: string;
  issued_date: string;
  expiry_date: string;
  is_active: boolean;
  days_until_expiry?: number;
}

type CertificationType = 'organic' | 'halal' | 'kosher' | 'non_gmo' | 'fair_trade' | 'gluten_free' | 'vegan' | 'other';
```

**Location:** `lib/services/contamination-service.ts`

```typescript
interface ContaminationService {
  // Line allergen history
  getLineAllergenHistory(lineId: string, limit?: number): Promise<LineAllergenEntry[]>;
  recordAllergenExposure(lineId: string, data: AllergenExposureDTO): Promise<LineAllergenEntry>;

  // Risk matrix
  getContaminationMatrix(): Promise<ContaminationMatrix>;
  getLineRiskAssessment(lineId: string): Promise<LineRiskAssessment>;

  // Cleaning
  getCleaningRecords(lineId: string): Promise<CleaningValidation[]>;
  recordCleaning(lineId: string, data: CreateCleaningDTO): Promise<CleaningValidation>;
  validateCleaning(cleaningId: string, validation: ValidationDTO): Promise<CleaningValidation>;

  // Lot assessment
  assessLotContamination(lotId: string): Promise<LotContaminationAssessment>;
  getLotAssessment(lotId: string): Promise<LotContaminationAssessment | null>;
}

interface ContaminationMatrix {
  lines: ProductionLine[];
  allergens: Allergen[];
  risks: MatrixCell[][];  // [line_index][allergen_index]
}

interface MatrixCell {
  line_id: string;
  allergen_id: string;
  risk_level: 'none' | 'low' | 'medium' | 'high';
  last_exposure_at?: string;
  hours_since_exposure?: number;
  cleaned_at?: string;
}

interface LineRiskAssessment {
  line_id: string;
  line_name: string;
  current_allergens: AllergenRisk[];
  last_cleaning?: CleaningValidation;
  overall_risk: 'none' | 'low' | 'medium' | 'high';
}

interface LotContaminationAssessment {
  lot_id: string;
  overall_risk_level: 'none' | 'low' | 'medium' | 'high';
  allergen_risks: AllergenRisk[];
  may_contain_allergens: string[];
  hours_since_last_cleaning?: number;
  decision_notes?: string;
}
```

### Zod Validation Schemas

**Location:** `lib/validation/origin.ts`

```typescript
import { z } from 'zod';

// ISO 3166-1 alpha-2 country code
const countryCodeSchema = z.string().regex(/^[A-Z]{2}$/, 'Invalid country code');

export const createOriginSchema = z.object({
  country_code: countryCodeSchema,
  country_name: z.string().min(2).max(100),
  region: z.string().max(100).optional().nullable(),
  sub_region: z.string().max(100).optional().nullable(),
  supplier_id: z.string().uuid().optional().nullable(),
  farm_name: z.string().max(255).optional().nullable(),
  farm_id: z.string().max(50).optional().nullable(),
  farm_address: z.string().optional().nullable(),
  is_primary: z.boolean().default(true),
  percentage: z.number().min(0.01).max(100).default(100),
  notes: z.string().optional().nullable(),
});

export const certificationTypeSchema = z.enum([
  'organic', 'halal', 'kosher', 'non_gmo', 'fair_trade', 'gluten_free', 'vegan', 'other'
]);

export const createCertificationSchema = z.object({
  certification_type: certificationTypeSchema,
  certification_name: z.string().min(1).max(255),
  certifying_body: z.string().min(1).max(255),
  certificate_number: z.string().max(100).optional().nullable(),
  issued_date: z.string().datetime(),
  expiry_date: z.string().datetime(),
  certificate_url: z.string().url().optional().nullable(),
  notes: z.string().optional().nullable(),
}).refine(
  (data) => new Date(data.expiry_date) > new Date(data.issued_date),
  { message: 'Expiry date must be after issued date', path: ['expiry_date'] }
);

export const originQuerySchema = z.object({
  country_code: countryCodeSchema.optional(),
  supplier_id: z.string().uuid().optional(),
  farm_id: z.string().optional(),
  certification_type: certificationTypeSchema.optional(),
  include_expired: z.boolean().default(false),
});
```

**Location:** `lib/validation/contamination.ts`

```typescript
import { z } from 'zod';

export const cleaningMethodSchema = z.enum([
  'wet', 'dry', 'allergen_wash', 'sanitize', 'full_cip', 'other'
]);

export const validationMethodSchema = z.enum([
  'visual', 'swab_test', 'atp_test', 'other'
]);

export const riskLevelSchema = z.enum(['none', 'low', 'medium', 'high']);

export const createCleaningSchema = z.object({
  cleaning_method: cleaningMethodSchema,
  cleaning_duration_minutes: z.number().int().min(1).max(480),
  cleaning_started_at: z.string().datetime(),
  cleaning_ended_at: z.string().datetime(),
  target_allergens: z.array(z.string().uuid()).min(1),
  previous_product_id: z.string().uuid().optional().nullable(),
  previous_allergens: z.array(z.string().uuid()).optional(),
}).refine(
  (data) => new Date(data.cleaning_ended_at) > new Date(data.cleaning_started_at),
  { message: 'End time must be after start time', path: ['cleaning_ended_at'] }
);

export const validateCleaningSchema = z.object({
  validation_method: validationMethodSchema,
  validation_status: z.enum(['passed', 'failed', 'waived']),
  validation_result: z.string().optional().nullable(),
});

export const allergenExposureSchema = z.object({
  allergen_id: z.string().uuid(),
  work_order_id: z.string().uuid().optional(),
  product_id: z.string().uuid().optional(),
  started_at: z.string().datetime(),
  ended_at: z.string().datetime().optional(),
  quantity: z.number().positive().optional(),
  uom: z.string().max(10).optional(),
});
```

## UI Components

### Pages

- `app/(authenticated)/technical/traceability/origin/page.tsx` - Origin management
- `app/(authenticated)/technical/traceability/contamination/page.tsx` - Cross-contamination dashboard

### Components

**Location:** `components/technical/traceability/`

```
OriginConfigPanel.tsx        - Origin configuration for product
OriginCard.tsx               - Display single origin with certifications
OriginCertificationForm.tsx  - Add/edit certification modal
OriginQueryForm.tsx          - Query by country/supplier/farm

ContaminationMatrix.tsx      - Allergen x Line risk matrix
LineAllergenHistory.tsx      - History list for production line
CleaningRecordForm.tsx       - Record cleaning modal
CleaningValidationForm.tsx   - Validate cleaning modal
LotAssessmentPanel.tsx       - Lot contamination assessment display
RiskBadge.tsx                - Risk level badge (None/Low/Medium/High)
```

### Component Details

**ContaminationMatrix.tsx**
```tsx
interface ContaminationMatrixProps {
  lines: ProductionLine[];
  allergens: Allergen[];
  matrix: MatrixCell[][];
  onCellClick?: (lineId: string, allergenId: string) => void;
}

// Displays grid:
// |           | Gluten | Milk | Eggs | Peanuts | ...
// | Line A    | HIGH   | LOW  | NONE | NONE    |
// | Line B    | NONE   | HIGH | HIGH | NONE    |
// Color coding: NONE=gray, LOW=yellow, MEDIUM=orange, HIGH=red
```

**OriginConfigPanel.tsx**
```tsx
interface OriginConfigPanelProps {
  productId: string;
  origins: IngredientOrigin[];
  onAddOrigin: (origin: CreateOriginDTO) => void;
  onUpdateOrigin: (originId: string, data: UpdateOriginDTO) => void;
  onDeleteOrigin: (originId: string) => void;
}

// Form fields:
// - Country (dropdown with ISO codes)
// - Region (text input)
// - Supplier (dropdown from suppliers table)
// - Farm Name, Farm ID (text inputs)
// - Percentage (number, for blends)
// - Certifications (expandable section)
```

## Test Cases

### Unit Tests

**origin-service.test.ts**
```typescript
describe('OriginService', () => {
  describe('addOrigin', () => {
    it('creates origin with valid country code');
    it('validates ISO country code format');
    it('links to existing supplier when provided');
    it('calculates percentage sum for multi-origin products');
  });

  describe('certifications', () => {
    it('adds certification with valid dates');
    it('rejects expired certification on add');
    it('calculates days until expiry');
    it('returns expiring certifications within threshold');
  });

  describe('queryByCountry', () => {
    it('returns all products from specified country');
    it('includes certification info in results');
    it('respects org isolation');
  });
});
```

**contamination-service.test.ts**
```typescript
describe('ContaminationService', () => {
  describe('getContaminationMatrix', () => {
    it('returns matrix for all lines and allergens');
    it('calculates risk based on time since exposure');
    it('sets risk to NONE after validated cleaning');
  });

  describe('assessLotContamination', () => {
    it('returns NONE risk for clean line');
    it('returns HIGH risk for recent allergen exposure without cleaning');
    it('suggests may_contain allergens based on risk');
  });

  describe('validateCleaning', () => {
    it('updates line allergen history on passed validation');
    it('keeps risk high on failed validation');
    it('records validator and timestamp');
  });
});
```

### Integration Tests

**origin-api.test.ts**
```typescript
describe('Origin API', () => {
  describe('POST /api/technical/origin/products/:productId', () => {
    it('creates origin for product');
    it('validates country code format');
    it('returns 404 for non-existent product');
    it('enforces org isolation');
  });

  describe('GET /api/technical/origin/query', () => {
    it('filters by country code');
    it('filters by supplier');
    it('includes certifications when requested');
  });
});
```

**contamination-api.test.ts**
```typescript
describe('Contamination API', () => {
  describe('GET /api/technical/contamination/matrix', () => {
    it('returns complete matrix');
    it('calculates real-time risk levels');
    it('respects org isolation');
  });

  describe('POST /api/technical/contamination/cleanings/:id/validate', () => {
    it('updates validation status');
    it('clears line allergen history on pass');
    it('requires validator permission');
  });
});
```

### E2E Tests

**origin-management.spec.ts**
```typescript
describe('Origin Management', () => {
  it('adds origin to ingredient product');
  it('adds multiple certifications');
  it('shows expiring certification warning');
  it('queries products by country');
});
```

**contamination-tracking.spec.ts**
```typescript
describe('Cross-Contamination', () => {
  it('displays contamination matrix');
  it('shows HIGH risk after allergen production');
  it('records cleaning with validation');
  it('clears risk after validated cleaning');
  it('assesses lot contamination risk');
});
```

## Deliverables

- [ ] Migration: `ingredient_origin` table with RLS
- [ ] Migration: `origin_certifications` table with RLS
- [ ] Migration: `line_allergen_history` table with RLS
- [ ] Migration: `cleaning_validations` table with RLS
- [ ] Migration: `lot_contamination_assessments` table with RLS
- [ ] API: Origin CRUD endpoints
- [ ] API: Certification endpoints
- [ ] API: Origin query endpoints
- [ ] API: Contamination matrix endpoint
- [ ] API: Cleaning validation endpoints
- [ ] API: Lot assessment endpoint
- [ ] Service: `origin-service.ts`
- [ ] Service: `contamination-service.ts`
- [ ] Validation: `lib/validation/origin.ts`
- [ ] Validation: `lib/validation/contamination.ts`
- [ ] Component: OriginConfigPanel
- [ ] Component: ContaminationMatrix
- [ ] Component: CleaningRecordForm
- [ ] Component: LotAssessmentPanel
- [ ] Page: Origin management page
- [ ] Page: Contamination dashboard page
- [ ] Unit tests (>80% coverage)
- [ ] Integration tests
- [ ] E2E tests

## Definition of Done

- [ ] Origin tracking saves country, region, supplier, farm info
- [ ] Multiple origins supported per product (blends with %)
- [ ] Certifications (organic, halal, kosher) stored with validity dates
- [ ] Expiring certification warnings display (<30 days)
- [ ] Origin queries return products by country/supplier/farm
- [ ] Contamination matrix shows all lines x allergens with risk levels
- [ ] Risk level calculated based on time since exposure and cleaning
- [ ] Cleaning records stored with method, duration, target allergens
- [ ] Cleaning validation workflow (pending -> passed/failed)
- [ ] Line allergen status cleared on validated cleaning
- [ ] Lot contamination assessment calculates risk and suggests may_contain
- [ ] RLS enforces org isolation on all tables
- [ ] Cross-tenant access returns 404
- [ ] Unit test coverage >= 80%
- [ ] Integration tests pass
- [ ] E2E tests pass
- [ ] Loading states during async operations
- [ ] Error handling with user-friendly messages

## Risk Notes

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| Supplier table not ready | Medium | Medium | Use nullable supplier_id, add link later |
| LP table dependency (Epic 05) | Medium | Low | lot_id is generic UUID, can reference later |
| Complex risk calculation | Low | Medium | Start with simple time-based rules, enhance later |
| Matrix performance (many lines) | Low | Low | Paginate lines, cache matrix for 5 min |

---

## Integration with Existing Traceability

This story extends the traceability framework established in 02.10a/02.10b:

```
02.10a (Config)                02.10b (Queries)               02.17 (Origin & Contamination)
---------------                -----------------              -----------------------------
- Lot number format            - Forward/backward trace       - Ingredient origin tracking
- GS1 encoding                 - Recall simulation            - Origin certifications
- Batch size defaults          - Genealogy tree               - Cross-contamination matrix
- Product traceability config  - Matrix report                - Cleaning validation
                                                              - Lot contamination assessment

Common tables:                                                New tables:
- product_traceability_config                                 - ingredient_origin
- license_plates (Epic 05)                                    - origin_certifications
- lp_genealogy (Epic 05)                                      - line_allergen_history
                                                              - cleaning_validations
                                                              - lot_contamination_assessments
```
