# 02.5b - BOM Items Advanced (Phase 1)

**Priority**: P1 (Phase 1)
**Story Points**: M (Medium)
**Type:** backend + frontend

**State:** ready
**Primary PRD:** `docs/1-BASELINE/product/modules/technical.md` (FR-2.26, FR-2.27, FR-2.33)
**UX Wireframes:** TEC-006a (BOM Items Detail)

---

## MVP Scope

This story implements Phase 1 functionality. Requires 02.5a (BOM Items Core) to be complete first.

---

## Goal

Extend BOM items with advanced features: conditional items (organic, vegan, kosher, halal, gluten-free flags), by-products with yield tracking, line-specific items for production line filtering, and bulk import capabilities.

## User Story

As a **Production Manager**, I want to **mark BOM items as conditional (organic, kosher, etc.), define by-products, and assign items to specific production lines** so that **I can handle complex recipe variations and line-specific formulations**.

## Scope

**In scope (Phase 1)**
- Conditional items with flags (condition_flags JSONB) - FR-2.26
- By-products management (is_output=true, yield_percent) - FR-2.27
- Line-specific items (line_ids array) - FR-2.33
- POST /api/technical/boms/:id/items/bulk (bulk add from CSV/import)
- Byproducts section in BOM items table
- Enhanced BOM item modal with conditional/line fields
- consume_whole_lp flag for LP consumption mode

**Out of scope (this story)**
- BOM header CRUD (covered in 02.4)
- Core items CRUD (covered in 02.5a)
- Alternative ingredients (covered in 02.6)
- Multi-level BOM explosion (covered in 02.14)
- BOM cost calculation (covered in 02.9)

## Dependencies
- **02.5a** - BOM Items Core (required - builds on core items)
- **01.1** - Org Context + Base RLS (for multi-tenant isolation)
- **02.4** - BOMs CRUD (required for BOM header exists)

## Acceptance Criteria (Given/When/Then)

### AC-1: Conditional Items (FR-2.26)

**Given** user opens item modal
**When** conditional flags section shown
**Then** multi-select dropdown displays available flags (organic, vegan, gluten-free, kosher, halal)

**Given** user selects flags [organic, vegan] for item
**When** save completes
**Then** condition_flags JSONB stores {"organic": true, "vegan": true}

**Given** BOM item has condition_flags
**When** items table row renders
**Then** sub-row displays "Flags: organic, vegan" with appropriate badges

**Given** item has conditional flags
**When** BOM used in WO for organic product
**Then** conditional item included (business logic validated in Production module)

**Given** item has conditional flags
**When** BOM used in WO for non-organic product
**Then** conditional item excluded (business logic validated in Production module)

### AC-2: By-products (FR-2.27)

**Given** user clicks "[+ Add Byproduct]"
**When** modal opens
**Then** byproduct form displays: product selector (BP type only), quantity, uom, yield_percent (auto-calculated), notes

**Given** user enters byproduct quantity 2 kg for BOM output 100 kg
**When** yield_percent calculated
**Then** displays "2.0% (2 kg / 100 kg)"

**Given** byproduct saved
**When** items table renders
**Then** byproduct appears in separate "Byproducts" section with is_output=true badge

**Given** byproduct has is_by_product=true
**When** BOM items listed
**Then** byproducts grouped separately from input items

**Given** byproduct deleted
**When** confirmation accepted
**Then** byproduct removed from table

### AC-3: Line-Specific Items (FR-2.33)

**Given** user opens item modal
**When** production lines section shown
**Then** checkbox group displays all active production lines for the organization

**Given** user selects no lines (empty)
**When** save completes
**Then** line_ids = NULL (available on all lines)

**Given** user selects "Line 2 - Pastry Production" only
**When** save completes
**Then** line_ids = ["line-2-uuid"]

**Given** item has line_ids = ["line-2-uuid"]
**When** items table row renders
**Then** shows "Lines: Pastry Production" badge

**Given** item has line_ids = ["line-2-uuid"]
**When** WO created for Line 1
**Then** item NOT included in WO BOM snapshot (validated in Planning module)

### AC-4: LP Consumption Mode

**Given** user opens item modal
**When** LP mode section shown
**Then** checkbox "Consume whole LP" displayed with tooltip explaining behavior

**Given** user checks "Consume whole LP"
**When** save completes
**Then** consume_whole_lp = true

**Given** item has consume_whole_lp = true
**When** items table row renders
**Then** shows "Whole LP" indicator

### AC-5: Bulk Import

**Given** user clicks "[Import Items]"
**When** import modal opens
**Then** CSV template download link shown with format: product_code, quantity, uom, sequence, scrap_percent, operation_seq

**Given** user uploads valid CSV with 10 items
**When** import processed
**Then** all 10 items created with success message "10 items imported"

**Given** CSV has invalid row (unknown product_code)
**When** import processed
**Then** error report shows "Row 3: Product 'UNKNOWN' not found"

**Given** CSV has partial success (8 valid, 2 invalid)
**When** import processed
**Then** shows "8 items imported, 2 errors" with downloadable error report

### AC-6: Enhanced Items Display

**Given** BOM item has condition_flags, line_ids, scrap_percent
**When** row renders
**Then** expandable sub-row displays all attributes:
  - "Flags: organic, vegan"
  - "Lines: Pastry Production, Bread Line"
  - "Scrap: 2.0%"

**Given** byproducts exist for BOM
**When** items section renders
**Then** shows two sections: "Ingredients/Components" and "Byproducts"

### AC-7: Future Features (Phase 2+)

Features deferred to Phase 2+:
- **Multi-level BOM explosion** (FR-2.29) - Covered in 02.14
- **BOM scaling** (FR-2.35) - Covered in 02.14
- **Drag-drop reordering** - Deferred to future

**Developer**: Choose hiding strategy per Epic 02.0 "Future Feature Handling".

## Implementation Notes

### API Endpoints

```typescript
// Enhanced CreateBOMItemRequest (extends 02.5a)
interface CreateBOMItemRequest {
  // Core fields from 02.5a
  product_id: string;
  quantity: number;
  uom: string;
  sequence?: number;
  scrap_percent?: number;
  operation_seq?: number | null;
  notes?: string | null;

  // Phase 1 fields (this story)
  consume_whole_lp?: boolean;   // Optional: default false
  line_ids?: string[] | null;   // Optional: null = all lines
  is_by_product?: boolean;      // Optional: default false
  yield_percent?: number;       // Required if is_by_product=true
  condition_flags?: object | null; // Optional: JSONB
}

// POST /api/technical/boms/:id/items/bulk
interface BulkImportRequest {
  items: CreateBOMItemRequest[];
}

interface BulkImportResponse {
  created: number;
  errors: {
    row: number;
    error: string;
  }[];
}

// GET /api/technical/boms/:id/items (enhanced response)
interface BOMItemsListResponse {
  items: BOMItem[];
  byproducts: BOMItem[];  // is_output=true items
  total: number;
}
```

### Database

```sql
-- bom_items table (uses existing columns)
-- Phase 1 columns used:
--   line_ids UUID[]            -- NULL = all lines
--   consume_whole_lp BOOLEAN   -- default false
--   is_by_product BOOLEAN      -- default false
--   yield_percent DECIMAL(5,2) -- required if is_by_product
--   condition_flags JSONB      -- e.g., {"organic": true, "vegan": true}
```

### Frontend Components

```
components/technical/bom/
  BOMItemsTable.tsx            -- Enhanced with byproducts section
  BOMItemModal.tsx             -- Enhanced with Phase 1 fields
  BOMByproductsSection.tsx     -- Byproducts table
  BOMItemRow.tsx               -- Enhanced sub-row with flags/lines
  BOMBulkImportModal.tsx       -- CSV import modal
  ConditionalFlagsSelect.tsx   -- Multi-select for condition flags
  ProductionLinesCheckbox.tsx  -- Multi-checkbox for line selection
```

### Services

```typescript
// lib/services/bom-items-service.ts (extended)
export async function bulkCreateBOMItems(
  bomId: string,
  items: CreateBOMItemRequest[]
): Promise<BulkImportResponse>

export async function getByproducts(bomId: string): Promise<BOMItem[]>

export function calculateYieldPercent(
  byproductQty: number,
  bomOutputQty: number
): number

export async function getProductionLines(orgId: string): Promise<ProductionLine[]>
```

### Validation (Zod)

```typescript
const bomItemSchemaPhase1 = bomItemSchema.extend({
  consume_whole_lp: z.boolean().optional().default(false),
  line_ids: z.array(z.string().uuid()).nullable().optional(),
  is_by_product: z.boolean().optional().default(false),
  yield_percent: z.number().min(0).max(100).nullable().optional(),
  condition_flags: z.record(z.boolean()).nullable().optional(),
}).refine((data) => {
  // If byproduct, yield_percent should be provided
  if (data.is_by_product && data.yield_percent === null) {
    return false;
  }
  return true;
}, {
  message: "Yield percent is required for byproducts",
  path: ["yield_percent"],
});

const bulkImportSchema = z.object({
  items: z.array(bomItemSchemaPhase1).min(1).max(500),
});
```

### Available Condition Flags

```typescript
const CONDITION_FLAGS = [
  { key: 'organic', label: 'Organic', color: 'green' },
  { key: 'vegan', label: 'Vegan', color: 'emerald' },
  { key: 'gluten_free', label: 'Gluten-Free', color: 'yellow' },
  { key: 'kosher', label: 'Kosher', color: 'blue' },
  { key: 'halal', label: 'Halal', color: 'purple' },
] as const;
```

### Key Business Rules

1. **Byproducts**: is_output=true, yield_percent auto-calculated as (byproduct_qty / bom_output_qty * 100)
2. **Line-specific**: NULL line_ids = all lines; specific IDs = restricted to those lines
3. **Conditional flags**: Stored as JSONB, evaluated during WO BOM snapshot creation
4. **Consume whole LP**: When true, production must consume entire LP (no partial)
5. **Bulk import**: Maximum 500 items per import, validates all before creating

## Deliverables

- Enhanced API routes with Phase 1 fields
- POST /api/technical/boms/:id/items/bulk endpoint
- BOMByproductsSection component
- Enhanced BOMItemModal with conditional/line fields
- BOMBulkImportModal component
- ConditionalFlagsSelect component
- ProductionLinesCheckbox component
- Extended bom-items-service.ts
- Integration tests for bulk import
- Unit tests for yield calculation

## Definition of Done

- [ ] Conditional flags save as JSONB correctly
- [ ] Conditional flags display in items table sub-row
- [ ] Byproducts section displays separately with yield%
- [ ] Byproduct yield auto-calculates on quantity change
- [ ] Line-specific items save line_ids array
- [ ] Line-specific items display line names in sub-row
- [ ] Consume whole LP checkbox works
- [ ] Bulk import creates multiple items from CSV
- [ ] Bulk import shows error report for invalid rows
- [ ] All Phase 1 fields visible in edit modal
- [ ] All API endpoints have integration tests
- [ ] Unit tests cover new service functions (>80% coverage)
- [ ] TEC-006a wireframe fully implemented

---

## Future Phases (Not in This Story)

### Phase 2 (Story 02.14)
- Multi-level BOM explosion with recursive traversal (FR-2.29)
- BOM scaling/batch size adjustment (FR-2.35)
- Drag-drop reordering of items

**Implementation**: See Epic 02.0 "Future Feature Handling" section.

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-12-16 | Split from 02.5, Phase 1 scope | ARCHITECT-AGENT |
