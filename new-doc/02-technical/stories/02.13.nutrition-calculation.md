# 02.13 - Nutrition Calculation: Facts Panel & Label Generation

**Priority**: P0 (MVP)
**Story Points**: L (8)
**Type**: backend + frontend

**State:** ready
**Estimate:** L (complex calculation engine + label rendering)
**Primary PRD:** `docs/1-BASELINE/product/modules/technical.md` (FR-2.80, FR-2.81, FR-2.82, FR-2.84)
**UX Wireframes:** TEC-009-nutrition-panel.md, TEC-011-nutrition-calculator.md

---

## MVP Scope

This story implements Phase 0 (MVP) functionality only. Features listed in "Future Phases" are deferred and should be handled per Epic 02.0 "Future Feature Handling" guidance.

---

## Goal
Implement nutrition facts calculation from BOM ingredients, nutrition panel display with FDA label format, manual override capability, serving size calculator, and label generation for printing/export.

## Scope

**In scope**
- GET /api/technical/nutrition/products/:id (get nutrition data)
- POST /api/technical/nutrition/products/:id/calculate (calculate from BOM)
- PUT /api/technical/nutrition/products/:id/override (manual entry)
- GET /api/technical/nutrition/products/:id/label (generate label PDF)
- GET /api/technical/nutrition/racc (FDA RACC lookup by category)
- POST /api/technical/nutrition/ingredients/:id (ingredient nutrition entry)
- GET /api/technical/nutrition/ingredients/:id (get ingredient nutrition)
- Nutrition panel modal with FDA 2016 label format
- Manual override form with metadata tracking
- Serving size calculator (by weight, dimensions, volume)
- FDA RACC reference validation
- Label preview with print-ready specifications
- PDF export for nutrition labels
- SVG export for professional printing
- Auto-calculation from BOM with yield adjustment
- Allergen label generation (contains/may contain warnings)
- Ingredient nutrition data entry for raw materials

---

## Future Phases (Not in MVP)

### Phase 1
- EU FIC label format (European compliance)
- Nutrition claims validation (FR-2.83)
- Additional micronutrient panels

### Phase 2
- Canada bilingual labels (Health Canada compliance)
- USDA FoodData Central API integration (auto-lookup)
- Multi-currency nutrition cost analysis
- Batch label printing
- QR code linking to online nutrition data

**Implementation**: See Epic 02.0 "Future Feature Handling".

---

## Dependencies
- **01.1** - Org context + RLS (required for tenant isolation)
- **02.1** - Products CRUD (required for product lookup)
- **02.3** - Product allergens (required for allergen labels)
- **02.4** - BOMs CRUD (required for BOM lookup)
- **02.5** - BOM items (required for ingredient quantities)

## Acceptance Criteria (Given/When/Then)

### Auto-Calculation from BOM
- GIVEN product has active BOM with 8 ingredients, WHEN user opens nutrition panel, THEN system attempts auto-calculation.
- GIVEN all BOM ingredients have nutrition data, WHEN calculation runs, THEN nutrition facts display within 2 seconds.
- GIVEN ingredient "Wheat Flour" has 340 kcal/100g and 300kg in BOM, WHEN calculated, THEN energy contribution is 1,020,000 kcal.
- GIVEN BOM has 500kg input and 475kg output (95% yield), WHEN calculated, THEN concentration factor 1.053 is applied.
- GIVEN calculation complete, WHEN per-100g values display, THEN all macros (energy, protein, fat, carbs) show correctly.

### Missing Ingredient Nutrition
- GIVEN BOM has ingredient "Sunflower Oil" without nutrition data, WHEN calculation attempted, THEN error state shows with list of missing ingredients.
- GIVEN error state displayed, WHEN user clicks "Add Data" for Sunflower Oil, THEN ingredient nutrition entry form opens.
- GIVEN error state displayed, WHEN user clicks "Skip and Use Partial Data", THEN calculation proceeds with missing ingredients as zero (with warning).
- GIVEN all missing ingredient data added, WHEN user clicks "Recalculate", THEN full calculation succeeds.

### Manual Override
- GIVEN user is on nutrition panel, WHEN user clicks "Override", THEN confirmation dialog shows "Auto-calculation will be disabled".
- GIVEN manual override mode active, WHEN user enters energy=304 kcal, protein=0.3g, fat=0.0g, carbs=82.4g, THEN values save successfully.
- GIVEN manual override saved, WHEN override is saved, THEN metadata includes source (Lab Test), reference (CoA number), notes, user, timestamp.
- GIVEN manual override active, WHEN panel displays, THEN yellow warning banner shows "Manual Override Active" with reason.
- GIVEN manual override active, WHEN user clicks "Recalculate from BOM", THEN confirmation shows "Manual values will be overwritten".

### Serving Size Calculator
- GIVEN nutrition panel open, WHEN user clicks "Serving Helper" button, THEN serving size calculator modal opens.
- GIVEN calculator open with "By Piece Dimensions" selected, WHEN user enters total weight=500g, number of pieces=10, THEN serving size calculates as 50g.
- GIVEN calculator open, WHEN user selects product category "Bread", THEN FDA RACC reference shows 50g recommended.
- GIVEN calculated serving=50g and RACC=50g, WHEN validation runs, THEN checkmark shows "Your serving matches FDA RACC".
- GIVEN calculated serving=80g and RACC=50g (>20% variance), WHEN validation runs, THEN warning shows "Differs from RACC by 60%".
- GIVEN user clicks "Apply Serving Size", WHEN modal closes, THEN nutrition panel updates with new serving size and per-serving values.

### FDA Label Preview
- GIVEN nutrition data complete with serving size, WHEN user clicks "Preview Label", THEN FDA 2016 format label displays.
- GIVEN FDA label preview open, WHEN typography displays, THEN title is 18pt Bold CAPS, calories 16pt Bold, nutrients 8pt.
- GIVEN FDA label preview open, WHEN % Daily Value shows for Sodium 240mg, THEN DV shows 10% (based on 2,000 kcal diet).
- GIVEN FDA label preview open, WHEN required nutrients display, THEN Vitamin D, Calcium, Iron, Potassium appear (not A, C).
- GIVEN FDA label preview open, WHEN Added Sugars shows 0g, THEN line appears indented under Total Sugars with 0% DV.

### Label Export
- GIVEN nutrition panel with complete data, WHEN user clicks "Export PDF", THEN PDF downloads as `{product_code}_nutrition_label.pdf`.
- GIVEN nutrition panel with complete data, WHEN user clicks "Export SVG", THEN SVG downloads for professional printing.
- GIVEN nutrition panel with complete data, WHEN user clicks "Print Label", THEN browser print dialog opens with 4x6" label size preset.
- GIVEN serving size not entered, WHEN export attempted, THEN validation error shows "Serving size required for label".

### Allergen Label Generation
- GIVEN product has allergens Gluten (contains), Dairy (may contain), WHEN allergen label generates, THEN warning shows "Contains: Gluten. May Contain: Dairy."
- GIVEN product has no allergens declared, WHEN allergen label generates, THEN empty allergen section or "Allergen Free" badge displays.
- GIVEN allergen label generated, WHEN combined with nutrition label, THEN allergen warnings appear below nutrition facts box.

### Ingredient Nutrition Entry
- GIVEN raw material "Sugar" selected, WHEN nutrition entry form opens, THEN all fields available (energy, protein, fat, carbs, fiber, sodium, etc.).
- GIVEN user enters nutrition data for Sugar, WHEN source is "Supplier CoA", THEN reference field becomes required.
- GIVEN nutrition data saved for ingredient, WHEN any product BOM uses that ingredient, THEN calculations use new data on next recalculate.

### Loading/Empty/Error States
- GIVEN user opens nutrition panel, WHEN calculation runs, THEN loading state shows spinner with "Calculating nutrition from BOM..."
- GIVEN product is raw material (no BOM), WHEN nutrition panel opens, THEN empty state shows "No BOM - Enter Nutrition Manually" with CTA.
- GIVEN API fails during calculation, WHEN error occurs, THEN error state shows with retry option.

### AC-13.1: Future Features Handling

Phase 1+ features (not in MVP):
- EU FIC label format
- Canada bilingual labels
- Nutrition claims validation (FR-2.83)
- USDA FoodData Central API integration

**Implementation**: Hide or show as "Coming Soon" per Epic 02.0 guidance.

**Example**:
```typescript
{/* Phase 1: EU Label Format
<TabsTrigger value="eu">EU FIC Format</TabsTrigger>
<TabsContent value="eu">
  <ComingSoonPlaceholder feature="EU FIC Label" phase={1} />
</TabsContent>
*/}

{/* Phase 2: Canada Labels
<TabsTrigger value="canada">Canada Bilingual</TabsTrigger>
<TabsContent value="canada">
  <ComingSoonPlaceholder feature="Canada Bilingual Labels" phase={2} />
</TabsContent>
*/}
```

---

## Implementation Notes

### API Endpoints

```typescript
// GET /api/technical/nutrition/products/:id
interface ProductNutritionResponse {
  product_id: string;
  serving_size: number | null;
  serving_unit: 'g' | 'ml' | 'oz' | 'cup' | 'tbsp' | 'piece';
  servings_per_container: number | null;
  is_manual_override: boolean;
  override_source?: 'lab_test' | 'supplier_coa' | 'database' | 'calculated';
  override_reference?: string;
  override_notes?: string;
  override_by?: string;
  override_at?: string;
  calculated_at?: string;
  bom_version_used?: number;
  // Macronutrients (per 100g/100ml)
  energy_kcal: number;
  energy_kj?: number;
  protein_g: number;
  fat_g: number;
  saturated_fat_g?: number;
  trans_fat_g?: number;
  carbohydrate_g: number;
  sugar_g?: number;
  added_sugar_g?: number;
  fiber_g?: number;
  sodium_mg?: number;
  salt_g?: number;
  cholesterol_mg?: number;
  // Micronutrients
  vitamin_d_mcg?: number;
  calcium_mg?: number;
  iron_mg?: number;
  potassium_mg?: number;
}

// POST /api/technical/nutrition/products/:id/calculate
interface CalculateNutritionRequest {
  bom_id?: string; // optional, defaults to active BOM
  actual_yield_kg?: number; // optional, for yield adjustment
}
interface CalculateNutritionResponse {
  ingredients: Array<{
    id: string;
    name: string;
    code: string;
    quantity: number;
    unit: string;
    nutrients: NutrientProfile;
    contribution_percent: number;
  }>;
  yield: {
    expected_kg: number;
    actual_kg: number;
    factor: number;
  };
  total_per_batch: NutrientProfile;
  per_100g: NutrientProfile;
  missing_ingredients: Array<{
    id: string;
    name: string;
    code: string;
    quantity: number;
  }>;
}

// PUT /api/technical/nutrition/products/:id/override
interface OverrideNutritionRequest {
  serving_size: number;
  serving_unit: string;
  servings_per_container: number;
  energy_kcal: number;
  protein_g: number;
  fat_g: number;
  carbohydrate_g: number;
  salt_g: number;
  fiber_g?: number;
  sugar_g?: number;
  saturated_fat_g?: number;
  sodium_mg?: number;
  // ... other nutrients
  source: 'lab_test' | 'supplier_coa' | 'database' | 'manual';
  reference?: string;
  notes?: string;
}

// GET /api/technical/nutrition/products/:id/label
// Query params: format=fda|eu|canada, width=inches, height=inches
interface NutritionLabelResponse {
  pdf_url?: string;   // Pre-signed URL for PDF download
  svg_content?: string; // Inline SVG for preview
  html_content?: string; // HTML for preview rendering
}

// GET /api/technical/nutrition/racc
// Query params: category=bread
interface RaccLookupResponse {
  category: string;
  racc_grams: number;
  racc_description: string;
  common_servings: Array<{
    description: string;
    grams: number;
  }>;
}
```

### Calculation Algorithm

```typescript
// Step 1: Load BOM and ingredients
const bom = await bomService.getActiveBom(productId);
const bomItems = await bomService.getBomItems(bom.id);

// Step 2: Fetch ingredient nutrition (batch query)
const ingredientIds = bomItems.map(item => item.component_id);
const nutritionData = await nutritionService.getIngredientNutrition(ingredientIds);

// Step 3: Check for missing data
const missingIngredients = bomItems.filter(
  item => !nutritionData.find(n => n.ingredient_id === item.component_id)
);
if (missingIngredients.length > 0 && !allowPartial) {
  return { error: 'MISSING_NUTRITION_DATA', missing: missingIngredients };
}

// Step 4: Calculate weighted totals (per batch)
const totalNutrients: NutrientProfile = {};
for (const item of bomItems) {
  const nutrition = nutritionData.find(n => n.ingredient_id === item.component_id);
  if (!nutrition) continue;

  const quantity_g = convertToGrams(item.quantity, item.uom);
  for (const [nutrient, value] of Object.entries(nutrition)) {
    // value is per 100g, quantity_g is total grams in batch
    const weighted = (value / 100) * quantity_g;
    totalNutrients[nutrient] = (totalNutrients[nutrient] || 0) + weighted;
  }
}

// Step 5: Apply yield adjustment
const yieldFactor = bom.output_qty_kg / actualOutputKg;
for (const [nutrient, value] of Object.entries(totalNutrients)) {
  totalNutrients[nutrient] = value * yieldFactor;
}

// Step 6: Convert to per 100g
const outputGrams = actualOutputKg * 1000;
const per100g: NutrientProfile = {};
for (const [nutrient, value] of Object.entries(totalNutrients)) {
  per100g[nutrient] = (value / outputGrams) * 100;
}

return { per100g, totalNutrients, yieldFactor };
```

### Database Schema

```sql
-- product_nutrition table
CREATE TABLE product_nutrition (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id),
  product_id UUID NOT NULL REFERENCES products(id),
  serving_size DECIMAL(10,2),
  serving_unit TEXT DEFAULT 'g',
  servings_per_container INTEGER,
  is_manual_override BOOLEAN DEFAULT false,
  override_source TEXT, -- 'lab_test', 'supplier_coa', 'database', 'calculated'
  override_reference TEXT,
  override_notes TEXT,
  override_by UUID REFERENCES users(id),
  override_at TIMESTAMPTZ,
  calculated_at TIMESTAMPTZ,
  bom_version_used INTEGER,
  -- Macronutrients (per 100g)
  energy_kcal DECIMAL(10,2),
  energy_kj DECIMAL(10,2),
  protein_g DECIMAL(10,2),
  fat_g DECIMAL(10,2),
  saturated_fat_g DECIMAL(10,2),
  trans_fat_g DECIMAL(10,2),
  carbohydrate_g DECIMAL(10,2),
  sugar_g DECIMAL(10,2),
  added_sugar_g DECIMAL(10,2),
  fiber_g DECIMAL(10,2),
  sodium_mg DECIMAL(10,2),
  salt_g DECIMAL(10,2),
  cholesterol_mg DECIMAL(10,2),
  -- Micronutrients
  vitamin_d_mcg DECIMAL(10,4),
  calcium_mg DECIMAL(10,2),
  iron_mg DECIMAL(10,2),
  potassium_mg DECIMAL(10,2),
  vitamin_c_mg DECIMAL(10,2),
  vitamin_a_mcg DECIMAL(10,4),
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now(),
  UNIQUE(org_id, product_id)
);

-- ingredient_nutrition table
CREATE TABLE ingredient_nutrition (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id),
  ingredient_id UUID NOT NULL REFERENCES products(id),
  per_unit DECIMAL(10,2) DEFAULT 100, -- per 100g or 100ml
  unit TEXT DEFAULT 'g',
  source TEXT DEFAULT 'manual', -- 'usda', 'eurofir', 'supplier_coa', 'manual'
  source_id TEXT, -- e.g., USDA NDB number
  source_date DATE,
  verified_by UUID REFERENCES users(id),
  confidence TEXT DEFAULT 'medium', -- 'high', 'medium', 'low'
  notes TEXT,
  -- Nutrients (per 100g/ml)
  energy_kcal DECIMAL(10,2),
  protein_g DECIMAL(10,2),
  fat_g DECIMAL(10,2),
  saturated_fat_g DECIMAL(10,2),
  carbohydrate_g DECIMAL(10,2),
  sugar_g DECIMAL(10,2),
  fiber_g DECIMAL(10,2),
  sodium_mg DECIMAL(10,2),
  -- ... other nutrients
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now(),
  UNIQUE(org_id, ingredient_id)
);
```

### Frontend Components
- `NutritionPanelModal` - Main modal (xl size: 800px)
- `NutritionFactsPreview` - FDA 2016 label format display
- `NutritionOverrideForm` - Manual entry form with validation
- `ServingCalculator` - Serving size calculation modal
- `IngredientBreakdownTable` - Shows ingredient contributions
- `AllergenLabelSection` - Contains/May Contain warnings
- `LabelFormatSpec` - Print-ready label preview with specs

### Services
- `nutrition-service.ts` - Calculation engine, label generation
- `serving-calculator-service.ts` - Serving size calculations
- `label-export-service.ts` - PDF/SVG generation

### Validation Schema (Zod)

```typescript
const nutritionOverrideSchema = z.object({
  serving_size: z.number().min(0.1).max(10000),
  serving_unit: z.enum(['g', 'ml', 'oz', 'cup', 'tbsp', 'piece']),
  servings_per_container: z.number().int().min(1).max(1000),
  energy_kcal: z.number().min(0).max(9999),
  protein_g: z.number().min(0).max(999.9),
  fat_g: z.number().min(0).max(999.9),
  carbohydrate_g: z.number().min(0).max(999.9),
  salt_g: z.number().min(0).max(99.9),
  fiber_g: z.number().min(0).max(999.9).optional(),
  sugar_g: z.number().min(0).max(999.9).optional(),
  source: z.enum(['lab_test', 'supplier_coa', 'database', 'manual']),
  reference: z.string().max(100).optional(),
  notes: z.string().max(500).optional(),
});
```

### Caching Strategy

```typescript
// Redis keys with TTL
'org:{orgId}:product:{productId}:nutrition' // 10 min TTL, invalidate on BOM change
'global:fda-racc-table' // 24 hour TTL, rarely changes
```

## Deliverables
- Nutrition panel modal at product detail view
- 7 API endpoints for nutrition management
- Nutrition calculation service with yield adjustment
- Ingredient nutrition entry form
- Serving size calculator with FDA RACC
- FDA 2016 label preview and export
- PDF and SVG export functionality
- Allergen label integration
- Zod validation schemas
- Integration tests for calculation accuracy
- Unit tests for nutrition service (>80% coverage)

## Definition of Done
- [ ] Nutrition calculation from BOM completes within 2 seconds
- [ ] Missing ingredient handling shows clear error with add data CTAs
- [ ] Manual override saves with audit trail (user, timestamp, source, reference)
- [ ] Serving size calculator calculates correctly by weight/dimensions/volume
- [ ] FDA RACC validation shows warning when serving differs >20%
- [ ] FDA 2016 label format matches specification (typography, spacing)
- [ ] PDF export generates print-ready 4x6" label
- [ ] SVG export works for professional printing
- [ ] Allergen labels show Contains/May Contain from product allergens
- [ ] Ingredient nutrition entry saves and is used in calculations
- [ ] Cache invalidation works when BOM changes
- [ ] All API endpoints have integration tests
- [ ] Nutrition service has >80% unit test coverage
- [ ] Yield adjustment correctly concentrates nutrients
