# 02.16 - Product Advanced Features

**Story ID:** 02.16
**Epic:** 02 - Technical
**Phase:** Phase 2 (2E-1)
**Complexity:** M (Medium)
**Estimate:** 3-4 days
**Type:** Backend + Frontend
**Priority:** P1 (due to FR-2.10 clone)
**State:** ready

**Primary PRD:** `docs/1-BASELINE/product/modules/TECHNICAL.md` (FR-2.9, FR-2.10, FR-2.11, FR-2.12)
**UX Wireframes:** TEC-002 (Product Modal - extended), TEC-001 (Products List - extended)

## PRD References

| FR ID | Requirement | Priority | Phase | Covered |
|-------|-------------|----------|-------|---------|
| FR-2.9 | Product image upload | P2 | 2E-1 | Yes |
| FR-2.10 | Product clone/duplicate | P1 | 2E-1 | Yes |
| FR-2.11 | Product barcode generation | P2 | Future | Yes (basic) |
| FR-2.12 | Product categories and tags | P2 | Future | Yes (basic) |

## User Story

**As a** production manager,
**I want** to upload product images, clone existing products, generate barcodes, and organize products with categories and tags,
**So that** I can quickly create similar products, maintain visual product identification, and organize my product catalog efficiently.

## Goal

Extend product management with advanced features: image upload for visual identification, product cloning for rapid creation of similar products, barcode generation for inventory operations, and categories/tags for organization. Product clone is the primary feature (P1) due to high user demand for rapid product creation.

## Scope

**In scope:**
- Product image upload (single image per product)
- Image preview and thumbnail generation
- Product clone/duplicate with customizable SKU
- Clone modal with field selection
- Basic barcode generation (Code128, EAN-13)
- Barcode display and print
- Product categories (hierarchical)
- Product tags (many-to-many)
- Category/tag filtering in product list

**Out of scope:**
- Multiple images per product (gallery)
- Image editing/cropping
- AI-powered barcode scanning
- Advanced barcode formats (QR, DataMatrix)
- Category permission management
- Tag suggestions/autocomplete based on AI
- Bulk category/tag assignment

**Future Phases:**
- Multi-image gallery with drag-drop ordering
- Image CDN optimization
- GS1 barcode integration with GTIN validation
- Nested category depth >3 levels
- Tag analytics and usage reports

## Dependencies

| Story | Requirement | Status |
|-------|-------------|--------|
| 02.1 | Products CRUD | Done - provides base product service |
| 02.2 | Product Versioning | Done - clone preserves version history reference |
| 01.1 | Org Context + Base RLS | Done - provides auth context |

## Acceptance Criteria (Given/When/Then)

### Product Image Upload (FR-2.9)

#### Image Upload
- GIVEN user opens product form (create/edit), WHEN form loads, THEN image upload zone is displayed.
- GIVEN user drags image to upload zone, WHEN file is valid (jpg, png, webp, <5MB), THEN image preview displays and uploads to storage.
- GIVEN user clicks upload zone, WHEN file dialog opens, THEN user can select image file.
- GIVEN user uploads invalid file (>5MB or wrong format), WHEN upload attempted, THEN error "File must be JPG, PNG or WebP under 5MB" displays.
- GIVEN user uploads image, WHEN upload completes, THEN thumbnail (200x200) is auto-generated and stored.

#### Image Display
- GIVEN product has image, WHEN viewing products list, THEN thumbnail displays in image column.
- GIVEN product has no image, WHEN viewing products list, THEN placeholder icon displays.
- GIVEN product detail view, WHEN image exists, THEN full-size image displays with click-to-zoom.
- GIVEN user clicks "Remove Image", WHEN confirmed, THEN image is deleted and placeholder shows.

### Product Clone (FR-2.10)

#### Clone Modal
- GIVEN user clicks "Clone" action on product row, WHEN modal opens, THEN "Clone Product" modal displays with product data pre-filled.
- GIVEN clone modal open, WHEN modal loads, THEN SKU field shows suggested new code "{original}-COPY".
- GIVEN clone modal open, WHEN user modifies SKU, THEN real-time uniqueness validation runs.
- GIVEN user enters existing SKU, WHEN validation runs, THEN error "SKU already exists" displays inline.

#### Clone Options
- GIVEN clone modal open, WHEN form loads, THEN checkboxes for "Include allergens", "Include categories/tags" display.
- GIVEN clone modal open, WHEN "Include allergens" checked, THEN cloned product copies allergen declarations.
- GIVEN clone modal open, WHEN "Include categories/tags" unchecked, THEN cloned product has no categories/tags.
- GIVEN clone modal open, WHEN user clears name field, THEN validation error "Name is required" displays.

#### Clone Execution
- GIVEN user clicks "Clone Product", WHEN all validations pass, THEN new product created with version 1.
- GIVEN clone successful, WHEN complete, THEN toast "Product cloned successfully" displays and modal closes.
- GIVEN clone successful, WHEN product list refreshes, THEN cloned product appears in list.
- GIVEN clone fails (server error), WHEN error occurs, THEN toast "Failed to clone product" displays with retry option.

### Barcode Generation (FR-2.11)

#### Generate Barcode
- GIVEN product detail view, WHEN "Generate Barcode" button clicked, THEN barcode generation modal opens.
- GIVEN barcode modal open, WHEN format selected (Code128 or EAN-13), THEN barcode preview updates.
- GIVEN barcode modal with Code128 selected, WHEN SKU entered, THEN Code128 barcode generates using SKU.
- GIVEN barcode modal with EAN-13 selected, WHEN GTIN field empty, THEN error "GTIN required for EAN-13" displays.
- GIVEN barcode modal with EAN-13 selected, WHEN GTIN has invalid check digit, THEN error "Invalid GTIN check digit" displays.

#### Barcode Display & Print
- GIVEN product has generated barcode, WHEN viewing product detail, THEN barcode displays with format label.
- GIVEN user clicks "Print Barcode", WHEN print dialog opens, THEN barcode label prints with product name and SKU.
- GIVEN user clicks "Download Barcode", WHEN clicked, THEN PNG file downloads (300 DPI).
- GIVEN barcode generated, WHEN product updated, THEN barcode_url field stores URL.

### Product Categories (FR-2.12)

#### Category Management
- GIVEN admin navigates to Settings > Product Categories, WHEN page loads, THEN category tree displays.
- GIVEN category tree, WHEN user clicks "Add Category", THEN modal opens with name, parent_category, description fields.
- GIVEN user creates category with parent, WHEN saved, THEN category appears nested under parent (max 3 levels).
- GIVEN category has child categories, WHEN user deletes category, THEN error "Cannot delete category with children" displays.
- GIVEN category has products assigned, WHEN user deletes category, THEN error "Cannot delete category with products" displays.

#### Category Assignment
- GIVEN product form open, WHEN form loads, THEN category dropdown displays hierarchical tree.
- GIVEN product form with category dropdown, WHEN user selects category, THEN category_id saved with product.
- GIVEN product form with category selected, WHEN viewing product list, THEN category name displays in column.
- GIVEN product list with category filter, WHEN category selected, THEN only products in that category (and children) display.

### Product Tags (FR-2.12)

#### Tag Management
- GIVEN admin navigates to Settings > Product Tags, WHEN page loads, THEN tags list displays with usage counts.
- GIVEN tags list, WHEN user clicks "Add Tag", THEN inline input appears for tag name.
- GIVEN user enters tag name, WHEN name exceeds 50 characters, THEN validation error displays.
- GIVEN tag has no products, WHEN user deletes tag, THEN tag removed immediately.
- GIVEN tag has products assigned, WHEN user deletes tag, THEN confirmation "Remove tag from X products?" displays.

#### Tag Assignment
- GIVEN product form open, WHEN form loads, THEN tags multi-select displays with autocomplete.
- GIVEN tags multi-select, WHEN user types, THEN matching tags filter in dropdown.
- GIVEN tags multi-select, WHEN user selects tag, THEN tag badge appears in selection.
- GIVEN product form, WHEN user creates new tag inline, THEN tag created and assigned to product.
- GIVEN product with tags, WHEN viewing product list, THEN tags display as badges (max 3 visible, "+N more").

#### Tag Filtering
- GIVEN product list with tag filter, WHEN single tag selected, THEN products with that tag display.
- GIVEN product list, WHEN multiple tags selected (AND logic), THEN products with ALL selected tags display.
- GIVEN product list URL, WHEN tags parameter present, THEN filter persists on page reload.

### Multi-tenancy
- GIVEN User A from Org A uploads image, WHEN User B from Org B requests image URL, THEN 404 Not Found returns.
- GIVEN User A from Org A clones product, WHEN clone saved, THEN clone has Org A's org_id.
- GIVEN categories/tags created by Org A, WHEN Org B queries categories/tags, THEN only Org B's data returns.

## Technical Specification

### Database Schema

#### product_images table
```sql
CREATE TABLE product_images (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  product_id UUID NOT NULL REFERENCES products(id) ON DELETE CASCADE,

  -- Image data
  storage_path VARCHAR(500) NOT NULL,
  thumbnail_path VARCHAR(500),
  original_filename VARCHAR(255) NOT NULL,
  mime_type VARCHAR(100) NOT NULL,
  file_size INTEGER NOT NULL,
  width INTEGER,
  height INTEGER,

  -- Audit
  created_at TIMESTAMPTZ DEFAULT NOW(),
  created_by UUID REFERENCES users(id),

  -- Constraints
  CONSTRAINT uq_product_images_product UNIQUE(product_id),
  CONSTRAINT chk_product_images_size CHECK (file_size > 0 AND file_size <= 5242880),
  CONSTRAINT chk_product_images_mime CHECK (mime_type IN ('image/jpeg', 'image/png', 'image/webp'))
);

CREATE INDEX idx_product_images_org ON product_images(org_id);
CREATE INDEX idx_product_images_product ON product_images(product_id);
```

#### product_categories table
```sql
CREATE TABLE product_categories (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,

  -- Category data
  name VARCHAR(100) NOT NULL,
  description TEXT,
  parent_id UUID REFERENCES product_categories(id) ON DELETE RESTRICT,
  level INTEGER NOT NULL DEFAULT 1,
  path LTREE,
  sort_order INTEGER DEFAULT 0,
  is_active BOOLEAN DEFAULT true,

  -- Audit
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  created_by UUID REFERENCES users(id),

  -- Constraints
  CONSTRAINT uq_product_categories_org_name_parent UNIQUE(org_id, name, parent_id),
  CONSTRAINT chk_product_categories_level CHECK (level >= 1 AND level <= 3)
);

CREATE INDEX idx_product_categories_org ON product_categories(org_id);
CREATE INDEX idx_product_categories_parent ON product_categories(parent_id);
CREATE INDEX idx_product_categories_path ON product_categories USING GIST(path);
```

#### product_tags table
```sql
CREATE TABLE product_tags (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,

  -- Tag data
  name VARCHAR(50) NOT NULL,
  color VARCHAR(7) DEFAULT '#6B7280',

  -- Audit
  created_at TIMESTAMPTZ DEFAULT NOW(),
  created_by UUID REFERENCES users(id),

  -- Constraints
  CONSTRAINT uq_product_tags_org_name UNIQUE(org_id, name)
);

CREATE INDEX idx_product_tags_org ON product_tags(org_id);
```

#### product_tag_assignments table
```sql
CREATE TABLE product_tag_assignments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  product_id UUID NOT NULL REFERENCES products(id) ON DELETE CASCADE,
  tag_id UUID NOT NULL REFERENCES product_tags(id) ON DELETE CASCADE,

  -- Audit
  created_at TIMESTAMPTZ DEFAULT NOW(),

  -- Constraints
  CONSTRAINT uq_product_tag_assignments UNIQUE(product_id, tag_id)
);

CREATE INDEX idx_product_tag_assignments_product ON product_tag_assignments(product_id);
CREATE INDEX idx_product_tag_assignments_tag ON product_tag_assignments(tag_id);
```

#### products table extension
```sql
-- Add category_id FK and barcode_url
ALTER TABLE products
  ADD COLUMN IF NOT EXISTS category_id UUID REFERENCES product_categories(id) ON DELETE SET NULL;

ALTER TABLE products
  ADD COLUMN IF NOT EXISTS barcode_url VARCHAR(500);

CREATE INDEX idx_products_category ON products(category_id) WHERE category_id IS NOT NULL;
```

### RLS Policies

```sql
-- product_images: Org isolation
CREATE POLICY "product_images_org_isolation" ON product_images
FOR ALL USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

-- product_categories: Org isolation
CREATE POLICY "product_categories_org_isolation" ON product_categories
FOR ALL USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

-- product_tags: Org isolation
CREATE POLICY "product_tags_org_isolation" ON product_tags
FOR ALL USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

-- product_tag_assignments: Via product org
CREATE POLICY "product_tag_assignments_org_isolation" ON product_tag_assignments
FOR ALL USING (
  EXISTS (
    SELECT 1 FROM products p
    WHERE p.id = product_id
    AND p.org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  )
);
```

### API Endpoints

```
# Product Image
POST   /api/technical/products/:id/image        - Upload product image
GET    /api/technical/products/:id/image        - Get product image URL
DELETE /api/technical/products/:id/image        - Remove product image

# Product Clone
POST   /api/technical/products/:id/clone        - Clone product

# Barcode Generation
POST   /api/technical/products/:id/barcode      - Generate barcode
GET    /api/technical/products/:id/barcode      - Get barcode image

# Product Categories
GET    /api/technical/product-categories        - List categories (tree)
POST   /api/technical/product-categories        - Create category
GET    /api/technical/product-categories/:id    - Get category
PUT    /api/technical/product-categories/:id    - Update category
DELETE /api/technical/product-categories/:id    - Delete category

# Product Tags
GET    /api/technical/product-tags              - List tags
POST   /api/technical/product-tags              - Create tag
PUT    /api/technical/product-tags/:id          - Update tag
DELETE /api/technical/product-tags/:id          - Delete tag

# Product Tag Assignment (via product update)
PUT    /api/technical/products/:id              - Update product (includes tag_ids array)
```

### Service Methods

**Location:** `lib/services/product-image-service.ts`

```typescript
interface ProductImageService {
  upload(productId: string, file: File): Promise<ProductImage>;
  getByProductId(productId: string): Promise<ProductImage | null>;
  delete(productId: string): Promise<void>;
  generateThumbnail(storagePath: string): Promise<string>;
}

interface ProductImage {
  id: string;
  product_id: string;
  storage_path: string;
  thumbnail_path: string | null;
  original_filename: string;
  mime_type: string;
  file_size: number;
  public_url: string;
  thumbnail_url: string | null;
}
```

**Location:** `lib/services/product-clone-service.ts`

```typescript
interface ProductCloneService {
  clone(productId: string, options: CloneOptions): Promise<Product>;
  validateCloneCode(code: string): Promise<{ valid: boolean; error?: string }>;
  generateSuggestedCode(originalCode: string): string;
}

interface CloneOptions {
  code: string;
  name: string;
  includeAllergens: boolean;
  includeCategoriesTags: boolean;
  includeImage: boolean;
}
```

**Location:** `lib/services/barcode-service.ts`

```typescript
interface BarcodeService {
  generate(productId: string, format: BarcodeFormat, value: string): Promise<BarcodeResult>;
  validate(format: BarcodeFormat, value: string): { valid: boolean; error?: string };
  getByProductId(productId: string): Promise<string | null>;
}

type BarcodeFormat = 'code128' | 'ean13';

interface BarcodeResult {
  url: string;
  format: BarcodeFormat;
  value: string;
}
```

**Location:** `lib/services/product-category-service.ts`

```typescript
interface ProductCategoryService {
  list(): Promise<ProductCategory[]>;
  getTree(): Promise<ProductCategoryTree[]>;
  create(input: CreateCategoryInput): Promise<ProductCategory>;
  update(id: string, input: UpdateCategoryInput): Promise<ProductCategory>;
  delete(id: string): Promise<void>;
  getProductCount(categoryId: string): Promise<number>;
}

interface ProductCategory {
  id: string;
  name: string;
  description: string | null;
  parent_id: string | null;
  level: number;
  path: string;
  sort_order: number;
  is_active: boolean;
}

interface ProductCategoryTree extends ProductCategory {
  children: ProductCategoryTree[];
}
```

**Location:** `lib/services/product-tag-service.ts`

```typescript
interface ProductTagService {
  list(): Promise<ProductTag[]>;
  create(name: string, color?: string): Promise<ProductTag>;
  update(id: string, name: string, color?: string): Promise<ProductTag>;
  delete(id: string): Promise<void>;
  assignToProduct(productId: string, tagIds: string[]): Promise<void>;
  getByProductId(productId: string): Promise<ProductTag[]>;
  getUsageCount(tagId: string): Promise<number>;
}

interface ProductTag {
  id: string;
  name: string;
  color: string;
  usage_count?: number;
}
```

### Zod Validation Schemas

**Location:** `lib/validation/product-advanced.ts`

```typescript
import { z } from 'zod';

// Product Clone
export const cloneProductSchema = z.object({
  code: z.string().min(2).max(50).regex(/^[A-Z0-9-]+$/, 'SKU must be uppercase alphanumeric'),
  name: z.string().min(2).max(255),
  include_allergens: z.boolean().default(true),
  include_categories_tags: z.boolean().default(true),
  include_image: z.boolean().default(false),
});

// Barcode Generation
export const generateBarcodeSchema = z.object({
  format: z.enum(['code128', 'ean13']),
  value: z.string().min(1).max(100),
}).refine(data => {
  if (data.format === 'ean13') {
    return /^\d{13}$/.test(data.value);
  }
  return true;
}, { message: 'EAN-13 requires exactly 13 digits', path: ['value'] });

// Product Category
export const createCategorySchema = z.object({
  name: z.string().min(2).max(100),
  description: z.string().max(500).nullable().optional(),
  parent_id: z.string().uuid().nullable().optional(),
  sort_order: z.number().int().min(0).default(0),
});

export const updateCategorySchema = createCategorySchema.partial();

// Product Tag
export const createTagSchema = z.object({
  name: z.string().min(1).max(50),
  color: z.string().regex(/^#[0-9A-Fa-f]{6}$/).default('#6B7280'),
});

export const updateTagSchema = createTagSchema.partial();

// Product with tags (extension of existing update schema)
export const updateProductWithTagsSchema = z.object({
  tag_ids: z.array(z.string().uuid()).optional(),
  category_id: z.string().uuid().nullable().optional(),
});
```

## UI Components

### Pages

- `app/(authenticated)/technical/products/page.tsx` - Extended with image column, clone action
- `app/(authenticated)/settings/product-categories/page.tsx` - Category management
- `app/(authenticated)/settings/product-tags/page.tsx` - Tag management

### Components

**Location:** `components/technical/products/`

```
ProductImageUpload.tsx          - Drag-drop image upload zone
ProductImagePreview.tsx         - Image display with zoom
ProductCloneModal.tsx           - Clone product modal with options
ProductBarcodeModal.tsx         - Barcode generation modal
BarcodeDisplay.tsx              - Barcode image display with print
ProductCategorySelect.tsx       - Hierarchical category dropdown
ProductTagsSelect.tsx           - Multi-select tags with autocomplete
ProductTagBadge.tsx             - Tag badge with color
```

**Location:** `components/settings/`

```
CategoryTreeView.tsx            - Hierarchical category tree
CategoryModal.tsx               - Create/edit category modal
TagsDataTable.tsx               - Tags list with usage counts
TagModal.tsx                    - Create/edit tag modal
```

### Component Details

**ProductCloneModal.tsx**
```tsx
interface ProductCloneModalProps {
  product: Product;
  open: boolean;
  onClose: () => void;
  onSuccess: (clonedProduct: Product) => void;
}

// Form fields:
// - SKU (code) - prefilled with "{original}-COPY", editable
// - Name - prefilled, editable
// - [x] Include allergens (checkbox, default checked)
// - [x] Include categories/tags (checkbox, default checked)
// - [ ] Include image (checkbox, default unchecked)
// - Clone Product button
```

**ProductImageUpload.tsx**
```tsx
interface ProductImageUploadProps {
  productId?: string;
  currentImage?: ProductImage;
  onUpload: (image: ProductImage) => void;
  onRemove: () => void;
}

// Displays:
// - Drop zone with icon when no image
// - Image preview with remove button when image exists
// - Upload progress indicator
// - Error messages for invalid files
```

## Test Cases

### Unit Tests

**product-clone-service.test.ts**
```typescript
describe('ProductCloneService', () => {
  describe('clone', () => {
    it('creates new product with version 1');
    it('generates unique code with -COPY suffix');
    it('copies allergens when includeAllergens is true');
    it('does not copy allergens when includeAllergens is false');
    it('copies category and tags when includeCategoriesTags is true');
    it('throws error for duplicate SKU');
  });

  describe('generateSuggestedCode', () => {
    it('appends -COPY to original code');
    it('increments -COPY-2 when -COPY exists');
    it('truncates long codes to fit max length');
  });
});
```

**barcode-service.test.ts**
```typescript
describe('BarcodeService', () => {
  describe('validate', () => {
    it('accepts valid Code128 value');
    it('accepts valid EAN-13 with correct check digit');
    it('rejects EAN-13 with wrong check digit');
    it('rejects EAN-13 with wrong length');
  });

  describe('generate', () => {
    it('generates Code128 barcode image');
    it('generates EAN-13 barcode image');
    it('stores barcode URL in product');
  });
});
```

**product-category-service.test.ts**
```typescript
describe('ProductCategoryService', () => {
  describe('getTree', () => {
    it('returns flat list as tree structure');
    it('nests children under parents correctly');
    it('limits depth to 3 levels');
  });

  describe('delete', () => {
    it('deletes category with no children or products');
    it('throws error when category has children');
    it('throws error when category has products');
  });
});
```

### Integration Tests

**product-clone-api.test.ts**
```typescript
describe('POST /api/technical/products/:id/clone', () => {
  it('clones product with valid data');
  it('returns 400 for duplicate SKU');
  it('returns 404 for non-existent product');
  it('returns 404 for other org product');
  it('copies allergens when option enabled');
  it('sets cloned product version to 1');
});
```

**product-image-api.test.ts**
```typescript
describe('Product Image API', () => {
  describe('POST /api/technical/products/:id/image', () => {
    it('uploads valid image');
    it('returns 400 for file >5MB');
    it('returns 400 for invalid mime type');
    it('generates thumbnail');
  });

  describe('DELETE /api/technical/products/:id/image', () => {
    it('removes image from storage');
    it('clears product image reference');
  });
});
```

### E2E Tests

**product-clone.spec.ts**
```typescript
describe('Product Clone', () => {
  it('opens clone modal from row action');
  it('prefills form with product data');
  it('suggests -COPY SKU suffix');
  it('validates SKU uniqueness in real-time');
  it('clones product successfully');
  it('shows cloned product in list');
});
```

**product-categories-tags.spec.ts**
```typescript
describe('Product Categories & Tags', () => {
  it('creates new category');
  it('assigns category to product');
  it('filters products by category');
  it('creates new tag');
  it('assigns multiple tags to product');
  it('filters products by tag');
});
```

## Security Considerations

1. **Image Storage Security**
   - Store images in Supabase Storage with org_id path prefix
   - Generate signed URLs with expiry for private access
   - Validate file type server-side (don't trust Content-Type header)
   - Scan uploaded images for malware (optional)

2. **Clone Security**
   - Verify user has access to source product before clone
   - Ensure cloned product inherits correct org_id
   - Audit log clone operations

3. **Barcode Security**
   - Rate limit barcode generation (10/minute)
   - Don't expose internal product IDs in barcodes
   - Validate barcode format before storage

4. **RLS Enforcement**
   - All new tables have org_id isolation
   - Category/tag deletion validates no cross-org references
   - Image access requires product ownership

## Deliverables

- [ ] `product_images` table migration
- [ ] `product_categories` table migration
- [ ] `product_tags` table migration
- [ ] `product_tag_assignments` table migration
- [ ] Products table extension (category_id, barcode_url)
- [ ] RLS policies for all new tables
- [ ] Product image service (`lib/services/product-image-service.ts`)
- [ ] Product clone service (`lib/services/product-clone-service.ts`)
- [ ] Barcode service (`lib/services/barcode-service.ts`)
- [ ] Product category service (`lib/services/product-category-service.ts`)
- [ ] Product tag service (`lib/services/product-tag-service.ts`)
- [ ] Zod schemas (`lib/validation/product-advanced.ts`)
- [ ] API routes: POST/GET/DELETE /api/technical/products/:id/image
- [ ] API route: POST /api/technical/products/:id/clone
- [ ] API route: POST/GET /api/technical/products/:id/barcode
- [ ] API routes: CRUD /api/technical/product-categories
- [ ] API routes: CRUD /api/technical/product-tags
- [ ] ProductImageUpload component
- [ ] ProductCloneModal component
- [ ] ProductBarcodeModal component
- [ ] ProductCategorySelect component
- [ ] ProductTagsSelect component
- [ ] CategoryTreeView component
- [ ] Settings pages for categories and tags
- [ ] Unit tests (>80% coverage)
- [ ] Integration tests
- [ ] E2E tests

## Definition of Done

- [ ] Product image upload works with drag-drop and file selection
- [ ] Image validation enforces <5MB and JPG/PNG/WebP only
- [ ] Thumbnails auto-generate on upload
- [ ] Product clone creates new product with version 1
- [ ] Clone modal shows suggested SKU with -COPY suffix
- [ ] SKU uniqueness validated in real-time during clone
- [ ] Clone options (allergens, categories/tags, image) work correctly
- [ ] Barcode generation produces valid Code128/EAN-13 images
- [ ] Barcode prints with product name and SKU
- [ ] Product categories support 3-level hierarchy
- [ ] Category tree displays with proper nesting
- [ ] Category deletion blocked when has children or products
- [ ] Product tags can be created, assigned, and filtered
- [ ] Multi-tag filtering uses AND logic
- [ ] RLS enforces org isolation on all new tables
- [ ] Cross-org access returns 404 (not 403)
- [ ] Unit test coverage >= 80%
- [ ] Integration tests pass
- [ ] E2E tests pass
- [ ] Loading states displayed during operations
- [ ] Error states handled with user-friendly messages
- [ ] Toast notifications on success/error
