# Code Review Handoff - Story 02.4
# Auto-generated by CODE-REVIEWER agent
# Date: 2025-12-26

story:
  id: "02.4"
  name: "BOMs CRUD + Date Validity"
  epic: "02-technical"

decision: request_changes

review_summary:
  tests_passing: 277
  tests_failing: 4  # Unrelated to this story
  critical_issues: 3
  major_issues: 8
  minor_issues: 12

blocking_issues:
  - id: CRIT-1
    severity: CRITICAL
    category: security
    title: "SQL Injection in Service Layer"
    file: "apps/frontend/lib/services/bom-service-02-4.ts"
    lines: [63, 64, 86]
    description: "User search input directly interpolated into .or() filter without sanitization"
    impact: "Attacker can inject malicious SQL, bypass filters, exfiltrate data, or corrupt database"
    owasp: "A03:2021 - Injection"
    fix_effort_hours: 1

  - id: CRIT-2
    severity: CRITICAL
    category: security
    title: "Missing org_id Enforcement in Service Layer"
    file: "apps/frontend/lib/services/bom-service-02-4.ts"
    lines: [46-114, 119-148, "all service methods"]
    description: "Service relies only on RLS for org isolation, no explicit org_id filter"
    impact: "Cross-tenant data leak if RLS bypassed (Edge Functions, admin context)"
    adr: "ADR-013 Defense in Depth"
    fix_effort_hours: 2

  - id: CRIT-3
    severity: CRITICAL
    category: functionality
    title: "Missing RPC Functions in Database"
    file: "apps/frontend/lib/services/bom-service-02-4.ts"
    lines: [188, 379, 415]
    description: "Service calls 3 RPC functions that don't exist in migrations"
    missing_functions:
      - "check_bom_date_overlap"
      - "get_work_orders_for_bom"
      - "get_bom_timeline"
    impact: "Runtime failure in production - features AC-18 to AC-33 will break"
    fix_effort_hours: 2

high_priority_issues:
  - id: MAJ-1
    severity: MAJOR
    category: data_integrity
    title: "Inconsistent Status Mapping"
    files:
      - "apps/frontend/app/api/v1/technical/boms/route.ts"
      - "apps/frontend/app/api/v1/technical/boms/[id]/route.ts"
    description: "Database uses lowercase ('draft'), API uses Title Case ('Draft')"
    impact: "Type mismatch, potential constraint violations"
    fix_effort_hours: 0.5

  - id: MAJ-2
    severity: MAJOR
    category: maintainability
    title: "Duplicate Date Overlap Logic"
    description: "Overlap validation in both API routes (JS) and database trigger (SQL)"
    impact: "Logic drift, double validation latency, maintenance burden"
    fix_effort_hours: 1

  - id: MAJ-3
    severity: MAJOR
    category: security
    title: "Missing RBAC Check in Timeline Endpoint"
    file: "apps/frontend/app/api/v1/technical/boms/timeline/[productId]/route.ts"
    description: "No permission check - any authenticated user can view timelines"
    impact: "Violates least-privilege principle"
    fix_effort_hours: 0.5

  - id: MAJ-5
    severity: MAJOR
    category: security
    title: "Console Logs in Production"
    instances: 257
    description: "console.log/error exposes sensitive data (user IDs, org IDs, SQL errors)"
    impact: "Security risk, log pollution, performance impact"
    fix_effort_hours: 2

  - id: MAJ-7
    severity: MAJOR
    category: security
    title: "No Rate Limiting"
    description: "Mutation endpoints lack rate limiting - DOS attack vector"
    impact: "Can spam BOM creation, database bloat, cost implications"
    fix_effort_hours: 1

recommended_fixes:
  - id: MAJ-4
    title: "Unvalidated API Responses in ProductSelector"
    fix_effort_hours: 0.5

  - id: MAJ-6
    title: "Improve Error Handling"
    fix_effort_hours: 1

  - id: MAJ-8
    title: "Fix Timezone-Dependent Date Validation"
    fix_effort_hours: 0.5

minor_issues_count: 12
minor_issues_summary:
  - "Missing ARIA labels on calendar buttons"
  - "Magic numbers in pagination"
  - "Unused imports"
  - "Inconsistent date formatting"
  - "No JSDoc comments"
  - "No input sanitization on notes field"
  - "Inconsistent null handling"

positive_aspects:
  - "Database schema and RLS policies correctly configured"
  - "Date overlap trigger logic is robust"
  - "TypeScript types are comprehensive"
  - "React components follow best practices"
  - "Zod validation schemas are thorough"
  - "All 4 UI states properly implemented"
  - "Good accessibility (ARIA, keyboard nav)"

test_coverage:
  unit_tests: passed
  integration_tests: missing  # No database trigger tests
  e2e_tests: missing  # No Playwright tests for BOM flows
  security_tests: missing  # No SQL injection tests

next_steps:
  immediate_required:
    - "Fix CRIT-1: Sanitize search input in bom-service-02-4.ts"
    - "Fix CRIT-2: Add org_id parameter to all 8 service methods"
    - "Fix CRIT-3: Create migration 039_create_bom_rpc_functions.sql"

  before_merge:
    - "Fix MAJ-1: Standardize status value casing"
    - "Fix MAJ-2: Remove duplicate overlap logic from API"
    - "Fix MAJ-3: Add permission check to timeline endpoint"
    - "Fix MAJ-5: Remove all console.log/error statements"
    - "Fix MAJ-7: Implement rate limiting"

  follow_up_ticket:
    - "Address remaining MAJ-4, MAJ-6, MAJ-8"
    - "Fix all MINOR issues (MIN-1 to MIN-12)"
    - "Add missing test coverage (TEST-1 to TEST-3)"

estimated_fix_time:
  critical_major: "4-6 hours"
  minor_recommended: "3-4 hours"
  total: "7-10 hours"

files_requiring_changes:
  critical:
    - "apps/frontend/lib/services/bom-service-02-4.ts"
    - "supabase/migrations/039_create_bom_rpc_functions.sql" # NEW FILE

  major:
    - "apps/frontend/app/api/v1/technical/boms/route.ts"
    - "apps/frontend/app/api/v1/technical/boms/[id]/route.ts"
    - "apps/frontend/app/api/v1/technical/boms/timeline/[productId]/route.ts"
    - "apps/frontend/components/technical/bom/ProductSelector.tsx"

  minor:
    - "apps/frontend/components/technical/bom/BOMHeaderForm.tsx"
    - "apps/frontend/components/technical/bom/BOMsDataTable.tsx"
    - "apps/frontend/lib/validation/bom-schema.ts"

handoff_to: BACKEND-DEV
priority: high
merge_blocked: true
resubmit_required: true

review_metadata:
  reviewer: CODE-REVIEWER
  model: Claude Sonnet 4.5 (1M context)
  date: 2025-12-26
  review_duration_minutes: 45
  files_reviewed: 18
  lines_reviewed: 3247

notes: |
  This review was conducted with BRUTAL HONESTY as requested.
  All issues are real and reproducible. The SQL injection vulnerability
  (CRIT-1) is a production-breaking security hole that MUST be fixed.

  Tests are passing (277/281) but this is due to mocking - the RPC
  functions don't exist in the database, so production will fail.

  The database layer is solid and well-designed. The issues are in
  the application layer (service + API routes).

  Estimated 4-6 hours to fix all blocking issues. Code quality is
  generally good aside from the security vulnerabilities.
