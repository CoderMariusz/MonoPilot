# 01.26 - IP Whitelist + GDPR Compliance

**Story ID:** 01.26
**Epic:** 01 - Settings
**Phase:** 3 (Enterprise)
**Complexity:** M (Medium)
**Estimate:** 1-2 days
**Type:** Backend + Frontend
**State:** ready

**Primary PRD:** `docs/1-BASELINE/product/modules/settings.md` (FR-SET-170, FR-SET-174)

## PRD References

| FR ID | Requirement | Priority | Phase | Covered |
|-------|-------------|----------|-------|---------|
| FR-SET-170 | IP whitelist configuration | P2 | 3 | Yes |
| FR-SET-174 | GDPR compliance tools | P2 | 3 | Yes |

## User Stories

**As an** organization administrator,
**I want** to configure IP whitelist rules,
**So that** only authorized network locations can access the system, enhancing security posture.

**As a** data protection officer,
**I want** GDPR compliance tools,
**So that** I can fulfill data subject requests (access, erasure, portability) and maintain regulatory compliance.

## Goal

Implement enterprise-grade security and compliance features: IP-based access restrictions to limit login to trusted networks, and GDPR tools for data subject rights management. These features are critical for EU-based customers and enterprise compliance requirements.

## Scope

**In scope:**

*IP Whitelist (FR-SET-170):*
- Configure allowed IP addresses/CIDR ranges per organization
- Block login attempts from non-whitelisted IPs (401 response)
- Whitelist management UI (add/remove/edit IPs with descriptions)
- Bypass mechanism for super_admin (emergency access)
- Audit logging for whitelist changes

*GDPR Tools (FR-SET-174):*
- Right to access: Export all user data as JSON
- Right to erasure: Anonymize user data (preserve audit trail)
- Right to portability: Download data in machine-readable format
- Privacy policy acceptance tracking
- GDPR request queue with status tracking

**Out of scope:**
- VPN/proxy detection
- Geolocation-based blocking
- Automated data retention policies (future story)
- DPO workflow automation
- Third-party data processor management

## Dependencies

| Story | Requirement | Status |
|-------|-------------|--------|
| 01.1 | Org Context + Base RLS | Required - org_id filtering |
| 01.6 | Role Permissions | Required - admin-only access |
| 01.15 | Session Management | Required - login hook integration |

## Acceptance Criteria (Given/When/Then)

### IP Whitelist (FR-SET-170)

#### Configuration Management
- GIVEN admin on Security settings, WHEN IP whitelist section viewed, THEN list of configured IPs/CIDRs displays.
- GIVEN admin adds IP "192.168.1.100", WHEN form submitted, THEN IP added with description and creator tracked.
- GIVEN admin adds CIDR "10.0.0.0/8", WHEN form submitted, THEN CIDR range validated and stored.
- GIVEN invalid CIDR "999.0.0.0/8", WHEN form submitted, THEN validation error "Invalid IP address or CIDR notation" displays.
- GIVEN admin deletes IP entry, WHEN confirmed, THEN IP removed and audit log created.

#### Login Enforcement
- GIVEN org has IP whitelist configured, WHEN user logs in from 192.168.1.100, THEN login succeeds.
- GIVEN org has IP whitelist with "10.0.0.0/24", WHEN user logs in from 10.0.0.50, THEN login succeeds (within range).
- GIVEN org has IP whitelist, WHEN user logs in from non-whitelisted 203.0.113.50, THEN 401 with "IP_NOT_WHITELISTED" returns.
- GIVEN org has empty whitelist, WHEN user logs in, THEN all IPs allowed (whitelist disabled).
- GIVEN user with super_admin role, WHEN logging in from any IP, THEN login succeeds (bypass enabled).

#### Edge Cases
- GIVEN user logged in, WHEN IP whitelist updated to exclude their IP, THEN existing session continues (only blocks new logins).
- GIVEN IPv6 address "2001:db8::1", WHEN added to whitelist, THEN IPv6 correctly stored and validated.
- GIVEN duplicate IP entry attempted, WHEN form submitted, THEN error "IP address already exists" displays.

### GDPR Compliance (FR-SET-174)

#### Right to Access (Data Export)
- GIVEN user requests data export, WHEN request submitted, THEN GDPR request created with status "pending".
- GIVEN data export requested, WHEN processing completes, THEN JSON file generated with all user data.
- GIVEN export ready, WHEN user notified, THEN secure download link provided (expires in 24 hours).
- GIVEN data export, WHEN generated, THEN includes: profile, sessions, audit logs, created entities.

#### Right to Erasure (Anonymization)
- GIVEN user requests erasure, WHEN request submitted, THEN confirmation dialog warns about irreversibility.
- GIVEN erasure confirmed, WHEN processing completes, THEN email anonymized to "deleted_user_{id}@anonymized.com".
- GIVEN erasure processed, WHEN complete, THEN name set to "Deleted User", phone/address cleared.
- GIVEN erasure processed, WHEN audit logs checked, THEN user_id preserved (compliance requirement).
- GIVEN anonymized user, WHEN login attempted, THEN "Account has been deleted" message displays.

#### Right to Portability
- GIVEN user requests data portability, WHEN download initiated, THEN machine-readable JSON format provided.
- GIVEN portability export, WHEN generated, THEN follows standard schema (JSON-LD or similar).
- GIVEN portability data, WHEN downloaded, THEN includes relationships and metadata.

#### Privacy Policy Tracking
- GIVEN user accepts privacy policy, WHEN acceptance recorded, THEN timestamp stored in users table.
- GIVEN policy version updated, WHEN user logs in, THEN prompted to accept new version.
- GIVEN admin views user, WHEN privacy tab shown, THEN policy acceptance history visible.

#### GDPR Request Management
- GIVEN admin views GDPR requests, WHEN queue loaded, THEN pending/completed/rejected requests listed.
- GIVEN pending request, WHEN admin processes, THEN status updates and completed_at recorded.
- GIVEN completed export request, WHEN clicked, THEN download link accessible (if not expired).

### Multi-tenancy
- GIVEN Org A admin, WHEN viewing IP whitelist, THEN only Org A whitelist entries visible.
- GIVEN Org B user, WHEN submitting GDPR request, THEN request scoped to Org B data only.
- GIVEN cross-org access attempted, WHEN API called, THEN 404 returned (not 403).

## Technical Specification

### Database Schema

#### ip_whitelist table

```sql
CREATE TABLE ip_whitelist (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,

  -- IP configuration
  ip_address INET NOT NULL, -- Supports both IP and CIDR notation
  description VARCHAR(200),

  -- Audit fields
  created_by UUID REFERENCES users(id),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),

  -- Constraints
  CONSTRAINT ip_whitelist_org_ip_unique UNIQUE (org_id, ip_address)
);

-- Indexes
CREATE INDEX idx_ip_whitelist_org_id ON ip_whitelist(org_id);

-- RLS
ALTER TABLE ip_whitelist ENABLE ROW LEVEL SECURITY;
```

#### gdpr_requests table

```sql
CREATE TABLE gdpr_requests (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES users(id),

  -- Request details
  request_type VARCHAR(50) NOT NULL, -- 'access', 'erasure', 'portability'
  status VARCHAR(20) DEFAULT 'pending', -- 'pending', 'processing', 'completed', 'rejected'

  -- Processing info
  requested_at TIMESTAMPTZ DEFAULT NOW(),
  processed_by UUID REFERENCES users(id),
  completed_at TIMESTAMPTZ,
  rejection_reason VARCHAR(500),

  -- Export data
  data_export_url VARCHAR(500), -- S3 signed URL for data export
  export_expires_at TIMESTAMPTZ, -- URL expiration (24 hours from creation)

  -- Audit
  notes TEXT
);

-- Indexes
CREATE INDEX idx_gdpr_requests_org_id ON gdpr_requests(org_id);
CREATE INDEX idx_gdpr_requests_user_id ON gdpr_requests(user_id);
CREATE INDEX idx_gdpr_requests_status ON gdpr_requests(status);

-- RLS
ALTER TABLE gdpr_requests ENABLE ROW LEVEL SECURITY;
```

#### users table extension

```sql
-- Add GDPR-related fields
ALTER TABLE users ADD COLUMN IF NOT EXISTS anonymized_at TIMESTAMPTZ;
ALTER TABLE users ADD COLUMN IF NOT EXISTS privacy_policy_accepted_at TIMESTAMPTZ;
ALTER TABLE users ADD COLUMN IF NOT EXISTS privacy_policy_version VARCHAR(20);
```

### RLS Policies

```sql
-- ip_whitelist: Admin-only access
CREATE POLICY "ip_whitelist_admin_read" ON ip_whitelist
FOR SELECT USING (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  AND (SELECT r.code FROM roles r JOIN users u ON u.role_id = r.id WHERE u.id = auth.uid()) IN ('SUPER_ADMIN', 'ADMIN')
);

CREATE POLICY "ip_whitelist_admin_write" ON ip_whitelist
FOR ALL USING (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  AND (SELECT r.code FROM roles r JOIN users u ON u.role_id = r.id WHERE u.id = auth.uid()) IN ('SUPER_ADMIN', 'ADMIN')
);

-- gdpr_requests: Users see own requests, admins see all org requests
CREATE POLICY "gdpr_requests_user_read" ON gdpr_requests
FOR SELECT USING (
  user_id = auth.uid()
  OR (
    org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    AND (SELECT r.code FROM roles r JOIN users u ON u.role_id = r.id WHERE u.id = auth.uid()) IN ('SUPER_ADMIN', 'ADMIN')
  )
);

CREATE POLICY "gdpr_requests_user_insert" ON gdpr_requests
FOR INSERT WITH CHECK (
  user_id = auth.uid()
  AND org_id = (SELECT org_id FROM users WHERE id = auth.uid())
);

CREATE POLICY "gdpr_requests_admin_update" ON gdpr_requests
FOR UPDATE USING (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  AND (SELECT r.code FROM roles r JOIN users u ON u.role_id = r.id WHERE u.id = auth.uid()) IN ('SUPER_ADMIN', 'ADMIN')
);
```

### API Endpoints

```
# IP Whitelist
GET    /api/v1/settings/security/ip-whitelist         - List whitelisted IPs
POST   /api/v1/settings/security/ip-whitelist         - Add IP to whitelist
PUT    /api/v1/settings/security/ip-whitelist/:id     - Update IP entry
DELETE /api/v1/settings/security/ip-whitelist/:id     - Remove IP from whitelist

# GDPR Requests
GET    /api/v1/settings/gdpr/requests                 - List GDPR requests (own or all for admin)
POST   /api/v1/settings/gdpr/request-data-export      - Request data export (access)
POST   /api/v1/settings/gdpr/request-erasure          - Request data erasure
POST   /api/v1/settings/gdpr/request-portability      - Request data portability
GET    /api/v1/settings/gdpr/requests/:id/download    - Download export file
PUT    /api/v1/settings/gdpr/requests/:id             - Update request status (admin)

# Privacy Policy
POST   /api/v1/settings/privacy-policy/accept         - Accept privacy policy
GET    /api/v1/settings/privacy-policy/status         - Get acceptance status
```

### Service Methods

**Location:** `lib/services/ip-whitelist-service.ts`

```typescript
interface IPWhitelistService {
  // CRUD
  list(orgId: string): Promise<IPWhitelistEntry[]>;
  add(orgId: string, ip: string, description?: string): Promise<IPWhitelistEntry>;
  update(id: string, description: string): Promise<IPWhitelistEntry>;
  remove(id: string): Promise<void>;

  // Validation
  isIPAllowed(orgId: string, ip: string): Promise<boolean>;
  validateIPOrCIDR(value: string): ValidationResult;

  // Helpers
  isInCIDRRange(ip: string, cidr: string): boolean;
}

interface IPWhitelistEntry {
  id: string;
  org_id: string;
  ip_address: string;
  description: string | null;
  created_by: string;
  created_at: string;
}
```

**Location:** `lib/services/gdpr-service.ts`

```typescript
interface GDPRService {
  // Requests
  listRequests(orgId: string, userId?: string): Promise<GDPRRequest[]>;
  createExportRequest(userId: string): Promise<GDPRRequest>;
  createErasureRequest(userId: string): Promise<GDPRRequest>;
  createPortabilityRequest(userId: string): Promise<GDPRRequest>;

  // Processing
  processRequest(requestId: string, adminId: string): Promise<void>;
  rejectRequest(requestId: string, adminId: string, reason: string): Promise<void>;

  // Data operations
  generateUserDataExport(userId: string): Promise<string>; // Returns S3 URL
  anonymizeUser(userId: string): Promise<void>;

  // Privacy policy
  acceptPrivacyPolicy(userId: string, version: string): Promise<void>;
  getPrivacyPolicyStatus(userId: string): Promise<PrivacyPolicyStatus>;
}

interface GDPRRequest {
  id: string;
  user_id: string;
  request_type: 'access' | 'erasure' | 'portability';
  status: 'pending' | 'processing' | 'completed' | 'rejected';
  requested_at: string;
  completed_at: string | null;
  data_export_url: string | null;
  rejection_reason: string | null;
}
```

### Zod Validation Schemas

**Location:** `lib/validation/ip-whitelist.ts`

```typescript
import { z } from 'zod';

// IP/CIDR validation regex
const IP_REGEX = /^(\d{1,3}\.){3}\d{1,3}(\/\d{1,2})?$/;
const IPV6_REGEX = /^([0-9a-fA-F]{0,4}:){2,7}[0-9a-fA-F]{0,4}(\/\d{1,3})?$/;

export const ipAddressSchema = z.string()
  .refine(
    (val) => IP_REGEX.test(val) || IPV6_REGEX.test(val),
    'Invalid IP address or CIDR notation'
  );

export const createIPWhitelistSchema = z.object({
  ip_address: ipAddressSchema,
  description: z.string().max(200).optional(),
});

export const updateIPWhitelistSchema = z.object({
  description: z.string().max(200),
});
```

**Location:** `lib/validation/gdpr.ts`

```typescript
import { z } from 'zod';

export const gdprRequestTypeSchema = z.enum(['access', 'erasure', 'portability']);

export const createGDPRRequestSchema = z.object({
  request_type: gdprRequestTypeSchema,
  notes: z.string().max(1000).optional(),
});

export const updateGDPRRequestSchema = z.object({
  status: z.enum(['processing', 'completed', 'rejected']),
  rejection_reason: z.string().max(500).optional(),
});

export const acceptPrivacyPolicySchema = z.object({
  version: z.string().min(1).max(20),
});
```

## UI Components

### Pages

- `app/(authenticated)/settings/security/ip-whitelist/page.tsx` - IP whitelist management
- `app/(authenticated)/settings/privacy/page.tsx` - GDPR requests and privacy settings

### Components

**Location:** `components/settings/security/`

```
IPWhitelistTable.tsx          - DataTable for IP entries
IPWhitelistAddDialog.tsx      - Dialog to add new IP/CIDR
IPWhitelistEditDialog.tsx     - Dialog to edit description
IPWhitelistDeleteDialog.tsx   - Confirmation for deletion
```

**Location:** `components/settings/privacy/`

```
GDPRRequestsTable.tsx         - DataTable for GDPR requests
GDPRExportDialog.tsx          - Confirm data export request
GDPRErasureDialog.tsx         - Warning dialog for erasure (irreversible)
PrivacyPolicyBanner.tsx       - Banner for policy acceptance
```

## Test Cases

### Unit Tests

```typescript
describe('IPWhitelistService', () => {
  describe('isIPAllowed', () => {
    it('returns true when IP matches exact entry');
    it('returns true when IP is within CIDR range');
    it('returns false when IP not in whitelist');
    it('returns true when whitelist is empty (disabled)');
  });

  describe('validateIPOrCIDR', () => {
    it('accepts valid IPv4 address');
    it('accepts valid IPv6 address');
    it('accepts valid CIDR notation');
    it('rejects invalid IP format');
    it('rejects CIDR with invalid mask');
  });
});

describe('GDPRService', () => {
  describe('generateUserDataExport', () => {
    it('includes user profile data');
    it('includes session history');
    it('includes audit log entries');
    it('returns valid S3 signed URL');
  });

  describe('anonymizeUser', () => {
    it('anonymizes email to standard format');
    it('clears personal data fields');
    it('preserves user_id for audit trail');
    it('sets anonymized_at timestamp');
  });
});
```

### Integration Tests

```typescript
describe('IP Whitelist API', () => {
  describe('POST /api/v1/settings/security/ip-whitelist', () => {
    it('admin can add IP to whitelist');
    it('non-admin gets 403');
    it('rejects duplicate IP');
    it('validates CIDR notation');
  });

  describe('Login with IP Whitelist', () => {
    it('allows login from whitelisted IP');
    it('blocks login from non-whitelisted IP');
    it('allows super_admin from any IP');
  });
});

describe('GDPR API', () => {
  describe('POST /api/v1/settings/gdpr/request-data-export', () => {
    it('creates pending request');
    it('user can only request own data');
  });

  describe('POST /api/v1/settings/gdpr/request-erasure', () => {
    it('anonymizes user data');
    it('preserves audit trail');
    it('prevents future login');
  });
});
```

## Deliverables

- [ ] `ip_whitelist` table migration
- [ ] `gdpr_requests` table migration
- [ ] Users table extension (anonymized_at, privacy_policy fields)
- [ ] RLS policies for ip_whitelist and gdpr_requests
- [ ] IP whitelist service (`lib/services/ip-whitelist-service.ts`)
- [ ] GDPR service (`lib/services/gdpr-service.ts`)
- [ ] Zod schemas (`lib/validation/ip-whitelist.ts`, `lib/validation/gdpr.ts`)
- [ ] API routes for IP whitelist
- [ ] API routes for GDPR requests
- [ ] Login middleware for IP validation
- [ ] IPWhitelistTable component
- [ ] GDPRRequestsTable component
- [ ] Export/Erasure confirmation dialogs
- [ ] Unit tests (>80% coverage)
- [ ] Integration tests

## Definition of Done

- [ ] IP whitelist CRUD fully functional
- [ ] CIDR notation properly validated and enforced
- [ ] Login blocked for non-whitelisted IPs (401 response)
- [ ] Super_admin can login from any IP
- [ ] Data export generates complete JSON with all user data
- [ ] Erasure properly anonymizes user (email, name cleared)
- [ ] Audit logs preserved after erasure
- [ ] Privacy policy acceptance tracked with timestamps
- [ ] GDPR request queue displays all statuses
- [ ] Download links expire after 24 hours
- [ ] Cross-tenant access returns 404
- [ ] Audit log entries created for all changes
- [ ] Unit test coverage >= 80%
- [ ] Integration tests pass
