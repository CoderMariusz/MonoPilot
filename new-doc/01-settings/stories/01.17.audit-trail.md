# 01.17 - Audit Trail

**Story ID:** 01.17
**Epic:** 01 - Settings
**Phase:** 1B (Polish)
**Complexity:** L (Large)
**Estimate:** 3-4 days
**Type:** Backend + Frontend
**State:** ready

**Primary PRD:** `docs/1-BASELINE/product/modules/settings.md` (FR-SET-140 to FR-SET-144)
**UX Wireframes:** SET-025-audit-logs.md

## PRD References

| FR ID | Requirement | Priority | Phase | Covered |
|-------|-------------|----------|-------|---------|
| FR-SET-140 | User Action Logging | P1 | 1B | Yes |
| FR-SET-141 | Data Change Tracking | P1 | 1B | Yes |
| FR-SET-142 | Login/Logout Tracking | P1 | 1B | Yes |
| FR-SET-143 | Audit Log Search/Filter | P1 | 1B | Yes |
| FR-SET-144 | Audit Log Export | P2 | 1B | Yes |

## User Story

**As a** compliance officer or administrator,
**I want** to view a complete audit trail of all user actions and data changes,
**So that** I can ensure regulatory compliance (HACCP), investigate security incidents, and maintain accountability for all system modifications.

**As a** manager,
**I want** to search and filter audit logs by user, action type, entity, and date range,
**So that** I can quickly find specific events and generate compliance reports.

## Goal

Implement a comprehensive audit trail system that logs all CREATE, UPDATE, DELETE operations on entities, tracks field-level changes with before/after values, records authentication events (LOGIN, LOGOUT, LOGIN_FAILED, SESSION_EXPIRED), and provides efficient search/filter/export capabilities for compliance and security auditing. The system must handle 100k+ entries with sub-2-second query performance.

## Scope

**In scope:**
- Audit log table with immutable append-only design
- User action logging (CREATE, UPDATE, DELETE) with entity type, ID, user_id, timestamp
- Field-level change tracking with before/after values in JSONB
- Sensitive field redaction (passwords, API keys show "[REDACTED]")
- Authentication event tracking (LOGIN, LOGOUT, LOGIN_FAILED, SESSION_EXPIRED)
- IP address and user agent capture for all events
- Search and filter by user, action, entity type, date range
- Full-text search across audit log contents
- CSV export with filtered results (max 10k rows)
- Pagination with infinite scroll (100 entries per load)
- Performance optimization for 100k+ entries
- Multi-tenant isolation via org_id and RLS

**Out of scope:**
- FR-SET-145: Audit retention policies (Phase 2)
- FR-SET-146: Critical event alerting (Phase 2)
- Real-time audit log updates (static snapshot, manual refresh)
- Audit log archival to cold storage
- IP geolocation
- User agent parsing for device type

## Dependencies

| Story | Requirement | Status |
|-------|-------------|--------|
| 01.1 | Org Context + Base RLS | Required - provides org_id context |
| 01.6 | Role Permissions | Required - manager/admin permission check |
| 01.15 | Session Management | Required - session tracking for auth events |

## Acceptance Criteria (Given/When/Then)

### User Action Logging (FR-SET-140)

#### CREATE Actions
- GIVEN user creates a product, WHEN action completes, THEN audit log entry created with action "CREATE", entity_type "products", entity_id, user_id, timestamp accurate to millisecond.
- GIVEN user creates a warehouse, WHEN action completes, THEN changes field contains created values as `{created: {field: value}}`.
- GIVEN 1000 CREATE actions performed, WHEN audit log queried, THEN all 1000 entries retrievable in chronological order.

#### UPDATE Actions
- GIVEN user updates warehouse name, WHEN save completes, THEN audit log entry created with action "UPDATE", before/after values.
- GIVEN user updates multiple fields in single save, WHEN audit log viewed, THEN all changed fields in single entry.
- GIVEN no fields changed (save clicked without edits), WHEN audit checked, THEN no audit entry created.

#### DELETE Actions
- GIVEN user deletes a machine, WHEN delete completes, THEN audit log entry created with action "DELETE", deleted entity data preserved.
- GIVEN soft-delete entity restored, WHEN restore completes, THEN audit log entry created with action "RESTORE".

#### Immutability
- GIVEN audit log entry exists, WHEN modification attempted via API or direct SQL, THEN modification rejected.
- GIVEN audit log entry created, WHEN viewed later, THEN timestamp and all fields unchanged from original.

### Data Change Tracking (FR-SET-141)

#### Field-Level Changes
- GIVEN product price changed from 10.00 to 12.50, WHEN audit log viewed, THEN shows `{before: {price: 10.00}, after: {price: 12.50}}`.
- GIVEN user email changed, WHEN audit log viewed, THEN old and new email values displayed in changes JSONB.
- GIVEN multiple fields changed (name and price), WHEN audit log viewed, THEN both fields appear in single changes object.

#### Sensitive Field Redaction
- GIVEN password hash changed, WHEN audit log viewed, THEN value shows "[REDACTED]" not actual hash.
- GIVEN API key regenerated, WHEN audit log viewed, THEN old and new keys show "[REDACTED]".
- GIVEN email changed (non-sensitive), WHEN audit log viewed, THEN actual email values displayed.

### Login/Logout Tracking (FR-SET-142)

#### Successful Login
- GIVEN user logs in successfully, WHEN audit queried, THEN entry shows action "LOGIN", user_id, IP address, user_agent, timestamp.
- GIVEN user logs in from 192.168.1.100, WHEN audit log viewed, THEN ip_address field contains "192.168.1.100".

#### Logout Events
- GIVEN user clicks logout, WHEN audit queried, THEN entry shows action "LOGOUT", user_id, session_duration in metadata.
- GIVEN session duration was 2h 15m, WHEN audit log viewed, THEN metadata contains `{session_duration_seconds: 8100}`.

#### Failed Login Attempts
- GIVEN login fails with wrong password, WHEN audit queried, THEN entry shows action "LOGIN_FAILED", email (not user_id), IP, timestamp.
- GIVEN 5 consecutive failed logins, WHEN audit queried, THEN all 5 failed attempts visible with timestamps and attempt_count.
- GIVEN failed login attempt, WHEN audit log viewed, THEN metadata contains `{email: "user@example.com", reason: "Invalid password"}`.

#### Session Expiry
- GIVEN session expires due to timeout, WHEN audit queried, THEN entry shows action "SESSION_EXPIRED", user_id, timestamp.
- GIVEN session expired after 8 hours, WHEN audit log viewed, THEN metadata contains session duration.

### Audit Log Search/Filter (FR-SET-143)

#### Page Load Performance
- GIVEN admin navigates to `/settings/audit-logs`, WHEN page loads, THEN most recent 100 entries display within 1 second.
- GIVEN 100,000 audit entries exist, WHEN page loads with no filters, THEN results return within 2 seconds.

#### User Filter
- GIVEN filter by user "john@company.com", WHEN applied, THEN only entries where user_id matches John's ID display.
- GIVEN filter by multiple users (John and Sarah), WHEN applied, THEN entries from both users display.

#### Action Filter
- GIVEN filter by action "DELETE", WHEN applied, THEN only DELETE actions display.
- GIVEN filter by actions "CREATE" and "UPDATE", WHEN applied, THEN both action types display.
- GIVEN filter by action "LOGIN_FAILED", WHEN applied, THEN only failed login attempts display.

#### Entity Type Filter
- GIVEN filter by entity "products", WHEN applied, THEN only product-related actions display.
- GIVEN filter by entities "products" and "warehouses", WHEN applied, THEN both entity types display.

#### Date Range Filter
- GIVEN filter by date range "2025-12-01 to 2025-12-10", WHEN applied, THEN only actions in that range display.
- GIVEN filter preset "Last 7 days" selected, WHEN applied, THEN entries from past 7 days display.
- GIVEN filter preset "Today" selected, WHEN applied, THEN only today's entries display.

#### Combined Filters
- GIVEN multiple filters applied (User=John, Action=DELETE, Date=Last 7 days), WHEN search executed, THEN filters AND together.
- GIVEN 100,000 entries exist and filters applied, WHEN filtered query runs, THEN results return within 2 seconds.

#### Full-Text Search
- GIVEN search text "WH-001", WHEN entered, THEN entries containing "WH-001" in any field display.
- GIVEN search text "Mixer", WHEN entered, THEN entries with "Mixer" in entity name or changes display.
- GIVEN search debounced at 300ms, WHEN user types quickly, THEN search triggers once after typing stops.

#### Pagination
- GIVEN 12,453 matching entries, WHEN initial load completes, THEN "Showing 1-100 of 12,453 entries" displays.
- GIVEN user clicks "Load More", WHEN next 100 entries load, THEN "Showing 1-200 of 12,453 entries" displays.
- GIVEN infinite scroll enabled, WHEN user scrolls to bottom, THEN next 100 entries auto-load.

### Audit Log Export (FR-SET-144)

#### CSV Export
- GIVEN user clicks "Export CSV", WHEN export completes, THEN CSV file downloads with filtered results.
- GIVEN export triggered, WHEN CSV generated, THEN columns include: Timestamp, User, User Email, Action, Entity Type, Entity ID, Details, IP Address, User Agent.
- GIVEN active filters applied, WHEN export triggered, THEN only filtered entries included in export.

#### Export Limits
- GIVEN filtered results contain 15,000 entries, WHEN export triggered, THEN warning "Export limited to first 10,000 entries" displays.
- GIVEN export completes, WHEN file examined, THEN max 10,000 rows present.
- GIVEN large export triggered, WHEN processing, THEN export completes within 5 seconds.

#### Export Filename
- GIVEN organization name "AcmeFoods", WHEN export triggered on 2025-12-15, THEN filename is "audit-logs-AcmeFoods-2025-12-15.csv".

### Multi-tenancy

- GIVEN User A from Org A, WHEN requesting audit logs, THEN only Org A logs returned.
- GIVEN User A from Org A, WHEN searching logs, THEN search limited to Org A scope.
- GIVEN RLS enabled on audit_logs table, WHEN direct SQL query attempted without org_id, THEN zero rows returned.

### Permission Control

- GIVEN user with Manager role, WHEN accessing audit logs, THEN full read access granted.
- GIVEN user with Operator role, WHEN accessing audit logs page, THEN 403 Forbidden returned.
- GIVEN user with Admin role, WHEN exporting audit logs, THEN export succeeds.

## Technical Specification

### Database Schema

#### audit_logs table

```sql
CREATE TABLE audit_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  user_id UUID REFERENCES users(id) ON DELETE SET NULL,

  -- Action classification
  action VARCHAR(50) NOT NULL CHECK (action IN (
    'CREATE', 'UPDATE', 'DELETE', 'RESTORE',
    'LOGIN', 'LOGOUT', 'LOGIN_FAILED', 'SESSION_EXPIRED'
  )),

  -- Entity reference
  entity_type VARCHAR(100),
  entity_id UUID,

  -- Change tracking
  changes JSONB, -- {before: {}, after: {}, changed_fields: []} or {created: {}} or {deleted: {}}

  -- Request context
  ip_address INET,
  user_agent TEXT,
  session_id UUID,

  -- Metadata for auth events
  metadata JSONB, -- {email: "", reason: "", attempt_count: N, session_duration_seconds: N}

  -- Timestamp with millisecond precision
  created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,

  -- Full-text search vector
  search_vector TSVECTOR
);

-- Performance indexes
CREATE INDEX idx_audit_logs_org_timestamp ON audit_logs(org_id, created_at DESC);
CREATE INDEX idx_audit_logs_user_id ON audit_logs(user_id);
CREATE INDEX idx_audit_logs_action ON audit_logs(action);
CREATE INDEX idx_audit_logs_entity_type ON audit_logs(entity_type);
CREATE INDEX idx_audit_logs_entity_id ON audit_logs(entity_id);
CREATE INDEX idx_audit_logs_created_at ON audit_logs(created_at DESC);
CREATE INDEX idx_audit_logs_search ON audit_logs USING GIN(search_vector);

-- Composite index for common filter combinations
CREATE INDEX idx_audit_logs_org_user_action ON audit_logs(org_id, user_id, action);
CREATE INDEX idx_audit_logs_org_entity ON audit_logs(org_id, entity_type, created_at DESC);

-- Full-text search trigger
CREATE OR REPLACE FUNCTION audit_logs_search_trigger()
RETURNS TRIGGER AS $$
BEGIN
  NEW.search_vector := to_tsvector('english',
    COALESCE(NEW.entity_type, '') || ' ' ||
    COALESCE(NEW.entity_id::text, '') || ' ' ||
    COALESCE(NEW.changes::text, '') || ' ' ||
    COALESCE(NEW.metadata::text, '')
  );
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER audit_logs_search_update
BEFORE INSERT OR UPDATE ON audit_logs
FOR EACH ROW EXECUTE FUNCTION audit_logs_search_trigger();

-- Immutability: Prevent updates and deletes
CREATE OR REPLACE FUNCTION prevent_audit_modification()
RETURNS TRIGGER AS $$
BEGIN
  RAISE EXCEPTION 'Audit logs are immutable and cannot be modified or deleted';
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER audit_logs_immutable_update
BEFORE UPDATE ON audit_logs
FOR EACH ROW EXECUTE FUNCTION prevent_audit_modification();

CREATE TRIGGER audit_logs_immutable_delete
BEFORE DELETE ON audit_logs
FOR EACH ROW EXECUTE FUNCTION prevent_audit_modification();
```

### RLS Policies

```sql
-- Enable RLS
ALTER TABLE audit_logs ENABLE ROW LEVEL SECURITY;

-- Read policy: Manager and Admin roles only, scoped to org
CREATE POLICY "audit_logs_read" ON audit_logs
FOR SELECT USING (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  AND (
    SELECT r.code FROM roles r
    JOIN users u ON u.role_id = r.id
    WHERE u.id = auth.uid()
  ) IN ('SUPER_ADMIN', 'ADMIN', 'MANAGER')
);

-- Insert policy: System/service role only (via backend)
CREATE POLICY "audit_logs_insert" ON audit_logs
FOR INSERT WITH CHECK (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
);

-- No update or delete policies (handled by triggers)
```

### API Endpoints

```
# Audit Log Viewing
GET    /api/v1/settings/audit-logs           - List audit logs with filters
GET    /api/v1/settings/audit-logs/:id       - Get single audit log entry details

# Audit Log Export
POST   /api/v1/settings/audit-logs/export    - Export filtered logs to CSV

# Internal (triggered by middleware, not user-facing)
POST   /api/v1/internal/audit-logs           - Create audit log entry (service only)
```

### Query Parameters for GET /api/v1/settings/audit-logs

| Parameter | Type | Description |
|-----------|------|-------------|
| search | string | Full-text search across all fields |
| user_id | uuid | Filter by specific user |
| user_ids | uuid[] | Filter by multiple users (comma-separated) |
| action | string | Filter by action type |
| actions | string[] | Filter by multiple actions (comma-separated) |
| entity_type | string | Filter by entity type |
| entity_types | string[] | Filter by multiple entity types (comma-separated) |
| date_from | ISO8601 | Start date for date range filter |
| date_to | ISO8601 | End date for date range filter |
| limit | number | Results per page (default 100, max 100) |
| offset | number | Pagination offset |

### Service Methods

**Location:** `lib/services/audit-service.ts`

```typescript
interface AuditService {
  // Query methods
  getAuditLogs(orgId: string, filters: AuditLogFilters): Promise<PaginatedAuditLogs>;
  getAuditLogById(orgId: string, id: string): Promise<AuditLog | null>;

  // Logging methods (called internally)
  logCreate(params: CreateAuditParams): Promise<void>;
  logUpdate(params: UpdateAuditParams): Promise<void>;
  logDelete(params: DeleteAuditParams): Promise<void>;
  logLogin(params: LoginAuditParams): Promise<void>;
  logLogout(params: LogoutAuditParams): Promise<void>;
  logLoginFailed(params: LoginFailedParams): Promise<void>;
  logSessionExpired(params: SessionExpiredParams): Promise<void>;

  // Export
  exportToCsv(orgId: string, filters: AuditLogFilters): Promise<Buffer>;

  // Helpers
  redactSensitiveFields(changes: Record<string, any>): Record<string, any>;
  computeChanges(before: Record<string, any>, after: Record<string, any>): ChangeSet;
}

interface AuditLogFilters {
  search?: string;
  user_ids?: string[];
  actions?: AuditAction[];
  entity_types?: string[];
  date_from?: Date;
  date_to?: Date;
  limit?: number;
  offset?: number;
}

interface AuditLog {
  id: string;
  org_id: string;
  user_id: string | null;
  action: AuditAction;
  entity_type: string | null;
  entity_id: string | null;
  changes: ChangeSet | null;
  ip_address: string | null;
  user_agent: string | null;
  session_id: string | null;
  metadata: Record<string, any> | null;
  created_at: string;
  user?: { name: string; email: string }; // Joined from users table
}

type AuditAction =
  | 'CREATE' | 'UPDATE' | 'DELETE' | 'RESTORE'
  | 'LOGIN' | 'LOGOUT' | 'LOGIN_FAILED' | 'SESSION_EXPIRED';

interface ChangeSet {
  before?: Record<string, any>;
  after?: Record<string, any>;
  changed_fields?: string[];
  created?: Record<string, any>;
  deleted?: Record<string, any>;
}

interface PaginatedAuditLogs {
  data: AuditLog[];
  total: number;
  limit: number;
  offset: number;
}
```

### Zod Validation Schemas

**Location:** `lib/validation/audit.ts`

```typescript
import { z } from 'zod';

// Audit action enum
export const auditActionSchema = z.enum([
  'CREATE', 'UPDATE', 'DELETE', 'RESTORE',
  'LOGIN', 'LOGOUT', 'LOGIN_FAILED', 'SESSION_EXPIRED'
]);

// Audit log response schema
export const auditLogSchema = z.object({
  id: z.string().uuid(),
  org_id: z.string().uuid(),
  user_id: z.string().uuid().nullable(),
  action: auditActionSchema,
  entity_type: z.string().nullable(),
  entity_id: z.string().uuid().nullable(),
  changes: z.record(z.any()).nullable(),
  ip_address: z.string().nullable(),
  user_agent: z.string().nullable(),
  session_id: z.string().uuid().nullable(),
  metadata: z.record(z.any()).nullable(),
  created_at: z.string().datetime(),
  user: z.object({
    name: z.string(),
    email: z.string().email(),
  }).optional(),
});

// Query parameters schema
export const auditLogQuerySchema = z.object({
  search: z.string().optional(),
  user_id: z.string().uuid().optional(),
  user_ids: z.string().transform(s => s.split(',')).optional(),
  action: auditActionSchema.optional(),
  actions: z.string().transform(s => s.split(',')).optional(),
  entity_type: z.string().optional(),
  entity_types: z.string().transform(s => s.split(',')).optional(),
  date_from: z.string().datetime().optional(),
  date_to: z.string().datetime().optional(),
  limit: z.coerce.number().min(1).max(100).default(100),
  offset: z.coerce.number().min(0).default(0),
});

// Export request schema
export const auditExportSchema = z.object({
  search: z.string().optional(),
  user_ids: z.array(z.string().uuid()).optional(),
  actions: z.array(auditActionSchema).optional(),
  entity_types: z.array(z.string()).optional(),
  date_from: z.string().datetime().optional(),
  date_to: z.string().datetime().optional(),
});

// Paginated response schema
export const paginatedAuditLogsSchema = z.object({
  data: z.array(auditLogSchema),
  total: z.number(),
  limit: z.number(),
  offset: z.number(),
});
```

### Sensitive Fields Configuration

```typescript
// lib/services/audit-service.ts

const SENSITIVE_FIELDS = new Set([
  'password',
  'password_hash',
  'api_key',
  'api_secret',
  'refresh_token',
  'session_token',
  'secret_key',
  'private_key',
  'access_token',
]);

function redactSensitiveFields(obj: Record<string, any>): Record<string, any> {
  const result: Record<string, any> = {};
  for (const [key, value] of Object.entries(obj)) {
    if (SENSITIVE_FIELDS.has(key.toLowerCase())) {
      result[key] = '[REDACTED]';
    } else if (typeof value === 'object' && value !== null) {
      result[key] = redactSensitiveFields(value);
    } else {
      result[key] = value;
    }
  }
  return result;
}
```

## UI Components

### Pages

- `app/(authenticated)/settings/audit-logs/page.tsx` - Main audit logs page

### Components

**Location:** `components/settings/audit/`

```
AuditLogsTable.tsx          - Main data table with infinite scroll
AuditLogRow.tsx             - Single audit log row with expand action
AuditLogDetails.tsx         - Expanded detail panel for single entry
AuditLogFilters.tsx         - Filter controls (user, action, entity, date)
AuditLogSearch.tsx          - Full-text search input with debounce
AuditLogExportButton.tsx    - Export to CSV button with progress
DateRangePicker.tsx         - Date range filter with presets
AuditLogEmptyState.tsx      - Empty state when no logs match
AuditLogLoadingState.tsx    - Skeleton loading state
```

### Component Props

**AuditLogsTable.tsx**
```tsx
interface AuditLogsTableProps {
  logs: AuditLog[];
  total: number;
  isLoading: boolean;
  hasMore: boolean;
  onLoadMore: () => void;
  onRowExpand: (id: string) => void;
}
```

**AuditLogFilters.tsx**
```tsx
interface AuditLogFiltersProps {
  users: { id: string; name: string; email: string }[];
  onFilterChange: (filters: AuditLogFilters) => void;
  currentFilters: AuditLogFilters;
}
```

## Test Cases

### Unit Tests

**audit-service.test.ts**
```typescript
describe('AuditService', () => {
  describe('redactSensitiveFields', () => {
    it('redacts password field');
    it('redacts api_key field');
    it('redacts nested sensitive fields');
    it('preserves non-sensitive fields');
  });

  describe('computeChanges', () => {
    it('computes changed fields between before and after');
    it('returns empty when no changes');
    it('handles null values correctly');
  });

  describe('logCreate', () => {
    it('creates audit entry with action CREATE');
    it('includes created values in changes');
    it('captures IP and user agent');
  });

  describe('logUpdate', () => {
    it('creates audit entry with before/after values');
    it('skips entry if no fields changed');
    it('redacts sensitive fields in changes');
  });

  describe('exportToCsv', () => {
    it('generates valid CSV format');
    it('limits export to 10,000 rows');
    it('applies filters to export');
  });
});
```

### Integration Tests

**audit-api.test.ts**
```typescript
describe('Audit API', () => {
  describe('GET /api/v1/settings/audit-logs', () => {
    it('returns paginated audit logs');
    it('filters by user_id');
    it('filters by action');
    it('filters by entity_type');
    it('filters by date range');
    it('combines multiple filters with AND');
    it('performs full-text search');
    it('returns 403 for non-manager/admin users');
    it('scopes results to user org');
  });

  describe('GET /api/v1/settings/audit-logs/:id', () => {
    it('returns single audit log with details');
    it('returns 404 for non-existent ID');
    it('returns 404 for other org audit log');
  });

  describe('POST /api/v1/settings/audit-logs/export', () => {
    it('exports filtered logs to CSV');
    it('limits to 10,000 rows');
    it('returns 403 for non-manager/admin users');
  });
});
```

### E2E Tests

**audit-logs.spec.ts**
```typescript
describe('Audit Logs', () => {
  it('displays audit logs table on page load');
  it('shows loading skeleton during fetch');
  it('displays empty state when no logs match');
  it('filters logs by user selection');
  it('filters logs by action type');
  it('filters logs by date range');
  it('performs search across logs');
  it('expands row to show details');
  it('loads more entries on scroll');
  it('exports filtered logs to CSV');
  it('shows export limit warning for large exports');
});
```

## Deliverables

- [ ] `audit_logs` table migration with indexes
- [ ] Full-text search trigger migration
- [ ] Immutability triggers migration
- [ ] RLS policies for audit_logs table
- [ ] Audit service (`lib/services/audit-service.ts`)
- [ ] Audit middleware for automatic logging (`lib/middleware/audit-middleware.ts`)
- [ ] Zod schemas (`lib/validation/audit.ts`)
- [ ] GET /api/v1/settings/audit-logs endpoint
- [ ] GET /api/v1/settings/audit-logs/:id endpoint
- [ ] POST /api/v1/settings/audit-logs/export endpoint
- [ ] AuditLogsTable component
- [ ] AuditLogRow component
- [ ] AuditLogDetails component
- [ ] AuditLogFilters component
- [ ] AuditLogSearch component
- [ ] AuditLogExportButton component
- [ ] DateRangePicker component
- [ ] Audit logs page
- [ ] Unit tests (>80% coverage)
- [ ] Integration tests
- [ ] E2E tests

## Definition of Done

- [ ] All CREATE/UPDATE/DELETE actions logged with entity type, ID, user_id, timestamp
- [ ] Field-level changes tracked with before/after values in JSONB
- [ ] Sensitive fields (passwords, API keys) redacted as "[REDACTED]"
- [ ] LOGIN, LOGOUT, LOGIN_FAILED, SESSION_EXPIRED events tracked with IP and user agent
- [ ] Audit log entries are immutable (update/delete triggers reject modifications)
- [ ] Search by full-text works across entity, changes, and metadata
- [ ] Filter by user, action, entity type works correctly
- [ ] Filter by date range with presets works correctly
- [ ] Multiple filters combine with AND logic
- [ ] Page loads 100 entries within 1 second
- [ ] Filtered queries on 100k+ entries complete within 2 seconds
- [ ] Infinite scroll loads next 100 entries on demand
- [ ] CSV export generates correct format with filtered results
- [ ] CSV export limited to 10,000 rows with warning for larger sets
- [ ] Manager and Admin roles can access audit logs
- [ ] Operator and below receive 403 Forbidden
- [ ] RLS ensures org isolation (users see only their org's logs)
- [ ] Unit test coverage >= 80%
- [ ] Integration tests pass
- [ ] E2E tests pass
