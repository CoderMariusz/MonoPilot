# 01.20a - Multi-Language Core (Language Selection & Translation Management)

**Story ID:** 01.20a
**Epic:** 01 - Settings
**Phase:** 1B (Polish)
**Complexity:** M (Medium)
**Estimate:** 2-3 days
**Type:** Full-stack
**State:** ready

**Primary PRD:** `docs/1-BASELINE/product/modules/settings.md` (FR-SET-110, FR-SET-111, FR-SET-112, FR-SET-113)

## PRD References

| FR ID | Requirement | Priority | Phase | Covered |
|-------|-------------|----------|-------|---------|
| FR-SET-110 | Language Selection (PL/EN/DE/FR) | P1 | 1B | Yes |
| FR-SET-111 | UI Translation Management | P1 | 1B | Yes |
| FR-SET-112 | User-Level Language Preference | P1 | 1B | Yes |
| FR-SET-113 | Organization Default Language | P1 | 1B | Yes |

## User Story

**As a** user,
**I want** to select my preferred language from PL, EN, DE, or FR,
**So that** I can use the application in my native language for better productivity.

**As an** administrator,
**I want** to set an organization default language and manage translations,
**So that** new users see the appropriate language and custom terminology can be applied.

## Goal

Implement core multi-language support with 4 languages (Polish, English, German, French). Users can set personal language preferences that override organization defaults. Translations are stored in the database for runtime updates without redeployment. Integration with next-intl for React component localization.

## Scope

**In scope:**
- 4 languages: PL (Polish), EN (English), DE (German), FR (French)
- User language preference (stored in users table)
- Organization default language (stored in organizations table)
- Database-backed translations table
- next-intl integration for React i18n
- Language switcher in application header
- Dynamic language switching (no page reload)
- English as fallback for missing translations
- Admin translation management UI

**Out of scope:**
- Date/Time format localization (FR-SET-114, separate story 01.20b)
- Number/Currency format localization (FR-SET-115, separate story 01.20b)
- RTL language support
- Translation import/export (future enhancement)
- Machine translation integration

## Dependencies

| Story | Requirement | Status |
|-------|-------------|--------|
| 01.1 | Org Context + Base RLS | Required - provides auth context |
| 01.5 | Users CRUD | Required - user table exists |
| 01.6 | Role Permissions | Required - admin-only translation management |

## Acceptance Criteria (Given/When/Then)

### Language Selection (FR-SET-110)

#### Language Dropdown
- GIVEN user profile page open, WHEN language dropdown clicked, THEN PL, EN, DE, FR options display with native names.
- GIVEN user selects "Polski", WHEN selection saved, THEN entire UI displays in Polish within 500ms.
- GIVEN user selects "English", WHEN selection saved, THEN entire UI displays in English.
- GIVEN user selects "Deutsch", WHEN selection saved, THEN entire UI displays in German.
- GIVEN user selects "Francais", WHEN selection saved, THEN entire UI displays in French.

#### Dynamic Switching
- GIVEN language changed, WHEN page does not reload, THEN all visible text updates dynamically (SPA behavior).
- GIVEN unsupported language requested via API, WHEN request processed, THEN fallback to English.

### UI Translation Management (FR-SET-111)

#### Admin Translation UI
- GIVEN admin navigates to translation management, WHEN page loads, THEN all translation keys display with values for each language.
- GIVEN translation key "settings.title" exists, WHEN admin updates Polish value, THEN change reflects immediately for Polish users.

#### Fallback Behavior
- GIVEN new feature added with missing translation, WHEN UI renders, THEN English fallback displays.
- GIVEN translation key has null value for German, WHEN German user views, THEN English value displays.

### User-Level Language Preference (FR-SET-112)

#### Preference Inheritance
- GIVEN organization default is Polish, WHEN new user created, THEN user language defaults to null (inherits org).
- GIVEN organization default is Polish, WHEN user sets preference to English, THEN UI displays in English for that user only.

#### Multi-User Isolation
- GIVEN user A has English, user B has Polish, WHEN both logged in, THEN each sees their preferred language.
- GIVEN user preference is null, WHEN user logs in, THEN organization default language used.
- GIVEN user changes language, WHEN change saved, THEN preference persists across sessions.

### Organization Default Language (FR-SET-113)

#### Org Default Settings
- GIVEN admin sets org default to German, WHEN new user invited, THEN invitation email sent in German.
- GIVEN admin sets org default to French, WHEN new user completes registration, THEN user sees French.
- GIVEN org default changed from EN to PL, WHEN existing users without preference login, THEN they see Polish.
- GIVEN org default changed, WHEN users with explicit preference login, THEN their preference unchanged.

### Multi-tenancy
- GIVEN Org A with default PL, WHEN Org B sets default DE, THEN each org's users see correct default.
- GIVEN admin from Org A, WHEN viewing translations, THEN only system translations visible (shared across orgs).

## Technical Specification

### Database Schema

#### users table extension

```sql
-- Add language preference to users
ALTER TABLE users ADD COLUMN IF NOT EXISTS
  language VARCHAR(5) CHECK (language IS NULL OR language IN ('pl', 'en', 'de', 'fr'));

COMMENT ON COLUMN users.language IS 'User language preference. NULL = use org default';
```

#### organizations table extension

```sql
-- Add default language to organizations
ALTER TABLE organizations ADD COLUMN IF NOT EXISTS
  default_language VARCHAR(5) NOT NULL DEFAULT 'en'
  CHECK (default_language IN ('pl', 'en', 'de', 'fr'));

COMMENT ON COLUMN organizations.default_language IS 'Organization default language for new users';
```

#### translations table

```sql
CREATE TABLE translations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  -- Translation key (namespaced: 'settings.title', 'common.save')
  key VARCHAR(255) NOT NULL UNIQUE,

  -- Namespace for grouping (settings, common, planning, etc.)
  namespace VARCHAR(100) NOT NULL DEFAULT 'common',

  -- Language values
  en TEXT NOT NULL, -- English is required (fallback)
  pl TEXT,
  de TEXT,
  fr TEXT,

  -- Metadata
  description TEXT, -- Context for translators
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),

  -- Indexes
  CONSTRAINT translations_key_unique UNIQUE (key)
);

-- Indexes for performance
CREATE INDEX idx_translations_namespace ON translations(namespace);
CREATE INDEX idx_translations_key ON translations(key);

-- Trigger for updated_at
CREATE TRIGGER translations_updated_at
  BEFORE UPDATE ON translations
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
```

### RLS Policies

```sql
-- translations: Read-only for all authenticated users, write for admins only
ALTER TABLE translations ENABLE ROW LEVEL SECURITY;

CREATE POLICY "translations_read_all" ON translations
FOR SELECT USING (auth.role() = 'authenticated');

CREATE POLICY "translations_admin_write" ON translations
FOR ALL USING (
  EXISTS (
    SELECT 1 FROM users u
    JOIN roles r ON u.role_id = r.id
    WHERE u.id = auth.uid()
    AND r.code IN ('SUPER_ADMIN', 'ADMIN')
  )
);
```

### API Endpoints

```
# User Language Preference
PATCH  /api/v1/settings/language                     - Update user language preference
GET    /api/v1/settings/language                     - Get effective language (user or org default)

# Translations (public read)
GET    /api/v1/settings/translations/:lang           - Get all translations for language
GET    /api/v1/settings/translations/:lang/:namespace - Get translations by namespace

# Admin Translation Management
GET    /api/v1/settings/translations                 - List all translation keys (admin)
PUT    /api/v1/settings/translations/:key            - Update translation (admin)
POST   /api/v1/settings/translations                 - Create translation key (admin)
DELETE /api/v1/settings/translations/:key            - Delete translation key (admin)

# Organization Default
PATCH  /api/v1/settings/organization/language        - Update org default language (admin)
```

### Service Methods

**Location:** `lib/services/language-service.ts`

```typescript
interface LanguageService {
  // Supported languages
  getSupportedLanguages(): Language[];

  // User preference
  getUserLanguage(userId: string): Promise<string | null>;
  setUserLanguage(userId: string, language: string): Promise<void>;
  getEffectiveLanguage(userId: string, orgId: string): Promise<string>;

  // Organization default
  getOrgDefaultLanguage(orgId: string): Promise<string>;
  setOrgDefaultLanguage(orgId: string, language: string): Promise<void>;

  // Validation
  isValidLanguage(code: string): boolean;
}

interface Language {
  code: string;      // 'pl', 'en', 'de', 'fr'
  name: string;      // 'Polish', 'English', etc.
  nativeName: string; // 'Polski', 'English', 'Deutsch', 'Francais'
  flag: string;      // Emoji flag
}
```

**Location:** `lib/services/translation-service.ts`

```typescript
interface TranslationService {
  // Fetch translations
  getTranslations(lang: string): Promise<Record<string, string>>;
  getTranslationsByNamespace(lang: string, namespace: string): Promise<Record<string, string>>;
  getTranslation(key: string, lang: string): Promise<string | null>;

  // Admin operations
  listAllTranslations(): Promise<TranslationEntry[]>;
  createTranslation(entry: CreateTranslationInput): Promise<TranslationEntry>;
  updateTranslation(key: string, values: TranslationValues): Promise<TranslationEntry>;
  deleteTranslation(key: string): Promise<void>;

  // Fallback handling
  getWithFallback(key: string, lang: string): Promise<string>;
}

interface TranslationEntry {
  id: string;
  key: string;
  namespace: string;
  en: string;
  pl: string | null;
  de: string | null;
  fr: string | null;
  description: string | null;
  updated_at: string;
}

interface TranslationValues {
  en?: string;
  pl?: string;
  de?: string;
  fr?: string;
  description?: string;
}
```

### Zod Validation Schemas

**Location:** `lib/validation/language.ts`

```typescript
import { z } from 'zod';

export const SUPPORTED_LANGUAGES = ['pl', 'en', 'de', 'fr'] as const;

export const languageCodeSchema = z.enum(SUPPORTED_LANGUAGES);

export const updateUserLanguageSchema = z.object({
  language: languageCodeSchema.nullable(),
});

export const updateOrgLanguageSchema = z.object({
  default_language: languageCodeSchema,
});

export const translationKeySchema = z.string()
  .min(1, 'Key is required')
  .max(255, 'Key too long')
  .regex(/^[a-z][a-z0-9_.]*$/, 'Key must be lowercase with dots/underscores');

export const createTranslationSchema = z.object({
  key: translationKeySchema,
  namespace: z.string().min(1).max(100).default('common'),
  en: z.string().min(1, 'English translation required'),
  pl: z.string().optional(),
  de: z.string().optional(),
  fr: z.string().optional(),
  description: z.string().optional(),
});

export const updateTranslationSchema = z.object({
  en: z.string().min(1).optional(),
  pl: z.string().nullable().optional(),
  de: z.string().nullable().optional(),
  fr: z.string().nullable().optional(),
  description: z.string().nullable().optional(),
});
```

### Next-intl Integration

**Location:** `lib/i18n/config.ts`

```typescript
import { getRequestConfig } from 'next-intl/server';

export const locales = ['en', 'pl', 'de', 'fr'] as const;
export type Locale = (typeof locales)[number];
export const defaultLocale: Locale = 'en';

export default getRequestConfig(async ({ locale }) => {
  // Fetch translations from database
  const response = await fetch(
    `${process.env.NEXT_PUBLIC_APP_URL}/api/v1/settings/translations/${locale}`,
    { next: { revalidate: 60 } } // Cache for 60 seconds
  );
  const messages = await response.json();

  return { messages };
});
```

**Location:** `lib/i18n/provider.tsx`

```typescript
'use client';

import { NextIntlClientProvider } from 'next-intl';
import { ReactNode } from 'react';

interface I18nProviderProps {
  locale: string;
  messages: Record<string, string>;
  children: ReactNode;
}

export function I18nProvider({ locale, messages, children }: I18nProviderProps) {
  return (
    <NextIntlClientProvider locale={locale} messages={messages}>
      {children}
    </NextIntlClientProvider>
  );
}
```

## UI Components

### Pages

- `app/(authenticated)/settings/language/page.tsx` - Language settings page
- `app/(authenticated)/settings/translations/page.tsx` - Admin translation management

### Components

**Location:** `components/settings/language/`

```
LanguageSwitcher.tsx       - Header dropdown for quick language switch
LanguageSelect.tsx         - Full language selection with flags
LanguageSettingsForm.tsx   - User language preference form
OrgLanguageSettings.tsx    - Admin org default language setting
```

**Location:** `components/settings/translations/`

```
TranslationsTable.tsx      - DataTable of all translation keys
TranslationEditModal.tsx   - Modal to edit translation values
TranslationCreateModal.tsx - Modal to create new key
LanguageColumnCell.tsx     - Cell showing value with fallback indicator
```

### Component Details

**LanguageSwitcher.tsx** (Header)
```tsx
interface LanguageSwitcherProps {
  currentLanguage: string;
  onLanguageChange: (lang: string) => void;
}

// Dropdown showing:
// [Flag] Polski
// [Flag] English (current)
// [Flag] Deutsch
// [Flag] Francais
```

**TranslationsTable.tsx**
```tsx
// Columns: Key | English | Polski | Deutsch | Francais | Actions
// Actions: Edit, Delete
// Features: Search by key, filter by namespace
```

## Test Cases

### Unit Tests

**language-service.test.ts**
```typescript
describe('LanguageService', () => {
  describe('isValidLanguage', () => {
    it('returns true for pl, en, de, fr');
    it('returns false for unsupported codes');
  });

  describe('getEffectiveLanguage', () => {
    it('returns user language when set');
    it('returns org default when user language is null');
    it('returns en when both are null');
  });
});
```

**translation-service.test.ts**
```typescript
describe('TranslationService', () => {
  describe('getWithFallback', () => {
    it('returns translation for requested language');
    it('returns English when translation missing');
    it('returns key when English also missing');
  });

  describe('getTranslations', () => {
    it('returns all translations for language');
    it('merges with English fallbacks');
  });
});
```

### Integration Tests

**language-api.test.ts**
```typescript
describe('Language API', () => {
  describe('PATCH /api/v1/settings/language', () => {
    it('updates user language preference');
    it('accepts null to clear preference');
    it('rejects invalid language code');
  });

  describe('GET /api/v1/settings/translations/:lang', () => {
    it('returns translations for language');
    it('includes English fallbacks');
    it('caches responses appropriately');
  });
});
```

### E2E Tests

**language-switch.spec.ts**
```typescript
describe('Language Switching', () => {
  it('displays language switcher in header');
  it('switches UI language without reload');
  it('persists language preference after logout/login');
  it('shows org default for new users');
});
```

## Seed Data

Initial translations to include:

```sql
INSERT INTO translations (key, namespace, en, pl, de, fr, description) VALUES
-- Common
('common.save', 'common', 'Save', 'Zapisz', 'Speichern', 'Enregistrer', 'Save button'),
('common.cancel', 'common', 'Cancel', 'Anuluj', 'Abbrechen', 'Annuler', 'Cancel button'),
('common.delete', 'common', 'Delete', 'Usun', 'Loschen', 'Supprimer', 'Delete button'),
('common.edit', 'common', 'Edit', 'Edytuj', 'Bearbeiten', 'Modifier', 'Edit button'),
('common.search', 'common', 'Search', 'Szukaj', 'Suchen', 'Rechercher', 'Search placeholder'),
('common.loading', 'common', 'Loading...', 'Ladowanie...', 'Laden...', 'Chargement...', 'Loading state'),

-- Settings module
('settings.title', 'settings', 'Settings', 'Ustawienia', 'Einstellungen', 'Parametres', 'Settings page title'),
('settings.language', 'settings', 'Language', 'Jezyk', 'Sprache', 'Langue', 'Language setting'),
('settings.language.description', 'settings', 'Select your preferred language', 'Wybierz preferowany jezyk', 'Wahlen Sie Ihre bevorzugte Sprache', 'Selectionnez votre langue preferee', 'Language setting description');
```

## Deliverables

- [ ] Users table extension migration (language column)
- [ ] Organizations table extension migration (default_language column)
- [ ] Translations table migration with seed data
- [ ] RLS policies for translations
- [ ] Language service (`lib/services/language-service.ts`)
- [ ] Translation service (`lib/services/translation-service.ts`)
- [ ] Zod schemas (`lib/validation/language.ts`)
- [ ] next-intl configuration and provider
- [ ] API routes for language preference
- [ ] API routes for translations
- [ ] LanguageSwitcher component (header)
- [ ] LanguageSettingsForm component
- [ ] TranslationsTable component (admin)
- [ ] TranslationEditModal component (admin)
- [ ] Language settings page
- [ ] Translations management page (admin)
- [ ] Unit tests (>80% coverage)
- [ ] Integration tests
- [ ] E2E tests

## Definition of Done

- [ ] 4 languages supported: PL, EN, DE, FR
- [ ] User can set language preference from profile/settings
- [ ] Language switcher visible in header
- [ ] Language switches dynamically without page reload
- [ ] User preference overrides org default
- [ ] Null user preference falls back to org default
- [ ] Organization default language configurable by admin
- [ ] Translations stored in database
- [ ] Missing translations fall back to English
- [ ] Admin can view/edit all translation keys
- [ ] Admin can create new translation keys
- [ ] Translation changes reflect immediately
- [ ] next-intl properly integrated with React components
- [ ] Multi-tenant isolation maintained
- [ ] Unit test coverage >= 80%
- [ ] Integration tests pass
- [ ] E2E tests pass
