# 01.20b - Multi-Language Formatting (Date/Number/Currency)

**Story ID:** 01.20b
**Epic:** 01 - Settings
**Phase:** 1B (Polish)
**Complexity:** S (Small)
**Estimate:** 1 day
**Type:** Frontend
**State:** ready

**Primary PRD:** `docs/1-BASELINE/product/modules/settings.md` (FR-SET-114, FR-SET-115, FR-SET-116)

## PRD References

| FR ID | Requirement | Priority | Phase | Covered |
|-------|-------------|----------|-------|---------|
| FR-SET-114 | Date/Time Format Localization | P1 | 1B | Yes |
| FR-SET-115 | Number Format Localization | P1 | 1B | Yes |
| FR-SET-116 | Translation Fallback | P1 | 1B | Yes |

## User Story

**As a** user in a multi-language organization,
**I want** dates, numbers, and currency to display in my locale format,
**So that** I can read and interpret data naturally without mental conversion.

## Goal

Implement locale-aware formatting utilities for dates, times, numbers, and currency. Provide translation fallback mechanism to English when translations are missing.

## Scope

**In scope:**
- Date format per locale (DD.MM.YYYY vs MM/DD/YYYY)
- Time format (24h vs 12h with AM/PM)
- Number format (comma vs period separators)
- Currency display with locale-appropriate positioning
- First day of week for date pickers (Monday vs Sunday)
- Translation fallback to English when key missing
- Dev console warning for missing translations

**Out of scope:**
- Language selection UI (covered in 01.20a)
- Translation management admin UI (Phase 2)
- Custom date/number format per user (uses locale only)
- RTL language support

## Dependencies

| Story | Requirement | Status |
|-------|-------------|--------|
| 01.20a | Multi-Language Selection | Required - provides locale context |

## Database

**No database changes required.** Uses existing fields:
- `users.language` - User locale preference
- `organizations.default_language` - Organization default locale

## Acceptance Criteria (Given/When/Then)

### Date/Time Formatting (FR-SET-114)

#### Date Format
- GIVEN locale is "en-US", WHEN date displayed, THEN format is "MM/DD/YYYY" (12/25/2025).
- GIVEN locale is "pl-PL", WHEN date displayed, THEN format is "DD.MM.YYYY" (25.12.2025).
- GIVEN locale is "de-DE", WHEN date displayed, THEN format is "DD.MM.YYYY" (25.12.2025).

#### Time Format
- GIVEN locale is "en-US", WHEN time displayed, THEN 12-hour format with AM/PM (2:30 PM).
- GIVEN locale is "pl-PL", WHEN time displayed, THEN 24-hour format (14:30).
- GIVEN locale is "de-DE", WHEN time displayed, THEN 24-hour format (14:30).

#### Date Picker Integration
- GIVEN datetime picker opened, WHEN locale is pl-PL, THEN first day of week is Monday.
- GIVEN datetime picker opened, WHEN locale is en-US, THEN first day of week is Sunday.

### Number Formatting (FR-SET-115)

#### Number Format
- GIVEN locale is "en-US", WHEN number 1234.56 displayed, THEN format is "1,234.56".
- GIVEN locale is "pl-PL", WHEN number 1234.56 displayed, THEN format is "1 234,56".
- GIVEN locale is "de-DE", WHEN number 1234.56 displayed, THEN format is "1.234,56".

#### Currency Format
- GIVEN locale is "en-US" and currency USD, WHEN amount displayed, THEN format is "$1,234.56".
- GIVEN locale is "pl-PL" and currency PLN, WHEN amount displayed, THEN format is "1 234,56 zl".
- GIVEN locale is "de-DE" and currency EUR, WHEN amount displayed, THEN format is "1.234,56 EUR".

### Translation Fallback (FR-SET-116)

#### Fallback Behavior
- GIVEN translation for key missing in Polish, WHEN UI renders in Polish, THEN English fallback displays.
- GIVEN all translations present for German, WHEN UI renders in German, THEN no English fallbacks visible.
- GIVEN translation key missing entirely, WHEN UI renders, THEN key displays as-is (e.g., "settings.new_label").

#### Developer Feedback
- GIVEN fallback used, WHEN console checked (dev mode), THEN warning "Missing translation: {key} for {locale}" logged.
- GIVEN production mode, WHEN fallback used, THEN no console warning (silent fallback).

## Technical Specification

### Frontend Utilities

**Location:** `lib/utils/formatting.ts`

```typescript
import { format, Locale } from 'date-fns';
import { enUS, pl, de, fr, es } from 'date-fns/locale';

// Locale mapping
const LOCALE_MAP: Record<string, Locale> = {
  'en-US': enUS,
  'pl-PL': pl,
  'de-DE': de,
  'fr-FR': fr,
  'es-ES': es,
};

// Date format patterns per locale
const DATE_PATTERNS: Record<string, string> = {
  'en-US': 'MM/dd/yyyy',
  'pl-PL': 'dd.MM.yyyy',
  'de-DE': 'dd.MM.yyyy',
  'fr-FR': 'dd/MM/yyyy',
  'es-ES': 'dd/MM/yyyy',
};

// Time format patterns per locale
const TIME_PATTERNS: Record<string, string> = {
  'en-US': 'h:mm a',
  'pl-PL': 'HH:mm',
  'de-DE': 'HH:mm',
  'fr-FR': 'HH:mm',
  'es-ES': 'HH:mm',
};

/**
 * Format date according to locale
 */
export function formatDate(date: Date | string, locale: string): string {
  const d = typeof date === 'string' ? new Date(date) : date;
  const pattern = DATE_PATTERNS[locale] || DATE_PATTERNS['en-US'];
  const dateLocale = LOCALE_MAP[locale] || enUS;
  return format(d, pattern, { locale: dateLocale });
}

/**
 * Format time according to locale
 */
export function formatTime(date: Date | string, locale: string): string {
  const d = typeof date === 'string' ? new Date(date) : date;
  const pattern = TIME_PATTERNS[locale] || TIME_PATTERNS['en-US'];
  const dateLocale = LOCALE_MAP[locale] || enUS;
  return format(d, pattern, { locale: dateLocale });
}

/**
 * Format datetime according to locale
 */
export function formatDateTime(date: Date | string, locale: string): string {
  return `${formatDate(date, locale)} ${formatTime(date, locale)}`;
}

/**
 * Format number according to locale
 */
export function formatNumber(
  num: number,
  locale: string,
  options?: Intl.NumberFormatOptions
): string {
  return new Intl.NumberFormat(locale, options).format(num);
}

/**
 * Format currency according to locale
 */
export function formatCurrency(
  amount: number,
  currency: string,
  locale: string
): string {
  return new Intl.NumberFormat(locale, {
    style: 'currency',
    currency: currency,
  }).format(amount);
}

/**
 * Get first day of week for locale (0=Sunday, 1=Monday)
 */
export function getFirstDayOfWeek(locale: string): 0 | 1 {
  const sundayFirst = ['en-US', 'en-CA'];
  return sundayFirst.includes(locale) ? 0 : 1;
}
```

**Location:** `lib/utils/translations.ts`

```typescript
type TranslationKey = string;
type Translations = Record<string, Record<TranslationKey, string>>;

let translations: Translations = {};

/**
 * Load translations for a locale
 */
export function loadTranslations(locale: string, data: Record<string, string>): void {
  translations[locale] = data;
}

/**
 * Get translation with fallback to English
 */
export function getTranslation(
  key: string,
  locale: string,
  params?: Record<string, string | number>
): string {
  // Try requested locale
  let value = translations[locale]?.[key];

  // Fallback to English
  if (!value && locale !== 'en-US') {
    value = translations['en-US']?.[key];
    if (value && process.env.NODE_ENV === 'development') {
      console.warn(`Missing translation: ${key} for ${locale}`);
    }
  }

  // Fallback to key itself
  if (!value) {
    if (process.env.NODE_ENV === 'development') {
      console.warn(`Missing translation key: ${key}`);
    }
    return key;
  }

  // Replace parameters
  if (params) {
    return Object.entries(params).reduce(
      (str, [k, v]) => str.replace(new RegExp(`{${k}}`, 'g'), String(v)),
      value
    );
  }

  return value;
}

/**
 * Shorthand translation function
 */
export const t = getTranslation;
```

### React Hook

**Location:** `lib/hooks/useLocale.ts`

```typescript
import { useContext, useMemo } from 'react';
import { UserContext } from '@/lib/context/user-context';
import { formatDate, formatTime, formatDateTime, formatNumber, formatCurrency, getFirstDayOfWeek } from '@/lib/utils/formatting';
import { t } from '@/lib/utils/translations';

export function useLocale() {
  const { user, organization } = useContext(UserContext);
  const locale = user?.language || organization?.default_language || 'en-US';
  const currency = organization?.currency || 'USD';

  return useMemo(() => ({
    locale,
    currency,
    formatDate: (date: Date | string) => formatDate(date, locale),
    formatTime: (date: Date | string) => formatTime(date, locale),
    formatDateTime: (date: Date | string) => formatDateTime(date, locale),
    formatNumber: (num: number, options?: Intl.NumberFormatOptions) =>
      formatNumber(num, locale, options),
    formatCurrency: (amount: number, cur?: string) =>
      formatCurrency(amount, cur || currency, locale),
    firstDayOfWeek: getFirstDayOfWeek(locale),
    t: (key: string, params?: Record<string, string | number>) =>
      t(key, locale, params),
  }), [locale, currency]);
}
```

### Usage Examples

```tsx
// In any component
function ProductionStats() {
  const { formatDate, formatNumber, formatCurrency, t } = useLocale();

  return (
    <div>
      <h2>{t('production.stats.title')}</h2>
      <p>{t('production.stats.date_label')}: {formatDate(new Date())}</p>
      <p>{t('production.stats.units')}: {formatNumber(1234.56)}</p>
      <p>{t('production.stats.cost')}: {formatCurrency(1234.56)}</p>
    </div>
  );
}
```

## Test Cases

### Unit Tests

**formatting.test.ts**
```typescript
describe('formatDate', () => {
  const testDate = new Date(2025, 11, 25); // Dec 25, 2025

  it('formats en-US as MM/DD/YYYY', () => {
    expect(formatDate(testDate, 'en-US')).toBe('12/25/2025');
  });

  it('formats pl-PL as DD.MM.YYYY', () => {
    expect(formatDate(testDate, 'pl-PL')).toBe('25.12.2025');
  });

  it('formats de-DE as DD.MM.YYYY', () => {
    expect(formatDate(testDate, 'de-DE')).toBe('25.12.2025');
  });
});

describe('formatTime', () => {
  const testTime = new Date(2025, 0, 1, 14, 30);

  it('formats en-US as 12h with AM/PM', () => {
    expect(formatTime(testTime, 'en-US')).toBe('2:30 PM');
  });

  it('formats pl-PL as 24h', () => {
    expect(formatTime(testTime, 'pl-PL')).toBe('14:30');
  });
});

describe('formatNumber', () => {
  it('formats en-US with comma thousands', () => {
    expect(formatNumber(1234.56, 'en-US')).toBe('1,234.56');
  });

  it('formats pl-PL with space thousands and comma decimal', () => {
    expect(formatNumber(1234.56, 'pl-PL')).toMatch(/1\s234,56/);
  });

  it('formats de-DE with period thousands and comma decimal', () => {
    expect(formatNumber(1234.56, 'de-DE')).toBe('1.234,56');
  });
});

describe('formatCurrency', () => {
  it('formats USD in en-US locale', () => {
    expect(formatCurrency(1234.56, 'USD', 'en-US')).toBe('$1,234.56');
  });

  it('formats PLN in pl-PL locale', () => {
    const result = formatCurrency(1234.56, 'PLN', 'pl-PL');
    expect(result).toContain('1');
    expect(result).toContain('234');
    expect(result).toMatch(/zl|PLN/i);
  });
});

describe('getFirstDayOfWeek', () => {
  it('returns Sunday (0) for en-US', () => {
    expect(getFirstDayOfWeek('en-US')).toBe(0);
  });

  it('returns Monday (1) for pl-PL', () => {
    expect(getFirstDayOfWeek('pl-PL')).toBe(1);
  });
});
```

**translations.test.ts**
```typescript
describe('getTranslation', () => {
  beforeEach(() => {
    loadTranslations('en-US', { 'greeting': 'Hello' });
    loadTranslations('pl-PL', { 'greeting': 'Czesc' });
  });

  it('returns translation for locale', () => {
    expect(t('greeting', 'pl-PL')).toBe('Czesc');
  });

  it('falls back to English when missing', () => {
    expect(t('greeting', 'de-DE')).toBe('Hello');
  });

  it('returns key when translation missing entirely', () => {
    expect(t('unknown.key', 'en-US')).toBe('unknown.key');
  });

  it('replaces parameters in translation', () => {
    loadTranslations('en-US', { 'welcome': 'Hello, {name}!' });
    expect(t('welcome', 'en-US', { name: 'John' })).toBe('Hello, John!');
  });
});
```

## Deliverables

- [ ] Formatting utilities (`lib/utils/formatting.ts`)
- [ ] Translation utilities (`lib/utils/translations.ts`)
- [ ] useLocale hook (`lib/hooks/useLocale.ts`)
- [ ] Unit tests for formatting functions
- [ ] Unit tests for translation fallback

## Definition of Done

- [ ] Date formatting works for en-US, pl-PL, de-DE locales
- [ ] Time formatting uses 12h/24h based on locale
- [ ] Number formatting uses correct separators per locale
- [ ] Currency formatting positions symbol correctly per locale
- [ ] First day of week returns correct value per locale
- [ ] Translation fallback to English works when key missing
- [ ] Dev console warns on missing translations (dev mode only)
- [ ] Missing key returns key as-is (production safe)
- [ ] useLocale hook provides all formatting functions
- [ ] Unit test coverage >= 90%
