# 01.16 - User Invitations (Email)

**Story ID:** 01.16
**Epic:** 01 - Settings
**Phase:** 1A (MVP)
**Priority:** P0
**Complexity:** M (Medium)
**Estimate:** 2-3 days
**Type:** Backend + Frontend

**State:** ready
**Primary PRD:** `docs/1-BASELINE/product/modules/settings.md` (FR-SET-012)

---

## PRD References

| FR ID | Description | Priority | Phase | Status |
|-------|-------------|----------|-------|--------|
| FR-SET-012 | User invitations (email) | P0 | 1A | This Story |

---

## User Story

As an **Administrator**, I want to **invite new users via email** so that **they can join my organization, set their password, and start using the system without manual account creation**.

---

## Goal

Implement a complete user invitation flow including email delivery, invitation management, and account activation. This enables administrators to onboard new team members securely by sending invitation links that expire after 7 days.

---

## Scope

**In scope**
- Send invitation emails with secure tokens
- Invitation management (list, resend, cancel/revoke)
- Public accept-invitation page with password setup
- Invitation expiry handling (7 days)
- Duplicate email validation
- Email service integration (Resend recommended)

**Out of scope**
- Bulk invitations (Phase 3)
- Custom email templates (Phase 2)
- SSO/SAML integration
- Invitation analytics/tracking
- Custom expiry periods per invitation

---

## Dependencies

| Story | Dependency Type | Description |
|-------|-----------------|-------------|
| **01.1** | Required | Org context + RLS (tenant isolation for invitations) |
| **01.5a** | Required | Users CRUD (user table, role assignment patterns) |
| **01.6** | Required | Role permissions (role dropdown for invitation) |

---

## Acceptance Criteria (Gherkin)

### AC-1: Send Invitation

```gherkin
Given admin is on the Users page
When admin clicks "Invite User"
Then an invitation modal displays with email and role fields

Given admin enters email "new@company.com" and selects role "PROD_OPERATOR"
When "Send Invitation" is clicked
Then invitation email is sent within 5 seconds
And success toast displays "Invitation sent to new@company.com"
And invitation appears in pending invitations list
```

### AC-2: Email Content

```gherkin
Given invitation is sent to "john@company.com"
When email is delivered
Then subject is "You're invited to join [Organization Name] on MonoPilot"
And body contains organization name
And body contains inviter's name
And body contains assigned role name
And body contains activation link
And body contains expiry notice (7 days)
And link format is "https://app.monopilot.io/invite/{token}"
```

### AC-3: Accept Invitation

```gherkin
Given recipient receives invitation email
When recipient clicks the activation link
Then password setup page displays
And organization name is shown
And assigned role is shown
And email field is pre-filled and readonly

Given recipient is on password setup page
When valid password is entered (min 8 chars, 1 upper, 1 number)
Then "Create Account" button enables

Given recipient submits valid password
When form is submitted
Then account is activated
And user is logged in automatically
And redirect to dashboard occurs
And welcome toast displays "Welcome to [Organization Name]!"
```

### AC-4: Invitation Expiry

```gherkin
Given invitation link is older than 7 days
When recipient clicks the link
Then error page displays "This invitation has expired"
And "Request New Invitation" button is shown
And contact admin message displays

Given invitation is 6 days old
When recipient clicks the link
Then password setup page displays normally
And warning banner shows "This invitation expires in 1 day"
```

### AC-5: View Pending Invitations

```gherkin
Given admin navigates to Users page
When "Pending Invitations" tab is clicked
Then pending invitations list displays
And each invitation shows: email, role, sent date, expires date, status

Given 5 pending invitations exist
When list loads
Then all 5 invitations display with correct data
And invitations are sorted by sent date (newest first)
```

### AC-6: Resend Invitation

```gherkin
Given pending invitation exists for "test@company.com"
When admin clicks "Resend" button
Then confirmation dialog appears

Given admin confirms resend
When action completes
Then new invitation email is sent
And expiry is reset to 7 days from now
And success toast displays "Invitation resent to test@company.com"
And sent date updates in list
```

### AC-7: Cancel Invitation

```gherkin
Given pending invitation exists for "cancel@company.com"
When admin clicks "Cancel" button
Then confirmation dialog appears with warning

Given admin confirms cancel
When action completes
Then invitation is invalidated
And invitation removed from pending list
And success toast displays "Invitation cancelled"

Given cancelled invitation token
When recipient clicks old link
Then error page displays "This invitation is no longer valid"
```

### AC-8: Duplicate Email Handling

```gherkin
Given user "existing@company.com" already has an active account
When admin attempts to invite "existing@company.com"
Then error displays "User with this email already exists"
And invitation is not sent

Given pending invitation exists for "pending@company.com"
When admin attempts to invite "pending@company.com" again
Then error displays "An invitation is already pending for this email"
And option to resend existing invitation is shown
```

### AC-9: Permission Enforcement

```gherkin
Given user with VIEWER role
When accessing invite functionality
Then "Invite User" button is hidden

Given user with ADMIN role
When inviting user with SUPER_ADMIN role
Then error displays "Only Super Admin can invite Super Admin"
And invitation is not sent

Given user with SUPER_ADMIN role
When inviting user with any role
Then invitation succeeds
```

---

## Technical Specification

### Database Schema

```sql
-- User Invitations table
CREATE TABLE user_invitations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id),
  email VARCHAR(255) NOT NULL,
  role_id UUID NOT NULL REFERENCES roles(id),
  token VARCHAR(64) UNIQUE NOT NULL,
  expires_at TIMESTAMPTZ NOT NULL,
  invited_by UUID NOT NULL REFERENCES users(id),
  status VARCHAR(20) NOT NULL DEFAULT 'pending',
  -- Status: 'pending', 'accepted', 'expired', 'cancelled'
  accepted_at TIMESTAMPTZ,
  cancelled_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),

  UNIQUE(org_id, email, status), -- Only one pending invitation per email per org

  CONSTRAINT valid_status CHECK (status IN ('pending', 'accepted', 'expired', 'cancelled'))
);

-- Index for token lookups (public endpoint)
CREATE INDEX idx_user_invitations_token ON user_invitations(token) WHERE status = 'pending';

-- Index for org listing
CREATE INDEX idx_user_invitations_org_status ON user_invitations(org_id, status);

-- RLS Policy
ALTER TABLE user_invitations ENABLE ROW LEVEL SECURITY;

CREATE POLICY "invitations_org_isolation" ON user_invitations
FOR SELECT USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

CREATE POLICY "invitations_admin_write" ON user_invitations
FOR ALL USING (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  AND (SELECT r.code FROM roles r JOIN users u ON u.role_id = r.id WHERE u.id = auth.uid()) IN ('SUPER_ADMIN', 'ADMIN')
);
```

### API Endpoints

```typescript
// POST /api/v1/settings/users/invite
// Send new invitation
interface InviteUserRequest {
  email: string;
  role_id: string; // UUID
}

interface InviteUserResponse {
  invitation_id: string;
  email: string;
  expires_at: string; // ISO date
}

// GET /api/v1/settings/users/invitations
// List pending invitations
interface ListInvitationsResponse {
  invitations: Invitation[];
  total: number;
}

interface Invitation {
  id: string;
  email: string;
  role_id: string;
  role_name: string;
  status: 'pending' | 'accepted' | 'expired' | 'cancelled';
  invited_by_name: string;
  expires_at: string;
  created_at: string;
}

// POST /api/v1/settings/users/invitations/:id/resend
// Resend invitation (resets expiry)
interface ResendInvitationResponse {
  invitation_id: string;
  new_expires_at: string;
}

// DELETE /api/v1/settings/users/invitations/:id
// Cancel/revoke invitation
// Returns 204 No Content

// POST /api/auth/accept-invitation (PUBLIC - no auth required)
// Accept invitation and create account
interface AcceptInvitationRequest {
  token: string;
  password: string;
}

interface AcceptInvitationResponse {
  user_id: string;
  access_token: string;
  org_name: string;
}

// GET /api/auth/invitation/:token (PUBLIC - no auth required)
// Get invitation details for accept page
interface GetInvitationResponse {
  email: string;
  role_name: string;
  org_name: string;
  expires_at: string;
  is_expired: boolean;
}
```

### Service Layer

```typescript
// lib/services/invitation-service.ts
export class InvitationService {
  // Create and send invitation
  async createInvitation(
    orgId: string,
    invitedBy: string,
    data: { email: string; role_id: string }
  ): Promise<Invitation>;

  // List invitations for org
  async listInvitations(
    orgId: string,
    status?: 'pending' | 'all'
  ): Promise<Invitation[]>;

  // Resend invitation (reset token and expiry)
  async resendInvitation(
    invitationId: string,
    orgId: string
  ): Promise<Invitation>;

  // Cancel invitation
  async cancelInvitation(
    invitationId: string,
    orgId: string
  ): Promise<void>;

  // Get invitation by token (public)
  async getInvitationByToken(
    token: string
  ): Promise<InvitationDetails | null>;

  // Accept invitation and create user
  async acceptInvitation(
    token: string,
    password: string
  ): Promise<{ user: User; accessToken: string }>;

  // Validate email not already in use
  async validateEmail(
    orgId: string,
    email: string
  ): Promise<{ valid: boolean; reason?: string }>;

  // Expire old invitations (cron job)
  async expireOldInvitations(): Promise<number>;

  // Generate secure token
  private generateToken(): string;
}
```

### Email Service Integration

```typescript
// lib/services/email-service.ts
import { Resend } from 'resend';

export class EmailService {
  private resend: Resend;

  constructor() {
    this.resend = new Resend(process.env.RESEND_API_KEY);
  }

  async sendInvitationEmail(params: {
    to: string;
    orgName: string;
    inviterName: string;
    roleName: string;
    inviteUrl: string;
    expiresAt: Date;
  }): Promise<{ success: boolean; messageId?: string }>;
}

// Email template
const INVITATION_EMAIL_TEMPLATE = `
Subject: You're invited to join {{orgName}} on MonoPilot

Hi there,

{{inviterName}} has invited you to join {{orgName}} on MonoPilot as a {{roleName}}.

Click the button below to set up your account:

[Accept Invitation]({{inviteUrl}})

This invitation will expire on {{expiryDate}}.

If you didn't expect this invitation, you can safely ignore this email.

Best regards,
The MonoPilot Team
`;
```

### Validation Schemas

```typescript
// lib/validation/invitation-schemas.ts
import { z } from 'zod';

export const inviteUserSchema = z.object({
  email: z
    .string()
    .email('Invalid email format')
    .max(255, 'Email too long'),
  role_id: z
    .string()
    .uuid('Invalid role ID'),
});

export const acceptInvitationSchema = z.object({
  token: z
    .string()
    .length(64, 'Invalid invitation token'),
  password: z
    .string()
    .min(8, 'Password must be at least 8 characters')
    .regex(/[A-Z]/, 'Password must contain at least one uppercase letter')
    .regex(/[0-9]/, 'Password must contain at least one number'),
});
```

---

## UI Components

### Frontend Structure

```
app/(authenticated)/settings/users/
  page.tsx                          -- Add "Pending Invitations" tab

components/settings/users/
  InviteUserModal.tsx               -- Email + role selection modal
  PendingInvitationsTable.tsx       -- List of pending invitations
  InvitationRow.tsx                 -- Single invitation row
  InvitationStatusBadge.tsx         -- Status indicator
  ResendConfirmDialog.tsx           -- Resend confirmation
  CancelInvitationDialog.tsx        -- Cancel confirmation

app/(public)/invite/[token]/
  page.tsx                          -- Accept invitation page

components/auth/
  AcceptInvitationForm.tsx          -- Password setup form
  InvitationExpiredPage.tsx         -- Expired/invalid invitation
```

### Component Specifications

**InviteUserModal.tsx**
- Email input with validation
- Role dropdown (from 01.6)
- Super Admin role disabled for non-Super Admin
- Loading state during send
- Error display inline

**PendingInvitationsTable.tsx**
- Columns: Email, Role, Invited By, Sent Date, Expires, Actions
- Actions: Resend, Cancel
- Empty state: "No pending invitations"
- Sort by sent date (newest first)

**AcceptInvitationPage.tsx** (Public)
- Display org name and role
- Email field (readonly, pre-filled)
- Password field with requirements indicator
- Confirm password field
- Submit button
- Link to login if already have account

---

## Out of Scope

| Feature | Phase | Reason |
|---------|-------|--------|
| Bulk invitations (CSV upload) | Phase 3 | Complexity, rare use case for MVP |
| Custom email templates | Phase 2 | Hardcoded template sufficient for MVP |
| Invitation analytics | Phase 3 | Nice-to-have, not essential |
| Custom expiry periods | Phase 2 | 7 days is reasonable default |
| SSO/SAML invitation flow | Phase 2 | Separate authentication story |

---

## Test Cases

### Unit Tests

```typescript
describe('InvitationService', () => {
  describe('createInvitation', () => {
    it('creates invitation with valid data');
    it('generates unique 64-char token');
    it('sets expiry to 7 days from now');
    it('rejects duplicate pending invitation for same email');
    it('rejects invitation for existing user email');
    it('rejects Super Admin role for non-Super Admin inviter');
  });

  describe('acceptInvitation', () => {
    it('creates user with correct role');
    it('marks invitation as accepted');
    it('returns valid access token');
    it('rejects expired invitation');
    it('rejects cancelled invitation');
    it('rejects invalid token');
  });

  describe('resendInvitation', () => {
    it('generates new token');
    it('resets expiry to 7 days');
    it('sends new email');
    it('rejects non-pending invitation');
  });
});
```

### Integration Tests

```typescript
describe('Invitation API', () => {
  it('POST /invite - creates and sends invitation');
  it('POST /invite - returns 400 for duplicate email');
  it('POST /invite - returns 403 for non-admin');
  it('GET /invitations - returns org invitations only');
  it('POST /invitations/:id/resend - resets invitation');
  it('DELETE /invitations/:id - cancels invitation');
  it('POST /auth/accept-invitation - creates user');
  it('POST /auth/accept-invitation - returns 400 for expired');
});
```

### E2E Tests

```typescript
describe('User Invitation Flow', () => {
  it('admin can invite user and user can accept');
  it('expired invitation shows error page');
  it('resent invitation works with new link');
  it('cancelled invitation shows invalid page');
});
```

---

## Definition of Done

- [ ] `user_invitations` table created with RLS policies
- [ ] Email service integrated (Resend)
- [ ] POST /api/v1/settings/users/invite works end-to-end
- [ ] GET /api/v1/settings/users/invitations returns org invitations
- [ ] POST /api/v1/settings/users/invitations/:id/resend resets expiry
- [ ] DELETE /api/v1/settings/users/invitations/:id cancels invitation
- [ ] POST /api/auth/accept-invitation creates user and logs in
- [ ] GET /api/auth/invitation/:token returns invitation details
- [ ] InviteUserModal implemented with role selection
- [ ] PendingInvitationsTable implemented with actions
- [ ] AcceptInvitationPage implemented (public route)
- [ ] Email template sends correctly with all required fields
- [ ] Duplicate email validation works
- [ ] Expiry handling works (7 days)
- [ ] Super Admin invitation restricted to Super Admins
- [ ] Unit tests pass (>80% coverage)
- [ ] Integration tests pass
- [ ] E2E test for full invitation flow passes

---

## Implementation Notes

### Email Service Selection

**Recommended: Resend**
- Simple API, good DX
- Free tier: 3,000 emails/month
- Easy setup with React Email templates
- Good deliverability

**Alternative: SendGrid, AWS SES**
- If already using in infrastructure

### Token Generation

```typescript
import { randomBytes } from 'crypto';

function generateInvitationToken(): string {
  return randomBytes(32).toString('hex'); // 64 chars
}
```

### Environment Variables

```env
RESEND_API_KEY=re_xxxxx
INVITATION_BASE_URL=https://app.monopilot.io/invite
INVITATION_EXPIRY_DAYS=7
```

### Cron Job for Expiry

```typescript
// Run daily to mark expired invitations
// Can be Supabase Edge Function or external cron
async function expireInvitations() {
  await supabase
    .from('user_invitations')
    .update({ status: 'expired' })
    .eq('status', 'pending')
    .lt('expires_at', new Date().toISOString());
}
```

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-12-16 | Initial story creation | ARCHITECT-AGENT |
