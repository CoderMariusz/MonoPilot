# 01.24b - Billing & Usage Tracking

**Story ID:** 01.24b
**Epic:** 01 - Settings
**Phase:** 3 (Enterprise)
**Complexity:** M (Medium)
**Estimate:** 1-2 days
**Type:** Backend + Frontend
**State:** ready

**Primary PRD:** `docs/1-BASELINE/product/modules/settings.md` (FR-SET-104, FR-SET-105, FR-SET-106)

## PRD References

| FR ID | Requirement | Priority | Phase | Covered |
|-------|-------------|----------|-------|---------|
| FR-SET-104 | Invoice History | P1 | 3 | Yes |
| FR-SET-105 | Usage Metrics Tracking | P2 | 3 | Yes |
| FR-SET-106 | Subscription Upgrade/Downgrade | P1 | 3 | Yes |

## User Story

**As a** billing administrator,
**I want** to view invoice history, track usage metrics, and manage subscription changes,
**So that** I can monitor costs, understand usage patterns, and adjust our plan as needed.

**As an** organization owner,
**I want** to see clear usage data and prorated billing for plan changes,
**So that** I can make informed decisions about subscription upgrades or downgrades.

## Goal

Extend the subscription management system with invoice history retrieval from Stripe, usage metrics tracking (active users, API calls, storage), and prorated upgrade/downgrade functionality. Provide clear visibility into billing and consumption patterns.

## Scope

**In scope:**
- Invoice history list with pagination
- Invoice detail view with line items
- PDF download from Stripe
- Usage metrics dashboard: active users, API calls, storage
- Usage trends (daily/weekly/monthly aggregation)
- Prorated upgrade flow (immediate billing)
- Prorated downgrade flow (credit for next cycle)
- Usage alerts/thresholds (optional)

**Out of scope:**
- Stripe webhook processing (handled in 01.24a)
- Payment method management (handled in 01.24a)
- Custom invoicing (uses Stripe invoicing)
- Detailed per-endpoint API analytics

## Dependencies

| Story | Requirement | Status |
|-------|-------------|--------|
| 01.24a | Subscription Core (Stripe integration, subscriptions table) | Required |

## Acceptance Criteria (Given/When/Then)

### Invoice History (FR-SET-104)

#### List Invoices
- GIVEN admin navigates to `/settings/billing/invoices`, WHEN page loads, THEN invoice list displays within 500ms.
- GIVEN org has 50 invoices, WHEN list loads, THEN paginated with 10 per page and pagination controls visible.
- GIVEN invoice list displayed, WHEN rendered, THEN each row shows: invoice number, date, amount, status, download link.
- GIVEN invoice status is "paid", WHEN displayed, THEN shows green "Paid" badge.
- GIVEN invoice status is "open", WHEN displayed, THEN shows yellow "Pending" badge with due date.

#### Invoice Details
- GIVEN admin clicks invoice row, WHEN detail loads, THEN shows line items, subtotal, tax, and total.
- GIVEN invoice has multiple line items, WHEN displayed, THEN each item shows description, quantity, unit price, amount.
- GIVEN invoice is paid, WHEN detail viewed, THEN shows payment date and method used.

#### PDF Download
- GIVEN invoice displayed, WHEN admin clicks "Download PDF", THEN PDF downloads from Stripe within 2 seconds.
- GIVEN Stripe PDF URL valid, WHEN download clicked, THEN browser initiates download directly.
- GIVEN Stripe PDF URL expired, WHEN download clicked, THEN new URL fetched and download proceeds.

### Usage Metrics (FR-SET-105)

#### Active Users Metric
- GIVEN admin views usage dashboard, WHEN loaded, THEN current active user count displays.
- GIVEN subscription has 10-seat limit, WHEN 8 users active, THEN shows "8 / 10 seats used".
- GIVEN user inactive for 30+ days, WHEN count calculated, THEN user excluded from active count.
- GIVEN usage at 90% of limit, WHEN dashboard loaded, THEN warning indicator displays.

#### API Calls Metric
- GIVEN API call made, WHEN request completes, THEN call count incremented for org.
- GIVEN usage dashboard loaded, WHEN API section viewed, THEN shows calls this billing period.
- GIVEN plan includes 10,000 API calls, WHEN 8,500 used, THEN shows "8,500 / 10,000 calls".
- GIVEN API calls at 100%, WHEN additional call made, THEN request succeeds but overage logged.

#### Storage Metric
- GIVEN files uploaded (attachments, exports), WHEN storage calculated, THEN total MB displayed.
- GIVEN plan includes 5GB storage, WHEN 4.2GB used, THEN shows "4.2 / 5.0 GB".
- GIVEN storage at 95%, WHEN dashboard loaded, THEN warning "Storage almost full" displays.

#### Usage Trends
- GIVEN admin clicks "View Trends", WHEN chart loads, THEN shows 30-day usage history.
- GIVEN daily usage data exists, WHEN weekly view selected, THEN data aggregated by week.
- GIVEN usage spike occurred, WHEN trend viewed, THEN spike clearly visible in chart.

### Subscription Upgrade/Downgrade (FR-SET-106)

#### Prorated Upgrade
- GIVEN org on "Starter" plan, WHEN admin clicks "Upgrade to Professional", THEN upgrade modal shows prorated amount.
- GIVEN 15 days remaining in billing cycle, WHEN upgrade calculated, THEN shows prorated charge for remaining days.
- GIVEN upgrade confirmed, WHEN Stripe processes, THEN immediate charge for prorated amount.
- GIVEN upgrade successful, WHEN complete, THEN new plan features active immediately.
- GIVEN upgrade successful, WHEN subscription checked, THEN next renewal uses new plan price.

#### Prorated Downgrade
- GIVEN org on "Enterprise" plan, WHEN admin clicks "Downgrade to Professional", THEN downgrade modal shows credit amount.
- GIVEN 20 days remaining in billing cycle, WHEN downgrade calculated, THEN shows credit applied to next invoice.
- GIVEN downgrade confirmed, WHEN processed, THEN current plan remains until period end.
- GIVEN downgrade scheduled, WHEN dashboard viewed, THEN shows "Downgrade scheduled for [date]".
- GIVEN period ends, WHEN renewal processes, THEN new lower plan activates with credit applied.

#### Upgrade/Downgrade Validation
- GIVEN org has 15 active users, WHEN downgrading to 10-seat plan, THEN error "Reduce active users to 10 or fewer first".
- GIVEN org uses 8GB storage, WHEN downgrading to 5GB plan, THEN error "Reduce storage usage first".
- GIVEN pending downgrade exists, WHEN upgrade attempted, THEN pending downgrade cancelled and upgrade proceeds.

### Multi-tenancy
- GIVEN User A from Org A, WHEN viewing invoices, THEN only Org A invoices returned.
- GIVEN User A from Org A, WHEN viewing usage, THEN only Org A metrics displayed.

## Technical Specification

### Database Schema

#### invoices table

```sql
CREATE TABLE invoices (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,

  -- Stripe reference
  stripe_invoice_id VARCHAR(100) UNIQUE NOT NULL,
  stripe_customer_id VARCHAR(100) NOT NULL,

  -- Invoice details
  invoice_number VARCHAR(50),
  amount_cents BIGINT NOT NULL,
  amount_due_cents BIGINT NOT NULL DEFAULT 0,
  currency VARCHAR(3) DEFAULT 'USD',
  status VARCHAR(20) NOT NULL DEFAULT 'draft', -- 'draft', 'open', 'paid', 'void', 'uncollectible'

  -- Dates
  period_start TIMESTAMPTZ,
  period_end TIMESTAMPTZ,
  due_date DATE,
  paid_at TIMESTAMPTZ,

  -- PDF
  invoice_pdf_url VARCHAR(500),
  hosted_invoice_url VARCHAR(500),

  -- Timestamps
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Indexes
CREATE INDEX idx_invoices_org_id ON invoices(org_id);
CREATE INDEX idx_invoices_stripe_id ON invoices(stripe_invoice_id);
CREATE INDEX idx_invoices_status ON invoices(status);
CREATE INDEX idx_invoices_created ON invoices(created_at DESC);
```

#### usage_metrics table

```sql
CREATE TABLE usage_metrics (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,

  -- Metric identification
  metric_type VARCHAR(50) NOT NULL, -- 'active_users', 'api_calls', 'storage_mb'

  -- Values
  value BIGINT NOT NULL,
  limit_value BIGINT, -- Plan limit for this metric (null = unlimited)

  -- Time period
  period_start DATE NOT NULL,
  period_end DATE NOT NULL,

  -- Timestamps
  recorded_at TIMESTAMPTZ DEFAULT NOW(),

  CONSTRAINT usage_metrics_unique UNIQUE (org_id, metric_type, period_start)
);

-- Indexes
CREATE INDEX idx_usage_metrics_org_id ON usage_metrics(org_id);
CREATE INDEX idx_usage_metrics_type ON usage_metrics(metric_type);
CREATE INDEX idx_usage_metrics_period ON usage_metrics(period_start, period_end);
```

#### usage_daily table (for trends)

```sql
CREATE TABLE usage_daily (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,

  -- Date
  date DATE NOT NULL,

  -- Metrics snapshot
  active_users INTEGER NOT NULL DEFAULT 0,
  api_calls INTEGER NOT NULL DEFAULT 0,
  storage_mb INTEGER NOT NULL DEFAULT 0,

  -- Timestamps
  created_at TIMESTAMPTZ DEFAULT NOW(),

  CONSTRAINT usage_daily_unique UNIQUE (org_id, date)
);

-- Indexes
CREATE INDEX idx_usage_daily_org_date ON usage_daily(org_id, date DESC);
```

### RLS Policies

```sql
-- invoices: Only org admins can view
CREATE POLICY "invoices_org_read" ON invoices
FOR SELECT USING (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  AND (SELECT r.code FROM roles r JOIN users u ON u.role_id = r.id WHERE u.id = auth.uid()) IN ('SUPER_ADMIN', 'ADMIN')
);

-- usage_metrics: Only org admins can view
CREATE POLICY "usage_metrics_org_read" ON usage_metrics
FOR SELECT USING (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  AND (SELECT r.code FROM roles r JOIN users u ON u.role_id = r.id WHERE u.id = auth.uid()) IN ('SUPER_ADMIN', 'ADMIN')
);

-- usage_daily: Only org admins can view
CREATE POLICY "usage_daily_org_read" ON usage_daily
FOR SELECT USING (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  AND (SELECT r.code FROM roles r JOIN users u ON u.role_id = r.id WHERE u.id = auth.uid()) IN ('SUPER_ADMIN', 'ADMIN')
);
```

### API Endpoints

```
# Invoice Management
GET    /api/v1/settings/invoices                    - List org invoices (paginated)
GET    /api/v1/settings/invoices/:id                - Get invoice details
GET    /api/v1/settings/invoices/:id/pdf            - Get fresh PDF download URL

# Usage Metrics
GET    /api/v1/settings/subscription/usage          - Current usage summary
GET    /api/v1/settings/subscription/usage/trends   - Usage trends (daily/weekly)

# Upgrade/Downgrade
POST   /api/v1/settings/subscription/upgrade        - Upgrade subscription (prorated)
POST   /api/v1/settings/subscription/downgrade      - Downgrade subscription (scheduled)
DELETE /api/v1/settings/subscription/downgrade      - Cancel pending downgrade
```

### Service Methods

**Location:** `lib/services/invoice-service.ts`

```typescript
interface InvoiceService {
  // List and retrieve
  getInvoices(orgId: string, page: number, limit: number): Promise<PaginatedResult<Invoice>>;
  getInvoice(orgId: string, invoiceId: string): Promise<Invoice | null>;

  // PDF
  getInvoicePdfUrl(orgId: string, invoiceId: string): Promise<string>;

  // Sync from Stripe
  syncInvoicesFromStripe(orgId: string, stripeCustomerId: string): Promise<number>;
  upsertFromStripeInvoice(stripeInvoice: Stripe.Invoice): Promise<Invoice>;
}

interface Invoice {
  id: string;
  org_id: string;
  stripe_invoice_id: string;
  invoice_number: string;
  amount_cents: number;
  currency: string;
  status: 'draft' | 'open' | 'paid' | 'void' | 'uncollectible';
  period_start: string;
  period_end: string;
  due_date: string | null;
  paid_at: string | null;
  invoice_pdf_url: string | null;
  created_at: string;
}
```

**Location:** `lib/services/usage-service.ts`

```typescript
interface UsageService {
  // Current usage
  getCurrentUsage(orgId: string): Promise<UsageSummary>;

  // Trends
  getUsageTrends(orgId: string, days: number): Promise<UsageTrend[]>;

  // Recording (called by system/cron)
  recordDailyUsage(orgId: string): Promise<void>;
  incrementApiCalls(orgId: string, count: number): Promise<void>;
  updateStorageUsage(orgId: string, totalMb: number): Promise<void>;

  // Validation for plan changes
  validateDowngrade(orgId: string, newPlanId: string): Promise<DowngradeValidation>;
}

interface UsageSummary {
  active_users: { current: number; limit: number | null; percentage: number };
  api_calls: { current: number; limit: number | null; percentage: number };
  storage_mb: { current: number; limit: number | null; percentage: number };
  billing_period: { start: string; end: string };
}

interface UsageTrend {
  date: string;
  active_users: number;
  api_calls: number;
  storage_mb: number;
}

interface DowngradeValidation {
  allowed: boolean;
  blockers: Array<{ metric: string; current: number; limit: number; message: string }>;
}
```

**Location:** `lib/services/subscription-service.ts` (extend from 01.24a)

```typescript
// Add to existing SubscriptionService
interface SubscriptionServiceExtension {
  // Upgrade/Downgrade
  upgradeSubscription(orgId: string, newPlanId: string): Promise<UpgradeResult>;
  downgradeSubscription(orgId: string, newPlanId: string): Promise<DowngradeResult>;
  cancelPendingDowngrade(orgId: string): Promise<void>;

  // Proration calculation
  calculateUpgradeProration(orgId: string, newPlanId: string): Promise<ProrationPreview>;
  calculateDowngradeCredit(orgId: string, newPlanId: string): Promise<CreditPreview>;
}

interface UpgradeResult {
  success: boolean;
  prorated_amount_cents: number;
  new_plan: string;
  effective_immediately: boolean;
}

interface DowngradeResult {
  success: boolean;
  credit_amount_cents: number;
  new_plan: string;
  effective_date: string;
}

interface ProrationPreview {
  current_plan: string;
  new_plan: string;
  days_remaining: number;
  prorated_charge_cents: number;
  new_monthly_amount_cents: number;
}
```

### Zod Validation Schemas

**Location:** `lib/validation/invoice.ts`

```typescript
import { z } from 'zod';

export const invoiceSchema = z.object({
  id: z.string().uuid(),
  org_id: z.string().uuid(),
  stripe_invoice_id: z.string(),
  invoice_number: z.string().nullable(),
  amount_cents: z.number().int(),
  currency: z.string().length(3),
  status: z.enum(['draft', 'open', 'paid', 'void', 'uncollectible']),
  period_start: z.string().datetime().nullable(),
  period_end: z.string().datetime().nullable(),
  due_date: z.string().nullable(),
  paid_at: z.string().datetime().nullable(),
  invoice_pdf_url: z.string().url().nullable(),
  created_at: z.string().datetime(),
});

export const invoicesListSchema = z.object({
  invoices: z.array(invoiceSchema),
  pagination: z.object({
    page: z.number().int().positive(),
    limit: z.number().int().positive(),
    total: z.number().int().nonnegative(),
    total_pages: z.number().int().nonnegative(),
  }),
});
```

**Location:** `lib/validation/usage.ts`

```typescript
import { z } from 'zod';

export const usageMetricSchema = z.object({
  current: z.number().int().nonnegative(),
  limit: z.number().int().positive().nullable(),
  percentage: z.number().min(0).max(100),
});

export const usageSummarySchema = z.object({
  active_users: usageMetricSchema,
  api_calls: usageMetricSchema,
  storage_mb: usageMetricSchema,
  billing_period: z.object({
    start: z.string().datetime(),
    end: z.string().datetime(),
  }),
});

export const usageTrendSchema = z.object({
  date: z.string(),
  active_users: z.number().int().nonnegative(),
  api_calls: z.number().int().nonnegative(),
  storage_mb: z.number().int().nonnegative(),
});

export const usageTrendsQuerySchema = z.object({
  days: z.coerce.number().int().min(7).max(90).default(30),
});
```

## UI Components

### Pages

- `app/(authenticated)/settings/billing/invoices/page.tsx` - Invoice history list
- `app/(authenticated)/settings/billing/usage/page.tsx` - Usage dashboard

### Components

**Location:** `components/settings/billing/`

```
InvoicesList.tsx           - Paginated invoice table
InvoiceRow.tsx             - Single invoice row with status badge
InvoiceDetailModal.tsx     - Invoice detail with line items
UsageDashboard.tsx         - Usage metrics overview
UsageMetricCard.tsx        - Individual metric card with progress
UsageTrendsChart.tsx       - Line chart for usage trends
UpgradeModal.tsx           - Upgrade confirmation with proration
DowngradeModal.tsx         - Downgrade confirmation with credit info
PlanChangeBlocker.tsx      - Shows blockers for invalid plan changes
```

### UI Patterns

**Invoice List Layout:**
```
+----------------------------------------------------------------+
| Invoices                                        [Download All]  |
+----------------------------------------------------------------+
| Invoice #    | Date       | Amount    | Status  | Actions      |
|--------------|------------|-----------|---------|--------------|
| INV-2024-001 | Jan 1      | $500.00   | [Paid]  | [Download]   |
| INV-2024-002 | Feb 1      | $500.00   | [Paid]  | [Download]   |
| INV-2024-003 | Mar 1      | $550.00   | [Open]  | [Pay Now]    |
+----------------------------------------------------------------+
| < 1 2 3 ... 5 >                                                 |
+----------------------------------------------------------------+
```

**Usage Dashboard Layout:**
```
+----------------------------------------------------------------+
| Usage Overview                    Period: Mar 1 - Mar 31, 2025  |
+----------------------------------------------------------------+
| +------------------+ +------------------+ +------------------+  |
| | Active Users     | | API Calls        | | Storage          |  |
| | [========--]     | | [======----]     | | [==========-]    |  |
| | 8 / 10 seats     | | 6,500 / 10,000   | | 4.5 / 5.0 GB     |  |
| | 80%              | | 65%              | | 90% [!]          |  |
| +------------------+ +------------------+ +------------------+  |
+----------------------------------------------------------------+
| Usage Trends (30 days)                   [Daily] [Weekly]       |
| [Line chart showing trends over time]                           |
+----------------------------------------------------------------+
```

## Test Cases

### Unit Tests

**invoice-service.test.ts**
```typescript
describe('InvoiceService', () => {
  describe('getInvoices', () => {
    it('returns paginated invoices for org');
    it('filters by org_id (RLS)');
    it('orders by created_at descending');
  });

  describe('syncInvoicesFromStripe', () => {
    it('creates new invoices from Stripe');
    it('updates existing invoices on status change');
    it('handles pagination for large invoice lists');
  });
});
```

**usage-service.test.ts**
```typescript
describe('UsageService', () => {
  describe('getCurrentUsage', () => {
    it('calculates active users from last 30 days');
    it('sums API calls for billing period');
    it('returns current storage usage');
    it('calculates percentage against plan limits');
  });

  describe('validateDowngrade', () => {
    it('blocks if active users exceed new plan limit');
    it('blocks if storage exceeds new plan limit');
    it('allows if all metrics within limits');
  });
});
```

### Integration Tests

**invoice-api.test.ts**
```typescript
describe('Invoice API', () => {
  describe('GET /api/v1/settings/invoices', () => {
    it('returns invoices for authenticated org');
    it('returns 403 for non-admin users');
    it('paginates correctly');
  });

  describe('GET /api/v1/settings/invoices/:id/pdf', () => {
    it('returns fresh PDF URL');
    it('returns 404 for other org invoice');
  });
});
```

**subscription-upgrade-api.test.ts**
```typescript
describe('Subscription Upgrade/Downgrade API', () => {
  describe('POST /api/v1/settings/subscription/upgrade', () => {
    it('calculates correct proration');
    it('charges immediately via Stripe');
    it('activates new plan features');
  });

  describe('POST /api/v1/settings/subscription/downgrade', () => {
    it('validates usage against new plan limits');
    it('schedules downgrade for period end');
    it('calculates credit correctly');
  });
});
```

## Deliverables

- [ ] `invoices` table migration
- [ ] `usage_metrics` table migration
- [ ] `usage_daily` table migration
- [ ] RLS policies for all tables
- [ ] Invoice service (`lib/services/invoice-service.ts`)
- [ ] Usage service (`lib/services/usage-service.ts`)
- [ ] Subscription service extension (upgrade/downgrade)
- [ ] Zod schemas (`lib/validation/invoice.ts`, `lib/validation/usage.ts`)
- [ ] Invoice API routes
- [ ] Usage API routes
- [ ] Upgrade/Downgrade API routes
- [ ] InvoicesList component
- [ ] InvoiceDetailModal component
- [ ] UsageDashboard component
- [ ] UsageMetricCard component
- [ ] UsageTrendsChart component
- [ ] UpgradeModal component
- [ ] DowngradeModal component
- [ ] Unit tests (>80% coverage)
- [ ] Integration tests
- [ ] E2E tests

## Definition of Done

- [ ] Invoice list displays with pagination
- [ ] Invoice details show line items and totals
- [ ] PDF download works from Stripe URLs
- [ ] Active users metric calculated correctly
- [ ] API calls tracked per billing period
- [ ] Storage usage displayed accurately
- [ ] Usage trends chart renders 30-day history
- [ ] Upgrade calculates correct proration
- [ ] Upgrade charges immediately via Stripe
- [ ] Downgrade validates against usage limits
- [ ] Downgrade schedules for period end
- [ ] Downgrade credit calculated correctly
- [ ] Non-admin users cannot access billing
- [ ] Cross-tenant access returns 404
- [ ] All tests pass
- [ ] Code review completed
