# Epic 01 Test Strategy - Settings Module (Demo MVP)

**Epic ID:** 01a
**Module:** Settings (Demo MVP Subset)
**Status:** Draft
**Last Updated:** 2025-12-15
**PRD Reference:** `docs/1-BASELINE/product/modules/settings.md`

---

## Overview

Test strategy for Epic 01 - a focused demo subset of the Settings Module covering only Phase 1A core features. This epic demonstrates the workflow structure with 7 stories.

**Key Testing Principles:**
- **Security First**: Multi-tenant isolation (RLS) must be 95% covered
- **Foundation Quality**: org_id resolution tested extensively
- **TDD Workflow**: RED (failing tests) → GREEN (pass) → REFACTOR

---

## Test Scope

### In Scope (P0 - 7 Stories)

| Story | Feature | Coverage Target |
|-------|---------|-----------------|
| 01.1 | Org context + base RLS | 95% |
| 01.2 | Settings shell navigation | 80% |
| 01.3 | Onboarding wizard launcher | 85% |
| 01.4 | Organization profile step | 80% |
| 01.5 | Users CRUD | 85% |
| 01.6 | Role-based permissions (10 roles) | 90% |
| 01.7 | Module toggles | 80% |

### Out of Scope (Deferred to Epic 01)

- Onboarding steps 2-6 (warehouse, location, product, work order, completion)
- Infrastructure (warehouses, locations, machines, production lines)
- Audit trail, security settings
- API keys, webhooks
- Subscription/billing
- Import/export

---

## Test Levels

### Unit Tests
- **Coverage Target:** 80%
- **Tools:** Vitest
- **Focus:** Services, validators, permission checks

### Integration Tests
- **Coverage Target:** 70%
- **Tools:** Vitest + Supabase test client
- **Focus:** API endpoints, RLS policies

### E2E Tests
- **Coverage Target:** Critical paths only
- **Tools:** Playwright
- **Focus:** Settings navigation, wizard launcher

---

## Critical Test Scenarios

### 1. RLS Isolation (01.1) - Priority: CRITICAL

```typescript
describe('01.1 Multi-Tenant Isolation', () => {
  it('should return 404 for cross-tenant resource access', async () => {
    // GIVEN user from Org B
    // WHEN accessing Org A resource
    // THEN 404 (not 403)
  });

  it('should block cross-tenant queries via RLS', async () => {
    // GIVEN query without explicit org_id
    // WHEN RLS applied
    // THEN only own org rows returned
  });
});
```

**Coverage:** 95%
**Test Count:** 8-10 tests

### 2. Role Permissions (01.6) - Priority: HIGH

```typescript
describe('01.6 Role-Based Permissions', () => {
  it.each([
    ['SUPER_ADMIN', 'Settings', 'CRUD'],
    ['ADMIN', 'Settings', 'CRUD'],
    ['VIEWER', 'Settings', 'R'],
    ['PROD_OPERATOR', 'Settings', '-'],
  ])('should enforce %s role has %s access to %s', async (role, module, access) => {
    // Test each of 10 roles
  });
});
```

**Coverage:** 90%
**Test Count:** 30+ tests (10 roles x 3+ scenarios)

### 3. Settings Navigation Guards (01.2) - Priority: HIGH

```typescript
describe('01.2 Settings Shell Navigation', () => {
  it('should redirect Viewer from /settings/users to dashboard', async () => {
    // GIVEN Viewer role
    // WHEN navigating to /settings/users
    // THEN redirect to dashboard with toast
  });

  it('should show all sections for Admin', async () => {
    // GIVEN Admin role
    // WHEN loading /settings
    // THEN all navigation sections visible
  });
});
```

**Coverage:** 80%
**Test Count:** 10-12 tests

### 4. Onboarding Wizard Launcher (01.3) - Priority: MEDIUM

```typescript
describe('01.3 Onboarding Wizard Launcher', () => {
  it('should trigger wizard on first login for new org', async () => {
    // GIVEN new organization (onboarding_step = 0)
    // WHEN admin logs in
    // THEN wizard modal appears
  });

  it('should NOT trigger for completed orgs', async () => {
    // GIVEN org with onboarding_completed_at set
    // WHEN user logs in
    // THEN no wizard, direct to dashboard
  });
});
```

**Coverage:** 85%
**Test Count:** 6-8 tests

### 5. Module Toggles (01.7) - Priority: MEDIUM

```typescript
describe('01.7 Module Toggles', () => {
  it('should hide disabled module from navigation', async () => {
    // GIVEN Production module disabled
    // WHEN loading navigation
    // THEN Production not in menu
  });

  it('should warn about dependencies when disabling', async () => {
    // GIVEN Production enabled, Quality enabled
    // WHEN disabling Production
    // THEN warning about Quality dependency
  });
});
```

**Coverage:** 80%
**Test Count:** 8-10 tests

---

## Test Data Requirements

### Fixtures

```typescript
// tests/01-settings/fixtures/
export const fixtures = {
  organizations: [
    { id: 'org-a', name: 'Org A', onboarding_step: 0 },
    { id: 'org-b', name: 'Org B', onboarding_completed_at: '2025-01-01' },
  ],
  users: [
    { org_id: 'org-a', email: 'super@a.com', role: 'SUPER_ADMIN' },
    { org_id: 'org-a', email: 'admin@a.com', role: 'ADMIN' },
    { org_id: 'org-a', email: 'viewer@a.com', role: 'VIEWER' },
    { org_id: 'org-b', email: 'admin@b.com', role: 'ADMIN' },
  ],
  modules: [
    { code: 'TECHNICAL', active: true },
    { code: 'PRODUCTION', active: false },
  ],
};
```

---

## File Structure

```
tests/01-settings/
  fixtures/
    organizations.ts
    users.ts
    modules.ts
  01.1.org-context-base-rls.test.ts
  01.1.org-context-base-rls.integration.test.ts
  01.2.settings-shell-navigation.test.ts
  01.3.onboarding-wizard-launcher.test.ts
  01.4.organization-profile-step.test.ts
  01.5.users-crud.test.ts
  01.5.users-crud.integration.test.ts
  01.6.role-permissions.test.ts
  01.7.module-toggles.test.ts
```

---

## Quality Gates

| Gate | Criteria | Enforcer |
|------|----------|----------|
| RED Complete | All tests written, all failing | TEST-WRITER |
| GREEN Complete | All tests passing | DEV |
| Coverage Met | Unit 80%, Integration 70% | CI |
| Security Met | RLS tests 95%+ | CODE-REVIEWER |

---

## Execution Commands

```bash
# Run all 01a tests
npm test -- tests/01-settings/

# Run specific story tests
npm test -- tests/01-settings/01.1

# Run with coverage
npm test -- tests/01-settings/ --coverage

# Run E2E
npx playwright test tests/01-settings/e2e/
```

---

## Notes for TEST-WRITER

1. **Start with 01.1** - foundation for all other stories
2. **Use Given/When/Then** format from story ACs
3. **Test isolation** - each test independent, clean fixtures
4. **Security focus** - 404 not 403 for cross-tenant
5. **Edge cases** - last super admin, self-delete, etc.

---

## Version History

| Version | Date | Changes |
|---------|------|---------|
| 1.0 | 2025-12-15 | Initial test strategy for demo Epic 01 |
