# 01.22 - Webhooks Management

**Story ID:** 01.22
**Epic:** 01 - Settings
**Phase:** 2 (Integrations)
**Complexity:** L (Large)
**Estimate:** 3-4 days
**Type:** Backend + Frontend
**State:** ready

**Primary PRD:** `docs/1-BASELINE/product/modules/settings.md` (FR-SET-130 to FR-SET-135)
**UX Wireframes:** SET-024 (Webhooks List)

## PRD References

| FR ID | Requirement | Priority | Phase | Covered |
|-------|-------------|----------|-------|---------|
| FR-SET-130 | Webhook endpoint registration | P1 | 2 | Yes |
| FR-SET-131 | Webhook event subscriptions | P1 | 2 | Yes |
| FR-SET-132 | Webhook delivery retry logic | P1 | 2 | Yes |
| FR-SET-133 | Webhook signature verification | P1 | 2 | Yes |
| FR-SET-134 | Webhook delivery logs | P2 | 2 | Yes |
| FR-SET-135 | Webhook test/ping functionality | P2 | 2 | Yes |

## User Story

**As an** administrator,
**I want** to register webhook endpoints and subscribe them to system events,
**So that** external systems can receive real-time notifications when events occur in MonoPilot.

**As an** integrations manager,
**I want** to verify webhook deliveries and troubleshoot failures,
**So that** I can ensure reliable event delivery to connected systems.

## Goal

Implement comprehensive webhook management enabling organizations to connect external systems for real-time event notifications. Support HMAC-SHA256 signature verification, exponential backoff retry logic, delivery logging, and test/ping functionality for reliable integrations.

## Scope

**In scope:**
- Webhook endpoint registration (HTTPS only)
- Event subscription management (product.created, order.completed, inventory.low, etc.)
- HMAC-SHA256 signature in X-Webhook-Signature header
- Retry logic: 3 attempts with exponential backoff (1s, 5s, 30s)
- Delivery logs (request, response, status, duration)
- Test endpoint with ping event
- Webhook enable/disable toggle
- Secret key generation and management
- Delivery status tracking (active, disabled, error)

**Out of scope:**
- IP allowlist per webhook (Phase 3)
- Custom headers per webhook (Phase 3)
- Webhook batching/aggregation (Phase 3)
- Event filtering/conditions (Phase 3)
- Webhook templates (Phase 3)

## Dependencies

| Story | Requirement | Status |
|-------|-------------|--------|
| 01.1 | Org Context + Base RLS | Required - provides org_id context |
| 01.6 | Role Permissions | Required - admin access control |
| 01.21 | API Keys | Optional - may share integration patterns |

## Acceptance Criteria (Given/When/Then)

### Webhook Registration (FR-SET-130)

#### Create Webhook
- GIVEN admin navigates to `/settings/webhooks`, WHEN "Add Webhook" clicked, THEN create modal opens with name, URL, events, and status fields.
- GIVEN create modal open, WHEN admin enters valid HTTPS URL, THEN URL accepted and validated.
- GIVEN create modal open, WHEN admin enters HTTP URL (non-HTTPS), THEN error "HTTPS required for webhooks" displays.
- GIVEN admin submits valid webhook form, WHEN webhook created, THEN secret key auto-generated (32 characters).
- GIVEN webhook created, WHEN webhook saved, THEN it appears in webhook list with "Active" status.
- GIVEN webhook URL exists for same org, WHEN duplicate URL entered, THEN warning "Webhook with this URL already exists" displays.

#### Edit Webhook
- GIVEN webhook exists, WHEN admin clicks "Edit", THEN edit modal opens with current values.
- GIVEN edit modal open, WHEN admin changes name or events, THEN changes can be saved.
- GIVEN edit modal open, WHEN admin attempts to change URL, THEN URL field is read-only (security measure).
- GIVEN admin needs different URL, WHEN URL change required, THEN must delete and recreate webhook.

#### Delete Webhook
- GIVEN webhook exists, WHEN admin clicks "Delete", THEN confirmation dialog appears with warning about log deletion.
- GIVEN confirmation dialog, WHEN admin confirms, THEN webhook and all delivery logs deleted.
- GIVEN webhook deleted, WHEN list refreshes, THEN webhook no longer appears.

### Event Subscriptions (FR-SET-131)

#### Subscribe to Events
- GIVEN webhook creation modal, WHEN events dropdown opened, THEN available events display grouped by category.
- GIVEN events available, WHEN admin selects multiple events, THEN all selected events stored in webhook.events array.
- GIVEN webhook with 5 events subscribed, WHEN relevant event occurs, THEN webhook receives notification.
- GIVEN webhook subscribed to "product.created", WHEN new product created, THEN webhook delivery triggered within 2 seconds.

#### Available Events
- Production: `work_order.created`, `work_order.started`, `work_order.completed`, `work_order.cancelled`
- Inventory: `inventory.updated`, `lot.created`, `material.reserved`, `material.consumed`, `inventory.low`
- Quality: `quality.test_created`, `quality.test_completed`, `quality.failed`, `quality.hold`
- Shipping: `shipment.created`, `shipment.dispatched`, `shipment.delivered`, `shipment.cancelled`
- Products: `product.created`, `product.updated`, `product.deleted`
- Orders: `order.created`, `order.completed`, `order.cancelled`

### Signature Verification (FR-SET-133)

#### HMAC-SHA256 Signature
- GIVEN webhook delivery, WHEN payload sent, THEN X-Webhook-Signature header contains HMAC-SHA256 signature.
- GIVEN signature format, WHEN header examined, THEN format is `sha256={hex_signature}`.
- GIVEN webhook with secret "abc123", WHEN payload signed, THEN recipient can verify using same secret.
- GIVEN signature verification example, WHEN documentation checked, THEN code samples provided for common languages.

#### Secret Management
- GIVEN new webhook created, WHEN no secret provided, THEN secret auto-generated (32 hex characters).
- GIVEN webhook secret, WHEN displayed in UI, THEN secret is masked (shown only on creation).
- GIVEN admin clicks "Regenerate Secret", WHEN confirmed, THEN new secret generated and old one invalidated.
- GIVEN secret regenerated, WHEN next delivery sent, THEN new signature uses new secret.

### Retry Logic (FR-SET-132)

#### Exponential Backoff
- GIVEN webhook delivery fails, WHEN first retry scheduled, THEN retry occurs after 1 second.
- GIVEN first retry fails, WHEN second retry scheduled, THEN retry occurs after 5 seconds.
- GIVEN second retry fails, WHEN third retry scheduled, THEN retry occurs after 30 seconds.
- GIVEN third retry fails, WHEN all retries exhausted, THEN webhook status changes to "error".

#### Retry Behavior
- GIVEN HTTP 5xx response, WHEN response received, THEN retry is scheduled.
- GIVEN HTTP 4xx response (except 429), WHEN response received, THEN no retry (client error).
- GIVEN HTTP 429 (rate limited), WHEN response received, THEN retry with backoff.
- GIVEN connection timeout (10s), WHEN timeout occurs, THEN retry is scheduled.
- GIVEN HTTP 2xx response, WHEN response received, THEN delivery marked successful, no retry.

### Delivery Logs (FR-SET-134)

#### Log Storage
- GIVEN webhook delivery attempted, WHEN delivery completes, THEN log entry created with full details.
- GIVEN log entry created, WHEN log examined, THEN includes: event type, payload, response status, response body, duration_ms, attempt number.
- GIVEN webhook has 150 delivery logs, WHEN logs queried, THEN only last 100 logs retained (auto-prune).
- GIVEN delivery log, WHEN response body stored, THEN truncated to 10KB max.

#### View Logs
- GIVEN admin clicks "View Logs" on webhook, WHEN logs panel opens, THEN delivery history displays chronologically.
- GIVEN logs panel, WHEN log entry clicked, THEN full request/response details display in modal.
- GIVEN logs panel, WHEN filtered by status, THEN only matching logs (success/failed) display.
- GIVEN logs panel, WHEN date range selected, THEN logs within range display.

### Test/Ping (FR-SET-135)

#### Test Webhook
- GIVEN webhook exists, WHEN admin clicks "Test", THEN test delivery modal opens.
- GIVEN test modal, WHEN "Send Test" clicked, THEN ping event sent to webhook URL.
- GIVEN test delivery sent, WHEN response received, THEN status, headers, and body display in modal.
- GIVEN test delivery succeeds (2xx), WHEN result displayed, THEN success indicator shows.
- GIVEN test delivery fails, WHEN result displayed, THEN error details and troubleshooting tips show.

#### Ping Event Payload
```json
{
  "event_type": "ping",
  "timestamp": "2025-12-11T14:32:00Z",
  "org_id": "org_123",
  "webhook_id": "webhook_456",
  "data": {
    "message": "This is a test event from MonoPilot",
    "webhook_name": "ERP Sync"
  }
}
```

### Multi-tenancy
- GIVEN User A from Org A, WHEN requesting webhooks, THEN only Org A webhooks returned.
- GIVEN User A from Org A, WHEN attempting to access Org B webhook, THEN 404 Not Found returns.
- GIVEN webhook delivery logs, WHEN queried by webhook_id, THEN RLS ensures org isolation.

## Technical Specification

### Database Schema

#### webhooks table

```sql
CREATE TABLE webhooks (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,

  -- Webhook configuration
  name VARCHAR(100) NOT NULL,
  url VARCHAR(500) NOT NULL, -- HTTPS only
  events TEXT[] NOT NULL, -- ['product.created', 'order.completed']
  secret VARCHAR(64) NOT NULL, -- For HMAC-SHA256 signature

  -- Status tracking
  active BOOLEAN DEFAULT true,
  status VARCHAR(20) DEFAULT 'active' CHECK (status IN ('active', 'disabled', 'error')),
  last_triggered_at TIMESTAMPTZ,
  last_status_code INT,
  last_error TEXT,
  consecutive_failures INT DEFAULT 0,

  -- Metadata
  description TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  created_by UUID REFERENCES users(id),

  -- Constraints
  CONSTRAINT webhooks_url_https CHECK (url LIKE 'https://%'),
  CONSTRAINT webhooks_events_not_empty CHECK (array_length(events, 1) > 0),
  CONSTRAINT webhooks_org_url_unique UNIQUE (org_id, url)
);

-- Indexes for performance
CREATE INDEX idx_webhooks_org_id ON webhooks(org_id);
CREATE INDEX idx_webhooks_active ON webhooks(org_id) WHERE active = true;
CREATE INDEX idx_webhooks_status ON webhooks(status);
CREATE INDEX idx_webhooks_events ON webhooks USING GIN(events);
```

#### webhook_logs table

```sql
CREATE TABLE webhook_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  webhook_id UUID NOT NULL REFERENCES webhooks(id) ON DELETE CASCADE,
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,

  -- Event details
  event_type VARCHAR(100) NOT NULL,
  payload JSONB NOT NULL,

  -- Request details
  request_headers JSONB,
  request_timestamp TIMESTAMPTZ DEFAULT NOW(),

  -- Response details
  response_status INT,
  response_body TEXT, -- Truncated to 10KB
  response_headers JSONB,

  -- Metrics
  duration_ms INT,
  attempt INT DEFAULT 1 CHECK (attempt >= 1 AND attempt <= 3),

  -- Status
  delivered BOOLEAN DEFAULT false,
  error_message TEXT,
  delivered_at TIMESTAMPTZ,

  -- Timestamps
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Indexes for performance
CREATE INDEX idx_webhook_logs_webhook_id ON webhook_logs(webhook_id);
CREATE INDEX idx_webhook_logs_org_id ON webhook_logs(org_id);
CREATE INDEX idx_webhook_logs_created_at ON webhook_logs(created_at DESC);
CREATE INDEX idx_webhook_logs_event_type ON webhook_logs(event_type);
CREATE INDEX idx_webhook_logs_delivered ON webhook_logs(webhook_id, delivered);

-- Auto-prune logs older than 30 days (via cron job or scheduled function)
-- Keep max 100 logs per webhook
CREATE OR REPLACE FUNCTION prune_webhook_logs()
RETURNS void AS $$
BEGIN
  DELETE FROM webhook_logs
  WHERE id IN (
    SELECT id FROM (
      SELECT id, ROW_NUMBER() OVER (PARTITION BY webhook_id ORDER BY created_at DESC) as rn
      FROM webhook_logs
    ) ranked WHERE rn > 100
  );

  DELETE FROM webhook_logs WHERE created_at < NOW() - INTERVAL '30 days';
END;
$$ LANGUAGE plpgsql;
```

### RLS Policies

```sql
-- Enable RLS
ALTER TABLE webhooks ENABLE ROW LEVEL SECURITY;
ALTER TABLE webhook_logs ENABLE ROW LEVEL SECURITY;

-- webhooks: Admins can manage, managers can view
CREATE POLICY "webhooks_select" ON webhooks
FOR SELECT USING (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  AND (SELECT r.code FROM roles r JOIN users u ON u.role_id = r.id WHERE u.id = auth.uid())
      IN ('SUPER_ADMIN', 'ADMIN', 'MANAGER')
);

CREATE POLICY "webhooks_insert" ON webhooks
FOR INSERT WITH CHECK (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  AND (SELECT r.code FROM roles r JOIN users u ON u.role_id = r.id WHERE u.id = auth.uid())
      IN ('SUPER_ADMIN', 'ADMIN', 'MANAGER')
);

CREATE POLICY "webhooks_update" ON webhooks
FOR UPDATE USING (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  AND (SELECT r.code FROM roles r JOIN users u ON u.role_id = r.id WHERE u.id = auth.uid())
      IN ('SUPER_ADMIN', 'ADMIN', 'MANAGER')
);

CREATE POLICY "webhooks_delete" ON webhooks
FOR DELETE USING (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  AND (SELECT r.code FROM roles r JOIN users u ON u.role_id = r.id WHERE u.id = auth.uid())
      IN ('SUPER_ADMIN', 'ADMIN')
);

-- webhook_logs: Read-only for admins and managers
CREATE POLICY "webhook_logs_select" ON webhook_logs
FOR SELECT USING (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  AND (SELECT r.code FROM roles r JOIN users u ON u.role_id = r.id WHERE u.id = auth.uid())
      IN ('SUPER_ADMIN', 'ADMIN', 'MANAGER')
);

-- Insert via service role only (from webhook delivery service)
CREATE POLICY "webhook_logs_insert" ON webhook_logs
FOR INSERT WITH CHECK (false); -- Service role bypasses RLS
```

### API Endpoints

```
# Webhook Management
GET    /api/v1/settings/webhooks                    - List organization webhooks
POST   /api/v1/settings/webhooks                    - Create new webhook
GET    /api/v1/settings/webhooks/:id                - Get webhook details
PUT    /api/v1/settings/webhooks/:id                - Update webhook (name, events, status)
DELETE /api/v1/settings/webhooks/:id                - Delete webhook

# Webhook Actions
POST   /api/v1/settings/webhooks/:id/test           - Send test ping event
POST   /api/v1/settings/webhooks/:id/regenerate-secret - Regenerate webhook secret

# Webhook Logs
GET    /api/v1/settings/webhooks/:id/logs           - Get delivery logs for webhook
GET    /api/v1/settings/webhooks/:id/logs/:logId    - Get specific log details

# Event Types (Reference)
GET    /api/v1/settings/webhooks/events             - List available event types
```

### Service Methods

**Location:** `lib/services/webhook-service.ts`

```typescript
interface WebhookService {
  // CRUD operations
  listWebhooks(orgId: string, filters?: WebhookFilters): Promise<Webhook[]>;
  getWebhook(webhookId: string): Promise<Webhook | null>;
  createWebhook(data: CreateWebhookInput): Promise<Webhook>;
  updateWebhook(webhookId: string, data: UpdateWebhookInput): Promise<Webhook>;
  deleteWebhook(webhookId: string): Promise<void>;

  // Webhook actions
  testWebhook(webhookId: string): Promise<WebhookTestResult>;
  regenerateSecret(webhookId: string): Promise<{ secret: string }>;

  // Delivery
  triggerWebhooks(eventType: string, payload: object): Promise<void>;
  deliverWebhook(webhook: Webhook, event: WebhookEvent): Promise<DeliveryResult>;
  retryDelivery(logId: string): Promise<DeliveryResult>;

  // Logs
  getDeliveryLogs(webhookId: string, filters?: LogFilters): Promise<WebhookLog[]>;
  getLogDetails(logId: string): Promise<WebhookLog | null>;

  // Helpers
  generateSecret(): string;
  signPayload(payload: object, secret: string): string;
  validateUrl(url: string): boolean;
  getAvailableEvents(): EventType[];
}

interface Webhook {
  id: string;
  org_id: string;
  name: string;
  url: string;
  events: string[];
  secret: string;
  active: boolean;
  status: 'active' | 'disabled' | 'error';
  last_triggered_at: string | null;
  last_status_code: number | null;
  last_error: string | null;
  created_at: string;
  created_by: string;
}

interface WebhookEvent {
  event_type: string;
  timestamp: string;
  org_id: string;
  webhook_id: string;
  data: object;
}

interface DeliveryResult {
  success: boolean;
  status_code: number;
  response_body: string;
  duration_ms: number;
  attempt: number;
  error?: string;
}

interface WebhookTestResult {
  success: boolean;
  status_code: number;
  response_headers: Record<string, string>;
  response_body: string;
  duration_ms: number;
  request_payload: object;
  signature: string;
}
```

**Location:** `lib/services/webhook-delivery-service.ts`

```typescript
interface WebhookDeliveryService {
  // Queue-based delivery
  queueDelivery(webhook: Webhook, event: WebhookEvent): Promise<void>;
  processDeliveryQueue(): Promise<void>;

  // Direct delivery (for test/ping)
  deliverNow(webhook: Webhook, event: WebhookEvent): Promise<DeliveryResult>;

  // Retry management
  scheduleRetry(logId: string, attempt: number): Promise<void>;
  processRetries(): Promise<void>;

  // Status management
  updateWebhookStatus(webhookId: string, result: DeliveryResult): Promise<void>;
  markAsError(webhookId: string, errorMessage: string): Promise<void>;
}

// Retry delays in milliseconds
const RETRY_DELAYS = [1000, 5000, 30000]; // 1s, 5s, 30s
const MAX_ATTEMPTS = 3;
const DELIVERY_TIMEOUT = 10000; // 10 seconds
```

### Zod Validation Schemas

**Location:** `lib/validation/webhook.ts`

```typescript
import { z } from 'zod';

// Available webhook events
export const webhookEventTypes = [
  // Production
  'work_order.created',
  'work_order.started',
  'work_order.completed',
  'work_order.cancelled',
  // Inventory
  'inventory.updated',
  'inventory.low',
  'lot.created',
  'material.reserved',
  'material.consumed',
  // Quality
  'quality.test_created',
  'quality.test_completed',
  'quality.failed',
  'quality.hold',
  // Shipping
  'shipment.created',
  'shipment.dispatched',
  'shipment.delivered',
  'shipment.cancelled',
  // Products
  'product.created',
  'product.updated',
  'product.deleted',
  // Orders
  'order.created',
  'order.completed',
  'order.cancelled',
] as const;

export const webhookEventSchema = z.enum(webhookEventTypes);

// Create webhook request
export const createWebhookSchema = z.object({
  name: z.string().min(1).max(100, 'Name must be 100 characters or less'),
  url: z.string()
    .url('Must be a valid URL')
    .refine((url) => url.startsWith('https://'), 'HTTPS required for webhooks'),
  events: z.array(webhookEventSchema).min(1, 'Select at least one event'),
  description: z.string().max(500).optional(),
  active: z.boolean().default(true),
});

// Update webhook request (URL not editable)
export const updateWebhookSchema = z.object({
  name: z.string().min(1).max(100).optional(),
  events: z.array(webhookEventSchema).min(1).optional(),
  description: z.string().max(500).optional(),
  active: z.boolean().optional(),
});

// Webhook response schema
export const webhookSchema = z.object({
  id: z.string().uuid(),
  org_id: z.string().uuid(),
  name: z.string(),
  url: z.string().url(),
  events: z.array(z.string()),
  active: z.boolean(),
  status: z.enum(['active', 'disabled', 'error']),
  last_triggered_at: z.string().datetime().nullable(),
  last_status_code: z.number().int().nullable(),
  last_error: z.string().nullable(),
  created_at: z.string().datetime(),
  created_by: z.string().uuid().nullable(),
});

// Webhook log schema
export const webhookLogSchema = z.object({
  id: z.string().uuid(),
  webhook_id: z.string().uuid(),
  event_type: z.string(),
  payload: z.record(z.unknown()),
  response_status: z.number().int().nullable(),
  response_body: z.string().nullable(),
  duration_ms: z.number().int().nullable(),
  attempt: z.number().int(),
  delivered: z.boolean(),
  error_message: z.string().nullable(),
  created_at: z.string().datetime(),
});

// Query params
export const webhookListQuerySchema = z.object({
  search: z.string().optional(),
  status: z.enum(['all', 'active', 'disabled', 'error']).default('all'),
  page: z.coerce.number().int().min(1).default(1),
  limit: z.coerce.number().int().min(1).max(100).default(20),
});

export const webhookLogsQuerySchema = z.object({
  status: z.enum(['all', 'success', 'failed']).default('all'),
  event_type: z.string().optional(),
  from_date: z.string().datetime().optional(),
  to_date: z.string().datetime().optional(),
  page: z.coerce.number().int().min(1).default(1),
  limit: z.coerce.number().int().min(1).max(100).default(50),
});
```

## UI Components

### Pages

- `app/(authenticated)/settings/webhooks/page.tsx` - Webhooks list page

### Components

**Location:** `components/settings/webhooks/`

```
WebhooksList.tsx              - Main list with DataTable
WebhookCard.tsx               - Individual webhook row display
CreateWebhookModal.tsx        - Create new webhook form
EditWebhookModal.tsx          - Edit webhook form (URL read-only)
DeleteWebhookDialog.tsx       - Confirmation dialog for deletion
TestWebhookModal.tsx          - Test delivery modal with results
WebhookLogsPanel.tsx          - Delivery logs side panel
WebhookLogDetail.tsx          - Full log details modal
WebhookStatusBadge.tsx        - Status indicator (active/disabled/error)
EventTypeSelect.tsx           - Multi-select for event subscriptions
SecretDisplay.tsx             - Masked secret with copy/regenerate
```

### Component Details

**WebhooksList.tsx**
```tsx
interface WebhooksListProps {
  webhooks: Webhook[];
  isLoading: boolean;
  onEdit: (webhook: Webhook) => void;
  onTest: (webhook: Webhook) => void;
  onViewLogs: (webhook: Webhook) => void;
  onDelete: (webhook: Webhook) => void;
  onToggleActive: (webhook: Webhook) => void;
}
```

**CreateWebhookModal.tsx**
```tsx
interface CreateWebhookModalProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  onSuccess: (webhook: Webhook) => void;
}

// Form fields:
// - Name (text input, required)
// - URL (text input, HTTPS validation)
// - Events (multi-select dropdown)
// - Description (textarea, optional)
// - Active (toggle, default true)
```

**TestWebhookModal.tsx**
```tsx
interface TestWebhookModalProps {
  webhook: Webhook;
  open: boolean;
  onOpenChange: (open: boolean) => void;
}

// Displays:
// - Request payload (JSON)
// - Response status code
// - Response headers
// - Response body
// - Duration (ms)
// - Signature header value
```

## Test Cases

### Unit Tests

**webhook-service.test.ts**
```typescript
describe('WebhookService', () => {
  describe('createWebhook', () => {
    it('creates webhook with auto-generated secret');
    it('validates HTTPS URL requirement');
    it('rejects duplicate URL for same org');
    it('requires at least one event');
  });

  describe('signPayload', () => {
    it('generates valid HMAC-SHA256 signature');
    it('produces consistent signatures for same payload/secret');
    it('produces different signatures for different secrets');
  });

  describe('testWebhook', () => {
    it('sends ping event to webhook URL');
    it('includes signature header');
    it('returns response details');
  });
});
```

**webhook-delivery-service.test.ts**
```typescript
describe('WebhookDeliveryService', () => {
  describe('deliverNow', () => {
    it('delivers payload to webhook URL');
    it('sets correct headers including signature');
    it('times out after 10 seconds');
    it('records delivery log on success');
    it('records delivery log on failure');
  });

  describe('retryDelivery', () => {
    it('retries after 1s on first failure');
    it('retries after 5s on second failure');
    it('retries after 30s on third failure');
    it('marks webhook as error after 3 failures');
    it('does not retry on 4xx responses');
    it('retries on 5xx responses');
  });
});
```

### Integration Tests

**webhook-api.test.ts**
```typescript
describe('Webhook API', () => {
  describe('POST /api/v1/settings/webhooks', () => {
    it('creates webhook with valid data');
    it('rejects HTTP URL');
    it('rejects empty events array');
    it('returns 403 for non-admin users');
  });

  describe('PUT /api/v1/settings/webhooks/:id', () => {
    it('updates webhook name and events');
    it('does not allow URL update');
    it('returns 404 for other org webhook');
  });

  describe('POST /api/v1/settings/webhooks/:id/test', () => {
    it('sends test ping to webhook');
    it('returns delivery result');
    it('does not create log entry for test');
  });

  describe('GET /api/v1/settings/webhooks/:id/logs', () => {
    it('returns paginated logs');
    it('filters by status');
    it('filters by date range');
  });
});
```

### E2E Tests

**webhooks.spec.ts**
```typescript
describe('Webhooks Management', () => {
  it('displays webhook list');
  it('creates new webhook with events');
  it('shows secret on creation only');
  it('edits webhook name and events');
  it('cannot edit webhook URL');
  it('tests webhook and shows result');
  it('views delivery logs');
  it('deletes webhook with confirmation');
  it('toggles webhook active status');
  it('shows error status after failures');
});
```

## Security Considerations

1. **URL Validation**
   - HTTPS required for all webhooks
   - Validate URL format before saving
   - Consider blocking internal/private IPs

2. **Secret Management**
   - Generate cryptographically secure secrets (32 hex chars)
   - Hash secrets in database (show only on creation)
   - Support secret regeneration

3. **Signature Verification**
   - HMAC-SHA256 with webhook secret
   - Include timestamp to prevent replay attacks
   - Document verification for consumers

4. **Rate Limiting**
   - Max 1000 events/hour per webhook
   - Max 50 webhooks per organization
   - Backoff on repeated failures

5. **Data Sanitization**
   - Truncate response body in logs (10KB max)
   - Never log secrets or sensitive headers
   - Sanitize payload data before sending

## Deliverables

- [ ] `webhooks` table migration
- [ ] `webhook_logs` table migration
- [ ] RLS policies for webhooks and webhook_logs
- [ ] Webhook service (`lib/services/webhook-service.ts`)
- [ ] Webhook delivery service (`lib/services/webhook-delivery-service.ts`)
- [ ] Zod schemas (`lib/validation/webhook.ts`)
- [ ] API routes for webhook management
- [ ] API routes for webhook actions (test, regenerate)
- [ ] API routes for webhook logs
- [ ] WebhooksList component
- [ ] CreateWebhookModal component
- [ ] EditWebhookModal component
- [ ] TestWebhookModal component
- [ ] WebhookLogsPanel component
- [ ] Webhooks page
- [ ] Unit tests (>80% coverage)
- [ ] Integration tests
- [ ] E2E tests

## Definition of Done

- [ ] Webhooks can be created with HTTPS URLs only
- [ ] At least one event must be selected for webhook
- [ ] HMAC-SHA256 signature sent in X-Webhook-Signature header
- [ ] Retry logic works: 1s, 5s, 30s exponential backoff
- [ ] Max 3 retry attempts per delivery
- [ ] Webhook status changes to "error" after 3 consecutive failures
- [ ] Delivery logs record all attempts with full details
- [ ] Test/ping functionality works and shows results
- [ ] Secret displayed only on creation
- [ ] Secret regeneration works
- [ ] URL cannot be edited (security)
- [ ] Multi-tenancy enforced via RLS
- [ ] Cross-org access returns 404
- [ ] Webhook limit per org enforced (50 max)
- [ ] Log retention (100 per webhook, 30 days max)
- [ ] Unit test coverage >= 80%
- [ ] Integration tests pass
- [ ] E2E tests pass
