# 01.23 - Notification Settings

**Story ID:** 01.23
**Epic:** 01 - Settings
**Phase:** 2 (Integrations)
**Complexity:** M (Medium)
**Estimate:** 1-2 days
**Type:** Backend + Frontend
**State:** ready

**Primary PRD:** `docs/1-BASELINE/product/modules/settings.md` (FR-SET-160 to FR-SET-163)
**UX Wireframes:** SET-023 (Notification Preferences)

## PRD References

| FR ID | Requirement | Priority | Phase | Covered |
|-------|-------------|----------|-------|---------|
| FR-SET-160 | Email notification settings | P1 | 2 | Yes |
| FR-SET-161 | In-app notification preferences | P1 | 2 | Yes |
| FR-SET-162 | Notification templates | P2 | 2 | Yes |
| FR-SET-163 | User notification subscriptions | P1 | 2 | Yes |

## User Story

**As a** user,
**I want** to configure my notification preferences for different event types and channels,
**So that** I receive relevant updates without being overwhelmed by unnecessary notifications.

**As an** administrator,
**I want** to manage notification templates with customizable content,
**So that** our organization can maintain consistent and branded communication.

## Goal

Implement comprehensive notification settings allowing users to control which events trigger notifications and through which channels (email, in-app, SMS future). Administrators can customize notification templates with variable substitution for personalized messages.

## Scope

**In scope:**
- Per-user notification preferences by event type
- Channel selection: email, in-app (SMS as future placeholder)
- Event types: order_completed, inventory_low, quality_alert, work_order_status, etc.
- Email templates with variable substitution ({{user.name}}, {{order.id}})
- Organization-level default templates
- Unsubscribe functionality per event type
- Bulk enable/disable all notifications

**Out of scope:**
- SMS integration (placeholder only, Phase 3)
- Push notifications (mobile app)
- Real-time notification delivery service (separate story)
- Email sending infrastructure (assumes SMTP configured)

## Dependencies

| Story | Requirement | Status |
|-------|-------------|--------|
| 01.1 | Org Context + Base RLS | Required - provides auth context |
| 01.6 | Role Permissions | Required - admin template management |

## Acceptance Criteria (Given/When/Then)

### User Notification Preferences (FR-SET-160, FR-SET-161)

#### View Preferences
- GIVEN user navigates to notification settings, WHEN page loads, THEN all event types display with current preference per channel.
- GIVEN preference list loaded, WHEN rendered, THEN grouped by category (Orders, Inventory, Quality, Production).
- GIVEN user has no preferences saved, WHEN page loads, THEN defaults to all notifications enabled.

#### Update Preferences
- GIVEN user toggles email for "order_completed" to OFF, WHEN toggle clicked, THEN preference saved immediately (optimistic UI).
- GIVEN user toggles in-app for "inventory_low" to ON, WHEN toggle clicked, THEN database updated within 500ms.
- GIVEN preference update fails, WHEN error occurs, THEN toggle reverts and error toast displays.

#### Bulk Actions
- GIVEN user clicks "Disable All Email", WHEN confirmed, THEN all email preferences set to false.
- GIVEN user clicks "Enable All", WHEN confirmed, THEN all preferences set to true for all channels.
- GIVEN user clicks "Reset to Defaults", WHEN confirmed, THEN preferences reset to organization defaults.

### Notification Templates (FR-SET-162)

#### View Templates
- GIVEN admin navigates to notification templates, WHEN page loads, THEN list of templates displays with event type and channel.
- GIVEN template list, WHEN rendered, THEN each row shows: event type, channel, subject preview, last modified.
- GIVEN non-admin user, WHEN accessing templates page, THEN 403 Forbidden displays.

#### Edit Templates
- GIVEN admin clicks edit on "order_completed" email template, WHEN modal opens, THEN subject and body fields editable.
- GIVEN admin edits body with "Hello {{user.name}}, your order {{order.id}} is complete", WHEN saved, THEN template stored with variables intact.
- GIVEN template has invalid variable "{{invalid.var}}", WHEN saved, THEN warning displays but save allowed.
- GIVEN admin clicks "Preview", WHEN preview renders, THEN sample data substituted into variables.

#### Template Variables
- GIVEN template editor open, WHEN user clicks "Insert Variable", THEN dropdown shows available variables for event type.
- GIVEN "order_completed" event, WHEN variables requested, THEN returns: user.name, user.email, order.id, order.total, order.items_count.
- GIVEN "inventory_low" event, WHEN variables requested, THEN returns: user.name, item.name, item.sku, item.current_qty, item.reorder_point.

### User Subscriptions (FR-SET-163)

#### Subscribe/Unsubscribe
- GIVEN user receives email with unsubscribe link, WHEN clicked, THEN preference for that event type set to false.
- GIVEN unsubscribe link, WHEN processed, THEN redirect to confirmation page with option to re-enable.
- GIVEN unsubscribe token, WHEN token invalid or expired, THEN error page displays.

### Multi-tenancy

- GIVEN User A from Org A, WHEN requesting preferences, THEN only own preferences returned.
- GIVEN Admin A from Org A, WHEN editing templates, THEN only Org A templates visible and editable.
- GIVEN User A from Org A, WHEN attempting to view Org B templates, THEN 403 Forbidden returns.

## Technical Specification

### Database Schema

#### notification_settings table

```sql
CREATE TABLE notification_settings (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,

  -- Event and channel
  event_type VARCHAR(100) NOT NULL, -- 'order.completed', 'inventory.low', etc.
  channel VARCHAR(20) NOT NULL, -- 'email', 'in_app', 'sms'
  enabled BOOLEAN DEFAULT true,

  -- Timestamps
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),

  -- Constraints
  CONSTRAINT notification_settings_unique UNIQUE(user_id, event_type, channel)
);

-- Indexes
CREATE INDEX idx_notification_settings_user_id ON notification_settings(user_id);
CREATE INDEX idx_notification_settings_org_id ON notification_settings(org_id);
CREATE INDEX idx_notification_settings_event ON notification_settings(event_type);
```

#### notification_templates table

```sql
CREATE TABLE notification_templates (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,

  -- Template identification
  event_type VARCHAR(100) NOT NULL, -- 'order.completed'
  channel VARCHAR(20) NOT NULL, -- 'email', 'in_app'

  -- Content
  subject VARCHAR(200), -- Email subject (null for in_app)
  body TEXT NOT NULL, -- Supports {{variable}} syntax

  -- Metadata
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  created_by UUID REFERENCES users(id),
  updated_by UUID REFERENCES users(id),

  -- Constraints
  CONSTRAINT notification_templates_unique UNIQUE(org_id, event_type, channel)
);

-- Indexes
CREATE INDEX idx_notification_templates_org_id ON notification_templates(org_id);
CREATE INDEX idx_notification_templates_event ON notification_templates(event_type);
```

#### notification_event_types table (reference data)

```sql
CREATE TABLE notification_event_types (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  code VARCHAR(100) UNIQUE NOT NULL, -- 'order.completed'
  name VARCHAR(200) NOT NULL, -- 'Order Completed'
  category VARCHAR(50) NOT NULL, -- 'orders', 'inventory', 'quality', 'production'
  description TEXT,
  available_variables JSONB, -- ['user.name', 'order.id', ...]
  default_enabled BOOLEAN DEFAULT true,
  channels VARCHAR(20)[] DEFAULT ARRAY['email', 'in_app'], -- Available channels
  sort_order INTEGER DEFAULT 0
);

-- Seed event types
INSERT INTO notification_event_types (code, name, category, available_variables, sort_order) VALUES
  ('order.completed', 'Order Completed', 'orders', '["user.name","user.email","order.id","order.total"]', 10),
  ('order.shipped', 'Order Shipped', 'orders', '["user.name","order.id","tracking.number"]', 20),
  ('inventory.low', 'Low Inventory Alert', 'inventory', '["user.name","item.name","item.sku","item.current_qty","item.reorder_point"]', 30),
  ('inventory.expired', 'Inventory Expiring', 'inventory', '["user.name","item.name","item.lot","item.expiry_date"]', 40),
  ('quality.alert', 'Quality Alert', 'quality', '["user.name","alert.type","item.name","item.lot"]', 50),
  ('quality.hold_released', 'Quality Hold Released', 'quality', '["user.name","item.name","item.lot"]', 60),
  ('work_order.status_changed', 'Work Order Status Changed', 'production', '["user.name","wo.number","wo.status","wo.product"]', 70),
  ('work_order.completed', 'Work Order Completed', 'production', '["user.name","wo.number","wo.product","wo.qty_produced"]', 80),
  ('system.maintenance', 'System Maintenance', 'system', '["scheduled_time","duration","description"]', 90);
```

### RLS Policies

```sql
-- notification_settings: Users can manage their own preferences
CREATE POLICY "notification_settings_own" ON notification_settings
FOR ALL USING (user_id = auth.uid());

CREATE POLICY "notification_settings_insert" ON notification_settings
FOR INSERT WITH CHECK (
  user_id = auth.uid()
  AND org_id = (SELECT org_id FROM users WHERE id = auth.uid())
);

-- notification_templates: Admins can manage org templates
CREATE POLICY "notification_templates_read" ON notification_templates
FOR SELECT USING (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
);

CREATE POLICY "notification_templates_admin" ON notification_templates
FOR ALL USING (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  AND (SELECT r.code FROM roles r JOIN users u ON u.role_id = r.id WHERE u.id = auth.uid()) IN ('SUPER_ADMIN', 'ADMIN')
);

-- notification_event_types: Public read
CREATE POLICY "notification_event_types_read" ON notification_event_types
FOR SELECT USING (true);
```

### API Endpoints

```
# User Notification Preferences
GET    /api/v1/settings/notifications              - Get user's notification preferences
PUT    /api/v1/settings/notifications              - Update user's preferences (bulk)
PATCH  /api/v1/settings/notifications/:eventType   - Update single preference
POST   /api/v1/settings/notifications/reset        - Reset to defaults
POST   /api/v1/settings/notifications/disable-all  - Disable all notifications

# Notification Templates (Admin only)
GET    /api/v1/settings/notification-templates              - List org templates
GET    /api/v1/settings/notification-templates/:id          - Get single template
PUT    /api/v1/settings/notification-templates/:id          - Update template
POST   /api/v1/settings/notification-templates/:id/preview  - Preview with sample data

# Event Types (Reference)
GET    /api/v1/settings/notification-event-types            - List available event types
```

### Service Methods

**Location:** `lib/services/notification-settings-service.ts`

```typescript
interface NotificationSettingsService {
  // User preferences
  getPreferences(userId: string): Promise<NotificationPreference[]>;
  getPreferencesByEvent(userId: string, eventType: string): Promise<NotificationPreference[]>;
  updatePreference(userId: string, eventType: string, channel: string, enabled: boolean): Promise<void>;
  updatePreferences(userId: string, preferences: PreferenceUpdate[]): Promise<void>;
  resetToDefaults(userId: string): Promise<void>;
  disableAll(userId: string, channel?: string): Promise<void>;

  // Event types
  getEventTypes(): Promise<NotificationEventType[]>;
  getEventTypesByCategory(): Promise<Record<string, NotificationEventType[]>>;

  // Unsubscribe
  generateUnsubscribeToken(userId: string, eventType: string): Promise<string>;
  processUnsubscribe(token: string): Promise<UnsubscribeResult>;
}

interface NotificationPreference {
  event_type: string;
  event_name: string;
  category: string;
  channels: {
    email: boolean;
    in_app: boolean;
    sms: boolean;
  };
}

interface PreferenceUpdate {
  event_type: string;
  channel: string;
  enabled: boolean;
}
```

**Location:** `lib/services/notification-template-service.ts`

```typescript
interface NotificationTemplateService {
  // Template CRUD
  getTemplates(orgId: string): Promise<NotificationTemplate[]>;
  getTemplate(orgId: string, eventType: string, channel: string): Promise<NotificationTemplate | null>;
  updateTemplate(id: string, data: TemplateUpdate): Promise<NotificationTemplate>;

  // Variable handling
  getVariablesForEvent(eventType: string): Promise<string[]>;
  renderTemplate(template: NotificationTemplate, variables: Record<string, any>): string;
  previewTemplate(id: string, sampleData?: Record<string, any>): Promise<RenderedTemplate>;

  // Validation
  validateTemplate(body: string, eventType: string): TemplateValidation;
}

interface NotificationTemplate {
  id: string;
  org_id: string;
  event_type: string;
  channel: string;
  subject: string | null;
  body: string;
  is_active: boolean;
  updated_at: string;
}

interface TemplateValidation {
  valid: boolean;
  warnings: string[]; // Unknown variables
  variables_found: string[];
}
```

### Zod Validation Schemas

**Location:** `lib/validation/notification-settings.ts`

```typescript
import { z } from 'zod';

export const notificationChannelSchema = z.enum(['email', 'in_app', 'sms']);

export const notificationPreferenceSchema = z.object({
  event_type: z.string().min(1),
  channel: notificationChannelSchema,
  enabled: z.boolean(),
});

export const updatePreferencesSchema = z.object({
  preferences: z.array(notificationPreferenceSchema),
});

export const updateSinglePreferenceSchema = z.object({
  channel: notificationChannelSchema,
  enabled: z.boolean(),
});

export const notificationTemplateSchema = z.object({
  subject: z.string().max(200).nullable(),
  body: z.string().min(1).max(10000),
  is_active: z.boolean().optional(),
});

export const templatePreviewSchema = z.object({
  sample_data: z.record(z.string(), z.any()).optional(),
});
```

## UI Components

### Pages

- `app/(authenticated)/settings/notifications/page.tsx` - User notification preferences
- `app/(authenticated)/settings/notifications/templates/page.tsx` - Admin template management

### Components

**Location:** `components/settings/notifications/`

```
NotificationPreferences.tsx    - Main preferences panel with toggles
NotificationCategoryGroup.tsx  - Category grouping (Orders, Inventory, etc.)
NotificationToggle.tsx         - Single event type toggle row
BulkActionsBar.tsx             - Disable all, enable all, reset buttons
TemplatesList.tsx              - Admin template list
TemplateEditModal.tsx          - Template editor with variable picker
VariablePicker.tsx             - Dropdown for inserting variables
TemplatePreview.tsx            - Preview rendered template
```

### UI Patterns

**Notification Preferences Layout:**
```
+--------------------------------------------------+
| Notification Preferences                          |
| [Disable All Email] [Enable All] [Reset]         |
+--------------------------------------------------+
| ORDERS                                            |
| +----------------------------------------------+ |
| | Order Completed          [Email] [In-App]   | |
| | Order Shipped            [Email] [In-App]   | |
| +----------------------------------------------+ |
| INVENTORY                                         |
| +----------------------------------------------+ |
| | Low Inventory Alert      [Email] [In-App]   | |
| | Inventory Expiring       [Email] [In-App]   | |
| +----------------------------------------------+ |
| QUALITY                                           |
| +----------------------------------------------+ |
| | Quality Alert            [Email] [In-App]   | |
| | Quality Hold Released    [Email] [In-App]   | |
| +----------------------------------------------+ |
+--------------------------------------------------+
```

**Template Editor:**
```
+--------------------------------------------------+
| Edit Template: Order Completed (Email)            |
+--------------------------------------------------+
| Subject:                                          |
| [Your order {{order.id}} is complete           ] |
+--------------------------------------------------+
| Body:                              [+ Variable]  |
| +----------------------------------------------+ |
| | Hello {{user.name}},                         | |
| |                                              | |
| | Your order #{{order.id}} has been completed. | |
| | Total: {{order.total}}                       | |
| +----------------------------------------------+ |
+--------------------------------------------------+
| [Preview]                    [Cancel] [Save]     |
+--------------------------------------------------+
```

## Test Cases

### Unit Tests

**notification-settings-service.test.ts**
```typescript
describe('NotificationSettingsService', () => {
  describe('getPreferences', () => {
    it('returns all preferences for user grouped by event type');
    it('returns default enabled for missing preferences');
  });

  describe('updatePreference', () => {
    it('creates preference if not exists');
    it('updates existing preference');
    it('validates event type exists');
  });

  describe('processUnsubscribe', () => {
    it('disables preference for valid token');
    it('returns error for expired token');
    it('returns error for invalid token');
  });
});
```

**notification-template-service.test.ts**
```typescript
describe('NotificationTemplateService', () => {
  describe('renderTemplate', () => {
    it('substitutes all variables correctly');
    it('leaves unknown variables as-is');
    it('handles missing variable values gracefully');
  });

  describe('validateTemplate', () => {
    it('returns warnings for unknown variables');
    it('lists all found variables');
  });
});
```

### Integration Tests

**notification-settings-api.test.ts**
```typescript
describe('Notification Settings API', () => {
  describe('GET /api/v1/settings/notifications', () => {
    it('returns user preferences grouped by category');
    it('returns 401 for unauthenticated');
  });

  describe('PUT /api/v1/settings/notifications', () => {
    it('updates multiple preferences at once');
    it('validates preference data');
  });

  describe('GET /api/v1/settings/notification-templates', () => {
    it('returns templates for admin user');
    it('returns 403 for non-admin');
  });
});
```

### E2E Tests

**notification-preferences.spec.ts**
```typescript
describe('Notification Preferences', () => {
  it('displays preferences grouped by category');
  it('toggles email preference with immediate save');
  it('disables all email notifications');
  it('resets to defaults');
});
```

## Deliverables

- [ ] `notification_settings` table migration
- [ ] `notification_templates` table migration
- [ ] `notification_event_types` table with seed data
- [ ] RLS policies for all tables
- [ ] Notification settings service (`lib/services/notification-settings-service.ts`)
- [ ] Notification template service (`lib/services/notification-template-service.ts`)
- [ ] Zod schemas (`lib/validation/notification-settings.ts`)
- [ ] API routes for preferences
- [ ] API routes for templates (admin)
- [ ] NotificationPreferences component
- [ ] TemplatesList component
- [ ] TemplateEditModal component
- [ ] User preferences page
- [ ] Admin templates page
- [ ] Unit tests (>80% coverage)
- [ ] Integration tests
- [ ] E2E tests

## Definition of Done

- [ ] User can view notification preferences grouped by category
- [ ] User can toggle email/in-app per event type with immediate save
- [ ] Bulk actions (disable all, enable all, reset) work correctly
- [ ] Admin can view and edit notification templates
- [ ] Template variables render correctly in preview
- [ ] Variable picker shows available variables per event type
- [ ] Non-admin cannot access template management
- [ ] Unsubscribe links work and disable specific event types
- [ ] Cross-tenant isolation enforced (users only see own preferences)
- [ ] RLS policies tested and working
- [ ] Unit test coverage >= 80%
- [ ] Integration tests pass
- [ ] E2E tests pass
