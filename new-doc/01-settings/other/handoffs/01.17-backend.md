# Handoff: 01.17 Audit Trail - Backend

## Story
Comprehensive audit trail: logs CREATE/UPDATE/DELETE, field-level changes, auth events (LOGIN/LOGOUT/LOGIN_FAILED/SESSION_EXPIRED), search/filter/export.

## Tests to Make Pass
- `apps/frontend/lib/services/__tests__/audit-service.test.ts` (32 tests, RED)

## Files to Create
1. **Migration**: `supabase/migrations/XXX_create_audit_logs.sql`
   - `audit_logs` table with immutability triggers, FTS, RLS
   - See story for full schema
2. **Service**: `apps/frontend/lib/services/audit-service.ts`
   - Static methods: redactSensitiveFields, computeChanges, logCreate/Update/Delete, logLogin/Logout/LoginFailed, getAuditLogs, exportToCsv
3. **Validation**: `apps/frontend/lib/validation/audit.ts`
   - Zod schemas: auditActionSchema, auditLogQuerySchema, auditExportSchema
4. **API Routes**:
   - `apps/frontend/app/api/settings/audit-logs/route.ts` (GET list)
   - `apps/frontend/app/api/settings/audit-logs/[id]/route.ts` (GET single)
   - `apps/frontend/app/api/settings/audit-logs/export/route.ts` (POST CSV)

## Key Business Rules
- SENSITIVE_FIELDS: password, password_hash, api_key, api_secret, refresh_token, session_token, secret_key, private_key, access_token
- Immutable: triggers prevent UPDATE/DELETE on audit_logs
- Permission: Manager/Admin only (403 for Operator)
- Export: max 10,000 rows CSV
- FTS: tsvector on entity_type, entity_id, changes, metadata
- Pagination: 100 per page, infinite scroll

## Patterns
- Service: static class methods (`AuditService.logCreate(...)`)
- RLS: `org_id = (SELECT org_id FROM users WHERE id = auth.uid())`
- API: validate with Zod, return `{ data, total, limit, offset }`
