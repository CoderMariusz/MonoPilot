# 05.28 - Expiry Alerts Dashboard

**Story ID:** 05.28
**Epic:** 05 - Warehouse
**Phase:** 2 (Advanced Features)
**Complexity:** M (Medium)
**Estimate:** 2-3 days
**Priority:** P2
**Type:** Backend + Frontend
**State:** ready

**Primary PRD:** `docs/1-BASELINE/product/modules/warehouse.md` (WH-FR-030: Expiry Alerts)
**Related Stories:** 05.7 (Warehouse Dashboard), 05.1 (LP Table with expiry_date)

## PRD References

| FR ID | Requirement | Priority | Phase | Covered |
|-------|-------------|----------|-------|---------|
| WH-FR-030 | Expiry Alerts | P2 | 2 | Yes |
| WH-FR-010 | Expiry Tracking | P0 | 1 | Partial (expiry_date field) |

## User Story

**As a** warehouse manager,
**I want** to see dashboard alerts for expiring and expired inventory,
**So that** I can proactively manage stock rotation, minimize waste, and ensure compliance with food safety regulations.

**As an** operations supervisor,
**I want** to receive notifications when inventory approaches expiry thresholds,
**So that** I can prioritize FEFO picks and plan disposition of soon-to-expire products.

## Goal

Implement a comprehensive expiry alerts system with dashboard widgets, multi-tier visual alerts, email notifications, and configurable warning thresholds. Enable warehouse teams to proactively identify and manage inventory approaching or past expiry dates.

## Scope

**In scope:**
- Expiring Soon dashboard widget (items within expiry_warning_days)
- Expired LPs alert list (expiry_date < today)
- Multi-tier color coding (7 days = red, 30 days = yellow)
- Configurable expiry_warning_days threshold (per org)
- Days until expiry calculation and display
- Daily scheduled expiry check job (Edge Function)
- Email notification to warehouse manager
- API endpoint for expiring LPs query
- Click-through navigation to LP detail
- Summary KPIs (expiring count, expired count, value at risk)
- Export expiring items list to CSV

**Out of scope:**
- SMS/push notifications (Phase 3+)
- Automated disposition workflows (Phase 3+)
- Supplier notifications (Phase 3+)
- Auto-blocking of expired LPs (separate story)
- Product-level expiry threshold overrides (Phase 2B)
- Slack/Teams integrations (Epic 11)

## Dependencies

| Story | Requirement | Status |
|-------|-------------|--------|
| 05.1 | LP Table with expiry_date field | Required |
| 05.7 | Warehouse Dashboard (base widgets) | Required |
| 05.0 | Warehouse Settings (expiry_warning_days) | Required |
| 01.23 | Notification Settings (email preferences) | Optional |

---

## Acceptance Criteria (Given/When/Then)

### Expiring Soon Widget (WH-FR-030)

#### AC-1: Expiring Soon Dashboard Widget
- GIVEN expiry_warning_days = 30 in warehouse_settings, WHEN LP.expiry_date <= current_date + 30 days AND expiry_date >= current_date AND LP.status = 'available', THEN LP appears in "Expiring Soon" dashboard widget.
- GIVEN the widget loads, WHEN data fetched, THEN items sorted by expiry_date ASC (soonest first).
- GIVEN expiring LP in widget, WHEN displayed, THEN shows: LP number, product name, quantity, UoM, location, expiry date, days until expiry.
- GIVEN widget item clicked, WHEN navigation triggered, THEN user navigates to LP detail page.
- GIVEN more than 10 expiring items, WHEN widget renders, THEN shows first 10 with "View All (N)" link.

#### AC-2: Multi-Tier Color Coding
- GIVEN LP with expiry_date <= today + 7 days, WHEN displayed, THEN row/badge shows RED indicator (critical).
- GIVEN LP with expiry_date > today + 7 days AND <= today + 14 days, WHEN displayed, THEN row/badge shows ORANGE indicator (warning).
- GIVEN LP with expiry_date > today + 14 days AND <= today + 30 days, WHEN displayed, THEN row/badge shows YELLOW indicator (caution).
- GIVEN LP with expiry_date > today + 30 days, WHEN displayed, THEN no expiry indicator shown (normal).

#### AC-3: Days Until Expiry Calculation
- GIVEN LP with expiry_date = current_date + 5 days, WHEN days_until_expiry calculated, THEN returns 5.
- GIVEN LP with expiry_date = current_date, WHEN days_until_expiry calculated, THEN returns 0 with "Expires today" label.
- GIVEN LP with expiry_date < current_date, WHEN days_until_expiry calculated, THEN returns negative value with "Expired X days ago" label.
- GIVEN display format, WHEN days > 0, THEN shows "in X days" format.
- GIVEN display format, WHEN days <= 0, THEN shows "Expired" or "Expires today" in red.

### Expired LPs Alert (WH-FR-030)

#### AC-4: Expired LPs Alert Panel
- GIVEN LP with expiry_date < current_date AND status = 'available', WHEN dashboard loads, THEN LP appears in "Expired Inventory" alert panel.
- GIVEN expired LP panel, WHEN displayed, THEN shows: LP number, product name, qty, expiry date, days expired, value (qty * unit cost).
- GIVEN expired LP panel, WHEN sorted, THEN ordered by expiry_date ASC (oldest expired first).
- GIVEN expired LP clicked, WHEN navigation triggered, THEN user navigates to LP detail page.
- GIVEN no expired LPs, WHEN panel renders, THEN shows "No expired inventory" with green checkmark.

#### AC-5: Expired LP Summary
- GIVEN expired LPs exist, WHEN summary displayed, THEN shows: total count, total quantity, total value at risk.
- GIVEN value at risk calculation, WHEN computed, THEN uses SUM(lp.quantity * product.unit_cost).
- GIVEN summary, WHEN clicked, THEN expands to full expired items list.

### Email Notifications (WH-FR-030)

#### AC-6: Daily Expiry Check Job
- GIVEN scheduled job configured, WHEN daily at 06:00 UTC, THEN job executes to check expiring inventory.
- GIVEN job execution, WHEN LPs expiring within expiry_warning_days detected, THEN notification generated.
- GIVEN job execution, WHEN LPs newly expired (expiry_date = yesterday), THEN separate alert generated.
- GIVEN job completion, WHEN successful, THEN job execution logged with results count.

#### AC-7: Email Notification to Warehouse Manager
- GIVEN expiring LPs detected by job, WHEN threshold met (>= 1 item), THEN email sent to users with warehouse_manager role.
- GIVEN email content, WHEN generated, THEN includes: org name, total expiring count, top 10 items list, link to dashboard.
- GIVEN email for expired items, WHEN generated, THEN subject includes "[URGENT]" prefix.
- GIVEN user has email_notifications disabled, WHEN email sent, THEN user excluded from recipients.

#### AC-8: Notification Settings Integration
- GIVEN warehouse_settings, WHEN expiry_alert_enabled = false, THEN no expiry emails sent.
- GIVEN warehouse_settings, WHEN expiry_alert_threshold set (e.g., 5), THEN email only sent if expiring count >= threshold.
- GIVEN user preferences, WHEN expiry_email_frequency = 'weekly', THEN user receives weekly digest instead of daily.

### Configurable Thresholds

#### AC-9: Expiry Warning Days Setting
- GIVEN warehouse_settings.expiry_warning_days = 30 (default), WHEN expiring query executed, THEN uses 30-day window.
- GIVEN admin changes expiry_warning_days to 14, WHEN saved, THEN future queries use 14-day window.
- GIVEN expiry_warning_days validation, WHEN value < 1 or > 365, THEN error "Warning days must be between 1 and 365" displays.
- GIVEN setting updated, WHEN dashboard refreshes, THEN widget reflects new threshold.

#### AC-10: Multi-Tier Threshold Configuration
- GIVEN warehouse_settings.expiry_critical_days = 7 (default), WHEN LP within this range, THEN shows red indicator.
- GIVEN warehouse_settings.expiry_warning_days_orange = 14 (default), WHEN LP within 7-14 days, THEN shows orange indicator.
- GIVEN admin adjusts thresholds, WHEN saved, THEN color coding reflects new values immediately.

### API Endpoints

#### AC-11: Expiring Inventory API
- GIVEN GET /api/warehouse/inventory/expiring, WHEN called with valid auth, THEN returns expiring LPs within warning period.
- GIVEN API response, WHEN successful, THEN includes: lp_id, lp_number, product_name, quantity, uom, expiry_date, days_until_expiry, location_code, tier (critical/warning/caution).
- GIVEN API query params, WHEN tier=critical provided, THEN filters to only red-tier items.
- GIVEN API query params, WHEN warehouse_id provided, THEN filters by specific warehouse.
- GIVEN API response, WHEN executed, THEN returns in < 300ms.

#### AC-12: Expiry Summary API
- GIVEN GET /api/warehouse/inventory/expiring/summary, WHEN called, THEN returns aggregated expiry data.
- GIVEN summary response, WHEN successful, THEN includes: expiring_count, expired_count, expiring_value, expired_value, by_tier breakdown.
- GIVEN summary, WHEN cached, THEN uses Redis with 5-minute TTL.

### Performance and Caching

#### AC-13: Performance Requirements
- GIVEN organization with 100,000+ LPs, WHEN expiring query executed, THEN returns in < 500ms.
- GIVEN expiry widget, WHEN loaded, THEN uses Redis cache with 5-minute TTL.
- GIVEN cache invalidation, WHEN LP expiry_date updated or LP status changes, THEN cache invalidated for that org.
- GIVEN database query, WHEN executed, THEN uses index on (org_id, status, expiry_date).

### Export Functionality

#### AC-14: Export Expiring Items
- GIVEN expiring items list, WHEN "Export CSV" clicked, THEN downloads CSV file with all expiring LPs.
- GIVEN CSV export, WHEN generated, THEN includes columns: LP Number, Product, SKU, Quantity, UoM, Expiry Date, Days Remaining, Location, Warehouse, Value.
- GIVEN CSV filename, WHEN generated, THEN uses format: expiring-inventory-{org_name}-{date}.csv.
- GIVEN large export (>1000 rows), WHEN generated, THEN streams response to prevent timeout.

---

## Technical Specification

### Database Schema

#### warehouse_settings extension

```sql
-- Add expiry alert settings (if not exists)
ALTER TABLE warehouse_settings ADD COLUMN IF NOT EXISTS
  expiry_alert_enabled BOOLEAN DEFAULT true;

ALTER TABLE warehouse_settings ADD COLUMN IF NOT EXISTS
  expiry_critical_days INTEGER DEFAULT 7;

ALTER TABLE warehouse_settings ADD COLUMN IF NOT EXISTS
  expiry_warning_days_orange INTEGER DEFAULT 14;

ALTER TABLE warehouse_settings ADD COLUMN IF NOT EXISTS
  expiry_alert_email_threshold INTEGER DEFAULT 1;

-- Index for expiry queries
CREATE INDEX IF NOT EXISTS idx_lp_expiry_query
  ON license_plates(org_id, status, expiry_date)
  WHERE status = 'available' AND expiry_date IS NOT NULL;
```

#### expiry_alert_logs table

```sql
CREATE TABLE IF NOT EXISTS expiry_alert_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,

  -- Alert details
  alert_type VARCHAR(20) NOT NULL, -- 'daily_summary', 'urgent_expired', 'threshold_alert'
  expiring_count INTEGER NOT NULL DEFAULT 0,
  expired_count INTEGER NOT NULL DEFAULT 0,
  expiring_value NUMERIC(15,2) DEFAULT 0,
  expired_value NUMERIC(15,2) DEFAULT 0,

  -- Notification tracking
  email_sent_to TEXT[], -- Array of email addresses
  email_sent_at TIMESTAMPTZ,

  -- Timestamps
  created_at TIMESTAMPTZ DEFAULT NOW(),

  -- Indexes
  CONSTRAINT expiry_alert_logs_org_idx UNIQUE (org_id, created_at)
);

CREATE INDEX idx_expiry_alert_logs_org ON expiry_alert_logs(org_id);
CREATE INDEX idx_expiry_alert_logs_date ON expiry_alert_logs(created_at);
```

### API Endpoints

```
# Expiry Alerts
GET    /api/warehouse/inventory/expiring              - List expiring LPs
GET    /api/warehouse/inventory/expiring/summary      - Expiry summary stats
GET    /api/warehouse/inventory/expired               - List expired LPs
GET    /api/warehouse/inventory/expiring/export       - Export to CSV

# Dashboard Integration (extends 05.7)
GET    /api/warehouse/dashboard/expiry-alerts         - Expiry widget data

# Settings (extends 05.0)
GET    /api/warehouse/settings/expiry                 - Get expiry settings
PUT    /api/warehouse/settings/expiry                 - Update expiry settings

# Admin
GET    /api/warehouse/expiry-alerts/logs              - Alert history (admin)
POST   /api/warehouse/expiry-alerts/send-test         - Send test notification (admin)
```

### Service Methods

**Location:** `lib/services/expiry-alert-service.ts`

```typescript
interface ExpiryAlertService {
  // Query methods
  getExpiringLPs(orgId: string, options?: ExpiryQueryOptions): Promise<ExpiringLP[]>;
  getExpiredLPs(orgId: string, limit?: number): Promise<ExpiredLP[]>;
  getExpirySummary(orgId: string): Promise<ExpirySummary>;

  // Alert methods
  checkExpiryAlerts(orgId: string): Promise<ExpiryCheckResult>;
  sendExpiryNotification(orgId: string, alert: ExpiryAlert): Promise<void>;

  // Scheduled job
  runDailyExpiryCheck(): Promise<JobResult>;

  // Helpers
  calculateDaysUntilExpiry(expiryDate: Date): number;
  getExpiryTier(daysRemaining: number, settings: ExpirySettings): ExpiryTier;
  calculateValueAtRisk(lps: ExpiringLP[]): number;

  // Export
  exportExpiringToCSV(orgId: string): Promise<Buffer>;
}

interface ExpiryQueryOptions {
  tier?: 'critical' | 'warning' | 'caution' | 'all';
  warehouse_id?: string;
  product_id?: string;
  limit?: number;
  offset?: number;
}

interface ExpiringLP {
  id: string;
  lp_number: string;
  product_id: string;
  product_name: string;
  product_sku: string;
  quantity: number;
  uom: string;
  expiry_date: Date;
  days_until_expiry: number;
  tier: ExpiryTier;
  location_id: string;
  location_code: string;
  warehouse_id: string;
  warehouse_name: string;
  unit_cost?: number;
  value_at_risk?: number;
}

type ExpiryTier = 'critical' | 'warning' | 'caution' | 'normal' | 'expired';

interface ExpirySummary {
  expiring_count: number;
  expired_count: number;
  expiring_value: number;
  expired_value: number;
  by_tier: {
    critical: { count: number; value: number };
    warning: { count: number; value: number };
    caution: { count: number; value: number };
  };
  by_warehouse: Array<{
    warehouse_id: string;
    warehouse_name: string;
    expiring_count: number;
    expired_count: number;
  }>;
}

interface ExpirySettings {
  expiry_warning_days: number;        // Default 30
  expiry_critical_days: number;       // Default 7 (red)
  expiry_warning_days_orange: number; // Default 14 (orange)
  expiry_alert_enabled: boolean;
  expiry_alert_email_threshold: number;
}

interface ExpiryAlert {
  org_id: string;
  alert_type: 'daily_summary' | 'urgent_expired' | 'threshold_alert';
  expiring_items: ExpiringLP[];
  expired_items: ExpiredLP[];
  recipients: string[];
}
```

### Zod Validation Schemas

**Location:** `lib/validation/expiry-alert.ts`

```typescript
import { z } from 'zod';

// Expiry tier enum
export const expiryTierSchema = z.enum(['critical', 'warning', 'caution', 'normal', 'expired']);

// Expiring LP response
export const expiringLPSchema = z.object({
  id: z.string().uuid(),
  lp_number: z.string(),
  product_id: z.string().uuid(),
  product_name: z.string(),
  product_sku: z.string().optional(),
  quantity: z.number().positive(),
  uom: z.string(),
  expiry_date: z.string().date(),
  days_until_expiry: z.number().int(),
  tier: expiryTierSchema,
  location_id: z.string().uuid(),
  location_code: z.string(),
  warehouse_id: z.string().uuid(),
  warehouse_name: z.string(),
  unit_cost: z.number().nonnegative().optional(),
  value_at_risk: z.number().nonnegative().optional(),
});

export const expiringLPListSchema = z.array(expiringLPSchema);

// Expiry summary response
export const expirySummarySchema = z.object({
  expiring_count: z.number().int().nonnegative(),
  expired_count: z.number().int().nonnegative(),
  expiring_value: z.number().nonnegative(),
  expired_value: z.number().nonnegative(),
  by_tier: z.object({
    critical: z.object({ count: z.number().int(), value: z.number() }),
    warning: z.object({ count: z.number().int(), value: z.number() }),
    caution: z.object({ count: z.number().int(), value: z.number() }),
  }),
  by_warehouse: z.array(z.object({
    warehouse_id: z.string().uuid(),
    warehouse_name: z.string(),
    expiring_count: z.number().int(),
    expired_count: z.number().int(),
  })),
});

// Query parameters
export const expiryQuerySchema = z.object({
  tier: z.enum(['critical', 'warning', 'caution', 'all']).optional(),
  warehouse_id: z.string().uuid().optional(),
  product_id: z.string().uuid().optional(),
  limit: z.coerce.number().int().min(1).max(500).default(50),
  offset: z.coerce.number().int().min(0).default(0),
});

// Expiry settings schema
export const expirySettingsSchema = z.object({
  expiry_warning_days: z.number().int().min(1).max(365).default(30),
  expiry_critical_days: z.number().int().min(1).max(30).default(7),
  expiry_warning_days_orange: z.number().int().min(1).max(60).default(14),
  expiry_alert_enabled: z.boolean().default(true),
  expiry_alert_email_threshold: z.number().int().min(0).max(100).default(1),
});

// Update settings request
export const updateExpirySettingsSchema = expirySettingsSchema.partial();
```

### Database Queries

**Expiring LPs Query:**
```sql
-- Get expiring LPs within warning period
SELECT
  lp.id,
  lp.lp_number,
  lp.product_id,
  p.name AS product_name,
  p.sku AS product_sku,
  lp.quantity,
  lp.uom,
  lp.expiry_date,
  (lp.expiry_date - CURRENT_DATE) AS days_until_expiry,
  CASE
    WHEN (lp.expiry_date - CURRENT_DATE) <= $2 THEN 'critical'
    WHEN (lp.expiry_date - CURRENT_DATE) <= $3 THEN 'warning'
    ELSE 'caution'
  END AS tier,
  lp.location_id,
  loc.code AS location_code,
  lp.warehouse_id,
  w.name AS warehouse_name,
  p.unit_cost,
  (lp.quantity * COALESCE(p.unit_cost, 0)) AS value_at_risk
FROM license_plates lp
JOIN products p ON p.id = lp.product_id
JOIN locations loc ON loc.id = lp.location_id
JOIN warehouses w ON w.id = lp.warehouse_id
WHERE lp.org_id = $1
  AND lp.status = 'available'
  AND lp.expiry_date IS NOT NULL
  AND lp.expiry_date > CURRENT_DATE
  AND lp.expiry_date <= (CURRENT_DATE + $4 * INTERVAL '1 day')
ORDER BY lp.expiry_date ASC
LIMIT $5 OFFSET $6;

-- Parameters: org_id, critical_days, orange_days, warning_days, limit, offset
```

**Expired LPs Query:**
```sql
-- Get expired LPs
SELECT
  lp.id,
  lp.lp_number,
  lp.product_id,
  p.name AS product_name,
  lp.quantity,
  lp.uom,
  lp.expiry_date,
  (CURRENT_DATE - lp.expiry_date) AS days_expired,
  lp.location_id,
  loc.code AS location_code,
  lp.warehouse_id,
  w.name AS warehouse_name,
  (lp.quantity * COALESCE(p.unit_cost, 0)) AS value_at_risk
FROM license_plates lp
JOIN products p ON p.id = lp.product_id
JOIN locations loc ON loc.id = lp.location_id
JOIN warehouses w ON w.id = lp.warehouse_id
WHERE lp.org_id = $1
  AND lp.status = 'available'
  AND lp.expiry_date IS NOT NULL
  AND lp.expiry_date < CURRENT_DATE
ORDER BY lp.expiry_date ASC
LIMIT $2;
```

**Expiry Summary Query:**
```sql
-- Get expiry summary with tier breakdown
SELECT
  COUNT(*) FILTER (WHERE expiry_date >= CURRENT_DATE) AS expiring_count,
  COUNT(*) FILTER (WHERE expiry_date < CURRENT_DATE) AS expired_count,
  COALESCE(SUM(quantity * COALESCE(unit_cost, 0)) FILTER (WHERE expiry_date >= CURRENT_DATE), 0) AS expiring_value,
  COALESCE(SUM(quantity * COALESCE(unit_cost, 0)) FILTER (WHERE expiry_date < CURRENT_DATE), 0) AS expired_value,
  COUNT(*) FILTER (WHERE expiry_date >= CURRENT_DATE AND (expiry_date - CURRENT_DATE) <= 7) AS critical_count,
  COUNT(*) FILTER (WHERE expiry_date >= CURRENT_DATE AND (expiry_date - CURRENT_DATE) > 7 AND (expiry_date - CURRENT_DATE) <= 14) AS warning_count,
  COUNT(*) FILTER (WHERE expiry_date >= CURRENT_DATE AND (expiry_date - CURRENT_DATE) > 14) AS caution_count
FROM license_plates lp
LEFT JOIN products p ON p.id = lp.product_id
WHERE lp.org_id = $1
  AND lp.status = 'available'
  AND lp.expiry_date IS NOT NULL
  AND lp.expiry_date <= (CURRENT_DATE + $2 * INTERVAL '1 day');
```

### Frontend Components

**Location:** `components/warehouse/expiry/`

```
ExpiryAlertWidget.tsx        - Dashboard widget for expiring items
ExpiryAlertPanel.tsx         - Expanded panel with full list
ExpiredInventoryPanel.tsx    - Panel for expired items
ExpiryBadge.tsx              - Color-coded expiry indicator
ExpirySettingsForm.tsx       - Settings form for thresholds
ExpiryExportButton.tsx       - CSV export button
ExpiryAlertSummary.tsx       - Summary cards (count, value)
ExpiryAlertDetailModal.tsx   - Modal for LP detail quick view
```

### Component Details

**ExpiryAlertWidget.tsx**
```tsx
interface ExpiryAlertWidgetProps {
  expiringItems: ExpiringLP[];
  expiredCount: number;
  isLoading: boolean;
  onViewAll: () => void;
  onItemClick: (lpId: string) => void;
}

// Displays:
// - Header: "Expiring Soon" with count badge
// - List of up to 10 items with ExpiryBadge
// - Each item: LP number, product name, days remaining
// - "View All (N)" link at bottom
```

**ExpiryBadge.tsx**
```tsx
interface ExpiryBadgeProps {
  daysRemaining: number;
  size?: 'sm' | 'md' | 'lg';
  showDays?: boolean;
}

// Renders:
// - Red badge (critical): "7d" or "Expires in 7 days"
// - Orange badge (warning): "12d"
// - Yellow badge (caution): "25d"
// - No badge (normal): > warning_days
// - Red "Expired" badge: < 0 days
```

### Email Template

**Location:** `lib/emails/expiry-alert-email.tsx`

```tsx
interface ExpiryAlertEmailProps {
  orgName: string;
  expiringCount: number;
  expiredCount: number;
  expiringValue: number;
  topItems: ExpiringLP[];
  dashboardUrl: string;
}

// Email content:
// Subject: "[MonoPilot] Expiry Alert: {N} items expiring soon - {OrgName}"
// Subject (urgent): "[URGENT] {N} items have expired - {OrgName}"
//
// Body:
// - Organization header
// - Summary stats (expiring count, expired count, value at risk)
// - Top 10 expiring items table
// - "View Dashboard" CTA button
// - Footer with unsubscribe link
```

### Edge Function (Scheduled Job)

**Location:** `supabase/functions/expiry-check/index.ts`

```typescript
// Runs daily at 06:00 UTC via cron
// 1. Fetch all orgs with expiry_alert_enabled = true
// 2. For each org:
//    a. Get expiring items within warning period
//    b. Get newly expired items (expiry_date = yesterday)
//    c. If count >= threshold, queue email
// 3. Log results to expiry_alert_logs
// 4. Return summary
```

### Redis Cache Configuration

```typescript
// lib/cache/expiry-cache.ts

export const EXPIRY_CACHE_KEYS = {
  EXPIRING_LIST: (orgId: string) => `warehouse:expiry:list:${orgId}`,
  EXPIRY_SUMMARY: (orgId: string) => `warehouse:expiry:summary:${orgId}`,
  EXPIRED_LIST: (orgId: string) => `warehouse:expiry:expired:${orgId}`,
};

export const EXPIRY_CACHE_TTL = {
  EXPIRING_LIST: 300,    // 5 minutes
  EXPIRY_SUMMARY: 300,   // 5 minutes
  EXPIRED_LIST: 300,     // 5 minutes
};

// Invalidation: On LP create/update/delete where expiry_date is affected
export async function invalidateExpiryCache(orgId: string): Promise<void> {
  await redis.del(EXPIRY_CACHE_KEYS.EXPIRING_LIST(orgId));
  await redis.del(EXPIRY_CACHE_KEYS.EXPIRY_SUMMARY(orgId));
  await redis.del(EXPIRY_CACHE_KEYS.EXPIRED_LIST(orgId));
}
```

---

## UI Patterns

### Expiry Widget Layout
```
+------------------------------------------+
| Expiring Soon                    [28]    |
+------------------------------------------+
| [RED]  LP00000123 - Milk Powder          |
|        Expires in 3 days                 |
|------------------------------------------+
| [ORG]  LP00000456 - Yogurt Base          |
|        Expires in 10 days                |
|------------------------------------------+
| [YEL]  LP00000789 - Cream Cheese         |
|        Expires in 22 days                |
|------------------------------------------+
|          View All (28) ->                |
+------------------------------------------+
```

### Expired Inventory Panel
```
+------------------------------------------+
| [!] Expired Inventory            [5]     |
+------------------------------------------+
| LP00000111 - Fresh Cream                 |
| Expired 2 days ago | Qty: 50 kg | $250   |
|------------------------------------------+
| LP00000222 - Butter                      |
| Expired 5 days ago | Qty: 30 kg | $180   |
|------------------------------------------+
| Total Value at Risk: $1,250              |
| [View All] [Export CSV]                  |
+------------------------------------------+
```

### Expiry Badge Styles
```
[Critical - Red]     : bg-red-100, text-red-800, border-red-300
[Warning - Orange]   : bg-orange-100, text-orange-800, border-orange-300
[Caution - Yellow]   : bg-yellow-100, text-yellow-800, border-yellow-300
[Expired - Dark Red] : bg-red-500, text-white
```

---

## Test Cases

### Unit Tests

**expiry-alert-service.test.ts**
```typescript
describe('ExpiryAlertService', () => {
  describe('calculateDaysUntilExpiry', () => {
    it('returns positive days for future expiry');
    it('returns 0 for today expiry');
    it('returns negative days for past expiry');
  });

  describe('getExpiryTier', () => {
    it('returns critical for days <= critical_days');
    it('returns warning for days <= orange_days');
    it('returns caution for days <= warning_days');
    it('returns normal for days > warning_days');
    it('returns expired for negative days');
  });

  describe('getExpiringLPs', () => {
    it('returns only available LPs with expiry_date');
    it('filters by tier when specified');
    it('filters by warehouse_id when specified');
    it('respects limit and offset');
    it('sorts by expiry_date ASC');
  });

  describe('getExpirySummary', () => {
    it('calculates correct counts per tier');
    it('calculates value at risk correctly');
    it('groups by warehouse correctly');
  });

  describe('calculateValueAtRisk', () => {
    it('sums quantity * unit_cost for all LPs');
    it('handles missing unit_cost as 0');
  });
});
```

**expiry-badge.test.tsx**
```typescript
describe('ExpiryBadge', () => {
  it('renders red badge for critical tier');
  it('renders orange badge for warning tier');
  it('renders yellow badge for caution tier');
  it('renders no badge for normal tier');
  it('renders expired badge for negative days');
  it('shows days text when showDays=true');
});
```

### Integration Tests

**expiry-api.test.ts**
```typescript
describe('Expiry API', () => {
  describe('GET /api/warehouse/inventory/expiring', () => {
    it('returns expiring LPs within warning period');
    it('filters by tier correctly');
    it('filters by warehouse_id correctly');
    it('respects pagination (limit, offset)');
    it('returns 401 for unauthenticated');
    it('enforces org isolation (RLS)');
  });

  describe('GET /api/warehouse/inventory/expiring/summary', () => {
    it('returns correct summary counts');
    it('returns correct value calculations');
    it('uses cache on second request');
    it('returns fresh data after cache invalidation');
  });

  describe('GET /api/warehouse/inventory/expiring/export', () => {
    it('returns CSV file with correct headers');
    it('includes all expiring items');
    it('handles large datasets without timeout');
  });
});
```

### E2E Tests

**expiry-dashboard.spec.ts**
```typescript
describe('Expiry Alerts Dashboard', () => {
  it('displays expiring soon widget with items');
  it('shows correct color coding for tiers');
  it('navigates to LP detail on item click');
  it('expands to full list on View All click');
  it('displays expired inventory panel');
  it('exports CSV on export button click');
  it('updates when threshold settings changed');
});
```

---

## Deliverables

### Database
- [ ] Migration: warehouse_settings expiry columns (if not exist)
- [ ] Migration: expiry_alert_logs table
- [ ] Index: idx_lp_expiry_query on license_plates

### API Routes
- [ ] `GET /api/warehouse/inventory/expiring` - List expiring LPs
- [ ] `GET /api/warehouse/inventory/expiring/summary` - Summary stats
- [ ] `GET /api/warehouse/inventory/expired` - List expired LPs
- [ ] `GET /api/warehouse/inventory/expiring/export` - CSV export
- [ ] `GET /api/warehouse/dashboard/expiry-alerts` - Widget data
- [ ] `GET /api/warehouse/settings/expiry` - Get settings
- [ ] `PUT /api/warehouse/settings/expiry` - Update settings

### Services
- [ ] `lib/services/expiry-alert-service.ts` - Expiry alert business logic
- [ ] `lib/cache/expiry-cache.ts` - Cache configuration

### Validation
- [ ] `lib/validation/expiry-alert.ts` - Zod schemas

### Frontend Components
- [ ] `ExpiryAlertWidget.tsx` - Dashboard widget
- [ ] `ExpiryAlertPanel.tsx` - Expanded list panel
- [ ] `ExpiredInventoryPanel.tsx` - Expired items panel
- [ ] `ExpiryBadge.tsx` - Color-coded indicator
- [ ] `ExpirySettingsForm.tsx` - Settings form
- [ ] `ExpiryExportButton.tsx` - CSV export
- [ ] `ExpiryAlertSummary.tsx` - Summary cards

### Edge Function
- [ ] `supabase/functions/expiry-check/index.ts` - Daily job

### Email Template
- [ ] `lib/emails/expiry-alert-email.tsx` - Notification template

### Tests
- [ ] Unit tests (service, components)
- [ ] Integration tests (API routes)
- [ ] E2E tests (dashboard flow)

---

## Definition of Done

- [ ] Expiring Soon widget displays on warehouse dashboard
- [ ] Multi-tier color coding (red/orange/yellow) works correctly
- [ ] Days until expiry calculated and displayed accurately
- [ ] Expired inventory panel shows items past expiry
- [ ] Value at risk calculated (qty * unit_cost)
- [ ] Click-through navigation to LP detail works
- [ ] CSV export generates correct file
- [ ] Expiry settings configurable (warning days, thresholds)
- [ ] API endpoints return data in < 300ms
- [ ] Redis caching with 5-min TTL implemented
- [ ] Cache invalidated on LP expiry_date changes
- [ ] Daily scheduled job executes at 06:00 UTC
- [ ] Email notifications sent to warehouse managers
- [ ] Email threshold setting respected
- [ ] RLS policies enforce org isolation
- [ ] Unit test coverage >= 80%
- [ ] Integration tests pass
- [ ] E2E tests pass
- [ ] Performance verified with 10K+ LPs

---

## Future Phases (Not in This Story)

### Phase 2B - Enhanced Expiry Management
- Product-level expiry threshold overrides
- Expiry forecast report (trend analysis)
- Bulk disposition actions (mark all expired as blocked)
- Custom tier definitions (user-defined thresholds)

### Phase 3 - Automation
- Auto-block expired LPs (configurable)
- SMS/push notifications
- Supplier expiry notifications
- Integration with disposal workflow

### Phase 4 - Analytics
- Expiry trend charts (daily/weekly/monthly)
- Waste reduction KPIs
- FEFO compliance metrics
- Predictive expiry alerts (ML-based)

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-01-15 | Initial story creation | ARCHITECT-AGENT |
