# 05.24 - Catch Weight Support

**Story ID:** 05.24
**Epic:** 05 - Warehouse
**Phase:** 2 (Advanced Features)
**Complexity:** M (Medium)
**Estimate:** 3-4 days
**Priority:** P2
**Type:** Backend + Frontend

**Primary PRD:** `docs/1-BASELINE/product/modules/warehouse.md` (WH-FR-021)

---

## PRD References

| FR ID | Requirement | Priority | Phase | Covered |
|-------|-------------|----------|-------|---------|
| WH-FR-021 | Catch Weight Support | P1 | 2 | Full |

---

## User Story

**As a** warehouse operator handling variable weight products (meat, cheese, fish),
**I want** to capture actual weight per LP during receipt and consumption,
**So that** I can track true inventory value and ensure production uses accurate weight-based quantities.

**As a** production manager,
**I want** the system to calculate pieces needed based on actual catch weight,
**So that** material consumption is accurate for weight-based BOM requirements.

---

## Goal

Implement comprehensive catch weight support for variable weight products. Enable weight capture during receipt, display both quantity (units) and weight for catch weight products, validate weight against tolerance ranges, calculate average weights, and support weight-based consumption calculations for production.

---

## Scope

**In scope:**
- Product configuration for catch weight (is_catch_weight, target_weight_kg, weight_tolerance_pct)
- Weight capture during LP creation/GRN receipt
- Weight tolerance validation with warnings
- Display qty + catch_weight_kg for catch weight products
- Average weight calculation per unit
- Weight-based consumption calculation for production
- Catch weight validation (required for catch weight products)
- Scale integration API for weight capture
- Catch weight reporting and analytics

**Out of scope:**
- Hardware scale drivers/integration (out of scope - API ready for integration)
- Automatic scale reading via hardware (future story)
- Price calculation based on actual weight (Finance module)
- GS1 weight parsing from barcode (separate story 05.21)

---

## Dependencies

| Story | Requirement | Status |
|-------|-------------|--------|
| 05.1 | LP Table (catch_weight_kg field) | Required |
| 02.1 | Products CRUD (is_catch_weight, target_weight_kg fields) | Required |
| 05.0 | Warehouse Settings (enable_catch_weight) | Required |
| 05.10 | GRN CRUD (catch_weight_kg in grn_items) | Required |

---

## Acceptance Criteria (Given/When/Then)

### Product Configuration (WH-FR-021)

#### Enable Catch Weight on Product
- GIVEN user editing product with category "Meat" or "Cheese", WHEN toggle `is_catch_weight` enabled, THEN additional fields display: `target_weight_kg`, `weight_tolerance_pct`.
- GIVEN product with `is_catch_weight = true`, WHEN `target_weight_kg` not set, THEN warning "Target weight recommended for tolerance validation" displays.
- GIVEN product with `is_catch_weight = true` and `target_weight_kg = 0.5`, WHEN `weight_tolerance_pct = 10`, THEN acceptable range is 0.45 - 0.55 kg.

#### Warehouse Setting
- GIVEN warehouse_settings.enable_catch_weight = false, WHEN user attempts to create LP with catch_weight_kg, THEN field ignored (not stored).
- GIVEN warehouse_settings.enable_catch_weight = true, WHEN creating LP for catch weight product, THEN system prompts for weight entry.

### Receipt Flow (WH-FR-021)

#### Weight Entry Required
- GIVEN product.is_catch_weight = true, WHEN creating LP via GRN without catch_weight_kg, THEN system returns 400 error "Catch weight required for this product".
- GIVEN product.is_catch_weight = false, WHEN creating LP with catch_weight_kg, THEN weight stored (optional field for non-catch-weight products).

#### Weight Tolerance Validation
- GIVEN product with target_weight_kg = 0.5, weight_tolerance_pct = 10, WHEN LP created with qty = 10, catch_weight_kg = 5.2, THEN avg weight = 0.52 kg/unit, within tolerance (0.45-0.55), no warning.
- GIVEN product with target_weight_kg = 0.5, weight_tolerance_pct = 10, WHEN LP created with qty = 10, catch_weight_kg = 6.5, THEN avg weight = 0.65 kg/unit, OUTSIDE tolerance, warning "Weight outside tolerance range (0.45-0.55 kg/unit, actual: 0.65 kg/unit)".
- GIVEN weight outside tolerance warning, WHEN user confirms, THEN LP created with warning logged in audit.
- GIVEN weight outside tolerance, WHEN tolerance enforcement is strict (future setting), THEN LP creation blocked.

#### Scale Integration API
- GIVEN scale API endpoint called with scale_id, WHEN scale returns weight reading, THEN weight auto-populated in form field.
- GIVEN scale not responding within 5 seconds, WHEN timeout occurs, THEN "Scale not responding - enter weight manually" message displays.
- GIVEN scale returns invalid reading (negative, zero, >9999), WHEN validation runs, THEN "Invalid scale reading" error displays.

### LP Display (WH-FR-021)

#### Catch Weight Products
- GIVEN LP with catch_weight_kg = 4.87 and qty = 10, WHEN displayed in LP list, THEN shows "10 EA (4.87 kg)" format.
- GIVEN LP with catch_weight_kg = 4.87 and qty = 10, WHEN displayed in LP detail, THEN shows: Quantity = 10 EA, Total Weight = 4.87 kg, Avg Weight = 0.487 kg/unit.
- GIVEN LP without catch_weight_kg (not a catch weight product), WHEN displayed, THEN shows only quantity without weight.

#### Average Weight Calculation
- GIVEN LP with qty = 10, catch_weight_kg = 4.87, WHEN avg_weight calculated, THEN avg_weight = 4.87 / 10 = 0.487 kg/unit.
- GIVEN LP with qty = 0 (consumed), WHEN avg_weight requested, THEN returns last known avg_weight or null.

### Consumption Calculation (WH-FR-021)

#### Weight-Based BOM Consumption
- GIVEN BOM requires 5 kg of ingredient, WHEN LP has catch_weight_kg = 4.87, qty = 10, THEN system calculates: need 5 kg, LP has 4.87 kg total, must consume full LP (all 10 pieces).
- GIVEN BOM requires 2.5 kg, WHEN LP has catch_weight_kg = 4.87, qty = 10 (avg 0.487 kg/unit), THEN system calculates: need ~5.13 pieces, round up to 6 pieces = 2.92 kg consumed.

#### Full LP Consumption (Catch Weight)
- GIVEN LP with qty = 10, catch_weight_kg = 4.87, WHEN consuming full LP, THEN consumed_qty = 10, consumed_weight = 4.87 kg.
- GIVEN full LP consumption, WHEN material consumption recorded, THEN consumption records both qty and weight consumed.

#### Partial LP Consumption (Catch Weight)
- GIVEN LP with qty = 10, catch_weight_kg = 4.87 (avg 0.487 kg/unit), WHEN consuming 6 pieces, THEN consumed_weight = 6 * 0.487 = 2.92 kg (calculated from avg).
- GIVEN partial consumption, WHEN LP updated, THEN remaining_qty = 4, remaining_weight = 4.87 - 2.92 = 1.95 kg.
- GIVEN partial consumption, WHEN LP split required (different location), THEN new LP created with consumed qty/weight, original LP reduced.

### Scanner Workflow

#### Scanner Weight Entry
- GIVEN scanner receive mode for catch weight product, WHEN product scanned, THEN weight entry field prominently displayed with large numeric keypad.
- GIVEN scanner with scale integration enabled, WHEN "Read Scale" button pressed, THEN current weight from connected scale populates field.
- GIVEN scanner weight entry, WHEN weight entered manually, THEN system validates and shows tolerance check result.

### Reporting

#### Catch Weight Analytics
- GIVEN catch weight products, WHEN average weight report requested, THEN shows avg weight by product, batch, time period.
- GIVEN historical LP data, WHEN weight variance report requested, THEN shows products consistently over/under target weight.
- GIVEN inventory summary, WHEN catch weight products included, THEN total shows both units and kg.

### Multi-tenancy

- GIVEN User A from Org A, WHEN querying catch weight LPs, THEN only Org A LPs returned.
- GIVEN cross-org LP access attempt, WHEN API called, THEN 404 Not Found returned.

---

## Technical Specification

### Database Schema Changes

#### Products Table Extension

```sql
-- Add catch weight fields to products table
ALTER TABLE products ADD COLUMN IF NOT EXISTS
  is_catch_weight BOOLEAN DEFAULT false;

ALTER TABLE products ADD COLUMN IF NOT EXISTS
  target_weight_kg DECIMAL(10,3) CHECK (target_weight_kg IS NULL OR target_weight_kg > 0);

ALTER TABLE products ADD COLUMN IF NOT EXISTS
  weight_tolerance_pct DECIMAL(5,2) DEFAULT 10 CHECK (weight_tolerance_pct >= 0 AND weight_tolerance_pct <= 100);

COMMENT ON COLUMN products.is_catch_weight IS 'Product has variable weight per unit (e.g., meat, cheese)';
COMMENT ON COLUMN products.target_weight_kg IS 'Target weight per unit in kg for tolerance validation';
COMMENT ON COLUMN products.weight_tolerance_pct IS 'Acceptable weight variance percentage (+/-)';
```

#### Warehouse Settings Extension

```sql
-- Add catch weight setting to warehouse_settings
ALTER TABLE warehouse_settings ADD COLUMN IF NOT EXISTS
  enable_catch_weight BOOLEAN DEFAULT false;

ALTER TABLE warehouse_settings ADD COLUMN IF NOT EXISTS
  catch_weight_tolerance_enforcement TEXT DEFAULT 'warn'
    CHECK (catch_weight_tolerance_enforcement IN ('none', 'warn', 'block'));

COMMENT ON COLUMN warehouse_settings.enable_catch_weight IS 'Enable catch weight functionality';
COMMENT ON COLUMN warehouse_settings.catch_weight_tolerance_enforcement IS 'How to handle weight outside tolerance: none (ignore), warn (allow with warning), block (prevent)';
```

#### Scale Configuration Table (New)

```sql
-- Scale configuration for weight capture integration
CREATE TABLE scales (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,

  -- Identity
  scale_code VARCHAR(50) NOT NULL,
  scale_name VARCHAR(255) NOT NULL,

  -- Connection
  connection_type VARCHAR(20) NOT NULL DEFAULT 'api'
    CHECK (connection_type IN ('api', 'serial', 'usb', 'network')),
  connection_string TEXT, -- IP:port for network, COM port for serial, etc.
  api_endpoint TEXT, -- External API URL for weight reading

  -- Configuration
  uom VARCHAR(10) NOT NULL DEFAULT 'KG',
  precision INTEGER NOT NULL DEFAULT 3 CHECK (precision >= 0 AND precision <= 6),
  min_weight DECIMAL(10,3) DEFAULT 0.001,
  max_weight DECIMAL(10,3) DEFAULT 9999,
  tare_weight DECIMAL(10,3) DEFAULT 0,

  -- Assignment
  warehouse_id UUID REFERENCES warehouses(id),
  location_id UUID REFERENCES locations(id),

  -- Status
  is_active BOOLEAN DEFAULT true,
  last_reading_at TIMESTAMPTZ,
  last_reading_kg DECIMAL(10,3),

  -- Audit
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),

  -- Constraints
  CONSTRAINT scales_org_code_unique UNIQUE(org_id, scale_code)
);

-- Indexes
CREATE INDEX idx_scales_org ON scales(org_id);
CREATE INDEX idx_scales_warehouse ON scales(warehouse_id) WHERE warehouse_id IS NOT NULL;
CREATE INDEX idx_scales_active ON scales(is_active) WHERE is_active = true;

-- RLS
ALTER TABLE scales ENABLE ROW LEVEL SECURITY;

CREATE POLICY "scales_org_select" ON scales
FOR SELECT TO authenticated
USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

CREATE POLICY "scales_org_insert" ON scales
FOR INSERT TO authenticated
WITH CHECK (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

CREATE POLICY "scales_org_update" ON scales
FOR UPDATE TO authenticated
USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

CREATE POLICY "scales_org_delete" ON scales
FOR DELETE TO authenticated
USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));
```

#### Weight History Table (New)

```sql
-- Track weight readings for audit and analytics
CREATE TABLE weight_readings (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,

  -- Source
  scale_id UUID REFERENCES scales(id),
  lp_id UUID REFERENCES license_plates(id),
  grn_item_id UUID, -- FK to grn_items when available

  -- Reading
  weight_kg DECIMAL(10,3) NOT NULL,
  uom VARCHAR(10) NOT NULL DEFAULT 'KG',

  -- Context
  reading_type VARCHAR(20) NOT NULL
    CHECK (reading_type IN ('receipt', 'verification', 'adjustment', 'manual')),
  product_id UUID REFERENCES products(id),
  qty_units INTEGER,
  avg_weight_kg DECIMAL(10,3),

  -- Tolerance Check
  target_weight_kg DECIMAL(10,3),
  weight_tolerance_pct DECIMAL(5,2),
  is_within_tolerance BOOLEAN,
  variance_pct DECIMAL(5,2),

  -- Audit
  recorded_by UUID REFERENCES users(id),
  recorded_at TIMESTAMPTZ DEFAULT NOW(),
  notes TEXT
);

-- Indexes
CREATE INDEX idx_weight_readings_org ON weight_readings(org_id);
CREATE INDEX idx_weight_readings_lp ON weight_readings(lp_id) WHERE lp_id IS NOT NULL;
CREATE INDEX idx_weight_readings_product ON weight_readings(product_id) WHERE product_id IS NOT NULL;
CREATE INDEX idx_weight_readings_date ON weight_readings(recorded_at);

-- RLS
ALTER TABLE weight_readings ENABLE ROW LEVEL SECURITY;

CREATE POLICY "weight_readings_org" ON weight_readings
FOR ALL TO authenticated
USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));
```

### API Endpoints

```
# Catch Weight Operations
POST   /api/warehouse/catch-weight/validate          - Validate weight against tolerance
POST   /api/warehouse/catch-weight/calculate-consumption - Calculate consumption for weight-based BOM

# Scale Management
GET    /api/warehouse/scales                         - List scales
GET    /api/warehouse/scales/:id                     - Get scale detail
POST   /api/warehouse/scales                         - Create scale
PUT    /api/warehouse/scales/:id                     - Update scale
DELETE /api/warehouse/scales/:id                     - Delete scale
POST   /api/warehouse/scales/:id/read                - Read weight from scale
POST   /api/warehouse/scales/:id/tare                - Tare scale

# Weight Readings
GET    /api/warehouse/weight-readings                - List weight readings
GET    /api/warehouse/weight-readings/stats          - Weight statistics by product
```

### Service Methods

**Location:** `lib/services/catch-weight-service.ts`

```typescript
export interface CatchWeightValidation {
  isValid: boolean;
  isWithinTolerance: boolean;
  avgWeightKg: number;
  targetWeightKg: number | null;
  tolerancePct: number | null;
  minWeightKg: number | null;
  maxWeightKg: number | null;
  variancePct: number | null;
  warnings: string[];
  errors: string[];
}

export interface ConsumptionCalculation {
  requiredWeightKg: number;
  availableWeightKg: number;
  avgWeightPerUnit: number;
  unitsToConsume: number;
  actualWeightToConsume: number;
  remainingUnits: number;
  remainingWeightKg: number;
  isFullConsumption: boolean;
  needsSplit: boolean;
}

export interface WeightReading {
  scaleId: string;
  weightKg: number;
  uom: string;
  timestamp: string;
  isStable: boolean;
}

export class CatchWeightService {
  /**
   * Validate catch weight against product tolerance
   */
  static async validateWeight(
    productId: string,
    qty: number,
    catchWeightKg: number
  ): Promise<CatchWeightValidation>;

  /**
   * Calculate consumption for weight-based BOM requirement
   */
  static async calculateConsumption(
    lpId: string,
    requiredWeightKg: number
  ): Promise<ConsumptionCalculation>;

  /**
   * Record weight reading for audit trail
   */
  static async recordWeightReading(input: {
    scaleId?: string;
    lpId?: string;
    grnItemId?: string;
    weightKg: number;
    readingType: 'receipt' | 'verification' | 'adjustment' | 'manual';
    productId: string;
    qtyUnits: number;
    notes?: string;
  }): Promise<void>;

  /**
   * Get average weight statistics for product
   */
  static async getProductWeightStats(
    productId: string,
    options?: {
      dateFrom?: string;
      dateTo?: string;
      batchNumber?: string;
    }
  ): Promise<{
    avgWeightKg: number;
    minWeightKg: number;
    maxWeightKg: number;
    stdDeviation: number;
    sampleCount: number;
    withinTolerancePct: number;
  }>;

  /**
   * Check if product requires catch weight
   */
  static async requiresCatchWeight(productId: string): Promise<boolean>;

  /**
   * Format weight display string
   */
  static formatWeightDisplay(qty: number, catchWeightKg: number | null, uom: string): string;
}
```

**Location:** `lib/services/scale-service.ts`

```typescript
export interface Scale {
  id: string;
  org_id: string;
  scale_code: string;
  scale_name: string;
  connection_type: 'api' | 'serial' | 'usb' | 'network';
  connection_string: string | null;
  api_endpoint: string | null;
  uom: string;
  precision: number;
  min_weight: number;
  max_weight: number;
  tare_weight: number;
  warehouse_id: string | null;
  location_id: string | null;
  is_active: boolean;
  last_reading_at: string | null;
  last_reading_kg: number | null;
}

export class ScaleService {
  /**
   * List scales for organization
   */
  static async list(params?: {
    warehouseId?: string;
    isActive?: boolean;
  }): Promise<Scale[]>;

  /**
   * Get scale by ID
   */
  static async getById(id: string): Promise<Scale | null>;

  /**
   * Create scale configuration
   */
  static async create(data: Omit<Scale, 'id' | 'org_id' | 'last_reading_at' | 'last_reading_kg'>): Promise<Scale>;

  /**
   * Update scale configuration
   */
  static async update(id: string, data: Partial<Scale>): Promise<Scale>;

  /**
   * Delete scale
   */
  static async delete(id: string): Promise<void>;

  /**
   * Read current weight from scale
   * @throws Error if scale not responding or invalid reading
   */
  static async readWeight(scaleId: string): Promise<WeightReading>;

  /**
   * Tare scale (set current weight as zero reference)
   */
  static async tare(scaleId: string): Promise<void>;

  /**
   * Get scales by warehouse/location
   */
  static async getByLocation(warehouseId: string, locationId?: string): Promise<Scale[]>;
}
```

### Zod Validation Schemas

**Location:** `lib/validation/catch-weight.ts`

```typescript
import { z } from 'zod';

// Product catch weight configuration
export const productCatchWeightSchema = z.object({
  is_catch_weight: z.boolean().default(false),
  target_weight_kg: z.number()
    .positive("Target weight must be positive")
    .max(9999, "Target weight too large")
    .nullable()
    .optional(),
  weight_tolerance_pct: z.number()
    .min(0, "Tolerance cannot be negative")
    .max(100, "Tolerance cannot exceed 100%")
    .default(10),
});

// Catch weight validation request
export const validateCatchWeightSchema = z.object({
  product_id: z.string().uuid("Invalid product ID"),
  qty: z.number().positive("Quantity must be positive"),
  catch_weight_kg: z.number().positive("Weight must be positive"),
});

// Weight entry for LP/GRN
export const catchWeightEntrySchema = z.object({
  catch_weight_kg: z.number()
    .positive("Weight must be positive")
    .max(99999, "Weight too large"),
  qty: z.number().positive("Quantity must be positive"),
  scale_id: z.string().uuid().optional(),
  tare_weight_kg: z.number().min(0).optional(),
});

// Consumption calculation request
export const consumptionCalculationSchema = z.object({
  lp_id: z.string().uuid("Invalid LP ID"),
  required_weight_kg: z.number().positive("Required weight must be positive"),
});

// Scale configuration
export const scaleSchema = z.object({
  scale_code: z.string()
    .min(1, "Scale code required")
    .max(50, "Scale code max 50 characters"),
  scale_name: z.string()
    .min(1, "Scale name required")
    .max(255, "Scale name max 255 characters"),
  connection_type: z.enum(['api', 'serial', 'usb', 'network']).default('api'),
  connection_string: z.string().max(500).nullable().optional(),
  api_endpoint: z.string().url("Invalid API endpoint URL").nullable().optional(),
  uom: z.string().max(10).default('KG'),
  precision: z.number().int().min(0).max(6).default(3),
  min_weight: z.number().min(0).default(0.001),
  max_weight: z.number().positive().default(9999),
  tare_weight: z.number().min(0).default(0),
  warehouse_id: z.string().uuid().nullable().optional(),
  location_id: z.string().uuid().nullable().optional(),
  is_active: z.boolean().default(true),
});

// Weight reading record
export const weightReadingSchema = z.object({
  scale_id: z.string().uuid().optional(),
  lp_id: z.string().uuid().optional(),
  grn_item_id: z.string().uuid().optional(),
  weight_kg: z.number().positive("Weight must be positive"),
  reading_type: z.enum(['receipt', 'verification', 'adjustment', 'manual']),
  product_id: z.string().uuid("Invalid product ID"),
  qty_units: z.number().int().positive(),
  notes: z.string().max(500).optional(),
});

export type ProductCatchWeight = z.infer<typeof productCatchWeightSchema>;
export type ValidateCatchWeightInput = z.infer<typeof validateCatchWeightSchema>;
export type CatchWeightEntry = z.infer<typeof catchWeightEntrySchema>;
export type ConsumptionCalculationInput = z.infer<typeof consumptionCalculationSchema>;
export type ScaleInput = z.infer<typeof scaleSchema>;
export type WeightReadingInput = z.infer<typeof weightReadingSchema>;
```

---

## UI Components

### Pages

- `app/(authenticated)/settings/warehouse/scales/page.tsx` - Scale management

### Components

**Location:** `components/warehouse/catch-weight/`

```
CatchWeightInput.tsx         - Weight entry field with scale integration
CatchWeightDisplay.tsx       - Display qty + weight format
CatchWeightBadge.tsx         - Inline badge showing weight
WeightToleranceIndicator.tsx - Visual tolerance range indicator
ScaleReadButton.tsx          - Button to read from connected scale
CatchWeightCalculator.tsx    - Calculate pieces from weight requirement
ProductWeightStats.tsx       - Average weight statistics display
```

**Location:** `components/settings/scales/`

```
ScalesList.tsx               - List of configured scales
ScaleForm.tsx                - Create/edit scale form
ScaleTestButton.tsx          - Test scale connection
```

### Component Details

**CatchWeightInput.tsx**
```tsx
interface CatchWeightInputProps {
  productId: string;
  qty: number;
  value: number | null;
  onChange: (weight: number | null) => void;
  scaleId?: string;
  showTolerance?: boolean;
  disabled?: boolean;
}

// Features:
// - Large numeric input field
// - "Read Scale" button (if scaleId provided)
// - Real-time tolerance validation
// - Displays target weight and acceptable range
// - Warning/error indicators for out-of-tolerance
```

**CatchWeightDisplay.tsx**
```tsx
interface CatchWeightDisplayProps {
  qty: number;
  catchWeightKg: number | null;
  uom: string;
  showAverage?: boolean;
}

// Renders:
// - "10 EA (4.87 kg)" for catch weight products
// - "10 EA" for non-catch-weight products
// - Optional: "Avg: 0.487 kg/unit"
```

**WeightToleranceIndicator.tsx**
```tsx
interface WeightToleranceIndicatorProps {
  actualWeight: number;
  targetWeight: number;
  tolerancePct: number;
  qty: number;
}

// Renders:
// - Green bar for within tolerance
// - Yellow bar for approaching tolerance limit
// - Red bar for outside tolerance
// - Shows min-target-max range
```

### UI Patterns

**Weight Entry Form:**
```
+------------------------------------------+
| Catch Weight Entry                        |
|                                           |
| Quantity: [____10____] EA                 |
|                                           |
| Total Weight: [___4.87___] kg  [Read Scale]|
|                                           |
| Target: 0.50 kg/unit (+-10%)              |
| Range: 0.45 - 0.55 kg/unit                |
|                                           |
| Calculated: 0.487 kg/unit   [OK]          |
+------------------------------------------+
```

**Tolerance Indicator:**
```
Min         Target         Max
0.45 -------- 0.50 -------- 0.55
        [====|====]
        Actual: 0.487
           [Within tolerance]
```

**LP Display (Catch Weight):**
```
+------------------------------------------+
| LP-00001234                               |
| Product: Beef Ribeye Steak                |
+------------------------------------------+
| Quantity     | 10 EA                      |
| Total Weight | 4.87 kg                    |
| Avg Weight   | 0.487 kg/unit              |
| Target       | 0.50 kg/unit (+/-10%)      |
+------------------------------------------+
```

---

## Test Cases

### Unit Tests

**catch-weight-service.test.ts**
```typescript
describe('CatchWeightService', () => {
  describe('validateWeight', () => {
    it('returns valid for weight within tolerance');
    it('returns warning for weight outside tolerance');
    it('calculates correct average weight');
    it('handles zero quantity gracefully');
    it('handles null target weight (no tolerance check)');
  });

  describe('calculateConsumption', () => {
    it('calculates full LP consumption correctly');
    it('calculates partial consumption based on avg weight');
    it('rounds up pieces for weight requirement');
    it('identifies when split is needed');
    it('handles exact weight match');
  });

  describe('formatWeightDisplay', () => {
    it('formats catch weight products as "10 EA (4.87 kg)"');
    it('formats non-catch-weight as "10 EA"');
    it('handles null catch weight');
  });
});
```

**scale-service.test.ts**
```typescript
describe('ScaleService', () => {
  describe('readWeight', () => {
    it('returns weight reading from API scale');
    it('applies tare weight correctly');
    it('throws on scale timeout');
    it('throws on invalid reading (negative)');
    it('throws on reading outside min/max');
  });

  describe('tare', () => {
    it('updates tare weight on scale');
    it('records tare in audit log');
  });
});
```

### Integration Tests

**catch-weight-api.test.ts**
```typescript
describe('Catch Weight API', () => {
  describe('POST /api/warehouse/catch-weight/validate', () => {
    it('validates weight within tolerance returns isWithinTolerance=true');
    it('validates weight outside tolerance returns warnings');
    it('returns 400 for invalid product_id');
    it('returns 400 for negative weight');
  });

  describe('POST /api/warehouse/catch-weight/calculate-consumption', () => {
    it('calculates consumption for weight requirement');
    it('returns 404 for invalid LP');
    it('returns 400 for LP without catch weight');
  });

  describe('POST /api/warehouse/license-plates', () => {
    it('creates LP with catch weight for catch weight product');
    it('returns 400 when catch weight missing for catch weight product');
    it('accepts LP without catch weight for non-catch-weight product');
  });
});
```

**scales-api.test.ts**
```typescript
describe('Scales API', () => {
  describe('GET /api/warehouse/scales', () => {
    it('returns scales for organization');
    it('filters by warehouse_id');
    it('filters by is_active');
  });

  describe('POST /api/warehouse/scales/:id/read', () => {
    it('returns weight reading from scale');
    it('returns 404 for invalid scale_id');
    it('returns 503 when scale not responding');
  });
});
```

### E2E Tests

**catch-weight.spec.ts**
```typescript
describe('Catch Weight', () => {
  it('displays weight entry for catch weight product during GRN');
  it('shows tolerance warning when weight outside range');
  it('displays qty and weight in LP list');
  it('shows average weight in LP detail');
  it('allows manual weight entry when scale unavailable');
});
```

---

## Security Considerations

1. **Scale API Security**
   - Scale API endpoints require authentication
   - Scale access restricted to assigned warehouse users
   - Weight readings logged for audit trail

2. **Data Validation**
   - Server-side validation of all weight inputs
   - Prevent negative weights
   - Maximum weight limits enforced

3. **Audit Trail**
   - All weight readings recorded with user, timestamp
   - Tolerance override decisions logged
   - Scale configuration changes audited

---

## Deliverables

### Database
- [ ] Migration: Products table catch weight columns
- [ ] Migration: Warehouse settings catch weight columns
- [ ] Migration: Scales table
- [ ] Migration: Weight readings table
- [ ] RLS policies for scales and weight_readings

### API Routes
- [ ] `POST /api/warehouse/catch-weight/validate`
- [ ] `POST /api/warehouse/catch-weight/calculate-consumption`
- [ ] `GET /api/warehouse/scales`
- [ ] `GET /api/warehouse/scales/:id`
- [ ] `POST /api/warehouse/scales`
- [ ] `PUT /api/warehouse/scales/:id`
- [ ] `DELETE /api/warehouse/scales/:id`
- [ ] `POST /api/warehouse/scales/:id/read`
- [ ] `POST /api/warehouse/scales/:id/tare`
- [ ] `GET /api/warehouse/weight-readings`
- [ ] `GET /api/warehouse/weight-readings/stats`

### Services
- [ ] `CatchWeightService.validateWeight()`
- [ ] `CatchWeightService.calculateConsumption()`
- [ ] `CatchWeightService.recordWeightReading()`
- [ ] `CatchWeightService.getProductWeightStats()`
- [ ] `CatchWeightService.requiresCatchWeight()`
- [ ] `CatchWeightService.formatWeightDisplay()`
- [ ] `ScaleService.list()`
- [ ] `ScaleService.getById()`
- [ ] `ScaleService.create()`
- [ ] `ScaleService.update()`
- [ ] `ScaleService.delete()`
- [ ] `ScaleService.readWeight()`
- [ ] `ScaleService.tare()`

### Validation
- [ ] `productCatchWeightSchema`
- [ ] `validateCatchWeightSchema`
- [ ] `catchWeightEntrySchema`
- [ ] `consumptionCalculationSchema`
- [ ] `scaleSchema`
- [ ] `weightReadingSchema`

### Frontend
- [ ] CatchWeightInput component
- [ ] CatchWeightDisplay component
- [ ] CatchWeightBadge component
- [ ] WeightToleranceIndicator component
- [ ] ScaleReadButton component
- [ ] CatchWeightCalculator component
- [ ] ProductWeightStats component
- [ ] Scales management page
- [ ] ScalesList component
- [ ] ScaleForm component
- [ ] Integration with LP list (show weight)
- [ ] Integration with GRN form (weight entry)

### Tests
- [ ] Unit tests: CatchWeightService (>80% coverage)
- [ ] Unit tests: ScaleService (>80% coverage)
- [ ] Integration tests: All API endpoints
- [ ] RLS tests: Multi-tenancy isolation
- [ ] E2E: Weight entry during receipt
- [ ] E2E: LP display with weight

---

## Definition of Done

- [ ] Products can be configured as catch weight with target weight and tolerance
- [ ] LP creation requires catch_weight_kg for catch weight products
- [ ] Weight tolerance validation with configurable enforcement (warn/block)
- [ ] LP list displays "qty EA (X.XX kg)" format for catch weight products
- [ ] LP detail shows quantity, total weight, and average weight per unit
- [ ] Consumption calculation works for weight-based BOM requirements
- [ ] Scale configuration CRUD functional
- [ ] Scale weight reading API functional (mock implementation)
- [ ] Weight readings recorded for audit trail
- [ ] Weight statistics available by product
- [ ] Multi-tenancy enforced via RLS
- [ ] Unit test coverage >80%
- [ ] Integration tests pass
- [ ] E2E tests pass

---

## Risk Assessment

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Scale hardware integration complexity | MEDIUM | HIGH | Provide API-ready interface, defer hardware drivers |
| Weight calculation precision errors | HIGH | MEDIUM | Use DECIMAL types, round consistently |
| Performance with many weight readings | LOW | LOW | Partition weight_readings by date if needed |
| Tolerance enforcement confusion | MEDIUM | MEDIUM | Clear UI indicators, configurable enforcement |

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2026-01-15 | Initial story creation | ARCHITECT-AGENT |
