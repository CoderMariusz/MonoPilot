# 05.11 - GRN from PO (Create LPs)

| Field | Value |
|-------|-------|
| **Story ID** | 05.11 |
| **Epic** | 05 - Warehouse |
| **Status** | Ready |
| **Phase** | Phase 1 (Goods Receipt) |
| **Priority** | P1 |
| **Complexity** | L (Large) |
| **Estimate** | 4-5 days |
| **Type** | Backend + Frontend |
| **Model** | OPUS |

---

## PRD References

| FR ID | Requirement | Priority | Coverage |
|-------|-------------|----------|----------|
| WH-FR-003 | GRN from PO (receive goods, create GRN + LPs) | P0 | Full |
| WH-FR-001 | LP Creation (auto/manual numbering) | P0 | Integrated |
| WH-FR-009 | Batch Tracking (entry per line) | P0 | Full |
| WH-FR-010 | Expiry Tracking (entry per line) | P0 | Full |
| WH-FR-029 | Over-Receipt Control (tolerance validation) | P1 | Full |

**Primary PRD:** `docs/1-BASELINE/product/modules/warehouse.md`
**Architecture:** `docs/1-BASELINE/architecture/modules/warehouse.md`
**Planning PRD:** `docs/1-BASELINE/product/modules/planning.md` (PO structure)

---

## MVP Scope

### In Scope (This Story)

1. **GRN CRUD Infrastructure**
   - `grns` table with all required columns
   - `grn_items` table linked to PO lines and LPs
   - GRN number auto-generation function
   - RLS policies for multi-tenancy

2. **API Endpoint: POST /api/warehouse/grns/from-po/:poId**
   - Validate PO exists and is receivable (status = approved/confirmed/partial)
   - Accept array of line items with quantities, batch, expiry
   - Create GRN header record
   - Create GRN item records with LP links
   - Create License Plates (one per line, or multiple if splitting)
   - Update `po_lines.received_qty` atomically
   - Update PO status (partial -> receiving, all lines complete -> closed)
   - Return created GRN with LP details

3. **Over-Receipt Validation**
   - Check `warehouse_settings.allow_over_receipt`
   - If false: Block if received_qty > ordered_qty
   - If true: Check `warehouse_settings.over_receipt_tolerance_pct`
   - Allow within tolerance, block if exceeded
   - Record over_receipt_flag and over_receipt_percentage in audit

4. **Desktop UI: Receive PO Wizard (Multi-Step)**
   - Step 1: Select PO from pending list (or navigate from PO detail)
   - Step 2: Review PO lines with ordered_qty and previously received_qty
   - Step 3: Enter receipt details per line (qty, batch, expiry, location override)
   - Step 4: Review and confirm
   - Step 5: Success with LP numbers and print labels option

5. **Service Layer**
   - `GRNService.createFromPO()` - Complex transaction orchestration
   - `GRNService.validateReceipt()` - Pre-validation before commit
   - `GRNService.calculateOverReceipt()` - Tolerance calculation
   - Integration with `LicensePlateService.create()`

6. **Zod Validation Schemas**
   - Create GRN from PO schema
   - GRN line item schema
   - Query params schema

### Out of Scope (Other Stories)

| Feature | Deferred To | Reason |
|---------|-------------|--------|
| GRN from TO | 05.12 | Different source, separate workflow |
| ASN Management | 05.13 | Pre-receipt workflow |
| GRN Cancellation | 05.14 | Reversal workflow |
| Scanner Receive | 05.17 | Mobile workflow |
| GS1 Barcode Parsing | 05.24 | Advanced feature |
| Catch Weight Entry | 05.27 | Phase 2 feature |
| Label Printing | 05.14 | Separate story |
| Batch Splitting (multiple LPs per line) | 05.11b | Advanced split story |
| Over-Receipt Approval Workflow | 05.11b | Manager override workflow |

---

## Epic 04 Dependency Status

- [ ] NOT CRITICAL - Does not unblock Epic 04 Phase 1
- [x] Phase 1 Story - Normal priority receiving workflow

This story provides goods receipt capability but Epic 04 (Production) does not depend on receiving workflows.

---

## Goal

Enable warehouse operators to receive goods from approved Purchase Orders, creating Goods Receipt Notes (GRN) and License Plates (LP) for each received line item, with complete batch/expiry tracking and over-receipt control.

---

## User Story

As a **Warehouse Operator**, I want to **receive goods from a Purchase Order and automatically create License Plates with batch and expiry information** so that **inventory is tracked at the atomic level from the moment it enters the warehouse**.

---

## Dependencies

| Dependency | Story/Epic | Type | Status | Notes |
|------------|------------|------|--------|-------|
| 05.1 | LP Table + CRUD | HARD | Ready | Creates LPs via LP service |
| 05.0 | Warehouse Settings | HARD | Ready | Over-receipt tolerance settings |
| 03.3 | PO CRUD | HARD | Ready | FK to purchase_orders, po_lines |
| 01.8 | Warehouses CRUD | HARD | Ready | FK to warehouses |
| 01.9 | Locations CRUD | HARD | Ready | FK to locations |
| 02.1 | Products CRUD | HARD | Ready | FK to products |

**Dependents (What This Unblocks):**
- 05.12 (GRN from TO) - Shares GRN infrastructure
- 05.13 (ASN Management) - ASN links to GRN
- 05.17 (Scanner Receive) - Uses GRN service

---

## Acceptance Criteria (Given/When/Then)

### AC-1: GRN Table Creation

```gherkin
Scenario: GRNs table exists with all required columns
  Given database migration runs
  When schema is inspected
  Then grns table has columns:
    | Column | Type | Nullable | Default |
    | id | UUID | NO | gen_random_uuid() |
    | org_id | UUID | NO | - |
    | grn_number | TEXT | NO | - |
    | source_type | TEXT | NO | 'po' |
    | po_id | UUID | YES | - |
    | to_id | UUID | YES | - |
    | asn_id | UUID | YES | - |
    | supplier_id | UUID | YES | - |
    | receipt_date | TIMESTAMPTZ | NO | NOW() |
    | warehouse_id | UUID | NO | - |
    | location_id | UUID | NO | - |
    | status | TEXT | NO | 'draft' |
    | notes | TEXT | YES | - |
    | created_at | TIMESTAMPTZ | NO | NOW() |
    | received_by | UUID | YES | - |
  And UNIQUE constraint exists on (org_id, grn_number)
```

### AC-2: GRN Items Table Creation

```gherkin
Scenario: GRN items table exists with all required columns
  Given database migration runs
  When schema is inspected
  Then grn_items table has columns:
    | Column | Type | Nullable | Default |
    | id | UUID | NO | gen_random_uuid() |
    | grn_id | UUID | NO | - |
    | product_id | UUID | NO | - |
    | po_line_id | UUID | YES | - |
    | to_line_id | UUID | YES | - |
    | ordered_qty | DECIMAL(15,4) | NO | - |
    | received_qty | DECIMAL(15,4) | NO | - |
    | uom | TEXT | NO | - |
    | lp_id | UUID | YES | - |
    | batch_number | TEXT | YES | - |
    | supplier_batch_number | TEXT | YES | - |
    | gtin | TEXT | YES | - |
    | catch_weight_kg | DECIMAL(10,3) | YES | - |
    | expiry_date | DATE | YES | - |
    | manufacture_date | DATE | YES | - |
    | location_id | UUID | NO | - |
    | qa_status | TEXT | NO | 'pending' |
    | notes | TEXT | YES | - |
  And FK constraint exists grn_items.grn_id -> grns.id ON DELETE CASCADE
  And FK constraint exists grn_items.lp_id -> license_plates.id
```

### AC-3: GRN Number Auto-Generation

```gherkin
Scenario: Generate GRN number with default format
  Given warehouse_settings exists for org
  When GRN is created
  Then system generates GRN number 'GRN-2025-00001'
  And next GRN gets 'GRN-2025-00002'
  And year resets sequence each year (first 2026 GRN = 'GRN-2026-00001')

Scenario: GRN number uniqueness
  Given GRN 'GRN-2025-00001' exists in org A
  When creating another GRN with same number in org A
  Then system returns 409 Conflict error
```

### AC-4: Create GRN from PO - Happy Path (WH-FR-003)

```gherkin
Scenario: Full receipt of PO creates GRN and LPs
  Given PO 'PO-2025-00001' exists with status = 'confirmed'
  And PO has 3 lines:
    | Line | Product | Ordered Qty | UoM | Already Received |
    | 1 | Flour | 1000 | KG | 0 |
    | 2 | Sugar | 500 | KG | 0 |
    | 3 | Salt | 100 | KG | 0 |
  When POST /api/warehouse/grns/from-po/PO-2025-00001 with:
    {
      "warehouse_id": "{warehouse_uuid}",
      "location_id": "{location_uuid}",
      "items": [
        { "po_line_id": "{line1}", "received_qty": 1000, "batch_number": "FLOUR-2025-001", "expiry_date": "2026-06-01" },
        { "po_line_id": "{line2}", "received_qty": 500, "batch_number": "SUGAR-2025-001", "expiry_date": "2026-12-31" },
        { "po_line_id": "{line3}", "received_qty": 100, "batch_number": "SALT-2025-001" }
      ]
    }
  Then response status = 201 Created
  And GRN created with:
    | Field | Value |
    | grn_number | GRN-2025-XXXXX |
    | source_type | po |
    | po_id | {po_uuid} |
    | status | completed |
  And 3 GRN items created, each with lp_id populated
  And 3 License Plates created with:
    | LP | Product | Qty | Batch | Expiry | Source |
    | LP00000001 | Flour | 1000 | FLOUR-2025-001 | 2026-06-01 | receipt |
    | LP00000002 | Sugar | 500 | SUGAR-2025-001 | 2026-12-31 | receipt |
    | LP00000003 | Salt | 100 | SALT-2025-001 | NULL | receipt |
  And PO lines updated: received_qty = ordered_qty for each
  And PO status updated to 'closed' (all lines fully received)
  And response time < 500ms
```

### AC-5: Partial Receipt of PO (WH-FR-003)

```gherkin
Scenario: Partial receipt updates PO to 'partial' status
  Given PO 'PO-2025-00002' with status = 'confirmed'
  And PO has line: Product=Flour, Ordered=1000 KG, Received=0
  When POST /api/warehouse/grns/from-po/PO-2025-00002 with:
    {
      "warehouse_id": "{warehouse_uuid}",
      "location_id": "{location_uuid}",
      "items": [
        { "po_line_id": "{line1}", "received_qty": 400, "batch_number": "FL-001" }
      ]
    }
  Then GRN created with status = 'completed'
  And 1 LP created with qty = 400
  And PO line.received_qty updated to 400
  And PO status updated to 'partial'

Scenario: Multiple partial receipts accumulate
  Given PO line with ordered_qty=1000, received_qty=400
  When receiving additional 300
  Then PO line.received_qty = 700
  And PO status remains 'partial'

Scenario: Final partial receipt closes PO
  Given PO line with ordered_qty=1000, received_qty=700
  When receiving remaining 300
  Then PO line.received_qty = 1000
  And PO status = 'closed'
```

### AC-6: PO Status Validation (WH-FR-003)

```gherkin
Scenario: Cannot receive from draft PO
  Given PO with status = 'draft'
  When POST /api/warehouse/grns/from-po/{poId}
  Then response status = 400 Bad Request
  And error message = "Cannot receive from PO with status 'draft'. PO must be approved or confirmed."

Scenario: Cannot receive from cancelled PO
  Given PO with status = 'cancelled'
  When POST /api/warehouse/grns/from-po/{poId}
  Then response status = 400 Bad Request
  And error message = "Cannot receive from cancelled PO"

Scenario: Can receive from approved PO
  Given PO with status = 'approved'
  When POST /api/warehouse/grns/from-po/{poId} with valid items
  Then GRN created successfully

Scenario: Can receive from confirmed PO
  Given PO with status = 'confirmed'
  When POST /api/warehouse/grns/from-po/{poId} with valid items
  Then GRN created successfully

Scenario: Can receive from partial PO
  Given PO with status = 'partial'
  When POST /api/warehouse/grns/from-po/{poId} with valid items
  Then GRN created successfully
```

### AC-7: Over-Receipt Blocked (WH-FR-029)

```gherkin
Scenario: Over-receipt blocked when setting is false
  Given warehouse_settings.allow_over_receipt = false
  And PO line with ordered_qty = 100, received_qty = 0
  When receiving 120 units
  Then response status = 400 Bad Request
  And error message = "Over-receipt not allowed. Ordered: 100, Already received: 0, Attempting: 120"

Scenario: Over-receipt blocked when already fully received
  Given warehouse_settings.allow_over_receipt = false
  And PO line with ordered_qty = 100, received_qty = 100
  When receiving additional 10 units
  Then response status = 400 Bad Request
  And error message = "PO line already fully received"
```

### AC-8: Over-Receipt Within Tolerance (WH-FR-029)

```gherkin
Scenario: Over-receipt allowed within tolerance
  Given warehouse_settings.allow_over_receipt = true
  And warehouse_settings.over_receipt_tolerance_pct = 10.00
  And PO line with ordered_qty = 100, received_qty = 0
  When receiving 108 units (8% over)
  Then GRN created successfully
  And LP created with qty = 108
  And PO line.received_qty = 108
  And audit log records: over_receipt_flag = true, over_receipt_pct = 8.0

Scenario: Over-receipt blocked when exceeds tolerance
  Given warehouse_settings.allow_over_receipt = true
  And warehouse_settings.over_receipt_tolerance_pct = 10.00
  And PO line with ordered_qty = 100, received_qty = 0
  When receiving 115 units (15% over)
  Then response status = 400 Bad Request
  And error message = "Over-receipt exceeds tolerance. Max allowed: 110 (10% tolerance), Attempting: 115"

Scenario: Over-receipt tolerance calculation with partial receipt
  Given warehouse_settings.over_receipt_tolerance_pct = 10.00
  And PO line with ordered_qty = 100, received_qty = 50
  When receiving 60 units (total would be 110, exactly 10% over)
  Then GRN created successfully
  And PO line.received_qty = 110
```

### AC-9: Batch Required Validation (WH-FR-009)

```gherkin
Scenario: Batch required when setting enabled
  Given warehouse_settings.require_batch_on_receipt = true
  When receiving without batch_number
  Then response status = 400 Bad Request
  And error message = "Batch number required for receipt"

Scenario: Batch optional when setting disabled
  Given warehouse_settings.require_batch_on_receipt = false
  When receiving without batch_number
  Then GRN and LP created with batch_number = NULL
```

### AC-10: Expiry Required Validation (WH-FR-010)

```gherkin
Scenario: Expiry required when setting enabled
  Given warehouse_settings.require_expiry_on_receipt = true
  When receiving without expiry_date
  Then response status = 400 Bad Request
  And error message = "Expiry date required for receipt"

Scenario: Expiry optional when setting disabled
  Given warehouse_settings.require_expiry_on_receipt = false
  When receiving without expiry_date
  Then GRN and LP created with expiry_date = NULL

Scenario: Expiry auto-calculated from manufacture date
  Given product.shelf_life_days = 90
  And receiving with manufacture_date = '2025-12-16' and no expiry_date
  Then LP.expiry_date = '2026-03-16'
```

### AC-11: LP Creation Details (WH-FR-001)

```gherkin
Scenario: LP inherits correct values from GRN
  Given GRN receipt with:
    | Field | Value |
    | product_id | {product_uuid} |
    | received_qty | 500 |
    | batch_number | BATCH-001 |
    | expiry_date | 2026-06-01 |
    | location_id | {location_uuid} |
  When GRN completed
  Then LP created with:
    | Field | Value |
    | product_id | {product_uuid} |
    | quantity | 500 |
    | uom | (from product) |
    | location_id | {location_uuid} |
    | warehouse_id | (from GRN) |
    | status | available |
    | qa_status | (from warehouse_settings.default_qa_status) |
    | batch_number | BATCH-001 |
    | expiry_date | 2026-06-01 |
    | source | receipt |
    | grn_id | {grn_uuid} |
    | po_number | PO-2025-XXXXX |

Scenario: LP auto-generates number
  Given warehouse_settings.auto_generate_lp_number = true
  When LP created via GRN
  Then LP.lp_number follows configured format (e.g., LP00000001)
```

### AC-12: Supplier Batch Tracking (WH-FR-009)

```gherkin
Scenario: Track both internal and supplier batch numbers
  Given warehouse_settings.enable_supplier_batch = true
  When receiving with batch_number='INT-001' and supplier_batch_number='SUP-BATCH-999'
  Then LP created with both batch fields populated
  And grn_items.supplier_batch_number = 'SUP-BATCH-999'
```

### AC-13: Location Override Per Line

```gherkin
Scenario: Different location per received item
  Given GRN with default location_id = ZONE-A
  When receiving with items:
    | Item | Location Override |
    | 1 | NULL (use default) |
    | 2 | ZONE-B |
    | 3 | ZONE-C |
  Then LP 1 created at ZONE-A
  And LP 2 created at ZONE-B
  And LP 3 created at ZONE-C
  And grn_items.location_id reflects each override
```

### AC-14: Desktop UI - Receive PO Wizard

```gherkin
Scenario: Step 1 - Select PO
  Given user navigates to /warehouse/receiving
  When page loads
  Then list of receivable POs displayed (status in [approved, confirmed, partial])
  And columns show: PO Number, Supplier, Expected Date, Lines, Status
  And user can search by PO number or supplier
  And user can click PO to start receiving

Scenario: Step 2 - Review PO Lines
  Given user selected PO 'PO-2025-00001'
  Then PO header info displayed (supplier, expected date, warehouse)
  And PO lines table shows:
    | Column | Description |
    | Product | Product name/code |
    | Ordered Qty | Original ordered quantity |
    | Already Received | Sum of previous GRN receipts |
    | Remaining | Ordered - Already Received |
    | UoM | Unit of measure |
  And "Receive All" button available to auto-fill remaining qty

Scenario: Step 3 - Enter Receipt Details
  Given user reviewing PO lines
  When user enters receipt details for each line:
    | Field | Required | Notes |
    | Receive Qty | Yes | Editable, default = Remaining |
    | Batch Number | If setting enabled | Manual entry |
    | Supplier Batch | If setting enabled | Manual entry |
    | Expiry Date | If setting enabled | Date picker |
    | Manufacture Date | No | Date picker |
    | Location | No | Override default, dropdown |
    | Notes | No | Free text |
  Then validation runs in real-time
  And over-receipt warnings displayed inline
  And batch/expiry required indicators shown

Scenario: Step 4 - Review and Confirm
  Given all line details entered
  When user clicks "Review Receipt"
  Then summary modal shows:
    | Section | Content |
    | PO Info | PO number, supplier |
    | Lines | List of items being received |
    | LPs to Create | Preview of LP numbers (if auto-generate) |
    | Over-Receipt | Warning if any line exceeds ordered |
    | Totals | Total items, total quantity |
  And user can go back to edit
  And "Confirm Receipt" button enabled if validation passes

Scenario: Step 5 - Success
  Given user confirmed receipt
  When GRN created successfully
  Then success modal displays:
    | Field | Value |
    | GRN Number | GRN-2025-00001 |
    | Items Received | 3 |
    | LPs Created | LP00000001, LP00000002, LP00000003 |
  And "Print Labels" button available (disabled if label printing not configured)
  And "Receive Another" button available
  And "View GRN" button navigates to GRN detail

Scenario: Wizard handles validation errors
  Given user enters invalid data (e.g., missing required batch)
  When attempting to proceed
  Then inline error messages displayed
  And user cannot proceed until errors fixed

Scenario: Wizard preserves state on navigation
  Given user partially completed Step 3
  When user navigates away and returns
  Then wizard state preserved (or warning to discard)
```

### AC-15: GRN List and Detail Pages

```gherkin
Scenario: GRN list page
  Given user navigates to /warehouse/grns
  Then DataTable displays GRNs with columns:
    | Column | Description |
    | GRN Number | Link to detail |
    | Source | PO/TO icon and number |
    | Supplier | Supplier name |
    | Receipt Date | Date received |
    | Items | Count of line items |
    | Status | Badge (draft/completed/cancelled) |
  And filters available: Status, Date Range, Source Type

Scenario: GRN detail page
  Given user clicks GRN number
  Then detail page shows:
    | Section | Content |
    | Header | GRN number, status, receipt date, received by |
    | Source | PO/TO link, supplier info |
    | Location | Warehouse, default location |
    | Items Table | Product, Qty, Batch, Expiry, LP link |
    | Notes | Any notes entered |
  And LP numbers are clickable links to LP detail
```

### AC-16: RLS Policy Enforcement

```gherkin
Scenario: Org isolation on GRN list
  Given User A from Org A and User B from Org B
  And GRNs exist in both orgs
  When User A requests /api/warehouse/grns
  Then only Org A GRNs returned

Scenario: Cannot receive PO from different org
  Given User A from Org A
  And PO belongs to Org B
  When User A attempts POST /api/warehouse/grns/from-po/{orgB_po_id}
  Then 404 Not Found returned

Scenario: GRN inherits org_id from authenticated user
  Given User A from Org A
  When creating GRN
  Then GRN.org_id = Org A (automatic)
```

### AC-17: Transaction Atomicity

```gherkin
Scenario: Failed LP creation rolls back GRN
  Given valid PO and receipt data
  And LP creation fails (e.g., database error)
  When attempting to create GRN
  Then entire transaction rolled back
  And no GRN created
  And no GRN items created
  And PO lines not updated
  And error message returned

Scenario: Failed PO line update rolls back everything
  Given valid PO and receipt data
  And PO line update fails
  When attempting to create GRN
  Then entire transaction rolled back
  And LPs not created (or deleted if created)
  And GRN not created
```

### AC-18: Performance Requirements

```gherkin
Scenario: GRN creation performance
  Given PO with 10 lines
  When creating GRN for all 10 lines
  Then operation completes in < 500ms

Scenario: GRN list performance
  Given 1000 GRNs in organization
  When listing with pagination
  Then response time < 500ms

Scenario: PO line lookup performance
  Given PO with 50 lines
  When loading for receive wizard
  Then response time < 300ms
```

### AC-19: Audit Trail

```gherkin
Scenario: GRN creation audit
  When GRN created
  Then audit log records:
    | Field | Value |
    | action | grn_created |
    | grn_id | {uuid} |
    | po_id | {uuid} |
    | user_id | {current_user} |
    | timestamp | NOW() |
    | items_count | N |

Scenario: Over-receipt audit
  When over-receipt occurs within tolerance
  Then audit log records:
    | Field | Value |
    | action | over_receipt |
    | grn_id | {uuid} |
    | po_line_id | {uuid} |
    | ordered_qty | 100 |
    | received_qty | 108 |
    | over_receipt_pct | 8.0 |
```

### AC-20: QA Status on Receipt

```gherkin
Scenario: LP QA status from settings
  Given warehouse_settings.require_qa_on_receipt = true
  And warehouse_settings.default_qa_status = 'pending'
  When LP created via GRN
  Then LP.qa_status = 'pending'

Scenario: LP QA status when QA not required
  Given warehouse_settings.require_qa_on_receipt = false
  When LP created via GRN
  Then LP.qa_status = 'passed' (auto-approved)
```

---

## Technical Specification

### Database Schema

```sql
-- =============================================================================
-- Goods Receipt Notes (GRN) Tables
-- =============================================================================

CREATE TABLE grns (
  -- Identity
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  grn_number TEXT NOT NULL,

  -- Source Reference (one of these populated)
  source_type TEXT NOT NULL DEFAULT 'po'
    CHECK (source_type IN ('po', 'to', 'return', 'adjustment')),
  po_id UUID REFERENCES purchase_orders(id),
  to_id UUID REFERENCES transfer_orders(id),
  asn_id UUID REFERENCES asns(id),
  supplier_id UUID REFERENCES suppliers(id),

  -- Receipt Info
  receipt_date TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  warehouse_id UUID NOT NULL REFERENCES warehouses(id),
  location_id UUID NOT NULL REFERENCES locations(id),  -- Default location

  -- Status
  status TEXT NOT NULL DEFAULT 'draft'
    CHECK (status IN ('draft', 'completed', 'cancelled')),

  -- Notes
  notes TEXT,

  -- Audit
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  received_by UUID REFERENCES users(id),

  -- Constraints
  CONSTRAINT grn_org_number_unique UNIQUE(org_id, grn_number)
);

CREATE TABLE grn_items (
  -- Identity
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  grn_id UUID NOT NULL REFERENCES grns(id) ON DELETE CASCADE,

  -- Product Reference
  product_id UUID NOT NULL REFERENCES products(id),

  -- Source Line Reference (one of these populated)
  po_line_id UUID REFERENCES purchase_order_lines(id),
  to_line_id UUID REFERENCES transfer_order_lines(id),

  -- Quantities
  ordered_qty DECIMAL(15,4) NOT NULL,
  received_qty DECIMAL(15,4) NOT NULL CHECK (received_qty >= 0),
  uom TEXT NOT NULL,

  -- Created LP
  lp_id UUID REFERENCES license_plates(id),

  -- Tracking
  batch_number TEXT,
  supplier_batch_number TEXT,
  gtin TEXT,
  catch_weight_kg DECIMAL(10,3),
  expiry_date DATE,
  manufacture_date DATE,

  -- Location (can override GRN default)
  location_id UUID NOT NULL REFERENCES locations(id),

  -- QA
  qa_status TEXT NOT NULL DEFAULT 'pending'
    CHECK (qa_status IN ('pending', 'passed', 'failed', 'quarantine')),

  -- Notes
  notes TEXT
);

-- =============================================================================
-- GRN Number Sequence
-- =============================================================================

CREATE TABLE grn_number_sequences (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  year INTEGER NOT NULL,
  current_value BIGINT NOT NULL DEFAULT 0,
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  UNIQUE(org_id, year)
);

-- Function to generate next GRN number (GRN-YYYY-NNNNN)
CREATE OR REPLACE FUNCTION generate_grn_number(p_org_id UUID)
RETURNS TEXT AS $$
DECLARE
  v_year INTEGER;
  v_next_val BIGINT;
  v_grn_number TEXT;
BEGIN
  v_year := EXTRACT(YEAR FROM CURRENT_DATE);

  -- Upsert sequence and get next value
  INSERT INTO grn_number_sequences (org_id, year, current_value)
  VALUES (p_org_id, v_year, 1)
  ON CONFLICT (org_id, year)
  DO UPDATE SET
    current_value = grn_number_sequences.current_value + 1,
    updated_at = NOW()
  RETURNING current_value INTO v_next_val;

  -- Format GRN number
  v_grn_number := 'GRN-' || v_year::TEXT || '-' || LPAD(v_next_val::TEXT, 5, '0');

  RETURN v_grn_number;
END;
$$ LANGUAGE plpgsql;

-- =============================================================================
-- Indexes
-- =============================================================================

CREATE INDEX idx_grn_org_status ON grns(org_id, status);
CREATE INDEX idx_grn_org_number ON grns(org_id, grn_number);
CREATE INDEX idx_grn_po ON grns(po_id) WHERE po_id IS NOT NULL;
CREATE INDEX idx_grn_to ON grns(to_id) WHERE to_id IS NOT NULL;
CREATE INDEX idx_grn_receipt_date ON grns(receipt_date);
CREATE INDEX idx_grn_supplier ON grns(supplier_id) WHERE supplier_id IS NOT NULL;

CREATE INDEX idx_grn_items_grn ON grn_items(grn_id);
CREATE INDEX idx_grn_items_product ON grn_items(product_id);
CREATE INDEX idx_grn_items_po_line ON grn_items(po_line_id) WHERE po_line_id IS NOT NULL;
CREATE INDEX idx_grn_items_lp ON grn_items(lp_id) WHERE lp_id IS NOT NULL;

-- =============================================================================
-- RLS Policies
-- =============================================================================

ALTER TABLE grns ENABLE ROW LEVEL SECURITY;

CREATE POLICY "grn_select_org" ON grns
FOR SELECT TO authenticated
USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

CREATE POLICY "grn_insert_org" ON grns
FOR INSERT TO authenticated
WITH CHECK (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  AND warehouse_id IN (
    SELECT id FROM warehouses
    WHERE org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  )
);

CREATE POLICY "grn_update_org" ON grns
FOR UPDATE TO authenticated
USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

ALTER TABLE grn_items ENABLE ROW LEVEL SECURITY;

-- GRN items inherit org from parent GRN
CREATE POLICY "grn_items_select" ON grn_items
FOR SELECT TO authenticated
USING (
  grn_id IN (
    SELECT id FROM grns
    WHERE org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  )
);

CREATE POLICY "grn_items_insert" ON grn_items
FOR INSERT TO authenticated
WITH CHECK (
  grn_id IN (
    SELECT id FROM grns
    WHERE org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  )
);

ALTER TABLE grn_number_sequences ENABLE ROW LEVEL SECURITY;

CREATE POLICY "grn_seq_org" ON grn_number_sequences
FOR ALL TO authenticated
USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));
```

### API Endpoints

```
# GRN Endpoints
GET    /api/warehouse/grns                              - List GRNs (paginated)
GET    /api/warehouse/grns/:id                          - Get GRN detail
POST   /api/warehouse/grns/from-po/:poId                - Create GRN from PO
POST   /api/warehouse/grns/:id/cancel                   - Cancel GRN (future)

# Supporting Endpoints
GET    /api/warehouse/receiving/pending-pos             - List receivable POs
GET    /api/warehouse/receiving/po/:poId/lines          - Get PO lines for receive wizard
POST   /api/warehouse/grns/validate                     - Validate receipt before commit
```

**POST /api/warehouse/grns/from-po/:poId Request Body:**

```typescript
interface CreateGRNFromPORequest {
  warehouse_id: string;           // UUID - receiving warehouse
  location_id: string;            // UUID - default receiving location
  notes?: string;                 // Optional GRN notes
  items: {
    po_line_id: string;           // UUID - which PO line
    received_qty: number;         // Quantity being received
    batch_number?: string;        // Internal batch
    supplier_batch_number?: string; // Supplier's batch
    expiry_date?: string;         // YYYY-MM-DD
    manufacture_date?: string;    // YYYY-MM-DD
    location_id?: string;         // UUID - override default location
    notes?: string;               // Line notes
  }[];
}
```

**POST /api/warehouse/grns/from-po/:poId Response:**

```typescript
interface CreateGRNFromPOResponse {
  grn: {
    id: string;
    grn_number: string;
    source_type: 'po';
    po_id: string;
    supplier_id: string;
    receipt_date: string;
    warehouse_id: string;
    location_id: string;
    status: 'completed';
    notes: string | null;
    created_at: string;
    received_by: string;
  };
  items: {
    id: string;
    product_id: string;
    product_name: string;
    ordered_qty: number;
    received_qty: number;
    uom: string;
    lp_id: string;
    lp_number: string;
    batch_number: string | null;
    expiry_date: string | null;
    location_id: string;
    qa_status: string;
  }[];
  po_status: string;              // Updated PO status
  over_receipt_warnings: {
    po_line_id: string;
    ordered_qty: number;
    total_received: number;
    over_receipt_pct: number;
  }[];
}
```

### Service Layer

```typescript
// lib/services/grn-service.ts

export interface CreateGRNFromPOInput {
  poId: string;
  warehouseId: string;
  locationId: string;
  notes?: string;
  items: {
    poLineId: string;
    receivedQty: number;
    batchNumber?: string;
    supplierBatchNumber?: string;
    expiryDate?: string;
    manufactureDate?: string;
    locationId?: string;
    notes?: string;
  }[];
}

export interface GRNValidationResult {
  valid: boolean;
  errors: {
    field: string;
    message: string;
    poLineId?: string;
  }[];
  warnings: {
    field: string;
    message: string;
    poLineId?: string;
  }[];
}

export interface OverReceiptCalculation {
  poLineId: string;
  orderedQty: number;
  alreadyReceivedQty: number;
  attemptingQty: number;
  totalAfterReceipt: number;
  overReceiptQty: number;
  overReceiptPct: number;
  isWithinTolerance: boolean;
  maxAllowed: number;
}

export class GRNService {
  // ==========================================================================
  // Main Operations
  // ==========================================================================

  /**
   * Create GRN from Purchase Order
   * - Validates PO status and line quantities
   * - Creates GRN header and items
   * - Creates License Plates via LP service
   * - Updates PO line received quantities
   * - Updates PO status
   * - All within single transaction
   */
  static async createFromPO(input: CreateGRNFromPOInput): Promise<GRN>;

  /**
   * Validate receipt data before committing
   * Returns validation errors and warnings (e.g., over-receipt within tolerance)
   */
  static async validateReceipt(input: CreateGRNFromPOInput): Promise<GRNValidationResult>;

  /**
   * Calculate over-receipt for a single PO line
   */
  static async calculateOverReceipt(
    poLineId: string,
    attemptingQty: number
  ): Promise<OverReceiptCalculation>;

  // ==========================================================================
  // CRUD Operations
  // ==========================================================================

  /**
   * List GRNs with filtering and pagination
   */
  static async list(params: GRNListParams): Promise<PaginatedResult<GRN>>;

  /**
   * Get GRN by ID with items and LP details
   */
  static async getById(id: string): Promise<GRN | null>;

  /**
   * Generate next GRN number
   */
  static async generateGRNNumber(): Promise<string>;

  /**
   * Cancel GRN (reverse receipts - future story)
   */
  static async cancel(id: string, reason: string): Promise<GRN>;

  // ==========================================================================
  // Support Operations
  // ==========================================================================

  /**
   * Get receivable POs (status in approved, confirmed, partial)
   */
  static async getReceivablePOs(): Promise<PurchaseOrder[]>;

  /**
   * Get PO lines with current received quantities
   */
  static async getPOLinesForReceipt(poId: string): Promise<POLineWithReceived[]>;

  /**
   * Check if PO is fully received
   */
  static async isPOFullyReceived(poId: string): Promise<boolean>;

  /**
   * Update PO status based on receipt status
   */
  static async updatePOStatus(poId: string): Promise<void>;
}
```

### Validation Schema (Zod)

```typescript
// lib/validation/grn.ts
import { z } from 'zod';

export const grnSourceTypeEnum = z.enum(['po', 'to', 'return', 'adjustment']);
export const grnStatusEnum = z.enum(['draft', 'completed', 'cancelled']);

export const createGRNItemSchema = z.object({
  po_line_id: z.string().uuid("Invalid PO line ID"),
  received_qty: z.number()
    .positive("Received quantity must be positive")
    .max(999999999, "Quantity too large"),
  batch_number: z.string()
    .max(100, "Batch number max 100 characters")
    .nullable()
    .optional(),
  supplier_batch_number: z.string()
    .max(100, "Supplier batch number max 100 characters")
    .nullable()
    .optional(),
  expiry_date: z.string()
    .regex(/^\d{4}-\d{2}-\d{2}$/, "Invalid date format (YYYY-MM-DD)")
    .nullable()
    .optional(),
  manufacture_date: z.string()
    .regex(/^\d{4}-\d{2}-\d{2}$/, "Invalid date format (YYYY-MM-DD)")
    .nullable()
    .optional(),
  location_id: z.string().uuid("Invalid location ID").optional(),
  notes: z.string().max(500).nullable().optional(),
});

export const createGRNFromPOSchema = z.object({
  warehouse_id: z.string().uuid("Invalid warehouse ID"),
  location_id: z.string().uuid("Invalid location ID"),
  notes: z.string().max(2000).optional(),
  items: z.array(createGRNItemSchema)
    .min(1, "At least one item required")
    .max(100, "Maximum 100 items per GRN"),
});

export const grnListQuerySchema = z.object({
  status: grnStatusEnum.optional(),
  source_type: grnSourceTypeEnum.optional(),
  po_id: z.string().uuid().optional(),
  warehouse_id: z.string().uuid().optional(),
  supplier_id: z.string().uuid().optional(),
  date_from: z.string().optional(),
  date_to: z.string().optional(),
  search: z.string().min(1).optional(),
  sort: z.enum(['grn_number', 'receipt_date', 'created_at']).default('receipt_date'),
  order: z.enum(['asc', 'desc']).default('desc'),
  page: z.coerce.number().int().positive().default(1),
  limit: z.coerce.number().int().min(1).max(100).default(50),
});

export type CreateGRNFromPOInput = z.infer<typeof createGRNFromPOSchema>;
export type GRNListQueryParams = z.infer<typeof grnListQuerySchema>;
```

---

## UI Components

```
app/(authenticated)/warehouse/
  receiving/
    page.tsx                           -- Receive PO wizard / pending POs list
    [poId]/
      page.tsx                         -- Receive specific PO (wizard)
  grns/
    page.tsx                           -- GRN list
    [id]/
      page.tsx                         -- GRN detail

components/warehouse/receiving/
  ReceivingWizard.tsx                  -- Multi-step wizard container
  ReceivingStep1SelectPO.tsx           -- Step 1: Select PO
  ReceivingStep2ReviewLines.tsx        -- Step 2: Review PO lines
  ReceivingStep3EnterDetails.tsx       -- Step 3: Enter receipt details
  ReceivingStep4Confirm.tsx            -- Step 4: Review and confirm
  ReceivingStep5Success.tsx            -- Step 5: Success with LP numbers
  PendingPOsTable.tsx                  -- List of receivable POs
  POLinesTable.tsx                     -- PO lines with receive inputs
  ReceiveLineForm.tsx                  -- Single line receipt form
  OverReceiptWarning.tsx               -- Over-receipt inline warning
  BatchExpiryInputs.tsx                -- Batch/expiry form fields

components/warehouse/grns/
  GRNDataTable.tsx                     -- GRN list table
  GRNFilters.tsx                       -- Filter panel
  GRNDetail.tsx                        -- GRN detail view
  GRNItemsTable.tsx                    -- GRN items with LP links
  GRNStatusBadge.tsx                   -- Status badge component
```

---

## Key Business Rules

1. **PO Status for Receiving**: Only POs with status in ['approved', 'confirmed', 'partial'] can be received
2. **Over-Receipt Control**:
   - If `allow_over_receipt = false`: Block any receipt > ordered_qty
   - If `allow_over_receipt = true`: Allow within `over_receipt_tolerance_pct`
3. **Batch/Expiry Requirements**: Configurable via warehouse_settings
4. **One LP Per Line**: Each GRN item creates exactly one LP (batch splitting in 05.11b)
5. **QA Status**: LP qa_status set from `warehouse_settings.default_qa_status`
6. **PO Status Updates**:
   - First receipt on PO: Status -> 'partial' (if not all lines complete)
   - All lines fully received: Status -> 'closed'
7. **Atomicity**: GRN creation, LP creation, PO updates all in single transaction
8. **Audit Trail**: All receipts logged with over-receipt flags

---

## Deliverables

### Database
- [ ] Migration: `grns` table with all columns
- [ ] Migration: `grn_items` table with all columns
- [ ] Migration: `grn_number_sequences` table
- [ ] Function: `generate_grn_number(org_id)`
- [ ] RLS policies for grns and grn_items
- [ ] All performance indexes

### API Routes
- [ ] `GET /api/warehouse/grns` - List with filters
- [ ] `GET /api/warehouse/grns/:id` - Get detail
- [ ] `POST /api/warehouse/grns/from-po/:poId` - Create from PO
- [ ] `GET /api/warehouse/receiving/pending-pos` - Receivable POs
- [ ] `GET /api/warehouse/receiving/po/:poId/lines` - PO lines for wizard
- [ ] `POST /api/warehouse/grns/validate` - Pre-validation

### Service Layer
- [ ] `GRNService.createFromPO()` - Main creation method
- [ ] `GRNService.validateReceipt()` - Validation method
- [ ] `GRNService.calculateOverReceipt()` - Over-receipt calculation
- [ ] `GRNService.list()` - List with pagination
- [ ] `GRNService.getById()` - Get with items
- [ ] `GRNService.generateGRNNumber()` - Number generation
- [ ] `GRNService.getReceivablePOs()` - Pending PO list
- [ ] `GRNService.getPOLinesForReceipt()` - PO lines query
- [ ] `GRNService.updatePOStatus()` - PO status update

### Validation
- [ ] `createGRNFromPOSchema`
- [ ] `createGRNItemSchema`
- [ ] `grnListQuerySchema`

### Frontend
- [ ] Receiving wizard (5 steps)
- [ ] Pending POs table
- [ ] PO lines table with receive inputs
- [ ] GRN list page
- [ ] GRN detail page
- [ ] Over-receipt warning component
- [ ] Batch/expiry inputs

### Tests
- [ ] Unit tests: GRN service methods (>80% coverage)
- [ ] Integration tests: All API endpoints
- [ ] Over-receipt tests: Tolerance calculations
- [ ] Transaction rollback tests
- [ ] RLS tests: Multi-tenancy isolation
- [ ] E2E: Full receive wizard flow

---

## Test Cases

### Unit Tests

**File:** `__tests__/unit/services/grn-service.test.ts`

| Test Case | Description |
|-----------|-------------|
| `createFromPO()` creates GRN with correct fields | All fields populated correctly |
| `createFromPO()` creates LP for each item | LP count = item count |
| `createFromPO()` updates PO line received_qty | Accumulative update |
| `createFromPO()` updates PO status to partial | When not fully received |
| `createFromPO()` updates PO status to closed | When fully received |
| `createFromPO()` blocks draft PO | Error returned |
| `createFromPO()` blocks cancelled PO | Error returned |
| `createFromPO()` rolls back on LP failure | No partial creates |
| `validateReceipt()` returns batch required error | When setting enabled |
| `validateReceipt()` returns expiry required error | When setting enabled |
| `validateReceipt()` returns over-receipt warning | Within tolerance |
| `validateReceipt()` returns over-receipt error | Exceeds tolerance |
| `calculateOverReceipt()` returns correct values | Math verified |
| `calculateOverReceipt()` accounts for partial receipts | Cumulative check |
| `generateGRNNumber()` increments sequence | Sequential numbers |
| `generateGRNNumber()` resets per year | Year change detection |

### Integration Tests

**File:** `__tests__/integration/api/warehouse/grns.test.ts`

| Test Case | Description |
|-----------|-------------|
| `POST /grns/from-po/:poId` creates GRN | Success response |
| `POST /grns/from-po/:poId` creates LPs | LP records exist |
| `POST /grns/from-po/:poId` updates PO | Received qty updated |
| `POST /grns/from-po/:poId` with invalid PO returns 404 | Not found |
| `POST /grns/from-po/:poId` with wrong org returns 404 | RLS enforced |
| `POST /grns/from-po/:poId` with over-receipt blocked | 400 error |
| `POST /grns/from-po/:poId` with over-receipt allowed | Success |
| `GET /grns` returns paginated list | Pagination works |
| `GET /grns/:id` returns GRN with items | Items populated |
| Response times meet requirements | < 500ms |

### E2E Tests

**File:** `__tests__/e2e/warehouse/receive-po.spec.ts`

| Test Case | Description |
|-----------|-------------|
| Complete receive wizard flow | All steps work |
| Partial receipt flow | PO shows partial status |
| Over-receipt blocked | Error displayed |
| Validation errors shown | Inline errors work |
| Success shows LP numbers | LPs listed |

---

## Definition of Done

### Database
- [ ] `grns` table created with all columns
- [ ] `grn_items` table created with FK to license_plates
- [ ] `grn_number_sequences` table created
- [ ] `generate_grn_number()` function works correctly
- [ ] All indexes created for performance
- [ ] RLS policies enforce org isolation

### API
- [ ] All endpoints return correct HTTP status codes
- [ ] Validation errors return 400 with detailed messages
- [ ] Over-receipt returns appropriate errors/warnings
- [ ] Cross-tenant access returns 404
- [ ] Transaction atomicity verified
- [ ] Response times:
  - GRN creation: < 500ms
  - GRN list: < 500ms
  - PO lines query: < 300ms

### Service
- [ ] `createFromPO()` creates GRN, items, LPs atomically
- [ ] LP creation uses `LicensePlateService.create()`
- [ ] PO line updates are atomic
- [ ] Over-receipt validation works correctly
- [ ] Rollback on any failure

### Frontend
- [ ] Receive wizard navigates through all 5 steps
- [ ] Validation errors displayed inline
- [ ] Over-receipt warnings shown clearly
- [ ] Success page shows LP numbers
- [ ] GRN list page with filtering
- [ ] GRN detail page with LP links

### Testing
- [ ] Unit tests: >80% coverage on service
- [ ] Integration tests: All endpoints covered
- [ ] Over-receipt tests: All scenarios
- [ ] RLS tests: Multi-tenancy verified
- [ ] E2E tests: Wizard flow passing

---

## Potential Split (05.11a / 05.11b)

### 05.11a: GRN from PO Core (This Story)
- Single LP per line
- Basic over-receipt validation (block or allow)
- Desktop wizard
- Complexity: M-L (3-4 days)

### 05.11b: GRN from PO Advanced (Future)
- Batch splitting (multiple LPs per line)
- Over-receipt approval workflow (manager override)
- Catch weight entry
- GS1 barcode pre-fill
- Complexity: M (2-3 days)

---

## Future Phases (Not in This Story)

### Story 05.12 - GRN from TO
- Receive from Transfer Order
- Transit location handling
- TO status updates

### Story 05.13 - ASN Management
- ASN CRUD
- Pre-fill GRN from ASN
- Expected vs actual variance

### Story 05.14 - GRN Cancellation
- Cancel completed GRN
- Reverse LP creation
- Restore PO line quantities

### Story 05.17 - Scanner Receive
- Mobile workflow
- Barcode scanning
- Audio feedback

---

## Risk Assessment

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Transaction complexity | HIGH | MEDIUM | Thorough transaction testing, explicit rollback |
| Over-receipt edge cases | MEDIUM | MEDIUM | Comprehensive test coverage for all scenarios |
| LP service integration | MEDIUM | LOW | LP service already tested in 05.1 |
| PO status race conditions | HIGH | LOW | Database-level locking on PO updates |
| Performance with many lines | MEDIUM | LOW | Batch processing, proper indexes |
| Wizard state management | MEDIUM | MEDIUM | Use React state or Zustand for complex state |

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-12-16 | Initial story creation with comprehensive LP creation workflow | OPUS |
