# 05.20 - Scanner Move Workflow

| Field | Value |
|-------|-------|
| **Story ID** | 05.20 |
| **Epic** | 05 - Warehouse |
| **Status** | Ready |
| **Phase** | Phase 2 (Scanner Workflows) |
| **Priority** | P0 (Scanner Critical) |
| **Complexity** | M (Medium) |
| **Estimate** | 3-4 days |
| **Type** | Backend + Frontend (Mobile) |
| **Model** | OPUS |

---

## PRD References

| FR ID | Requirement | Priority | Coverage |
|-------|-------------|----------|----------|
| WH-FR-012 | Scanner Move (mobile move workflow) | P0 | Full |
| WH-FR-005 | Stock Moves (LP movement tracking) | P0 | Integrated |
| WH-FR-002 | LP Tracking (status validation) | P0 | Integrated |

**Primary PRD:** `docs/1-BASELINE/product/modules/warehouse.md`
**Architecture:** `docs/1-BASELINE/architecture/modules/warehouse.md`

---

## MVP Scope

### In Scope (This Story)

1. **Scanner Move Page (`/scanner/move`)**
   - Full-screen mobile-optimized layout
   - 3-step workflow: Scan LP -> Scan Destination -> Confirm
   - Touch-optimized UI with large buttons (min 48x48dp)
   - High contrast colors for warehouse lighting
   - Portrait and landscape orientation support

2. **Barcode Scanning Integration**
   - LP barcode scanning to identify source
   - Location barcode scanning for destination
   - Camera-based scanning using device camera
   - Manual barcode entry fallback

3. **LP Validation**
   - Validate LP exists in system
   - Validate LP status = 'available'
   - Display LP details (product, qty, current location)
   - Block moves for consumed/blocked/reserved LPs

4. **Location Validation**
   - Validate destination location exists
   - Validate location is active
   - Capacity check (warning if enabled and at capacity)
   - Show location details (zone, path)

5. **Audio/Visual Feedback System**
   - Success tone on valid scan (200ms, high pitch)
   - Error beep on invalid scan (300ms, low pitch)
   - Confirmation chime on move complete (500ms)
   - Alert tone on network error (400ms)
   - Visual indicators: green checkmarks, red X, yellow warnings
   - Haptic feedback on mobile devices (if supported)

6. **API Endpoints for Scanner Move**
   - `POST /api/warehouse/scanner/move` - Execute move operation
   - `GET /api/warehouse/scanner/lookup/lp/:barcode` - Lookup LP by barcode
   - `POST /api/warehouse/scanner/validate-move` - Pre-validate before commit

7. **Service Layer**
   - `ScannerMoveService.processMove()` - Main move handler
   - `ScannerMoveService.validateMove()` - Pre-validation
   - `ScannerMoveService.lookupLP()` - LP barcode lookup
   - Integration with `StockMoveService` (Story 05.16)
   - Integration with `LicensePlateService` (Story 05.1)

8. **Zod Validation Schemas**
   - Scanner move request schema
   - LP lookup schema
   - Move validation schema

### Out of Scope (Other Stories)

| Feature | Deferred To | Reason |
|---------|-------------|--------|
| Partial LP Move (Split) | 05.17 | Requires LP split workflow integration |
| Guided Putaway | 05.21 | Separate FIFO/FEFO suggestion workflow |
| Offline Queue Support | 05.19b (Phase 3) | Requires local storage, sync logic |
| Scanner Login/Session | 05.16 | Separate authentication story |
| Capacity Enforcement (Block) | 05.25 | Phase 3 capacity management |
| FIFO/FEFO Warnings | 05.21 | Guided putaway story |

---

## Goal

Enable warehouse operators to quickly move License Plates between locations using handheld scanner devices with a streamlined 3-step workflow: Scan LP, Scan Destination Location, Confirm Move.

---

## User Story

As a **Warehouse Operator using a handheld scanner**, I want to **move License Plates by scanning the LP barcode and destination location barcode with large touch-friendly buttons and audio confirmation** so that **I can efficiently relocate inventory on the warehouse floor without needing a desktop computer**.

---

## Dependencies

| Dependency | Story/Epic | Type | Status | Notes |
|------------|------------|------|--------|-------|
| 05.1 | LP Table + CRUD | HARD | Ready | LP lookup and validation |
| 05.16 | Stock Moves CRUD | HARD | Ready | Uses StockMoveService for move creation |
| 01.8 | Warehouses CRUD | SOFT | Ready | Warehouse context |
| 01.9 | Locations CRUD | HARD | Ready | Location barcode lookup, validation |
| 05.19 | Scanner Receive | SOFT | Ready | Shares scanner UI components |

**Dependents (What This Unblocks):**
- 05.21 (Scanner Putaway) - Guided putaway with FIFO/FEFO
- Scanner workflow polish stories

---

## Acceptance Criteria (Given/When/Then)

### AC-1: Scanner Move Page Layout (WH-FR-012)

```gherkin
Scenario: Scanner move page renders with mobile-optimized layout
  Given scanner user is authenticated
  When user navigates to /scanner/move
  Then full-screen layout displays without browser chrome
  And header shows "Move LP" title with back button
  And current step indicator shows progress (1 of 3)
  And main content area fills available space
  And action buttons anchored to bottom of screen
  And all touch targets are minimum 48x48 pixels

Scenario: Page adapts to device orientation
  Given user on /scanner/move
  When device rotates to landscape
  Then layout adjusts to horizontal orientation
  And barcode scan area remains easily accessible

Scenario: Page handles safe area insets
  Given user on device with notch/rounded corners
  Then content respects safe area insets
  And no UI elements obscured by device hardware
```

### AC-2: Step 1 - Scan LP (WH-FR-012)

```gherkin
Scenario: Initial scan LP prompt displays
  Given user on Step 1 "Scan LP"
  When step loads
  Then large "Scan LP Barcode" button displayed prominently (80x80dp)
  And instruction text shows "Scan the License Plate barcode to move"
  And manual entry link available below scan button
  And recent moves list shows last 5 moves (optional quick repeat)

Scenario: Camera scanner activates on button tap
  Given user on Step 1
  When user taps "Scan LP Barcode" button
  Then camera barcode scanner activates
  And scan frame displays with guide overlay
  And scanning instruction text shows "Point camera at LP barcode"
  And torch/flashlight toggle available

Scenario: Valid LP barcode scanned
  Given camera scanner active
  When LP barcode "LP00000001" scanned
  Then system validates LP in < 200ms
  And success tone plays (880Hz, 200ms)
  And green checkmark animation displays
  And LP details display:
    | Field | Value |
    | LP Number | LP00000001 |
    | Product | {product name} |
    | Quantity | 100 KG |
    | Current Location | WH-001/ZONE-A/LOC-001 |
    | Status | Available |
    | Batch | BATCH-001 (if applicable) |
    | Expiry | 2026-06-01 (if applicable) |
  And workflow advances to Step 2

Scenario: LP not found
  Given camera scanner active
  When unrecognized LP barcode scanned
  Then error beep plays (220Hz, 300ms)
  And red X animation displays
  And error message shows "LP not found: {barcode}"
  And scanner remains active for retry

Scenario: LP not available (wrong status)
  Given camera scanner active
  When LP barcode scanned for LP with status='consumed'
  Then error beep plays
  And message shows "LP not available (status: consumed)"
  And LP details displayed with red highlight
  And scanner remains active for retry

Scenario: LP reserved
  Given camera scanner active
  When LP barcode scanned for LP with status='reserved'
  Then error beep plays
  And message shows "LP is reserved for {WO/TO number}"
  And scanner remains active for retry

Scenario: LP blocked
  Given camera scanner active
  When LP barcode scanned for LP with status='blocked'
  Then error beep plays
  And message shows "LP is blocked (QA: {qa_status})"
  And scanner remains active for retry

Scenario: Manual LP entry
  Given user on Step 1
  When user taps "Enter manually" link
  Then text input field appears
  And keyboard displays
  And "Lookup" button enables when text entered
  When user enters "LP00000001" and taps "Lookup"
  Then system validates LP same as scan flow
```

### AC-3: Step 2 - Scan Destination Location (WH-FR-012)

```gherkin
Scenario: Destination scan prompt displays
  Given LP validated in Step 1
  When Step 2 loads
  Then LP summary card displays at top (compact):
    | LP Number | Product | Qty |
  And large "Scan Destination" button displayed (80x80dp)
  And instruction text shows "Scan the destination location barcode"
  And current location shown with "From:" label
  And manual location selection link available

Scenario: Valid destination location scanned
  Given user on Step 2
  When destination location barcode "LOC-B01-02" scanned
  Then system validates location in < 100ms
  And success tone plays
  And green checkmark animation displays
  And destination details display:
    | Field | Value |
    | Location Code | LOC-B01-02 |
    | Zone | Zone B |
    | Full Path | Warehouse > Zone B > Aisle 01 > Rack 02 |
    | Capacity | 80% (if enabled) |
  And workflow advances to Step 3

Scenario: Location not found
  Given user on Step 2
  When unrecognized location barcode scanned
  Then error beep plays
  And error message shows "Location not found: {barcode}"
  And scanner remains active

Scenario: Location inactive
  Given user on Step 2
  When location barcode scanned for inactive location
  Then error beep plays
  And message shows "Location is inactive"
  And scanner remains active

Scenario: Location at capacity (warning)
  Given warehouse_settings.enable_location_capacity = true
  And destination location at 100% capacity
  When location barcode scanned
  Then yellow warning displays "Location at capacity"
  And move still allowed (warning only)
  And user can proceed or choose different location

Scenario: Same location as source
  Given LP at location "LOC-A01-01"
  When user scans same location "LOC-A01-01" as destination
  Then yellow warning displays "Same as current location"
  And move blocked with "Choose a different destination"
  And scanner remains active

Scenario: Manual location selection
  Given user on Step 2
  When user taps "Select manually" link
  Then location picker modal opens
  And locations grouped by zone
  And search/filter available
  And recently used locations shown at top
  When user selects location
  Then modal closes
  And location validated same as scan flow
```

### AC-4: Step 3 - Confirm Move (WH-FR-012)

```gherkin
Scenario: Confirmation screen displays
  Given LP and destination validated
  When Step 3 loads
  Then confirmation summary displays:
    | Section | Content |
    | LP Info | LP Number, Product, Quantity |
    | From | Current location (full path) |
    | To | Destination location (full path) |
    | Arrow | Visual arrow showing direction |
  And large "Confirm Move" button at bottom (full-width, 56dp height)
  And "Cancel" link above confirm button
  And "Edit" buttons for LP and destination sections

Scenario: Edit LP from confirmation
  Given confirmation screen displayed
  When user taps "Edit" on LP section
  Then workflow returns to Step 1
  And can scan different LP

Scenario: Edit destination from confirmation
  Given confirmation screen displayed
  When user taps "Edit" on destination section
  Then workflow returns to Step 2
  And LP details preserved
  And can scan different destination

Scenario: Confirm move executes successfully
  Given confirmation screen displayed
  When user taps "Confirm Move"
  Then loading indicator displays
  And POST /api/warehouse/scanner/move called
  And stock_move record created
  And LP.location_id updated
  And confirmation chime plays (660Hz+880Hz, 500ms)
  And success screen displays with:
    | Field | Value |
    | Move Number | SM-2025-00001 |
    | LP | LP00000001 |
    | New Location | LOC-B01-02 |
  And green success animation displays
  And response time < 300ms
```

### AC-5: Success Screen Actions (WH-FR-012)

```gherkin
Scenario: Move another LP (same destination)
  Given success screen displayed
  When user taps "Move Another to Same Location"
  Then workflow returns to Step 1
  And destination location preserved for quick repeat
  And ready to scan next LP

Scenario: Move same LP again (different destination)
  Given success screen displayed
  And LP still has qty > 0 (not fully consumed)
  When user taps "Move Same LP"
  Then workflow returns to Step 2
  And LP preserved
  And can scan new destination

Scenario: New move (fresh start)
  Given success screen displayed
  When user taps "New Move"
  Then workflow returns to Step 1
  And all previous selections cleared

Scenario: Return to scanner menu
  Given success screen displayed
  When user taps "Done"
  Then navigate to scanner dashboard
  And move logged in activity
```

### AC-6: Audio Feedback System (WH-NFR)

```gherkin
Scenario: Audio feedback respects settings
  Given warehouse_settings.scanner_sound_feedback = true
  Then all audio feedback enabled
  When warehouse_settings.scanner_sound_feedback = false
  Then audio muted (visual only)

Scenario: Success tone plays on valid LP scan
  Given audio enabled
  When valid LP barcode scanned
  Then success tone plays:
    - Frequency: 880Hz (high pitch)
    - Duration: 200ms
    - Volume: Device volume level

Scenario: Success tone plays on valid location scan
  Given audio enabled
  When valid location barcode scanned
  Then success tone plays:
    - Frequency: 880Hz (high pitch)
    - Duration: 200ms
    - Volume: Device volume level

Scenario: Error beep plays on invalid scan
  Given audio enabled
  When invalid barcode scanned (LP or location)
  Then error beep plays:
    - Frequency: 220Hz (low pitch)
    - Duration: 300ms
    - Volume: Device volume level

Scenario: Confirmation chime on move complete
  Given audio enabled
  When move submitted successfully
  Then confirmation chime plays:
    - Dual tone: 660Hz + 880Hz
    - Duration: 500ms
    - Volume: Device volume level

Scenario: Alert tone on network error
  Given audio enabled
  When network request fails
  Then alert tone plays:
    - Frequency: 440Hz (mid pitch, repeating)
    - Duration: 400ms
    - Volume: Device volume level

Scenario: Haptic feedback on mobile
  Given device supports haptic feedback
  When action completed (scan, submit)
  Then haptic vibration triggers:
    - Success: short buzz (50ms)
    - Error: double buzz (50ms, 50ms gap, 50ms)
    - Confirm: long buzz (100ms)
```

### AC-7: Visual Feedback System (WH-NFR)

```gherkin
Scenario: Success visual indicator
  When valid barcode scanned
  Then green checkmark animation displays
  And animation duration = 500ms
  And checkmark size = 64x64 pixels minimum
  And background flashes green briefly

Scenario: Error visual indicator
  When invalid barcode scanned
  Then red X animation displays
  And animation duration = 500ms
  And X size = 64x64 pixels minimum
  And background flashes red briefly

Scenario: Warning visual indicator
  When warning condition detected (capacity, FIFO)
  Then yellow warning icon displays
  And warning message in yellow banner
  And relevant field highlighted yellow

Scenario: Loading indicator during API calls
  When API request in progress
  Then loading spinner displays
  And spinner size = 48x48 pixels
  And UI interaction disabled during load
  And timeout after 10 seconds with error

Scenario: High contrast colors for warehouse lighting
  Given warehouse lighting conditions may be poor
  Then UI uses high contrast color scheme:
    - Success: #22C55E (bright green)
    - Errors: #EF4444 (bright red)
    - Warnings: #F59E0B (bright orange)
    - Text: #111827 (near black) on #FFFFFF (white)
```

### AC-8: API Endpoint - Scanner Move (WH-FR-012)

```gherkin
Scenario: POST /api/warehouse/scanner/move - Happy path
  When POST /api/warehouse/scanner/move with:
    {
      "lp_id": "{lp_uuid}",
      "to_location_id": "{location_uuid}"
    }
  Then response status = 201 Created
  And response includes:
    {
      "stock_move": {
        "id": "...",
        "move_number": "SM-2025-00001",
        "move_type": "transfer",
        "status": "completed"
      },
      "lp": {
        "id": "...",
        "lp_number": "LP00000001",
        "location_id": "{new_location_uuid}",
        "location_path": "Zone B > Aisle 01 > Rack 02"
      }
    }
  And response time < 300ms

Scenario: POST /api/warehouse/scanner/move - LP not found
  When POST with invalid lp_id
  Then response status = 404 Not Found
  And error message = "License Plate not found"

Scenario: POST /api/warehouse/scanner/move - LP not available
  When POST with lp_id for LP with status='consumed'
  Then response status = 400 Bad Request
  And error message = "LP not available for movement (status: consumed)"

Scenario: POST /api/warehouse/scanner/move - Location not found
  When POST with invalid to_location_id
  Then response status = 404 Not Found
  And error message = "Destination location not found"

Scenario: POST /api/warehouse/scanner/move - Location inactive
  When POST with to_location_id for inactive location
  Then response status = 400 Bad Request
  And error message = "Destination location is inactive"

Scenario: POST /api/warehouse/scanner/move - Same location
  When POST where LP.location_id = to_location_id
  Then response status = 400 Bad Request
  And error message = "Source and destination locations are the same"
```

### AC-9: API Endpoint - LP Lookup (WH-FR-012)

```gherkin
Scenario: GET /api/warehouse/scanner/lookup/lp/:barcode - Found
  Given LP with lp_number "LP00000001" exists
  When GET /api/warehouse/scanner/lookup/lp/LP00000001
  Then response status = 200 OK
  And response includes:
    {
      "id": "...",
      "lp_number": "LP00000001",
      "product": { "id": "...", "name": "...", "sku": "..." },
      "quantity": 100,
      "uom": "KG",
      "location": { "id": "...", "code": "...", "path": "..." },
      "status": "available",
      "qa_status": "passed",
      "batch_number": "...",
      "expiry_date": "..."
    }
  And response time < 200ms

Scenario: GET /api/warehouse/scanner/lookup/lp/:barcode - Not Found
  When GET /api/warehouse/scanner/lookup/lp/INVALID
  Then response status = 404 Not Found
  And error message = "LP not found"

Scenario: GET /api/warehouse/scanner/lookup/lp/:barcode - Different org
  Given LP belongs to Org B
  And user from Org A requests lookup
  Then response status = 404 Not Found (RLS enforced)
```

### AC-10: API Endpoint - Validate Move (WH-FR-012)

```gherkin
Scenario: POST /api/warehouse/scanner/validate-move - Valid
  When POST /api/warehouse/scanner/validate-move with:
    {
      "lp_id": "{lp_uuid}",
      "to_location_id": "{location_uuid}"
    }
  Then response status = 200 OK
  And response includes:
    {
      "valid": true,
      "warnings": [],
      "lp": { ... },
      "destination": { ... }
    }

Scenario: POST /api/warehouse/scanner/validate-move - With warnings
  Given destination location at 95% capacity
  When POST validate-move
  Then response status = 200 OK
  And response includes:
    {
      "valid": true,
      "warnings": [
        { "code": "CAPACITY_WARNING", "message": "Location at 95% capacity" }
      ]
    }

Scenario: POST /api/warehouse/scanner/validate-move - Invalid
  Given LP status = 'blocked'
  When POST validate-move
  Then response status = 200 OK
  And response includes:
    {
      "valid": false,
      "errors": [
        { "field": "lp_id", "message": "LP is blocked" }
      ]
    }
```

### AC-11: Touch Target Requirements (WH-NFR)

```gherkin
Scenario: All buttons meet minimum touch target
  Given scanner move page rendered
  When measuring all interactive elements
  Then all buttons >= 48x48 pixels (48dp)
  And all tappable areas >= 48x48 pixels
  And spacing between targets >= 8 pixels

Scenario: Primary action buttons larger
  Given action buttons displayed
  Then "Scan" buttons >= 80x80 pixels
  And "Confirm Move" button = full-width, 56dp height

Scenario: List items tappable
  Given location picker list displayed
  Then each list row height >= 56 pixels
  And entire row is tappable area
  And visual feedback on tap (ripple/highlight)
```

### AC-12: Error Handling and Recovery (WH-NFR)

```gherkin
Scenario: Network error during move
  Given user confirming move
  When network request fails (timeout/offline)
  Then alert tone plays
  And error modal displays:
    - "Network error. Please try again."
    - "Retry" button
    - "Cancel" button
  And user data preserved for retry

Scenario: Retry after network error
  Given network error modal displayed
  When user taps "Retry"
  Then request resubmitted
  And loading indicator shows
  And on success, normal flow continues

Scenario: Session timeout
  Given warehouse_settings.scanner_idle_timeout_sec = 300
  And user idle for 300+ seconds
  Then session timeout warning displays at 4:30
  And at 5:00, session expires
  And user redirected to login

Scenario: Camera permission denied
  Given user attempts barcode scan
  When camera permission denied by device
  Then error message "Camera permission required for scanning"
  And "Open Settings" button to enable
  And "Manual Entry" fallback option
```

### AC-13: Performance Requirements (WH-NFR)

```gherkin
Scenario: Page load performance
  Given user navigates to /scanner/move
  Then page renders within 1 second
  And interactive within 1.5 seconds

Scenario: LP lookup response time
  Given camera scanner active
  When LP barcode scanned and decoded
  Then lookup API called within 50ms
  And response returned within 200ms total

Scenario: Location lookup response time
  Given camera scanner active
  When location barcode scanned
  Then lookup API called within 50ms
  And response returned within 100ms total

Scenario: Move execution performance
  Given user taps "Confirm Move"
  Then API call completes within 300ms
  And success feedback within 400ms total
```

### AC-14: RLS and Security (WH-NFR)

```gherkin
Scenario: Org isolation on LP lookup
  Given User A from Org A, LP belongs to Org B
  When User A requests LP lookup
  Then 404 Not Found returned (not 403)

Scenario: Org isolation on location lookup
  Given User A from Org A, location belongs to Org B
  When User A requests location lookup
  Then 404 Not Found returned

Scenario: Cannot move LP from different org
  Given User A from Org A
  And LP belongs to Org B
  When User A attempts POST /api/warehouse/scanner/move
  Then 404 Not Found returned
  And no stock_move created
```

---

## Technical Specification

### Database

No new tables required. Uses existing tables:
- `license_plates` (from Story 05.1)
- `stock_moves` (from Story 05.16)
- `locations` (from Story 01.9)

### API Endpoints

```
# Scanner Move Endpoints
POST   /api/warehouse/scanner/move                - Execute move
POST   /api/warehouse/scanner/validate-move       - Pre-validate move
GET    /api/warehouse/scanner/lookup/lp/:barcode  - Lookup LP by barcode
```

**Note:** Location lookup endpoint already exists from Story 05.19:
- `GET /api/warehouse/scanner/lookup/location/:barcode`

**POST /api/warehouse/scanner/move Request:**

```typescript
interface ScannerMoveRequest {
  lp_id: string;           // LP UUID
  to_location_id: string;  // Destination location UUID
  notes?: string;          // Optional move notes
}
```

**POST /api/warehouse/scanner/move Response:**

```typescript
interface ScannerMoveResponse {
  stock_move: {
    id: string;
    move_number: string;
    move_type: 'transfer';
    from_location_id: string;
    to_location_id: string;
    quantity: number;
    status: 'completed';
    move_date: string;
  };
  lp: {
    id: string;
    lp_number: string;
    location_id: string;
    location_path: string;
    product_name: string;
    quantity: number;
    uom: string;
  };
}
```

**POST /api/warehouse/scanner/validate-move Request:**

```typescript
interface ValidateMoveRequest {
  lp_id: string;
  to_location_id: string;
}
```

**POST /api/warehouse/scanner/validate-move Response:**

```typescript
interface ValidateMoveResponse {
  valid: boolean;
  errors: { field: string; message: string }[];
  warnings: { code: string; message: string }[];
  lp?: {
    id: string;
    lp_number: string;
    product_name: string;
    quantity: number;
    uom: string;
    current_location: string;
    status: string;
    qa_status: string;
  };
  destination?: {
    id: string;
    location_code: string;
    location_path: string;
    capacity_pct: number | null;
  };
}
```

### Service Layer

```typescript
// lib/services/scanner-move-service.ts

export interface ScannerMoveInput {
  lpId: string;
  toLocationId: string;
  notes?: string;
}

export interface ScannerMoveResult {
  stockMove: StockMove;
  lp: LicensePlate;
}

export interface LPLookupResult {
  id: string;
  lp_number: string;
  product: { id: string; name: string; sku: string };
  quantity: number;
  uom: string;
  location: { id: string; code: string; path: string };
  status: string;
  qa_status: string;
  batch_number: string | null;
  expiry_date: string | null;
}

export interface MoveValidationResult {
  valid: boolean;
  errors: { field: string; message: string }[];
  warnings: { code: string; message: string }[];
  lp?: LPLookupResult;
  destination?: {
    id: string;
    location_code: string;
    location_path: string;
    capacity_pct: number | null;
  };
}

export class ScannerMoveService {
  /**
   * Execute scanner move - main handler
   * - Validates LP (exists, available status)
   * - Validates destination (exists, active)
   * - Creates stock_move via StockMoveService
   * - Updates LP.location_id
   */
  static async processMove(input: ScannerMoveInput): Promise<ScannerMoveResult>;

  /**
   * Validate move without executing
   * Returns errors/warnings for UI feedback
   */
  static async validateMove(input: ScannerMoveInput): Promise<MoveValidationResult>;

  /**
   * Lookup LP by barcode (lp_number)
   * Returns full LP details for display
   */
  static async lookupLP(barcode: string): Promise<LPLookupResult | null>;

  /**
   * Check if LP can be moved
   * Returns validation result with reason
   */
  static async canMoveLP(lpId: string): Promise<{
    canMove: boolean;
    reason?: string;
  }>;
}
```

### Validation Schema (Zod)

```typescript
// lib/validation/scanner-move.ts
import { z } from 'zod';

export const scannerMoveSchema = z.object({
  lp_id: z.string().uuid("Invalid LP ID"),
  to_location_id: z.string().uuid("Invalid location ID"),
  notes: z.string().max(500, "Notes max 500 characters").optional().nullable(),
});

export const validateMoveSchema = z.object({
  lp_id: z.string().uuid("Invalid LP ID"),
  to_location_id: z.string().uuid("Invalid location ID"),
});

export const lpLookupSchema = z.object({
  barcode: z.string()
    .min(1, "Barcode required")
    .max(100, "Barcode too long"),
});

export type ScannerMoveInput = z.infer<typeof scannerMoveSchema>;
export type ValidateMoveInput = z.infer<typeof validateMoveSchema>;
```

---

## UI Components

```
app/(authenticated)/scanner/
  move/
    page.tsx                              -- Scanner move main page

components/scanner/
  move/
    ScannerMoveWizard.tsx                 -- 3-step wizard container
    Step1ScanLP.tsx                       -- Step 1: Scan LP
    Step2ScanDestination.tsx              -- Step 2: Scan destination
    Step3Confirm.tsx                      -- Step 3: Confirm move
    MoveSuccessScreen.tsx                 -- Success with actions
    LPSummaryCard.tsx                     -- Compact LP info card
    LocationSummaryCard.tsx               -- Compact location info card
    MoveDirectionArrow.tsx                -- Visual from -> to arrow

  shared/
    BarcodeScanner.tsx                    -- Camera barcode scanner (reuse from 05.19)
    BarcodeScanButton.tsx                 -- Large scan trigger button (reuse)
    AudioFeedback.tsx                     -- Audio feedback manager (reuse)
    HapticFeedback.tsx                    -- Haptic feedback utility (reuse)
    SuccessAnimation.tsx                  -- Green checkmark animation (reuse)
    ErrorAnimation.tsx                    -- Red X animation (reuse)
    LoadingOverlay.tsx                    -- Full-screen loading (reuse)
    ScannerHeader.tsx                     -- Scanner page header (reuse)
    StepProgress.tsx                      -- Step progress indicator (reuse)
    LargeTouchButton.tsx                  -- 48dp+ touch target button (reuse)
    LocationPicker.tsx                    -- Location selection modal
```

### Key Component Implementations

**Step1ScanLP.tsx**
```tsx
interface Step1ScanLPProps {
  onLPScanned: (lp: LPLookupResult) => void;
  onError: (error: string) => void;
}

// Features:
// - Large scan button (80x80dp)
// - Manual entry fallback
// - Recent moves list (quick repeat)
// - LP validation display
// - Error handling with retry
```

**Step2ScanDestination.tsx**
```tsx
interface Step2ScanDestinationProps {
  lp: LPLookupResult;
  onLocationScanned: (location: LocationResult) => void;
  onBack: () => void;
  onError: (error: string) => void;
}

// Features:
// - LP summary card at top
// - Large scan button
// - Manual location picker
// - Same-location validation
// - Capacity warnings
```

**Step3Confirm.tsx**
```tsx
interface Step3ConfirmProps {
  lp: LPLookupResult;
  destination: LocationResult;
  onConfirm: () => Promise<void>;
  onEditLP: () => void;
  onEditDestination: () => void;
  onCancel: () => void;
}

// Features:
// - Full move summary
// - Visual direction arrow
// - Edit buttons for each section
// - Full-width confirm button
// - Loading state on submit
```

**LPSummaryCard.tsx**
```tsx
interface LPSummaryCardProps {
  lp: LPLookupResult;
  compact?: boolean;  // true for Step 2, false for Step 3
  showStatus?: boolean;
  onEdit?: () => void;
}

// Displays: LP number, product name, qty, location, status badge
// Compact mode: single line with key info
// Full mode: detailed card with all fields
```

---

## Scanner UI Layout

### Step 1: Scan LP

```
+------------------------------------------+
| <- Back        Move LP           [?]     |  Header (56dp)
+------------------------------------------+
| Step 1 of 3: Scan LP                     |  Progress (32dp)
+------------------------------------------+
|                                          |
|          Point camera at LP              |
|          barcode to begin                |
|                                          |
|         +------------------+             |
|         |                  |             |
|         |   [SCAN ICON]    |             |
|         |                  |             |
|         +------------------+             |
|            80x80dp button                |
|                                          |
|         [ Scan LP Barcode ]              |  Primary (full-width)
|                                          |
|         Enter manually                   |  Link
|                                          |
+------------------------------------------+
```

### Step 2: Scan Destination

```
+------------------------------------------+
| <- Back        Move LP           [?]     |  Header (56dp)
+------------------------------------------+
| Step 2 of 3: Scan Destination            |  Progress (32dp)
+------------------------------------------+
| +--------------------------------------+ |
| | LP00000001  |  Product Name  | 100KG | |  LP Summary Card
| | From: Zone A > Aisle 01 > Rack 01    | |
| +--------------------------------------+ |
|                                          |
|          Scan destination                |
|          location barcode                |
|                                          |
|         +------------------+             |
|         |   [SCAN ICON]    |             |
|         +------------------+             |
|                                          |
|       [ Scan Destination ]               |  Primary
|                                          |
|       Select from list                   |  Link
|                                          |
+------------------------------------------+
```

### Step 3: Confirm Move

```
+------------------------------------------+
| <- Back        Move LP           [?]     |  Header (56dp)
+------------------------------------------+
| Step 3 of 3: Confirm Move                |  Progress (32dp)
+------------------------------------------+
| +--------------------------------------+ |
| | LICENSE PLATE                 [Edit] | |
| | LP00000001                           | |
| | Product Name - 100 KG                | |
| | Batch: BATCH-001  Exp: 2026-06-01    | |
| +--------------------------------------+ |
|                                          |
|              FROM                        |
|    Zone A > Aisle 01 > Rack 01          |
|              |                           |
|              v                           |
|              TO                          |
|    Zone B > Aisle 02 > Rack 05  [Edit]  |
|                                          |
+------------------------------------------+
|                                          |
|        [ CONFIRM MOVE ]                  |  Full-width, 56dp
|                                          |
|            Cancel                        |  Link
+------------------------------------------+
```

### Success Screen

```
+------------------------------------------+
|           Move Completed!                |  Header (centered)
+------------------------------------------+
|                                          |
|              [CHECKMARK]                 |  64x64 green
|                                          |
|           Move: SM-2025-00001            |
|           LP: LP00000001                 |
|           New Location:                  |
|           Zone B > Aisle 02 > Rack 05    |
|                                          |
+------------------------------------------+
|                                          |
| [ Move Another to Same Location ]        |  Primary
|                                          |
| [ New Move ]                             |  Secondary
|                                          |
| Done                                     |  Link
|                                          |
+------------------------------------------+
```

---

## Audio Feedback Specification

| Event | Frequency | Duration | Pattern | Web Audio API |
|-------|-----------|----------|---------|---------------|
| Valid LP scan | 880Hz | 200ms | Single tone | OscillatorNode |
| Valid location scan | 880Hz | 200ms | Single tone | OscillatorNode |
| Invalid scan | 220Hz | 300ms | Single tone | OscillatorNode |
| Move complete | 660Hz+880Hz | 500ms | Dual tone chord | 2x OscillatorNode |
| Network error | 440Hz | 400ms | Repeating (3x) | OscillatorNode |

---

## Key Business Rules

1. **LP Status Validation**: Only LPs with status='available' can be moved
2. **Location Validation**: Destination must exist and be active
3. **Same Location Check**: Cannot move LP to its current location
4. **Full LP Move**: This story handles full LP moves only (partial moves require 05.17 LP Split)
5. **Stock Move Creation**: All moves create stock_move record with move_type='transfer'
6. **Location Update**: LP.location_id updated atomically with stock_move creation
7. **Audio Feedback**: Enabled by default via `scanner_sound_feedback` setting
8. **Touch Targets**: All interactive elements minimum 48x48 pixels
9. **Response Times**: LP lookup < 200ms, Move execution < 300ms
10. **Multi-tenancy**: All operations scoped to user's org_id via RLS

---

## Deliverables

### API Routes
- [ ] `POST /api/warehouse/scanner/move` - Execute move
- [ ] `POST /api/warehouse/scanner/validate-move` - Pre-validation
- [ ] `GET /api/warehouse/scanner/lookup/lp/:barcode` - LP lookup

### Service Layer
- [ ] `ScannerMoveService.processMove()` - Main handler
- [ ] `ScannerMoveService.validateMove()` - Pre-validation
- [ ] `ScannerMoveService.lookupLP()` - LP lookup
- [ ] `ScannerMoveService.canMoveLP()` - Status check

### Validation
- [ ] `scannerMoveSchema` - Move request validation
- [ ] `validateMoveSchema` - Pre-validation schema
- [ ] `lpLookupSchema` - Barcode lookup validation

### Frontend Components
- [ ] Scanner move page (`/scanner/move`)
- [ ] 3-step wizard component
- [ ] Step 1: Scan LP
- [ ] Step 2: Scan Destination
- [ ] Step 3: Confirm Move
- [ ] Success screen with actions
- [ ] LP summary card component
- [ ] Location summary card component
- [ ] Move direction arrow component
- [ ] Location picker modal

### Shared Components (Reuse from 05.19)
- [ ] Barcode scanner component
- [ ] Audio feedback system
- [ ] Success/Error animations
- [ ] Loading overlay
- [ ] Step progress indicator

### Tests
- [ ] Unit tests: Scanner move service (>80% coverage)
- [ ] Integration tests: All scanner move API endpoints
- [ ] Validation tests: LP status, location status scenarios
- [ ] Touch target tests: All elements >= 48dp
- [ ] Audio tests: Feedback plays correctly
- [ ] E2E: Full scanner move flow
- [ ] RLS tests: Multi-tenancy isolation

---

## Test Cases

### Unit Tests

**File:** `__tests__/unit/services/scanner-move-service.test.ts`

| Test Case | Description |
|-----------|-------------|
| `processMove()` creates stock_move | Success flow |
| `processMove()` updates LP.location_id | Location update |
| `processMove()` rejects consumed LP | Status validation |
| `processMove()` rejects blocked LP | Status validation |
| `processMove()` rejects reserved LP | Status validation |
| `processMove()` rejects inactive location | Location validation |
| `processMove()` rejects same location | Same location check |
| `validateMove()` returns valid for good inputs | Happy path |
| `validateMove()` returns capacity warning | Warning generation |
| `validateMove()` returns errors for invalid LP | Error reporting |
| `lookupLP()` finds LP by number | Barcode match |
| `lookupLP()` returns null for missing LP | Not found |
| `canMoveLP()` returns true for available | Status check |
| `canMoveLP()` returns false with reason | Status check |

### Integration Tests

**File:** `__tests__/integration/api/warehouse/scanner-move.test.ts`

| Test Case | Description |
|-----------|-------------|
| `POST /scanner/move` creates stock_move | Success response |
| `POST /scanner/move` updates LP location | Location updated |
| `POST /scanner/move` with consumed LP returns 400 | Validation |
| `POST /scanner/move` with invalid location returns 404 | Not found |
| `POST /scanner/move` with same location returns 400 | Validation |
| `POST /scanner/move` cross-org returns 404 | RLS enforced |
| `POST /scanner/validate-move` returns valid | Pre-validation |
| `POST /scanner/validate-move` returns warnings | Capacity warning |
| `POST /scanner/validate-move` returns errors | Invalid LP |
| `GET /scanner/lookup/lp/:barcode` finds LP | Lookup success |
| `GET /scanner/lookup/lp/:barcode` returns 404 | Not found |
| Response times < 300ms | Performance |

### E2E Tests

**File:** `__tests__/e2e/scanner/move.spec.ts`

| Test Case | Description |
|-----------|-------------|
| Full scanner move flow | Steps 1-3 + success |
| Scan LP shows details | LP card displays |
| Scan destination shows details | Location card displays |
| Confirm executes move | Stock move created |
| Invalid LP shows error | Error handling |
| Invalid location shows error | Error handling |
| Same location blocked | Validation UI |
| Edit LP from confirmation | Navigation |
| Edit destination from confirmation | Navigation |
| Move another to same location | Quick repeat |
| Touch targets >= 48dp | Accessibility |

---

## Definition of Done

### API
- [ ] All endpoints return correct HTTP status codes
- [ ] LP not found returns 404, not available returns 400
- [ ] Location not found returns 404, inactive returns 400
- [ ] Cross-tenant access returns 404 (RLS enforced)
- [ ] Response times:
  - LP lookup: < 200ms
  - Location lookup: < 100ms
  - Move execution: < 300ms

### Service
- [ ] `processMove()` creates stock_move and updates LP atomically
- [ ] LP status validation (available only)
- [ ] Location validation (exists, active)
- [ ] Same-location check implemented
- [ ] Integration with StockMoveService (05.16)

### Frontend
- [ ] Mobile-optimized full-screen layout
- [ ] All touch targets >= 48dp
- [ ] 3-step wizard navigation
- [ ] Barcode scanner integration (camera)
- [ ] Manual entry fallback
- [ ] Audio feedback (success, error, confirm, alert)
- [ ] Visual feedback (animations, badges)
- [ ] High contrast color scheme
- [ ] Error handling with retry
- [ ] Quick repeat actions on success

### Testing
- [ ] Unit tests: >80% coverage on service
- [ ] Integration tests: All endpoints covered
- [ ] E2E tests: Full flow passing
- [ ] Touch target tests: All compliant
- [ ] Audio tests: All feedback working
- [ ] RLS tests: Multi-tenancy verified

---

## Risk Assessment

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Camera permission issues | HIGH | MEDIUM | Clear permission prompts, manual entry fallback |
| Barcode scanning reliability | MEDIUM | MEDIUM | Multiple barcode formats supported, manual fallback |
| Network latency on warehouse floor | HIGH | MEDIUM | Loading indicators, retry logic, future offline support |
| Touch targets too small on devices | MEDIUM | LOW | Test on multiple devices, minimum 48dp enforced |
| Audio feedback not playing | LOW | MEDIUM | Visual feedback primary, audio secondary |
| Integration with StockMoveService | LOW | LOW | 05.16 already implemented and tested |

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-01-15 | Initial story creation - Scanner Move Workflow | ARCHITECT-AGENT |
