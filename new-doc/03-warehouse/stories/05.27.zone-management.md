# 05.27 - Zone Management

**Story ID:** 05.27
**Epic:** 05 - Warehouse
**Phase:** 2 (Advanced Features)
**Complexity:** M (Medium)
**Estimate:** 3-4 days
**Type:** Full-stack
**Priority:** P2
**State:** ready

**Primary PRD:** `docs/1-BASELINE/product/modules/warehouse.md` (WH-FR-026)

## PRD References

| FR ID | Requirement | Priority | Phase | Covered |
|-------|-------------|----------|-------|---------|
| WH-FR-026 | Zone Management | P2 | 2 | Yes |

## User Story

**As a** warehouse administrator,
**I want** to organize warehouse locations into logical zones (receiving, storage, shipping, quarantine),
**So that** I can manage inventory flow efficiently and enable zone-based putaway suggestions.

**As a** warehouse operator,
**I want** products to be automatically suggested for putaway in their preferred zones,
**So that** I can quickly store items in the correct areas without manual lookup.

## Goal

Implement zone management to organize warehouse locations into logical groupings. Zones enable structured warehouse layouts, product preferred zone assignments, zone-based putaway suggestions, and zone-level inventory reporting.

## Scope

**In scope:**
- Zone CRUD (create, read, update, delete)
- Zone types: receiving, storage, shipping, quarantine
- Location-to-zone assignment (many locations per zone)
- Product preferred zone configuration
- Zone-based putaway suggestions (integrate with FIFO/FEFO)
- Zone inventory summary/reporting
- Zone capacity aggregation (from locations)
- Zone-based filtering in LP search

**Out of scope:**
- Zone-to-zone transfer rules (Phase 3)
- Zone access permissions (Phase 3)
- Zone temperature monitoring (Phase 3)
- Zone workflow automation (Phase 3)
- Visual zone layout/map (Phase 3)

## Dependencies

| Story | Requirement | Status |
|-------|-------------|--------|
| 01.9 | Locations CRUD | Required - zones group locations |
| 01.8 | Warehouses CRUD | Required - zones belong to warehouses |
| 05.0 | Warehouse Settings | Required - enable_location_zones flag |
| 05.1 | LP Table + Basic Service | Required - LP zone filtering |
| 05.3 | FIFO/FEFO Pick Suggestions | Optional - zone-aware suggestions |

## Acceptance Criteria (Given/When/Then)

### Zone CRUD (WH-FR-026)

#### Zone Creation
- GIVEN enable_location_zones is true in warehouse_settings, WHEN admin navigates to zone management, THEN zone management UI is accessible.
- GIVEN zone management UI, WHEN admin creates zone with zone_code, zone_name, zone_type, THEN zone record created with status='active'.
- GIVEN zone creation, WHEN zone_code already exists in same warehouse, THEN error "Zone code must be unique within warehouse" displays.
- GIVEN zone creation with valid data, WHEN saved, THEN zone created in <300ms with success toast.

#### Zone Types
- GIVEN zone type dropdown, WHEN admin selects type, THEN options include: receiving, storage, shipping, quarantine.
- GIVEN zone with type='receiving', WHEN displayed, THEN shows "Receiving" badge with appropriate icon.
- GIVEN zone with type='quarantine', WHEN LP moved to location in zone, THEN LP.qa_status validation may apply based on settings.

#### Zone Update
- GIVEN existing zone, WHEN admin updates zone_name or zone_type, THEN zone updates successfully.
- GIVEN zone with assigned locations, WHEN zone_code change attempted, THEN zone_code is immutable (cannot change).
- GIVEN zone update, WHEN saved, THEN updated_at timestamp refreshes.

#### Zone Delete
- GIVEN zone with no assigned locations, WHEN admin deletes zone, THEN zone removed successfully.
- GIVEN zone with assigned locations, WHEN admin attempts delete, THEN error "Remove locations from zone first" displays.
- GIVEN zone delete confirmation, WHEN user confirms, THEN zone deleted with success toast.

### Location-to-Zone Assignment

#### Assign Location to Zone
- GIVEN location without zone_id, WHEN admin assigns location to zone, THEN locations.zone_id updates to zone.id.
- GIVEN location with existing zone_id, WHEN admin changes zone, THEN locations.zone_id updates to new zone.id.
- GIVEN location assignment modal, WHEN zone dropdown displayed, THEN only zones from same warehouse shown.

#### Remove Location from Zone
- GIVEN location with zone_id, WHEN admin removes from zone, THEN locations.zone_id set to null.
- GIVEN zone view with assigned locations, WHEN location removed, THEN location no longer appears in zone's location list.

#### Bulk Location Assignment
- GIVEN multiple locations selected, WHEN admin assigns all to zone, THEN all locations.zone_id updated.
- GIVEN bulk assignment, WHEN different warehouses selected, THEN error "Locations must be in same warehouse as zone" displays.

### Product Preferred Zone

#### Configure Preferred Zone
- GIVEN product detail page, WHEN admin sets preferred_zone_id, THEN product linked to zone for putaway suggestions.
- GIVEN product with preferred_zone_id, WHEN displayed, THEN shows "Preferred Zone: {zone_name}" indicator.
- GIVEN preferred zone configuration, WHEN zone from different org selected, THEN 404 error (multi-tenancy).

#### Preferred Zone Validation
- GIVEN product with preferred_zone_id, WHEN zone deleted, THEN products.preferred_zone_id set to null (ON DELETE SET NULL).
- GIVEN product without preferred_zone_id, WHEN putaway suggested, THEN any available location in any zone suggested.

### Zone-Based Putaway Suggestions

#### Putaway Priority
- GIVEN LP for product with preferred_zone_id, WHEN putaway suggested, THEN locations in preferred zone prioritized.
- GIVEN preferred zone has no available locations, WHEN putaway suggested, THEN locations in other zones suggested with warning.
- GIVEN enable_fifo/enable_fefo settings, WHEN putaway suggested in zone, THEN FIFO/FEFO ordering applied within zone.

#### Suggestion Algorithm
- GIVEN putaway suggestion request, WHEN zone preference exists, THEN query: `locations WHERE zone_id = preferred_zone_id AND has_capacity ORDER BY FIFO/FEFO`.
- GIVEN no locations available in preferred zone, WHEN fallback applied, THEN query: `locations WHERE warehouse_id = ? AND has_capacity ORDER BY FIFO/FEFO`.
- GIVEN suggestion returned, WHEN displayed, THEN shows location code, zone name, and reason (e.g., "Preferred zone: Raw Materials").

### Zone Inventory Reporting

#### Zone Summary
- GIVEN zone with assigned locations, WHEN zone summary requested, THEN returns: total_lps, total_qty, total_weight, location_count.
- GIVEN zone inventory query, WHEN executed, THEN returns in <500ms.
- GIVEN zone summary, WHEN displayed, THEN shows aggregate values from all locations in zone.

#### Zone-Based LP Filter
- GIVEN LP list page, WHEN zone filter selected, THEN only LPs in locations belonging to zone returned.
- GIVEN zone filter, WHEN combined with other filters (product, status), THEN all filters applied.

#### Zone Capacity Summary
- GIVEN zone with locations having max_pallets, WHEN zone capacity requested, THEN aggregated: total_max_pallets, total_current_pallets, capacity_percent.
- GIVEN zone capacity at 90%+, WHEN displayed, THEN shows yellow/red warning indicator.

### Multi-tenancy

#### Org Isolation
- GIVEN User A from Org A, WHEN requesting zones, THEN only Org A's zones returned.
- GIVEN User A from Org A, WHEN attempting to access Org B's zone, THEN 404 Not Found (not 403).
- GIVEN zone assignment to location, WHEN zone.org_id differs from location.org_id, THEN assignment blocked.

## Technical Specification

### Database Schema

#### zones table

```sql
CREATE TYPE zone_type AS ENUM (
  'receiving',
  'storage',
  'shipping',
  'quarantine'
);

CREATE TABLE zones (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  warehouse_id UUID NOT NULL REFERENCES warehouses(id) ON DELETE CASCADE,

  -- Identity
  zone_code VARCHAR(50) NOT NULL,
  zone_name VARCHAR(255) NOT NULL,
  description TEXT,

  -- Type
  zone_type zone_type NOT NULL DEFAULT 'storage',

  -- Status
  is_active BOOLEAN DEFAULT true,

  -- Audit
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  created_by UUID REFERENCES users(id),
  updated_by UUID REFERENCES users(id),

  -- Constraints
  UNIQUE(org_id, warehouse_id, zone_code)
);

-- Indexes
CREATE INDEX idx_zones_org ON zones(org_id);
CREATE INDEX idx_zones_warehouse ON zones(warehouse_id);
CREATE INDEX idx_zones_type ON zones(zone_type);
CREATE INDEX idx_zones_active ON zones(is_active) WHERE is_active = true;

-- Updated_at trigger
CREATE TRIGGER set_zones_updated_at
BEFORE UPDATE ON zones
FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
```

#### locations table extension

```sql
-- Add zone_id to locations table
ALTER TABLE locations ADD COLUMN IF NOT EXISTS
  zone_id UUID REFERENCES zones(id) ON DELETE SET NULL;

-- Index for zone filtering
CREATE INDEX idx_locations_zone ON locations(zone_id);
```

#### products table extension

```sql
-- Add preferred_zone_id to products table
ALTER TABLE products ADD COLUMN IF NOT EXISTS
  preferred_zone_id UUID REFERENCES zones(id) ON DELETE SET NULL;

-- Index for product zone lookup
CREATE INDEX idx_products_preferred_zone ON products(preferred_zone_id);
```

### RLS Policies

```sql
-- Enable RLS
ALTER TABLE zones ENABLE ROW LEVEL SECURITY;

-- Select: Org isolation
CREATE POLICY "zones_select" ON zones
FOR SELECT TO authenticated
USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

-- Insert: Org isolation with warehouse ownership
CREATE POLICY "zones_insert" ON zones
FOR INSERT TO authenticated
WITH CHECK (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  AND warehouse_id IN (
    SELECT id FROM warehouses
    WHERE org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  )
);

-- Update: Org isolation
CREATE POLICY "zones_update" ON zones
FOR UPDATE TO authenticated
USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

-- Delete: Org isolation
CREATE POLICY "zones_delete" ON zones
FOR DELETE TO authenticated
USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));
```

### API Endpoints

```
Base: /api/warehouse/zones

# Zone CRUD
GET    /api/warehouse/zones                           - List zones (filter: warehouse_id, zone_type)
POST   /api/warehouse/zones                           - Create zone
GET    /api/warehouse/zones/:id                       - Get zone by ID
PUT    /api/warehouse/zones/:id                       - Update zone
DELETE /api/warehouse/zones/:id                       - Delete zone

# Zone Locations
GET    /api/warehouse/zones/:id/locations             - List locations in zone
POST   /api/warehouse/zones/:id/locations             - Assign locations to zone
DELETE /api/warehouse/zones/:id/locations/:locationId - Remove location from zone

# Zone Inventory
GET    /api/warehouse/zones/:id/summary               - Get zone inventory summary
GET    /api/warehouse/zones/:id/license-plates        - Get LPs in zone

# Putaway Suggestion (extension)
GET    /api/warehouse/putaway/suggest                 - Get putaway suggestion (zone-aware)
       Query params: product_id, warehouse_id, qty
```

**Query Parameters (List):**
- `warehouse_id` - Filter by warehouse (required)
- `zone_type` - Filter by type (receiving/storage/shipping/quarantine)
- `is_active` - Filter active/inactive zones
- `search` - Search by zone_code or zone_name

**Response (Zone):**
```typescript
interface Zone {
  id: string;
  org_id: string;
  warehouse_id: string;
  zone_code: string;
  zone_name: string;
  description: string | null;
  zone_type: 'receiving' | 'storage' | 'shipping' | 'quarantine';
  is_active: boolean;
  created_at: string;
  updated_at: string;
  // Computed
  location_count?: number;
  lp_count?: number;
  total_qty?: number;
  capacity_percent?: number;
}

interface ZoneSummary {
  zone_id: string;
  location_count: number;
  lp_count: number;
  total_qty: number;
  total_weight_kg: number;
  max_pallets: number | null;
  current_pallets: number;
  capacity_percent: number | null;
}
```

### Service Layer

**Zone Service:** `lib/services/zone-service.ts`

```typescript
interface ZoneService {
  // CRUD
  list(params: ZoneListParams): Promise<ZoneListResponse>;
  getById(id: string): Promise<Zone | null>;
  create(data: CreateZoneInput): Promise<Zone>;
  update(id: string, data: UpdateZoneInput): Promise<Zone>;
  delete(id: string): Promise<void>;

  // Location assignment
  getLocations(zoneId: string): Promise<Location[]>;
  assignLocations(zoneId: string, locationIds: string[]): Promise<void>;
  removeLocation(zoneId: string, locationId: string): Promise<void>;

  // Inventory
  getSummary(zoneId: string): Promise<ZoneSummary>;
  getLicensePlates(zoneId: string, params: LPListParams): Promise<LP[]>;

  // Putaway
  suggestPutawayLocation(productId: string, warehouseId: string, qty: number): Promise<PutawaySuggestion>;

  // Validation
  canDelete(zoneId: string): Promise<{ can: boolean; reason?: string; location_count?: number }>;
  validateLocationAssignment(zoneId: string, locationId: string): Promise<boolean>;
}

interface ZoneListParams {
  warehouse_id: string;
  zone_type?: ZoneType;
  is_active?: boolean;
  search?: string;
}

interface PutawaySuggestion {
  location_id: string;
  location_code: string;
  location_full_path: string;
  zone_id: string | null;
  zone_name: string | null;
  reason: string; // "Preferred zone: Raw Materials" or "Fallback: no capacity in preferred zone"
  available_capacity: number;
}
```

### Zod Validation Schemas

**Zone:** `lib/validation/zone.ts`

```typescript
import { z } from 'zod';

const zoneTypeEnum = z.enum(['receiving', 'storage', 'shipping', 'quarantine']);

export const createZoneSchema = z.object({
  warehouse_id: z.string().uuid('Invalid warehouse ID'),
  zone_code: z.string()
    .min(1, 'Zone code is required')
    .max(50, 'Zone code max 50 characters')
    .regex(/^[A-Z0-9-]+$/, 'Zone code must be uppercase alphanumeric with hyphens'),
  zone_name: z.string()
    .min(2, 'Zone name min 2 characters')
    .max(255, 'Zone name max 255 characters'),
  description: z.string().max(1000).nullable().optional(),
  zone_type: zoneTypeEnum.default('storage'),
  is_active: z.boolean().default(true),
});

export const updateZoneSchema = createZoneSchema
  .omit({ zone_code: true, warehouse_id: true }) // Immutable fields
  .partial();

export const zoneQuerySchema = z.object({
  warehouse_id: z.string().uuid('Invalid warehouse ID'),
  zone_type: zoneTypeEnum.optional(),
  is_active: z.coerce.boolean().optional(),
  search: z.string().min(2).optional(),
});

export const assignLocationsSchema = z.object({
  location_ids: z.array(z.string().uuid()).min(1, 'At least one location required'),
});

export const putawaySuggestionQuerySchema = z.object({
  product_id: z.string().uuid('Invalid product ID'),
  warehouse_id: z.string().uuid('Invalid warehouse ID'),
  qty: z.coerce.number().positive('Quantity must be positive').optional(),
});
```

## UI Components

### Pages

- `app/(authenticated)/warehouse/zones/page.tsx` - Zone list page
- `app/(authenticated)/warehouse/zones/[id]/page.tsx` - Zone detail page (optional)

### Components

**Location:** `components/warehouse/zones/`

```
ZonesList.tsx                - List of zones with filters
ZoneCard.tsx                 - Zone summary card with stats
ZoneModal.tsx                - Create/edit zone modal
ZoneLocationsList.tsx        - Locations assigned to zone
AssignLocationsModal.tsx     - Modal to assign locations to zone
ZoneTypeSelect.tsx           - Zone type dropdown with icons
ZoneSummaryCard.tsx          - Zone inventory/capacity summary
ZoneCapacityIndicator.tsx    - Visual capacity bar for zone
```

### Component Details

**ZonesList.tsx**
```tsx
interface ZonesListProps {
  warehouseId: string;
  zones: Zone[];
  onSelect: (zone: Zone) => void;
  onEdit: (zone: Zone) => void;
  onDelete: (zone: Zone) => void;
  isLoading: boolean;
}
```

**ZoneModal.tsx**
```tsx
interface ZoneModalProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  warehouseId: string;
  zone?: Zone; // Edit mode if provided
  onSuccess: () => void;
}

// Form sections:
// 1. Identity - Zone code (uppercase), Zone name, Description
// 2. Type - Zone type dropdown with descriptions
// 3. Status - Active toggle
```

**AssignLocationsModal.tsx**
```tsx
interface AssignLocationsModalProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  zone: Zone;
  availableLocations: Location[]; // Locations not assigned to any zone
  onSuccess: () => void;
}
```

**ZoneSummaryCard.tsx**
```tsx
interface ZoneSummaryCardProps {
  zone: Zone;
  summary: ZoneSummary;
}

// Displays:
// - Zone name and type badge
// - Location count
// - LP count
// - Total quantity
// - Capacity bar (if locations have capacity)
```

### UI Patterns

**Zone Card Layout:**
```
+--------------------------------------------+
| [Storage]  RAW-MATERIALS                   |
| Raw Materials Zone                         |
|                                            |
| Locations: 12    LPs: 156    Qty: 4,250    |
|                                            |
| Capacity: [========--] 80%                 |
|                                            |
| [Edit] [View Locations] [Delete]           |
+--------------------------------------------+
```

**Zone Type Icons:**
- Receiving: ArrowDownToLine
- Storage: Warehouse
- Shipping: Truck
- Quarantine: AlertTriangle

### Page Layout

**Zones List Page:**
```
+--------------------------------------------------+
| Warehouse: [Dropdown]   Type: [All v]   [Search] |
+--------------------------------------------------+
| [+ Create Zone]                                  |
|                                                  |
| +--Zone Cards Grid (3 columns)--+                |
| |                               |                |
| | [Receiving] [Storage] [Ship]  |                |
| |                               |                |
| +-------------------------------+                |
+--------------------------------------------------+
```

## Test Cases

### Unit Tests

**zone-service.test.ts**
```typescript
describe('ZoneService', () => {
  describe('create', () => {
    it('creates zone with valid data');
    it('rejects duplicate zone_code in same warehouse');
    it('allows same zone_code in different warehouses');
    it('validates zone_type enum');
  });

  describe('delete', () => {
    it('deletes zone with no locations');
    it('rejects delete when locations assigned');
    it('returns location_count in canDelete');
  });

  describe('assignLocations', () => {
    it('assigns multiple locations to zone');
    it('validates location belongs to same warehouse as zone');
    it('rejects locations from different org');
  });

  describe('getSummary', () => {
    it('returns correct aggregated stats');
    it('calculates capacity_percent correctly');
    it('handles zones with no locations');
  });

  describe('suggestPutawayLocation', () => {
    it('suggests location in preferred zone first');
    it('falls back to other zones when preferred full');
    it('applies FIFO/FEFO ordering within zone');
    it('returns reason with suggestion');
  });
});
```

### Integration Tests

**zone-api.test.ts**
```typescript
describe('Zone API', () => {
  describe('GET /api/warehouse/zones', () => {
    it('returns zones for specified warehouse');
    it('filters by zone_type');
    it('filters by is_active');
    it('searches by zone_code and zone_name');
    it('returns 400 without warehouse_id');
  });

  describe('POST /api/warehouse/zones', () => {
    it('creates zone with valid data');
    it('rejects duplicate zone_code');
    it('rejects invalid zone_type');
    it('enforces org isolation');
  });

  describe('DELETE /api/warehouse/zones/:id', () => {
    it('deletes empty zone');
    it('rejects delete with assigned locations');
    it('returns 404 for other org zone');
  });

  describe('POST /api/warehouse/zones/:id/locations', () => {
    it('assigns locations to zone');
    it('validates location warehouse matches zone warehouse');
    it('handles bulk assignment');
  });

  describe('GET /api/warehouse/zones/:id/summary', () => {
    it('returns aggregated zone stats');
    it('calculates capacity correctly');
  });

  describe('GET /api/warehouse/putaway/suggest', () => {
    it('returns location in preferred zone');
    it('includes zone_name in response');
    it('falls back when preferred zone full');
  });
});
```

### E2E Tests

**zone-management.spec.ts**
```typescript
describe('Zone Management', () => {
  it('displays zones list for warehouse');
  it('creates new zone with all fields');
  it('validates zone_code format');
  it('edits zone name and type');
  it('shows location count on zone card');
  it('assigns locations to zone');
  it('removes location from zone');
  it('deletes empty zone');
  it('prevents delete of zone with locations');
  it('filters zones by type');
  it('searches zones by name');
});
```

**zone-putaway.spec.ts**
```typescript
describe('Zone-Based Putaway', () => {
  it('suggests location in product preferred zone');
  it('shows zone name in suggestion');
  it('shows fallback warning when preferred zone full');
  it('respects FIFO ordering within zone');
});
```

## Security Considerations

1. **Multi-tenancy Isolation**
   - All zone queries filtered by org_id via RLS
   - Zone-location assignment validates same org
   - Cross-tenant access returns 404 (not 403)

2. **Data Integrity**
   - Zone code immutable after creation
   - Cascade delete protection via FK constraints
   - Location assignment validates same warehouse

3. **Authorization**
   - Zone management requires admin role
   - Read access for operators (for putaway suggestions)

## Performance Considerations

1. **Zone Summary Query**
   - Aggregate locations and LPs in single query
   - Use materialized view or caching for large zones
   - Target <500ms for zone with 100+ locations

2. **Putaway Suggestion**
   - Index on locations.zone_id for fast filtering
   - Combined query with FIFO/FEFO ordering
   - Target <300ms response time

3. **Zone List**
   - Include location_count in list query (subquery)
   - Pagination for warehouses with many zones

## Deliverables

- [ ] `zones` table migration
- [ ] `locations.zone_id` column migration
- [ ] `products.preferred_zone_id` column migration
- [ ] RLS policies for zones table
- [ ] Zone service (`lib/services/zone-service.ts`)
- [ ] Zod schemas (`lib/validation/zone.ts`)
- [ ] API routes for zone CRUD
- [ ] API routes for location assignment
- [ ] API route for zone summary
- [ ] Putaway suggestion endpoint (zone-aware)
- [ ] ZonesList component
- [ ] ZoneCard component
- [ ] ZoneModal component
- [ ] AssignLocationsModal component
- [ ] ZoneSummaryCard component
- [ ] Zones list page
- [ ] Unit tests (>80% coverage)
- [ ] Integration tests
- [ ] E2E tests

## Definition of Done

- [ ] Zones table created with all fields and constraints
- [ ] Location-to-zone assignment works (zone_id FK)
- [ ] Product preferred zone works (preferred_zone_id FK)
- [ ] RLS policies enforce org isolation
- [ ] Zone CRUD API endpoints functional
- [ ] Zone summary returns aggregated stats correctly
- [ ] Putaway suggestion prioritizes preferred zone
- [ ] Fallback suggestion works when preferred zone full
- [ ] Zone type dropdown shows all 4 types with icons
- [ ] Zone cards display location/LP counts
- [ ] Capacity indicator shows correct percentage
- [ ] Bulk location assignment works
- [ ] Delete blocked for zones with locations
- [ ] Zone code uniqueness enforced per warehouse
- [ ] Cross-tenant access returns 404
- [ ] Unit test coverage >= 80%
- [ ] Integration tests pass
- [ ] E2E tests pass
- [ ] Loading states for all async operations
- [ ] Error handling with user-friendly messages
- [ ] Toast notifications on success/error

## Version History

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| 1.0 | 2026-01-15 | ARCHITECT-AGENT | Initial story creation |
