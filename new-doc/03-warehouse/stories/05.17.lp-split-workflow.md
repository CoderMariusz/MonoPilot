# 05.17 - LP Split Workflow

**Priority**: P2 (Phase 2)
**Story Points**: M (3-4 days)
**Type:** backend + frontend

**State:** ready
**Primary PRD:** `docs/1-BASELINE/product/modules/warehouse.md` (WH-FR-006)
**Architecture:** `docs/1-BASELINE/architecture/modules/warehouse.md`

---

## MVP Scope

LP Split Workflow enables splitting one License Plate into two, with the split quantity moved to a new LP and the source LP quantity reduced accordingly. This is **Phase 2 functionality** for handling partial LP movements and adjustments.

**Phase 2 MVP includes:**
- Split service method with database transaction
- API endpoint `POST /api/warehouse/license-plates/:id/split`
- Desktop UI: Split modal with quantity validation
- Automatic genealogy link creation (operation_type='split')
- Settings toggle: `enable_split_merge` (Warehouse Settings 05.0)
- New LP inherits product, UoM, batch, expiry, QA status from source
- Destination location support (move split quantity to different location)
- Auto-generated LP number for new LP
- Input validation: split_qty < source.quantity
- Service-level transaction (atomic operation)
- Unit tests for validation and business rules
- E2E test for split workflow

**Phase 2 EXCLUDES:**
- Scanner split workflow (Story 05.20 - Phase 2)
- Bulk split operations (Phase 3)
- Split templates/presets (Phase 3)
- Split reversal UI (use consumption correction pattern)
- Split analytics/reporting (Phase 4)

---

## Epic 04 Dependency Status

- [ ] CRITICAL - Unblocks Epic 04 Phase 1
- [x] **NOT CRITICAL - Can defer to Phase 2**

**Relationship to Epic 04:**
While Epic 04 Production doesn't require split functionality for MVP, split operations are commonly used to handle partial consumption scenarios. Story 05.6 (LP Split/Merge) was originally listed in Phase 0, but analysis shows Epic 04 can function without it if full LP consumption is enforced initially.

**When Split Becomes Valuable:**
- Partial LP consumption in production (consume 50kg from 100kg LP)
- Warehouse movements of partial quantities
- Adjustments when LP quantity needs to be split across locations
- Rework/repackaging scenarios

---

## Goal

Implement the LP Split workflow to enable splitting one License Plate into two, with proper quantity tracking, genealogy linking, and location management for warehouse flexibility.

## User Story

As a **warehouse operator**, I want **to split a License Plate into two separate LPs** so that **I can move partial quantities to different locations, handle partial consumption, or adjust inventory when needed**.

## Scope

**In scope (this story)**
- Desktop split workflow:
  - Split button on LP detail page
  - Split modal with quantity input and destination location selector
  - Validation: split_qty < source.quantity
  - Preview of new LP before confirmation
- Backend service method: `splitLicensePlate(lpId, splitQty, destinationLocationId?)`
- Database transaction:
  1. Validate source LP (status='available', qa_status='passed')
  2. Create new LP with split_qty (auto-generated number)
  3. Reduce source LP.quantity by split_qty
  4. Create genealogy record (operation_type='split')
- API endpoint: `POST /api/warehouse/license-plates/:id/split`
- Settings toggle: `enable_split_merge` (check before allowing operation)
- New LP inherits from source:
  - product_id, uom
  - batch_number, supplier_batch_number
  - expiry_date, manufacture_date
  - qa_status
  - warehouse_id
  - source = 'split' (vs 'manual', 'receipt', 'production')
- Optional destination location (defaults to same location as source)
- Zod validation schemas
- Unit tests for business rules
- E2E test for split modal workflow

**Out of scope (this story)**
- Scanner split (Story 05.20)
- LP merge workflow (Story 05.18 - separate story)
- Bulk split (split into 3+ LPs) - Phase 3
- Split reversal UI - use genealogy reversal pattern
- Split history report - Phase 4

## Dependencies

- **05.0** - Warehouse Settings (`enable_split_merge` toggle)
- **05.1** - LP Table + Basic Service (`license_plates` table, LP service methods)
- **05.2** - LP Genealogy (`lp_genealogy` table, `linkSplit()` service method)
- **01.1** - Multi-tenancy (RLS, org_id filtering)
- **01.8, 01.9** - Warehouses, Locations (location selector)
- **02.1** - Products (product context for validation)

---

## Acceptance Criteria (Given/When/Then)

### AC-1: Split Modal Display

**Given** user views LP detail page for LP-001 (qty: 100, status='available')
**When** user clicks "Split LP" button
**Then**
- Split modal opens with title "Split License Plate: LP-001"
- Current quantity displayed: "Current: 100 kg"
- Split quantity input field visible (with validation)
- Destination location selector shown (default: current location)
- "New LP Number" field shows auto-generated number (read-only)
- Preview panel shows:
  - Source LP after split: LP-001, qty: [100 - split_qty]
  - New LP: [auto-generated], qty: [split_qty]
- "Split" button enabled (primary)
- "Cancel" button visible

### AC-2: Split Quantity Validation (Valid)

**Given** split modal open for LP-001 (qty: 100)
**When** user enters split_qty = 40
**Then**
- No validation error shown
- Preview updates:
  - Source LP after split: LP-001, qty: 60 kg
  - New LP: LP-000002, qty: 40 kg
- "Split" button remains enabled
- Split operation can proceed

### AC-3: Split Quantity Validation (Invalid - Greater Than or Equal to Source)

**Given** split modal open for LP-001 (qty: 100)
**When** user enters split_qty = 100 (or 120)
**Then**
- Validation error displayed: "Split quantity must be less than current LP quantity (100 kg)"
- "Split" button disabled
- Preview panel shows error state
- Cannot proceed with split

### AC-4: Split Quantity Validation (Invalid - Zero or Negative)

**Given** split modal open for LP-001 (qty: 100)
**When** user enters split_qty = 0 (or -10)
**Then**
- Validation error displayed: "Split quantity must be greater than 0"
- "Split" button disabled
- Cannot proceed with split

### AC-5: Destination Location Selection

**Given** split modal open for LP-001 (current location: "Warehouse A / Zone B / Rack-01")
**When** modal loads
**Then**
- Destination location selector defaults to current location
- User can select different location from dropdown
- Selected location displayed in preview: "New LP will be at: [location]"
- If different location selected, preview updates to show new location

### AC-6: Settings Toggle Check

**Given** `warehouse_settings.enable_split_merge = false`
**When** user views LP detail page
**Then**
- "Split LP" button is hidden or disabled
- If user attempts API call directly, returns 403 error: "Split/merge operations are disabled in settings"
- Settings must be enabled to access split functionality

### AC-7: Split Operation Execution (Same Location)

**Given** LP-001 (qty: 100, product: "Flour 25kg", batch: "BATCH-123", location: "Rack-01")
**When** user executes split with split_qty = 30, destination = "Rack-01" (same location)
**Then**
- Database transaction completes in <300ms
- Source LP updated:
  - LP-001.quantity = 70 (100 - 30)
  - LP-001.updated_at = current timestamp
  - LP-001.location_id unchanged
- New LP created:
  - lp_number = "LP-000002" (auto-generated)
  - quantity = 30
  - product_id = same as LP-001
  - uom = same as LP-001
  - batch_number = "BATCH-123" (inherited)
  - expiry_date = same as LP-001
  - qa_status = same as LP-001
  - location_id = "Rack-01" (same as source)
  - source = 'split'
  - parent_lp_id = LP-001.id
  - status = 'available'
- Genealogy record created:
  - parent_lp_id = LP-001.id
  - child_lp_id = LP-000002.id
  - operation_type = 'split'
  - quantity = 30
  - wo_id = null (split is not production operation)
- Success message: "LP split successfully. New LP: LP-000002"
- Modal closes, LP detail page refreshes

### AC-8: Split Operation Execution (Different Location)

**Given** LP-001 (qty: 100, location: "Rack-01")
**When** user executes split with split_qty = 40, destination = "Rack-05"
**Then**
- Source LP updated: LP-001.quantity = 60, location_id = "Rack-01" (unchanged)
- New LP created: LP-000002.quantity = 40, location_id = "Rack-05" (different)
- Genealogy record created with operation_type='split'
- Both LPs exist in system with different locations
- Success message includes location info: "LP split successfully. New LP LP-000002 created at Rack-05"

### AC-9: Split Inherits All Tracking Fields

**Given** source LP with full tracking data:
  - batch_number = "BATCH-123"
  - supplier_batch_number = "SUP-456"
  - expiry_date = "2025-12-31"
  - manufacture_date = "2024-01-15"
  - qa_status = "passed"
**When** split operation executed
**Then**
- New LP inherits all fields:
  - batch_number = "BATCH-123" (same)
  - supplier_batch_number = "SUP-456" (same)
  - expiry_date = "2025-12-31" (same)
  - manufacture_date = "2024-01-15" (same)
  - qa_status = "passed" (same)
- Fields NOT inherited/carried:
  - lp_number (new auto-generated)
  - id (new UUID)
  - created_at (current timestamp)
  - po_number (cleared)
  - grn_id (cleared)
  - wo_id (cleared)

### AC-10: Split Status Validation (LP Not Available)

**Given** LP-001 with status = 'reserved' (or 'consumed', 'blocked')
**When** user attempts to split
**Then**
- "Split LP" button disabled with tooltip: "Cannot split LP with status: reserved"
- If API call attempted, returns 400 error: "Cannot split LP. Status must be 'available'. Current status: reserved"
- Split operation rejected

### AC-11: Split QA Status Validation (QA Pending or Failed)

**Given** LP-001 with qa_status = 'pending' (or 'failed', 'quarantine')
**When** user attempts to split
**Then**
- Warning displayed: "This LP has QA status: pending. Split will inherit this status."
- User can proceed with acknowledgement
- New LP created with qa_status = 'pending' (inherited)
- Both LPs remain with pending QA status

### AC-12: Transaction Atomicity (Rollback on Error)

**Given** split operation in progress
**When** error occurs during transaction (e.g., database constraint failure, genealogy creation fails)
**Then**
- Entire transaction rolled back
- Source LP.quantity unchanged (remains 100)
- New LP not created
- No genealogy record created
- Error message displayed: "Split failed: [error details]. No changes made."
- System state remains consistent

### AC-13: Auto-Generated LP Number

**Given** LP number sequence at "LP-000042"
**When** split operation executed
**Then**
- New LP receives number "LP-000043"
- Sequence increments by 1
- LP number format follows org settings (prefix + zero-padded)
- New LP number displayed in preview before split
- Uniqueness enforced (org_id, lp_number unique constraint)

### AC-14: API Endpoint - Success Response

**Given** valid split request
**When** `POST /api/warehouse/license-plates/LP-001/split` with body:
```json
{
  "splitQty": 30,
  "destinationLocationId": "loc-456"
}
```
**Then**
- Response 200 OK:
```json
{
  "success": true,
  "sourceLp": {
    "id": "lp-001-id",
    "lpNumber": "LP-001",
    "quantity": 70,
    "location": { "id": "loc-123", "name": "Rack-01" }
  },
  "newLp": {
    "id": "lp-002-id",
    "lpNumber": "LP-000002",
    "quantity": 30,
    "location": { "id": "loc-456", "name": "Rack-05" }
  },
  "genealogyId": "gen-001-id"
}
```
- Response time <300ms

### AC-15: API Endpoint - Validation Error Response

**Given** invalid split request (split_qty >= source.quantity)
**When** API receives request with splitQty = 100 for LP with quantity = 100
**Then**
- Response 400 Bad Request:
```json
{
  "error": "Split quantity must be less than LP quantity",
  "details": {
    "splitQty": 100,
    "currentQty": 100
  }
}
```

### AC-16: API Endpoint - LP Not Found

**Given** split request for non-existent LP
**When** `POST /api/warehouse/license-plates/invalid-id/split`
**Then**
- Response 404 Not Found:
```json
{
  "error": "License Plate not found",
  "lpId": "invalid-id"
}
```

### AC-17: API Endpoint - Settings Disabled

**Given** `enable_split_merge = false` in warehouse settings
**When** split request submitted
**Then**
- Response 403 Forbidden:
```json
{
  "error": "Split/merge operations are disabled",
  "message": "Enable 'enable_split_merge' in warehouse settings to use this feature"
}
```

### AC-18: Desktop UI - Loading State

**Given** split operation in progress
**When** user clicks "Split" button
**Then**
- "Split" button shows loading spinner
- Button text changes to "Splitting..."
- Form inputs disabled during operation
- Modal cannot be closed during operation
- Operation completes within 2 seconds (or timeout error)

### AC-19: Desktop UI - Success Feedback

**Given** split operation completed successfully
**When** operation finishes
**Then**
- Success toast notification: "LP split successfully"
- Toast includes link: "View new LP: LP-000002" (clickable)
- Modal closes automatically
- LP detail page refreshes to show updated quantity
- Genealogy panel updates to show split operation

### AC-20: Desktop UI - Error Feedback

**Given** split operation fails
**When** error returned from API
**Then**
- Error toast notification: "Split failed: [error message]"
- Modal remains open (allows user to correct input)
- Form inputs re-enabled
- User can retry operation or cancel

### AC-21: Genealogy Link Verification

**Given** split operation completed (LP-001 split into LP-002)
**When** user views genealogy for LP-001 (forward trace)
**Then**
- Genealogy panel shows descendant: LP-002
- Operation badge: "Split" (with icon)
- Quantity shown: 30 kg
- Date/time of split operation displayed
- Clicking LP-002 navigates to its detail page

**And when** user views genealogy for LP-002 (backward trace)
**Then**
- Genealogy panel shows ancestor: LP-001
- Operation badge: "Split" (from)
- Indicates LP-002 was split from LP-001

### AC-22: Permission Check (RLS)

**Given** user belongs to org_id = 'org-abc'
**When** user attempts to split LP belonging to org_id = 'org-xyz'
**Then**
- API returns 403 Forbidden: "Access denied"
- RLS policy prevents cross-org split operations
- No data leakage between organizations

### AC-23: Performance - Split Operation

**Given** split operation request
**When** executed
**Then**
- Database transaction completes in <300ms (per PRD AC)
- Total API response time <500ms
- UI feedback displayed within 1 second
- No noticeable lag in user experience

### AC-24: Audit Trail

**Given** split operation completed
**When** audit log queried
**Then**
- Audit log entry records:
  - Action: "LP Split"
  - User: current user ID
  - Timestamp: operation time
  - Source LP: LP-001, quantity before/after (100 -> 70)
  - New LP: LP-000002, quantity (30)
  - Location: source and destination locations
  - Genealogy ID: reference to genealogy record
- Full audit trail maintained for compliance

### AC-25: Edge Case - Split Decimals

**Given** LP-001 with quantity = 100.5 kg (decimal)
**When** user splits with split_qty = 40.25 kg
**Then**
- Source LP updated: quantity = 60.25 kg (100.5 - 40.25)
- New LP created: quantity = 40.25 kg
- Decimal precision maintained (4 decimal places per schema)
- No rounding errors
- Validation allows decimal input for split_qty

---

## Implementation Notes

### API Endpoint

```typescript
POST /api/warehouse/license-plates/:id/split

Request Body:
{
  splitQty: number;              // Required: Quantity to split off
  destinationLocationId?: string; // Optional: Destination location for new LP (defaults to source location)
}

Response 200 OK:
{
  success: true;
  sourceLp: {
    id: string;
    lpNumber: string;
    quantity: number;
    location: { id: string; name: string };
  };
  newLp: {
    id: string;
    lpNumber: string;
    quantity: number;
    location: { id: string; name: string };
  };
  genealogyId: string;
}

Response 400 Bad Request:
{
  error: string;
  details?: any;
}

Response 403 Forbidden:
{
  error: string;
  message: string;
}

Response 404 Not Found:
{
  error: string;
  lpId: string;
}
```

### Database Transaction Flow

```typescript
BEGIN TRANSACTION;

-- 1. Validate source LP
SELECT * FROM license_plates
WHERE id = $lpId AND org_id = $orgId AND status = 'available'
FOR UPDATE; -- Lock row for update

-- If not found or status != 'available', ROLLBACK

-- 2. Validate split_qty < source.quantity
-- If split_qty >= source.quantity, ROLLBACK

-- 3. Check warehouse settings
SELECT enable_split_merge FROM warehouse_settings
WHERE org_id = $orgId;

-- If false, ROLLBACK

-- 4. Generate new LP number
SELECT generate_lp_number($orgId); -- Returns next sequence

-- 5. Create new LP (inherits from source)
INSERT INTO license_plates (
  org_id,
  lp_number,
  product_id,
  quantity,
  uom,
  location_id,
  warehouse_id,
  status,
  qa_status,
  batch_number,
  supplier_batch_number,
  expiry_date,
  manufacture_date,
  parent_lp_id,
  source,
  created_by
) VALUES (
  $orgId,
  $newLpNumber,
  (SELECT product_id FROM license_plates WHERE id = $lpId),
  $splitQty,
  (SELECT uom FROM license_plates WHERE id = $lpId),
  COALESCE($destinationLocationId, (SELECT location_id FROM license_plates WHERE id = $lpId)),
  (SELECT warehouse_id FROM license_plates WHERE id = $lpId),
  'available',
  (SELECT qa_status FROM license_plates WHERE id = $lpId),
  (SELECT batch_number FROM license_plates WHERE id = $lpId),
  (SELECT supplier_batch_number FROM license_plates WHERE id = $lpId),
  (SELECT expiry_date FROM license_plates WHERE id = $lpId),
  (SELECT manufacture_date FROM license_plates WHERE id = $lpId),
  $lpId,
  'split',
  $userId
) RETURNING *;

-- 6. Update source LP quantity
UPDATE license_plates
SET quantity = quantity - $splitQty,
    updated_at = NOW()
WHERE id = $lpId;

-- 7. Create genealogy record
INSERT INTO lp_genealogy (
  org_id,
  parent_lp_id,
  child_lp_id,
  operation_type,
  quantity,
  operation_date,
  created_by
) VALUES (
  $orgId,
  $lpId,
  $newLpId,
  'split',
  $splitQty,
  NOW(),
  $userId
) RETURNING id;

COMMIT;
```

### Frontend Components

```
app/(authenticated)/warehouse/license-plates/[id]/
  page.tsx                              -- LP detail page (add Split button)
  components/
    LPSplitModal.tsx                   -- Split modal component
    LPSplitPreview.tsx                 -- Preview panel (before/after)
    LPSplitQuantityInput.tsx           -- Quantity input with validation
    LPLocationSelector.tsx             -- Destination location dropdown
```

### Services

```typescript
// lib/services/lp-split-service.ts

import { supabase } from '@/lib/supabase';
import { getOrgIdFromContext, getUserIdFromContext } from '@/lib/auth-utils';
import { linkSplit } from './lp-genealogy-service';
import { generateLpNumber } from './lp-number-service';
import { NotFoundError, ValidationError, ForbiddenError } from '@/lib/errors';

export interface SplitLPRequest {
  lpId: string;
  splitQty: number;
  destinationLocationId?: string;
}

export interface SplitLPResult {
  success: true;
  sourceLp: {
    id: string;
    lpNumber: string;
    quantity: number;
    location: { id: string; name: string };
  };
  newLp: {
    id: string;
    lpNumber: string;
    quantity: number;
    location: { id: string; name: string };
  };
  genealogyId: string;
}

/**
 * Split a License Plate into two
 * Creates new LP with split_qty, reduces source LP by split_qty
 * Creates genealogy record
 *
 * @throws {NotFoundError} LP not found
 * @throws {ValidationError} Invalid split_qty or LP status
 * @throws {ForbiddenError} Settings disabled or permission denied
 */
export async function splitLicensePlate(
  request: SplitLPRequest
): Promise<SplitLPResult> {
  const { lpId, splitQty, destinationLocationId } = request;
  const orgId = await getOrgIdFromContext();
  const userId = await getUserIdFromContext();

  // 1. Check warehouse settings
  const { data: settings } = await supabase
    .from('warehouse_settings')
    .select('enable_split_merge')
    .eq('org_id', orgId)
    .single();

  if (!settings?.enable_split_merge) {
    throw new ForbiddenError('Split/merge operations are disabled in settings');
  }

  // 2. Fetch and validate source LP
  const { data: sourceLp, error: fetchError } = await supabase
    .from('license_plates')
    .select(`
      *,
      location:locations(id, name),
      warehouse:warehouses(id, name)
    `)
    .eq('id', lpId)
    .eq('org_id', orgId)
    .single();

  if (fetchError || !sourceLp) {
    throw new NotFoundError('License Plate not found');
  }

  // 3. Validate LP status
  if (sourceLp.status !== 'available') {
    throw new ValidationError(
      `Cannot split LP. Status must be 'available'. Current status: ${sourceLp.status}`
    );
  }

  // 4. Validate split_qty
  if (splitQty <= 0) {
    throw new ValidationError('Split quantity must be greater than 0');
  }

  if (splitQty >= sourceLp.quantity) {
    throw new ValidationError(
      `Split quantity must be less than LP quantity. Current: ${sourceLp.quantity} ${sourceLp.uom}`
    );
  }

  // 5. Generate new LP number
  const newLpNumber = await generateLpNumber(orgId);

  // 6. Determine destination location (default to source location)
  const destLocationId = destinationLocationId || sourceLp.location_id;

  // 7. Execute split transaction
  const { data: result, error: splitError } = await supabase.rpc(
    'split_license_plate',
    {
      p_source_lp_id: lpId,
      p_org_id: orgId,
      p_split_qty: splitQty,
      p_new_lp_number: newLpNumber,
      p_destination_location_id: destLocationId,
      p_user_id: userId,
    }
  );

  if (splitError) {
    throw splitError;
  }

  return result as SplitLPResult;
}

/**
 * Validate split request before execution
 * Used by API endpoint and UI for early validation
 */
export async function validateSplitRequest(
  lpId: string,
  splitQty: number
): Promise<{ valid: boolean; error?: string }> {
  const orgId = await getOrgIdFromContext();

  // Check settings
  const { data: settings } = await supabase
    .from('warehouse_settings')
    .select('enable_split_merge')
    .eq('org_id', orgId)
    .single();

  if (!settings?.enable_split_merge) {
    return { valid: false, error: 'Split/merge operations are disabled' };
  }

  // Check LP
  const { data: lp } = await supabase
    .from('license_plates')
    .select('quantity, status, uom')
    .eq('id', lpId)
    .eq('org_id', orgId)
    .single();

  if (!lp) {
    return { valid: false, error: 'License Plate not found' };
  }

  if (lp.status !== 'available') {
    return { valid: false, error: `LP status is ${lp.status}, must be available` };
  }

  if (splitQty <= 0) {
    return { valid: false, error: 'Split quantity must be greater than 0' };
  }

  if (splitQty >= lp.quantity) {
    return {
      valid: false,
      error: `Split quantity must be less than ${lp.quantity} ${lp.uom}`,
    };
  }

  return { valid: true };
}
```

### Database Function (RPC)

```sql
-- Split LP stored procedure for atomic transaction
CREATE OR REPLACE FUNCTION split_license_plate(
  p_source_lp_id UUID,
  p_org_id UUID,
  p_split_qty DECIMAL(15,4),
  p_new_lp_number TEXT,
  p_destination_location_id UUID,
  p_user_id UUID
)
RETURNS JSON
LANGUAGE plpgsql
AS $$
DECLARE
  v_source_lp license_plates%ROWTYPE;
  v_new_lp license_plates%ROWTYPE;
  v_genealogy_id UUID;
BEGIN
  -- Lock and fetch source LP
  SELECT * INTO v_source_lp
  FROM license_plates
  WHERE id = p_source_lp_id AND org_id = p_org_id
  FOR UPDATE;

  -- Validate
  IF NOT FOUND THEN
    RAISE EXCEPTION 'License Plate not found';
  END IF;

  IF v_source_lp.status != 'available' THEN
    RAISE EXCEPTION 'LP status must be available, current: %', v_source_lp.status;
  END IF;

  IF p_split_qty >= v_source_lp.quantity THEN
    RAISE EXCEPTION 'Split quantity must be less than LP quantity';
  END IF;

  -- Create new LP (inherit from source)
  INSERT INTO license_plates (
    org_id,
    lp_number,
    product_id,
    quantity,
    uom,
    location_id,
    warehouse_id,
    status,
    qa_status,
    batch_number,
    supplier_batch_number,
    expiry_date,
    manufacture_date,
    parent_lp_id,
    source,
    created_by
  ) VALUES (
    p_org_id,
    p_new_lp_number,
    v_source_lp.product_id,
    p_split_qty,
    v_source_lp.uom,
    p_destination_location_id,
    v_source_lp.warehouse_id,
    'available',
    v_source_lp.qa_status,
    v_source_lp.batch_number,
    v_source_lp.supplier_batch_number,
    v_source_lp.expiry_date,
    v_source_lp.manufacture_date,
    p_source_lp_id,
    'split',
    p_user_id
  ) RETURNING * INTO v_new_lp;

  -- Update source LP quantity
  UPDATE license_plates
  SET quantity = quantity - p_split_qty,
      updated_at = NOW()
  WHERE id = p_source_lp_id;

  -- Create genealogy record
  INSERT INTO lp_genealogy (
    org_id,
    parent_lp_id,
    child_lp_id,
    operation_type,
    quantity,
    operation_date,
    created_by
  ) VALUES (
    p_org_id,
    p_source_lp_id,
    v_new_lp.id,
    'split',
    p_split_qty,
    NOW(),
    p_user_id
  ) RETURNING id INTO v_genealogy_id;

  -- Return result
  RETURN json_build_object(
    'success', true,
    'sourceLp', json_build_object(
      'id', p_source_lp_id,
      'lpNumber', v_source_lp.lp_number,
      'quantity', v_source_lp.quantity - p_split_qty
    ),
    'newLp', json_build_object(
      'id', v_new_lp.id,
      'lpNumber', v_new_lp.lp_number,
      'quantity', v_new_lp.quantity
    ),
    'genealogyId', v_genealogy_id
  );
END;
$$;
```

### Validation (Zod)

```typescript
// lib/validation/lp-split-schemas.ts

import { z } from 'zod';

export const SplitLPSchema = z.object({
  splitQty: z
    .number()
    .positive('Split quantity must be greater than 0')
    .finite('Split quantity must be a valid number'),
  destinationLocationId: z.string().uuid('Invalid location ID').optional(),
});

export const SplitLPRequestSchema = z.object({
  lpId: z.string().uuid('Invalid LP ID'),
  splitQty: z.number().positive(),
  destinationLocationId: z.string().uuid().optional(),
});

// Validation with context (requires source LP for comparison)
export function validateSplitWithContext(
  splitQty: number,
  sourceLpQty: number
): { valid: boolean; error?: string } {
  if (splitQty <= 0) {
    return { valid: false, error: 'Split quantity must be greater than 0' };
  }
  if (splitQty >= sourceLpQty) {
    return {
      valid: false,
      error: `Split quantity must be less than current LP quantity (${sourceLpQty})`,
    };
  }
  return { valid: true };
}
```

### Key Business Rules

1. **Split Quantity Constraint:** split_qty MUST be less than source LP quantity (per WH-FR-006)

2. **Status Validation:** Source LP must have status='available' to allow split

3. **Settings Toggle:** `enable_split_merge` must be true in warehouse_settings

4. **Inheritance:** New LP inherits product_id, uom, batch_number, expiry_date, qa_status, manufacture_date from source

5. **New LP Fields:**
   - lp_number: Auto-generated (sequence)
   - quantity: split_qty
   - location_id: destinationLocationId or source location
   - source: 'split'
   - parent_lp_id: source LP ID
   - status: 'available'

6. **Source LP Update:** quantity reduced by split_qty, updated_at timestamp updated

7. **Genealogy Link:** operation_type='split', parent=source, child=new LP

8. **Transaction Atomicity:** All operations (new LP, update source, genealogy) must succeed or rollback

9. **RLS Enforcement:** All operations filtered by org_id

10. **Location Flexibility:** Split can move quantity to different location (optional)

---

## Deliverables

### Database Migration
- `supabase/migrations/YYYYMMDDHHMMSS_add_lp_split_function.sql`
  - `split_license_plate()` stored procedure
  - Updated comments/documentation

### API Routes
- `POST /api/warehouse/license-plates/:id/split`

### Frontend Components
- `app/(authenticated)/warehouse/license-plates/[id]/components/`
  - `LPSplitModal.tsx` - Main split modal
  - `LPSplitPreview.tsx` - Before/after preview
  - `LPSplitQuantityInput.tsx` - Validated quantity input
  - `LPLocationSelector.tsx` - Destination location dropdown

### Services
- `lib/services/lp-split-service.ts` - Split service methods
- Update `lib/services/lp-service.ts` - Add split button logic

### Validation
- `lib/validation/lp-split-schemas.ts` - Zod schemas

### Tests
- **Unit Tests** (Vitest):
  - `lp-split-service.test.ts` - Service logic
  - `split-validation.test.ts` - Validation rules
  - `split-business-rules.test.ts` - Business rule enforcement
  - Target: >80% coverage

- **Integration Tests**:
  - Split with same location
  - Split with different location
  - Split validation errors
  - Settings toggle check
  - Transaction rollback on error

- **E2E Tests** (Playwright):
  - `lp-split-workflow.spec.ts` - Complete split workflow
  - `split-validation-ui.spec.ts` - UI validation feedback

---

## Definition of Done

- [ ] `split_license_plate()` database function created
- [ ] API endpoint `POST /api/warehouse/license-plates/:id/split` implemented
- [ ] Desktop UI: "Split LP" button on LP detail page
- [ ] Split modal with quantity input and location selector
- [ ] Real-time validation: split_qty < source.quantity
- [ ] Preview panel shows before/after state
- [ ] Settings toggle check (`enable_split_merge`)
- [ ] New LP inherits all required fields from source
- [ ] Source LP quantity reduced by split_qty
- [ ] Genealogy record created (operation_type='split')
- [ ] Transaction atomicity verified (rollback on error)
- [ ] Auto-generated LP number for new LP
- [ ] Destination location support (same or different)
- [ ] Status validation (source must be 'available')
- [ ] QA status inherited (with warning if not 'passed')
- [ ] RLS policies verified (org_id isolation)
- [ ] Zod validation schemas in place
- [ ] Unit tests passing (>80% coverage)
- [ ] E2E test for split workflow
- [ ] Performance: Split operation <300ms (per PRD)
- [ ] Success/error feedback in UI
- [ ] Audit trail logging
- [ ] Code review completed
- [ ] Documentation updated

---

## Future Phases (Not in This Story)

### Story 05.20 - Scanner Split (Phase 2)
- Mobile-first split workflow
- Barcode scan for source LP
- Touch-friendly quantity input (large buttons)
- Audio feedback on completion
- Offline queue support

### Phase 3 - Advanced Split
- Bulk split: Split one LP into 3+ LPs at once
- Split templates: Pre-configured split ratios
- Split by percentage (split 50% of LP)
- Cross-location bulk split
- Split with automatic label printing

### Phase 4 - Split Analytics
- Split frequency by product
- Average split quantities
- Location-based split patterns
- Split reason tracking (optional field)

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-12-16 | Initial story - LP Split Workflow (Phase 2) | Claude (Sonnet 4.5) |
