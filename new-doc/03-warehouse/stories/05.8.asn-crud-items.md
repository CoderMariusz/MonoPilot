# 05.8 - ASN CRUD + Items (Advanced Shipping Notice)

| Field | Value |
|-------|-------|
| **Story ID** | 05.8 |
| **Epic** | 05 - Warehouse |
| **Status** | Ready |
| **Phase** | Phase 1 (P1) |
| **Complexity** | M (Medium) |
| **Estimate** | 3-4 days |
| **Type** | Full-stack |

---

## PRD References

| FR ID | Requirement | Priority | Covered |
|-------|-------------|----------|---------|
| WH-FR-015 | ASN Processing | P1 | YES |

**Primary PRD:** `docs/1-BASELINE/product/modules/warehouse.md` (WH-FR-015)
**Architecture:** `docs/1-BASELINE/architecture/modules/warehouse.md`
**UX Wireframes:** WH-ASN-001 (ASN List), WH-ASN-002 (ASN Detail/Form), WH-ASN-003 (ASN Items Table)

---

## MVP Scope

This story implements Phase 1 functionality for Advanced Shipping Notice (ASN) management. ASNs provide pre-notification of incoming goods before they arrive, enabling warehouse staff to prepare for receiving and pre-fill GRN forms.

**MVP Includes**:
- Complete ASN header CRUD (create, read, update, delete)
- ASN item management (add, edit, remove lines)
- Master-detail form pattern (consistent with PO pattern from Epic 03.3)
- ASN-to-PO linkage with auto-population from PO lines
- ASN status lifecycle (pending, partial, received, cancelled)
- Expected vs received quantity tracking per item
- Carrier and tracking number fields
- ASN number auto-generation (ASN-YYYY-NNNNN format)
- "Expected Today" dashboard integration (WH-FR-015)
- GRN pre-fill from ASN data
- Settings toggle (enable_asn)

**Deferred to Phase 2+**: Scanner workflows, EDI integration, barcode printing. See "Future Phases" section below.

---

## Epic 04 Dependency Status

- [ ] NOT CRITICAL - Can defer
- [x] Phase 1 Priority - Enhances receiving workflow after Phase 0 LP Foundation

---

## Goal

Implement Advanced Shipping Notice (ASN) CRUD with line items to enable pre-receiving notifications, warehouse preparation, and streamlined GRN workflows.

## User Story

As a **Warehouse Manager or Receiving Clerk**, I want to **create and track Advanced Shipping Notices with detailed item information** so that **I can prepare for incoming shipments, allocate resources, and expedite the receiving process by pre-filling GRN forms with expected quantities and product details**.

---

## Scope

**In scope (this story)**
- ASN header CRUD (create, read, update, delete, cancel)
- ASN items CRUD (add, edit, remove lines)
- ASN-to-PO linkage with auto-population
- ASN status management (pending -> partial -> received)
- Expected vs received qty tracking
- Carrier and tracking number fields
- ASN list page with filters (status, expected date, supplier, PO)
- ASN detail page (master-detail form)
- Desktop UI for ASN management
- API endpoints for ASN operations
- Service layer (asn-service.ts)
- Zod validation schemas
- Settings toggle (enable_asn)
- Integration with GRN workflow (pre-fill ASN data)
- "Expected Today" dashboard widget

**Out of scope (this story)**
- Scanner-based ASN receiving (Story 05.17 - Scanner Receive)
- EDI ASN import/export (Epic 11 - Integrations)
- ASN barcode labels (Story 05.14 - Label Printing)
- Mobile ASN workflows (Phase 2 - Scanner stories)
- ASN approval workflow (future enhancement)
- ASN email notifications (future enhancement)

---

## Dependencies

| Dependency | Story/Epic | Type | Reason |
|------------|------------|------|--------|
| 01.1 | Org Context + Base RLS | HARD | Requires org_id context and RLS patterns |
| 01.8 | Warehouses CRUD | HARD | ASN references warehouse for receipt destination |
| 02.1 | Products CRUD | HARD | ASN items require product_id reference |
| 03.1 | Suppliers CRUD | HARD | ASN requires supplier_id FK |
| 03.3 | PO CRUD + Lines | HARD | ASN links to PO and auto-populates from PO lines |
| 05.0 | Warehouse Settings | HARD | Requires enable_asn toggle |
| 05.1 | LP Table + Basic Service | SOFT | GRN from ASN creates LPs (05.8 integration) |

**Dependents:**
- 05.8 (GRN from PO) - Uses ASN data to pre-fill GRN
- 05.15 (Warehouse Dashboard) - Shows "Expected Today" ASNs
- 05.17 (Scanner Receive) - Scanner-based receiving from ASN

---

## Acceptance Criteria (Given/When/Then)

### AC-1: Settings Toggle (enable_asn)

**Given** warehouse settings exist
**When** enable_asn is true
**Then** ASN menu item appears in warehouse navigation
**And** ASN-related UI and workflows are accessible

**Given** warehouse settings exist
**When** enable_asn is false
**Then** ASN menu item is hidden
**And** ASN API endpoints return 403 Forbidden

### AC-2: ASN List Page

**Given** planner navigates to `/warehouse/asns`
**When** page loads
**Then** ASN list displays within 300ms
**And** table shows columns: ASN Number, PO Number, Supplier, Expected Date, Status, Items Count, Created

**Given** ASN list with 20+ records
**When** planner enters search "ASN-2024"
**Then** only ASNs matching number, PO number, or supplier name display within 200ms

**Given** ASN list displayed
**When** planner selects filter "Pending"
**Then** only pending ASNs appear

**Given** ASN list displayed
**When** planner sets date range for expected delivery
**Then** only ASNs within date range appear

**Given** ASN list displayed
**When** planner clicks "Expected Date" column header
**Then** list sorts by date (toggle asc/desc)

**Given** 100 ASNs exist
**When** planner views ASN list
**Then** 20 ASNs display per page with pagination controls

### AC-3: Create ASN Header

**Given** planner clicks "+ New ASN"
**When** page loads
**Then** form displays: PO dropdown, supplier (read-only from PO), expected date, carrier, tracking number, notes

**Given** planner selects PO "PO-2024-00123"
**When** PO selected
**Then** supplier auto-fills from PO
**And** expected date defaults to PO expected_delivery_date
**And** ASN items auto-populate from PO lines with expected_qty = ordered_qty - received_qty

**Given** planner saves a new ASN
**When** ASN is created
**Then** ASN number generated as "ASN-2024-00001" (next sequence)
**And** ASN number is immutable after creation
**And** status is set to "pending"

**Given** planner leaves PO empty
**When** save attempted
**Then** error "Purchase Order is required" displays inline
**And** form submission blocked

**Given** planner enters past date for expected delivery
**When** save attempted
**Then** error "Expected delivery date must be today or in the future" displays

**Given** planner selects PO with all lines fully received
**When** ASN creation attempted
**Then** error "Cannot create ASN for fully received PO" displays

### AC-4: ASN-to-PO Linkage and Auto-Population (WH-FR-015)

**Given** enable_asn is true
**When** ASN created with po_id reference
**Then** ASN linked to PO
**And** ASN items auto-populated from PO lines
**And** expected_qty = po_line.quantity - po_line.received_qty for each line

**Given** PO has 3 lines: Flour (100 kg, 20 received), Sugar (50 kg, 0 received), Salt (25 kg, 25 received - fully received)
**When** ASN created from this PO
**Then** ASN items show: Flour (80 kg expected), Sugar (50 kg expected)
**And** Salt line is NOT included (already fully received)

**Given** ASN items auto-populated from PO
**When** planner views ASN detail
**Then** each item shows: product, expected_qty, received_qty (0 initially), UoM, supplier_batch_number, GTIN, expiry_date fields (optional)

### AC-5: ASN Item Management

**Given** planner is on ASN detail page (status="pending")
**When** "Add Line" button clicked
**Then** line form appears with: product dropdown, expected_qty, UoM, supplier_lp_number, supplier_batch_number, GTIN, expiry_date, notes

**Given** planner adds product "RM-FLOUR-001" with expected_qty 100 kg
**When** line saved
**Then** line added to ASN items table
**And** UoM defaults to product's base UoM
**And** received_qty initializes to 0

**Given** ASN has line for "RM-FLOUR-001" expected_qty 100
**When** planner clicks edit on that line
**Then** inline edit mode activates
**And** changes can be saved or cancelled

**Given** ASN has 3 line items
**When** planner clicks delete on line 2
**Then** confirmation dialog "Remove this line item?" displays
**And** upon confirm, line removed

**Given** ASN already has line for "RM-FLOUR-001"
**When** planner attempts to add same product again
**Then** error "Product already exists in ASN items" displays

**Given** ASN status is "received" or "cancelled"
**When** planner attempts to edit or delete items
**Then** error "Cannot modify ASN in {status} status" displays
**And** all item fields are read-only

### AC-6: ASN Status Lifecycle (WH-FR-015)

**Given** ASN created
**When** ASN saved
**Then** status is "pending"

**Given** ASN status="pending"
**When** partial receipt completed (received_qty > 0 but < expected_qty for at least one item)
**Then** ASN status updates to "partial"

**Given** ASN fully received
**When** all items have received_qty >= expected_qty
**Then** ASN status updates to "received"

**Given** ASN status="pending"
**When** planner clicks "Cancel ASN" button
**Then** confirmation dialog "Cancel this ASN?" displays
**And** upon confirm, status updates to "cancelled"

**Given** ASN status="received" or "cancelled"
**When** planner attempts to modify ASN
**Then** error "Cannot modify ASN in {status} status" displays
**And** form is read-only

### AC-7: Carrier and Tracking Number (WH-FR-015)

**Given** ASN creation
**When** carrier and tracking_number provided
**Then** fields stored in asns table

**Given** ASN with carrier="FedEx" and tracking_number="1234567890"
**When** planner views ASN detail
**Then** carrier and tracking number displayed prominently
**And** tracking number is clickable link (if carrier supports tracking URL)

### AC-8: Expected Today Dashboard Widget (WH-FR-015)

**Given** ASN with expected_date = TODAY and status="pending" or "partial"
**When** warehouse dashboard loads
**Then** ASN appears in "Expected Today" widget
**And** widget shows: ASN number, supplier, items count, carrier

**Given** ASN with expected_date = YESTERDAY and status="pending"
**When** warehouse dashboard loads
**Then** ASN appears in "Overdue ASNs" widget (if exists)
**And** row highlighted in red

### AC-9: GRN Pre-fill from ASN (WH-FR-015)

**Given** ASN received
**When** planner initiates GRN creation from ASN
**Then** GRN pre-populated with ASN item details
**And** GRN items show: product_id, expected_qty from ASN, supplier_batch, GTIN, expiry_date
**And** GRN.asn_id set to ASN ID

**Given** GRN created from ASN
**When** GRN line received
**Then** ASN item.received_qty incremented by received amount
**And** ASN status updates to "partial" or "received" based on completion

### AC-10: ASN Detail View

**Given** planner clicks ASN number from list
**When** detail page loads
**Then** page displays: ASN number (header), PO number (link), supplier name, expected date, actual date (if received), carrier, tracking number, status badge, notes

**Given** ASN detail page displayed
**When** items section loads
**Then** items table shows: Product Code, Product Name, Expected Qty, Received Qty, UoM, Supplier Batch, GTIN, Expiry Date, Notes

**Given** ASN with 5 items, 3 partially received
**When** planner views ASN detail
**Then** progress bar shows: "3 / 5 items partially received" or "Fully Received" if all complete

### AC-11: ASN Edit and Delete

**Given** ASN status="pending"
**When** planner clicks "Edit" button
**Then** form fields become editable (except ASN number, supplier, PO)

**Given** ASN status="pending" with no receipts
**When** planner clicks "Delete" button
**Then** confirmation dialog "Permanently delete this ASN?" displays
**And** upon confirm, ASN and ASN items deleted

**Given** ASN status="partial" or "received"
**When** planner clicks "Delete" button
**Then** error "Cannot delete ASN with received items" displays

### AC-12: Data Validation

**Given** ASN item with expected_qty
**When** planner enters negative or zero quantity
**Then** error "Expected quantity must be greater than 0" displays

**Given** ASN item with expiry_date
**When** planner enters expiry date in the past
**Then** warning "Expiry date is in the past" displays (allow save with warning)

**Given** ASN with expected_date = tomorrow
**When** planner attempts to mark as received today
**Then** warning "Receiving before expected date" displays (allow proceed with confirmation)

---

## Implementation Notes

### API Endpoints

```typescript
// ASN CRUD
GET    /api/warehouse/asns                 // List ASNs (filter, sort, paginate)
GET    /api/warehouse/asns/:id             // Get ASN detail + items
POST   /api/warehouse/asns                 // Create ASN (header + items)
PUT    /api/warehouse/asns/:id             // Update ASN header
DELETE /api/warehouse/asns/:id             // Delete ASN (if status=pending, no receipts)
POST   /api/warehouse/asns/:id/cancel      // Cancel ASN (status -> cancelled)

// ASN Items CRUD
POST   /api/warehouse/asns/:id/items       // Add item to ASN
PUT    /api/warehouse/asns/:id/items/:itemId   // Update ASN item
DELETE /api/warehouse/asns/:id/items/:itemId   // Delete ASN item

// ASN Workflows
POST   /api/warehouse/asns/:id/receive     // Initiate receiving (create GRN from ASN)
GET    /api/warehouse/asns/expected-today  // Get ASNs expected today (for dashboard)
POST   /api/warehouse/asns/from-po/:poId   // Create ASN from PO (auto-populate)
```

### Database

**Tables Created:**
```sql
-- ASN Header
CREATE TABLE asns (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id),
  asn_number TEXT NOT NULL,
  po_id UUID NOT NULL REFERENCES purchase_orders(id),
  supplier_id UUID NOT NULL REFERENCES suppliers(id),
  expected_date DATE NOT NULL,
  actual_date DATE,
  carrier TEXT,
  tracking_number TEXT,
  status TEXT NOT NULL DEFAULT 'pending',  -- pending, partial, received, cancelled
  notes TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  created_by UUID REFERENCES users(id),
  updated_at TIMESTAMPTZ DEFAULT NOW(),

  CONSTRAINT asns_org_number_unique UNIQUE(org_id, asn_number)
);

-- Indexes
CREATE INDEX idx_asns_org_status ON asns(org_id, status);
CREATE INDEX idx_asns_org_expected_date ON asns(org_id, expected_date);
CREATE INDEX idx_asns_po_id ON asns(po_id);
CREATE INDEX idx_asns_supplier_id ON asns(supplier_id);

-- RLS
ALTER TABLE asns ENABLE ROW LEVEL SECURITY;

CREATE POLICY "ASN org isolation" ON asns
  FOR ALL USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));
```

```sql
-- ASN Items
CREATE TABLE asn_items (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  asn_id UUID NOT NULL REFERENCES asns(id) ON DELETE CASCADE,
  product_id UUID NOT NULL REFERENCES products(id),
  po_line_id UUID REFERENCES purchase_order_lines(id),
  expected_qty DECIMAL(15,4) NOT NULL CHECK (expected_qty > 0),
  received_qty DECIMAL(15,4) DEFAULT 0 CHECK (received_qty >= 0),
  uom TEXT NOT NULL,
  supplier_lp_number TEXT,
  supplier_batch_number TEXT,
  gtin TEXT,
  expiry_date DATE,
  notes TEXT,

  CONSTRAINT asn_items_asn_product_unique UNIQUE(asn_id, product_id)
);

-- Indexes
CREATE INDEX idx_asn_items_asn_id ON asn_items(asn_id);
CREATE INDEX idx_asn_items_product_id ON asn_items(product_id);

-- RLS
ALTER TABLE asn_items ENABLE ROW LEVEL SECURITY;

CREATE POLICY "ASN items org isolation" ON asn_items
  FOR ALL USING (
    EXISTS (
      SELECT 1 FROM asns
      WHERE asns.id = asn_items.asn_id
      AND asns.org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    )
  );
```

**Settings Table Update (05.0):**
```sql
-- Add to warehouse_settings table
ALTER TABLE warehouse_settings ADD COLUMN enable_asn BOOLEAN DEFAULT false;
```

**GRN Table Update (05.8 - GRN from PO story):**
```sql
-- Add asn_id FK to grns table (already in schema from brief)
-- asn_id UUID REFERENCES asns(id) -- Already planned in architecture
```

### Frontend Components

```
app/(authenticated)/warehouse/asns/
  page.tsx                           -- ASN list page (table, filters, search)
  new/
    page.tsx                         -- Create ASN page
  [id]/
    page.tsx                         -- ASN detail page (master-detail)
    edit/
      page.tsx                       -- Edit ASN page
  components/
    AsnList.tsx                      -- ASN list table with sorting, filtering
    AsnForm.tsx                      -- ASN header form (PO, expected date, carrier, etc.)
    AsnItemsTable.tsx                -- ASN items table (editable inline)
    AsnItemForm.tsx                  -- Add/edit ASN item modal/drawer
    AsnStatusBadge.tsx               -- Status badge (pending, partial, received, cancelled)
    AsnDetailPanel.tsx               -- ASN detail view (read-only)
    AsnProgressBar.tsx               -- Visual progress (received vs expected)
    AsnFilters.tsx                   -- Filter controls (status, date, supplier, PO)
```

### Services

```typescript
// lib/services/asn-service.ts
export interface ASN {
  id: string;
  org_id: string;
  asn_number: string;
  po_id: string;
  supplier_id: string;
  expected_date: string; // ISO date
  actual_date?: string;
  carrier?: string;
  tracking_number?: string;
  status: 'pending' | 'partial' | 'received' | 'cancelled';
  notes?: string;
  created_at: string;
  created_by: string;
  updated_at: string;
}

export interface ASNItem {
  id: string;
  asn_id: string;
  product_id: string;
  po_line_id?: string;
  expected_qty: number;
  received_qty: number;
  uom: string;
  supplier_lp_number?: string;
  supplier_batch_number?: string;
  gtin?: string;
  expiry_date?: string;
  notes?: string;
}

export interface ASNWithDetails extends ASN {
  items: ASNItem[];
  supplier_name: string;
  po_number: string;
}

// Core CRUD
export async function listASNs(filters: ASNFilters): Promise<ASN[]>
export async function getASNById(id: string): Promise<ASNWithDetails>
export async function createASN(data: CreateASNInput): Promise<ASN>
export async function updateASN(id: string, data: UpdateASNInput): Promise<ASN>
export async function deleteASN(id: string): Promise<void>
export async function cancelASN(id: string): Promise<ASN>

// ASN Items
export async function addASNItem(asnId: string, item: CreateASNItemInput): Promise<ASNItem>
export async function updateASNItem(asnId: string, itemId: string, data: UpdateASNItemInput): Promise<ASNItem>
export async function deleteASNItem(asnId: string, itemId: string): Promise<void>

// Workflows
export async function createASNFromPO(poId: string, data: CreateASNFromPOInput): Promise<ASNWithDetails>
export async function initiateReceivingFromASN(asnId: string): Promise<{ grn_id: string }>
export async function getExpectedTodayASNs(): Promise<ASN[]>
export async function updateASNStatus(asnId: string): Promise<void> // Auto-update based on received_qty

// Business Logic
export async function generateASNNumber(orgId: string): Promise<string>
export async function canDeleteASN(asnId: string): Promise<boolean>
export async function canEditASN(asnId: string): Promise<boolean>
```

### Validation (Zod)

```typescript
// lib/validation/warehouse-schemas.ts

export const asnSchema = z.object({
  po_id: z.string().uuid("Invalid purchase order ID"),
  expected_date: z.string().date().refine(
    (date) => new Date(date) >= new Date(new Date().setHours(0, 0, 0, 0)),
    "Expected delivery date must be today or in the future"
  ),
  carrier: z.string().optional(),
  tracking_number: z.string().optional(),
  notes: z.string().optional(),
});

export const asnItemSchema = z.object({
  product_id: z.string().uuid("Invalid product ID"),
  expected_qty: z.number().positive("Expected quantity must be greater than 0"),
  uom: z.string().min(1, "Unit of measure is required"),
  supplier_lp_number: z.string().optional(),
  supplier_batch_number: z.string().optional(),
  gtin: z.string().regex(/^\d{14}$/, "GTIN must be 14 digits").optional(),
  expiry_date: z.string().date().optional(),
  notes: z.string().optional(),
});

export const createASNSchema = z.object({
  header: asnSchema,
  items: z.array(asnItemSchema).min(1, "At least one item is required"),
});

export const updateASNSchema = asnSchema.partial();
export const updateASNItemSchema = asnItemSchema.partial();

export const createASNFromPOSchema = z.object({
  po_id: z.string().uuid("Invalid purchase order ID"),
  expected_date: z.string().date(),
  carrier: z.string().optional(),
  tracking_number: z.string().optional(),
  notes: z.string().optional(),
  // Items auto-populated from PO, optional manual adjustments
  item_overrides: z.array(
    z.object({
      po_line_id: z.string().uuid(),
      expected_qty: z.number().positive().optional(),
      supplier_batch_number: z.string().optional(),
      gtin: z.string().optional(),
      expiry_date: z.string().date().optional(),
    })
  ).optional(),
});
```

### Key Business Rules

1. **ASN Number Generation**: Format `ASN-YYYY-NNNNN` (e.g., ASN-2024-00001), unique per org, immutable after creation
2. **PO Linkage**: ASN must reference a valid PO, supplier auto-populated from PO
3. **Auto-Population**: When creating ASN from PO, items auto-populate with expected_qty = po_line.quantity - po_line.received_qty (skip fully received lines)
4. **Status Lifecycle**:
   - `pending`: Initial state, no receipts
   - `partial`: At least one item has received_qty > 0 but < expected_qty
   - `received`: All items have received_qty >= expected_qty
   - `cancelled`: Manually cancelled, no further receipts allowed
5. **Received Qty Tracking**: ASN item.received_qty increments when GRN line created/updated referencing this ASN
6. **Edit Constraints**:
   - Can only edit ASN header/items if status = "pending"
   - Cannot delete ASN if status = "partial" or "received"
   - Can cancel ASN if status = "pending" (sets status to "cancelled")
7. **GRN Pre-fill**: When creating GRN from ASN, pre-fill product, expected_qty, supplier_batch, GTIN, expiry_date
8. **Expected Today**: Dashboard widget queries asns WHERE expected_date = CURRENT_DATE AND status IN ('pending', 'partial')
9. **Duplicate Product Prevention**: Cannot add same product_id twice to same ASN
10. **Settings Toggle**: ASN features only accessible if warehouse_settings.enable_asn = true
11. **Carrier URL**: If carrier is known (FedEx, UPS, DHL), generate tracking URL from tracking_number
12. **Expiry Date Warning**: If expiry_date < CURRENT_DATE, show warning but allow save

---

## Deliverables

- API routes:
  - `/api/warehouse/asns` (GET, POST)
  - `/api/warehouse/asns/:id` (GET, PUT, DELETE)
  - `/api/warehouse/asns/:id/cancel` (POST)
  - `/api/warehouse/asns/:id/items` (POST)
  - `/api/warehouse/asns/:id/items/:itemId` (PUT, DELETE)
  - `/api/warehouse/asns/:id/receive` (POST)
  - `/api/warehouse/asns/expected-today` (GET)
  - `/api/warehouse/asns/from-po/:poId` (POST)

- Components:
  - `AsnList.tsx` (table with filters, search, pagination)
  - `AsnForm.tsx` (header form)
  - `AsnItemsTable.tsx` (items table with inline edit)
  - `AsnItemForm.tsx` (add/edit item modal)
  - `AsnStatusBadge.tsx` (status visual)
  - `AsnDetailPanel.tsx` (read-only detail view)
  - `AsnProgressBar.tsx` (received vs expected visual)
  - `AsnFilters.tsx` (filter controls)

- Services:
  - `lib/services/asn-service.ts` (CRUD, workflows, business logic)

- Validation:
  - `lib/validation/warehouse-schemas.ts` (asnSchema, asnItemSchema, createASNSchema, etc.)

- Database:
  - Migration: `asns` table creation
  - Migration: `asn_items` table creation
  - Migration: `warehouse_settings.enable_asn` column
  - RLS policies for asns and asn_items

- Tests:
  - Unit tests for asn-service.ts (>80% coverage)
  - API route tests for all endpoints
  - Validation schema tests
  - E2E smoke test: Create ASN from PO -> View ASN detail -> Initiate receiving -> GRN pre-filled

---

## Definition of Done

- [ ] `asns` table created with all columns, constraints, indexes, RLS
- [ ] `asn_items` table created with all columns, constraints, indexes, RLS
- [ ] `warehouse_settings.enable_asn` column added
- [ ] ASN number auto-generation working (ASN-YYYY-NNNNN format)
- [ ] ASN CRUD API endpoints implemented (list, get, create, update, delete, cancel)
- [ ] ASN items API endpoints implemented (add, update, delete)
- [ ] ASN-to-PO linkage working (auto-populate items from PO)
- [ ] ASN status lifecycle implemented (pending -> partial -> received)
- [ ] GRN pre-fill from ASN working (asn_id FK, item details copied)
- [ ] ASN list page with filters (status, expected date, supplier, PO), search, pagination
- [ ] ASN detail page (master-detail) with items table
- [ ] ASN form with validation (PO required, expected date >= today, etc.)
- [ ] ASN item form with inline edit support
- [ ] Settings toggle (enable_asn) enforced (403 if disabled)
- [ ] "Expected Today" dashboard widget showing ASNs expected today
- [ ] Carrier and tracking number fields stored and displayed
- [ ] Progress bar showing received vs expected items
- [ ] Unit tests passing (>80% coverage for asn-service.ts)
- [ ] API route tests passing (all CRUD operations)
- [ ] Validation schema tests passing
- [ ] RLS policies verified (multi-tenant isolation)
- [ ] E2E smoke test passing (create ASN from PO, initiate receiving)
- [ ] Cannot edit/delete ASN if status = "partial" or "received"
- [ ] Cannot add duplicate product to ASN items
- [ ] Response times: List <300ms, Detail <200ms, Create <500ms

---

## Future Phases (Not in This Story)

### Phase 2 (Scanner Workflows)
- Scanner-based ASN receiving (Story 05.17) - Scan LP barcode, auto-link to ASN item
- Mobile ASN receiving UI for warehouse floor

### Phase 3 (Advanced Features)
- EDI ASN import (Epic 11 - Integrations) - DESADV message parsing
- EDI ASN export (send ASN to suppliers)
- ASN barcode labels (Story 05.14) - Print ASN labels for each item
- ASN approval workflow (require manager approval before receiving)
- ASN email notifications (alert warehouse when ASN expected today)
- ASN attachment upload (BOL, packing list, COA)
- Multi-warehouse ASN (split ASN across multiple warehouses)

### Phase 4 (Reporting)
- ASN performance report (on-time vs late delivery by supplier)
- ASN variance report (expected vs actual received quantities)
- ASN aging report (pending ASNs overdue)

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-12-16 | Initial story creation | ARCHITECT-AGENT |
