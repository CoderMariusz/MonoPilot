# 05.25 - Cycle Count

**Story ID:** 05.25
**Epic:** 05 - Warehouse
**Phase:** 2
**Complexity:** L (Large)
**Estimate:** 5-7 days
**Type:** Backend + Frontend
**State:** ready

**Primary PRD:** `docs/1-BASELINE/product/modules/warehouse.md` (WH-FR-023)
**UX Wireframes:** WH-025 (Cycle Count List), WH-026 (Count Execution), WH-027 (Variance Review)

## PRD References

| FR ID | Requirement | Priority | Phase | Covered |
|-------|-------------|----------|-------|---------|
| WH-FR-023 | Cycle Count | P2 | 2 | Yes |
| WH-FR-024 | Stock Adjustment | P2 | 2 | Integration |

## User Story

**As a** warehouse manager,
**I want** to plan and execute inventory counts on a scheduled or ad-hoc basis,
**So that** I can verify physical inventory matches system records and maintain accurate stock levels for compliance.

**As a** warehouse operator,
**I want** to count inventory using a structured count sheet,
**So that** I can efficiently record counted quantities and flag discrepancies.

## Goal

Implement comprehensive cycle count functionality including plan creation, execution workflow, variance analysis, adjustment posting, ABC classification for count frequency, and cycle count dashboard.

## Scope

**In scope:**
- Cycle count plan creation (locations, products, schedule)
- Count execution workflow (scan LP, enter actual qty)
- Variance analysis (expected vs actual)
- Adjustment posting (auto or manual approval)
- ABC analysis for count frequency
- Cycle count dashboard
- Count sheet generation and export (CSV/PDF)
- Count history and audit trail

**Out of scope:**
- Blind counts (hiding expected qty) - future enhancement
- Multi-counter reconciliation for same location
- Automated count scheduling via cron jobs
- Scanner-specific optimizations (separate story)
- Integration with external counting devices
- Inventory valuation variance reports (Finance module)

## Dependencies

| Story | Requirement | Status |
|-------|-------------|--------|
| 05.1 | LP Table + CRUD | Required - LP records to count |
| 05.16 | Stock Adjustment | Required - adjustment move type |
| 01.8 | Warehouses CRUD | Required - warehouse context |
| 01.9 | Locations CRUD | Required - location selection |
| 02.1 | Products CRUD | Required - ABC classification |

## Acceptance Criteria (Given/When/Then)

### Cycle Count Plan Creation

#### Plan Form
- GIVEN user has warehouse manager permissions, WHEN creating new cycle count, THEN system displays count creation form with type, warehouse, scope, schedule date, and assignee fields.
- GIVEN count type = 'full', WHEN count created, THEN all LPs in selected warehouse included in count scope.
- GIVEN count type = 'partial', WHEN zone/locations selected, THEN only LPs in selected areas included.
- GIVEN count type = 'cycle', WHEN ABC class selected (A/B/C), THEN only products with matching classification included.
- GIVEN count type = 'spot', WHEN specific LPs selected, THEN only those LPs included in count.
- GIVEN count created, WHEN saved, THEN count_number auto-generated (CC-YYYY-NNNNN format) and status = 'planned'.

#### Count Number Generation
- GIVEN a cycle count is being created, WHEN the service calls generateCountNumber(), THEN it returns unique number in format `CC-YYYY-NNNNN`.
- GIVEN count number generated, WHEN operation completes, THEN response time < 100ms.

### Count Execution Workflow

#### Count Sheet Generation
- GIVEN count with status = 'planned', WHEN user initiates "Generate Count Sheet", THEN system creates cycle_count_items for all LPs in scope.
- GIVEN count sheet generated, WHEN items created, THEN each item has lp_id, expected_qty (from LP.quantity), counted_qty = null, variance = null.
- GIVEN count sheet, WHEN exported to PDF/CSV, THEN includes: Location, LP Number, Product, Expected Qty, UoM, blank counted_qty column.
- GIVEN count sheet generation, WHEN scope contains 1000+ LPs, THEN generation completes in < 5 seconds.

#### Count Execution
- GIVEN count with status = 'planned', WHEN user clicks "Start Count", THEN status updates to 'in_progress' and started_at timestamp recorded.
- GIVEN count in_progress, WHEN user scans/selects LP, THEN system displays LP details and prompts for counted_qty entry.
- GIVEN LP scanned, WHEN counted_qty entered, THEN cycle_count_items record updated with counted_qty, variance calculated = counted_qty - expected_qty.
- GIVEN variance detected (|variance| > 0), WHEN count item saved, THEN item flagged with variance_flag = true.
- GIVEN LP not on count sheet, WHEN LP scanned during count, THEN system prompts "LP not expected at this location - add as unexpected?" with option to include.
- GIVEN unexpected LP added, WHEN included, THEN new cycle_count_item created with expected_qty = 0, source = 'unexpected'.

### Variance Analysis

#### Variance Report
- GIVEN count in_progress or completed, WHEN user views "Variance Report", THEN system displays all items with |variance| > 0.
- GIVEN variance report, WHEN displayed, THEN columns show: Location, LP Number, Product, Expected, Counted, Variance, Variance %, Notes.
- GIVEN variance item, WHEN variance_pct > threshold (default 5%), THEN row highlighted in red requiring review.
- GIVEN variance report, WHEN sorted, THEN default sort by |variance_pct| descending (largest variances first).
- GIVEN variance item, WHEN user clicks "Add Note", THEN notes field editable for explanation.

#### Variance Approval
- GIVEN all count items have counted_qty entered, WHEN user clicks "Complete Count", THEN status updates to 'pending_approval'.
- GIVEN count pending_approval, WHEN user with manager role reviews variances, THEN can approve/reject each variance line.
- GIVEN variance line approved, WHEN saved, THEN item.approval_status = 'approved', approved_by and approved_at recorded.
- GIVEN variance line rejected, WHEN saved, THEN item.approval_status = 'rejected' with rejection reason required.
- GIVEN all variance lines approved, WHEN count approved, THEN count status = 'approved'.

### Adjustment Posting

- GIVEN count status = 'approved', WHEN user clicks "Post Adjustments", THEN system creates stock_moves with move_type = 'adjustment' for each approved variance.
- GIVEN variance > 0 (count surplus), WHEN adjustment posted, THEN stock_move.quantity = +variance, LP.quantity increased.
- GIVEN variance < 0 (count shortage), WHEN adjustment posted, THEN stock_move.quantity = variance (negative), LP.quantity decreased.
- GIVEN LP.quantity would become 0 after adjustment, WHEN posted, THEN LP.status updated to 'consumed'.
- GIVEN LP.quantity would become negative after adjustment, WHEN posting attempted, THEN error "Adjustment would result in negative quantity" - requires manual review.
- GIVEN adjustments posted, WHEN complete, THEN count status = 'completed', completed_at timestamp recorded.

### ABC Classification

#### Product Classification
- GIVEN ABC analysis feature enabled, WHEN products analyzed, THEN classification based on:
  - Class A: Top 20% by inventory value (count weekly)
  - Class B: Next 30% by value (count monthly)
  - Class C: Bottom 50% by value (count quarterly)
- GIVEN product inventory value calculated, WHEN ABC classification runs, THEN product.abc_class field updated (A/B/C).
- GIVEN count type = 'cycle', WHEN ABC class = 'A' selected, THEN only A-class products' LPs included.

#### Count Frequency Settings
- GIVEN warehouse_settings, WHEN cycle count configured, THEN settings include:
  - `abc_count_frequency_a`: days between A-class counts (default 7)
  - `abc_count_frequency_b`: days between B-class counts (default 30)
  - `abc_count_frequency_c`: days between C-class counts (default 90)
- GIVEN count frequency configured, WHEN count due date calculated, THEN based on product.last_counted_at + frequency_days.

### Multi-tenancy
- GIVEN User A from Org A, WHEN requesting cycle counts, THEN only Org A counts returned.
- GIVEN count belongs to Org B, WHEN User A attempts to access, THEN 404 Not Found returned (not 403).

## Technical Specification

### Database Schema

#### cycle_counts table

```sql
CREATE TABLE cycle_counts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  count_number TEXT NOT NULL,
  count_type TEXT NOT NULL CHECK (count_type IN ('full', 'partial', 'cycle', 'spot')),
  warehouse_id UUID NOT NULL REFERENCES warehouses(id),
  scope_zone_ids UUID[] DEFAULT '{}',
  scope_location_ids UUID[] DEFAULT '{}',
  scope_abc_class TEXT CHECK (scope_abc_class IN ('A', 'B', 'C')),
  scope_lp_ids UUID[] DEFAULT '{}',
  status TEXT NOT NULL DEFAULT 'planned' CHECK (status IN (
    'planned', 'in_progress', 'pending_approval', 'approved', 'completed', 'cancelled'
  )),
  scheduled_date DATE NOT NULL,
  scheduled_by UUID REFERENCES users(id),
  assigned_to UUID REFERENCES users(id),
  started_at TIMESTAMPTZ,
  started_by UUID REFERENCES users(id),
  completed_at TIMESTAMPTZ,
  completed_by UUID REFERENCES users(id),
  approved_at TIMESTAMPTZ,
  approved_by UUID REFERENCES users(id),
  total_items INTEGER DEFAULT 0,
  items_counted INTEGER DEFAULT 0,
  items_with_variance INTEGER DEFAULT 0,
  total_variance_value DECIMAL(15,2) DEFAULT 0,
  notes TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  created_by UUID REFERENCES users(id),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  CONSTRAINT unique_count_number UNIQUE(org_id, count_number)
);

CREATE INDEX idx_cycle_counts_org_status ON cycle_counts(org_id, status);
CREATE INDEX idx_cycle_counts_warehouse ON cycle_counts(warehouse_id);
CREATE INDEX idx_cycle_counts_scheduled ON cycle_counts(scheduled_date);

ALTER TABLE cycle_counts ENABLE ROW LEVEL SECURITY;

CREATE POLICY "cycle_counts_org_isolation" ON cycle_counts FOR ALL
USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));
```

#### cycle_count_items table

```sql
CREATE TABLE cycle_count_items (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  count_id UUID NOT NULL REFERENCES cycle_counts(id) ON DELETE CASCADE,
  lp_id UUID NOT NULL REFERENCES license_plates(id),
  location_id UUID NOT NULL REFERENCES locations(id),
  product_id UUID NOT NULL REFERENCES products(id),
  expected_qty DECIMAL(15,4) NOT NULL,
  counted_qty DECIMAL(15,4),
  variance DECIMAL(15,4),
  variance_pct DECIMAL(8,4),
  is_counted BOOLEAN DEFAULT FALSE,
  is_unexpected BOOLEAN DEFAULT FALSE,
  is_missing BOOLEAN DEFAULT FALSE,
  variance_flag BOOLEAN DEFAULT FALSE,
  approval_status TEXT DEFAULT 'pending' CHECK (approval_status IN (
    'pending', 'approved', 'rejected', 'not_required'
  )),
  approved_by UUID REFERENCES users(id),
  approved_at TIMESTAMPTZ,
  rejection_reason TEXT,
  adjustment_move_id UUID REFERENCES stock_moves(id),
  adjustment_posted_at TIMESTAMPTZ,
  notes TEXT,
  counted_by UUID REFERENCES users(id),
  counted_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_count_items_count ON cycle_count_items(count_id);
CREATE INDEX idx_count_items_lp ON cycle_count_items(lp_id);
CREATE INDEX idx_count_items_variance ON cycle_count_items(count_id, variance_flag) WHERE variance_flag = TRUE;

ALTER TABLE cycle_count_items ENABLE ROW LEVEL SECURITY;

CREATE POLICY "count_items_org_isolation" ON cycle_count_items FOR ALL
USING (count_id IN (SELECT id FROM cycle_counts WHERE org_id = (SELECT org_id FROM users WHERE id = auth.uid())));
```

#### warehouse_settings extension

```sql
ALTER TABLE warehouse_settings ADD COLUMN IF NOT EXISTS enable_cycle_count BOOLEAN DEFAULT TRUE;
ALTER TABLE warehouse_settings ADD COLUMN IF NOT EXISTS abc_count_frequency_a INTEGER DEFAULT 7;
ALTER TABLE warehouse_settings ADD COLUMN IF NOT EXISTS abc_count_frequency_b INTEGER DEFAULT 30;
ALTER TABLE warehouse_settings ADD COLUMN IF NOT EXISTS abc_count_frequency_c INTEGER DEFAULT 90;
ALTER TABLE warehouse_settings ADD COLUMN IF NOT EXISTS variance_threshold_pct DECIMAL(5,2) DEFAULT 5.00;
ALTER TABLE warehouse_settings ADD COLUMN IF NOT EXISTS require_variance_approval BOOLEAN DEFAULT TRUE;
```

#### products table extension

```sql
ALTER TABLE products ADD COLUMN IF NOT EXISTS abc_class TEXT CHECK (abc_class IN ('A', 'B', 'C'));
ALTER TABLE products ADD COLUMN IF NOT EXISTS last_counted_at TIMESTAMPTZ;
```

### RLS Policies

```sql
-- cycle_counts: Users can see their org counts
CREATE POLICY "counts_org_read" ON cycle_counts
FOR SELECT USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

CREATE POLICY "counts_org_write" ON cycle_counts
FOR ALL USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

-- cycle_count_items: Inherits from cycle_counts via FK
CREATE POLICY "count_items_org_read" ON cycle_count_items
FOR SELECT USING (count_id IN (SELECT id FROM cycle_counts WHERE org_id = (SELECT org_id FROM users WHERE id = auth.uid())));
```

### API Endpoints

```
# Cycle Count Management
GET    /api/warehouse/cycle-counts                     - List counts (paginated, filtered)
GET    /api/warehouse/cycle-counts/:id                 - Get count detail with items
POST   /api/warehouse/cycle-counts                     - Create count plan
PUT    /api/warehouse/cycle-counts/:id                 - Update count (limited fields)
DELETE /api/warehouse/cycle-counts/:id                 - Cancel count (soft delete)

# Count Workflow
POST   /api/warehouse/cycle-counts/:id/generate-sheet  - Generate count items
POST   /api/warehouse/cycle-counts/:id/start           - Start count execution
POST   /api/warehouse/cycle-counts/:id/complete        - Complete count
POST   /api/warehouse/cycle-counts/:id/approve         - Approve count (manager)
POST   /api/warehouse/cycle-counts/:id/post-adjustments - Post approved variances

# Count Items
GET    /api/warehouse/cycle-counts/:id/items           - List count items
PUT    /api/warehouse/cycle-counts/:id/items/:itemId   - Update counted qty
POST   /api/warehouse/cycle-counts/:id/items           - Add unexpected LP

# Variance Management
GET    /api/warehouse/cycle-counts/:id/variances       - List items with variance
PUT    /api/warehouse/cycle-counts/:id/items/:itemId/approve - Approve variance
PUT    /api/warehouse/cycle-counts/:id/items/:itemId/reject  - Reject variance

# Reports
GET    /api/warehouse/cycle-counts/:id/export          - Export count sheet (CSV/PDF)

# ABC Classification
POST   /api/warehouse/products/calculate-abc           - Calculate ABC classification
GET    /api/warehouse/products/count-due               - Get products due for counting
```

### Service Methods

**Location:** `lib/services/cycle-count-service.ts`

```typescript
export type CountType = 'full' | 'partial' | 'cycle' | 'spot';
export type CountStatus = 'planned' | 'in_progress' | 'pending_approval' | 'approved' | 'completed' | 'cancelled';
export type ApprovalStatus = 'pending' | 'approved' | 'rejected' | 'not_required';

export interface CycleCount {
  id: string;
  org_id: string;
  count_number: string;
  count_type: CountType;
  warehouse_id: string;
  status: CountStatus;
  scheduled_date: string;
  total_items: number;
  items_counted: number;
  items_with_variance: number;
}

export interface CycleCountItem {
  id: string;
  count_id: string;
  lp_id: string;
  expected_qty: number;
  counted_qty: number | null;
  variance: number | null;
  variance_pct: number | null;
  is_counted: boolean;
  variance_flag: boolean;
  approval_status: ApprovalStatus;
}

interface CycleCountService {
  list(filters: CountListFilters): Promise<PaginatedResult<CycleCount>>;
  getById(id: string): Promise<CycleCount>;
  create(data: CreateCycleCountInput): Promise<CycleCount>;
  update(id: string, data: Partial<CycleCount>): Promise<CycleCount>;
  cancel(id: string, reason: string): Promise<CycleCount>;
  generateCountSheet(countId: string): Promise<CycleCountItem[]>;
  startCount(countId: string): Promise<CycleCount>;
  completeCount(countId: string): Promise<CycleCount>;
  approveCount(countId: string): Promise<CycleCount>;
  postAdjustments(countId: string): Promise<{ adjustments: number; errors: string[] }>;
  getCountItems(countId: string, filters?: ItemFilters): Promise<CycleCountItem[]>;
  updateCountedQty(countId: string, itemId: string, data: UpdateCountItemInput): Promise<CycleCountItem>;
  addUnexpectedLP(countId: string, lpId: string, countedQty: number): Promise<CycleCountItem>;
  getVariances(countId: string): Promise<CycleCountItem[]>;
  approveVariance(itemId: string, approverId: string): Promise<CycleCountItem>;
  rejectVariance(itemId: string, reason: string): Promise<CycleCountItem>;
  generateCountNumber(orgId: string): Promise<string>;
  calculateVariance(expectedQty: number, countedQty: number): { variance: number; variance_pct: number };
}
```

### Zod Validation Schemas

**Location:** `lib/validation/cycle-count-schema.ts`

```typescript
import { z } from 'zod';

export const countTypeEnum = z.enum(['full', 'partial', 'cycle', 'spot']);
export const countStatusEnum = z.enum(['planned', 'in_progress', 'pending_approval', 'approved', 'completed', 'cancelled']);
export const abcClassEnum = z.enum(['A', 'B', 'C']);

export const createCycleCountSchema = z.object({
  count_type: countTypeEnum,
  warehouse_id: z.string().uuid('Invalid warehouse ID'),
  scheduled_date: z.string().regex(/^\d{4}-\d{2}-\d{2}$/, 'Date must be YYYY-MM-DD'),
  assigned_to: z.string().uuid().optional(),
  scope_zone_ids: z.array(z.string().uuid()).optional(),
  scope_location_ids: z.array(z.string().uuid()).optional(),
  scope_abc_class: abcClassEnum.optional(),
  scope_lp_ids: z.array(z.string().uuid()).optional(),
  notes: z.string().max(1000).optional(),
}).refine(
  (data) => {
    if (data.count_type === 'partial') {
      return (data.scope_zone_ids?.length || 0) > 0 || (data.scope_location_ids?.length || 0) > 0;
    }
    if (data.count_type === 'cycle') return !!data.scope_abc_class;
    if (data.count_type === 'spot') return (data.scope_lp_ids?.length || 0) > 0;
    return true;
  },
  { message: 'Scope selection required for this count type', path: ['scope_location_ids'] }
);

export const updateCountItemSchema = z.object({
  counted_qty: z.number().min(0, 'Quantity cannot be negative'),
  notes: z.string().max(500).optional(),
});

export const rejectVarianceSchema = z.object({
  reason: z.string().min(10, 'Rejection reason must be at least 10 characters').max(500),
});

export const countListFiltersSchema = z.object({
  status: countStatusEnum.optional(),
  count_type: countTypeEnum.optional(),
  warehouse_id: z.string().uuid().optional(),
  date_from: z.string().optional(),
  date_to: z.string().optional(),
  page: z.coerce.number().int().positive().default(1),
  limit: z.coerce.number().int().min(1).max(100).default(50),
});

export type CreateCycleCountInput = z.infer<typeof createCycleCountSchema>;
export type UpdateCountItemInput = z.infer<typeof updateCountItemSchema>;
```

## UI Components

### Pages

- `app/(authenticated)/warehouse/cycle-counts/page.tsx` - Cycle count list page
- `app/(authenticated)/warehouse/cycle-counts/new/page.tsx` - Create new count
- `app/(authenticated)/warehouse/cycle-counts/[id]/page.tsx` - Count detail/execution
- `app/(authenticated)/warehouse/cycle-counts/[id]/variances/page.tsx` - Variance review

### Components

**Location:** `components/warehouse/cycle-count/`

```
CycleCountList.tsx            - DataTable with counts, filters, actions
CycleCountFilters.tsx         - Status, type, date range, warehouse filters
CycleCountCard.tsx            - Count summary card with progress
CreateCountForm.tsx           - Multi-step count creation form
CountScopeSelector.tsx        - Location/zone/LP selector based on type
CountExecutionPanel.tsx       - Main counting interface
CountItemRow.tsx              - Individual item counting row
VarianceTable.tsx             - Variance review DataTable
VarianceApprovalDialog.tsx    - Approve/reject variance dialog
CountProgressBar.tsx          - Progress indicator (items counted/total)
ABCClassBadge.tsx             - A/B/C classification badge
CountStatusBadge.tsx          - Count status badge with colors
ExportCountSheetButton.tsx    - Export to CSV/PDF
PostAdjustmentsButton.tsx     - Post adjustments with confirmation
```

### Component Details

**CountExecutionPanel.tsx**
```tsx
interface CountExecutionPanelProps {
  count: CycleCount;
  items: CycleCountItem[];
  onUpdateItem: (itemId: string, countedQty: number, notes?: string) => void;
  onAddUnexpected: (lpId: string, countedQty: number) => void;
  onComplete: () => void;
}
```

**VarianceTable.tsx**
```tsx
interface VarianceTableProps {
  items: CycleCountItem[];
  onApprove: (itemId: string) => void;
  onReject: (itemId: string, reason: string) => void;
  varianceThreshold: number;
}
```

### Status Badge Colors

| Status | Color | Description |
|--------|-------|-------------|
| planned | Blue | Count scheduled, not started |
| in_progress | Yellow | Counting underway |
| pending_approval | Orange | Awaiting variance approval |
| approved | Green | Variances approved |
| completed | Gray | Adjustments posted |
| cancelled | Red | Count cancelled |

### ABC Class Badge Colors

| Class | Color | Frequency |
|-------|-------|-----------|
| A | Red | Weekly |
| B | Yellow | Monthly |
| C | Green | Quarterly |

## Test Cases

### Unit Tests

**cycle-count-service.test.ts**
```typescript
describe('CycleCountService', () => {
  describe('create', () => {
    it('creates full count with all LPs in warehouse');
    it('creates partial count with selected locations only');
    it('creates cycle count with ABC class filter');
    it('creates spot count with specific LPs');
    it('generates unique count number');
  });

  describe('generateCountSheet', () => {
    it('creates items for all LPs in scope');
    it('sets expected_qty from current LP.quantity');
    it('handles 1000+ LPs within 5 seconds');
  });

  describe('updateCountedQty', () => {
    it('calculates variance correctly');
    it('calculates variance_pct correctly');
    it('sets variance_flag when variance != 0');
  });

  describe('postAdjustments', () => {
    it('creates stock_moves for approved variances');
    it('updates LP quantities correctly');
    it('sets LP status to consumed when qty = 0');
    it('rejects negative resulting quantities');
  });
});
```

### Integration Tests

**cycle-count-api.test.ts**
```typescript
describe('Cycle Count API', () => {
  describe('POST /api/warehouse/cycle-counts', () => {
    it('creates count with valid data');
    it('validates count_type specific scope requirements');
    it('returns 400 for missing required fields');
  });

  describe('POST /api/warehouse/cycle-counts/:id/generate-sheet', () => {
    it('generates items for all LPs in scope');
    it('returns 400 if count not in planned status');
  });

  describe('POST /api/warehouse/cycle-counts/:id/post-adjustments', () => {
    it('creates stock_moves for approved variances');
    it('returns 400 if not all variances approved');
  });

  describe('RLS enforcement', () => {
    it('returns 404 for cross-org count access');
    it('filters list to org counts only');
  });
});
```

### E2E Tests

**cycle-count.spec.ts**
```typescript
describe('Cycle Count Workflow', () => {
  it('creates full warehouse count');
  it('generates count sheet with all LPs');
  it('starts count and enters quantities');
  it('identifies and displays variances');
  it('approves variances');
  it('posts adjustments and verifies LP updates');
  it('completes count workflow end-to-end');
});
```

## Key Business Rules

1. **Count Types**:
   - **full**: All LPs in warehouse - annual/semi-annual
   - **partial**: Selected zones/locations - quarterly/as-needed
   - **cycle**: ABC-based rotation - configurable frequency
   - **spot**: Specific LPs - ad-hoc verification

2. **Count Status Flow**:
   ```
   planned -> in_progress -> pending_approval -> approved -> completed
                  |                                  |
                  +----> cancelled <-----------------+
   ```

3. **Variance Handling**:
   - Variance = counted_qty - expected_qty
   - Variance % = (variance / expected_qty) * 100
   - Threshold configurable (default 5%)
   - Above-threshold variances require approval

4. **Adjustment Posting**:
   - Creates stock_moves with move_type = 'adjustment'
   - Reason code = 'counting_error'
   - LP quantity updated atomically

5. **ABC Classification**:
   - Class A: Top 20% by inventory value (80% of value)
   - Class B: Next 30% by value (15% of value)
   - Class C: Bottom 50% by value (5% of value)

6. **Performance Requirements**:
   - Count creation: < 200ms
   - Sheet generation (1000 LPs): < 5 seconds
   - Item update: < 100ms
   - Adjustment posting (100 items): < 10 seconds

## Security Considerations

1. **Role-Based Access**:
   - Count creation: Warehouse Manager role required
   - Count execution: Warehouse Operator role minimum
   - Variance approval: Manager role required
   - Adjustment posting: Manager role required

2. **Audit Trail**:
   - Log all count state transitions
   - Record who counted each item
   - Track variance approvals/rejections

3. **Data Integrity**:
   - Prevent concurrent counting of same LP
   - Atomic adjustment posting with LP updates

## Deliverables

### Database
- [ ] Migration: `cycle_counts` table
- [ ] Migration: `cycle_count_items` table
- [ ] Migration: `warehouse_settings` extension (cycle count settings)
- [ ] Migration: `products` extension (abc_class, last_counted_at)
- [ ] RLS policies for both tables
- [ ] All performance indexes

### API Routes
- [ ] `GET /api/warehouse/cycle-counts` - List counts
- [ ] `GET /api/warehouse/cycle-counts/:id` - Get count detail
- [ ] `POST /api/warehouse/cycle-counts` - Create count
- [ ] `PUT /api/warehouse/cycle-counts/:id` - Update count
- [ ] `DELETE /api/warehouse/cycle-counts/:id` - Cancel count
- [ ] `POST /api/warehouse/cycle-counts/:id/generate-sheet` - Generate items
- [ ] `POST /api/warehouse/cycle-counts/:id/start` - Start count
- [ ] `POST /api/warehouse/cycle-counts/:id/complete` - Complete count
- [ ] `POST /api/warehouse/cycle-counts/:id/approve` - Approve count
- [ ] `POST /api/warehouse/cycle-counts/:id/post-adjustments` - Post adjustments
- [ ] `GET /api/warehouse/cycle-counts/:id/items` - List items
- [ ] `PUT /api/warehouse/cycle-counts/:id/items/:itemId` - Update item
- [ ] `POST /api/warehouse/cycle-counts/:id/items` - Add unexpected LP
- [ ] `GET /api/warehouse/cycle-counts/:id/variances` - Get variances
- [ ] `PUT /api/warehouse/cycle-counts/:id/items/:itemId/approve` - Approve variance
- [ ] `PUT /api/warehouse/cycle-counts/:id/items/:itemId/reject` - Reject variance
- [ ] `GET /api/warehouse/cycle-counts/:id/export` - Export sheet
- [ ] `POST /api/warehouse/products/calculate-abc` - Calculate ABC

### Services
- [ ] `CycleCountService` with all methods
- [ ] `ABCClassificationService` with analysis methods
- [ ] Integration with `StockMoveService` for adjustments

### Validation
- [ ] `createCycleCountSchema`
- [ ] `updateCountItemSchema`
- [ ] `rejectVarianceSchema`
- [ ] `countListFiltersSchema`

### Frontend
- [ ] Cycle count list page
- [ ] Create count form
- [ ] Count execution page
- [ ] Variance review page
- [ ] All UI components (14 components)

### Tests
- [ ] Unit tests (>80% coverage)
- [ ] Integration tests (all endpoints)
- [ ] RLS tests (multi-tenancy)
- [ ] E2E tests (full workflow)

## Definition of Done

- [ ] `cycle_counts` table created with all fields and indexes
- [ ] `cycle_count_items` table created with all fields and indexes
- [ ] RLS policies enforce org isolation for both tables
- [ ] Count number generation works with CC-YYYY-NNNNN format
- [ ] All count types (full, partial, cycle, spot) create correct scope
- [ ] Count sheet generation includes all LPs in scope
- [ ] Count execution updates counted_qty and calculates variance
- [ ] Unexpected LPs can be added during count
- [ ] Variance report shows all items with variance
- [ ] Variance approval workflow works correctly
- [ ] Adjustment posting creates stock_moves and updates LP quantities
- [ ] ABC classification calculates and assigns A/B/C classes
- [ ] Products due for counting identified correctly
- [ ] API response times meet requirements
- [ ] Desktop UI allows complete count workflow
- [ ] Export to CSV/PDF works
- [ ] Unit tests coverage > 80%
- [ ] Integration tests pass
- [ ] E2E tests pass for full workflow
- [ ] RLS prevents cross-tenant access

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-01-15 | Initial story creation | ARCHITECT-AGENT |
| 1.1 | 2025-01-15 | Restructured to match 01.15 template format | ARCHITECT-AGENT |
