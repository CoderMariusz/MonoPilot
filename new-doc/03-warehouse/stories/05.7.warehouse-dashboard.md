# 05.7 - Warehouse Dashboard

**Priority**: P0 (Phase 0 - CRITICAL)
**Story Points**: M (Medium - 2-3 days)
**Type:** backend + frontend

**State:** ready
**Primary PRD:** `docs/1-BASELINE/product/modules/warehouse.md` (WH-FR-030)
**Architecture:** `docs/1-BASELINE/architecture/modules/warehouse.md`

---

## MVP Scope

The Warehouse Dashboard provides a high-level operational overview at `/warehouse` with real-time KPIs, alerts, and activity tracking. This is the landing page for warehouse operators, enabling quick access to inventory status, issues, and recent operations.

**Phase 0 MVP includes:**
- KPI cards: Total LPs, Available LPs, Reserved LPs, Consumed Today, Expiring Soon
- Alert panels: Low stock, expiring items, blocked LPs
- Recent activity feed (last 20 LP operations)
- Quick action buttons (Create LP, View Inventory)
- Redis caching with 1 min TTL for KPI aggregations
- Desktop UI with responsive layout

**Phase 0 MVP excludes:**
- Warehouse-level filtering (Phase 1+)
- Time-series charts/trends (Phase 1+)
- Export dashboard data (Phase 2+)
- Custom dashboard layouts (Phase 3+)
- Mobile scanner view (Phase 2+)

---

## Epic 04 Dependency Status

- [ ] NOT CRITICAL - Can defer
- [x] Supports operational visibility for LP operations

**Rationale:** While the dashboard provides valuable visibility, it does not block Epic 04 Production operations. Epic 04 requires LP CRUD operations (05.1-05.6), not dashboard analytics.

---

## Goal

Provide warehouse operators with a real-time operational overview of inventory status, alerts, and recent activity to enable quick decision-making and proactive issue resolution.

## User Story

As a **warehouse manager**, I want **a dashboard showing inventory KPIs, alerts, and recent activity** so that **I can quickly identify issues, monitor inventory levels, and track warehouse operations without navigating multiple screens**.

## Scope

**In scope (this story)**
- Dashboard page at `/warehouse` (landing page)
- 5 KPI cards: Total LPs, Available LPs, Reserved LPs, Consumed Today, Expiring Soon (< 30 days)
- 3 Alert panels: Low stock (below min_stock threshold), expiring items, blocked LPs
- Recent activity feed showing last 20 LP operations (create, consume, move, split, merge)
- Quick action buttons: "Create LP", "View Inventory"
- API endpoints for dashboard data aggregation
- Service layer with optimized aggregation queries
- Redis caching (1 min TTL) for expensive KPI queries
- Desktop UI with responsive grid layout
- Auto-refresh every 60 seconds
- Unit tests (services, API routes)
- E2E test for dashboard load

**Out of scope (this story)**
- Warehouse-level filtering (05.15 Phase 1+)
- Location/zone-level KPIs (05.30 Phase 3+)
- Time-series charts (Phase 1+)
- Custom KPI thresholds (Phase 1+)
- Export to CSV/PDF (Phase 2+)
- Scanner mobile view (Phase 2+)
- Real-time WebSocket updates (Phase 3+)
- User-customizable widgets (Phase 3+)

## Dependencies

- **05.1** - LP Table + Basic Service (LP CRUD operations)
- **05.2** - LP Genealogy (activity feed, traceability)
- **05.3** - LP Reservations (reserved LPs count)
- **05.4** - FIFO/FEFO Pick Suggestions (expiring soon logic)
- **01.8** - Warehouses CRUD (warehouse context)
- **01.9** - Locations CRUD (location references)
- **02.1** - Products (product names in alerts)

---

## Acceptance Criteria (Given/When/Then)

### AC-1: Dashboard Page Structure

**Given** I am an authenticated user with warehouse permissions
**When** I navigate to `/warehouse`
**Then** I should see:
- 5 KPI cards in a responsive grid (Total LPs, Available LPs, Reserved LPs, Consumed Today, Expiring Soon)
- Alert panels below KPI cards (Low Stock, Expiring Items, Blocked LPs)
- Recent activity feed on the right side
- Quick action buttons at the top-right ("Create LP", "View Inventory")
- Auto-refresh indicator showing "Last updated: [timestamp]"

### AC-2: KPI Card - Total LPs

**Given** my organization has license plates in the database
**When** the dashboard loads
**Then** the "Total LPs" card should display:
- Count of all active LPs (status != 'consumed')
- Icon: Box
- Background: Neutral (gray/blue)
- Format: "1,234 LPs"

### AC-3: KPI Card - Available LPs

**Given** my organization has license plates with various statuses
**When** the dashboard loads
**Then** the "Available LPs" card should display:
- Count of LPs with status='available' AND qa_status='passed'
- Icon: CheckCircle (green)
- Background: Success (green)
- Format: "890 Available"
- Percentage of total: "(72%)"

### AC-4: KPI Card - Reserved LPs

**Given** my organization has reserved license plates
**When** the dashboard loads
**Then** the "Reserved LPs" card should display:
- Count of LPs with status='reserved' AND active reservation records
- Icon: Lock (orange)
- Background: Warning (orange)
- Format: "234 Reserved"
- Percentage of total: "(19%)"

### AC-5: KPI Card - Consumed Today

**Given** my organization has consumed license plates in the last 24 hours
**When** the dashboard loads
**Then** the "Consumed Today" card should display:
- Count of LPs with status='consumed' AND consumed date >= today at midnight (org timezone)
- Icon: TrendingDown
- Background: Info (blue)
- Format: "45 Consumed"
- Subtitle: "Since midnight"

### AC-6: KPI Card - Expiring Soon

**Given** my organization has license plates with expiry dates
**When** the dashboard loads
**Then** the "Expiring Soon" card should display:
- Count of LPs with expiry_date BETWEEN today AND (today + 30 days) AND status='available'
- Icon: AlertTriangle (red)
- Background: Danger (red)
- Format: "12 Expiring"
- Subtitle: "Next 30 days"

### AC-7: Alert Panel - Low Stock

**Given** products have min_stock thresholds defined in settings
**When** the dashboard loads
**Then** the "Low Stock Alerts" panel should display:
- List of products where available LP count < min_stock
- Each alert shows: Product name, Current count, Min stock threshold
- Format: "Product XYZ: 5 LPs (Min: 10)"
- Click on alert navigates to inventory browser filtered by that product
- If no low stock items, show "No low stock alerts"

### AC-8: Alert Panel - Expiring Items

**Given** license plates have expiry dates approaching
**When** the dashboard loads
**Then** the "Expiring Items" panel should display:
- List of LPs expiring in next 30 days, sorted by expiry_date ASC
- Each alert shows: LP number, Product name, Expiry date, Days until expiry
- Format: "LP00000123 - Milk Powder - Exp: 2025-12-25 (9 days)"
- Color-coded: Red (< 7 days), Orange (7-14 days), Yellow (15-30 days)
- Click on alert navigates to LP detail page
- If no expiring items, show "No items expiring soon"

### AC-9: Alert Panel - Blocked LPs

**Given** license plates have qa_status='quarantine' or qa_status='failed'
**When** the dashboard loads
**Then** the "Blocked LPs" panel should display:
- List of LPs with qa_status IN ('quarantine', 'failed') AND status='blocked'
- Each alert shows: LP number, Product name, QA status, Block reason
- Format: "LP00000456 - Sugar - Quarantine - Quality check pending"
- Click on alert navigates to LP detail page
- If no blocked LPs, show "No blocked LPs"

### AC-10: Recent Activity Feed

**Given** my organization has LP operations recorded
**When** the dashboard loads
**Then** the "Recent Activity" feed should display:
- Last 20 LP operations from `lp_genealogy` and LP audit logs
- Each entry shows: Timestamp, Operation type (icon), LP number, User, Description
- Operation types: Create (Plus), Consume (ArrowDown), Split (Split), Merge (Merge), Move (Truck)
- Format: "14:32 - [Icon] LP00000789 - John Smith - Consumed 50kg for WO-00123"
- Sorted by timestamp DESC (most recent first)
- If no activity, show "No recent activity"

### AC-11: Quick Action Buttons

**Given** I am on the warehouse dashboard
**When** I look at the top-right corner
**Then** I should see:
- "Create LP" button (primary, blue) - opens manual LP creation form
- "View Inventory" button (secondary, gray) - navigates to `/warehouse/inventory`
- Buttons are visible and clickable

### AC-12: Auto-Refresh and Caching

**Given** the dashboard is open
**When** 60 seconds have elapsed since the last data fetch
**Then**:
- Dashboard data should automatically refresh
- "Last updated" timestamp should update to current time
- KPI queries should hit Redis cache if available (1 min TTL)
- Cache miss should execute SQL aggregations and update Redis
- User should see a brief loading indicator during refresh

### AC-13: Performance and Loading

**Given** my organization has 10,000+ license plates
**When** the dashboard loads
**Then**:
- Page should render within 2 seconds
- KPI cards should load from Redis cache (< 100ms per query)
- Activity feed should be paginated (last 20 only)
- Alert panels should limit to 10 items each with "View All" link
- No full table scans (all queries use indexes)

---

## Implementation Notes

### API Endpoints

```typescript
// Dashboard KPIs
GET /api/warehouse/dashboard/kpis
Response: {
  total_lps: number,
  available_lps: number,
  reserved_lps: number,
  consumed_today: number,
  expiring_soon: number
}

// Dashboard Alerts
GET /api/warehouse/dashboard/alerts
Response: {
  low_stock: Array<{ product_id, product_name, current_count, min_stock }>,
  expiring_items: Array<{ lp_id, lp_number, product_name, expiry_date, days_until_expiry }>,
  blocked_lps: Array<{ lp_id, lp_number, product_name, qa_status, block_reason }>
}

// Recent Activity
GET /api/warehouse/dashboard/activity?limit=20
Response: {
  activities: Array<{
    timestamp: string,
    operation_type: 'create' | 'consume' | 'split' | 'merge' | 'move',
    lp_id: string,
    lp_number: string,
    user_name: string,
    description: string
  }>
}
```

### Database Queries

**KPI Queries (Cached)**
```sql
-- Total LPs
SELECT COUNT(*) FROM license_plates
WHERE org_id = $1 AND status != 'consumed';

-- Available LPs
SELECT COUNT(*) FROM license_plates
WHERE org_id = $1 AND status = 'available' AND qa_status = 'passed';

-- Reserved LPs
SELECT COUNT(DISTINCT lp_id) FROM lp_reservations
WHERE org_id = $1 AND status = 'active';

-- Consumed Today
SELECT COUNT(*) FROM license_plates
WHERE org_id = $1 AND status = 'consumed'
  AND updated_at >= (CURRENT_DATE AT TIME ZONE 'UTC');

-- Expiring Soon
SELECT COUNT(*) FROM license_plates
WHERE org_id = $1 AND status = 'available'
  AND expiry_date BETWEEN CURRENT_DATE AND (CURRENT_DATE + INTERVAL '30 days');
```

**Alert Queries**
```sql
-- Low Stock Alerts
SELECT p.id, p.name, COUNT(lp.id) AS current_count, ws.min_stock
FROM products p
LEFT JOIN license_plates lp ON lp.product_id = p.id
  AND lp.org_id = $1 AND lp.status = 'available'
LEFT JOIN warehouse_settings ws ON ws.org_id = $1
GROUP BY p.id, p.name, ws.min_stock
HAVING COUNT(lp.id) < COALESCE(ws.min_stock, 0)
ORDER BY (ws.min_stock - COUNT(lp.id)) DESC
LIMIT 10;

-- Expiring Items
SELECT lp.id, lp.lp_number, p.name, lp.expiry_date,
  (lp.expiry_date - CURRENT_DATE) AS days_until_expiry
FROM license_plates lp
JOIN products p ON p.id = lp.product_id
WHERE lp.org_id = $1 AND lp.status = 'available'
  AND lp.expiry_date BETWEEN CURRENT_DATE AND (CURRENT_DATE + INTERVAL '30 days')
ORDER BY lp.expiry_date ASC
LIMIT 10;

-- Blocked LPs
SELECT lp.id, lp.lp_number, p.name, lp.qa_status, lp.block_reason
FROM license_plates lp
JOIN products p ON p.id = lp.product_id
WHERE lp.org_id = $1 AND lp.qa_status IN ('quarantine', 'failed')
  AND lp.status = 'blocked'
ORDER BY lp.updated_at DESC
LIMIT 10;
```

**Activity Feed Query**
```sql
-- Recent LP operations from genealogy + audit
(
  SELECT g.operation_date AS timestamp,
    g.operation_type,
    lp.id AS lp_id,
    lp.lp_number,
    u.full_name AS user_name,
    CONCAT(g.operation_type, ' - ', g.quantity, ' ', lp.uom) AS description
  FROM lp_genealogy g
  JOIN license_plates lp ON lp.id = g.child_lp_id
  LEFT JOIN users u ON u.id = lp.created_by
  WHERE g.org_id = $1
)
UNION ALL
(
  SELECT lp.created_at AS timestamp,
    'create' AS operation_type,
    lp.id AS lp_id,
    lp.lp_number,
    u.full_name AS user_name,
    CONCAT('Created LP - ', lp.quantity, ' ', lp.uom, ' of ', p.name) AS description
  FROM license_plates lp
  JOIN products p ON p.id = lp.product_id
  LEFT JOIN users u ON u.id = lp.created_by
  WHERE lp.org_id = $1
)
ORDER BY timestamp DESC
LIMIT 20;
```

### Frontend Components

```
app/(authenticated)/warehouse/
  page.tsx                          - Dashboard landing page
  components/
    DashboardKPICard.tsx            - Reusable KPI card component
    DashboardAlertPanel.tsx         - Alert panel component
    DashboardActivityFeed.tsx       - Activity feed component
    DashboardQuickActions.tsx       - Quick action buttons
```

### Services

```typescript
// lib/services/warehouse-dashboard-service.ts

export async function getDashboardKPIs(orgId: string): Promise<DashboardKPIs> {
  // Check Redis cache first
  const cached = await redis.get(`dashboard:kpis:${orgId}`);
  if (cached) return JSON.parse(cached);

  // Execute aggregation queries
  const kpis = await executeKPIQueries(orgId);

  // Cache for 1 minute
  await redis.set(`dashboard:kpis:${orgId}`, JSON.stringify(kpis), 'EX', 60);

  return kpis;
}

export async function getDashboardAlerts(orgId: string): Promise<DashboardAlerts> {
  // Check Redis cache
  const cached = await redis.get(`dashboard:alerts:${orgId}`);
  if (cached) return JSON.parse(cached);

  // Execute alert queries
  const alerts = await executeAlertQueries(orgId);

  // Cache for 1 minute
  await redis.set(`dashboard:alerts:${orgId}`, JSON.stringify(alerts), 'EX', 60);

  return alerts;
}

export async function getRecentActivity(orgId: string, limit: number = 20): Promise<Activity[]> {
  // No caching for activity feed (real-time)
  return await supabase
    .from('lp_genealogy')
    .select('*, license_plates(*), users(*)')
    .eq('org_id', orgId)
    .order('operation_date', { ascending: false })
    .limit(limit);
}
```

### Validation (Zod)

```typescript
// lib/validation/warehouse-dashboard.ts

export const dashboardKPIsSchema = z.object({
  total_lps: z.number().int().nonnegative(),
  available_lps: z.number().int().nonnegative(),
  reserved_lps: z.number().int().nonnegative(),
  consumed_today: z.number().int().nonnegative(),
  expiring_soon: z.number().int().nonnegative(),
});

export const dashboardAlertSchema = z.object({
  low_stock: z.array(z.object({
    product_id: z.string().uuid(),
    product_name: z.string(),
    current_count: z.number().int(),
    min_stock: z.number().int(),
  })),
  expiring_items: z.array(z.object({
    lp_id: z.string().uuid(),
    lp_number: z.string(),
    product_name: z.string(),
    expiry_date: z.string().date(),
    days_until_expiry: z.number().int(),
  })),
  blocked_lps: z.array(z.object({
    lp_id: z.string().uuid(),
    lp_number: z.string(),
    product_name: z.string(),
    qa_status: z.enum(['quarantine', 'failed']),
    block_reason: z.string().optional(),
  })),
});

export const activityItemSchema = z.object({
  timestamp: z.string().datetime(),
  operation_type: z.enum(['create', 'consume', 'split', 'merge', 'move']),
  lp_id: z.string().uuid(),
  lp_number: z.string(),
  user_name: z.string(),
  description: z.string(),
});
```

### Redis Cache Configuration

```typescript
// lib/cache/redis-config.ts

export const CACHE_KEYS = {
  DASHBOARD_KPIS: (orgId: string) => `dashboard:kpis:${orgId}`,
  DASHBOARD_ALERTS: (orgId: string) => `dashboard:alerts:${orgId}`,
};

export const CACHE_TTL = {
  DASHBOARD_KPIS: 60,      // 1 minute
  DASHBOARD_ALERTS: 60,    // 1 minute
};

// Cache invalidation on LP operations
export async function invalidateDashboardCache(orgId: string): Promise<void> {
  await redis.del(CACHE_KEYS.DASHBOARD_KPIS(orgId));
  await redis.del(CACHE_KEYS.DASHBOARD_ALERTS(orgId));
}
```

### Key Business Rules

1. **KPI Aggregation**
   - Total LPs excludes consumed LPs (status='consumed')
   - Available LPs requires BOTH status='available' AND qa_status='passed'
   - Reserved LPs counts active reservations (status='active')
   - Consumed Today uses organization timezone for "today" calculation
   - Expiring Soon looks ahead exactly 30 days from current date

2. **Alert Thresholds**
   - Low stock uses min_stock from warehouse_settings
   - Expiring items: Red (< 7 days), Orange (7-14 days), Yellow (15-30 days)
   - Blocked LPs include qa_status='quarantine' OR qa_status='failed'

3. **Activity Feed**
   - Last 20 operations only (performance)
   - Includes LP creation, consumption, split, merge, move
   - Genealogy operations take precedence over simple audit logs

4. **Caching Strategy**
   - KPIs cached for 1 minute (expensive aggregations)
   - Alerts cached for 1 minute (multiple joins)
   - Activity feed NOT cached (real-time updates)
   - Cache invalidated on ANY LP operation

5. **Performance**
   - All KPI queries use indexes (idx_lp_org_status, idx_lp_expiry, etc.)
   - Alert panels limited to 10 items each
   - Activity feed limited to 20 items
   - No full table scans allowed

---

## Deliverables

### API Routes
- `GET /api/warehouse/dashboard/kpis` - KPI aggregations
- `GET /api/warehouse/dashboard/alerts` - Alert panels data
- `GET /api/warehouse/dashboard/activity` - Recent activity feed

### Frontend Components
- `app/(authenticated)/warehouse/page.tsx` - Dashboard landing page
- `components/DashboardKPICard.tsx` - Reusable KPI card
- `components/DashboardAlertPanel.tsx` - Alert panel
- `components/DashboardActivityFeed.tsx` - Activity feed
- `components/DashboardQuickActions.tsx` - Quick action buttons

### Services
- `lib/services/warehouse-dashboard-service.ts` - Dashboard aggregations
- `lib/cache/redis-config.ts` - Cache configuration

### Validation
- `lib/validation/warehouse-dashboard.ts` - Zod schemas for dashboard data

### Tests
- Unit tests for dashboard service (KPI calculations, alert logic)
- API route tests (mocked Redis, mocked Supabase)
- E2E test for dashboard page load (Playwright)
- Cache hit/miss tests
- Performance tests (10K+ LP dataset)

---

## Definition of Done

- [ ] Dashboard page renders at `/warehouse` with all sections
- [ ] 5 KPI cards display correct counts with proper formatting
- [ ] 3 Alert panels show relevant items with click-through navigation
- [ ] Recent activity feed shows last 20 operations
- [ ] Quick action buttons navigate correctly
- [ ] Auto-refresh works every 60 seconds
- [ ] Redis caching implemented with 1 min TTL
- [ ] Cache invalidation on LP operations
- [ ] All queries use indexes (verified with EXPLAIN)
- [ ] API tests passing (>80% coverage)
- [ ] Zod validation for all API responses
- [ ] RLS policies verified (org isolation)
- [ ] E2E smoke test for dashboard load
- [ ] Performance test with 10K+ LPs (< 2s load time)
- [ ] Responsive layout works on desktop and tablet
- [ ] "Last updated" timestamp displays correctly

---

## Future Phases (Not in This Story)

### Phase 1 - Enhanced Dashboard
- Warehouse-level filtering (multi-warehouse orgs)
- Custom date ranges for "Consumed" KPI (last 7 days, last 30 days)
- Time-series chart showing LP creation/consumption trends
- Custom KPI thresholds (user-defined low stock alerts)
- Export dashboard to PDF/CSV

### Phase 2 - Real-Time Updates
- WebSocket integration for live KPI updates
- Real-time activity feed (no 60s refresh)
- Browser notifications for critical alerts
- Mobile scanner view (simplified dashboard)

### Phase 3 - Customization
- User-customizable widget layout (drag-and-drop)
- Saved dashboard views (per user)
- Zone/location-level KPIs (drill-down)
- Aging analysis charts (inventory age distribution)
- Custom alert rules (user-defined thresholds)

### Phase 4 - Advanced Analytics
- Predictive alerts (ML-based low stock forecasting)
- Velocity metrics (turnover rate, aging velocity)
- Cost tracking (COGS per LP)
- OEE integration (warehouse efficiency metrics)

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-12-16 | Initial story creation | ARCHITECT-AGENT |
