# 05.3 - LP Reservations + FIFO/FEFO Picking

**Priority**: P0 (Phase 0 - CRITICAL)
**Story Points**: L (Large - 3-4 days)
**Type:** backend + frontend
**Model:** opus

**State:** ready
**Primary PRD:** `docs/1-BASELINE/product/modules/warehouse.md` (WH-FR-027, WH-FR-019, WH-FR-020)
**Production PRD:** `docs/1-BASELINE/product/modules/production.md` (FR-PROD-016)
**Architecture:** `docs/1-BASELINE/architecture/modules/warehouse.md`

---

## CRITICAL - Unblocks Epic 04.8 (WO Reservations)

**THIS STORY IS A HARD BLOCKER FOR EPIC 04 PRODUCTION PHASE 1**

Epic 04.8 (Material Reservations) cannot proceed without:
1. `lp_reservations` table with full schema
2. FIFO algorithm for finding available LPs
3. FEFO algorithm for expiry-based selection
4. Multi-LP allocation when single LP insufficient
5. Reservation service methods for Epic 04.8 to consume

---

## MVP Scope

This story delivers the **LP Reservation infrastructure** that Epic 04 Production needs:

**In Scope:**
- `lp_reservations` table with RLS
- Reservation tracking (wo_id, lp_id, reserved_qty, status)
- FIFO algorithm: ORDER BY created_at ASC
- FEFO algorithm: ORDER BY expiry_date ASC (overrides FIFO when enabled)
- Settings integration (enable_fifo, enable_fefo from warehouse_settings)
- Service methods Epic 04.8 needs (see Interface Contract below)
- Multi-LP allocation when single LP insufficient
- Reserved vs Available quantity calculation
- Desktop UI: reservations list per WO
- API endpoints for reservations

**Out of Scope:**
- Transfer Order (TO) reservations (to_id column exists but TO logic is Phase 1)
- Scanner reservation UI (Phase 2)
- Automatic reservation on WO start (Epic 04.8 implements)
- Consumption logic (Epic 04.6a implements)

---

## Epic 04 Dependency Status

- [x] **CRITICAL - Unblocks Epic 04 Phase 1**
- [ ] NOT CRITICAL - Can defer

**Rationale:** Epic 04.8 (Material Reservations) is blocked waiting for:
1. `lp_reservations` table
2. `findAvailableLPs()` method with FIFO/FEFO logic
3. `reserveLPs()` method for WO material allocation
4. `releaseReservation()` method for WO cancellation/completion
5. `getReservations()` method for UI display

---

## Goal

Enable Work Orders to reserve specific License Plates for material consumption, using FIFO/FEFO algorithms to suggest optimal LPs, and supporting multi-LP allocation when a single LP has insufficient quantity.

## User Story

As a **production manager**, I want **to reserve specific LPs for work orders** so that **materials are allocated fairly using FIFO/FEFO rules and not consumed by competing work orders**.

## Scope

**In scope (this story)**
- Complete `lp_reservations` table with all columns
- Reservation service with CRUD operations
- FIFO picking algorithm (ORDER BY created_at ASC)
- FEFO picking algorithm (ORDER BY expiry_date ASC)
- Settings-driven algorithm selection
- Multi-LP allocation for partial fulfillment
- Reserved quantity tracking and calculation
- Desktop UI for viewing reservations per WO
- API endpoints for reservation operations
- Unit tests with edge cases

**Out of scope (this story)**
- TO reservations workflow (Phase 1 - Story 05.9)
- Auto-reservation on WO start (Epic 04.8 implements)
- Material consumption (Epic 04.6a implements)
- Scanner reservation UI (Phase 2)

## Dependencies

- **05.0** - Warehouse Settings (for enable_fifo, enable_fefo toggles)
- **05.1** - LP Table + Basic Service (lp_reservations.lp_id references license_plates)
- **Epic 03.10** - Work Orders table (lp_reservations.wo_id references work_orders)

---

## Interface Contract for Epic 04.8

**CRITICAL: These methods are the contract that Epic 04.8 will consume.**

```typescript
// lib/services/lp-reservation-service.ts

export interface AvailableLP {
  id: string;
  lp_number: string;
  product_id: string;
  quantity: number;
  available_qty: number;  // quantity - reserved_qty
  uom: string;
  location_id: string;
  warehouse_id: string;
  batch_number: string | null;
  expiry_date: string | null;
  created_at: string;
  qa_status: string;
}

export interface ReservationResult {
  id: string;
  lp_id: string;
  wo_id: string;
  reserved_qty: number;
  status: 'active' | 'released' | 'consumed';
  reserved_at: string;
  reserved_by: string;
}

export interface AllocationResult {
  success: boolean;
  reservations: ReservationResult[];
  total_reserved: number;
  shortfall: number;  // 0 if fully allocated
  warning?: string;   // FIFO/FEFO violation warning
}

export type PickingStrategy = 'fifo' | 'fefo' | 'none';

/**
 * Find available LPs for a product using FIFO/FEFO strategy
 * @param productId - Product to find LPs for
 * @param warehouseId - Optional warehouse filter
 * @param strategy - 'fifo' | 'fefo' | 'none' (uses settings default if 'none')
 * @returns Sorted list of available LPs
 */
export async function findAvailableLPs(
  productId: string,
  warehouseId?: string,
  strategy?: PickingStrategy
): Promise<AvailableLP[]>;

/**
 * Reserve LPs for a Work Order material requirement
 * @param woId - Work Order ID
 * @param materialId - WO Material ID (for reference)
 * @param productId - Product to reserve
 * @param requiredQty - Quantity needed
 * @param warehouseId - Optional warehouse filter
 * @returns Allocation result with reservations
 */
export async function reserveLPs(
  woId: string,
  materialId: string,
  productId: string,
  requiredQty: number,
  warehouseId?: string
): Promise<AllocationResult>;

/**
 * Release a reservation (when WO cancelled or completed)
 * @param reservationId - Reservation to release
 * @returns Updated reservation
 */
export async function releaseReservation(
  reservationId: string
): Promise<ReservationResult>;

/**
 * Release all reservations for a Work Order
 * @param woId - Work Order ID
 * @returns Number of reservations released
 */
export async function releaseAllReservations(
  woId: string
): Promise<number>;

/**
 * Get all reservations for a Work Order
 * @param woId - Work Order ID
 * @returns List of reservations with LP details
 */
export async function getReservations(
  woId: string
): Promise<ReservationWithLP[]>;

/**
 * Mark reservation as consumed (partial or full)
 * @param reservationId - Reservation ID
 * @param consumedQty - Quantity consumed
 * @returns Updated reservation
 */
export async function consumeReservation(
  reservationId: string,
  consumedQty: number
): Promise<ReservationResult>;

/**
 * Calculate available quantity for an LP (quantity - active reserved)
 * @param lpId - License Plate ID
 * @returns Available quantity
 */
export async function getAvailableQuantity(
  lpId: string
): Promise<number>;
```

---

## Acceptance Criteria (Given/When/Then)

### AC-1: Reservation Creation (WH-FR-027)

```gherkin
Scenario: Create reservation for available LP
Given LP-001 with status='available' AND qa_status='passed' AND quantity=100
And no active reservations exist for LP-001
When reservation created for WO-001 with reserved_qty=50
Then lp_reservations record created with:
  - lp_id = LP-001.id
  - wo_id = WO-001.id
  - reserved_qty = 50
  - status = 'active'
  - reserved_at = NOW()
  - reserved_by = current user
And LP-001.status remains 'available' (LP status only changes to 'reserved' when fully reserved)
And operation completes in <200ms
```

### AC-2: Full LP Reservation Updates LP Status

```gherkin
Scenario: LP status updates when fully reserved
Given LP-001 with quantity=100 AND status='available'
When reservation created for full quantity (reserved_qty=100)
Then LP-001.status updates to 'reserved'
And LP displays as "Reserved for WO-001" in UI
```

### AC-3: Partial Reservation - Available Calculation

```gherkin
Scenario: Calculate available quantity with partial reservation
Given LP-001 with quantity=100
And active reservation exists with reserved_qty=40
When getAvailableQuantity(LP-001.id) called
Then returns 60 (100 - 40 = 60 available)
```

### AC-4: Reservation Blocked for Unavailable LP (WH-FR-027)

```gherkin
Scenario: Cannot reserve unavailable LP
Given LP-001 with status='consumed' OR status='blocked'
When reservation attempted
Then system returns 400 error "LP not available for reservation (status: {status})"
And no reservation record created
```

### AC-5: Cannot Over-Reserve LP

```gherkin
Scenario: Cannot reserve more than available quantity
Given LP-001 with quantity=100
And active reservation exists with reserved_qty=40
When reservation attempted with reserved_qty=70
Then system returns 400 error "Insufficient available quantity (requested: 70, available: 60)"
```

### AC-6: Reservation Released on WO Cancel (WH-FR-027)

```gherkin
Scenario: Release reservation when WO cancelled
Given active reservation for LP-001 with reserved_qty=50
When releaseReservation() called
Then reservation.status updates to 'released'
And reservation.released_at = NOW()
And LP-001.status updates to 'available' (if was fully reserved)
```

### AC-7: FIFO Algorithm (WH-FR-019)

```gherkin
Scenario: FIFO suggests oldest LP first
Given warehouse_settings.enable_fifo = true
And warehouse_settings.enable_fefo = false
And 3 LPs for Product A:
  - LP-001: created_at = 2025-12-01, qty = 50
  - LP-002: created_at = 2025-12-05, qty = 50
  - LP-003: created_at = 2025-12-10, qty = 50
When findAvailableLPs('Product A', null, 'fifo') called
Then LPs returned in order: [LP-001, LP-002, LP-003]
And LP-001 highlighted as "Suggested (FIFO: oldest)"
```

### AC-8: FEFO Algorithm (WH-FR-020)

```gherkin
Scenario: FEFO suggests soonest expiry first
Given warehouse_settings.enable_fefo = true
And 3 LPs for Product A:
  - LP-001: expiry_date = 2026-06-01, created_at = 2025-12-01
  - LP-002: expiry_date = 2026-03-01, created_at = 2025-12-05
  - LP-003: expiry_date = 2026-09-01, created_at = 2025-12-10
When findAvailableLPs('Product A', null, 'fefo') called
Then LPs returned in order: [LP-002, LP-001, LP-003] (by expiry ASC)
And LP-002 highlighted as "Suggested (FEFO: expires 2026-03-01)"
```

### AC-9: FEFO Takes Precedence Over FIFO

```gherkin
Scenario: Both FIFO and FEFO enabled - FEFO wins
Given warehouse_settings.enable_fifo = true
And warehouse_settings.enable_fefo = true
When findAvailableLPs() called
Then LPs sorted by expiry_date ASC, created_at ASC (FEFO primary)
```

### AC-10: NULL Expiry Dates in FEFO

```gherkin
Scenario: NULL expiry dates sorted last in FEFO
Given 3 LPs for Product A:
  - LP-001: expiry_date = NULL, created_at = 2025-12-01
  - LP-002: expiry_date = 2026-03-01, created_at = 2025-12-05
  - LP-003: expiry_date = NULL, created_at = 2025-12-10
When FEFO sorting applied
Then LPs returned in order: [LP-002, LP-001, LP-003]
  (LP with expiry first, then NULL expiries by created_at)
```

### AC-11: Expired LPs Excluded (WH-FR-020)

```gherkin
Scenario: Expired LPs excluded from suggestions
Given LP-001 with expiry_date < CURRENT_DATE
When findAvailableLPs() called
Then LP-001 NOT included in results
And log entry created: "Excluded expired LP: LP-001"
```

### AC-12: QA Status Filter

```gherkin
Scenario: Only QA-passed LPs suggested
Given LP-001 with qa_status='pending'
And LP-002 with qa_status='passed'
And LP-003 with qa_status='failed'
When findAvailableLPs() called
Then only LP-002 returned in results
```

### AC-13: Multi-LP Allocation (Partial Fulfillment)

```gherkin
Scenario: Reserve from multiple LPs when single insufficient
Given WO requires 100 units of Product A
And available LPs (FIFO order):
  - LP-001: available_qty = 40
  - LP-002: available_qty = 50
  - LP-003: available_qty = 60
When reserveLPs(woId, materialId, productId, 100) called
Then creates reservations:
  - LP-001: reserved_qty = 40 (full LP)
  - LP-002: reserved_qty = 50 (full LP)
  - LP-003: reserved_qty = 10 (partial)
And AllocationResult.total_reserved = 100
And AllocationResult.shortfall = 0
And AllocationResult.success = true
```

### AC-14: Partial Allocation with Shortfall

```gherkin
Scenario: Partial allocation when insufficient inventory
Given WO requires 100 units of Product A
And total available quantity = 70 (across all LPs)
When reserveLPs(woId, materialId, productId, 100) called
Then creates reservations for all available qty (70 total)
And AllocationResult.total_reserved = 70
And AllocationResult.shortfall = 30
And AllocationResult.success = true (partial allocation allowed)
And AllocationResult.warning = "Partial allocation: 30 units short"
```

### AC-15: FIFO/FEFO Violation Warning

```gherkin
Scenario: Warning when user selects non-optimal LP
Given FIFO enabled
And LP-001 is oldest (suggested)
And LP-002 is newer
When user manually reserves LP-002 instead of LP-001
Then warning displayed: "FIFO violation: LP-002 is newer than suggested LP-001"
And reservation allowed (warning only, not blocking)
And audit log entry created with fifo_violation_flag = true
```

### AC-16: Get Reservations with LP Details

```gherkin
Scenario: Query reservations for WO with LP details
Given WO-001 has 3 active reservations
When getReservations('WO-001') called
Then returns list with:
  - reservation fields (id, reserved_qty, status, etc.)
  - LP details (lp_number, product_name, batch, expiry, location)
And results include consumed_qty for each reservation
And results include remaining_qty = reserved_qty - consumed_qty
```

### AC-17: Desktop UI - Reservations Panel

```gherkin
Scenario: View reservations on WO detail page
Given user navigates to WO detail page
And WO has 3 material reservations
When reservations panel loads
Then displays table with columns:
  - Material Name
  - LP Number
  - Reserved Qty
  - Consumed Qty
  - Remaining Qty
  - Status (active/released/consumed)
  - Expiry Date
  - Location
And "Release" button visible for each active reservation (Manager role)
```

### AC-18: Release Reservation from UI

```gherkin
Scenario: Manager releases reservation
Given Manager views active reservation on WO
When clicks "Release" button
Then confirmation modal: "Release reservation of 50 units from LP-001?"
When confirmed
Then reservation.status = 'released'
And LP available for other WOs
And success toast: "Reservation released"
```

---

## Implementation Notes

### Database Schema

```sql
-- lp_reservations table (from architecture doc)
CREATE TABLE lp_reservations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id),
  lp_id UUID NOT NULL REFERENCES license_plates(id),
  wo_id UUID REFERENCES work_orders(id),
  to_id UUID REFERENCES transfer_orders(id),  -- Phase 1
  wo_material_id UUID REFERENCES wo_materials(id),  -- For Epic 04.8 linking
  reserved_qty DECIMAL(15,4) NOT NULL,
  consumed_qty DECIMAL(15,4) NOT NULL DEFAULT 0,
  status TEXT NOT NULL DEFAULT 'active',  -- active, released, consumed
  reserved_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  released_at TIMESTAMPTZ,
  reserved_by UUID REFERENCES users(id),
  created_at TIMESTAMPTZ DEFAULT NOW(),

  -- Constraints
  CONSTRAINT valid_status CHECK (status IN ('active', 'released', 'consumed')),
  CONSTRAINT positive_qty CHECK (reserved_qty > 0),
  CONSTRAINT consumed_lte_reserved CHECK (consumed_qty <= reserved_qty)
);

-- Indexes for performance
CREATE INDEX idx_reservation_lp ON lp_reservations(lp_id);
CREATE INDEX idx_reservation_wo ON lp_reservations(wo_id) WHERE wo_id IS NOT NULL;
CREATE INDEX idx_reservation_status ON lp_reservations(org_id, status);
CREATE INDEX idx_reservation_org_lp ON lp_reservations(org_id, lp_id, status);

-- RLS
ALTER TABLE lp_reservations ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Reservation org isolation" ON lp_reservations
  FOR ALL USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));
```

### FIFO/FEFO Query

```sql
-- FIFO query (when enable_fifo = true, enable_fefo = false)
SELECT
  lp.*,
  lp.quantity - COALESCE(SUM(r.reserved_qty) FILTER (WHERE r.status = 'active'), 0) as available_qty
FROM license_plates lp
LEFT JOIN lp_reservations r ON lp.id = r.lp_id AND r.status = 'active'
WHERE lp.org_id = $org_id
  AND lp.product_id = $product_id
  AND lp.status = 'available'
  AND lp.qa_status = 'passed'
  AND (lp.expiry_date IS NULL OR lp.expiry_date > CURRENT_DATE)
  AND ($warehouse_id IS NULL OR lp.warehouse_id = $warehouse_id)
GROUP BY lp.id
HAVING lp.quantity - COALESCE(SUM(r.reserved_qty) FILTER (WHERE r.status = 'active'), 0) > 0
ORDER BY lp.created_at ASC;

-- FEFO query (when enable_fefo = true)
-- Same as above but ORDER BY:
ORDER BY
  CASE WHEN lp.expiry_date IS NULL THEN 1 ELSE 0 END,  -- NULLs last
  lp.expiry_date ASC,
  lp.created_at ASC;
```

### API Endpoints

```typescript
// LP Reservation endpoints
GET    /api/warehouse/reservations                    -- List reservations (filter: wo_id, lp_id, status)
GET    /api/warehouse/reservations/:id                -- Get reservation detail
POST   /api/warehouse/reservations                    -- Create reservation
PUT    /api/warehouse/reservations/:id                -- Update reservation
DELETE /api/warehouse/reservations/:id                -- Cancel/release reservation

// Picking suggestion endpoints
GET    /api/warehouse/picking/available               -- Find available LPs
POST   /api/warehouse/picking/suggest                 -- Get picking suggestions (FIFO/FEFO)
POST   /api/warehouse/picking/reserve                 -- Reserve LPs for WO (multi-LP)

// WO-specific endpoints (for Epic 04.8)
GET    /api/warehouse/work-orders/:woId/reservations  -- Get reservations for WO
POST   /api/warehouse/work-orders/:woId/reserve       -- Create reservations for WO
DELETE /api/warehouse/work-orders/:woId/reservations  -- Release all WO reservations
```

### Frontend Components

```
app/(authenticated)/warehouse/
  reservations/
    page.tsx                      -- Reservations list (all WOs)
    components/
      ReservationsTable.tsx       -- Table with filters
      ReservationDetail.tsx       -- Reservation detail panel
      ReleaseModal.tsx            -- Release confirmation

app/(authenticated)/production/
  work-orders/[id]/
    components/
      ReservationsPanel.tsx       -- WO reservations panel
      ReserveLPsModal.tsx         -- Reserve LPs for material
      FIFOFEFOSuggestions.tsx     -- Picking suggestions UI
```

### Services

```typescript
// lib/services/lp-reservation-service.ts
export async function createReservation(data: CreateReservationInput): Promise<Reservation>
export async function releaseReservation(id: string): Promise<Reservation>
export async function releaseAllReservations(woId: string): Promise<number>
export async function getReservations(woId: string): Promise<ReservationWithLP[]>
export async function consumeReservation(id: string, qty: number): Promise<Reservation>

// lib/services/fifo-fefo-service.ts
export async function findAvailableLPs(productId: string, warehouseId?: string, strategy?: PickingStrategy): Promise<AvailableLP[]>
export async function reserveLPs(woId: string, materialId: string, productId: string, qty: number, warehouseId?: string): Promise<AllocationResult>
export async function getPickingStrategy(): Promise<PickingStrategy>
export async function checkFIFOFEFOViolation(selectedLpId: string, suggestedLpId: string): Promise<ViolationResult>
```

### Validation (Zod)

```typescript
// lib/validation/reservation-schemas.ts
import { z } from 'zod';

export const createReservationSchema = z.object({
  lp_id: z.string().uuid(),
  wo_id: z.string().uuid().optional(),
  to_id: z.string().uuid().optional(),
  wo_material_id: z.string().uuid().optional(),
  reserved_qty: z.number().positive("Reserved quantity must be positive"),
}).refine(data => data.wo_id || data.to_id, {
  message: "Either wo_id or to_id must be provided"
});

export const reserveLPsSchema = z.object({
  wo_id: z.string().uuid(),
  material_id: z.string().uuid(),
  product_id: z.string().uuid(),
  required_qty: z.number().positive("Required quantity must be positive"),
  warehouse_id: z.string().uuid().optional(),
});

export const findAvailableLPsSchema = z.object({
  product_id: z.string().uuid(),
  warehouse_id: z.string().uuid().optional(),
  strategy: z.enum(['fifo', 'fefo', 'none']).optional(),
});
```

---

## Key Business Rules

1. **LP Status**: LP status changes to 'reserved' only when FULLY reserved (available_qty = 0)
2. **Available Calculation**: available_qty = quantity - SUM(active reservations reserved_qty)
3. **QA Required**: Only qa_status='passed' LPs can be reserved
4. **No Expired LPs**: LPs with expiry_date < CURRENT_DATE are excluded
5. **FIFO Default**: FIFO is default algorithm (ORDER BY created_at ASC)
6. **FEFO Precedence**: When both enabled, FEFO takes precedence (ORDER BY expiry_date ASC, created_at ASC)
7. **NULL Expiry**: LPs without expiry_date sort LAST in FEFO
8. **Multi-LP Allocation**: System allocates from multiple LPs when single LP insufficient
9. **Partial Allowed**: Partial allocation allowed (shortfall reported in result)
10. **Violation Warning**: FIFO/FEFO violation is WARNING only, not blocking
11. **Consumed <= Reserved**: consumed_qty cannot exceed reserved_qty
12. **Release on Cancel**: All reservations released when WO cancelled/completed

---

## Deliverables

- **Migration**: `lp_reservations` table with RLS
- **API Routes**:
  - `GET/POST /api/warehouse/reservations`
  - `GET/PUT/DELETE /api/warehouse/reservations/:id`
  - `GET /api/warehouse/picking/available`
  - `POST /api/warehouse/picking/suggest`
  - `POST /api/warehouse/picking/reserve`
  - `GET /api/warehouse/work-orders/:woId/reservations`
- **Services**:
  - `lp-reservation-service.ts`
  - `fifo-fefo-service.ts`
- **Components**:
  - `ReservationsTable.tsx`
  - `ReservationsPanel.tsx` (for WO detail page)
  - `FIFOFEFOSuggestions.tsx`
  - `ReleaseModal.tsx`
- **Tests**:
  - Unit tests for FIFO/FEFO algorithms
  - Edge cases: NULL expiry, partial allocation, over-reservation
  - Integration tests for reservation lifecycle

---

## Test Cases (Edge Cases)

### FIFO/FEFO Tests

| Test Case | Input | Expected Output |
|-----------|-------|-----------------|
| FIFO basic | 3 LPs with different created_at | Oldest first |
| FEFO basic | 3 LPs with different expiry | Soonest expiry first |
| FEFO NULL expiry | 2 LPs with NULL, 1 with expiry | Expiry first, then NULLs by created_at |
| FEFO same expiry | 3 LPs same expiry, different created_at | Same expiry grouped, then FIFO within group |
| Both enabled | enable_fifo=true, enable_fefo=true | FEFO takes precedence |
| Neither enabled | enable_fifo=false, enable_fefo=false | No sorting (default order) |
| Expired LP | LP with expiry < today | Excluded from results |

### Reservation Tests

| Test Case | Input | Expected Output |
|-----------|-------|-----------------|
| Create reservation | LP with 100 qty, reserve 50 | Reservation created, LP status unchanged |
| Full reservation | LP with 100 qty, reserve 100 | LP status = 'reserved' |
| Over-reserve | LP with 100 qty (60 available), reserve 70 | Error: insufficient qty |
| Release reservation | Active reservation | Status = 'released', LP available |
| Multi-LP allocation | Need 100, LP-1=40, LP-2=50, LP-3=60 | 3 reservations (40+50+10) |
| Partial allocation | Need 100, total available 70 | 70 reserved, shortfall=30 |
| QA filter | LP with qa_status='pending' | Not included in available |
| Consumed exceeds reserved | Try to consume 60 when reserved 50 | Error: consumed > reserved |

---

## Definition of Done

- [ ] `lp_reservations` table created with all columns
- [ ] RLS policy enforces org_id isolation
- [ ] FIFO algorithm: ORDER BY created_at ASC
- [ ] FEFO algorithm: ORDER BY expiry_date ASC, created_at ASC
- [ ] NULL expiry dates sort last in FEFO
- [ ] Expired LPs excluded from suggestions
- [ ] Only qa_status='passed' LPs suggested
- [ ] Multi-LP allocation works correctly
- [ ] Partial allocation with shortfall reporting
- [ ] Available quantity calculation accurate
- [ ] LP status updates when fully reserved
- [ ] Release reservation restores LP availability
- [ ] API endpoints functional with <200ms response
- [ ] Desktop UI shows reservations per WO
- [ ] Release modal with confirmation
- [ ] Unit tests >80% coverage
- [ ] Edge case tests for NULL expiry, partial allocation
- [ ] Integration tests for reservation lifecycle
- [ ] Service methods match interface contract for Epic 04.8
- [ ] Documentation updated

---

## Future Phases (Not in This Story)

### Phase 1 (Story 05.9 - GRN from TO)
- TO reservations (to_id column populated)
- Transfer Order material allocation
- Inter-warehouse reservation

### Epic 04.8 (Material Reservations)
- Auto-reserve on WO start
- Integration with wo_materials table
- Consumption from reserved LPs
- Release unused on WO complete

### Phase 2 (Scanner Workflows)
- Scanner reservation UI
- Barcode scan to reserve
- Quick release actions

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-12-16 | Initial story - LP Reservations + FIFO/FEFO | OPUS (Story Writer) |
