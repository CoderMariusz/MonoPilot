# 05.22 - Pallet Management

**Story ID:** 05.22
**Epic:** 05 - Warehouse
**Phase:** 2 (Advanced Features)
**Complexity:** L (Large)
**Estimate:** 5-7 days
**Type:** Backend + Frontend
**State:** ready

**Primary PRD:** `docs/1-BASELINE/product/modules/warehouse.md` (WH-FR-016, WH-FR-018)
**UX Wireframes:** WH-020 (Pallet List), WH-021 (Pallet Detail), WH-022 (Pallet Create)

## PRD References

| FR ID | Requirement | Priority | Phase | Covered |
|-------|-------------|----------|-------|---------|
| WH-FR-016 | Pallet Management - Create/add/remove LPs, SSCC codes | P1 | 2 | Full |
| WH-FR-018 | GS1 SSCC Support - Generate/scan SSCC-18 codes | P1 | 2 | Partial |
| WH-FR-014 | Label Print - Print ZPL labels for pallets | P1 | 2 | Partial |

## User Story

**As a** Warehouse Operator,
**I want** to create pallets, add and remove License Plates, and print pallet labels,
**So that** I can efficiently group inventory for shipping and track pallets with industry-standard SSCC-18 codes.

**As a** Shipping Coordinator,
**I want** to view pallet contents and status,
**So that** I can verify shipment readiness and track pallets through the shipping process.

## Goal

Implement comprehensive pallet management enabling operators to create pallets, add/remove LPs, close pallets for shipping, calculate weights, and print SSCC-18 labels. Pallets serve as logical grouping of LPs for shipping and storage, providing visibility into inventory at the pallet level.

## Scope

**In scope:**
- Pallet CRUD operations (create, read, update, delete)
- SSCC-18 pallet number generation (if GS1 enabled)
- Standard pallet numbering (if GS1 disabled)
- Add LP to pallet (with validation)
- Remove LP from pallet
- Move pallet (moves all linked LPs)
- Close pallet (no further LP additions)
- Reopen pallet (admin only)
- Pallet weight calculation (sum of LP weights)
- Pallet label printing (ZPL with SSCC-18 barcode)
- Pallet status tracking (open/closed/shipped)
- Desktop UI: list, detail, create, edit

**Out of scope:**
- Scanner pallet workflows (Story 05.19)
- GS1 SSCC parsing on scan (Story 05.25)
- Pallet shipping integration (Epic 07)
- Pallet templates/configurations
- Multi-level pallets (pallets on pallets)

## Dependencies

| Story | Requirement | Status | Notes |
|-------|-------------|--------|-------|
| 05.1 | LP Table + CRUD | Required | Pallet references LPs via pallet_id |
| 05.0 | Warehouse Settings | Required | enable_pallets, enable_gs1_barcodes settings |
| 05.14 | Label Printing (ZPL) | Required | Print pallet labels |
| 01.8 | Warehouses | Required | Pallet warehouse assignment |
| 01.9 | Locations | Required | Pallet location tracking |

**Dependents (What This Unblocks):**
- 05.19: Scanner Pack workflow (add LP to pallet via scanner)
- 05.25: GS1 SSCC Support (full SSCC parsing)
- 07.x: Shipping workflows (ship pallets)

## Acceptance Criteria (Given/When/Then)

### AC-1: Pallet Table Creation

```gherkin
Scenario: Pallets table exists with all required columns
  Given database migration runs
  When schema is inspected
  Then pallets table has columns:
    | Column | Type | Nullable | Default |
    | id | UUID | NO | gen_random_uuid() |
    | org_id | UUID | NO | - |
    | pallet_number | TEXT | NO | - |
    | pallet_type | TEXT | YES | 'standard' |
    | warehouse_id | UUID | NO | - |
    | location_id | UUID | NO | - |
    | status | TEXT | NO | 'open' |
    | sscc | TEXT | YES | - |
    | weight_kg | DECIMAL(10,2) | YES | - |
    | lp_count | INTEGER | NO | 0 |
    | notes | TEXT | YES | - |
    | created_at | TIMESTAMPTZ | NO | NOW() |
    | created_by | UUID | YES | - |
    | closed_at | TIMESTAMPTZ | YES | - |
    | closed_by | UUID | YES | - |
    | shipped_at | TIMESTAMPTZ | YES | - |
  And UNIQUE constraint exists on (org_id, pallet_number)
  And UNIQUE constraint exists on (org_id, sscc) WHERE sscc IS NOT NULL
```

### AC-2: Pallet Items Table Creation

```gherkin
Scenario: Pallet items table exists
  Given database migration runs
  When schema is inspected
  Then pallet_items table has columns:
    | Column | Type | Nullable | Default |
    | id | UUID | NO | gen_random_uuid() |
    | pallet_id | UUID | NO | - |
    | lp_id | UUID | NO | - |
    | added_at | TIMESTAMPTZ | NO | NOW() |
    | added_by | UUID | YES | - |
    | sequence | INTEGER | YES | - |
  And UNIQUE constraint exists on (pallet_id, lp_id)
  And FK constraint exists on pallet_id REFERENCES pallets(id)
  And FK constraint exists on lp_id REFERENCES license_plates(id)
```

### AC-3: Pallet Creation (WH-FR-016)

```gherkin
Scenario: Create pallet with auto-generated number (GS1 disabled)
  Given warehouse_settings.enable_pallets = true
  And warehouse_settings.enable_gs1_barcodes = false
  When POST /api/warehouse/pallets with:
    | warehouse_id | {valid_uuid} |
    | location_id | {valid_uuid} |
  Then pallet created with auto-generated pallet_number 'PLT-00000001'
  And status = 'open'
  And sscc = NULL
  And lp_count = 0
  And response time < 200ms

Scenario: Create pallet with SSCC-18 (GS1 enabled)
  Given warehouse_settings.enable_pallets = true
  And warehouse_settings.enable_gs1_barcodes = true
  And warehouse_settings.gs1_company_prefix = '1234567'
  When POST /api/warehouse/pallets with:
    | warehouse_id | {valid_uuid} |
    | location_id | {valid_uuid} |
  Then pallet created with auto-generated pallet_number
  And sscc is valid 18-digit SSCC (format: 0 + 1234567 + serial + check)
  And pallet_number = sscc (for GS1 orgs)
  And status = 'open'
  And response time < 300ms

Scenario: Create pallet with custom number
  Given warehouse_settings.enable_pallets = true
  When POST /api/warehouse/pallets with:
    | pallet_number | CUSTOM-PLT-001 |
    | warehouse_id | {valid_uuid} |
    | location_id | {valid_uuid} |
  Then pallet created with pallet_number = 'CUSTOM-PLT-001'

Scenario: Pallet creation blocked if pallets disabled
  Given warehouse_settings.enable_pallets = false
  When POST /api/warehouse/pallets
  Then 400 error "Pallet management is disabled for this organization"

Scenario: Duplicate pallet number rejected
  Given pallet 'PLT-00000001' exists in org A
  When POST /api/warehouse/pallets with pallet_number = 'PLT-00000001' in org A
  Then 409 Conflict "Pallet number already exists"
```

### AC-4: SSCC-18 Generation (WH-FR-018)

```gherkin
Scenario: Generate valid SSCC-18
  Given gs1_company_prefix = '1234567'
  When generateSSCC() is called
  Then SSCC has 18 digits
  And format is: extension(1) + company_prefix(7) + serial(9) + check(1)
  And check digit is valid per GS1 algorithm

Scenario: SSCC uniqueness across org
  Given 1000 pallets exist with SSCCs
  When new SSCC generated
  Then SSCC is unique in organization

Scenario: Sequential serial reference
  Given last SSCC serial was 000000001
  When new SSCC generated
  Then serial is 000000002
```

### AC-5: Add LP to Pallet (WH-FR-016)

```gherkin
Scenario: Add LP to open pallet
  Given pallet 'PLT-001' with status = 'open'
  And LP 'LP-001' with status = 'available' and pallet_id = NULL
  When POST /api/warehouse/pallets/{pallet_id}/add-lp with lp_id = 'LP-001'
  Then pallet_items record created (pallet_id, lp_id, sequence)
  And license_plates.pallet_id updated to pallet.id
  And pallet.lp_count incremented by 1
  And pallet.weight_kg recalculated
  And response time < 200ms

Scenario: Add LP with catch weight to pallet
  Given LP with catch_weight_kg = 25.5
  And pallet with current weight_kg = 100
  When LP added to pallet
  Then pallet.weight_kg = 125.5

Scenario: Add LP blocked if pallet closed
  Given pallet with status = 'closed'
  When POST /api/warehouse/pallets/{pallet_id}/add-lp
  Then 400 error "Cannot add LP to closed pallet"

Scenario: Add LP blocked if LP already on pallet
  Given LP 'LP-001' with pallet_id = 'PLT-002'
  When POST /api/warehouse/pallets/PLT-001/add-lp with lp_id = 'LP-001'
  Then 400 error "LP is already on pallet PLT-002"

Scenario: Add LP blocked if LP not available
  Given LP with status = 'consumed'
  When POST /api/warehouse/pallets/{pallet_id}/add-lp
  Then 400 error "LP is not available (status: consumed)"

Scenario: Add LP from different warehouse blocked
  Given pallet in warehouse WH-001
  And LP in warehouse WH-002
  When POST /api/warehouse/pallets/{pallet_id}/add-lp
  Then 400 error "LP must be in same warehouse as pallet"
```

### AC-6: Remove LP from Pallet

```gherkin
Scenario: Remove LP from open pallet
  Given pallet 'PLT-001' with LP 'LP-001' attached
  And pallet.status = 'open'
  When POST /api/warehouse/pallets/{pallet_id}/remove-lp with lp_id = 'LP-001'
  Then pallet_items record deleted
  And license_plates.pallet_id set to NULL
  And pallet.lp_count decremented by 1
  And pallet.weight_kg recalculated
  And response time < 200ms

Scenario: Remove LP blocked if pallet closed
  Given pallet with status = 'closed'
  When POST /api/warehouse/pallets/{pallet_id}/remove-lp
  Then 400 error "Cannot remove LP from closed pallet"

Scenario: Remove LP blocked if pallet shipped
  Given pallet with status = 'shipped'
  When POST /api/warehouse/pallets/{pallet_id}/remove-lp
  Then 400 error "Cannot modify shipped pallet"
```

### AC-7: Close Pallet (WH-FR-016)

```gherkin
Scenario: Close pallet with LPs
  Given pallet with status = 'open' and lp_count > 0
  When POST /api/warehouse/pallets/{pallet_id}/close
  Then pallet.status = 'closed'
  And pallet.closed_at = NOW()
  And pallet.closed_by = current_user_id
  And response time < 200ms

Scenario: Close empty pallet blocked
  Given pallet with status = 'open' and lp_count = 0
  When POST /api/warehouse/pallets/{pallet_id}/close
  Then 400 error "Cannot close empty pallet"

Scenario: Close already closed pallet blocked
  Given pallet with status = 'closed'
  When POST /api/warehouse/pallets/{pallet_id}/close
  Then 400 error "Pallet is already closed"
```

### AC-8: Reopen Pallet (Admin Only)

```gherkin
Scenario: Admin reopens closed pallet
  Given pallet with status = 'closed'
  And user has ADMIN or SUPER_ADMIN role
  When POST /api/warehouse/pallets/{pallet_id}/reopen
  Then pallet.status = 'open'
  And pallet.closed_at = NULL
  And pallet.closed_by = NULL
  And audit log entry created

Scenario: Non-admin reopen blocked
  Given pallet with status = 'closed'
  And user has OPERATOR role
  When POST /api/warehouse/pallets/{pallet_id}/reopen
  Then 403 Forbidden "Only admins can reopen pallets"

Scenario: Reopen shipped pallet blocked
  Given pallet with status = 'shipped'
  When POST /api/warehouse/pallets/{pallet_id}/reopen
  Then 400 error "Cannot reopen shipped pallet"
```

### AC-9: Move Pallet (WH-FR-016)

```gherkin
Scenario: Move pallet to new location
  Given pallet 'PLT-001' at location A with 5 LPs
  When POST /api/warehouse/pallets/{pallet_id}/move with location_id = B
  Then pallet.location_id = B
  And all 5 LPs location_id updated to B
  And stock_move record created for pallet move
  And response time < 500ms (5 LPs)

Scenario: Move pallet to different warehouse
  Given pallet at warehouse WH-001
  And destination location in warehouse WH-002
  When POST /api/warehouse/pallets/{pallet_id}/move
  Then pallet.warehouse_id = WH-002
  And all LPs warehouse_id updated to WH-002
  And all LPs location_id updated to destination

Scenario: Move shipped pallet blocked
  Given pallet with status = 'shipped'
  When POST /api/warehouse/pallets/{pallet_id}/move
  Then 400 error "Cannot move shipped pallet"
```

### AC-10: Pallet Weight Calculation (WH-FR-016)

```gherkin
Scenario: Calculate weight from LP catch weights
  Given pallet with 3 LPs:
    | LP | catch_weight_kg |
    | LP-001 | 25.5 |
    | LP-002 | 30.0 |
    | LP-003 | NULL |
  When weight calculated
  Then pallet.weight_kg = 55.5 (sum of non-null weights)

Scenario: Calculate weight from product estimated weights
  Given pallet with LP where catch_weight_kg = NULL
  And LP.product.estimated_weight_kg = 0.5
  And LP.quantity = 100
  When weight calculated (fallback mode)
  Then LP contributes 50.0 kg to pallet weight

Scenario: Weight recalculated on LP add/remove
  Given pallet with weight_kg = 100
  And LP with catch_weight_kg = 25.5
  When LP added to pallet
  Then pallet.weight_kg = 125.5
  When LP removed from pallet
  Then pallet.weight_kg = 100
```

### AC-11: Pallet Label Printing (WH-FR-014)

```gherkin
Scenario: Print pallet label with SSCC
  Given pallet with sscc = '012345670000000018'
  When POST /api/warehouse/pallets/{pallet_id}/print-label
  Then ZPL generated with:
    | Element | Content |
    | SSCC Barcode | Code 128 with (00)012345670000000018 |
    | Pallet Number | PLT-001 |
    | LP Count | 5 LPs |
    | Weight | 125.5 kg |
    | Pack Date | 2025-01-15 |
    | QR Code | Pallet data JSON |
  And print job queued successfully
  And response time < 1000ms

Scenario: Print pallet label without SSCC
  Given pallet with sscc = NULL
  When POST /api/warehouse/pallets/{pallet_id}/print-label
  Then ZPL generated with pallet_number barcode (Code 128)
  And no SSCC barcode

Scenario: Print multiple copies
  Given print request with copies = 3
  When POST /api/warehouse/pallets/{pallet_id}/print-label
  Then 3 labels queued for printing
```

### AC-12: Pallet List UI

```gherkin
Scenario: View pallet list page
  Given user navigates to /warehouse/pallets
  When page loads
  Then Pallet DataTable displays within 500ms
  And columns show: Pallet#, SSCC, LPs, Weight, Status, Location, Created

Scenario: Pallet status badges
  Given pallets with different statuses
  When viewing list
  Then status badges display with colors:
    | Status | Color |
    | open | Green |
    | closed | Blue |
    | shipped | Gray |

Scenario: Filter pallets by status
  Given 50 open pallets and 30 closed pallets
  When user filters by status = 'open'
  Then only 50 open pallets returned

Scenario: Filter pallets by warehouse
  Given pallets in WH-001 and WH-002
  When user filters by warehouse = WH-001
  Then only WH-001 pallets returned

Scenario: Search pallets by number/SSCC
  Given pallets: PLT-001, PLT-002, PLT-100
  When user searches 'PLT-00'
  Then PLT-001, PLT-002 returned (prefix match)
```

### AC-13: Pallet Detail Panel

```gherkin
Scenario: View pallet detail
  Given pallet 'PLT-001' with 5 LPs
  When user clicks on pallet row
  Then detail panel slides in from right
  And shows pallet header info (number, SSCC, status, location)
  And shows LP list (LP#, Product, Qty, Weight, Batch, Expiry)
  And shows weight summary (total weight)
  And shows timestamps (created, closed, shipped)

Scenario: Quick actions in detail panel
  Given pallet detail panel open
  And pallet.status = 'open'
  Then quick actions available:
    | Action | Condition |
    | Add LP | status = open |
    | Remove LP | status = open, has LPs |
    | Close | status = open, lp_count > 0 |
    | Move | status != shipped |
    | Print Label | always |

Scenario: Add LP from detail panel
  Given pallet detail panel open
  When user clicks "Add LP"
  Then LP selection dialog opens
  And shows available LPs in same warehouse
  And user can search/filter LPs
  And user selects LP and confirms
  And LP added to pallet and list refreshes
```

### AC-14: Pallet Create Modal

```gherkin
Scenario: Create pallet via modal
  Given user on pallet list page
  When user clicks "New Pallet"
  Then create modal opens with fields:
    | Field | Type | Required |
    | Pallet Number | Text (optional if auto) | No |
    | Pallet Type | Select (EUR, Standard, Custom) | No |
    | Warehouse | Select | Yes |
    | Location | Select (filtered by warehouse) | Yes |
    | Notes | Textarea | No |

Scenario: Auto-generate pallet number
  Given create modal open
  And "Auto-generate" checkbox checked (default)
  When pallet created
  Then pallet_number auto-generated based on settings

Scenario: Create pallet with custom number
  Given create modal open
  And "Auto-generate" checkbox unchecked
  When user enters pallet_number = 'MY-PALLET-001'
  Then pallet created with 'MY-PALLET-001'
```

### AC-15: RLS Policy Enforcement

```gherkin
Scenario: Org isolation on pallet list
  Given User A from Org A
  And User B from Org B
  And pallets exist in both orgs
  When User A requests /api/warehouse/pallets
  Then only Org A pallets returned

Scenario: Cross-tenant pallet access returns 404
  Given pallet belongs to Org B
  When User A from Org A requests /api/warehouse/pallets/{orgB_pallet_id}
  Then 404 Not Found returned (not 403)

Scenario: RLS on pallet_items
  Given pallet_item links pallet to LP
  When User A queries pallet_items for Org B pallet
  Then no results returned (RLS blocks)
```

### AC-16: Performance Requirements

```gherkin
Scenario: Pallet lookup by ID
  Given pallet exists
  When GET /api/warehouse/pallets/{id}
  Then response time < 100ms

Scenario: Pallet list with filters
  Given 1000 pallets in warehouse
  When GET /api/warehouse/pallets with filters
  Then response time < 500ms

Scenario: Add LP to pallet
  Given valid pallet and LP
  When POST /api/warehouse/pallets/{id}/add-lp
  Then response time < 200ms

Scenario: Move pallet with 20 LPs
  Given pallet with 20 LPs
  When POST /api/warehouse/pallets/{id}/move
  Then response time < 1000ms (bulk update)

Scenario: SSCC generation
  Given GS1 enabled
  When generateSSCC() called
  Then response time < 50ms
```

## Technical Specification

### Database Schema

```sql
-- =============================================================================
-- Pallets Table - Pallet Headers
-- =============================================================================

CREATE TABLE pallets (
  -- Identity
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  pallet_number TEXT NOT NULL,

  -- Type
  pallet_type TEXT DEFAULT 'standard'
    CHECK (pallet_type IN ('eur', 'standard', 'custom', 'other')),

  -- Location
  warehouse_id UUID NOT NULL REFERENCES warehouses(id),
  location_id UUID NOT NULL REFERENCES locations(id),

  -- Status
  status TEXT NOT NULL DEFAULT 'open'
    CHECK (status IN ('open', 'closed', 'shipped')),

  -- GS1
  sscc TEXT, -- 18-digit SSCC-18 code

  -- Metrics
  weight_kg DECIMAL(10,2),
  lp_count INTEGER NOT NULL DEFAULT 0,

  -- Metadata
  notes TEXT,

  -- Audit - Creation
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  created_by UUID REFERENCES users(id),

  -- Audit - Close
  closed_at TIMESTAMPTZ,
  closed_by UUID REFERENCES users(id),

  -- Audit - Ship
  shipped_at TIMESTAMPTZ,
  shipped_by UUID REFERENCES users(id),

  -- Constraints
  CONSTRAINT pallet_org_number_unique UNIQUE(org_id, pallet_number),
  CONSTRAINT pallet_org_sscc_unique UNIQUE(org_id, sscc)
);

-- =============================================================================
-- Pallet Items Table - LP Assignments
-- =============================================================================

CREATE TABLE pallet_items (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  pallet_id UUID NOT NULL REFERENCES pallets(id) ON DELETE CASCADE,
  lp_id UUID NOT NULL REFERENCES license_plates(id),
  added_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  added_by UUID REFERENCES users(id),
  sequence INTEGER, -- Order on pallet

  CONSTRAINT pallet_item_unique UNIQUE(pallet_id, lp_id)
);

-- =============================================================================
-- Pallet Number Sequence per Organization
-- =============================================================================

CREATE TABLE pallet_number_sequences (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE UNIQUE,
  current_value BIGINT NOT NULL DEFAULT 0,
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- =============================================================================
-- SSCC Sequence per Organization
-- =============================================================================

CREATE TABLE sscc_sequences (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE UNIQUE,
  current_value BIGINT NOT NULL DEFAULT 0,
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- =============================================================================
-- Indexes for Performance
-- =============================================================================

CREATE INDEX idx_pallets_org_status ON pallets(org_id, status);
CREATE INDEX idx_pallets_org_warehouse ON pallets(org_id, warehouse_id);
CREATE INDEX idx_pallets_org_location ON pallets(org_id, location_id);
CREATE INDEX idx_pallets_sscc ON pallets(sscc) WHERE sscc IS NOT NULL;
CREATE INDEX idx_pallets_number_search ON pallets(org_id, pallet_number text_pattern_ops);
CREATE INDEX idx_pallets_created ON pallets(created_at);

CREATE INDEX idx_pallet_items_pallet ON pallet_items(pallet_id);
CREATE INDEX idx_pallet_items_lp ON pallet_items(lp_id);

-- =============================================================================
-- Functions: Generate Pallet Number
-- =============================================================================

CREATE OR REPLACE FUNCTION generate_pallet_number(p_org_id UUID)
RETURNS TEXT AS $$
DECLARE
  v_prefix TEXT := 'PLT-';
  v_length INT := 8;
  v_next_val BIGINT;
  v_pallet_number TEXT;
BEGIN
  -- Upsert sequence and get next value
  INSERT INTO pallet_number_sequences (org_id, current_value)
  VALUES (p_org_id, 1)
  ON CONFLICT (org_id)
  DO UPDATE SET
    current_value = pallet_number_sequences.current_value + 1,
    updated_at = NOW()
  RETURNING current_value INTO v_next_val;

  -- Format pallet number
  v_pallet_number := v_prefix || LPAD(v_next_val::TEXT, v_length, '0');

  RETURN v_pallet_number;
END;
$$ LANGUAGE plpgsql;

-- =============================================================================
-- Functions: Generate SSCC-18
-- =============================================================================

CREATE OR REPLACE FUNCTION generate_sscc(p_org_id UUID)
RETURNS TEXT AS $$
DECLARE
  v_company_prefix TEXT;
  v_extension CHAR(1) := '0';
  v_serial BIGINT;
  v_serial_padded TEXT;
  v_sscc_without_check TEXT;
  v_check_digit INT;
  v_sscc TEXT;
BEGIN
  -- Get company prefix from settings
  SELECT gs1_company_prefix INTO v_company_prefix
  FROM warehouse_settings
  WHERE org_id = p_org_id;

  IF v_company_prefix IS NULL THEN
    RAISE EXCEPTION 'GS1 company prefix not configured';
  END IF;

  -- Get next serial
  INSERT INTO sscc_sequences (org_id, current_value)
  VALUES (p_org_id, 1)
  ON CONFLICT (org_id)
  DO UPDATE SET
    current_value = sscc_sequences.current_value + 1,
    updated_at = NOW()
  RETURNING current_value INTO v_serial;

  -- Pad serial to fill remaining digits (17 - extension - company prefix length)
  v_serial_padded := LPAD(v_serial::TEXT, 17 - LENGTH(v_company_prefix), '0');

  -- Build SSCC without check digit
  v_sscc_without_check := v_extension || v_company_prefix || v_serial_padded;

  -- Calculate GS1 check digit (mod 10)
  v_check_digit := calculate_gs1_check_digit(v_sscc_without_check);

  -- Final SSCC-18
  v_sscc := v_sscc_without_check || v_check_digit::TEXT;

  RETURN v_sscc;
END;
$$ LANGUAGE plpgsql;

-- =============================================================================
-- Functions: GS1 Check Digit Calculator
-- =============================================================================

CREATE OR REPLACE FUNCTION calculate_gs1_check_digit(p_digits TEXT)
RETURNS INT AS $$
DECLARE
  v_sum INT := 0;
  v_digit INT;
  v_multiplier INT;
  i INT;
BEGIN
  FOR i IN 1..LENGTH(p_digits) LOOP
    v_digit := CAST(SUBSTRING(p_digits FROM i FOR 1) AS INT);
    -- Odd positions (1,3,5...) multiply by 3, even by 1
    v_multiplier := CASE WHEN i % 2 = 1 THEN 3 ELSE 1 END;
    v_sum := v_sum + (v_digit * v_multiplier);
  END LOOP;

  RETURN (10 - (v_sum % 10)) % 10;
END;
$$ LANGUAGE plpgsql;

-- =============================================================================
-- Trigger: Update pallet LP count and weight
-- =============================================================================

CREATE OR REPLACE FUNCTION update_pallet_metrics()
RETURNS TRIGGER AS $$
DECLARE
  v_pallet_id UUID;
  v_lp_count INT;
  v_weight DECIMAL(10,2);
BEGIN
  -- Determine pallet_id based on operation
  IF TG_OP = 'DELETE' THEN
    v_pallet_id := OLD.pallet_id;
  ELSE
    v_pallet_id := NEW.pallet_id;
  END IF;

  -- Calculate LP count
  SELECT COUNT(*) INTO v_lp_count
  FROM pallet_items
  WHERE pallet_id = v_pallet_id;

  -- Calculate total weight
  SELECT COALESCE(SUM(
    COALESCE(lp.catch_weight_kg, lp.quantity * COALESCE(p.estimated_weight_kg, 0))
  ), 0) INTO v_weight
  FROM pallet_items pi
  JOIN license_plates lp ON lp.id = pi.lp_id
  LEFT JOIN products p ON p.id = lp.product_id
  WHERE pi.pallet_id = v_pallet_id;

  -- Update pallet
  UPDATE pallets SET
    lp_count = v_lp_count,
    weight_kg = v_weight
  WHERE id = v_pallet_id;

  RETURN COALESCE(NEW, OLD);
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER tr_pallet_items_metrics
AFTER INSERT OR DELETE ON pallet_items
FOR EACH ROW EXECUTE FUNCTION update_pallet_metrics();

-- =============================================================================
-- RLS Policies
-- =============================================================================

ALTER TABLE pallets ENABLE ROW LEVEL SECURITY;
ALTER TABLE pallet_items ENABLE ROW LEVEL SECURITY;
ALTER TABLE pallet_number_sequences ENABLE ROW LEVEL SECURITY;
ALTER TABLE sscc_sequences ENABLE ROW LEVEL SECURITY;

-- Pallets: Org isolation
CREATE POLICY "pallets_select_org" ON pallets
FOR SELECT TO authenticated
USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

CREATE POLICY "pallets_insert_org" ON pallets
FOR INSERT TO authenticated
WITH CHECK (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

CREATE POLICY "pallets_update_org" ON pallets
FOR UPDATE TO authenticated
USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()))
WITH CHECK (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

CREATE POLICY "pallets_delete_org" ON pallets
FOR DELETE TO authenticated
USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

-- Pallet items: Via pallet org
CREATE POLICY "pallet_items_select" ON pallet_items
FOR SELECT TO authenticated
USING (
  pallet_id IN (
    SELECT id FROM pallets
    WHERE org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  )
);

CREATE POLICY "pallet_items_insert" ON pallet_items
FOR INSERT TO authenticated
WITH CHECK (
  pallet_id IN (
    SELECT id FROM pallets
    WHERE org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  )
);

CREATE POLICY "pallet_items_delete" ON pallet_items
FOR DELETE TO authenticated
USING (
  pallet_id IN (
    SELECT id FROM pallets
    WHERE org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  )
);

-- Sequences: Org isolation
CREATE POLICY "pallet_seq_org" ON pallet_number_sequences
FOR ALL TO authenticated
USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

CREATE POLICY "sscc_seq_org" ON sscc_sequences
FOR ALL TO authenticated
USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));
```

### API Endpoints

```
# Pallets
GET    /api/warehouse/pallets                    - List pallets (paginated, filtered)
GET    /api/warehouse/pallets/:id                - Get pallet detail with LPs
POST   /api/warehouse/pallets                    - Create pallet
PUT    /api/warehouse/pallets/:id                - Update pallet (notes, type)
DELETE /api/warehouse/pallets/:id                - Delete pallet (if empty)

# Pallet LP Operations
POST   /api/warehouse/pallets/:id/add-lp         - Add LP to pallet
POST   /api/warehouse/pallets/:id/remove-lp      - Remove LP from pallet
POST   /api/warehouse/pallets/:id/add-lps        - Bulk add LPs to pallet

# Pallet Status Operations
POST   /api/warehouse/pallets/:id/close          - Close pallet
POST   /api/warehouse/pallets/:id/reopen         - Reopen pallet (admin)
POST   /api/warehouse/pallets/:id/ship           - Mark pallet as shipped

# Pallet Movement
POST   /api/warehouse/pallets/:id/move           - Move pallet + all LPs

# Pallet Label
POST   /api/warehouse/pallets/:id/print-label    - Print pallet label (ZPL)

# SSCC Generation (utility)
POST   /api/warehouse/pallets/generate-sscc      - Generate next SSCC
```

**Query Parameters (List):**
- `search` - Pallet number or SSCC prefix search
- `warehouse_id` - Filter by warehouse UUID
- `location_id` - Filter by location UUID
- `status` - Filter by status (open, closed, shipped)
- `sort` - Sort field (pallet_number, created_at, lp_count, weight_kg)
- `order` - Sort order (asc, desc)
- `page` - Page number (default 1)
- `limit` - Items per page (default 50, max 100)

### Service Layer

```typescript
// lib/services/pallet-service.ts

export type PalletStatus = 'open' | 'closed' | 'shipped';
export type PalletType = 'eur' | 'standard' | 'custom' | 'other';

export interface Pallet {
  id: string;
  org_id: string;
  pallet_number: string;
  pallet_type: PalletType | null;
  warehouse_id: string;
  location_id: string;
  status: PalletStatus;
  sscc: string | null;
  weight_kg: number | null;
  lp_count: number;
  notes: string | null;
  created_at: string;
  created_by: string | null;
  closed_at: string | null;
  closed_by: string | null;
  shipped_at: string | null;
  shipped_by: string | null;
  // Joined fields
  warehouse?: { name: string; code: string };
  location?: { full_path: string };
  items?: PalletItem[];
}

export interface PalletItem {
  id: string;
  pallet_id: string;
  lp_id: string;
  added_at: string;
  added_by: string | null;
  sequence: number | null;
  // Joined LP fields
  lp?: {
    lp_number: string;
    product_name: string;
    quantity: number;
    uom: string;
    catch_weight_kg: number | null;
    batch_number: string | null;
    expiry_date: string | null;
  };
}

export interface CreatePalletInput {
  pallet_number?: string;
  pallet_type?: PalletType;
  warehouse_id: string;
  location_id: string;
  notes?: string;
}

export interface UpdatePalletInput {
  pallet_type?: PalletType;
  notes?: string;
}

export interface PalletListParams {
  search?: string;
  warehouse_id?: string;
  location_id?: string;
  status?: PalletStatus;
  sort?: 'pallet_number' | 'created_at' | 'lp_count' | 'weight_kg';
  order?: 'asc' | 'desc';
  page?: number;
  limit?: number;
}

export class PalletService {
  // ==========================================================================
  // CRUD Operations
  // ==========================================================================

  /**
   * List pallets with filtering, sorting, pagination
   */
  static async list(params: PalletListParams): Promise<PaginatedResult<Pallet>>;

  /**
   * Get pallet by ID with LP items
   */
  static async getById(id: string): Promise<Pallet | null>;

  /**
   * Create new pallet
   * Auto-generates pallet number if not provided
   * Generates SSCC if GS1 enabled
   */
  static async create(data: CreatePalletInput): Promise<Pallet>;

  /**
   * Update pallet (notes, type only)
   */
  static async update(id: string, data: UpdatePalletInput): Promise<Pallet>;

  /**
   * Delete pallet (only if empty)
   */
  static async delete(id: string): Promise<void>;

  // ==========================================================================
  // LP Operations
  // ==========================================================================

  /**
   * Add LP to pallet
   * Validates: pallet open, LP available, same warehouse
   * Updates LP.pallet_id, recalculates weight
   */
  static async addLP(palletId: string, lpId: string): Promise<Pallet>;

  /**
   * Add multiple LPs to pallet
   */
  static async addLPs(palletId: string, lpIds: string[]): Promise<Pallet>;

  /**
   * Remove LP from pallet
   * Validates: pallet open
   * Clears LP.pallet_id, recalculates weight
   */
  static async removeLP(palletId: string, lpId: string): Promise<Pallet>;

  /**
   * Get LPs on pallet with product details
   */
  static async getPalletItems(palletId: string): Promise<PalletItem[]>;

  // ==========================================================================
  // Status Operations
  // ==========================================================================

  /**
   * Close pallet (no more LP additions)
   * Validates: pallet open, has LPs
   */
  static async close(id: string): Promise<Pallet>;

  /**
   * Reopen pallet (admin only)
   * Validates: pallet closed (not shipped)
   */
  static async reopen(id: string): Promise<Pallet>;

  /**
   * Mark pallet as shipped
   * Called by shipping module
   */
  static async ship(id: string): Promise<Pallet>;

  // ==========================================================================
  // Movement
  // ==========================================================================

  /**
   * Move pallet to new location
   * Updates all LP locations as well
   * Creates stock_move record
   */
  static async move(id: string, locationId: string): Promise<Pallet>;

  // ==========================================================================
  // Label Printing
  // ==========================================================================

  /**
   * Generate ZPL for pallet label
   */
  static async generateLabel(id: string): Promise<string>;

  /**
   * Print pallet label
   */
  static async printLabel(id: string, copies?: number): Promise<void>;

  // ==========================================================================
  // SSCC Generation
  // ==========================================================================

  /**
   * Generate next SSCC-18 for organization
   */
  static async generateSSCC(): Promise<string>;

  /**
   * Validate SSCC-18 format and check digit
   */
  static validateSSCC(sscc: string): boolean;

  // ==========================================================================
  // Utility
  // ==========================================================================

  /**
   * Generate next pallet number
   */
  static async generatePalletNumber(): Promise<string>;

  /**
   * Check if pallet number is available
   */
  static async isPalletNumberAvailable(palletNumber: string): Promise<boolean>;

  /**
   * Calculate pallet weight from LPs
   */
  static async calculateWeight(id: string): Promise<number>;
}
```

### Validation Schema (Zod)

```typescript
// lib/validation/pallet.ts
import { z } from 'zod';

export const palletStatusEnum = z.enum(['open', 'closed', 'shipped']);
export const palletTypeEnum = z.enum(['eur', 'standard', 'custom', 'other']);

export const createPalletSchema = z.object({
  pallet_number: z.string()
    .min(1, "Pallet number is required if manual entry")
    .max(50, "Pallet number max 50 characters")
    .optional(),
  pallet_type: palletTypeEnum.optional().default('standard'),
  warehouse_id: z.string().uuid("Invalid warehouse ID"),
  location_id: z.string().uuid("Invalid location ID"),
  notes: z.string().max(500).nullable().optional(),
});

export const updatePalletSchema = z.object({
  pallet_type: palletTypeEnum.optional(),
  notes: z.string().max(500).nullable().optional(),
});

export const addLPToPalletSchema = z.object({
  lp_id: z.string().uuid("Invalid LP ID"),
});

export const addLPsToPalletSchema = z.object({
  lp_ids: z.array(z.string().uuid()).min(1, "At least one LP required"),
});

export const movePalletSchema = z.object({
  location_id: z.string().uuid("Invalid location ID"),
});

export const printLabelSchema = z.object({
  copies: z.number().int().min(1).max(10).default(1),
});

export const palletQuerySchema = z.object({
  search: z.string().min(1).optional(),
  warehouse_id: z.string().uuid().optional(),
  location_id: z.string().uuid().optional(),
  status: palletStatusEnum.optional(),
  sort: z.enum(['pallet_number', 'created_at', 'lp_count', 'weight_kg']).default('created_at'),
  order: z.enum(['asc', 'desc']).default('desc'),
  page: z.coerce.number().int().positive().default(1),
  limit: z.coerce.number().int().min(1).max(100).default(50),
});

// SSCC validation
export const ssccSchema = z.string()
  .length(18, "SSCC must be 18 digits")
  .regex(/^\d+$/, "SSCC must contain only digits");

export type CreatePalletInput = z.infer<typeof createPalletSchema>;
export type UpdatePalletInput = z.infer<typeof updatePalletSchema>;
export type AddLPInput = z.infer<typeof addLPToPalletSchema>;
export type AddLPsInput = z.infer<typeof addLPsToPalletSchema>;
export type MovePalletInput = z.infer<typeof movePalletSchema>;
export type PalletQueryParams = z.infer<typeof palletQuerySchema>;
```

## UI Components

```
app/(authenticated)/warehouse/
  pallets/
    page.tsx                              -- Pallet list page

components/warehouse/pallets/
  PalletDataTable.tsx                     -- DataTable with sorting, pagination
  PalletFilters.tsx                       -- Filter panel (warehouse, status)
  PalletSearchInput.tsx                   -- Pallet number/SSCC search
  PalletDetailPanel.tsx                   -- Slide-in panel for pallet details
  PalletStatusBadge.tsx                   -- Status badge (open/closed/shipped)
  PalletCreateModal.tsx                   -- Create pallet modal
  PalletLPList.tsx                        -- List of LPs on pallet
  PalletLPSelector.tsx                    -- Dialog to select LPs to add
  PalletActions.tsx                       -- Row actions dropdown
  PalletQuickStats.tsx                    -- LP count, weight display
  PalletLabelPreview.tsx                  -- Label preview component
```

### Badge Colors (TailwindCSS)

| Status | Badge Class |
|--------|-------------|
| open | `bg-green-100 text-green-800` |
| closed | `bg-blue-100 text-blue-800` |
| shipped | `bg-gray-100 text-gray-500` |

### Pallet Label ZPL Template

```zpl
^XA
^FO50,50^BY3
^BCN,120,Y,N,N
^FD{SSCC_OR_PALLET_NUMBER}^FS
^FO50,200^A0N,40,40^FDPallet: {PALLET_NUMBER}^FS
^FO50,250^A0N,30,30^FDLPs: {LP_COUNT}^FS
^FO50,290^A0N,30,30^FDWeight: {WEIGHT_KG} kg^FS
^FO50,330^A0N,30,30^FDPacked: {CREATED_DATE}^FS
^FO50,370^A0N,30,30^FDLocation: {LOCATION}^FS
^FO400,200^BQN,2,4
^FDQA,{QR_DATA}^FS
^XZ
```

## Key Business Rules

1. **Pallet Number Uniqueness**: Pallet number must be unique within organization
2. **SSCC-18 Generation**: Auto-generated if GS1 enabled with valid company prefix
3. **Open Pallet Operations**: Only open pallets can have LPs added/removed
4. **Close Validation**: Cannot close empty pallet
5. **Reopen Restriction**: Only admins can reopen closed pallets, shipped pallets cannot be reopened
6. **Same Warehouse**: LP must be in same warehouse as pallet to be added
7. **LP Availability**: Only available LPs (status='available') can be added to pallet
8. **Single Pallet**: LP can only be on one pallet at a time
9. **Weight Calculation**: Sum of LP catch_weight_kg, fallback to qty * estimated_weight
10. **Pallet Move**: Moving pallet moves all linked LPs to same location

## Deliverables

### Database
- [ ] Migration: `pallets` table
- [ ] Migration: `pallet_items` table
- [ ] Migration: `pallet_number_sequences` table
- [ ] Migration: `sscc_sequences` table
- [ ] Function: `generate_pallet_number(org_id)`
- [ ] Function: `generate_sscc(org_id)`
- [ ] Function: `calculate_gs1_check_digit(digits)`
- [ ] Trigger: `update_pallet_metrics`
- [ ] RLS policies for all tables
- [ ] Performance indexes

### API Routes
- [ ] `GET /api/warehouse/pallets` - List with filters
- [ ] `GET /api/warehouse/pallets/:id` - Get detail with LPs
- [ ] `POST /api/warehouse/pallets` - Create
- [ ] `PUT /api/warehouse/pallets/:id` - Update
- [ ] `DELETE /api/warehouse/pallets/:id` - Delete
- [ ] `POST /api/warehouse/pallets/:id/add-lp` - Add LP
- [ ] `POST /api/warehouse/pallets/:id/remove-lp` - Remove LP
- [ ] `POST /api/warehouse/pallets/:id/close` - Close
- [ ] `POST /api/warehouse/pallets/:id/reopen` - Reopen
- [ ] `POST /api/warehouse/pallets/:id/move` - Move
- [ ] `POST /api/warehouse/pallets/:id/print-label` - Print label

### Service Layer
- [ ] `PalletService.list()`
- [ ] `PalletService.getById()`
- [ ] `PalletService.create()`
- [ ] `PalletService.update()`
- [ ] `PalletService.delete()`
- [ ] `PalletService.addLP()`
- [ ] `PalletService.removeLP()`
- [ ] `PalletService.close()`
- [ ] `PalletService.reopen()`
- [ ] `PalletService.move()`
- [ ] `PalletService.generateSSCC()`
- [ ] `PalletService.generateLabel()`
- [ ] `PalletService.printLabel()`

### Validation
- [ ] `createPalletSchema`
- [ ] `updatePalletSchema`
- [ ] `addLPToPalletSchema`
- [ ] `movePalletSchema`
- [ ] `palletQuerySchema`
- [ ] `ssccSchema`

### Frontend
- [ ] Pallet list page (`/warehouse/pallets`)
- [ ] PalletDataTable with sorting/pagination
- [ ] PalletFilters component
- [ ] PalletSearchInput component
- [ ] PalletDetailPanel component
- [ ] PalletCreateModal component
- [ ] PalletLPList component
- [ ] PalletLPSelector dialog
- [ ] Status badges

### Tests
- [ ] Unit tests: Pallet service methods (>80% coverage)
- [ ] Unit tests: SSCC generation and validation
- [ ] Integration tests: All API endpoints
- [ ] RLS tests: Multi-tenancy isolation
- [ ] E2E: Pallet create, add LP, close, print label

## Test Cases

### Unit Tests

**File:** `__tests__/unit/services/pallet-service.test.ts`

| Test Case | Description |
|-----------|-------------|
| `create()` generates pallet number | Verify sequence increment |
| `create()` generates SSCC when GS1 enabled | Verify SSCC format |
| `create()` blocks when pallets disabled | 400 error returned |
| `addLP()` adds LP to open pallet | pallet_items created |
| `addLP()` blocks if pallet closed | 400 error returned |
| `addLP()` blocks if LP already on pallet | 400 error returned |
| `addLP()` blocks if LP not available | 400 error returned |
| `addLP()` blocks if different warehouse | 400 error returned |
| `removeLP()` removes LP from pallet | pallet_items deleted |
| `removeLP()` blocks if pallet closed | 400 error returned |
| `close()` closes pallet with LPs | status = closed |
| `close()` blocks empty pallet | 400 error returned |
| `reopen()` reopens closed pallet | status = open |
| `reopen()` blocks shipped pallet | 400 error returned |
| `move()` updates pallet and LP locations | All locations updated |
| `generateSSCC()` creates valid 18-digit code | Check digit valid |
| `calculateWeight()` sums LP weights | Correct total |

### Integration Tests

**File:** `__tests__/integration/api/warehouse/pallets.test.ts`

| Test Case | Description |
|-----------|-------------|
| GET `/pallets` returns paginated list | Pagination works |
| GET `/pallets?status=open` filters | Status filter |
| GET `/pallets/:id` returns pallet with LPs | Detail with items |
| POST `/pallets` creates pallet | Pallet created |
| POST `/pallets/:id/add-lp` adds LP | LP added |
| POST `/pallets/:id/remove-lp` removes LP | LP removed |
| POST `/pallets/:id/close` closes pallet | Status changed |
| POST `/pallets/:id/move` moves pallet | Locations updated |
| Cross-org access returns 404 | RLS enforced |
| Response times meet requirements | < 500ms |

### E2E Tests

**File:** `__tests__/e2e/warehouse/pallets.spec.ts`

| Test Case | Description |
|-----------|-------------|
| Create pallet via modal | Modal flow works |
| Add LP to pallet from detail | LP selector works |
| Remove LP from pallet | LP removed from list |
| Close pallet | Status badge updates |
| Print pallet label | Print job queued |
| Move pallet | Location updates |

## Definition of Done

### Database
- [ ] `pallets` table created with all columns
- [ ] `pallet_items` table created
- [ ] Sequence tables created
- [ ] All indexes created for performance
- [ ] RLS policies enforce org isolation
- [ ] SSCC generation function works correctly
- [ ] Pallet metrics trigger works

### API
- [ ] All endpoints return correct HTTP status codes
- [ ] Validation errors return 400 with messages
- [ ] Cross-tenant access returns 404
- [ ] Response times meet requirements:
  - Pallet lookup: < 100ms
  - Pallet list: < 500ms
  - Add LP: < 200ms
  - Move pallet: < 1000ms

### Service
- [ ] SSCC-18 generated with valid check digit
- [ ] Pallet weight calculated correctly
- [ ] LP pallet_id updated on add/remove
- [ ] Close/reopen status transitions work
- [ ] Move updates all LP locations

### Frontend
- [ ] Pallet list page renders DataTable
- [ ] Filters work correctly
- [ ] Detail panel shows LP list
- [ ] Create modal with warehouse/location selection
- [ ] Add LP dialog with search
- [ ] Status badges display correct colors

### Testing
- [ ] Unit tests: >80% coverage on service
- [ ] Integration tests: All endpoints covered
- [ ] RLS tests: Multi-tenancy verified
- [ ] E2E tests: Critical flows passing

## Security Considerations

1. **RLS Enforcement**: All pallet and pallet_items queries filtered by org_id
2. **Role-Based Reopen**: Only ADMIN/SUPER_ADMIN can reopen closed pallets
3. **Audit Trail**: created_by, closed_by, shipped_by tracked
4. **Cross-Warehouse Validation**: Cannot add LP from different warehouse

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-01-15 | Initial story creation | ARCHITECT-AGENT |
