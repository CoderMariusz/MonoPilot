# 04.2a - WO Start (Execution Begin)

| Field | Value |
|-------|-------|
| **Story ID** | 04.2a |
| **Epic** | 04 - Production |
| **Status** | Ready |
| **Phase** | Phase 0 - MVP Core |
| **Complexity** | M (Medium) |
| **Estimate** | 3-4 days |
| **Type** | Full-stack |
| **Priority** | P0 (MVP Core - No LP Dependency) |

---

## PRD References

| FR ID | Requirement | Priority | Covered |
|-------|-------------|----------|---------|
| FR-PROD-002 | WO Start - Transition from Released to In Progress | P0 | YES |
| FR-PROD-016 | Material Reservations | P0 | NO - Story 04.8 (Phase 1) |

**Primary PRD:** `docs/1-BASELINE/product/modules/production.md` (FR-PROD-002)
**Architecture:** `docs/1-BASELINE/architecture/modules/production.md`
**UX Wireframes:** TBD (Production execution screens)

---

## MVP Scope

**Phase 0 - WO Start (This Story):**
- Start WO transition: Released → In Progress
- Timestamp tracking (started_at, started_by)
- Status validation (WO must be Released)
- Line/machine assignment validation
- Material availability check (warning only, NO blocking)
- UI: Start WO button on WO detail page
- Service layer with status validation
- NO material reservations (deferred to Story 04.8, Phase 1)

**What This Story Enables:**
- Production operators can begin work on Released WOs
- System tracks when production started and by whom
- Dashboard shows active WOs (In Progress status)
- Foundation for consumption/output tracking (Phase 1)

---

## LP Dependency Status

- [x] NO LP dependency - can proceed immediately
- [ ] REQUIRES Epic 05 - defer to Phase 1

**Rationale:** This story only updates the `work_orders` table status and timestamps. Material reservations (which require Epic 05 LPs) are deferred to Story 04.8 in Phase 1.

---

## User Story

As a **production operator or manager**, I want to **start a Released Work Order to begin production execution** so that **the system tracks WO execution status, timestamps, and allows me to proceed with material consumption and output registration**.

---

## Dependencies

| Dependency | Story/Epic | Type | Reason |
|------------|------------|------|--------|
| 01.1 | Org Context + Base RLS | HARD | Requires org_id context and RLS patterns |
| 01.11 | Production Lines CRUD | HARD | Line assignment validation |
| 03.10 | Work Orders CRUD | HARD | Requires work_orders table with status field |
| 03.11a | WO Materials | SOFT | Material availability check (warning only) |
| 04.5 | Production Settings | SOFT | Settings validation (if implemented first) |

**Dependents:**
- 04.2b (WO Pause/Resume) - Requires In Progress status
- 04.2c (WO Complete) - Requires In Progress status
- 04.6a (Material Consumption) - Consumes from In Progress WOs
- 04.7a (Output Registration) - Registers output for In Progress WOs

---

## Acceptance Criteria (Gherkin)

### AC-1: Start WO from Released Status (FR-PROD-002)

```gherkin
Scenario: Start WO with Released status
  Given WO "WO-001" has status "Released"
  When user clicks "Start Production"
  Then WO status changes to "In Progress" within 1 second
  And started_at timestamp is set to current time (+/- 1 second)
  And started_by is set to current user's ID
  And success toast "Work Order WO-001 started successfully" displays

Scenario: Start button only visible for Released WOs
  Given WO "WO-002" has status "Released"
  When user views WO detail page
  Then "Start Production" button is visible and enabled

Scenario: Start button disabled for non-Released WOs
  Given WO "WO-003" has status "Draft"
  When user views WO detail page
  Then "Start Production" button is disabled or hidden
  And tooltip "WO must be Released to start" displays on hover
```

### AC-2: Status Validation (FR-PROD-002)

```gherkin
Scenario: Cannot start Draft WO
  Given WO "WO-004" has status "Draft"
  When user attempts to start WO
  Then error message "WO must be Released to start" displays
  And WO status remains "Draft"

Scenario: Cannot start already In Progress WO
  Given WO "WO-005" has status "In Progress"
  When user attempts to start WO
  Then "Start Production" button is disabled
  And status remains "In Progress"

Scenario: Cannot start Completed WO
  Given WO "WO-006" has status "Completed"
  When user attempts to start WO
  Then "Start Production" button is disabled
  And status remains "Completed"

Scenario: Cannot start Cancelled WO
  Given WO "WO-007" has status "Cancelled"
  When user attempts to start WO
  Then "Start Production" button is disabled
  And status remains "Cancelled"
```

### AC-3: Line/Machine Assignment (FR-PROD-002)

```gherkin
Scenario: Confirm line assignment on start
  Given WO "WO-008" has line assigned to "Line A"
  When user clicks "Start Production"
  Then confirmation modal displays "Start WO-008 on Line A?"
  And user confirms
  And WO starts successfully

Scenario: Optional machine assignment
  Given WO "WO-009" has no machine assigned
  When user clicks "Start Production"
  Then machine field is optional (can leave blank)
  And WO starts successfully without machine assignment

Scenario: Production line already in use (validation)
  Given production line "Line B" is running WO "WO-010" (status In Progress)
  When user attempts to start WO "WO-011" with line "Line B"
  Then warning message "Line B already in use by WO-010. Continue?" displays
  And user can proceed anyway (warning only, not blocking)
```

### AC-4: Material Availability Check (FR-PROD-002)

```gherkin
Scenario: Material availability 100% (no warning)
  Given WO "WO-012" has material availability = 100%
  When user clicks "Start Production"
  Then no warning message displays
  And WO starts successfully

Scenario: Material availability < 100% (warning only)
  Given WO "WO-013" has material availability = 80%
  When user clicks "Start Production"
  Then warning message "Material availability is 80%. Continue?" displays
  And user confirms
  And WO starts successfully (warning does NOT block start)

Scenario: Material availability 0% (warning only)
  Given WO "WO-014" has material availability = 0%
  When user clicks "Start Production"
  Then warning message "No materials available. Continue?" displays
  And user can still start WO if confirmed
```

### AC-5: Material Reservations - Phase 1 Deferred (FR-PROD-016)

```gherkin
Scenario: NO material reservations created in Phase 0
  Given WO "WO-015" has status "Released"
  When user starts WO
  Then WO status changes to "In Progress"
  And NO records are created in material_reservations table
  And started_at is set

# NOTE: Material reservations will be implemented in Story 04.8 (Phase 1)
# after Epic 05 License Plates table exists
```

### AC-6: Timestamp Tracking (FR-PROD-002)

```gherkin
Scenario: started_at timestamp set on start
  Given WO "WO-016" has status "Released"
  And current time is 2025-01-15 10:30:00
  When user starts WO
  Then started_at is set to 2025-01-15 10:30:00 (+/- 1 second)

Scenario: started_by user tracking
  Given user "operator-123" starts WO "WO-017"
  When WO starts
  Then started_by field is set to "operator-123" user ID

Scenario: Updated_at timestamp also updated
  Given WO "WO-018" starts
  When status changes to "In Progress"
  Then updated_at timestamp is set to current time
  And updated_by is set to current user's ID
```

### AC-7: UI - Start WO Modal (FR-PROD-002)

```gherkin
Scenario: Start WO modal displays summary
  Given WO "WO-019" status is "Released"
  When user clicks "Start Production"
  Then modal displays:
    | Field | Value |
    | WO Number | WO-019 |
    | Product | Product Name |
    | Planned Qty | 1000 units |
    | Line | Line A |
    | Material Availability | 95% |
  And "Confirm Start" button is enabled

Scenario: Start modal shows material list
  Given WO "WO-020" has 3 required materials
  When start modal opens
  Then material list displays all 3 materials with:
    - Material name
    - Required qty
    - Available qty
    - Availability %
```

### AC-8: Permission Enforcement

```gherkin
Scenario: Production Operator can start WO
  Given user has PROD_OPERATOR role
  When viewing WO with status "Released"
  Then "Start Production" button is visible

Scenario: Production Manager can start WO
  Given user has PROD_MANAGER role
  When viewing WO with status "Released"
  Then "Start Production" button is visible

Scenario: Viewer cannot start WO
  Given user has VIEWER role
  When viewing WO with status "Released"
  Then "Start Production" button is hidden

Scenario: Admin can start WO
  Given user has ADMIN role
  When viewing WO with status "Released"
  Then "Start Production" button is visible
```

### AC-9: Multi-tenancy (RLS)

```gherkin
Scenario: Org isolation on start
  Given User A from Org A
  And WO "WO-021" belongs to Org A
  When User A starts WO "WO-021"
  Then WO starts successfully

Scenario: Cross-tenant start attempt returns 404
  Given User A from Org A
  And WO "WO-022" belongs to Org B
  When User A attempts to start WO "WO-022"
  Then 404 Not Found returned (not 403)
  And WO status unchanged
```

### AC-10: API Response and Error Handling

```gherkin
Scenario: Successful start returns updated WO
  Given WO "WO-023" status is "Released"
  When POST /api/production/work-orders/WO-023/start
  Then response status is 200
  And response body contains:
    | Field | Value |
    | id | WO-023 UUID |
    | status | in_progress |
    | started_at | ISO timestamp |
    | started_by | User UUID |

Scenario: Start invalid WO returns 400
  Given WO "WO-024" status is "Draft"
  When POST /api/production/work-orders/WO-024/start
  Then response status is 400
  And error message "WO must be Released to start" returned

Scenario: Start non-existent WO returns 404
  Given WO "WO-999" does not exist
  When POST /api/production/work-orders/WO-999/start
  Then response status is 404
  And error message "Work Order not found" returned
```

---

## Technical Specification

### Database Schema

**Existing `work_orders` Table (from Epic 03.10):**

```sql
-- This story UPDATES existing work_orders table fields:
-- No new table creation required

-- Fields used/updated:
-- status (updated to 'in_progress')
-- started_at (set to NOW())
-- started_by (set to auth.uid())
-- updated_at (set to NOW())
-- updated_by (set to auth.uid())

-- Status enum values:
-- 'draft', 'released', 'in_progress', 'paused', 'completed', 'cancelled'
```

**No New Tables Required for Phase 0.**

Phase 1 will add:
- `material_reservations` table (Story 04.8)

---

### API Endpoints

```typescript
// Start WO
POST /api/production/work-orders/:id/start

// Request Body (optional):
{
  line_id?: string;          // Override line assignment
  machine_id?: string;       // Override machine assignment
  force?: boolean;           // Bypass line availability check
}

// Response (200 OK):
{
  id: string;
  wo_number: string;
  status: 'in_progress';
  started_at: string;        // ISO timestamp
  started_by: string;        // User UUID
  production_line_id: string;
  machine_id?: string;
  // ... other WO fields
}

// Error Responses:
// 400 Bad Request - Invalid status transition
{
  error: 'WO must be Released to start',
  current_status: 'draft'
}

// 404 Not Found - WO doesn't exist or cross-tenant
{
  error: 'Work Order not found'
}

// 409 Conflict - Line already in use (optional enforcement)
{
  error: 'Line already in use by WO-XXX',
  warning: true               // Can be bypassed with force=true
}
```

**Helper Endpoints:**

```typescript
// Check material availability for WO
GET /api/production/work-orders/:id/material-availability

// Response:
{
  wo_id: string;
  overall_availability_percent: number;
  materials: [
    {
      wo_material_id: string;
      product_id: string;
      product_name: string;
      required_qty: number;
      available_qty: number;
      availability_percent: number;
      uom: string;
    }
  ]
}
```

---

### Service Layer

```typescript
// lib/services/production-execution-service.ts

export interface ProductionExecutionService {
  startWorkOrder(
    woId: string,
    options?: StartWorkOrderOptions
  ): Promise<WorkOrder>;

  canStartWorkOrder(woId: string): Promise<ValidationResult>;

  checkMaterialAvailability(woId: string): Promise<MaterialAvailability>;

  checkLineAvailability(lineId: string): Promise<{
    available: boolean;
    current_wo?: string;
  }>;
}

export interface StartWorkOrderOptions {
  line_id?: string;
  machine_id?: string;
  force?: boolean;        // Bypass line availability check
}

export interface ValidationResult {
  allowed: boolean;
  reason?: string;
  warnings?: string[];
}

export interface MaterialAvailability {
  overall_percent: number;
  materials: {
    wo_material_id: string;
    product_id: string;
    product_name: string;
    required_qty: number;
    available_qty: number;
    availability_percent: number;
    uom: string;
  }[];
}

// Implementation methods:
export async function startWorkOrder(
  woId: string,
  options: StartWorkOrderOptions = {}
): Promise<WorkOrder> {
  // 1. Validate WO exists and belongs to org
  const wo = await getWorkOrderById(woId);
  if (!wo) throw new NotFoundError('Work Order not found');

  // 2. Validate status is 'released'
  if (wo.status !== 'released') {
    throw new BadRequestError(`WO must be Released to start. Current status: ${wo.status}`);
  }

  // 3. Check line availability (warning only unless force=false)
  if (options.line_id && !options.force) {
    const lineCheck = await checkLineAvailability(options.line_id);
    if (!lineCheck.available) {
      // Return warning, don't throw error
      // Frontend will show confirmation dialog
    }
  }

  // 4. Update WO status and timestamps
  const updated = await supabase
    .from('work_orders')
    .update({
      status: 'in_progress',
      started_at: new Date().toISOString(),
      started_by: userId,
      production_line_id: options.line_id || wo.production_line_id,
      machine_id: options.machine_id || wo.machine_id,
      updated_at: new Date().toISOString(),
      updated_by: userId,
    })
    .eq('id', woId)
    .select()
    .single();

  // 5. NO material reservations in Phase 0
  // (Story 04.8 will add this)

  return updated;
}

export async function canStartWorkOrder(woId: string): Promise<ValidationResult> {
  const wo = await getWorkOrderById(woId);

  if (!wo) {
    return { allowed: false, reason: 'Work Order not found' };
  }

  if (wo.status !== 'released') {
    return {
      allowed: false,
      reason: `WO must be Released to start. Current status: ${wo.status}`
    };
  }

  // Check material availability (warning only)
  const matAvail = await checkMaterialAvailability(woId);
  const warnings: string[] = [];

  if (matAvail.overall_percent < 100) {
    warnings.push(`Material availability is ${matAvail.overall_percent}%`);
  }

  return { allowed: true, warnings };
}

export async function checkMaterialAvailability(
  woId: string
): Promise<MaterialAvailability> {
  // Query wo_materials for this WO
  const materials = await supabase
    .from('wo_materials')
    .select(`
      id,
      product_id,
      required_qty,
      uom,
      products:product_id (
        name
      )
    `)
    .eq('wo_id', woId);

  // For Phase 0 (no LPs), return mock 100% availability
  // Story 04.6a will implement real LP-based availability check

  const materialResults = materials.map(m => ({
    wo_material_id: m.id,
    product_id: m.product_id,
    product_name: m.products.name,
    required_qty: m.required_qty,
    available_qty: m.required_qty, // Mock: assume available
    availability_percent: 100,      // Mock
    uom: m.uom,
  }));

  return {
    overall_percent: 100,
    materials: materialResults,
  };
}

export async function checkLineAvailability(
  lineId: string
): Promise<{ available: boolean; current_wo?: string }> {
  // Check if line has any active WOs (status = 'in_progress')
  const activeWO = await supabase
    .from('work_orders')
    .select('wo_number')
    .eq('production_line_id', lineId)
    .eq('status', 'in_progress')
    .single();

  if (activeWO) {
    return {
      available: false,
      current_wo: activeWO.wo_number
    };
  }

  return { available: true };
}
```

---

### Validation Schema (Zod)

```typescript
// lib/validation/production-execution.ts
import { z } from 'zod';

export const startWorkOrderSchema = z.object({
  line_id: z.string().uuid().optional(),
  machine_id: z.string().uuid().optional(),
  force: z.boolean().optional().default(false),
});

export type StartWorkOrderInput = z.infer<typeof startWorkOrderSchema>;

// Status validation
export const woStatusEnum = z.enum([
  'draft',
  'released',
  'in_progress',
  'paused',
  'completed',
  'cancelled'
]);
```

---

## UI Components

```
app/(authenticated)/production/work-orders/[id]/
  page.tsx                          -- WO detail page with Start button

components/production/work-orders/
  WorkOrderHeader.tsx               -- WO summary with status badge
  WorkOrderActions.tsx              -- Action buttons (Start, Pause, Complete)
  StartWorkOrderButton.tsx          -- Start button with permission check
  StartWorkOrderModal.tsx           -- Confirmation modal with summary
  MaterialAvailabilityCard.tsx      -- Material list with availability %
  LineAvailabilityWarning.tsx       -- Warning if line in use
  WorkOrderStatusBadge.tsx          -- Status badge with colors

components/production/common/
  ProductionToast.tsx               -- Success/error notifications
```

### UI Flow

1. **WO Detail Page** (`/production/work-orders/:id`):
   - Displays WO summary (number, product, qty, line, status)
   - Shows "Start Production" button if status = Released
   - Button disabled/hidden for other statuses

2. **Start Button Click**:
   - Fetch material availability
   - Fetch line availability
   - Open StartWorkOrderModal

3. **Start WO Modal**:
   - Display WO summary
   - Show material list with availability %
   - Warning banner if material < 100%
   - Warning banner if line already in use
   - Confirm/Cancel buttons

4. **Confirm Start**:
   - POST /api/production/work-orders/:id/start
   - Show loading spinner
   - On success: Toast notification, redirect to WO detail
   - On error: Show error message in modal

---

### Badge Colors (TailwindCSS)

| Status | Badge Class |
|--------|-------------|
| Draft | `bg-gray-100 text-gray-800` |
| Released | `bg-blue-100 text-blue-800` |
| In Progress | `bg-green-100 text-green-800` |
| Paused | `bg-yellow-100 text-yellow-800` |
| Completed | `bg-purple-100 text-purple-800` |
| Cancelled | `bg-red-100 text-red-800` |

---

## Key Business Rules

1. **Status Validation**: Only WOs with status 'Released' can be started
2. **Timestamp Tracking**: started_at and started_by must be set atomically with status change
3. **Line Availability**: Line in use check is a WARNING only, not blocking (operator can override)
4. **Material Availability**: Material shortage is a WARNING only, does NOT block start
5. **Multi-tenancy**: All operations enforce org_id isolation via RLS
6. **Audit Trail**: updated_at and updated_by must be updated on every status change
7. **No Material Reservations**: Phase 0 does NOT create material reservations (deferred to Story 04.8)
8. **Idempotency**: Starting an already In Progress WO should return current state, not error

---

## Out of Scope (This Story)

| Feature | Reason | Future Story |
|---------|--------|--------------|
| Material Reservations | Requires Epic 05 LPs | Story 04.8 (Phase 1) |
| Operation Auto-Start | Depends on operation tracking | Story 04.3 |
| WO Pause/Resume | Separate lifecycle state | Story 04.2b |
| WO Complete | Separate lifecycle state | Story 04.2c |
| Material Consumption | Requires LPs | Story 04.6a (Phase 1) |
| Output Registration | Requires LPs | Story 04.7a (Phase 1) |
| OEE Tracking | Phase 2 feature | Story 04.9a |
| Auto-complete on full output | Depends on output registration | Story 04.2c + 04.7a |
| Scanner workflow | Mobile interface | Story 04.6b (Phase 1) |

---

## Test Cases

### Unit Tests

**File:** `__tests__/unit/services/production-execution-service.test.ts`

| Test Case | Description |
|-----------|-------------|
| `startWorkOrder()` updates status to in_progress | Verify status change |
| `startWorkOrder()` sets started_at timestamp | Within 1 second of now |
| `startWorkOrder()` sets started_by to current user | Audit tracking |
| `startWorkOrder()` rejects Draft WO | Throws BadRequestError |
| `startWorkOrder()` rejects In Progress WO | Idempotent or reject |
| `startWorkOrder()` rejects Completed WO | Cannot restart completed WO |
| `canStartWorkOrder()` returns false for Draft | Validation helper |
| `canStartWorkOrder()` returns warnings for low material | Warning included |
| `checkLineAvailability()` detects active WO | Returns current_wo |
| `checkLineAvailability()` returns available for idle line | No active WO |

### Integration Tests

**File:** `__tests__/integration/api/production/work-orders-start.test.ts`

| Test Case | Description |
|-----------|-------------|
| POST `/work-orders/:id/start` returns 200 | Success case |
| POST `/work-orders/:id/start` sets timestamps | started_at, updated_at |
| POST `/work-orders/:id/start` Draft WO returns 400 | Invalid status |
| POST `/work-orders/:id/start` non-existent WO returns 404 | Not found |
| Cross-org start attempt returns 404 | Multi-tenancy enforced |
| Permission denied returns 403 | Viewer cannot start |
| Line in use returns 409 (optional) | Conflict warning |
| GET `/work-orders/:id/material-availability` returns data | Helper endpoint |

### E2E Tests

**File:** `__tests__/e2e/production/work-order-start.spec.ts`

| Test Case | Description |
|-----------|-------------|
| Start WO flow | Detail page > Start button > Confirm > Success |
| Start button visibility | Only visible for Released status |
| Start button disabled for Draft | Button disabled or hidden |
| Material availability warning | Warning banner if < 100% |
| Line in use warning | Warning banner if line active |
| Success toast notification | "WO started successfully" |
| Status badge updates | Released → In Progress |
| Permission-based UI | Viewer sees no Start button |

---

## Definition of Done

- [ ] API endpoint `POST /api/production/work-orders/:id/start` implemented
- [ ] Helper endpoint `GET /api/production/work-orders/:id/material-availability` implemented
- [ ] `production-execution-service.ts` implements startWorkOrder() method
- [ ] `production-execution-service.ts` implements canStartWorkOrder() method
- [ ] `production-execution-service.ts` implements checkMaterialAvailability() method
- [ ] `production-execution-service.ts` implements checkLineAvailability() method
- [ ] Zod schema validates start request (line_id, machine_id, force)
- [ ] Status validation: only Released WOs can be started
- [ ] Timestamp tracking: started_at and started_by set on start
- [ ] Audit fields: updated_at and updated_by updated
- [ ] Material availability check returns mock data (Phase 0)
- [ ] Line availability check warns if line in use
- [ ] NO material reservations created (deferred to Story 04.8)
- [ ] WO detail page shows "Start Production" button
- [ ] Start button only visible for Released status
- [ ] Start button disabled/hidden for other statuses
- [ ] StartWorkOrderModal component with WO summary
- [ ] Material availability list in modal
- [ ] Line availability warning in modal
- [ ] Success toast notification on start
- [ ] Error handling with user-friendly messages
- [ ] Permission enforcement: Prod Operator, Manager, Admin can start
- [ ] Multi-tenancy: RLS enforces org isolation (cross-org returns 404)
- [ ] Unit tests >= 80% coverage
- [ ] Integration tests for all endpoints
- [ ] E2E test for start WO flow
- [ ] Loading states implemented (button spinner)
- [ ] Empty/error states handled
- [ ] Accessibility: keyboard nav, ARIA labels, screen reader support

---

## Future Phases (Not in This Story)

### Phase 1 (After Epic 05)
- **Material Reservations on Start** (Story 04.8) - Create material_reservations records when WO starts, allocating specific LPs to the WO
- **Real Material Availability** (Story 04.6a) - Replace mock availability check with actual LP-based inventory queries
- **Material Consumption** (Story 04.6a) - Consume reserved LPs during production
- **Output Registration** (Story 04.7a) - Create output LPs and link genealogy

### Phase 2 (OEE)
- **OEE Tracking on Start** (Story 04.9a) - Initialize OEE record when WO starts
- **Downtime Tracking** (Story 04.9b) - Track downtime events during WO execution
- **Shift Integration** (Story 04.9d) - Associate WO start with current shift

### Phase 3 (Advanced)
- **Auto-Start Next WO** - Queue management, auto-start next WO when line becomes available
- **Batch Start** - Start multiple WOs simultaneously
- **IoT Integration** - Machine sensors trigger WO start automatically
- **Offline Mode** - Queue start requests when offline, sync when online

**Implementation:** See Epic 04.0 "Future Feature Handling" section.

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-12-16 | Initial story creation | ARCHITECT-AGENT |
