# 04.8 - Material Reservations

**Story ID:** 04.8
**Epic:** 04 - Production
**Phase:** 1B (MVP)
**Complexity:** L (Large)
**Estimate:** 4 days
**Type:** Full-stack
**State:** ready

**Primary PRD:** `docs/1-BASELINE/product/modules/PRODUCTION.md` (FR-PROD-016)
**Wireframes:** WH-RES-001, WH-RES-002, WH-RES-003, PLAN-026

## PRD References

| FR ID | Requirement | Priority | Phase | Covered |
|-------|-------------|----------|-------|---------|
| FR-PROD-016 | Material Reservations | P0 | MVP | Yes |

## User Story

**As a** production planner,
**I want** to reserve specific License Plates for Work Order materials,
**So that** I can prevent allocation conflicts and ensure materials are available when production starts.

**As a** production supervisor,
**I want** to view and manage material reservations for Work Orders,
**So that** I can monitor material coverage and release unused reservations when needed.

## Goal

Implement a material reservation system that links License Plates (LPs) to Work Order materials with quantity tracking. The system supports FIFO/FEFO pick suggestions, manual LP selection, soft reservations (multiple WOs can reserve same LP with warning), partial allocation, and auto-release on WO completion or cancellation.

## Scope

**In scope:**
- FIFO/FEFO LP suggestions based on warehouse settings
- Reserve specific LPs for WO materials with quantity tracking
- Reservation status badges (Full/Partial/None/Over coverage)
- Manual release of reservations by supervisor/admin
- Auto-release on WO completion or cancellation
- Over-reservation warning with acknowledgment
- Soft reservations (same LP visible to multiple WOs)
- Filter available LPs by location, lot number
- Multi-LP selection for single material
- Real-time available quantity calculation

**Out of scope:**
- Hard reservations (blocking LP from other WOs)
- Auto-reserve on WO creation (manual trigger only)
- Barcode scanner workflow for reservations
- Reservation transfer between WOs
- Reservation expiry/timeout

## Dependencies

| Story | Requirement | Status |
|-------|-------------|--------|
| 05.1 | License Plates table and service | Required |
| 05.3 | LP reservations infrastructure | Required |
| 03.11a | wo_materials table with required_qty | Required |
| 04.5 | enable_material_reservations setting | Required |
| 04.2a | WO start workflow integration | Required |

**Blocks:**
- 04.2c (WO completion releases unused reservations)

## Acceptance Criteria (Given/When/Then)

### Reservation Creation

#### LP Availability Query
- GIVEN WO requires Material A = 100 kg AND LP-001 has 150 kg available, WHEN user views available LPs, THEN LP-001 displays with available_qty = 150 kg.
- GIVEN warehouse default_pick_algorithm = FIFO, WHEN available LPs queried, THEN LPs sorted by created_at ASC (oldest first).
- GIVEN warehouse default_pick_algorithm = FEFO, WHEN available LPs queried, THEN LPs sorted by expiry_date ASC (earliest expiry first, NULL last).
- GIVEN LP has status = 'blocked' OR qa_status != 'passed', WHEN available LPs queried, THEN LP excluded from results.
- GIVEN LP has expiry_date < today, WHEN available LPs queried, THEN expired LP excluded from results.
- GIVEN LP-001 has 50 kg reserved by WO-001, WHEN WO-002 queries available LPs, THEN LP-001 shows available_qty = (total - reserved) with "Reserved by WO-001: 50 kg" warning.

#### Create Reservation
- GIVEN WO requires Material A = 100 kg AND LP-001 has 150 kg available, WHEN user reserves LP-001 for 100 kg, THEN reservation created with reserved_qty = 100, status = 'active'.
- GIVEN LP-001 has 50 kg AND LP-002 has 60 kg, WHEN WO requires 100 kg AND user selects both LPs, THEN reservations created totaling 110 kg.
- GIVEN total reservation qty > required_qty AND acknowledge_over_reservation = false, WHEN user submits, THEN error "Total reserved exceeds required. Set acknowledge to continue" displays.
- GIVEN total reservation qty > required_qty AND acknowledge_over_reservation = true, WHEN user submits, THEN reservations created successfully with over-reservation warning logged.
- GIVEN reservation created, WHEN stored, THEN reserved_by = current user, reserved_at = now().
- GIVEN WO status = 'completed', WHEN user attempts to reserve, THEN error "Cannot reserve for completed WO" displays.
- GIVEN WO status = 'cancelled', WHEN user attempts to reserve, THEN error "Cannot reserve for cancelled WO" displays.

### Reservation Status Tracking

#### Reservation Status Badge
- GIVEN required_qty = 100 AND reserved_qty = 100, WHEN status badge rendered, THEN green badge "Full 100%" displays.
- GIVEN required_qty = 100 AND reserved_qty = 80, WHEN status badge rendered, THEN yellow badge "Partial 80%" displays with tooltip "20 kg short".
- GIVEN required_qty = 100 AND reserved_qty = 0, WHEN status badge rendered, THEN gray badge "None 0%" displays.
- GIVEN required_qty = 100 AND reserved_qty = 120, WHEN status badge rendered, THEN blue badge "Over 120%" displays with tooltip "20 kg excess".

#### Remaining Quantity Calculation
- GIVEN reservation with reserved_qty = 100 AND consumed_qty = 40, WHEN remaining calculated, THEN remaining_qty = 60.
- GIVEN multiple reservations for same material, WHEN totals calculated, THEN sum of all remaining_qty displayed.

### Reservation Release

#### Manual Release
- GIVEN active reservation exists, WHEN supervisor clicks "Release", THEN confirmation dialog appears.
- GIVEN user confirms release, WHEN release processed, THEN reservation.status = 'released', released_at = now(), released_by = user.
- GIVEN reservation released, WHEN LP availability queried, THEN released qty returns to available pool.
- GIVEN user with role 'operator', WHEN attempting to release reservation, THEN 403 "Only supervisor or admin can release" returns.
- GIVEN reservation already released, WHEN user attempts release again, THEN error "Reservation already released" displays.
- GIVEN reservation with consumed_qty = reserved_qty (fully consumed), WHEN user attempts release, THEN error "Cannot release fully consumed reservation" displays.

#### Auto-Release
- GIVEN WO with 3 active reservations totaling 50 kg unused, WHEN WO status changes to 'completed', THEN all active reservations released automatically.
- GIVEN WO status changes to 'cancelled', WHEN auto-release triggered, THEN all active reservations released.
- GIVEN reservation with consumed_qty = 40 of reserved_qty = 100, WHEN WO completes, THEN remaining 60 kg released back to LP.

### Soft Reservations

#### Multiple WO Reservations
- GIVEN LP-001 reserved by WO-001 for 50 kg, WHEN WO-002 reserves same LP for 40 kg, THEN both reservations created (soft reservation).
- GIVEN LP-001 has total_qty = 100, WO-001 reserved 50, WO-002 reserved 40, WHEN WO-003 queries, THEN available_qty = 10 with warnings about other reservations.
- GIVEN LP-001 available_qty = 10 AND WO-003 requests 20 kg, WHEN reservation attempted, THEN error "Insufficient quantity: LP has 10 available" displays.

### Multi-tenancy

- GIVEN User A from Org A, WHEN querying reservations, THEN only Org A reservations returned.
- GIVEN User A from Org A, WHEN attempting to release Org B reservation, THEN 404 "Not found" returns (not 403).

## Technical Specification

### Database Schema

#### material_reservations table

```sql
CREATE TABLE material_reservations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  wo_id UUID NOT NULL REFERENCES work_orders(id) ON DELETE CASCADE,
  wo_material_id UUID NOT NULL REFERENCES wo_materials(id) ON DELETE CASCADE,
  lp_id UUID NOT NULL REFERENCES license_plates(id) ON DELETE CASCADE,

  -- Quantity tracking
  reserved_qty NUMERIC NOT NULL CHECK (reserved_qty > 0),
  consumed_qty NUMERIC DEFAULT 0 CHECK (consumed_qty >= 0),
  status TEXT DEFAULT 'active' CHECK (status IN ('active', 'released', 'consumed')),

  -- Reservation tracking
  reserved_at TIMESTAMPTZ DEFAULT NOW(),
  reserved_by UUID NOT NULL REFERENCES auth.users(id),

  -- Release tracking
  released_at TIMESTAMPTZ,
  released_by UUID REFERENCES auth.users(id),

  -- Timestamps
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ
);

-- Indexes for performance
CREATE INDEX idx_material_reservations_wo ON material_reservations(wo_id);
CREATE INDEX idx_material_reservations_lp ON material_reservations(lp_id);
CREATE INDEX idx_material_reservations_status ON material_reservations(status);
CREATE INDEX idx_material_reservations_wo_material ON material_reservations(wo_material_id);
CREATE INDEX idx_material_reservations_org ON material_reservations(org_id);
CREATE INDEX idx_material_reservations_active ON material_reservations(lp_id) WHERE status = 'active';
```

#### RPC Functions

```sql
-- Get available LPs for a material with FIFO/FEFO sorting
CREATE OR REPLACE FUNCTION get_available_lps_for_material(
  p_org_id UUID,
  p_product_id UUID,
  p_warehouse_id UUID,
  p_sort TEXT DEFAULT 'fifo'
)
RETURNS TABLE(
  lp_id UUID,
  lp_number TEXT,
  lot_number TEXT,
  expiry_date DATE,
  location TEXT,
  total_qty NUMERIC,
  reserved_qty NUMERIC,
  available_qty NUMERIC,
  created_at TIMESTAMPTZ
) AS $$
BEGIN
  RETURN QUERY
  SELECT
    lp.id AS lp_id,
    lp.lp_number,
    lp.lot_number,
    lp.expiry_date,
    lp.location_name AS location,
    lp.quantity AS total_qty,
    COALESCE(SUM(mr.reserved_qty - mr.consumed_qty) FILTER (WHERE mr.status = 'active'), 0) AS reserved_qty,
    lp.quantity - COALESCE(SUM(mr.reserved_qty - mr.consumed_qty) FILTER (WHERE mr.status = 'active'), 0) AS available_qty,
    lp.created_at
  FROM license_plates lp
  LEFT JOIN material_reservations mr ON lp.id = mr.lp_id
  WHERE lp.org_id = p_org_id
    AND lp.product_id = p_product_id
    AND lp.warehouse_id = p_warehouse_id
    AND lp.status = 'available'
    AND lp.qa_status = 'passed'
    AND (lp.expiry_date IS NULL OR lp.expiry_date >= CURRENT_DATE)
  GROUP BY lp.id
  HAVING lp.quantity - COALESCE(SUM(mr.reserved_qty - mr.consumed_qty) FILTER (WHERE mr.status = 'active'), 0) > 0
  ORDER BY
    CASE WHEN p_sort = 'fifo' THEN lp.created_at END ASC,
    CASE WHEN p_sort = 'fifo' THEN lp.expiry_date END ASC NULLS LAST,
    CASE WHEN p_sort = 'fefo' THEN lp.expiry_date END ASC NULLS LAST,
    CASE WHEN p_sort = 'fefo' THEN lp.created_at END ASC;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Release all active reservations for a WO
CREATE OR REPLACE FUNCTION release_wo_reservations(
  p_wo_id UUID,
  p_user_id UUID
)
RETURNS INTEGER AS $$
DECLARE
  v_count INTEGER;
BEGIN
  UPDATE material_reservations
  SET status = 'released',
      released_at = NOW(),
      released_by = p_user_id,
      updated_at = NOW()
  WHERE wo_id = p_wo_id
    AND status = 'active';

  GET DIAGNOSTICS v_count = ROW_COUNT;
  RETURN v_count;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

### RLS Policies

```sql
ALTER TABLE material_reservations ENABLE ROW LEVEL SECURITY;

-- SELECT: Users can view reservations in their org
CREATE POLICY "material_reservations_select" ON material_reservations
FOR SELECT USING (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
);

-- INSERT: Users can create reservations in their org
CREATE POLICY "material_reservations_insert" ON material_reservations
FOR INSERT WITH CHECK (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
);

-- UPDATE: Users can update reservations in their org
CREATE POLICY "material_reservations_update" ON material_reservations
FOR UPDATE USING (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
);

-- DELETE: Users can delete reservations in their org
CREATE POLICY "material_reservations_delete" ON material_reservations
FOR DELETE USING (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
);
```

### API Endpoints

```
# Available LPs Query
GET    /api/planning/work-orders/:id/materials/:materialId/available-lps
       Query: sort=fifo|fefo, lot_number, location

# Reservation Management
POST   /api/planning/work-orders/:id/materials/:materialId/reservations
       Body: { reservations: [{lp_id, quantity}], acknowledge_over_reservation }

GET    /api/production/work-orders/:id/reservations
       Query: status=active|released|consumed|all, material_id

DELETE /api/production/work-orders/:id/reservations/:resId
```

### Service Methods

**Location:** `lib/services/material-reservation-service.ts`

```typescript
interface MaterialReservationService {
  // Query available LPs
  getAvailableLPs(
    woId: string,
    materialId: string,
    sort: 'fifo' | 'fefo',
    filters?: { lotNumber?: string; location?: string }
  ): Promise<AvailableLP[]>;

  // Reservation CRUD
  createReservations(
    woId: string,
    materialId: string,
    reservations: { lpId: string; quantity: number }[],
    acknowledgeOver?: boolean
  ): Promise<Reservation[]>;

  getWOReservations(
    woId: string,
    filters?: { status?: string; materialId?: string }
  ): Promise<ReservationWithDetails[]>;

  releaseReservation(reservationId: string): Promise<ReleaseResult>;
  releaseAllWOReservations(woId: string): Promise<number>;

  // Calculation helpers
  calculateCoverage(materialId: string): Promise<CoverageStatus>;
  getReservationSummary(woId: string): Promise<ReservationSummary>;
}

interface AvailableLP {
  id: string;
  lpNumber: string;
  lotNumber: string | null;
  expiryDate: string | null;
  location: string | null;
  totalQty: number;
  reservedQty: number;
  availableQty: number;
  createdAt: string;
  otherReservations: { woNumber: string; quantity: number }[];
}

interface Reservation {
  id: string;
  woId: string;
  woMaterialId: string;
  lpId: string;
  reservedQty: number;
  consumedQty: number;
  status: 'active' | 'released' | 'consumed';
  reservedAt: string;
  reservedBy: string;
  releasedAt?: string;
  releasedBy?: string;
}

interface CoverageStatus {
  requiredQty: number;
  reservedQty: number;
  coveragePercent: number;
  status: 'full' | 'partial' | 'none' | 'over';
}
```

### Zod Validation Schemas

**Location:** `lib/validation/reservation-schemas.ts`

```typescript
import { z } from 'zod';

// Single reservation item
export const createReservationItemSchema = z.object({
  lp_id: z.string().uuid('Invalid LP ID'),
  quantity: z.number().positive('Quantity must be positive'),
});

// Create reservations request
export const createReservationsRequestSchema = z.object({
  reservations: z.array(createReservationItemSchema)
    .min(1, 'At least one reservation required'),
  acknowledge_over_reservation: z.boolean().optional().default(false),
});

// Query filters
export const reservationFiltersSchema = z.object({
  status: z.enum(['active', 'released', 'consumed', 'all']).optional(),
  material_id: z.string().uuid().optional(),
});

export const availableLPsQuerySchema = z.object({
  sort: z.enum(['fifo', 'fefo']).optional(),
  lot_number: z.string().optional(),
  location: z.string().optional(),
});

// Reservation response
export const reservationSchema = z.object({
  id: z.string().uuid(),
  wo_id: z.string().uuid(),
  wo_material_id: z.string().uuid(),
  lp_id: z.string().uuid(),
  lp_number: z.string(),
  reserved_qty: z.number(),
  consumed_qty: z.number(),
  remaining_qty: z.number(),
  status: z.enum(['active', 'released', 'consumed']),
  reserved_at: z.string().datetime(),
  reserved_by: z.string(),
});
```

## UI Components

### Pages

- `app/(authenticated)/production/work-orders/[id]/page.tsx` - WO detail with Materials tab containing reservations

### Components

**Location:** `components/production/reservations/`

```
WOReservationsPanel.tsx        - Panel showing all material reservations for WO
ReserveLPModal.tsx             - Modal for selecting and reserving LPs
AvailableLPsTable.tsx          - Table with FIFO/FEFO sorted LPs for selection
ReservationStatusBadge.tsx     - Visual coverage indicator (Full/Partial/None/Over)
ReleaseReservationDialog.tsx   - Confirmation dialog for releasing reservation
```

### Component Details

**WOReservationsPanel.tsx**
```tsx
interface WOReservationsPanelProps {
  woId: string;
  woNumber: string;
  woStatus: WOStatus;
  onReservationsChange: () => void;
}

// Features:
// - DataTable with columns: Material, LP Number, Lot, Qty Reserved/Consumed/Remaining, Status
// - Summary bar: Total reserved, consumed, remaining
// - [+ Reserve Materials] button opens ReserveLPModal
// - [Release] action per active reservation
// - Filter by status, material
```

**ReserveLPModal.tsx**
```tsx
interface ReserveLPModalProps {
  open: boolean;
  woId: string;
  woNumber: string;
  woMaterialId: string;
  productId: string;
  productName: string;
  productCode: string;
  requiredQty: number;
  currentlyReservedQty: number;
  uom: string;
  warehouseId: string;
  defaultAlgorithm: 'fifo' | 'fefo';
  onReserve: (selections: LPSelection[]) => Promise<void>;
  onCancel: () => void;
}

// Features:
// - Progress bar: Reserved X / Required Y kg (percentage)
// - FIFO/FEFO toggle with auto-select checkbox
// - Filters: location, lot number
// - AvailableLPsTable for LP selection with quantity input
// - Selected LPs summary with remove action
// - Over-reservation warning with acknowledgment checkbox
```

**ReservationStatusBadge.tsx**
```tsx
interface ReservationStatusBadgeProps {
  requiredQty: number;
  reservedQty: number;
  uom: string;
  size?: 'default' | 'large';
  showTooltip?: boolean;
}

// Variants:
// - Full (100%): Green badge with CheckCircle icon
// - Partial (<100%): Yellow badge with AlertTriangle icon, tooltip shows shortfall
// - None (0%): Gray badge with Circle icon
// - Over (>100%): Blue badge with PlusCircle icon, tooltip shows excess
```

### UI States

| State | Display |
|-------|---------|
| Loading | Skeleton table with 5 shimmer rows |
| Empty | Empty box icon with "No Material Reservations" and CTA |
| Error | Warning icon with error message and retry button |
| Success | Full DataTable with reservations and summary |

### UI Patterns

**Available LPs Table Layout:**
```
+--------------------------------------------------------------+
| [ ] | LP Number  | Lot    | Expiry   | Location | Avail | Reserve |
+--------------------------------------------------------------+
| [*] | LP-00001   | LOT-A  | 2026-06  | A-01-01  | 50 kg | [50   ] |
| [ ] | LP-00002   | LOT-B  | 2026-07  | A-01-02  | 60 kg | [    ] |
+--------------------------------------------------------------+
* = Suggested (FIFO oldest / FEFO earliest expiry)
```

**Reservation Progress:**
```
Reserved: 80 / 100 kg
[========--------] 80%
Partial - 20 kg short
```

## Test Cases

### Unit Tests

**material-reservation-service.test.ts**
```typescript
describe('MaterialReservationService', () => {
  describe('FIFO/FEFO sorting', () => {
    it('sorts LPs by created_at ASC for FIFO');
    it('sorts LPs by expiry_date ASC for FEFO');
    it('places NULL expiry last in FEFO sort');
    it('uses created_at as secondary sort in FEFO');
  });

  describe('calculateCoverage', () => {
    it('returns "full" when reserved == required');
    it('returns "partial" when reserved < required');
    it('returns "none" when reserved == 0');
    it('returns "over" when reserved > required');
  });

  describe('createReservations', () => {
    it('creates reservation with correct quantities');
    it('rejects over-reservation without acknowledgment');
    it('accepts over-reservation with acknowledgment');
    it('validates LP availability before creating');
  });
});
```

**reservation-calculations.test.ts**
```typescript
describe('Reservation Calculations', () => {
  it('calculateRemainingQty returns reserved minus consumed');
  it('calculateCoveragePercent returns percentage of required');
  it('getCoverageStatus returns correct status for all ranges');
});
```

### Integration Tests

**reservations-api.test.ts**
```typescript
describe('Reservations API', () => {
  describe('GET /available-lps', () => {
    it('returns LPs sorted by FIFO');
    it('returns LPs sorted by FEFO');
    it('excludes blocked and failed QA LPs');
    it('excludes expired LPs');
    it('calculates available qty after reservations');
    it('includes other WO reservations info');
  });

  describe('POST /reservations', () => {
    it('creates reservations successfully');
    it('rejects insufficient quantity');
    it('rejects for completed WO');
    it('requires acknowledgment for over-reservation');
  });

  describe('DELETE /reservations/:id', () => {
    it('releases reservation and updates LP availability');
    it('requires supervisor or admin role');
    it('rejects already released reservation');
    it('rejects fully consumed reservation');
  });
});
```

**reservations-rls.test.ts**
```typescript
describe('Reservations RLS', () => {
  it('user sees only own org reservations');
  it('user cannot release other org reservation');
  it('returns 404 for cross-org access (not 403)');
});
```

### E2E Tests

**reservations.spec.ts**
```typescript
describe('Material Reservations Workflow', () => {
  it('opens ReserveLPModal and loads available LPs');
  it('selects multiple LPs and reserves successfully');
  it('shows over-reservation warning and requires acknowledgment');
  it('toggles FIFO/FEFO and updates LP order');
  it('releases reservation with confirmation');
  it('updates coverage badge after reservation changes');
});
```

**reservations-a11y.spec.ts**
```typescript
describe('Reservations Accessibility', () => {
  it('keyboard navigation through modal');
  it('focus trap within modal');
  it('escape closes modal');
  it('no axe-core violations');
});
```

## Business Rules

1. **Soft Reservations**: Multiple WOs can reserve same LP (with warnings). Total reserved can exceed LP qty - last reservation to consume wins.

2. **Pick Algorithm**:
   - FIFO: Sort by created_at ASC, then expiry_date ASC
   - FEFO: Sort by expiry_date ASC (NULL last), then created_at ASC

3. **LP Eligibility**: Only LPs with status='available' AND qa_status='passed' AND (expiry_date IS NULL OR expiry_date >= today)

4. **Auto-Release**: All active reservations released when WO status = 'completed' or 'cancelled'

5. **Permission**: Only supervisor or admin can manually release reservations

6. **Over-Reservation**: Allowed with explicit acknowledgment, logged for audit

## Security Considerations

1. **RLS Enforcement**: All tables have org_id filtering
2. **Role-Based Release**: Only supervisor/admin can release reservations
3. **Audit Trail**: Log reservation creation, release, and consumption
4. **Cross-Org Protection**: Return 404 (not 403) for cross-org access attempts

## Performance Considerations

1. **Available LPs Query**: Index on (product_id, warehouse_id, status, qa_status)
2. **Active Reservations**: Partial index on lp_id WHERE status = 'active'
3. **Query Target**: <500ms for 100+ LPs
4. **Batch Creation**: <1.5s for 5 reservations

## Deliverables

- [ ] `material_reservations` table migration
- [ ] `get_available_lps_for_material` RPC function
- [ ] `release_wo_reservations` RPC function
- [ ] RLS policies for material_reservations
- [ ] MaterialReservationService (`lib/services/material-reservation-service.ts`)
- [ ] Zod schemas (`lib/validation/reservation-schemas.ts`)
- [ ] API: GET /available-lps
- [ ] API: POST /reservations
- [ ] API: GET /reservations
- [ ] API: DELETE /reservations/:id
- [ ] WOReservationsPanel component
- [ ] ReserveLPModal component
- [ ] AvailableLPsTable component
- [ ] ReservationStatusBadge component
- [ ] ReleaseReservationDialog component
- [ ] useWOReservations hook
- [ ] useAvailableLPs hook
- [ ] Unit tests (>80% coverage)
- [ ] Integration tests
- [ ] E2E tests

## Definition of Done

- [ ] Available LPs query returns correctly sorted LPs (FIFO/FEFO)
- [ ] Blocked, failed QA, and expired LPs excluded from results
- [ ] Available qty correctly calculated after existing reservations
- [ ] Reservations created with correct quantities and user tracking
- [ ] Over-reservation warning displayed and requires acknowledgment
- [ ] ReservationStatusBadge shows correct coverage status
- [ ] Manual release works for supervisor/admin only
- [ ] Auto-release triggers on WO completion/cancellation
- [ ] Soft reservations allow multiple WOs with warnings
- [ ] Multi-tenancy enforced (RLS working correctly)
- [ ] Performance meets targets (<500ms query, <1.5s batch create)
- [ ] Unit test coverage >= 80%
- [ ] Integration tests pass
- [ ] E2E tests pass
- [ ] Accessibility requirements met (keyboard nav, ARIA)
