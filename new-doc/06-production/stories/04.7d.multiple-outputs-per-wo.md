# 04.7d - Multiple Outputs per WO

**Story ID:** 04.7d
**Epic:** 04 - Production
**Phase:** 1B (MVP)
**Complexity:** S (Small)
**Estimate:** 2 days
**Type:** Full-stack
**State:** ready

**Primary PRD:** `docs/1-BASELINE/product/modules/production.md` (FR-PROD-015)
**UX Wireframes:** PROD-004-part2 (Output History Table, WO Summary Header)

## PRD References

| FR ID | Requirement | Priority | Phase | Covered |
|-------|-------------|----------|-------|---------|
| FR-PROD-015 | Multiple Outputs per WO | P0 | MVP | Yes |

## User Story

**As a** production operator,
**I want** to register multiple output batches for a single work order,
**So that** I can track partial completions and split production across multiple license plates.

**As a** production manager,
**I want** to see cumulative progress and output history for each work order,
**So that** I can monitor production throughput and identify completion status.

## Goal

Enable multiple output registrations per work order with cumulative tracking. Each output creates a separate LP while the WO aggregates total output quantity. Progress percentage updates in real-time. Auto-complete triggers when output reaches planned quantity (if enabled).

## Scope

**In scope:**
- Multiple LP creation per WO
- Cumulative output_qty tracking on work_orders table
- Progress bar with percentage display
- Auto-complete WO when output >= planned (if setting enabled)
- Output history table with filters and pagination
- Over-production tracking (>100% allowed)

**Out of scope:**
- Output editing or deletion
- Output merging or splitting
- Batch output registration (multiple at once)
- Output transfer between WOs

## Dependencies

| Story | Requirement | Status |
|-------|-------------|--------|
| 04.7a | Output Registration Desktop | Required - provides production_outputs table, single output flow |
| 04.7c | By-Product Registration | Required - provides is_by_product flag for exclusion |
| 05.1 | License Plates CRUD | Required - provides license_plates table, LP service |
| 04.5 | Production Settings | Required - provides auto_complete_wo setting |
| 03.10 | Work Order CRUD | Required - provides work_orders table, status field |

**Blocks:** 04.2c (WO completion validation depends on output tracking)

## Acceptance Criteria (Given/When/Then)

### Cumulative Output Tracking

#### First Output Registration
- GIVEN WO.planned_qty = 1000 AND first output = 400, WHEN output registered, THEN WO.output_qty = 400 AND progress = 40%.
- GIVEN output registered, WHEN LP created, THEN new unique LP ID is generated.
- GIVEN output registered, WHEN WO queried, THEN output_qty reflects sum of all non-by-product outputs.

#### Subsequent Output Registration
- GIVEN WO.output_qty = 400 AND second output = 300, WHEN second output registered, THEN WO.output_qty = 700 AND progress = 70%.
- GIVEN multiple outputs registered, WHEN output_qty calculated, THEN by-product outputs are excluded from sum.
- GIVEN third output = 300 (total = 1000), WHEN output registered, THEN progress = 100%.

#### Over-Production Handling
- GIVEN WO.output_qty = 1000 AND planned_qty = 1000, WHEN additional 200 registered, THEN output_qty = 1200 AND progress = 120%.
- GIVEN progress > 100%, WHEN progress bar displayed, THEN shows green with over-production indicator.
- GIVEN over-production state, WHEN user attempts to register more output, THEN registration proceeds (not blocked).

### Output History Table

#### Display
- GIVEN 3 outputs registered (LP-001, LP-002, LP-003), WHEN output history viewed, THEN all 3 LPs display with individual quantities.
- GIVEN output history table, WHEN rendered, THEN columns include: LP Number, Quantity, UoM, Batch, QA Status, Location, Expiry, Created At, Created By.
- GIVEN output list, WHEN sorted, THEN default order is created_at DESC (most recent first).

#### Pagination
- GIVEN WO with 25 outputs, WHEN history table loads with limit=20, THEN first page shows 20 outputs.
- GIVEN page 1 displayed, WHEN user clicks "Next", THEN page 2 shows remaining 5 outputs.
- GIVEN pagination controls, WHEN rendered, THEN shows "Showing X to Y of Z outputs".

#### Filtering
- GIVEN outputs with mixed QA statuses, WHEN user selects "Approved" filter, THEN only approved outputs display.
- GIVEN outputs across locations, WHEN user selects location filter, THEN only outputs in that location display.
- GIVEN filter applied, WHEN summary recalculated, THEN summary reflects filtered data.

### Auto-Complete

#### Auto-Complete Enabled
- GIVEN auto_complete_wo = true AND output_qty reaches 1000 (planned), WHEN output registered, THEN WO status changes to 'completed'.
- GIVEN WO auto-completes, WHEN status updated, THEN completed_at timestamp is set.
- GIVEN auto-complete triggers, WHEN notification sent, THEN toast displays "Work order completed".

#### Auto-Complete Disabled
- GIVEN auto_complete_wo = false AND output_qty >= planned_qty, WHEN output registered, THEN WO status remains 'in_progress'.
- GIVEN auto_complete disabled, WHEN progress reaches 100%, THEN manual completion still required.

### Progress Display

#### Progress Card
- GIVEN WO with planned_qty = 5000 AND output_qty = 3200, WHEN progress card rendered, THEN shows: Planned: 5000, Output: 3200, Remaining: 1800.
- GIVEN progress_percent = 64%, WHEN progress bar rendered, THEN bar filled to 64%.
- GIVEN progress < 100%, WHEN progress bar rendered, THEN bar color is blue.
- GIVEN progress >= 100%, WHEN progress bar rendered, THEN bar color is green.

#### Real-Time Updates
- GIVEN user registers new output, WHEN registration completes, THEN progress card updates immediately.
- GIVEN progress updates, WHEN toast displayed, THEN shows "{progress_percent}% complete".

## Technical Specification

### Database Schema

#### work_orders table extension

```sql
-- Add output_qty to work_orders
ALTER TABLE work_orders
  ADD COLUMN IF NOT EXISTS output_qty DECIMAL(15,4) NOT NULL DEFAULT 0;
```

#### Aggregation Trigger

```sql
-- Create function to update WO output_qty
CREATE OR REPLACE FUNCTION update_wo_output_qty()
RETURNS TRIGGER AS $$
DECLARE
  v_total_qty DECIMAL(15,4);
BEGIN
  -- Calculate sum of non-by-product outputs
  SELECT COALESCE(SUM(quantity), 0)
  INTO v_total_qty
  FROM production_outputs
  WHERE wo_id = COALESCE(NEW.wo_id, OLD.wo_id)
  AND is_by_product = false;

  -- Update work_orders
  UPDATE work_orders
  SET output_qty = v_total_qty,
      updated_at = NOW()
  WHERE id = COALESCE(NEW.wo_id, OLD.wo_id);

  RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Create trigger for INSERT
DROP TRIGGER IF EXISTS trg_update_wo_output_qty_insert ON production_outputs;
CREATE TRIGGER trg_update_wo_output_qty_insert
  AFTER INSERT ON production_outputs
  FOR EACH ROW
  EXECUTE FUNCTION update_wo_output_qty();

-- Create trigger for UPDATE
DROP TRIGGER IF EXISTS trg_update_wo_output_qty_update ON production_outputs;
CREATE TRIGGER trg_update_wo_output_qty_update
  AFTER UPDATE OF quantity, is_by_product ON production_outputs
  FOR EACH ROW
  EXECUTE FUNCTION update_wo_output_qty();

-- Create trigger for DELETE
DROP TRIGGER IF EXISTS trg_update_wo_output_qty_delete ON production_outputs;
CREATE TRIGGER trg_update_wo_output_qty_delete
  AFTER DELETE ON production_outputs
  FOR EACH ROW
  EXECUTE FUNCTION update_wo_output_qty();
```

#### Auto-Complete Trigger

```sql
-- Create function for auto-complete check
CREATE OR REPLACE FUNCTION check_wo_auto_complete()
RETURNS TRIGGER AS $$
DECLARE
  v_auto_complete BOOLEAN;
  v_planned_qty DECIMAL(15,4);
BEGIN
  -- Get auto_complete setting and planned_qty
  SELECT
    ps.auto_complete_wo,
    NEW.planned_qty
  INTO v_auto_complete, v_planned_qty
  FROM production_settings ps
  WHERE ps.org_id = NEW.org_id
  LIMIT 1;

  -- Check if auto-complete should trigger
  IF v_auto_complete = true
    AND NEW.output_qty >= v_planned_qty
    AND NEW.status = 'in_progress' THEN

    NEW.status := 'completed';
    NEW.completed_at := NOW();
  END IF;

  RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Create trigger for auto-complete
DROP TRIGGER IF EXISTS trg_check_wo_auto_complete ON work_orders;
CREATE TRIGGER trg_check_wo_auto_complete
  BEFORE UPDATE OF output_qty ON work_orders
  FOR EACH ROW
  EXECUTE FUNCTION check_wo_auto_complete();
```

#### Index for Performance

```sql
-- Index for output aggregation
CREATE INDEX IF NOT EXISTS idx_production_outputs_wo_active
  ON production_outputs(wo_id, is_by_product)
  WHERE is_by_product = false;
```

### API Endpoints

```
# Output List
GET    /api/production/work-orders/:id/outputs      - Get all outputs for WO with pagination

# Progress
GET    /api/production/work-orders/:id/progress     - Get WO output progress summary
```

### Service Methods

**Location:** `lib/services/output-aggregation-service.ts`

```typescript
interface OutputAggregationService {
  // Output retrieval
  getOutputsForWO(woId: string, options?: OutputQueryOptions): Promise<OutputsListResponse>;
  getOutputsSummary(woId: string): Promise<OutputsSummary>;

  // Progress tracking
  getWOProgress(woId: string): Promise<WOProgressResponse>;
  calculateProgress(outputQty: number, plannedQty: number): number;
}

interface OutputQueryOptions {
  page?: number;
  limit?: number;
  qa_status?: 'approved' | 'pending' | 'rejected';
  location_id?: string;
  sort?: 'created_at' | 'qty' | 'lp_number';
  order?: 'asc' | 'desc';
}

interface OutputItem {
  id: string;
  lp_id: string;
  lp_number: string;
  quantity: number;
  uom: string;
  batch_number: string;
  qa_status: QAStatus;
  location_id: string;
  location_name: string;
  expiry_date: string | null;
  created_at: string;
  created_by_name: string;
  notes: string | null;
}

interface OutputsSummary {
  total_outputs: number;
  total_qty: number;
  approved_count: number;
  approved_qty: number;
  pending_count: number;
  pending_qty: number;
  rejected_count: number;
  rejected_qty: number;
}

interface WOProgressResponse {
  wo_id: string;
  wo_number: string;
  planned_qty: number;
  output_qty: number;
  progress_percent: number;
  remaining_qty: number;
  outputs_count: number;
  is_complete: boolean;
  auto_complete_enabled: boolean;
  status: WOStatus;
}

interface OutputsListResponse {
  outputs: OutputItem[];
  summary: OutputsSummary;
  pagination: Pagination;
}
```

### Zod Validation Schemas

**Location:** `lib/validation/production-schemas.ts`

```typescript
import { z } from 'zod';

// Output query parameters
export const outputQuerySchema = z.object({
  page: z.coerce.number().int().min(1).default(1),
  limit: z.coerce.number().int().min(1).max(100).default(20),
  qa_status: z.enum(['approved', 'pending', 'rejected']).optional(),
  location_id: z.string().uuid().optional(),
  sort: z.enum(['created_at', 'qty', 'lp_number']).default('created_at'),
  order: z.enum(['asc', 'desc']).default('desc')
});
```

## UI Components

### Pages

- `app/(authenticated)/production/outputs/[woId]/page.tsx` - Existing page, enhanced with new components

### Components

**Location:** `components/production/outputs/`

```
OutputProgressCard.tsx      - Progress card showing output vs planned
OutputHistoryTable.tsx      - Table showing all outputs for WO with pagination
OutputsSummary.tsx          - Summary card with aggregate statistics
```

### Component Details

**OutputProgressCard.tsx**
```tsx
interface OutputProgressCardProps {
  progress: WOProgressResponse;
  uom: string;
}

// Displays:
// - Planned: {planned_qty} {uom}
// - Output: {output_qty} {uom}
// - Remaining: {remaining_qty} {uom}
// - Progress bar filled to progress_percent
// - Auto-complete enabled badge
// - Over-production indicator (if > 100%)
```

**OutputHistoryTable.tsx**
```tsx
interface OutputHistoryTableProps {
  woId: string;
  outputs: OutputItem[];
  pagination: Pagination;
  onPageChange: (page: number) => void;
  onFilterChange: (filters: OutputQueryOptions) => void;
  onViewLP: (lpId: string) => void;
  onPrintLabel: (lpId: string) => void;
}

// Columns:
// - LP Number (link to LP detail)
// - Quantity with UoM
// - Batch Number
// - QA Status (badge)
// - Location (path)
// - Expiry Date
// - Created At (relative + absolute)
// - Created By
// - Actions (View, Label)
```

**OutputsSummary.tsx**
```tsx
interface OutputsSummaryProps {
  summary: OutputsSummary;
  uom: string;
}

// Displays:
// - Total: {total_outputs} outputs | {total_qty} {uom}
// - Approved: {approved_count} | {approved_qty} {uom}
// - Pending: {pending_count} | {pending_qty} {uom}
// - Rejected: {rejected_count} | {rejected_qty} {uom}
```

### UI Patterns

**Progress Bar:**
```
+---------------------------------------------+
| Progress                            64.0%   |
| [=============================-----]        |
| Remaining: 1,800 kg                         |
+---------------------------------------------+
```

**Over-Production Display:**
```
+---------------------------------------------+
| Progress                           120.0%   |
| [=====================================]      |
| Over-production: 20% above planned          |
+---------------------------------------------+
```

**Output History Table:**
```
+----------+--------+--------+---------+----------+--------+----------+--------+
| LP#      | Qty    | Batch  | QA      | Location | Expiry | Created  | By     |
+----------+--------+--------+---------+----------+--------+----------+--------+
| LP-05482 | 500 kg | B-0156 | Approved| WH-A/Z1  | Jan 13 | 2 min ago| John S |
| LP-05481 | 600 kg | B-0155 | Pending | WH-A/Z1  | Jan 13 | 1 hr ago | Mary K |
| LP-05480 | 400 kg | B-0154 | Approved| WH-B/Z2  | Jan 12 | 2 hrs ago| John S |
+----------+--------+--------+---------+----------+--------+----------+--------+
Showing 1 to 3 of 6 outputs        [Previous] [Next]
```

## Test Cases

### Unit Tests

**output-aggregation-service.test.ts**
```typescript
describe('OutputAggregationService', () => {
  describe('calculateProgress', () => {
    it('returns correct percentage for partial completion');
    it('returns 100 when output equals planned');
    it('returns >100 for over-production');
    it('returns 0 when planned qty is 0');
    it('returns 0 when output qty is 0');
  });

  describe('getOutputsForWO', () => {
    it('returns paginated results');
    it('filters by qa_status');
    it('excludes by-products');
    it('calculates summary correctly');
  });
});
```

**OutputProgressCard.test.tsx**
```typescript
describe('OutputProgressCard', () => {
  it('renders planned, output, and remaining quantities');
  it('shows progress bar at correct percentage');
  it('displays green progress bar when complete');
  it('shows over-production message when > 100%');
  it('shows auto-complete badge when enabled');
});
```

### Integration Tests

**route.test.ts**
```typescript
describe('GET /api/production/work-orders/:id/outputs', () => {
  it('returns outputs with pagination');
  it('filters by qa_status');
  it('excludes by-products from list');
  it('returns correct summary');
  it('returns 404 for non-existent WO');
});

describe('GET /api/production/work-orders/:id/progress', () => {
  it('returns correct progress percentage');
  it('handles over-production correctly');
  it('includes auto_complete_enabled flag');
});
```

**trigger.test.ts**
```typescript
describe('update_wo_output_qty trigger', () => {
  it('updates output_qty on INSERT');
  it('updates output_qty cumulatively');
  it('excludes by-products from aggregation');
});

describe('check_wo_auto_complete trigger', () => {
  it('auto-completes WO when output >= planned and setting enabled');
  it('does not auto-complete when setting disabled');
  it('sets completed_at timestamp on auto-complete');
});
```

### E2E Tests

**multiple-outputs.spec.ts**
```typescript
describe('Multiple Outputs per WO', () => {
  it('registers multiple outputs and tracks progress');
  it('displays all outputs in history table');
  it('auto-completes WO when target reached');
  it('allows manual completion when auto-complete disabled');
  it('handles over-production correctly');
  it('paginates output history');
  it('filters outputs by QA status');
});
```

## Performance Considerations

1. **Output Aggregation**
   - Database trigger recalculates sum on each INSERT/UPDATE/DELETE
   - Index on (wo_id, is_by_product) WHERE is_by_product = false
   - Aggregation runs within same transaction as output registration

2. **Output History Query**
   - Paginated by default (limit 20)
   - Max limit 100 per request
   - Filters reduce result set before pagination

3. **Progress Calculation**
   - Simple division: output_qty / planned_qty * 100
   - No complex joins required (output_qty stored on WO)

## Deliverables

- [ ] Migration: `XXX_add_wo_output_qty_tracking.sql`
  - [ ] Add output_qty column to work_orders
  - [ ] Create update_wo_output_qty function and triggers
  - [ ] Create check_wo_auto_complete function and trigger
  - [ ] Create performance index
- [ ] API: `GET /api/production/work-orders/:id/outputs`
- [ ] API: `GET /api/production/work-orders/:id/progress`
- [ ] Service: `output-aggregation-service.ts`
- [ ] Hook: `use-wo-outputs.ts`
- [ ] Hook: `use-wo-progress.ts`
- [ ] Component: `OutputProgressCard.tsx`
- [ ] Component: `OutputHistoryTable.tsx`
- [ ] Component: `OutputsSummary.tsx`
- [ ] Validation schema: `outputQuerySchema`
- [ ] Unit tests (>80% coverage)
- [ ] Integration tests
- [ ] E2E tests

## Definition of Done

- [ ] Multiple outputs can be registered for single WO
- [ ] Each output creates separate LP with unique ID
- [ ] WO.output_qty correctly aggregates non-by-product outputs
- [ ] Progress percentage displays correctly (0-100%+)
- [ ] Progress bar updates in real-time after registration
- [ ] Auto-complete triggers when output >= planned (if enabled)
- [ ] Auto-complete sets status = 'completed' and completed_at
- [ ] Over-production allowed (progress > 100%)
- [ ] Output history table shows all outputs
- [ ] Pagination works correctly
- [ ] Filters (QA status, location) work correctly
- [ ] By-products excluded from output_qty and history list
- [ ] Unit tests pass
- [ ] Integration tests pass
- [ ] E2E tests pass
