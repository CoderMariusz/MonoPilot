# 04.9a - OEE Calculation

**Story ID:** 04.9a
**Epic:** 04 - Production
**Phase:** Phase 2
**Complexity:** L (Large)
**Estimate:** 5 days
**Type:** Backend + Frontend
**State:** ready
**Priority:** P1

**Primary PRD:** `docs/1-BASELINE/product/modules/PRODUCTION.md` (FR-PROD-018)
**Architecture:** `docs/1-BASELINE/architecture/modules/production.md`
**UX Wireframes:** TBD (OEE Dashboard, OEE Gauges, OEE Trend Charts)

## PRD References

| FR ID | Requirement | Priority | Phase | Covered |
|-------|-------------|----------|-------|---------|
| FR-PROD-018 | OEE Calculation | P1 | Phase 2 | Yes |

---

## User Story

**As a** production manager,
**I want** to see real-time OEE (Overall Equipment Effectiveness) metrics calculated automatically from shift, downtime, and output data,
**So that** I can identify inefficiencies, compare performance against targets, and make data-driven decisions to improve manufacturing efficiency.

**As a** plant supervisor,
**I want** to drill down into Availability, Performance, and Quality components of OEE,
**So that** I can pinpoint whether issues are caused by downtime, speed loss, or quality defects.

---

## Goal

Implement comprehensive OEE calculation engine that computes Availability, Performance, and Quality metrics in real-time per machine, production line, and shift. Provide visual dashboards with gauges, trend charts, and target comparison. Enable OEE target setting with variance alerts when performance drops below threshold.

---

## OEE Formula

```
OEE = Availability x Performance x Quality

Where:
- Availability = (Planned Production Time - Downtime) / Planned Production Time
             = (Operating Time) / (Planned Production Time)

- Performance = (Ideal Cycle Time x Total Count) / Operating Time
             = (Actual Output) / (Theoretical Output)

- Quality = Good Count / Total Count
         = (Total Count - Reject Count) / Total Count
```

### Component Definitions

| Component | Formula | Data Source | Unit |
|-----------|---------|-------------|------|
| **Planned Production Time** | shift_duration - scheduled_breaks | `shifts` table | minutes |
| **Downtime** | SUM(downtime_logs.duration_minutes) WHERE is_planned = false | `downtime_logs` table | minutes |
| **Operating Time** | Planned Production Time - Unplanned Downtime | calculated | minutes |
| **Ideal Cycle Time** | products.ideal_cycle_time_seconds OR routings.cycle_time | product/routing | seconds |
| **Total Count** | SUM(production_outputs.quantity) | `production_outputs` table | units |
| **Good Count** | SUM(production_outputs.quantity) WHERE qa_status = 'Approved' | `production_outputs` table | units |
| **Theoretical Output** | Operating Time / Ideal Cycle Time | calculated | units |

### World-Class OEE Benchmarks

| Category | OEE % | Rating |
|----------|-------|--------|
| World-Class | >= 85% | Excellent |
| Average | 60-85% | Good |
| Below Average | 40-60% | Needs Improvement |
| Poor | < 40% | Critical |

---

## Scope

**In scope (this story):**
- OEE calculation engine with Availability x Performance x Quality
- Real-time OEE calculation per machine, line, and shift
- OEE metrics storage in `oee_metrics` table
- OEE dashboard page with A/P/Q gauges
- OEE trend chart (daily/weekly/monthly)
- Target OEE configuration and variance alerts
- OEE widget on Production Dashboard
- Shift-based OEE aggregation
- Machine-level OEE breakdown
- Service layer: `oee-service.ts`
- Zod schema validation
- Unit and integration tests

**Out of scope (this story):**
- Downtime logging and tracking (Story 04.9b - prerequisite)
- Shift management and configuration (Story 04.9d - prerequisite)
- Machine integration and counters (Story 04.9c)
- OEE Summary Report with export (Story 04.10a)
- Predictive OEE alerts (Phase 3)
- OEE comparison across plants (multi-site - future)

---

## Dependencies

| Story | Name | Requirement | Status |
|-------|------|-------------|--------|
| **04.9d** | Shift Management | Required - shift duration for Availability | PREREQUISITE |
| **04.9b** | Downtime Tracking | Required - downtime for Availability | PREREQUISITE |
| **04.4** | Yield Tracking | Required - output data for Quality | PREREQUISITE |
| **04.7a** | Output Registration Desktop | Required - production counts | PREREQUISITE |
| **01.10** | Machines | Required - machine configuration | PREREQUISITE |
| **01.11** | Production Lines | Required - line configuration | PREREQUISITE |
| **04.5** | Production Settings | Required - OEE toggle and target | PREREQUISITE |

**Critical Path:**
```
01.10 (Machines) + 01.11 (Lines) + 04.5 (Settings)
    |
    v
04.9d (Shift Management)
    |
    v
04.9b (Downtime Tracking)
    |
    v
04.4 (Yield) + 04.7a (Output Registration)
    |
    v
04.9a (OEE Calculation) <-- THIS STORY
```

---

## Acceptance Criteria (Given/When/Then)

### AC-1: OEE Formula Calculation

**Given** shift_duration = 480 min AND downtime = 60 min (unplanned)
**When** Availability calculated
**Then** Availability = (480 - 60) / 480 = 87.5%

**Given** actual_output = 900 units AND theoretical_output = 1000 units
**When** Performance calculated
**Then** Performance = 900 / 1000 = 90.0%

**Given** total_output = 1000 units AND approved_output = 950 units
**When** Quality calculated
**Then** Quality = 950 / 1000 = 95.0%

**Given** Availability = 87.5%, Performance = 90%, Quality = 95%
**When** OEE calculated
**Then** OEE = 0.875 x 0.90 x 0.95 x 100 = 74.8%

**Given** OEE calculation result is 74.8125%
**When** displayed
**Then** OEE rounds to 74.8% (1 decimal place)

### AC-2: Availability Calculation

**Given** shift has duration_minutes = 480 AND break_minutes = 30
**When** planned_production_time calculated
**Then** planned_production_time = 480 - 30 = 450 minutes

**Given** unplanned downtime = 45 minutes during shift
**When** operating_time calculated
**Then** operating_time = 450 - 45 = 405 minutes

**Given** planned downtime (changeover) = 20 minutes during shift
**When** operating_time calculated
**Then** planned downtime is NOT subtracted (only unplanned counts)

**Given** operating_time = 405 AND planned_production_time = 450
**When** Availability calculated
**Then** Availability = 405 / 450 = 90.0%

**Given** no downtime logged during shift
**When** Availability calculated
**Then** Availability = 100.0%

**Given** downtime exceeds shift duration (data error)
**When** Availability calculated
**Then** Availability = 0% (capped, not negative)

### AC-3: Performance Calculation

**Given** product has ideal_cycle_time = 30 seconds/unit AND operating_time = 405 minutes
**When** theoretical_output calculated
**Then** theoretical_output = (405 x 60) / 30 = 810 units

**Given** actual_output = 750 units AND theoretical_output = 810 units
**When** Performance calculated
**Then** Performance = 750 / 810 = 92.6%

**Given** actual_output = 900 units AND theoretical_output = 810 units (over-performance)
**When** Performance calculated
**Then** Performance = 111.1% (can exceed 100%)

**Given** ideal_cycle_time not configured for product
**When** Performance calculated
**Then** Performance defaults to 100% with warning "Cycle time not configured"

**Given** no output registered during shift
**When** Performance calculated
**Then** Performance = 0%

### AC-4: Quality Calculation

**Given** total_output = 1000 units
**When** counting approved output
**Then** Good Count = SUM(production_outputs.quantity WHERE qa_status = 'Approved')

**Given** total_output = 1000 AND rejected_output = 50 (qa_status = 'Rejected')
**When** Quality calculated
**Then** Quality = (1000 - 50) / 1000 = 95.0%

**Given** all output has qa_status = 'Pending' (not yet inspected)
**When** Quality calculated
**Then** Quality = 100% (pending treated as good until rejected)

**Given** no output registered during shift
**When** Quality calculated
**Then** Quality = 100% (no rejects = perfect quality)

**Given** total_output = 0 (division by zero edge case)
**When** Quality calculated
**Then** Quality = 100% (default when no production)

### AC-5: OEE Dashboard Display

**Given** enable_oee_tracking = true in production_settings
**When** user navigates to `/production/oee`
**Then** OEE dashboard displays with A/P/Q gauges within 2 seconds

**Given** enable_oee_tracking = false in production_settings
**When** user navigates to `/production/oee`
**Then** message "OEE tracking is disabled. Enable in Settings." displays

**Given** OEE dashboard loads
**When** rendered
**Then** displays: OEE gauge (large), Availability gauge, Performance gauge, Quality gauge

**Given** current shift OEE = 74.8%
**When** OEE gauge displayed
**Then** gauge shows 74.8% with color indicator (green/yellow/red based on target)

**Given** OEE dashboard displayed
**When** user views metrics
**Then** shows current shift, today's average, week average, month average

### AC-6: OEE Gauges and Visual Indicators

**Given** OEE = 88% AND target_oee = 85%
**When** OEE gauge rendered
**Then** gauge shows green color with "Above Target" label

**Given** OEE = 75% AND target_oee = 85%
**When** OEE gauge rendered
**Then** gauge shows yellow color with "Below Target" label

**Given** OEE = 55% AND target_oee = 85%
**When** OEE gauge rendered
**Then** gauge shows red color with "Critical" label

**Given** gauge color thresholds
**When** OEE calculated
**Then** colors: green (>= target), yellow (>= target - 15%), red (< target - 15%)

**Given** Availability gauge displayed
**When** rendered
**Then** shows percentage with "Availability" label and relevant icon

**Given** Performance gauge displayed
**When** rendered
**Then** shows percentage with "Performance" label and relevant icon

**Given** Quality gauge displayed
**When** rendered
**Then** shows percentage with "Quality" label and relevant icon

### AC-7: OEE Trend Chart

**Given** OEE dashboard displayed
**When** trend chart rendered
**Then** shows OEE % over time as line chart

**Given** date range filter = "Last 7 Days"
**When** trend chart rendered
**Then** shows daily OEE values for each of the 7 days

**Given** date range filter = "Last 30 Days"
**When** trend chart rendered
**Then** shows daily OEE values for each of the 30 days

**Given** target_oee_percent = 85%
**When** trend chart rendered
**Then** horizontal target line displays at 85% level

**Given** machine filter = "Machine A"
**When** trend chart rendered
**Then** shows OEE trend only for Machine A

**Given** trend chart data point hovered
**When** tooltip displayed
**Then** shows: Date, OEE %, Availability %, Performance %, Quality %

### AC-8: OEE by Machine/Line Breakdown

**Given** OEE dashboard displayed
**When** machine breakdown table rendered
**Then** shows each machine with: Name, OEE %, A %, P %, Q %, Status

**Given** 5 machines configured
**When** breakdown table displayed
**Then** all 5 machines listed with their respective OEE metrics

**Given** machine breakdown table
**When** sorted by OEE ascending
**Then** lowest performing machine appears first

**Given** user clicks on machine row
**When** clicked
**Then** drills down to machine-specific OEE detail page

**Given** production line filter selected
**When** machine breakdown displayed
**Then** shows only machines assigned to that production line

### AC-9: OEE Target Configuration

**Given** production_settings.target_oee_percent = 85
**When** OEE dashboard loads
**Then** target line shows at 85% on charts and gauges

**Given** admin navigates to production settings
**When** target_oee_percent field edited
**Then** accepts values 0-100 with validation

**Given** target_oee_percent = 110 entered
**When** form submitted
**Then** validation error "Target OEE must be between 0 and 100" displays

**Given** target_oee_percent changed from 85 to 90
**When** saved
**Then** OEE dashboard immediately reflects new target

### AC-10: OEE Variance Alerts

**Given** current OEE = 70% AND target_oee = 85%
**When** variance calculated
**Then** variance = -15% (below target)

**Given** OEE below target for current shift
**When** Production Dashboard loads
**Then** "OEE Below Target" alert displays in Medium priority section

**Given** OEE below target by > 20%
**When** alert generated
**Then** alert shows as High priority with "Critical OEE" message

**Given** OEE = 90% AND target_oee = 85%
**When** variance calculated
**Then** no alert generated (above target)

### AC-11: Real-Time OEE Updates

**Given** shift is currently active
**When** new output registered
**Then** OEE recalculates within 30 seconds

**Given** downtime logged during active shift
**When** downtime recorded
**Then** Availability and OEE recalculate within 30 seconds

**Given** OEE dashboard open with auto-refresh
**When** refresh_interval = 30 seconds passes
**Then** all OEE metrics update without page reload

**Given** manual refresh button clicked
**When** clicked
**Then** OEE metrics update within 500ms

### AC-12: OEE Metrics Storage

**Given** shift ends
**When** shift closes
**Then** final OEE metrics saved to oee_metrics table within 5 minutes

**Given** oee_metrics record created
**When** stored
**Then** includes: machine_id, shift_id, shift_date, A%, P%, Q%, OEE%, component values

**Given** historical OEE data exists for 30 days
**When** trend chart queries data
**Then** retrieves from oee_metrics table efficiently (< 1 second)

**Given** OEE calculated mid-shift
**When** stored temporarily
**Then** marked as is_final = false (updated at shift end)

### AC-13: OEE Widget on Production Dashboard

**Given** enable_oee_tracking = true
**When** Production Dashboard loads
**Then** OEE widget displays with current shift OEE percentage

**Given** OEE widget displayed
**When** rendered
**Then** shows mini gauge with A/P/Q breakdown below

**Given** user clicks OEE widget
**When** clicked
**Then** navigates to full OEE dashboard page

**Given** enable_oee_tracking = false
**When** Production Dashboard loads
**Then** OEE widget is hidden

### AC-14: Multi-tenancy and RLS

**Given** User from Org A views OEE dashboard
**When** data loads
**Then** only Org A OEE metrics returned

**Given** User from Org A attempts to query Org B OEE data
**When** API called
**Then** 404 Not Found returned (not 403)

**Given** oee_metrics table
**When** RLS policy applied
**Then** org_id filter automatically enforced

---

## Technical Specification

### Database Schema

#### oee_metrics table (Primary)

```sql
CREATE TABLE oee_metrics (
  id                        UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id                    UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,

  -- Dimensions
  machine_id                UUID REFERENCES machines(id) ON DELETE SET NULL,
  line_id                   UUID REFERENCES production_lines(id) ON DELETE SET NULL,
  shift_id                  UUID REFERENCES shifts(id) ON DELETE SET NULL,
  shift_date                DATE NOT NULL,

  -- Time Metrics (minutes)
  planned_production_minutes INTEGER NOT NULL DEFAULT 0,
  break_minutes             INTEGER NOT NULL DEFAULT 0,
  planned_downtime_minutes  INTEGER NOT NULL DEFAULT 0,
  unplanned_downtime_minutes INTEGER NOT NULL DEFAULT 0,
  operating_minutes         INTEGER GENERATED ALWAYS AS (
    planned_production_minutes - break_minutes - unplanned_downtime_minutes
  ) STORED,

  -- Production Counts
  theoretical_output        DECIMAL(15,4) DEFAULT 0,
  actual_output             DECIMAL(15,4) DEFAULT 0,
  good_output               DECIMAL(15,4) DEFAULT 0,
  reject_output             DECIMAL(15,4) DEFAULT 0,

  -- OEE Percentages (0-100, can exceed 100 for Performance)
  availability_percent      DECIMAL(5,2) DEFAULT 0,
  performance_percent       DECIMAL(5,2) DEFAULT 0,
  quality_percent           DECIMAL(5,2) DEFAULT 100,
  oee_percent               DECIMAL(5,2) DEFAULT 0,

  -- Metadata
  is_final                  BOOLEAN DEFAULT false,  -- Final calculation at shift end
  calculated_at             TIMESTAMPTZ DEFAULT now(),
  created_at                TIMESTAMPTZ DEFAULT now(),
  updated_at                TIMESTAMPTZ,

  -- Constraints
  CONSTRAINT oee_metrics_availability_check CHECK (availability_percent >= 0 AND availability_percent <= 100),
  CONSTRAINT oee_metrics_quality_check CHECK (quality_percent >= 0 AND quality_percent <= 100),
  CONSTRAINT oee_metrics_oee_check CHECK (oee_percent >= 0)
);

-- Indexes for performance
CREATE INDEX idx_oee_metrics_org_id ON oee_metrics(org_id);
CREATE INDEX idx_oee_metrics_machine_id ON oee_metrics(machine_id);
CREATE INDEX idx_oee_metrics_line_id ON oee_metrics(line_id);
CREATE INDEX idx_oee_metrics_shift_date ON oee_metrics(shift_date DESC);
CREATE INDEX idx_oee_metrics_calculated_at ON oee_metrics(calculated_at DESC);

-- Unique constraint for one record per machine per shift per date
CREATE UNIQUE INDEX idx_oee_metrics_unique_shift
  ON oee_metrics(org_id, machine_id, shift_id, shift_date)
  WHERE machine_id IS NOT NULL AND shift_id IS NOT NULL;

-- RLS policies
ALTER TABLE oee_metrics ENABLE ROW LEVEL SECURITY;

CREATE POLICY "oee_metrics_tenant_isolation" ON oee_metrics
  FOR ALL USING (org_id = current_setting('app.current_org_id')::uuid);

CREATE POLICY "oee_metrics_read_own_org" ON oee_metrics
  FOR SELECT USING (
    org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  );

CREATE POLICY "oee_metrics_insert_own_org" ON oee_metrics
  FOR INSERT WITH CHECK (
    org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  );

CREATE POLICY "oee_metrics_update_own_org" ON oee_metrics
  FOR UPDATE USING (
    org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  );
```

#### oee_targets table (Target Configuration)

```sql
CREATE TABLE oee_targets (
  id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id          UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,

  -- Target scope (most specific wins)
  machine_id      UUID REFERENCES machines(id) ON DELETE CASCADE,
  line_id         UUID REFERENCES production_lines(id) ON DELETE CASCADE,
  product_id      UUID REFERENCES products(id) ON DELETE CASCADE,

  -- Targets
  target_oee_percent         DECIMAL(5,2) NOT NULL DEFAULT 85,
  target_availability_percent DECIMAL(5,2) DEFAULT 90,
  target_performance_percent  DECIMAL(5,2) DEFAULT 95,
  target_quality_percent      DECIMAL(5,2) DEFAULT 99,

  -- Alert thresholds
  warning_threshold_percent  DECIMAL(5,2) DEFAULT 10, -- Alert if below target by this %
  critical_threshold_percent DECIMAL(5,2) DEFAULT 20, -- Critical if below target by this %

  -- Metadata
  is_active       BOOLEAN DEFAULT true,
  created_at      TIMESTAMPTZ DEFAULT now(),
  updated_at      TIMESTAMPTZ,
  created_by      UUID REFERENCES users(id),

  CONSTRAINT oee_targets_positive CHECK (
    target_oee_percent > 0 AND
    target_oee_percent <= 100 AND
    target_availability_percent <= 100 AND
    target_performance_percent <= 100 AND
    target_quality_percent <= 100
  )
);

-- Indexes
CREATE INDEX idx_oee_targets_org_id ON oee_targets(org_id);
CREATE INDEX idx_oee_targets_machine_id ON oee_targets(machine_id);
CREATE INDEX idx_oee_targets_line_id ON oee_targets(line_id);

-- RLS
ALTER TABLE oee_targets ENABLE ROW LEVEL SECURITY;

CREATE POLICY "oee_targets_tenant_isolation" ON oee_targets
  FOR ALL USING (org_id = current_setting('app.current_org_id')::uuid);
```

#### products table extension

```sql
-- Add ideal cycle time to products for Performance calculation
ALTER TABLE products ADD COLUMN IF NOT EXISTS
  ideal_cycle_time_seconds INTEGER DEFAULT NULL;

COMMENT ON COLUMN products.ideal_cycle_time_seconds IS
  'Ideal production time per unit in seconds for OEE Performance calculation';
```

#### production_settings extension

```sql
-- Ensure OEE settings exist (from FR-PROD-017)
-- These should already exist from 04.5 story:
--   enable_oee_tracking BOOLEAN DEFAULT false
--   target_oee_percent DECIMAL(5,2) DEFAULT 85
```

### RLS Policies Summary

```sql
-- oee_metrics: Users can read own org, admins can update
CREATE POLICY "oee_metrics_read_own" ON oee_metrics
  FOR SELECT USING (
    org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  );

CREATE POLICY "oee_metrics_write_admin" ON oee_metrics
  FOR ALL USING (
    org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    AND (SELECT r.code FROM roles r JOIN users u ON u.role_id = r.id WHERE u.id = auth.uid())
        IN ('SUPER_ADMIN', 'ADMIN', 'MANAGER')
  );

-- oee_targets: Admins can manage, all can read
CREATE POLICY "oee_targets_read_all" ON oee_targets
  FOR SELECT USING (
    org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  );

CREATE POLICY "oee_targets_write_admin" ON oee_targets
  FOR ALL USING (
    org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    AND (SELECT r.code FROM roles r JOIN users u ON u.role_id = r.id WHERE u.id = auth.uid())
        IN ('SUPER_ADMIN', 'ADMIN')
  );
```

### API Endpoints

```
# OEE Dashboard Data
GET    /api/production/oee/current              - Get current shift OEE for all machines
GET    /api/production/oee/summary              - Get OEE summary (today, week, month)
GET    /api/production/oee/by-machine/:id       - Get OEE for specific machine
GET    /api/production/oee/by-line/:id          - Get OEE for production line
GET    /api/production/oee/by-shift/:id         - Get OEE for specific shift

# OEE Trends
GET    /api/production/oee/trend                - Get OEE trend data
  Query params:
    - start_date: string (ISO date)
    - end_date: string (ISO date)
    - machine_id?: string (UUID)
    - line_id?: string (UUID)
    - granularity: 'hourly' | 'daily' | 'weekly' | 'monthly'

# OEE Breakdown
GET    /api/production/oee/breakdown            - Get A/P/Q breakdown by machine
GET    /api/production/oee/components/:metricId - Get detailed component values

# OEE Targets
GET    /api/production/oee/targets              - List OEE targets
POST   /api/production/oee/targets              - Create OEE target
PUT    /api/production/oee/targets/:id          - Update OEE target
DELETE /api/production/oee/targets/:id          - Delete OEE target

# OEE Calculation (Internal/Scheduled)
POST   /api/production/oee/calculate            - Trigger OEE recalculation
POST   /api/production/oee/finalize-shift       - Finalize shift OEE (called by scheduler)

# OEE Alerts
GET    /api/production/oee/alerts               - Get current OEE alerts
```

### Service Methods

**Location:** `lib/services/oee-service.ts`

```typescript
interface OEEService {
  // Core Calculations
  calculateOEE(params: OEECalculationParams): Promise<OEEResult>;
  calculateAvailability(params: AvailabilityParams): Promise<number>;
  calculatePerformance(params: PerformanceParams): Promise<number>;
  calculateQuality(params: QualityParams): Promise<number>;

  // Data Retrieval
  getCurrentShiftOEE(machineId?: string): Promise<OEEMetrics[]>;
  getOEESummary(dateRange: DateRange): Promise<OEESummary>;
  getOEEByMachine(machineId: string, dateRange: DateRange): Promise<OEEMetrics[]>;
  getOEEByLine(lineId: string, dateRange: DateRange): Promise<OEEMetrics[]>;
  getOEETrend(params: TrendParams): Promise<OEETrendData[]>;
  getOEEBreakdown(): Promise<MachineOEEBreakdown[]>;

  // Target Management
  getTargetOEE(machineId?: string, lineId?: string): Promise<OEETarget>;
  setTargetOEE(target: OEETargetInput): Promise<OEETarget>;

  // Alerts
  getOEEAlerts(): Promise<OEEAlert[]>;
  checkOEEThresholds(oee: number, target: number): AlertLevel;

  // Lifecycle
  finalizeShiftOEE(shiftId: string, shiftDate: Date): Promise<void>;
  recalculateOEE(machineId: string, shiftId: string, shiftDate: Date): Promise<OEEMetrics>;
}

interface OEECalculationParams {
  machineId: string;
  shiftId: string;
  shiftDate: Date;
  plannedProductionMinutes: number;
  breakMinutes: number;
  unplannedDowntimeMinutes: number;
  theoreticalOutput: number;
  actualOutput: number;
  goodOutput: number;
}

interface OEEResult {
  availability: number;
  performance: number;
  quality: number;
  oee: number;
  operatingMinutes: number;
}

interface OEEMetrics {
  id: string;
  machineId: string;
  machineName: string;
  lineId?: string;
  lineName?: string;
  shiftId?: string;
  shiftName?: string;
  shiftDate: string;
  availabilityPercent: number;
  performancePercent: number;
  qualityPercent: number;
  oeePercent: number;
  plannedProductionMinutes: number;
  operatingMinutes: number;
  actualOutput: number;
  goodOutput: number;
  targetOeePercent: number;
  variancePercent: number;
  isFinal: boolean;
  calculatedAt: string;
}

interface OEESummary {
  currentShift: OEEMetrics | null;
  todayAverage: number;
  weekAverage: number;
  monthAverage: number;
  targetOee: number;
  trend: 'up' | 'down' | 'stable';
}

interface OEETrendData {
  date: string;
  oeePercent: number;
  availabilityPercent: number;
  performancePercent: number;
  qualityPercent: number;
}

interface MachineOEEBreakdown {
  machineId: string;
  machineName: string;
  lineName: string;
  oeePercent: number;
  availabilityPercent: number;
  performancePercent: number;
  qualityPercent: number;
  status: 'running' | 'idle' | 'down';
}

interface OEETarget {
  id: string;
  machineId?: string;
  lineId?: string;
  targetOeePercent: number;
  targetAvailabilityPercent: number;
  targetPerformancePercent: number;
  targetQualityPercent: number;
  warningThresholdPercent: number;
  criticalThresholdPercent: number;
}

interface OEEAlert {
  machineId: string;
  machineName: string;
  currentOee: number;
  targetOee: number;
  variancePercent: number;
  alertLevel: 'warning' | 'critical';
  message: string;
}

type AlertLevel = 'none' | 'warning' | 'critical';
```

### Zod Validation Schemas

**Location:** `lib/validation/oee-validation.ts`

```typescript
import { z } from 'zod';

// OEE Metrics Response Schema
export const oeeMetricsSchema = z.object({
  id: z.string().uuid(),
  machine_id: z.string().uuid().nullable(),
  machine_name: z.string().nullable(),
  line_id: z.string().uuid().nullable(),
  line_name: z.string().nullable(),
  shift_id: z.string().uuid().nullable(),
  shift_name: z.string().nullable(),
  shift_date: z.string().date(),
  availability_percent: z.number().min(0).max(100),
  performance_percent: z.number().min(0), // Can exceed 100
  quality_percent: z.number().min(0).max(100),
  oee_percent: z.number().min(0),
  planned_production_minutes: z.number().int().min(0),
  operating_minutes: z.number().int().min(0),
  actual_output: z.number().min(0),
  good_output: z.number().min(0),
  target_oee_percent: z.number().min(0).max(100),
  variance_percent: z.number(),
  is_final: z.boolean(),
  calculated_at: z.string().datetime(),
});

// OEE Target Input Schema
export const oeeTargetInputSchema = z.object({
  machine_id: z.string().uuid().optional(),
  line_id: z.string().uuid().optional(),
  product_id: z.string().uuid().optional(),
  target_oee_percent: z.number()
    .min(0, 'Target OEE must be at least 0%')
    .max(100, 'Target OEE must be at most 100%')
    .default(85),
  target_availability_percent: z.number().min(0).max(100).optional(),
  target_performance_percent: z.number().min(0).max(100).optional(),
  target_quality_percent: z.number().min(0).max(100).optional(),
  warning_threshold_percent: z.number().min(0).max(50).default(10),
  critical_threshold_percent: z.number().min(0).max(50).default(20),
});

// OEE Trend Query Schema
export const oeeTrendQuerySchema = z.object({
  start_date: z.string().date(),
  end_date: z.string().date(),
  machine_id: z.string().uuid().optional(),
  line_id: z.string().uuid().optional(),
  granularity: z.enum(['hourly', 'daily', 'weekly', 'monthly']).default('daily'),
});

// OEE Calculation Request Schema (internal)
export const oeeCalculationSchema = z.object({
  machine_id: z.string().uuid(),
  shift_id: z.string().uuid(),
  shift_date: z.string().date(),
  planned_production_minutes: z.number().int().min(0),
  break_minutes: z.number().int().min(0),
  unplanned_downtime_minutes: z.number().int().min(0),
  theoretical_output: z.number().min(0),
  actual_output: z.number().min(0),
  good_output: z.number().min(0),
});

// OEE Summary Response Schema
export const oeeSummarySchema = z.object({
  current_shift: oeeMetricsSchema.nullable(),
  today_average: z.number().min(0),
  week_average: z.number().min(0),
  month_average: z.number().min(0),
  target_oee: z.number().min(0).max(100),
  trend: z.enum(['up', 'down', 'stable']),
});
```

---

## UI Components

### Pages

- `app/(authenticated)/production/oee/page.tsx` - OEE Dashboard page
- `app/(authenticated)/production/oee/[machineId]/page.tsx` - Machine OEE detail

### Components

**Location:** `components/production/oee/`

```
OEEDashboard.tsx           - Main OEE dashboard container
OEEGauge.tsx               - Circular gauge for OEE/A/P/Q metrics
OEEGaugeSet.tsx            - Set of 4 gauges (OEE, A, P, Q)
OEETrendChart.tsx          - Line chart for OEE trends
OEEMachineBreakdown.tsx    - Table showing OEE by machine
OEEWidget.tsx              - Mini widget for Production Dashboard
OEETargetConfig.tsx        - Target configuration form
OEEAlertBanner.tsx         - Alert banner for low OEE
OEEComponentDetails.tsx    - Detailed A/P/Q breakdown
OEEDateRangeFilter.tsx     - Date range selector for trends
OEEMachineFilter.tsx       - Machine/line filter dropdown
```

### Component Details

**OEEGauge.tsx**
```tsx
interface OEEGaugeProps {
  value: number;           // 0-100 (or higher for Performance)
  target?: number;         // Target value for comparison
  label: string;           // 'OEE', 'Availability', 'Performance', 'Quality'
  size?: 'sm' | 'md' | 'lg';
  showTarget?: boolean;
  colorThresholds?: {
    green: number;
    yellow: number;
  };
}

// Gauge visuals:
// - Circular arc with percentage fill
// - Color based on thresholds (green/yellow/red)
// - Center displays percentage value
// - Label below gauge
// - Optional target indicator on arc
```

**OEETrendChart.tsx**
```tsx
interface OEETrendChartProps {
  data: OEETrendData[];
  targetOee?: number;
  dateRange: { start: Date; end: Date };
  showComponents?: boolean; // Show A/P/Q lines
  onDataPointClick?: (data: OEETrendData) => void;
}

// Chart features:
// - Line chart with OEE trend
// - Optional A/P/Q component lines (dashed)
// - Horizontal target line
// - Tooltips on hover
// - Responsive design
// - Date range on X-axis
```

**OEEMachineBreakdown.tsx**
```tsx
interface OEEMachineBreakdownProps {
  data: MachineOEEBreakdown[];
  onMachineClick?: (machineId: string) => void;
  sortBy?: 'oee' | 'availability' | 'performance' | 'quality';
  sortOrder?: 'asc' | 'desc';
}

// Table columns:
// - Machine Name
// - Line
// - OEE % (with color badge)
// - Availability %
// - Performance %
// - Quality %
// - Status (Running/Idle/Down)
// - Actions (View Details)
```

**OEEWidget.tsx**
```tsx
interface OEEWidgetProps {
  currentOee: number;
  targetOee: number;
  availability: number;
  performance: number;
  quality: number;
  onClick?: () => void;
}

// Widget layout:
// +------------------------+
// |    OEE: 74.8%          |
// |    [======----]        |
// | A: 87% P: 90% Q: 95%   |
// |    Target: 85%         |
// +------------------------+
```

### UI Patterns

**OEE Dashboard Layout:**
```
+----------------------------------------------------------+
| OEE Dashboard                    [Machine Filter v] [7D]  |
+----------------------------------------------------------+
|                                                          |
|  +------------+  +------------+  +------------+  +-----+ |
|  |    OEE     |  | Availability|  | Performance|  |Qual.| |
|  |   74.8%    |  |    87.5%   |  |    90.0%   |  |95.0%| |
|  |  (Large)   |  |   (Medium) |  |   (Medium) |  |(Med)| |
|  +------------+  +------------+  +------------+  +-----+ |
|                                                          |
|  OEE Trend                                    [Export]   |
|  +----------------------------------------------------+ |
|  |     ---- Target (85%)                               | |
|  |  /\      /\                                         | |
|  | /  \    /  \____/\                                  | |
|  |/    \__/          \                                 | |
|  +----------------------------------------------------+ |
|  | Jan 8 | Jan 9 | Jan 10 | Jan 11 | Jan 12 | Jan 13 | |
|                                                          |
|  Machine Breakdown                           [Sort: OEE] |
|  +----------------------------------------------------+ |
|  | Machine      | Line   | OEE  | A%   | P%   | Q%   | |
|  |--------------|--------|------|------|------|------| |
|  | Machine A    | Line 1 | 82%  | 90%  | 92%  | 99%  | |
|  | Machine B    | Line 1 | 75%  | 85%  | 90%  | 98%  | |
|  | Machine C    | Line 2 | 68%  | 80%  | 88%  | 97%  | |
|  +----------------------------------------------------+ |
|                                                          |
+----------------------------------------------------------+
```

**Gauge Color Thresholds:**
```
OEE Gauge Colors (based on target):
- Green:  OEE >= target_oee
- Yellow: OEE >= target_oee - warning_threshold (default 10%)
- Red:    OEE < target_oee - critical_threshold (default 20%)

Example with target = 85%:
- Green:  >= 85%
- Yellow: 65% - 84.9%
- Red:    < 65%
```

---

## Implementation Notes

### OEE Calculation Logic

```typescript
// lib/services/oee-service.ts

export function calculateOEE(params: OEECalculationParams): OEEResult {
  const {
    plannedProductionMinutes,
    breakMinutes,
    unplannedDowntimeMinutes,
    theoreticalOutput,
    actualOutput,
    goodOutput,
  } = params;

  // Planned production time (excluding scheduled breaks)
  const plannedTime = plannedProductionMinutes - breakMinutes;

  // Operating time (excluding unplanned downtime only)
  const operatingMinutes = Math.max(0, plannedTime - unplannedDowntimeMinutes);

  // Availability = Operating Time / Planned Production Time
  const availability = plannedTime > 0
    ? Math.min(100, (operatingMinutes / plannedTime) * 100)
    : 0;

  // Performance = Actual Output / Theoretical Output
  // Theoretical = Operating Time (in seconds) / Ideal Cycle Time
  const performance = theoreticalOutput > 0
    ? (actualOutput / theoreticalOutput) * 100
    : 100; // Default to 100% if no theoretical output

  // Quality = Good Output / Total Output
  const quality = actualOutput > 0
    ? Math.min(100, (goodOutput / actualOutput) * 100)
    : 100; // Default to 100% if no output (no defects)

  // OEE = A x P x Q
  const oee = (availability / 100) * (performance / 100) * (quality / 100) * 100;

  return {
    availability: roundToOneDecimal(availability),
    performance: roundToOneDecimal(performance),
    quality: roundToOneDecimal(quality),
    oee: roundToOneDecimal(oee),
    operatingMinutes,
  };
}

function roundToOneDecimal(value: number): number {
  return Math.round(value * 10) / 10;
}
```

### Theoretical Output Calculation

```typescript
export function calculateTheoreticalOutput(
  operatingMinutes: number,
  idealCycleTimeSeconds: number | null
): number {
  if (!idealCycleTimeSeconds || idealCycleTimeSeconds <= 0) {
    // If no cycle time configured, return 0 (will default Performance to 100%)
    return 0;
  }

  const operatingSeconds = operatingMinutes * 60;
  return operatingSeconds / idealCycleTimeSeconds;
}
```

### Data Aggregation for OEE

```typescript
export async function aggregateOEEData(
  machineId: string,
  shiftId: string,
  shiftDate: Date
): Promise<OEECalculationParams> {
  // 1. Get shift duration from shifts table
  const shift = await getShift(shiftId);
  const plannedProductionMinutes = shift.duration_minutes;
  const breakMinutes = shift.break_minutes;

  // 2. Get unplanned downtime from downtime_logs
  const downtime = await supabase
    .from('downtime_logs')
    .select('duration_minutes')
    .eq('machine_id', machineId)
    .eq('is_planned', false)
    .gte('started_at', shiftDate)
    .lt('started_at', addDays(shiftDate, 1));

  const unplannedDowntimeMinutes = downtime.data
    ?.reduce((sum, d) => sum + (d.duration_minutes || 0), 0) || 0;

  // 3. Get outputs from production_outputs
  const outputs = await supabase
    .from('production_outputs')
    .select('quantity, qa_status')
    .eq('machine_id', machineId)
    .gte('created_at', shiftDate)
    .lt('created_at', addDays(shiftDate, 1));

  const actualOutput = outputs.data
    ?.reduce((sum, o) => sum + Number(o.quantity), 0) || 0;

  const goodOutput = outputs.data
    ?.filter(o => o.qa_status !== 'Rejected')
    .reduce((sum, o) => sum + Number(o.quantity), 0) || 0;

  // 4. Get ideal cycle time from product/routing
  const idealCycleTimeSeconds = await getIdealCycleTime(machineId, shiftDate);

  const operatingMinutes = plannedProductionMinutes - breakMinutes - unplannedDowntimeMinutes;
  const theoreticalOutput = calculateTheoreticalOutput(operatingMinutes, idealCycleTimeSeconds);

  return {
    machineId,
    shiftId,
    shiftDate,
    plannedProductionMinutes,
    breakMinutes,
    unplannedDowntimeMinutes,
    theoreticalOutput,
    actualOutput,
    goodOutput,
  };
}
```

### Key Business Rules

1. **Availability Calculation:**
   - Uses only UNPLANNED downtime (is_planned = false)
   - Planned downtime (changeovers, maintenance) does not reduce Availability
   - Availability capped at 100% (cannot exceed planned time)
   - Availability floored at 0% (no negative values)

2. **Performance Calculation:**
   - Requires ideal_cycle_time to be configured on product or routing
   - If not configured, defaults to 100% with warning
   - CAN exceed 100% (over-performance possible)
   - Uses actual output vs theoretical output

3. **Quality Calculation:**
   - Based on qa_status of production_outputs
   - 'Pending' treated as 'Good' until marked 'Rejected'
   - Quality capped at 100%
   - If no output, Quality = 100% (no defects possible)

4. **OEE Calculation:**
   - OEE = A x P x Q (all as decimals, then x 100)
   - Can exceed 100% only if Performance > 100%
   - Rounded to 1 decimal place for display
   - World-class benchmark: >= 85%

5. **Real-Time Updates:**
   - OEE recalculates every 30 seconds during active shift
   - Final OEE calculated and marked `is_final = true` at shift end
   - Mid-shift values are estimates, subject to change

6. **Target Comparison:**
   - Default target_oee = 85% (from production_settings)
   - Machine-specific targets override org default
   - Variance = actual_oee - target_oee (negative = below target)

7. **Alert Thresholds:**
   - Warning: OEE < target - warning_threshold (default 10%)
   - Critical: OEE < target - critical_threshold (default 20%)

---

## Test Cases

### Unit Tests

**oee-service.test.ts**
```typescript
describe('OEEService', () => {
  describe('calculateOEE', () => {
    it('calculates correct OEE for standard inputs', () => {
      // Given: A=87.5%, P=90%, Q=95%
      // Expected: OEE = 74.8%
    });

    it('handles zero planned production time', () => {
      // Expected: All metrics = 0
    });

    it('caps availability at 100%', () => {
      // Given: downtime = negative (data error)
      // Expected: Availability = 100%
    });

    it('allows performance over 100%', () => {
      // Given: actual > theoretical
      // Expected: Performance > 100%
    });

    it('handles zero output with 100% quality', () => {
      // Given: no output
      // Expected: Quality = 100%
    });

    it('rounds to 1 decimal place', () => {
      // Given: calculated = 74.8125%
      // Expected: displayed = 74.8%
    });
  });

  describe('calculateAvailability', () => {
    it('excludes only unplanned downtime', () => {
      // Given: planned=20min, unplanned=45min
      // Expected: only 45min subtracted
    });

    it('subtracts break time from planned time', () => {
      // Given: shift=480min, break=30min
      // Expected: planned_production = 450min
    });
  });

  describe('calculatePerformance', () => {
    it('returns 100% when cycle time not configured', () => {
      // Given: ideal_cycle_time = null
      // Expected: Performance = 100%
    });

    it('calculates theoretical output correctly', () => {
      // Given: operating=405min, cycle_time=30sec
      // Expected: theoretical = 810 units
    });
  });

  describe('calculateQuality', () => {
    it('treats pending as good', () => {
      // Given: 100 total, 90 approved, 10 pending, 0 rejected
      // Expected: Quality = 100%
    });

    it('calculates correct reject rate', () => {
      // Given: 1000 total, 50 rejected
      // Expected: Quality = 95%
    });
  });

  describe('checkOEEThresholds', () => {
    it('returns none when above target', () => {
      // Given: OEE=90%, target=85%
      // Expected: 'none'
    });

    it('returns warning when below warning threshold', () => {
      // Given: OEE=80%, target=85%, warning=10%
      // Expected: 'warning'
    });

    it('returns critical when below critical threshold', () => {
      // Given: OEE=60%, target=85%, critical=20%
      // Expected: 'critical'
    });
  });
});
```

### Integration Tests

**oee-api.test.ts**
```typescript
describe('OEE API', () => {
  describe('GET /api/production/oee/current', () => {
    it('returns current shift OEE for all machines');
    it('returns 401 for unauthenticated request');
    it('filters by org_id via RLS');
  });

  describe('GET /api/production/oee/summary', () => {
    it('returns today, week, month averages');
    it('calculates trend correctly');
  });

  describe('GET /api/production/oee/trend', () => {
    it('returns daily OEE for date range');
    it('filters by machine_id');
    it('returns empty array for no data');
  });

  describe('POST /api/production/oee/targets', () => {
    it('creates target with valid data');
    it('rejects target > 100%');
    it('requires admin role');
  });

  describe('POST /api/production/oee/calculate', () => {
    it('triggers recalculation for machine/shift');
    it('updates oee_metrics table');
  });
});
```

### E2E Tests

**oee-dashboard.spec.ts**
```typescript
describe('OEE Dashboard', () => {
  it('displays OEE gauges with correct values');
  it('shows trend chart with target line');
  it('filters by machine');
  it('filters by date range');
  it('drills down to machine detail');
  it('shows alert banner when OEE below target');
  it('auto-refreshes every 30 seconds');
  it('displays "disabled" message when OEE tracking off');
});
```

---

## Security Considerations

1. **Multi-tenancy**
   - All OEE queries filtered by org_id via RLS
   - Cross-tenant OEE access returns 404 (not 403)

2. **Role-Based Access**
   - All users can view OEE metrics
   - Only Admin/Manager can modify targets
   - OEE calculation runs with service role (scheduled)

3. **Data Integrity**
   - OEE metrics are calculated, not user-entered
   - is_final flag prevents mid-shift values from being treated as final
   - Audit trail via calculated_at timestamps

4. **Rate Limiting**
   - Manual refresh limited to 1 per 10 seconds
   - Auto-refresh at 30 second intervals (configurable)

---

## Deliverables

### Database
- [ ] `oee_metrics` table migration with RLS policies
- [ ] `oee_targets` table migration with RLS policies
- [ ] `products.ideal_cycle_time_seconds` column migration
- [ ] Indexes for query performance

### API Routes
- [ ] `GET /api/production/oee/current`
- [ ] `GET /api/production/oee/summary`
- [ ] `GET /api/production/oee/by-machine/:id`
- [ ] `GET /api/production/oee/by-line/:id`
- [ ] `GET /api/production/oee/trend`
- [ ] `GET /api/production/oee/breakdown`
- [ ] `GET /api/production/oee/targets`
- [ ] `POST /api/production/oee/targets`
- [ ] `PUT /api/production/oee/targets/:id`
- [ ] `DELETE /api/production/oee/targets/:id`
- [ ] `GET /api/production/oee/alerts`
- [ ] `POST /api/production/oee/calculate`
- [ ] `POST /api/production/oee/finalize-shift`

### Services
- [ ] `lib/services/oee-service.ts` - Core OEE calculation logic

### Validation
- [ ] `lib/validation/oee-validation.ts` - Zod schemas

### Components
- [ ] `OEEDashboard.tsx` - Main dashboard container
- [ ] `OEEGauge.tsx` - Circular gauge component
- [ ] `OEEGaugeSet.tsx` - Set of A/P/Q/OEE gauges
- [ ] `OEETrendChart.tsx` - Trend line chart
- [ ] `OEEMachineBreakdown.tsx` - Machine breakdown table
- [ ] `OEEWidget.tsx` - Mini widget for Production Dashboard
- [ ] `OEETargetConfig.tsx` - Target configuration form
- [ ] `OEEAlertBanner.tsx` - Alert banner component
- [ ] `OEEDateRangeFilter.tsx` - Date range selector
- [ ] `OEEMachineFilter.tsx` - Machine/line filter

### Pages
- [ ] `app/(authenticated)/production/oee/page.tsx`
- [ ] `app/(authenticated)/production/oee/[machineId]/page.tsx`

### Tests
- [ ] Unit tests for OEE calculation (>90% coverage - critical)
- [ ] Integration tests for OEE API endpoints
- [ ] E2E tests for OEE dashboard

---

## Definition of Done

- [ ] `oee_metrics` table created with RLS policies enforcing org_id isolation
- [ ] `oee_targets` table created for target configuration
- [ ] OEE calculation correctly computes A x P x Q formula
- [ ] Availability uses only unplanned downtime
- [ ] Performance handles missing cycle time gracefully (defaults to 100%)
- [ ] Quality treats pending QA status as good
- [ ] OEE dashboard displays gauges for OEE, A, P, Q
- [ ] Gauge colors reflect target comparison (green/yellow/red)
- [ ] Trend chart shows OEE over time with target line
- [ ] Machine breakdown table shows all machines with OEE metrics
- [ ] Target OEE configurable via settings (admin only)
- [ ] Alerts display when OEE below target
- [ ] OEE widget displays on Production Dashboard (when enabled)
- [ ] Real-time updates every 30 seconds
- [ ] Manual refresh completes within 500ms
- [ ] Shift-end OEE finalization marks records as is_final = true
- [ ] Multi-tenant RLS enforced on all OEE tables
- [ ] Unit tests >90% coverage (critical calculation logic)
- [ ] Integration tests pass for all API endpoints
- [ ] E2E tests pass for dashboard interactions
- [ ] Performance: Dashboard loads in < 2 seconds
- [ ] Performance: Trend chart loads in < 1 second for 30 days data
- [ ] Documentation: OEE formula and business rules documented inline

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-01-14 | Initial story creation | ARCHITECT-AGENT |
