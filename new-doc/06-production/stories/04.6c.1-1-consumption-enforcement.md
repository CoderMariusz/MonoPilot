# 04.6c - 1:1 Consumption Enforcement

**Story ID:** 04.6c
**Epic:** 04 - Production
**Phase:** 1 (MVP)
**Complexity:** S (Small)
**Estimate:** 2 days
**Type:** Full-stack
**State:** ready

**Primary PRD:** `docs/1-BASELINE/product/modules/PRODUCTION.md` (FR-PROD-008)
**UX Wireframes:** PROD-003 (Material Consumption), PROD-005 (Scanner Consume Material)

## PRD References

| FR ID | Requirement | Priority | Phase | Covered |
|-------|-------------|----------|-------|---------|
| FR-PROD-008 | 1:1 Consumption Enforcement | P0 | MVP | Yes |

## User Story

**As a** production operator,
**I want** the system to enforce full LP consumption for allergen-sensitive materials,
**So that** cross-contamination is prevented and traceability requirements are maintained.

**As a** quality manager,
**I want** certain materials to require complete LP consumption (no partial usage),
**So that** food safety compliance is ensured and audit trails are accurate.

## Goal

Implement 1:1 consumption enforcement for materials flagged with `consume_whole_lp=true`. When enabled, users must consume the entire LP quantity - partial consumption is blocked. This supports allergen control, sealed packaging requirements, and regulatory traceability.

## Scope

**In scope:**
- Block partial consumption when `consume_whole_lp=true`
- Pre-fill and lock qty input on scanner when `consume_whole_lp=true`
- Display "Full LP Required" badge on materials in list
- Show warning banner on desktop modal when qty editing attempted
- Set `is_full_lp=true` flag on consumption record
- Calculate variance when LP.qty differs from required qty
- API validation returning `FULL_LP_REQUIRED` error

**Out of scope:**
- Override permissions for managers (future story)
- Split LP functionality
- Retroactive enforcement on existing consumptions
- Automatic LP selection for 1:1 materials

## Dependencies

| Story | Requirement | Status |
|-------|-------------|--------|
| 04.6a | Material Consumption Desktop | Required - base consumption flow |
| 04.6b | Material Consumption Scanner | Required - scanner flow and NumberPad |
| 03.11a | WO Materials | Required - `wo_materials.consume_whole_lp` flag |

**Blocks:** 04.7a (Output Registration may verify 1:1 materials fully consumed)

## Acceptance Criteria (Given/When/Then)

### Full LP Consumption Enforcement

#### Block Partial Consumption
- GIVEN `consume_whole_lp=true` AND `LP.qty=100`, WHEN user enters `consume_qty=50`, THEN error "Full LP consumption required. LP quantity is 100" displays.
- GIVEN `consume_whole_lp=true` AND `LP.qty=100`, WHEN user enters `consume_qty=100`, THEN consumption proceeds successfully with `is_full_lp=true`.
- GIVEN `consume_whole_lp=false` AND `LP.qty=100`, WHEN user enters `consume_qty=50`, THEN partial consumption proceeds successfully.

#### Scanner Pre-fill and Lock
- GIVEN `consume_whole_lp=true` on scanner, WHEN LP scanned, THEN qty input pre-filled with `LP.qty` and displayed as read-only with lock icon.
- GIVEN `consume_whole_lp=true` on scanner, WHEN Step 3 (Enter Qty) displayed, THEN number pad is disabled (grayed out, 50% opacity, not interactive).
- GIVEN `consume_whole_lp=true` on scanner, WHEN number pad key tapped, THEN key tap ignored, qty value unchanged.

#### Desktop Warning and Lock
- GIVEN `consume_whole_lp=true` on desktop modal, WHEN LP selected, THEN qty input pre-filled with `LP.qty` and marked read-only.
- GIVEN `consume_whole_lp=true` on desktop modal, WHEN user attempts to edit qty input, THEN warning "This material requires full LP consumption" displays, qty remains `LP.qty`.

#### Full LP Required Badge
- GIVEN `consume_whole_lp=true` material in materials table, WHEN table rendered, THEN "Full LP Required" badge with lock icon displays next to material name.
- GIVEN badge rendered on desktop, WHEN displayed, THEN badge has Yellow-900 background, Yellow-300 text.
- GIVEN badge rendered on scanner, WHEN displayed, THEN badge has Yellow-600 background, Yellow-900 text.

#### Variance Recording
- GIVEN `consume_whole_lp=true` AND `LP.qty=100` but `required_qty=90`, WHEN consumption completed, THEN consumption proceeds with +11% variance recorded, `is_full_lp=true` set.

#### API Validation
- GIVEN API receives `consume_qty != LP.qty` for `consume_whole_lp=true` material, WHEN `POST /consume` called, THEN returns 400 with `error_code='FULL_LP_REQUIRED'`, message includes `LP.qty`.

## Technical Specification

### Database Schema

No new tables required. Uses existing columns:

#### wo_materials table (from 03.11a)
```sql
-- Already exists
consume_whole_lp BOOLEAN DEFAULT false
-- If true, entire LP must be consumed (1:1 mode)
```

#### wo_material_consumptions table (from 04.6a)
```sql
-- Already exists
is_full_lp BOOLEAN DEFAULT false
-- True if entire LP was consumed in this consumption
```

### Validation Logic

```sql
-- API-level validation (not database constraint for future override flexibility)
-- Pseudocode:
IF wo_materials.consume_whole_lp = true
   AND request.consume_qty != LP.quantity
THEN
   RETURN 400 error {
     error: 'FULL_LP_REQUIRED',
     message: 'Full LP consumption required. LP quantity is {lp_qty}',
     lp_qty: LP.quantity,
     requested_qty: request.consume_qty
   }
END IF
```

### API Endpoints

**Modified Endpoint:**

```
POST /api/production/work-orders/:woId/consume
```

**File:** `apps/frontend/app/api/production/work-orders/[woId]/consume/route.ts`

**Added Validation:**
```typescript
// Before processing consumption
if (woMaterial.consume_whole_lp && consumeQty !== lp.quantity) {
  return NextResponse.json({
    error: 'FULL_LP_REQUIRED',
    message: `Full LP consumption required. LP quantity is ${lp.quantity}`,
    lp_qty: lp.quantity,
    requested_qty: consumeQty
  }, { status: 400 });
}
```

**New Error Response:**
```json
{
  "error": "FULL_LP_REQUIRED",
  "message": "Full LP consumption required. LP quantity is 100",
  "lp_qty": 100,
  "requested_qty": 50
}
```

### Service Methods

**Location:** `lib/services/consumption-service.ts`

```typescript
interface ConsumptionService {
  // NEW METHOD
  validateFullLPConsumption(
    woMaterialId: string,
    lpId: string,
    consumeQty: number
  ): Promise<FullLPValidationResult>;

  // MODIFIED - add validation call
  recordConsumption(data: ConsumptionData): Promise<Consumption>;
}

interface FullLPValidationResult {
  valid: boolean;
  error?: 'FULL_LP_REQUIRED';
  lpQty?: number;
  message?: string;
}

// Implementation
async validateFullLPConsumption(
  woMaterialId: string,
  lpId: string,
  consumeQty: number
): Promise<FullLPValidationResult> {
  const woMaterial = await getWoMaterial(woMaterialId);
  const lp = await getLicensePlate(lpId);

  if (woMaterial.consume_whole_lp && consumeQty !== lp.quantity) {
    return {
      valid: false,
      error: 'FULL_LP_REQUIRED',
      lpQty: lp.quantity,
      message: `Full LP consumption required. LP quantity is ${lp.quantity}`
    };
  }

  return { valid: true };
}

// Modified recordConsumption
async recordConsumption(data: ConsumptionData): Promise<Consumption> {
  // 1. Validate full LP consumption
  const validation = await this.validateFullLPConsumption(
    data.wo_material_id,
    data.lp_id,
    data.consume_qty
  );

  if (!validation.valid) {
    throw new FullLPRequiredError(validation.message, validation.lpQty);
  }

  // 2. Determine is_full_lp flag
  const lp = await getLicensePlate(data.lp_id);
  const isFullLP = data.consume_qty === lp.quantity;

  // 3. Record consumption with is_full_lp flag
  return await supabase
    .from('wo_material_consumptions')
    .insert({
      ...data,
      is_full_lp: isFullLP
    });
}
```

### Zod Validation Schemas

**Location:** `lib/validation/consumption-schema.ts`

```typescript
import { z } from 'zod';

// Modified consume request schema with async refinement
export const consumeRequestSchema = z.object({
  wo_material_id: z.string().uuid(),
  lp_id: z.string().uuid(),
  consume_qty: z.number().positive(),
  consume_whole_lp: z.boolean().optional(), // Passed from client for validation context
});

// Custom validation function (called in API route)
export async function validateFullLPConsumption(
  data: z.infer<typeof consumeRequestSchema>,
  lpQty: number,
  consumeWholeLP: boolean
): z.SafeParseReturnType<typeof data, typeof data> {
  if (consumeWholeLP && data.consume_qty !== lpQty) {
    return {
      success: false,
      error: new z.ZodError([{
        code: 'custom',
        path: ['consume_qty'],
        message: `Full LP consumption required. LP quantity is ${lpQty}`
      }])
    };
  }
  return { success: true, data };
}
```

## UI Components

### Pages

No new pages. Modifies existing:
- `app/(authenticated)/production/consumption/[woId]/page.tsx`
- `app/(authenticated)/scanner/consume/page.tsx`

### Components

**Location:** `components/production/consumption/`

```
FullLPRequiredBadge.tsx       - NEW: Badge indicating 1:1 requirement
ConsumptionQtyInput.tsx       - NEW: Qty input handling editable/read-only states
AddConsumptionModal.tsx       - MODIFY: Add lock behavior for consume_whole_lp
MaterialsTable.tsx            - MODIFY: Add badge display
```

**Location:** `components/scanner/`

```
NumberPad.tsx                 - MODIFY: Add disabled prop
MaterialsList.tsx             - MODIFY: Add badge display
```

### Component Details

**FullLPRequiredBadge.tsx**
```tsx
interface FullLPRequiredBadgeProps {
  size?: 'small' | 'medium';
  variant?: 'desktop' | 'scanner';
}

// Desktop: Yellow-900 bg, Yellow-300 text, 12px font
// Scanner: Yellow-600 bg, Yellow-900 text, 14px font
// Both: Lock icon (16px desktop, 20px scanner)
```

**ConsumptionQtyInput.tsx**
```tsx
interface ConsumptionQtyInputProps {
  value: number;
  onChange: (value: number) => void;
  uom: string;
  maxQty: number;
  isReadOnly: boolean;
  showLockIcon: boolean;
}

// Editable state: Slate-600 border, Slate-800 bg, text cursor
// Read-only state: Yellow-600 border, Slate-900 bg, lock icon right, not-allowed cursor
```

**NumberPad.tsx (Modified)**
```tsx
interface NumberPadProps {
  value: string;
  onChange: (value: string) => void;
  disabled?: boolean; // NEW: When true, all keys non-interactive
}

// Disabled state: 50% opacity, not-allowed cursor, onClick ignored
```

### UI States

**Desktop - consume_whole_lp=true:**
```
+------------------------------------------+
| Step 2: Enter Quantity                   |
|                                          |
| +--------------------------------------+ |
| | [!] This material requires full LP   | |
| |     consumption                      | |
| +--------------------------------------+ |
|                                          |
| Quantity:                                |
| +---------------------------+ +--------+ |
| | 100                   [L] | | kg     | |
| +---------------------------+ +--------+ |
|   (read-only, lock icon)                 |
|                                          |
|           [Cancel]  [Use All Available]  |
+------------------------------------------+
```

**Scanner - consume_whole_lp=true:**
```
+------------------------------------------+
| STEP 3: Enter Quantity                   |
|                                          |
| +--------------------------------------+ |
| | [L] Full LP Required                 | |
| +--------------------------------------+ |
|                                          |
|              +-------+                   |
|              | 500   | kg                |
|              +-------+                   |
|              (locked)                    |
|                                          |
| +---+---+---+                            |
| | 1 | 2 | 3 |  <- grayed out,           |
| +---+---+---+     50% opacity,           |
| | 4 | 5 | 6 |     not clickable          |
| +---+---+---+                            |
| | 7 | 8 | 9 |                            |
| +---+---+---+                            |
| | . | 0 | < |                            |
| +---+---+---+                            |
|                                          |
| [Full Consumption (500 kg)]              |
+------------------------------------------+
```

**Materials Table Badge:**
```
+--------------------------------------------------+
| Material        | Required | Consumed | Progress |
+--------------------------------------------------+
| Flour           | 100 kg   | 60 kg    | [====--] |
| Water [L] Full  | 50 L     | 0 L      | [------] |
|  LP Required    |          |          |          |
| Sugar           | 25 kg    | 25 kg    | [======] |
+--------------------------------------------------+
```

### Hooks

**useConsumeWholeLPCheck.ts**
```typescript
interface UseConsumeWholeLPCheckResult {
  consumeWholeLP: boolean;
  isLoading: boolean;
}

function useConsumeWholeLPCheck(materialId: string): UseConsumeWholeLPCheckResult;
```

## Test Cases

### Unit Tests

**consumption-service.test.ts**
```typescript
describe('ConsumptionService', () => {
  describe('validateFullLPConsumption', () => {
    it('returns error when partial qty for consume_whole_lp=true');
    it('returns success when full qty for consume_whole_lp=true');
    it('allows partial qty for consume_whole_lp=false');
  });

  describe('recordConsumption', () => {
    it('sets is_full_lp=true when full LP consumed');
    it('throws FullLPRequiredError when partial qty for consume_whole_lp=true');
    it('calculates variance when LP.qty differs from required');
  });
});
```

**FullLPRequiredBadge.test.tsx**
```typescript
describe('FullLPRequiredBadge', () => {
  it('renders lock icon');
  it('uses Yellow-900 bg, Yellow-300 text for desktop variant');
  it('uses Yellow-600 bg, Yellow-900 text for scanner variant');
  it('has aria-label="Full LP Required"');
});
```

**NumberPad.test.tsx**
```typescript
describe('NumberPad', () => {
  it('disables all keys when disabled=true');
  it('applies 50% opacity when disabled');
  it('ignores key clicks when disabled');
  it('works normally when disabled=false');
});
```

### Integration Tests

**full-lp-api.test.ts**
```typescript
describe('Full LP Consumption API', () => {
  describe('POST /consume', () => {
    it('returns 400 FULL_LP_REQUIRED when partial qty for consume_whole_lp=true');
    it('returns 201 success when full qty for consume_whole_lp=true');
    it('allows partial when consume_whole_lp=false');
    it('records variance when LP.qty differs from required');
    it('sets is_full_lp=true in consumption record');
  });
});
```

### E2E Tests

**one-to-one-consumption.spec.ts**
```typescript
describe('1:1 Consumption Enforcement', () => {
  describe('Desktop', () => {
    it('displays Full LP Required badge on materials with consume_whole_lp=true');
    it('locks qty input when LP selected for consume_whole_lp=true material');
    it('shows warning banner when attempting to edit locked qty');
    it('pre-fills qty input with LP.qty');
    it('displays lock icon on read-only qty input');
  });

  describe('Scanner', () => {
    it('displays Full LP Required badge in materials list');
    it('pre-fills qty with LP.qty when LP scanned');
    it('disables number pad (grayed out, 50% opacity)');
    it('ignores number pad key taps');
    it('Full Consumption button works correctly');
  });

  describe('Error Handling', () => {
    it('displays error when partial qty submitted via API bypass');
    it('error message includes LP quantity');
  });

  describe('Variance', () => {
    it('records variance when LP.qty differs from required');
    it('shows variance percentage in materials table');
  });
});
```

## Use Cases

| Use Case | Example | Behavior |
|----------|---------|----------|
| Allergen-Sensitive Materials | Peanut flour 25kg LP | Must consume entire LP to prevent cross-contamination |
| Traceability Requirements | Organic ingredients | Complete LP consumption for certification compliance |
| Sealed Packaging | Box of 5000 bags | Cannot partially use, must consume entire box |

## Error Handling

| Error Code | HTTP Status | Message | User Action |
|------------|-------------|---------|-------------|
| FULL_LP_REQUIRED | 400 | Full LP consumption required. LP quantity is {qty} | Enter full LP qty or select different LP |

**Frontend Handling:**
- Desktop: Show error banner, highlight qty input, suggest "Use All Available"
- Scanner: Show error message, highlight "Full Consumption" button

## Security Considerations

1. **Validation at API Level**
   - Cannot bypass UI lock via direct API calls
   - Server-side validation before processing

2. **Audit Trail**
   - All consumptions logged with `is_full_lp` flag
   - Variance recorded for traceability

3. **No Override Without Permission**
   - Current implementation does not allow overrides
   - Future story may add manager override capability

## Performance Considerations

- Badge render time: < 50ms
- Full LP validation response: < 100ms
- No additional database queries (uses existing data from LP selection)

## Accessibility

- `aria-label="Full LP Required"` on badge
- `aria-disabled="true"` on disabled number pad
- `aria-describedby` linking qty input to warning message
- Focus management when qty input becomes read-only

## Deliverables

- [ ] `validateFullLPConsumption` service method
- [ ] Modified `recordConsumption` with full LP validation
- [ ] Modified POST /consume API with FULL_LP_REQUIRED error
- [ ] `FullLPRequiredBadge` component (desktop + scanner variants)
- [ ] `ConsumptionQtyInput` component with read-only state
- [ ] Modified `NumberPad` with disabled prop
- [ ] Modified `AddConsumptionModal` with lock behavior
- [ ] Modified `MaterialsTable` with badge display
- [ ] Modified `MaterialsList` (scanner) with badge display
- [ ] `useConsumeWholeLPCheck` hook
- [ ] Unit tests (>90% coverage)
- [ ] Integration tests
- [ ] E2E tests

## Definition of Done

- [ ] Partial consumption blocked when `consume_whole_lp=true`
- [ ] Error message "Full LP consumption required. LP quantity is X" displays correctly
- [ ] Full qty consumption succeeds with `is_full_lp=true` recorded
- [ ] Partial consumption allowed when `consume_whole_lp=false`
- [ ] Scanner qty pre-filled and number pad disabled for `consume_whole_lp=true`
- [ ] Desktop qty pre-filled and read-only for `consume_whole_lp=true`
- [ ] Warning banner displays on desktop when qty locked
- [ ] "Full LP Required" badge displays on materials with flag
- [ ] Badge uses correct colors for desktop vs scanner variants
- [ ] Lock icon displays on read-only qty inputs
- [ ] Variance calculated when LP.qty differs from required
- [ ] API returns 400 FULL_LP_REQUIRED for invalid requests
- [ ] Unit test coverage >= 90%
- [ ] Integration tests pass
- [ ] E2E tests pass
- [ ] Accessibility requirements met
