# 04.6a - Material Consumption Desktop

**Story ID:** 04.6a
**Epic:** 04 - Production
**Phase:** 1 (MVP)
**Complexity:** L (Large)
**Estimate:** 4 days
**Type:** Full-stack
**State:** ready
**Priority:** P0

**Primary PRD:** `docs/1-BASELINE/product/modules/PRODUCTION.md` (FR-PROD-006, FR-PROD-008, FR-PROD-009, FR-PROD-010)
**UX Wireframes:** PROD-003 (Material Consumption)

## PRD References

| FR ID | Requirement | Priority | Phase | Covered |
|-------|-------------|----------|-------|---------|
| FR-PROD-006 | Material Consumption (Desktop) | P0 | MVP | Yes |
| FR-PROD-008 | 1:1 Consumption Enforcement | P0 | MVP | Partial |
| FR-PROD-009 | Consumption Correction | P0 | MVP | Yes |
| FR-PROD-010 | Over-Consumption Control | P0 | MVP | Partial |

## User Story

**As a** production operator,
**I want** to consume materials from License Plates via a desktop interface,
**So that** I can record material usage during production with proper validation and traceability.

**As a** production manager,
**I want** to view consumption history and reverse incorrect consumptions,
**So that** I can correct mistakes while maintaining audit trail integrity.

## Goal

Implement desktop-based material consumption workflow for work order execution. Operators can select materials from WO requirements, search/scan LP barcodes, enter consumption quantities, and confirm with full validation. The system updates LP quantities, records consumption history with genealogy tracking, and allows manager-only reversal capability.

## Scope

**In scope:**
- Materials table with consumption progress display
- LP validation on selection (exists, available, product match, UoM match)
- Quantity validation (cannot exceed LP quantity)
- Consumption recording with LP quantity update
- Consumption history with reversal (Manager only)
- Full LP status update when depleted
- Progress bars and variance indicators
- "Full LP Required" badge for consume_whole_lp materials

**Out of scope:**
- Scanner/mobile consumption workflow (04.6b)
- Full LP consumption enforcement logic (04.6c)
- Over-consumption approval workflow (04.6d)
- Material reservations integration (04.6e)
- Genealogy record creation (handled in separate story)

## Dependencies

| Story | Requirement | Status |
|-------|-------------|--------|
| 01.1 | Org Context + Base RLS | Required - provides auth context |
| 04.5 | Production Settings | Required - allow_over_consumption, allow_partial_lp_consumption settings |
| 03.11a | WO Materials | Required - wo_materials table, consume_whole_lp flag |
| 05.1 | License Plates Table | Required - LP status management |
| 05.6 | LP Transactions | Soft - audit trail (optional) |

**Blocks:**
- 04.6b (Scanner uses same service layer and API)
- 04.6c (Full LP consumption builds on base consumption)

## Acceptance Criteria (Given/When/Then)

### LP Validation

#### AC-04.6a-001: LP Not Found
- GIVEN LP does not exist in system, WHEN user enters LP barcode in search, THEN error "LP not found" displays within 500ms.

#### AC-04.6a-002: LP Not Available
- GIVEN LP status is "consumed", WHEN user selects LP for consumption, THEN error "LP is not available (status: consumed)" displays with LP details.

#### AC-04.6a-003: Product Mismatch
- GIVEN LP.product_id does not match material.product_id, WHEN user selects LP, THEN error "Product mismatch: LP contains X, material requires Y" displays.

#### AC-04.6a-004: UoM Mismatch
- GIVEN LP.uom does not match material.uom, WHEN user attempts consumption, THEN error "UoM mismatch: LP is X, material requires Y" displays.

### Quantity Validation

#### AC-04.6a-005: Insufficient Quantity
- GIVEN LP.qty is 30 and user enters 50, WHEN user submits consumption, THEN error "Insufficient quantity: LP has 30 kg, requested 50 kg" displays.

### Consumption Recording

#### AC-04.6a-006: Successful Consumption
- GIVEN valid consumption with qty 40 from LP with 100, WHEN user confirms consumption, THEN LP.qty becomes 60, wo_material_consumptions record created, wo_materials.consumed_qty increased by 40.

#### AC-04.6a-007: LP Depletion
- GIVEN consumption fully depletes LP (consume_qty equals LP.qty), WHEN user confirms consumption, THEN LP.status becomes "consumed", LP.qty becomes 0.

### UI Display

#### AC-04.6a-008: Full LP Required Badge
- GIVEN material with consume_whole_lp is true, WHEN material displays in table, THEN "Full LP Required" badge with lock icon displays next to material name.

## Technical Specification

### Database Schema

#### wo_material_consumptions table

```sql
CREATE TABLE wo_material_consumptions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  wo_id UUID NOT NULL REFERENCES work_orders(id) ON DELETE CASCADE,
  wo_material_id UUID NOT NULL REFERENCES wo_materials(id) ON DELETE CASCADE,
  lp_id UUID NOT NULL REFERENCES license_plates(id),
  product_id UUID NOT NULL REFERENCES products(id),

  -- Consumption details
  consumed_qty DECIMAL(15,6) NOT NULL CHECK (consumed_qty > 0),
  uom TEXT NOT NULL,
  is_full_lp BOOLEAN DEFAULT false,

  -- Denormalized for history display
  lp_batch_number TEXT,
  lp_expiry_date DATE,

  -- Audit fields
  consumed_by UUID REFERENCES users(id),
  consumed_at TIMESTAMPTZ DEFAULT NOW(),

  -- Reversal fields
  status TEXT DEFAULT 'active' CHECK (status IN ('active', 'reversed')),
  reversed_at TIMESTAMPTZ,
  reversed_by UUID REFERENCES users(id),
  reversal_reason TEXT,

  -- Timestamps
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Indexes
CREATE INDEX idx_consumption_org ON wo_material_consumptions(org_id);
CREATE INDEX idx_consumption_wo ON wo_material_consumptions(wo_id);
CREATE INDEX idx_consumption_lp ON wo_material_consumptions(lp_id);
CREATE INDEX idx_consumption_material ON wo_material_consumptions(wo_material_id);
CREATE INDEX idx_consumption_status ON wo_material_consumptions(status);
CREATE INDEX idx_consumption_consumed_at ON wo_material_consumptions(consumed_at DESC);
```

#### Triggers

```sql
-- Update wo_materials.consumed_qty on new consumption
CREATE OR REPLACE FUNCTION update_wo_material_consumed_qty()
RETURNS TRIGGER AS $$
BEGIN
  UPDATE wo_materials
  SET consumed_qty = consumed_qty + NEW.consumed_qty,
      updated_at = NOW()
  WHERE id = NEW.wo_material_id;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_update_wo_material_consumed_qty
AFTER INSERT ON wo_material_consumptions
FOR EACH ROW EXECUTE FUNCTION update_wo_material_consumed_qty();

-- Update LP quantity on consumption
CREATE OR REPLACE FUNCTION update_lp_quantity_on_consumption()
RETURNS TRIGGER AS $$
BEGIN
  UPDATE license_plates
  SET quantity = quantity - NEW.consumed_qty,
      status = CASE WHEN quantity - NEW.consumed_qty <= 0 THEN 'consumed' ELSE status END,
      updated_at = NOW()
  WHERE id = NEW.lp_id;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_update_lp_quantity
AFTER INSERT ON wo_material_consumptions
FOR EACH ROW EXECUTE FUNCTION update_lp_quantity_on_consumption();
```

### RLS Policies

```sql
-- Org isolation
CREATE POLICY "wo_material_consumptions_org_isolation" ON wo_material_consumptions
FOR ALL USING (org_id = get_user_org_id())
WITH CHECK (org_id = get_user_org_id());

-- Select access
CREATE POLICY "wo_material_consumptions_select" ON wo_material_consumptions
FOR SELECT USING (
  org_id = get_user_org_id()
  AND (SELECT r.code FROM roles r JOIN users u ON u.role_id = r.id WHERE u.id = auth.uid())
  IN ('owner', 'admin', 'production_manager', 'production_operator', 'planner')
);

-- Insert access
CREATE POLICY "wo_material_consumptions_insert" ON wo_material_consumptions
FOR INSERT WITH CHECK (
  org_id = get_user_org_id()
  AND (SELECT r.code FROM roles r JOIN users u ON u.role_id = r.id WHERE u.id = auth.uid())
  IN ('owner', 'admin', 'production_manager', 'production_operator')
);

-- Update access (reverse - managers only)
CREATE POLICY "wo_material_consumptions_update_reverse" ON wo_material_consumptions
FOR UPDATE USING (
  org_id = get_user_org_id()
  AND (SELECT r.code FROM roles r JOIN users u ON u.role_id = r.id WHERE u.id = auth.uid())
  IN ('owner', 'admin', 'production_manager')
);
```

### API Endpoints

```
# Materials List
GET    /api/production/work-orders/:woId/materials
       - List WO materials with consumption progress
       - Query: filter (all|partial|completed|over-consumed), sort (sequence|name|progress)
       - Returns: materials array with progress data

# Consume Material
POST   /api/production/work-orders/:woId/consume
       - Record material consumption from LP
       - Body: { wo_material_id, lp_id, consume_qty }
       - Returns: consumption record, updated LP, material progress

# Consumption History
GET    /api/production/work-orders/:woId/consumptions
       - List consumption history for WO
       - Query: page, limit, status (all|active|reversed)
       - Returns: paginated consumptions array

# Reverse Consumption (Manager only)
POST   /api/production/work-orders/:woId/consumptions/:id/reverse
       - Reverse a consumption
       - Body: { reason, notes }
       - Returns: reversed consumption, restored LP
```

### Service Methods

**Location:** `lib/services/consumption-service.ts`

```typescript
interface ConsumptionService {
  // Validation
  validateLP(lpId: string, materialId: string): Promise<LPValidationResult>;

  // Operations
  recordConsumption(
    woId: string,
    woMaterialId: string,
    lpId: string,
    consumeQty: number
  ): Promise<ConsumptionResult>;

  reverseConsumption(
    consumptionId: string,
    reason: string,
    notes?: string
  ): Promise<ReversalResult>;

  // Queries
  getWOMaterials(
    woId: string,
    filter?: MaterialFilter,
    sort?: MaterialSort
  ): Promise<WOMaterial[]>;

  getConsumptionHistory(
    woId: string,
    page: number,
    limit: number,
    status?: ConsumptionStatus
  ): Promise<ConsumptionHistoryPage>;
}

interface LPValidationResult {
  valid: boolean;
  error?: 'LP_NOT_FOUND' | 'LP_NOT_AVAILABLE' | 'PRODUCT_MISMATCH' | 'UOM_MISMATCH';
  lp?: LicensePlate;
  message?: string;
}

interface ConsumptionResult {
  consumption: WOMaterialConsumption;
  lp_updated: { id: string; new_qty: number; new_status: string };
  material_progress: { consumed: number; required: number; percentage: number };
}

interface ReversalResult {
  success: boolean;
  lp_restored: { id: string; new_qty: number; new_status: string };
  consumption: { id: string; status: string; reversed_at: string; reversed_by: string };
}
```

### Zod Validation Schemas

**Location:** `lib/validation/consumption-schema.ts`

```typescript
import { z } from 'zod';

// Consume request
export const consumeRequestSchema = z.object({
  wo_material_id: z.string().uuid('Invalid material ID'),
  lp_id: z.string().uuid('Invalid LP ID'),
  consume_qty: z.number().positive('Quantity must be positive'),
});

// Reverse request
export const reverseRequestSchema = z.object({
  reason: z.string().min(1, 'Reason is required').max(500),
  notes: z.string().max(1000).optional(),
});

// Query params
export const materialsQuerySchema = z.object({
  filter: z.enum(['all', 'partial', 'completed', 'over-consumed']).optional(),
  sort: z.enum(['sequence', 'name', 'progress']).optional(),
});

export const consumptionsQuerySchema = z.object({
  page: z.coerce.number().min(1).default(1),
  limit: z.coerce.number().min(1).max(100).default(20),
  status: z.enum(['all', 'active', 'reversed']).optional(),
});
```

## UI Components

### Pages

- `app/(authenticated)/production/consumption/[woId]/page.tsx` - Material consumption page

### Components

**Location:** `components/production/consumption/`

```
MaterialsTable.tsx           - Required materials table with progress bars
ConsumptionHistoryTable.tsx  - Consumption history with reversal capability
AddConsumptionModal.tsx      - Two-step modal for LP selection and qty entry
ReverseConsumptionModal.tsx  - Confirmation modal for reversing consumption
LPSearchInput.tsx            - LP barcode search/scan input component
WOSummaryCard.tsx            - Work order summary header card
```

### Component Details

**MaterialsTable.tsx**
```tsx
interface MaterialsTableProps {
  woId: string;
  materials: WOMaterial[];
  onConsume: (materialId: string) => void;
}

// Features:
// - Progress bar per material (consumed/required)
// - Variance percentage display with color coding
// - 'Full LP Required' badge for consume_whole_lp=true
// - Over-consumed warning indicator
// - [+] button to open AddConsumptionModal

// Columns:
// - Sequence (#)
// - Component (name, SKU, type)
// - Required (qty + uom)
// - Consumed (qty)
// - Remaining (qty)
// - Progress (bar + %)
// - Variance (% with color)
// - Actions ([+] consume)
```

**AddConsumptionModal.tsx**
```tsx
interface AddConsumptionModalProps {
  woId: string;
  material: WOMaterial;
  open: boolean;
  onClose: () => void;
  onSuccess: (consumption: Consumption) => void;
}

// Two-step wizard:
// Step 1: Select License Plate
//   - WO context card (WO number, material, required/consumed/remaining)
//   - LP barcode search input with scan button
//   - Available LPs table (filtered by product, status=available)
//   - FIFO order by expiry date

// Step 2: Confirm Quantity
//   - LP validated card (number, product, batch, expiry, location, qty)
//   - Qty input field with UoM
//   - 'Use All Available' button
//   - Consumption summary card
//   - LP status after preview
```

**ConsumptionHistoryTable.tsx**
```tsx
interface ConsumptionHistoryTableProps {
  woId: string;
  consumptions: Consumption[];
  canReverse: boolean;
  onReverse: (consumptionId: string) => void;
}

// Features:
// - LP number, material, qty, timestamp, user
// - Batch and expiry info
// - Status badge (Active/Reversed)
// - 'Full LP' indicator
// - [Rev] button for managers only
// - Pagination

// Columns:
// - LP Number
// - Material
// - Qty
// - Consumed At
// - Consumed By
// - Status
// - Actions ([Rev] if manager)
```

**ReverseConsumptionModal.tsx**
```tsx
interface ReverseConsumptionModalProps {
  consumption: Consumption;
  open: boolean;
  onClose: () => void;
  onConfirm: (reason: string, notes: string) => void;
}

// Content:
// - Consumption details (read-only)
// - Warning box explaining reversal effects
// - Reason dropdown (predefined options)
// - Additional notes textarea
// - Cancel and Confirm buttons
```

### Hooks

**Location:** `lib/hooks/`

```typescript
// useWOMaterials.ts - Fetch and manage WO materials state
// useConsumptionHistory.ts - Fetch paginated consumption history
// useConsumption.ts - Mutation hook for recording/reversing consumption
```

### UI States

| State | Description | Display |
|-------|-------------|---------|
| loading | Initial data load | Skeleton loaders for tables and cards |
| empty (no materials) | WO has no materials defined | "No materials defined for this work order" |
| empty (no consumptions) | No consumption history | "No consumptions recorded yet" |
| error | API errors and validation | Toast notification + inline error messages |
| success | Successful consumption/reversal | Toast notification + table refresh |
| over_consumed_warning | Material > required | Yellow warning badge + variance % |

## Test Cases

### Unit Tests

**consumption-service.test.ts**
```typescript
describe('ConsumptionService', () => {
  describe('validateLP', () => {
    it('returns error when LP does not exist');
    it('returns error when LP status is consumed');
    it('returns error when product does not match');
    it('returns error when UoM does not match');
    it('returns success when all validations pass');
  });

  describe('recordConsumption', () => {
    it('decreases LP quantity');
    it('marks LP as consumed when fully depleted');
    it('increases material consumed_qty');
  });
});
```

**consumption-schema.test.ts**
```typescript
describe('consumeRequestSchema', () => {
  it('validates required fields');
  it('rejects negative quantity');
  it('accepts valid request');
});
```

### Integration Tests

**consume-api.test.ts**
```typescript
describe('POST /consume', () => {
  it('returns 400 when LP not found');
  it('returns 400 when LP not available');
  it('returns 400 when product mismatch');
  it('returns 400 when insufficient quantity');
  it('returns 201 on successful consumption');
  it('enforces RLS org isolation');
});
```

**consumptions-api.test.ts**
```typescript
describe('GET /consumptions', () => {
  it('returns paginated history');
  it('filters by status');
});

describe('POST /reverse', () => {
  it('returns 403 for non-manager');
  it('returns 200 for manager');
  it('restores LP quantity');
});
```

### E2E Tests

**material-consumption.spec.ts**
```typescript
describe('Material Consumption Desktop', () => {
  it('Operator consumes material from LP');
  it('Manager reverses incorrect consumption');
  it('Validation error displays when LP product mismatch');
  it('Full LP Required badge displays for 1:1 materials');
});
```

### Performance Targets

| Metric | Target | Test |
|--------|--------|------|
| LP validation response time | < 500ms | Measure time from LP scan to validation result |
| Consumption recording time | < 2s | Measure time from Confirm click to success toast |
| Materials table load time | < 1s | Measure time to load and render materials table |

## Security Considerations

1. **Role-Based Access**
   - Consumption recording: owner, admin, production_manager, production_operator
   - Consumption reversal: owner, admin, production_manager only

2. **RLS Enforcement**
   - All queries filtered by org_id
   - Cross-tenant access returns 404 (not 403)

3. **Audit Trail**
   - All consumptions tracked with user and timestamp
   - Reversals include reason and notes
   - LP history maintained

## Deliverables

- [ ] `wo_material_consumptions` table migration (120_create_wo_material_consumptions.sql)
- [ ] RLS policies for wo_material_consumptions
- [ ] Consumption service (`lib/services/consumption-service.ts`)
- [ ] Zod schemas (`lib/validation/consumption-schema.ts`)
- [ ] GET /api/production/work-orders/:woId/materials route
- [ ] POST /api/production/work-orders/:woId/consume route
- [ ] GET /api/production/work-orders/:woId/consumptions route
- [ ] POST /api/production/work-orders/:woId/consumptions/:id/reverse route
- [ ] MaterialsTable component
- [ ] ConsumptionHistoryTable component
- [ ] AddConsumptionModal component
- [ ] ReverseConsumptionModal component
- [ ] LPSearchInput component
- [ ] WOSummaryCard component
- [ ] useWOMaterials hook
- [ ] useConsumptionHistory hook
- [ ] useConsumption hook
- [ ] Consumption page (`/production/consumption/:woId`)
- [ ] Unit tests (>80% coverage)
- [ ] Integration tests
- [ ] E2E tests

## Definition of Done

- [ ] LP validation checks all 4 conditions (exists, available, product, UoM)
- [ ] Quantity validation prevents over-LP consumption
- [ ] Consumption updates LP qty and wo_materials.consumed_qty
- [ ] LP status changes to "consumed" when depleted
- [ ] Materials table shows progress bars and variance
- [ ] "Full LP Required" badge displays for consume_whole_lp materials
- [ ] Consumption history displays with pagination
- [ ] Reversal only available for managers
- [ ] Reversal restores LP quantity and status
- [ ] All validation errors display within 500ms
- [ ] RLS enforces org isolation
- [ ] Unit test coverage >= 80%
- [ ] Integration tests pass
- [ ] E2E tests pass
- [ ] Performance targets met
