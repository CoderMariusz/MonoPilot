# Story 04.2a - Frontend Specification
# Purpose: Components, hooks, types, UI patterns
# Agent: FRONTEND-DEV (UI focus)

# UX Reference
ux:
  wireframes:
    - id: "PROD-002"
      path: "docs/3-ARCHITECTURE/ux/wireframes/PROD-002-wo-execution-detail.md"
      sections:
        - "4.1 Start WO Modal"
        - "Section 3 Action Bar"
      components:
        - "Start WO Button"
        - "Start WO Modal"
        - "Material Availability List"
        - "Line Selector Dropdown"
  patterns:
    modal: "ShadCN Dialog pattern"
    button: "ShadCN Button with loading state"
    select: "ShadCN Select/Dropdown"
    progress: "ShadCN Progress for availability bars"
    toast: "ShadCN Toast for success/error notifications"
    badge: "ShadCN Badge for status display"
  states:
    - loading: "Skeleton loader during data fetch"
    - empty: "N/A for this story"
    - error: "Error message with retry button"
    - success: "Toast notification on successful start"

# TypeScript Types
types:
  - path: "apps/frontend/lib/types/production-execution.ts"
    content: |
      export interface StartWorkOrderOptions {
        line_id?: string;
        machine_id?: string;
        force?: boolean;
      }

      export interface StartWorkOrderResponse {
        id: string;
        wo_number: string;
        status: 'in_progress';
        started_at: string;
        started_by: string;
        production_line_id: string | null;
        machine_id: string | null;
        product_name: string;
        planned_qty: number;
        line_name: string | null;
      }

      export interface ValidationResult {
        allowed: boolean;
        reason?: string;
        warnings?: string[];
      }

      export interface MaterialAvailability {
        wo_id: string;
        overall_availability_percent: number;
        materials: MaterialAvailabilityItem[];
      }

      export interface MaterialAvailabilityItem {
        wo_material_id: string;
        product_id: string;
        product_name: string;
        required_qty: number;
        available_qty: number;
        availability_percent: number;
        uom: string;
      }

      export interface LineAvailability {
        available: boolean;
        current_wo?: string;
      }

      export type WOStatus = 'draft' | 'released' | 'in_progress' | 'paused' | 'completed' | 'cancelled';

# Hooks
hooks:
  - path: "apps/frontend/lib/hooks/use-start-work-order.ts"
    description: "React Query mutation hook for starting WO"
    exports:
      - name: "useStartWorkOrder"
        returns: "UseMutationResult"
    pattern: |
      import { useMutation, useQueryClient } from '@tanstack/react-query';
      import { startWorkOrder, StartWorkOrderOptions } from '@/lib/services/production-execution-service';
      import { toast } from 'sonner';

      export function useStartWorkOrder() {
        const queryClient = useQueryClient();

        return useMutation({
          mutationFn: ({ woId, options }: { woId: string; options?: StartWorkOrderOptions }) =>
            startWorkOrder(woId, options),
          onSuccess: (data) => {
            toast.success(`Work Order ${data.wo_number} started successfully`);
            queryClient.invalidateQueries({ queryKey: ['work-orders'] });
            queryClient.invalidateQueries({ queryKey: ['work-order', data.id] });
          },
          onError: (error: Error) => {
            toast.error(error.message);
          },
        });
      }

  - path: "apps/frontend/lib/hooks/use-material-availability.ts"
    description: "React Query hook for fetching material availability"
    exports:
      - name: "useMaterialAvailability"
        returns: "UseQueryResult<MaterialAvailability>"
    pattern: |
      import { useQuery } from '@tanstack/react-query';
      import { checkMaterialAvailability, MaterialAvailability } from '@/lib/services/production-execution-service';

      export function useMaterialAvailability(woId: string, enabled: boolean = true) {
        return useQuery<MaterialAvailability>({
          queryKey: ['material-availability', woId],
          queryFn: () => checkMaterialAvailability(woId),
          enabled,
          staleTime: 30 * 1000, // 30 seconds
        });
      }

# Components
components:
  - path: "apps/frontend/components/production/work-orders/StartWorkOrderButton.tsx"
    description: "Start Production button with permission check"
    props:
      - "workOrder: WorkOrder"
      - "onStartClick: () => void"
    pattern: |
      'use client';
      import { Button } from '@/components/ui/button';
      import { Play } from 'lucide-react';
      import { useOrgContext } from '@/lib/hooks/use-org-context';
      import { hasPermission } from '@/lib/services/permission-service';
      import { Tooltip, TooltipContent, TooltipTrigger } from '@/components/ui/tooltip';

      interface StartWorkOrderButtonProps {
        workOrder: {
          id: string;
          status: string;
        };
        onStartClick: () => void;
      }

      export function StartWorkOrderButton({ workOrder, onStartClick }: StartWorkOrderButtonProps) {
        const { data: context } = useOrgContext();
        const canStart = context && hasPermission(context, 'production', 'U');
        const isReleased = workOrder.status === 'released';

        if (!canStart) return null;

        if (!isReleased) {
          return (
            <Tooltip>
              <TooltipTrigger asChild>
                <span>
                  <Button disabled variant="outline">
                    <Play className="mr-2 h-4 w-4" />
                    Start Production
                  </Button>
                </span>
              </TooltipTrigger>
              <TooltipContent>
                <p>WO must be Released to start</p>
              </TooltipContent>
            </Tooltip>
          );
        }

        return (
          <Button onClick={onStartClick} variant="default">
            <Play className="mr-2 h-4 w-4" />
            Start Production
          </Button>
        );
      }

  - path: "apps/frontend/components/production/work-orders/StartWorkOrderModal.tsx"
    description: "Confirmation modal with WO summary and material availability"
    props:
      - "workOrder: WorkOrder"
      - "open: boolean"
      - "onOpenChange: (open: boolean) => void"
      - "onConfirm: (options: StartWorkOrderOptions) => void"
      - "isLoading: boolean"
    pattern: |
      'use client';
      import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from '@/components/ui/dialog';
      import { Button } from '@/components/ui/button';
      import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
      import { Alert, AlertDescription } from '@/components/ui/alert';
      import { MaterialAvailabilityCard } from './MaterialAvailabilityCard';
      import { LineAvailabilityWarning } from './LineAvailabilityWarning';
      import { useMaterialAvailability } from '@/lib/hooks/use-material-availability';
      import { Loader2, AlertTriangle } from 'lucide-react';

      // ... component implementation with:
      // - WO summary display (WO Number, Product, Planned Qty, Line)
      // - Line selection dropdown (optional override)
      // - Machine selection dropdown (optional)
      // - Material availability list with progress bars
      // - Warning banner if availability < 100%
      // - Line in use warning (if applicable)
      // - Confirm/Cancel buttons

  - path: "apps/frontend/components/production/work-orders/MaterialAvailabilityCard.tsx"
    description: "Material list with availability percentages and progress bars"
    props:
      - "materials: MaterialAvailabilityItem[]"
      - "overallPercent: number"
    pattern: |
      'use client';
      import { Progress } from '@/components/ui/progress';
      import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
      import { AlertTriangle, CheckCircle } from 'lucide-react';
      import { cn } from '@/lib/utils';

      // Shows each material with:
      // - Material name
      // - Required qty
      // - Available qty
      // - Progress bar (green >= 100%, yellow 80-99%, red < 80%)
      // - Availability percentage

  - path: "apps/frontend/components/production/work-orders/LineAvailabilityWarning.tsx"
    description: "Warning banner when line is already in use"
    props:
      - "lineId: string"
      - "currentWO: string | undefined"
    pattern: |
      'use client';
      import { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert';
      import { AlertTriangle } from 'lucide-react';

      // Shows warning: "Line already in use by WO-XXX. Continue?"

  - path: "apps/frontend/components/production/work-orders/WorkOrderStatusBadge.tsx"
    description: "Status badge with appropriate colors"
    props:
      - "status: WOStatus"
    pattern: |
      'use client';
      import { Badge } from '@/components/ui/badge';

      const statusConfig = {
        draft: { label: 'Draft', variant: 'secondary', className: 'bg-gray-100 text-gray-800' },
        released: { label: 'Released', variant: 'secondary', className: 'bg-blue-100 text-blue-800' },
        in_progress: { label: 'In Progress', variant: 'default', className: 'bg-green-100 text-green-800' },
        paused: { label: 'Paused', variant: 'secondary', className: 'bg-yellow-100 text-yellow-800' },
        completed: { label: 'Completed', variant: 'secondary', className: 'bg-purple-100 text-purple-800' },
        cancelled: { label: 'Cancelled', variant: 'destructive', className: 'bg-red-100 text-red-800' },
      };

  - path: "apps/frontend/components/production/work-orders/WorkOrderActions.tsx"
    description: "Action buttons container (Start, Pause, Complete)"
    props:
      - "workOrder: WorkOrder"
    pattern: |
      // Container for action buttons based on WO status
      // This story implements Start button only

# Pages (modification to existing)
pages:
  - path: "apps/frontend/app/(authenticated)/production/work-orders/[id]/page.tsx"
    description: "WO detail page - add Start button and modal"
    modifications:
      - "Add StartWorkOrderButton to action bar"
      - "Add StartWorkOrderModal with state management"
      - "Handle start mutation and success/error states"
      - "Refresh WO data after successful start"

# Component File Structure
file_structure: |
  apps/frontend/
    app/(authenticated)/production/work-orders/[id]/
      page.tsx                          -- WO detail page with Start button

    components/production/work-orders/
      WorkOrderHeader.tsx               -- WO summary with status badge
      WorkOrderActions.tsx              -- Action buttons (Start, Pause, Complete)
      StartWorkOrderButton.tsx          -- Start button with permission check
      StartWorkOrderModal.tsx           -- Confirmation modal with summary
      MaterialAvailabilityCard.tsx      -- Material list with availability %
      LineAvailabilityWarning.tsx       -- Warning if line in use
      WorkOrderStatusBadge.tsx          -- Status badge with colors

    lib/services/
      production-execution-service.ts   -- Service functions

    lib/hooks/
      use-start-work-order.ts           -- Mutation hook
      use-material-availability.ts      -- Query hook

    lib/types/
      production-execution.ts           -- TypeScript interfaces

    lib/validation/
      production-execution.ts           -- Zod schemas

# UI/UX Notes
ui_notes:
  status_badge_colors:
    draft: "bg-gray-100 text-gray-800"
    released: "bg-blue-100 text-blue-800"
    in_progress: "bg-green-100 text-green-800"
    paused: "bg-yellow-100 text-yellow-800"
    completed: "bg-purple-100 text-purple-800"
    cancelled: "bg-red-100 text-red-800"

  material_availability_colors:
    full: "green (>= 100%)"
    partial: "yellow (80-99%)"
    low: "red (< 80%)"

  loading_states:
    button: "Show spinner icon, disable button during mutation"
    modal: "Show skeleton loader while fetching material availability"

  error_handling:
    validation: "Show error message in modal"
    network: "Show toast notification with retry option"
    conflict: "Show warning banner in modal with proceed option"

  accessibility:
    keyboard_nav: "Tab through form fields and buttons"
    aria_labels: "All buttons and interactive elements have labels"
    focus_management: "Return focus to trigger button after modal closes"
    screen_reader: "Status changes announced"

  responsive:
    desktop: "Modal with side-by-side layout"
    tablet: "Modal with stacked layout"
    mobile: "Full-screen modal with stacked cards"
