# 04.2c - WO Complete (Execution End)

**Priority**: P0 (MVP Core - Phase 0)
**Story Points**: M (3-4 days)
**Type:** backend + frontend

**State:** ready
**Primary PRD:** `docs/1-BASELINE/product/modules/production.md` (FR-PROD-005)
**Architecture:** `docs/1-BASELINE/architecture/modules/production.md`

---

## MVP Scope

This story implements the **WO completion workflow WITHOUT output validation**. In Phase 0, operators can complete a WO based on time/operations tracking only. Output registration validation is deferred to Story 04.7 (Phase 1) when License Plates are available.

**Phase 0 Scope (This Story):**
- Manual WO completion with status transition
- Timestamp tracking (completed_at, completed_by)
- Yield calculation (produced_qty / planned_qty * 100)
- Auto-complete based on setting (simplified - no output validation)
- Operation sequence validation (if enabled)
- Release material reservations (placeholder for Phase 1)
- UI: Complete WO button with validation modal

**Deferred to Phase 1 (Story 04.7):**
- Output registration requirement validation
- By-product registration validation
- Actual produced quantity from output LPs

---

## LP Dependency Status

- [x] NO LP dependency - can proceed immediately
- [ ] REQUIRES Epic 05 - defer to Phase 1

**Rationale:** Phase 0 completion is based on WO metadata and operations tracking only. Output validation requires `production_outputs` table which links to `license_plates` (Epic 05), so output-based validation is deferred to Phase 1.

---

## Goal

Enable production operators to manually complete Work Orders with proper status transitions, yield tracking, and validation, while deferring output-based validation until License Plates are available in Phase 1.

## User Story

As a **production operator**, I want to **complete a Work Order after production finishes** so that **the system records completion time, calculates yield, and updates WO status to reflect that production is done**.

## Scope

**In scope (this story)**
- POST /api/production/work-orders/:id/complete endpoint
- Status transition validation (must be 'in_progress')
- Timestamp tracking (completed_at, completed_by)
- Yield calculation from WO metadata (produced_qty / planned_qty * 100)
- Operation sequence validation (if require_operation_sequence = true)
- Auto-complete option (if auto_complete_wo = true and produced_qty >= planned_qty)
- Material reservation release (no-op in Phase 0, logs placeholder)
- Complete WO button in UI
- Service layer method: completeWorkOrder()
- Unit tests (>80% coverage)
- E2E smoke test

**Out of scope (this story)**
- Output registration requirement validation → **Story 04.7a** (Phase 1)
- By-product registration validation → **Story 04.7c** (Phase 1)
- LP-based output quantity tracking → **Story 04.7a** (Phase 1)
- Consumption validation → **Story 04.6a** (Phase 1)
- OEE metrics update → **Story 04.9a** (Phase 2)
- Genealogy record closure → **Story 04.7a** (Phase 1)

## Dependencies

- **01.1** - Org Context + RLS (for multi-tenancy)
- **01.11** - Production Lines CRUD (for line assignment validation)
- **03.10** - WO CRUD (work_orders table, status field)
- **03.12** - WO Operations (wo_operations table, status tracking)
- **04.2a** - WO Start (status must be 'in_progress' to complete)
- **04.2b** - WO Pause/Resume (status validation)
- **04.5** - Production Settings (auto_complete_wo, require_operation_sequence flags)

## Acceptance Criteria (Given/When/Then)

### AC-1: Basic WO Completion

**Given** WO status = "In Progress" AND user has production role
**When** user clicks "Complete WO" and confirms
**Then** WO status changes to "Completed" within 1 second AND completed_at timestamp is set to current time (+/- 1 second) AND completed_by is set to current user's ID

### AC-2: Invalid Status Prevention

**Given** WO status = "Draft" OR "Released" OR "Paused" OR "Completed" OR "Cancelled"
**When** user attempts to complete WO
**Then** error message "WO must be In Progress to complete" displays AND WO status remains unchanged

### AC-3: Completed WO Button State

**Given** WO status = "Completed"
**When** user views WO detail page
**Then** "Complete WO" button is disabled AND displays "Already Completed"

### AC-4: Operation Sequence Validation (Enabled)

**Given** production_settings.require_operation_sequence = true AND WO has 3 operations AND Operation 2 status = "Not Started"
**When** user clicks "Complete WO"
**Then** error message "All operations must be completed before closing the WO" displays AND WO status remains "In Progress"

### AC-5: Operation Sequence Validation (Disabled)

**Given** production_settings.require_operation_sequence = false AND WO has operations with status "Not Started"
**When** user clicks "Complete WO"
**Then** WO completes successfully (no operation validation)

### AC-6: Yield Calculation

**Given** WO planned_qty = 1000 AND produced_qty = 950
**When** WO is completed
**Then** yield_percent is calculated as (950 / 1000 * 100) = 95.0 AND stored in work_orders.actual_yield_percent

### AC-7: Auto-Complete Enabled

**Given** production_settings.auto_complete_wo = true AND WO planned_qty = 1000 AND produced_qty = 1000
**When** produced_qty reaches planned_qty
**Then** WO auto-completes without user action AND status changes to "Completed" AND completed_at is set

### AC-8: Auto-Complete Disabled

**Given** production_settings.auto_complete_wo = false AND WO planned_qty = 1000 AND produced_qty = 1000
**When** produced_qty reaches planned_qty
**Then** WO remains "In Progress" (no auto-complete) AND user must manually complete

### AC-9: Timestamp Accuracy

**Given** WO is being completed
**When** completion is recorded
**Then** completed_at timestamp is set to current server time within +/- 1 second of API call

### AC-10: Permission Validation

**Given** user has role "Viewer" (no production.wo.complete permission)
**When** user attempts to complete WO
**Then** error message "You do not have permission to complete work orders" displays AND WO status remains unchanged

### AC-11: Material Reservations Release Placeholder

**Given** WO has material reservations (future Phase 1 feature)
**When** WO is completed
**Then** backend logs "Material reservation release skipped - Epic 05 required" AND no error occurs (graceful degradation)

### AC-12: Completion Confirmation Modal

**Given** WO status = "In Progress" AND all operations completed
**When** user clicks "Complete WO" button
**Then** confirmation modal displays with:
- WO Number
- Product Name
- Planned Qty vs Produced Qty
- Calculated Yield %
- Warning if yield < 80%
- "Confirm Completion" button
- "Cancel" button

### AC-13: Low Yield Warning

**Given** WO yield_percent < 80%
**When** user views completion confirmation modal
**Then** warning message "Low yield detected (XX%). Please verify before completing." displays in yellow

## Implementation Notes

### API Endpoints

```typescript
// Complete Work Order
POST /api/production/work-orders/:id/complete
Request: {
  // No body required - completion uses existing WO data
}
Response: {
  id: string;
  wo_number: string;
  status: 'completed';
  completed_at: string;
  completed_by: string;
  actual_yield_percent: number;
  message: string;
}

// Auto-complete endpoint (called internally when produced_qty >= planned_qty)
POST /api/production/work-orders/:id/auto-complete
Request: {}
Response: {
  id: string;
  wo_number: string;
  status: 'completed';
  auto_completed: true;
}
```

### Database

**Tables Used:**

```sql
-- work_orders (from Epic 03)
-- Updated fields:
status              TEXT NOT NULL           -- 'completed'
completed_at        TIMESTAMPTZ             -- Set on completion
completed_by        UUID REFERENCES users(id) -- Set to auth.uid()
actual_yield_percent DECIMAL(5,2)           -- Calculated on completion

-- wo_operations (from Epic 03)
-- Read to validate all operations completed (if setting enabled)
status              TEXT NOT NULL           -- Check all = 'completed'

-- production_settings (from Story 04.5)
-- Read to determine validation rules
auto_complete_wo              BOOLEAN DEFAULT false
require_operation_sequence    BOOLEAN DEFAULT true
```

**No new tables created in this story.**

**Migration Requirements:**
- Ensure work_orders has columns: completed_at, completed_by, actual_yield_percent
- If missing, create migration to add them (check Epic 03 migrations first)

### Frontend Components

```
app/(authenticated)/production/
  execution/
    components/
      CompleteWorkOrderButton.tsx     -- Button with permission check
      CompleteWorkOrderModal.tsx      -- Confirmation modal with validation
      WorkOrderYieldBadge.tsx         -- Display yield % with color coding
```

### Services

```typescript
// lib/services/work-order-service.ts

export async function completeWorkOrder(
  workOrderId: string
): Promise<WorkOrderCompletionResult> {
  // 1. Validate WO status = 'in_progress'
  // 2. If require_operation_sequence = true, validate all operations completed
  // 3. Calculate yield: (produced_qty / planned_qty * 100)
  // 4. Update work_orders: status = 'completed', completed_at = now(), completed_by = auth.uid()
  // 5. Log material reservation release placeholder
  // 6. Return completion result
}

export async function checkAutoComplete(
  workOrderId: string
): Promise<boolean> {
  // Called after produced_qty update
  // 1. Get production_settings.auto_complete_wo
  // 2. If false, return false
  // 3. Get WO planned_qty and produced_qty
  // 4. If produced_qty >= planned_qty, call completeWorkOrder()
  // 5. Return true if auto-completed, false otherwise
}
```

### Validation (Zod)

```typescript
// lib/validation/production-schemas.ts

const completeWorkOrderSchema = z.object({
  // No body required - uses WO ID from URL
});

// For internal auto-complete check
const autoCompleteCheckSchema = z.object({
  workOrderId: z.string().uuid(),
  producedQty: z.number().positive(),
  plannedQty: z.number().positive(),
});
```

### Key Business Rules

1. **Status Transition**: WO must be in 'in_progress' status to complete
2. **Operation Sequence**: If require_operation_sequence = true, all operations must have status = 'completed'
3. **Yield Calculation**: actual_yield_percent = (produced_qty / planned_qty * 100), rounded to 2 decimals
4. **Auto-Complete**: If auto_complete_wo = true AND produced_qty >= planned_qty, system auto-completes without user action
5. **Low Yield Warning**: If yield < 80%, show warning in confirmation modal (but allow completion)
6. **Timestamp**: completed_at uses server timestamp (now()), not client time
7. **Immutability**: Completed WOs cannot be reopened (future "Reopen WO" story in backlog)
8. **Material Reservations**: Release logic is placeholder in Phase 0 (logs message, no error)
9. **Permission**: User must have 'production.wo.complete' permission
10. **Auto-Complete Trigger**: Checked after every produced_qty update (Story 04.4)

### Phase 0 Simplifications

**Validation Skipped in Phase 0 (Added in Phase 1):**
- ❌ "At least one output registered" → **Story 04.7a** (Phase 1)
- ❌ "By-products registered if defined in BOM" → **Story 04.7c** (Phase 1)
- ❌ "Unused material reservations released" → **Story 04.6a** (Phase 1)
- ❌ "Genealogy records closed" → **Story 04.7a** (Phase 1)

**How Phase 0 Works Without Outputs:**
- Yield calculated from `work_orders.produced_qty` field (manually tracked in Story 04.4)
- Auto-complete based on manual produced_qty tracking
- Completion is purely status transition + timestamp
- All output-based validation deferred to Phase 1

### Error Handling

| Error Scenario | HTTP Status | Error Message | Action |
|----------------|-------------|---------------|--------|
| WO not found | 404 | "Work order not found" | Log, return error |
| Invalid status | 400 | "WO must be In Progress to complete" | Return error |
| Operations incomplete | 400 | "All operations must be completed" | Return error |
| Permission denied | 403 | "You do not have permission to complete work orders" | Return error |
| Database error | 500 | "Failed to complete work order" | Log error, rollback |

## Deliverables

- **API routes:**
  - POST /api/production/work-orders/:id/complete
  - POST /api/production/work-orders/:id/auto-complete (internal)
- **Components:**
  - CompleteWorkOrderButton.tsx
  - CompleteWorkOrderModal.tsx
  - WorkOrderYieldBadge.tsx
- **Services:**
  - completeWorkOrder() in work-order-service.ts
  - checkAutoComplete() in work-order-service.ts
- **Tests:**
  - Unit tests for completeWorkOrder() service (>80% coverage)
  - Unit tests for auto-complete logic
  - E2E test: Complete WO happy path
  - E2E test: Auto-complete when produced_qty >= planned_qty
  - E2E test: Operation sequence validation

## Definition of Done

- [ ] API endpoint POST /api/production/work-orders/:id/complete implemented
- [ ] Status transition validation (must be 'in_progress')
- [ ] Timestamp tracking (completed_at, completed_by) working
- [ ] Yield calculation correct (produced_qty / planned_qty * 100)
- [ ] Operation sequence validation respects require_operation_sequence setting
- [ ] Auto-complete logic working when auto_complete_wo = true
- [ ] Material reservation release placeholder logs message (no error)
- [ ] CompleteWorkOrderButton renders with permission check
- [ ] CompleteWorkOrderModal displays WO summary and yield
- [ ] Low yield warning (<80%) displays in yellow
- [ ] Permission validation enforced (production.wo.complete)
- [ ] RLS policies ensure org_id isolation
- [ ] API tests passing (>80% coverage)
- [ ] E2E smoke test for complete WO flow passing
- [ ] Performance: Completion request completes within 1 second
- [ ] Documentation: API endpoint documented in code comments
- [ ] Code review completed
- [ ] QA sign-off obtained

---

## Future Phases (Not in This Story)

### Phase 1 - Output-Based Validation (After Epic 05)
- **Output Registration Requirement** - Story 04.7a
  - Validate at least one production_output record exists before allowing completion
  - Actual yield calculated from SUM(production_outputs.quantity) vs planned_qty
- **By-Product Validation** - Story 04.7c
  - Check if BOM defines by-products, warn if not registered
  - Allow continuation with confirmation
- **Material Reservation Release** - Story 04.6a
  - Release unused material_reservations records (status = 'released')
  - Calculate unused qty: reserved_qty - consumed_qty
- **Genealogy Closure** - Story 04.7a
  - Close lp_genealogy records for consumed materials
  - Mark output LPs as final products

### Phase 2 - OEE Integration
- **OEE Metrics Update** - Story 04.9a
  - Calculate OEE (Availability x Performance x Quality) on completion
  - Insert oee_records with shift/line/machine data
- **Downtime Impact** - Story 04.9b
  - Factor downtime_records into availability calculation
- **Quality Rate** - Story 04.9a
  - Calculate quality_percent from good_output / total_output

**Implementation**: See Epic 04.0 "Future Feature Handling" section for phase toggle strategy.

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-12-16 | Initial story creation | ARCHITECT-AGENT |
