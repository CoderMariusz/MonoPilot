# 04.10f - Quality Rate Report

**Story ID:** 04.10f
**Epic:** 04 - Production
**Phase:** 2 (Analytics)
**Complexity:** M (Medium)
**Estimate:** 2 days
**Type:** Full-stack
**Priority:** P2
**State:** ready

**Primary PRD:** `docs/1-BASELINE/product/modules/PRODUCTION.md` (FR-PROD-022f)
**UX Wireframes:** PROD-022f (Quality Rate Report Dashboard)

## PRD References

| FR ID | Requirement | Priority | Phase | Covered |
|-------|-------------|----------|-------|---------|
| FR-PROD-022f | Quality Rate Report | P1 | Phase 2 | Yes |

## User Story

**As a** production manager,
**I want** to view quality rate reports with QA status distribution and rejection analysis,
**So that** I can identify quality issues, track trends, and drive continuous improvement.

**As a** quality engineer,
**I want** to analyze rejection rates by reason and see defect Pareto charts,
**So that** I can prioritize quality improvement initiatives based on data.

## Goal

Implement a comprehensive Quality Rate Report that analyzes production output quality metrics. The report shows QA status distribution (approved/pending/rejected), calculates quality rates over time, performs defect Pareto analysis, and enables drill-down by product, line, operator, and date range. Integrates with Epic 06 Quality module when available for enhanced rejection reason tracking.

## Scope

**In scope:**
- Quality rate calculation (approved / total outputs)
- QA status distribution pie chart (Approved/Pending/Rejected)
- Quality trend line chart (daily/weekly/monthly)
- Rejection rate by reason bar chart (Pareto analysis)
- Defect frequency table with top reasons
- Filters: product, date range, line, operator, shift
- Summary metrics cards (total outputs, quality rate, rejection count)
- Data table with detailed output records
- CSV export of report data
- Drill-down from chart to underlying data
- Color-coded status indicators
- Comparison with target quality rate

**Out of scope:**
- Full quality inspection workflow (Epic 06 Quality)
- Defect image capture (Quality module)
- Root cause analysis workflow (Quality module)
- SPC control charts (advanced analytics)
- Real-time quality alerts (separate story)

## Dependencies

| Story | Requirement | Status |
|-------|-------------|--------|
| 04.7a | Output Registration with QA status | Required - provides output data |
| 04.5 | Production Settings (target_quality_percent) | Required - provides targets |
| Epic 06 | Quality Module (rejection reasons) | Soft - enhanced rejection tracking |

## Acceptance Criteria (Given/When/Then)

### Quality Rate Calculation

#### Basic Quality Rate
- GIVEN outputs: 900 Approved, 50 Pending, 50 Rejected, WHEN quality rate calculated, THEN quality_rate = 90.0% (Approved/Total).
- GIVEN no outputs in selected period, WHEN quality rate calculated, THEN "No data available" displays with empty state.
- GIVEN quality_rate = 90% AND target = 95%, WHEN displayed, THEN quality rate shows in red with "Below Target" indicator.
- GIVEN quality_rate = 97% AND target = 95%, WHEN displayed, THEN quality rate shows in green with "Above Target" indicator.

#### Period Comparison
- GIVEN current period quality_rate = 92% AND previous period = 88%, WHEN comparison displayed, THEN "+4.0% vs previous period" indicator shows.
- GIVEN current period quality_rate = 85% AND previous period = 90%, WHEN comparison displayed, THEN "-5.0% vs previous period" indicator shows in red.
- GIVEN no previous period data, WHEN comparison displayed, THEN "No comparison data" shows.

### QA Status Distribution (FR-PROD-022f)

#### Pie Chart
- GIVEN outputs exist with mixed QA statuses, WHEN pie chart rendered, THEN segments show Approved (green), Pending (yellow), Rejected (red).
- GIVEN 1000 outputs: 900 Approved, 50 Pending, 50 Rejected, WHEN pie chart rendered, THEN segments show 90%, 5%, 5% respectively.
- GIVEN user hovers over pie segment, WHEN tooltip displays, THEN count and percentage shown (e.g., "Approved: 900 (90%)").
- GIVEN user clicks pie segment, WHEN clicked, THEN data table filters to that QA status.

#### Distribution Metrics
- GIVEN 1000 outputs registered in period, WHEN summary displayed, THEN "Total Outputs: 1,000" shows.
- GIVEN 50 rejected outputs, WHEN rejection count displayed, THEN "Rejections: 50" shows with trend indicator.
- GIVEN 50 pending outputs, WHEN pending count displayed, THEN "Pending QA: 50" shows with action link.

### Quality Trend Line Chart

#### Trend Visualization
- GIVEN date range = last 30 days, WHEN trend chart rendered, THEN daily quality rate displays as line chart.
- GIVEN trend data, WHEN chart rendered, THEN Y-axis shows percentage (0-100%), X-axis shows dates.
- GIVEN target_quality_percent = 95%, WHEN chart rendered, THEN horizontal target line displays at 95%.
- GIVEN data point value = 85%, WHEN point rendered, THEN point color is red (below target).
- GIVEN data point value = 97%, WHEN point rendered, THEN point color is green (above target).

#### Aggregation Options
- GIVEN aggregation = "Daily", WHEN selected, THEN chart shows one point per day.
- GIVEN aggregation = "Weekly", WHEN selected, THEN chart shows one point per week (Sunday-Saturday).
- GIVEN aggregation = "Monthly", WHEN selected, THEN chart shows one point per month.

### Rejection Rate by Reason (Pareto Analysis)

#### Pareto Chart
- GIVEN rejection reasons logged, WHEN Pareto chart rendered, THEN reasons sorted by frequency (highest first).
- GIVEN Pareto chart rendered, WHEN displayed, THEN cumulative percentage line overlays bars.
- GIVEN 5 rejection reasons with counts: 40, 25, 15, 10, 10, WHEN rendered, THEN bars show in descending order with cumulative line reaching 100%.
- GIVEN user hovers over bar, WHEN tooltip displays, THEN reason, count, and percentage shown.

#### Top Reasons Table
- GIVEN rejection data exists, WHEN top reasons table rendered, THEN reasons sorted by frequency descending.
- GIVEN table columns, WHEN rendered, THEN shows: Rank, Reason, Count, Percentage, Cumulative %.
- GIVEN top 10 reasons requested, WHEN rendered, THEN maximum 10 rows display.

### Filters (FR-PROD-022f)

#### Product Filter
- GIVEN product filter = "Product A", WHEN applied, THEN only outputs for Product A display in all charts.
- GIVEN product filter = "All Products", WHEN applied, THEN outputs for all products display.
- GIVEN multiple products selected, WHEN filter applied, THEN outputs for selected products included.

#### Date Range Filter
- GIVEN date range = last 7 days, WHEN applied, THEN only outputs from last 7 days included.
- GIVEN date range = "Custom" with start=Jan 1 and end=Jan 31, WHEN applied, THEN outputs in that range included.
- GIVEN date range = last 30 days (default), WHEN report loads, THEN last 30 days data displays.

#### Line Filter
- GIVEN line filter = "Line A", WHEN applied, THEN only outputs from Line A display.
- GIVEN line filter = "All Lines", WHEN applied, THEN outputs from all lines display.

#### Operator Filter
- GIVEN operator filter applied, WHEN report generated, THEN only outputs created by that operator included.
- GIVEN no outputs by selected operator, WHEN filter applied, THEN "No data for selected operator" displays.

#### Shift Filter
- GIVEN shift filter = "Day Shift", WHEN applied, THEN only outputs during Day Shift included.
- GIVEN shift filter = "All Shifts", WHEN applied, THEN outputs from all shifts display.

### Data Table

#### Detailed Records
- GIVEN report generated, WHEN data table rendered, THEN columns show: Date, Product, Line, Operator, Total, Approved, Pending, Rejected, Quality Rate %.
- GIVEN data table rendered, WHEN user clicks column header, THEN data sorts by that column.
- GIVEN data table has 100+ rows, WHEN rendered, THEN pagination shows (25 rows per page).
- GIVEN user clicks row, WHEN clicked, THEN drill-down to output details modal opens.

#### Export
- GIVEN report exported, WHEN CSV downloaded, THEN columns include: Date, Product, Line, Shift, Operator, Total Output, Approved, Pending, Rejected, Quality Rate %, Rejection Reasons.
- GIVEN export includes 1000 rows, WHEN downloaded, THEN complete dataset exports (no truncation).
- GIVEN date range = Jan 1-31, WHEN exported, THEN filename is "quality-rate-report-2025-01-01-to-2025-01-31.csv".

### Performance

#### Load Time
- GIVEN report with 30 days of data, WHEN page loads, THEN all charts render within 3 seconds.
- GIVEN report with 90 days of data, WHEN page loads, THEN all charts render within 5 seconds.
- GIVEN filter changed, WHEN applied, THEN charts update within 1 second.

### Multi-tenancy
- GIVEN User A from Org A, WHEN requesting quality report, THEN only Org A outputs included.
- GIVEN User A from Org A, WHEN attempting to filter by Org B product, THEN product not visible in filter.

## Technical Specification

### Database Schema

Uses existing tables. Key queries for quality rate report:

#### quality_rate_summary View

```sql
-- Materialized view for quality rate summary by date
CREATE MATERIALIZED VIEW quality_rate_summary AS
SELECT
  org_id,
  DATE(created_at) AS report_date,
  product_id,
  line_id,
  shift_id,
  created_by AS operator_id,
  COUNT(*) AS total_outputs,
  COUNT(*) FILTER (WHERE qa_status = 'approved') AS approved_count,
  COUNT(*) FILTER (WHERE qa_status = 'pending') AS pending_count,
  COUNT(*) FILTER (WHERE qa_status = 'rejected') AS rejected_count,
  ROUND(
    COUNT(*) FILTER (WHERE qa_status = 'approved')::NUMERIC /
    NULLIF(COUNT(*), 0) * 100,
    1
  ) AS quality_rate
FROM license_plates
WHERE source = 'production'
GROUP BY org_id, DATE(created_at), product_id, line_id, shift_id, created_by;

-- Index for fast queries
CREATE INDEX idx_quality_summary_org_date
ON quality_rate_summary(org_id, report_date DESC);

CREATE INDEX idx_quality_summary_product
ON quality_rate_summary(org_id, product_id, report_date DESC);

-- Refresh schedule: every 15 minutes during business hours
CREATE OR REPLACE FUNCTION refresh_quality_summary()
RETURNS void AS $$
BEGIN
  REFRESH MATERIALIZED VIEW CONCURRENTLY quality_rate_summary;
END;
$$ LANGUAGE plpgsql;
```

#### rejection_reasons Table (Epic 06 Integration)

```sql
-- Rejection reasons tracking (if Epic 06 not available, use simplified version)
CREATE TABLE IF NOT EXISTS rejection_reasons (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id),
  code VARCHAR(50) NOT NULL,
  name VARCHAR(100) NOT NULL,
  category VARCHAR(50), -- 'visual', 'dimensional', 'contamination', 'packaging', 'other'
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMPTZ DEFAULT NOW(),

  CONSTRAINT rejection_reasons_org_code_unique UNIQUE (org_id, code)
);

-- Link rejections to reasons
CREATE TABLE IF NOT EXISTS lp_rejections (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id),
  lp_id UUID NOT NULL REFERENCES license_plates(id),
  reason_id UUID NOT NULL REFERENCES rejection_reasons(id),
  quantity NUMERIC(15,4), -- Partial rejection qty if applicable
  notes TEXT,
  created_by UUID NOT NULL REFERENCES users(id),
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Indexes
CREATE INDEX idx_lp_rejections_org ON lp_rejections(org_id);
CREATE INDEX idx_lp_rejections_reason ON lp_rejections(reason_id);
CREATE INDEX idx_lp_rejections_created ON lp_rejections(org_id, created_at DESC);
```

### Database Functions

```sql
-- Get quality rate summary for date range
CREATE OR REPLACE FUNCTION get_quality_rate_summary(
  p_org_id UUID,
  p_start_date DATE,
  p_end_date DATE,
  p_product_id UUID DEFAULT NULL,
  p_line_id UUID DEFAULT NULL,
  p_operator_id UUID DEFAULT NULL,
  p_shift_id UUID DEFAULT NULL
)
RETURNS JSONB AS $$
BEGIN
  RETURN (
    SELECT jsonb_build_object(
      'total_outputs', COALESCE(SUM(total_outputs), 0),
      'approved_count', COALESCE(SUM(approved_count), 0),
      'pending_count', COALESCE(SUM(pending_count), 0),
      'rejected_count', COALESCE(SUM(rejected_count), 0),
      'quality_rate', ROUND(
        COALESCE(SUM(approved_count), 0)::NUMERIC /
        NULLIF(COALESCE(SUM(total_outputs), 0), 0) * 100,
        1
      )
    )
    FROM quality_rate_summary
    WHERE org_id = p_org_id
      AND report_date BETWEEN p_start_date AND p_end_date
      AND (p_product_id IS NULL OR product_id = p_product_id)
      AND (p_line_id IS NULL OR line_id = p_line_id)
      AND (p_operator_id IS NULL OR operator_id = p_operator_id)
      AND (p_shift_id IS NULL OR shift_id = p_shift_id)
  );
END;
$$ LANGUAGE plpgsql;

-- Get quality rate trend data
CREATE OR REPLACE FUNCTION get_quality_rate_trend(
  p_org_id UUID,
  p_start_date DATE,
  p_end_date DATE,
  p_aggregation VARCHAR DEFAULT 'daily', -- 'daily', 'weekly', 'monthly'
  p_product_id UUID DEFAULT NULL,
  p_line_id UUID DEFAULT NULL
)
RETURNS TABLE (
  period_date DATE,
  period_label TEXT,
  total_outputs BIGINT,
  approved_count BIGINT,
  rejected_count BIGINT,
  quality_rate NUMERIC
) AS $$
BEGIN
  RETURN QUERY
  SELECT
    CASE p_aggregation
      WHEN 'weekly' THEN DATE_TRUNC('week', qrs.report_date)::DATE
      WHEN 'monthly' THEN DATE_TRUNC('month', qrs.report_date)::DATE
      ELSE qrs.report_date
    END AS period_date,
    CASE p_aggregation
      WHEN 'weekly' THEN 'W' || TO_CHAR(qrs.report_date, 'IW')
      WHEN 'monthly' THEN TO_CHAR(qrs.report_date, 'Mon YYYY')
      ELSE TO_CHAR(qrs.report_date, 'YYYY-MM-DD')
    END AS period_label,
    SUM(qrs.total_outputs)::BIGINT,
    SUM(qrs.approved_count)::BIGINT,
    SUM(qrs.rejected_count)::BIGINT,
    ROUND(
      SUM(qrs.approved_count)::NUMERIC / NULLIF(SUM(qrs.total_outputs), 0) * 100,
      1
    )
  FROM quality_rate_summary qrs
  WHERE qrs.org_id = p_org_id
    AND qrs.report_date BETWEEN p_start_date AND p_end_date
    AND (p_product_id IS NULL OR qrs.product_id = p_product_id)
    AND (p_line_id IS NULL OR qrs.line_id = p_line_id)
  GROUP BY period_date, period_label
  ORDER BY period_date;
END;
$$ LANGUAGE plpgsql;

-- Get rejection reasons Pareto data
CREATE OR REPLACE FUNCTION get_rejection_pareto(
  p_org_id UUID,
  p_start_date DATE,
  p_end_date DATE,
  p_product_id UUID DEFAULT NULL,
  p_line_id UUID DEFAULT NULL,
  p_limit INTEGER DEFAULT 10
)
RETURNS TABLE (
  reason_id UUID,
  reason_code VARCHAR,
  reason_name VARCHAR,
  category VARCHAR,
  rejection_count BIGINT,
  percentage NUMERIC,
  cumulative_percentage NUMERIC
) AS $$
BEGIN
  RETURN QUERY
  WITH rejection_counts AS (
    SELECT
      rr.id AS reason_id,
      rr.code AS reason_code,
      rr.name AS reason_name,
      rr.category,
      COUNT(*) AS rejection_count
    FROM lp_rejections lr
    JOIN rejection_reasons rr ON lr.reason_id = rr.id
    JOIN license_plates lp ON lr.lp_id = lp.id
    WHERE lr.org_id = p_org_id
      AND lr.created_at::DATE BETWEEN p_start_date AND p_end_date
      AND (p_product_id IS NULL OR lp.product_id = p_product_id)
      AND (p_line_id IS NULL OR lp.line_id = p_line_id)
    GROUP BY rr.id, rr.code, rr.name, rr.category
  ),
  total_rejections AS (
    SELECT COALESCE(SUM(rejection_count), 0) AS total FROM rejection_counts
  ),
  ranked_reasons AS (
    SELECT
      rc.*,
      ROUND(rc.rejection_count::NUMERIC / NULLIF(tr.total, 0) * 100, 1) AS percentage,
      ROW_NUMBER() OVER (ORDER BY rc.rejection_count DESC) AS rank
    FROM rejection_counts rc
    CROSS JOIN total_rejections tr
  )
  SELECT
    rr.reason_id,
    rr.reason_code,
    rr.reason_name,
    rr.category,
    rr.rejection_count,
    rr.percentage,
    SUM(rr.percentage) OVER (ORDER BY rr.rank) AS cumulative_percentage
  FROM ranked_reasons rr
  WHERE rr.rank <= p_limit
  ORDER BY rr.rank;
END;
$$ LANGUAGE plpgsql;
```

### RLS Policies

```sql
-- quality_rate_summary: Org isolation
CREATE POLICY "quality_summary_org_isolation" ON quality_rate_summary
FOR SELECT USING (org_id = (auth.jwt() ->> 'org_id')::uuid);

-- rejection_reasons: Org isolation
CREATE POLICY "rejection_reasons_org_isolation" ON rejection_reasons
FOR ALL USING (org_id = (auth.jwt() ->> 'org_id')::uuid);

-- lp_rejections: Org isolation
CREATE POLICY "lp_rejections_org_isolation" ON lp_rejections
FOR ALL USING (org_id = (auth.jwt() ->> 'org_id')::uuid);
```

### API Endpoints

```
# Quality Rate Report
GET    /api/production/analytics/quality-rate              - Get quality rate report data
GET    /api/production/analytics/quality-rate/summary      - Get summary metrics
GET    /api/production/analytics/quality-rate/trend        - Get quality trend data
GET    /api/production/analytics/quality-rate/pareto       - Get rejection Pareto data
GET    /api/production/analytics/quality-rate/export       - Export report as CSV

# Rejection Reasons (if Epic 06 not available)
GET    /api/production/rejection-reasons                   - List rejection reasons
POST   /api/production/rejection-reasons                   - Create rejection reason
```

### Service Methods

**Location:** `lib/services/quality-rate-service.ts`

```typescript
interface QualityRateService {
  // Report data
  getQualityRateReport(filters: QualityRateFilters): Promise<QualityRateReport>;
  getSummary(filters: QualityRateFilters): Promise<QualitySummary>;
  getTrendData(filters: QualityRateFilters): Promise<QualityTrendPoint[]>;
  getParetoData(filters: QualityRateFilters): Promise<ParetoItem[]>;

  // Calculations
  calculateQualityRate(approved: number, total: number): number;
  calculatePeriodComparison(current: number, previous: number): PeriodComparison;

  // Export
  exportToCSV(filters: QualityRateFilters): Promise<Blob>;

  // Helpers
  getStatusColor(qaStatus: string): 'green' | 'yellow' | 'red';
  formatPercentage(value: number | null): string;
}

interface QualityRateFilters {
  start_date: string;
  end_date: string;
  product_id?: string;
  line_id?: string;
  operator_id?: string;
  shift_id?: string;
  aggregation?: 'daily' | 'weekly' | 'monthly';
}

interface QualityRateReport {
  summary: QualitySummary;
  trend: QualityTrendPoint[];
  pareto: ParetoItem[];
  details: QualityDetailRow[];
  filters_applied: QualityRateFilters;
  generated_at: string;
}

interface QualitySummary {
  total_outputs: number;
  approved_count: number;
  pending_count: number;
  rejected_count: number;
  quality_rate: number | null;
  target_quality_rate: number;
  vs_target: 'above' | 'at' | 'below';
  vs_previous_period: PeriodComparison | null;
}

interface PeriodComparison {
  previous_rate: number;
  change: number;
  change_direction: 'up' | 'down' | 'same';
}

interface QualityTrendPoint {
  period_date: string;
  period_label: string;
  total_outputs: number;
  approved_count: number;
  rejected_count: number;
  quality_rate: number | null;
  vs_target: 'above' | 'at' | 'below';
}

interface ParetoItem {
  reason_id: string;
  reason_code: string;
  reason_name: string;
  category: string;
  rejection_count: number;
  percentage: number;
  cumulative_percentage: number;
}

interface QualityDetailRow {
  date: string;
  product_id: string;
  product_name: string;
  product_code: string;
  line_id: string;
  line_name: string;
  shift_name: string | null;
  operator_id: string;
  operator_name: string;
  total_outputs: number;
  approved_count: number;
  pending_count: number;
  rejected_count: number;
  quality_rate: number | null;
}
```

**Location:** `lib/services/rejection-reason-service.ts`

```typescript
interface RejectionReasonService {
  // CRUD
  list(orgId: string): Promise<RejectionReason[]>;
  create(data: CreateRejectionReasonInput): Promise<RejectionReason>;
  update(id: string, data: UpdateRejectionReasonInput): Promise<RejectionReason>;
  deactivate(id: string): Promise<void>;

  // Categories
  getCategories(): string[];
}

interface RejectionReason {
  id: string;
  org_id: string;
  code: string;
  name: string;
  category: string | null;
  is_active: boolean;
  created_at: string;
}

interface CreateRejectionReasonInput {
  code: string;
  name: string;
  category?: string;
}
```

### Zod Validation Schemas

**Location:** `lib/validation/quality-rate.ts`

```typescript
import { z } from 'zod';

// Quality rate filters schema
export const qualityRateFiltersSchema = z.object({
  start_date: z.string().refine((val) => !isNaN(Date.parse(val)), {
    message: 'Invalid start date'
  }),
  end_date: z.string().refine((val) => !isNaN(Date.parse(val)), {
    message: 'Invalid end date'
  }),
  product_id: z.string().uuid().optional(),
  line_id: z.string().uuid().optional(),
  operator_id: z.string().uuid().optional(),
  shift_id: z.string().uuid().optional(),
  aggregation: z.enum(['daily', 'weekly', 'monthly']).default('daily')
}).refine(
  (data) => new Date(data.start_date) <= new Date(data.end_date),
  { message: 'Start date must be before or equal to end date', path: ['end_date'] }
);

// Pareto filters schema
export const paretoFiltersSchema = qualityRateFiltersSchema.extend({
  limit: z.number().min(1).max(50).default(10)
});

// Export filters schema
export const exportFiltersSchema = qualityRateFiltersSchema.extend({
  include_details: z.boolean().default(true)
});

// Rejection reason schema
export const createRejectionReasonSchema = z.object({
  code: z.string().min(1, 'Code is required').max(50),
  name: z.string().min(1, 'Name is required').max(100),
  category: z.enum(['visual', 'dimensional', 'contamination', 'packaging', 'other']).optional()
});

export const updateRejectionReasonSchema = createRejectionReasonSchema.partial();
```

## UI Components

### Pages

- `app/(authenticated)/production/analytics/quality-rate/page.tsx` - Quality Rate Report page

### Components

**Location:** `components/production/analytics/quality-rate/`

```
QualityRateSummaryCards.tsx     - Summary metrics (total, approved, pending, rejected, rate)
QualityStatusPieChart.tsx       - QA status distribution pie chart
QualityTrendChart.tsx           - Quality rate trend line chart
RejectionParetoChart.tsx        - Rejection reasons Pareto bar chart
TopRejectionReasonsTable.tsx    - Top 10 rejection reasons table
QualityDetailsTable.tsx         - Detailed quality records table
QualityRateFilters.tsx          - Filter panel component
QualityRateExportButton.tsx     - Export to CSV button
```

### Component Details

**QualityRateSummaryCards.tsx**
```tsx
interface QualityRateSummaryCardsProps {
  summary: QualitySummary;
  isLoading: boolean;
}

// Displays:
// +------------+------------+------------+------------+------------+
// | Total      | Approved   | Pending    | Rejected   | Quality    |
// | Outputs    |            | QA         |            | Rate       |
// |   1,000    |    900     |     50     |     50     |   90.0%    |
// |            |   (90%)    |    (5%)    |    (5%)    | Target:95% |
// |            |    [G]     |    [Y]     |    [R]     | Below [-5%]|
// +------------+------------+------------+------------+------------+
// [G] = green dot, [Y] = yellow dot, [R] = red dot
```

**QualityStatusPieChart.tsx**
```tsx
interface QualityStatusPieChartProps {
  data: {
    approved: number;
    pending: number;
    rejected: number;
  };
  onSegmentClick?: (status: string) => void;
  isLoading: boolean;
}

// Pie chart with:
// - Green segment: Approved (90%)
// - Yellow segment: Pending (5%)
// - Red segment: Rejected (5%)
// - Legend below chart
// - Tooltips on hover
// - Click to filter
```

**QualityTrendChart.tsx**
```tsx
interface QualityTrendChartProps {
  data: QualityTrendPoint[];
  targetRate: number;
  aggregation: 'daily' | 'weekly' | 'monthly';
  onAggregationChange: (agg: string) => void;
  onPointClick?: (point: QualityTrendPoint) => void;
  isLoading: boolean;
}

// Line chart with:
// - X-axis: Date/period
// - Y-axis: Quality rate (0-100%)
// - Data line with points
// - Target line (horizontal dashed)
// - Points colored by vs_target
// - Aggregation toggle: Daily/Weekly/Monthly
// - Click point to drill down
```

**RejectionParetoChart.tsx**
```tsx
interface RejectionParetoChartProps {
  data: ParetoItem[];
  onBarClick?: (item: ParetoItem) => void;
  isLoading: boolean;
}

// Combined bar + line chart:
// - Bars: Rejection count per reason (descending)
// - Line: Cumulative percentage
// - X-axis: Reason codes
// - Left Y-axis: Count
// - Right Y-axis: Cumulative %
// - 80/20 reference line
// - Click bar to drill down
```

**TopRejectionReasonsTable.tsx**
```tsx
interface TopRejectionReasonsTableProps {
  data: ParetoItem[];
  onRowClick?: (item: ParetoItem) => void;
  isLoading: boolean;
}

// Table columns:
// Rank | Code | Reason | Category | Count | % | Cumulative %
//  1   | VIS01| Surface Defect| Visual | 40 | 40.0% | 40.0%
//  2   | DIM02| Size Out of Spec| Dimensional | 25 | 25.0% | 65.0%
// ...
```

**QualityDetailsTable.tsx**
```tsx
interface QualityDetailsTableProps {
  data: QualityDetailRow[];
  pagination: PaginationState;
  sorting: SortingState;
  onPaginationChange: (state: PaginationState) => void;
  onSortingChange: (state: SortingState) => void;
  onRowClick: (row: QualityDetailRow) => void;
  isLoading: boolean;
}

// Table columns:
// Date | Product | Line | Operator | Total | Approved | Pending | Rejected | Quality %
// Sortable, paginated (25 per page)
// Click row for drill-down
```

**QualityRateFilters.tsx**
```tsx
interface QualityRateFiltersProps {
  filters: QualityRateFilters;
  products: Product[];
  lines: Line[];
  operators: User[];
  shifts: Shift[];
  onChange: (filters: QualityRateFilters) => void;
  onReset: () => void;
}

// Filter panel:
// - Date range picker (presets: 7d, 30d, 90d, Custom)
// - Product multi-select
// - Line multi-select
// - Operator select
// - Shift select
// - Apply / Reset buttons
```

### UI States

| State | Description | Components |
|-------|-------------|------------|
| loading | Skeleton loaders | All cards, charts, tables |
| empty | No data for filters | Empty state illustration, adjust filters prompt |
| error | Error fetching data | Error card, retry button |
| success | Full data display | All components populated |
| partial | Some data missing | Warning banner, available data shown |

### UI Layout

```
+------------------------------------------------------------------+
| Quality Rate Report                    [Filters] [Export CSV]     |
+------------------------------------------------------------------+
|                                                                   |
| [Summary Cards Row]                                               |
| +--------+ +--------+ +--------+ +--------+ +--------+            |
| | Total  | |Approved| |Pending | |Rejected| |Quality |            |
| | 1,000  | |  900   | |   50   | |   50   | | 90.0%  |            |
| +--------+ +--------+ +--------+ +--------+ +--------+            |
|                                                                   |
+------------------------------------------------------------------+
|                                                                   |
| [Charts Row]                                                      |
| +----------------------------+ +----------------------------+     |
| | QA Status Distribution     | | Quality Rate Trend         |     |
| |                            | |                            |     |
| |    [PIE CHART]             | |    [LINE CHART]            |     |
| |                            | |                            |     |
| +----------------------------+ +----------------------------+     |
|                                                                   |
+------------------------------------------------------------------+
|                                                                   |
| [Rejection Analysis Row]                                          |
| +----------------------------+ +----------------------------+     |
| | Rejection Pareto           | | Top Rejection Reasons      |     |
| |                            | |                            |     |
| |    [BAR + LINE CHART]      | |    [TABLE]                 |     |
| |                            | |                            |     |
| +----------------------------+ +----------------------------+     |
|                                                                   |
+------------------------------------------------------------------+
|                                                                   |
| [Details Table]                                                   |
| +--------------------------------------------------------------+ |
| | Date | Product | Line | Operator | Total | App | Pend | Rej |%| |
| +--------------------------------------------------------------+ |
| | Jan 1| Flour   | A    | John     | 100   | 95  | 3    | 2   |95| |
| | Jan 2| Flour   | A    | Jane     | 80    | 70  | 5    | 5   |88| |
| | ...                                                          | |
| +--------------------------------------------------------------+ |
| | [Pagination: 1 2 3 ... 10]                                   | |
+------------------------------------------------------------------+
```

## Test Cases

### Unit Tests

**quality-rate-service.test.ts**
```typescript
describe('QualityRateService', () => {
  describe('calculateQualityRate', () => {
    it('returns correct percentage (approved/total * 100)');
    it('returns null when total is zero');
    it('rounds to 1 decimal place');
  });

  describe('calculatePeriodComparison', () => {
    it('returns positive change when current > previous');
    it('returns negative change when current < previous');
    it('returns zero change when equal');
    it('handles null previous period');
  });

  describe('getSummary', () => {
    it('returns all counts and quality rate');
    it('calculates vs_target correctly');
    it('includes period comparison when data available');
  });

  describe('getTrendData', () => {
    it('returns daily data points for daily aggregation');
    it('returns weekly data points for weekly aggregation');
    it('returns monthly data points for monthly aggregation');
    it('calculates quality rate per period');
  });

  describe('getParetoData', () => {
    it('sorts reasons by count descending');
    it('calculates cumulative percentage');
    it('limits results to specified count');
  });
});
```

**quality-rate-validation.test.ts**
```typescript
describe('Quality Rate Validation', () => {
  describe('qualityRateFiltersSchema', () => {
    it('accepts valid date range');
    it('rejects invalid start_date format');
    it('rejects start_date after end_date');
    it('accepts optional filters');
  });

  describe('createRejectionReasonSchema', () => {
    it('requires code and name');
    it('validates category enum');
    it('enforces max lengths');
  });
});
```

### Integration Tests

**quality-rate-api.test.ts**
```typescript
describe('Quality Rate API', () => {
  describe('GET /api/production/analytics/quality-rate', () => {
    it('returns complete report data');
    it('filters by product correctly');
    it('filters by date range correctly');
    it('returns 403 for other org data');
    it('returns empty state for no data');
  });

  describe('GET /api/production/analytics/quality-rate/trend', () => {
    it('returns daily trend data');
    it('returns weekly trend data when aggregation=weekly');
    it('calculates quality rate per period');
    it('includes target comparison');
  });

  describe('GET /api/production/analytics/quality-rate/pareto', () => {
    it('returns sorted rejection reasons');
    it('calculates cumulative percentages');
    it('respects limit parameter');
    it('returns empty array when no rejections');
  });

  describe('GET /api/production/analytics/quality-rate/export', () => {
    it('exports CSV with correct headers');
    it('includes all filtered data');
    it('formats dates correctly');
    it('handles large datasets');
  });
});
```

### E2E Tests

**quality-rate-report.spec.ts**
```typescript
describe('Quality Rate Report', () => {
  // Summary cards
  it('displays summary metrics cards');
  it('shows quality rate with target comparison');
  it('shows period-over-period change');

  // Pie chart
  it('displays QA status pie chart');
  it('shows tooltips on segment hover');
  it('filters table when segment clicked');

  // Trend chart
  it('displays quality trend line chart');
  it('shows target reference line');
  it('toggles daily/weekly/monthly aggregation');
  it('colors points by target comparison');

  // Pareto chart
  it('displays rejection Pareto chart');
  it('shows cumulative percentage line');
  it('sorts bars by count descending');

  // Filters
  it('filters by date range');
  it('filters by product');
  it('filters by line');
  it('filters by operator');
  it('resets filters correctly');

  // Export
  it('exports report to CSV');
  it('includes all visible data in export');

  // Multi-tenancy
  it('blocks access to other org data');
});
```

## Security Considerations

1. **Authorization**
   - Verify user has access to production analytics
   - Check org_id on all queries
   - Validate filter values belong to same org

2. **Data Access**
   - RLS policies enforce org isolation
   - Aggregated data only (no individual LP details without permission)
   - Export limited to authorized roles

3. **Performance**
   - Materialized view prevents heavy aggregation queries
   - Query timeout limits for large date ranges
   - Pagination on detail tables

## Deliverables

- [ ] `quality_rate_summary` materialized view migration
- [ ] `rejection_reasons` table migration (if Epic 06 not available)
- [ ] `lp_rejections` table migration (if Epic 06 not available)
- [ ] `get_quality_rate_summary` DB function
- [ ] `get_quality_rate_trend` DB function
- [ ] `get_rejection_pareto` DB function
- [ ] RLS policies for new tables/views
- [ ] Quality rate service (`lib/services/quality-rate-service.ts`)
- [ ] Rejection reason service (`lib/services/rejection-reason-service.ts`)
- [ ] Zod schemas (`lib/validation/quality-rate.ts`)
- [ ] API route GET `/api/production/analytics/quality-rate`
- [ ] API route GET `/api/production/analytics/quality-rate/summary`
- [ ] API route GET `/api/production/analytics/quality-rate/trend`
- [ ] API route GET `/api/production/analytics/quality-rate/pareto`
- [ ] API route GET `/api/production/analytics/quality-rate/export`
- [ ] QualityRateSummaryCards component
- [ ] QualityStatusPieChart component
- [ ] QualityTrendChart component
- [ ] RejectionParetoChart component
- [ ] TopRejectionReasonsTable component
- [ ] QualityDetailsTable component
- [ ] QualityRateFilters component
- [ ] QualityRateExportButton component
- [ ] Quality Rate Report page
- [ ] Unit tests (>80% coverage)
- [ ] Integration tests
- [ ] E2E tests

## Definition of Done

- [ ] Quality rate calculated correctly (approved/total * 100)
- [ ] Summary cards display total, approved, pending, rejected, quality rate
- [ ] Quality rate shows comparison to target (above/below indicator)
- [ ] Period comparison shows change vs previous period
- [ ] QA status pie chart renders with correct segments and colors
- [ ] Pie chart segments clickable for filtering
- [ ] Quality trend line chart displays daily/weekly/monthly data
- [ ] Target reference line displayed on trend chart
- [ ] Data points colored by target comparison
- [ ] Aggregation toggle switches between daily/weekly/monthly
- [ ] Rejection Pareto chart shows bars sorted by count
- [ ] Cumulative percentage line overlays Pareto bars
- [ ] Top rejection reasons table displays ranked list
- [ ] All filters work correctly (date range, product, line, operator, shift)
- [ ] Details table shows paginated quality records
- [ ] Details table sortable by all columns
- [ ] CSV export includes all filtered data
- [ ] Report loads within 3 seconds for 30 days of data
- [ ] Multi-tenancy isolation enforced
- [ ] Unit tests pass (>80% coverage)
- [ ] Integration tests pass
- [ ] E2E tests pass
