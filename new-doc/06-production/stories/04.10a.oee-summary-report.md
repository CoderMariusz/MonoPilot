# 04.10a - OEE Summary Report

**Story ID:** 04.10a
**Epic:** 04 - Production
**Phase:** Phase 2
**Complexity:** M (Medium)
**Estimate:** 3 days
**Type:** Backend + Frontend
**State:** ready
**Priority:** P2

**Primary PRD:** `docs/1-BASELINE/product/modules/PRODUCTION.md` (FR-PROD-022a)
**Architecture:** `docs/1-BASELINE/architecture/modules/production.md`
**UX Wireframes:** TBD (OEE Report Page, Export Modal, Chart Visualizations)

## PRD References

| FR ID | Requirement | Priority | Phase | Covered |
|-------|-------------|----------|-------|---------|
| FR-PROD-022a | OEE Summary Report | P2 | Phase 2 | Yes |

---

## User Story

**As a** production manager,
**I want** to generate comprehensive OEE summary reports by machine, line, shift, or time period,
**So that** I can analyze equipment effectiveness trends, compare performance against targets, and identify areas for improvement.

**As a** plant director,
**I want** to export OEE reports in various formats (CSV, PDF, Excel),
**So that** I can share performance data with stakeholders and include in management reviews.

---

## Goal

Implement a comprehensive OEE Summary Report feature with flexible filtering by date range, machine, production line, and shift. Provide multiple visualization options (trend charts, bar comparisons, tabular data), target comparison analysis, and multi-format export capabilities. Enable drill-down from summary to detailed metrics.

---

## Scope

**In scope (this story):**
- OEE Summary Report page with flexible filters
- Date range selection (custom, presets: 7d, 30d, 90d, YTD)
- Filter by machine, production line, shift
- OEE trend line chart with A/P/Q components
- Bar chart comparison across machines/lines
- Target comparison with variance analysis
- Tabular data view with sorting and pagination
- CSV export with all report data
- PDF export with charts and summary
- Excel export with raw data and pivot tables
- Report scheduling (save filter presets)
- Service layer: `oee-report-service.ts`
- Zod schema validation
- Unit and integration tests

**Out of scope (this story):**
- OEE Calculation Engine (Story 04.9a - prerequisite)
- Downtime Analysis Report (Story 04.10b)
- Yield Analysis Report (Story 04.10c)
- Automated email report delivery (Phase 3)
- Cross-plant comparison (multi-site - future)

---

## Dependencies

| Story | Name | Requirement | Status |
|-------|------|-------------|--------|
| **04.9a** | OEE Calculation | Required - provides oee_metrics data | PREREQUISITE |
| **04.9d** | Shift Management | Required - shift definitions for filtering | PREREQUISITE |
| **04.9b** | Downtime Tracking | Required - downtime data for Availability | PREREQUISITE |
| **01.10** | Machines | Required - machine master data | PREREQUISITE |
| **01.11** | Production Lines | Required - line master data | PREREQUISITE |

**Critical Path:**
```
04.9a (OEE Calculation) + 04.9d (Shift Management) + 04.9b (Downtime)
    |
    v
04.10a (OEE Summary Report) <-- THIS STORY
```

---

## Acceptance Criteria (Given/When/Then)

### AC-1: Report Page Access and Loading

**Given** user is authenticated with Production module access
**When** user navigates to `/production/reports/oee-summary`
**Then** OEE Summary Report page loads within 2 seconds

**Given** user has no production data in org
**When** report page loads
**Then** empty state displays "No OEE data available for selected criteria"

**Given** enable_oee_tracking = false in production_settings
**When** user navigates to report page
**Then** message "OEE tracking is disabled. Enable in Settings to generate reports." displays

### AC-2: Date Range Filter

**Given** report page loaded
**When** user views date range filter
**Then** default selection is "Last 7 Days"

**Given** date range presets available
**When** user clicks preset dropdown
**Then** options include: "Last 7 Days", "Last 30 Days", "Last 90 Days", "Year to Date", "Custom"

**Given** user selects "Custom" date range
**When** date pickers appear
**Then** user can select start_date and end_date with validation (start <= end)

**Given** user selects date range > 365 days
**When** form validated
**Then** warning "Large date range may result in slow performance" displays

**Given** user applies date range filter
**When** filter applied
**Then** report data refreshes within 3 seconds for up to 90 days of data

### AC-3: Machine and Line Filters

**Given** report page loaded
**When** user views machine filter
**Then** dropdown shows all active machines with "All Machines" default

**Given** user selects specific machine
**When** filter applied
**Then** report shows only data for selected machine

**Given** user views production line filter
**When** dropdown displayed
**Then** options include all active production lines with "All Lines" default

**Given** user selects production line
**When** filter applied
**Then** machine filter updates to show only machines on selected line

**Given** user applies multiple filters (machine + date range)
**When** filters applied
**Then** report data reflects intersection of all filters

### AC-4: Shift Filter

**Given** report page loaded
**When** user views shift filter
**Then** dropdown shows all active shifts with "All Shifts" default

**Given** user selects specific shift (e.g., "Day Shift")
**When** filter applied
**Then** report shows only OEE data from Day Shift periods

**Given** shift filter selected
**When** combined with date range
**Then** report filters by both shift AND date range

### AC-5: OEE Trend Chart

**Given** report loaded with date range = 7 days
**When** trend chart rendered
**Then** line chart shows daily OEE % for each day in range

**Given** trend chart displayed
**When** target_oee_percent = 85%
**Then** horizontal dashed target line displays at 85% level

**Given** trend chart with "Show Components" toggle = ON
**When** rendered
**Then** additional lines show Availability, Performance, Quality trends

**Given** user hovers over data point
**When** tooltip displayed
**Then** shows: Date, OEE %, Availability %, Performance %, Quality %, Machine (if filtered)

**Given** no data for specific day in range
**When** chart rendered
**Then** gap displayed in line (not interpolated)

**Given** trend chart rendered
**When** user clicks "Zoom" button
**Then** chart expands to full-screen modal view

### AC-6: Machine/Line Comparison Bar Chart

**Given** "All Machines" filter selected
**When** comparison chart rendered
**Then** grouped bar chart shows OEE by machine

**Given** comparison chart displayed
**When** rendered
**Then** bars sorted by OEE descending (best performing first)

**Given** comparison chart with 5 machines
**When** rendered
**Then** each machine shows 4 bars: OEE, Availability, Performance, Quality

**Given** target_oee_percent = 85%
**When** bar chart rendered
**Then** horizontal target line overlays at 85%

**Given** user clicks on machine bar
**When** clicked
**Then** report filters to that machine (drill-down)

**Given** more than 10 machines
**When** comparison chart rendered
**Then** pagination or "Show Top 10 / Show All" toggle available

### AC-7: Tabular Data View

**Given** report page loaded
**When** user clicks "Table View" tab
**Then** data table displays with columns: Date, Machine, Line, Shift, OEE %, A %, P %, Q %, Target, Variance

**Given** data table with 100+ rows
**When** rendered
**Then** pagination shows 25 rows per page with navigation

**Given** data table displayed
**When** user clicks column header
**Then** table sorts by that column (toggle asc/desc)

**Given** data table displayed
**When** user clicks "Filter" icon on column
**Then** inline filter allows text/value filtering

**Given** tabular data displayed
**When** OEE < target - 10%
**Then** OEE cell highlighted in yellow (warning)

**Given** tabular data displayed
**When** OEE < target - 20%
**Then** OEE cell highlighted in red (critical)

**Given** tabular data displayed
**When** OEE >= target
**Then** OEE cell highlighted in green (on target)

### AC-8: Target Comparison Analysis

**Given** report loaded
**When** summary section displayed
**Then** shows: Average OEE, Target OEE, Variance, Days On Target, Days Below Target

**Given** average OEE = 78% AND target = 85%
**When** variance calculated
**Then** variance shows "-7%" in red

**Given** average OEE = 88% AND target = 85%
**When** variance calculated
**Then** variance shows "+3%" in green

**Given** 7-day period with OEE: [80, 85, 90, 75, 88, 82, 86]
**When** days on target calculated (target = 85%)
**Then** "Days On Target: 4" (85, 90, 88, 86)

**Given** target comparison displayed
**When** "View Details" clicked
**Then** breakdown shows variance by A/P/Q components

### AC-9: CSV Export

**Given** report with data loaded
**When** user clicks "Export" > "CSV"
**Then** CSV file downloads within 5 seconds

**Given** CSV export generated
**When** file opened
**Then** columns include: Date, Machine, Line, Shift, OEE %, Availability %, Performance %, Quality %, Target %, Variance %

**Given** date range = 30 days, 5 machines
**When** CSV exported
**Then** file contains 150 rows (30 days x 5 machines) + header row

**Given** CSV exported
**When** file named
**Then** filename format: `oee-summary-report-{start_date}-{end_date}.csv`

**Given** filters applied (machine = "Machine A")
**When** CSV exported
**Then** export includes only filtered data

### AC-10: PDF Export

**Given** report with data loaded
**When** user clicks "Export" > "PDF"
**Then** PDF generation starts with progress indicator

**Given** PDF export generated
**When** file opened
**Then** includes: Report header with date range, OEE trend chart, Comparison bar chart, Summary table

**Given** PDF generated
**When** viewed
**Then** formatted for print (A4/Letter) with MonoPilot branding

**Given** PDF exported
**When** file named
**Then** filename format: `oee-summary-report-{start_date}-{end_date}.pdf`

**Given** large data set (90 days, 10 machines)
**When** PDF generated
**Then** report pagination handles multi-page layout

**Given** PDF generation fails
**When** error occurs
**Then** toast "PDF generation failed. Please try again." displays with retry option

### AC-11: Excel Export

**Given** report with data loaded
**When** user clicks "Export" > "Excel"
**Then** XLSX file downloads within 5 seconds

**Given** Excel export generated
**When** file opened
**Then** workbook contains sheets: "Summary", "Daily Data", "Machine Comparison"

**Given** "Daily Data" sheet
**When** viewed
**Then** contains raw OEE metrics with all columns

**Given** "Summary" sheet
**When** viewed
**Then** contains aggregated statistics and filter criteria used

**Given** Excel export
**When** "Machine Comparison" sheet viewed
**Then** contains pivot-ready data grouped by machine

**Given** Excel exported
**When** file named
**Then** filename format: `oee-summary-report-{start_date}-{end_date}.xlsx`

### AC-12: Report Filter Presets (Saved Reports)

**Given** user applies custom filters
**When** user clicks "Save as Preset"
**Then** modal prompts for preset name

**Given** user enters preset name "Weekly Machine A Review"
**When** saved
**Then** preset stored with all current filter settings

**Given** user has saved presets
**When** preset dropdown clicked
**Then** shows list of saved presets with "Apply" action

**Given** user selects saved preset
**When** "Apply" clicked
**Then** all filters update to preset values and report refreshes

**Given** user views saved preset
**When** "Delete" clicked
**Then** confirmation modal displays before deletion

**Given** user's presets list
**When** 10 presets exist
**Then** all presets available in dropdown (no limit in MVP)

### AC-13: Performance Requirements

**Given** date range = 30 days, all machines
**When** report loads
**Then** initial render completes within 3 seconds

**Given** date range = 90 days, all machines
**When** report loads
**Then** initial render completes within 5 seconds

**Given** CSV export for 90 days, 10 machines
**When** export triggered
**Then** download starts within 5 seconds

**Given** PDF export for 30 days
**When** export triggered
**Then** download starts within 10 seconds

**Given** user changes filter
**When** new filter applied
**Then** data refresh completes within 2 seconds

### AC-14: Multi-tenancy and RLS

**Given** User from Org A views OEE report
**When** data loaded
**Then** only Org A OEE metrics returned

**Given** User from Org A exports report
**When** export generated
**Then** export contains only Org A data

**Given** saved preset from Org A
**When** User from Org B queries presets
**Then** Org A preset not visible (RLS enforced)

---

## Technical Specification

### Database Schema

#### oee_report_presets table

```sql
CREATE TABLE oee_report_presets (
  id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id          UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  user_id         UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,

  -- Preset metadata
  name            VARCHAR(100) NOT NULL,
  description     TEXT,
  is_default      BOOLEAN DEFAULT false,

  -- Filter configuration (JSON)
  filters         JSONB NOT NULL DEFAULT '{}',
  /*
   * filters structure:
   * {
   *   "date_range_type": "custom" | "7d" | "30d" | "90d" | "ytd",
   *   "start_date": "2025-01-01",
   *   "end_date": "2025-01-31",
   *   "machine_ids": ["uuid1", "uuid2"] | null,
   *   "line_ids": ["uuid1"] | null,
   *   "shift_ids": ["uuid1"] | null,
   *   "show_components": true,
   *   "chart_type": "trend" | "comparison" | "both",
   *   "group_by": "day" | "week" | "month"
   * }
   */

  -- Display preferences
  view_mode       VARCHAR(20) DEFAULT 'chart', -- 'chart', 'table', 'both'

  -- Timestamps
  created_at      TIMESTAMPTZ DEFAULT now(),
  updated_at      TIMESTAMPTZ,
  last_used_at    TIMESTAMPTZ,

  -- Constraints
  CONSTRAINT oee_report_presets_name_unique UNIQUE (org_id, user_id, name)
);

-- Indexes
CREATE INDEX idx_oee_report_presets_org_id ON oee_report_presets(org_id);
CREATE INDEX idx_oee_report_presets_user_id ON oee_report_presets(user_id);

-- RLS
ALTER TABLE oee_report_presets ENABLE ROW LEVEL SECURITY;

CREATE POLICY "oee_report_presets_own_read" ON oee_report_presets
  FOR SELECT USING (
    user_id = auth.uid()
    OR org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  );

CREATE POLICY "oee_report_presets_own_write" ON oee_report_presets
  FOR ALL USING (user_id = auth.uid());
```

### RLS Policies Summary

```sql
-- oee_report_presets: Users own their presets, can view org presets
CREATE POLICY "presets_read_own_and_org" ON oee_report_presets
  FOR SELECT USING (
    user_id = auth.uid()
    OR (
      org_id = (SELECT org_id FROM users WHERE id = auth.uid())
      AND is_shared = true
    )
  );

CREATE POLICY "presets_write_own" ON oee_report_presets
  FOR INSERT WITH CHECK (user_id = auth.uid());

CREATE POLICY "presets_update_own" ON oee_report_presets
  FOR UPDATE USING (user_id = auth.uid());

CREATE POLICY "presets_delete_own" ON oee_report_presets
  FOR DELETE USING (user_id = auth.uid());
```

### API Endpoints

```
# OEE Summary Report Data
GET    /api/production/reports/oee-summary           - Get OEE summary report data
  Query params:
    - start_date: string (ISO date, required)
    - end_date: string (ISO date, required)
    - machine_ids?: string[] (comma-separated UUIDs)
    - line_ids?: string[] (comma-separated UUIDs)
    - shift_ids?: string[] (comma-separated UUIDs)
    - group_by?: 'day' | 'week' | 'month' (default: 'day')

GET    /api/production/reports/oee-summary/trend     - Get OEE trend data for chart
GET    /api/production/reports/oee-summary/comparison - Get machine/line comparison data
GET    /api/production/reports/oee-summary/summary   - Get aggregated summary statistics

# Export Endpoints
POST   /api/production/reports/oee-summary/export/csv   - Export to CSV
POST   /api/production/reports/oee-summary/export/pdf   - Export to PDF
POST   /api/production/reports/oee-summary/export/excel - Export to Excel
  Body: { filters: OEEReportFilters }

# Report Presets
GET    /api/production/reports/presets              - List user's report presets
POST   /api/production/reports/presets              - Create new preset
GET    /api/production/reports/presets/:id          - Get preset details
PUT    /api/production/reports/presets/:id          - Update preset
DELETE /api/production/reports/presets/:id          - Delete preset
```

### Service Methods

**Location:** `lib/services/oee-report-service.ts`

```typescript
interface OEEReportService {
  // Report Data Retrieval
  getOEESummaryReport(filters: OEEReportFilters): Promise<OEESummaryReportData>;
  getOEETrendData(filters: OEEReportFilters): Promise<OEETrendDataPoint[]>;
  getOEEComparisonData(filters: OEEReportFilters): Promise<OEEComparisonData[]>;
  getSummaryStatistics(filters: OEEReportFilters): Promise<OEESummaryStatistics>;

  // Export Functions
  exportToCSV(filters: OEEReportFilters): Promise<Blob>;
  exportToPDF(filters: OEEReportFilters): Promise<Blob>;
  exportToExcel(filters: OEEReportFilters): Promise<Blob>;

  // Preset Management
  getPresets(userId: string): Promise<OEEReportPreset[]>;
  createPreset(preset: OEEReportPresetInput): Promise<OEEReportPreset>;
  updatePreset(id: string, preset: Partial<OEEReportPresetInput>): Promise<OEEReportPreset>;
  deletePreset(id: string): Promise<void>;
  applyPreset(presetId: string): Promise<OEEReportFilters>;

  // Helpers
  validateDateRange(startDate: Date, endDate: Date): ValidationResult;
  calculateTargetVariance(actual: number, target: number): number;
  formatReportFilename(reportType: string, filters: OEEReportFilters): string;
}

interface OEEReportFilters {
  startDate: string;
  endDate: string;
  machineIds?: string[];
  lineIds?: string[];
  shiftIds?: string[];
  groupBy: 'day' | 'week' | 'month';
  showComponents: boolean;
}

interface OEESummaryReportData {
  trend: OEETrendDataPoint[];
  comparison: OEEComparisonData[];
  statistics: OEESummaryStatistics;
  filters: OEEReportFilters;
  generatedAt: string;
}

interface OEETrendDataPoint {
  date: string;
  oeePercent: number;
  availabilityPercent: number;
  performancePercent: number;
  qualityPercent: number;
  targetOeePercent: number;
  machineId?: string;
  machineName?: string;
}

interface OEEComparisonData {
  machineId: string;
  machineName: string;
  lineName: string;
  oeePercent: number;
  availabilityPercent: number;
  performancePercent: number;
  qualityPercent: number;
  targetOeePercent: number;
  variancePercent: number;
  rank: number;
}

interface OEESummaryStatistics {
  averageOee: number;
  minOee: number;
  maxOee: number;
  targetOee: number;
  variancePercent: number;
  daysOnTarget: number;
  daysBelowTarget: number;
  totalDays: number;
  bestMachine: { id: string; name: string; oee: number };
  worstMachine: { id: string; name: string; oee: number };
  trendDirection: 'up' | 'down' | 'stable';
  componentBreakdown: {
    avgAvailability: number;
    avgPerformance: number;
    avgQuality: number;
  };
}

interface OEEReportPreset {
  id: string;
  name: string;
  description?: string;
  filters: OEEReportFilters;
  viewMode: 'chart' | 'table' | 'both';
  createdAt: string;
  lastUsedAt?: string;
}

interface OEEReportPresetInput {
  name: string;
  description?: string;
  filters: OEEReportFilters;
  viewMode?: 'chart' | 'table' | 'both';
}
```

### Zod Validation Schemas

**Location:** `lib/validation/oee-report-validation.ts`

```typescript
import { z } from 'zod';

// Date range presets
export const dateRangePresetSchema = z.enum(['7d', '30d', '90d', 'ytd', 'custom']);

// Report filters schema
export const oeeReportFiltersSchema = z.object({
  start_date: z.string().date(),
  end_date: z.string().date(),
  machine_ids: z.array(z.string().uuid()).optional(),
  line_ids: z.array(z.string().uuid()).optional(),
  shift_ids: z.array(z.string().uuid()).optional(),
  group_by: z.enum(['day', 'week', 'month']).default('day'),
  show_components: z.boolean().default(true),
}).refine(
  (data) => new Date(data.start_date) <= new Date(data.end_date),
  { message: 'Start date must be before or equal to end date', path: ['start_date'] }
).refine(
  (data) => {
    const days = Math.ceil(
      (new Date(data.end_date).getTime() - new Date(data.start_date).getTime()) / (1000 * 60 * 60 * 24)
    );
    return days <= 365;
  },
  { message: 'Date range cannot exceed 365 days', path: ['end_date'] }
);

// Query params schema
export const oeeReportQuerySchema = z.object({
  start_date: z.string().date(),
  end_date: z.string().date(),
  machine_ids: z.string().optional().transform(v => v ? v.split(',') : undefined),
  line_ids: z.string().optional().transform(v => v ? v.split(',') : undefined),
  shift_ids: z.string().optional().transform(v => v ? v.split(',') : undefined),
  group_by: z.enum(['day', 'week', 'month']).default('day'),
});

// Export request schema
export const oeeExportRequestSchema = z.object({
  filters: oeeReportFiltersSchema,
  format: z.enum(['csv', 'pdf', 'excel']),
  include_charts: z.boolean().default(true), // For PDF
});

// Report preset schema
export const oeeReportPresetSchema = z.object({
  id: z.string().uuid(),
  name: z.string().min(1).max(100),
  description: z.string().max(500).optional(),
  filters: oeeReportFiltersSchema,
  view_mode: z.enum(['chart', 'table', 'both']).default('both'),
  created_at: z.string().datetime(),
  last_used_at: z.string().datetime().optional(),
});

// Create preset schema
export const createPresetSchema = z.object({
  name: z.string().min(1, 'Preset name is required').max(100, 'Name must be 100 characters or less'),
  description: z.string().max(500).optional(),
  filters: oeeReportFiltersSchema,
  view_mode: z.enum(['chart', 'table', 'both']).default('both'),
});

// Update preset schema
export const updatePresetSchema = createPresetSchema.partial();

// Trend data point schema
export const oeeTrendDataPointSchema = z.object({
  date: z.string().date(),
  oee_percent: z.number().min(0),
  availability_percent: z.number().min(0).max(100),
  performance_percent: z.number().min(0),
  quality_percent: z.number().min(0).max(100),
  target_oee_percent: z.number().min(0).max(100),
  machine_id: z.string().uuid().optional(),
  machine_name: z.string().optional(),
});

// Comparison data schema
export const oeeComparisonDataSchema = z.object({
  machine_id: z.string().uuid(),
  machine_name: z.string(),
  line_name: z.string(),
  oee_percent: z.number().min(0),
  availability_percent: z.number().min(0).max(100),
  performance_percent: z.number().min(0),
  quality_percent: z.number().min(0).max(100),
  target_oee_percent: z.number().min(0).max(100),
  variance_percent: z.number(),
  rank: z.number().int().positive(),
});

// Summary statistics schema
export const oeeSummaryStatisticsSchema = z.object({
  average_oee: z.number().min(0),
  min_oee: z.number().min(0),
  max_oee: z.number().min(0),
  target_oee: z.number().min(0).max(100),
  variance_percent: z.number(),
  days_on_target: z.number().int().min(0),
  days_below_target: z.number().int().min(0),
  total_days: z.number().int().min(0),
  best_machine: z.object({
    id: z.string().uuid(),
    name: z.string(),
    oee: z.number(),
  }),
  worst_machine: z.object({
    id: z.string().uuid(),
    name: z.string(),
    oee: z.number(),
  }),
  trend_direction: z.enum(['up', 'down', 'stable']),
  component_breakdown: z.object({
    avg_availability: z.number(),
    avg_performance: z.number(),
    avg_quality: z.number(),
  }),
});
```

---

## UI Components

### Pages

- `app/(authenticated)/production/reports/oee-summary/page.tsx` - OEE Summary Report page

### Components

**Location:** `components/production/reports/oee/`

```
OEESummaryReport.tsx        - Main report container
OEEReportFilters.tsx        - Filter controls (date, machine, line, shift)
OEEReportDateRange.tsx      - Date range selector with presets
OEEReportTrendChart.tsx     - OEE trend line chart
OEEReportComparisonChart.tsx - Machine/line comparison bar chart
OEEReportDataTable.tsx      - Tabular data view with pagination
OEEReportSummaryCard.tsx    - Summary statistics card
OEEReportExportMenu.tsx     - Export options dropdown
OEEReportPresetManager.tsx  - Save/load preset modal
OEEReportTargetComparison.tsx - Target vs actual analysis
OEEReportEmptyState.tsx     - Empty state when no data
```

### Component Details

**OEESummaryReport.tsx**
```tsx
interface OEESummaryReportProps {
  initialFilters?: OEEReportFilters;
}

// Main container orchestrating all report components
// Manages filter state, data fetching, and export
```

**OEEReportFilters.tsx**
```tsx
interface OEEReportFiltersProps {
  filters: OEEReportFilters;
  onFiltersChange: (filters: OEEReportFilters) => void;
  machines: Machine[];
  lines: ProductionLine[];
  shifts: Shift[];
  isLoading?: boolean;
}

// Filter bar with:
// - Date range selector with presets
// - Machine multi-select dropdown
// - Production line multi-select dropdown
// - Shift multi-select dropdown
// - "Show Components" toggle
// - "Apply Filters" button
// - "Clear Filters" button
```

**OEEReportTrendChart.tsx**
```tsx
interface OEEReportTrendChartProps {
  data: OEETrendDataPoint[];
  targetOee: number;
  showComponents: boolean;
  dateRange: { start: string; end: string };
  onDataPointClick?: (point: OEETrendDataPoint) => void;
  onZoom?: () => void;
}

// Line chart features:
// - OEE trend line (primary, bold)
// - A/P/Q component lines (optional, dashed)
// - Target OEE horizontal line (dashed red)
// - Tooltips on hover with all metrics
// - Zoom to full-screen option
// - Responsive design
```

**OEEReportComparisonChart.tsx**
```tsx
interface OEEReportComparisonChartProps {
  data: OEEComparisonData[];
  targetOee: number;
  sortBy: 'oee' | 'name';
  sortOrder: 'asc' | 'desc';
  onMachineClick?: (machineId: string) => void;
  maxDisplay?: number;
}

// Bar chart features:
// - Grouped bars (OEE, A, P, Q) per machine
// - Target line overlay
// - Color coding (green=on target, yellow=warning, red=critical)
// - Click to drill-down
// - Sort controls
// - "Show Top N / Show All" toggle
```

**OEEReportDataTable.tsx**
```tsx
interface OEEReportDataTableProps {
  data: OEETrendDataPoint[];
  targetOee: number;
  pageSize?: number;
  onSort: (column: string, direction: 'asc' | 'desc') => void;
  onFilter: (column: string, value: string) => void;
}

// Table columns:
// - Date
// - Machine
// - Line
// - Shift
// - OEE % (with color indicator)
// - Availability %
// - Performance %
// - Quality %
// - Target %
// - Variance % (with color indicator)
// Features:
// - Pagination (25 rows default)
// - Column sorting
// - Column filtering
// - Row highlighting based on OEE vs target
```

**OEEReportExportMenu.tsx**
```tsx
interface OEEReportExportMenuProps {
  filters: OEEReportFilters;
  onExport: (format: 'csv' | 'pdf' | 'excel') => void;
  isExporting: boolean;
}

// Dropdown with:
// - Export to CSV
// - Export to PDF (with charts)
// - Export to Excel
// - Progress indicator during export
```

**OEEReportPresetManager.tsx**
```tsx
interface OEEReportPresetManagerProps {
  presets: OEEReportPreset[];
  currentFilters: OEEReportFilters;
  onApplyPreset: (presetId: string) => void;
  onSavePreset: (name: string, description?: string) => void;
  onDeletePreset: (presetId: string) => void;
}

// Features:
// - Preset dropdown selector
// - "Save Current as Preset" button
// - Save preset modal (name, description)
// - Delete preset confirmation
```

### UI Layout

**OEE Summary Report Page:**
```
+------------------------------------------------------------------+
| OEE Summary Report                                               |
+------------------------------------------------------------------+
| Filters:                                                         |
| [Date Range: Last 7 Days v] [Machines: All v] [Lines: All v]     |
| [Shifts: All v] [ ] Show Components    [Apply] [Clear]           |
|                                                                  |
| Presets: [Select Preset v] [Save Current]      [Export v]        |
+------------------------------------------------------------------+
|                                                                  |
| Summary Statistics                                               |
| +--------------------+--------------------+--------------------+ |
| | Avg OEE: 78.5%     | Target: 85%        | Variance: -6.5%    | |
| | Min: 65% Max: 92%  | Days On Target: 3  | Days Below: 4      | |
| +--------------------+--------------------+--------------------+ |
|                                                                  |
| [Chart View] [Table View] [Both]                                 |
|                                                                  |
| OEE Trend                                          [Zoom] [---]  |
| +--------------------------------------------------------------+ |
| |          --- Target (85%)                                     | |
| |     /\                                                        | |
| |    /  \    /----\                                             | |
| |   /    \  /      \___/\                                       | |
| |  /      \/             \                                      | |
| +--------------------------------------------------------------+ |
| | Jan 8  Jan 9  Jan 10  Jan 11  Jan 12  Jan 13  Jan 14         | |
|                                                                  |
| Machine Comparison                               [Sort: OEE v]   |
| +--------------------------------------------------------------+ |
| | ||||  ||||  ||||  ||||  ||||  --- Target                     | |
| | ||||  ||||  ||||  ||||  ||||                                 | |
| +--------------------------------------------------------------+ |
| | Mach A | Mach B | Mach C | Mach D | Mach E |                 | |
|                                                                  |
| Legend: [OEE] [Availability] [Performance] [Quality]            |
|                                                                  |
+------------------------------------------------------------------+
```

**Table View Layout:**
```
+------------------------------------------------------------------+
| Date       | Machine  | Line   | Shift | OEE   | A%   | P%   | Q%   | Target | Var    |
|------------|----------|--------|-------|-------|------|------|------|--------|--------|
| 2025-01-14 | Machine A| Line 1 | Day   | 82.5% | 90%  | 92%  | 99%  | 85%    | -2.5%  |
| 2025-01-14 | Machine B| Line 1 | Day   | 78.2% | 85%  | 92%  | 100% | 85%    | -6.8%  |
| 2025-01-13 | Machine A| Line 1 | Night | 88.0% | 92%  | 96%  | 99%  | 85%    | +3.0%  |
| ...        |          |        |       |       |      |      |      |        |        |
+------------------------------------------------------------------+
| Showing 1-25 of 150                        [< Prev] [1] [2] [3] [Next >] |
+------------------------------------------------------------------+
```

---

## Implementation Notes

### CSV Export Implementation

```typescript
// lib/services/oee-report-service.ts

export async function exportToCSV(filters: OEEReportFilters): Promise<Blob> {
  const data = await getOEESummaryReport(filters);

  const headers = [
    'Date', 'Machine', 'Line', 'Shift',
    'OEE %', 'Availability %', 'Performance %', 'Quality %',
    'Target %', 'Variance %'
  ];

  const rows = data.trend.map(point => [
    point.date,
    point.machineName || 'All',
    point.lineName || 'All',
    point.shiftName || 'All',
    point.oeePercent.toFixed(1),
    point.availabilityPercent.toFixed(1),
    point.performancePercent.toFixed(1),
    point.qualityPercent.toFixed(1),
    point.targetOeePercent.toFixed(1),
    (point.oeePercent - point.targetOeePercent).toFixed(1),
  ]);

  const csvContent = [
    headers.join(','),
    ...rows.map(row => row.join(','))
  ].join('\n');

  return new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
}
```

### PDF Export Implementation

```typescript
// lib/services/oee-report-service.ts
// Uses @react-pdf/renderer or similar library

export async function exportToPDF(filters: OEEReportFilters): Promise<Blob> {
  const data = await getOEESummaryReport(filters);

  // Generate PDF with:
  // 1. Header with report title, date range, filters used
  // 2. Summary statistics section
  // 3. OEE trend chart (rendered as image)
  // 4. Machine comparison chart (rendered as image)
  // 5. Data table (paginated if needed)
  // 6. Footer with generation timestamp and page numbers

  // Implementation details depend on PDF library choice
  // Options: @react-pdf/renderer, pdfmake, jspdf

  return pdfBlob;
}
```

### Excel Export Implementation

```typescript
// lib/services/oee-report-service.ts
// Uses xlsx or exceljs library

export async function exportToExcel(filters: OEEReportFilters): Promise<Blob> {
  const data = await getOEESummaryReport(filters);

  const workbook = XLSX.utils.book_new();

  // Sheet 1: Summary
  const summaryData = [
    ['OEE Summary Report'],
    ['Generated:', new Date().toISOString()],
    ['Date Range:', `${filters.startDate} to ${filters.endDate}`],
    [],
    ['Average OEE', data.statistics.averageOee + '%'],
    ['Target OEE', data.statistics.targetOee + '%'],
    ['Variance', data.statistics.variancePercent + '%'],
    ['Days On Target', data.statistics.daysOnTarget],
    ['Days Below Target', data.statistics.daysBelowTarget],
  ];
  const summarySheet = XLSX.utils.aoa_to_sheet(summaryData);
  XLSX.utils.book_append_sheet(workbook, summarySheet, 'Summary');

  // Sheet 2: Daily Data
  const dailyHeaders = ['Date', 'Machine', 'OEE %', 'A %', 'P %', 'Q %', 'Target %', 'Variance %'];
  const dailyRows = data.trend.map(point => [
    point.date,
    point.machineName || 'All',
    point.oeePercent,
    point.availabilityPercent,
    point.performancePercent,
    point.qualityPercent,
    point.targetOeePercent,
    point.oeePercent - point.targetOeePercent,
  ]);
  const dailySheet = XLSX.utils.aoa_to_sheet([dailyHeaders, ...dailyRows]);
  XLSX.utils.book_append_sheet(workbook, dailySheet, 'Daily Data');

  // Sheet 3: Machine Comparison
  const compHeaders = ['Rank', 'Machine', 'Line', 'OEE %', 'A %', 'P %', 'Q %'];
  const compRows = data.comparison.map(m => [
    m.rank, m.machineName, m.lineName,
    m.oeePercent, m.availabilityPercent, m.performancePercent, m.qualityPercent
  ]);
  const compSheet = XLSX.utils.aoa_to_sheet([compHeaders, ...compRows]);
  XLSX.utils.book_append_sheet(workbook, compSheet, 'Machine Comparison');

  return XLSX.write(workbook, { type: 'array', bookType: 'xlsx' });
}
```

### Trend Direction Calculation

```typescript
export function calculateTrendDirection(
  data: OEETrendDataPoint[]
): 'up' | 'down' | 'stable' {
  if (data.length < 3) return 'stable';

  // Compare first half average to second half average
  const mid = Math.floor(data.length / 2);
  const firstHalf = data.slice(0, mid);
  const secondHalf = data.slice(mid);

  const firstAvg = firstHalf.reduce((sum, d) => sum + d.oeePercent, 0) / firstHalf.length;
  const secondAvg = secondHalf.reduce((sum, d) => sum + d.oeePercent, 0) / secondHalf.length;

  const diff = secondAvg - firstAvg;

  if (diff > 2) return 'up';      // >2% improvement
  if (diff < -2) return 'down';   // >2% decline
  return 'stable';                 // Within +/- 2%
}
```

---

## Test Cases

### Unit Tests

**oee-report-service.test.ts**
```typescript
describe('OEEReportService', () => {
  describe('getOEESummaryReport', () => {
    it('returns data for valid date range');
    it('filters by machine IDs');
    it('filters by line IDs');
    it('filters by shift IDs');
    it('returns empty array for no data');
  });

  describe('getSummaryStatistics', () => {
    it('calculates correct average OEE');
    it('calculates correct variance from target');
    it('counts days on target correctly');
    it('identifies best and worst machines');
    it('calculates trend direction');
  });

  describe('exportToCSV', () => {
    it('generates valid CSV with headers');
    it('includes all data points');
    it('formats percentages correctly');
    it('handles empty data set');
  });

  describe('exportToPDF', () => {
    it('generates valid PDF blob');
    it('includes charts when requested');
    it('handles large data sets with pagination');
  });

  describe('exportToExcel', () => {
    it('creates workbook with 3 sheets');
    it('populates summary sheet correctly');
    it('includes all daily data');
  });

  describe('validateDateRange', () => {
    it('accepts valid date ranges');
    it('rejects start > end');
    it('rejects ranges > 365 days');
    it('warns for ranges > 90 days');
  });

  describe('calculateTrendDirection', () => {
    it('returns up for improving trend');
    it('returns down for declining trend');
    it('returns stable for flat trend');
    it('returns stable for insufficient data');
  });
});
```

### Integration Tests

**oee-report-api.test.ts**
```typescript
describe('OEE Report API', () => {
  describe('GET /api/production/reports/oee-summary', () => {
    it('returns report data for valid filters');
    it('returns 400 for invalid date range');
    it('returns 401 for unauthenticated');
    it('filters by org_id via RLS');
    it('returns empty data for no matching records');
  });

  describe('POST /api/production/reports/oee-summary/export/csv', () => {
    it('returns CSV blob');
    it('respects filters');
    it('sets correct content-type header');
  });

  describe('POST /api/production/reports/oee-summary/export/pdf', () => {
    it('returns PDF blob');
    it('handles timeout for large reports');
  });

  describe('GET /api/production/reports/presets', () => {
    it('returns user presets');
    it('excludes other users presets');
  });

  describe('POST /api/production/reports/presets', () => {
    it('creates preset with valid data');
    it('rejects duplicate name');
    it('validates filter schema');
  });

  describe('DELETE /api/production/reports/presets/:id', () => {
    it('deletes own preset');
    it('returns 404 for other user preset');
  });
});
```

### E2E Tests

**oee-summary-report.spec.ts**
```typescript
describe('OEE Summary Report', () => {
  it('loads report page with default filters');
  it('displays empty state when no data');
  it('applies date range filter and refreshes data');
  it('applies machine filter');
  it('shows trend chart with target line');
  it('shows comparison chart sorted by OEE');
  it('toggles between chart and table view');
  it('exports to CSV');
  it('exports to PDF');
  it('exports to Excel');
  it('saves filter as preset');
  it('loads saved preset');
  it('deletes preset with confirmation');
  it('handles large date range warning');
  it('drills down from comparison chart to machine');
});
```

---

## Security Considerations

1. **Multi-tenancy**
   - All report queries filtered by org_id via RLS
   - Exported data contains only user's org data
   - Presets visible only to owner (or shared org presets)

2. **Data Export Security**
   - Export endpoints require authentication
   - Rate limiting on export endpoints (5 exports/minute)
   - Large exports processed asynchronously if needed

3. **Input Validation**
   - Date range validated (max 365 days)
   - Filter UUIDs validated against existing records
   - Preset names sanitized

4. **Performance**
   - Query optimization for large date ranges
   - Caching for repeated identical requests
   - Pagination for large result sets

---

## Deliverables

### Database
- [ ] `oee_report_presets` table migration with RLS policies
- [ ] Indexes for query performance

### API Routes
- [ ] `GET /api/production/reports/oee-summary`
- [ ] `GET /api/production/reports/oee-summary/trend`
- [ ] `GET /api/production/reports/oee-summary/comparison`
- [ ] `GET /api/production/reports/oee-summary/summary`
- [ ] `POST /api/production/reports/oee-summary/export/csv`
- [ ] `POST /api/production/reports/oee-summary/export/pdf`
- [ ] `POST /api/production/reports/oee-summary/export/excel`
- [ ] `GET /api/production/reports/presets`
- [ ] `POST /api/production/reports/presets`
- [ ] `PUT /api/production/reports/presets/:id`
- [ ] `DELETE /api/production/reports/presets/:id`

### Services
- [ ] `lib/services/oee-report-service.ts` - Report generation and export

### Validation
- [ ] `lib/validation/oee-report-validation.ts` - Zod schemas

### Components
- [ ] `OEESummaryReport.tsx` - Main report container
- [ ] `OEEReportFilters.tsx` - Filter controls
- [ ] `OEEReportDateRange.tsx` - Date range selector
- [ ] `OEEReportTrendChart.tsx` - Trend line chart
- [ ] `OEEReportComparisonChart.tsx` - Comparison bar chart
- [ ] `OEEReportDataTable.tsx` - Tabular data view
- [ ] `OEEReportSummaryCard.tsx` - Summary statistics
- [ ] `OEEReportExportMenu.tsx` - Export dropdown
- [ ] `OEEReportPresetManager.tsx` - Preset management

### Pages
- [ ] `app/(authenticated)/production/reports/oee-summary/page.tsx`

### Tests
- [ ] Unit tests for report service (>80% coverage)
- [ ] Integration tests for API endpoints
- [ ] E2E tests for report page interactions

---

## Definition of Done

- [ ] OEE Summary Report page loads within 2 seconds for 30-day range
- [ ] Date range filter works with presets and custom selection
- [ ] Machine, line, shift filters work individually and combined
- [ ] OEE trend chart displays with target line and optional A/P/Q components
- [ ] Comparison bar chart shows all machines sorted by OEE
- [ ] Table view displays paginated data with sorting and filtering
- [ ] Summary statistics show average, variance, days on/below target
- [ ] CSV export generates correct file with all columns
- [ ] PDF export generates formatted report with charts
- [ ] Excel export creates multi-sheet workbook
- [ ] Filter presets can be saved, loaded, and deleted
- [ ] Empty state displayed when no data matches filters
- [ ] Multi-tenant RLS enforced on all queries and exports
- [ ] Performance: 90-day report loads in < 5 seconds
- [ ] Performance: Exports complete in < 10 seconds
- [ ] Unit test coverage > 80%
- [ ] Integration tests pass for all API endpoints
- [ ] E2E tests pass for page interactions

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-01-14 | Initial story creation | ARCHITECT-AGENT |
