# 04.9d - Shift Management

**Story ID:** 04.9d
**Epic:** 04 - Production
**Phase:** Phase 2 (OEE & Analytics)
**Complexity:** M (Medium)
**Estimate:** 3 days
**Type:** Backend + Frontend
**State:** ready
**Priority:** P1

**Primary PRD:** `docs/1-BASELINE/product/modules/PRODUCTION.md` (FR-PROD-021)
**Architecture:** Standard MonoPilot patterns
**UX Wireframes:** N/A (Standard CRUD with calendar view)

## PRD References

| FR ID | Requirement | Priority | Phase | Covered |
|-------|-------------|----------|-------|---------|
| FR-PROD-021 | Shift Management | P1 | Phase 2 | Yes |

## User Story

**As a** production manager,
**I want** to define and manage production shifts,
**So that** I can accurately calculate OEE metrics per shift, plan work orders for specific shifts, and track production performance across different time periods.

**As an** administrator,
**I want** to configure shift schedules including start/end times, break durations, and active days,
**So that** the system correctly attributes production data, downtime, and OEE calculations to the appropriate shifts.

## Goal

Implement comprehensive shift management functionality that serves as the foundation for OEE calculation (04.9a), downtime tracking (04.9b), and machine integration (04.9c). Shifts define the time boundaries for measuring production performance and are essential for accurate availability calculations.

## Scope

**In scope:**
- Shifts CRUD operations (create, read, update, delete)
- Shift configuration fields:
  - Name (e.g., "Day Shift", "Night Shift", "Afternoon Shift")
  - Type (Day, Night, Afternoon, Custom)
  - Start time (HH:MM format)
  - End time (HH:MM format)
  - Duration calculation (auto-calculated, handles midnight crossing)
  - Break time configuration (total break minutes)
  - Days of week selection (Mon-Sun multi-select)
  - Active/Inactive toggle
- Shift calendar view (weekly view showing active shifts per day)
- Current shift indicator on dashboard
- Shifts dropdown for WO assignment
- API endpoints for shift management
- Validation (no overlapping shifts, valid time ranges)
- Integration preparation for OEE calculation
- Multi-tenancy (org_id scoping)

**Out of scope:**
- OEE calculation logic (Story 04.9a)
- Downtime tracking per shift (Story 04.9b)
- Machine integration (Story 04.9c)
- Shift handover notes/logs
- Shift supervisor assignment
- Break scheduling (individual breaks within shift)
- Shift rotation patterns
- Holiday calendar integration
- Shift premium/pay rate configuration

## Dependencies

| Story | Requirement | Status |
|-------|-------------|--------|
| 01.1 | Org Context + Base RLS | Required - provides auth context |
| 04.5 | Production Settings | Optional - enable_oee_tracking flag |

## Acceptance Criteria (Given/When/Then)

### Shift Definition

#### AC-1: Create Shift with All Required Fields
- GIVEN user navigates to `/settings/production/shifts`
- WHEN user clicks "Add Shift" and enters:
  - Name: "Day Shift"
  - Type: "Day"
  - Start Time: "06:00"
  - End Time: "14:00"
  - Break Minutes: 30
  - Days: [Mon, Tue, Wed, Thu, Fri]
  - Active: true
- AND clicks "Save"
- THEN shift is created with:
  - duration_minutes = 480 (auto-calculated)
  - net_production_minutes = 450 (duration - break)
  - Success toast "Shift created successfully" displays

#### AC-2: Shift Duration Auto-Calculation (Standard)
- GIVEN user creates shift with start_time = "06:00" and end_time = "14:00"
- WHEN shift is saved
- THEN duration_minutes = 480 (8 hours)

#### AC-3: Shift Duration Auto-Calculation (Midnight Crossing)
- GIVEN user creates shift with start_time = "22:00" and end_time = "06:00"
- WHEN shift is saved
- THEN duration_minutes = 480 (handles midnight crossing correctly)

#### AC-4: Validate Same Start and End Time
- GIVEN user creates shift with start_time = "14:00" and end_time = "14:00"
- WHEN user clicks "Save"
- THEN validation error "End time must differ from start time" displays
- AND shift is NOT saved

#### AC-5: Shift Name Uniqueness per Org
- GIVEN org already has shift named "Day Shift"
- WHEN user attempts to create another shift named "Day Shift"
- THEN validation error "Shift name already exists" displays
- AND shift is NOT saved

#### AC-6: Shift Name Required
- GIVEN user creates shift without entering name
- WHEN user clicks "Save"
- THEN validation error "Shift name is required" displays

### Shift Types

#### AC-7: Shift Type Selection
- GIVEN user is creating a shift
- WHEN shift type dropdown is displayed
- THEN options include: Day, Night, Afternoon, Custom
- AND each type has associated icon/color for UI distinction

#### AC-8: Shift Type Does Not Restrict Times
- GIVEN user selects type "Night" for a shift
- WHEN user enters start_time = "08:00" and end_time = "16:00"
- THEN shift saves successfully (type is descriptive only, not restrictive)

### Break Time Configuration

#### AC-9: Break Minutes Validation - Zero Allowed
- GIVEN user creates shift with break_minutes = 0
- WHEN shift is saved
- THEN shift saves successfully (continuous shift allowed)
- AND net_production_minutes = duration_minutes

#### AC-10: Break Minutes Validation - Cannot Exceed Duration
- GIVEN shift has duration_minutes = 480
- WHEN user enters break_minutes = 500
- THEN validation error "Break time cannot exceed shift duration" displays

#### AC-11: Break Minutes Affects Net Production Time
- GIVEN shift with duration_minutes = 480 and break_minutes = 30
- WHEN net_production_minutes is calculated
- THEN net_production_minutes = 450

### Days of Week Configuration

#### AC-12: Days of Week Multi-Select
- GIVEN user is creating a shift
- WHEN days of week selector is displayed
- THEN user can select multiple days (checkboxes for Mon-Sun)
- AND at least one day must be selected

#### AC-13: No Days Selected Validation
- GIVEN user creates shift without selecting any days
- WHEN user clicks "Save"
- THEN validation error "At least one day must be selected" displays

#### AC-14: Weekend-Only Shift
- GIVEN user creates shift with days = [Sat, Sun] only
- WHEN shift is saved
- THEN shift saves successfully
- AND shift only appears on weekend days in calendar

### Active/Inactive Status

#### AC-15: Deactivate Shift
- GIVEN active shift "Day Shift" exists
- WHEN user toggles is_active to false and saves
- THEN shift no longer appears in:
  - WO shift assignment dropdown
  - Current shift indicator
  - OEE calculations
- BUT shift remains in shift list with "Inactive" badge

#### AC-16: Reactivate Shift
- GIVEN inactive shift "Day Shift" exists
- WHEN user toggles is_active to true and saves
- THEN shift appears in all active shift contexts

### Shift Calendar View

#### AC-17: Weekly Calendar Display
- GIVEN 3 shifts exist: Day (Mon-Fri 06:00-14:00), Afternoon (Mon-Fri 14:00-22:00), Night (Mon-Fri 22:00-06:00)
- WHEN user views shift calendar
- THEN weekly calendar displays with:
  - 7 columns (Mon-Sun)
  - Time slots showing shift blocks
  - Color-coded by shift type
  - Shift name labels on blocks

#### AC-18: Calendar Shows Active Shifts Only
- GIVEN Day Shift is active and Night Shift is inactive
- WHEN user views shift calendar
- THEN only Day Shift displays on calendar
- AND toggle available to "Show inactive shifts"

#### AC-19: Click Shift Block Opens Edit
- GIVEN shift calendar is displayed
- WHEN user clicks on a shift block
- THEN edit shift modal opens for that shift

### Current Shift Indicator

#### AC-20: Current Shift Display on Dashboard
- GIVEN "Day" shift (06:00-14:00) is active and current time = 09:00
- WHEN user views production dashboard
- THEN "Current Shift: Day" indicator displays in header

#### AC-21: No Current Shift (Outside All Shifts)
- GIVEN shifts only defined for Mon-Fri
- WHEN current day is Saturday at 10:00
- THEN "Current Shift: None" or "No Active Shift" indicator displays

#### AC-22: Current Shift Calculation with Midnight Crossing
- GIVEN Night shift (22:00-06:00) is active
- WHEN current time = 02:00 (next day)
- THEN "Current Shift: Night" indicator displays (recognizes overnight shift)

### Shift Selection for Work Orders

#### AC-23: Shift Dropdown in WO Planning
- GIVEN 3 active shifts exist
- WHEN user creates or edits work order
- THEN shift dropdown shows only active shifts

#### AC-24: Shift Assignment Optional
- GIVEN user creates work order
- WHEN shift is not selected
- THEN WO saves successfully with shift_id = null
- AND WO can run across any shift

### OEE Integration Preparation

#### AC-25: Net Production Minutes for OEE
- GIVEN shift "Day" with duration_minutes = 480 and break_minutes = 30
- WHEN OEE availability is calculated (in Story 04.9a)
- THEN planned_production_time = 450 minutes (net production time)

#### AC-26: Shift Links to OEE Metrics
- GIVEN shift "Day" is used for production
- WHEN OEE metrics are calculated (in Story 04.9a)
- THEN oee_metrics.shift_id references this shift

### API Endpoints

#### AC-27: GET /api/production/shifts - List All Org Shifts
- GIVEN org has 3 shifts configured
- WHEN API call `GET /api/production/shifts` is made
- THEN response status 200 OK
- AND response contains all 3 shifts for authenticated org
- AND response includes: id, name, type, start_time, end_time, duration_minutes, break_minutes, days_of_week, is_active, net_production_minutes

#### AC-28: GET /api/production/shifts/current - Get Current Shift
- GIVEN current time = 10:00 and "Day" shift (06:00-14:00) is active on current day
- WHEN API call `GET /api/production/shifts/current` is made
- THEN response status 200 OK
- AND response contains "Day" shift object

#### AC-29: GET /api/production/shifts/current - No Current Shift
- GIVEN no shifts defined for current day/time
- WHEN API call `GET /api/production/shifts/current` is made
- THEN response status 200 OK
- AND response body `{ "shift": null, "message": "No active shift for current time" }`

#### AC-30: POST /api/production/shifts - Create Shift
- GIVEN valid shift data
- WHEN API call `POST /api/production/shifts` with body is made
- THEN response status 201 Created
- AND response contains created shift with generated ID
- AND duration_minutes is auto-calculated

#### AC-31: PUT /api/production/shifts/:id - Update Shift
- GIVEN existing shift with id = "shift-123"
- WHEN API call `PUT /api/production/shifts/shift-123` with updated data
- THEN response status 200 OK
- AND response contains updated shift
- AND duration_minutes recalculated if times changed

#### AC-32: DELETE /api/production/shifts/:id - Delete Shift
- GIVEN existing shift with id = "shift-123" not referenced by any WO
- WHEN API call `DELETE /api/production/shifts/shift-123`
- THEN response status 200 OK
- AND shift removed from database

#### AC-33: DELETE Shift Referenced by WO - Soft Delete
- GIVEN shift "shift-123" is referenced by 5 work orders
- WHEN API call `DELETE /api/production/shifts/shift-123`
- THEN response status 200 OK
- AND shift is_active set to false (soft delete)
- AND shift remains in database for historical data integrity

### Multi-tenancy

#### AC-34: Org Isolation - View
- GIVEN Org A has 3 shifts and Org B has 2 shifts
- WHEN user from Org A calls `GET /api/production/shifts`
- THEN response contains only Org A's 3 shifts
- AND RLS policy blocks cross-org access

#### AC-35: Org Isolation - Create
- GIVEN user from Org A creates a shift
- WHEN shift is saved
- THEN shift.org_id = Org A's org_id
- AND shift cannot be accessed by Org B users

#### AC-36: Org Isolation - Update
- GIVEN shift belongs to Org A
- WHEN user from Org B attempts to update shift
- THEN response status 404 Not Found (not 403, for security)

### Validation Edge Cases

#### AC-37: Overlapping Shifts Warning
- GIVEN "Day" shift exists (06:00-14:00, Mon-Fri)
- WHEN user creates new shift (08:00-12:00, Mon-Fri)
- THEN warning displays "This shift overlaps with: Day Shift"
- AND shift can still be saved (warning only, not blocking)

#### AC-38: No Shifts Configured Warning for OEE
- GIVEN enable_oee_tracking = true (in production_settings)
- AND no shifts are configured
- WHEN user navigates to OEE dashboard
- THEN warning "No active shifts configured. Configure shifts to calculate OEE." displays

## Technical Specification

### Database Schema

#### shifts table

```sql
CREATE TABLE shifts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,

  -- Shift identification
  name VARCHAR(100) NOT NULL,
  type VARCHAR(20) NOT NULL DEFAULT 'custom',  -- 'day', 'night', 'afternoon', 'custom'
  description TEXT,

  -- Time configuration
  start_time TIME NOT NULL,
  end_time TIME NOT NULL,
  duration_minutes INTEGER NOT NULL,  -- Auto-calculated, stored for performance
  break_minutes INTEGER NOT NULL DEFAULT 0 CHECK (break_minutes >= 0),
  net_production_minutes INTEGER GENERATED ALWAYS AS (duration_minutes - break_minutes) STORED,

  -- Schedule
  days_of_week INTEGER[] NOT NULL DEFAULT '{1,2,3,4,5}',  -- 1=Mon, 7=Sun (ISO weekday)

  -- Status
  is_active BOOLEAN NOT NULL DEFAULT true,

  -- Metadata
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  created_by UUID REFERENCES users(id),

  -- Constraints
  CONSTRAINT shifts_name_org_unique UNIQUE (org_id, name),
  CONSTRAINT shifts_start_end_different CHECK (start_time <> end_time),
  CONSTRAINT shifts_break_not_exceed_duration CHECK (break_minutes <= duration_minutes),
  CONSTRAINT shifts_type_valid CHECK (type IN ('day', 'night', 'afternoon', 'custom'))
);

-- Indexes
CREATE INDEX idx_shifts_org_id ON shifts(org_id);
CREATE INDEX idx_shifts_active ON shifts(org_id) WHERE is_active = true;
CREATE INDEX idx_shifts_type ON shifts(org_id, type);

-- RLS Policies
ALTER TABLE shifts ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view their org's shifts"
  ON shifts FOR SELECT
  USING (org_id = auth.org_id());

CREATE POLICY "Users can create shifts for their org"
  ON shifts FOR INSERT
  WITH CHECK (org_id = auth.org_id());

CREATE POLICY "Users can update their org's shifts"
  ON shifts FOR UPDATE
  USING (org_id = auth.org_id());

CREATE POLICY "Users can delete their org's shifts"
  ON shifts FOR DELETE
  USING (org_id = auth.org_id());

-- Trigger for updated_at
CREATE TRIGGER update_shifts_updated_at
  BEFORE UPDATE ON shifts
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();
```

#### Duration Calculation Function

```sql
-- Function to calculate shift duration (handles midnight crossing)
CREATE OR REPLACE FUNCTION calculate_shift_duration(
  p_start_time TIME,
  p_end_time TIME
) RETURNS INTEGER AS $$
DECLARE
  v_duration INTERVAL;
BEGIN
  IF p_end_time > p_start_time THEN
    -- Same day shift (e.g., 06:00 to 14:00)
    v_duration := p_end_time - p_start_time;
  ELSE
    -- Overnight shift (e.g., 22:00 to 06:00)
    v_duration := ('24:00:00'::TIME - p_start_time) + p_end_time;
  END IF;

  RETURN EXTRACT(EPOCH FROM v_duration) / 60;
END;
$$ LANGUAGE plpgsql IMMUTABLE;

-- Trigger to auto-calculate duration on insert/update
CREATE OR REPLACE FUNCTION calculate_shift_duration_trigger()
RETURNS TRIGGER AS $$
BEGIN
  NEW.duration_minutes := calculate_shift_duration(NEW.start_time, NEW.end_time);
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER shifts_calc_duration
  BEFORE INSERT OR UPDATE OF start_time, end_time ON shifts
  FOR EACH ROW
  EXECUTE FUNCTION calculate_shift_duration_trigger();
```

#### Current Shift Function

```sql
-- Function to get current shift for an org
CREATE OR REPLACE FUNCTION get_current_shift(p_org_id UUID)
RETURNS SETOF shifts AS $$
DECLARE
  v_current_time TIME;
  v_current_dow INTEGER;
BEGIN
  v_current_time := LOCALTIME;
  v_current_dow := EXTRACT(ISODOW FROM CURRENT_DATE);  -- 1=Monday, 7=Sunday

  RETURN QUERY
  SELECT s.*
  FROM shifts s
  WHERE s.org_id = p_org_id
    AND s.is_active = true
    AND v_current_dow = ANY(s.days_of_week)
    AND (
      -- Same day shift
      (s.end_time > s.start_time AND v_current_time >= s.start_time AND v_current_time < s.end_time)
      OR
      -- Overnight shift (current time after start OR before end)
      (s.end_time < s.start_time AND (v_current_time >= s.start_time OR v_current_time < s.end_time))
    )
  LIMIT 1;
END;
$$ LANGUAGE plpgsql STABLE SECURITY DEFINER;
```

### API Endpoints

```
# Shift Management
GET    /api/production/shifts                    - List all org shifts
GET    /api/production/shifts/current            - Get current active shift
GET    /api/production/shifts/:id                - Get specific shift
POST   /api/production/shifts                    - Create new shift
PUT    /api/production/shifts/:id                - Update shift
DELETE /api/production/shifts/:id                - Delete/deactivate shift

# Calendar View
GET    /api/production/shifts/calendar           - Get shifts formatted for calendar view
       Query params: ?week_start=YYYY-MM-DD
```

### Service Methods

**Location:** `lib/services/shift-service.ts`

```typescript
export interface Shift {
  id: string;
  org_id: string;
  name: string;
  type: 'day' | 'night' | 'afternoon' | 'custom';
  description?: string;
  start_time: string;  // "HH:MM"
  end_time: string;    // "HH:MM"
  duration_minutes: number;
  break_minutes: number;
  net_production_minutes: number;
  days_of_week: number[];  // [1,2,3,4,5] = Mon-Fri
  is_active: boolean;
  created_at: string;
  updated_at: string;
  created_by?: string;
}

export interface CreateShiftInput {
  name: string;
  type?: 'day' | 'night' | 'afternoon' | 'custom';
  description?: string;
  start_time: string;
  end_time: string;
  break_minutes?: number;
  days_of_week: number[];
  is_active?: boolean;
}

export interface UpdateShiftInput {
  name?: string;
  type?: 'day' | 'night' | 'afternoon' | 'custom';
  description?: string;
  start_time?: string;
  end_time?: string;
  break_minutes?: number;
  days_of_week?: number[];
  is_active?: boolean;
}

export interface ShiftService {
  // CRUD
  getShifts(): Promise<Shift[]>;
  getActiveShifts(): Promise<Shift[]>;
  getShift(id: string): Promise<Shift | null>;
  createShift(input: CreateShiftInput): Promise<Shift>;
  updateShift(id: string, input: UpdateShiftInput): Promise<Shift>;
  deleteShift(id: string): Promise<void>;

  // Current shift
  getCurrentShift(): Promise<Shift | null>;
  isWithinShift(time: Date, shift: Shift): boolean;

  // Calendar
  getShiftsForCalendar(weekStart: Date): Promise<CalendarShift[]>;

  // Validation
  validateShiftTimes(start: string, end: string): ValidationResult;
  checkOverlappingShifts(shift: CreateShiftInput): Promise<Shift[]>;

  // Utilities
  calculateDuration(startTime: string, endTime: string): number;
  getNetProductionMinutes(shift: Shift): number;
  formatShiftTime(time: string): string;
  getDayName(dayNumber: number): string;
}

export interface CalendarShift {
  id: string;
  name: string;
  type: string;
  color: string;
  start_time: string;
  end_time: string;
  day: number;
  dayName: string;
}

export interface ValidationResult {
  valid: boolean;
  errors: string[];
}
```

### Zod Validation Schemas

**Location:** `lib/validation/shift.ts`

```typescript
import { z } from 'zod';

// Time format validation (HH:MM)
const timeSchema = z.string().regex(
  /^([01]\d|2[0-3]):([0-5]\d)$/,
  'Invalid time format. Use HH:MM (e.g., 06:00)'
);

// Days of week validation (1-7, ISO weekday)
const daysOfWeekSchema = z.array(
  z.number().int().min(1).max(7)
).min(1, 'At least one day must be selected');

// Shift type enum
const shiftTypeSchema = z.enum(['day', 'night', 'afternoon', 'custom']).default('custom');

// Create shift schema
export const createShiftSchema = z.object({
  name: z.string()
    .min(1, 'Shift name is required')
    .max(100, 'Shift name must not exceed 100 characters'),
  type: shiftTypeSchema,
  description: z.string().max(500).optional(),
  start_time: timeSchema,
  end_time: timeSchema,
  break_minutes: z.number()
    .int()
    .min(0, 'Break time cannot be negative')
    .max(1440, 'Break time cannot exceed 24 hours')
    .default(0),
  days_of_week: daysOfWeekSchema,
  is_active: z.boolean().default(true),
}).refine(
  (data) => data.start_time !== data.end_time,
  { message: 'End time must differ from start time', path: ['end_time'] }
);

// Update shift schema (all fields optional)
export const updateShiftSchema = z.object({
  name: z.string()
    .min(1, 'Shift name is required')
    .max(100, 'Shift name must not exceed 100 characters')
    .optional(),
  type: shiftTypeSchema.optional(),
  description: z.string().max(500).optional(),
  start_time: timeSchema.optional(),
  end_time: timeSchema.optional(),
  break_minutes: z.number()
    .int()
    .min(0, 'Break time cannot be negative')
    .max(1440, 'Break time cannot exceed 24 hours')
    .optional(),
  days_of_week: daysOfWeekSchema.optional(),
  is_active: z.boolean().optional(),
});

// Shift response schema
export const shiftSchema = z.object({
  id: z.string().uuid(),
  org_id: z.string().uuid(),
  name: z.string(),
  type: shiftTypeSchema,
  description: z.string().nullable(),
  start_time: z.string(),
  end_time: z.string(),
  duration_minutes: z.number(),
  break_minutes: z.number(),
  net_production_minutes: z.number(),
  days_of_week: z.array(z.number()),
  is_active: z.boolean(),
  created_at: z.string().datetime(),
  updated_at: z.string().datetime(),
  created_by: z.string().uuid().nullable(),
});

export const shiftsListSchema = z.array(shiftSchema);

// Export types
export type CreateShiftInput = z.infer<typeof createShiftSchema>;
export type UpdateShiftInput = z.infer<typeof updateShiftSchema>;
export type Shift = z.infer<typeof shiftSchema>;
```

## UI Components

### Pages

- `app/(authenticated)/settings/production/shifts/page.tsx` - Shifts management page
- `app/(authenticated)/settings/production/shifts/[id]/page.tsx` - Edit shift page (optional, can use modal)

### Components

**Location:** `components/production/shifts/`

```
ShiftsList.tsx              - List of all shifts with actions
ShiftCard.tsx               - Individual shift display card
ShiftForm.tsx               - Create/Edit shift form
ShiftCalendar.tsx           - Weekly calendar view of shifts
ShiftDeleteDialog.tsx       - Confirmation dialog for shift deletion
ShiftTypeSelect.tsx         - Shift type dropdown with icons
DaysOfWeekSelector.tsx      - Multi-select for days (Mon-Sun checkboxes)
TimeInput.tsx               - Time picker input (HH:MM format)
CurrentShiftIndicator.tsx   - Dashboard header shift indicator
ShiftDropdown.tsx           - Shift selector for WO forms
```

### Component Details

**ShiftsList.tsx**
```tsx
interface ShiftsListProps {
  shifts: Shift[];
  onEdit: (shift: Shift) => void;
  onDelete: (shiftId: string) => void;
  onToggleActive: (shiftId: string, isActive: boolean) => void;
  showInactive?: boolean;
  isLoading?: boolean;
}
```

**ShiftForm.tsx**
```tsx
interface ShiftFormProps {
  shift?: Shift;  // undefined for create, defined for edit
  onSubmit: (data: CreateShiftInput | UpdateShiftInput) => Promise<void>;
  onCancel: () => void;
  isLoading?: boolean;
}

// Form sections:
// 1. Basic Info: Name, Type, Description
// 2. Schedule: Start Time, End Time, Break Minutes
// 3. Active Days: Mon-Sun checkboxes
// 4. Status: Active toggle
```

**ShiftCalendar.tsx**
```tsx
interface ShiftCalendarProps {
  shifts: Shift[];
  weekStart: Date;
  onShiftClick: (shift: Shift) => void;
  onWeekChange: (direction: 'prev' | 'next') => void;
  showInactive?: boolean;
}

// Layout:
// - 7 columns (Mon-Sun)
// - 24-hour time axis (vertical)
// - Colored blocks for each shift
// - Click to edit
```

**CurrentShiftIndicator.tsx**
```tsx
interface CurrentShiftIndicatorProps {
  className?: string;
}

// Displays in dashboard header:
// "Current Shift: Day (06:00 - 14:00)"
// or "No Active Shift"
```

### UI Layout

**Shifts List Page:**
```
+--------------------------------------------------+
| Production Settings > Shifts                      |
+--------------------------------------------------+
| [+ Add Shift]                    [ ] Show Inactive|
+--------------------------------------------------+
| Shift Name    | Type  | Times      | Days | Status |
|---------------|-------|------------|------|--------|
| Day Shift     | Day   | 06:00-14:00| M-F  | Active |
| Afternoon     | Aftn  | 14:00-22:00| M-F  | Active |
| Night Shift   | Night | 22:00-06:00| M-F  | Active |
| Weekend Day   | Day   | 08:00-16:00| S-Su | Inactive|
+--------------------------------------------------+
```

**Shift Form:**
```
+------------------------------------------+
| Create Shift / Edit Shift                |
+------------------------------------------+
| Basic Information                        |
| Shift Name:  [Day Shift          ]       |
| Type:        [Day        v]              |
| Description: [Morning production shift]  |
+------------------------------------------+
| Schedule                                 |
| Start Time:  [06:00]    End Time: [14:00]|
| Duration:    8 hours (auto-calculated)   |
| Break Time:  [30] minutes                |
| Net Production: 7.5 hours                |
+------------------------------------------+
| Active Days                              |
| [x] Mon [x] Tue [x] Wed [x] Thu [x] Fri  |
| [ ] Sat [ ] Sun                          |
+------------------------------------------+
| Status                                   |
| [x] Active                               |
+------------------------------------------+
|                    [Cancel]  [Save]      |
+------------------------------------------+
```

**Shift Calendar View:**
```
+-------------------------------------------------------+
| < Week: Jan 6-12, 2025 >                              |
+-------+-------+-------+-------+-------+-------+-------+
|  Mon  |  Tue  |  Wed  |  Thu  |  Fri  |  Sat  |  Sun  |
+-------+-------+-------+-------+-------+-------+-------+
| 06:00 |       |       |       |       |       |       |
| [=DAY=]       |       |       |       |       |       |
| 14:00 |       |       |       |       |       |       |
| [AFTN=]       |       |       |       |       |       |
| 22:00 |       |       |       |       |       |       |
| [NIGHT]       |       |       |       |       |       |
+-------------------------------------------------------+
```

## Test Cases

### Unit Tests

**shift-service.test.ts**
```typescript
describe('ShiftService', () => {
  describe('calculateDuration', () => {
    it('calculates duration for same-day shift (06:00-14:00) = 480 min');
    it('calculates duration for overnight shift (22:00-06:00) = 480 min');
    it('calculates duration for short shift (09:00-12:00) = 180 min');
    it('calculates duration for 24-hour edge case (00:00-00:00) returns error');
  });

  describe('isWithinShift', () => {
    it('returns true when time is within same-day shift');
    it('returns true when time is within overnight shift (before midnight)');
    it('returns true when time is within overnight shift (after midnight)');
    it('returns false when time is outside shift hours');
    it('returns false when day is not in days_of_week');
  });

  describe('validateShiftTimes', () => {
    it('accepts valid time range');
    it('rejects same start and end time');
    it('rejects invalid time format');
  });

  describe('checkOverlappingShifts', () => {
    it('detects overlapping shifts on same days');
    it('allows non-overlapping shifts on same days');
    it('allows overlapping times on different days');
  });
});
```

**shift-validation.test.ts**
```typescript
describe('Shift Zod Schemas', () => {
  describe('createShiftSchema', () => {
    it('accepts valid shift data');
    it('rejects empty name');
    it('rejects invalid time format');
    it('rejects empty days_of_week');
    it('rejects same start and end time');
    it('rejects negative break_minutes');
    it('rejects invalid shift type');
  });

  describe('updateShiftSchema', () => {
    it('accepts partial updates');
    it('validates provided fields');
    it('allows empty object (no changes)');
  });
});
```

### Integration Tests

**shift-api.test.ts**
```typescript
describe('Shift API', () => {
  describe('GET /api/production/shifts', () => {
    it('returns all shifts for authenticated org');
    it('returns empty array for new org');
    it('excludes other org shifts (RLS)');
    it('returns 401 for unauthenticated request');
  });

  describe('GET /api/production/shifts/current', () => {
    it('returns current shift when within active shift');
    it('returns null when outside all shifts');
    it('handles overnight shifts correctly');
  });

  describe('POST /api/production/shifts', () => {
    it('creates shift with auto-calculated duration');
    it('rejects duplicate shift name');
    it('rejects invalid time format');
    it('sets org_id from auth context');
  });

  describe('PUT /api/production/shifts/:id', () => {
    it('updates specified fields only');
    it('recalculates duration on time change');
    it('returns 404 for other org shift');
  });

  describe('DELETE /api/production/shifts/:id', () => {
    it('deletes unreferenced shift');
    it('soft-deletes shift with WO references');
    it('returns 404 for other org shift');
  });
});
```

### E2E Tests

**shift-management.spec.ts**
```typescript
describe('Shift Management', () => {
  it('displays shifts list');
  it('creates new shift with all fields');
  it('validates shift creation form');
  it('edits existing shift');
  it('toggles shift active status');
  it('deletes shift with confirmation');
  it('shows current shift indicator on dashboard');
  it('displays shift calendar view');
  it('selects shift in work order form');
});
```

## Business Rules

1. **Shift Uniqueness**: Each shift name must be unique within an organization
2. **Duration Auto-Calculation**: Duration is always calculated from start_time and end_time
3. **Midnight Crossing**: System handles overnight shifts (e.g., 22:00-06:00) correctly
4. **Break Validation**: Break minutes cannot exceed shift duration
5. **Days Required**: At least one day of the week must be selected
6. **Soft Delete**: Shifts with WO references are deactivated, not deleted
7. **Active Only for Operations**: Only active shifts appear in WO dropdowns and OEE calculations
8. **Net Production Time**: OEE uses net_production_minutes (duration - breaks) for availability calculation
9. **Overlapping Warning**: Overlapping shifts trigger warning but don't block creation
10. **Org Isolation**: All shifts are scoped to org_id via RLS

## Deliverables

- [ ] `supabase/migrations/XXX_create_shifts_table.sql` (table + RLS + functions)
- [ ] API routes:
  - `app/api/production/shifts/route.ts` (GET, POST)
  - `app/api/production/shifts/[id]/route.ts` (GET, PUT, DELETE)
  - `app/api/production/shifts/current/route.ts` (GET)
  - `app/api/production/shifts/calendar/route.ts` (GET)
- [ ] Service: `lib/services/shift-service.ts`
- [ ] Validation: `lib/validation/shift.ts`
- [ ] Components:
  - `ShiftsList.tsx`
  - `ShiftCard.tsx`
  - `ShiftForm.tsx`
  - `ShiftCalendar.tsx`
  - `ShiftDeleteDialog.tsx`
  - `ShiftTypeSelect.tsx`
  - `DaysOfWeekSelector.tsx`
  - `TimeInput.tsx`
  - `CurrentShiftIndicator.tsx`
  - `ShiftDropdown.tsx`
- [ ] Pages:
  - `app/(authenticated)/settings/production/shifts/page.tsx`
- [ ] Tests:
  - `lib/services/shift-service.test.ts`
  - `lib/validation/shift.test.ts`
  - `app/api/production/shifts/route.test.ts`
  - `e2e/shift-management.spec.ts`

## Definition of Done

- [ ] Database migration creates `shifts` table with all fields and constraints
- [ ] RLS policies enforce org_id isolation (tested with multi-org scenarios)
- [ ] Duration auto-calculated on insert/update (including midnight crossing)
- [ ] net_production_minutes computed column works correctly
- [ ] GET /api/production/shifts returns all org shifts
- [ ] GET /api/production/shifts/current returns current shift or null
- [ ] POST /api/production/shifts creates shift with validation
- [ ] PUT /api/production/shifts/:id updates shift with validation
- [ ] DELETE /api/production/shifts/:id handles soft-delete for referenced shifts
- [ ] Shift form validates all fields with real-time feedback
- [ ] Shift name uniqueness enforced per org
- [ ] Days of week multi-select requires at least one selection
- [ ] Break minutes cannot exceed duration
- [ ] Shift calendar displays weekly view with colored blocks
- [ ] Current shift indicator displays on production dashboard
- [ ] Shift dropdown available in WO planning forms
- [ ] Inactive shifts excluded from operational contexts
- [ ] Overlapping shift warning implemented
- [ ] API tests passing (>80% coverage)
- [ ] Unit tests for duration calculation (including overnight)
- [ ] E2E test: Create, edit, delete shift workflow
- [ ] Performance: Shift list loads within 500ms
- [ ] No console errors on shifts page
- [ ] Code review approved
- [ ] PR merged to main

## Integration Points

### With OEE Calculation (04.9a)
- Provides `net_production_minutes` for availability calculation
- shift_id referenced in oee_metrics table
- Current shift determines active OEE calculation context

### With Downtime Tracking (04.9b)
- Downtime attributed to specific shift
- Availability calculated per shift

### With Machine Integration (04.9c)
- Machine utilization tracked per shift
- Production counters reset at shift boundaries (optional)

### With Work Order Planning (03.x)
- Optional shift assignment for WOs
- Shift-based capacity planning

### With Production Dashboard (04.1)
- Current shift indicator
- Shift filter for KPIs

## Notes

**Design Decisions:**
1. **Stored Duration**: Duration is calculated and stored (not computed at query time) for performance in OEE calculations
2. **Generated Column**: `net_production_minutes` is a generated column for automatic maintenance
3. **ISO Weekday**: Using ISO 8601 weekday numbers (1=Monday, 7=Sunday) for consistency
4. **Soft Delete**: Shifts with references are deactivated to preserve historical data integrity
5. **Overlapping Allowed**: Overlapping shifts are allowed with warning (some facilities have overlapping shift handover periods)

**Future Enhancements (Not in This Story):**
- Shift rotation patterns (3-shift rotation, 4-day work week)
- Holiday calendar integration
- Shift supervisor assignment
- Individual break scheduling
- Shift handover notes/logs
- Shift premium configuration

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-01-14 | Initial story creation | ARCHITECT-AGENT |
