# 04.7c - By-Product Registration

**Story ID:** 04.7c
**Epic:** 04 - Production
**Phase:** 1 (MVP)
**Complexity:** S (Small)
**Estimate:** 2 days
**Type:** Full-stack
**State:** COMPLETE + DEPLOYED (2026-01-21)

**Primary PRD:** `docs/1-BASELINE/product/modules/PRODUCTION.md` (FR-PROD-013)
**UX Wireframes:** PROD-004-part2 (By-Products Section, Register By-Product Flow)

## Implementation Summary

**Deployed:** 2026-01-21
**Tests:** 160 (P2 RED) -> 116/116 (P3 GREEN)
**AC:** 8/8 passed
**QA:** PASS (zero bugs)
**Code Review:** APPROVED (zero issues)

### Files Created/Modified

**Services:**
- `apps/frontend/lib/services/by-product-service.ts` - By-product registration service with expected qty calculation, auto-create, manual registration, genealogy linkage

**Validation:**
- `apps/frontend/lib/validation/by-product-schemas.ts` - Zod schemas for registration request and status

**API:**
- `apps/frontend/app/api/production/work-orders/[id]/by-products/route.ts` - GET/POST endpoints for by-product status and registration

**Components:**
- `apps/frontend/components/production/outputs/ByProductsSection.tsx` - Desktop by-products section with progress bars
- `apps/frontend/components/production/ByProductRegistrationDialog.tsx` - Manual registration modal
- `apps/frontend/components/scanner/output/ByProductPromptStep.tsx` - Scanner workflow step

**Tests:**
- `apps/frontend/__tests__/lib/services/by-product-service.test.ts`
- `apps/frontend/__tests__/lib/validation/by-product-schemas.test.ts`
- `apps/frontend/__tests__/api/production/by-product-registration.test.ts`
- `apps/frontend/__tests__/components/production/ByProductsSection.test.ts`

**Documentation:**
- `docs/guides/production/by-product-registration-guide.md` - Comprehensive user/developer guide

---

## PRD References

| FR ID | Requirement | Priority | Phase | Covered |
|-------|-------------|----------|-------|---------|
| FR-PROD-013 | By-Product Registration | P0 | MVP | Yes |

## User Story

**As a** production operator,
**I want** to register by-products generated during production,
**So that** I can track yield, maintain traceability, and ensure accurate inventory for secondary outputs.

**As a** production manager,
**I want** by-products to be automatically created when enabled,
**So that** operators can focus on production without manual tracking overhead.

## Goal

Implement by-product registration functionality that calculates expected quantities from BOM yield percentages, supports both auto-creation and manual entry, creates proper LP records with genealogy linkage to source materials, and provides clear visibility of by-product registration status.

## Scope

**In scope:**
- Display expected by-product qty from BOM yield_percent
- Auto-create by-product LPs when setting enabled
- Manual entry flow when auto-create disabled
- Separate LP per by-product type
- Shared genealogy with main output
- Zero qty warning with confirmation
- Batch auto-generation with format `{main_batch}-BP-{code}`
- By-product section on output registration page
- Progress tracking (actual vs expected)

**Out of scope:**
- By-product quality testing workflow
- By-product cost allocation
- Partial by-product registration across multiple outputs
- By-product rejection workflow

## Dependencies

| Story | Requirement | Status |
|-------|-------------|--------|
| 04.7a | Output Registration Desktop | Required - provides production_outputs table, LP creation flow |
| 05.1 | License Plates CRUD | Required - provides LP table, LP service |
| 05.5 | LP Genealogy | Required - provides lp_genealogy table, parent-child tracking |
| 03.11a | WO BOM Snapshot | Required - provides wo_materials.is_by_product, yield_percent |
| 04.5 | Production Settings | Required - provides auto_create_by_product_lp setting |

## Acceptance Criteria (Given/When/Then)

### Expected Quantity Calculation

- [x] GIVEN WO.planned_qty = 1000 AND by-product yield_percent = 5, WHEN by-product prompt displays, THEN expected qty shows as 50.
- [x] GIVEN WO.planned_qty = 5000 AND by-product yield_percent = 2.5, WHEN calculated, THEN expected qty = 125.
- [x] GIVEN WO.planned_qty = 0 OR yield_percent = 0, WHEN calculated, THEN expected qty = 0.

### Auto-Create By-Products

- [x] GIVEN auto_create_by_product_lp = true, WHEN main output registered, THEN by-product LPs auto-created with expected quantities.
- [x] GIVEN auto_create_by_product_lp = true AND BOM has 3 by-products, WHEN main output registered, THEN all 3 by-product LPs created in same transaction.
- [x] GIVEN auto_create enabled, WHEN by-products created, THEN success toast shows count of created LPs.
- [x] GIVEN auto_create enabled AND by-product qty = 0, WHEN main output registered, THEN by-product LP created with qty = 0.

### Manual By-Product Registration

- [x] GIVEN auto_create_by_product_lp = false, WHEN main output registered, THEN user manually enters by-product quantities.
- [x] GIVEN by-product expected = 50 AND user enters actual = 45, WHEN registered, THEN LP created with qty = 45.
- [x] GIVEN manual flow, WHEN modal opens, THEN quantity pre-filled with expected qty.
- [x] GIVEN manual flow, WHEN user clicks "Register By-Product", THEN LP created and by-product status updated.

### Zero Quantity Handling

- [x] GIVEN by-product qty entered = 0, WHEN user confirms, THEN warning "By-product quantity is 0. Continue?" displays.
- [x] GIVEN zero qty warning shown, WHEN user clicks "Confirm Anyway", THEN LP registered with qty = 0.
- [x] GIVEN zero qty warning shown, WHEN user clicks "Skip By-Product", THEN by-product skipped, no LP created.
- [x] GIVEN zero qty warning shown, WHEN user clicks "Cancel", THEN returns to form.

### Genealogy Linkage

- [x] GIVEN by-product registered, WHEN genealogy queried, THEN by-product LP has same parent_lp_ids as main output LP.
- [x] GIVEN main output has 2 parent LPs (from consumed materials), WHEN by-product registered, THEN by-product LP shows same 2 parents.
- [x] GIVEN genealogy copied, WHEN viewing by-product LP detail, THEN parent LPs display with consumed quantities.

### Batch Number Generation

- [x] GIVEN main batch = "B-2025-0156" AND product_code = "BRAN", WHEN by-product registered, THEN batch = "B-2025-0156-BP-BRAN".
- [x] GIVEN batch auto-generated, WHEN user edits batch, THEN edited value saved.
- [x] GIVEN batch number max length = 50, WHEN generated batch exceeds limit, THEN truncated appropriately.

### By-Products Section UI

- [x] GIVEN user on output registration page, WHEN page loads, THEN By-Products section displays below output history.
- [x] GIVEN no by-products defined in BOM, WHEN section renders, THEN "No by-products defined for this WO" message displays.
- [x] GIVEN 2 of 3 by-products registered, WHEN section renders, THEN 2 show "Registered" status, 1 shows "Not Registered".
- [x] GIVEN by-product partially registered, WHEN progress shown, THEN progress bar reflects actual/expected percentage.

### Multi-tenancy

- [x] GIVEN User A from Org A, WHEN requesting by-products, THEN only Org A data returned.
- [x] GIVEN User A from Org A, WHEN attempting to register by-product for Org B WO, THEN 404 Not Found returns.

## Technical Specification

### Database Schema

#### production_outputs table (extension)

```sql
-- Add by-product fields to production_outputs
ALTER TABLE production_outputs
  ADD COLUMN IF NOT EXISTS is_by_product BOOLEAN NOT NULL DEFAULT false,
  ADD COLUMN IF NOT EXISTS parent_output_id UUID REFERENCES production_outputs(id),
  ADD COLUMN IF NOT EXISTS by_product_material_id UUID REFERENCES wo_materials(id);

-- Index for by-product queries
CREATE INDEX IF NOT EXISTS idx_production_outputs_by_product
  ON production_outputs(wo_id, is_by_product);

-- Index for parent output lookup
CREATE INDEX IF NOT EXISTS idx_production_outputs_parent
  ON production_outputs(parent_output_id)
  WHERE parent_output_id IS NOT NULL;
```

#### license_plates table (extension)

```sql
-- Add is_by_product flag to license_plates
ALTER TABLE license_plates
  ADD COLUMN IF NOT EXISTS is_by_product BOOLEAN NOT NULL DEFAULT false;

-- Index for by-product LPs
CREATE INDEX IF NOT EXISTS idx_license_plates_by_product
  ON license_plates(wo_id, is_by_product)
  WHERE is_by_product = true;
```

### RLS Policies

```sql
-- By-product insert policy (existing production_outputs RLS extends)
-- Operators can register by-products (same as main outputs)
CREATE POLICY "by_product_insert" ON production_outputs
FOR INSERT WITH CHECK (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  AND EXISTS (
    SELECT 1 FROM users u
    JOIN roles r ON r.id = u.role_id
    WHERE u.id = auth.uid()
    AND (r.name IN ('admin', 'production_manager', 'operator', 'owner'))
  )
);
```

### API Endpoints

```
# By-Product Registration
POST   /api/production/outputs/by-products           - Register by-product output LP
GET    /api/production/work-orders/:id/by-products   - Get by-product status for WO
```

### Service Methods

**Location:** `lib/services/by-product-service.ts`

```typescript
interface ByProductService {
  // Registration
  registerByProduct(request: RegisterByProductRequest): Promise<ByProductRegistrationResult>;
  autoCreateByProducts(woId: string, mainOutputLpId: string, parentOutputId: string): Promise<ByProductRegistrationResult[]>;

  // Queries
  getByProductsForWO(woId: string): Promise<ByProductStatus[]>;

  // Calculations
  calculateExpectedByProductQty(plannedQty: number, yieldPercent: number): number;
  generateByProductBatch(mainBatch: string, productCode: string): string;
}

interface RegisterByProductRequest {
  wo_id: string;
  main_output_lp_id: string;
  by_product_id: string;
  by_product_material_id: string;
  quantity: number;
  uom: string;
  batch_number?: string;
  qa_status?: 'approved' | 'pending' | 'rejected';
  location_id: string;
  expiry_date?: string;
  notes?: string;
}

interface ByProductStatus {
  product_id: string;
  product_name: string;
  product_code: string;
  material_id: string;
  yield_percent: number;
  expected_qty: number;
  actual_qty: number;
  uom: string;
  lp_count: number;
  status: 'registered' | 'not_registered';
  last_registered_at: string | null;
}

interface ByProductRegistrationResult {
  success: boolean;
  lp: LicensePlate;
  genealogy: GenealogyLink[];
  output_record: ProductionOutput;
  message: string;
}
```

### Zod Validation Schemas

**Location:** `lib/validation/by-product-schemas.ts`

```typescript
import { z } from 'zod';

export const registerByProductSchema = z.object({
  wo_id: z.string().uuid('Invalid WO ID'),
  main_output_lp_id: z.string().uuid('Invalid main output LP ID'),
  by_product_id: z.string().uuid('Invalid by-product ID'),
  by_product_material_id: z.string().uuid('Invalid material ID'),
  quantity: z.number().min(0, 'Quantity cannot be negative'),
  uom: z.string().min(1, 'UoM is required'),
  batch_number: z.string().max(50, 'Batch number too long').optional(),
  qa_status: z.enum(['approved', 'pending', 'rejected']).optional(),
  location_id: z.string().uuid('Invalid location ID'),
  expiry_date: z.string().optional(),
  notes: z.string().max(500, 'Notes too long').optional(),
});

export const byProductStatusSchema = z.object({
  product_id: z.string().uuid(),
  product_name: z.string(),
  product_code: z.string(),
  material_id: z.string().uuid(),
  yield_percent: z.number(),
  expected_qty: z.number(),
  actual_qty: z.number(),
  uom: z.string(),
  lp_count: z.number(),
  status: z.enum(['registered', 'not_registered']),
  last_registered_at: z.string().nullable(),
});

export const byProductsListSchema = z.array(byProductStatusSchema);
```

## UI Components

### Pages

- `app/(authenticated)/production/outputs/[woId]/page.tsx` - Existing output page (add ByProductsSection)

### Components

**Location:** `components/production/outputs/`

```
ByProductsSection.tsx          - Section showing by-product status and actions
RegisterByProductModal.tsx     - Modal for manual by-product registration
ByProductCompletionModal.tsx   - Success modal after all by-products registered
ZeroQtyWarningModal.tsx        - Warning dialog for zero quantity registration
```

### Component Details

**ByProductsSection.tsx**
```tsx
interface ByProductsSectionProps {
  woId: string;
  autoCreateEnabled: boolean;
  byProducts: ByProductStatus[];
  onRegister: (byProduct: ByProductStatus) => void;
  onRegisterAll: () => void;
  isLoading: boolean;
}
```

**RegisterByProductModal.tsx**
```tsx
interface RegisterByProductModalProps {
  byProduct: ByProductStatus;
  mainOutputLpId: string;
  mainBatch: string;
  open: boolean;
  onOpenChange: (open: boolean) => void;
  onSuccess: (result: ByProductRegistrationResult) => void;
}

// Form fields:
// - Product info (read-only: name, code, expected qty, UoM)
// - Actual Quantity (number input, pre-filled)
// - Batch Number (auto-generated, editable)
// - Location (dropdown, pre-selected)
// - Expiry Date (date picker, auto-calculated)
// - QA Status (optional dropdown)
// - Notes (optional textarea)
```

### UI Patterns

**By-Product Card Layout:**
```
+------------------------------------------+
| Wheat Bran (SKU-BP-BRAN)      [Registered]|
|                                           |
| [==============----] 160/250 kg (64%)     |
| 6 LPs                                     |
|                                           |
|              [View LPs]  [Add More]       |
+------------------------------------------+

+------------------------------------------+
| Wheat Germ (SKU-BP-GERM)  [Not Registered]|
|                                           |
| [--------------------] 0/100 kg (0%)      |
| 0 LPs                                     |
|                                           |
|                          [Register Now]  |
+------------------------------------------+
```

**Auto-Create Info Banner:**
```
+------------------------------------------+
| (i) Auto-create: ON                       |
| By-products will be automatically         |
| created when main output is registered    |
+------------------------------------------+
```

## Test Cases

### Unit Tests

**by-product-service.test.ts**
```typescript
describe('ByProductService', () => {
  describe('calculateExpectedByProductQty', () => {
    it('calculates 1000 * 5% = 50');
    it('calculates 5000 * 2.5% = 125');
    it('returns 0 for 0 planned qty');
    it('returns 0 for 0 yield percent');
  });

  describe('generateByProductBatch', () => {
    it('generates correct format: {main}-BP-{code}');
    it('handles special characters in product code');
    it('truncates if exceeds max length');
  });
});
```

**by-product-schemas.test.ts**
```typescript
describe('registerByProductSchema', () => {
  it('rejects missing wo_id');
  it('rejects missing by_product_id');
  it('rejects missing quantity');
  it('accepts quantity = 0');
  it('rejects negative quantity');
  it('accepts valid complete request');
});
```

### Integration Tests

**by-products-api.test.ts**
```typescript
describe('By-Product API', () => {
  describe('POST /api/production/outputs/by-products', () => {
    it('creates by-product LP with is_by_product = true');
    it('copies genealogy from main output LP');
    it('links to parent_output_id');
    it('returns 400 for non-by-product material');
    it('returns 404 for WO in different org');
  });

  describe('GET /api/production/work-orders/:id/by-products', () => {
    it('returns all by-products with calculated expected qty');
    it('aggregates LP counts correctly');
    it('returns status = registered when any LP exists');
    it('returns status = not_registered when no LPs');
  });
});
```

### E2E Tests

**by-product-registration.spec.ts**
```typescript
describe('By-Product Registration', () => {
  it('displays By-Products section on output page');
  it('shows expected qty calculated from yield percent');
  it('manual registration flow works correctly');
  it('auto-create creates all by-products on main output');
  it('shows zero qty warning and allows confirmation');
  it('genealogy shows same parent LPs as main output');
});
```

## Business Rules

1. **Expected Qty Calculation:** `WO.planned_qty * yield_percent / 100`
2. **Batch Format:** `{main_batch}-BP-{product_code}` (max 50 chars)
3. **Expiry Date:** `today + by_product.shelf_life_days`
4. **Location Default:** Product's default location or production line default
5. **Genealogy:** Copy all parent_lp_ids from main output LP
6. **Zero Qty:** Allowed with confirmation warning
7. **Auto-Create:** Runs in same transaction as main output registration

## Deliverables

- [x] Migration: Add by-product columns to production_outputs
- [x] Migration: Add is_by_product column to license_plates
- [x] RLS policies for by-product operations
- [x] By-product service (`lib/services/by-product-service.ts`)
- [x] Zod schemas (`lib/validation/by-product-schemas.ts`)
- [x] API: POST /api/production/outputs/by-products
- [x] API: GET /api/production/work-orders/:id/by-products
- [x] ByProductsSection component
- [x] RegisterByProductModal component
- [x] ByProductCompletionModal component
- [x] ZeroQtyWarningModal component
- [x] Hook: useByProductRegistration
- [x] Unit tests (>80% coverage)
- [x] Integration tests
- [x] E2E tests

## Definition of Done

- [x] Expected by-product qty displays correctly from BOM yield_percent
- [x] Auto-create setting creates all by-product LPs on main output registration
- [x] Manual entry flow allows custom quantities
- [x] By-product LPs created with is_by_product = true
- [x] Batch number auto-generated in correct format
- [x] Genealogy copied from main output to by-product LPs
- [x] Zero qty warning displays and allows confirmation
- [x] By-Products section shows progress and status correctly
- [x] Cross-tenant access returns 404 (not 403)
- [x] Unit test coverage >= 80%
- [x] Integration tests pass
- [x] E2E tests pass
