# 10.7 - Shift Report Generation

**Priority**: P0 (MVP)
**Story Points**: M (Medium)
**Type**: fullstack
**Phase**: 1B (Alerts & Reports)
**Model**: OPUS

**State:** ready
**Estimate:** M (3-4 days)
**Primary PRD:** `docs/1-BASELINE/product/modules/oee.md` (FR-OEE-011)

---

## Goal

Implement automatic shift report generation capturing OEE metrics, production output, downtime summary, and quality events for each shift. Enable supervisor approval workflow and PDF export for compliance documentation. Shift reports provide end-of-shift performance summary and support continuous improvement initiatives.

---

## User Story

As a **Production Supervisor**, I want to **automatically generate a comprehensive shift report at the end of each shift with OEE metrics, output, and downtime summary** so that **I can review performance, approve the report, and hand over information to the next shift**.

As a **Production Manager**, I want to **view historical shift reports and analyze trends across shifts** so that **I can identify patterns and improvement opportunities**.

---

## Scope

**In scope (this story)**
- `shift_reports` table with comprehensive metrics
- Auto-generation 15 minutes after shift end
- Report sections: Performance, Output, Downtime, Quality
- Supervisor approval workflow
- PDF export functionality
- GET /api/oee/shift-reports - List reports
- GET /api/oee/shift-reports/:id - Get report detail
- POST /api/oee/shift-reports/generate - Manual generation
- PATCH /api/oee/shift-reports/:id/approve - Approve report
- GET /api/oee/shift-reports/:id/export - Export to PDF
- Shift reports list page
- Shift report detail/approval page
- PDF template

**Out of scope (this story)**
- Shift handover notes (Story 10.14)
- Email distribution (Story 10.14)
- Excel export (Phase 2)
- Shift comparison analytics (Phase 2)
- Report scheduling/archival (Phase 3)

---

## Dependencies

### Within Epic Dependencies

| Dependency | Story | Type | What It Provides |
|------------|-------|------|------------------|
| 10.4 | OEE Calculation Engine | HARD | oee_snapshots for metrics aggregation |
| 10.3 | Downtime Event Tracking | HARD | oee_downtime_events for downtime summary |

---

## Database Migration

```sql
-- Migration: YYYYMMDDHHMMSS_create_shift_reports.sql

CREATE TABLE shift_reports (
    id                      UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id                  UUID NOT NULL REFERENCES organizations(id),

    -- Shift Identification
    shift_id                UUID NOT NULL REFERENCES shifts(id),
    line_id                 UUID REFERENCES production_lines(id),
    report_date             DATE NOT NULL,
    start_time              TIMESTAMPTZ NOT NULL,
    end_time                TIMESTAMPTZ NOT NULL,
    supervisor_id           UUID REFERENCES users(id),

    -- OEE Metrics (aggregated)
    oee_avg                 NUMERIC(5, 2),
    availability_avg        NUMERIC(5, 2),
    performance_avg         NUMERIC(5, 2),
    quality_avg             NUMERIC(5, 2),
    oee_target              NUMERIC(5, 2),

    -- Production Time
    planned_production_time INTEGER, -- minutes
    actual_production_time  INTEGER,
    total_downtime          INTEGER,
    planned_downtime        INTEGER,
    unplanned_downtime      INTEGER,

    -- Output Metrics
    total_output            INTEGER,
    good_output             INTEGER,
    scrap_count             INTEGER,
    rework_count            INTEGER,
    yield_pct               NUMERIC(5, 2),

    -- Work Orders
    work_orders_completed   INTEGER,
    work_orders_started     INTEGER,

    -- Energy (optional)
    energy_consumed_kwh     NUMERIC(10, 2),
    energy_cost             NUMERIC(10, 2),

    -- Report Status
    status                  TEXT NOT NULL DEFAULT 'draft'
                            CHECK (status IN ('draft', 'pending_approval', 'approved', 'rejected')),
    generated_at            TIMESTAMPTZ NOT NULL DEFAULT now(),
    approved_by             UUID REFERENCES users(id),
    approved_at             TIMESTAMPTZ,
    rejected_by             UUID REFERENCES users(id),
    rejected_at             TIMESTAMPTZ,
    rejection_reason        TEXT,

    -- Notes
    supervisor_notes        TEXT,
    system_notes            TEXT,

    -- Additional Data
    details                 JSONB,

    -- Audit
    created_at              TIMESTAMPTZ NOT NULL DEFAULT now(),
    created_by              UUID REFERENCES users(id),
    updated_at              TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE INDEX idx_shift_reports_org ON shift_reports(org_id);
CREATE INDEX idx_shift_reports_shift ON shift_reports(shift_id);
CREATE INDEX idx_shift_reports_line ON shift_reports(line_id) WHERE line_id IS NOT NULL;
CREATE INDEX idx_shift_reports_date ON shift_reports(org_id, report_date);
CREATE INDEX idx_shift_reports_status ON shift_reports(org_id, status);
CREATE INDEX idx_shift_reports_supervisor ON shift_reports(supervisor_id) WHERE supervisor_id IS NOT NULL;

-- RLS
ALTER TABLE shift_reports ENABLE ROW LEVEL SECURITY;

CREATE POLICY "shift_reports_select" ON shift_reports
    FOR SELECT USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

CREATE POLICY "shift_reports_insert" ON shift_reports
    FOR INSERT WITH CHECK (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

CREATE POLICY "shift_reports_update" ON shift_reports
    FOR UPDATE USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

-- Trigger
CREATE TRIGGER update_shift_reports_updated_at
    BEFORE UPDATE ON shift_reports
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- Auto-generation function
CREATE OR REPLACE FUNCTION generate_shift_report(
    p_org_id UUID,
    p_shift_id UUID,
    p_line_id UUID,
    p_report_date DATE
)
RETURNS UUID AS $$
DECLARE
    v_report_id UUID;
    v_shift RECORD;
    v_start_time TIMESTAMPTZ;
    v_end_time TIMESTAMPTZ;
    v_oee_metrics RECORD;
    v_downtime_metrics RECORD;
    v_output_metrics RECORD;
BEGIN
    -- Get shift details
    SELECT * INTO v_shift
    FROM shifts
    WHERE id = p_shift_id;

    -- Calculate shift time window
    v_start_time := (p_report_date || ' ' || v_shift.start_time::TEXT)::TIMESTAMPTZ;
    v_end_time := (p_report_date || ' ' || v_shift.end_time::TEXT)::TIMESTAMPTZ;
    IF v_end_time < v_start_time THEN
        v_end_time := v_end_time + INTERVAL '1 day';
    END IF;

    -- Aggregate OEE metrics
    SELECT
        AVG(oee_pct) as oee_avg,
        AVG(availability_pct) as availability_avg,
        AVG(performance_pct) as performance_avg,
        AVG(quality_pct) as quality_avg
    INTO v_oee_metrics
    FROM oee_snapshots
    WHERE org_id = p_org_id
      AND (line_id = p_line_id OR p_line_id IS NULL)
      AND snapshot_time BETWEEN v_start_time AND v_end_time;

    -- Aggregate downtime
    SELECT
        COALESCE(SUM(duration_minutes), 0) as total_downtime,
        COALESCE(SUM(CASE WHEN is_planned THEN duration_minutes ELSE 0 END), 0) as planned_downtime,
        COALESCE(SUM(CASE WHEN NOT is_planned THEN duration_minutes ELSE 0 END), 0) as unplanned_downtime
    INTO v_downtime_metrics
    FROM oee_downtime_events
    WHERE org_id = p_org_id
      AND (line_id = p_line_id OR p_line_id IS NULL)
      AND start_time >= v_start_time
      AND COALESCE(end_time, NOW()) <= v_end_time;

    -- Aggregate output (placeholder - integrate with production module)
    SELECT
        0 as total_output,
        0 as good_output,
        0 as scrap_count
    INTO v_output_metrics;

    -- Create report
    INSERT INTO shift_reports (
        org_id,
        shift_id,
        line_id,
        report_date,
        start_time,
        end_time,
        oee_avg,
        availability_avg,
        performance_avg,
        quality_avg,
        total_downtime,
        planned_downtime,
        unplanned_downtime,
        total_output,
        good_output,
        scrap_count,
        status,
        created_by
    ) VALUES (
        p_org_id,
        p_shift_id,
        p_line_id,
        p_report_date,
        v_start_time,
        v_end_time,
        v_oee_metrics.oee_avg,
        v_oee_metrics.availability_avg,
        v_oee_metrics.performance_avg,
        v_oee_metrics.quality_avg,
        v_downtime_metrics.total_downtime,
        v_downtime_metrics.planned_downtime,
        v_downtime_metrics.unplanned_downtime,
        v_output_metrics.total_output,
        v_output_metrics.good_output,
        v_output_metrics.scrap_count,
        'draft',
        NULL
    )
    RETURNING id INTO v_report_id;

    RETURN v_report_id;
END;
$$ LANGUAGE plpgsql;
```

---

## Acceptance Criteria (Given/When/Then)

### AC-1: Auto-Generate Shift Report

```gherkin
Scenario: Auto-generation at shift end
  Given shift "Morning" ends at 14:00
  And current time is 14:15 (15 min after shift end)
  When scheduled job runs
  Then shift report generated with:
    | Field | Value |
    | shift_id | Morning shift ID |
    | report_date | Today |
    | start_time | 06:00 |
    | end_time | 14:00 |
    | status | draft |
  And OEE metrics aggregated
  And downtime summary calculated
  And output totals aggregated

Scenario: Report aggregates OEE metrics
  Given 96 OEE snapshots during shift (every 5 min for 8 hours)
  And average OEE = 84.2%
  When report generated
  Then report.oee_avg = 84.2
  And availability_avg, performance_avg, quality_avg calculated
```

### AC-2: Supervisor Approval Workflow

```gherkin
Scenario: Supervisor reviews and approves report
  Given draft shift report exists
  And user is supervisor for this shift
  When supervisor navigates to report detail
  And reviews metrics
  And adds supervisor_notes "Good shift, minor jam on Line 2"
  And clicks [Approve Report]
  Then report.status = 'approved'
  And report.approved_by = supervisor user_id
  And report.approved_at = now
  And report locked (no edits)

Scenario: Supervisor requests changes
  Given draft report with incorrect data
  When supervisor clicks [Request Changes]
  And enters rejection_reason "Output count incorrect"
  Then report.status = 'rejected'
  And notification sent to shift creator
  And report can be regenerated
```

### AC-3: PDF Export

```gherkin
Scenario: Export approved report to PDF
  Given approved shift report
  When user clicks [Export PDF]
  Then PDF generated with:
    | Section | Content |
    | Header | Company logo, report date, shift name |
    | Summary | OEE metrics with targets |
    | Downtime | Table of downtime events |
    | Output | WOs completed, quantities |
    | Notes | Supervisor notes |
    | Signatures | Supervisor, approver |
  And PDF downloaded to browser
  And filename = "ShiftReport_Line1_2025-01-15_Morning.pdf"
```

### AC-4: Report List Page

```gherkin
Scenario: View shift reports list
  Given user navigates to /oee/shifts
  When page loads
  Then DataTable displays reports with columns:
    | Column | Content |
    | Date | Report date |
    | Shift | Shift name |
    | Line | Line name |
    | OEE | Average OEE % with target |
    | Status | Badge (draft/approved) |
    | Supervisor | Supervisor name |
    | Actions | View, Approve, Export |
  And filters: Date range, Shift, Line, Status
  And pagination (20 per page)

Scenario: Filter by date range
  Given reports from last 30 days
  When user selects date range = last 7 days
  Then only reports from last 7 days displayed
```

### AC-5: Report Detail View

```gherkin
Scenario: View report details
  Given shift report exists
  When user navigates to /oee/shifts/:id
  Then page displays:
    | Section | Content |
    | Header | Date, shift, line, status |
    | Performance Metrics | OEE, availability, performance, quality with gauges |
    | Production Time | Planned vs actual, downtime breakdown |
    | Output | Total, good, scrap, yield % |
    | Work Orders | Table of WOs completed/started |
    | Downtime Events | Table of downtime with durations |
    | Energy | kWh consumed, cost (if available) |
    | Notes | Supervisor notes field |
    | Actions | Approve, Reject, Export based on status |
```

### AC-6: Downtime Summary Section

```gherkin
Scenario: Downtime breakdown displayed
  Given shift report with 55 minutes total downtime
  And planned downtime = 30 min (break, lunch)
  And unplanned downtime = 25 min (setup, jams)
  When viewing report detail
  Then downtime section shows:
    | Metric | Value |
    | Total Downtime | 55 min |
    | Planned | 30 min (54%) |
    | Unplanned | 25 min (46%) |
  And table of downtime events with reasons
```

### AC-7: Work Orders Summary

```gherkin
Scenario: Work orders completed during shift
  Given shift report
  And 2 WOs completed during shift
  When viewing report
  Then WO table shows:
    | WO # | Product | Planned | Actual | Yield |
    | 2451 | Cookie Dough | 2,000 | 2,000 | 100% |
    | 2452 | Vanilla Dough | 500 | 450 | 90% |
  And summary: 2 WOs completed, 2,450 total output
```

### AC-8: Performance vs Target

```gherkin
Scenario: OEE vs target visualization
  Given shift report with oee_avg = 84.2%
  And oee_target = 85%
  When viewing report
  Then OEE gauge shows:
    - Actual: 84.2%
    - Target: 85%
    - Variance: -0.8% (red, below target)
  And color-coded: green if >= target, yellow if >= 80%, red if < 80%
```

### AC-9: Manual Report Generation

```gherkin
Scenario: Generate report manually
  Given shift ended yesterday but no report exists
  When user navigates to /oee/shifts
  And clicks [+ Generate Report]
  And selects:
    | Field | Value |
    | Date | Yesterday |
    | Shift | Morning |
    | Line | Production Line 1 |
  And clicks [Generate]
  Then report generated with aggregated data
  And success toast "Shift report generated"

Scenario: Regenerate rejected report
  Given rejected shift report
  When user clicks [Regenerate]
  Then new report created with fresh data
  And old report archived
  And status = draft
```

### AC-10: Permission Enforcement

```gherkin
Scenario: Supervisor can approve own shift
  Given user is supervisor for shift
  When viewing draft report
  Then [Approve] button enabled
  And [Reject] button available

Scenario: Manager can approve any report
  Given user is Production Manager
  Then can approve/reject any shift report
  And can export any report

Scenario: Operator view only
  Given user is Operator
  Then can view reports
  And cannot approve/reject
  And cannot export (Phase 2)
```

### AC-11: Report Status Workflow

```gherkin
Scenario: Report lifecycle
  Given new shift ends
  Then status progression:
    draft → pending_approval → approved
  And at each state:
    | Status | Actions | Who |
    | draft | Edit notes, Generate | Supervisor |
    | pending_approval | Approve, Reject | Supervisor, Manager |
    | approved | Export, View | All |
    | rejected | Regenerate | Supervisor, Manager |
```

### AC-12: Energy Metrics (Optional)

```gherkin
Scenario: Include energy data if available
  Given energy readings captured during shift
  And total energy = 1,245 kWh
  And energy cost = $124.50
  When report generated
  Then energy section shows:
    | Metric | Value |
    | Energy Consumed | 1,245 kWh |
    | Energy Cost | $124.50 |
    | kWh per Unit | 0.62 kWh |

Scenario: Skip energy if not tracked
  Given no energy readings
  Then energy section hidden in report
```

---

## Implementation Notes

### API Endpoints

```typescript
// GET /api/oee/shift-reports
interface ShiftReportListParams {
  date_from?: string;
  date_to?: string;
  shift_id?: string;
  line_id?: string;
  status?: 'draft' | 'pending_approval' | 'approved' | 'rejected';
  page?: number;
  limit?: number;
}

interface ShiftReport {
  id: string;
  shift_id: string;
  shift_name: string;
  line_id?: string;
  line_name?: string;
  report_date: string;
  start_time: string;
  end_time: string;
  oee_avg: number;
  oee_target: number;
  status: string;
  supervisor_id?: string;
  supervisor_name?: string;
  approved_by?: string;
  approved_at?: string;
}

// POST /api/oee/shift-reports/generate
interface GenerateShiftReportRequest {
  shift_id: string;
  line_id?: string;
  report_date: string;
}

// PATCH /api/oee/shift-reports/:id/approve
interface ApproveShiftReportRequest {
  supervisor_notes?: string;
}
```

### PDF Template Structure

```typescript
interface ShiftReportPDF {
  header: {
    company_name: string;
    logo_url: string;
    report_title: string;
    report_date: string;
    shift_name: string;
    line_name: string;
  };
  metrics: {
    oee: { actual: number; target: number; variance: number };
    availability: number;
    performance: number;
    quality: number;
  };
  production: {
    planned_time: number;
    actual_time: number;
    total_output: number;
    good_output: number;
    yield_pct: number;
  };
  downtime_events: Array<{
    start: string;
    duration: number;
    reason: string;
    type: string;
  }>;
  work_orders: Array<{
    wo_number: string;
    product: string;
    planned: number;
    actual: number;
    yield: number;
  }>;
  notes: string;
  signatures: {
    supervisor: string;
    approved_by: string;
    approved_at: string;
  };
}
```

---

## Deliverables

- [ ] `shift_reports` table
- [ ] Auto-generation function
- [ ] Shift reports API endpoints
- [ ] ShiftReportService
- [ ] Shift reports list page
- [ ] Shift report detail page
- [ ] PDF export functionality
- [ ] Approval workflow UI

---

## Definition of Done

- [ ] Reports auto-generate 15 min after shift end
- [ ] All metrics aggregated correctly
- [ ] Approval workflow complete
- [ ] PDF export functional
- [ ] All tests passing (>80% coverage)

---

**Document Status**: Ready for Implementation
**Created**: 2025-01-15
**Lines**: ~650
**Complexity**: M (Medium)
**Phase**: 1B (Alerts & Reports)
