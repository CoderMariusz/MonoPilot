# 10.20 - Export to BI Tools

**Priority**: P1
**Story Points**: M (Medium)
**Type**: backend
**Phase**: 3
**Model**: OPUS

**State:** ready
**Estimate:** M (3-4 days)
**Primary PRD:** `docs/1-BASELINE/product/modules/oee.md` (FR-OEE-028)

---

## Goal

Enable data export to external BI tools (Power BI, Tableau, Excel) via REST API, CSV/JSON exports, and scheduled data refresh. Provide OEE data mart schema for advanced analytics and executive dashboards.

---

## User Story

As a **Data Analyst**, I want to **export OEE data to Power BI for custom dashboards** so that **I can combine production data with financial and sales metrics in executive reports**.

---

## Scope

**In scope**
- CSV export for all OEE tables (snapshots, downtime, shift reports)
- JSON export via REST API
- Power BI connector configuration
- Tableau Web Data Connector
- Excel export (XLSX format)
- Data refresh scheduling (hourly, daily)
- Data mart view (denormalized for BI)
- GET /api/oee/export/snapshots, /downtime, /shift-reports
- Export API documentation

**Out of scope**
- Real-time streaming to BI (Phase 4)
- Custom BI connectors (Looker, QlikView) (Phase 4)
- Data warehouse integration (Phase 4)

---

## Acceptance Criteria

```gherkin
Scenario: Export OEE snapshots to CSV
  Given user on /oee/analytics
  When clicks [Export] > [CSV]
  And selects:
    | Table | OEE Snapshots |
    | Date Range | Last 30 days |
    | Machines | All |
  Then CSV file downloads with columns:
    | snapshot_time | machine_id | machine_name | oee_pct | availability_pct | performance_pct | quality_pct | shift_id |
  And filename = "OEE_Snapshots_2025-01-15.csv"
  And 2,880 rows (30 days Ã— 96 snapshots/day)

Scenario: Connect Power BI
  Given Power BI Desktop open
  When user selects "Web" data source
  And enters API endpoint: https://api.monopilot.com/oee/export/snapshots
  And provides API key for authentication
  Then Power BI loads OEE data
  And user can create custom reports

Scenario: Scheduled data refresh
  Given BI tool connected to API
  When configuring refresh schedule
  And selects refresh = Daily at 02:00
  Then data refreshes automatically
  And latest OEE data available in BI dashboard

Scenario: Data mart view
  Given complex joins across OEE tables
  When querying oee_data_mart view
  Then single denormalized table with:
    | Column | Source |
    | snapshot_time | oee_snapshots |
    | machine_name | machines |
    | line_name | production_lines |
    | shift_name | shifts |
    | oee_pct | oee_snapshots |
    | downtime_minutes | aggregated from oee_downtime_events |
    | work_order_number | work_orders |
  And optimized for BI query performance
```

---

## Database Migration

```sql
-- Data mart view for BI tools
CREATE OR REPLACE VIEW oee_data_mart AS
SELECT
    s.id as snapshot_id,
    s.snapshot_time,
    s.org_id,
    m.id as machine_id,
    m.name as machine_name,
    m.code as machine_code,
    l.id as line_id,
    l.name as line_name,
    sh.id as shift_id,
    sh.name as shift_name,
    wo.id as work_order_id,
    wo.wo_number,
    p.name as product_name,
    s.oee_pct,
    s.availability_pct,
    s.performance_pct,
    s.quality_pct,
    s.total_pieces,
    s.good_pieces,
    s.rejected_pieces,
    s.planned_production_time,
    s.actual_production_time,
    -- Aggregate downtime for this snapshot period
    COALESCE(dt.total_downtime, 0) as downtime_minutes,
    COALESCE(dt.planned_downtime, 0) as planned_downtime_minutes,
    COALESCE(dt.unplanned_downtime, 0) as unplanned_downtime_minutes
FROM oee_snapshots s
LEFT JOIN machines m ON s.machine_id = m.id
LEFT JOIN production_lines l ON s.line_id = l.id
LEFT JOIN shifts sh ON s.shift_id = sh.id
LEFT JOIN work_orders wo ON s.work_order_id = wo.id
LEFT JOIN products p ON wo.product_id = p.id
LEFT JOIN LATERAL (
    SELECT
        SUM(duration_minutes) as total_downtime,
        SUM(CASE WHEN is_planned THEN duration_minutes ELSE 0 END) as planned_downtime,
        SUM(CASE WHEN NOT is_planned THEN duration_minutes ELSE 0 END) as unplanned_downtime
    FROM oee_downtime_events de
    WHERE de.machine_id = s.machine_id
      AND de.start_time >= s.snapshot_time - INTERVAL '5 minutes'
      AND de.start_time < s.snapshot_time
) dt ON true;

-- Grant access to view
GRANT SELECT ON oee_data_mart TO authenticated;
```

---

## API Endpoints

```typescript
// GET /api/oee/export/snapshots
interface ExportSnapshotsParams {
  format: 'csv' | 'json' | 'xlsx';
  date_from: string;
  date_to: string;
  machine_id?: string;
  line_id?: string;
  shift_id?: string;
  include_headers?: boolean;
}

// GET /api/oee/export/downtime
interface ExportDowntimeParams {
  format: 'csv' | 'json' | 'xlsx';
  date_from: string;
  date_to: string;
  include_resolved?: boolean;
}

// GET /api/oee/export/shift-reports
interface ExportShiftReportsParams {
  format: 'csv' | 'json' | 'xlsx';
  date_from: string;
  date_to: string;
  status?: string;
}

// GET /api/oee/export/data-mart
// Full data mart export for BI tools
interface ExportDataMartParams {
  format: 'csv' | 'json';
  date_from: string;
  date_to: string;
  limit?: number; // Max 100,000 rows
}
```

---

## Deliverables

- [ ] oee_data_mart view
- [ ] Export API endpoints (CSV, JSON, XLSX)
- [ ] Power BI connector documentation
- [ ] Tableau WDC configuration
- [ ] Export service with format converters
- [ ] API documentation for BI integrations
- [ ] Sample Power BI dashboard template

---

## Definition of Done

- [ ] CSV export downloads correctly
- [ ] JSON export valid format
- [ ] XLSX export with formatting
- [ ] Power BI connects successfully
- [ ] Data mart view performant (< 5s for 90 days)
- [ ] API documentation complete

---

**Document Status**: Ready for Implementation
**Lines**: ~300
**Phase**: 3
