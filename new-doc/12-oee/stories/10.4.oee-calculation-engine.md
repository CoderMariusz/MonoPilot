# 10.4 - OEE Calculation Engine

**Priority**: P0 (MVP)
**Story Points**: L (Large)
**Type**: backend
**Phase**: 1A (Core OEE)
**Model**: SONNET

**State:** ready
**Estimate:** L (5-6 days)
**Primary PRD:** `docs/1-BASELINE/product/modules/oee.md` (FR-OEE-001, FR-OEE-006, FR-OEE-007, FR-OEE-008)
**Architecture:** `docs/1-BASELINE/architecture/modules/oee.md` (oee_snapshots, oee_daily_summary tables)

---

## Goal

Implement the core OEE calculation engine that computes Overall Equipment Effectiveness (OEE = Availability × Performance × Quality) in real-time and stores snapshots for historical analysis. This is the mathematical heart of the OEE module, enabling accurate performance measurement against targets.

---

## User Story

As a **Production Manager**, I want **OEE automatically calculated for all machines in real-time** so that **I can monitor performance and identify improvement opportunities**.

As a **Data Analyst**, I want **OEE snapshots stored at regular intervals** so that **I can analyze trends, compare shifts, and generate reports**.

---

## Scope

**In scope (this story)**
- `oee_snapshots` table with OEE%, Availability%, Performance%, Quality%
- `oee_daily_summary` and `oee_hourly_summary` aggregation tables
- OEE calculation formula implementation:
  - **Availability** = (Production Time - Downtime) / Production Time
  - **Performance** = (Total Pieces / Production Time) / Ideal Cycle Time
  - **Quality** = Good Pieces / Total Pieces
  - **OEE** = Availability × Performance × Quality
- Real-time calculation triggers:
  - Output registration (quality metric update)
  - Downtime event end (availability update)
  - WO operation complete (performance update)
  - Manual snapshot request
- Scheduled snapshot creation (every 5 min for active WOs)
- Calculation per machine, line, shift, work order
- GET /api/oee/calculate (calculate OEE for period)
- GET /api/oee/snapshots (list snapshots)
- POST /api/oee/snapshots (manual snapshot)
- Background job: Snapshot creation (cron every 5 min)

**Out of scope (this story)**
- Real-time dashboard UI (story 10.5)
- Trend analysis (Phase 1B)
- Pareto analysis (Phase 2)
- Alert notifications (Phase 1B)
- BI tool export (Phase 3)

---

## Dependencies

### Cross-Epic Dependencies

| Dependency | Story/Epic | Type | What It Provides | Status |
|------------|------------|------|------------------|--------|
| 01.1 | Org Context + RLS | HARD | organizations table | Ready |
| 01.3 | Machine Settings | HARD | machines table, ideal_cycle_time | Ready |
| 01.5 | Production Lines | HARD | production_lines table | Ready |
| 04.1 | Work Orders CRUD | HARD | work_orders, planned_quantity | Ready |
| 04.2 | WO Operations | HARD | wo_operations, start/end times | Ready |
| 04.5 | Output Registration | HARD | output_registrations, good_quantity | Ready |

### Within Epic Dependencies

| Dependency | Story | Type | What It Provides |
|------------|-------|------|------------------|
| 10.1 | OEE Settings & Targets | HARD | Target values for comparison | Ready |
| 10.3 | Downtime Event Tracking | HARD | Downtime data for availability calc | Ready |

### Provides To (Downstream)

| Story | What This Provides |
|-------|-------------------|
| 10.5 | Real-Time Machine Dashboard - OEE data source |
| Phase 1B | Trend Analysis - historical snapshots |
| Phase 1B | Alerts - threshold comparison |

---

## Database Migration

```sql
-- Migration: YYYYMMDDHHMMSS_create_oee_snapshots.sql

-- =============================================================================
-- OEE Snapshots (Point-in-Time Calculations)
-- =============================================================================

CREATE TABLE oee_snapshots (
    -- Identity
    id                          UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id                      UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,

    -- Scope
    machine_id                  UUID REFERENCES machines(id),
    line_id                     UUID REFERENCES production_lines(id),
    shift_id                    UUID REFERENCES shifts(id),
    work_order_id               UUID REFERENCES work_orders(id),

    -- Snapshot Timestamp
    snapshot_time               TIMESTAMPTZ NOT NULL DEFAULT now(),

    -- OEE Metrics (percentage values)
    availability_pct            DECIMAL(5,2) NOT NULL
                                CHECK (availability_pct >= 0 AND availability_pct <= 100),
    performance_pct             DECIMAL(5,2) NOT NULL
                                CHECK (performance_pct >= 0 AND performance_pct <= 100),
    quality_pct                 DECIMAL(5,2) NOT NULL
                                CHECK (quality_pct >= 0 AND quality_pct <= 100),
    oee_pct                     DECIMAL(5,2) GENERATED ALWAYS AS (
                                    (availability_pct * performance_pct * quality_pct) / 10000
                                ) STORED,

    -- Time Breakdown (minutes)
    planned_production_time     INTEGER NOT NULL, -- Shift time - breaks
    actual_production_time      INTEGER NOT NULL, -- Planned - downtime
    total_downtime              INTEGER DEFAULT 0,

    -- Production Data
    ideal_cycle_time            DECIMAL(10,4), -- Units per minute (from machine)
    total_pieces                INTEGER DEFAULT 0,
    good_pieces                 INTEGER DEFAULT 0,
    rejected_pieces             INTEGER DEFAULT 0,

    -- Metadata
    calculation_method          TEXT DEFAULT 'auto'
                                CHECK (calculation_method IN ('auto', 'manual', 'scheduled')),
    notes                       TEXT,

    -- Audit
    created_at                  TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- =============================================================================
-- Daily Summary (Aggregated Metrics)
-- =============================================================================

CREATE TABLE oee_daily_summary (
    id                      UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id                  UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,

    summary_date            DATE NOT NULL,
    machine_id              UUID REFERENCES machines(id),
    line_id                 UUID REFERENCES production_lines(id),
    shift_id                UUID REFERENCES shifts(id),

    -- Time Totals (minutes)
    total_planned_time      INTEGER NOT NULL,
    total_downtime          INTEGER DEFAULT 0,
    total_production_time   INTEGER NOT NULL,

    -- OEE Averages
    oee_avg                 DECIMAL(5,2),
    availability_avg        DECIMAL(5,2),
    performance_avg         DECIMAL(5,2),
    quality_avg             DECIMAL(5,2),

    -- Production Totals
    total_output            INTEGER DEFAULT 0,
    good_output             INTEGER DEFAULT 0,
    scrap_output            INTEGER DEFAULT 0,

    -- Audit
    created_at              TIMESTAMPTZ NOT NULL DEFAULT now(),
    updated_at              TIMESTAMPTZ NOT NULL DEFAULT now(),

    CONSTRAINT uq_daily_summary UNIQUE (org_id, summary_date, machine_id, line_id, shift_id)
);

-- =============================================================================
-- Hourly Summary (for intraday trends)
-- =============================================================================

CREATE TABLE oee_hourly_summary (
    id                      UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id                  UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,

    hour_start              TIMESTAMPTZ NOT NULL, -- Rounded to hour
    machine_id              UUID REFERENCES machines(id),
    line_id                 UUID REFERENCES production_lines(id),

    -- Metrics
    oee_avg                 DECIMAL(5,2),
    units_produced          INTEGER DEFAULT 0,
    good_units              INTEGER DEFAULT 0,
    downtime_minutes        INTEGER DEFAULT 0,

    -- Audit
    created_at              TIMESTAMPTZ NOT NULL DEFAULT now(),

    CONSTRAINT uq_hourly_summary UNIQUE (org_id, hour_start, machine_id)
);

-- =============================================================================
-- Indexes
-- =============================================================================

-- Snapshots indexes
CREATE INDEX idx_snapshots_org ON oee_snapshots(org_id);
CREATE INDEX idx_snapshots_machine ON oee_snapshots(machine_id) WHERE machine_id IS NOT NULL;
CREATE INDEX idx_snapshots_line ON oee_snapshots(line_id) WHERE line_id IS NOT NULL;
CREATE INDEX idx_snapshots_wo ON oee_snapshots(work_order_id) WHERE work_order_id IS NOT NULL;
CREATE INDEX idx_snapshots_time ON oee_snapshots(org_id, snapshot_time DESC);
CREATE INDEX idx_snapshots_machine_time ON oee_snapshots(machine_id, snapshot_time DESC)
    WHERE machine_id IS NOT NULL;

-- Daily summary indexes
CREATE INDEX idx_daily_org_date ON oee_daily_summary(org_id, summary_date DESC);
CREATE INDEX idx_daily_machine ON oee_daily_summary(machine_id, summary_date DESC)
    WHERE machine_id IS NOT NULL;

-- Hourly summary indexes
CREATE INDEX idx_hourly_org_hour ON oee_hourly_summary(org_id, hour_start DESC);
CREATE INDEX idx_hourly_machine ON oee_hourly_summary(machine_id, hour_start DESC)
    WHERE machine_id IS NOT NULL;

-- =============================================================================
-- RLS Policies
-- =============================================================================

ALTER TABLE oee_snapshots ENABLE ROW LEVEL SECURITY;
ALTER TABLE oee_daily_summary ENABLE ROW LEVEL SECURITY;
ALTER TABLE oee_hourly_summary ENABLE ROW LEVEL SECURITY;

CREATE POLICY "snapshots_select" ON oee_snapshots
    FOR SELECT USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

CREATE POLICY "snapshots_insert" ON oee_snapshots
    FOR INSERT WITH CHECK (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

CREATE POLICY "daily_summary_select" ON oee_daily_summary
    FOR SELECT USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

CREATE POLICY "daily_summary_insert" ON oee_daily_summary
    FOR INSERT WITH CHECK (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

CREATE POLICY "hourly_summary_select" ON oee_hourly_summary
    FOR SELECT USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

CREATE POLICY "hourly_summary_insert" ON oee_hourly_summary
    FOR INSERT WITH CHECK (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

-- =============================================================================
-- Trigger for updated_at
-- =============================================================================

CREATE TRIGGER update_oee_daily_summary_updated_at
    BEFORE UPDATE ON oee_daily_summary
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();
```

---

## Acceptance Criteria (Given/When/Then)

### AC-1: Availability Calculation

```gherkin
Scenario: Calculate availability with downtime
  Given shift planned production time = 480 minutes (8 hours)
  And total downtime = 55 minutes
  When calculating availability
  Then actual_production_time = 480 - 55 = 425 minutes
  And availability_pct = (425 / 480) × 100 = 88.54%

Scenario: Perfect availability (no downtime)
  Given planned_production_time = 480 minutes
  And total_downtime = 0 minutes
  Then availability_pct = 100%

Scenario: Availability with planned downtime excluded
  Given planned_production_time = 480 minutes
  And planned_downtime (breaks, lunch) = 45 minutes (already excluded from planned time)
  And unplanned_downtime = 30 minutes
  Then availability_pct = (450 / 480) × 100 = 93.75%
```

### AC-2: Performance Calculation

```gherkin
Scenario: Calculate performance with ideal cycle time
  Given ideal_cycle_time = 120 units/hour = 2 units/minute
  And actual_production_time = 425 minutes
  And total_pieces = 800 units
  When calculating performance
  Then target_output = 425 × 2 = 850 units
  And performance_pct = (800 / 850) × 100 = 94.12%

Scenario: Performance exceeds 100% (running faster than ideal)
  Given ideal_cycle_time = 2 units/minute
  And actual_production_time = 425 minutes
  And total_pieces = 900 units
  Then target_output = 850 units
  And performance_pct = (900 / 850) × 100 = 105.88%
  And performance_pct capped at 100% (or allowed >100% per settings)
```

### AC-3: Quality Calculation

```gherkin
Scenario: Calculate quality with scrap
  Given total_pieces = 800 units
  And good_pieces = 780 units
  And rejected_pieces = 20 units
  When calculating quality
  Then quality_pct = (780 / 800) × 100 = 97.5%

Scenario: Perfect quality (zero defects)
  Given total_pieces = 800
  And good_pieces = 800
  Then quality_pct = 100%

Scenario: No production yet
  Given total_pieces = 0
  Then quality_pct = 100% (default, no defects detected)
```

### AC-4: OEE Calculation

```gherkin
Scenario: Calculate OEE from components
  Given availability_pct = 88.54%
  And performance_pct = 94.12%
  And quality_pct = 97.5%
  When calculating OEE
  Then oee_pct = (88.54 × 94.12 × 97.5) / 10000 = 81.25%

Scenario: Perfect OEE
  Given availability = 100%, performance = 100%, quality = 100%
  Then oee_pct = 100%
```

### AC-5: Real-Time Snapshot Creation

```gherkin
Scenario: Auto-create snapshot on output registration
  Given WO-2451 running on Mixer-01
  When operator registers output:
    | good_quantity | 50 |
    | scrap_quantity | 2 |
  Then OEE snapshot created
  And quality_pct recalculated
  And total_pieces incremented

Scenario: Auto-create snapshot on downtime end
  Given active downtime event for Mixer-01
  When downtime ended (duration = 15 min)
  Then OEE snapshot created
  And availability_pct recalculated
  And total_downtime incremented
```

### AC-6: Scheduled Snapshot Creation

```gherkin
Scenario: Cron job creates snapshots every 5 minutes
  Given WO-2451 active on Mixer-01
  And current time = 14:00
  When cron job runs
  Then snapshot created for Mixer-01 at 14:00
  And next snapshot at 14:05
  And historical trend buildable from snapshots

Scenario: No snapshot for idle machines
  Given Mixer-01 has no active WO
  When cron job runs
  Then no snapshot created for Mixer-01
  And avoids unnecessary data
```

### AC-7: Calculation by Scope

```gherkin
Scenario: Calculate OEE for machine
  Given machine = Mixer-01
  And time period = today
  When requesting machine OEE
  Then aggregate all snapshots for Mixer-01 today
  And return average OEE, availability, performance, quality

Scenario: Calculate OEE for production line
  Given line = Line-1 with 4 machines
  When requesting line OEE
  Then aggregate all machine OEEs on Line-1
  And return weighted average (or simple average)

Scenario: Calculate OEE for shift
  Given shift = Morning (06:00-14:00)
  When requesting shift OEE
  Then filter snapshots by shift_id
  And aggregate metrics for shift period
```

### AC-8: Daily Summary Aggregation

```gherkin
Scenario: End-of-day summary generation
  Given date = 2025-01-15
  And Mixer-01 has 96 snapshots (every 5 min × 8 hours)
  When daily summary job runs
  Then summary record created:
    | Field | Value |
    | summary_date | 2025-01-15 |
    | machine_id | Mixer-01 |
    | oee_avg | Average of all snapshots |
    | total_output | Sum of total_pieces |
    | good_output | Sum of good_pieces |
  And summary queryable for reports
```

### AC-9: API - Calculate OEE

```gherkin
Scenario: Calculate OEE for period
  Given request GET /api/oee/calculate?machine_id={uuid}&start=2025-01-15T06:00&end=2025-01-15T14:00
  When endpoint processes
  Then response:
    | Field | Value |
    | oee_pct | 81.25 |
    | availability_pct | 88.54 |
    | performance_pct | 94.12 |
    | quality_pct | 97.5 |
    | total_pieces | 800 |
    | good_pieces | 780 |
    | downtime_minutes | 55 |
  And calculation_method = 'on-demand'
```

### AC-10: API - List Snapshots

```gherkin
Scenario: List snapshots for machine
  Given machine Mixer-01 has 100 snapshots
  When request GET /api/oee/snapshots?machine_id={uuid}&limit=20
  Then 20 most recent snapshots returned
  And pagination metadata included
  And sorted by snapshot_time DESC
```

### AC-11: API - Manual Snapshot

```gherkin
Scenario: Supervisor requests manual snapshot
  Given supervisor viewing machine dashboard
  When POST /api/oee/snapshots with:
    | machine_id | Mixer-01 |
    | work_order_id | WO-2451 |
    | calculation_method | manual |
  Then snapshot created immediately
  And reflects current state
  And calculation_method = 'manual'
```

### AC-12: Performance Optimization

```gherkin
Scenario: Snapshot query performance
  Given 100,000 snapshots in database
  When querying snapshots for specific machine + date range
  Then response time < 500ms
  And uses idx_snapshots_machine_time index

Scenario: Calculation performance
  Given requesting OEE for 1 hour period
  When calculation processes
  Then completes < 2 seconds
  And aggregates from hourly_summary if available
```

### AC-13: Data Validation

```gherkin
Scenario: Prevent invalid percentages
  Given calculating OEE
  When availability > 100%
  Then cap at 100% or flag as data error

  When total_pieces < good_pieces
  Then validation error: "Good pieces cannot exceed total pieces"
```

### AC-14: Zero Division Handling

```gherkin
Scenario: No production time
  Given planned_production_time = 0
  When calculating availability
  Then availability_pct = NULL or 0%
  And log warning

Scenario: No ideal cycle time
  Given ideal_cycle_time = NULL
  When calculating performance
  Then performance_pct = NULL
  And note in snapshot
```

---

## Implementation Notes

### OEE Service

```typescript
// lib/services/oee-calculation-service.ts

export class OEECalculationService {
  /**
   * Calculate OEE for a given period and scope
   */
  static async calculate(params: {
    org_id: string;
    machine_id?: string;
    line_id?: string;
    work_order_id?: string;
    shift_id?: string;
    start_time: Date;
    end_time: Date;
  }): Promise<OEESnapshot>;

  /**
   * Create OEE snapshot
   */
  static async createSnapshot(params: {
    org_id: string;
    machine_id?: string;
    line_id?: string;
    work_order_id?: string;
    shift_id?: string;
    calculation_method: 'auto' | 'manual' | 'scheduled';
  }): Promise<OEESnapshot>;

  /**
   * Calculate Availability component
   */
  static calculateAvailability(params: {
    planned_production_time: number; // minutes
    total_downtime: number; // minutes
  }): number; // percentage

  /**
   * Calculate Performance component
   */
  static calculatePerformance(params: {
    actual_production_time: number; // minutes
    ideal_cycle_time: number; // units per minute
    total_pieces: number;
  }): number; // percentage

  /**
   * Calculate Quality component
   */
  static calculateQuality(params: {
    total_pieces: number;
    good_pieces: number;
  }): number; // percentage

  /**
   * Calculate composite OEE
   */
  static calculateOEE(
    availability: number,
    performance: number,
    quality: number
  ): number;

  /**
   * Aggregate snapshots into daily summary
   */
  static async generateDailySummary(
    org_id: string,
    date: Date
  ): Promise<void>;

  /**
   * Aggregate snapshots into hourly summary
   */
  static async generateHourlySummary(
    org_id: string,
    hour: Date
  ): Promise<void>;

  /**
   * Get latest snapshot for machine
   */
  static async getLatestSnapshot(machine_id: string): Promise<OEESnapshot | null>;

  /**
   * Trigger snapshot creation from event
   */
  static async triggerSnapshotFromEvent(event: {
    type: 'output' | 'downtime_end' | 'wo_complete';
    machine_id: string;
    work_order_id?: string;
  }): Promise<void>;
}
```

---

## Deliverables

### Database
- [ ] Migration: `oee_snapshots` table
- [ ] Migration: `oee_daily_summary` table
- [ ] Migration: `oee_hourly_summary` table
- [ ] Generated column: `oee_pct`
- [ ] All indexes

### API Routes
- [ ] `GET /api/oee/calculate` - Calculate OEE
- [ ] `GET /api/oee/snapshots` - List snapshots
- [ ] `POST /api/oee/snapshots` - Manual snapshot

### Service Layer
- [ ] `OEECalculationService.calculate()` - Main calc
- [ ] `OEECalculationService.createSnapshot()` - Snapshot creation
- [ ] `OEECalculationService.calculateAvailability()` - Component
- [ ] `OEECalculationService.calculatePerformance()` - Component
- [ ] `OEECalculationService.calculateQuality()` - Component
- [ ] `OEECalculationService.generateDailySummary()` - Aggregation
- [ ] `OEECalculationService.triggerSnapshotFromEvent()` - Event handler

### Background Jobs
- [ ] Cron job: Snapshot creation (every 5 min)
- [ ] Cron job: Daily summary generation (midnight)
- [ ] Cron job: Hourly summary generation (hourly)

### Tests
- [ ] Unit tests: All calculation methods (>90% coverage)
- [ ] Integration tests: Snapshot creation, aggregation
- [ ] Performance tests: 100K snapshots query
- [ ] Edge cases: Zero division, missing data

---

## Definition of Done

- [ ] All formulas implemented correctly
- [ ] Snapshots created on triggers
- [ ] Scheduled jobs running
- [ ] Aggregation tables populated
- [ ] API endpoints functional
- [ ] Performance < 2s for calculations
- [ ] Tests passing (>90% coverage)

---

**Document Status**: Ready for Implementation
**Created**: 2025-01-15
**Complexity**: L (Large)
**Phase**: 1A (Core OEE)
