# Story 09.23: Budget Management

**Epic:** 09-finance
**Phase:** 3
**Complexity:** M (3-4 days)
**Type:** Full-stack
**Story File:** `09.23.budget-management.md`

---

## User Story

As a **Finance Manager** or **Budget Controller**,
I want to **manage budget approval workflows, revisions, and forecasting with variance alerts**,
So that I can **ensure budgets are properly controlled, adjusted when needed, and stakeholders are notified of issues**.

---

## Business Context

**Problem**: Budgets are set once and never revised, leading to irrelevant targets that don't reflect business reality. Budget overruns happen without warning.

**Value**:
- Enable adaptive budget management (revisions when business conditions change)
- Predictive alerts prevent budget overruns before they occur
- Formal approval process ensures budget accountability
- Forecasting supports proactive planning vs reactive firefighting

**Use Cases**:
1. Finance Manager creates Q2 budget → submits for CFO approval → CFO approves → budget becomes active
2. Production Manager requests budget increase mid-quarter (unexpected maintenance) → Finance Manager reviews → approves revised budget → notifies stakeholders
3. Budget Controller reviews alert: "Production Line 1 projected to exceed budget by $15K" → investigates cause → implements cost controls → prevents overrun
4. CFO forecasts next year's budget based on current year trends → applies 8% inflation adjustment → shares forecast with department heads for input

---

## Acceptance Criteria

### AC1: Budget Approval Workflow (FR-9.11.4)

**Given** budget is created with status "Draft"
**When** user submits budget for approval
**Then** the system:
- Changes budget status to "Pending Approval"
- Notifies configured approvers (based on budget amount or cost center)
- Approval chain supports multi-level approval:
  - <$50K: Finance Manager approval
  - $50K-$200K: Finance Manager + CFO approval
  - >$200K: Finance Manager + CFO + Board approval
- Approver actions:
  - **Approve**: Status → "Approved", moves to next approver if multi-level
  - **Reject**: Status → "Rejected", requires rejection reason
  - **Request Revision**: Status → "Revision Requested", returns to submitter with notes
- Final approval activates budget (status → "Active") on effective date
- Email notifications at each approval step
- Audit log records all approval actions with timestamps

**Validation**:
- Only designated approvers can approve budgets
- Budget cannot be edited while "Pending Approval"
- Rejection requires reason (min 10 characters)
- Approval notes optional but recommended
- Budget owner notified of all status changes

---

### AC2: Budget Revision (FR-9.11.6)

**Given** active budget exists
**When** user requests budget revision
**Then** the system allows:
- Create new budget version linked to original
- Specify revision reason (dropdown + notes):
  - Unexpected cost increase
  - Business expansion
  - Cost-saving initiative
  - Seasonal adjustment
  - Other (require notes)
- Adjust budget amount (increase or decrease)
- Set effective date for revision
- Submit revision for approval (follows approval workflow)
- Original budget marked "Superseded" when revision approved
- Revision history preserved with link to original budget

**Validation**:
- Revision reason required
- Effective date must be within original budget period
- Revision cannot overlap existing active budget
- Revision history viewable (shows all versions)
- Variance reporting shows variance to original vs revised budget

---

### AC3: Budget Forecasting (FR-9.11.5)

**Given** historical cost data exists
**When** forecasting budget for future period
**Then** the system:
- Supports forecasting methods:
  - **Historical Average**: AVG(last N periods) × (1 + growth rate)
  - **Trend-Based**: Linear regression on historical data
  - **Manual Override**: User enters forecast directly
- Inputs:
  - Cost center selection
  - Forecast period (start/end date)
  - Historical lookback period (3, 6, 12 months)
  - Growth rate % (inflation, business growth)
  - Seasonality adjustment (if applicable)
- Outputs:
  - Suggested budget amount
  - Historical average, min, max
  - Trend line chart (historical + forecast)
  - Confidence interval (±10% default)
  - Forecasting assumptions documented
- User can:
  - Accept forecast → creates draft budget
  - Adjust forecast → modify suggested amount
  - Reject forecast → enter manual budget

**Formula**:
```
Historical Average Method:
Forecast = AVG(Last N Period Costs) × (1 + Growth Rate) × Seasonality Factor

Trend-Based Method:
Forecast = a + b × Period Number (linear regression)

Where:
- a = intercept
- b = slope (trend)
- Seasonality Factor = Period Cost / Annual Avg Cost (if seasonal patterns detected)
```

**Validation**:
- Historical lookback requires at least 3 data points
- Growth rate range: -50% to +200%
- Forecast period cannot overlap existing approved budgets
- Forecast confidence interval displayed for transparency

---

### AC4: Budget Variance Alerts (FR-9.11.6)

**Given** budget variance thresholds configured
**When** variance or spending rate triggers alert
**Then** the system creates alert with severity:
- **Warning** (Yellow):
  - Variance >5% but <10%
  - Spending rate 80-90% of budget with >10% period remaining
- **Critical** (Red):
  - Variance >10%
  - Spending rate >90% of budget with >10% period remaining
  - Projected to exceed budget before period end

**Alert includes**:
- Cost center name and code
- Budget amount and actual cost
- Variance amount and %
- Days remaining in period
- Projected final spend
- Spending rate (cost per day)
- Recommended actions

**Notification**:
- Email to cost center owner, finance manager
- In-app notification badge
- Dashboard alert widget
- SMS for critical alerts (if configured)

**User actions**:
- Acknowledge alert (with notes)
- Create action plan (free text or template)
- Request budget revision (link to revision workflow)
- Resolve alert (when variance corrected)

**Validation**:
- Alerts checked daily via scheduled job
- Alert thresholds configurable per cost center or globally
- Alert history preserved for audit
- Duplicate alerts suppressed (don't re-alert same issue)

---

### AC5: Budget Approval Notifications

**Given** budget requires approval
**When** approval workflow triggered
**Then** the system sends notifications:
- **To Submitter**:
  - Budget submitted for approval (confirmation)
  - Budget approved (all approvers signed off)
  - Budget rejected (with reason)
  - Revision requested (with notes)
- **To Approvers**:
  - New budget pending your approval (with link)
  - Budget approved by other approver (multi-level approval)
  - Budget withdrawn by submitter
- **To Stakeholders** (cost center owners, finance team):
  - Budget approved and activated
  - Budget revised
  - Budget approaching limit (variance alert)

**Notification channels**:
- Email (primary)
- In-app notification center
- SMS (critical alerts only)
- Slack/Teams integration (if configured)

**Validation**:
- Email templates customizable per organization
- Notification preferences per user (email vs in-app)
- Notification history logged
- Unsubscribe option for non-critical notifications

---

### AC6: Budget Dashboard Widget

**Given** user has access to finance module
**When** viewing finance dashboard
**Then** budget widget displays:
- Summary cards:
  - Total Active Budgets
  - Total Budget Amount
  - Total Actual Spend
  - Total Variance (amount + %)
  - Budgets Over Limit (count)
  - Pending Approvals (count)
- Recent budget alerts (top 5 by severity)
- Budget variance trend chart (last 30 days)
- Top 5 cost centers by variance %
- Quick actions:
  - Create Budget
  - View All Budgets
  - Approve Pending Budgets
  - View Alerts

**Interactivity**:
- Click summary card → navigate to detailed report
- Click alert → view alert detail and action plan
- Click cost center → view budget variance detail
- Refresh button → reload latest data

**Validation**:
- Dashboard data cached (5-minute TTL)
- Real-time updates via WebSocket for critical alerts
- Dashboard responsive on mobile/tablet
- Widget customizable (show/hide sections)

---

## Technical Design

### Database Schema Additions

#### budget_approvals
```sql
CREATE TABLE budget_approvals (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  org_id UUID NOT NULL REFERENCES organizations(id),
  budget_id UUID NOT NULL REFERENCES cost_center_budgets(id),

  approval_level INT NOT NULL DEFAULT 1, -- 1 = first approval, 2 = second, etc.
  approver_role VARCHAR(50) NOT NULL, -- 'finance_manager', 'cfo', 'board'
  required_for_amount_min NUMERIC(15,2), -- Approval required if budget >= this
  required_for_amount_max NUMERIC(15,2),

  status VARCHAR(20) NOT NULL DEFAULT 'pending', -- 'pending', 'approved', 'rejected'
  approved_by UUID REFERENCES users(id),
  approved_at TIMESTAMPTZ,
  approval_notes TEXT,
  rejection_reason TEXT,

  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_budget_approvals_budget ON budget_approvals(budget_id);
CREATE INDEX idx_budget_approvals_status ON budget_approvals(org_id, status);

-- RLS
ALTER TABLE budget_approvals ENABLE ROW LEVEL SECURITY;
CREATE POLICY budget_approvals_org_isolation ON budget_approvals FOR ALL USING (org_id = current_setting('app.org_id')::UUID);
```

#### budget_revisions
```sql
CREATE TABLE budget_revisions (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  org_id UUID NOT NULL REFERENCES organizations(id),
  original_budget_id UUID NOT NULL REFERENCES cost_center_budgets(id),
  revised_budget_id UUID NOT NULL REFERENCES cost_center_budgets(id),

  revision_number INT NOT NULL DEFAULT 1,
  revision_reason VARCHAR(50) NOT NULL,
  revision_notes TEXT,

  original_amount NUMERIC(15,2) NOT NULL,
  revised_amount NUMERIC(15,2) NOT NULL,
  amount_change NUMERIC(15,2) NOT NULL,
  percent_change NUMERIC(5,2) NOT NULL,

  requested_by UUID REFERENCES users(id),
  requested_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  approved_at TIMESTAMPTZ,

  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_budget_revisions_original ON budget_revisions(original_budget_id);
CREATE INDEX idx_budget_revisions_revised ON budget_revisions(revised_budget_id);

-- RLS
ALTER TABLE budget_revisions ENABLE ROW LEVEL SECURITY;
CREATE POLICY budget_revisions_org_isolation ON budget_revisions FOR ALL USING (org_id = current_setting('app.org_id')::UUID);
```

#### budget_forecasts
```sql
CREATE TABLE budget_forecasts (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  org_id UUID NOT NULL REFERENCES organizations(id),
  cost_center_id UUID NOT NULL REFERENCES cost_centers(id),

  forecast_period_start DATE NOT NULL,
  forecast_period_end DATE NOT NULL,

  forecasting_method VARCHAR(50) NOT NULL, -- 'historical_avg', 'trend', 'manual'
  historical_lookback_months INT,
  growth_rate_percent NUMERIC(5,2),
  seasonality_factor NUMERIC(5,2) DEFAULT 1.0,

  historical_avg NUMERIC(15,2),
  historical_min NUMERIC(15,2),
  historical_max NUMERIC(15,2),

  suggested_budget NUMERIC(15,2) NOT NULL,
  confidence_interval_low NUMERIC(15,2),
  confidence_interval_high NUMERIC(15,2),

  assumptions TEXT,
  forecasted_by UUID REFERENCES users(id),
  forecasted_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),

  accepted BOOLEAN DEFAULT FALSE,
  budget_id UUID REFERENCES cost_center_budgets(id), -- Created budget if accepted

  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_budget_forecasts_cost_center ON budget_forecasts(cost_center_id);

-- RLS
ALTER TABLE budget_forecasts ENABLE ROW LEVEL SECURITY;
CREATE POLICY budget_forecasts_org_isolation ON budget_forecasts FOR ALL USING (org_id = current_setting('app.org_id')::UUID);
```

### API Endpoints

```typescript
// Budget Approval
POST /api/finance/budgets/:id/submit-for-approval
Response: { updated budget, created approvals }

GET /api/finance/budgets/:id/approvals
Response: { approvals: BudgetApproval[] }

POST /api/finance/budgets/:id/approve
Body: { approval_notes?: string }
Response: { updated budget approval }

POST /api/finance/budgets/:id/reject
Body: { rejection_reason: string }
Response: { updated budget approval }

POST /api/finance/budgets/:id/request-revision
Body: { revision_notes: string }
Response: { updated budget }

// Budget Revision
POST /api/finance/budgets/:id/revise
Body: {
  revision_reason: string;
  revision_notes?: string;
  revised_amount: number;
  effective_date: ISO date;
}
Response: { created revised budget }

GET /api/finance/budgets/:id/revision-history
Response: { revisions: BudgetRevision[] }

// Budget Forecasting
POST /api/finance/budgets/forecast
Body: {
  cost_center_id: string;
  forecast_period_start: ISO date;
  forecast_period_end: ISO date;
  forecasting_method: 'historical_avg' | 'trend' | 'manual';
  historical_lookback_months?: number;
  growth_rate_percent?: number;
  seasonality_factor?: number;
}
Response: { forecast: BudgetForecast }

POST /api/finance/budgets/forecasts/:id/accept
Response: { created budget from forecast }

// Budget Dashboard
GET /api/finance/budgets/dashboard-summary
Response: {
  total_active_budgets: number;
  total_budget_amount: number;
  total_actual_spend: number;
  total_variance: number;
  total_variance_percent: number;
  budgets_over_limit: number;
  pending_approvals: number;
  recent_alerts: BudgetVarianceAlert[];
  variance_trend: { date: ISO date, variance: number }[];
  top_variances: CostCenterBudget[];
}
```

### Service: BudgetManagementService

```typescript
// apps/frontend/lib/services/budget-management-service.ts
export class BudgetManagementService {
  // Submit budget for approval
  static async submitForApproval(budgetId: string): Promise<Budget> {
    // Determine approval chain based on budget amount
    // Create approval records for each required approver
    // Update budget status to pending_approval
    // Notify approvers
  }

  // Approve budget
  static async approveBudget(
    budgetId: string,
    approverId: string,
    notes?: string
  ): Promise<BudgetApproval> {
    // Validate approver role and permissions
    // Update approval record
    // Check if all approvals complete
    // If complete, activate budget
    // Notify submitter and stakeholders
  }

  // Reject budget
  static async rejectBudget(
    budgetId: string,
    approverId: string,
    reason: string
  ): Promise<BudgetApproval> {
    // Update approval record
    // Update budget status to rejected
    // Notify submitter with rejection reason
  }

  // Create budget revision
  static async createRevision(
    originalBudgetId: string,
    revisionData: RevisionInput
  ): Promise<Budget> {
    // Create new budget version
    // Link to original budget
    // Create revision record
    // Submit for approval
  }

  // Forecast budget
  static async forecastBudget(
    forecastData: ForecastInput
  ): Promise<BudgetForecast> {
    // Get historical cost data
    // Apply forecasting method
    // Calculate suggested budget
    // Calculate confidence interval
    // Save forecast record
  }

  // Accept forecast and create budget
  static async acceptForecast(forecastId: string): Promise<Budget> {
    // Create budget from forecast
    // Link budget to forecast
    // Update forecast.accepted = true
  }

  // Get budget dashboard summary
  static async getDashboardSummary(): Promise<BudgetDashboardSummary> {
    // Aggregate budget metrics
    // Get recent alerts
    // Get variance trends
    // Get top variances
  }
}
```

---

## Frontend Components

### BudgetApprovalWorkflow
```tsx
// apps/frontend/components/finance/budget/BudgetApprovalWorkflow.tsx
export function BudgetApprovalWorkflow({ budgetId }: Props) {
  const { data: budget } = useBudget(budgetId);
  const { data: approvals } = useBudgetApprovals(budgetId);

  const handleApprove = async (approvalId: string, notes: string) => {
    await BudgetManagementService.approveBudget(budgetId, userId, notes);
    toast.success('Budget approved');
  };

  const handleReject = async (approvalId: string, reason: string) => {
    await BudgetManagementService.rejectBudget(budgetId, userId, reason);
    toast.success('Budget rejected');
  };

  return (
    <Card>
      <CardHeader>
        <CardTitle>Approval Workflow</CardTitle>
        <Badge variant={getBudgetStatusVariant(budget?.status)}>{budget?.status}</Badge>
      </CardHeader>
      <CardContent>
        <div className="space-y-4">
          {approvals?.map((approval, index) => (
            <div key={approval.id} className="flex items-center gap-4 p-4 border rounded-md">
              <div className="flex-shrink-0">
                {approval.status === 'approved' && <CheckCircle className="text-green-600" />}
                {approval.status === 'rejected' && <XCircle className="text-red-600" />}
                {approval.status === 'pending' && <Clock className="text-yellow-600" />}
              </div>

              <div className="flex-1">
                <div className="font-semibold">Level {approval.approval_level}: {approval.approver_role}</div>
                {approval.approved_by && (
                  <div className="text-sm text-muted-foreground">
                    Approved by {approval.approved_by_name} on {format(new Date(approval.approved_at), 'PPP')}
                  </div>
                )}
                {approval.approval_notes && (
                  <div className="text-sm mt-1 italic">"{approval.approval_notes}"</div>
                )}
              </div>

              {approval.status === 'pending' && canApprove(approval.approver_role) && (
                <div className="flex gap-2">
                  <Button size="sm" onClick={() => openApproveModal(approval)}>Approve</Button>
                  <Button size="sm" variant="destructive" onClick={() => openRejectModal(approval)}>Reject</Button>
                </div>
              )}
            </div>
          ))}
        </div>
      </CardContent>
    </Card>
  );
}
```

### BudgetRevisionModal
```tsx
// apps/frontend/components/finance/budget/BudgetRevisionModal.tsx
export function BudgetRevisionModal({ budgetId, open, onClose }: Props) {
  const { data: budget } = useBudget(budgetId);
  const [revisionData, setRevisionData] = useState<RevisionInput>({
    revision_reason: '',
    revised_amount: budget?.budget_amount || 0,
    effective_date: new Date(),
  });

  const handleSubmit = async () => {
    await BudgetManagementService.createRevision(budgetId, revisionData);
    toast.success('Budget revision submitted for approval');
    onClose();
  };

  return (
    <Dialog open={open} onOpenChange={onClose}>
      <DialogContent>
        <DialogHeader>
          <DialogTitle>Revise Budget</DialogTitle>
          <DialogDescription>
            Original Budget: {formatCurrency(budget?.budget_amount)}
          </DialogDescription>
        </DialogHeader>

        <div className="space-y-4">
          <div>
            <Label>Revision Reason</Label>
            <Select
              value={revisionData.revision_reason}
              onValueChange={(val) => setRevisionData({ ...revisionData, revision_reason: val })}
            >
              <SelectTrigger><SelectValue /></SelectTrigger>
              <SelectContent>
                <SelectItem value="unexpected_cost_increase">Unexpected Cost Increase</SelectItem>
                <SelectItem value="business_expansion">Business Expansion</SelectItem>
                <SelectItem value="cost_saving_initiative">Cost-Saving Initiative</SelectItem>
                <SelectItem value="seasonal_adjustment">Seasonal Adjustment</SelectItem>
                <SelectItem value="other">Other</SelectItem>
              </SelectContent>
            </Select>
          </div>

          <div>
            <Label>Revised Budget Amount</Label>
            <Input
              type="number"
              step="0.01"
              value={revisionData.revised_amount}
              onChange={(e) => setRevisionData({ ...revisionData, revised_amount: parseFloat(e.target.value) })}
            />
            <p className="text-sm text-muted-foreground mt-1">
              Change: {formatCurrency(revisionData.revised_amount - budget?.budget_amount || 0)}
              ({(((revisionData.revised_amount - budget?.budget_amount) / budget?.budget_amount) * 100).toFixed(2)}%)
            </p>
          </div>

          <div>
            <Label>Effective Date</Label>
            <DatePicker
              value={revisionData.effective_date}
              onChange={(date) => setRevisionData({ ...revisionData, effective_date: date })}
            />
          </div>

          <div>
            <Label>Revision Notes</Label>
            <Textarea
              value={revisionData.revision_notes}
              onChange={(e) => setRevisionData({ ...revisionData, revision_notes: e.target.value })}
              placeholder="Explain the reason for this budget revision..."
              rows={4}
            />
          </div>
        </div>

        <DialogFooter>
          <Button variant="outline" onClick={onClose}>Cancel</Button>
          <Button onClick={handleSubmit}>Submit Revision</Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}
```

### BudgetForecastWizard
```tsx
// apps/frontend/components/finance/budget/BudgetForecastWizard.tsx
export function BudgetForecastWizard({ costCenterId, open, onClose }: Props) {
  const [forecastData, setForecastData] = useState<ForecastInput>({
    cost_center_id: costCenterId,
    forecast_period_start: startOfMonth(addMonths(new Date(), 1)),
    forecast_period_end: endOfMonth(addMonths(new Date(), 1)),
    forecasting_method: 'historical_avg',
    historical_lookback_months: 6,
    growth_rate_percent: 0,
  });

  const [forecast, setForecast] = useState<BudgetForecast | null>(null);

  const handleGenerateForecast = async () => {
    const result = await BudgetManagementService.forecastBudget(forecastData);
    setForecast(result);
  };

  const handleAcceptForecast = async () => {
    await BudgetManagementService.acceptForecast(forecast.id);
    toast.success('Budget created from forecast');
    onClose();
  };

  return (
    <Dialog open={open} onOpenChange={onClose}>
      <DialogContent className="max-w-4xl">
        <DialogHeader>
          <DialogTitle>Budget Forecast Wizard</DialogTitle>
        </DialogHeader>

        {!forecast ? (
          <div className="space-y-4">
            <div className="grid grid-cols-2 gap-4">
              <div>
                <Label>Forecast Period Start</Label>
                <DatePicker
                  value={forecastData.forecast_period_start}
                  onChange={(date) => setForecastData({ ...forecastData, forecast_period_start: date })}
                />
              </div>
              <div>
                <Label>Forecast Period End</Label>
                <DatePicker
                  value={forecastData.forecast_period_end}
                  onChange={(date) => setForecastData({ ...forecastData, forecast_period_end: date })}
                />
              </div>
            </div>

            <div>
              <Label>Forecasting Method</Label>
              <RadioGroup
                value={forecastData.forecasting_method}
                onValueChange={(val) => setForecastData({ ...forecastData, forecasting_method: val })}
              >
                <div className="flex items-center space-x-2">
                  <RadioGroupItem value="historical_avg" id="historical_avg" />
                  <Label htmlFor="historical_avg">Historical Average</Label>
                </div>
                <div className="flex items-center space-x-2">
                  <RadioGroupItem value="trend" id="trend" />
                  <Label htmlFor="trend">Trend-Based (Linear Regression)</Label>
                </div>
                <div className="flex items-center space-x-2">
                  <RadioGroupItem value="manual" id="manual" />
                  <Label htmlFor="manual">Manual Entry</Label>
                </div>
              </RadioGroup>
            </div>

            {forecastData.forecasting_method !== 'manual' && (
              <>
                <div>
                  <Label>Historical Lookback (months)</Label>
                  <Input
                    type="number"
                    min="3"
                    max="24"
                    value={forecastData.historical_lookback_months}
                    onChange={(e) => setForecastData({ ...forecastData, historical_lookback_months: parseInt(e.target.value) })}
                  />
                </div>

                <div>
                  <Label>Growth Rate %</Label>
                  <Input
                    type="number"
                    step="0.1"
                    value={forecastData.growth_rate_percent}
                    onChange={(e) => setForecastData({ ...forecastData, growth_rate_percent: parseFloat(e.target.value) })}
                  />
                </div>
              </>
            )}

            <Button onClick={handleGenerateForecast}>Generate Forecast</Button>
          </div>
        ) : (
          <div className="space-y-4">
            <Card>
              <CardHeader>
                <CardTitle>Forecast Results</CardTitle>
              </CardHeader>
              <CardContent>
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <div className="text-sm text-muted-foreground">Suggested Budget</div>
                    <div className="text-2xl font-bold">{formatCurrency(forecast.suggested_budget)}</div>
                  </div>
                  <div>
                    <div className="text-sm text-muted-foreground">Confidence Interval</div>
                    <div className="text-sm">
                      {formatCurrency(forecast.confidence_interval_low)} - {formatCurrency(forecast.confidence_interval_high)}
                    </div>
                  </div>
                  <div>
                    <div className="text-sm text-muted-foreground">Historical Average</div>
                    <div>{formatCurrency(forecast.historical_avg)}</div>
                  </div>
                  <div>
                    <div className="text-sm text-muted-foreground">Historical Range</div>
                    <div className="text-sm">
                      {formatCurrency(forecast.historical_min)} - {formatCurrency(forecast.historical_max)}
                    </div>
                  </div>
                </div>

                <div className="mt-4">
                  <Label>Assumptions</Label>
                  <p className="text-sm text-muted-foreground">{forecast.assumptions}</p>
                </div>
              </CardContent>
            </Card>

            <div className="flex gap-2">
              <Button onClick={handleAcceptForecast}>Accept & Create Budget</Button>
              <Button variant="outline" onClick={() => setForecast(null)}>Adjust Parameters</Button>
              <Button variant="ghost" onClick={onClose}>Cancel</Button>
            </div>
          </div>
        )}
      </DialogContent>
    </Dialog>
  );
}
```

---

## Dependencies

### Required Stories
- **09.22** - Cost Center Budget & Variance (cost_center_budgets table)
- **09.10** - Cost Center CRUD (cost_centers table)
- **01.1** - Org Context + RLS (users, roles for approvals)

---

## Testing Requirements

### Unit Tests
- Budget approval chain logic (multi-level approvals)
- Budget revision calculation (amount change, % change)
- Forecasting algorithms (historical avg, trend-based)
- Alert threshold triggering

### Integration Tests
- Budget approval workflow (submit → approve → activate)
- Budget revision workflow (create revision → approve → supersede original)
- Budget forecasting (generate forecast → accept → create budget)
- Alert notification delivery

### E2E Tests
1. **Budget Approval Workflow**:
   - Create budget >$50K
   - Submit for approval
   - Finance Manager approves
   - CFO approves
   - Verify budget activated

2. **Budget Revision**:
   - Create active budget
   - Request revision with increase
   - Approve revision
   - Verify original budget superseded

3. **Budget Forecasting**:
   - Select cost center with 6 months history
   - Generate forecast with 5% growth
   - Accept forecast
   - Verify budget created

---

## Performance Requirements

- Approval workflow processing: <1 second
- Forecast calculation: <2 seconds (12 months historical data)
- Dashboard summary load: <1 second

---

## Security & Permissions

Roles: finance_manager (create budgets, approve <$50K)
Roles: cfo (approve $50K-$200K)
Roles: board (approve >$200K)
Roles: budget_controller (view all budgets, forecasting)

---

## Story Metadata

**Estimated Effort:** 3-4 days
**Story Points:** 8
**Priority:** P2 (Phase 3)
**FR Coverage:** FR-9.11.4, FR-9.11.5, FR-9.11.6
**Related Stories:** 09.22 (Budget Variance), 09.24 (Cost Dashboard), 09.25 (Variance Approval)
