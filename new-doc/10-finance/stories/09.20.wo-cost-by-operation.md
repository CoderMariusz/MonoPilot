# Story 09.20: WO Cost by Operation

**Epic:** 09-finance
**Phase:** 2
**Complexity:** M (3-4 days)
**Type:** Backend
**Story File:** `09.20.wo-cost-by-operation.md`

---

## User Story

As a **Production Manager** or **Finance Manager**,
I want to **view work order cost breakdown by routing operation**,
So that I can **identify which operations are driving cost and optimize production processes**.

---

## Business Context

**Problem**: Current work order costing shows total labor and overhead costs, but doesn't reveal which specific operations (mixing, baking, packaging) are consuming the most resources.

**Value**:
- Identify bottleneck operations with high labor or overhead costs
- Compare operation costs across work orders for same product
- Support process optimization decisions (invest in automation, training)
- Enable accurate standard cost setting per operation

**Use Cases**:
1. Production Manager reviews WO-1234 (Chocolate Bar) → sees "Packaging" operation cost is 40% higher than standard → investigates equipment downtime → schedules maintenance
2. Finance Manager compares operation costs for WO-1234 vs WO-1235 (same product) → sees "Mixing" operation has 20% cost variance → identifies inefficiency on Line 2
3. Process Engineer analyzes operation cost history for "Baking" → identifies trend of increasing labor hours → recommends operator training program

---

## Acceptance Criteria

### AC1: Operation Cost Breakdown (FR-9.3.7)

**Given** work order has completed operations with labor and overhead costs
**When** user views work order cost detail page (`/production/work-orders/:id/costs`)
**Then** the system displays operation-level cost breakdown:
- Operation name and sequence number
- Labor cost (hours actual × hourly rate)
- Labor hours (actual vs standard)
- Overhead cost (allocated based on cost center overhead rate)
- Total operation cost
- Cost variance vs standard (amount and %)
- Percentage of total WO cost

**Validation**:
- Operation costs sum to total WO cost
- Labor cost sourced from `labor_costs` table filtered by `operation_id`
- Overhead allocated based on operation duration or labor hours
- Variance calculated as: actual cost - (standard hours × standard rate)

---

### AC2: Operation Cost History (FR-9.1.6)

**Given** product has been produced multiple times
**When** user views operation cost history for specific operation and product
**Then** the system displays:
- Time series of operation costs (last 10 WOs or last 30 days)
- Average operation cost
- Min/max operation cost
- Trend indicator (increasing, stable, decreasing)
- Work order links for drill-down

**Validation**:
- Historical data retrieved from `labor_costs` and `overhead_allocations`
- Trend calculated using linear regression over last 10 data points
- Average excludes outliers (values beyond 2 standard deviations)

---

### AC3: Operation Cost Comparison (FR-9.1.6)

**Given** multiple work orders exist for same product
**When** user compares operation costs across work orders
**Then** the system displays:
- Side-by-side table comparing operation costs
- Highlight operations with significant variance (>10% difference)
- Average cost per operation across selected WOs
- Best/worst performing WO by operation

**Validation**:
- Comparison supports up to 5 work orders
- Variance threshold configurable (default 10%)
- Color coding: green (below average), red (above average), yellow (at average)

---

### AC4: Operation Cost Variance Detail

**Given** operation has cost variance
**When** user expands operation variance detail
**Then** the system shows:
- Labor rate variance: (actual rate - standard rate) × actual hours
- Labor efficiency variance: (actual hours - standard hours) × standard rate
- Overhead variance: actual overhead - standard overhead
- Root cause notes (if entered by user)

**Formula**:
```
Operation Labor Cost Variance = Labor Rate Variance + Labor Efficiency Variance
Labor Rate Variance = (Actual Hourly Rate - Standard Hourly Rate) × Actual Hours
Labor Efficiency Variance = (Actual Hours - Standard Hours) × Standard Hourly Rate
```

**Validation**:
- Variance formulas match FR-FIN-053 (Labor Variance Breakdown)
- User can add root cause notes to operation variance
- Root cause notes saved in `cost_variances` table with `operation_id`

---

## Technical Design

### Database Schema Additions

#### operation_costs (new table)
```sql
CREATE TABLE operation_costs (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  org_id UUID NOT NULL REFERENCES organizations(id),
  work_order_id UUID NOT NULL REFERENCES work_orders(id),
  operation_id UUID NOT NULL REFERENCES routing_operations(id),
  operation_sequence INT NOT NULL,

  -- Labor costs
  labor_hours_actual NUMERIC(10,2) NOT NULL DEFAULT 0,
  labor_hours_standard NUMERIC(10,2) NOT NULL DEFAULT 0,
  labor_cost_actual NUMERIC(15,2) NOT NULL DEFAULT 0,
  labor_cost_standard NUMERIC(15,2) NOT NULL DEFAULT 0,
  labor_rate_variance NUMERIC(15,2) NOT NULL DEFAULT 0,
  labor_efficiency_variance NUMERIC(15,2) NOT NULL DEFAULT 0,

  -- Overhead costs
  overhead_cost_actual NUMERIC(15,2) NOT NULL DEFAULT 0,
  overhead_cost_standard NUMERIC(15,2) NOT NULL DEFAULT 0,
  overhead_variance NUMERIC(15,2) NOT NULL DEFAULT 0,

  -- Totals
  total_cost_actual NUMERIC(15,2) NOT NULL DEFAULT 0,
  total_cost_standard NUMERIC(15,2) NOT NULL DEFAULT 0,
  total_variance NUMERIC(15,2) NOT NULL DEFAULT 0,
  variance_percent NUMERIC(5,2) NOT NULL DEFAULT 0,

  -- Cost as % of WO total
  percent_of_wo_cost NUMERIC(5,2),

  -- Root cause analysis
  variance_root_cause TEXT,
  variance_notes TEXT,

  cost_center_id UUID REFERENCES cost_centers(id),
  costing_date DATE NOT NULL DEFAULT CURRENT_DATE,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_operation_costs_work_order ON operation_costs(work_order_id);
CREATE INDEX idx_operation_costs_operation ON operation_costs(operation_id);
CREATE INDEX idx_operation_costs_org_date ON operation_costs(org_id, costing_date);

-- RLS policies
ALTER TABLE operation_costs ENABLE ROW LEVEL SECURITY;
CREATE POLICY operation_costs_org_isolation ON operation_costs FOR ALL USING (org_id = current_setting('app.org_id')::UUID);
```

### API Endpoints

```typescript
// Get operation cost breakdown for work order
GET /api/finance/work-order-costs/:workOrderId/operations
Response: {
  work_order_id: string;
  work_order_number: string;
  product_name: string;
  total_cost: number;
  operations: {
    operation_id: string;
    operation_name: string;
    operation_sequence: number;
    labor_hours_actual: number;
    labor_hours_standard: number;
    labor_cost_actual: number;
    labor_cost_standard: number;
    labor_rate_variance: number;
    labor_efficiency_variance: number;
    overhead_cost_actual: number;
    overhead_cost_standard: number;
    overhead_variance: number;
    total_cost_actual: number;
    total_cost_standard: number;
    total_variance: number;
    variance_percent: number;
    percent_of_wo_cost: number;
    variance_root_cause?: string;
    variance_notes?: string;
  }[];
}

// Get operation cost history
GET /api/finance/operations/:operationId/cost-history
Query Params:
  - productId: string (required)
  - dateFrom?: ISO date
  - dateTo?: ISO date
  - limit?: number (default 10)

Response: {
  operation_id: string;
  operation_name: string;
  product_id: string;
  product_name: string;
  history: {
    work_order_id: string;
    work_order_number: string;
    costing_date: ISO date;
    total_cost_actual: number;
    labor_hours_actual: number;
    variance_percent: number;
  }[];
  statistics: {
    avg_cost: number;
    min_cost: number;
    max_cost: number;
    avg_hours: number;
    trend: 'increasing' | 'stable' | 'decreasing';
  };
}

// Compare operation costs across work orders
POST /api/finance/reports/compare-operation-costs
Body: {
  work_order_ids: string[]; // Array of WO IDs (2-5)
  product_id: string;
}
Response: {
  product_name: string;
  work_orders: { id, number, total_cost }[];
  operations: {
    operation_id: string;
    operation_name: string;
    costs_by_wo: { work_order_id, cost, variance_from_avg }[];
    avg_cost: number;
    best_wo_id: string;
    worst_wo_id: string;
  }[];
}

// Update operation variance notes
PATCH /api/finance/operation-costs/:id
Body: {
  variance_root_cause?: string;
  variance_notes?: string;
}
Response: { updated operation_cost }
```

### Service: OperationCostService

```typescript
// apps/frontend/lib/services/operation-cost-service.ts
export class OperationCostService {
  // Calculate operation costs for work order
  static async calculateOperationCosts(workOrderId: string): Promise<void> {
    // Aggregate labor_costs by operation_id
    // Allocate overhead to operations (based on labor hours or operation duration)
    // Calculate variances per operation
    // Calculate % of total WO cost per operation
    // Insert/update operation_costs table
  }

  // Get operation cost breakdown for WO
  static async getOperationCosts(workOrderId: string): Promise<OperationCost[]> {
    // Retrieve operation_costs for work order
    // Join with routing_operations for operation details
    // Return sorted by operation_sequence
  }

  // Get operation cost history for product
  static async getOperationCostHistory(
    operationId: string,
    productId: string,
    filters: HistoryFilters
  ): Promise<OperationCostHistory> {
    // Retrieve operation_costs for this operation and product
    // Calculate statistics (avg, min, max, trend)
    // Return time series data
  }

  // Compare operation costs across work orders
  static async compareOperationCosts(
    workOrderIds: string[],
    productId: string
  ): Promise<OperationCostComparison> {
    // Retrieve operation_costs for all selected work orders
    // Align operations across work orders
    // Calculate avg cost per operation
    // Identify best/worst performing WO per operation
  }

  // Update operation variance notes
  static async updateOperationVarianceNotes(
    operationCostId: string,
    notes: { variance_root_cause?: string; variance_notes?: string }
  ): Promise<OperationCost> {
    // Update operation_costs record
    // Also update cost_variances table if linked variance exists
  }
}
```

### Database Function: Calculate Operation Costs

```sql
-- Function to calculate and populate operation_costs
CREATE OR REPLACE FUNCTION calculate_operation_costs(p_work_order_id UUID)
RETURNS VOID AS $$
DECLARE
  v_wo_total_cost NUMERIC;
BEGIN
  -- Get total WO cost
  SELECT total_cost_actual INTO v_wo_total_cost
  FROM work_order_costs
  WHERE work_order_id = p_work_order_id;

  -- Delete existing operation costs (if recalculating)
  DELETE FROM operation_costs WHERE work_order_id = p_work_order_id;

  -- Insert operation costs
  INSERT INTO operation_costs (
    org_id,
    work_order_id,
    operation_id,
    operation_sequence,
    labor_hours_actual,
    labor_hours_standard,
    labor_cost_actual,
    labor_cost_standard,
    labor_rate_variance,
    labor_efficiency_variance,
    overhead_cost_actual,
    overhead_cost_standard,
    overhead_variance,
    total_cost_actual,
    total_cost_standard,
    total_variance,
    variance_percent,
    percent_of_wo_cost,
    cost_center_id,
    costing_date
  )
  SELECT
    wo.org_id,
    lc.work_order_id,
    lc.operation_id,
    ro.sequence AS operation_sequence,
    SUM(lc.hours_actual) AS labor_hours_actual,
    SUM(lc.hours_standard) AS labor_hours_standard,
    SUM(lc.total_cost) AS labor_cost_actual,
    SUM(lc.hours_standard * lc.hourly_rate) AS labor_cost_standard,
    -- Labor rate variance
    SUM((lc.hourly_rate - sc.labor_cost) * lc.hours_actual) AS labor_rate_variance,
    -- Labor efficiency variance
    SUM((lc.hours_actual - lc.hours_standard) * sc.labor_cost) AS labor_efficiency_variance,
    -- Overhead (allocated proportionally by labor hours)
    COALESCE(SUM(oa.total_cost), 0) AS overhead_cost_actual,
    0 AS overhead_cost_standard, -- TODO: Calculate from routing
    COALESCE(SUM(oa.total_cost), 0) AS overhead_variance,
    -- Totals
    SUM(lc.total_cost) + COALESCE(SUM(oa.total_cost), 0) AS total_cost_actual,
    SUM(lc.hours_standard * lc.hourly_rate) AS total_cost_standard,
    (SUM(lc.total_cost) + COALESCE(SUM(oa.total_cost), 0)) - SUM(lc.hours_standard * lc.hourly_rate) AS total_variance,
    -- Variance %
    CASE
      WHEN SUM(lc.hours_standard * lc.hourly_rate) > 0
      THEN (((SUM(lc.total_cost) + COALESCE(SUM(oa.total_cost), 0)) - SUM(lc.hours_standard * lc.hourly_rate)) / SUM(lc.hours_standard * lc.hourly_rate)) * 100
      ELSE 0
    END AS variance_percent,
    -- % of WO cost
    CASE
      WHEN v_wo_total_cost > 0
      THEN ((SUM(lc.total_cost) + COALESCE(SUM(oa.total_cost), 0)) / v_wo_total_cost) * 100
      ELSE 0
    END AS percent_of_wo_cost,
    lc.cost_center_id,
    CURRENT_DATE AS costing_date
  FROM labor_costs lc
  JOIN work_orders wo ON lc.work_order_id = wo.id
  JOIN routing_operations ro ON lc.operation_id = ro.id
  LEFT JOIN standard_costs sc ON wo.product_id = sc.item_id AND sc.item_type = 'product'
  LEFT JOIN overhead_allocations oa ON lc.work_order_id = oa.work_order_id AND lc.operation_id = oa.operation_id
  WHERE lc.work_order_id = p_work_order_id
  GROUP BY wo.org_id, lc.work_order_id, lc.operation_id, ro.sequence, lc.cost_center_id;
END;
$$ LANGUAGE plpgsql;
```

---

## Frontend Components

### WOOperationCostBreakdown
```tsx
// apps/frontend/components/finance/work-order/WOOperationCostBreakdown.tsx
export function WOOperationCostBreakdown({ workOrderId }: Props) {
  const { data, isLoading } = useOperationCosts(workOrderId);

  return (
    <Card>
      <CardHeader>
        <CardTitle>Cost by Operation</CardTitle>
        <CardDescription>
          Work Order: {data?.work_order_number} - {data?.product_name}
        </CardDescription>
      </CardHeader>
      <CardContent>
        <Table>
          <TableHeader>
            <TableRow>
              <TableHead>#</TableHead>
              <TableHead>Operation</TableHead>
              <TableHead>Labor Hours</TableHead>
              <TableHead>Labor Cost</TableHead>
              <TableHead>Overhead</TableHead>
              <TableHead>Total Cost</TableHead>
              <TableHead>Variance</TableHead>
              <TableHead>% of WO</TableHead>
              <TableHead></TableHead>
            </TableRow>
          </TableHeader>
          <TableBody>
            {data?.operations.map(op => (
              <TableRow key={op.operation_id}>
                <TableCell>{op.operation_sequence}</TableCell>
                <TableCell>{op.operation_name}</TableCell>
                <TableCell>
                  {op.labor_hours_actual.toFixed(2)}h / {op.labor_hours_standard.toFixed(2)}h
                </TableCell>
                <TableCell>{formatCurrency(op.labor_cost_actual)}</TableCell>
                <TableCell>{formatCurrency(op.overhead_cost_actual)}</TableCell>
                <TableCell><strong>{formatCurrency(op.total_cost_actual)}</strong></TableCell>
                <TableCell className={op.total_variance > 0 ? 'text-red-600' : 'text-green-600'}>
                  {formatCurrency(op.total_variance)} ({op.variance_percent.toFixed(2)}%)
                </TableCell>
                <TableCell>{op.percent_of_wo_cost.toFixed(1)}%</TableCell>
                <TableCell>
                  <Button size="sm" variant="ghost" onClick={() => openVarianceDetail(op)}>
                    Details
                  </Button>
                </TableCell>
              </TableRow>
            ))}

            <TableRow className="font-bold border-t-2">
              <TableCell colSpan={5}>Total</TableCell>
              <TableCell>{formatCurrency(data?.total_cost)}</TableCell>
              <TableCell colSpan={2}></TableCell>
            </TableRow>
          </TableBody>
        </Table>
      </CardContent>
    </Card>
  );
}
```

### OperationVarianceDetailModal
```tsx
// apps/frontend/components/finance/operation/OperationVarianceDetailModal.tsx
export function OperationVarianceDetailModal({ operationCost, open, onClose }: Props) {
  const [notes, setNotes] = useState({
    variance_root_cause: operationCost.variance_root_cause || '',
    variance_notes: operationCost.variance_notes || '',
  });

  const handleSaveNotes = async () => {
    await OperationCostService.updateOperationVarianceNotes(operationCost.id, notes);
    toast.success('Variance notes saved');
    onClose();
  };

  return (
    <Dialog open={open} onOpenChange={onClose}>
      <DialogContent>
        <DialogHeader>
          <DialogTitle>{operationCost.operation_name} - Variance Detail</DialogTitle>
        </DialogHeader>

        <div className="space-y-4">
          <Card>
            <CardHeader><CardTitle className="text-sm">Labor Variance Breakdown</CardTitle></CardHeader>
            <CardContent>
              <div className="space-y-2 text-sm">
                <div className="flex justify-between">
                  <span>Labor Rate Variance:</span>
                  <span className={operationCost.labor_rate_variance > 0 ? 'text-red-600' : 'text-green-600'}>
                    {formatCurrency(operationCost.labor_rate_variance)}
                  </span>
                </div>
                <div className="flex justify-between">
                  <span>Labor Efficiency Variance:</span>
                  <span className={operationCost.labor_efficiency_variance > 0 ? 'text-red-600' : 'text-green-600'}>
                    {formatCurrency(operationCost.labor_efficiency_variance)}
                  </span>
                </div>
                <Separator />
                <div className="flex justify-between font-bold">
                  <span>Total Labor Variance:</span>
                  <span>{formatCurrency(operationCost.labor_rate_variance + operationCost.labor_efficiency_variance)}</span>
                </div>
              </div>
            </CardContent>
          </Card>

          <Card>
            <CardHeader><CardTitle className="text-sm">Overhead Variance</CardTitle></CardHeader>
            <CardContent>
              <div className="flex justify-between">
                <span>Overhead Variance:</span>
                <span className={operationCost.overhead_variance > 0 ? 'text-red-600' : 'text-green-600'}>
                  {formatCurrency(operationCost.overhead_variance)}
                </span>
              </div>
            </CardContent>
          </Card>

          <div>
            <Label>Root Cause Category</Label>
            <Select value={notes.variance_root_cause} onValueChange={(val) => setNotes({ ...notes, variance_root_cause: val })}>
              <SelectTrigger>
                <SelectValue placeholder="Select root cause" />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="equipment_downtime">Equipment Downtime</SelectItem>
                <SelectItem value="material_shortage">Material Shortage</SelectItem>
                <SelectItem value="operator_training">Operator Training</SelectItem>
                <SelectItem value="process_inefficiency">Process Inefficiency</SelectItem>
                <SelectItem value="quality_issue">Quality Issue</SelectItem>
                <SelectItem value="other">Other</SelectItem>
              </SelectContent>
            </Select>
          </div>

          <div>
            <Label>Variance Notes</Label>
            <Textarea
              value={notes.variance_notes}
              onChange={(e) => setNotes({ ...notes, variance_notes: e.target.value })}
              placeholder="Describe the root cause and corrective actions..."
              rows={4}
            />
          </div>
        </div>

        <DialogFooter>
          <Button variant="outline" onClick={onClose}>Cancel</Button>
          <Button onClick={handleSaveNotes}>Save Notes</Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}
```

### OperationCostHistoryChart
```tsx
// apps/frontend/components/finance/operation/OperationCostHistoryChart.tsx
export function OperationCostHistoryChart({ operationId, productId }: Props) {
  const { data } = useOperationCostHistory(operationId, productId);

  const chartData = data?.history.map(h => ({
    date: format(new Date(h.costing_date), 'MM/dd'),
    cost: h.total_cost_actual,
    hours: h.labor_hours_actual,
    wo: h.work_order_number,
  }));

  return (
    <Card>
      <CardHeader>
        <CardTitle>Operation Cost History - {data?.operation_name}</CardTitle>
        <CardDescription>
          Avg: {formatCurrency(data?.statistics.avg_cost)} |
          Trend: <Badge>{data?.statistics.trend}</Badge>
        </CardDescription>
      </CardHeader>
      <CardContent>
        <ResponsiveContainer width="100%" height={200}>
          <LineChart data={chartData}>
            <CartesianGrid strokeDasharray="3 3" />
            <XAxis dataKey="date" />
            <YAxis />
            <Tooltip />
            <Line type="monotone" dataKey="cost" stroke="#8884d8" name="Cost" />
          </LineChart>
        </ResponsiveContainer>
      </CardContent>
    </Card>
  );
}
```

---

## Dependencies

### Required Stories
- **02.6** - Routing Management (routing_operations table)
- **04.3** - Operation Tracking (labor time per operation)
- **09.4** - Labor Cost Tracking (labor_costs table)
- **09.6** - WO Cost Summary (work_order_costs table)
- **09.12** - Overhead Allocation (overhead_allocations table)

---

## Testing Requirements

### Unit Tests
- Operation cost calculation accuracy
- Labor rate and efficiency variance formulas
- Overhead allocation to operations
- % of WO cost calculation
- Trend calculation (linear regression)

### Integration Tests
- Calculate operation costs for WO with multiple operations
- Operation cost history retrieval
- Compare operation costs across work orders
- Update operation variance notes

### E2E Tests
1. **Operation cost breakdown**:
   - Complete work order with 3 operations
   - Navigate to WO cost detail page
   - Verify operation cost breakdown table displays
   - Click "Details" on operation → verify variance modal opens

2. **Operation cost history**:
   - Complete 5 work orders for same product
   - View operation cost history chart
   - Verify trend indicator displays correctly

---

## Performance Requirements

- Calculate operation costs: <500ms per work order
- Operation cost history query: <1 second
- Compare operation costs: <1 second (5 work orders)

---

## Security & Permissions

Roles: finance_manager, production_manager, cost_accountant (view operation costs)

---

## Story Metadata

**Estimated Effort:** 3-4 days
**Story Points:** 8
**Priority:** P1 (Phase 2)
**FR Coverage:** FR-9.3.7, FR-9.1.6
**Related Stories:** 09.4 (Labor Cost Tracking), 09.12 (Overhead Allocation), 09.6 (WO Cost Summary)
