# Story 09.26: Accounting Integration (Comarch Optima)

**Epic:** 09-finance
**Phase:** 3
**Complexity:** M (4-5 days)
**Type:** Backend
**Story File:** `09.26.accounting-integration-comarch.md`

---

## User Story

As a **Finance Manager** or **Accountant**,
I want to **export financial data to Comarch Optima in compatible XML/CSV format with GL account mapping**,
So that I can **integrate production costs with our accounting system without manual data entry**.

---

## Business Context

**Problem**: Manual transfer of production cost data to accounting system (Comarch Optima) is error-prone, time-consuming (4-6 hours monthly), and delays month-end close.

**Value**:
- Eliminate manual data entry (save 4-6 hours/month)
- Reduce errors from transcription mistakes
- Accelerate month-end close (1-2 days faster)
- Ensure consistent GL account mapping
- Provide audit trail for all exports
- Support automated scheduled exports

**Use Cases**:
1. Finance Manager exports January production costs → selects "Comarch Optima XML" format → maps material costs to GL 4100, labor to GL 5200, overhead to GL 5300 → exports file → imports into Comarch Optima → posts to GL
2. Cost Accountant schedules weekly WO cost export → system auto-generates XML every Monday → saves to shared folder → Comarch Optima auto-imports → costs posted automatically
3. Auditor reviews export log → sees all exports with timestamps, user, record counts → validates completeness → confirms GL mapping → signs off on month-end
4. CFO reviews variance export → unfavorable variances post to debit accounts, favorable to credit accounts → GL account mapping ensures proper financial statement presentation

---

## Acceptance Criteria

### AC1: Export to CSV (FR-9.12.1)

**Given** user selects financial data to export
**When** choosing "Export to CSV" format
**Then** the system generates CSV file with:
- **Standard CSV Structure**:
  - Header row with column names
  - One row per transaction/record
  - Comma-separated values
  - Text fields quoted if contain commas
  - UTF-8 encoding (Polish characters support)
- **Columns** (work order costs):
  - Document Number (WO number)
  - Document Date (costing date)
  - Product SKU
  - Product Name
  - Quantity Produced
  - Material Cost
  - Labor Cost
  - Overhead Cost
  - Total Cost
  - Cost Center Code
  - Currency Code
- **Filename**: `MonoPilot_Export_{YYYY-MM-DD}_{HHMMSS}.csv`
- **Download**: Immediate browser download or save to server path

**Validation**:
- CSV opens correctly in Excel/LibreOffice
- Polish characters (ą, ć, ę, ł, ń, ó, ś, ź, ż) display correctly
- Numbers use decimal point (not comma) for compatibility
- Dates in ISO format (YYYY-MM-DD) or configurable format

---

### AC2: Export to XML (FR-9.12.2)

**Given** user selects financial data to export
**When** choosing "Export to XML" format
**Then** the system generates XML file with:
- **Standard XML Structure**:
  - XML declaration: `<?xml version="1.0" encoding="UTF-8"?>`
  - Root element: `<MonoPilotExport>`
  - Metadata: Export date, org name, user, record count
  - Transaction records in `<Transaction>` elements
- **Example Structure**:
```xml
<?xml version="1.0" encoding="UTF-8"?>
<MonoPilotExport>
  <Metadata>
    <ExportDate>2025-01-15T10:30:00Z</ExportDate>
    <Organization>Acme Foods</Organization>
    <ExportedBy>john.doe@example.com</ExportedBy>
    <RecordCount>150</RecordCount>
  </Metadata>
  <Transactions>
    <Transaction>
      <DocumentNumber>WO-2025-001</DocumentNumber>
      <DocumentDate>2025-01-14</DocumentDate>
      <ProductSKU>CHOC-001</ProductSKU>
      <ProductName>Chocolate Bar</ProductName>
      <QuantityProduced>1000</QuantityProduced>
      <MaterialCost>5000.00</MaterialCost>
      <LaborCost>2000.00</LaborCost>
      <OverheadCost>1500.00</OverheadCost>
      <TotalCost>8500.00</TotalCost>
      <CostCenter>PROD-LINE-1</CostCenter>
      <CurrencyCode>PLN</CurrencyCode>
    </Transaction>
    ...
  </Transactions>
</MonoPilotExport>
```

**Validation**:
- XML validates against schema (if provided)
- Well-formed XML (no unclosed tags)
- CDATA sections for text with special characters

---

### AC3: Comarch Optima XML Format (FR-9.12.3, FR-FIN-058)

**Given** user exports for Comarch Optima import
**When** selecting "Comarch Optima" export format
**Then** the system generates XML compatible with Comarch Optima import:
- **Document Type**: Production Cost Journal Entry
- **Comarch XML Schema**:
```xml
<?xml version="1.0" encoding="UTF-8"?>
<Root xmlns="http://www.comarch.pl/cdn/import">
  <Documents>
    <Document>
      <DocumentType>JP</DocumentType> <!-- JP = Journal Entry (Polecenie Księgowania) -->
      <DocumentNumber>MP-WO-2025-001</DocumentNumber>
      <DocumentDate>2025-01-14</DocumentDate>
      <Description>Production Cost - WO-2025-001 - Chocolate Bar</Description>
      <Items>
        <Item>
          <AccountCode>4100</AccountCode> <!-- Material Cost Account -->
          <Debit>5000.00</Debit>
          <Credit>0.00</Credit>
          <CostCenter>PROD-LINE-1</CostCenter>
          <Description>Material Cost</Description>
        </Item>
        <Item>
          <AccountCode>5200</AccountCode> <!-- Labor Cost Account -->
          <Debit>2000.00</Debit>
          <Credit>0.00</Credit>
          <CostCenter>PROD-LINE-1</CostCenter>
          <Description>Labor Cost</Description>
        </Item>
        <Item>
          <AccountCode>5300</AccountCode> <!-- Overhead Cost Account -->
          <Debit>1500.00</Debit>
          <Credit>0.00</Credit>
          <CostCenter>PROD-LINE-1</CostCenter>
          <Description>Overhead Cost</Description>
        </Item>
        <Item>
          <AccountCode>1300</AccountCode> <!-- WIP Account -->
          <Debit>0.00</Debit>
          <Credit>8500.00</Credit>
          <CostCenter>PROD-LINE-1</CostCenter>
          <Description>WIP Allocation</Description>
        </Item>
      </Items>
    </Document>
  </Documents>
</Root>
```

**GL Account Mapping** (from gl_account_mappings table):
- Material Cost → Debit GL 4100 (Surowce - Raw Materials)
- Labor Cost → Debit GL 5200 (Koszty Wynagrodzeń - Payroll Costs)
- Overhead Cost → Debit GL 5300 (Koszty Ogólne - Overhead)
- WIP → Credit GL 1300 (Produkcja w Toku - Work in Process)

**Variance Export**:
- Material Price Variance → GL 4110
- Material Usage Variance → GL 4120
- Labor Rate Variance → GL 5210
- Labor Efficiency Variance → GL 5220
- Overhead Variance → GL 5310

**Validation**:
- XML imports successfully into Comarch Optima test instance
- Debit and credit amounts balance (sum debit = sum credit per document)
- GL account codes valid in Comarch chart of accounts
- Cost center codes match Comarch cost center setup

---

### AC4: GL Account Mapping Configuration (FR-9.12.7)

**Given** user has finance_manager role
**When** configuring GL account mappings
**Then** the system allows:
- **Mapping Table**: Cost Category → GL Account Code
- **Configurable Mappings**:
  - Material Cost (actual) → GL XXXX
  - Labor Cost (actual) → GL XXXX
  - Overhead Cost (actual) → GL XXXX
  - WIP (work in process) → GL XXXX
  - Finished Goods → GL XXXX
  - Material Price Variance → GL XXXX
  - Material Usage Variance → GL XXXX
  - Labor Rate Variance → GL XXXX
  - Labor Efficiency Variance → GL XXXX
  - Overhead Variance → GL XXXX
  - Scrap/Waste → GL XXXX
- **Mapping Properties**:
  - GL Account Code (e.g., "4100")
  - GL Account Name (e.g., "Surowce")
  - Debit or Credit (normal balance)
  - Description
  - Effective date (for historical mapping changes)
  - Is Active
- **Validation Rules**:
  - GL account code format: 4 digits (Comarch standard)
  - No duplicate mappings for same cost category
  - Historical mappings preserved (for audit trail)

**Validation**:
- Mappings applied consistently across all exports
- Mapping changes logged in audit trail
- Default mappings provided (can be customized)

---

### AC5: Scheduled Exports (FR-9.12.5)

**Given** user configures scheduled export
**When** setting up export schedule
**Then** the system allows:
- **Schedule Frequency**:
  - Daily (specific time, e.g., 6:00 AM)
  - Weekly (specific day and time, e.g., Monday 6:00 AM)
  - Monthly (specific date and time, e.g., 1st of month 6:00 AM)
  - Custom cron expression (advanced)
- **Export Configuration**:
  - Data type (WO costs, variances, inventory valuation)
  - Export format (CSV, XML, Comarch Optima)
  - Date range (last 7 days, last month, MTD, QTD)
  - Filters (production line, product category)
  - GL account mapping set
- **Delivery Method**:
  - Save to server path (for network share or FTP)
  - Email to recipient(s) (with attachment)
  - SFTP upload to remote server
  - Webhook notification when export complete
- **Schedule Management**:
  - Enable/disable schedule
  - Edit schedule parameters
  - View next run time
  - View last run status and timestamp
  - View run history (last 30 executions)

**Validation**:
- Scheduled exports run at configured time (±5 minutes)
- Failed exports retry up to 3 times
- Email notifications sent on success or failure
- Export history logged for troubleshooting

---

### AC6: Export Audit Log (FR-9.12.6)

**Given** financial exports occur
**When** viewing export audit log
**Then** the system displays:
- **Audit Log Entries** (one per export):
  - Export ID (unique identifier)
  - Export Date/Time
  - Exported By (user name/email)
  - Export Type (Manual, Scheduled)
  - Data Type (WO Costs, Variances, etc.)
  - Export Format (CSV, XML, Comarch)
  - Date Range (data exported)
  - Record Count
  - File Name
  - File Size
  - Status (Success, Failed, Partial)
  - Error Message (if failed)
  - Download Link (if file stored)
- **Filters**: Date range, user, export type, status
- **Search**: By export ID, file name, user
- **Export Log**: Export audit log to CSV/Excel

**Validation**:
- Audit log immutable (no edits/deletes)
- Log entries created automatically for all exports
- Failed export logs include error details
- Log retention: 2 years minimum (configurable)

---

### AC7: Export Variance Data (FR-FIN-058)

**Given** cost variances exist
**When** exporting variances to Comarch Optima
**Then** the system:
- Exports variance journal entries with:
  - Document Type: "Variance Adjustment"
  - Document Number: `VAR-{YYYYMM}-{XXXX}`
  - Variance Type (MPV, MQV, LRV, LEV, OHV)
  - Work Order Reference
  - Product Reference
- **Variance GL Posting**:
  - Unfavorable variance (actual > standard):
    - Debit: Variance GL Account (expense)
    - Credit: WIP or COGS
  - Favorable variance (actual < standard):
    - Debit: WIP or COGS
    - Credit: Variance GL Account (contra-expense)
- **Variance Description**: "Variance - {Type} - WO {Number} - {Product}"
- **Prevent Duplicate Export**: Mark variance as exported (exported_at timestamp)

**Validation**:
- Variance export uses correct GL accounts from mapping
- Debit/credit logic correct for favorable vs unfavorable
- Duplicate export warning if variance already exported
- Re-export requires confirmation

---

## Technical Design

### Database Schema Additions

#### finance_exports
```sql
CREATE TABLE finance_exports (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  org_id UUID NOT NULL REFERENCES organizations(id),

  export_type VARCHAR(50) NOT NULL, -- 'manual', 'scheduled'
  data_type VARCHAR(50) NOT NULL, -- 'wo_costs', 'variances', 'inventory_valuation'
  export_format VARCHAR(50) NOT NULL, -- 'csv', 'xml', 'comarch_optima'

  date_range_start DATE NOT NULL,
  date_range_end DATE NOT NULL,

  filters JSONB, -- { production_line_id, product_category_id, etc. }

  record_count INT DEFAULT 0,
  file_name VARCHAR(255),
  file_path TEXT,
  file_size_bytes BIGINT,

  status VARCHAR(20) NOT NULL DEFAULT 'pending', -- 'pending', 'success', 'failed', 'partial'
  error_message TEXT,

  exported_by UUID REFERENCES users(id),
  exported_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),

  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_finance_exports_org_date ON finance_exports(org_id, exported_at DESC);
CREATE INDEX idx_finance_exports_status ON finance_exports(org_id, status);

-- RLS
ALTER TABLE finance_exports ENABLE ROW LEVEL SECURITY;
CREATE POLICY finance_exports_org_isolation ON finance_exports FOR ALL USING (org_id = current_setting('app.org_id')::UUID);
```

#### export_schedules
```sql
CREATE TABLE export_schedules (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  org_id UUID NOT NULL REFERENCES organizations(id),

  schedule_name VARCHAR(255) NOT NULL,
  description TEXT,

  frequency VARCHAR(50) NOT NULL, -- 'daily', 'weekly', 'monthly', 'custom'
  cron_expression VARCHAR(100), -- For custom frequency
  time_of_day TIME, -- HH:MM
  day_of_week INT, -- 0-6 (Sunday=0) for weekly
  day_of_month INT, -- 1-31 for monthly

  data_type VARCHAR(50) NOT NULL,
  export_format VARCHAR(50) NOT NULL,
  date_range_type VARCHAR(50) NOT NULL, -- 'last_7_days', 'last_month', 'mtd', 'qtd'
  filters JSONB,

  delivery_method VARCHAR(50) NOT NULL, -- 'server_path', 'email', 'sftp'
  delivery_config JSONB, -- { path, email, sftp_host, etc. }

  is_active BOOLEAN DEFAULT TRUE,
  last_run_at TIMESTAMPTZ,
  last_run_status VARCHAR(20),
  next_run_at TIMESTAMPTZ,

  created_by UUID REFERENCES users(id),
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_export_schedules_org ON export_schedules(org_id);
CREATE INDEX idx_export_schedules_next_run ON export_schedules(next_run_at) WHERE is_active = TRUE;

-- RLS
ALTER TABLE export_schedules ENABLE ROW LEVEL SECURITY;
CREATE POLICY export_schedules_org_isolation ON export_schedules FOR ALL USING (org_id = current_setting('app.org_id')::UUID);
```

#### gl_account_mappings (enhanced from PRD)
```sql
-- Already defined in PRD, adding indexes
CREATE INDEX idx_gl_mappings_org_category ON gl_account_mappings(org_id, cost_category);
```

### API Endpoints

```typescript
// Export Work Order Costs
POST /api/finance/exports/wo-costs
Body: {
  export_format: 'csv' | 'xml' | 'comarch_optima';
  date_from: ISO date;
  date_to: ISO date;
  filters?: { production_line_id?, product_category_id? };
}
Response: Blob (file download) or { export_id, file_url }

// Export Variances
POST /api/finance/exports/variances
Body: {
  export_format: 'csv' | 'xml' | 'comarch_optima';
  date_from: ISO date;
  date_to: ISO date;
  variance_types?: ['material', 'labor', 'overhead'];
}
Response: Blob or { export_id, file_url }

// GL Account Mapping CRUD
GET /api/finance/settings/gl-account-mappings
POST /api/finance/settings/gl-account-mappings
PATCH /api/finance/settings/gl-account-mappings/:id
DELETE /api/finance/settings/gl-account-mappings/:id

// Export Schedules CRUD
GET /api/finance/exports/schedules
POST /api/finance/exports/schedules
PATCH /api/finance/exports/schedules/:id
DELETE /api/finance/exports/schedules/:id

// Export Audit Log
GET /api/finance/exports/audit-log
Query Params:
  - dateFrom?, dateTo?
  - exportedBy?: userId
  - status?: 'success' | 'failed' | 'partial'
Response: { exports: FinanceExport[] }

// Re-download Export
GET /api/finance/exports/:id/download
Response: Blob (file)
```

### Service: ExportService

```typescript
// apps/frontend/lib/services/export-service.ts
export class ExportService {
  // Export WO costs to CSV
  static async exportToCSV(data: ExportData): Promise<Blob> {
    // Convert data to CSV format
    // Create CSV string with headers and rows
    // Return as downloadable Blob
  }

  // Export WO costs to XML
  static async exportToXML(data: ExportData): Promise<Blob> {
    // Convert data to XML structure
    // Generate XML with proper encoding
    // Return as downloadable Blob
  }

  // Export to Comarch Optima XML
  static async exportToComarch(data: ExportData): Promise<Blob> {
    // Get GL account mappings
    // Convert data to Comarch XML schema
    // Create journal entries with debit/credit
    // Validate debit = credit balance
    // Return as downloadable Blob
  }

  // Export variances
  static async exportVariances(
    exportFormat: ExportFormat,
    filters: VarianceFilters
  ): Promise<Blob> {
    // Get variance data
    // Get GL account mappings for variance accounts
    // Generate export in requested format
    // Mark variances as exported
    // Create export audit log entry
  }

  // Create scheduled export
  static async createSchedule(scheduleData: ScheduleInput): Promise<ExportSchedule> {
    // Validate schedule configuration
    // Calculate next run time
    // Create schedule record
  }

  // Execute scheduled export (called by cron job)
  static async executeScheduledExport(scheduleId: string): Promise<void> {
    // Get schedule configuration
    // Generate export
    // Deliver via configured method (save, email, SFTP)
    // Update last_run_at, next_run_at
    // Create export audit log entry
  }
}
```

---

## Frontend Components

### ExportWizard
```tsx
// apps/frontend/components/finance/export/ExportWizard.tsx
export function ExportWizard({ open, onClose }: Props) {
  const [step, setStep] = useState(1);
  const [exportConfig, setExportConfig] = useState<ExportConfig>({
    data_type: 'wo_costs',
    export_format: 'csv',
    date_from: subMonths(new Date(), 1),
    date_to: new Date(),
  });

  const handleExport = async () => {
    const blob = await ExportService.exportToComarch(exportConfig);
    downloadBlob(blob, `Comarch_Export_${format(new Date(), 'yyyyMMdd_HHmmss')}.xml`);
    toast.success('Export generated successfully');
    onClose();
  };

  return (
    <Dialog open={open} onOpenChange={onClose}>
      <DialogContent className="max-w-2xl">
        <DialogHeader>
          <DialogTitle>Export to Comarch Optima</DialogTitle>
        </DialogHeader>

        {step === 1 && (
          <div className="space-y-4">
            <div>
              <Label>Data Type</Label>
              <RadioGroup value={exportConfig.data_type} onValueChange={(val) => setExportConfig({ ...exportConfig, data_type: val })}>
                <div className="flex items-center space-x-2">
                  <RadioGroupItem value="wo_costs" id="wo_costs" />
                  <Label htmlFor="wo_costs">Work Order Costs</Label>
                </div>
                <div className="flex items-center space-x-2">
                  <RadioGroupItem value="variances" id="variances" />
                  <Label htmlFor="variances">Cost Variances</Label>
                </div>
                <div className="flex items-center space-x-2">
                  <RadioGroupItem value="inventory" id="inventory" />
                  <Label htmlFor="inventory">Inventory Valuation</Label>
                </div>
              </RadioGroup>
            </div>

            <div>
              <Label>Export Format</Label>
              <Select value={exportConfig.export_format} onValueChange={(val) => setExportConfig({ ...exportConfig, export_format: val })}>
                <SelectTrigger><SelectValue /></SelectTrigger>
                <SelectContent>
                  <SelectItem value="comarch_optima">Comarch Optima XML</SelectItem>
                  <SelectItem value="xml">Generic XML</SelectItem>
                  <SelectItem value="csv">CSV</SelectItem>
                </SelectContent>
              </Select>
            </div>

            <div className="grid grid-cols-2 gap-4">
              <div>
                <Label>Date From</Label>
                <DatePicker value={exportConfig.date_from} onChange={(date) => setExportConfig({ ...exportConfig, date_from: date })} />
              </div>
              <div>
                <Label>Date To</Label>
                <DatePicker value={exportConfig.date_to} onChange={(date) => setExportConfig({ ...exportConfig, date_to: date })} />
              </div>
            </div>

            <Button onClick={() => setStep(2)}>Next: Review</Button>
          </div>
        )}

        {step === 2 && (
          <div className="space-y-4">
            <Card>
              <CardHeader><CardTitle className="text-sm">Export Configuration</CardTitle></CardHeader>
              <CardContent className="text-sm space-y-2">
                <div><strong>Data Type:</strong> {exportConfig.data_type}</div>
                <div><strong>Format:</strong> {exportConfig.export_format}</div>
                <div><strong>Date Range:</strong> {format(exportConfig.date_from, 'PP')} - {format(exportConfig.date_to, 'PP')}</div>
              </CardContent>
            </Card>

            <div className="flex gap-2">
              <Button variant="outline" onClick={() => setStep(1)}>Back</Button>
              <Button onClick={handleExport}>Export</Button>
            </div>
          </div>
        )}
      </DialogContent>
    </Dialog>
  );
}
```

### GLAccountMappingConfig
```tsx
// apps/frontend/components/finance/settings/GLAccountMappingConfig.tsx
export function GLAccountMappingConfig() {
  const { data: mappings, isLoading } = useGLAccountMappings();

  return (
    <Card>
      <CardHeader>
        <CardTitle>GL Account Mappings (Comarch Optima)</CardTitle>
        <CardDescription>
          Configure how MonoPilot cost categories map to Comarch GL accounts
        </CardDescription>
      </CardHeader>
      <CardContent>
        <Table>
          <TableHeader>
            <TableRow>
              <TableHead>Cost Category</TableHead>
              <TableHead>GL Account Code</TableHead>
              <TableHead>GL Account Name</TableHead>
              <TableHead>Normal Balance</TableHead>
              <TableHead>Actions</TableHead>
            </TableRow>
          </TableHeader>
          <TableBody>
            {mappings?.map(mapping => (
              <TableRow key={mapping.id}>
                <TableCell>{mapping.cost_category}</TableCell>
                <TableCell>{mapping.gl_account_code}</TableCell>
                <TableCell>{mapping.gl_account_name}</TableCell>
                <TableCell><Badge>{mapping.normal_balance}</Badge></TableCell>
                <TableCell>
                  <Button size="sm" variant="ghost" onClick={() => editMapping(mapping)}>Edit</Button>
                </TableCell>
              </TableRow>
            ))}
          </TableBody>
        </Table>
      </CardContent>
    </Card>
  );
}
```

---

## Dependencies

### Required Stories
- **09.6** - WO Cost Summary (work_order_costs data)
- **09.13** - Material Variance (variance data)
- **09.14** - Labor Variance (variance data)
- **09.7** - Inventory Valuation (for inventory export)

---

## Testing Requirements

### Unit Tests
- CSV generation (formatting, encoding)
- XML generation (well-formed, valid)
- Comarch XML schema compliance
- GL account mapping lookup
- Debit/credit balance validation

### Integration Tests
- Export WO costs to CSV, XML, Comarch
- Export variances to Comarch
- GL account mapping CRUD
- Scheduled export execution
- Export audit log creation

### E2E Tests
1. **Export to Comarch Optima**:
   - Configure GL account mappings
   - Export January WO costs
   - Download XML file
   - Validate XML structure
   - (Optional) Import to Comarch test instance

2. **Scheduled Export**:
   - Create weekly export schedule
   - Wait for scheduled run
   - Verify export generated
   - Verify audit log entry created

---

## Performance Requirements

- CSV export: <5 seconds (1000 records)
- XML export: <10 seconds (1000 records)
- Comarch XML export: <15 seconds (1000 records + GL mapping lookups)
- Scheduled export execution: <30 seconds

---

## Security & Permissions

Roles: finance_manager (configure GL mappings, create schedules, export)
Roles: accountant (export only)

---

## Story Metadata

**Estimated Effort:** 4-5 days
**Story Points:** 10
**Priority:** P0 (Phase 3)
**FR Coverage:** FR-9.12.1, FR-9.12.2, FR-9.12.3, FR-9.12.4, FR-9.12.5, FR-9.12.6, FR-9.12.7, FR-FIN-058
**Related Stories:** 09.6 (WO Cost Summary), 09.13 (Material Variance), 09.7 (Inventory Valuation)
