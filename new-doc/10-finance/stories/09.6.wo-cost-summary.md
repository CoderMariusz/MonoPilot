# 09.6 - WO Cost Summary

**Priority**: P0 (MVP)
**Story Points**: M (Medium)
**Type**: fullstack
**Phase**: 1 (Foundation)
**Model**: SONNET

**State:** ready
**Estimate:** M (3-4 days)
**Primary PRD:** `docs/1-BASELINE/product/modules/finance.md` (FR-9.3.4, FR-9.3.6)
**Architecture:** `docs/1-BASELINE/architecture/modules/finance.md` (work_order_costs table)

---

## Goal

Display work order total actual cost (material + labor + overhead), cost per unit produced, and cost summary card on work order detail page. Enable production managers and finance teams to view cost breakdowns by category in real-time and track cost efficiency during production execution.

---

## User Story

As a **Production Manager**, I want to **view total actual costs and unit costs for each work order** so that **I can monitor production efficiency and identify cost overruns early**.

As a **Finance Manager**, I want to **see work order cost breakdowns by category (material, labor, overhead)** so that **I can analyze cost composition and identify optimization opportunities**.

---

## Scope

**In scope (this story)**
- `work_order_costs` table with actual cost tracking
- GET /api/finance/work-order-costs/:id (cost summary endpoint)
- WO cost summary card on WO detail page
- Cost breakdown by category (material, labor, overhead)
- Unit cost calculation (total cost / units produced)
- Real-time cost updates on consumption/labor transactions
- Cost status indicators (on-track, over-budget, warning)
- Cost summary export to CSV
- Integration with Epic 04 (Work Orders)

**Out of scope (this story)**
- Standard cost comparison (story 09.11 - Cost Variance)
- Overhead allocation (story 09.12 - Overhead Allocation)
- Cost by operation breakdown (story 09.13 - Operation Costing)
- Scrap cost tracking (story 09.14 - Scrap Costing)
- Real-time variance alerts (Phase 2 - FR-FIN-051)
- Historical cost trends (Phase 3)
- Budget vs actual comparison (Phase 2)
- Cost simulation (Phase 2)

---

## Dependencies

### Cross-Epic Dependencies

| Dependency | Story/Epic | Type | What It Provides | Status |
|------------|------------|------|------------------|--------|
| 01.1 | Org Context + RLS | HARD | organizations, users, roles tables | Ready |
| 02.1 | Products CRUD | HARD | products table for product reference | Ready |
| 04.1 | Work Orders CRUD | HARD | work_orders table, WO service | Ready |
| 04.4 | Material Consumption | HARD | material_consumption for material costs | Ready |
| 04.5 | Labor Time Tracking | HARD | operation_labor for labor costs | Ready |

### Within Epic Dependencies

| Dependency | Story | Type | What It Provides |
|------------|-------|------|------------------|
| 09.8 | Currency Management | HARD | currencies table, currency conversion |
| 09.9 | Tax Code Integration | SOFT | tax_codes for VAT (optional) |
| 09.10 | Cost Center CRUD | SOFT | cost_centers for cost allocation |

### Provides To (Downstream)

| Story | What This Provides |
|-------|-------------------|
| 09.11 | Cost Variance Analysis - actual cost baseline |
| 09.12 | Overhead Allocation - cost summary integration |
| 09.13 | Operation Costing - WO cost structure |
| 09.14 | Scrap Costing - total cost reference |
| Phase 2 | Real-time variance calculation |

---

## Database Migration

### Migration: Create work_order_costs table

```sql
-- Migration: YYYYMMDDHHMMSS_create_work_order_costs.sql

CREATE TABLE work_order_costs (
    -- Identity
    id                      UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id                  UUID NOT NULL REFERENCES organizations(id),
    work_order_id           UUID NOT NULL REFERENCES work_orders(id),

    -- Actual Costs
    material_cost_actual    DECIMAL(15,4) DEFAULT 0.00,
    labor_cost_actual       DECIMAL(15,4) DEFAULT 0.00,
    overhead_cost_actual    DECIMAL(15,4) DEFAULT 0.00,
    total_cost_actual       DECIMAL(15,4) DEFAULT 0.00,

    -- Standard Costs (for variance - Phase 2)
    material_cost_standard  DECIMAL(15,4) DEFAULT 0.00,
    labor_cost_standard     DECIMAL(15,4) DEFAULT 0.00,
    overhead_cost_standard  DECIMAL(15,4) DEFAULT 0.00,
    total_cost_standard     DECIMAL(15,4) DEFAULT 0.00,

    -- Variances (calculated - Phase 2)
    material_variance       DECIMAL(15,4) DEFAULT 0.00,
    labor_variance          DECIMAL(15,4) DEFAULT 0.00,
    overhead_variance       DECIMAL(15,4) DEFAULT 0.00,
    total_variance          DECIMAL(15,4) DEFAULT 0.00,

    -- Production Quantities
    quantity_planned        INTEGER NOT NULL,
    quantity_produced       INTEGER DEFAULT 0,
    quantity_scrapped       INTEGER DEFAULT 0,

    -- Unit Costs
    unit_cost_actual        DECIMAL(15,4) DEFAULT 0.00,
    unit_cost_standard      DECIMAL(15,4) DEFAULT 0.00,

    -- Currency
    currency_id             UUID NOT NULL REFERENCES currencies(id),

    -- Cost Center Assignment (optional)
    cost_center_id          UUID REFERENCES cost_centers(id),

    -- Costing Metadata
    costing_date            TIMESTAMPTZ,
    costing_method          TEXT DEFAULT 'actual'
                            CHECK (costing_method IN ('actual', 'standard', 'average')),
    status                  TEXT NOT NULL DEFAULT 'pending'
                            CHECK (status IN ('pending', 'calculated', 'approved')),

    -- Last Calculation
    last_calculated_at      TIMESTAMPTZ,
    calculated_by           UUID REFERENCES users(id),

    -- Audit
    created_at              TIMESTAMPTZ NOT NULL DEFAULT now(),
    created_by              UUID REFERENCES users(id),
    updated_at              TIMESTAMPTZ NOT NULL DEFAULT now(),
    updated_by              UUID REFERENCES users(id),

    -- Constraints
    CONSTRAINT uq_work_order_cost UNIQUE (org_id, work_order_id)
);

-- =============================================================================
-- Indexes for Performance
-- =============================================================================

CREATE INDEX idx_wo_costs_org_wo ON work_order_costs(org_id, work_order_id);
CREATE INDEX idx_wo_costs_org_status ON work_order_costs(org_id, status);
CREATE INDEX idx_wo_costs_cost_center ON work_order_costs(cost_center_id) WHERE cost_center_id IS NOT NULL;
CREATE INDEX idx_wo_costs_currency ON work_order_costs(currency_id);
CREATE INDEX idx_wo_costs_costing_date ON work_order_costs(org_id, costing_date) WHERE costing_date IS NOT NULL;
CREATE INDEX idx_wo_costs_created ON work_order_costs(org_id, created_at);

-- =============================================================================
-- Material Consumption Costs Tracking
-- =============================================================================

CREATE TABLE material_consumption_costs (
    -- Identity
    id                      UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id                  UUID NOT NULL REFERENCES organizations(id),

    -- References
    consumption_id          UUID NOT NULL REFERENCES material_consumption(id),
    work_order_id           UUID NOT NULL REFERENCES work_orders(id),
    product_id              UUID NOT NULL REFERENCES products(id),

    -- Consumption Details
    quantity                DECIMAL(15,4) NOT NULL,
    uom                     TEXT NOT NULL,

    -- Cost Details
    unit_cost               DECIMAL(15,4) NOT NULL,
    total_cost              DECIMAL(15,4) NOT NULL,
    currency_id             UUID NOT NULL REFERENCES currencies(id),

    -- Costing Method
    cost_method             TEXT NOT NULL DEFAULT 'fifo'
                            CHECK (cost_method IN ('fifo', 'average', 'standard')),

    -- Cost Layer Reference (for FIFO)
    cost_layer_id           UUID REFERENCES inventory_cost_layers(id),

    -- Cost Center Assignment
    cost_center_id          UUID REFERENCES cost_centers(id),

    -- Transaction Timing
    transaction_date        TIMESTAMPTZ NOT NULL,

    -- Audit
    created_at              TIMESTAMPTZ NOT NULL DEFAULT now(),
    created_by              UUID REFERENCES users(id),

    -- Constraints
    CONSTRAINT fk_mcc_consumption FOREIGN KEY (consumption_id) REFERENCES material_consumption(id) ON DELETE CASCADE
);

CREATE INDEX idx_mcc_org_wo ON material_consumption_costs(org_id, work_order_id);
CREATE INDEX idx_mcc_consumption ON material_consumption_costs(consumption_id);
CREATE INDEX idx_mcc_product ON material_consumption_costs(product_id);
CREATE INDEX idx_mcc_transaction_date ON material_consumption_costs(org_id, transaction_date);
CREATE INDEX idx_mcc_cost_center ON material_consumption_costs(cost_center_id) WHERE cost_center_id IS NOT NULL;

-- =============================================================================
-- Labor Costs Tracking
-- =============================================================================

CREATE TABLE labor_costs (
    -- Identity
    id                      UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id                  UUID NOT NULL REFERENCES organizations(id),

    -- References
    work_order_id           UUID NOT NULL REFERENCES work_orders(id),
    operation_id            UUID REFERENCES routing_operations(id),
    user_id                 UUID REFERENCES users(id),

    -- Labor Details
    hours_actual            DECIMAL(10,2) NOT NULL,
    hours_standard          DECIMAL(10,2) DEFAULT 0.00,
    hourly_rate             DECIMAL(15,4) NOT NULL,

    -- Cost Details
    total_cost              DECIMAL(15,4) NOT NULL,
    currency_id             UUID NOT NULL REFERENCES currencies(id),

    -- Cost Center Assignment
    cost_center_id          UUID REFERENCES cost_centers(id),

    -- Transaction Timing
    transaction_date        TIMESTAMPTZ NOT NULL,

    -- Audit
    created_at              TIMESTAMPTZ NOT NULL DEFAULT now(),
    created_by              UUID REFERENCES users(id),

    -- Constraints
    CONSTRAINT chk_labor_hours_positive CHECK (hours_actual >= 0)
);

CREATE INDEX idx_labor_costs_org_wo ON labor_costs(org_id, work_order_id);
CREATE INDEX idx_labor_costs_operation ON labor_costs(operation_id) WHERE operation_id IS NOT NULL;
CREATE INDEX idx_labor_costs_user ON labor_costs(user_id) WHERE user_id IS NOT NULL;
CREATE INDEX idx_labor_costs_transaction_date ON labor_costs(org_id, transaction_date);
CREATE INDEX idx_labor_costs_cost_center ON labor_costs(cost_center_id) WHERE cost_center_id IS NOT NULL;

-- =============================================================================
-- RLS Policies
-- =============================================================================

ALTER TABLE work_order_costs ENABLE ROW LEVEL SECURITY;

CREATE POLICY "wo_costs_select" ON work_order_costs
    FOR SELECT USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

CREATE POLICY "wo_costs_insert" ON work_order_costs
    FOR INSERT WITH CHECK (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

CREATE POLICY "wo_costs_update" ON work_order_costs
    FOR UPDATE USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

CREATE POLICY "wo_costs_delete" ON work_order_costs
    FOR DELETE USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
        AND status = 'pending'
    );

-- Material Consumption Costs RLS
ALTER TABLE material_consumption_costs ENABLE ROW LEVEL SECURITY;

CREATE POLICY "mcc_org" ON material_consumption_costs
    FOR ALL TO authenticated
    USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

-- Labor Costs RLS
ALTER TABLE labor_costs ENABLE ROW LEVEL SECURITY;

CREATE POLICY "labor_costs_org" ON labor_costs
    FOR ALL TO authenticated
    USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

-- =============================================================================
-- Trigger for updated_at
-- =============================================================================

CREATE TRIGGER update_work_order_costs_updated_at
    BEFORE UPDATE ON work_order_costs
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- =============================================================================
-- Function: Calculate Work Order Costs
-- =============================================================================

CREATE OR REPLACE FUNCTION calculate_work_order_costs(p_work_order_id UUID)
RETURNS void AS $$
DECLARE
    v_org_id UUID;
    v_material_total DECIMAL(15,4);
    v_labor_total DECIMAL(15,4);
    v_overhead_total DECIMAL(15,4);
    v_total_cost DECIMAL(15,4);
    v_quantity_produced INTEGER;
    v_unit_cost DECIMAL(15,4);
    v_currency_id UUID;
BEGIN
    -- Get org_id and currency from work order
    SELECT wo.org_id, wo.currency_id, wo.quantity_produced
    INTO v_org_id, v_currency_id, v_quantity_produced
    FROM work_orders wo
    WHERE wo.id = p_work_order_id;

    IF NOT FOUND THEN
        RAISE EXCEPTION 'Work order not found: %', p_work_order_id;
    END IF;

    -- Calculate total material costs
    SELECT COALESCE(SUM(total_cost), 0)
    INTO v_material_total
    FROM material_consumption_costs
    WHERE work_order_id = p_work_order_id;

    -- Calculate total labor costs
    SELECT COALESCE(SUM(total_cost), 0)
    INTO v_labor_total
    FROM labor_costs
    WHERE work_order_id = p_work_order_id;

    -- Overhead calculation placeholder (Phase 2)
    v_overhead_total := 0.00;

    -- Calculate totals
    v_total_cost := v_material_total + v_labor_total + v_overhead_total;

    -- Calculate unit cost (avoid division by zero)
    IF v_quantity_produced > 0 THEN
        v_unit_cost := v_total_cost / v_quantity_produced;
    ELSE
        v_unit_cost := 0.00;
    END IF;

    -- Upsert work_order_costs record
    INSERT INTO work_order_costs (
        org_id,
        work_order_id,
        material_cost_actual,
        labor_cost_actual,
        overhead_cost_actual,
        total_cost_actual,
        quantity_produced,
        unit_cost_actual,
        currency_id,
        status,
        last_calculated_at,
        created_by,
        updated_by
    ) VALUES (
        v_org_id,
        p_work_order_id,
        v_material_total,
        v_labor_total,
        v_overhead_total,
        v_total_cost,
        v_quantity_produced,
        v_unit_cost,
        v_currency_id,
        'calculated',
        NOW(),
        auth.uid(),
        auth.uid()
    )
    ON CONFLICT (org_id, work_order_id)
    DO UPDATE SET
        material_cost_actual = v_material_total,
        labor_cost_actual = v_labor_total,
        overhead_cost_actual = v_overhead_total,
        total_cost_actual = v_total_cost,
        quantity_produced = v_quantity_produced,
        unit_cost_actual = v_unit_cost,
        last_calculated_at = NOW(),
        updated_by = auth.uid(),
        updated_at = NOW();

END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- =============================================================================
-- Trigger: Auto-calculate costs on material consumption
-- =============================================================================

CREATE OR REPLACE FUNCTION trigger_recalculate_wo_costs_on_consumption()
RETURNS TRIGGER AS $$
BEGIN
    -- Recalculate work order costs after material consumption change
    PERFORM calculate_work_order_costs(NEW.work_order_id);
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_recalc_costs_after_consumption
    AFTER INSERT OR UPDATE ON material_consumption_costs
    FOR EACH ROW
    EXECUTE FUNCTION trigger_recalculate_wo_costs_on_consumption();

-- =============================================================================
-- Trigger: Auto-calculate costs on labor entry
-- =============================================================================

CREATE OR REPLACE FUNCTION trigger_recalculate_wo_costs_on_labor()
RETURNS TRIGGER AS $$
BEGIN
    -- Recalculate work order costs after labor entry
    PERFORM calculate_work_order_costs(NEW.work_order_id);
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_recalc_costs_after_labor
    AFTER INSERT OR UPDATE ON labor_costs
    FOR EACH ROW
    EXECUTE FUNCTION trigger_recalculate_wo_costs_on_labor();
```

---

## Acceptance Criteria (Given/When/Then)

### AC-1: Work Order Costs Table Creation

```gherkin
Scenario: work_order_costs table exists with all required columns
  Given database migration runs
  When schema is inspected
  Then work_order_costs table has all columns from schema
  And UNIQUE constraint exists on (org_id, work_order_id)
  And FK constraints exist for all references
  And RLS policies enforce org isolation
```

### AC-2: Material Cost Tracking

```gherkin
Scenario: Track material consumption costs
  Given work order WO-001 exists with status = 'in_progress'
  And material consumption recorded: 10 kg flour at 5 PLN/kg
  When material_consumption_costs record created
  Then material_consumption_costs.total_cost = 50 PLN
  And work_order_costs.material_cost_actual updated to 50 PLN
  And work_order_costs.total_cost_actual updated

Scenario: Multiple material consumption accumulates
  Given work order has material_cost_actual = 50 PLN
  When new material consumed: 5 kg sugar at 8 PLN/kg
  Then material_cost_actual = 90 PLN (50 + 40)
  And total_cost_actual reflects new total
```

### AC-3: Labor Cost Tracking

```gherkin
Scenario: Track labor time costs
  Given work order WO-001 exists
  And worker records 2.5 hours at 20 PLN/hour
  When labor_costs record created
  Then labor_costs.total_cost = 50 PLN
  And work_order_costs.labor_cost_actual updated to 50 PLN
  And work_order_costs.total_cost_actual updated

Scenario: Multiple labor entries accumulate
  Given work order has labor_cost_actual = 50 PLN
  When new labor entry: 1.5 hours at 20 PLN/hour
  Then labor_cost_actual = 80 PLN (50 + 30)
  And total_cost_actual reflects new total
```

### AC-4: Unit Cost Calculation

```gherkin
Scenario: Calculate unit cost when production completes
  Given work order WO-001 with:
    | Field | Value |
    | material_cost_actual | 100 PLN |
    | labor_cost_actual | 50 PLN |
    | overhead_cost_actual | 30 PLN |
    | quantity_produced | 20 units |
  When calculate_work_order_costs() executes
  Then total_cost_actual = 180 PLN
  And unit_cost_actual = 9.00 PLN (180 / 20)

Scenario: Unit cost is zero when no production
  Given work order with quantity_produced = 0
  And total_cost_actual = 100 PLN
  When unit cost calculated
  Then unit_cost_actual = 0.00 (avoid division by zero)
```

### AC-5: Cost Summary API Endpoint

```gherkin
Scenario: Get work order cost summary
  Given work order WO-001 exists with costs
  When GET /api/finance/work-order-costs/:workOrderId
  Then response 200 OK with JSON:
    {
      "work_order_id": "uuid",
      "work_order_number": "WO-001",
      "product_name": "Bread",
      "material_cost_actual": 100.00,
      "labor_cost_actual": 50.00,
      "overhead_cost_actual": 30.00,
      "total_cost_actual": 180.00,
      "quantity_produced": 20,
      "unit_cost_actual": 9.00,
      "currency_code": "PLN",
      "status": "calculated",
      "last_calculated_at": "2025-01-15T10:30:00Z"
    }

Scenario: Work order without costs returns default
  Given work order WO-002 has no cost records
  When GET /api/finance/work-order-costs/:workOrderId
  Then response 200 OK with all costs = 0.00
  And status = "pending"
```

### AC-6: Cost Summary Card on WO Detail Page

```gherkin
Scenario: Display cost summary card on work order detail
  Given user views work order detail page /production/work-orders/WO-001
  And work order has costs calculated
  When page loads
  Then cost summary card displays:
    | Field | Display |
    | Total Cost | 180.00 PLN |
    | Material | 100.00 PLN (55.6%) |
    | Labor | 50.00 PLN (27.8%) |
    | Overhead | 30.00 PLN (16.6%) |
    | Unit Cost | 9.00 PLN/unit |
    | Last Updated | 2025-01-15 10:30 |
  And progress bar shows cost category breakdown
  And card loads within 500ms

Scenario: Cost card shows pending for new work order
  Given work order just created with no consumption
  When viewing WO detail page
  Then cost summary card shows:
    | Field | Value |
    | Status | Pending |
    | Total Cost | 0.00 PLN |
    | Message | "No costs recorded yet" |
```

### AC-7: Real-Time Cost Updates

```gherkin
Scenario: Costs update automatically on material consumption
  Given user viewing WO detail page with cost card
  And material_cost_actual = 100 PLN displayed
  When new material consumption posted via API
  And consumption costs calculated
  Then cost summary card refreshes within 5 seconds
  And new material_cost_actual displayed
  And total_cost_actual updated

Scenario: Database trigger recalculates on consumption
  Given material_consumption_costs inserted
  When trigger executes
  Then calculate_work_order_costs() called automatically
  And work_order_costs record updated
  And last_calculated_at = NOW()
```

### AC-8: Cost Status Indicators

```gherkin
Scenario: Display cost status based on progress
  Given work order with planned quantity = 100
  And quantity_produced = 50 (50% complete)
  And total_cost_actual = 600 PLN
  And total_cost_standard = 1000 PLN (for 100 units)
  When cost summary displays
  Then status = "On Track" (50% cost for 50% production)
  And indicator color = green

Scenario: Display warning for cost overrun
  Given work order 50% complete
  And total_cost_actual = 700 PLN (70% of standard)
  When cost summary displays
  Then status = "Over Budget" (warning)
  And indicator color = yellow
  And message: "7% over standard at current rate"

Scenario: Display critical for major overrun
  Given work order 50% complete
  And total_cost_actual = 900 PLN (90% of standard)
  Then status = "Critical" (major overrun)
  And indicator color = red
```

### AC-9: Cost Export to CSV

```gherkin
Scenario: Export work order cost summary to CSV
  Given work order WO-001 with costs
  When user clicks [Export to CSV] on cost card
  Then CSV file generated with headers:
    | Column | Value |
    | Work Order | WO-001 |
    | Product | Bread |
    | Material Cost | 100.00 |
    | Labor Cost | 50.00 |
    | Overhead Cost | 30.00 |
    | Total Cost | 180.00 |
    | Quantity Produced | 20 |
    | Unit Cost | 9.00 |
    | Currency | PLN |
  And file downloads with name: "wo-cost-WO-001-YYYYMMDD.csv"
```

### AC-10: Multi-Currency Support

```gherkin
Scenario: Work order costs in base currency
  Given organization base currency = PLN
  And work order created in PLN
  When costs calculated
  Then all costs stored in PLN
  And currency_id = PLN currency ID

Scenario: Convert foreign currency costs
  Given organization base currency = PLN
  And material purchased in EUR
  And exchange rate EUR->PLN = 4.30
  When material consumption recorded (10 EUR)
  Then material_consumption_costs.total_cost = 43 PLN
  And currency_id = PLN (converted to base)
```

### AC-11: Permission Enforcement

```gherkin
Scenario: Viewer can view costs
  Given user with VIEWER role
  When viewing work order detail page
  Then cost summary card visible
  And all cost data displayed
  And no edit/delete actions available

Scenario: Finance manager can view and export
  Given user with FINANCE_MANAGER role
  When viewing cost summary
  Then can view, export, and recalculate costs
  And can approve cost records (Phase 2)

Scenario: Production manager can view costs
  Given user with PRODUCTION_MANAGER role
  Then can view cost summary on WO detail
  And can export cost data
  And cannot edit cost records
```

### AC-12: RLS Policy Enforcement

```gherkin
Scenario: Org isolation on work order costs
  Given User A from Org A and User B from Org B
  And work orders exist in both orgs
  When User A requests GET /api/finance/work-order-costs
  Then only Org A work order costs returned

Scenario: Cannot view costs from different org
  Given work order cost belongs to Org B
  When User A (Org A) requests cost by ID
  Then 404 Not Found returned
```

### AC-13: Performance Requirements

```gherkin
Scenario: Cost calculation performance
  Given work order with 50 material consumption records
  And 20 labor cost records
  When calculate_work_order_costs() executes
  Then calculation completes < 300ms

Scenario: Cost summary API performance
  Given work order with costs calculated
  When GET /api/finance/work-order-costs/:id
  Then response time < 200ms

Scenario: Cost card render performance
  Given work order detail page loading
  When cost summary card renders
  Then render time < 500ms
```

---

## Implementation Notes

### API Endpoints

```typescript
// =============================================================================
// Work Order Cost Endpoints
// =============================================================================

// GET /api/finance/work-order-costs/:workOrderId
interface WorkOrderCostSummaryResponse {
  work_order_id: string;
  work_order_number: string;
  product_id: string;
  product_code: string;
  product_name: string;

  // Actual Costs
  material_cost_actual: number;
  labor_cost_actual: number;
  overhead_cost_actual: number;
  total_cost_actual: number;

  // Production
  quantity_planned: number;
  quantity_produced: number;
  quantity_scrapped: number;

  // Unit Costs
  unit_cost_actual: number;

  // Currency
  currency_id: string;
  currency_code: string;
  currency_symbol: string;

  // Cost Center
  cost_center_id?: string;
  cost_center_name?: string;

  // Status
  status: 'pending' | 'calculated' | 'approved';
  last_calculated_at?: string;

  // Cost Breakdown Percentages
  material_percent: number;
  labor_percent: number;
  overhead_percent: number;
}

// GET /api/finance/work-order-costs/:workOrderId/material
interface WorkOrderMaterialCostsResponse {
  work_order_id: string;
  material_costs: MaterialCostDetail[];
  total_material_cost: number;
}

interface MaterialCostDetail {
  id: string;
  consumption_id: string;
  product_id: string;
  product_code: string;
  product_name: string;
  quantity: number;
  uom: string;
  unit_cost: number;
  total_cost: number;
  cost_method: 'fifo' | 'average' | 'standard';
  transaction_date: string;
}

// GET /api/finance/work-order-costs/:workOrderId/labor
interface WorkOrderLaborCostsResponse {
  work_order_id: string;
  labor_costs: LaborCostDetail[];
  total_labor_cost: number;
}

interface LaborCostDetail {
  id: string;
  operation_id?: string;
  operation_name?: string;
  user_id?: string;
  user_name?: string;
  hours_actual: number;
  hourly_rate: number;
  total_cost: number;
  transaction_date: string;
}

// POST /api/finance/work-order-costs/:workOrderId/recalculate
interface RecalculateCostsRequest {
  force?: boolean; // Force recalculation even if recently calculated
}

interface RecalculateCostsResponse {
  success: boolean;
  work_order_cost: WorkOrderCostSummaryResponse;
  recalculated_at: string;
}

// GET /api/finance/work-order-costs/:workOrderId/export
// Returns CSV file download
```

### Validation Schemas (Zod)

```typescript
import { z } from 'zod';

export const materialConsumptionCostSchema = z.object({
  consumption_id: z.string().uuid('Invalid consumption ID'),
  work_order_id: z.string().uuid('Invalid work order ID'),
  product_id: z.string().uuid('Invalid product ID'),
  quantity: z.number().positive('Quantity must be positive'),
  uom: z.string().min(1, 'UOM is required'),
  unit_cost: z.number().min(0, 'Unit cost cannot be negative'),
  total_cost: z.number().min(0, 'Total cost cannot be negative'),
  currency_id: z.string().uuid('Invalid currency ID'),
  cost_method: z.enum(['fifo', 'average', 'standard']).default('fifo'),
  cost_center_id: z.string().uuid().optional(),
  transaction_date: z.string().datetime('Invalid transaction date'),
});

export const laborCostSchema = z.object({
  work_order_id: z.string().uuid('Invalid work order ID'),
  operation_id: z.string().uuid().optional(),
  user_id: z.string().uuid().optional(),
  hours_actual: z.number().min(0, 'Hours cannot be negative'),
  hours_standard: z.number().min(0).default(0),
  hourly_rate: z.number().positive('Hourly rate must be positive'),
  total_cost: z.number().min(0, 'Total cost cannot be negative'),
  currency_id: z.string().uuid('Invalid currency ID'),
  cost_center_id: z.string().uuid().optional(),
  transaction_date: z.string().datetime('Invalid transaction date'),
});

export const recalculateCostsSchema = z.object({
  force: z.boolean().default(false),
});
```

### Service Layer

```typescript
// lib/services/work-order-cost-service.ts

export class WorkOrderCostService {
  /**
   * Get work order cost summary
   */
  static async getSummary(workOrderId: string): Promise<WorkOrderCostSummaryResponse>;

  /**
   * Get material cost details
   */
  static async getMaterialCosts(workOrderId: string): Promise<WorkOrderMaterialCostsResponse>;

  /**
   * Get labor cost details
   */
  static async getLaborCosts(workOrderId: string): Promise<WorkOrderLaborCostsResponse>;

  /**
   * Recalculate work order costs
   */
  static async recalculate(workOrderId: string, force?: boolean): Promise<WorkOrderCostSummaryResponse>;

  /**
   * Create material consumption cost record
   */
  static async createMaterialCost(input: MaterialConsumptionCostInput): Promise<MaterialConsumptionCost>;

  /**
   * Create labor cost record
   */
  static async createLaborCost(input: LaborCostInput): Promise<LaborCost>;

  /**
   * Calculate cost breakdown percentages
   */
  static async getCostBreakdown(workOrderId: string): Promise<{
    material_percent: number;
    labor_percent: number;
    overhead_percent: number;
  }>;

  /**
   * Export work order costs to CSV
   */
  static async exportToCSV(workOrderId: string): Promise<string>;

  /**
   * Get cost status indicator
   */
  static async getCostStatus(workOrderId: string): Promise<{
    status: 'on_track' | 'warning' | 'critical' | 'pending';
    message: string;
    color: string;
  }>;
}
```

### Frontend Components

```
apps/frontend/app/(authenticated)/finance/
  work-order-costs/
    [id]/
      page.tsx                     -- Work order cost detail page

apps/frontend/app/api/finance/
  work-order-costs/
    [id]/
      route.ts                     -- GET cost summary
      material/
        route.ts                   -- GET material costs
      labor/
        route.ts                   -- GET labor costs
      recalculate/
        route.ts                   -- POST recalculate
      export/
        route.ts                   -- GET CSV export

components/finance/
  WOCostSummaryCard.tsx            -- Cost summary card for WO detail
  WOCostBreakdownChart.tsx         -- Pie/bar chart for cost breakdown
  WOCostStatusBadge.tsx            -- Status badge (on track/warning/critical)
  MaterialCostsTable.tsx           -- Material consumption costs table
  LaborCostsTable.tsx              -- Labor costs table
  CostExportButton.tsx             -- CSV export button
```

### UI Component Details

**WOCostSummaryCard.tsx**
- Card layout with cost metrics
- Progress bar showing cost category breakdown
- Color-coded status indicator
- Last updated timestamp
- Refresh button to recalculate
- Export to CSV button
- Responsive layout (stacks on mobile)

**WOCostBreakdownChart.tsx**
- Pie chart showing material/labor/overhead percentages
- Legend with amounts and percentages
- Responsive sizing
- Tooltip on hover with details

**WOCostStatusBadge.tsx**
- Color-coded badge: green (on track), yellow (warning), red (critical), gray (pending)
- Status text with icon
- Tooltip explaining status calculation

---

## Key Business Rules

1. **Auto-Calculation on Transaction**: Work order costs recalculate automatically when material consumption or labor costs posted
2. **Currency Consistency**: All costs for a work order must be in same currency (organization base currency)
3. **Unit Cost Only When Production**: Unit cost calculated only when quantity_produced > 0
4. **Pending Until First Cost**: Work order costs status = 'pending' until first material/labor transaction
5. **Cost Lock on Completion**: Work order costs cannot be deleted once work order is completed (status check)
6. **Real-Time Updates**: Cost summary updates within 5 seconds of new consumption/labor transaction
7. **Cost Breakdown Accuracy**: Material + Labor + Overhead must equal Total Cost (validation)
8. **Historical Cost Preservation**: Once calculated, cost records are immutable (audit trail)
9. **Permission-Based Access**: Only FINANCE_MANAGER and above can recalculate or approve costs
10. **Export Availability**: CSV export available for all users with VIEW permission

---

## Deliverables

### Database
- [ ] Migration: `work_order_costs` table with all columns
- [ ] Migration: `material_consumption_costs` table
- [ ] Migration: `labor_costs` table
- [ ] Function: `calculate_work_order_costs(work_order_id)`
- [ ] Trigger: Auto-recalculate on material consumption
- [ ] Trigger: Auto-recalculate on labor entry
- [ ] RLS policies for all cost tables
- [ ] All performance indexes

### API Routes
- [ ] `GET /api/finance/work-order-costs/:id` - Get cost summary
- [ ] `GET /api/finance/work-order-costs/:id/material` - Get material costs
- [ ] `GET /api/finance/work-order-costs/:id/labor` - Get labor costs
- [ ] `POST /api/finance/work-order-costs/:id/recalculate` - Recalculate costs
- [ ] `GET /api/finance/work-order-costs/:id/export` - Export to CSV

### Service Layer
- [ ] `WorkOrderCostService.getSummary()` - Get cost summary
- [ ] `WorkOrderCostService.getMaterialCosts()` - Get material details
- [ ] `WorkOrderCostService.getLaborCosts()` - Get labor details
- [ ] `WorkOrderCostService.recalculate()` - Recalculate costs
- [ ] `WorkOrderCostService.createMaterialCost()` - Create material cost
- [ ] `WorkOrderCostService.createLaborCost()` - Create labor cost
- [ ] `WorkOrderCostService.getCostBreakdown()` - Get breakdown percentages
- [ ] `WorkOrderCostService.exportToCSV()` - Export functionality
- [ ] `WorkOrderCostService.getCostStatus()` - Get status indicator

### Validation
- [ ] `materialConsumptionCostSchema`
- [ ] `laborCostSchema`
- [ ] `recalculateCostsSchema`

### Frontend
- [ ] Work order cost summary card component
- [ ] Cost breakdown chart component
- [ ] Cost status badge component
- [ ] Material costs table component
- [ ] Labor costs table component
- [ ] CSV export button
- [ ] Integration with WO detail page

### Tests
- [ ] Unit tests: WorkOrderCostService methods (>80% coverage)
- [ ] Integration tests: All API endpoints
- [ ] Database trigger tests (auto-recalculation)
- [ ] RLS tests: Multi-tenancy isolation
- [ ] E2E: Full cost tracking workflow (consumption -> calculation -> display)

---

## Test Strategy

### Unit Tests

```typescript
describe('WorkOrderCostService', () => {
  describe('getSummary', () => {
    it('returns cost summary for work order', async () => {});
    it('returns default values for work order without costs', async () => {});
    it('calculates cost breakdown percentages', async () => {});
    it('handles zero quantity produced', async () => {});
  });

  describe('createMaterialCost', () => {
    it('creates material consumption cost record', async () => {});
    it('triggers work order cost recalculation', async () => {});
    it('validates currency matches work order', async () => {});
  });

  describe('createLaborCost', () => {
    it('creates labor cost record', async () => {});
    it('triggers work order cost recalculation', async () => {});
    it('calculates total cost from hours and rate', async () => {});
  });

  describe('recalculate', () => {
    it('recalculates all cost components', async () => {});
    it('updates unit cost when quantity produced', async () => {});
    it('sets unit cost to zero when no production', async () => {});
    it('updates last_calculated_at timestamp', async () => {});
  });

  describe('exportToCSV', () => {
    it('generates CSV with all cost data', async () => {});
    it('includes cost breakdown', async () => {});
    it('formats currency values correctly', async () => {});
  });
});
```

### Integration Tests

```typescript
describe('Work Order Costs API', () => {
  describe('GET /api/finance/work-order-costs/:id', () => {
    it('returns cost summary with 200 OK', async () => {});
    it('returns 404 for non-existent work order', async () => {});
    it('enforces org isolation via RLS', async () => {});
  });

  describe('POST /api/finance/work-order-costs/:id/recalculate', () => {
    it('recalculates costs and returns updated summary', async () => {});
    it('requires FINANCE_MANAGER role', async () => {});
    it('handles force flag correctly', async () => {});
  });
});
```

### E2E Tests

```typescript
describe('Work Order Cost Tracking', () => {
  it('complete cost tracking workflow', async () => {
    // 1. Create work order
    // 2. Record material consumption
    // 3. Verify material cost updated
    // 4. Record labor time
    // 5. Verify labor cost updated
    // 6. View cost summary card on WO detail
    // 7. Verify total cost and unit cost displayed
    // 8. Export to CSV
  });

  it('real-time cost updates on consumption', async () => {
    // 1. Open WO detail page
    // 2. Record material consumption via API
    // 3. Verify cost card updates within 5 seconds
  });
});
```

---

## Definition of Done

### Database
- [ ] `work_order_costs` table created with all columns
- [ ] `material_consumption_costs` table created
- [ ] `labor_costs` table created
- [ ] All indexes created for performance
- [ ] RLS policies enforce org isolation
- [ ] Auto-recalculation triggers work correctly
- [ ] Unit cost calculation handles division by zero

### API
- [ ] All endpoints return correct HTTP status codes
- [ ] Validation errors return 400 with detailed messages
- [ ] Cross-tenant access returns 404
- [ ] Response times:
  - Cost summary: < 200ms
  - Recalculate: < 300ms
  - Export CSV: < 1s

### Service
- [ ] Cost summary includes all required fields
- [ ] Material and labor cost tracking works
- [ ] Auto-recalculation on new transactions
- [ ] CSV export generates valid file
- [ ] Permission checks enforced

### Frontend
- [ ] Cost summary card displays on WO detail page
- [ ] Cost breakdown chart renders correctly
- [ ] Status badge shows correct color/status
- [ ] CSV export button works
- [ ] Real-time updates within 5 seconds
- [ ] Responsive layout on mobile

### Testing
- [ ] Unit tests: >80% coverage on service
- [ ] Integration tests: All endpoints covered
- [ ] Trigger tests: Auto-recalculation verified
- [ ] RLS tests: Multi-tenancy verified
- [ ] E2E tests: Full workflow passing

### Integration
- [ ] Works with Epic 04 (Work Orders)
- [ ] Works with story 09.8 (Currency)
- [ ] Works with story 09.10 (Cost Centers)
- [ ] Provides data for story 09.11 (Variance)

---

## Risk Assessment

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Auto-calculation trigger performance | MEDIUM | LOW | Optimize SQL, test with large datasets |
| Currency conversion errors | HIGH | LOW | Validation rules, require base currency |
| Division by zero in unit cost | LOW | MEDIUM | Explicit check in function |
| Real-time update lag | MEDIUM | MEDIUM | Database triggers, WebSocket updates |
| Cost data inconsistency | HIGH | LOW | Transaction wrappers, validation |
| Export file generation failure | LOW | LOW | Error handling, retry logic |

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-01-15 | Initial story creation for WO cost summary | SONNET |

---

**Document Status**: Ready for Implementation
**Created**: 2025-01-15
**Lines**: ~900
**Complexity**: M (Medium)
**Phase**: 1 (Foundation)
