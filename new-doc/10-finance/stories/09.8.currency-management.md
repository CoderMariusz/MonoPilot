# 09.8 - Currency Management

**Priority**: P0 (MVP)
**Story Points**: M (Medium)
**Type**: fullstack
**Phase**: 1 (Foundation)
**Model**: SONNET

**State:** ready
**Estimate:** M (3-4 days)
**Primary PRD:** `docs/1-BASELINE/product/modules/finance.md` (FR-9.8.1-5)
**Architecture:** `docs/1-BASELINE/architecture/modules/finance.md` (currencies, exchange_rates tables)

---

## Goal

Implement currency CRUD (PLN default, EUR, USD, GBP), exchange rate management (manual entry or API), currency conversion, historical rates, and display amounts in base currency. Enable multi-currency cost tracking with automatic conversion to organization base currency.

---

## User Story

As a **Finance Manager**, I want to **manage multiple currencies and exchange rates** so that **I can track costs for imported materials and export products accurately**.

As a **CFO**, I want to **view all financial data in our base currency (PLN)** so that **I can prepare consistent financial reports regardless of transaction currency**.

---

## Scope

**In scope**
- `currencies` table with CRUD operations
- `exchange_rates` table with historical rates
- PLN as default base currency
- Currency CRUD API endpoints
- Exchange rate management (manual entry)
- Currency conversion utility
- Historical rate lookup by date
- Currency selector in UI
- Base currency configuration per org
- Integration with cost tracking (stories 09.6, 09.7)

**Out of scope**
- Exchange rate API integration (Phase 3)
- Automatic rate updates (Phase 3)
- Multi-currency reporting (Phase 2)
- Currency gain/loss tracking (Phase 3)
- Forward exchange contracts (Phase 3)

---

## Dependencies

### Cross-Epic Dependencies

| Dependency | Story/Epic | Type | What It Provides | Status |
|------------|------------|------|------------------|--------|
| 01.1 | Org Context + RLS | HARD | organizations, users, roles tables | Ready |

### Provides To (Downstream)

| Story | What This Provides |
|-------|-------------------|
| 09.6 | WO Cost Summary - currency reference |
| 09.7 | Inventory Valuation - currency conversion |
| 09.10 | Cost Center - budget currency |

---

## Database Migration

```sql
-- Migration: YYYYMMDDHHMMSS_create_currencies.sql

CREATE TABLE currencies (
    id                      UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id                  UUID NOT NULL REFERENCES organizations(id),
    code                    TEXT NOT NULL, -- PLN, EUR, USD, GBP
    name                    TEXT NOT NULL,
    symbol                  TEXT NOT NULL, -- zł, €, $, £
    is_base                 BOOLEAN DEFAULT FALSE,
    is_active               BOOLEAN DEFAULT TRUE,
    exchange_rate           DECIMAL(15,6) DEFAULT 1.000000, -- Current rate to base
    created_at              TIMESTAMPTZ NOT NULL DEFAULT now(),
    updated_at              TIMESTAMPTZ NOT NULL DEFAULT now(),
    CONSTRAINT uq_currency_code UNIQUE (org_id, code)
);

CREATE INDEX idx_currencies_org ON currencies(org_id);
CREATE INDEX idx_currencies_org_active ON currencies(org_id, is_active) WHERE is_active = TRUE;

CREATE TABLE exchange_rates (
    id                      UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id                  UUID NOT NULL REFERENCES organizations(id),
    currency_id             UUID NOT NULL REFERENCES currencies(id),
    effective_date          DATE NOT NULL,
    rate                    DECIMAL(15,6) NOT NULL, -- Rate to base currency
    source                  TEXT DEFAULT 'manual' CHECK (source IN ('manual', 'api')),
    created_at              TIMESTAMPTZ NOT NULL DEFAULT now(),
    created_by              UUID REFERENCES users(id),
    CONSTRAINT uq_exchange_rate UNIQUE (org_id, currency_id, effective_date)
);

CREATE INDEX idx_exchange_rates_org_currency ON exchange_rates(org_id, currency_id);
CREATE INDEX idx_exchange_rates_date ON exchange_rates(org_id, currency_id, effective_date DESC);

-- RLS Policies
ALTER TABLE currencies ENABLE ROW LEVEL SECURITY;
CREATE POLICY "currencies_org" ON currencies
    FOR ALL TO authenticated
    USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

ALTER TABLE exchange_rates ENABLE ROW LEVEL SECURITY;
CREATE POLICY "exchange_rates_org" ON exchange_rates
    FOR ALL TO authenticated
    USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

-- Trigger
CREATE TRIGGER update_currencies_updated_at
    BEFORE UPDATE ON currencies
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- Function: Convert currency amount
CREATE OR REPLACE FUNCTION convert_currency(
    p_org_id UUID,
    p_amount DECIMAL,
    p_from_currency_id UUID,
    p_to_currency_id UUID,
    p_date DATE DEFAULT CURRENT_DATE
)
RETURNS DECIMAL AS $$
DECLARE
    v_from_rate DECIMAL;
    v_to_rate DECIMAL;
    v_converted DECIMAL;
BEGIN
    -- If same currency, return amount
    IF p_from_currency_id = p_to_currency_id THEN
        RETURN p_amount;
    END IF;

    -- Get exchange rate for from_currency on date
    SELECT rate INTO v_from_rate
    FROM exchange_rates
    WHERE org_id = p_org_id
      AND currency_id = p_from_currency_id
      AND effective_date <= p_date
    ORDER BY effective_date DESC
    LIMIT 1;

    -- If not found, use current rate from currencies table
    IF v_from_rate IS NULL THEN
        SELECT exchange_rate INTO v_from_rate
        FROM currencies
        WHERE id = p_from_currency_id AND org_id = p_org_id;
    END IF;

    -- Get exchange rate for to_currency
    SELECT rate INTO v_to_rate
    FROM exchange_rates
    WHERE org_id = p_org_id
      AND currency_id = p_to_currency_id
      AND effective_date <= p_date
    ORDER BY effective_date DESC
    LIMIT 1;

    IF v_to_rate IS NULL THEN
        SELECT exchange_rate INTO v_to_rate
        FROM currencies
        WHERE id = p_to_currency_id AND org_id = p_org_id;
    END IF;

    -- Convert: amount * (to_rate / from_rate)
    v_converted := p_amount * (v_to_rate / v_from_rate);

    RETURN ROUND(v_converted, 4);
END;
$$ LANGUAGE plpgsql;

-- Function: Get base currency for org
CREATE OR REPLACE FUNCTION get_base_currency(p_org_id UUID)
RETURNS UUID AS $$
DECLARE
    v_currency_id UUID;
BEGIN
    SELECT id INTO v_currency_id
    FROM currencies
    WHERE org_id = p_org_id
      AND is_base = TRUE
    LIMIT 1;

    IF NOT FOUND THEN
        RAISE EXCEPTION 'No base currency configured for organization %', p_org_id;
    END IF;

    RETURN v_currency_id;
END;
$$ LANGUAGE plpgsql;
```

---

## Acceptance Criteria (Given/When/Then)

### AC-1: Currency CRUD

```gherkin
Scenario: Create currency
  Given admin user on currencies settings page
  When creating currency:
    | Code | PLN |
    | Name | Polish Zloty |
    | Symbol | zł |
    | Is Base | TRUE |
  Then currency created successfully
  And is_base = TRUE
  And is_active = TRUE
  And exchange_rate = 1.000000

Scenario: Only one base currency per org
  Given org has PLN as base currency
  When attempting to set EUR as base
  Then validation error: "Organization can have only one base currency"
```

### AC-2: Exchange Rate Management

```gherkin
Scenario: Add exchange rate manually
  Given currency EUR exists
  When adding exchange rate:
    | Effective Date | 2025-01-15 |
    | Rate | 4.30 |
  Then exchange_rates record created
  And source = 'manual'
  And rate = 4.30

Scenario: Historical rate lookup
  Given EUR has rates:
    | Date | Rate |
    | 2025-01-10 | 4.25 |
    | 2025-01-15 | 4.30 |
  When looking up rate for 2025-01-12
  Then rate = 4.25 (most recent rate <= date)
```

### AC-3: Currency Conversion

```gherkin
Scenario: Convert EUR to PLN
  Given EUR rate = 4.30
  And amount = 100 EUR
  When converting to PLN
  Then converted_amount = 430.00 PLN

Scenario: Convert between two foreign currencies
  Given EUR rate = 4.30, USD rate = 3.90
  And amount = 100 USD
  When converting to EUR
  Then converted_amount = 90.70 EUR
  Calculation: 100 * (4.30 / 3.90) = 110.26 PLN -> 110.26 / 4.30 = 25.64 EUR
```

### AC-4: Currency Selector UI

```gherkin
Scenario: Display currency selector
  Given user creating cost record
  When currency selector rendered
  Then displays active currencies only
  And default selection = base currency
  And format: "PLN (zł)" with symbol
```

---

## Key Business Rules

1. **Base Currency Required**: Every org must have exactly one base currency
2. **PLN Default**: New Polish orgs default to PLN as base currency
3. **Exchange Rate to Base**: All rates expressed relative to base currency
4. **Historical Rates**: Use most recent rate <= transaction date for conversion
5. **Active Currencies**: Only active currencies selectable in UI
6. **Rate Precision**: Exchange rates stored with 6 decimal precision
7. **Conversion Rounding**: Converted amounts rounded to 4 decimals
8. **Immutable Rates**: Historical exchange rates cannot be deleted (audit trail)

---

## Deliverables

- [ ] Migration: currencies and exchange_rates tables
- [ ] Function: convert_currency(), get_base_currency()
- [ ] API: Currency CRUD endpoints
- [ ] API: Exchange rate CRUD endpoints
- [ ] Service: CurrencyService with conversion methods
- [ ] Component: Currency selector dropdown
- [ ] Page: Currency management settings
- [ ] Tests: Unit, integration, E2E

---

**Document Status**: Ready for Implementation
**Created**: 2025-01-15
**Complexity**: M (Medium)
**Phase**: 1 (Foundation)
