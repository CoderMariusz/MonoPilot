# Story 09.22: Cost Center Budget & Variance

**Epic:** 09-finance
**Phase:** 3
**Complexity:** M (3-4 days)
**Type:** Full-stack
**Story File:** `09.22.cost-center-budget-variance.md`

---

## User Story

As a **Finance Manager** or **Department Head**,
I want to **define budgets by cost center and track budget vs actual variance**,
So that I can **control spending, identify budget overruns, and optimize resource allocation**.

---

## Business Context

**Problem**: Departments and cost centers operate without spending visibility, leading to budget overruns and uncontrolled costs.

**Value**:
- Establish accountability for cost center spending
- Early detection of budget overruns (prevent surprises at month-end)
- Enable proactive cost control decisions
- Support financial planning and forecasting
- Align operational spending with strategic budgets

**Use Cases**:
1. Finance Manager defines Q1 budget for "Production Line 1" cost center → sets monthly budget $50K → tracks actual spending against budget
2. Department Head reviews cost center variance report → sees "Packaging Department" is 15% over budget → investigates overtime hours → implements corrective actions
3. CFO reviews all cost centers → identifies 3 centers consistently under budget → reallocates resources to overperforming areas
4. Production Manager receives budget alert → "Maintenance Cost Center" at 90% of monthly budget with 10 days remaining → defers non-critical repairs to next month

---

## Acceptance Criteria

### AC1: Budget Definition (FR-9.11.1, FR-9.10.5)

**Given** user has finance_manager role
**When** defining budget for cost center
**Then** the system allows:
- Select cost center (from cost_centers table)
- Define budget period: Monthly, Quarterly, Annual
- Set budget amount
- Select currency
- Select budget category: Material, Labor, Overhead, Total
- Effective date range (period_start, period_end)
- Budget status: Draft, Approved, Active
- Notes/justification

**Validation**:
- Budget amount must be > 0
- Period start < period end
- No overlapping budgets for same cost center, category, and period
- Currency must match organization base currency or be convertible

---

### AC2: Budget Allocation (FR-9.10.4)

**Given** annual budget is defined
**When** allocating budget to sub-periods
**Then** the system:
- Supports automatic allocation: Annual budget ÷ 12 months
- Supports custom allocation: User defines per-month amounts
- Supports allocation by percentage: Q1 30%, Q2 25%, Q3 20%, Q4 25%
- Validates: Sum of sub-period budgets = total budget
- Allows adjustment of individual period budgets

**Example**:
- Annual budget: $600K
- Auto-allocate: $50K/month × 12 months
- Custom: Jan $60K (high season), Feb-Dec $49K each

---

### AC3: Budget vs Actual Report (FR-9.11.2, FR-9.10.6)

**Given** budgets are defined and actual costs exist
**When** user views budget vs actual report
**Then** the system displays:
- Cost center hierarchy (parent → children)
- For each cost center:
  - Budget amount
  - Actual cost (to date)
  - Variance amount (actual - budget)
  - Variance % = (variance / budget) × 100
  - Remaining budget
  - % of budget consumed
  - Days remaining in period
  - Projected final spend (based on current trend)
- Filters: Cost center, period, budget category, variance threshold
- Color coding: Green (under budget), Yellow (within 5% of budget), Red (over budget)

**Export**: CSV, Excel, PDF

**Validation**:
- Actual costs sourced from work_order_costs filtered by cost_center_id
- Budget data from cost_center_budgets
- Variance calculation: positive = over budget, negative = under budget

---

### AC4: Budget Variance Analysis (FR-9.11.3)

**Given** cost center has budget variance
**When** user drills into variance detail
**Then** the system shows:
- Variance breakdown by category (material, labor, overhead)
- Variance trend over period (daily or weekly)
- Top variance contributors (work orders, operations, products)
- Root cause categorization (if entered)
- Historical comparison (same period last year)
- Corrective actions taken (if documented)

**Validation**:
- Variance breakdown sums to total variance
- Trend chart shows cumulative budget vs actual
- Links to underlying transaction details

---

### AC5: Budget Approval Workflow (FR-9.11.4)

**Given** budget is created with status "Draft"
**When** user submits budget for approval
**Then** the system:
- Changes status to "Pending Approval"
- Notifies designated approvers (finance_manager, cfo)
- Approver can:
  - Approve → status = "Approved"
  - Reject → status = "Rejected" with rejection reason
  - Request revision → status = "Revision Requested" with notes
- Approved budget becomes "Active" on effective date
- Audit log records approval chain

**Validation**:
- Only users with finance_manager or cfo role can approve
- Budget cannot be edited while "Pending Approval"
- Approval notes required for rejection
- Email notifications sent to budget owner

---

### AC6: Budget Forecasting (FR-9.11.5)

**Given** historical cost data exists
**When** forecasting budget for next period
**Then** the system:
- Calculates average cost per period (last 6-12 months)
- Applies growth rate adjustment (configurable %, default 0%)
- Suggests budget based on historical average + growth
- Shows min/max historical costs for reference
- Allows user to override suggested budget
- Documents forecasting assumptions

**Formula**:
```
Forecasted Budget = AVG(Last N Period Costs) × (1 + Growth Rate)
```

**Example**:
- Last 6 months avg cost: $45K
- Growth rate: 5%
- Forecasted budget: $45K × 1.05 = $47.25K

---

### AC7: Budget Variance Alerts (FR-9.11.6)

**Given** budget variance thresholds are configured
**When** actual spending exceeds threshold
**Then** the system:
- Generates budget variance alert
- Alert triggered when:
  - Variance > 5% (warning)
  - Variance > 10% (critical)
  - Spending rate projects >100% budget consumption before period end
- Notifies cost center owner, finance manager
- Alert includes:
    - Cost center name
    - Budget amount
    - Actual cost
    - Variance %
    - Days remaining
    - Projected overspend
- User can acknowledge alert with action plan

**Validation**:
- Alerts checked daily or after cost transactions
- Alert severity based on configurable thresholds
- Alert status: active, acknowledged, resolved
- Alert history preserved

---

## Technical Design

### Database Schema Additions

#### cost_center_budgets (existing, enhanced)
```sql
-- Enhanced from 09.10
ALTER TABLE cost_center_budgets
  ADD COLUMN allocation_method VARCHAR(20) DEFAULT 'manual', -- 'manual', 'equal', 'percentage'
  ADD COLUMN allocation_percentage NUMERIC(5,2), -- For percentage allocation
  ADD COLUMN projected_spend NUMERIC(15,2), -- Forecasted final spend
  ADD COLUMN variance_notes TEXT, -- Variance explanation
  ADD COLUMN reviewed_by UUID REFERENCES users(id),
  ADD COLUMN reviewed_at TIMESTAMPTZ;

-- Index for budget lookups
CREATE INDEX idx_cost_center_budgets_period ON cost_center_budgets(cost_center_id, period_start, period_end);
```

#### budget_variance_alerts
```sql
CREATE TABLE budget_variance_alerts (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  org_id UUID NOT NULL REFERENCES organizations(id),
  cost_center_id UUID NOT NULL REFERENCES cost_centers(id),
  budget_id UUID NOT NULL REFERENCES cost_center_budgets(id),

  alert_type VARCHAR(50) NOT NULL, -- 'over_budget', 'approaching_limit', 'projected_overrun'
  severity VARCHAR(20) NOT NULL, -- 'warning', 'critical'

  budget_amount NUMERIC(15,2) NOT NULL,
  actual_cost NUMERIC(15,2) NOT NULL,
  variance_amount NUMERIC(15,2) NOT NULL,
  variance_percent NUMERIC(5,2) NOT NULL,

  days_remaining INT,
  projected_overspend NUMERIC(15,2),

  status VARCHAR(20) NOT NULL DEFAULT 'active', -- 'active', 'acknowledged', 'resolved'
  acknowledged_by UUID REFERENCES users(id),
  acknowledged_at TIMESTAMPTZ,
  action_plan TEXT,

  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_budget_alerts_cost_center ON budget_variance_alerts(cost_center_id);
CREATE INDEX idx_budget_alerts_status ON budget_variance_alerts(org_id, status);

-- RLS
ALTER TABLE budget_variance_alerts ENABLE ROW LEVEL SECURITY;
CREATE POLICY budget_alerts_org_isolation ON budget_variance_alerts FOR ALL USING (org_id = current_setting('app.org_id')::UUID);
```

### API Endpoints

```typescript
// Budget Definition
POST /api/finance/budgets
Body: {
  cost_center_id: string;
  period_start: ISO date;
  period_end: ISO date;
  budget_amount: number;
  currency_id: string;
  category: 'material' | 'labor' | 'overhead' | 'total';
  allocation_method?: 'manual' | 'equal' | 'percentage';
  notes?: string;
}
Response: { created budget }

GET /api/finance/budgets
Query Params:
  - costCenterId?: string
  - periodStart?: ISO date
  - periodEnd?: ISO date
  - status?: 'draft' | 'approved' | 'active'
Response: { budgets: Budget[] }

PATCH /api/finance/budgets/:id
Body: { budget_amount, status, variance_notes, etc. }
Response: { updated budget }

// Budget Allocation
POST /api/finance/budgets/:id/allocate
Body: {
  allocation_method: 'equal' | 'percentage' | 'custom';
  custom_allocations?: { month: string, amount: number }[];
  percentages?: { period: string, percent: number }[];
}
Response: { sub_budgets: Budget[] }

// Budget vs Actual Report
GET /api/finance/reports/budget-vs-actual
Query Params:
  - costCenterId?: string
  - periodStart: ISO date
  - periodEnd: ISO date
  - category?: 'material' | 'labor' | 'overhead' | 'total'
  - includeChildren?: boolean (include child cost centers)

Response: {
  cost_centers: {
    cost_center_id: string;
    cost_center_code: string;
    cost_center_name: string;
    budget_amount: number;
    actual_cost: number;
    variance_amount: number;
    variance_percent: number;
    remaining_budget: number;
    percent_consumed: number;
    days_remaining: number;
    projected_final_spend: number;
    children?: CostCenterBudget[]; // Hierarchy
  }[];
  summary: { total_budget, total_actual, total_variance };
}

// Budget Variance Detail
GET /api/finance/budgets/:id/variance-detail
Response: {
  budget: Budget;
  variance_breakdown: {
    category: 'material' | 'labor' | 'overhead';
    budget: number;
    actual: number;
    variance: number;
  }[];
  variance_trend: { date: ISO date, budget_to_date: number, actual_to_date: number }[];
  top_contributors: { work_order_id, product_name, cost: number }[];
}

// Budget Approval
POST /api/finance/budgets/:id/submit-for-approval
Response: { updated budget }

POST /api/finance/budgets/:id/approve
Body: { approval_notes?: string }
Response: { updated budget }

POST /api/finance/budgets/:id/reject
Body: { rejection_reason: string }
Response: { updated budget }

// Budget Forecasting
GET /api/finance/budgets/forecast
Query Params:
  - costCenterId: string
  - periodStart: ISO date
  - periodEnd: ISO date
  - historicalMonths?: number (default 6)
  - growthRate?: number (default 0)

Response: {
  suggested_budget: number;
  historical_avg: number;
  historical_min: number;
  historical_max: number;
  growth_rate: number;
  assumptions: string;
}

// Budget Alerts
GET /api/finance/budgets/alerts
Query Params:
  - status: 'active' | 'acknowledged' | 'resolved'
  - costCenterId?: string

Response: { alerts: BudgetVarianceAlert[] }

POST /api/finance/budgets/alerts/:id/acknowledge
Body: { action_plan?: string }
Response: { updated alert }
```

### Service: BudgetService

```typescript
// apps/frontend/lib/services/budget-service.ts
export class BudgetService {
  // Create budget
  static async createBudget(budgetData: BudgetInput): Promise<Budget> {
    // Validate budget data
    // Check for overlapping budgets
    // Insert budget record
  }

  // Allocate budget to sub-periods
  static async allocateBudget(
    budgetId: string,
    allocationMethod: AllocationMethod,
    customAllocations?: CustomAllocation[]
  ): Promise<Budget[]> {
    // Calculate sub-period budgets
    // Validate sum = total budget
    // Create sub-budget records
  }

  // Get budget vs actual report
  static async getBudgetVsActual(filters: BudgetReportFilters): Promise<BudgetVsActualReport> {
    // Join cost_center_budgets with work_order_costs
    // Calculate variance for each cost center
    // Include hierarchy rollup if requested
  }

  // Get variance detail
  static async getVarianceDetail(budgetId: string): Promise<VarianceDetail> {
    // Breakdown variance by category
    // Get variance trend (cumulative)
    // Identify top cost contributors
  }

  // Submit budget for approval
  static async submitForApproval(budgetId: string): Promise<Budget> {
    // Change status to pending_approval
    // Notify approvers
  }

  // Approve/Reject budget
  static async approveBudget(budgetId: string, notes?: string): Promise<Budget> {
    // Validate approver role
    // Update status to approved
    // Log approval
  }

  // Forecast budget
  static async forecastBudget(
    costCenterId: string,
    periodStart: Date,
    periodEnd: Date,
    options: ForecastOptions
  ): Promise<BudgetForecast> {
    // Get historical costs
    // Calculate average, min, max
    // Apply growth rate
    // Return forecast
  }

  // Check and create budget alerts
  static async checkBudgetAlerts(costCenterId: string): Promise<void> {
    // Get active budgets for cost center
    // Calculate variance
    // If threshold exceeded, create alert
    // Notify cost center owner
  }
}
```

### Database Function: Calculate Budget Variance

```sql
CREATE OR REPLACE FUNCTION calculate_budget_variance(
  p_budget_id UUID,
  p_current_date DATE DEFAULT CURRENT_DATE
)
RETURNS TABLE (
  budget_amount NUMERIC,
  actual_cost NUMERIC,
  variance_amount NUMERIC,
  variance_percent NUMERIC,
  remaining_budget NUMERIC,
  percent_consumed NUMERIC,
  days_remaining INT,
  projected_final_spend NUMERIC
) AS $$
DECLARE
  v_budget_amount NUMERIC;
  v_period_start DATE;
  v_period_end DATE;
  v_cost_center_id UUID;
  v_actual_cost NUMERIC;
  v_days_total INT;
  v_days_elapsed INT;
BEGIN
  -- Get budget details
  SELECT ccb.budget_amount, ccb.period_start, ccb.period_end, ccb.cost_center_id
  INTO v_budget_amount, v_period_start, v_period_end, v_cost_center_id
  FROM cost_center_budgets ccb
  WHERE ccb.id = p_budget_id;

  -- Get actual cost to date
  SELECT COALESCE(SUM(woc.total_cost_actual), 0)
  INTO v_actual_cost
  FROM work_order_costs woc
  JOIN work_orders wo ON woc.work_order_id = wo.id
  WHERE woc.cost_center_id = v_cost_center_id
    AND woc.costing_date BETWEEN v_period_start AND p_current_date;

  -- Calculate days
  v_days_total := v_period_end - v_period_start + 1;
  v_days_elapsed := p_current_date - v_period_start + 1;

  -- Calculate variance
  variance_amount := v_actual_cost - v_budget_amount;
  variance_percent := CASE
    WHEN v_budget_amount > 0 THEN (variance_amount / v_budget_amount) * 100
    ELSE 0
  END;

  -- Calculate projections
  remaining_budget := v_budget_amount - v_actual_cost;
  percent_consumed := CASE
    WHEN v_budget_amount > 0 THEN (v_actual_cost / v_budget_amount) * 100
    ELSE 0
  END;
  days_remaining := v_period_end - p_current_date;

  -- Project final spend (linear extrapolation)
  projected_final_spend := CASE
    WHEN v_days_elapsed > 0 THEN (v_actual_cost / v_days_elapsed) * v_days_total
    ELSE v_actual_cost
  END;

  budget_amount := v_budget_amount;
  actual_cost := v_actual_cost;

  RETURN NEXT;
END;
$$ LANGUAGE plpgsql;
```

---

## Frontend Components

### BudgetDefinitionForm
```tsx
// apps/frontend/components/finance/budget/BudgetDefinitionForm.tsx
export function BudgetDefinitionForm({ onSave, onCancel }: Props) {
  const [budgetData, setBudgetData] = useState<BudgetInput>({
    cost_center_id: '',
    period_start: startOfMonth(new Date()),
    period_end: endOfMonth(new Date()),
    budget_amount: 0,
    category: 'total',
    allocation_method: 'manual',
  });

  const handleSubmit = async () => {
    const budget = await BudgetService.createBudget(budgetData);
    toast.success('Budget created');
    onSave(budget);
  };

  return (
    <Form onSubmit={handleSubmit}>
      <div className="space-y-4">
        <div>
          <Label>Cost Center</Label>
          <CostCenterSelect
            value={budgetData.cost_center_id}
            onChange={(id) => setBudgetData({ ...budgetData, cost_center_id: id })}
          />
        </div>

        <div className="grid grid-cols-2 gap-4">
          <div>
            <Label>Period Start</Label>
            <DatePicker
              value={budgetData.period_start}
              onChange={(date) => setBudgetData({ ...budgetData, period_start: date })}
            />
          </div>
          <div>
            <Label>Period End</Label>
            <DatePicker
              value={budgetData.period_end}
              onChange={(date) => setBudgetData({ ...budgetData, period_end: date })}
            />
          </div>
        </div>

        <div>
          <Label>Budget Amount</Label>
          <Input
            type="number"
            step="0.01"
            value={budgetData.budget_amount}
            onChange={(e) => setBudgetData({ ...budgetData, budget_amount: parseFloat(e.target.value) })}
          />
        </div>

        <div>
          <Label>Category</Label>
          <Select value={budgetData.category} onValueChange={(val) => setBudgetData({ ...budgetData, category: val })}>
            <SelectTrigger><SelectValue /></SelectTrigger>
            <SelectContent>
              <SelectItem value="total">Total</SelectItem>
              <SelectItem value="material">Material</SelectItem>
              <SelectItem value="labor">Labor</SelectItem>
              <SelectItem value="overhead">Overhead</SelectItem>
            </SelectContent>
          </Select>
        </div>

        <div>
          <Label>Notes</Label>
          <Textarea
            value={budgetData.notes}
            onChange={(e) => setBudgetData({ ...budgetData, notes: e.target.value })}
            placeholder="Budget justification..."
          />
        </div>
      </div>

      <DialogFooter>
        <Button variant="outline" onClick={onCancel}>Cancel</Button>
        <Button type="submit">Create Budget</Button>
      </DialogFooter>
    </Form>
  );
}
```

### BudgetVsActualReport
```tsx
// apps/frontend/components/finance/budget/BudgetVsActualReport.tsx
export function BudgetVsActualReport({ filters }: Props) {
  const { data, isLoading } = useBudgetVsActual(filters);

  const columns: ColumnDef<CostCenterBudget>[] = [
    { accessorKey: 'cost_center_code', header: 'Code' },
    { accessorKey: 'cost_center_name', header: 'Cost Center' },
    { accessorKey: 'budget_amount', header: 'Budget', cell: ({ value }) => formatCurrency(value) },
    { accessorKey: 'actual_cost', header: 'Actual', cell: ({ value }) => formatCurrency(value) },
    {
      accessorKey: 'variance_amount',
      header: 'Variance',
      cell: ({ row }) => {
        const variance = row.original.variance_amount;
        const className = variance > 0 ? 'text-red-600' : variance < 0 ? 'text-green-600' : '';
        return <span className={className}>{formatCurrency(Math.abs(variance))}</span>;
      },
    },
    {
      accessorKey: 'variance_percent',
      header: 'Variance %',
      cell: ({ row }) => {
        const percent = row.original.variance_percent;
        const variant = percent > 10 ? 'destructive' : percent > 5 ? 'warning' : 'success';
        return <Badge variant={variant}>{percent.toFixed(2)}%</Badge>;
      },
    },
    { accessorKey: 'remaining_budget', header: 'Remaining', cell: ({ value }) => formatCurrency(value) },
    { accessorKey: 'percent_consumed', header: '% Used', cell: ({ value }) => `${value.toFixed(1)}%` },
    { accessorKey: 'days_remaining', header: 'Days Left' },
    {
      id: 'actions',
      cell: ({ row }) => (
        <Button size="sm" variant="ghost" onClick={() => openVarianceDetail(row.original)}>
          Details
        </Button>
      ),
    },
  ];

  return (
    <Card>
      <CardHeader>
        <CardTitle>Budget vs Actual</CardTitle>
        <CardDescription>
          Period: {format(filters.periodStart, 'MMM d, yyyy')} - {format(filters.periodEnd, 'MMM d, yyyy')}
        </CardDescription>
      </CardHeader>
      <CardContent>
        <DataTable columns={columns} data={data?.cost_centers || []} />

        <div className="mt-4 p-4 bg-muted rounded-md">
          <h4 className="font-semibold mb-2">Summary</h4>
          <div className="grid grid-cols-3 gap-4 text-sm">
            <div>
              <span className="text-muted-foreground">Total Budget:</span>
              <span className="ml-2 font-semibold">{formatCurrency(data?.summary.total_budget)}</span>
            </div>
            <div>
              <span className="text-muted-foreground">Total Actual:</span>
              <span className="ml-2 font-semibold">{formatCurrency(data?.summary.total_actual)}</span>
            </div>
            <div>
              <span className="text-muted-foreground">Total Variance:</span>
              <span className={`ml-2 font-semibold ${data?.summary.total_variance > 0 ? 'text-red-600' : 'text-green-600'}`}>
                {formatCurrency(Math.abs(data?.summary.total_variance))}
              </span>
            </div>
          </div>
        </div>
      </CardContent>
    </Card>
  );
}
```

### BudgetVarianceDetailModal
```tsx
// apps/frontend/components/finance/budget/BudgetVarianceDetailModal.tsx
export function BudgetVarianceDetailModal({ budgetId, open, onClose }: Props) {
  const { data } = useBudgetVarianceDetail(budgetId);

  return (
    <Dialog open={open} onOpenChange={onClose}>
      <DialogContent className="max-w-4xl">
        <DialogHeader>
          <DialogTitle>Budget Variance Detail - {data?.budget.cost_center_name}</DialogTitle>
        </DialogHeader>

        <Tabs defaultValue="breakdown">
          <TabsList>
            <TabsTrigger value="breakdown">Breakdown</TabsTrigger>
            <TabsTrigger value="trend">Trend</TabsTrigger>
            <TabsTrigger value="contributors">Contributors</TabsTrigger>
          </TabsList>

          <TabsContent value="breakdown" className="space-y-4">
            <Table>
              <TableHeader>
                <TableRow>
                  <TableHead>Category</TableHead>
                  <TableHead>Budget</TableHead>
                  <TableHead>Actual</TableHead>
                  <TableHead>Variance</TableHead>
                </TableRow>
              </TableHeader>
              <TableBody>
                {data?.variance_breakdown.map(b => (
                  <TableRow key={b.category}>
                    <TableCell className="capitalize">{b.category}</TableCell>
                    <TableCell>{formatCurrency(b.budget)}</TableCell>
                    <TableCell>{formatCurrency(b.actual)}</TableCell>
                    <TableCell className={b.variance > 0 ? 'text-red-600' : 'text-green-600'}>
                      {formatCurrency(Math.abs(b.variance))}
                    </TableCell>
                  </TableRow>
                ))}
              </TableBody>
            </Table>
          </TabsContent>

          <TabsContent value="trend">
            <BudgetVarianceTrendChart data={data?.variance_trend} />
          </TabsContent>

          <TabsContent value="contributors">
            <Table>
              <TableHeader>
                <TableRow>
                  <TableHead>Work Order</TableHead>
                  <TableHead>Product</TableHead>
                  <TableHead>Cost</TableHead>
                </TableRow>
              </TableHeader>
              <TableBody>
                {data?.top_contributors.map(c => (
                  <TableRow key={c.work_order_id}>
                    <TableCell>
                      <Link href={`/production/work-orders/${c.work_order_id}`}>{c.work_order_number}</Link>
                    </TableCell>
                    <TableCell>{c.product_name}</TableCell>
                    <TableCell>{formatCurrency(c.cost)}</TableCell>
                  </TableRow>
                ))}
              </TableBody>
            </Table>
          </TabsContent>
        </Tabs>

        <DialogFooter>
          <Button onClick={onClose}>Close</Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}
```

---

## Dependencies

### Required Stories
- **09.10** - Cost Center CRUD (cost_centers table)
- **09.6** - WO Cost Summary (work_order_costs table)
- **09.12** - Overhead Allocation (overhead cost tracking)

---

## Testing Requirements

### Unit Tests
- Budget variance calculation formulas
- Budget allocation logic (equal, percentage, custom)
- Projected spend calculation
- Alert threshold logic

### Integration Tests
- Budget CRUD operations
- Budget vs actual report generation
- Budget approval workflow
- Alert creation and notification

### E2E Tests
1. **Create Budget and Track Variance**:
   - Create monthly budget for cost center
   - Complete work orders against cost center
   - View budget vs actual report
   - Verify variance calculated correctly

2. **Budget Approval Workflow**:
   - Create budget in draft status
   - Submit for approval
   - Approve budget
   - Verify status changes and notifications

3. **Budget Alert**:
   - Set budget with low threshold
   - Create costs exceeding threshold
   - Verify alert created
   - Acknowledge alert with action plan

---

## Performance Requirements

- Budget variance calculation: <500ms per cost center
- Budget vs actual report: <2 seconds (100 cost centers)
- Budget approval workflow: <1 second

---

## Security & Permissions

Roles: finance_manager (create/edit budgets, approve)
Roles: department_head (view own cost center budgets)
Roles: viewer (view budget reports, read-only)

---

## Story Metadata

**Estimated Effort:** 3-4 days
**Story Points:** 8
**Priority:** P1 (Phase 3)
**FR Coverage:** FR-9.10.4, FR-9.10.5, FR-9.10.6, FR-9.11.1, FR-9.11.2, FR-9.11.3
**Related Stories:** 09.10 (Cost Center CRUD), 09.23 (Budget Management), 09.24 (Cost Dashboard)
