# 09.3 - Material Cost Tracking

**Priority**: P0 (MVP)
**Story Points**: M (Medium)
**Type**: backend
**Phase**: 1 (Foundation)
**Model**: OPUS

**State:** ready
**Estimate:** M (3-4 days)
**Primary PRD:** `docs/1-BASELINE/product/modules/finance.md` (FR-9.1.1, FR-9.3.1 Material Cost Tracking)
**Architecture:** `docs/1-BASELINE/architecture/modules/finance.md` (material_consumption_costs table)

---

## Goal

Implement actual material cost tracking from License Plate (LP) consumption transactions, applying FIFO or weighted average cost valuation methods. Link material costs to work orders, calculate material cost summaries, and establish foundation for material variance analysis.

---

## User Story

As a **Cost Accountant**, I want to **track actual material costs when License Plates are consumed in production** so that **I can calculate accurate work order costs and analyze material cost variances**.

As a **Finance Manager**, I want to **choose between FIFO and weighted average valuation methods** so that **inventory costing aligns with our accounting policies**.

---

## MVP Scope

**MVP Includes**:
- `material_consumption_costs` table
- `inventory_cost_layers` table (for FIFO tracking)
- Material cost calculation on LP consumption
- FIFO cost layer selection
- Weighted average cost calculation
- Link costs to work_order_id
- Material cost summary per WO API
- Integration with material_consumption table (Epic 04)
- Cost calculation service
- Audit logging

**Deferred to Phase 2+**:
- Material price variance calculation (Phase 2)
- Material usage variance calculation (Phase 2)
- Cost layer revaluation
- Scrap cost allocation

---

## Dependencies

| Dependency | Story/Epic | Type | Status |
|------------|------------|------|--------|
| 01.1 | Org Context + RLS | HARD | Ready |
| 04.X | Material Consumption | HARD | Implemented |
| 05.1 | License Plates | HARD | Ready |
| 09.1 | Finance Settings | HARD | Ready |
| 09.2 | Standard Costs | HARD | Ready |

---

## Database Migration

```sql
-- Migration: create_material_consumption_costs.sql

CREATE TABLE material_consumption_costs (
    id                  UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id              UUID NOT NULL REFERENCES organizations(id),
    consumption_id      UUID NOT NULL REFERENCES material_consumption(id),
    work_order_id       UUID NOT NULL REFERENCES work_orders(id),
    product_id          UUID NOT NULL REFERENCES products(id),
    lp_id               UUID REFERENCES license_plates(id),

    quantity            NUMERIC(15,4) NOT NULL,
    uom                 TEXT NOT NULL,
    unit_cost           NUMERIC(15,4) NOT NULL,
    total_cost          NUMERIC(15,4) NOT NULL,

    currency_id         UUID NOT NULL REFERENCES currencies(id),
    cost_method         TEXT NOT NULL CHECK (cost_method IN ('fifo', 'weighted_average', 'standard')),
    cost_center_id      UUID REFERENCES cost_centers(id),

    transaction_date    TIMESTAMPTZ NOT NULL DEFAULT now(),
    created_at          TIMESTAMPTZ NOT NULL DEFAULT now(),

    CONSTRAINT chk_quantity CHECK (quantity > 0),
    CONSTRAINT chk_total_cost CHECK (total_cost = quantity * unit_cost)
);

CREATE INDEX idx_material_costs_org ON material_consumption_costs(org_id);
CREATE INDEX idx_material_costs_wo ON material_consumption_costs(work_order_id);
CREATE INDEX idx_material_costs_product ON material_consumption_costs(product_id);
CREATE INDEX idx_material_costs_date ON material_consumption_costs(org_id, transaction_date);

ALTER TABLE material_consumption_costs ENABLE ROW LEVEL SECURITY;

CREATE POLICY "material_costs_select" ON material_consumption_costs
    FOR SELECT USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

-- Inventory cost layers for FIFO
CREATE TABLE inventory_cost_layers (
    id                  UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id              UUID NOT NULL REFERENCES organizations(id),
    product_id          UUID NOT NULL REFERENCES products(id),
    location_id         UUID REFERENCES locations(id),
    lot_number          TEXT,

    quantity_received   NUMERIC(15,4) NOT NULL,
    quantity_remaining  NUMERIC(15,4) NOT NULL,
    unit_cost           NUMERIC(15,4) NOT NULL,
    total_cost          NUMERIC(15,4) NOT NULL,

    currency_id         UUID NOT NULL REFERENCES currencies(id),
    receipt_date        TIMESTAMPTZ NOT NULL,
    valuation_method    TEXT NOT NULL DEFAULT 'fifo',

    created_at          TIMESTAMPTZ NOT NULL DEFAULT now(),
    updated_at          TIMESTAMPTZ NOT NULL DEFAULT now(),

    CONSTRAINT chk_quantity_remaining CHECK (quantity_remaining >= 0 AND quantity_remaining <= quantity_received)
);

CREATE INDEX idx_cost_layers_org_product ON inventory_cost_layers(org_id, product_id);
CREATE INDEX idx_cost_layers_fifo ON inventory_cost_layers(org_id, product_id, receipt_date)
    WHERE quantity_remaining > 0;

ALTER TABLE inventory_cost_layers ENABLE ROW LEVEL SECURITY;

CREATE POLICY "cost_layers_select" ON inventory_cost_layers
    FOR SELECT USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

-- Function: Calculate material cost on consumption
CREATE OR REPLACE FUNCTION calculate_material_consumption_cost(
    p_consumption_id UUID,
    p_org_id UUID,
    p_work_order_id UUID,
    p_product_id UUID,
    p_quantity NUMERIC,
    p_uom TEXT
)
RETURNS UUID AS $$
DECLARE
    v_cost_id UUID;
    v_unit_cost NUMERIC;
    v_total_cost NUMERIC;
    v_valuation_method TEXT;
    v_currency_id UUID;
BEGIN
    -- Get valuation method from settings
    SELECT valuation_method, base_currency_id
    INTO v_valuation_method, v_currency_id
    FROM finance_settings
    WHERE org_id = p_org_id;

    -- Calculate unit cost based on method
    IF v_valuation_method = 'fifo' THEN
        SELECT calculate_fifo_cost(p_org_id, p_product_id, p_quantity)
        INTO v_unit_cost;
    ELSIF v_valuation_method = 'weighted_average' THEN
        SELECT calculate_weighted_average_cost(p_org_id, p_product_id)
        INTO v_unit_cost;
    ELSE -- standard_cost
        SELECT total_cost INTO v_unit_cost
        FROM get_active_standard_cost(p_org_id, p_product_id, CURRENT_DATE);
    END IF;

    v_total_cost := p_quantity * v_unit_cost;

    -- Insert material consumption cost
    INSERT INTO material_consumption_costs (
        org_id, consumption_id, work_order_id, product_id,
        quantity, uom, unit_cost, total_cost,
        currency_id, cost_method, transaction_date
    ) VALUES (
        p_org_id, p_consumption_id, p_work_order_id, p_product_id,
        p_quantity, p_uom, v_unit_cost, v_total_cost,
        v_currency_id, v_valuation_method, NOW()
    )
    RETURNING id INTO v_cost_id;

    RETURN v_cost_id;
END;
$$ LANGUAGE plpgsql;
```

---

## Acceptance Criteria

### AC-1: FIFO Cost Calculation
```gherkin
Given inventory cost layers for product:
  | Receipt Date | Qty Remaining | Unit Cost |
  | 2025-01-01  | 100 | 2.50 |
  | 2025-01-10  | 200 | 2.75 |
When consuming 150 units
Then cost calculated from oldest layers:
  | Layer | Qty Used | Unit Cost | Total |
  | 2025-01-01 | 100 | 2.50 | 250.00 |
  | 2025-01-10 | 50  | 2.75 | 137.50 |
And weighted average unit cost = 387.50 / 150 = 2.583
And material_consumption_cost record created
```

### AC-2: Weighted Average Cost
```gherkin
Given inventory on hand:
  | Qty | Unit Cost | Total Cost |
  | 100 | 2.50 | 250.00 |
  | 200 | 2.75 | 550.00 |
When consuming 50 units
Then weighted average = 800.00 / 300 = 2.667
And unit_cost = 2.667, total_cost = 133.33
```

### AC-3: Link to Work Order
```gherkin
Given work order WO-2025-001
And material consumption transaction created
When cost calculated
Then material_consumption_cost.work_order_id = WO-2025-001
And cost included in WO material cost summary
```

### AC-4: Material Cost Summary API
```gherkin
Given GET /api/finance/work-order-costs/:workOrderId/material
When requesting material costs for WO
Then response contains:
  | product_name | quantity | unit_cost | total_cost |
And summary totals at bottom
```

---

## Deliverables

- [ ] `material_consumption_costs` table
- [ ] `inventory_cost_layers` table
- [ ] FIFO cost calculation function
- [ ] Weighted average cost function
- [ ] Material cost trigger on consumption
- [ ] API: GET material costs by WO
- [ ] Service: MaterialCostService
- [ ] Tests: FIFO, WAC, standard cost scenarios

---

## Definition of Done

- [ ] Material costs calculated on LP consumption
- [ ] FIFO and WAC methods functional
- [ ] Costs linked to work orders
- [ ] API returns accurate cost summaries
- [ ] Tests cover all valuation methods
- [ ] Performance < 500ms for cost calculation

---

**Created**: 2025-01-15 | **Complexity**: M (3-4 days) | **Phase**: 1
