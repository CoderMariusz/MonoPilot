# Story 09.21: Margin Analysis

**Epic:** 09-finance
**Phase:** 3
**Complexity:** L (4-5 days)
**Type:** Full-stack
**Story File:** `09.21.margin-analysis.md`

---

## User Story

As a **Finance Manager** or **CFO**,
I want to **analyze product margins and profitability by product family, customer, and time period**,
So that I can **optimize product mix, pricing strategies, and identify unprofitable products**.

---

## Business Context

**Problem**: Companies produce products without knowing which are profitable and which are losing money. Margin visibility is critical for strategic pricing and product portfolio decisions.

**Value**:
- Identify which products contribute most to profitability
- Detect products with negative or below-target margins
- Support pricing decisions with cost-based margin data
- Enable product mix optimization
- Track margin trends to spot deteriorating profitability

**Use Cases**:
1. Finance Manager generates margin report → identifies "Chocolate Bar Premium" has 8% margin vs 15% target → recommends price increase or cost reduction
2. CFO reviews margin by product family → sees "Bakery" family averages 22% margin while "Snacks" is only 9% → shifts production focus to bakery
3. Sales Director views margin by customer → identifies Customer X consistently buys low-margin products → negotiates price adjustments
4. Product Manager monitors margin trends → sees "Energy Bar" margin declining from 18% to 12% over 3 months → investigates cost increases

---

## Acceptance Criteria

### AC1: Product Margin Calculation (FR-9.7.1)

**Given** products have defined selling prices and actual production costs
**When** system calculates product margins
**Then** the system computes:
- Gross Margin = Selling Price - Total Product Cost
- Gross Margin % = (Gross Margin / Selling Price) × 100
- Contribution Margin = Selling Price - Variable Costs (if variable/fixed split configured)
- Contribution Margin % = (Contribution Margin / Selling Price) × 100

**Validation**:
- Total Product Cost sourced from work_order_costs (actual cost)
- If no selling price defined, margin calculation skipped with warning
- Margin recalculated when selling price or cost changes
- Historical margins preserved with effective dates

---

### AC2: Margin by Product Report (FR-9.7.2, FR-FIN-057)

**Given** user navigates to `/finance/margin-analysis/by-product`
**When** selecting date range and filters
**Then** the system displays:
- Product list with columns:
  - SKU, Product Name
  - Selling Price
  - Total Cost (average actual cost for period)
  - Gross Margin Amount
  - Gross Margin %
  - Target Margin % (if defined)
  - Variance to Target
  - Units Sold
  - Total Revenue
  - Total Margin (margin × units sold)
- Sortable columns (by margin %, total margin, variance)
- Color coding: Green (above target), Yellow (within 2% of target), Red (below target)
- Filters: Product category, margin threshold, date range

**Export**: CSV, Excel, PDF

**Validation**:
- Report aggregates work_order_costs for actual cost
- Selling price from products.selling_price or price list
- Units sold from completed work orders
- Target margin from product_margins table

---

### AC3: Margin by Product Family (FR-FIN-057)

**Given** products are assigned to product families/categories
**When** user views margin by product family report
**Then** the system displays:
- Product family list with:
  - Family Name
  - Total Revenue (sum of selling price × units sold)
  - Total Cost (sum of actual costs)
  - Family Gross Margin (total revenue - total cost)
  - Family Gross Margin % = (Family Margin / Revenue) × 100
  - Target Margin % (if defined at family level)
  - Variance to Target
  - Number of Products in Family
  - Units Sold
- Drill-down: Click family → view individual product margins within family
- Comparison chart: Bar chart comparing family margins

**Validation**:
- Family margins calculated as weighted average of product margins
- Families ranked by total margin contribution
- Products without family assigned shown in "Uncategorized"

---

### AC4: Margin by Customer (FR-9.7.3)

**Given** sales orders exist with customer assignments
**When** user views margin by customer report
**Then** the system displays:
- Customer list with:
  - Customer Name
  - Total Revenue
  - Total Cost
  - Gross Margin
  - Gross Margin %
  - Units Purchased
  - Average Margin per Unit
  - Product Mix (count of distinct products)
- Filters: Customer segment, date range, margin threshold
- Drill-down: Click customer → view product-level margins for that customer

**Validation**:
- Customer data sourced from sales_orders (if integrated) or work_order.customer_id
- Margin calculated per customer order
- If customer not assigned, shown as "Direct/Internal"

---

### AC5: Margin Trend Analysis (FR-9.7.4)

**Given** margin data exists for multiple periods
**When** user views margin trend analysis
**Then** the system displays:
- Line chart showing margin % trends over time (by month or week)
- Selectable products or product families
- Trend indicators (increasing, stable, decreasing)
- Period-over-period change
- Table: Period, Revenue, Cost, Margin %, Change from Previous Period
- Ability to compare multiple products on same chart

**Validation**:
- Time series aggregated by selected period (daily, weekly, monthly)
- Trend calculated using linear regression or moving average
- Color coding: Green (improving margin), Red (declining margin)

---

### AC6: Target Margin Setting (FR-9.7.5)

**Given** user has finance_manager role
**When** defining target margin for product or product family
**Then** the system allows:
- Set target margin % per product
- Set target margin % per product family (applies to all products in family)
- Effective date for target margin
- Reason for target margin change
- Approval workflow (if configured)

**Validation**:
- Target margin stored in product_margins table
- Target margin range: 0-100%
- Historical targets preserved (effective_from, effective_to dates)
- Target margin displayed in margin reports for comparison

---

### AC7: Margin Alert Notifications (FR-9.7.6)

**Given** target margins are defined
**When** actual margin falls below target margin by threshold (e.g., >2%)
**Then** the system:
- Generates margin alert notification
- Notifies assigned users (finance_manager, product_manager)
- Displays alert on margin dashboard
- Sends email notification (if enabled)
- Alert includes:
  - Product name
  - Actual margin %
  - Target margin %
  - Variance %
  - Contributing factors (cost increase, price decrease)

**Validation**:
- Margin alerts checked after work order costing completes
- Alert threshold configurable per product family
- User can acknowledge alert with notes
- Alert status: active, acknowledged, resolved

---

### AC8: Contribution Margin Calculation (FR-9.7.7)

**Given** costs are categorized as variable or fixed
**When** contribution margin is calculated
**Then** the system computes:
- Variable Costs = Material Cost + Variable Labor + Variable Overhead
- Contribution Margin = Selling Price - Variable Costs
- Contribution Margin % = (Contribution Margin / Selling Price) × 100
- Fixed Cost Coverage = Contribution Margin - Fixed Costs

**Validation**:
- Variable/Fixed cost split configured in cost_centers or overhead_allocations
- If cost split not configured, contribution margin = gross margin
- Contribution margin useful for break-even analysis
- Report shows both gross margin and contribution margin side-by-side

---

## Technical Design

### Database Schema Additions

#### product_margins (enhanced)
```sql
CREATE TABLE product_margins (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  org_id UUID NOT NULL REFERENCES organizations(id),
  product_id UUID REFERENCES products(id),
  product_family_id UUID REFERENCES product_categories(id), -- Family-level margin
  effective_date DATE NOT NULL DEFAULT CURRENT_DATE,

  -- Pricing
  selling_price NUMERIC(15,2) NOT NULL,

  -- Costs (average for period)
  total_cost NUMERIC(15,2) NOT NULL,
  variable_cost NUMERIC(15,2),
  fixed_cost NUMERIC(15,2),

  -- Gross Margin
  margin_amount NUMERIC(15,2) NOT NULL,
  margin_percent NUMERIC(5,2) NOT NULL,

  -- Contribution Margin
  contribution_margin_amount NUMERIC(15,2),
  contribution_margin_percent NUMERIC(5,2),

  -- Targets
  target_margin_percent NUMERIC(5,2),
  variance_to_target NUMERIC(5,2),

  -- Volume
  units_sold INT DEFAULT 0,
  total_revenue NUMERIC(15,2) DEFAULT 0,
  total_margin NUMERIC(15,2) DEFAULT 0,

  currency_id UUID REFERENCES currencies(id),

  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_product_margins_product ON product_margins(product_id);
CREATE INDEX idx_product_margins_family ON product_margins(product_family_id);
CREATE INDEX idx_product_margins_date ON product_margins(org_id, effective_date DESC);

-- RLS
ALTER TABLE product_margins ENABLE ROW LEVEL SECURITY;
CREATE POLICY product_margins_org_isolation ON product_margins FOR ALL USING (org_id = current_setting('app.org_id')::UUID);
```

#### margin_alerts
```sql
CREATE TABLE margin_alerts (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  org_id UUID NOT NULL REFERENCES organizations(id),
  product_id UUID REFERENCES products(id),
  product_family_id UUID REFERENCES product_categories(id),

  alert_type VARCHAR(50) NOT NULL, -- 'below_target', 'negative_margin', 'declining_trend'
  severity VARCHAR(20) NOT NULL, -- 'warning', 'critical'

  actual_margin_percent NUMERIC(5,2),
  target_margin_percent NUMERIC(5,2),
  variance_percent NUMERIC(5,2),

  contributing_factors JSONB, -- { cost_increase: 500, price_decrease: 0 }

  status VARCHAR(20) NOT NULL DEFAULT 'active', -- 'active', 'acknowledged', 'resolved'
  acknowledged_by UUID REFERENCES users(id),
  acknowledged_at TIMESTAMPTZ,
  acknowledged_notes TEXT,

  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_margin_alerts_product ON margin_alerts(product_id);
CREATE INDEX idx_margin_alerts_status ON margin_alerts(org_id, status);

-- RLS
ALTER TABLE margin_alerts ENABLE ROW LEVEL SECURITY;
CREATE POLICY margin_alerts_org_isolation ON margin_alerts FOR ALL USING (org_id = current_setting('app.org_id')::UUID);
```

### API Endpoints

```typescript
// Margin by Product
GET /api/finance/margin-analysis/by-product
Query Params:
  - dateFrom: ISO date
  - dateTo: ISO date
  - productCategoryId?: string
  - minMarginPercent?: number
  - maxMarginPercent?: number

Response: {
  products: {
    product_id: string;
    sku: string;
    product_name: string;
    product_family: string;
    selling_price: number;
    total_cost: number;
    margin_amount: number;
    margin_percent: number;
    target_margin_percent: number;
    variance_to_target: number;
    units_sold: number;
    total_revenue: number;
    total_margin: number;
  }[];
  summary: {
    total_revenue: number;
    total_cost: number;
    total_margin: number;
    avg_margin_percent: number;
  };
}

// Margin by Product Family
GET /api/finance/margin-analysis/by-family
Query Params:
  - dateFrom, dateTo

Response: {
  families: {
    family_id: string;
    family_name: string;
    total_revenue: number;
    total_cost: number;
    family_margin: number;
    family_margin_percent: number;
    target_margin_percent: number;
    variance_to_target: number;
    product_count: number;
    units_sold: number;
    products: ProductMargin[]; // For drill-down
  }[];
}

// Margin by Customer
GET /api/finance/margin-analysis/by-customer
Query Params:
  - dateFrom, dateTo
  - customerSegment?: string

Response: {
  customers: {
    customer_id: string;
    customer_name: string;
    total_revenue: number;
    total_cost: number;
    margin_amount: number;
    margin_percent: number;
    units_purchased: number;
    avg_margin_per_unit: number;
    product_mix_count: number;
  }[];
}

// Margin Trends
GET /api/finance/margin-analysis/trends
Query Params:
  - productId: string
  - dateFrom, dateTo
  - periodType: 'daily' | 'weekly' | 'monthly'

Response: {
  product_id: string;
  product_name: string;
  periods: {
    period_start: ISO date;
    period_end: ISO date;
    revenue: number;
    cost: number;
    margin_percent: number;
    change_from_previous: number; // %
  }[];
  trend: 'increasing' | 'stable' | 'decreasing';
}

// Set Target Margin
POST /api/finance/margin-analysis/targets
Body: {
  product_id?: string;
  product_family_id?: string;
  target_margin_percent: number;
  effective_date: ISO date;
  reason?: string;
}
Response: { created product_margin record }

// Margin Alerts
GET /api/finance/margin-analysis/alerts
Query Params:
  - status: 'active' | 'acknowledged' | 'resolved'

Response: {
  alerts: MarginAlert[];
}

POST /api/finance/margin-analysis/alerts/:id/acknowledge
Body: {
  acknowledged_notes?: string;
}
Response: { updated alert }
```

### Service: MarginAnalysisService

```typescript
// apps/frontend/lib/services/margin-analysis-service.ts
export class MarginAnalysisService {
  // Calculate product margin
  static async calculateProductMargin(
    productId: string,
    dateFrom: Date,
    dateTo: Date
  ): Promise<ProductMargin> {
    // Get average selling price for period
    // Get total cost from work_order_costs
    // Calculate margin amount and %
    // Compare to target margin
  }

  // Get margin by product report
  static async getMarginByProduct(filters: MarginFilters): Promise<MarginByProductReport> {
    // Join products, work_order_costs, product_margins
    // Calculate margins for period
    // Rank by margin % or total margin
  }

  // Get margin by product family
  static async getMarginByFamily(filters: MarginFilters): Promise<MarginByFamilyReport> {
    // Group products by family
    // Aggregate revenue, cost, margin
    // Calculate family-level margin
  }

  // Get margin by customer
  static async getMarginByCustomer(filters: MarginFilters): Promise<MarginByCustomerReport> {
    // Join sales_orders or work_orders with customer
    // Calculate margin per customer
  }

  // Get margin trends
  static async getMarginTrends(
    productId: string,
    dateFrom: Date,
    dateTo: Date,
    periodType: PeriodType
  ): Promise<MarginTrendData> {
    // Time series of margins
    // Calculate trend direction
    // Period-over-period change
  }

  // Set target margin
  static async setTargetMargin(
    targetData: TargetMarginInput
  ): Promise<ProductMargin> {
    // Insert/update product_margins
    // Trigger margin alert check
  }

  // Check and create margin alerts
  static async checkMarginAlerts(productId: string): Promise<void> {
    // Compare actual margin to target
    // If below threshold, create alert
    // Notify assigned users
  }

  // Calculate contribution margin
  static async calculateContributionMargin(
    productId: string,
    dateFrom: Date,
    dateTo: Date
  ): Promise<ContributionMargin> {
    // Separate variable and fixed costs
    // Calculate contribution margin
  }
}
```

### Database Queries

#### Margin by Product (Optimized)
```sql
WITH product_costs AS (
  SELECT
    wo.product_id,
    SUM(woc.total_cost_actual) AS total_cost,
    SUM(woc.quantity_produced) AS units_produced,
    SUM(woc.material_cost_actual) AS material_cost,
    SUM(woc.labor_cost_actual) AS labor_cost,
    SUM(woc.overhead_cost_actual) AS overhead_cost
  FROM work_order_costs woc
  JOIN work_orders wo ON woc.work_order_id = wo.id
  WHERE wo.org_id = :org_id
    AND woc.costing_date BETWEEN :date_from AND :date_to
    AND wo.status = 'completed'
  GROUP BY wo.product_id
)
SELECT
  p.id AS product_id,
  p.sku,
  p.name AS product_name,
  pc.name AS product_family,
  p.selling_price,
  COALESCE(c.total_cost / NULLIF(c.units_produced, 0), 0) AS avg_unit_cost,
  c.units_produced AS units_sold,
  p.selling_price * c.units_produced AS total_revenue,
  c.total_cost,
  (p.selling_price - COALESCE(c.total_cost / NULLIF(c.units_produced, 0), 0)) AS margin_amount,
  CASE
    WHEN p.selling_price > 0
    THEN ((p.selling_price - COALESCE(c.total_cost / NULLIF(c.units_produced, 0), 0)) / p.selling_price) * 100
    ELSE 0
  END AS margin_percent,
  pm.target_margin_percent,
  CASE
    WHEN pm.target_margin_percent IS NOT NULL
    THEN ((p.selling_price - COALESCE(c.total_cost / NULLIF(c.units_produced, 0), 0)) / p.selling_price) * 100 - pm.target_margin_percent
    ELSE NULL
  END AS variance_to_target,
  (p.selling_price - COALESCE(c.total_cost / NULLIF(c.units_produced, 0), 0)) * c.units_produced AS total_margin
FROM products p
LEFT JOIN product_costs c ON p.id = c.product_id
LEFT JOIN product_categories pc ON p.category_id = pc.id
LEFT JOIN product_margins pm ON p.id = pm.product_id AND pm.effective_date = (
  SELECT MAX(effective_date) FROM product_margins WHERE product_id = p.id AND effective_date <= CURRENT_DATE
)
WHERE p.org_id = :org_id
  AND (:category_id IS NULL OR p.category_id = :category_id)
  AND c.units_produced > 0 -- Only products actually produced
ORDER BY margin_percent DESC;
```

---

## Frontend Components

### MarginByProductPage
```tsx
// apps/frontend/app/(authenticated)/finance/margin-analysis/by-product/page.tsx
export default function MarginByProductPage() {
  const [filters, setFilters] = useState<MarginFilters>({
    dateFrom: subMonths(new Date(), 3),
    dateTo: new Date(),
  });

  const { data, isLoading } = useMarginByProduct(filters);

  return (
    <div className="space-y-6">
      <PageHeader title="Margin Analysis by Product" />

      <Card>
        <CardContent className="flex gap-4">
          <DateRangePicker value={filters} onChange={(range) => setFilters({ ...filters, ...range })} />
          <ProductCategoryFilter
            value={filters.productCategoryId}
            onChange={(id) => setFilters({ ...filters, productCategoryId: id })}
          />
          <Input
            type="number"
            placeholder="Min Margin %"
            onChange={(e) => setFilters({ ...filters, minMarginPercent: parseFloat(e.target.value) })}
          />
          <ExportButton reportType="margin_by_product" data={data} />
        </CardContent>
      </Card>

      <MarginSummaryCards summary={data?.summary} />

      <MarginByProductTable data={data?.products} />
    </div>
  );
}
```

### MarginByProductTable
```tsx
// apps/frontend/components/finance/margin/MarginByProductTable.tsx
export function MarginByProductTable({ data }: Props) {
  const columns: ColumnDef<ProductMargin>[] = [
    { accessorKey: 'sku', header: 'SKU' },
    { accessorKey: 'product_name', header: 'Product' },
    { accessorKey: 'product_family', header: 'Family' },
    { accessorKey: 'units_sold', header: 'Units Sold' },
    { accessorKey: 'selling_price', header: 'Price', cell: ({ value }) => formatCurrency(value) },
    { accessorKey: 'avg_unit_cost', header: 'Avg Cost', cell: ({ value }) => formatCurrency(value) },
    { accessorKey: 'margin_amount', header: 'Margin', cell: ({ value }) => formatCurrency(value) },
    {
      accessorKey: 'margin_percent',
      header: 'Margin %',
      cell: ({ row }) => {
        const margin = row.original.margin_percent;
        const target = row.original.target_margin_percent;
        const variant = margin >= target ? 'success' : margin >= target - 2 ? 'warning' : 'destructive';
        return <Badge variant={variant}>{margin.toFixed(2)}%</Badge>;
      },
    },
    { accessorKey: 'target_margin_percent', header: 'Target %', cell: ({ value }) => value ? `${value}%` : '-' },
    {
      accessorKey: 'variance_to_target',
      header: 'Variance',
      cell: ({ value }) => value !== null ? (
        <span className={value >= 0 ? 'text-green-600' : 'text-red-600'}>
          {value > 0 ? '+' : ''}{value.toFixed(2)}%
        </span>
      ) : '-',
    },
    { accessorKey: 'total_margin', header: 'Total Margin', cell: ({ value }) => formatCurrency(value) },
  ];

  return <DataTable columns={columns} data={data || []} />;
}
```

### MarginByFamilyPage
```tsx
// apps/frontend/app/(authenticated)/finance/margin-analysis/by-family/page.tsx
export default function MarginByFamilyPage() {
  const { data, isLoading } = useMarginByFamily(filters);

  return (
    <div className="space-y-6">
      <PageHeader title="Margin Analysis by Product Family" />

      <MarginFamilyComparisonChart data={data?.families} />

      <Card>
        <CardHeader><CardTitle>Product Family Margins</CardTitle></CardHeader>
        <CardContent>
          {data?.families.map(family => (
            <Accordion key={family.family_id} type="single" collapsible>
              <AccordionItem value={family.family_id}>
                <AccordionTrigger>
                  <div className="flex justify-between w-full pr-4">
                    <span className="font-semibold">{family.family_name}</span>
                    <div className="flex gap-4 text-sm">
                      <span>Revenue: {formatCurrency(family.total_revenue)}</span>
                      <Badge variant={family.family_margin_percent >= family.target_margin_percent ? 'success' : 'destructive'}>
                        Margin: {family.family_margin_percent.toFixed(2)}%
                      </Badge>
                    </div>
                  </div>
                </AccordionTrigger>
                <AccordionContent>
                  <MarginByProductTable data={family.products} />
                </AccordionContent>
              </AccordionItem>
            </Accordion>
          ))}
        </CardContent>
      </Card>
    </div>
  );
}
```

### MarginTrendsChart
```tsx
// apps/frontend/components/finance/margin/MarginTrendsChart.tsx
export function MarginTrendsChart({ productId }: Props) {
  const { data } = useMarginTrends(productId, filters);

  const chartData = data?.periods.map(p => ({
    date: format(new Date(p.period_start), 'MMM yyyy'),
    margin_percent: p.margin_percent,
    target: data.target_margin_percent,
  }));

  return (
    <Card>
      <CardHeader>
        <CardTitle>Margin Trend - {data?.product_name}</CardTitle>
        <CardDescription>
          Trend: <Badge>{data?.trend}</Badge>
        </CardDescription>
      </CardHeader>
      <CardContent>
        <ResponsiveContainer width="100%" height={300}>
          <LineChart data={chartData}>
            <CartesianGrid strokeDasharray="3 3" />
            <XAxis dataKey="date" />
            <YAxis label={{ value: 'Margin %', angle: -90, position: 'insideLeft' }} />
            <Tooltip />
            <Legend />
            <Line type="monotone" dataKey="margin_percent" stroke="#8884d8" strokeWidth={2} name="Actual Margin" />
            <Line type="monotone" dataKey="target" stroke="#82ca9d" strokeDasharray="5 5" name="Target Margin" />
          </LineChart>
        </ResponsiveContainer>
      </CardContent>
    </Card>
  );
}
```

### SetTargetMarginModal
```tsx
// apps/frontend/components/finance/margin/SetTargetMarginModal.tsx
export function SetTargetMarginModal({ productId, open, onClose }: Props) {
  const [targetData, setTargetData] = useState({
    target_margin_percent: 0,
    effective_date: new Date(),
    reason: '',
  });

  const handleSave = async () => {
    await MarginAnalysisService.setTargetMargin({ product_id: productId, ...targetData });
    toast.success('Target margin set');
    onClose();
  };

  return (
    <Dialog open={open} onOpenChange={onClose}>
      <DialogContent>
        <DialogHeader>
          <DialogTitle>Set Target Margin</DialogTitle>
        </DialogHeader>

        <div className="space-y-4">
          <div>
            <Label>Target Margin %</Label>
            <Input
              type="number"
              step="0.1"
              value={targetData.target_margin_percent}
              onChange={(e) => setTargetData({ ...targetData, target_margin_percent: parseFloat(e.target.value) })}
            />
          </div>

          <div>
            <Label>Effective Date</Label>
            <DatePicker
              value={targetData.effective_date}
              onChange={(date) => setTargetData({ ...targetData, effective_date: date })}
            />
          </div>

          <div>
            <Label>Reason (optional)</Label>
            <Textarea
              value={targetData.reason}
              onChange={(e) => setTargetData({ ...targetData, reason: e.target.value })}
              placeholder="Why is this target margin being set?"
            />
          </div>
        </div>

        <DialogFooter>
          <Button variant="outline" onClick={onClose}>Cancel</Button>
          <Button onClick={handleSave}>Save Target</Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}
```

---

## Dependencies

### Required Stories
- **02.1** - Products CRUD (products table, selling_price)
- **02.2** - Product Categories (product families)
- **09.6** - WO Cost Summary (work_order_costs table)
- **09.13** - Material Variance (cost variance data)
- **09.14** - Labor Variance (cost variance data)

---

## Testing Requirements

### Unit Tests
- Margin calculation formulas (gross margin, contribution margin)
- Variance to target calculation
- Margin trend direction calculation
- Alert threshold logic

### Integration Tests
- Margin by product report generation
- Margin by family report with drill-down
- Margin trend time series
- Target margin setting and alert triggering

### E2E Tests
1. **Margin by Product Report**:
   - Navigate to margin analysis page
   - Apply date range filter
   - Verify products sorted by margin %
   - Export to Excel → verify download

2. **Set Target Margin and Alert**:
   - Set target margin for product at 15%
   - Complete work order with 12% actual margin
   - Verify margin alert created
   - Acknowledge alert with notes

3. **Margin Trends**:
   - View margin trend for product
   - Verify trend chart displays correctly
   - Verify trend indicator (increasing/decreasing)

---

## Performance Requirements

- Margin calculation: <1 second per product
- Margin by product report: <3 seconds (1000 products)
- Margin trends: <2 seconds (12 months data)
- Export to Excel: <5 seconds

---

## Security & Permissions

Roles: finance_manager, cfo, product_manager (view margin reports)
Roles: finance_manager (set target margins)

---

## Story Metadata

**Estimated Effort:** 4-5 days
**Story Points:** 13
**Priority:** P2 (Phase 3)
**FR Coverage:** FR-9.7.1, FR-9.7.2, FR-9.7.3, FR-9.7.4, FR-9.7.5, FR-9.7.6, FR-9.7.7, FR-FIN-057
**Related Stories:** 09.6 (WO Cost Summary), 09.22 (Budget Management), 09.24 (Cost Dashboard)
