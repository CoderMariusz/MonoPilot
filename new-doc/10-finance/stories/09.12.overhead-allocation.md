# 09.12 - Overhead Allocation

**Priority**: P0 (Phase 2)
**Story Points**: L (Large)
**Type**: backend
**Phase**: 2 (Advanced Costing)
**Model**: OPUS

**State:** ready
**Estimate:** L (4-5 days)
**Primary PRD:** `docs/1-BASELINE/product/modules/finance.md` (FR-9.1.3, FR-9.3.3)
**Architecture:** `docs/1-BASELINE/architecture/modules/finance.md` (overhead_allocations)

---

## Goal

Implement overhead cost allocation system with configurable allocation bases (labor hours, machine hours, units produced). Support overhead rate definition per cost center, automatic overhead application to work orders, and overhead variance tracking (spending vs volume variance).

---

## User Story

As a **Finance Manager**, I want to **allocate overhead costs to work orders using configurable allocation bases** so that **I can accurately capture indirect costs and analyze overhead efficiency**.

As a **Cost Accountant**, I want to **track overhead variance (spending vs volume)** so that **I can identify overhead cost drivers and optimize resource utilization**.

---

## MVP Scope

**MVP Includes**:
- `overhead_rates` table (per cost center)
- `overhead_allocations` table (per work order)
- Allocation basis configuration (labor hours, machine hours, units)
- Overhead rate calculation
- Automatic overhead application to WO
- Overhead spending variance
- Overhead volume variance
- Integration with 09.6 WO cost summary
- Overhead variance report

**Deferred to Phase 3**:
- Activity-based costing (ABC)
- Multiple overhead pools per cost center
- Overhead budget forecasting
- Automated rate adjustment based on actuals

---

## Dependencies

| Dependency | Story/Epic | Type | Status |
|------------|------------|------|--------|
| 01.1 | Org Context | HARD | Ready |
| 03.10 | Work Orders | HARD | Ready |
| 04.3 | Operation Time Tracking | HARD | Ready |
| 09.1 | Finance Settings | HARD | Ready |
| 09.6 | WO Cost Summary | HARD | Ready |
| 09.10 | Cost Centers | HARD | Ready |

---

## Database Migration

```sql
-- Migration: create_overhead_allocation.sql

-- Overhead rates per cost center
CREATE TABLE overhead_rates (
    id                  UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id              UUID NOT NULL REFERENCES organizations(id),
    cost_center_id      UUID NOT NULL REFERENCES cost_centers(id),

    effective_from      DATE NOT NULL,
    effective_to        DATE,

    allocation_basis    TEXT NOT NULL CHECK (allocation_basis IN ('labor_hours', 'machine_hours', 'units_produced', 'direct_labor_cost')),
    rate                NUMERIC(15,4) NOT NULL CHECK (rate >= 0),
    currency_id         UUID NOT NULL REFERENCES currencies(id),

    budgeted_overhead   NUMERIC(15,2) NOT NULL DEFAULT 0,
    budgeted_activity   NUMERIC(15,2) NOT NULL DEFAULT 1 CHECK (budgeted_activity > 0),

    is_active           BOOLEAN NOT NULL DEFAULT true,

    created_by          UUID NOT NULL REFERENCES users(id),
    updated_by          UUID REFERENCES users(id),
    created_at          TIMESTAMPTZ NOT NULL DEFAULT now(),
    updated_at          TIMESTAMPTZ NOT NULL DEFAULT now(),

    CONSTRAINT chk_overhead_rate CHECK (rate = budgeted_overhead / budgeted_activity),
    CONSTRAINT chk_effective_dates CHECK (effective_to IS NULL OR effective_to >= effective_from)
);

CREATE INDEX idx_overhead_rates_org ON overhead_rates(org_id);
CREATE INDEX idx_overhead_rates_cost_center ON overhead_rates(cost_center_id);
CREATE INDEX idx_overhead_rates_effective ON overhead_rates(effective_from, effective_to);

ALTER TABLE overhead_rates ENABLE ROW LEVEL SECURITY;

CREATE POLICY "overhead_rates_select" ON overhead_rates
    FOR SELECT USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

CREATE POLICY "overhead_rates_insert" ON overhead_rates
    FOR INSERT WITH CHECK (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

CREATE POLICY "overhead_rates_update" ON overhead_rates
    FOR UPDATE USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

-- Overhead allocations per work order
CREATE TABLE overhead_allocations (
    id                  UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id              UUID NOT NULL REFERENCES organizations(id),
    work_order_id       UUID NOT NULL REFERENCES work_orders(id),
    cost_center_id      UUID NOT NULL REFERENCES cost_centers(id),
    overhead_rate_id    UUID REFERENCES overhead_rates(id),

    allocation_basis    TEXT NOT NULL,
    basis_quantity      NUMERIC(15,4) NOT NULL CHECK (basis_quantity >= 0),
    rate                NUMERIC(15,4) NOT NULL CHECK (rate >= 0),
    total_cost          NUMERIC(15,2) NOT NULL CHECK (total_cost >= 0),

    budgeted_overhead   NUMERIC(15,2) NOT NULL DEFAULT 0,
    applied_overhead    NUMERIC(15,2) NOT NULL DEFAULT 0,
    spending_variance   NUMERIC(15,2) NOT NULL DEFAULT 0,
    volume_variance     NUMERIC(15,2) NOT NULL DEFAULT 0,
    total_variance      NUMERIC(15,2) NOT NULL DEFAULT 0,

    currency_id         UUID NOT NULL REFERENCES currencies(id),
    allocation_date     DATE NOT NULL DEFAULT CURRENT_DATE,

    created_at          TIMESTAMPTZ NOT NULL DEFAULT now(),

    CONSTRAINT chk_overhead_total CHECK (total_cost = rate * basis_quantity),
    CONSTRAINT chk_overhead_variance CHECK (total_variance = spending_variance + volume_variance)
);

CREATE INDEX idx_overhead_allocations_org ON overhead_allocations(org_id);
CREATE INDEX idx_overhead_allocations_wo ON overhead_allocations(work_order_id);
CREATE INDEX idx_overhead_allocations_cc ON overhead_allocations(cost_center_id);
CREATE INDEX idx_overhead_allocations_date ON overhead_allocations(allocation_date);

ALTER TABLE overhead_allocations ENABLE ROW LEVEL SECURITY;

CREATE POLICY "overhead_allocations_select" ON overhead_allocations
    FOR SELECT USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

CREATE POLICY "overhead_allocations_insert" ON overhead_allocations
    FOR INSERT WITH CHECK (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

-- Function: Get active overhead rate
CREATE OR REPLACE FUNCTION get_active_overhead_rate(
    p_org_id UUID,
    p_cost_center_id UUID,
    p_effective_date DATE DEFAULT CURRENT_DATE
)
RETURNS overhead_rates AS $$
    SELECT *
    FROM overhead_rates
    WHERE org_id = p_org_id
    AND cost_center_id = p_cost_center_id
    AND is_active = true
    AND p_effective_date BETWEEN effective_from AND COALESCE(effective_to, '9999-12-31')
    ORDER BY effective_from DESC
    LIMIT 1;
$$ LANGUAGE sql;

-- Function: Calculate overhead for work order
CREATE OR REPLACE FUNCTION calculate_work_order_overhead(
    p_org_id UUID,
    p_work_order_id UUID
)
RETURNS TABLE (
    cost_center_id UUID,
    allocation_basis TEXT,
    basis_quantity NUMERIC,
    rate NUMERIC,
    total_overhead NUMERIC
) AS $$
DECLARE
    v_wo RECORD;
    v_overhead_rate RECORD;
    v_basis_quantity NUMERIC := 0;
    v_total_overhead NUMERIC := 0;
BEGIN
    -- Get work order details
    SELECT wo.*, cc.id AS cost_center_id
    INTO v_wo
    FROM work_orders wo
    LEFT JOIN cost_centers cc ON cc.production_line_id = wo.production_line_id
    WHERE wo.id = p_work_order_id
    AND wo.org_id = p_org_id;

    IF v_wo.cost_center_id IS NULL THEN
        RAISE EXCEPTION 'No cost center assigned to work order';
    END IF;

    -- Get active overhead rate
    SELECT * INTO v_overhead_rate
    FROM get_active_overhead_rate(p_org_id, v_wo.cost_center_id, v_wo.start_date);

    IF v_overhead_rate IS NULL THEN
        RAISE EXCEPTION 'No active overhead rate for cost center';
    END IF;

    -- Calculate basis quantity based on allocation method
    CASE v_overhead_rate.allocation_basis
        WHEN 'labor_hours' THEN
            SELECT COALESCE(SUM(hours_actual), 0) INTO v_basis_quantity
            FROM labor_costs
            WHERE work_order_id = p_work_order_id
            AND org_id = p_org_id;

        WHEN 'machine_hours' THEN
            SELECT COALESCE(SUM(machine_hours), 0) INTO v_basis_quantity
            FROM operation_labor
            WHERE work_order_id = p_work_order_id
            AND org_id = p_org_id;

        WHEN 'units_produced' THEN
            SELECT COALESCE(qty_good, 0) INTO v_basis_quantity
            FROM work_orders
            WHERE id = p_work_order_id
            AND org_id = p_org_id;

        WHEN 'direct_labor_cost' THEN
            SELECT COALESCE(SUM(total_cost), 0) INTO v_basis_quantity
            FROM labor_costs
            WHERE work_order_id = p_work_order_id
            AND org_id = p_org_id;

        ELSE
            RAISE EXCEPTION 'Unknown allocation basis: %', v_overhead_rate.allocation_basis;
    END CASE;

    v_total_overhead := v_basis_quantity * v_overhead_rate.rate;

    RETURN QUERY SELECT
        v_wo.cost_center_id,
        v_overhead_rate.allocation_basis,
        v_basis_quantity,
        v_overhead_rate.rate,
        v_total_overhead;
END;
$$ LANGUAGE plpgsql;

-- Function: Calculate overhead variance
CREATE OR REPLACE FUNCTION calculate_overhead_variance(
    p_org_id UUID,
    p_work_order_id UUID,
    p_actual_overhead NUMERIC,
    p_budgeted_overhead NUMERIC,
    p_applied_overhead NUMERIC
)
RETURNS TABLE (
    spending_variance NUMERIC,
    volume_variance NUMERIC,
    total_variance NUMERIC
) AS $$
DECLARE
    v_spending_variance NUMERIC;
    v_volume_variance NUMERIC;
    v_total_variance NUMERIC;
BEGIN
    -- Spending Variance = Actual Overhead - Budgeted Overhead
    v_spending_variance := p_actual_overhead - p_budgeted_overhead;

    -- Volume Variance = Budgeted Overhead - Applied Overhead
    v_volume_variance := p_budgeted_overhead - p_applied_overhead;

    -- Total Variance = Spending + Volume
    v_total_variance := v_spending_variance + v_volume_variance;

    RETURN QUERY SELECT v_spending_variance, v_volume_variance, v_total_variance;
END;
$$ LANGUAGE plpgsql;

-- Trigger: Auto-allocate overhead on WO completion
CREATE OR REPLACE FUNCTION trigger_allocate_overhead()
RETURNS TRIGGER AS $$
DECLARE
    v_overhead RECORD;
BEGIN
    IF NEW.status = 'completed' AND (OLD.status IS NULL OR OLD.status != 'completed') THEN
        SELECT * INTO v_overhead
        FROM calculate_work_order_overhead(NEW.org_id, NEW.id);

        INSERT INTO overhead_allocations (
            org_id, work_order_id, cost_center_id,
            allocation_basis, basis_quantity, rate, total_cost,
            applied_overhead, currency_id, allocation_date
        )
        VALUES (
            NEW.org_id, NEW.id, v_overhead.cost_center_id,
            v_overhead.allocation_basis, v_overhead.basis_quantity,
            v_overhead.rate, v_overhead.total_overhead,
            v_overhead.total_overhead,
            (SELECT id FROM currencies WHERE org_id = NEW.org_id AND is_base = true LIMIT 1),
            CURRENT_DATE
        );
    END IF;

    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER wo_overhead_allocation
    AFTER UPDATE ON work_orders
    FOR EACH ROW
    EXECUTE FUNCTION trigger_allocate_overhead();
```

---

## API Endpoints

### GET /api/finance/overhead-rates
List overhead rates.

**Query Params:**
- `cost_center_id` (optional)
- `is_active` (optional, default: true)

**Response:**
```json
{
  "data": [
    {
      "id": "uuid",
      "cost_center_id": "uuid",
      "cost_center_name": "Production Line 1",
      "allocation_basis": "labor_hours",
      "rate": 25.50,
      "budgeted_overhead": 51000,
      "budgeted_activity": 2000,
      "effective_from": "2026-01-01",
      "effective_to": null,
      "currency": "PLN"
    }
  ]
}
```

### POST /api/finance/overhead-rates
Create overhead rate.

**Request:**
```json
{
  "cost_center_id": "uuid",
  "allocation_basis": "labor_hours",
  "budgeted_overhead": 51000,
  "budgeted_activity": 2000,
  "effective_from": "2026-01-01"
}
```

### GET /api/finance/work-order-costs/:workOrderId/overhead
Get work order overhead allocation.

**Response:**
```json
{
  "work_order_id": "uuid",
  "allocations": [
    {
      "cost_center_id": "uuid",
      "cost_center_name": "Production Line 1",
      "allocation_basis": "labor_hours",
      "basis_quantity": 10.5,
      "rate": 25.50,
      "total_cost": 267.75,
      "spending_variance": 15.00,
      "volume_variance": -5.00,
      "total_variance": 10.00
    }
  ]
}
```

### GET /api/finance/reports/overhead-variance
Overhead variance report.

**Query Params:**
- `cost_center_id` (optional)
- `from_date`, `to_date`

**Response:**
```json
{
  "summary": {
    "total_budgeted": 51000,
    "total_applied": 48500,
    "total_actual": 52000,
    "spending_variance": 1000,
    "volume_variance": 2500,
    "total_variance": 3500
  },
  "by_cost_center": [...]
}
```

---

## Service Layer

### OverheadService

```typescript
export class OverheadService {
  static async getOverheadRates(filters?: {
    costCenterId?: string;
    isActive?: boolean;
  }) {
    const query = supabase
      .from('overhead_rates')
      .select('*, cost_centers(name), currencies(code)')
      .order('effective_from', { ascending: false });

    if (filters?.costCenterId) {
      query.eq('cost_center_id', filters.costCenterId);
    }
    if (filters?.isActive !== undefined) {
      query.eq('is_active', filters.isActive);
    }

    const { data, error } = await query;
    if (error) throw error;
    return data;
  }

  static async createOverheadRate(rate: CreateOverheadRateInput) {
    // Calculate rate from budget
    const calculatedRate = rate.budgetedOverhead / rate.budgetedActivity;

    const { data, error } = await supabase
      .from('overhead_rates')
      .insert({
        ...rate,
        rate: calculatedRate,
        org_id: getOrgId(),
        created_by: getUserId()
      })
      .select()
      .single();

    if (error) throw error;
    return data;
  }

  static async calculateWorkOrderOverhead(workOrderId: string) {
    const { data, error } = await supabase.rpc(
      'calculate_work_order_overhead',
      {
        p_org_id: getOrgId(),
        p_work_order_id: workOrderId
      }
    );

    if (error) throw error;
    return data;
  }

  static async getWorkOrderOverheadAllocation(workOrderId: string) {
    const { data, error } = await supabase
      .from('overhead_allocations')
      .select('*, cost_centers(name, code)')
      .eq('work_order_id', workOrderId)
      .single();

    if (error) throw error;
    return data;
  }

  static async getOverheadVarianceReport(filters: {
    costCenterId?: string;
    fromDate: Date;
    toDate: Date;
  }) {
    const response = await fetch(
      `/api/finance/reports/overhead-variance?${new URLSearchParams({
        cost_center_id: filters.costCenterId || '',
        from_date: filters.fromDate.toISOString(),
        to_date: filters.toDate.toISOString()
      })}`
    );

    if (!response.ok) throw new Error('Failed to fetch overhead variance');
    return response.json();
  }
}
```

---

## Acceptance Criteria

### AC-1: Overhead Rate Definition
```gherkin
Given cost center "Production Line 1"
And budgeted overhead = 51,000 PLN
And budgeted activity = 2,000 labor hours
When creating overhead rate
Then rate = 51,000 / 2,000 = 25.50 PLN/hour
And allocation_basis = "labor_hours"
```

### AC-2: Automatic Overhead Allocation
```gherkin
Given work order on "Production Line 1"
And actual labor hours = 10.5
And overhead rate = 25.50 PLN/hour
When work order status changes to "completed"
Then overhead_allocation created:
  | basis_quantity | 10.5 |
  | rate | 25.50 |
  | total_cost | 267.75 |
And work_order_costs.overhead_cost_actual = 267.75
```

### AC-3: Overhead Spending Variance
```gherkin
Given budgeted overhead = 51,000 PLN
And actual overhead incurred = 52,000 PLN
When calculating spending variance
Then spending_variance = 52,000 - 51,000 = 1,000 (unfavorable)
```

### AC-4: Overhead Volume Variance
```gherkin
Given budgeted overhead = 51,000 PLN
And budgeted activity = 2,000 hours
And actual activity = 1,900 hours
And overhead rate = 25.50 PLN/hour
When calculating volume variance
Then applied_overhead = 1,900 Ã— 25.50 = 48,450
And volume_variance = 51,000 - 48,450 = 2,550 (unfavorable)
```

---

## Performance Requirements

- Overhead rate lookup: < 50ms
- Overhead calculation: < 200ms
- Overhead variance report (1 month): < 1s
- Auto-allocation trigger: < 300ms

---

## Testing

### Unit Tests
- Overhead rate calculation
- Allocation basis quantity calculation
- Spending variance formula
- Volume variance formula
- Rate effective date logic

### Integration Tests
- Auto-allocation on WO completion
- Multi-cost center overhead
- Variance report generation

### Edge Cases
- Zero budgeted activity (should error)
- Negative overhead (should error)
- Missing overhead rate
- Multiple rates for same cost center (effective dates)

---

## Deliverables

- [ ] `overhead_rates` table
- [ ] `overhead_allocations` table
- [ ] `get_active_overhead_rate()` function
- [ ] `calculate_work_order_overhead()` function
- [ ] `calculate_overhead_variance()` function
- [ ] Auto-allocation trigger on WO completion
- [ ] API: Overhead rate CRUD
- [ ] API: WO overhead allocation
- [ ] API: Overhead variance report
- [ ] OverheadService with 5 methods
- [ ] Tests: Unit, integration, edge cases

---

## Definition of Done

- [ ] Overhead rates configurable per cost center
- [ ] Auto-allocation works on WO completion
- [ ] Spending variance calculated correctly
- [ ] Volume variance calculated correctly
- [ ] Variance report generates < 1s
- [ ] All allocation bases supported (labor, machine, units, cost)
- [ ] Tests pass (unit, integration, edge cases)
- [ ] Performance benchmarks met
- [ ] Documentation updated

---

**Created**: 2026-01-15 | **Complexity**: L (4-5 days) | **Phase**: 2
