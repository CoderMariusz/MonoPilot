# 09.9 - Tax Code Integration

**Priority**: P0 (MVP)
**Story Points**: S (Small)
**Type**: backend
**Phase**: 1 (Foundation)
**Model**: SONNET

**State:** ready
**Estimate:** S (1-2 days)
**Primary PRD:** `docs/1-BASELINE/product/modules/finance.md` (FR-9.9.1-3)
**Architecture:** Reuse `tax_codes` table from Epic 01

---

## Goal

Reuse Epic 01 tax_codes table, configure Polish VAT rates (23%, 8%, 5%, 0%), enable tax code assignment to products, and integrate tax calculation (preparation for invoicing). This ensures VAT compliance for Polish food manufacturing.

---

## User Story

As a **Finance Manager**, I want to **assign appropriate VAT tax codes to products and materials** so that **VAT is calculated correctly for financial reporting and Comarch Optima export**.

---

## Scope

**In scope**
- Reuse existing `tax_codes` table from Epic 01
- Seed Polish VAT rates (23%, 8%, 5%, 0%)
- Add tax_code_id to products table (migration)
- GET /api/finance/tax-codes (list tax codes)
- Tax code assignment UI in product form
- Tax calculation utility function
- Integration with product CRUD (Epic 02)

**Out of scope**
- Tax reporting (Phase 2)
- Tax rate history (Phase 2)
- Tax calculation on invoices (Phase 3)
- Multi-country tax support (Phase 3)

---

## Dependencies

### Cross-Epic Dependencies

| Dependency | Story/Epic | Type | What It Provides | Status |
|------------|------------|------|------------------|--------|
| 01.1 | Org Context + RLS | HARD | tax_codes table | Ready |
| 02.1 | Products CRUD | HARD | products table | Ready |

---

## Database Migration

```sql
-- Migration: YYYYMMDDHHMMSS_add_tax_code_to_products.sql

-- Add tax_code_id to products table
ALTER TABLE products
ADD COLUMN tax_code_id UUID REFERENCES tax_codes(id);

CREATE INDEX idx_products_tax_code ON products(tax_code_id) WHERE tax_code_id IS NOT NULL;

-- Seed Polish VAT rates
INSERT INTO tax_codes (org_id, code, name, rate_percent, country_code, category, is_active)
SELECT
    org.id,
    'VAT23',
    'VAT 23% - Standard Rate',
    23.00,
    'PL',
    'vat',
    TRUE
FROM organizations org
WHERE org.country = 'PL'
ON CONFLICT DO NOTHING;

INSERT INTO tax_codes (org_id, code, name, rate_percent, country_code, category, is_active)
SELECT
    org.id,
    'VAT8',
    'VAT 8% - Reduced Rate 1 (Most Food)',
    8.00,
    'PL',
    'vat',
    TRUE
FROM organizations org
WHERE org.country = 'PL'
ON CONFLICT DO NOTHING;

INSERT INTO tax_codes (org_id, code, name, rate_percent, country_code, category, is_active)
SELECT
    org.id,
    'VAT5',
    'VAT 5% - Reduced Rate 2 (Specific Food)',
    5.00,
    'PL',
    'vat',
    TRUE
FROM organizations org
WHERE org.country = 'PL'
ON CONFLICT DO NOTHING;

INSERT INTO tax_codes (org_id, code, name, rate_percent, country_code, category, is_active)
SELECT
    org.id,
    'VAT0',
    'VAT 0% - Zero Rate (Exports)',
    0.00,
    'PL',
    'vat',
    TRUE
FROM organizations org
WHERE org.country = 'PL'
ON CONFLICT DO NOTHING;

-- Function: Calculate tax amount
CREATE OR REPLACE FUNCTION calculate_tax_amount(
    p_base_amount DECIMAL,
    p_tax_code_id UUID
)
RETURNS DECIMAL AS $$
DECLARE
    v_tax_rate DECIMAL;
    v_tax_amount DECIMAL;
BEGIN
    -- Get tax rate
    SELECT rate_percent INTO v_tax_rate
    FROM tax_codes
    WHERE id = p_tax_code_id
      AND is_active = TRUE;

    IF NOT FOUND THEN
        RETURN 0.00;
    END IF;

    -- Calculate tax
    v_tax_amount := p_base_amount * (v_tax_rate / 100.0);

    RETURN ROUND(v_tax_amount, 2);
END;
$$ LANGUAGE plpgsql;
```

---

## Acceptance Criteria

### AC-1: Tax Code Assignment

```gherkin
Scenario: Assign tax code to product
  Given product "Bread" exists
  When assigning tax code "VAT8"
  Then products.tax_code_id = VAT8 code ID
  And tax code displays on product detail

Scenario: Product form shows tax code selector
  Given user creating/editing product
  Then tax code dropdown displays active tax codes
  And shows: "VAT8 - VAT 8% - Reduced Rate 1 (Most Food)"
```

### AC-2: Tax Calculation

```gherkin
Scenario: Calculate VAT on amount
  Given base amount = 100 PLN
  And tax code = VAT8 (8%)
  When calculate_tax_amount() called
  Then tax_amount = 8.00 PLN
  And gross_amount = 108.00 PLN
```

---

## Key Business Rules

1. **Default Tax Code**: Polish food products default to VAT8 (8%)
2. **Tax Code Required**: Products must have tax code assigned for financial export
3. **Active Codes Only**: Only active tax codes selectable
4. **Rate Immutability**: Tax rate changes create new tax code (historical rates preserved)

---

## Deliverables

- [ ] Migration: Add tax_code_id to products
- [ ] Migration: Seed Polish VAT rates
- [ ] Function: calculate_tax_amount()
- [ ] API: GET /api/finance/tax-codes
- [ ] Component: Tax code selector in product form
- [ ] Tests: Unit, integration

---

**Document Status**: Ready for Implementation
**Created**: 2025-01-15
**Complexity**: S (Small)
**Phase**: 1 (Foundation)
