# 09.2 - Standard Cost Definition

**Priority**: P0 (MVP)
**Story Points**: M (Medium)
**Type**: fullstack
**Phase**: 1 (Foundation)
**Model**: OPUS

**State:** ready
**Estimate:** M (3-4 days)
**Primary PRD:** `docs/1-BASELINE/product/modules/finance.md` (FR-9.1.4 Standard Cost Definition)
**Architecture:** `docs/1-BASELINE/architecture/modules/finance.md` (standard_costs table)

---

## Goal

Implement standard cost definition and management for products and materials, enabling organizations to define expected costs (material, labor, overhead) with effective date ranges, approval workflow, and cost history tracking. Standard costs serve as the baseline for variance analysis and provide stability for cost planning.

---

## Finance Compliance Context

This story is **critical for cost accounting compliance**:

- [x] **GAAP/IFRS Compliance** - Standard costing is accepted accounting method
- [x] **Cost Accounting Standards** - Pre-determined costs for planning and variance analysis
- [x] **Audit Trail Required** - All standard cost changes logged with approval workflow
- [x] **Effective Dating** - Historical cost tracking for period-correct reporting

**Regulatory Context:**
- Standard costs must be reviewed and updated annually (minimum)
- Cost changes require approval by authorized personnel
- Effective dates prevent backdating cost changes
- Historical costs retained for audit and variance analysis
- Multi-currency support for international materials

---

## MVP Scope

This story implements Phase 1 (Foundation) functionality for standard cost definition.

**MVP Includes**:
- `standard_costs` table with effective date ranges
- `currencies` table (PLN, EUR, USD)
- `tax_codes` table (Polish VAT rates)
- Standard cost CRUD for products and materials
- Cost breakdown (material, labor, overhead, total)
- Effective date management
- Currency support (PLN default)
- Approval workflow (draft → approved → active)
- Cost history view (show all versions)
- Standard cost API endpoints
- Standard cost management UI
- Cost approval interface
- RLS enforcement for multi-tenancy

**Deferred to Phase 2+**:
- Cost update approval workflow automation (story 9.15)
- Multi-level cost rollup from BOM (story 9.9)
- Cost simulation (story 9.9)
- Bulk cost import/export
- Cost change impact analysis
- Automated cost update reminders

---

## User Story

As a **Finance Manager**, I want to **define and maintain standard costs for products and materials with effective date ranges** so that **I can establish cost baselines for variance analysis and ensure accurate cost planning**.

As a **Cost Accountant**, I want to **approve standard cost changes and view cost history** so that **cost updates are controlled and historical costs are available for reporting**.

---

## Scope

**In scope (this story)**
- `standard_costs` table creation
- `currencies` table creation
- `tax_codes` table creation
- POST /api/finance/standard-costs (create standard cost)
- GET /api/finance/standard-costs (list with filters)
- GET /api/finance/standard-costs/:id (get detail)
- PUT /api/finance/standard-costs/:id (update draft)
- DELETE /api/finance/standard-costs/:id (delete draft)
- POST /api/finance/standard-costs/:id/approve (approve cost)
- GET /api/finance/standard-costs/by-product/:productId (get product costs)
- GET /api/finance/standard-costs/:id/history (get cost history)
- Standard cost form UI
- Cost approval interface
- Cost history view
- Currency management (basic CRUD)
- Tax code management (Polish VAT)
- Validation and business rules
- Audit logging

**Out of scope (this story)**
- BOM cost rollup calculation (story 09.5)
- Work order cost variance (story 09.3, 09.4)
- Cost simulation and comparison (Phase 2)
- Exchange rate management (Phase 2)
- Multi-site cost differences (Phase 2)
- Cost approval workflow automation (Phase 2)

---

## Dependencies

### Cross-Epic Dependencies

| Dependency | Story/Epic | Type | What It Provides | Status |
|------------|------------|------|------------------|--------|
| 01.1 | Org Context + RLS | HARD | organizations, users, roles tables | Ready |
| 02.1 | Products CRUD | HARD | products table for product reference | Ready |

### Within Epic Dependencies

| Dependency | Story | Type | What It Provides |
|------------|-------|------|------------------|
| 09.1 | Finance Settings | HARD | finance_settings, base_currency_id | Ready |

### Provides To (Downstream)

| Story | What This Provides |
|-------|-------------------|
| 09.3 | Material Cost Tracking - standard material costs |
| 09.4 | Labor Cost Tracking - standard labor costs |
| 09.5 | BOM Costing - standard costs for BOM components |
| Phase 2 | Cost variance calculation baseline |

---

## Database Migration

### Migration: Create currencies and tax_codes tables

```sql
-- Migration: YYYYMMDDHHMMSS_create_currencies_and_tax_codes.sql

-- =============================================================================
-- Currencies Table
-- =============================================================================

CREATE TABLE currencies (
    id                  UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id              UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    code                TEXT NOT NULL,
    name                TEXT NOT NULL,
    symbol              TEXT NOT NULL,
    is_base             BOOLEAN NOT NULL DEFAULT false,
    is_active           BOOLEAN NOT NULL DEFAULT true,
    exchange_rate       NUMERIC(12,6) DEFAULT 1.000000,
    created_at          TIMESTAMPTZ NOT NULL DEFAULT now(),
    updated_at          TIMESTAMPTZ NOT NULL DEFAULT now(),

    CONSTRAINT uq_currency_code UNIQUE (org_id, code),
    CONSTRAINT chk_exchange_rate CHECK (exchange_rate > 0)
);

CREATE INDEX idx_currencies_org ON currencies(org_id);
CREATE INDEX idx_currencies_base ON currencies(org_id, is_base) WHERE is_base = true;

ALTER TABLE currencies ENABLE ROW LEVEL SECURITY;

CREATE POLICY "currencies_select" ON currencies
    FOR SELECT USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

CREATE POLICY "currencies_insert" ON currencies
    FOR INSERT WITH CHECK (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
        AND (SELECT role FROM users WHERE id = auth.uid()) IN ('admin', 'finance_manager')
    );

CREATE POLICY "currencies_update" ON currencies
    FOR UPDATE USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
        AND (SELECT role FROM users WHERE id = auth.uid()) IN ('admin', 'finance_manager')
    );

CREATE TRIGGER update_currencies_updated_at
    BEFORE UPDATE ON currencies
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- =============================================================================
-- Tax Codes Table
-- =============================================================================

CREATE TABLE tax_codes (
    id                  UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id              UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    code                TEXT NOT NULL,
    name                TEXT NOT NULL,
    rate_percent        NUMERIC(5,2) NOT NULL,
    country_code        TEXT NOT NULL DEFAULT 'PL',
    category            TEXT NOT NULL DEFAULT 'vat'
                        CHECK (category IN ('vat', 'exempt', 'zero_rated')),
    effective_from      DATE NOT NULL,
    effective_to        DATE,
    is_active           BOOLEAN NOT NULL DEFAULT true,
    created_at          TIMESTAMPTZ NOT NULL DEFAULT now(),
    updated_at          TIMESTAMPTZ NOT NULL DEFAULT now(),

    CONSTRAINT uq_tax_code UNIQUE (org_id, code),
    CONSTRAINT chk_tax_rate CHECK (rate_percent >= 0 AND rate_percent <= 100),
    CONSTRAINT chk_effective_dates CHECK (effective_to IS NULL OR effective_to >= effective_from)
);

CREATE INDEX idx_tax_codes_org ON tax_codes(org_id);
CREATE INDEX idx_tax_codes_active ON tax_codes(org_id, is_active) WHERE is_active = true;

ALTER TABLE tax_codes ENABLE ROW LEVEL SECURITY;

CREATE POLICY "tax_codes_select" ON tax_codes
    FOR SELECT USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

CREATE POLICY "tax_codes_insert" ON tax_codes
    FOR INSERT WITH CHECK (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
        AND (SELECT role FROM users WHERE id = auth.uid()) IN ('admin', 'finance_manager')
    );

CREATE POLICY "tax_codes_update" ON tax_codes
    FOR UPDATE USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
        AND (SELECT role FROM users WHERE id = auth.uid()) IN ('admin', 'finance_manager')
    );

CREATE TRIGGER update_tax_codes_updated_at
    BEFORE UPDATE ON tax_codes
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- =============================================================================
-- Standard Costs Table
-- =============================================================================

CREATE TABLE standard_costs (
    id                  UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id              UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,

    -- Item Reference (product or material)
    item_id             UUID NOT NULL REFERENCES products(id),
    item_type           TEXT NOT NULL DEFAULT 'product'
                        CHECK (item_type IN ('product', 'material')),

    -- Effective Dating
    effective_from      DATE NOT NULL,
    effective_to        DATE,

    -- Cost Components
    material_cost       NUMERIC(15,4) NOT NULL DEFAULT 0,
    labor_cost          NUMERIC(15,4) NOT NULL DEFAULT 0,
    overhead_cost       NUMERIC(15,4) NOT NULL DEFAULT 0,
    total_cost          NUMERIC(15,4) NOT NULL DEFAULT 0,

    -- Currency and UOM
    currency_id         UUID NOT NULL REFERENCES currencies(id),
    uom                 TEXT NOT NULL,
    cost_basis          TEXT NOT NULL DEFAULT 'per_unit'
                        CHECK (cost_basis IN ('per_unit', 'per_batch', 'per_kg', 'per_liter')),

    -- Status and Approval
    status              TEXT NOT NULL DEFAULT 'draft'
                        CHECK (status IN ('draft', 'approved', 'active', 'superseded')),
    approved_by         UUID REFERENCES users(id),
    approved_at         TIMESTAMPTZ,

    -- Notes
    notes               TEXT,

    -- Audit
    created_at          TIMESTAMPTZ NOT NULL DEFAULT now(),
    created_by          UUID REFERENCES users(id),
    updated_at          TIMESTAMPTZ NOT NULL DEFAULT now(),
    updated_by          UUID REFERENCES users(id),

    -- Constraints
    CONSTRAINT chk_effective_dates CHECK (effective_to IS NULL OR effective_to >= effective_from),
    CONSTRAINT chk_total_cost CHECK (total_cost = material_cost + labor_cost + overhead_cost),
    CONSTRAINT chk_no_overlap_dates EXCLUDE USING gist (
        org_id WITH =,
        item_id WITH =,
        daterange(effective_from, COALESCE(effective_to, 'infinity'::date), '[]') WITH &&
    ) WHERE (status IN ('approved', 'active'))
);

CREATE INDEX idx_standard_costs_org ON standard_costs(org_id);
CREATE INDEX idx_standard_costs_item ON standard_costs(item_id);
CREATE INDEX idx_standard_costs_org_item ON standard_costs(org_id, item_id);
CREATE INDEX idx_standard_costs_status ON standard_costs(org_id, status);
CREATE INDEX idx_standard_costs_active ON standard_costs(org_id, item_id, effective_from)
    WHERE status = 'active';
CREATE INDEX idx_standard_costs_effective ON standard_costs(item_id, effective_from, effective_to)
    WHERE status IN ('approved', 'active');

ALTER TABLE standard_costs ENABLE ROW LEVEL SECURITY;

CREATE POLICY "standard_costs_select" ON standard_costs
    FOR SELECT USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

CREATE POLICY "standard_costs_insert" ON standard_costs
    FOR INSERT WITH CHECK (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
        AND (SELECT role FROM users WHERE id = auth.uid()) IN ('admin', 'finance_manager', 'cost_accountant')
    );

CREATE POLICY "standard_costs_update" ON standard_costs
    FOR UPDATE USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
        AND (SELECT role FROM users WHERE id = auth.uid()) IN ('admin', 'finance_manager', 'cost_accountant')
    );

CREATE POLICY "standard_costs_delete" ON standard_costs
    FOR DELETE USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
        AND status = 'draft' -- Only drafts can be deleted
        AND (SELECT role FROM users WHERE id = auth.uid()) IN ('admin', 'finance_manager', 'cost_accountant')
    );

CREATE TRIGGER update_standard_costs_updated_at
    BEFORE UPDATE ON standard_costs
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- =============================================================================
-- Function: Calculate total cost
-- =============================================================================

CREATE OR REPLACE FUNCTION calculate_standard_cost_total()
RETURNS TRIGGER AS $$
BEGIN
    NEW.total_cost := NEW.material_cost + NEW.labor_cost + NEW.overhead_cost;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER calculate_total_before_insert_update
    BEFORE INSERT OR UPDATE ON standard_costs
    FOR EACH ROW
    EXECUTE FUNCTION calculate_standard_cost_total();

-- =============================================================================
-- Function: Supersede old active costs when new cost activated
-- =============================================================================

CREATE OR REPLACE FUNCTION supersede_old_standard_costs()
RETURNS TRIGGER AS $$
BEGIN
    IF NEW.status = 'active' AND (OLD.status IS NULL OR OLD.status != 'active') THEN
        -- Supersede any other active costs for same item
        UPDATE standard_costs
        SET status = 'superseded',
            effective_to = NEW.effective_from - INTERVAL '1 day',
            updated_at = NOW()
        WHERE org_id = NEW.org_id
          AND item_id = NEW.item_id
          AND id != NEW.id
          AND status = 'active';
    END IF;

    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER supersede_costs_on_activate
    AFTER INSERT OR UPDATE ON standard_costs
    FOR EACH ROW
    EXECUTE FUNCTION supersede_old_standard_costs();

-- =============================================================================
-- Function: Get active standard cost for item at date
-- =============================================================================

CREATE OR REPLACE FUNCTION get_active_standard_cost(
    p_org_id UUID,
    p_item_id UUID,
    p_effective_date DATE DEFAULT CURRENT_DATE
)
RETURNS TABLE (
    id UUID,
    material_cost NUMERIC,
    labor_cost NUMERIC,
    overhead_cost NUMERIC,
    total_cost NUMERIC,
    currency_id UUID,
    uom TEXT,
    cost_basis TEXT
) AS $$
BEGIN
    RETURN QUERY
    SELECT
        sc.id,
        sc.material_cost,
        sc.labor_cost,
        sc.overhead_cost,
        sc.total_cost,
        sc.currency_id,
        sc.uom,
        sc.cost_basis
    FROM standard_costs sc
    WHERE sc.org_id = p_org_id
      AND sc.item_id = p_item_id
      AND sc.status = 'active'
      AND sc.effective_from <= p_effective_date
      AND (sc.effective_to IS NULL OR sc.effective_to >= p_effective_date)
    ORDER BY sc.effective_from DESC
    LIMIT 1;
END;
$$ LANGUAGE plpgsql;
```

---

## Acceptance Criteria (Given/When/Then)

### AC-1: Standard Costs Table Creation

```gherkin
Scenario: standard_costs table exists with all required columns
  Given database migration runs
  When schema is inspected
  Then standard_costs table has all columns from schema
  And CHECK constraint validates status IN ('draft', 'approved', 'active', 'superseded')
  And CHECK constraint validates total_cost = sum of components
  And EXCLUDE constraint prevents overlapping date ranges for active costs
  And FK constraints exist for item_id, currency_id, approved_by
  And RLS policies enforce org isolation
```

### AC-2: Create Standard Cost

```gherkin
Scenario: Create standard cost for product
  Given user is Finance Manager
  And product "Chocolate Bar 100g" exists
  And PLN currency exists
  When user creates standard cost with:
    | Field | Value |
    | item_id | Chocolate Bar uuid |
    | item_type | product |
    | effective_from | 2025-01-01 |
    | material_cost | 2.50 |
    | labor_cost | 0.40 |
    | overhead_cost | 0.60 |
    | currency_id | PLN uuid |
    | uom | pcs |
    | cost_basis | per_unit |
  Then standard cost created with status = 'draft'
  And total_cost calculated as 3.50 (sum of components)
  And created_by set to current user
  And success message "Standard cost created successfully"

Scenario: Total cost auto-calculated
  Given creating standard cost with:
    | material_cost | 10.00 |
    | labor_cost | 5.00 |
    | overhead_cost | 3.00 |
  When saving
  Then total_cost = 18.00 automatically
  And no manual total_cost input required

Scenario: Cannot create without required fields
  Given user is Finance Manager
  When creating standard cost without item_id
  Then validation error "Product/material is required"
  When creating without effective_from
  Then validation error "Effective from date is required"
  When creating without currency_id
  Then validation error "Currency is required"
```

### AC-3: Standard Cost Approval Workflow

```gherkin
Scenario: Approve draft standard cost
  Given standard cost exists with status = 'draft'
  And user is Finance Manager
  When user clicks [Approve]
  Then status changes to 'approved'
  And approved_by set to current user
  And approved_at set to now
  And success message "Standard cost approved"

Scenario: Activate approved standard cost
  Given standard cost exists with status = 'approved'
  And effective_from = today
  When user clicks [Activate]
  Then status changes to 'active'
  And any previous active cost for same item superseded
  And previous cost effective_to set to (new effective_from - 1 day)

Scenario: Cannot approve without Finance Manager role
  Given user is Cost Accountant
  And standard cost status = 'draft'
  When attempting to approve
  Then error "Only Finance Manager can approve standard costs"

Scenario: Cannot activate cost with future effective date
  Given approved cost with effective_from = 2025-06-01
  And today is 2025-01-15
  When attempting to activate
  Then warning "Effective date is in the future. Activate now or schedule?"
  And options: [Activate Now] [Schedule for 2025-06-01] [Cancel]
```

### AC-4: Standard Cost History

```gherkin
Scenario: View cost history for product
  Given product has 3 standard costs:
    | Effective From | Effective To | Status | Total Cost |
    | 2024-01-01 | 2024-06-30 | superseded | 3.00 |
    | 2024-07-01 | 2024-12-31 | superseded | 3.25 |
    | 2025-01-01 | NULL | active | 3.50 |
  When user views cost history
  Then all 3 costs displayed in chronological order
  And active cost highlighted
  And effective date ranges shown
  And total cost trend visualized

Scenario: Compare cost versions
  Given viewing cost history
  When selecting two cost versions
  Then comparison view shows:
    | Component | Old Value | New Value | Change |
    | Material | 2.50 | 2.65 | +0.15 (+6%) |
    | Labor | 0.40 | 0.40 | 0 |
    | Overhead | 0.60 | 0.72 | +0.12 (+20%) |
    | Total | 3.50 | 3.77 | +0.27 (+7.7%) |
```

### AC-5: Update Standard Cost

```gherkin
Scenario: Update draft standard cost
  Given standard cost with status = 'draft'
  And user is Finance Manager
  When updating material_cost from 2.50 to 2.75
  Then cost updated successfully
  And total_cost recalculated (2.75 + 0.40 + 0.60 = 3.75)
  And updated_by set to current user

Scenario: Cannot update approved/active cost
  Given standard cost with status = 'approved'
  When attempting to update
  Then error "Cannot modify approved cost. Create new version instead."
  And [Create New Version] button shown

Scenario: Create new version from active cost
  Given active standard cost for product
  When user clicks [Create New Version]
  Then new draft cost created with:
    | Field | Value |
    | Copied from active cost | All fields |
    | effective_from | Next period start |
    | status | draft |
  And user can modify before approving
```

### AC-6: Delete Standard Cost

```gherkin
Scenario: Delete draft standard cost
  Given standard cost with status = 'draft'
  And user is Finance Manager
  When user clicks [Delete]
  Then confirmation dialog "Delete draft standard cost for [Product Name]?"
  And if confirmed, cost deleted
  And success message "Standard cost deleted"

Scenario: Cannot delete approved/active cost
  Given standard cost with status = 'approved'
  When attempting to delete
  Then [Delete] button disabled
  And tooltip "Cannot delete approved or active costs"
```

### AC-7: Get Standard Cost for Product

```gherkin
Scenario: Get active standard cost for product
  Given product has active standard cost
  When requesting GET /api/finance/standard-costs/by-product/{productId}
  Then response contains:
    | Field | Description |
    | id | Standard cost uuid |
    | material_cost | Material cost component |
    | labor_cost | Labor cost component |
    | overhead_cost | Overhead cost component |
    | total_cost | Total standard cost |
    | currency_code | Currency code (PLN) |
    | effective_from | Effective start date |
    | status | active |

Scenario: Get historical cost for specific date
  Given product has cost history
  When requesting with query param ?effective_date=2024-06-15
  Then cost active on 2024-06-15 returned

Scenario: No active cost exists
  Given product has no active standard cost
  When requesting current cost
  Then 404 Not Found
  And message "No active standard cost defined for this product"
```

### AC-8: Prevent Overlapping Active Costs

```gherkin
Scenario: Cannot create overlapping active costs
  Given active cost for product with:
    | effective_from | 2025-01-01 |
    | effective_to | 2025-12-31 |
  When creating another active cost with:
    | effective_from | 2025-06-01 |
    | effective_to | NULL |
  Then database constraint violation
  And error "Active cost dates overlap with existing cost"

Scenario: Can create overlapping drafts
  Given draft cost for product with effective_from = 2025-01-01
  When creating another draft with same date
  Then creation succeeds
  And both remain in draft status
  And only one can be activated
```

### AC-9: Currency Management

```gherkin
Scenario: Create PLN currency
  Given user is Finance Manager
  When creating currency with:
    | code | PLN |
    | name | Polish Zloty |
    | symbol | zł |
    | is_base | true |
    | exchange_rate | 1.000000 |
  Then currency created successfully
  And set as base currency for org

Scenario: Create EUR currency
  When creating currency with:
    | code | EUR |
    | name | Euro |
    | symbol | € |
    | is_base | false |
    | exchange_rate | 4.250000 |
  Then currency created
  And exchange_rate represents PLN per EUR

Scenario: Only one base currency per org
  Given PLN is base currency
  When attempting to set EUR as base
  Then warning "This will change base currency from PLN to EUR. Continue?"
  And if confirmed, PLN.is_base = false, EUR.is_base = true
```

### AC-10: Tax Code Management (Polish VAT)

```gherkin
Scenario: Create Polish VAT tax codes
  Given user is Finance Manager
  When creating tax codes:
    | Code | Name | Rate | Category |
    | VAT-23 | Polish VAT Standard | 23.00 | vat |
    | VAT-8 | Polish VAT Reduced Food | 8.00 | vat |
    | VAT-5 | Polish VAT Super Reduced | 5.00 | vat |
    | VAT-0 | Polish VAT Zero | 0.00 | zero_rated |
    | VAT-EX | VAT Exempt | 0.00 | exempt |
  Then all tax codes created successfully
  And effective_from set to creation date

Scenario: Tax rate must be 0-100%
  When creating tax code with rate_percent = 150
  Then validation error "Tax rate must be between 0 and 100"
```

### AC-11: Standard Cost List and Filters

```gherkin
Scenario: List all standard costs
  Given organization has 50 standard costs
  When user requests GET /api/finance/standard-costs
  Then response contains paginated list
  And default sorted by product name
  And includes product name, total cost, status, effective dates

Scenario: Filter by status
  When filtering by status = 'active'
  Then only active costs returned

Scenario: Filter by product
  When filtering by product_id
  Then only costs for that product returned

Scenario: Filter by effective date range
  When filtering by effective_from >= 2025-01-01
  Then only costs effective from 2025 onwards returned

Scenario: Search by product name
  When searching "chocolate"
  Then costs for products matching "chocolate" returned
```

### AC-12: RLS Policy Enforcement

```gherkin
Scenario: Org isolation on standard costs
  Given User A from Org A and User B from Org B
  And costs exist for both orgs
  When User A requests GET /api/finance/standard-costs
  Then only Org A costs returned

Scenario: Cannot view costs from different org
  Given cost belongs to Org B
  When User A (Org A) requests GET /api/finance/standard-costs/:id
  Then 404 Not Found returned
```

### AC-13: Audit Logging

```gherkin
Scenario: Log standard cost creation
  Given user creates standard cost
  Then audit_log entry created with:
    | action | create |
    | entity_type | standard_cost |
    | entity_id | cost uuid |

Scenario: Log approval action
  Given user approves standard cost
  Then audit_log entry created with:
    | action | approve |
    | old_value | { status: 'draft' } |
    | new_value | { status: 'approved', approved_by, approved_at } |
```

### AC-14: Standard Cost UI

```gherkin
Scenario: Standard cost form layout
  Given user navigates to /finance/costs/standard/new
  When page loads
  Then form displays fields:
    | Section | Fields |
    | Item | Product/Material selector, Item Type |
    | Effective Dates | Effective From, Effective To |
    | Cost Components | Material Cost, Labor Cost, Overhead Cost, Total Cost (calculated) |
    | Currency | Currency selector, UOM, Cost Basis |
    | Notes | Notes textarea |
  And [Save Draft] button
  And [Save & Approve] button (if Finance Manager)

Scenario: Total cost auto-updates
  Given entering cost components:
    | material_cost | 10.00 |
    | labor_cost | 5.00 |
  When entering overhead_cost | 3.00 |
  Then total_cost updates to 18.00 immediately
  And field is read-only

Scenario: Cost approval interface
  Given viewing draft standard cost
  And user is Finance Manager
  When clicking [Approve]
  Then confirmation dialog "Approve standard cost for [Product]?"
  And shows cost breakdown summary
  And [Confirm Approval] button
  And on approval, status badge changes to "Approved"
```

### AC-15: Performance Requirements

```gherkin
Scenario: Standard cost list performance
  Given 1000 standard costs in organization
  When listing costs with pagination
  Then response time < 500ms

Scenario: Get active cost performance
  Given product has 10 cost versions
  When getting active cost
  Then query uses index on (item_id, effective_from)
  And response time < 200ms
```

---

## Deliverables

### Database
- [ ] Migration: `currencies` table
- [ ] Migration: `tax_codes` table
- [ ] Migration: `standard_costs` table
- [ ] Function: `calculate_standard_cost_total()` trigger
- [ ] Function: `supersede_old_standard_costs()` trigger
- [ ] Function: `get_active_standard_cost()` query function
- [ ] RLS policies for all tables
- [ ] Performance indexes

### API Routes
- [ ] `POST /api/finance/standard-costs` - Create cost
- [ ] `GET /api/finance/standard-costs` - List costs
- [ ] `GET /api/finance/standard-costs/:id` - Get detail
- [ ] `PUT /api/finance/standard-costs/:id` - Update draft
- [ ] `DELETE /api/finance/standard-costs/:id` - Delete draft
- [ ] `POST /api/finance/standard-costs/:id/approve` - Approve cost
- [ ] `GET /api/finance/standard-costs/by-product/:productId` - Get product costs
- [ ] `GET /api/finance/standard-costs/:id/history` - Get cost history
- [ ] `GET /api/finance/currencies` - List currencies
- [ ] `POST /api/finance/currencies` - Create currency
- [ ] `GET /api/finance/tax-codes` - List tax codes
- [ ] `POST /api/finance/tax-codes` - Create tax code

### Service Layer
- [ ] `StandardCostService.create()` - Create cost
- [ ] `StandardCostService.update()` - Update draft
- [ ] `StandardCostService.approve()` - Approve cost
- [ ] `StandardCostService.activate()` - Activate approved cost
- [ ] `StandardCostService.getByProduct()` - Get active cost for product
- [ ] `StandardCostService.getHistory()` - Get cost history
- [ ] `CurrencyService` - Currency CRUD
- [ ] `TaxCodeService` - Tax code CRUD

### Validation
- [ ] `createStandardCostSchema`
- [ ] `updateStandardCostSchema`
- [ ] `createCurrencySchema`
- [ ] `createTaxCodeSchema`

### Frontend
- [ ] Standard costs list page
- [ ] Standard cost form (create/edit)
- [ ] Cost approval interface
- [ ] Cost history view
- [ ] Currency management page
- [ ] Tax code management page
- [ ] Status badges (draft/approved/active)

### Tests
- [ ] Unit tests: Service methods (>80% coverage)
- [ ] Integration tests: All API endpoints
- [ ] Database constraint tests
- [ ] RLS tests
- [ ] E2E: Full cost lifecycle

---

## Definition of Done

- [ ] All database tables created with constraints
- [ ] All API endpoints functional
- [ ] All service methods tested
- [ ] UI pages functional and validated
- [ ] RLS enforced across all tables
- [ ] Approval workflow complete
- [ ] Cost history tracking works
- [ ] Audit logging implemented
- [ ] Performance requirements met
- [ ] Documentation complete

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-01-15 | Initial story creation | ARCHITECT |

---

**Document Status**: Ready for Implementation
**Created**: 2025-01-15
**Complexity**: M (Medium - 3-4 days)
**Phase**: 1 (Foundation)
