# 09.5 - BOM Costing

**Priority**: P0 (MVP)
**Story Points**: M (Medium)
**Type**: fullstack
**Phase**: 1 (Foundation)
**Model**: OPUS

**State:** ready
**Estimate:** M (3-4 days)
**Primary PRD:** `docs/1-BASELINE/product/modules/finance.md` (FR-9.2.1, FR-9.2.2 BOM Costing)
**Architecture:** `docs/1-BASELINE/architecture/modules/finance.md` (cost_rollups table)

---

## Goal

Implement BOM (Bill of Materials) costing to calculate total product cost by summing ingredient costs, packaging costs, labor from routing, and overhead. Integrate with Epic 02 BOM service to provide cost-per-unit calculations and establish foundation for cost variance analysis.

---

## User Story

As a **Finance Manager**, I want to **calculate the total cost of a product from its BOM structure including ingredients, packaging, labor, and overhead** so that **I can establish standard product costs and analyze profitability**.

As a **Cost Accountant**, I want to **see cost breakdown by BOM component** so that **I can identify high-cost ingredients and optimize formulations**.

---

## MVP Scope

**MVP Includes**:
- `cost_rollups` table
- BOM cost calculation from standard costs
- Ingredient costing (sum of BOM items Ã— standard cost)
- Packaging costing
- Labor cost from routing operations
- Overhead allocation
- Cost per unit calculation
- Integration with Epic 02 BOM service
- BOM cost breakdown API
- BOM costing UI

**Deferred to Phase 2+**:
- Multi-level BOM cost rollup (Phase 2)
- BOM cost simulation (Phase 2)
- Recipe cost comparison (Phase 2)
- Yield cost adjustment (Phase 2)
- By-product cost credit (Phase 3)

---

## Dependencies

| Dependency | Story/Epic | Type | Status |
|------------|------------|------|--------|
| 01.1 | Org Context | HARD | Ready |
| 02.1 | Products CRUD | HARD | Ready |
| 02.2 | BOM CRUD | HARD | Ready |
| 09.1 | Finance Settings | HARD | Ready |
| 09.2 | Standard Costs | HARD | Ready |

---

## Database Migration

```sql
-- Migration: create_cost_rollups.sql

CREATE TABLE cost_rollups (
    id                  UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id              UUID NOT NULL REFERENCES organizations(id),
    product_id          UUID NOT NULL REFERENCES products(id),
    bom_id              UUID NOT NULL REFERENCES boms(id),

    effective_date      DATE NOT NULL DEFAULT CURRENT_DATE,
    level               INTEGER NOT NULL DEFAULT 0,

    material_cost       NUMERIC(15,4) NOT NULL DEFAULT 0,
    labor_cost          NUMERIC(15,4) NOT NULL DEFAULT 0,
    overhead_cost       NUMERIC(15,4) NOT NULL DEFAULT 0,
    total_cost          NUMERIC(15,4) NOT NULL DEFAULT 0,

    currency_id         UUID NOT NULL REFERENCES currencies(id),
    calculation_method  TEXT NOT NULL DEFAULT 'standard',

    created_at          TIMESTAMPTZ NOT NULL DEFAULT now(),

    CONSTRAINT chk_total_cost CHECK (total_cost = material_cost + labor_cost + overhead_cost)
);

CREATE INDEX idx_cost_rollups_org ON cost_rollups(org_id);
CREATE INDEX idx_cost_rollups_product ON cost_rollups(product_id);
CREATE INDEX idx_cost_rollups_bom ON cost_rollups(bom_id);

ALTER TABLE cost_rollups ENABLE ROW LEVEL SECURITY;

CREATE POLICY "cost_rollups_select" ON cost_rollups
    FOR SELECT USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

-- Function: Calculate BOM cost
CREATE OR REPLACE FUNCTION calculate_bom_cost(
    p_org_id UUID,
    p_bom_id UUID
)
RETURNS TABLE (
    material_cost NUMERIC,
    labor_cost NUMERIC,
    overhead_cost NUMERIC,
    total_cost NUMERIC
) AS $$
DECLARE
    v_material_cost NUMERIC := 0;
    v_labor_cost NUMERIC := 0;
    v_overhead_cost NUMERIC := 0;
    v_total_cost NUMERIC := 0;
    v_bom_item RECORD;
    v_routing_op RECORD;
BEGIN
    -- Sum ingredient and packaging costs
    FOR v_bom_item IN
        SELECT bi.product_id, bi.quantity
        FROM bom_items bi
        WHERE bi.bom_id = p_bom_id
    LOOP
        SELECT COALESCE(sc.total_cost * v_bom_item.quantity, 0) INTO v_material_cost
        FROM get_active_standard_cost(p_org_id, v_bom_item.product_id, CURRENT_DATE) sc;

        v_material_cost := v_material_cost + COALESCE(v_material_cost, 0);
    END LOOP;

    -- Sum labor from routing
    FOR v_routing_op IN
        SELECT ro.standard_hours
        FROM routings r
        JOIN routing_operations ro ON ro.routing_id = r.id
        WHERE r.bom_id = p_bom_id
    LOOP
        -- Assuming default hourly rate of 30 PLN (should come from settings)
        v_labor_cost := v_labor_cost + (v_routing_op.standard_hours * 30);
    END LOOP;

    -- Calculate overhead (e.g., 150% of labor)
    v_overhead_cost := v_labor_cost * 1.5;

    v_total_cost := v_material_cost + v_labor_cost + v_overhead_cost;

    RETURN QUERY SELECT v_material_cost, v_labor_cost, v_overhead_cost, v_total_cost;
END;
$$ LANGUAGE plpgsql;
```

---

## Acceptance Criteria

### AC-1: Calculate BOM Total Cost
```gherkin
Given BOM for "Chocolate Bar 100g" with items:
  | Ingredient | Quantity | Standard Cost | Total |
  | Cocoa | 30g | 0.05/g | 1.50 |
  | Sugar | 50g | 0.02/g | 1.00 |
  | Packaging | 1 pcs | 0.50 | 0.50 |
And routing with 5 min labor at 30 PLN/hr = 2.50
And overhead at 150% of labor = 3.75
When calculating BOM cost
Then cost_rollup created:
  | material_cost | 3.00 |
  | labor_cost | 2.50 |
  | overhead_cost | 3.75 |
  | total_cost | 9.25 |
```

### AC-2: Ingredient Cost Breakdown
```gherkin
Given GET /api/finance/bom-costs/:bomId
When requesting BOM cost breakdown
Then response contains:
  | Component | Type | Quantity | Unit Cost | Total |
  | Cocoa | ingredient | 30g | 0.05 | 1.50 |
  | Sugar | ingredient | 50g | 0.02 | 1.00 |
  | Packaging | packaging | 1 pcs | 0.50 | 0.50 |
And labor and overhead summaries
```

### AC-3: Cost Per Unit
```gherkin
Given BOM with batch_size = 100 units
And total_cost = 925.00 PLN
When calculating cost per unit
Then unit_cost = 925.00 / 100 = 9.25 PLN
```

### AC-4: Integration with BOM Service
```gherkin
Given Epic 02 BOM service
When BOM updated (item added/removed)
And auto_calculate_bom_costs = true
Then BOM cost recalculated automatically
And cost_rollup updated
```

---

## Deliverables

- [ ] `cost_rollups` table
- [ ] BOM cost calculation function
- [ ] Ingredient cost summation
- [ ] Packaging cost summation
- [ ] Labor cost from routing
- [ ] Overhead allocation
- [ ] API: GET BOM cost breakdown
- [ ] API: POST calculate BOM cost
- [ ] Service: BOMCostService
- [ ] UI: BOM cost breakdown view
- [ ] Tests: BOM costing scenarios

---

## Definition of Done

- [ ] BOM total cost calculated correctly
- [ ] Ingredient costs summed from standard costs
- [ ] Packaging costs included
- [ ] Labor and overhead allocated
- [ ] Cost per unit calculated
- [ ] API functional
- [ ] Integration with BOM service works
- [ ] Tests cover all cost components
- [ ] Performance < 1s for complex BOMs

---

**Created**: 2025-01-15 | **Complexity**: M (3-4 days) | **Phase**: 1
