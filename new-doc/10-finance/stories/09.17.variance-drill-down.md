# Story 09.17: Variance Drill-Down

**Epic:** 09-finance
**Phase:** 2
**Complexity:** M (3-4 days)
**Type:** Full-stack
**Story File:** `09.17.variance-drill-down.md`

---

## User Story

As a **Finance Manager** or **Production Supervisor**,
I want to **drill down into variance data by product, production line, shift, and time period**,
So that I can **identify specific root causes and take targeted corrective actions**.

---

## Business Context

**Problem**: High-level variance summaries don't reveal which products, lines, or shifts are causing cost overruns, making it difficult to identify actionable insights.

**Value**:
- Enable multi-dimensional analysis (product × line × shift × period)
- Identify top variance contributors quickly
- Support data-driven operational improvements
- Reduce time to identify root causes from days to minutes

**Use Cases**:
1. Finance Manager investigates why total variance increased 15% this week → drills down by product → finds SKU-101 has +$5K material variance → drills into BOM components → identifies sunflower oil price spike
2. Production Supervisor sees labor variance spike on Line 2 → drills by shift → finds Night shift has +20% efficiency variance → investigates crew training gaps
3. Cost Accountant compares variance across production lines → identifies Line 3 consistently has 8% overhead variance → recommends equipment maintenance review

---

## Acceptance Criteria

### AC1: Variance Drill-Down by Product (FR-FIN-056)

**Given** user is viewing variance summary data (e.g., total variance dashboard)
**When** drilling down by product
**Then** the system displays:
- Variance by product with ranking (highest to lowest absolute variance)
- Variance trend chart for selected product (last 30 days)
- Work orders contributing to product variance (with links)
- BOM components contributing to material variance (material-level breakdown)
- Percentage contribution to total variance
- Filter by date range

**Validation**:
- Products sorted by absolute variance (descending)
- Clicking product name navigates to product-specific variance view
- BOM component breakdown matches sum of material_consumption_costs
- Trend chart shows daily variance for selected product

---

### AC2: Variance Drill-Down by Production Line (FR-FIN-056)

**Given** user drills down by production line
**When** selecting a specific line (e.g., Line 2)
**Then** the system displays:
- Variance by line with comparison to other lines (side-by-side bars)
- Line efficiency metrics affecting labor variance (actual vs standard hours)
- Machine-specific overhead variances (if multiple machines on line)
- Shift-level breakdown for selected line (Day/Night/Weekend)
- Top 5 products with highest variance on this line
- Period selector (daily, weekly, monthly)

**Validation**:
- Line comparison shows % deviation from average variance
- Efficiency metric calculated from labor_costs table
- Shift breakdown sums to total line variance
- Export to CSV available

---

### AC3: Variance Drill-Down by Shift (FR-FIN-056)

**Given** user drills down by shift
**When** selecting a specific shift (Day, Night, Weekend)
**Then** the system displays:
- Variance comparison across shifts (bar chart)
- Labor rate variance by shift (highlighting overtime impact)
- Labor efficiency variance by shift (hours vs standard)
- Supervisor/team performance context (if tracked)
- Work orders completed during shift with variance
- Average variance per shift over selected period

**Validation**:
- Shift data sourced from labor_costs.transaction_date timestamp
- Overtime hours identified by shift time (Night/Weekend = higher rates)
- Variance trends show day-of-week patterns

---

### AC4: Overhead Variance Allocation (FR-FIN-054)

**Given** overhead rates configured by cost center
**When** user views overhead variance drill-down
**Then** the system displays:
- Overhead Spending Variance: Actual overhead - Budgeted overhead
- Overhead Volume Variance: Budgeted overhead - Applied overhead
- Total Overhead Variance: Sum of spending + volume variance
- Breakdown by cost center
- Allocation basis used (labor hours, machine hours, units produced)
- Comparison to budget

**Formula**:
```
Applied Overhead = Overhead Rate × Actual Activity
Budgeted Overhead = Overhead Rate × Budgeted Activity
Overhead Spending Variance = Actual Overhead - Budgeted Overhead
Overhead Volume Variance = Budgeted Overhead - Applied Overhead
Total Overhead Variance = Spending Variance + Volume Variance
```

**Validation**:
- Spending variance highlights over/under budget overhead costs
- Volume variance shows impact of activity level vs plan
- Aggregation respects different allocation bases per cost center

---

### AC5: Export Drill-Down Data

**Given** user has filtered variance data in drill-down view
**When** clicking "Export" button
**Then** the system exports current view to CSV or Excel with:
- All visible columns (product/line/shift, variance amount, variance %, contribution %)
- Filters applied (date range, category, threshold)
- Timestamp and user who exported
- Summary row (totals, averages)

**Validation**:
- Export completes in <5 seconds for 1000 rows
- CSV format preserves numeric formatting
- Excel format includes formatted headers and totals

---

## Technical Design

### API Endpoints

#### Variance Drill-Down Endpoints
```typescript
// Get variance by product
GET /api/finance/reports/variance-by-product
Query Params:
  - dateFrom: ISO date
  - dateTo: ISO date
  - productIds?: string[] (optional filter)
  - minVariancePercent?: number (optional threshold)

// Get variance by production line
GET /api/finance/reports/variance-by-line
Query Params:
  - dateFrom, dateTo
  - lineIds?: string[]
  - includeShiftBreakdown?: boolean

// Get variance by shift
GET /api/finance/reports/variance-by-shift
Query Params:
  - dateFrom, dateTo
  - shiftType?: 'day' | 'night' | 'weekend'
  - lineId?: string

// Get overhead variance breakdown
GET /api/finance/reports/overhead-variance
Query Params:
  - dateFrom, dateTo
  - costCenterIds?: string[]
  - groupBy?: 'cost_center' | 'allocation_basis'

// Get product drill-down details
GET /api/finance/reports/variance-by-product/:productId/details
Returns:
  - variance_trend: { date, variance_amount, variance_percent }[]
  - work_orders: { id, number, variance, date }[]
  - bom_components: { material_id, material_name, variance }[]
  - summary: { total_variance, avg_variance, contribution_percent }
```

### Backend Service: VarianceDrillDownService

```typescript
// apps/frontend/lib/services/variance-drill-down-service.ts
export class VarianceDrillDownService {
  // Get variance grouped by product
  static async getVarianceByProduct(filters: VarianceFilters): Promise<ProductVariance[]> {
    // Join work_order_costs with work_orders and products
    // Group by product_id
    // Calculate sum(variance), avg(variance_percent), count(work_orders)
    // Rank by absolute variance descending
  }

  // Get variance grouped by production line
  static async getVarianceByLine(filters: VarianceFilters): Promise<LineVariance[]> {
    // Join work_order_costs with work_orders and production_lines
    // Group by production_line_id
    // Include efficiency metrics from labor_costs
    // Calculate overhead variance per line
  }

  // Get variance grouped by shift
  static async getVarianceByShift(filters: VarianceFilters): Promise<ShiftVariance[]> {
    // Extract shift from labor_costs.transaction_date timestamp
    // Group by shift_type (day: 6am-2pm, night: 2pm-10pm, weekend: Sat/Sun)
    // Calculate labor rate variance (overtime impact)
    // Calculate labor efficiency variance
  }

  // Get overhead variance breakdown
  static async getOverheadVariance(filters: VarianceFilters): Promise<OverheadVariance[]> {
    // Join overhead_allocations with cost_centers and cost_center_budgets
    // Calculate spending variance and volume variance
    // Group by cost_center_id
  }

  // Get product-specific drill-down details
  static async getProductVarianceDetails(productId: string, filters: VarianceFilters): Promise<ProductVarianceDetails> {
    // Variance trend: daily variance for this product over date range
    // Work orders: list of WOs for this product with variance
    // BOM components: material-level variance breakdown
    // Summary: totals and contribution %
  }

  // Export variance data to CSV
  static async exportVariance(data: any[], format: 'csv' | 'excel'): Promise<Blob> {
    // Convert data to CSV or Excel format
    // Include headers, filters applied, timestamp
  }
}
```

### Database Queries

#### Variance by Product (Optimized)
```sql
SELECT
  p.id AS product_id,
  p.sku,
  p.name AS product_name,
  COUNT(DISTINCT wo.id) AS work_order_count,
  SUM(woc.total_variance) AS total_variance,
  AVG(woc.total_variance / NULLIF(woc.total_cost_standard, 0) * 100) AS avg_variance_percent,
  SUM(ABS(woc.total_variance)) AS abs_total_variance,
  (SUM(woc.total_variance) / SUM(SUM(woc.total_variance)) OVER ()) * 100 AS contribution_percent
FROM work_order_costs woc
JOIN work_orders wo ON woc.work_order_id = wo.id
JOIN products p ON wo.product_id = p.id
WHERE wo.org_id = :org_id
  AND woc.costing_date BETWEEN :date_from AND :date_to
GROUP BY p.id, p.sku, p.name
ORDER BY abs_total_variance DESC;
```

#### Variance by Production Line with Shift Breakdown
```sql
SELECT
  pl.id AS line_id,
  pl.name AS line_name,
  CASE
    WHEN EXTRACT(HOUR FROM lc.transaction_date) BETWEEN 6 AND 13 THEN 'day'
    WHEN EXTRACT(HOUR FROM lc.transaction_date) BETWEEN 14 AND 21 THEN 'night'
    ELSE 'weekend'
  END AS shift_type,
  SUM(lc.total_cost) AS total_labor_cost,
  SUM(lc.hours_actual) AS total_hours_actual,
  SUM(lc.hours_standard) AS total_hours_standard,
  SUM(lc.total_cost) - SUM(lc.hours_standard * lc.hourly_rate) AS labor_efficiency_variance
FROM labor_costs lc
JOIN work_orders wo ON lc.work_order_id = wo.id
JOIN production_lines pl ON wo.production_line_id = pl.id
WHERE wo.org_id = :org_id
  AND lc.transaction_date BETWEEN :date_from AND :date_to
GROUP BY pl.id, pl.name, shift_type
ORDER BY pl.name, shift_type;
```

---

## Frontend Components

### VarianceDrillDownPage
```tsx
// apps/frontend/app/(authenticated)/finance/reports/variance-drill-down/page.tsx
export default function VarianceDrillDownPage() {
  const [dimension, setDimension] = useState<'product' | 'line' | 'shift'>('product');
  const [dateRange, setDateRange] = useState({ from: subDays(new Date(), 30), to: new Date() });

  return (
    <div className="space-y-6">
      <PageHeader title="Variance Drill-Down Analysis" />

      <Card>
        <CardContent className="flex gap-4">
          <DimensionSelector value={dimension} onChange={setDimension} />
          <DateRangePicker value={dateRange} onChange={setDateRange} />
          <Button onClick={() => exportData()}>Export</Button>
        </CardContent>
      </Card>

      {dimension === 'product' && <VarianceByProductTable filters={{ dateRange }} />}
      {dimension === 'line' && <VarianceByLineTable filters={{ dateRange }} />}
      {dimension === 'shift' && <VarianceByShiftTable filters={{ dateRange }} />}
    </div>
  );
}
```

### VarianceByProductTable
```tsx
// apps/frontend/components/finance/variance/VarianceByProductTable.tsx
export function VarianceByProductTable({ filters }: Props) {
  const { data, isLoading } = useVarianceByProduct(filters);

  const columns: ColumnDef<ProductVariance>[] = [
    { accessorKey: 'rank', header: 'Rank' },
    { accessorKey: 'sku', header: 'SKU', cell: ({ row }) => (
      <Link href={`/finance/variance-drill-down/product/${row.original.product_id}`}>
        {row.original.sku}
      </Link>
    )},
    { accessorKey: 'product_name', header: 'Product' },
    { accessorKey: 'total_variance', header: 'Variance', cell: ({ value }) => formatCurrency(value) },
    { accessorKey: 'avg_variance_percent', header: 'Avg %', cell: ({ value }) => `${value.toFixed(2)}%` },
    { accessorKey: 'work_order_count', header: 'WO Count' },
    { accessorKey: 'contribution_percent', header: 'Contribution %', cell: ({ value }) => (
      <Badge variant={value > 10 ? 'destructive' : 'secondary'}>
        {value.toFixed(1)}%
      </Badge>
    )},
  ];

  return <DataTable columns={columns} data={data || []} />;
}
```

### ProductVarianceDetailModal
```tsx
// apps/frontend/components/finance/variance/ProductVarianceDetailModal.tsx
export function ProductVarianceDetailModal({ productId, open, onClose }: Props) {
  const { data } = useProductVarianceDetails(productId);

  return (
    <Dialog open={open} onOpenChange={onClose}>
      <DialogContent className="max-w-4xl">
        <DialogHeader>
          <DialogTitle>{data?.product_name} - Variance Details</DialogTitle>
        </DialogHeader>

        <Tabs defaultValue="trend">
          <TabsList>
            <TabsTrigger value="trend">Trend</TabsTrigger>
            <TabsTrigger value="work-orders">Work Orders</TabsTrigger>
            <TabsTrigger value="bom-components">BOM Components</TabsTrigger>
          </TabsList>

          <TabsContent value="trend">
            <VarianceTrendChart data={data?.variance_trend} />
          </TabsContent>

          <TabsContent value="work-orders">
            <WorkOrderVarianceTable workOrders={data?.work_orders} />
          </TabsContent>

          <TabsContent value="bom-components">
            <BOMComponentVarianceTable components={data?.bom_components} />
          </TabsContent>
        </Tabs>
      </DialogContent>
    </Dialog>
  );
}
```

### VarianceByLineTable
```tsx
// apps/frontend/components/finance/variance/VarianceByLineTable.tsx
export function VarianceByLineTable({ filters }: Props) {
  const { data, isLoading } = useVarianceByLine({ ...filters, includeShiftBreakdown: true });

  return (
    <div className="space-y-4">
      <VarianceByLineChart data={data} />

      <Table>
        <TableHeader>
          <TableRow>
            <TableHead>Line</TableHead>
            <TableHead>Shift</TableHead>
            <TableHead>Labor Cost</TableHead>
            <TableHead>Efficiency Variance</TableHead>
            <TableHead>Hours (Actual vs Std)</TableHead>
          </TableRow>
        </TableHeader>
        <TableBody>
          {data?.map(row => (
            <TableRow key={`${row.line_id}-${row.shift_type}`}>
              <TableCell>{row.line_name}</TableCell>
              <TableCell><Badge>{row.shift_type}</Badge></TableCell>
              <TableCell>{formatCurrency(row.total_labor_cost)}</TableCell>
              <TableCell className={row.labor_efficiency_variance > 0 ? 'text-red-600' : 'text-green-600'}>
                {formatCurrency(row.labor_efficiency_variance)}
              </TableCell>
              <TableCell>{row.total_hours_actual.toFixed(1)} / {row.total_hours_standard.toFixed(1)}</TableCell>
            </TableRow>
          ))}
        </TableBody>
      </Table>
    </div>
  );
}
```

### OverheadVarianceBreakdownCard
```tsx
// apps/frontend/components/finance/variance/OverheadVarianceBreakdownCard.tsx
export function OverheadVarianceBreakdownCard({ filters }: Props) {
  const { data } = useOverheadVariance(filters);

  return (
    <Card>
      <CardHeader>
        <CardTitle>Overhead Variance Breakdown</CardTitle>
      </CardHeader>
      <CardContent>
        <Table>
          <TableHeader>
            <TableRow>
              <TableHead>Cost Center</TableHead>
              <TableHead>Spending Variance</TableHead>
              <TableHead>Volume Variance</TableHead>
              <TableHead>Total Variance</TableHead>
            </TableRow>
          </TableHeader>
          <TableBody>
            {data?.map(row => (
              <TableRow key={row.cost_center_id}>
                <TableCell>{row.cost_center_name}</TableCell>
                <TableCell className={row.spending_variance > 0 ? 'text-red-600' : 'text-green-600'}>
                  {formatCurrency(row.spending_variance)}
                </TableCell>
                <TableCell className={row.volume_variance > 0 ? 'text-red-600' : 'text-green-600'}>
                  {formatCurrency(row.volume_variance)}
                </TableCell>
                <TableCell><strong>{formatCurrency(row.total_variance)}</strong></TableCell>
              </TableRow>
            ))}
          </TableBody>
        </Table>
      </CardContent>
    </Card>
  );
}
```

---

## Dependencies

### Required Stories
- **09.1** - Finance Settings
- **09.2** - Standard Cost Definition
- **09.3** - Material Cost Tracking
- **09.4** - Labor Cost Tracking
- **09.6** - WO Cost Summary
- **09.12** - Overhead Allocation (for overhead variance breakdown)
- **09.16** - Real-Time Variance Dashboard (base variance data)

---

## Testing Requirements

### Unit Tests
- Variance aggregation by product correctness
- Shift extraction from timestamp logic
- Overhead variance formula calculations
- Contribution % calculation accuracy
- Export data formatting

### Integration Tests
- Multi-level drill-down navigation flow
- Product detail modal data loading
- Shift breakdown sums to total variance
- Export includes correct filters and data

### E2E Tests
1. **Product drill-down workflow**:
   - Navigate to variance drill-down page
   - Select "Product" dimension
   - Verify table sorted by absolute variance
   - Click product → verify detail modal opens
   - Verify BOM component breakdown matches total

2. **Line and shift analysis**:
   - Select "Line" dimension
   - Verify shift breakdown displayed
   - Click shift → verify filtered data
   - Export to CSV → verify file downloads

---

## Performance Requirements

- Product variance query: <1 second (100 products)
- Line variance query: <1 second (10 lines)
- Shift variance query: <1 second
- Overhead variance query: <1 second (50 cost centers)
- Export generation: <5 seconds (1000 rows)

---

## Security & Permissions

Roles: Same as 09.16 (finance_manager, production_supervisor, cost_accountant, admin)

---

## UX/UI Specifications

### Variance Drill-Down Page Layout
```
┌─────────────────────────────────────────────────────────┐
│  Variance Drill-Down Analysis                [Export]  │
├─────────────────────────────────────────────────────────┤
│  Dimension: [Product ▼] [Line] [Shift]                │
│  Date Range: [Last 30 days ▼]                         │
├─────────────────────────────────────────────────────────┤
│  ┌─────┬─────────┬─────────┬──────────┬────────┬─────┐│
│  │Rank │ SKU     │ Product │ Variance │ Avg %  │Cont%││
│  ├─────┼─────────┼─────────┼──────────┼────────┼─────┤│
│  │  1  │ SKU-101 │Choc Bar │ +$5,234  │ +12.5% │ 35% ││
│  │  2  │ SKU-205 │Cookie   │ +$2,890  │ +8.2%  │ 19% ││
│  │  3  │ SKU-310 │Cake     │ +$1,450  │ +5.8%  │ 10% ││
│  └─────┴─────────┴─────────┴──────────┴────────┴─────┘│
└─────────────────────────────────────────────────────────┘
```

---

## Story Metadata

**Estimated Effort:** 3-4 days
**Story Points:** 8
**Priority:** P0 (Phase 2)
**FR Coverage:** FR-FIN-054, FR-FIN-056
**Related Stories:** 09.16 (Real-Time Variance Dashboard), 09.13 (Material Variance), 09.14 (Labor Variance)
