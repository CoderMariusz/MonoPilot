# Story 09.24: Cost Dashboard & Trends

**Epic:** 09-finance
**Phase:** 3
**Complexity:** L (4-5 days)
**Type:** Frontend
**Story File:** `09.24.cost-dashboard-trends.md`

---

## User Story

As a **Finance Manager**, **CFO**, or **Production Manager**,
I want to **view a comprehensive cost dashboard with trends, KPIs, and drill-down capabilities**,
So that I can **quickly assess cost performance, identify issues, and make data-driven decisions**.

---

## Business Context

**Problem**: Cost data scattered across multiple reports, requiring manual compilation and analysis. Executives lack real-time cost visibility for decision-making.

**Value**:
- Executive cost command center (single source of truth)
- Real-time cost visibility (no waiting for month-end reports)
- Proactive issue detection via trend analysis
- Quick drill-down from summary to transaction detail
- Custom cost report builder for ad-hoc analysis

**Use Cases**:
1. CFO reviews cost dashboard Monday morning → sees total production cost up 12% vs last month → drills into material cost spike → identifies sugar price increase → discusses hedging strategy with procurement
2. Production Manager monitors daily cost trends → spots gradual labor cost increase on Line 2 → investigates → discovers overtime pattern → adjusts shift schedules
3. Finance Analyst builds custom report → cost by product × period × production line → identifies cross-functional cost patterns → shares insights with operations team
4. Cost Accountant uses cost breakdown widget → sees overhead allocation at 38% of total cost vs 30% target → presents data to management → triggers overhead reduction initiative

---

## Acceptance Criteria

### AC1: Cost Dashboard Overview (FR-9.6.7)

**Given** user accesses finance dashboard (`/finance/dashboard`)
**When** page loads
**Then** the system displays:
- **Summary KPI Cards** (6 cards):
  1. Total Production Cost (this month)
  2. Cost per Unit (average)
  3. Material Cost % of Total
  4. Labor Cost % of Total
  5. Overhead Cost % of Total
  6. Cost Variance % (vs budget or standard)
- Each card shows:
  - Current value (large, prominent)
  - Comparison to previous period (arrow + %)
  - Trend indicator (up/down/stable)
  - Target or budget comparison (if available)
- Filters: Date range (MTD, QTD, YTD, custom), Production line, Product category

**Validation**:
- KPI data refreshed every 5 minutes or on-demand
- Comparison period auto-calculated (previous month, previous quarter, etc.)
- Color coding: Green (favorable), Red (unfavorable), Gray (neutral)

---

### AC2: Cost Trend Chart (FR-9.6.5)

**Given** user views dashboard
**When** cost trend chart displayed
**Then** the system shows:
- **Line chart** with time series:
  - X-axis: Time period (daily, weekly, monthly based on date range)
  - Y-axis: Cost amount
  - Multiple lines: Material, Labor, Overhead, Total
- **Stacked area chart option**: Shows cost composition over time
- **Customization**:
  - Toggle cost categories on/off
  - Switch chart type (line, stacked area, bar)
  - Zoom/pan controls
  - Hover tooltip with exact values
- **Time period selector**: Last 7/30/90 days, MTD, QTD, YTD, Custom

**Validation**:
- Chart renders within 1 second
- Data aggregated by appropriate time bucket (daily for <30 days, weekly for 30-90 days, monthly for >90 days)
- Chart responsive on mobile (simplified view)

---

### AC3: Cost Breakdown Visualization (FR-9.6.6)

**Given** user views dashboard
**When** cost breakdown widget displayed
**Then** the system shows:
- **Pie chart**: Cost distribution (Material, Labor, Overhead)
- **Donut chart option**: With total cost in center
- **Percentage labels**: Show % of total for each category
- **Legend**: Clickable to toggle categories
- **Drill-down**: Click category → view detailed breakdown
  - Material → top 10 materials by cost
  - Labor → cost by operation or department
  - Overhead → cost by cost center

**Validation**:
- Percentages sum to 100%
- Colors consistent across all visualizations
- Drill-down opens modal or navigates to detail page

---

### AC4: Cost Trends Analysis (FR-9.6.5)

**Given** user accesses cost trends analysis
**When** viewing trend analysis page
**Then** the system displays:
- **Trend line chart** with moving average overlay (7-day or 4-week)
- **Period-over-period comparison**:
  - Table showing current vs previous period
  - Change amount and percentage
  - Trend direction (increasing, stable, decreasing)
- **Trend indicators**:
  - Linear regression trend line
  - R² (coefficient of determination) for trend confidence
  - Forecasted trend (next 30 days based on current trajectory)
- **Statistical summary**:
  - Average cost per period
  - Standard deviation
  - Min/Max cost with dates
  - Outlier detection (values >2 std dev from mean)

**Validation**:
- Trend calculation uses robust statistical methods
- Outliers highlighted but not excluded from trend calculation
- Forecast accuracy disclaimer shown

---

### AC5: Top Cost Contributors Widget

**Given** user views dashboard
**When** top cost contributors widget displayed
**Then** the system shows:
- **Top 10 products by total cost** (for selected period)
  - Product name, SKU
  - Total cost
  - % of total production cost
  - Units produced
  - Cost per unit
  - Trend indicator vs previous period
- **Top 5 work orders by cost**
  - WO number, product
  - Total cost
  - Status (completed, in-progress)
  - Cost variance (actual vs standard)
- **Drill-down**: Click product or WO → navigate to detail page

---

### AC6: Custom Cost Report Builder (FR-9.6.8)

**Given** user accesses custom report builder
**When** building custom cost report
**Then** the system allows:
- **Dimension Selection** (multi-select):
  - Product / Product Family
  - Period (day, week, month, quarter)
  - Production Line
  - Cost Center
  - Work Order
  - Shift
- **Metric Selection**:
  - Material Cost
  - Labor Cost
  - Overhead Cost
  - Total Cost
  - Variance (vs standard or budget)
  - Cost per Unit
- **Aggregation**: Sum, Average, Min, Max, Count
- **Filters**: Date range, specific product/line/center
- **Grouping**: Primary and secondary grouping
- **Sorting**: Any column, ascending or descending
- **Visualization**: Table, chart (bar, line, stacked), or both
- **Save Report**: Save configuration for reuse
- **Export**: Excel, CSV, PDF

**Example**:
- Dimensions: Product Family (primary), Month (secondary)
- Metrics: Total Cost, Cost per Unit, Variance %
- Filters: Production Line 1, 2024 Q1
- Result: Table showing cost by product family by month

**Validation**:
- Report builder supports up to 3 dimensions
- Preview updates dynamically as user selects options
- Saved reports appear in user's report library
- Export includes all data (not just visible rows)

---

### AC7: Cost Dashboard Widgets (Customizable Layout)

**Given** user has finance_manager role
**When** customizing dashboard layout
**Then** the system allows:
- **Drag-and-drop** widget positioning
- **Widget library**:
  - KPI Summary Cards
  - Cost Trend Chart
  - Cost Breakdown Pie Chart
  - Top Cost Contributors Table
  - Budget Variance Gauge
  - Cost Alerts List
  - Custom Report Embed
- **Widget sizing**: Small, Medium, Large
- **Dashboard presets**:
  - Executive View (high-level KPIs)
  - Operations View (production line costs, WO costs)
  - Finance View (variance analysis, budget tracking)
- **Save layout**: Per user or organization default
- **Reset to default**: Restore original layout

**Validation**:
- Layout saved to user preferences
- Dashboard loads with last saved layout
- Widget data refreshes independently (no full page reload)

---

## Technical Design

### API Endpoints

```typescript
// Cost Dashboard KPIs
GET /api/finance/dashboard/kpis
Query Params:
  - dateFrom, dateTo
  - productionLineId?
  - productCategoryId?

Response: {
  total_production_cost: { current, previous, change_percent, trend };
  cost_per_unit: { current, previous, change_percent };
  material_cost_percent: { current, target };
  labor_cost_percent: { current, target };
  overhead_cost_percent: { current, target };
  cost_variance_percent: { current, target };
}

// Cost Trend Data
GET /api/finance/dashboard/cost-trends
Query Params:
  - dateFrom, dateTo
  - periodType: 'daily' | 'weekly' | 'monthly'
  - categories: 'material,labor,overhead,total'

Response: {
  periods: {
    period_start: ISO date;
    material_cost, labor_cost, overhead_cost, total_cost: number;
  }[];
  moving_average: number[];
  trend_line: number[];
  forecast: number[];
}

// Cost Breakdown
GET /api/finance/dashboard/cost-breakdown
Query Params:
  - dateFrom, dateTo

Response: {
  breakdown: { category: string, amount: number, percent: number }[];
  drill_down: { category, top_items: { name, amount }[] };
}

// Top Cost Contributors
GET /api/finance/dashboard/top-contributors
Query Params:
  - dateFrom, dateTo
  - contributorType: 'product' | 'work_order' | 'cost_center'
  - limit: number (default 10)

Response: {
  products: { product_id, name, total_cost, percent_of_total, units, cost_per_unit, trend }[];
  work_orders: { wo_id, wo_number, product, total_cost, status, variance }[];
}

// Custom Report Builder
POST /api/finance/reports/custom
Body: {
  dimensions: string[];
  metrics: string[];
  filters: Record<string, any>;
  grouping: { primary: string, secondary?: string };
  sorting: { column: string, direction: 'asc' | 'desc' };
}
Response: {
  report_data: any[];
  summary: Record<string, number>;
}

// Save Custom Report
POST /api/finance/reports/custom/save
Body: {
  report_name: string;
  report_config: ReportConfig;
}

// Dashboard Layout
GET /api/finance/dashboard/layout
Response: { widgets: Widget[], layout: Layout }

PATCH /api/finance/dashboard/layout
Body: { widgets, layout }
```

### Frontend Components Structure

```
apps/frontend/app/(authenticated)/finance/dashboard/
  page.tsx                          -- Main dashboard page

components/finance/dashboard/
  FinanceDashboard.tsx              -- Dashboard container
  CostKPICards.tsx                  -- 6 summary KPI cards
  CostTrendChart.tsx                -- Line/area chart (Recharts)
  CostBreakdownChart.tsx            -- Pie/donut chart (Recharts)
  TopCostContributorsTable.tsx      -- Top 10 products/WOs table
  CustomReportBuilder.tsx           -- Report builder interface
  DashboardLayoutEditor.tsx         -- Drag-drop layout editor
  CostTrendsAnalysisPage.tsx        -- Dedicated trends analysis page
  WidgetLibrary.tsx                 -- Widget selection panel
  SavedReportsList.tsx              -- User's saved reports
```

### Chart Library

**Recharts** (already in use):
- LineChart for trends
- AreaChart for stacked cost composition
- PieChart / RadialBarChart for breakdown
- BarChart for comparisons
- ComposedChart for multi-series data

### Dashboard State Management

```typescript
// apps/frontend/lib/hooks/use-cost-dashboard.ts
export function useCostDashboard(filters: DashboardFilters) {
  const { data: kpis } = useQuery(['cost-kpis', filters], () => fetchKPIs(filters));
  const { data: trends } = useQuery(['cost-trends', filters], () => fetchTrends(filters));
  const { data: breakdown } = useQuery(['cost-breakdown', filters], () => fetchBreakdown(filters));
  const { data: contributors } = useQuery(['top-contributors', filters], () => fetchContributors(filters));

  return { kpis, trends, breakdown, contributors };
}
```

---

## Dependencies

### Required Stories
- **09.6** - WO Cost Summary (work_order_costs table)
- **09.13** - Material Variance (variance data)
- **09.14** - Labor Variance (variance data)
- **09.22** - Cost Center Budget & Variance (budget data)

---

## Testing Requirements

### Unit Tests
- KPI calculation logic
- Trend direction calculation (moving average, linear regression)
- Cost breakdown percentage calculations
- Custom report builder query generation

### Integration Tests
- Dashboard data loading from multiple endpoints
- Chart rendering with real data
- Custom report builder execution
- Dashboard layout save/load

### E2E Tests
1. **Dashboard Load and Interaction**:
   - Navigate to finance dashboard
   - Verify all widgets load within 2 seconds
   - Apply date filter → verify all widgets update
   - Drill down from pie chart → verify modal opens

2. **Cost Trends Analysis**:
   - View cost trends page
   - Select 90-day period
   - Verify trend line and moving average display
   - Verify forecast shown for next 30 days

3. **Custom Report Builder**:
   - Open report builder
   - Select dimensions: Product Family, Month
   - Select metrics: Total Cost, Variance %
   - Preview report → verify data displayed
   - Save report → verify appears in saved reports list

---

## Performance Requirements

- Dashboard initial load: <2 seconds
- KPI cards render: <500ms
- Charts render: <1 second
- Custom report generation: <3 seconds (1000 rows)
- Dashboard widget refresh: <1 second

---

## Security & Permissions

Roles: finance_manager, cfo, production_manager (view dashboard)
Roles: finance_manager (customize layout, save reports)
Roles: viewer (view dashboard, read-only)

---

## Story Metadata

**Estimated Effort:** 4-5 days
**Story Points:** 13
**Priority:** P0 (Phase 3)
**FR Coverage:** FR-9.6.5, FR-9.6.6, FR-9.6.7, FR-9.6.8
**Related Stories:** 09.19 (Cost Reporting Suite), 09.16 (Real-Time Variance Dashboard), 09.21 (Margin Analysis)
