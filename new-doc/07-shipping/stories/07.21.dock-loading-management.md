# 07.21 - Dock & Loading Management

**Story ID:** 07.21
**Epic:** 07 - Shipping
**Phase:** 2 (Advanced Features)
**Complexity:** L (Large)
**Priority:** P1
**Estimate:** 7-10 days
**Type:** Backend + Frontend
**State:** ready

**Primary PRD:** `docs/1-BASELINE/product/modules/shipping.md` (FR-7.52 to FR-7.58)
**UX Wireframes:** SHIP-020 (Dock Schedule), SHIP-021 (Dock Door Config), SHIP-022 (Load Planning)

## PRD References

| FR ID | Requirement | Priority | Phase | Covered |
|-------|-------------|----------|-------|---------|
| FR-7.52 | Dock Door Configuration | P1 | 2 | Full |
| FR-7.53 | Dock Appointment Scheduling | P1 | 2 | Full |
| FR-7.54 | Load Planning (Pallet/Box) | P1 | 2 | Full |
| FR-7.55 | Staging Location Assignment | P1 | 2 | Full |
| FR-7.56 | Load Confirmation | P1 | 2 | Full |
| FR-7.57 | Truck Capacity Management | P2 | 3 | Partial |
| FR-7.58 | Temperature Zone Validation | P1 | 2 | Full |

## User Story

**As a** Shipping Coordinator,
**I want** to configure dock doors, schedule dock appointments, and plan load sequences,
**So that** I can efficiently manage truck loading operations while ensuring temperature compliance and optimal dock utilization.

**As a** Warehouse Manager,
**I want** to assign staging locations for outbound shipments and confirm loaded shipments,
**So that** I can track inventory movement through the shipping process and maintain accurate load records.

## Goal

Implement comprehensive dock and loading management enabling operators to configure dock doors with temperature zones, schedule appointments, plan load sequences with pallet/box optimization, assign staging locations, and confirm loads with temperature zone validation. Ensures food safety compliance through temperature zone matching and provides visibility into dock utilization.

## Scope

**In scope:**
- Dock door CRUD operations (code, name, type, temperature zone)
- Dock door temperature zones: ambient, chilled, frozen
- Dock appointment scheduling (calendar view)
- Appointment status workflow: scheduled, checked_in, loading, completed, cancelled
- Load planning interface (pallet/box sequence)
- Staging location assignment for shipments
- Load confirmation workflow (scan SSCC to confirm load)
- Temperature zone validation (shipment temp zone vs dock door temp zone)
- Truck capacity display (weight, pallet count)
- Load manifest generation
- Desktop UI: dock schedule calendar, load planning, staging assignment
- Multi-tenant RLS policies

**Out of scope:**
- Carrier API integration (Story 07.25)
- Automatic appointment suggestions (Phase 3)
- Real-time dock door status sensors/IoT (Phase 3)
- Yard management (Phase 3)
- Driver mobile app (Phase 3)
- Cross-docking workflows (Phase 3)

## Dependencies

| Story | Requirement | Status | Notes |
|-------|-------------|--------|-------|
| 07.14 | Shipment Manifest | Required | Provides shipments table, manifest workflow |
| 05.22 | Pallet Management | Required | Provides pallets table, SSCC codes |
| 01.8 | Warehouses | Required | Dock doors linked to warehouses |
| 01.9 | Locations | Required | Staging locations |
| 07.11 | Packing + Shipment Creation | Required | Provides shipment_boxes |

**Dependents (What This Unblocks):**
- 07.23: Advanced Carrier Integration (uses dock assignments)
- 07.24: On-Time Delivery Reports (uses dock completion times)
- 07.25: Carrier Webhooks (updates dock status)

## Acceptance Criteria (Given/When/Then)

### FR-7.52: Dock Door Configuration

#### AC-1: Dock Door CRUD

```gherkin
Scenario: Create dock door
  Given user has ADMIN or MANAGER role
  When POST /api/shipping/dock-doors with:
    | door_code | DOCK-001 |
    | door_name | Shipping Dock 1 |
    | door_type | shipping |
    | temperature_zone | chilled |
    | warehouse_id | {valid_uuid} |
  Then dock door created successfully
  And door_code unique within organization
  And is_active = true by default
  And response time < 200ms

Scenario: Duplicate door code rejected
  Given dock door DOCK-001 exists in org A
  When POST /api/shipping/dock-doors with door_code = 'DOCK-001' in org A
  Then 409 Conflict "Dock door code already exists"

Scenario: List dock doors with filters
  Given 10 dock doors exist (5 shipping, 3 receiving, 2 both)
  When GET /api/shipping/dock-doors?door_type=shipping
  Then only 5 shipping dock doors returned
  And sorted by door_code ascending

Scenario: Deactivate dock door
  Given dock door with is_active = true
  And no future appointments exist
  When PUT /api/shipping/dock-doors/:id with is_active = false
  Then dock door deactivated
  And door no longer available for new appointments

Scenario: Deactivate blocked with future appointments
  Given dock door with 3 future appointments
  When PUT /api/shipping/dock-doors/:id with is_active = false
  Then 400 error "Cannot deactivate: 3 future appointments exist"
```

#### AC-2: Temperature Zone Configuration

```gherkin
Scenario: Configure temperature zone
  Given dock door exists
  When PUT /api/shipping/dock-doors/:id with temperature_zone = 'frozen'
  Then dock door temperature_zone updated
  And validation will check shipment temp zones against this

Scenario: Temperature zone enum values
  Given dock door create/update request
  When temperature_zone value submitted
  Then only 'ambient', 'chilled', 'frozen' accepted
  And any other value returns 400 error

Scenario: Display temperature zone badge
  Given dock door list displayed
  When viewing door details
  Then temperature zone badge shows with color:
    | Zone | Color |
    | ambient | Green |
    | chilled | Blue |
    | frozen | Purple |
```

### FR-7.53: Dock Appointment Scheduling

#### AC-3: Create Dock Appointment

```gherkin
Scenario: Create appointment for shipping
  Given dock door DOCK-001 with door_type = 'shipping' or 'both'
  When POST /api/shipping/dock-appointments with:
    | dock_door_id | {dock_door_uuid} |
    | appointment_type | shipping |
    | shipment_id | {shipment_uuid} |
    | scheduled_start | 2025-01-20T09:00:00Z |
    | scheduled_end | 2025-01-20T10:00:00Z |
    | carrier | DHL |
    | truck_number | ABC-123 |
  Then appointment created with status = 'scheduled'
  And response includes appointment_number (auto-generated)

Scenario: Create appointment without shipment (placeholder)
  Given dock door exists
  When POST /api/shipping/dock-appointments without shipment_id
  Then appointment created as placeholder
  And shipment can be linked later

Scenario: Overlapping appointment blocked
  Given appointment at DOCK-001 from 09:00 to 10:00
  When POST /api/shipping/dock-appointments at DOCK-001 from 09:30 to 10:30
  Then 409 Conflict "Time slot overlaps with existing appointment"

Scenario: Door type mismatch blocked
  Given dock door with door_type = 'receiving'
  When POST /api/shipping/dock-appointments with appointment_type = 'shipping'
  Then 400 error "Dock door DOCK-001 does not support shipping appointments"
```

#### AC-4: Appointment Calendar View

```gherkin
Scenario: View dock schedule calendar
  Given user navigates to /shipping/dock-schedule
  When page loads
  Then calendar displays with:
    | View | Options |
    | Day | 24-hour timeline |
    | Week | 7-day grid |
    | Month | Monthly overview |
  And dock doors shown as rows/columns
  And appointments shown as colored blocks

Scenario: Filter calendar by dock door
  Given 5 dock doors exist
  When user filters by DOCK-001 only
  Then only DOCK-001 appointments displayed

Scenario: Appointment color coding
  Given appointments with different statuses
  When viewing calendar
  Then appointment blocks colored by status:
    | Status | Color |
    | scheduled | Blue |
    | checked_in | Yellow |
    | loading | Orange |
    | completed | Green |
    | cancelled | Gray |

Scenario: Click appointment for details
  Given appointment block in calendar
  When user clicks appointment
  Then detail modal opens with:
    | Field | Content |
    | Appointment # | APT-2025-00001 |
    | Dock Door | DOCK-001 |
    | Time | 09:00 - 10:00 |
    | Carrier | DHL |
    | Truck | ABC-123 |
    | Shipment | SH-2025-00123 |
    | Status | scheduled |
```

#### AC-5: Appointment Status Workflow

```gherkin
Scenario: Check in appointment
  Given appointment with status = 'scheduled'
  When POST /api/shipping/dock-appointments/:id/check-in
  Then appointment.status = 'checked_in'
  And appointment.actual_start = NOW()
  And success toast "Appointment checked in"

Scenario: Start loading
  Given appointment with status = 'checked_in'
  When POST /api/shipping/dock-appointments/:id/start-loading
  Then appointment.status = 'loading'

Scenario: Complete appointment
  Given appointment with status = 'loading'
  When POST /api/shipping/dock-appointments/:id/complete
  Then appointment.status = 'completed'
  And appointment.actual_end = NOW()

Scenario: Cancel appointment
  Given appointment with status = 'scheduled' or 'checked_in'
  When POST /api/shipping/dock-appointments/:id/cancel with reason = 'Truck delayed'
  Then appointment.status = 'cancelled'
  And cancellation_reason stored

Scenario: Invalid status transition blocked
  Given appointment with status = 'completed'
  When POST /api/shipping/dock-appointments/:id/check-in
  Then 400 error "Cannot check in completed appointment"

Scenario: Status workflow enforcement
  Given various appointment states
  When attempting transitions
  Then only valid transitions allowed:
    | From | To | Allowed |
    | scheduled | checked_in | Yes |
    | scheduled | cancelled | Yes |
    | checked_in | loading | Yes |
    | checked_in | cancelled | Yes |
    | loading | completed | Yes |
    | completed | * | No |
    | cancelled | * | No |
```

### FR-7.54: Load Planning (Pallet/Box)

#### AC-6: Load Planning Interface

```gherkin
Scenario: View load plan for appointment
  Given appointment with linked shipment
  And shipment has 5 pallets and 10 boxes
  When user opens load planning view
  Then load plan displays:
    | Element | Content |
    | Pallets | 5 pallets with SSCC |
    | Boxes | 10 boxes with SSCC |
    | Total Weight | 1,250 kg |
    | Load Sequence | Suggested order |

Scenario: Set load sequence
  Given 5 pallets for shipment
  When user drags pallets to set load order
  Then load_sequence updated (1, 2, 3, 4, 5)
  And sequence persisted to load_plan_items

Scenario: Auto-sequence by temperature
  Given pallets with different temp zones:
    | Pallet | Temp Zone |
    | PLT-001 | frozen |
    | PLT-002 | chilled |
    | PLT-003 | ambient |
  When "Auto-sequence" button clicked
  Then sequence set: frozen first, chilled second, ambient last
  And rationale: "Load frozen first (back of truck), ambient last (front)"

Scenario: Load sequence validation
  Given load plan with sequence
  When validating load plan
  Then warnings shown for:
    | Issue | Warning |
    | Heavy on top | "Heavy pallet PLT-001 after light PLT-002" |
    | Temp mixing | "Frozen and ambient in same zone" |
```

#### AC-7: Create Load Plan

```gherkin
Scenario: Create load plan for appointment
  Given appointment without load plan
  When POST /api/shipping/dock-appointments/:id/load-plan with:
    | shipment_ids | [uuid1, uuid2] |
  Then load_plans record created
  And load_plan_items populated from shipment boxes/pallets
  And default sequence assigned

Scenario: Add shipment to existing load plan
  Given load plan with shipment SH-001
  When POST /api/shipping/dock-appointments/:id/load-plan/add-shipment with shipment_id = SH-002
  Then SH-002 items added to load plan
  And sequence numbers continue from existing max

Scenario: Remove shipment from load plan
  Given load plan with shipments SH-001 and SH-002
  When DELETE /api/shipping/dock-appointments/:id/load-plan/shipment/:shipmentId
  Then SH-002 items removed
  And remaining items re-sequenced
```

### FR-7.55: Staging Location Assignment

#### AC-8: Assign Staging Location

```gherkin
Scenario: Assign staging location to shipment
  Given shipment with status = 'packed' or 'manifested'
  And staging location 'STAGE-A1' available
  When PUT /api/shipping/shipments/:id with staged_location_id = 'STAGE-A1'
  Then shipment.staged_location_id updated
  And location utilization updated

Scenario: Staging location dropdown
  Given shipment edit form
  When user selects staging location field
  Then dropdown shows:
    | Location | Status |
    | STAGE-A1 | Available |
    | STAGE-A2 | Occupied (SH-001) |
    | STAGE-A3 | Available |
  And occupied locations shown but disabled

Scenario: Auto-suggest staging location
  Given shipment ready for staging
  When "Suggest Location" clicked
  Then system suggests based on:
    | Factor | Weight |
    | Temperature zone match | High |
    | Proximity to dock | Medium |
    | Current utilization | Low |
  And suggestion shown with rationale

Scenario: Bulk staging assignment
  Given 5 shipments ready for staging
  When user selects shipments and clicks "Assign Staging"
  Then bulk assignment modal opens
  And user can assign same or different locations
  And all shipments updated on confirm
```

#### AC-9: Staging Location Tracking

```gherkin
Scenario: View staging location status
  Given staging locations in warehouse
  When GET /api/warehouse/locations?type=staging
  Then each location returns:
    | Field | Content |
    | location_id | UUID |
    | location_code | STAGE-A1 |
    | status | available/occupied |
    | current_shipment | SH-001 or null |
    | temp_zone | ambient/chilled/frozen |

Scenario: Clear staging location on ship
  Given shipment at staging location STAGE-A1
  When shipment marked as shipped
  Then STAGE-A1 status = 'available'
  And current_shipment = null
```

### FR-7.56: Load Confirmation

#### AC-10: Load Confirmation Workflow

```gherkin
Scenario: Confirm load via desktop
  Given appointment with status = 'loading'
  And load plan with 5 pallets
  When user clicks "Confirm Load" for pallet PLT-001
  Then load_plan_items.loaded_at = NOW()
  And load_plan_items.loaded_by = current_user
  And progress updated (1/5 loaded)

Scenario: Scan SSCC to confirm load
  Given load confirmation interface
  When user scans SSCC '012345670000000018'
  Then system finds matching pallet/box
  And marks as loaded with timestamp
  And plays success sound
  And shows next item to load

Scenario: Scan unknown SSCC
  Given load confirmation interface
  When user scans SSCC not in load plan
  Then error toast "SSCC not found in load plan"
  And error sound plays
  And item not marked as loaded

Scenario: Complete load confirmation
  Given all items in load plan marked as loaded
  When user clicks "Complete Load"
  Then appointment.status = 'completed'
  And appointment.actual_end = NOW()
  And linked shipments updated (if not already shipped)
```

#### AC-11: Load Manifest

```gherkin
Scenario: Generate load manifest
  Given appointment with completed load plan
  When POST /api/shipping/dock-appointments/:id/manifest
  Then PDF manifest generated with:
    | Section | Content |
    | Header | Appointment #, Date, Dock Door |
    | Carrier | Carrier name, Truck #, Driver |
    | Items | All pallets/boxes with SSCC |
    | Weights | Total weight, pallet count |
    | Signatures | Shipper, Driver lines |
  And manifest stored and available for print

Scenario: Print load manifest
  Given load manifest generated
  When user clicks "Print Manifest"
  Then print dialog opens
  And manifest prints successfully
```

### FR-7.57: Truck Capacity Management

#### AC-12: Truck Capacity Display

```gherkin
Scenario: Display truck capacity
  Given appointment with truck configuration
  When viewing load plan
  Then capacity indicators show:
    | Metric | Value | Limit |
    | Weight | 1,250 kg | 20,000 kg |
    | Pallets | 5 | 26 |
    | Volume | 15 m3 | 80 m3 |
  And progress bars indicate utilization

Scenario: Capacity warning
  Given load plan approaching capacity
  When weight exceeds 90% of truck limit
  Then warning badge displayed
  And tooltip shows "Weight at 92% capacity"

Scenario: Capacity exceeded blocked
  Given truck weight limit = 20,000 kg
  And load plan weight = 19,500 kg
  When adding pallet with weight = 1,000 kg
  Then warning "Adding this pallet would exceed truck capacity by 500 kg"
  And user can override with confirmation

Scenario: Configure truck capacity
  Given appointment creation form
  When user enters truck details
  Then capacity fields available:
    | Field | Type |
    | max_weight_kg | Number |
    | max_pallets | Number |
    | max_volume_m3 | Number |
```

### FR-7.58: Temperature Zone Validation

#### AC-13: Temperature Zone Matching

```gherkin
Scenario: Validate shipment temp zone vs dock door
  Given dock door DOCK-001 with temperature_zone = 'chilled'
  And shipment with temperature_zone = 'frozen'
  When assigning shipment to DOCK-001 appointment
  Then warning "Temperature mismatch: Shipment requires frozen, dock is chilled"
  And user can override with confirmation

Scenario: Temperature zone auto-suggest
  Given shipment with temperature_zone = 'frozen'
  When user creates appointment
  Then dock doors filtered to show frozen-compatible first
  And incompatible doors shown with warning icon

Scenario: Mixed temperature load warning
  Given load plan with shipments:
    | Shipment | Temp Zone |
    | SH-001 | frozen |
    | SH-002 | ambient |
  When validating load plan
  Then warning "Mixed temperature zones in load: frozen, ambient"
  And guidance "Ensure frozen items remain in temperature-controlled area"

Scenario: Temperature validation on load confirmation
  Given dock door temp_zone = 'ambient'
  And pallet with temp_zone = 'frozen'
  When confirming pallet load
  Then warning dialog "Loading frozen item at ambient dock"
  And user must acknowledge to proceed
```

#### AC-14: Temperature Compliance Audit

```gherkin
Scenario: Log temperature zone overrides
  Given temperature mismatch warning shown
  When user overrides and proceeds
  Then audit log entry created:
    | Field | Value |
    | event_type | temp_zone_override |
    | shipment_id | {uuid} |
    | expected_zone | frozen |
    | actual_zone | chilled |
    | overridden_by | {user_id} |
    | reason | {optional user comment} |

Scenario: Temperature compliance report
  Given completed appointments in date range
  When generating compliance report
  Then report shows:
    | Metric | Value |
    | Total loads | 100 |
    | Temp-compliant | 95 |
    | Temp overrides | 5 |
    | Override rate | 5% |
```

### RLS and Multi-tenancy

#### AC-15: Org Isolation

```gherkin
Scenario: Dock door org isolation
  Given User A from Org A
  And User B from Org B
  When User A requests GET /api/shipping/dock-doors
  Then only Org A dock doors returned

Scenario: Cross-tenant appointment access
  Given appointment belongs to Org B
  When User A from Org A requests /api/shipping/dock-appointments/{orgB_appointment}
  Then 404 Not Found returned (not 403)

Scenario: Load plan org isolation
  Given load plan in Org B
  When User A queries load_plan_items
  Then no results returned (RLS blocks)
```

## Technical Specification

### Database Schema

```sql
-- =============================================================================
-- Dock Doors Table (already defined in PRD, enhancing)
-- =============================================================================

CREATE TABLE dock_doors (
  -- Identity
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,

  -- Door Info
  door_code TEXT NOT NULL,
  door_name TEXT NOT NULL,
  door_type TEXT NOT NULL DEFAULT 'shipping'
    CHECK (door_type IN ('shipping', 'receiving', 'both')),

  -- Temperature
  temperature_zone TEXT NOT NULL DEFAULT 'ambient'
    CHECK (temperature_zone IN ('ambient', 'chilled', 'frozen')),

  -- Location (optional link to physical location)
  warehouse_id UUID NOT NULL REFERENCES warehouses(id),
  location_id UUID REFERENCES locations(id),

  -- Status
  is_active BOOLEAN NOT NULL DEFAULT true,

  -- Capacity (optional)
  max_truck_height_m DECIMAL(5,2),

  -- Metadata
  notes TEXT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  created_by UUID REFERENCES users(id),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),

  -- Constraints
  CONSTRAINT dock_doors_org_code_unique UNIQUE(org_id, door_code)
);

-- =============================================================================
-- Dock Appointments Table (already defined in PRD, enhancing)
-- =============================================================================

CREATE TABLE dock_appointments (
  -- Identity
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  appointment_number TEXT NOT NULL,

  -- Door Reference
  dock_door_id UUID NOT NULL REFERENCES dock_doors(id),

  -- Type
  appointment_type TEXT NOT NULL DEFAULT 'shipping'
    CHECK (appointment_type IN ('shipping', 'receiving')),

  -- Shipment Link (nullable for placeholder appointments)
  shipment_id UUID REFERENCES shipments(id),

  -- Schedule
  scheduled_start TIMESTAMPTZ NOT NULL,
  scheduled_end TIMESTAMPTZ NOT NULL,
  actual_start TIMESTAMPTZ,
  actual_end TIMESTAMPTZ,

  -- Carrier/Truck Info
  carrier TEXT,
  truck_number TEXT,
  driver_name TEXT,
  driver_phone TEXT,

  -- Truck Capacity (optional)
  truck_max_weight_kg DECIMAL(10,2),
  truck_max_pallets INTEGER,
  truck_max_volume_m3 DECIMAL(10,2),

  -- Status
  status TEXT NOT NULL DEFAULT 'scheduled'
    CHECK (status IN ('scheduled', 'checked_in', 'loading', 'completed', 'cancelled')),
  cancellation_reason TEXT,

  -- Metadata
  notes TEXT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  created_by UUID REFERENCES users(id),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),

  -- Constraints
  CONSTRAINT dock_appointments_org_number_unique UNIQUE(org_id, appointment_number),
  CONSTRAINT dock_appointments_time_valid CHECK (scheduled_end > scheduled_start)
);

-- =============================================================================
-- Load Plans Table (new)
-- =============================================================================

CREATE TABLE load_plans (
  -- Identity
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,

  -- Links
  dock_appointment_id UUID NOT NULL REFERENCES dock_appointments(id) ON DELETE CASCADE,

  -- Aggregates (cached for performance)
  total_weight_kg DECIMAL(10,2) DEFAULT 0,
  total_pallets INTEGER DEFAULT 0,
  total_boxes INTEGER DEFAULT 0,
  total_volume_m3 DECIMAL(10,2) DEFAULT 0,
  items_loaded INTEGER DEFAULT 0,
  items_total INTEGER DEFAULT 0,

  -- Status
  status TEXT NOT NULL DEFAULT 'draft'
    CHECK (status IN ('draft', 'confirmed', 'loading', 'completed')),

  -- Timestamps
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  created_by UUID REFERENCES users(id),
  confirmed_at TIMESTAMPTZ,
  completed_at TIMESTAMPTZ,

  -- Constraints
  CONSTRAINT load_plans_appointment_unique UNIQUE(dock_appointment_id)
);

-- =============================================================================
-- Load Plan Items Table (new)
-- =============================================================================

CREATE TABLE load_plan_items (
  -- Identity
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  -- Links
  load_plan_id UUID NOT NULL REFERENCES load_plans(id) ON DELETE CASCADE,
  shipment_id UUID NOT NULL REFERENCES shipments(id),

  -- Item Reference (one of these will be set)
  pallet_id UUID REFERENCES pallets(id),
  shipment_box_id UUID REFERENCES shipment_boxes(id),

  -- SSCC for scanning
  sscc TEXT,

  -- Sequence
  load_sequence INTEGER NOT NULL DEFAULT 0,

  -- Item Info (denormalized for display)
  item_type TEXT NOT NULL CHECK (item_type IN ('pallet', 'box')),
  weight_kg DECIMAL(10,2),
  temperature_zone TEXT,

  -- Load Status
  loaded_at TIMESTAMPTZ,
  loaded_by UUID REFERENCES users(id),

  -- Validation
  temp_zone_validated BOOLEAN DEFAULT false,
  temp_zone_override BOOLEAN DEFAULT false,
  temp_zone_override_reason TEXT,

  -- Timestamps
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),

  -- Constraints
  CONSTRAINT load_plan_items_unique_pallet UNIQUE(load_plan_id, pallet_id),
  CONSTRAINT load_plan_items_unique_box UNIQUE(load_plan_id, shipment_box_id),
  CONSTRAINT load_plan_items_has_item CHECK (
    (pallet_id IS NOT NULL AND shipment_box_id IS NULL) OR
    (pallet_id IS NULL AND shipment_box_id IS NOT NULL)
  )
);

-- =============================================================================
-- Load Plan Shipments Junction Table (new)
-- =============================================================================

CREATE TABLE load_plan_shipments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  load_plan_id UUID NOT NULL REFERENCES load_plans(id) ON DELETE CASCADE,
  shipment_id UUID NOT NULL REFERENCES shipments(id),
  added_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),

  CONSTRAINT load_plan_shipments_unique UNIQUE(load_plan_id, shipment_id)
);

-- =============================================================================
-- Appointment Number Sequence
-- =============================================================================

CREATE TABLE appointment_number_sequences (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE UNIQUE,
  current_value BIGINT NOT NULL DEFAULT 0,
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- =============================================================================
-- Indexes for Performance
-- =============================================================================

-- Dock Doors
CREATE INDEX idx_dock_doors_org_active ON dock_doors(org_id, is_active);
CREATE INDEX idx_dock_doors_warehouse ON dock_doors(warehouse_id);
CREATE INDEX idx_dock_doors_type ON dock_doors(org_id, door_type);
CREATE INDEX idx_dock_doors_temp_zone ON dock_doors(org_id, temperature_zone);

-- Dock Appointments
CREATE INDEX idx_dock_appointments_org_status ON dock_appointments(org_id, status);
CREATE INDEX idx_dock_appointments_dock_door ON dock_appointments(dock_door_id);
CREATE INDEX idx_dock_appointments_shipment ON dock_appointments(shipment_id);
CREATE INDEX idx_dock_appointments_schedule ON dock_appointments(dock_door_id, scheduled_start, scheduled_end);
CREATE INDEX idx_dock_appointments_date_range ON dock_appointments(org_id, scheduled_start, scheduled_end);

-- Load Plans
CREATE INDEX idx_load_plans_appointment ON load_plans(dock_appointment_id);
CREATE INDEX idx_load_plans_org_status ON load_plans(org_id, status);

-- Load Plan Items
CREATE INDEX idx_load_plan_items_plan ON load_plan_items(load_plan_id);
CREATE INDEX idx_load_plan_items_shipment ON load_plan_items(shipment_id);
CREATE INDEX idx_load_plan_items_sscc ON load_plan_items(sscc) WHERE sscc IS NOT NULL;
CREATE INDEX idx_load_plan_items_pallet ON load_plan_items(pallet_id) WHERE pallet_id IS NOT NULL;
CREATE INDEX idx_load_plan_items_box ON load_plan_items(shipment_box_id) WHERE shipment_box_id IS NOT NULL;
CREATE INDEX idx_load_plan_items_unloaded ON load_plan_items(load_plan_id) WHERE loaded_at IS NULL;

-- =============================================================================
-- Functions: Generate Appointment Number
-- =============================================================================

CREATE OR REPLACE FUNCTION generate_appointment_number(p_org_id UUID)
RETURNS TEXT AS $$
DECLARE
  v_prefix TEXT := 'APT-';
  v_year TEXT := TO_CHAR(NOW(), 'YYYY');
  v_next_val BIGINT;
  v_appointment_number TEXT;
BEGIN
  INSERT INTO appointment_number_sequences (org_id, current_value)
  VALUES (p_org_id, 1)
  ON CONFLICT (org_id)
  DO UPDATE SET
    current_value = appointment_number_sequences.current_value + 1,
    updated_at = NOW()
  RETURNING current_value INTO v_next_val;

  v_appointment_number := v_prefix || v_year || '-' || LPAD(v_next_val::TEXT, 5, '0');
  RETURN v_appointment_number;
END;
$$ LANGUAGE plpgsql;

-- =============================================================================
-- Functions: Check Appointment Overlap
-- =============================================================================

CREATE OR REPLACE FUNCTION check_appointment_overlap(
  p_dock_door_id UUID,
  p_scheduled_start TIMESTAMPTZ,
  p_scheduled_end TIMESTAMPTZ,
  p_exclude_appointment_id UUID DEFAULT NULL
)
RETURNS BOOLEAN AS $$
DECLARE
  v_overlap_count INTEGER;
BEGIN
  SELECT COUNT(*) INTO v_overlap_count
  FROM dock_appointments
  WHERE dock_door_id = p_dock_door_id
    AND status NOT IN ('cancelled', 'completed')
    AND (p_exclude_appointment_id IS NULL OR id != p_exclude_appointment_id)
    AND (scheduled_start, scheduled_end) OVERLAPS (p_scheduled_start, p_scheduled_end);

  RETURN v_overlap_count > 0;
END;
$$ LANGUAGE plpgsql;

-- =============================================================================
-- Trigger: Update Load Plan Aggregates
-- =============================================================================

CREATE OR REPLACE FUNCTION update_load_plan_aggregates()
RETURNS TRIGGER AS $$
DECLARE
  v_load_plan_id UUID;
  v_totals RECORD;
BEGIN
  IF TG_OP = 'DELETE' THEN
    v_load_plan_id := OLD.load_plan_id;
  ELSE
    v_load_plan_id := NEW.load_plan_id;
  END IF;

  SELECT
    COALESCE(SUM(weight_kg), 0) AS total_weight,
    COUNT(*) FILTER (WHERE item_type = 'pallet') AS total_pallets,
    COUNT(*) FILTER (WHERE item_type = 'box') AS total_boxes,
    COUNT(*) AS items_total,
    COUNT(*) FILTER (WHERE loaded_at IS NOT NULL) AS items_loaded
  INTO v_totals
  FROM load_plan_items
  WHERE load_plan_id = v_load_plan_id;

  UPDATE load_plans SET
    total_weight_kg = v_totals.total_weight,
    total_pallets = v_totals.total_pallets,
    total_boxes = v_totals.total_boxes,
    items_total = v_totals.items_total,
    items_loaded = v_totals.items_loaded
  WHERE id = v_load_plan_id;

  RETURN COALESCE(NEW, OLD);
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER tr_load_plan_items_aggregates
AFTER INSERT OR UPDATE OR DELETE ON load_plan_items
FOR EACH ROW EXECUTE FUNCTION update_load_plan_aggregates();

-- =============================================================================
-- RLS Policies
-- =============================================================================

ALTER TABLE dock_doors ENABLE ROW LEVEL SECURITY;
ALTER TABLE dock_appointments ENABLE ROW LEVEL SECURITY;
ALTER TABLE load_plans ENABLE ROW LEVEL SECURITY;
ALTER TABLE load_plan_items ENABLE ROW LEVEL SECURITY;
ALTER TABLE load_plan_shipments ENABLE ROW LEVEL SECURITY;
ALTER TABLE appointment_number_sequences ENABLE ROW LEVEL SECURITY;

-- Dock Doors: Org isolation
CREATE POLICY "dock_doors_select_org" ON dock_doors
FOR SELECT TO authenticated
USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

CREATE POLICY "dock_doors_insert_org" ON dock_doors
FOR INSERT TO authenticated
WITH CHECK (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

CREATE POLICY "dock_doors_update_org" ON dock_doors
FOR UPDATE TO authenticated
USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()))
WITH CHECK (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

CREATE POLICY "dock_doors_delete_org" ON dock_doors
FOR DELETE TO authenticated
USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

-- Dock Appointments: Org isolation
CREATE POLICY "dock_appointments_select_org" ON dock_appointments
FOR SELECT TO authenticated
USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

CREATE POLICY "dock_appointments_insert_org" ON dock_appointments
FOR INSERT TO authenticated
WITH CHECK (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

CREATE POLICY "dock_appointments_update_org" ON dock_appointments
FOR UPDATE TO authenticated
USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()))
WITH CHECK (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

CREATE POLICY "dock_appointments_delete_org" ON dock_appointments
FOR DELETE TO authenticated
USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

-- Load Plans: Via org_id
CREATE POLICY "load_plans_select_org" ON load_plans
FOR SELECT TO authenticated
USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

CREATE POLICY "load_plans_insert_org" ON load_plans
FOR INSERT TO authenticated
WITH CHECK (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

CREATE POLICY "load_plans_update_org" ON load_plans
FOR UPDATE TO authenticated
USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()))
WITH CHECK (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

CREATE POLICY "load_plans_delete_org" ON load_plans
FOR DELETE TO authenticated
USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

-- Load Plan Items: Via load_plan org
CREATE POLICY "load_plan_items_select" ON load_plan_items
FOR SELECT TO authenticated
USING (
  load_plan_id IN (
    SELECT id FROM load_plans
    WHERE org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  )
);

CREATE POLICY "load_plan_items_insert" ON load_plan_items
FOR INSERT TO authenticated
WITH CHECK (
  load_plan_id IN (
    SELECT id FROM load_plans
    WHERE org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  )
);

CREATE POLICY "load_plan_items_update" ON load_plan_items
FOR UPDATE TO authenticated
USING (
  load_plan_id IN (
    SELECT id FROM load_plans
    WHERE org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  )
);

CREATE POLICY "load_plan_items_delete" ON load_plan_items
FOR DELETE TO authenticated
USING (
  load_plan_id IN (
    SELECT id FROM load_plans
    WHERE org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  )
);

-- Load Plan Shipments: Via load_plan org
CREATE POLICY "load_plan_shipments_all" ON load_plan_shipments
FOR ALL TO authenticated
USING (
  load_plan_id IN (
    SELECT id FROM load_plans
    WHERE org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  )
);

-- Sequences: Org isolation
CREATE POLICY "appointment_seq_org" ON appointment_number_sequences
FOR ALL TO authenticated
USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));
```

### API Endpoints

```
# Dock Doors
GET    /api/shipping/dock-doors                         - List dock doors
GET    /api/shipping/dock-doors/:id                     - Get dock door details
POST   /api/shipping/dock-doors                         - Create dock door
PUT    /api/shipping/dock-doors/:id                     - Update dock door
DELETE /api/shipping/dock-doors/:id                     - Delete dock door (if no appointments)

# Dock Appointments
GET    /api/shipping/dock-appointments                  - List appointments
GET    /api/shipping/dock-appointments/:id              - Get appointment details
POST   /api/shipping/dock-appointments                  - Create appointment
PUT    /api/shipping/dock-appointments/:id              - Update appointment
DELETE /api/shipping/dock-appointments/:id              - Delete appointment

# Appointment Status Actions
POST   /api/shipping/dock-appointments/:id/check-in     - Check in truck
POST   /api/shipping/dock-appointments/:id/start-loading - Start loading
POST   /api/shipping/dock-appointments/:id/complete     - Complete appointment
POST   /api/shipping/dock-appointments/:id/cancel       - Cancel appointment

# Appointment Schedule View
GET    /api/shipping/dock-appointments/schedule         - Calendar data (date range)

# Load Plans
GET    /api/shipping/dock-appointments/:id/load-plan    - Get load plan
POST   /api/shipping/dock-appointments/:id/load-plan    - Create load plan
PUT    /api/shipping/dock-appointments/:id/load-plan    - Update load plan
DELETE /api/shipping/dock-appointments/:id/load-plan    - Delete load plan

# Load Plan Shipments
POST   /api/shipping/dock-appointments/:id/load-plan/add-shipment      - Add shipment
DELETE /api/shipping/dock-appointments/:id/load-plan/shipment/:sid     - Remove shipment

# Load Plan Items
GET    /api/shipping/dock-appointments/:id/load-plan/items             - List items
PUT    /api/shipping/dock-appointments/:id/load-plan/items/:itemId     - Update item (sequence)
POST   /api/shipping/dock-appointments/:id/load-plan/items/:itemId/load - Mark as loaded
POST   /api/shipping/dock-appointments/:id/load-plan/auto-sequence     - Auto-sequence items

# Load Plan Confirmation
POST   /api/shipping/dock-appointments/:id/load-plan/confirm-load      - Confirm all loaded
POST   /api/shipping/dock-appointments/:id/load-plan/scan              - Scan SSCC to load

# Load Manifest
POST   /api/shipping/dock-appointments/:id/manifest                    - Generate manifest PDF
GET    /api/shipping/dock-appointments/:id/manifest                    - Get manifest PDF

# Staging Locations (utility)
GET    /api/warehouse/locations/staging                                - List staging locations
GET    /api/warehouse/locations/staging/available                      - Available staging
```

### Service Layer

```typescript
// lib/services/dock-door-service.ts

export type DoorType = 'shipping' | 'receiving' | 'both';
export type TemperatureZone = 'ambient' | 'chilled' | 'frozen';

export interface DockDoor {
  id: string;
  org_id: string;
  door_code: string;
  door_name: string;
  door_type: DoorType;
  temperature_zone: TemperatureZone;
  warehouse_id: string;
  location_id: string | null;
  is_active: boolean;
  max_truck_height_m: number | null;
  notes: string | null;
  created_at: string;
  updated_at: string;
  // Joined
  warehouse?: { name: string; code: string };
}

export interface CreateDockDoorInput {
  door_code: string;
  door_name: string;
  door_type?: DoorType;
  temperature_zone?: TemperatureZone;
  warehouse_id: string;
  location_id?: string;
  max_truck_height_m?: number;
  notes?: string;
}

export class DockDoorService {
  static async list(params: DockDoorListParams): Promise<DockDoor[]>;
  static async getById(id: string): Promise<DockDoor | null>;
  static async create(data: CreateDockDoorInput): Promise<DockDoor>;
  static async update(id: string, data: Partial<CreateDockDoorInput>): Promise<DockDoor>;
  static async delete(id: string): Promise<void>;
  static async canDeactivate(id: string): Promise<{ can: boolean; reason?: string }>;
}

// lib/services/dock-appointment-service.ts

export type AppointmentStatus = 'scheduled' | 'checked_in' | 'loading' | 'completed' | 'cancelled';

export interface DockAppointment {
  id: string;
  org_id: string;
  appointment_number: string;
  dock_door_id: string;
  appointment_type: 'shipping' | 'receiving';
  shipment_id: string | null;
  scheduled_start: string;
  scheduled_end: string;
  actual_start: string | null;
  actual_end: string | null;
  carrier: string | null;
  truck_number: string | null;
  driver_name: string | null;
  driver_phone: string | null;
  truck_max_weight_kg: number | null;
  truck_max_pallets: number | null;
  truck_max_volume_m3: number | null;
  status: AppointmentStatus;
  cancellation_reason: string | null;
  notes: string | null;
  created_at: string;
  // Joined
  dock_door?: DockDoor;
  shipment?: Shipment;
  load_plan?: LoadPlan;
}

export interface CreateAppointmentInput {
  dock_door_id: string;
  appointment_type: 'shipping' | 'receiving';
  shipment_id?: string;
  scheduled_start: string;
  scheduled_end: string;
  carrier?: string;
  truck_number?: string;
  driver_name?: string;
  driver_phone?: string;
  truck_max_weight_kg?: number;
  truck_max_pallets?: number;
  truck_max_volume_m3?: number;
  notes?: string;
}

export interface ScheduleParams {
  start_date: string;
  end_date: string;
  dock_door_ids?: string[];
  warehouse_id?: string;
}

export class DockAppointmentService {
  // CRUD
  static async list(params: AppointmentListParams): Promise<PaginatedResult<DockAppointment>>;
  static async getById(id: string): Promise<DockAppointment | null>;
  static async create(data: CreateAppointmentInput): Promise<DockAppointment>;
  static async update(id: string, data: Partial<CreateAppointmentInput>): Promise<DockAppointment>;
  static async delete(id: string): Promise<void>;

  // Schedule
  static async getSchedule(params: ScheduleParams): Promise<DockAppointment[]>;
  static async checkOverlap(dockDoorId: string, start: string, end: string, excludeId?: string): Promise<boolean>;

  // Status Actions
  static async checkIn(id: string): Promise<DockAppointment>;
  static async startLoading(id: string): Promise<DockAppointment>;
  static async complete(id: string): Promise<DockAppointment>;
  static async cancel(id: string, reason: string): Promise<DockAppointment>;

  // Validation
  static async validateDoorTypeMatch(dockDoorId: string, appointmentType: string): Promise<boolean>;
  static async validateTempZone(dockDoorId: string, shipmentId: string): Promise<TempZoneValidation>;
}

// lib/services/load-plan-service.ts

export interface LoadPlan {
  id: string;
  org_id: string;
  dock_appointment_id: string;
  total_weight_kg: number;
  total_pallets: number;
  total_boxes: number;
  total_volume_m3: number;
  items_loaded: number;
  items_total: number;
  status: 'draft' | 'confirmed' | 'loading' | 'completed';
  created_at: string;
  confirmed_at: string | null;
  completed_at: string | null;
  // Joined
  items?: LoadPlanItem[];
  shipments?: Shipment[];
}

export interface LoadPlanItem {
  id: string;
  load_plan_id: string;
  shipment_id: string;
  pallet_id: string | null;
  shipment_box_id: string | null;
  sscc: string | null;
  load_sequence: number;
  item_type: 'pallet' | 'box';
  weight_kg: number | null;
  temperature_zone: string | null;
  loaded_at: string | null;
  loaded_by: string | null;
  temp_zone_validated: boolean;
  temp_zone_override: boolean;
  temp_zone_override_reason: string | null;
  // Joined
  pallet?: Pallet;
  shipment_box?: ShipmentBox;
}

export interface CreateLoadPlanInput {
  shipment_ids: string[];
}

export class LoadPlanService {
  // CRUD
  static async get(appointmentId: string): Promise<LoadPlan | null>;
  static async create(appointmentId: string, data: CreateLoadPlanInput): Promise<LoadPlan>;
  static async delete(appointmentId: string): Promise<void>;

  // Shipments
  static async addShipment(appointmentId: string, shipmentId: string): Promise<LoadPlan>;
  static async removeShipment(appointmentId: string, shipmentId: string): Promise<LoadPlan>;

  // Items
  static async getItems(appointmentId: string): Promise<LoadPlanItem[]>;
  static async updateItemSequence(itemId: string, sequence: number): Promise<LoadPlanItem>;
  static async markItemLoaded(itemId: string): Promise<LoadPlanItem>;
  static async scanSSCC(appointmentId: string, sscc: string): Promise<LoadPlanItem>;

  // Sequencing
  static async autoSequence(appointmentId: string): Promise<LoadPlanItem[]>;

  // Confirmation
  static async confirmAllLoaded(appointmentId: string): Promise<LoadPlan>;

  // Manifest
  static async generateManifest(appointmentId: string): Promise<Buffer>;

  // Validation
  static async validateCapacity(appointmentId: string): Promise<CapacityValidation>;
  static async validateTempZones(appointmentId: string): Promise<TempZoneValidation[]>;
}

// Types
export interface TempZoneValidation {
  valid: boolean;
  item_id?: string;
  expected_zone: TemperatureZone;
  actual_zone: TemperatureZone;
  message: string;
}

export interface CapacityValidation {
  valid: boolean;
  weight: { current: number; max: number; exceeded: boolean };
  pallets: { current: number; max: number; exceeded: boolean };
  volume: { current: number; max: number; exceeded: boolean };
  warnings: string[];
}
```

### Validation Schema (Zod)

```typescript
// lib/validation/dock.ts
import { z } from 'zod';

export const doorTypeEnum = z.enum(['shipping', 'receiving', 'both']);
export const temperatureZoneEnum = z.enum(['ambient', 'chilled', 'frozen']);
export const appointmentStatusEnum = z.enum(['scheduled', 'checked_in', 'loading', 'completed', 'cancelled']);
export const appointmentTypeEnum = z.enum(['shipping', 'receiving']);
export const loadPlanStatusEnum = z.enum(['draft', 'confirmed', 'loading', 'completed']);

// Dock Door Schemas
export const createDockDoorSchema = z.object({
  door_code: z.string()
    .min(1, "Door code is required")
    .max(20, "Door code max 20 characters")
    .regex(/^[A-Z0-9\-]+$/i, "Door code: letters, numbers, hyphens only"),
  door_name: z.string()
    .min(1, "Door name is required")
    .max(100, "Door name max 100 characters"),
  door_type: doorTypeEnum.default('shipping'),
  temperature_zone: temperatureZoneEnum.default('ambient'),
  warehouse_id: z.string().uuid("Invalid warehouse ID"),
  location_id: z.string().uuid("Invalid location ID").optional(),
  max_truck_height_m: z.number().positive().max(10).optional(),
  notes: z.string().max(500).nullable().optional(),
});

export const updateDockDoorSchema = createDockDoorSchema.partial();

// Dock Appointment Schemas
export const createAppointmentSchema = z.object({
  dock_door_id: z.string().uuid("Invalid dock door ID"),
  appointment_type: appointmentTypeEnum.default('shipping'),
  shipment_id: z.string().uuid("Invalid shipment ID").optional(),
  scheduled_start: z.string().datetime("Invalid start time"),
  scheduled_end: z.string().datetime("Invalid end time"),
  carrier: z.string().max(50).optional(),
  truck_number: z.string().max(20).optional(),
  driver_name: z.string().max(100).optional(),
  driver_phone: z.string().max(20).optional(),
  truck_max_weight_kg: z.number().positive().max(100000).optional(),
  truck_max_pallets: z.number().int().positive().max(100).optional(),
  truck_max_volume_m3: z.number().positive().max(200).optional(),
  notes: z.string().max(500).nullable().optional(),
}).refine(
  (data) => new Date(data.scheduled_end) > new Date(data.scheduled_start),
  { message: "End time must be after start time", path: ["scheduled_end"] }
);

export const updateAppointmentSchema = createAppointmentSchema.partial();

export const cancelAppointmentSchema = z.object({
  reason: z.string().min(1, "Cancellation reason required").max(200),
});

export const scheduleQuerySchema = z.object({
  start_date: z.string().datetime(),
  end_date: z.string().datetime(),
  dock_door_ids: z.array(z.string().uuid()).optional(),
  warehouse_id: z.string().uuid().optional(),
});

// Load Plan Schemas
export const createLoadPlanSchema = z.object({
  shipment_ids: z.array(z.string().uuid()).min(1, "At least one shipment required"),
});

export const addShipmentSchema = z.object({
  shipment_id: z.string().uuid("Invalid shipment ID"),
});

export const updateItemSequenceSchema = z.object({
  load_sequence: z.number().int().min(0),
});

export const scanSSCCSchema = z.object({
  sscc: z.string().min(1, "SSCC is required"),
});

export const tempZoneOverrideSchema = z.object({
  override: z.boolean(),
  reason: z.string().max(200).optional(),
});

// Query Params
export const dockDoorQuerySchema = z.object({
  warehouse_id: z.string().uuid().optional(),
  door_type: doorTypeEnum.optional(),
  temperature_zone: temperatureZoneEnum.optional(),
  is_active: z.coerce.boolean().optional(),
});

export const appointmentQuerySchema = z.object({
  dock_door_id: z.string().uuid().optional(),
  shipment_id: z.string().uuid().optional(),
  status: appointmentStatusEnum.optional(),
  appointment_type: appointmentTypeEnum.optional(),
  date_from: z.string().datetime().optional(),
  date_to: z.string().datetime().optional(),
  page: z.coerce.number().int().positive().default(1),
  limit: z.coerce.number().int().min(1).max(100).default(50),
});

export type CreateDockDoorInput = z.infer<typeof createDockDoorSchema>;
export type UpdateDockDoorInput = z.infer<typeof updateDockDoorSchema>;
export type CreateAppointmentInput = z.infer<typeof createAppointmentSchema>;
export type UpdateAppointmentInput = z.infer<typeof updateAppointmentSchema>;
export type CreateLoadPlanInput = z.infer<typeof createLoadPlanSchema>;
export type ScheduleQueryParams = z.infer<typeof scheduleQuerySchema>;
```

## UI Components

```
app/(authenticated)/shipping/
  dock-doors/
    page.tsx                              -- Dock doors list page
  dock-schedule/
    page.tsx                              -- Dock appointment calendar
  dock-appointments/
    [id]/
      page.tsx                            -- Appointment detail + load planning

components/shipping/dock/
  DockDoorsDataTable.tsx                  -- DataTable for dock doors
  DockDoorForm.tsx                        -- Create/Edit dock door form
  DockDoorCard.tsx                        -- Dock door display card
  TemperatureZoneBadge.tsx                -- Temp zone badge (ambient/chilled/frozen)
  DoorTypeBadge.tsx                       -- Door type badge (shipping/receiving/both)

components/shipping/appointments/
  AppointmentCalendar.tsx                 -- Full calendar view (day/week/month)
  AppointmentBlock.tsx                    -- Calendar appointment block
  AppointmentStatusBadge.tsx              -- Status badge with colors
  AppointmentDetailModal.tsx              -- Appointment detail popup
  AppointmentForm.tsx                     -- Create/Edit appointment form
  AppointmentTimePicker.tsx               -- Time slot picker
  AppointmentActions.tsx                  -- Status action buttons

components/shipping/loading/
  LoadPlanView.tsx                        -- Load plan overview
  LoadPlanItemsList.tsx                   -- Drag-drop sequenceable item list
  LoadPlanItem.tsx                        -- Single item row with load status
  LoadConfirmationPanel.tsx               -- Scan/confirm interface
  SSCCScanInput.tsx                       -- SSCC barcode scan input
  LoadProgressBar.tsx                     -- Items loaded progress
  CapacityIndicators.tsx                  -- Weight/pallet/volume capacity bars
  TempZoneWarning.tsx                     -- Temperature zone mismatch warning
  LoadManifestPreview.tsx                 -- Manifest preview component

components/shipping/staging/
  StagingLocationSelector.tsx             -- Staging location dropdown
  StagingLocationStatus.tsx               -- Location availability display
  BulkStagingModal.tsx                    -- Bulk assignment modal
```

### Calendar Component (using react-big-calendar or similar)

```tsx
// components/shipping/appointments/AppointmentCalendar.tsx
interface AppointmentCalendarProps {
  appointments: DockAppointment[];
  dockDoors: DockDoor[];
  view: 'day' | 'week' | 'month';
  date: Date;
  onSelectAppointment: (appointment: DockAppointment) => void;
  onSelectSlot: (slot: { start: Date; end: Date; resourceId?: string }) => void;
  onNavigate: (date: Date) => void;
  onViewChange: (view: 'day' | 'week' | 'month') => void;
}
```

### Badge Colors (TailwindCSS)

| Element | Value | Badge Class |
|---------|-------|-------------|
| Temperature | ambient | `bg-green-100 text-green-800` |
| Temperature | chilled | `bg-blue-100 text-blue-800` |
| Temperature | frozen | `bg-purple-100 text-purple-800` |
| Appt Status | scheduled | `bg-blue-100 text-blue-800` |
| Appt Status | checked_in | `bg-yellow-100 text-yellow-800` |
| Appt Status | loading | `bg-orange-100 text-orange-800` |
| Appt Status | completed | `bg-green-100 text-green-800` |
| Appt Status | cancelled | `bg-gray-100 text-gray-500` |
| Door Type | shipping | `bg-indigo-100 text-indigo-800` |
| Door Type | receiving | `bg-teal-100 text-teal-800` |
| Door Type | both | `bg-cyan-100 text-cyan-800` |

## Key Business Rules

1. **Door Code Uniqueness**: Door code must be unique within organization
2. **Door Type Matching**: Appointment type must match dock door type (or door type = 'both')
3. **No Overlapping Appointments**: Same dock door cannot have overlapping time slots
4. **Temperature Zone Validation**: Warn when shipment temp zone doesn't match dock door temp zone
5. **Status Workflow**: Appointments follow strict status flow (scheduled -> checked_in -> loading -> completed)
6. **Completed/Cancelled Immutable**: Cannot modify completed or cancelled appointments
7. **Deactivation Check**: Cannot deactivate dock door with future appointments
8. **Load Sequence**: Items should be loaded in sequence order (back of truck first)
9. **Temperature Priority**: Frozen items load first (back of truck), ambient last
10. **Capacity Warnings**: Warn when approaching/exceeding truck capacity limits

## Deliverables

### Database
- [ ] Migration: `dock_doors` table enhancements
- [ ] Migration: `dock_appointments` table enhancements
- [ ] Migration: `load_plans` table (new)
- [ ] Migration: `load_plan_items` table (new)
- [ ] Migration: `load_plan_shipments` table (new)
- [ ] Migration: `appointment_number_sequences` table
- [ ] Function: `generate_appointment_number(org_id)`
- [ ] Function: `check_appointment_overlap()`
- [ ] Trigger: `update_load_plan_aggregates`
- [ ] RLS policies for all tables
- [ ] Performance indexes

### API Routes
- [ ] `GET /api/shipping/dock-doors` - List
- [ ] `GET /api/shipping/dock-doors/:id` - Get
- [ ] `POST /api/shipping/dock-doors` - Create
- [ ] `PUT /api/shipping/dock-doors/:id` - Update
- [ ] `DELETE /api/shipping/dock-doors/:id` - Delete
- [ ] `GET /api/shipping/dock-appointments` - List
- [ ] `GET /api/shipping/dock-appointments/:id` - Get
- [ ] `POST /api/shipping/dock-appointments` - Create
- [ ] `PUT /api/shipping/dock-appointments/:id` - Update
- [ ] `DELETE /api/shipping/dock-appointments/:id` - Delete
- [ ] `POST /api/shipping/dock-appointments/:id/check-in` - Check in
- [ ] `POST /api/shipping/dock-appointments/:id/start-loading` - Start loading
- [ ] `POST /api/shipping/dock-appointments/:id/complete` - Complete
- [ ] `POST /api/shipping/dock-appointments/:id/cancel` - Cancel
- [ ] `GET /api/shipping/dock-appointments/schedule` - Calendar data
- [ ] `GET /api/shipping/dock-appointments/:id/load-plan` - Get load plan
- [ ] `POST /api/shipping/dock-appointments/:id/load-plan` - Create load plan
- [ ] `POST /api/shipping/dock-appointments/:id/load-plan/scan` - Scan SSCC
- [ ] `POST /api/shipping/dock-appointments/:id/load-plan/confirm-load` - Confirm all
- [ ] `POST /api/shipping/dock-appointments/:id/manifest` - Generate manifest

### Service Layer
- [ ] `DockDoorService.list()`
- [ ] `DockDoorService.create()`
- [ ] `DockDoorService.update()`
- [ ] `DockDoorService.delete()`
- [ ] `DockAppointmentService.list()`
- [ ] `DockAppointmentService.create()`
- [ ] `DockAppointmentService.checkIn()`
- [ ] `DockAppointmentService.startLoading()`
- [ ] `DockAppointmentService.complete()`
- [ ] `DockAppointmentService.cancel()`
- [ ] `DockAppointmentService.getSchedule()`
- [ ] `DockAppointmentService.checkOverlap()`
- [ ] `LoadPlanService.create()`
- [ ] `LoadPlanService.addShipment()`
- [ ] `LoadPlanService.removeShipment()`
- [ ] `LoadPlanService.scanSSCC()`
- [ ] `LoadPlanService.autoSequence()`
- [ ] `LoadPlanService.confirmAllLoaded()`
- [ ] `LoadPlanService.generateManifest()`

### Validation
- [ ] `createDockDoorSchema`
- [ ] `updateDockDoorSchema`
- [ ] `createAppointmentSchema`
- [ ] `updateAppointmentSchema`
- [ ] `cancelAppointmentSchema`
- [ ] `createLoadPlanSchema`
- [ ] `scanSSCCSchema`
- [ ] `scheduleQuerySchema`

### Frontend
- [ ] Dock doors list page (`/shipping/dock-doors`)
- [ ] Dock schedule calendar page (`/shipping/dock-schedule`)
- [ ] Appointment detail page (`/shipping/dock-appointments/:id`)
- [ ] DockDoorsDataTable component
- [ ] DockDoorForm component
- [ ] TemperatureZoneBadge component
- [ ] AppointmentCalendar component
- [ ] AppointmentDetailModal component
- [ ] AppointmentForm component
- [ ] LoadPlanView component
- [ ] LoadPlanItemsList component (drag-drop)
- [ ] LoadConfirmationPanel component
- [ ] SSCCScanInput component
- [ ] CapacityIndicators component
- [ ] TempZoneWarning component
- [ ] StagingLocationSelector component

### Tests
- [ ] Unit tests: DockDoorService (>80% coverage)
- [ ] Unit tests: DockAppointmentService (>80% coverage)
- [ ] Unit tests: LoadPlanService (>80% coverage)
- [ ] Integration tests: All dock API endpoints
- [ ] Integration tests: All appointment API endpoints
- [ ] Integration tests: Load plan workflow
- [ ] RLS tests: Multi-tenancy isolation
- [ ] E2E: Create dock door
- [ ] E2E: Schedule appointment
- [ ] E2E: Check in -> Loading -> Complete workflow
- [ ] E2E: Load plan scan confirmation

## Test Cases

### Unit Tests

**File:** `__tests__/unit/services/dock-door-service.test.ts`

| Test Case | Description |
|-----------|-------------|
| `create()` creates dock door | Verify door created with defaults |
| `create()` rejects duplicate code | 409 error on duplicate |
| `update()` updates door | Fields updated correctly |
| `delete()` deletes door without appointments | Door deleted |
| `delete()` blocks with future appointments | 400 error returned |
| `canDeactivate()` returns false with appointments | Check correctly |

**File:** `__tests__/unit/services/dock-appointment-service.test.ts`

| Test Case | Description |
|-----------|-------------|
| `create()` creates appointment | Appointment created with status=scheduled |
| `create()` rejects overlap | 409 error on overlapping time |
| `create()` rejects door type mismatch | 400 error returned |
| `checkIn()` transitions to checked_in | Status updated, actual_start set |
| `startLoading()` transitions to loading | Status updated |
| `complete()` transitions to completed | Status updated, actual_end set |
| `cancel()` transitions to cancelled | Status updated, reason stored |
| `checkIn()` rejects from completed | 400 error returned |
| `checkOverlap()` detects overlap | Returns true for overlap |

**File:** `__tests__/unit/services/load-plan-service.test.ts`

| Test Case | Description |
|-----------|-------------|
| `create()` creates load plan with items | Plan and items created |
| `addShipment()` adds shipment items | Items added with sequence |
| `removeShipment()` removes shipment items | Items removed, re-sequenced |
| `scanSSCC()` marks item loaded | loaded_at set |
| `scanSSCC()` rejects unknown SSCC | 404 error returned |
| `autoSequence()` sequences by temp zone | Frozen first, ambient last |
| `validateCapacity()` detects exceeded | Warnings returned |
| `validateTempZones()` detects mismatch | Validation results returned |

### Integration Tests

**File:** `__tests__/integration/api/shipping/dock-doors.test.ts`

| Test Case | Description |
|-----------|-------------|
| GET `/dock-doors` returns list | Filtered by org |
| POST `/dock-doors` creates door | Door created |
| PUT `/dock-doors/:id` updates door | Door updated |
| DELETE `/dock-doors/:id` deletes | Door deleted |
| Cross-org access returns 404 | RLS enforced |

**File:** `__tests__/integration/api/shipping/dock-appointments.test.ts`

| Test Case | Description |
|-----------|-------------|
| POST `/dock-appointments` creates | Appointment created |
| POST `/dock-appointments/:id/check-in` works | Status updated |
| POST `/dock-appointments/:id/complete` works | Status updated |
| Overlap rejection works | 409 error on overlap |
| GET `/dock-appointments/schedule` returns | Calendar data correct |

### E2E Tests

**File:** `__tests__/e2e/shipping/dock-loading.spec.ts`

| Test Case | Description |
|-----------|-------------|
| Create dock door via form | Modal flow works |
| Schedule appointment in calendar | Calendar interaction works |
| Check in appointment | Status transitions |
| Create load plan | Plan created from shipments |
| Scan SSCC to confirm load | Items marked loaded |
| Complete load workflow | Full workflow end-to-end |
| Temperature zone warning | Warning displayed on mismatch |

## Definition of Done

### Database
- [ ] All tables created with correct columns
- [ ] Foreign keys and constraints working
- [ ] RLS policies enforce org isolation
- [ ] Indexes created for performance
- [ ] Overlap check function works correctly
- [ ] Aggregates trigger works

### API
- [ ] All endpoints return correct HTTP status codes
- [ ] Validation errors return 400 with messages
- [ ] Cross-tenant access returns 404
- [ ] Response times meet requirements:
  - Dock door lookup: < 100ms
  - Appointment list: < 500ms
  - Schedule query: < 500ms
  - Load plan creation: < 300ms
  - SSCC scan: < 200ms

### Service
- [ ] Appointment status transitions enforced
- [ ] Overlap detection works correctly
- [ ] Temperature zone validation works
- [ ] Capacity validation works
- [ ] Auto-sequence logic correct
- [ ] Manifest PDF generation works

### Frontend
- [ ] Dock doors list page renders DataTable
- [ ] Calendar displays appointments correctly
- [ ] Appointment detail shows load plan
- [ ] Drag-drop sequencing works
- [ ] SSCC scan marks items loaded
- [ ] Temperature warnings display
- [ ] Capacity indicators accurate

### Testing
- [ ] Unit tests: >80% coverage on services
- [ ] Integration tests: All endpoints covered
- [ ] RLS tests: Multi-tenancy verified
- [ ] E2E tests: Critical flows passing

## Security Considerations

1. **RLS Enforcement**: All dock, appointment, and load plan queries filtered by org_id
2. **Role Requirements**: Only MANAGER/ADMIN can delete dock doors
3. **Audit Trail**: created_by, loaded_by tracked for accountability
4. **Temperature Override Logging**: All temp zone overrides logged with reason
5. **Capacity Override Logging**: Capacity exceeded confirmations logged

## Performance Considerations

1. **Calendar Query**: Index on (dock_door_id, scheduled_start, scheduled_end) for efficient range queries
2. **Load Plan Aggregates**: Cached via trigger, avoid N+1 queries
3. **SSCC Lookup**: Index on sscc column for fast scan confirmation
4. **Pagination**: Appointment list paginated for large datasets

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-01-15 | Initial story creation | ARCHITECT-AGENT |
