# 07.18 - SO Advanced Features (Backorder Management + SO Import)

**Story ID:** 07.18
**Epic:** 07 - Shipping
**Phase:** 2-3
**Complexity:** M (Medium)
**Estimate:** 4-5 days
**Priority:** P1
**Type:** Backend + Frontend

**State:** ready
**Primary PRD:** `docs/1-BASELINE/product/modules/shipping.md` (FR-7.16 Backorder Management, FR-7.20 SO Import CSV/API)

## PRD References

| FR ID | Requirement | Priority | Phase | Covered |
|-------|-------------|----------|-------|---------|
| FR-7.16 | Backorder Management | P1 | 2 | Yes |
| FR-7.20 | SO Import (CSV/API) | P2 | 3 | Yes |

## User Story

**As a** Shipping Manager,
**I want** to track and fulfill backorders automatically when inventory becomes available,
**So that** I can ensure customer orders are completed without manual intervention.

**As a** Shipping Clerk,
**I want** to import sales orders via CSV and API,
**So that** I can integrate with external systems and bulk-create orders efficiently.

## Goal

Implement comprehensive backorder management including automatic backorder creation when inventory is insufficient, backorder tracking, and fulfillment workflow when stock arrives. Additionally, provide robust SO import capabilities via CSV file upload and REST API for system integration.

## Scope

**In scope:**
- Backorder creation when allocation insufficient
- `backorders` table for tracking unfulfilled quantities
- Backorder list page with filters (customer, product, date)
- Backorder detail view
- Auto-fulfill backorders when inventory replenished
- Manual backorder fulfillment workflow
- Backorder cancellation
- Backorder-to-SO conversion
- CSV import for bulk SO creation (extends 07.5)
- API import endpoint for integration (JSON payload)
- Import validation with detailed error reporting
- Import history/audit log

**Out of scope:**
- EDI 850 (Purchase Order) inbound - Epic 11
- Automatic PO generation for backorders - Epic 03/MRP
- Backorder priority queues - Phase 3
- Advanced import field mapping - Phase 3
- Real-time inventory sync for backorder fulfillment - Phase 3

## Dependencies

| Story | Requirement | Status |
|-------|-------------|--------|
| 07.2 | Sales Orders Core CRUD | Required - provides SO tables |
| 07.7 | Inventory Allocation | Required - creates backorder signals |
| 07.5 | SO Clone/Import | Required - extends CSV import |
| 05.1-05.4 | Warehouse LP Foundation | Required - inventory source |

## Acceptance Criteria (Given/When/Then)

### Backorder Management (FR-7.16)

#### AC-1: Backorder Creation on Partial Allocation

**Given** SO line for 100 units of Product A
**And** only 60 units available in inventory
**When** allocation runs
**Then** backorder record created with:
- `backorder_qty = 40`
- `sales_order_id`, `sales_order_line_id`
- `product_id`, `customer_id`
- `status = 'pending'`
- `created_at` timestamp

**Given** backorder created
**When** backorder list viewed
**Then** new backorder appears with status "Pending"

#### AC-2: Backorder List Page

**Given** shipping manager navigates to `/shipping/backorders`
**When** page loads
**Then** backorder list displays within 500ms for up to 1000 records

**Given** backorder list displayed
**When** manager filters by customer "Acme Corp"
**Then** only Acme Corp backorders appear

**Given** backorder list displayed
**When** manager filters by product "Widget A"
**Then** only Widget A backorders appear

**Given** backorder list displayed
**When** manager filters by status "pending"
**Then** only pending backorders appear

**Given** backorder list displayed
**When** manager filters by date range "last 7 days"
**Then** only backorders created in last 7 days appear

#### AC-3: Backorder Detail View

**Given** manager clicks backorder row
**When** detail modal/page opens
**Then** displays:
- Backorder number (BO-YYYY-NNNNN)
- Customer name and code
- Product name and SKU
- Original SO number and line number
- Quantity ordered, allocated, backorder
- Created date
- Status (pending, fulfilled, cancelled)
- Fulfillment history (if any)

#### AC-4: Auto-Fulfill Backorder on Inventory Replenish

**Given** backorder exists for 40 units of Product A
**And** status = 'pending'
**When** new LP received with 50 units of Product A
**Then** system triggers backorder fulfillment check

**Given** backorder fulfillment check runs
**And** auto_fulfill_backorders org setting = true
**When** sufficient inventory available
**Then**:
- Backorder `status = 'fulfilled'`
- SO line `quantity_allocated` updated
- New allocation record created
- `fulfilled_at` timestamp set

**Given** partial inventory available (30 units for 40 unit backorder)
**When** auto-fulfillment runs
**Then**:
- Partial fulfillment: 30 units allocated
- Backorder `backorder_qty` reduced to 10
- Status remains 'pending'
- Fulfillment log created

#### AC-5: Manual Backorder Fulfillment

**Given** manager views pending backorder
**And** inventory now available
**When** "Fulfill Backorder" button clicked
**Then** confirmation dialog displays

**Given** confirmation accepted
**When** fulfillment completes
**Then**:
- Backorder status changes to 'fulfilled'
- SO line allocation updated
- Success toast "Backorder fulfilled successfully"

**Given** insufficient inventory for manual fulfillment
**When** "Fulfill Backorder" clicked
**Then** error "Insufficient inventory. Available: X units"

#### AC-6: Backorder Cancellation

**Given** manager views pending backorder
**When** "Cancel Backorder" button clicked
**Then** confirmation dialog displays "Cancel this backorder? The shortage will not be fulfilled."

**Given** confirmation accepted
**When** cancellation completes
**Then**:
- Backorder `status = 'cancelled'`
- `cancelled_at` timestamp set
- `cancelled_by` user recorded
- `cancellation_reason` captured (required)

**Given** backorder already fulfilled
**When** cancel attempted
**Then** error "Cannot cancel fulfilled backorder"

#### AC-7: Backorder-to-New-SO Conversion

**Given** manager views cancelled/expired backorder
**When** "Create New Order" button clicked
**Then** new SO wizard opens pre-populated with:
- Same customer
- Same product
- Same quantity
- Default shipping address

**Given** new SO created from backorder
**When** SO saved
**Then**:
- Original backorder linked via `converted_to_so_id`
- Backorder status = 'converted'

#### AC-8: Backorder Dashboard Metrics

**Given** shipping dashboard viewed
**When** dashboard loads
**Then** backorder KPI card displays:
- Total pending backorders count
- Total backorder value (qty * unit_price)
- Oldest pending backorder age

**Given** dashboard displays backorder metrics
**When** KPI card clicked
**Then** navigates to `/shipping/backorders?status=pending`

### SO Import - CSV (FR-7.20)

#### AC-9: CSV Import - Enhanced Format

**Given** clerk clicks "Import Orders" button
**When** import dialog opens
**Then** displays:
- File upload dropzone
- Format instructions
- "Download Template" link
- Column mapping preview

**Given** clerk uploads valid CSV with required columns:
```csv
customer_code,product_code,quantity,unit_price
ACME001,PROD-001,100,10.50
```
**When** file parsed
**Then** preview table displays with validation status

**Given** clerk uploads CSV with extended columns:
```csv
customer_code,product_code,quantity,unit_price,customer_po,promised_ship_date,shipping_address_code,notes
ACME001,PROD-001,100,10.50,PO-12345,2025-12-20,ADDR-001,Rush order
```
**When** file parsed
**Then** all fields mapped correctly in preview

#### AC-10: CSV Import - Shipping Address Mapping

**Given** CSV row includes `shipping_address_code`
**And** address code exists for customer
**When** import processes
**Then** SO created with specified shipping address

**Given** CSV row has invalid `shipping_address_code`
**When** validation runs
**Then** error "Shipping address 'ADDR-XXX' not found for customer"

**Given** CSV row has no `shipping_address_code`
**When** import processes
**Then** SO uses customer's default shipping address

#### AC-11: CSV Import - Batch Processing

**Given** CSV file with 500 rows (200 customers)
**When** import started
**Then**:
- Progress indicator displays
- Import runs in background
- User can close dialog
- Notification on completion

**Given** large import completes
**When** results viewed
**Then** summary shows:
- Total rows processed
- Orders created
- Lines imported
- Errors (with row numbers)
- Processing time

#### AC-12: CSV Import - Duplicate Detection

**Given** CSV has duplicate rows (same customer, product, quantity)
**When** validation runs
**Then** warning "Row X appears to be duplicate of Row Y"

**Given** duplicate warning displayed
**When** clerk confirms import
**Then** duplicates imported as separate lines (allowed)

### SO Import - API (FR-7.20)

#### AC-13: API Import Endpoint

**Given** external system has valid API key
**When** POST `/api/shipping/sales-orders/import` called with JSON:
```json
{
  "orders": [
    {
      "customer_code": "ACME001",
      "customer_po": "PO-12345",
      "promised_ship_date": "2025-12-20",
      "lines": [
        {
          "product_code": "PROD-001",
          "quantity": 100,
          "unit_price": 10.50
        }
      ]
    }
  ]
}
```
**Then** SOs created for each order object
**And** response includes created order IDs

#### AC-14: API Import - Validation Response

**Given** API import request with invalid data
**When** validation fails
**Then** response returns 400 with:
```json
{
  "success": false,
  "errors": [
    {
      "order_index": 0,
      "line_index": 0,
      "field": "product_code",
      "error": "Product 'INVALID' not found"
    }
  ]
}
```

#### AC-15: API Import - Authentication

**Given** request without API key
**When** import endpoint called
**Then** 401 Unauthorized returned

**Given** request with invalid API key
**When** import endpoint called
**Then** 403 Forbidden returned

**Given** API key belongs to different org
**When** import references that org's customers
**Then** validation error "Customer not found" (RLS enforced)

#### AC-16: API Import - Rate Limiting

**Given** API import endpoint
**When** more than 100 requests per minute from same API key
**Then** 429 Too Many Requests returned with retry-after header

#### AC-17: Import History/Audit

**Given** any import (CSV or API) completes
**When** import finishes
**Then** `import_logs` record created with:
- Import type (csv, api)
- User/API key
- Timestamp
- Success/failure
- Orders created count
- Error details (JSON)

**Given** manager navigates to `/shipping/imports/history`
**When** page loads
**Then** import history table displays:
- Date/time
- Type (CSV/API)
- User
- Status
- Orders created
- Errors

### Multi-tenancy & Permissions

#### AC-18: Backorder RLS

**Given** user from org A
**When** backorder list queried
**Then** only org A backorders returned

**Given** user from org B tries to access org A backorder by ID
**When** API request made
**Then** 404 Not Found (RLS blocks)

#### AC-19: Permission Enforcement

**Given** user with VIEWER role
**When** backorder list viewed
**Then** "Fulfill" and "Cancel" buttons hidden

**Given** user with SALES role
**When** backorder list viewed
**Then** "Fulfill" button visible
**And** "Cancel" button hidden (requires MANAGER+)

**Given** user with MANAGER role
**When** backorder list viewed
**Then** all actions visible

## Technical Specification

### Database Schema

#### backorders table

```sql
CREATE TABLE backorders (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,

  -- Identifiers
  backorder_number TEXT NOT NULL,          -- BO-YYYY-NNNNN

  -- Relationships
  sales_order_id UUID NOT NULL REFERENCES sales_orders(id),
  sales_order_line_id UUID NOT NULL REFERENCES sales_order_lines(id),
  customer_id UUID NOT NULL REFERENCES customers(id),
  product_id UUID NOT NULL REFERENCES products(id),

  -- Quantities
  quantity_ordered DECIMAL(15,4) NOT NULL,
  quantity_allocated DECIMAL(15,4) DEFAULT 0,
  backorder_qty DECIMAL(15,4) NOT NULL,    -- quantity_ordered - quantity_allocated

  -- Status
  status TEXT NOT NULL DEFAULT 'pending',  -- pending, fulfilled, cancelled, converted
  priority TEXT DEFAULT 'normal',          -- low, normal, high, urgent

  -- Timestamps
  created_at TIMESTAMPTZ DEFAULT NOW(),
  fulfilled_at TIMESTAMPTZ,
  cancelled_at TIMESTAMPTZ,
  converted_at TIMESTAMPTZ,

  -- User tracking
  created_by UUID REFERENCES users(id),
  fulfilled_by UUID REFERENCES users(id),
  cancelled_by UUID REFERENCES users(id),
  cancellation_reason TEXT,

  -- Conversion tracking
  converted_to_so_id UUID REFERENCES sales_orders(id),

  -- Constraints
  UNIQUE(org_id, backorder_number),
  CHECK (backorder_qty > 0)
);

-- Indexes
CREATE INDEX idx_backorders_org_status ON backorders(org_id, status);
CREATE INDEX idx_backorders_customer ON backorders(customer_id);
CREATE INDEX idx_backorders_product ON backorders(product_id);
CREATE INDEX idx_backorders_so_line ON backorders(sales_order_line_id);
CREATE INDEX idx_backorders_created_at ON backorders(created_at DESC);

-- RLS
ALTER TABLE backorders ENABLE ROW LEVEL SECURITY;

CREATE POLICY "backorders_org_isolation" ON backorders
  FOR ALL USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));
```

#### backorder_fulfillments table

```sql
CREATE TABLE backorder_fulfillments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id),
  backorder_id UUID NOT NULL REFERENCES backorders(id) ON DELETE CASCADE,

  -- Fulfillment details
  quantity_fulfilled DECIMAL(15,4) NOT NULL,
  allocation_id UUID REFERENCES inventory_allocations(id),
  license_plate_id UUID REFERENCES license_plates(id),

  -- Tracking
  fulfilled_at TIMESTAMPTZ DEFAULT NOW(),
  fulfilled_by UUID REFERENCES users(id),
  fulfillment_type TEXT DEFAULT 'manual', -- manual, auto
  notes TEXT,

  CONSTRAINT positive_fulfillment CHECK (quantity_fulfilled > 0)
);

-- Index
CREATE INDEX idx_backorder_fulfillments_backorder ON backorder_fulfillments(backorder_id);

-- RLS
ALTER TABLE backorder_fulfillments ENABLE ROW LEVEL SECURITY;

CREATE POLICY "backorder_fulfillments_org_isolation" ON backorder_fulfillments
  FOR ALL USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));
```

#### import_logs table

```sql
CREATE TABLE import_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id),

  -- Import details
  import_type TEXT NOT NULL,               -- csv, api
  file_name TEXT,                          -- Original filename (CSV only)

  -- Results
  status TEXT NOT NULL DEFAULT 'processing', -- processing, completed, failed
  rows_processed INTEGER DEFAULT 0,
  orders_created INTEGER DEFAULT 0,
  lines_imported INTEGER DEFAULT 0,
  errors_count INTEGER DEFAULT 0,
  error_details JSONB,                     -- Array of {row, field, error}

  -- Tracking
  started_at TIMESTAMPTZ DEFAULT NOW(),
  completed_at TIMESTAMPTZ,
  imported_by UUID REFERENCES users(id),
  api_key_id UUID,                         -- If API import

  -- Performance
  processing_time_ms INTEGER
);

-- Index
CREATE INDEX idx_import_logs_org ON import_logs(org_id, started_at DESC);

-- RLS
ALTER TABLE import_logs ENABLE ROW LEVEL SECURITY;

CREATE POLICY "import_logs_org_isolation" ON import_logs
  FOR ALL USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));
```

#### Organization settings extension

```sql
-- Add backorder settings
ALTER TABLE organizations ADD COLUMN IF NOT EXISTS
  auto_fulfill_backorders BOOLEAN DEFAULT true;

ALTER TABLE organizations ADD COLUMN IF NOT EXISTS
  backorder_notification_email TEXT;
```

### API Endpoints

```
# Backorder Management
GET    /api/shipping/backorders                     - List backorders (filters: status, customer_id, product_id, date_from, date_to)
GET    /api/shipping/backorders/:id                 - Get backorder detail
POST   /api/shipping/backorders/:id/fulfill         - Manually fulfill backorder
POST   /api/shipping/backorders/:id/cancel          - Cancel backorder
POST   /api/shipping/backorders/:id/convert         - Convert to new SO

# Backorder Reports
GET    /api/shipping/reports/backorders             - Backorder summary report

# SO Import (extends 07.5)
POST   /api/shipping/sales-orders/import            - Import SOs (CSV or JSON)
GET    /api/shipping/imports/history                - Import history list
GET    /api/shipping/imports/:id                    - Import detail/results
```

### Service Methods

**Location:** `lib/services/backorder-service.ts`

```typescript
interface BackorderService {
  // CRUD
  getBackorders(params: BackorderListParams): Promise<BackorderListResponse>;
  getBackorder(id: string): Promise<BackorderDetail>;

  // Creation (called by AllocationService)
  createBackorder(data: CreateBackorderData): Promise<Backorder>;

  // Fulfillment
  fulfillBackorder(id: string, userId: string): Promise<FulfillResult>;
  autoFulfillBackorders(orgId: string, productId: string): Promise<AutoFulfillResult>;

  // Cancellation
  cancelBackorder(id: string, reason: string, userId: string): Promise<Backorder>;

  // Conversion
  convertToSalesOrder(id: string, userId: string): Promise<SalesOrder>;

  // Queries
  getPendingBackordersForProduct(productId: string): Promise<Backorder[]>;
  getBackorderMetrics(orgId: string): Promise<BackorderMetrics>;

  // Helpers
  generateBackorderNumber(orgId: string): Promise<string>;
}
```

**Location:** `lib/services/import-service.ts`

```typescript
interface ImportService {
  // CSV Import
  importFromCSV(orgId: string, csvData: string, userId: string): Promise<ImportResult>;
  parseCSV(csvData: string): ParsedCSVRow[];
  validateCSVRow(orgId: string, row: CSVRow): Promise<ValidationResult>;

  // API Import
  importFromAPI(orgId: string, orders: APIOrderInput[]): Promise<ImportResult>;
  validateAPIOrder(orgId: string, order: APIOrderInput): Promise<ValidationResult>;

  // Common
  createOrdersFromImport(orgId: string, validatedRows: ValidatedRow[]): Promise<CreatedOrder[]>;

  // History
  getImportHistory(orgId: string, params: HistoryParams): Promise<ImportLog[]>;
  getImportDetail(importId: string): Promise<ImportLogDetail>;

  // Logging
  createImportLog(data: ImportLogData): Promise<ImportLog>;
  updateImportLog(id: string, results: ImportResults): Promise<void>;
}
```

### Zod Validation Schemas

**Location:** `lib/validation/backorder-schema.ts`

```typescript
import { z } from 'zod';

export const backorderSchema = z.object({
  id: z.string().uuid(),
  backorder_number: z.string(),
  sales_order_id: z.string().uuid(),
  sales_order_line_id: z.string().uuid(),
  customer_id: z.string().uuid(),
  product_id: z.string().uuid(),
  quantity_ordered: z.number().positive(),
  quantity_allocated: z.number().nonnegative(),
  backorder_qty: z.number().positive(),
  status: z.enum(['pending', 'fulfilled', 'cancelled', 'converted']),
  priority: z.enum(['low', 'normal', 'high', 'urgent']),
  created_at: z.string().datetime(),
});

export const cancelBackorderSchema = z.object({
  reason: z.string().min(1, 'Cancellation reason is required').max(500),
});

export const backorderFiltersSchema = z.object({
  status: z.enum(['pending', 'fulfilled', 'cancelled', 'converted']).optional(),
  customer_id: z.string().uuid().optional(),
  product_id: z.string().uuid().optional(),
  date_from: z.string().datetime().optional(),
  date_to: z.string().datetime().optional(),
  page: z.number().int().positive().default(1),
  limit: z.number().int().min(1).max(100).default(25),
});
```

**Location:** `lib/validation/import-schema.ts`

```typescript
import { z } from 'zod';

// API Import Order Schema
export const apiOrderInputSchema = z.object({
  customer_code: z.string().min(1, 'Customer code is required'),
  customer_po: z.string().max(100).optional(),
  shipping_address_code: z.string().optional(),
  promised_ship_date: z.string().datetime().optional(),
  required_delivery_date: z.string().datetime().optional(),
  notes: z.string().max(1000).optional(),
  lines: z.array(z.object({
    product_code: z.string().min(1, 'Product code is required'),
    quantity: z.number().positive('Quantity must be greater than zero'),
    unit_price: z.number().nonnegative('Unit price cannot be negative').optional(),
    requested_lot: z.string().optional(),
    notes: z.string().max(500).optional(),
  })).min(1, 'Order must have at least one line'),
});

export const apiImportRequestSchema = z.object({
  orders: z.array(apiOrderInputSchema).min(1).max(100, 'Maximum 100 orders per request'),
});

// CSV Row Schema
export const csvRowSchema = z.object({
  customer_code: z.string().min(1),
  product_code: z.string().min(1),
  quantity: z.string().refine(v => !isNaN(parseFloat(v)) && parseFloat(v) > 0),
  unit_price: z.string().optional().refine(v => !v || (!isNaN(parseFloat(v)) && parseFloat(v) >= 0)),
  customer_po: z.string().optional(),
  shipping_address_code: z.string().optional(),
  promised_ship_date: z.string().optional(),
  required_delivery_date: z.string().optional(),
  notes: z.string().optional(),
});
```

## UI Components

### Pages

- `app/(authenticated)/shipping/backorders/page.tsx` - Backorder list page
- `app/(authenticated)/shipping/backorders/[id]/page.tsx` - Backorder detail (optional, can use modal)
- `app/(authenticated)/shipping/imports/history/page.tsx` - Import history page

### Components

**Location:** `components/shipping/backorders/`

```
BackorderList.tsx           - List with filters
BackorderTable.tsx          - Data table with actions
BackorderFilters.tsx        - Status, customer, product, date filters
BackorderDetail.tsx         - Detail view (modal or page)
BackorderStatusBadge.tsx    - Status indicator
FulfillBackorderDialog.tsx  - Fulfillment confirmation
CancelBackorderDialog.tsx   - Cancellation with reason
ConvertToOrderDialog.tsx    - Convert to new SO
BackorderMetricsCard.tsx    - Dashboard KPI card
```

**Location:** `components/shipping/imports/`

```
ImportOrdersDialog.tsx      - CSV/API import dialog (extends 07.5)
ImportPreviewTable.tsx      - Preview with validation (extends 07.5)
ImportHistoryTable.tsx      - Import history list
ImportResultSummary.tsx     - Success/error summary
APIImportDocs.tsx           - API documentation component
```

### UI Patterns

**Backorder List Layout:**
```
+----------------------------------------------------------+
| Backorders                    [Filter] [Export] [Refresh] |
+----------------------------------------------------------+
| Status: [All v]  Customer: [All v]  Product: [All v]     |
| Date: [Last 30 days v]                                    |
+----------------------------------------------------------+
| BO-2025-00001 | Acme Corp | Widget A | 40 units | Pending |
| BO-2025-00002 | Beta Inc  | Gadget B | 25 units | Pending |
| BO-2025-00003 | Gamma LLC | Widget A | 15 units | Fulfilled|
+----------------------------------------------------------+
```

**Backorder Detail Modal:**
```
+------------------------------------------+
| Backorder BO-2025-00001           [Close] |
+------------------------------------------+
| Customer: Acme Corp (ACME001)             |
| Product: Widget A (PROD-001)              |
| Original SO: SO-2025-00123 (Line 2)       |
+------------------------------------------+
| Qty Ordered:    100                       |
| Qty Allocated:   60                       |
| Backorder Qty:   40                       |
+------------------------------------------+
| Status: Pending                           |
| Created: Dec 15, 2025 10:30 AM            |
| Priority: Normal                          |
+------------------------------------------+
| [Cancel Backorder] [Fulfill Backorder]    |
+------------------------------------------+
```

## Test Cases

### Unit Tests

**backorder-service.test.ts**
```typescript
describe('BackorderService', () => {
  describe('createBackorder', () => {
    it('creates backorder with correct quantities');
    it('generates backorder number in BO-YYYY-NNNNN format');
    it('sets status to pending');
  });

  describe('fulfillBackorder', () => {
    it('updates backorder status to fulfilled');
    it('creates fulfillment record');
    it('updates SO line allocation');
    it('handles partial fulfillment');
    it('rejects if insufficient inventory');
  });

  describe('cancelBackorder', () => {
    it('updates status to cancelled');
    it('records cancellation reason');
    it('rejects if already fulfilled');
  });

  describe('autoFulfillBackorders', () => {
    it('fulfills pending backorders when inventory arrives');
    it('respects priority order');
    it('handles partial availability');
  });
});
```

**import-service.test.ts**
```typescript
describe('ImportService', () => {
  describe('importFromCSV', () => {
    it('parses valid CSV correctly');
    it('groups rows by customer');
    it('creates one SO per customer');
    it('validates customer codes');
    it('validates product codes');
    it('validates quantities');
    it('returns row-level errors');
  });

  describe('importFromAPI', () => {
    it('creates orders from valid JSON');
    it('validates order structure');
    it('validates lines');
    it('returns order-level errors');
  });
});
```

### Integration Tests

**backorder-api.test.ts**
```typescript
describe('Backorder API', () => {
  describe('GET /api/shipping/backorders', () => {
    it('returns paginated backorders');
    it('filters by status');
    it('filters by customer');
    it('filters by product');
    it('filters by date range');
    it('enforces RLS');
  });

  describe('POST /api/shipping/backorders/:id/fulfill', () => {
    it('fulfills backorder with available inventory');
    it('returns error if insufficient inventory');
    it('requires SALES+ role');
  });

  describe('POST /api/shipping/backorders/:id/cancel', () => {
    it('cancels pending backorder');
    it('requires cancellation reason');
    it('requires MANAGER+ role');
  });
});
```

**import-api.test.ts**
```typescript
describe('Import API', () => {
  describe('POST /api/shipping/sales-orders/import (CSV)', () => {
    it('imports valid CSV');
    it('returns validation errors');
    it('creates import log');
    it('enforces rate limits');
  });

  describe('POST /api/shipping/sales-orders/import (API)', () => {
    it('imports valid JSON orders');
    it('validates authentication');
    it('returns structured errors');
    it('creates import log');
  });
});
```

### E2E Tests

**backorder.spec.ts**
```typescript
describe('Backorder Management', () => {
  it('creates backorder on partial allocation');
  it('displays backorder in list');
  it('filters backorders');
  it('fulfills backorder manually');
  it('cancels backorder with reason');
  it('converts backorder to new SO');
});
```

**import.spec.ts**
```typescript
describe('SO Import', () => {
  it('imports orders from CSV file');
  it('shows validation errors in preview');
  it('displays import results summary');
  it('records import in history');
});
```

## Security Considerations

1. **API Authentication:**
   - API import requires valid API key (from 01.21)
   - API keys scoped to organization
   - Rate limiting: 100 requests/minute

2. **Permission Enforcement:**
   - Backorder view: All authenticated users
   - Backorder fulfill: SALES, MANAGER, ADMIN, SUPER_ADMIN
   - Backorder cancel: MANAGER, ADMIN, SUPER_ADMIN
   - Import (CSV): SALES, MANAGER, ADMIN, SUPER_ADMIN
   - Import (API): Valid API key with import scope

3. **Data Validation:**
   - All customer/product codes validated against org scope
   - RLS ensures cross-tenant isolation
   - Import file size limit: 5MB

4. **Audit Trail:**
   - All backorder status changes logged
   - Import operations logged with full details
   - API requests logged with key ID

## Deliverables

- [ ] `backorders` table migration
- [ ] `backorder_fulfillments` table migration
- [ ] `import_logs` table migration
- [ ] Organizations table extension (auto_fulfill setting)
- [ ] RLS policies for all new tables
- [ ] BackorderService with CRUD and fulfillment
- [ ] ImportService with CSV and API import
- [ ] Zod schemas for backorder and import
- [ ] API routes for backorder management
- [ ] API routes for import (extends 07.5)
- [ ] BackorderList component
- [ ] BackorderDetail component
- [ ] FulfillBackorderDialog component
- [ ] CancelBackorderDialog component
- [ ] ImportOrdersDialog extension
- [ ] ImportHistoryTable component
- [ ] BackorderMetricsCard for dashboard
- [ ] Unit tests (>80% coverage)
- [ ] Integration tests
- [ ] E2E tests

## Definition of Done

- [ ] Backorder created automatically on partial allocation
- [ ] Backorder list page displays with filters
- [ ] Backorder detail shows all relevant information
- [ ] Manual backorder fulfillment works
- [ ] Auto-fulfill triggers when inventory replenished
- [ ] Backorder cancellation with reason works
- [ ] Backorder-to-SO conversion works
- [ ] CSV import extended with shipping_address_code
- [ ] API import endpoint works with JSON payload
- [ ] Import validation returns structured errors
- [ ] Import history logged and viewable
- [ ] Rate limiting enforced on API import
- [ ] RLS policies prevent cross-tenant access
- [ ] Permission checks enforced on all actions
- [ ] Dashboard backorder metrics display
- [ ] Unit tests pass (>80% coverage)
- [ ] Integration tests pass
- [ ] E2E tests pass

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2026-01-15 | Initial story combining FR-7.16 and FR-7.20 | ARCHITECT-AGENT |
