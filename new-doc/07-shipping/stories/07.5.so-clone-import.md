# 07.5 - SO Clone/Template + CSV Import

**Priority:** P1 (Phase 1A - Enhanced)
**Story Points:** M (Medium)
**Complexity:** M (2-3 days)
**Type:** backend + frontend

**State:** ready
**Primary PRD:** `docs/1-BASELINE/product/modules/shipping.md` (FR-7.14, FR-7.20)
**Architecture:** `docs/1-BASELINE/architecture/modules/shipping.md` (lines 382-405)

---

## MVP Scope

This story implements Phase 1A enhanced features for sales order creation: clone functionality to duplicate existing orders, and CSV import for bulk order creation. These features accelerate order entry for repeat customers and migration scenarios.

**In scope:**
- Clone existing SO (preserves customer, address, lines, pricing)
- CSV import with validation and preview
- Row-level error reporting for imports

**Out of scope:**
- SO templates (saved as reusable templates) - Phase 2
- Recurring/scheduled orders - Phase 2
- API-based EDI integration - Epic 11 Integrations
- Advanced import mappings - Phase 2

---

## Dependencies

### Epic Dependencies
- **Epic 01.1** - Org context, RLS, users table
- **Epic 02.1** - Products table (for CSV product code validation)
- **Story 07.1** - Customers table (for CSV customer code validation)

### Story Dependencies (within Epic 07)
- **Story 07.2** - Sales Orders Core CRUD (provides sales_orders and sales_order_lines tables)

### Provides To
- **All SO-related stories** - Faster order creation via clone/import
- **Story 07.7** - Cloned/imported orders can be allocated
- **Migration workflow** - Legacy order import

---

## Goal

Enable shipping clerks to quickly create new orders by cloning existing ones or bulk importing from CSV, reducing manual entry time from 5 minutes per order to under 30 seconds, while maintaining data integrity through validation.

## User Story

As a **Shipping Clerk**, I want to **clone existing sales orders and import orders from CSV** so that **I can quickly create repeat orders and migrate legacy data without manual re-entry**.

## Scope

**In scope (this story)**
- `POST /api/shipping/sales-orders/:id/clone` endpoint
  - Clones SO header (customer, shipping address)
  - Clones all SO lines (product, quantity, unit price)
  - Resets: order_number (new auto-generated), status (draft), dates (cleared), quantities (ordered only)
  - Preserves: customer_id, shipping_address_id, line products, unit prices
- `POST /api/shipping/sales-orders/import` endpoint (CSV)
  - CSV format: customer_code, product_code, quantity, unit_price (optional)
  - Extended format: customer_code, product_code, quantity, unit_price, customer_po, promised_ship_date, notes
  - Validation: customer exists, product exists, quantity > 0, unit_price >= 0
  - Creates draft SO with lines for each valid customer group
  - Returns validation errors (row-level) with line numbers
- Clone button in SO detail page
- Import dialog with file upload + preview table
- Import result summary (success count, error list)
- SO template concept documentation (future enhancement)

**Out of scope (this story)**
- Template library (save SO as reusable template) - Phase 2
- Recurring/scheduled orders (auto-generate on schedule) - Phase 2
- EDI 850 (Purchase Order) inbound integration - Epic 11
- Advanced field mapping for CSV (custom columns) - Phase 2
- Import validation for allergen restrictions - Story 07.6 handles post-creation

---

## Acceptance Criteria (Given/When/Then)

### AC-1: Clone Sales Order - Happy Path

**Given** clerk views SO detail page for SO-2025-00123 (confirmed, shipped)
**When** "Clone Order" button clicked
**Then** confirmation dialog displays "Clone this order?"

**Given** confirmation accepted
**When** clone completes
**Then** new SO created with:
- New order_number (e.g., SO-2025-00456)
- Status: draft
- Same customer_id, shipping_address_id
- Same lines (product, quantity, unit_price)
- Cleared: confirmed_at, shipped_at, all non-ordered quantities (allocated, picked, packed, shipped = 0)
- order_date = today
- promised_ship_date, required_delivery_date = NULL
- customer_po = NULL (must be re-entered)
- notes = copied from original

**Given** clone successful
**When** clerk redirected to new SO detail page
**Then** page displays "Cloned from SO-2025-00123" toast notification

### AC-2: Clone Sales Order - Validation

**Given** clerk attempts to clone SO from different org
**When** API called with invalid SO id
**Then** 404 error "Sales order not found" (RLS blocks)

**Given** clerk clones SO with 10 lines
**When** clone completes
**Then** all 10 lines cloned with new line_number sequence (1-10)

**Given** original SO has 3 lines with line_numbers 1, 5, 10 (gaps)
**When** clone completes
**Then** cloned SO has lines renumbered as 1, 2, 3 (sequential)

### AC-3: CSV Import - Happy Path

**Given** clerk clicks "Import Orders" button
**When** import dialog opens
**Then** file upload dropzone displays with format instructions

**Given** clerk uploads valid CSV:
```csv
customer_code,product_code,quantity,unit_price
ACME001,PROD-001,100,10.50
ACME001,PROD-002,50,25.00
BETA002,PROD-001,200,10.00
```
**When** file parsed
**Then** preview table displays 3 rows with validation status

**Given** preview shows 3 valid rows (2 for ACME, 1 for BETA)
**When** "Import" clicked
**Then** system creates:
- SO 1 for ACME001 with 2 lines
- SO 2 for BETA002 with 1 line
- Both status = draft, order_date = today

**Given** import completes
**When** success dialog displays
**Then** summary shows:
- 2 orders created
- 3 lines imported
- 0 errors
- "View Orders" link to SO list filtered by today

### AC-4: CSV Import - Validation Errors

**Given** clerk uploads CSV with invalid customer:
```csv
customer_code,product_code,quantity,unit_price
INVALID,PROD-001,100,10.50
ACME001,PROD-002,50,25.00
```
**When** file parsed
**Then** preview shows:
- Row 1: Error "Customer 'INVALID' not found"
- Row 2: Valid (green checkmark)

**Given** preview shows 1 error, 1 valid
**When** "Import" clicked
**Then** system:
- Creates SO for ACME001 with 1 line
- Skips row 1
- Returns error summary: "1 row skipped"

**Given** clerk uploads CSV with invalid product:
```csv
customer_code,product_code,quantity,unit_price
ACME001,INVALID-PROD,100,10.50
```
**When** preview displays
**Then** error shows "Product 'INVALID-PROD' not found"

**Given** clerk uploads CSV with invalid quantity:
```csv
customer_code,product_code,quantity,unit_price
ACME001,PROD-001,0,10.50
ACME001,PROD-002,-5,25.00
```
**When** preview displays
**Then** errors show:
- Row 1: "Quantity must be greater than zero"
- Row 2: "Quantity must be greater than zero"

**Given** clerk uploads CSV with negative price:
```csv
customer_code,product_code,quantity,unit_price
ACME001,PROD-001,100,-10.50
```
**When** preview displays
**Then** error shows "Unit price cannot be negative"

### AC-5: CSV Import - Extended Format

**Given** clerk uploads CSV with optional fields:
```csv
customer_code,product_code,quantity,unit_price,customer_po,promised_ship_date,notes
ACME001,PROD-001,100,10.50,PO-12345,2025-12-20,Rush order
ACME001,PROD-002,50,25.00,,,
```
**When** import completes
**Then** SO created with:
- customer_po = "PO-12345"
- promised_ship_date = 2025-12-20
- notes = "Rush order"
- Line 2: inherits SO-level customer_po, dates, notes

### AC-6: CSV Import - Multi-Customer Grouping

**Given** clerk uploads CSV with 5 rows (3 customers):
```csv
customer_code,product_code,quantity,unit_price
ACME001,PROD-001,100,10.50
ACME001,PROD-002,50,25.00
BETA002,PROD-001,200,10.00
BETA002,PROD-003,75,15.00
GAMMA003,PROD-004,300,5.00
```
**When** import completes
**Then** system creates:
- SO 1 for ACME001 (2 lines)
- SO 2 for BETA002 (2 lines)
- SO 3 for GAMMA003 (1 line)

**Given** import creates 3 SOs
**When** success summary displays
**Then** shows "3 orders created, 5 lines imported"

### AC-7: CSV Import - Empty/Malformed File

**Given** clerk uploads empty CSV
**When** file parsed
**Then** error displays "CSV file is empty"

**Given** clerk uploads CSV without header row:
```csv
ACME001,PROD-001,100,10.50
```
**When** file parsed
**Then** error displays "CSV must have header row: customer_code, product_code, quantity"

**Given** clerk uploads CSV with missing required columns:
```csv
customer_code,product_code
ACME001,PROD-001
```
**When** file parsed
**Then** error displays "Missing required columns: quantity"

**Given** clerk uploads non-CSV file (e.g., .xlsx)
**When** file upload attempted
**Then** error displays "Only CSV files (.csv) are supported"

### AC-8: Clone Button Visibility

**Given** clerk views SO with status "draft"
**When** detail page loads
**Then** "Clone Order" button visible

**Given** clerk views SO with status "confirmed"
**When** detail page loads
**Then** "Clone Order" button visible

**Given** clerk views SO with status "cancelled"
**When** detail page loads
**Then** "Clone Order" button visible (can clone cancelled orders)

**Given** clerk has VIEWER role
**When** SO detail page loads
**Then** "Clone Order" button hidden

### AC-9: Import Permission Enforcement

**Given** user with VIEWER role
**When** navigates to `/shipping/sales-orders`
**Then** "Import Orders" button hidden

**Given** user with SALES role
**When** SO list page loads
**Then** "Import Orders" button visible

**Given** user without shipping permissions
**When** attempts to access import endpoint directly
**Then** 403 "Access Denied" error

### AC-10: RLS and Multi-Tenancy

**Given** user from org A clones SO
**When** clone created
**Then** new SO has org_id = org A

**Given** user from org A imports CSV
**When** orders created
**Then** all SOs have org_id = org A

**Given** user from org B tries to clone org A's SO by direct API call
**When** request made
**Then** 404 error (RLS blocks access)

**Given** CSV references customer from org B
**When** org A user imports
**Then** validation error "Customer not found" (customer not in org A's scope)

### AC-11: Allergen Validation State

**Given** original SO has allergen_validated = true
**When** cloned
**Then** new SO has allergen_validated = false (must re-validate)

**Given** imported SO created
**When** SO saved
**Then** allergen_validated = false (Story 07.6 validates later)

---

## Implementation Notes

### API Endpoints

```typescript
// POST /api/shipping/sales-orders/:id/clone
interface CloneSalesOrderResponse {
  original_order_number: string;
  cloned_order: {
    id: UUID;
    order_number: string; // New auto-generated
    status: 'draft';
    customer_id: UUID;
    shipping_address_id: UUID;
    order_date: Date; // Today
    total_amount: number;
    lines: SalesOrderLine[];
  };
}

// POST /api/shipping/sales-orders/import
interface ImportSalesOrdersRequest {
  csv_data: string; // Base64 or raw CSV string
  // OR
  file: File; // Multipart form data
}

interface ImportSalesOrdersResponse {
  success: boolean;
  summary: {
    orders_created: number;
    lines_imported: number;
    rows_processed: number;
    errors_count: number;
  };
  created_orders: {
    id: UUID;
    order_number: string;
    customer_code: string;
    lines_count: number;
  }[];
  errors: {
    row: number; // CSV row number (1-based, excludes header)
    customer_code?: string;
    product_code?: string;
    error: string; // Human-readable error message
  }[];
}

// CSV Format (required columns)
interface CSVRowMinimal {
  customer_code: string;    // Maps to customers.customer_code
  product_code: string;     // Maps to products.product_code
  quantity: number;         // quantity_ordered
  unit_price?: number;      // Optional, defaults to product.unit_price
}

// CSV Format (extended columns, optional)
interface CSVRowExtended extends CSVRowMinimal {
  customer_po?: string;     // Applied at SO level
  promised_ship_date?: string; // ISO date or YYYY-MM-DD
  required_delivery_date?: string;
  notes?: string;           // Applied at SO level or line level
}
```

### Database

**No new tables required.** Uses existing `sales_orders` and `sales_order_lines` from Story 07.2.

**Key operations:**
- Clone: Query original SO + lines, insert new SO + lines with transformed data
- Import: Parse CSV, validate, batch insert SOs and lines

### Frontend Components

```
apps/frontend/app/(authenticated)/shipping/
  sales-orders/
    [id]/
      page.tsx                     -- Add "Clone Order" button
      components/
        CloneOrderDialog.tsx       -- Confirmation dialog for clone
    components/
      ImportOrdersDialog.tsx       -- CSV upload + preview + import
      ImportPreviewTable.tsx       -- Preview CSV rows with validation status
      ImportResultSummary.tsx      -- Success/error summary after import
```

### Services

```typescript
// lib/services/sales-order-service.ts (extend existing)
export class SalesOrderService {
  /**
   * Clone existing sales order
   * - Preserves: customer, address, lines, pricing
   * - Resets: order_number, status, dates, quantities
   * - Clears: customer_po, confirmed_at, shipped_at
   */
  async cloneSalesOrder(originalId: string): Promise<ClonedSalesOrder> {
    // 1. Fetch original SO + lines (with RLS)
    const original = await getSalesOrder(originalId);

    // 2. Generate new order number
    const newOrderNumber = await generateOrderNumber(original.org_id);

    // 3. Create new SO
    const clonedSO = await createSalesOrder({
      org_id: original.org_id,
      order_number: newOrderNumber,
      customer_id: original.customer_id,
      shipping_address_id: original.shipping_address_id,
      order_date: new Date(), // Today
      status: 'draft',
      notes: original.notes, // Preserve notes
      allergen_validated: false, // Must re-validate
      // Cleared fields:
      customer_po: null,
      promised_ship_date: null,
      required_delivery_date: null,
      confirmed_at: null,
      shipped_at: null,
    });

    // 4. Clone lines (sequential line_number)
    const clonedLines = [];
    for (let i = 0; i < original.lines.length; i++) {
      const line = original.lines[i];
      const clonedLine = await createSalesOrderLine({
        sales_order_id: clonedSO.id,
        line_number: i + 1, // Sequential 1-N
        product_id: line.product_id,
        quantity_ordered: line.quantity_ordered,
        unit_price: line.unit_price,
        requested_lot: line.requested_lot,
        notes: line.notes,
        // Reset quantities:
        quantity_allocated: 0,
        quantity_picked: 0,
        quantity_packed: 0,
        quantity_shipped: 0,
      });
      clonedLines.push(clonedLine);
    }

    // 5. Recalculate totals
    const totalAmount = clonedLines.reduce(
      (sum, line) => sum + line.line_total, 0
    );
    await updateSalesOrder(clonedSO.id, { total_amount: totalAmount });

    return { ...clonedSO, lines: clonedLines };
  }

  /**
   * Import sales orders from CSV
   * - Validates customer_code, product_code, quantity, price
   * - Groups rows by customer_code
   * - Creates one SO per customer
   * - Returns created orders + validation errors
   */
  async importSalesOrdersFromCSV(
    orgId: string,
    csvData: string
  ): Promise<ImportResult> {
    // 1. Parse CSV
    const rows = parseCSV(csvData);

    // 2. Validate header
    const requiredColumns = ['customer_code', 'product_code', 'quantity'];
    validateCSVHeader(rows[0], requiredColumns);

    // 3. Validate and transform rows
    const validatedRows: ValidatedRow[] = [];
    const errors: ImportError[] = [];

    for (let i = 1; i < rows.length; i++) { // Skip header
      const row = rows[i];
      const validation = await validateCSVRow(orgId, row, i);

      if (validation.valid) {
        validatedRows.push(validation.data);
      } else {
        errors.push({
          row: i,
          customer_code: row.customer_code,
          product_code: row.product_code,
          error: validation.error,
        });
      }
    }

    // 4. Group by customer_code
    const groupedByCustomer = groupBy(validatedRows, 'customer_id');

    // 5. Create SOs (one per customer)
    const createdOrders: CreatedOrder[] = [];

    for (const [customerId, customerRows] of Object.entries(groupedByCustomer)) {
      const firstRow = customerRows[0];

      // Generate order number
      const orderNumber = await generateOrderNumber(orgId);

      // Create SO
      const so = await createSalesOrder({
        org_id: orgId,
        order_number: orderNumber,
        customer_id: customerId,
        shipping_address_id: firstRow.shipping_address_id, // Default address
        order_date: new Date(),
        customer_po: firstRow.customer_po,
        promised_ship_date: firstRow.promised_ship_date,
        required_delivery_date: firstRow.required_delivery_date,
        notes: firstRow.notes,
        status: 'draft',
        allergen_validated: false,
      });

      // Create lines
      const lines = [];
      for (let lineNum = 0; lineNum < customerRows.length; lineNum++) {
        const row = customerRows[lineNum];
        const line = await createSalesOrderLine({
          sales_order_id: so.id,
          line_number: lineNum + 1,
          product_id: row.product_id,
          quantity_ordered: row.quantity,
          unit_price: row.unit_price,
        });
        lines.push(line);
      }

      // Recalculate total
      const totalAmount = lines.reduce((sum, line) => sum + line.line_total, 0);
      await updateSalesOrder(so.id, { total_amount: totalAmount });

      createdOrders.push({
        id: so.id,
        order_number: so.order_number,
        customer_code: firstRow.customer_code,
        lines_count: lines.length,
      });
    }

    return {
      success: errors.length < rows.length - 1, // At least 1 valid row
      summary: {
        orders_created: createdOrders.length,
        lines_imported: validatedRows.length,
        rows_processed: rows.length - 1, // Exclude header
        errors_count: errors.length,
      },
      created_orders: createdOrders,
      errors: errors,
    };
  }

  /**
   * Validate CSV row
   */
  private async validateCSVRow(
    orgId: string,
    row: CSVRow,
    rowIndex: number
  ): Promise<ValidationResult> {
    // Customer exists?
    const customer = await getCustomerByCode(orgId, row.customer_code);
    if (!customer) {
      return {
        valid: false,
        error: `Customer '${row.customer_code}' not found`,
      };
    }

    // Product exists?
    const product = await getProductByCode(orgId, row.product_code);
    if (!product) {
      return {
        valid: false,
        error: `Product '${row.product_code}' not found`,
      };
    }

    // Quantity valid?
    const quantity = parseFloat(row.quantity);
    if (isNaN(quantity) || quantity <= 0) {
      return {
        valid: false,
        error: 'Quantity must be greater than zero',
      };
    }

    // Unit price (optional, defaults to product.unit_price)
    let unitPrice = product.unit_price;
    if (row.unit_price) {
      unitPrice = parseFloat(row.unit_price);
      if (isNaN(unitPrice) || unitPrice < 0) {
        return {
          valid: false,
          error: 'Unit price cannot be negative',
        };
      }
    }

    // Date validation (if provided)
    let promisedShipDate = null;
    if (row.promised_ship_date) {
      promisedShipDate = parseDate(row.promised_ship_date);
      if (!promisedShipDate) {
        return {
          valid: false,
          error: 'Invalid promised_ship_date format (use YYYY-MM-DD)',
        };
      }
    }

    return {
      valid: true,
      data: {
        customer_id: customer.id,
        customer_code: row.customer_code,
        shipping_address_id: customer.default_shipping_address_id,
        product_id: product.id,
        product_code: row.product_code,
        quantity,
        unit_price: unitPrice,
        customer_po: row.customer_po || null,
        promised_ship_date: promisedShipDate,
        required_delivery_date: row.required_delivery_date
          ? parseDate(row.required_delivery_date)
          : null,
        notes: row.notes || null,
      },
    };
  }
}
```

### Validation (Zod)

```typescript
// lib/validation/sales-order-schema.ts (extend existing)

// No additional schemas needed for clone (uses existing SO creation schema)

// CSV import validation
const csvRowSchema = z.object({
  customer_code: z.string().min(1, "Customer code is required"),
  product_code: z.string().min(1, "Product code is required"),
  quantity: z.string().refine(
    (val) => !isNaN(parseFloat(val)) && parseFloat(val) > 0,
    "Quantity must be a number greater than zero"
  ),
  unit_price: z.string().optional().refine(
    (val) => !val || (!isNaN(parseFloat(val)) && parseFloat(val) >= 0),
    "Unit price must be a non-negative number"
  ),
  customer_po: z.string().max(100).optional(),
  promised_ship_date: z.string().optional().refine(
    (val) => !val || isValidDate(val),
    "Invalid date format (use YYYY-MM-DD)"
  ),
  required_delivery_date: z.string().optional().refine(
    (val) => !val || isValidDate(val),
    "Invalid date format (use YYYY-MM-DD)"
  ),
  notes: z.string().max(1000).optional(),
});

// CSV file validation
const csvFileSchema = z.object({
  file: z.instanceof(File).refine(
    (file) => file.type === 'text/csv' || file.name.endsWith('.csv'),
    "Only CSV files (.csv) are supported"
  ).refine(
    (file) => file.size > 0 && file.size <= 5 * 1024 * 1024, // 5MB limit
    "File size must be between 1 byte and 5MB"
  ),
});
```

### Key Business Rules

1. **Clone Behavior:**
   - New order_number auto-generated (SO-YYYY-NNNNN)
   - Status always 'draft'
   - order_date = today
   - Clears: customer_po, promised_ship_date, required_delivery_date, confirmed_at, shipped_at
   - Resets quantities: allocated, picked, packed, shipped = 0
   - Preserves: customer_id, shipping_address_id, all lines, unit_price, notes
   - Resets allergen_validated = false (must re-validate)
   - Line numbers renumbered sequentially (1, 2, 3, ...) regardless of original gaps

2. **CSV Import Grouping:**
   - Rows grouped by customer_code
   - One SO created per unique customer_code
   - Lines added to SO in CSV row order
   - If customer has multiple addresses, uses default shipping address

3. **CSV Validation Rules:**
   - Required columns: customer_code, product_code, quantity
   - Optional columns: unit_price (defaults to product.unit_price), customer_po, promised_ship_date, required_delivery_date, notes
   - customer_code must exist in customers table (org-scoped)
   - product_code must exist in products table (org-scoped)
   - quantity > 0
   - unit_price >= 0 (if provided)
   - Dates in ISO format (YYYY-MM-DD)

4. **CSV Error Handling:**
   - Row-level validation (one error per row)
   - Import continues for valid rows even if some rows fail
   - Returns error summary with row numbers and error messages
   - No partial SO creation (if customer group has any invalid row, skip entire customer)

5. **Permission Requirements:**
   - Clone: SALES, MANAGER, ADMIN, SUPER_ADMIN
   - Import: SALES, MANAGER, ADMIN, SUPER_ADMIN
   - View import button: Same as create SO permissions

6. **Multi-Tenancy:**
   - Clone: RLS ensures original SO belongs to user's org
   - Import: customer_code and product_code validated against org_id scope
   - All created SOs have org_id = user's org_id

7. **SO Template Concept (Future - Not Implemented):**
   - Story 07.5 does NOT implement templates
   - Future enhancement: Save SO as template with name, allow user to select template for new SO
   - Templates would be stored in separate `so_templates` table

---

## UX Workflow

### Clone Workflow

1. User opens SO detail page
2. Clicks "Clone Order" button (top right)
3. Confirmation dialog displays: "Clone this order? A new draft order will be created with the same customer and products."
4. User confirms
5. API creates cloned SO
6. User redirected to new SO detail page
7. Toast notification: "Cloned from SO-2025-00123"

### Import Workflow

1. User clicks "Import Orders" button on SO list page
2. Import dialog opens with instructions:
   - "Upload CSV with columns: customer_code, product_code, quantity, unit_price (optional)"
   - "Download sample CSV" link
3. User drags/drops or selects CSV file
4. System parses and validates CSV
5. Preview table displays all rows with validation status:
   - Green checkmark for valid rows
   - Red X with error message for invalid rows
6. User reviews preview, clicks "Import X Orders" button
7. System creates SOs for valid rows
8. Success dialog displays:
   - "3 orders created, 5 lines imported"
   - List of created order numbers
   - Error summary (if any): "2 rows skipped due to errors"
   - "View Orders" button (navigates to SO list filtered by today)

---

## Deliverables

- API route: POST /api/shipping/sales-orders/:id/clone
- API route: POST /api/shipping/sales-orders/import
- SalesOrderService.cloneSalesOrder method
- SalesOrderService.importSalesOrdersFromCSV method
- CSV parsing and validation utility
- CloneOrderDialog component
- ImportOrdersDialog component
- ImportPreviewTable component
- ImportResultSummary component
- "Clone Order" button in SO detail page
- "Import Orders" button in SO list page
- CSV validation with Zod
- Unit tests for clone logic (>80% coverage)
- Unit tests for CSV validation (>80% coverage)
- Integration tests for clone API endpoint
- Integration tests for import API endpoint
- E2E test: Clone SO and verify new order created
- E2E test: Import CSV and verify orders created

---

## Definition of Done

- [ ] POST /api/shipping/sales-orders/:id/clone endpoint works
- [ ] Clone preserves customer, address, lines, pricing
- [ ] Clone resets order_number, status, dates, quantities
- [ ] Clone renumbers lines sequentially (1, 2, 3)
- [ ] Clone resets allergen_validated to false
- [ ] POST /api/shipping/sales-orders/import endpoint works
- [ ] CSV import validates customer_code, product_code, quantity, price
- [ ] CSV import groups rows by customer_code
- [ ] CSV import creates one SO per customer
- [ ] CSV import returns row-level error messages
- [ ] Import preview table displays validation status
- [ ] Import result summary shows success/error counts
- [ ] "Clone Order" button visible on SO detail page
- [ ] "Import Orders" button visible on SO list page (authorized users only)
- [ ] CloneOrderDialog component works
- [ ] ImportOrdersDialog component works
- [ ] Permission checks hide buttons for unauthorized users
- [ ] Multi-tenant isolation verified (clone and import)
- [ ] Unit tests cover clone logic (>80% coverage)
- [ ] Unit tests cover CSV validation (>80% coverage)
- [ ] Integration tests for clone API
- [ ] Integration tests for import API
- [ ] E2E test: Clone SO and verify
- [ ] E2E test: Import CSV and verify

---

## Future Phases (Not in This Story)

### Phase 2 - SO Templates

- **Template Library:**
  - Save SO as reusable template with name
  - Store in `so_templates` table
  - User can select template when creating new SO
  - Template includes customer, lines, pricing
  - User can edit template after creation

- **Template Management UI:**
  - Templates list page
  - "Save as Template" button on SO detail page
  - "Create from Template" option in SO creation wizard

### Phase 2 - Recurring Orders

- **Scheduled Orders:**
  - Create recurring order schedule (daily, weekly, monthly)
  - Auto-generate SO on schedule
  - Email notification to customer
  - Store in `recurring_orders` table

### Epic 11 - Integrations

- **EDI 850 (Purchase Order) Inbound:**
  - Receive EDI 850 from customer systems
  - Parse and create SO automatically
  - Map EDI fields to SO schema

- **API-based Order Import:**
  - REST API endpoint for external systems
  - OAuth authentication
  - Real-time order creation
  - Webhook for order status updates

### Phase 2 - Advanced Import

- **Custom Field Mapping:**
  - User defines CSV column mappings
  - Save mapping profiles
  - Support non-standard CSV formats

- **Import Validation Rules:**
  - Pre-import validation for allergen restrictions
  - Credit limit checks
  - Inventory availability checks

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-12-16 | Initial story for Epic 07 Phase 1A Enhanced | PM-AGENT |
