# 07.17 - Customer Advanced Features

**Story ID:** 07.17
**Epic:** 07 - Shipping
**Phase:** Phase 2
**Complexity:** M (Medium)
**Estimate:** 3-4 days
**Type:** Backend + Frontend
**Priority:** P1
**State:** ready

**Primary PRD:** `docs/1-BASELINE/product/modules/shipping.md` (FR-7.4, FR-7.5, FR-7.6)
**Architecture:** `docs/1-BASELINE/architecture/modules/shipping.md`

## PRD References

| FR ID | Requirement | Priority | Phase | Covered |
|-------|-------------|----------|-------|---------|
| FR-7.4 | Customer Credit Limits | P1 | 2 | Yes |
| FR-7.5 | Customer Categories/Groups | P2 | 2 | Yes |
| FR-7.6 | Customer Payment Terms | P1 | 2 | Yes |

## User Story

**As a** sales manager,
**I want** to configure credit limits, payment terms, and categories for customers,
**So that** I can manage customer financial risk, apply consistent payment policies, and segment customers for reporting and analysis.

**As a** shipping clerk,
**I want** to see credit status warnings when creating sales orders,
**So that** I can prevent orders that exceed customer credit limits and reduce financial risk.

## Goal

Extend customer management with advanced financial controls and categorization. Implement credit limit enforcement during sales order creation, configurable payment terms (Net 30, Net 60, COD, etc.), and customer grouping for segmentation and bulk operations.

## Scope

**In scope:**
- Credit limit configuration per customer
- Credit limit enforcement on SO creation (warning/block)
- Available credit calculation (limit - open orders - unpaid invoices)
- Payment terms configuration (Net 30, Net 60, COD, Prepaid, Custom)
- Payment terms due date calculation
- Customer categories/groups (retail, wholesale, distributor, key_account)
- Custom category creation per organization
- Category-based filtering and reporting
- Credit status display on customer detail
- Payment terms display on customer and SO

**Out of scope:**
- Customer pricing agreements (FR-7.8, Phase 3)
- Credit score integration (external)
- Automatic credit limit adjustment
- Customer tiering with automatic discounts (Phase 3)
- Invoice generation (Finance module)
- Payment processing (Finance module)

## Dependencies

| Story | Requirement | Status |
|-------|-------------|--------|
| 07.1 | Customers CRUD | Required - provides customer base |
| 07.2 | Sales Orders Core | Required - SO creation flow |
| 07.3 | SO Status Workflow | Required - status for credit calculation |

## Provides To

| Story | What |
|-------|------|
| 07.2 | Credit check during SO creation |
| 07.15 | Dashboard credit metrics |
| Future | Finance module invoice due dates |

---

## Acceptance Criteria (Given/When/Then)

### Credit Limits (FR-7.4)

#### Credit Limit Configuration
- GIVEN admin edits customer, WHEN credit limit field visible, THEN can set limit from 0 to 999,999,999.99.
- GIVEN customer has no credit limit set (NULL), WHEN SO created, THEN no credit check performed (unlimited).
- GIVEN customer has credit limit of 0, WHEN SO created, THEN order blocked (COD/prepaid only).
- GIVEN customer has credit limit of 10,000, WHEN customer saved, THEN credit_limit stored correctly.

#### Available Credit Calculation
- GIVEN customer has credit_limit = 10,000, WHEN open orders total = 3,000 and unpaid invoices = 2,000, THEN available_credit = 5,000.
- GIVEN customer has credit_limit = 10,000 and no open orders, WHEN available credit calculated, THEN available_credit = 10,000.
- GIVEN customer has NULL credit limit, WHEN available credit displayed, THEN shows "Unlimited".

#### Credit Check on SO Creation
- GIVEN customer has available_credit = 5,000, WHEN creating SO for 4,000, THEN order proceeds without warning.
- GIVEN customer has available_credit = 5,000, WHEN creating SO for 6,000, THEN warning displays: "Order exceeds available credit by $1,000".
- GIVEN customer has available_credit = 5,000 and org setting credit_check_mode = 'warn', WHEN creating SO for 6,000, THEN warning displays but order can proceed.
- GIVEN customer has available_credit = 5,000 and org setting credit_check_mode = 'block', WHEN creating SO for 6,000, THEN order blocked with error.
- GIVEN customer has credit_limit = 0, WHEN creating SO, THEN order blocked: "Customer requires prepayment or COD".

#### Credit Status Display
- GIVEN customer detail page, WHEN credit section visible, THEN displays: Credit Limit, Open Orders, Unpaid Invoices, Available Credit.
- GIVEN customer has credit_limit = 10,000, available = 2,000, WHEN displayed, THEN shows utilization bar at 80%.
- GIVEN customer available credit < 20% of limit, WHEN displayed, THEN utilization bar shows red/warning color.
- GIVEN customer available credit > 50% of limit, WHEN displayed, THEN utilization bar shows green color.

### Payment Terms (FR-7.6)

#### Payment Terms Configuration
- GIVEN admin creates/edits customer, WHEN payment terms field visible, THEN dropdown shows: Net 7, Net 15, Net 30, Net 45, Net 60, Net 90, COD, Prepaid, Custom.
- GIVEN payment_terms = 'Net 30', WHEN customer saved, THEN payment_terms_code = 'NET_30' and payment_terms_days = 30 stored.
- GIVEN payment_terms = 'Custom', WHEN selected, THEN custom days input appears (1-365).
- GIVEN payment_terms = 'COD', WHEN saved, THEN payment_terms_days = 0.
- GIVEN payment_terms = 'Prepaid', WHEN saved, THEN payment_terms_days = -1 (payment before shipment).

#### Payment Terms Display
- GIVEN customer with payment_terms_code = 'NET_30', WHEN customer detail viewed, THEN displays "Net 30 Days".
- GIVEN SO for customer with Net 30 terms, WHEN SO created on Jan 15, THEN due_date calculated as Feb 14.
- GIVEN customer with COD terms, WHEN SO displayed, THEN shows "Cash on Delivery" badge.
- GIVEN customer with Prepaid terms, WHEN SO displayed, THEN shows "Prepaid - Payment Required" badge.

#### Organization Default Terms
- GIVEN organization has default_payment_terms = 'NET_30', WHEN new customer created, THEN payment_terms defaults to Net 30.
- GIVEN admin changes org default to 'NET_60', WHEN new customer created, THEN payment_terms defaults to Net 60.
- GIVEN existing customer, WHEN org default changes, THEN existing customer terms unchanged.

### Customer Categories/Groups (FR-7.5)

#### Standard Categories
- GIVEN admin creates/edits customer, WHEN category field visible, THEN dropdown shows: Retail, Wholesale, Distributor, Key Account, Other.
- GIVEN customer category = 'wholesale', WHEN saved, THEN category stored correctly.
- GIVEN customer list, WHEN filter by category 'wholesale', THEN only wholesale customers display.

#### Custom Categories
- GIVEN org admin navigates to Settings > Customer Categories, WHEN page loads, THEN list of categories displays.
- GIVEN admin clicks "Add Category", WHEN form opens, THEN can enter: code, name, description, color.
- GIVEN admin creates category code = 'HOTEL', name = 'Hotels & Restaurants', WHEN saved, THEN category available in customer dropdown.
- GIVEN custom category in use by 5 customers, WHEN admin attempts delete, THEN error: "Category in use by 5 customers".
- GIVEN custom category not in use, WHEN admin deletes, THEN category removed from dropdown.

#### Category Badge Display
- GIVEN customer has category = 'wholesale', WHEN displayed in list, THEN shows blue "Wholesale" badge.
- GIVEN customer has category = 'key_account', WHEN displayed, THEN shows gold "Key Account" badge.
- GIVEN custom category with color = '#FF5722', WHEN displayed, THEN badge uses custom color.

#### Category Statistics
- GIVEN customer list page, WHEN category filter active, THEN shows count: "Showing 25 Wholesale customers".
- GIVEN dashboard page, WHEN customer metrics visible, THEN shows breakdown by category (pie chart).

### Multi-tenancy

- GIVEN Org A has custom category 'HOTEL', WHEN Org B views categories, THEN 'HOTEL' not visible.
- GIVEN customer belongs to Org A, WHEN Org B queries customers, THEN customer not returned.
- GIVEN Org A and Org B both have category code 'PREMIUM', WHEN each org views, THEN sees own category.

### Permission Enforcement

- GIVEN user with role 'VIEWER', WHEN viewing customer, THEN credit info visible but edit disabled.
- GIVEN user with role 'SALES', WHEN creating SO over credit limit, THEN warning displays, can proceed (soft limit).
- GIVEN user with role 'ADMIN', WHEN creating SO over credit limit, THEN can override block (if credit_check_mode = 'block').
- GIVEN user without SETTINGS_MANAGE permission, WHEN accessing customer categories settings, THEN 403 returned.

---

## Technical Specification

### Database Schema

#### customer_categories table

```sql
CREATE TABLE customer_categories (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,

  -- Category identification
  code VARCHAR(50) NOT NULL,
  name VARCHAR(100) NOT NULL,
  description TEXT,

  -- Display
  color VARCHAR(7) DEFAULT '#6B7280', -- Hex color for badge
  sort_order INTEGER DEFAULT 0,
  is_system BOOLEAN DEFAULT false, -- System categories cannot be deleted
  is_active BOOLEAN DEFAULT true,

  -- Timestamps
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),

  -- Constraints
  CONSTRAINT customer_categories_org_code_unique UNIQUE (org_id, code)
);

-- Indexes
CREATE INDEX idx_customer_categories_org ON customer_categories(org_id);
CREATE INDEX idx_customer_categories_active ON customer_categories(org_id, is_active);

-- Seed system categories for each org (via trigger or migration)
-- RETAIL, WHOLESALE, DISTRIBUTOR, KEY_ACCOUNT, OTHER
```

#### payment_terms table

```sql
CREATE TABLE payment_terms (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,

  -- Terms identification
  code VARCHAR(50) NOT NULL,
  name VARCHAR(100) NOT NULL,
  description TEXT,

  -- Configuration
  days INTEGER NOT NULL, -- -1 = prepaid, 0 = COD, 1+ = net days
  is_system BOOLEAN DEFAULT false,
  is_active BOOLEAN DEFAULT true,

  -- Timestamps
  created_at TIMESTAMPTZ DEFAULT NOW(),

  CONSTRAINT payment_terms_org_code_unique UNIQUE (org_id, code)
);

-- Indexes
CREATE INDEX idx_payment_terms_org ON payment_terms(org_id);

-- System payment terms seeded per org:
-- NET_7, NET_15, NET_30, NET_45, NET_60, NET_90, COD, PREPAID
```

#### customers table extension

```sql
-- Add/modify columns in customers table
ALTER TABLE customers ADD COLUMN IF NOT EXISTS
  category_id UUID REFERENCES customer_categories(id);

ALTER TABLE customers ADD COLUMN IF NOT EXISTS
  payment_terms_id UUID REFERENCES payment_terms(id);

-- credit_limit already exists, ensure decimal precision
ALTER TABLE customers
  ALTER COLUMN credit_limit TYPE DECIMAL(15,2);

-- Add credit check mode override per customer (optional)
ALTER TABLE customers ADD COLUMN IF NOT EXISTS
  credit_check_override VARCHAR(20); -- 'none', 'warn', 'block', NULL = org default

-- Indexes
CREATE INDEX idx_customers_category ON customers(category_id);
CREATE INDEX idx_customers_payment_terms ON customers(payment_terms_id);
CREATE INDEX idx_customers_credit_limit ON customers(credit_limit) WHERE credit_limit IS NOT NULL;
```

#### organizations table extension

```sql
-- Add credit and payment settings to organization
ALTER TABLE organizations ADD COLUMN IF NOT EXISTS
  credit_check_mode VARCHAR(20) DEFAULT 'warn'; -- 'none', 'warn', 'block'

ALTER TABLE organizations ADD COLUMN IF NOT EXISTS
  default_payment_terms_id UUID REFERENCES payment_terms(id);

ALTER TABLE organizations ADD COLUMN IF NOT EXISTS
  default_credit_limit DECIMAL(15,2);
```

### RLS Policies

```sql
-- customer_categories: Org isolation
ALTER TABLE customer_categories ENABLE ROW LEVEL SECURITY;

CREATE POLICY "customer_categories_org_isolation" ON customer_categories
FOR ALL USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

-- payment_terms: Org isolation
ALTER TABLE payment_terms ENABLE ROW LEVEL SECURITY;

CREATE POLICY "payment_terms_org_isolation" ON payment_terms
FOR ALL USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));
```

### API Endpoints

```
# Credit Management
GET    /api/shipping/customers/:id/credit          - Get customer credit status
POST   /api/shipping/customers/:id/credit/check    - Check if order amount exceeds credit

# Payment Terms
GET    /api/shipping/payment-terms                 - List payment terms
POST   /api/shipping/payment-terms                 - Create custom payment term (admin)
PUT    /api/shipping/payment-terms/:id             - Update payment term
DELETE /api/shipping/payment-terms/:id             - Delete payment term (if unused)

# Customer Categories
GET    /api/shipping/customer-categories           - List categories
POST   /api/shipping/customer-categories           - Create custom category (admin)
PUT    /api/shipping/customer-categories/:id       - Update category
DELETE /api/shipping/customer-categories/:id       - Delete category (if unused)

# Extended Customer endpoints (modify existing)
GET    /api/shipping/customers                     - Add category filter, credit status
GET    /api/shipping/customers/:id                 - Include credit_status, category, payment_terms
PUT    /api/shipping/customers/:id                 - Support category_id, payment_terms_id
```

### Service Methods

**Location:** `lib/services/customer-credit-service.ts`

```typescript
interface CustomerCreditService {
  // Credit calculations
  getCreditStatus(customerId: string): Promise<CreditStatus>;
  calculateAvailableCredit(customerId: string): Promise<number>;
  getOpenOrdersTotal(customerId: string): Promise<number>;
  getUnpaidInvoicesTotal(customerId: string): Promise<number>;

  // Credit checks
  checkCreditForOrder(customerId: string, orderAmount: number): Promise<CreditCheckResult>;
  canCreateOrder(customerId: string, orderAmount: number): Promise<boolean>;

  // Credit management
  updateCreditLimit(customerId: string, limit: number | null): Promise<void>;
  setCreditCheckOverride(customerId: string, mode: CreditCheckMode | null): Promise<void>;
}

interface CreditStatus {
  credit_limit: number | null;
  open_orders_total: number;
  unpaid_invoices_total: number;
  available_credit: number | null; // null = unlimited
  utilization_percent: number | null;
  status: 'good' | 'warning' | 'exceeded' | 'unlimited';
}

interface CreditCheckResult {
  allowed: boolean;
  mode: 'none' | 'warn' | 'block';
  available_credit: number | null;
  order_amount: number;
  exceeds_by: number;
  message: string;
}

type CreditCheckMode = 'none' | 'warn' | 'block';
```

**Location:** `lib/services/payment-terms-service.ts`

```typescript
interface PaymentTermsService {
  // CRUD
  listPaymentTerms(orgId: string): Promise<PaymentTerm[]>;
  getPaymentTerm(id: string): Promise<PaymentTerm>;
  createPaymentTerm(data: CreatePaymentTermInput): Promise<PaymentTerm>;
  updatePaymentTerm(id: string, data: UpdatePaymentTermInput): Promise<PaymentTerm>;
  deletePaymentTerm(id: string): Promise<void>;

  // Calculations
  calculateDueDate(termsId: string, invoiceDate: Date): Date;
  getTermsForCustomer(customerId: string): Promise<PaymentTerm>;

  // Defaults
  getOrganizationDefault(orgId: string): Promise<PaymentTerm | null>;
  setOrganizationDefault(orgId: string, termsId: string): Promise<void>;
}

interface PaymentTerm {
  id: string;
  code: string;
  name: string;
  description: string | null;
  days: number;
  is_system: boolean;
  is_active: boolean;
}
```

**Location:** `lib/services/customer-category-service.ts`

```typescript
interface CustomerCategoryService {
  // CRUD
  listCategories(orgId: string): Promise<CustomerCategory[]>;
  getCategory(id: string): Promise<CustomerCategory>;
  createCategory(data: CreateCategoryInput): Promise<CustomerCategory>;
  updateCategory(id: string, data: UpdateCategoryInput): Promise<CustomerCategory>;
  deleteCategory(id: string): Promise<void>;

  // Validation
  canDeleteCategory(id: string): Promise<{ canDelete: boolean; customersCount: number }>;

  // Statistics
  getCategoryStats(orgId: string): Promise<CategoryStats[]>;
}

interface CustomerCategory {
  id: string;
  code: string;
  name: string;
  description: string | null;
  color: string;
  sort_order: number;
  is_system: boolean;
  is_active: boolean;
  customers_count?: number;
}

interface CategoryStats {
  category_id: string;
  category_name: string;
  customers_count: number;
  total_credit_limit: number;
  total_open_orders: number;
}
```

### Zod Validation Schemas

**Location:** `lib/validation/customer-credit.ts`

```typescript
import { z } from 'zod';

export const creditLimitSchema = z.number()
  .min(0, 'Credit limit must be non-negative')
  .max(999999999.99, 'Credit limit exceeds maximum')
  .nullable();

export const creditCheckModeSchema = z.enum(['none', 'warn', 'block']);

export const creditStatusSchema = z.object({
  credit_limit: z.number().nullable(),
  open_orders_total: z.number(),
  unpaid_invoices_total: z.number(),
  available_credit: z.number().nullable(),
  utilization_percent: z.number().nullable(),
  status: z.enum(['good', 'warning', 'exceeded', 'unlimited']),
});

export const creditCheckRequestSchema = z.object({
  order_amount: z.number().positive('Order amount must be positive'),
});

export const creditCheckResultSchema = z.object({
  allowed: z.boolean(),
  mode: creditCheckModeSchema,
  available_credit: z.number().nullable(),
  order_amount: z.number(),
  exceeds_by: z.number(),
  message: z.string(),
});
```

**Location:** `lib/validation/payment-terms.ts`

```typescript
import { z } from 'zod';

export const paymentTermsCodeSchema = z.string()
  .min(1, 'Code is required')
  .max(50, 'Code must be at most 50 characters')
  .regex(/^[A-Z0-9_]+$/, 'Code must be uppercase letters, numbers, and underscores');

export const paymentTermsSchema = z.object({
  code: paymentTermsCodeSchema,
  name: z.string().min(1).max(100),
  description: z.string().max(500).nullable().optional(),
  days: z.number()
    .int()
    .min(-1, 'Days must be -1 (prepaid), 0 (COD), or positive')
    .max(365, 'Days cannot exceed 365'),
  is_active: z.boolean().default(true),
});

export const createPaymentTermsSchema = paymentTermsSchema;

export const updatePaymentTermsSchema = paymentTermsSchema.partial().omit({ code: true });
```

**Location:** `lib/validation/customer-category.ts`

```typescript
import { z } from 'zod';

export const categoryCodeSchema = z.string()
  .min(1, 'Code is required')
  .max(50, 'Code must be at most 50 characters')
  .regex(/^[A-Z0-9_]+$/, 'Code must be uppercase letters, numbers, and underscores');

export const categoryColorSchema = z.string()
  .regex(/^#[0-9A-Fa-f]{6}$/, 'Color must be a valid hex color');

export const customerCategorySchema = z.object({
  code: categoryCodeSchema,
  name: z.string().min(1).max(100),
  description: z.string().max(500).nullable().optional(),
  color: categoryColorSchema.default('#6B7280'),
  sort_order: z.number().int().min(0).default(0),
  is_active: z.boolean().default(true),
});

export const createCategorySchema = customerCategorySchema;

export const updateCategorySchema = customerCategorySchema.partial().omit({ code: true });
```

---

## UI Components

### Pages

- `app/(authenticated)/settings/shipping/payment-terms/page.tsx` - Payment terms management
- `app/(authenticated)/settings/shipping/customer-categories/page.tsx` - Customer categories management

### Components

**Location:** `components/shipping/customer/`

```
CreditStatusCard.tsx           - Credit limit, available, utilization display
CreditCheckWarningDialog.tsx   - Warning dialog when SO exceeds credit
CreditUtilizationBar.tsx       - Visual bar showing credit usage %
PaymentTermsSelect.tsx         - Dropdown for selecting payment terms
PaymentTermsBadge.tsx          - Badge showing Net 30, COD, etc.
CustomerCategorySelect.tsx     - Dropdown for selecting category
CustomerCategoryBadge.tsx      - Colored badge for category display
```

**Location:** `components/settings/shipping/`

```
PaymentTermsTable.tsx          - DataTable for payment terms management
PaymentTermsForm.tsx           - Create/edit payment term modal
CustomerCategoriesTable.tsx    - DataTable for categories management
CustomerCategoryForm.tsx       - Create/edit category modal
CategoryColorPicker.tsx        - Color picker for category badge color
```

### Component Details

**CreditStatusCard.tsx**
```tsx
interface CreditStatusCardProps {
  customerId: string;
  creditStatus: CreditStatus;
  showDetails?: boolean;
  className?: string;
}

// Displays:
// +----------------------------------------+
// | Credit Status                    [Good] |
// | Credit Limit:      $10,000.00          |
// | Open Orders:       -$3,500.00          |
// | Unpaid Invoices:   -$2,000.00          |
// | --------------------------------        |
// | Available Credit:   $4,500.00          |
// | [========-----] 55% utilized           |
// +----------------------------------------+
```

**CreditCheckWarningDialog.tsx**
```tsx
interface CreditCheckWarningDialogProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  checkResult: CreditCheckResult;
  onConfirm: () => void;
  onCancel: () => void;
}

// Dialog content:
// "This order of $6,000.00 exceeds available credit by $1,500.00"
// Available Credit: $4,500.00
// [Cancel] [Proceed Anyway]
```

**PaymentTermsBadge.tsx**
```tsx
interface PaymentTermsBadgeProps {
  terms: PaymentTerm;
  showDays?: boolean;
  size?: 'sm' | 'md';
}

// Renders:
// [Net 30] - blue badge
// [COD] - orange badge
// [Prepaid] - red badge
```

---

## Test Cases

### Unit Tests

**customer-credit-service.test.ts**
```typescript
describe('CustomerCreditService', () => {
  describe('calculateAvailableCredit', () => {
    it('returns limit minus open orders and unpaid invoices');
    it('returns null for unlimited credit (no limit set)');
    it('returns 0 when fully utilized');
    it('handles negative available credit (over limit)');
  });

  describe('checkCreditForOrder', () => {
    it('allows order within available credit');
    it('warns when order exceeds credit (warn mode)');
    it('blocks when order exceeds credit (block mode)');
    it('allows any order when mode is none');
    it('blocks all orders when credit_limit = 0');
    it('allows any order when credit_limit is null');
  });

  describe('getCreditStatus', () => {
    it('returns good status when utilization < 80%');
    it('returns warning status when utilization 80-100%');
    it('returns exceeded status when utilization > 100%');
    it('returns unlimited status when no limit');
  });
});
```

**payment-terms-service.test.ts**
```typescript
describe('PaymentTermsService', () => {
  describe('calculateDueDate', () => {
    it('calculates Net 30 due date correctly');
    it('returns invoice date for COD (days = 0)');
    it('returns date before invoice for Prepaid (days = -1)');
    it('handles month boundaries correctly');
  });

  describe('deletePaymentTerm', () => {
    it('allows deletion when not in use');
    it('prevents deletion when customers use term');
    it('prevents deletion of system terms');
  });
});
```

**customer-category-service.test.ts**
```typescript
describe('CustomerCategoryService', () => {
  describe('createCategory', () => {
    it('creates category with valid data');
    it('rejects duplicate code within org');
    it('allows same code in different orgs');
  });

  describe('deleteCategory', () => {
    it('allows deletion when no customers');
    it('prevents deletion when customers assigned');
    it('prevents deletion of system categories');
  });

  describe('getCategoryStats', () => {
    it('returns correct customer counts per category');
    it('includes total credit limits per category');
  });
});
```

### Integration Tests

**credit-api.test.ts**
```typescript
describe('Credit API', () => {
  describe('GET /api/shipping/customers/:id/credit', () => {
    it('returns credit status for customer');
    it('calculates available credit correctly');
    it('returns 404 for other org customer');
  });

  describe('POST /api/shipping/customers/:id/credit/check', () => {
    it('returns allowed=true when within credit');
    it('returns warning result in warn mode');
    it('returns blocked result in block mode');
  });
});
```

**payment-terms-api.test.ts**
```typescript
describe('Payment Terms API', () => {
  describe('GET /api/shipping/payment-terms', () => {
    it('returns org payment terms including system');
    it('filters inactive terms when requested');
  });

  describe('POST /api/shipping/payment-terms', () => {
    it('creates custom payment term');
    it('rejects duplicate code');
    it('requires admin permission');
  });

  describe('DELETE /api/shipping/payment-terms/:id', () => {
    it('deletes unused term');
    it('returns error when term in use');
    it('returns error for system term');
  });
});
```

### E2E Tests

**customer-credit-flow.spec.ts**
```typescript
describe('Customer Credit Flow', () => {
  it('displays credit status on customer detail page');
  it('shows warning when creating SO over credit');
  it('allows proceeding with warning in warn mode');
  it('blocks order in block mode');
  it('updates credit utilization bar in real-time');
});
```

**customer-category-flow.spec.ts**
```typescript
describe('Customer Category Flow', () => {
  it('filters customer list by category');
  it('displays category badges on customers');
  it('creates custom category from settings');
  it('assigns category to customer');
});
```

---

## Deliverables

### Database
- [ ] `customer_categories` table migration
- [ ] `payment_terms` table migration
- [ ] `customers` table extension (category_id, payment_terms_id, credit_check_override)
- [ ] `organizations` table extension (credit_check_mode, default_payment_terms_id)
- [ ] RLS policies for new tables
- [ ] Seed data for system categories and payment terms
- [ ] Trigger for seeding new orgs with system data

### API Routes
- [ ] `/api/shipping/customers/:id/credit` (GET)
- [ ] `/api/shipping/customers/:id/credit/check` (POST)
- [ ] `/api/shipping/payment-terms` (GET, POST)
- [ ] `/api/shipping/payment-terms/:id` (PUT, DELETE)
- [ ] `/api/shipping/customer-categories` (GET, POST)
- [ ] `/api/shipping/customer-categories/:id` (PUT, DELETE)
- [ ] Update existing customer endpoints for new fields

### Services
- [ ] `customer-credit-service.ts`
- [ ] `payment-terms-service.ts`
- [ ] `customer-category-service.ts`

### Validation
- [ ] `lib/validation/customer-credit.ts`
- [ ] `lib/validation/payment-terms.ts`
- [ ] `lib/validation/customer-category.ts`

### Frontend Components
- [ ] CreditStatusCard
- [ ] CreditCheckWarningDialog
- [ ] CreditUtilizationBar
- [ ] PaymentTermsSelect
- [ ] PaymentTermsBadge
- [ ] CustomerCategorySelect
- [ ] CustomerCategoryBadge
- [ ] PaymentTermsTable + Form
- [ ] CustomerCategoriesTable + Form
- [ ] CategoryColorPicker

### Pages
- [ ] Payment Terms settings page
- [ ] Customer Categories settings page
- [ ] Update Customer detail page (credit section)
- [ ] Update Customer form (category, payment terms)

### Tests
- [ ] Unit tests (>80% coverage)
- [ ] Integration tests for all API endpoints
- [ ] E2E tests for credit check flow

---

## Definition of Done

- [ ] Credit limit configurable per customer (0 to unlimited)
- [ ] Available credit calculation includes open orders and unpaid invoices
- [ ] Credit check performed on SO creation with configurable mode (none/warn/block)
- [ ] Credit status displayed on customer detail page with utilization bar
- [ ] Warning dialog appears when SO exceeds credit (warn mode)
- [ ] Order blocked when SO exceeds credit (block mode)
- [ ] Payment terms configurable per customer (Net 30, COD, etc.)
- [ ] Custom payment terms creatable by admin
- [ ] Due date calculation works correctly for all term types
- [ ] Customer categories configurable with custom colors
- [ ] Category filter works on customer list
- [ ] Category badges display on customer list and detail
- [ ] System categories seeded for new organizations
- [ ] Multi-tenant isolation verified (RLS tests pass)
- [ ] Admin permissions required for settings management
- [ ] Unit test coverage >= 80%
- [ ] Integration tests pass
- [ ] E2E tests pass
- [ ] Code reviewed and approved

---

## Business Rules

### Credit Limit Rules
1. **NULL credit limit** = unlimited credit, no checks performed
2. **credit_limit = 0** = COD/prepaid only, all orders blocked
3. **Available credit** = credit_limit - open_orders - unpaid_invoices
4. **Open orders** = SOs in status: draft, confirmed, allocated, picking, packing (not shipped)
5. **Unpaid invoices** = future Finance module integration (default 0 for now)
6. **Credit check mode** = org-level default, can override per customer

### Payment Terms Rules
1. **days = -1** = Prepaid (payment before shipment)
2. **days = 0** = COD (Cash on Delivery)
3. **days > 0** = Net terms (due X days after invoice)
4. **System terms** cannot be deleted, can be deactivated
5. **Organization default** applied to new customers

### Category Rules
1. **System categories** seeded for each org: RETAIL, WHOLESALE, DISTRIBUTOR, KEY_ACCOUNT, OTHER
2. **System categories** cannot be deleted, can be renamed/recolored
3. **Custom categories** can be created/deleted by admins
4. **Category deletion** blocked if customers assigned

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-01-15 | Initial story creation | ARCHITECT-AGENT |
