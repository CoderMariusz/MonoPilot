# 07.16 - RMA (Returns) Core CRUD + Approval

**Priority**: P1 (Phase 2A - Enhanced)
**Complexity**: M (3-4 days)
**Type:** backend + frontend

**State:** ready
**Primary PRD:** `docs/1-BASELINE/product/modules/shipping.md` (FR-7.59 to FR-7.65)
**Architecture:** `docs/1-BASELINE/architecture/modules/shipping.md`

---

## MVP Scope

This story implements the Return Merchandise Authorization (RMA) system for managing customer returns. It provides the foundation for return processing, including RMA creation, line-level tracking, approval workflows, and status management. This is a Phase 2 feature that enhances the shipping workflow but is not required for MVP operations.

**In scope (this story):**
- rma_requests table (rma_number auto RMA-YYYY-NNNNN, status workflow, disposition tracking)
- rma_lines table (product, quantity_expected, quantity_received, lot_number, reason_notes)
- RMA CRUD operations (create, read, update pending only, delete pending only)
- RMA lines management (add, edit, delete lines)
- Approval workflow (Manager+ only, pending → approved)
- RMA list page with filters (status, customer, date range)
- RMA detail page with lines table
- RMA form (customer selection, optional SO link, line entry)
- Reason codes: damaged, expired, wrong_product, quality_issue, customer_change, other
- Disposition: restock, scrap, quality_hold, rework
- Status workflow: pending → approved → receiving → received → processed → closed
- Multi-tenant isolation (RLS)
- Auto-number generation (RMA-YYYY-NNNNN)

**Out of scope (this story):**
- RMA receiving workflow (Story 07.17 - requires Epic 05 integration)
- Disposition processing (Story 07.18 - LP generation, putaway)
- RMA scanner workflow (Story 07.17)
- Credit memo generation (Phase 3 - requires Finance module)
- Customer portal (Phase 3)
- RMA reports and analytics (Phase 2)

---

## Dependencies

### Epic Dependencies
- **Epic 01.1** - Organization context, RLS, users table, auth
- **Epic 01.6** - Role-based permissions (Manager, Admin roles for approval)
- **Epic 02.1** - Products table (for RMA lines)
- **Epic 07.1** - Customers table (required for RMA creation)
- **Epic 07.2** - Sales Orders table (optional FK for linked returns)

### Story Dependencies (within Epic 07)
- **07.1** - Customers CRUD (customer_id FK)
- **07.2** - Sales Orders (sales_order_id optional FK)

### Provides To
- **07.17** - RMA Receiving (requires rma_requests and rma_lines tables)
- **07.18** - RMA Disposition Processing (requires approval workflow)
- **Epic 09** - Finance (credit memo generation)

---

## Goal

Enable shipping clerks and managers to create, track, and approve customer return requests with full traceability, supporting quality management and inventory disposition workflows for returned products.

## User Story

As a **shipping clerk or manager**, I want to **create and manage RMA requests with approval workflows** so that **I can systematically process customer returns, track reasons for returns, and ensure proper disposition of returned inventory**.

---

## Scope

**In scope (this story)**
- Create RMA with customer selection and optional sales order link
- Add/edit/delete RMA lines (product, quantity_expected, reason_notes)
- Set reason codes (damaged, expired, wrong_product, quality_issue, customer_change, other)
- Set disposition (restock, scrap, quality_hold, rework)
- RMA status workflow: pending → approved → receiving → received → processed → closed
- Approval action (Manager+ only): pending → approved
- RMA list page with DataTable (filters: status, customer, date range, sort)
- RMA detail page with header info and lines table
- Auto-generate RMA number (RMA-YYYY-NNNNN)
- Update/delete allowed only for pending status
- RLS policies for multi-tenant isolation
- Cascade delete for rma_lines

**Out of scope (this story)**
- Physical receiving of returned items (Story 07.17)
- Quantity_received tracking (Story 07.17)
- LP generation for restock items (Story 07.18)
- Quality hold workflow (requires Epic 06)
- Credit memo generation (Phase 3, Epic 09)
- RMA scanner workflow (Story 07.17)
- RMA analytics and reports (Phase 2)
- Customer self-service RMA creation (Phase 3)

---

## Acceptance Criteria (Given/When/Then)

### AC-1: RMA List Page

**Given** a shipping clerk navigates to `/shipping/rma`
**When** the page loads
**Then** the RMA list displays within 500ms with columns: RMA Number, Customer, Status, Reason Code, Total Lines, Created Date, Actions

**Given** the RMA list has 50 RMAs
**When** the clerk searches for "RMA-2025-001"
**Then** only RMAs matching the RMA number display within 300ms

**Given** the RMA list is displayed
**When** the clerk filters by status "pending"
**Then** only pending RMAs appear

**Given** the RMA list is displayed
**When** the clerk filters by customer "Acme Foods"
**Then** only RMAs for that customer appear

**Given** the RMA list is displayed
**When** the clerk filters by date range "2025-01-01 to 2025-01-31"
**Then** only RMAs created in that date range appear

### AC-2: RMA Creation

**Given** a clerk clicks "Create RMA" on the RMA list page
**When** the RMA form modal opens
**Then** the form displays fields: customer (required), sales_order (optional), reason_code (required), disposition, notes

**Given** valid RMA data is entered:
- customer: "Acme Foods Inc"
- reason_code: "damaged"
- disposition: "restock"
- notes: "Packaging damaged in transit"
**When** the "Create" button is clicked
**Then** the RMA is created with status "pending" and auto-generated RMA number (RMA-YYYY-NNNNN) within 1 second

**Given** an RMA is created on 2025-03-15
**When** the RMA is saved
**Then** the RMA number is "RMA-2025-00001" (or next sequential for that year)

**Given** a customer is selected but no lines are added
**When** the form is submitted
**Then** an error displays: "At least one line item is required"

### AC-3: RMA Lines Management

**Given** a clerk is creating an RMA
**When** the "Add Line" button is clicked
**Then** a line entry form displays: product (required), quantity_expected (required), lot_number (optional), reason_notes (optional)

**Given** valid line data is entered:
- product: "Whole Wheat Bread"
- quantity_expected: 50
- lot_number: "LOT-2025-001"
- reason_notes: "Packages crushed"
**When** "Add" is clicked
**Then** the line is added to the RMA lines table

**Given** an RMA has 3 lines
**When** the clerk clicks "Edit" on a line
**Then** the line edit modal opens with pre-populated data

**Given** a clerk updates line quantity from 50 to 40
**When** "Save" is clicked
**Then** the updated quantity displays immediately in the lines table

**Given** a clerk clicks delete on a line
**When** the confirmation dialog is accepted
**Then** the line is removed from the RMA

**Given** an RMA has status "approved"
**When** the clerk attempts to edit a line
**Then** the edit button is disabled with tooltip: "Cannot edit approved RMA"

### AC-4: RMA Detail View

**Given** a clerk clicks on an RMA row in the list
**When** the RMA detail page loads
**Then** the page displays: RMA number, customer, sales order link (if present), status badge, reason code, disposition, notes, created date, created by

**Given** the RMA detail page is displayed
**When** the lines section is viewed
**Then** a table displays all lines with columns: Product, Quantity Expected, Quantity Received, Lot Number, Reason Notes, Actions

**Given** an RMA has status "pending"
**When** the detail page is viewed
**Then** the "Edit RMA" and "Delete RMA" buttons are visible

**Given** an RMA has status "approved"
**When** the detail page is viewed
**Then** the "Edit RMA" and "Delete RMA" buttons are hidden

### AC-5: RMA Approval Workflow

**Given** a user with role "MANAGER" or "ADMIN" views a pending RMA
**When** the "Approve" button is clicked
**Then** a confirmation dialog displays: "Approve this RMA? This will enable receiving workflow."

**Given** a manager confirms approval
**When** the approval is processed
**Then** the RMA status changes to "approved", approved_at is set to current timestamp, approved_by is set to current user ID

**Given** an RMA has status "approved"
**When** the detail page is viewed
**Then** approval info displays: "Approved by [user name] on [date/time]"

**Given** a user with role "SALES" or "VIEWER" views a pending RMA
**When** the detail page loads
**Then** the "Approve" button is hidden (insufficient permissions)

**Given** an RMA has status "receiving"
**When** the detail page is viewed
**Then** the "Approve" button is hidden (already past pending state)

### AC-6: RMA Edit Restrictions

**Given** an RMA has status "pending"
**When** the clerk clicks "Edit RMA"
**Then** the edit form opens with all fields editable except RMA number

**Given** a clerk updates the disposition from "restock" to "scrap"
**When** "Save" is clicked
**Then** the updated disposition displays immediately

**Given** an RMA has status "approved" or later
**When** the clerk clicks on the RMA
**Then** the "Edit RMA" button is hidden or disabled

**Given** an RMA has 2 lines and one has quantity_received > 0
**When** the clerk attempts to edit the RMA
**Then** an error displays: "Cannot edit RMA with received quantities"

### AC-7: RMA Deletion

**Given** an RMA has status "pending"
**When** the clerk clicks "Delete RMA"
**Then** a confirmation dialog displays: "Delete this RMA? This action cannot be undone."

**Given** the clerk confirms deletion
**When** the deletion is processed
**Then** the RMA and all its lines are deleted (cascade), and the list refreshes

**Given** an RMA has status "approved" or later
**When** the clerk attempts to delete
**Then** the delete action is disabled with tooltip: "Cannot delete approved or in-progress RMA"

### AC-8: Status Workflow

**Given** a new RMA is created
**When** the RMA is saved
**Then** the status is "pending" (default)

**Given** a pending RMA is approved by a manager
**When** the approval action is completed
**Then** the status changes to "approved"

**Given** an approved RMA has receiving workflow initiated (Story 07.17)
**When** the first line item is scanned
**Then** the status changes to "receiving"

**Given** an RMA in "receiving" status has all lines with quantity_received = quantity_expected
**When** the receiving is completed
**Then** the status changes to "received"

**Given** an RMA with status "received" has disposition processing completed (Story 07.18)
**When** all dispositions are executed
**Then** the status changes to "processed"

**Given** an RMA with status "processed"
**When** a manager clicks "Close RMA"
**Then** the status changes to "closed"

### AC-9: Reason Codes and Dispositions

**Given** a clerk is creating an RMA
**When** the reason_code dropdown is displayed
**Then** the options are: damaged, expired, wrong_product, quality_issue, customer_change, other

**Given** reason_code "damaged" is selected
**When** the form is submitted
**Then** the default disposition "scrap" is suggested (but can be overridden)

**Given** reason_code "expired" is selected
**When** the form is submitted
**Then** the default disposition "scrap" is suggested

**Given** reason_code "wrong_product" is selected
**When** the form is submitted
**Then** the default disposition "restock" is suggested

**Given** reason_code "quality_issue" is selected
**When** the form is submitted
**Then** the default disposition "quality_hold" is suggested

**Given** disposition dropdown is displayed
**When** viewed
**Then** the options are: restock, scrap, quality_hold, rework

### AC-10: Multi-Tenant Isolation

**Given** two organizations (Org A and Org B) each have RMAs with number "RMA-2025-00001"
**When** a user from Org A queries RMAs
**Then** only Org A's "RMA-2025-00001" is returned (RLS enforced)

**Given** a user from Org A attempts to access an RMA from Org B via direct API call
**When** the request is processed
**Then** a 404 error is returned (RLS blocks cross-org access)

**Given** a user from Org A creates an RMA
**When** the RMA is saved
**Then** the org_id is automatically set to Org A (from auth context)

### AC-11: Auto-Number Generation

**Given** an organization creates its first RMA in 2025
**When** the RMA is saved
**Then** the RMA number is "RMA-2025-00001"

**Given** the same organization creates a second RMA in 2025
**When** the RMA is saved
**Then** the RMA number is "RMA-2025-00002"

**Given** an organization creates its first RMA in 2026
**When** the RMA is saved
**Then** the RMA number is "RMA-2026-00001" (year resets counter)

**Given** concurrent RMA creation attempts
**When** multiple users create RMAs simultaneously
**Then** each RMA receives a unique sequential number (database lock prevents conflicts)

---

## Implementation Notes

### API Endpoints

```typescript
// RMA Core
GET    /api/shipping/rma                          // List RMAs with filters
GET    /api/shipping/rma/:id                      // RMA detail
POST   /api/shipping/rma                          // Create RMA
PUT    /api/shipping/rma/:id                      // Update RMA (pending only)
DELETE /api/shipping/rma/:id                      // Delete RMA (pending only)

// RMA Lines
POST   /api/shipping/rma/:id/lines                // Add line
PUT    /api/shipping/rma/:id/lines/:lineId        // Update line (pending RMA only)
DELETE /api/shipping/rma/:id/lines/:lineId        // Delete line (pending RMA only)

// RMA Actions
POST   /api/shipping/rma/:id/approve              // Approve RMA (Manager+ only)
POST   /api/shipping/rma/:id/close                // Close RMA (Manager+ only)

// Future endpoints (Story 07.17+)
// POST   /api/shipping/rma/:id/receive-line       // Receive line item
// POST   /api/shipping/rma/:id/process            // Process dispositions
```

### Database Schema

```sql
-- RMA Requests table
CREATE TABLE rma_requests (
  id                    UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id                UUID NOT NULL REFERENCES organizations(id),
  rma_number            TEXT NOT NULL,           -- Auto: RMA-YYYY-NNNNN
  customer_id           UUID NOT NULL REFERENCES customers(id),
  sales_order_id        UUID REFERENCES sales_orders(id),  -- Optional link
  reason_code           TEXT NOT NULL,           -- damaged, expired, wrong_product, quality_issue, customer_change, other
  status                TEXT NOT NULL DEFAULT 'pending',  -- pending, approved, receiving, received, processed, closed
  total_value           DECIMAL(15,2),           -- Calculated from lines
  disposition           TEXT,                    -- restock, scrap, quality_hold, rework
  notes                 TEXT,
  created_at            TIMESTAMPTZ DEFAULT now(),
  created_by            UUID REFERENCES users(id),
  updated_at            TIMESTAMPTZ DEFAULT now(),
  approved_at           TIMESTAMPTZ,
  approved_by           UUID REFERENCES users(id),

  CONSTRAINT rma_requests_org_number_unique UNIQUE(org_id, rma_number)
);

-- RMA Lines table
CREATE TABLE rma_lines (
  id                    UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id                UUID NOT NULL REFERENCES organizations(id),
  rma_request_id        UUID NOT NULL REFERENCES rma_requests(id) ON DELETE CASCADE,
  product_id            UUID NOT NULL REFERENCES products(id),
  quantity_expected     DECIMAL(15,4) NOT NULL,
  quantity_received     DECIMAL(15,4) DEFAULT 0,
  lot_number            TEXT,
  reason_notes          TEXT,
  disposition           TEXT,                    -- Override RMA-level disposition
  created_at            TIMESTAMPTZ DEFAULT now()
);

-- Indexes
CREATE INDEX idx_rma_requests_org_status ON rma_requests(org_id, status);
CREATE INDEX idx_rma_requests_customer ON rma_requests(customer_id);
CREATE INDEX idx_rma_requests_sales_order ON rma_requests(sales_order_id);
CREATE INDEX idx_rma_requests_number ON rma_requests(rma_number);
CREATE INDEX idx_rma_requests_created_at ON rma_requests(created_at);
CREATE INDEX idx_rma_lines_rma_request ON rma_lines(rma_request_id);
CREATE INDEX idx_rma_lines_product ON rma_lines(product_id);

-- RLS Policies
ALTER TABLE rma_requests ENABLE ROW LEVEL SECURITY;
ALTER TABLE rma_lines ENABLE ROW LEVEL SECURITY;

CREATE POLICY "rma_requests_org_isolation" ON rma_requests
  FOR ALL USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

CREATE POLICY "rma_lines_org_isolation" ON rma_lines
  FOR ALL USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

-- Auto-number generation function
CREATE OR REPLACE FUNCTION generate_rma_number(p_org_id UUID)
RETURNS TEXT AS $$
DECLARE
  v_year INTEGER;
  v_sequence INTEGER;
  v_rma_number TEXT;
BEGIN
  v_year := EXTRACT(YEAR FROM CURRENT_DATE);

  -- Get next sequence for this org and year
  SELECT COALESCE(MAX(
    CAST(SUBSTRING(rma_number FROM 10) AS INTEGER)
  ), 0) + 1
  INTO v_sequence
  FROM rma_requests
  WHERE org_id = p_org_id
    AND rma_number LIKE 'RMA-' || v_year || '-%';

  -- Format: RMA-YYYY-NNNNN
  v_rma_number := 'RMA-' || v_year || '-' || LPAD(v_sequence::TEXT, 5, '0');

  RETURN v_rma_number;
END;
$$ LANGUAGE plpgsql;

-- Trigger to auto-generate RMA number on insert
CREATE OR REPLACE FUNCTION set_rma_number()
RETURNS TRIGGER AS $$
BEGIN
  IF NEW.rma_number IS NULL OR NEW.rma_number = '' THEN
    NEW.rma_number := generate_rma_number(NEW.org_id);
  END IF;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_set_rma_number
  BEFORE INSERT ON rma_requests
  FOR EACH ROW
  EXECUTE FUNCTION set_rma_number();

-- Updated_at trigger
CREATE TRIGGER trigger_rma_requests_updated_at
  BEFORE UPDATE ON rma_requests
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();
```

### Frontend Components

```
apps/frontend/app/(authenticated)/shipping/rma/
  page.tsx                          -- RMA list page
  [id]/page.tsx                     -- RMA detail page
  new/page.tsx                      -- Create RMA page (optional, or use modal)
  components/
    RMATable.tsx                    -- DataTable with search, filters, sort
    RMAForm.tsx                     -- Create/Edit RMA form
    RMALinesTable.tsx               -- Lines display table
    RMALineForm.tsx                 -- Add/Edit line modal
    RMAStatusBadge.tsx              -- Status badge (pending, approved, etc.)
    RMAReasonBadge.tsx              -- Reason code badge
    RMADispositionBadge.tsx         -- Disposition badge
    RMAApprovalInfo.tsx             -- Approval timestamp and user display
    RMAActionButtons.tsx            -- Approve, Close, Edit, Delete buttons
```

### Services

```typescript
// lib/services/rma-service.ts
export class RMAService {
  static async listRMAs(filters: {
    search?: string;
    status?: string;
    customer_id?: string;
    date_from?: string;
    date_to?: string;
    page?: number;
    limit?: number;
  }): Promise<{ rmas: RMA[]; total: number }>;

  static async getRMA(id: string): Promise<RMA>;

  static async createRMA(data: CreateRMAInput): Promise<RMA>;

  static async updateRMA(id: string, data: UpdateRMAInput): Promise<RMA>;

  static async deleteRMA(id: string): Promise<void>;

  static async canEditRMA(rma: RMA): Promise<boolean>;

  static async canDeleteRMA(rma: RMA): Promise<boolean>;

  // Lines
  static async addLine(rmaId: string, data: CreateRMALineInput): Promise<RMALine>;

  static async updateLine(rmaId: string, lineId: string, data: UpdateRMALineInput): Promise<RMALine>;

  static async deleteLine(rmaId: string, lineId: string): Promise<void>;

  // Actions
  static async approveRMA(id: string): Promise<RMA>;

  static async closeRMA(id: string): Promise<RMA>;

  // Helpers
  static async suggestDisposition(reasonCode: string): Promise<string>;

  static async calculateTotalValue(rmaId: string): Promise<number>;
}
```

### Validation (Zod)

```typescript
// lib/validation/rma-schema.ts
import { z } from 'zod';

export const rmaReasonCodeEnum = z.enum([
  'damaged',
  'expired',
  'wrong_product',
  'quality_issue',
  'customer_change',
  'other'
]);

export const rmaDispositionEnum = z.enum([
  'restock',
  'scrap',
  'quality_hold',
  'rework'
]);

export const rmaStatusEnum = z.enum([
  'pending',
  'approved',
  'receiving',
  'received',
  'processed',
  'closed'
]);

export const rmaSchema = z.object({
  customer_id: z.string().uuid("Invalid customer ID"),
  sales_order_id: z.string().uuid("Invalid sales order ID").optional().nullable(),
  reason_code: rmaReasonCodeEnum,
  disposition: rmaDispositionEnum.optional().nullable(),
  notes: z.string().max(1000, "Notes must be at most 1000 characters").optional().nullable(),
});

export const rmaLineSchema = z.object({
  product_id: z.string().uuid("Invalid product ID"),
  quantity_expected: z.number()
    .positive("Quantity must be positive")
    .max(999999.9999, "Quantity too large"),
  lot_number: z.string()
    .max(100, "Lot number must be at most 100 characters")
    .optional()
    .nullable(),
  reason_notes: z.string()
    .max(500, "Reason notes must be at most 500 characters")
    .optional()
    .nullable(),
  disposition: rmaDispositionEnum.optional().nullable(),
});

export const rmaUpdateSchema = rmaSchema.partial().extend({
  status: rmaStatusEnum.optional(),
});
```

### Key Business Rules

1. **RMA Number Generation**: Auto-generate format RMA-YYYY-NNNNN per org, sequential within year
2. **Status Workflow**: pending → approved → receiving → received → processed → closed (one-way, no rollback)
3. **Edit Restrictions**: Can only edit/delete RMAs with status "pending"
4. **Approval Authority**: Only Manager or Admin roles can approve RMAs
5. **Line Validation**: RMA must have at least one line before approval
6. **Cascade Delete**: Deleting an RMA deletes all its lines (ON DELETE CASCADE)
7. **Disposition Defaults**:
   - damaged → scrap
   - expired → scrap
   - wrong_product → restock
   - quality_issue → quality_hold
   - customer_change → restock
   - other → (no default, user must select)
8. **Line-Level Disposition**: Lines can override RMA-level disposition
9. **Quantity Tracking**: quantity_received starts at 0, updated in Story 07.17
10. **Total Value**: Calculated from line items (product price × quantity_expected)
11. **Approval Tracking**: Record approved_at timestamp and approved_by user ID
12. **Sales Order Link**: Optional FK to sales_orders for returns linked to specific orders

---

## Food Safety Rules

### Traceability
- Lot numbers captured at line level for full traceability
- RMA receiving (Story 07.17) will validate lot numbers against inventory
- All returned products tracked through disposition process

### Quality Holds
- Disposition "quality_hold" triggers QC workflow (future Epic 06 integration)
- Products with quality_hold cannot be restocked until QC approval
- QC findings may change disposition from quality_hold to restock or scrap

### Allergen Considerations
- Returned products must maintain allergen information
- Restocked items retain original allergen classifications
- No special allergen handling in this story (basic CRUD only)

---

## Deliverables

- **Database Migration**: Create `rma_requests`, `rma_lines` tables with RLS policies and auto-number trigger
- **API Routes**:
  - `/api/shipping/rma` (GET, POST)
  - `/api/shipping/rma/:id` (GET, PUT, DELETE)
  - `/api/shipping/rma/:id/lines` (POST)
  - `/api/shipping/rma/:id/lines/:lineId` (PUT, DELETE)
  - `/api/shipping/rma/:id/approve` (POST)
  - `/api/shipping/rma/:id/close` (POST)
- **Frontend Pages**:
  - RMA list page (`/shipping/rma`)
  - RMA detail page (`/shipping/rma/:id`)
- **Components**:
  - RMATable (DataTable with search, filters)
  - RMAForm (Create/Edit modal)
  - RMALinesTable + RMALineForm
  - Status, reason, disposition badges
  - RMAApprovalInfo
  - RMAActionButtons
- **Services**: `rma-service.ts` with CRUD operations and approval logic
- **Validation**: Zod schemas for RMA, RMA lines, enums
- **Tests**:
  - Unit tests for rma-service (>80% coverage)
  - Integration tests for all API endpoints
  - E2E test for complete RMA creation and approval workflow

---

## Definition of Done

- [ ] Database tables created with RLS policies enabled
- [ ] Auto-number generation function works correctly (RMA-YYYY-NNNNN)
- [ ] All API endpoints functional and returning correct data
- [ ] RMA list page loads within 500ms for 50 RMAs
- [ ] Search and filter work within 300ms
- [ ] Create RMA form validates all fields
- [ ] RMA lines CRUD operations work end-to-end
- [ ] Approval workflow changes status to "approved" and records timestamp/user
- [ ] Edit/delete disabled for non-pending RMAs
- [ ] Disposition defaults suggested based on reason code
- [ ] RMA detail page displays all info correctly
- [ ] Status badges display correct colors
- [ ] Permission checks hide unauthorized actions (approval button)
- [ ] Multi-tenant isolation verified (RLS tests pass)
- [ ] Cascade delete works (deleting RMA deletes lines)
- [ ] Unit tests pass (>80% coverage for services)
- [ ] Integration tests pass for all API endpoints
- [ ] E2E test passes for RMA creation and approval workflow
- [ ] Code reviewed and approved
- [ ] Documentation updated (API docs, component docs)

---

## Future Phases (Not in This Story)

### Story 07.17 - RMA Receiving
- Scanner workflow for receiving returned items
- Update quantity_received on rma_lines
- Status transition: approved → receiving → received
- Lot number validation against expected lot
- Desktop receiving UI

### Story 07.18 - RMA Disposition Processing
- Generate new license plates for restock items
- Create putaway tasks for restocked inventory
- Record waste/scrap transactions
- Quality hold integration (Epic 06)
- Status transition: received → processed

### Phase 2 - RMA Enhancements
- RMA reports (return rate by product, customer, reason)
- Return rate analytics and trends
- Root cause analysis (quality issues)
- Supplier notification for wrong_product returns

### Phase 3 - Advanced RMA
- Credit memo generation (Epic 09 Finance integration)
- Customer portal for RMA creation
- RMA approval routing (multi-level approval)
- RMA restocking fees
- Advanced disposition options (repair, rework)

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-12-16 | Initial story creation | PM-AGENT |
