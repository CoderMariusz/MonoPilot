# 07.10 - Pick Confirmation - Scanner/Mobile UI

**Priority**: P0 (MVP Core)
**Complexity**: L (4-5 days)
**Type:** frontend + backend (scanner)
**Phase:** 1C (After Story 07.9 - Pick Confirmation Desktop)

**State:** ready
**Primary PRD:** `docs/1-BASELINE/product/modules/shipping.md` (FR-7.25, FR-7.26, FR-7.27, FR-7.28)
**Architecture:** `docs/1-BASELINE/architecture/modules/shipping.md` (lines 507-517, 630-641, 1050-1072)

---

## MVP Scope

This story implements the mobile-optimized scanner UI for pick confirmation at `/scanner/shipping/pick`. Enables warehouse pickers to efficiently confirm picks using barcode scanning with real-time audio/visual feedback, designed for warehouse environments with large touch targets and high-contrast visuals.

**What's IN scope:**
- Mobile-optimized scanner page at `/scanner/shipping/pick`
- POST `/api/shipping/scanner/pick` endpoint (scanner-optimized response)
- GET `/api/shipping/scanner/lookup/lp/:barcode` (LP quick lookup)
- GET `/api/shipping/scanner/suggest-pick/:lineId` (next pick suggestion)
- Scanner workflow:
  1. Select pick list from "My Picks"
  2. Start pick list (status -> in_progress)
  3. Display current pick line (sorted by pick_sequence)
  4. Scan LP barcode (validate matches expected LP)
  5. Confirm quantity (number pad input)
  6. Audio/visual feedback (success/error)
  7. Auto-advance to next line
  8. Complete pick list when all lines done
- Mobile UI components:
  - Large scan input field (auto-focus)
  - Number pad for quantity (48px+ touch targets)
  - Progress bar (X of Y lines)
  - Current line card (product, location, qty)
  - Skip line button (short pick flow)
  - Allergen warning banner
- Audio feedback (Web Audio API)
- Vibration feedback (Navigator.vibrate())
- FIFO/FEFO enforcement warnings
- Barcode scanner integration (camera or hardware)

**What's OUT of scope (deferred):**
- Offline mode implementation (Phase 2)
- Advanced route optimization (Phase 2, Story 07.30)
- Multi-user collision detection (Phase 2)
- Batch picking workflow (Phase 2)
- Pick performance analytics (Phase 3)

---

## Dependencies

### Epic Dependencies
- **Epic 01.1** - Organizations, RLS, users, roles (HARD)
- **Epic 01.9** - Locations (zone, aisle, bin hierarchy) (HARD)
- **Epic 02.1** - Products (HARD)
- **Epic 02.3** - Allergens (for customer restrictions) (HARD)
- **Epic 05.1** - License Plates (HARD)
- **Epic 05.3** - LP Reservations/Allocations (HARD)

### Story Dependencies (within Epic 07)
- **07.8** - Pick List Generation (provides pick_lists, pick_list_lines tables) **[BLOCKER]**
- **07.9** - Pick Confirmation Desktop (provides pick confirmation logic, short pick handling) **[BLOCKER]**
- **07.3** - Sales Orders CRUD (provides sales_orders table)
- **07.7** - Inventory Allocation (provides allocation records)

### Provides To
- **07.11** - Packing Station Workflow (picks feed into packing)
- **07.12** - Pack Confirmation Scanner (same scanner patterns)

---

## Goal

Provide warehouse pickers with a mobile-optimized, barcode-scanner-friendly interface for confirming picks in the warehouse. The UI must be usable on handheld scanners (Zebra, Honeywell) and mobile phones, with instant audio/visual feedback to maximize picking speed and accuracy.

## User Story

As a **warehouse picker**, I want to **use a mobile scanner to confirm picks with barcode scanning and instant feedback** so that **I can pick orders quickly and accurately without returning to a desktop computer**.

## Scope

**In scope (this story)**
- Scanner page: `/scanner/shipping/pick`
- Scanner API endpoints (optimized for mobile)
- Select pick list from "My Picks"
- Start pick list (status -> in_progress)
- Display current pick line (product, location, qty, lot)
- Scan LP barcode (validate correct LP)
- Enter quantity picked (number pad, default = full qty)
- Audio feedback (success beep, error beep)
- Visual feedback (green flash, red flash)
- Vibration feedback (mobile devices)
- Auto-advance to next line
- Complete pick list (status -> completed)
- Short pick handling (skip line, capture reason)
- Allergen warning banner (red banner if product has allergens)
- FIFO/FEFO warning (warn if not picking oldest lot)
- Progress bar (X of Y lines picked)
- Large touch targets (48px+ minimum)
- High contrast colors (WCAG 2.1 AA)
- Auto-focus on scan input after each action
- Performance: < 100ms scan feedback, < 200ms API response

**Out of scope (this story)**
- Offline mode (queue operations locally) - Phase 2
- Route optimization display (show map) - Phase 2
- Multi-user collision detection - Phase 2
- Batch picking (pick-to-box) - Phase 2
- Voice picking integration - Phase 3
- Wearable device support - Phase 3

---

## Acceptance Criteria (Given/When/Then)

### AC-1: Select Pick List from "My Picks"

**Given** a picker user with 3 assigned pick lists (status = 'assigned' or 'in_progress')
**When** the picker navigates to `/scanner/shipping/pick`
**Then** the system displays a list of assigned pick lists:
- Pick List # (large text, 24px)
- Priority badge (urgent = red, high = orange, normal = blue, low = gray)
- Line count (e.g., "12 lines")
- Status (assigned / in_progress)
**And** lists are sorted by priority DESC, created_at ASC
**And** "Continue" button is shown for in_progress lists
**And** "Start" button is shown for assigned lists
**And** each list row is a large touch target (min 64px height)

### AC-2: Start Pick List

**Given** a picker selects an assigned pick list
**When** the picker taps "Start" button
**Then** the system updates pick_list.status to 'in_progress'
**And** updates pick_list.started_at to current timestamp
**And** displays the first unpicked line (pick_sequence = 1)
**And** auto-focuses on the scan input field
**And** plays a short "start" audio cue (440Hz, 100ms)

### AC-3: Display Current Pick Line

**Given** a pick list with 12 lines in progress
**When** the system displays the current pick line
**Then** the scanner UI shows:
- **Location Card** (top, prominent):
  - Zone badge (e.g., "CHILLED" with blue background)
  - Full location path (e.g., "A-03-12" in 32px bold text)
  - "Go to location" instruction
- **Product Card** (middle):
  - Product name (24px, bold)
  - SKU (16px, gray)
  - Lot number (16px)
  - Best Before Date (if perishable)
- **Quantity Card** (bottom):
  - "Pick Qty: 24" (32px, bold, green)
  - Expected LP# (16px)
- **Progress Bar** (top):
  - "Line 3 of 12" text
  - Visual progress indicator
- **Navigation Buttons**:
  - "Skip Line" button (left, secondary)
  - "Confirm" button (right, primary, disabled until scanned)

### AC-4: Scan LP Barcode - Valid Scan

**Given** the picker is on a pick line expecting LP# "LP-2025-00042"
**When** the picker scans the LP barcode "LP-2025-00042"
**Then** the system validates the scanned LP matches the expected LP
**And** displays green flash overlay (200ms fade)
**And** plays success audio tone (880Hz, 150ms)
**And** triggers vibration (100ms) on supported devices
**And** enables the quantity input (auto-populated with quantity_to_pick)
**And** focuses on quantity input for adjustment if needed
**And** displays "LP Verified" badge in green

### AC-5: Scan LP Barcode - Invalid Scan (Wrong LP)

**Given** the picker is on a pick line expecting LP# "LP-2025-00042"
**When** the picker scans a different LP barcode "LP-2025-00099"
**Then** the system validates the scanned LP does NOT match
**And** displays red flash overlay (300ms fade)
**And** plays error audio tone (220Hz, 300ms, descending)
**And** triggers vibration (200ms, 100ms pause, 200ms) on supported devices
**And** displays error message: "Wrong LP - Expected LP-2025-00042"
**And** keeps focus on scan input for retry
**And** does NOT enable quantity input
**And** logs the error (for analytics)

### AC-6: Scan LP Barcode - Invalid Scan (LP Not Found)

**Given** the picker scans a barcode that is not a valid LP
**When** the system queries `/api/shipping/scanner/lookup/lp/:barcode`
**Then** the system returns 404 (LP not found)
**And** displays red flash overlay
**And** plays error audio tone
**And** displays error message: "LP Not Found - Check barcode"
**And** keeps focus on scan input for retry

### AC-7: Quantity Confirmation with Number Pad

**Given** the picker has scanned a valid LP for a line with quantity_to_pick = 24
**When** the system displays the quantity confirmation UI
**Then** the UI shows:
- Large quantity input field (64px height, 32px text)
- Pre-filled with "24" (default = quantity_to_pick)
- Number pad with large buttons (64px x 64px each):
  - 1, 2, 3
  - 4, 5, 6
  - 7, 8, 9
  - Clear (C), 0, Backspace
- "Confirm Pick" button (full width, 56px height, green)
- "Cancel" button (secondary, returns to scan mode)
**And** if picker enters 24 and taps Confirm:
- quantity_picked = 24
- status = 'picked'
- picked_at = now()
- picked_by = current user
**And** auto-advances to next line

### AC-8: Short Pick Flow

**Given** the picker scans LP with available quantity < quantity_to_pick
**Or** the picker taps "Skip Line" button
**When** the system prompts for short pick
**Then** the UI displays a modal:
- "Short Pick" title
- "Quantity Available" input (number pad)
- Reason dropdown:
  - "Insufficient inventory"
  - "Product not found"
  - "Product damaged"
  - "Location empty"
  - "Other"
- "Notes" text input (optional)
- "Confirm Short Pick" button
- "Cancel" button
**And** on confirm:
- Creates short pick record (status = 'short')
- Updates quantity_picked = entered quantity
- Stores reason code in pick_list_lines.short_pick_reason
- Triggers backorder workflow (Story 07.7)
- Plays short pick audio (440Hz + 554Hz, 200ms)
- Shows "Short pick recorded" toast
- Advances to next line

### AC-9: Audio Feedback Specifications

**Given** the scanner app is active
**When** various events occur
**Then** the system plays appropriate audio feedback:

| Event | Frequency | Duration | Pattern |
|-------|-----------|----------|---------|
| Start Pick List | 440Hz | 100ms | Single tone |
| Valid LP Scan | 880Hz | 150ms | Single high tone |
| Invalid LP Scan | 220Hz | 300ms | Descending tone |
| Quantity Confirmed | 660Hz -> 880Hz | 200ms | Rising sweep |
| Pick Line Complete | 880Hz | 100ms x2 | Double beep |
| Pick List Complete | 440Hz -> 880Hz | 500ms | Victory sweep |
| Error (General) | 220Hz | 200ms x2 | Double low |
| Short Pick | 440Hz + 554Hz | 200ms | Chord |

**And** audio is played using Web Audio API (AudioContext)
**And** volume is configurable in scanner settings (default 70%)
**And** audio can be muted via toggle in settings

### AC-10: Visual Feedback Specifications

**Given** the scanner app is active
**When** scan events occur
**Then** the system displays visual feedback:

| Event | Color | Duration | Animation |
|-------|-------|----------|-----------|
| Valid Scan | #22C55E (Green 500) | 200ms | Flash overlay + fade |
| Invalid Scan | #EF4444 (Red 500) | 300ms | Flash overlay + shake |
| Warning | #F59E0B (Amber 500) | 250ms | Flash border |
| Pick Complete | #22C55E | 300ms | Full screen + scale |

**And** flash overlay is semi-transparent (opacity 0.3)
**And** animations use CSS transitions (GPU-accelerated)
**And** high contrast mode available for bright environments

### AC-11: Vibration Feedback (Mobile)

**Given** the picker is using a mobile device with vibration support
**When** scan events occur
**Then** the system triggers vibration patterns:

| Event | Pattern |
|-------|---------|
| Valid Scan | 100ms |
| Invalid Scan | [200, 100, 200] (vibrate, pause, vibrate) |
| Pick Complete | [100, 50, 100] |
| Error | [300, 100, 300] |

**And** vibration uses Navigator.vibrate() API
**And** vibration can be disabled in scanner settings
**And** fallback gracefully on unsupported devices (no error)

### AC-12: Auto-Advance to Next Line

**Given** the picker confirms a pick (quantity entered)
**When** the system saves the pick confirmation
**Then** the system automatically advances to the next unpicked line
**And** next line is determined by:
1. status = 'pending' (skip already picked/short)
2. Sorted by pick_sequence ASC
**And** displays new line with location/product/qty
**And** auto-focuses on scan input
**And** plays "line complete" audio (double beep)
**And** updates progress bar

### AC-13: Complete Pick List

**Given** the picker has picked the last line (12 of 12)
**When** the system detects all lines are picked or short
**Then** the system updates pick_list.status to 'completed'
**And** updates pick_list.completed_at to current timestamp
**And** displays "Pick List Complete" full-screen celebration:
- Green background
- Checkmark icon (animated)
- "Pick List Complete!" text (32px)
- Summary: "12 lines picked, 0 short"
- "Return to My Picks" button
**And** plays victory audio sweep (440Hz -> 880Hz, 500ms)
**And** triggers vibration pattern [100, 50, 100]

### AC-14: Allergen Warning Banner

**Given** a pick line for a product with allergens (e.g., "Contains: Milk, Eggs")
**And** the customer has allergen restrictions
**When** the system displays the pick line
**Then** the system shows an allergen warning banner:
- Red background (#DC2626)
- Warning icon (triangle with !)
- Text: "ALLERGEN ALERT: Contains Milk, Eggs"
- Banner is persistent (not dismissible)
- Banner height: 48px minimum
**And** the picker must acknowledge before confirming (checkbox)

### AC-15: FIFO/FEFO Warning

**Given** a pick line with suggested LP (oldest lot)
**And** the picker scans a different LP with same product but newer lot
**When** the system validates the scanned LP
**Then** the system displays a FIFO/FEFO warning:
- Amber warning banner
- Text: "Older lot available - LP-2025-00040 (Lot: A2024-001)"
- "Use Suggested LP" button
- "Continue Anyway" button (requires confirmation)
**And** if picker continues anyway:
- Logs override event
- Updates picked_license_plate_id to scanned LP
- Proceeds with pick confirmation

### AC-16: LP Lookup Endpoint

**Given** the scanner needs to validate a scanned LP barcode
**When** the system calls GET `/api/shipping/scanner/lookup/lp/:barcode`
**Then** the endpoint returns (if valid):
```json
{
  "lp_number": "LP-2025-00042",
  "product_id": "uuid",
  "product_name": "Chocolate Milk 1L",
  "product_sku": "CHO-MILK-1L",
  "lot_number": "A2025-003",
  "best_before_date": "2025-06-15",
  "on_hand_quantity": 48,
  "location_id": "uuid",
  "location_path": "CHILLED / A-03-12",
  "allergens": ["Milk"],
  "qa_status": "passed"
}
```
**And** returns 404 if LP not found
**And** response time < 100ms
**And** filters by org_id (RLS)

### AC-17: Scanner Pick Endpoint

**Given** the picker confirms a pick via scanner
**When** the system calls POST `/api/shipping/scanner/pick`
**Then** the endpoint accepts:
```json
{
  "pick_line_id": "uuid",
  "scanned_lp_barcode": "LP-2025-00042",
  "quantity_picked": 24,
  "short_pick": false,
  "short_pick_reason": null,
  "short_pick_notes": null
}
```
**And** returns (optimized for scanner):
```json
{
  "success": true,
  "pick_line_status": "picked",
  "next_line": {
    "id": "uuid",
    "pick_sequence": 4,
    "location_path": "CHILLED / A-04-08",
    "product_name": "Yogurt Strawberry",
    "quantity_to_pick": 12,
    "expected_lp": "LP-2025-00055"
  },
  "progress": {
    "total_lines": 12,
    "picked_lines": 4,
    "short_lines": 0
  },
  "pick_list_complete": false
}
```
**And** response time < 200ms
**And** validates LP matches expected (or acceptable alternate)
**And** updates quantity_picked, picked_at, picked_by, picked_license_plate_id

### AC-18: Touch Target Requirements (WCAG)

**Given** the scanner UI is designed for warehouse use
**When** buttons and interactive elements are rendered
**Then** all touch targets meet accessibility requirements:
- Minimum 48x48 pixels (WCAG 2.1 AA)
- Buttons: 56px height, 48px+ width
- Number pad buttons: 64x64 pixels
- Input fields: 56px height
- List rows: 64px minimum height
- Spacing between targets: 8px minimum
**And** touch targets have visible focus states
**And** active states are clearly visible (scale, color change)

### AC-19: Scanner Settings

**Given** the picker wants to customize scanner behavior
**When** the picker accesses scanner settings (gear icon)
**Then** the settings modal includes:
- **Audio Settings**:
  - Volume slider (0-100%, default 70%)
  - Mute toggle (default off)
  - Test audio button
- **Vibration Settings**:
  - Enable/disable toggle (default on)
- **Display Settings**:
  - High contrast mode toggle
  - Large text mode toggle (+4px font size)
- **Scanner Settings**:
  - Camera scanner enable/disable (for phone camera scanning)
  - Hardware scanner mode (default, for dedicated scanners)
**And** settings are persisted in localStorage
**And** settings sync across sessions

### AC-20: RLS Policy Enforcement

**Given** two organizations (Org A and Org B) in the database
**When** a picker from Org A uses the scanner
**Then** the system only returns pick lists where org_id = Org A
**And** prevents access to Org B's pick lists
**And** scanner endpoints filter by org_id from auth context
**And** LP lookup only returns LPs within picker's organization

---

## Scanner UI Wireframes

### Screen 1: My Picks List

```
+------------------------------------------+
|  [<]  PICK LISTS              [Settings] |
+------------------------------------------+
|  Progress: 3 active picks                |
+------------------------------------------+
|                                          |
|  +--------------------------------------+|
|  | PL-2025-00042                   [!]  ||
|  | 12 lines | URGENT              [red] ||
|  |                          [Continue]  ||
|  +--------------------------------------+|
|                                          |
|  +--------------------------------------+|
|  | PL-2025-00043                        ||
|  | 8 lines | Normal               [blu] ||
|  |                             [Start]  ||
|  +--------------------------------------+|
|                                          |
|  +--------------------------------------+|
|  | PL-2025-00044                        ||
|  | 5 lines | Low                  [gry] ||
|  |                             [Start]  ||
|  +--------------------------------------+|
|                                          |
+------------------------------------------+
|            Pull to refresh               |
+------------------------------------------+
```

### Screen 2: Pick Line (Active Picking)

```
+------------------------------------------+
|  Line 3 of 12          [====----] 25%   |
+------------------------------------------+
| +--------------------------------------+ |
| |  ALLERGEN ALERT                [!]   | |  <- Red banner (if applicable)
| |  Contains: Milk, Eggs                | |
| +--------------------------------------+ |
+------------------------------------------+
|                                          |
|      +----------------------------+      |
|      |     CHILLED                |      |  <- Zone badge
|      +----------------------------+      |
|                                          |
|      +----------------------------+      |
|      |        A-03-12             |      |  <- Location (32px bold)
|      +----------------------------+      |
|                                          |
+------------------------------------------+
|                                          |
|   Chocolate Milk 1L                      |  <- Product name (24px)
|   SKU: CHO-MILK-1L                       |  <- SKU (16px gray)
|   Lot: A2025-003 | BBD: Jun 15, 2025     |
|                                          |
+------------------------------------------+
|                                          |
|      +----------------------------+      |
|      |    PICK QTY: 24            |      |  <- Qty (32px green)
|      +----------------------------+      |
|                                          |
|   Expected LP: LP-2025-00042             |
|                                          |
+------------------------------------------+
|                                          |
|   +----------------------------------+   |
|   |      [Scan LP Barcode]           |   |  <- Scan input (auto-focus)
|   +----------------------------------+   |
|                                          |
+------------------------------------------+
|                                          |
|   [Skip Line]              [Confirm]     |  <- Buttons (disabled until scan)
|                            (disabled)    |
|                                          |
+------------------------------------------+
```

### Screen 3: Quantity Confirmation

```
+------------------------------------------+
|  Quantity Confirmation                   |
+------------------------------------------+
|                                          |
|   LP Verified: LP-2025-00042   [check]   |  <- Green badge
|                                          |
+------------------------------------------+
|                                          |
|      +----------------------------+      |
|      |           24               |      |  <- Qty input (64px height)
|      +----------------------------+      |
|                                          |
+------------------------------------------+
|                                          |
|   +--------+  +--------+  +--------+     |
|   |   1    |  |   2    |  |   3    |     |
|   +--------+  +--------+  +--------+     |  <- Number pad (64x64 buttons)
|                                          |
|   +--------+  +--------+  +--------+     |
|   |   4    |  |   5    |  |   6    |     |
|   +--------+  +--------+  +--------+     |
|                                          |
|   +--------+  +--------+  +--------+     |
|   |   7    |  |   8    |  |   9    |     |
|   +--------+  +--------+  +--------+     |
|                                          |
|   +--------+  +--------+  +--------+     |
|   |   C    |  |   0    |  |  <--  |     |
|   +--------+  +--------+  +--------+     |
|                                          |
+------------------------------------------+
|                                          |
|   +----------------------------------+   |
|   |        CONFIRM PICK              |   |  <- Primary button (green)
|   +----------------------------------+   |
|                                          |
|   [Cancel]                               |  <- Secondary (returns to scan)
|                                          |
+------------------------------------------+
```

### Screen 4: Short Pick Modal

```
+------------------------------------------+
|  Short Pick                     [X]      |
+------------------------------------------+
|                                          |
|   Expected: 24                           |
|   Available: ___                         |  <- Number input
|                                          |
|   Reason:                                |
|   +----------------------------------+   |
|   | Select reason...              [v] |   |  <- Dropdown
|   +----------------------------------+   |
|   | - Insufficient inventory          |   |
|   | - Product not found               |   |
|   | - Product damaged                 |   |
|   | - Location empty                  |   |
|   | - Other                           |   |
|   +----------------------------------+   |
|                                          |
|   Notes (optional):                      |
|   +----------------------------------+   |
|   |                                  |   |
|   +----------------------------------+   |
|                                          |
+------------------------------------------+
|                                          |
|   +----------------------------------+   |
|   |      CONFIRM SHORT PICK          |   |  <- Amber button
|   +----------------------------------+   |
|                                          |
|   [Cancel]                               |
|                                          |
+------------------------------------------+
```

### Screen 5: Pick List Complete

```
+------------------------------------------+
|                                          |
|                                          |
|           +----------------+             |
|           |      [v]       |             |  <- Animated checkmark
|           +----------------+             |
|                                          |
|       PICK LIST COMPLETE!                |  <- 32px bold text
|                                          |
|       PL-2025-00042                      |
|                                          |
|       12 lines picked                    |
|       0 short picks                      |
|                                          |
|       Total: 284 units                   |
|                                          |
+------------------------------------------+
|                                          |
|   +----------------------------------+   |
|   |      RETURN TO MY PICKS          |   |
|   +----------------------------------+   |
|                                          |
+------------------------------------------+
```

---

## Implementation Notes

### API Endpoints

```typescript
// Scanner-optimized pick confirmation
POST /api/shipping/scanner/pick
Body: {
  pick_line_id: string;
  scanned_lp_barcode: string;
  quantity_picked: number;
  short_pick: boolean;
  short_pick_reason?: string;
  short_pick_notes?: string;
}
Response: {
  success: boolean;
  pick_line_status: 'picked' | 'short';
  next_line?: PickLinePreview;
  progress: { total_lines: number; picked_lines: number; short_lines: number };
  pick_list_complete: boolean;
}

// LP quick lookup
GET /api/shipping/scanner/lookup/lp/:barcode
Response: {
  lp_number: string;
  product_id: string;
  product_name: string;
  product_sku: string;
  lot_number: string;
  best_before_date?: string;
  on_hand_quantity: number;
  location_id: string;
  location_path: string;
  allergens: string[];
  qa_status: string;
}

// Suggest next pick for a line (if different LP acceptable)
GET /api/shipping/scanner/suggest-pick/:lineId
Response: {
  suggested_lp: string;
  alternate_lps: LPPreview[];  // Other valid LPs for this product
  fifo_warning: boolean;
}
```

### Database Updates

This story uses existing tables from Story 07.8 (`pick_lists`, `pick_list_lines`) with additional columns:

```sql
-- Add short pick fields to pick_list_lines (if not exists from 07.9)
ALTER TABLE pick_list_lines ADD COLUMN IF NOT EXISTS short_pick_reason TEXT;
ALTER TABLE pick_list_lines ADD COLUMN IF NOT EXISTS short_pick_notes TEXT;

-- Index for scanner queries
CREATE INDEX IF NOT EXISTS idx_pick_list_lines_pending
  ON pick_list_lines(pick_list_id, status)
  WHERE status = 'pending';
```

### Frontend Components

```
apps/frontend/app/(authenticated)/scanner/shipping/
  pick/
    page.tsx                    -- Main scanner pick page
    components/
      MyPicksList.tsx           -- List of assigned pick lists
      PickLineCard.tsx          -- Current pick line display
      LocationCard.tsx          -- Location display (zone, path)
      ProductCard.tsx           -- Product info display
      QuantityCard.tsx          -- Quantity display
      ScanInput.tsx             -- Barcode scan input (auto-focus)
      NumberPad.tsx             -- Quantity number pad
      ShortPickModal.tsx        -- Short pick dialog
      AllergenBanner.tsx        -- Allergen warning banner
      FifoWarning.tsx           -- FIFO/FEFO warning display
      ProgressBar.tsx           -- Line progress indicator
      PickComplete.tsx          -- Completion celebration screen
      ScannerSettings.tsx       -- Settings modal
    hooks/
      useAudioFeedback.ts       -- Web Audio API integration
      useVibration.ts           -- Vibration API integration
      useScanInput.ts           -- Barcode input handling
      usePickProgress.ts        -- Pick list progress tracking
    utils/
      audioTones.ts             -- Audio tone definitions
      vibrationPatterns.ts      -- Vibration pattern definitions
```

### Services

```typescript
// lib/services/scanner-pick-service.ts
import { supabase } from '@/lib/supabase/client';
import { getOrgId } from '@/lib/auth/context';

export class ScannerPickService {
  /**
   * Confirm a pick via scanner
   * Optimized for mobile: single request, includes next line preview
   */
  static async confirmPick(params: {
    pick_line_id: string;
    scanned_lp_barcode: string;
    quantity_picked: number;
    short_pick: boolean;
    short_pick_reason?: string;
    short_pick_notes?: string;
  }): Promise<ScannerPickResponse> {
    // 1. Validate LP matches expected (or acceptable alternate)
    // 2. Update pick_list_line (quantity_picked, status, picked_at, picked_by)
    // 3. If short_pick, store reason and trigger backorder
    // 4. Check if pick list complete
    // 5. Return next line preview for auto-advance
  }

  /**
   * Lookup LP by barcode (fast query for scanner)
   */
  static async lookupLP(barcode: string): Promise<LPLookupResult | null> {
    // Fast query: LP + product + location join
    // Return null if not found
    // Filter by org_id (RLS)
  }

  /**
   * Get suggested LP for a pick line
   * Considers FIFO/FEFO and returns alternates
   */
  static async suggestPick(lineId: string): Promise<PickSuggestion> {
    // Return suggested LP (from allocation)
    // List alternate LPs for same product
    // Flag if suggested LP is oldest (FIFO compliant)
  }

  /**
   * Start pick list (update status to in_progress)
   */
  static async startPickList(pickListId: string): Promise<void> {
    // Update status = 'in_progress'
    // Update started_at = now()
  }

  /**
   * Get pick list for scanner (optimized response)
   */
  static async getPickListForScanner(pickListId: string): Promise<ScannerPickList> {
    // Return pick list with lines
    // Pre-calculate progress
    // Include product allergens
    // Sort lines by pick_sequence
  }
}
```

### Audio Feedback Hook

```typescript
// hooks/useAudioFeedback.ts
import { useCallback, useEffect, useRef } from 'react';

const TONES = {
  SUCCESS: { frequency: 880, duration: 150 },
  ERROR: { frequency: 220, duration: 300 },
  COMPLETE: { frequency: [440, 880], duration: 200, type: 'sweep' },
  START: { frequency: 440, duration: 100 },
  LINE_COMPLETE: { frequency: 880, duration: 100, repeat: 2 },
  SHORT_PICK: { frequency: [440, 554], duration: 200, type: 'chord' },
  VICTORY: { frequency: [440, 880], duration: 500, type: 'sweep' },
};

export function useAudioFeedback() {
  const audioContext = useRef<AudioContext | null>(null);
  const volume = useRef(0.7);

  useEffect(() => {
    audioContext.current = new (window.AudioContext || window.webkitAudioContext)();
    return () => audioContext.current?.close();
  }, []);

  const playTone = useCallback((tone: keyof typeof TONES) => {
    const ctx = audioContext.current;
    if (!ctx) return;

    const config = TONES[tone];
    const oscillator = ctx.createOscillator();
    const gainNode = ctx.createGain();

    oscillator.connect(gainNode);
    gainNode.connect(ctx.destination);
    gainNode.gain.value = volume.current;

    if (Array.isArray(config.frequency)) {
      // Sweep or chord
      // Implementation details...
    } else {
      oscillator.frequency.value = config.frequency;
    }

    oscillator.start();
    oscillator.stop(ctx.currentTime + config.duration / 1000);
  }, []);

  return { playTone, setVolume: (v: number) => { volume.current = v; } };
}
```

### Vibration Hook

```typescript
// hooks/useVibration.ts
import { useCallback } from 'react';

const PATTERNS = {
  SUCCESS: [100],
  ERROR: [200, 100, 200],
  COMPLETE: [100, 50, 100],
};

export function useVibration() {
  const enabled = useRef(true);

  const vibrate = useCallback((pattern: keyof typeof PATTERNS) => {
    if (!enabled.current || !navigator.vibrate) return;
    navigator.vibrate(PATTERNS[pattern]);
  }, []);

  return { vibrate, setEnabled: (e: boolean) => { enabled.current = e; } };
}
```

### Validation (Zod)

```typescript
// lib/validation/scanner-pick-schema.ts
import { z } from 'zod';

export const scannerPickSchema = z.object({
  pick_line_id: z.string().uuid(),
  scanned_lp_barcode: z.string().min(1),
  quantity_picked: z.number().positive(),
  short_pick: z.boolean(),
  short_pick_reason: z.string().optional(),
  short_pick_notes: z.string().optional(),
}).refine(
  (data) => !data.short_pick || data.short_pick_reason,
  { message: 'Short pick reason required when short_pick is true' }
);

export const lpLookupSchema = z.object({
  barcode: z.string().min(1),
});

export type ScannerPickInput = z.infer<typeof scannerPickSchema>;
export type LPLookupInput = z.infer<typeof lpLookupSchema>;
```

### Key Business Rules

1. **LP Validation**: Scanned LP must match expected LP or be acceptable alternate (same product, available qty)
2. **FIFO/FEFO Warning**: Warn if picker scans newer lot than suggested (but allow override)
3. **Short Pick**: Any quantity < quantity_to_pick triggers short pick flow with reason required
4. **Auto-Advance**: After successful pick, auto-advance to next pending line by pick_sequence
5. **Pick Complete**: When all lines are picked or short, mark pick list as completed
6. **Allergen Alert**: Display allergen banner for products with customer allergen conflicts (from Story 07.6)
7. **RLS Enforcement**: All queries filtered by org_id from auth context
8. **Performance**: Scan feedback < 100ms, API response < 200ms

---

## Food Safety Rules

### Allergen Separation

- Display allergen warning banner when product contains allergens that conflict with customer restrictions
- Banner is red, prominent, and persistent (cannot dismiss)
- Picker must acknowledge allergen awareness before confirming pick
- Log allergen acknowledgment in audit trail

### FIFO/FEFO Enforcement

- System suggests oldest lot (FIFO) or soonest expiry (FEFO) via pick line's license_plate_id
- If picker scans different LP with newer lot, display warning
- Allow override but log the decision
- Do not allow picking from LP with qa_status != 'passed'

---

## Accessibility Requirements (WCAG 2.1 AA)

### Touch Targets
- All interactive elements: 48x48px minimum
- Primary buttons: 56px height
- Number pad buttons: 64x64px
- List rows: 64px minimum height
- Spacing between targets: 8px minimum

### Color Contrast
- Text on background: 4.5:1 minimum ratio
- Large text (24px+): 3:1 minimum ratio
- UI components: 3:1 against adjacent colors
- Status colors meet contrast requirements:
  - Success green (#22C55E) on white: 4.5:1
  - Error red (#EF4444) on white: 4.5:1
  - Warning amber (#F59E0B) on white: 3:1

### Focus Management
- Visible focus indicators on all interactive elements
- Auto-focus on scan input after each action
- Logical tab order through UI elements
- Focus trap in modals

### Screen Reader Support
- Semantic HTML structure
- ARIA labels on all interactive elements
- Live regions for status updates (aria-live)
- Announce scan results

---

## Performance Requirements

| Metric | Target | Measurement |
|--------|--------|-------------|
| Scan feedback (visual/audio) | < 100ms | Time from scan to feedback |
| API response time | < 200ms | p95 latency |
| Page initial load | < 2s | First contentful paint |
| Time to interactive | < 3s | After page load |
| Memory usage | < 100MB | Browser memory |

---

## Deliverables

### API Routes
- `apps/frontend/app/api/shipping/scanner/pick/route.ts` (POST)
- `apps/frontend/app/api/shipping/scanner/lookup/lp/[barcode]/route.ts` (GET)
- `apps/frontend/app/api/shipping/scanner/suggest-pick/[lineId]/route.ts` (GET)

### Services
- `lib/services/scanner-pick-service.ts`

### Validation
- `lib/validation/scanner-pick-schema.ts`

### Frontend Pages
- `apps/frontend/app/(authenticated)/scanner/shipping/pick/page.tsx`

### Components
- `MyPicksList.tsx` - Pick list selection
- `PickLineCard.tsx` - Current pick line display
- `LocationCard.tsx` - Location display
- `ProductCard.tsx` - Product info
- `QuantityCard.tsx` - Quantity display
- `ScanInput.tsx` - Barcode input
- `NumberPad.tsx` - Quantity entry
- `ShortPickModal.tsx` - Short pick dialog
- `AllergenBanner.tsx` - Allergen warning
- `FifoWarning.tsx` - FIFO/FEFO warning
- `ProgressBar.tsx` - Progress indicator
- `PickComplete.tsx` - Completion screen
- `ScannerSettings.tsx` - Settings modal

### Hooks
- `useAudioFeedback.ts` - Web Audio API
- `useVibration.ts` - Vibration API
- `useScanInput.ts` - Barcode handling
- `usePickProgress.ts` - Progress tracking

### Tests
- `lib/services/__tests__/scanner-pick-service.test.ts` (unit tests)
- `tests/e2e/shipping/scanner-pick.spec.ts` (E2E tests)

---

## Definition of Done

- [ ] Scanner page renders at `/scanner/shipping/pick`
- [ ] "My Picks" list displays assigned pick lists (sorted by priority)
- [ ] Start pick list updates status to 'in_progress'
- [ ] Current pick line displays location, product, quantity, LP
- [ ] Scan input auto-focuses after each action
- [ ] Valid LP scan triggers success feedback (green flash, beep, vibration)
- [ ] Invalid LP scan triggers error feedback (red flash, error beep, vibration)
- [ ] LP lookup API returns in < 100ms
- [ ] Number pad allows quantity adjustment (default = quantity_to_pick)
- [ ] Confirm pick updates pick_list_lines and advances to next line
- [ ] Short pick flow captures reason and creates backorder
- [ ] Allergen warning banner displays for products with allergens
- [ ] FIFO/FEFO warning displays when scanning newer lot
- [ ] Pick list completion shows celebration screen
- [ ] Scanner pick API returns in < 200ms
- [ ] All touch targets are 48x48px minimum
- [ ] High contrast mode available
- [ ] Audio feedback configurable (volume, mute)
- [ ] Vibration feedback works on mobile devices
- [ ] RLS policies enforce org isolation
- [ ] Unit tests pass (>80% coverage for ScannerPickService)
- [ ] E2E test: Full pick workflow (start -> pick all lines -> complete)
- [ ] E2E test: Short pick flow (skip line -> capture reason)
- [ ] E2E test: Invalid LP scan (error feedback)
- [ ] E2E test: FIFO warning and override
- [ ] Works on Zebra TC52, Honeywell CT40, and mobile phones
- [ ] Tested in bright warehouse lighting conditions

---

## Future Phases (Not in This Story)

### Phase 2
- **Offline Mode**: Queue operations locally, sync when connection restored (max 100 operations)
- **Route Optimization Display**: Show visual map of pick route
- **Multi-User Collision Detection**: Warn if another picker is working same location
- **Batch Picking**: Pick-to-box workflow for wave picks

### Phase 3
- **Voice Picking**: Integration with voice picking systems
- **Wearable Support**: Ring scanner, smart glasses integration
- **Pick Performance Analytics**: Real-time picker performance metrics
- **Predictive Pick Time**: Estimate completion time based on historical data

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-12-16 | Initial story creation | ARCHITECT-AGENT |
