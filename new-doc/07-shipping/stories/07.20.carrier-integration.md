# 07.20 - Carrier Integration

**Story ID:** 07.20
**Epic:** 07 - Shipping
**Phase:** 2-3
**Complexity:** XL (Extra Large)
**Estimate:** 10-14 days
**Type:** Backend + Frontend
**State:** ready

**Primary PRD:** `docs/1-BASELINE/product/modules/shipping.md` (FR-7.45 to FR-7.51)
**Architecture:** Carrier API adapter pattern with multi-carrier support

## PRD References

| FR ID | Requirement | Priority | Phase | Covered |
|-------|-------------|----------|-------|---------|
| FR-7.45 | Carrier Configuration (DHL/UPS/DPD) | P1 | 2 | Yes |
| FR-7.46 | Rate Shopping | P2 | 3 | Yes |
| FR-7.47 | Shipment Booking API | P1 | 2 | Yes |
| FR-7.48 | Tracking Number Import | P1 | 2 | Yes |
| FR-7.49 | Shipment Tracking (Webhook) | P2 | 3 | Yes |
| FR-7.50 | Carrier Label Print (API) | P1 | 2 | Yes |
| FR-7.51 | Proof of Delivery Capture | P2 | 3 | Yes |

## User Story

**As a** shipping administrator,
**I want** to configure multiple carrier accounts (DHL, UPS, DPD) and integrate their APIs,
**So that** I can automate rate shopping, shipment booking, label generation, and tracking.

**As a** warehouse operator,
**I want** to book shipments directly with carriers and print shipping labels via API,
**So that** I can reduce manual data entry and eliminate carrier portal switching.

**As a** customer service representative,
**I want** to receive automatic tracking updates and proof of delivery,
**So that** I can proactively inform customers about shipment status.

## Goal

Implement comprehensive multi-carrier integration enabling automated rate shopping across DHL, UPS, and DPD, one-click shipment booking with automatic tracking number import, API-driven label generation, real-time tracking via webhooks, and proof of delivery capture. This eliminates manual carrier portal interactions and provides unified shipping management.

## Scope

**In scope:**
- Carrier configuration management (DHL, UPS, DPD accounts)
- API credentials storage (encrypted)
- Rate shopping across multiple carriers
- Shipment booking API integration
- Automatic tracking number import
- Carrier label generation via API
- Tracking webhook receiver
- Real-time status updates
- POD capture (signature, photo URL)
- Carrier adapter pattern (extensible)

**Out of scope:**
- FedEx integration (future carrier)
- Customs documentation (international shipping)
- Freight/LTL carrier APIs
- Multi-warehouse routing
- Carrier performance analytics (Story 07.71)

## Dependencies

| Story | Requirement | Status |
|-------|-------------|--------|
| 07.14 | Shipment Manifest + Ship | Required - provides shipment workflow |
| 07.13 | SSCC + Labels + BOL | Required - provides label infrastructure |
| 07.11 | Packing + Shipment Creation | Required - provides shipments table |
| 01.1 | Org Context + Base RLS | Required - provides auth context |

## Acceptance Criteria (Given/When/Then)

### Carrier Configuration (FR-7.45)

#### Create Carrier Configuration
- GIVEN admin navigates to Settings > Carriers, WHEN form submitted with valid DHL credentials, THEN carrier config saved with encrypted API key.
- GIVEN admin creates carrier config, WHEN account_number and api_key provided, THEN connection test validates credentials with carrier API.
- GIVEN multiple carriers configured, WHEN carrier list displayed, THEN shows all active carriers with connection status.
- GIVEN carrier with invalid credentials, WHEN connection test fails, THEN displays specific error message from carrier API.

#### Update Carrier Configuration
- GIVEN existing carrier config, WHEN admin updates API key, THEN old key replaced with new encrypted value.
- GIVEN carrier config update, WHEN is_active toggled to false, THEN carrier excluded from rate shopping.
- GIVEN carrier config, WHEN service_levels configured (Express, Ground), THEN only configured services returned in rate quotes.

#### Delete Carrier Configuration
- GIVEN carrier config with pending shipments, WHEN admin attempts delete, THEN error "Cannot delete: X pending shipments use this carrier".
- GIVEN carrier config with no dependencies, WHEN admin deletes, THEN soft-delete (is_active=false) or hard delete with confirmation.

### Rate Shopping (FR-7.46)

#### Get Rate Quotes
- GIVEN shipment ready to manifest, WHEN user clicks "Get Rates", THEN system queries all active carriers in parallel.
- GIVEN rate request with weight 5kg, dimensions 30x20x15cm, WHEN rates returned, THEN displays carrier, service, price, estimated delivery.
- GIVEN rate response, WHEN displayed, THEN sorted by price (cheapest first) with delivery time as secondary sort.
- GIVEN one carrier API timeout, WHEN rates displayed, THEN shows available rates with warning "DHL unavailable".

#### Rate Shopping Cache
- GIVEN rate quotes fetched, WHEN same shipment rated again within 15 minutes, THEN cached rates returned (no API calls).
- GIVEN cached rates older than 15 minutes, WHEN rates requested, THEN fresh quotes fetched from carrier APIs.

#### Select Rate
- GIVEN rate quotes displayed, WHEN user selects UPS Ground, THEN carrier and service_level saved to shipment.
- GIVEN rate selected, WHEN shipment updated, THEN displays "Selected: UPS Ground - $12.50 - Est. Dec 20".

### Shipment Booking API (FR-7.47)

#### Book Shipment
- GIVEN manifested shipment with selected carrier, WHEN user clicks "Book Shipment", THEN carrier API called with shipment details.
- GIVEN successful booking, WHEN carrier responds, THEN tracking_number saved to shipment immediately.
- GIVEN successful booking, WHEN complete, THEN shipment status updated to 'booked' (intermediate status before ship).
- GIVEN booking failure (invalid address), WHEN carrier returns error, THEN displays specific error and suggests corrections.

#### Booking Validation
- GIVEN shipment without carrier selected, WHEN book attempted, THEN error "Select carrier before booking".
- GIVEN shipment with invalid dimensions, WHEN carrier rejects, THEN displays "Weight exceeds 30kg limit for UPS Ground".
- GIVEN already-booked shipment, WHEN book attempted again, THEN error "Shipment already booked with tracking #123456789".

#### Booking Data Mapping
- GIVEN shipment with customer address, WHEN booking submitted, THEN address mapped to carrier format (DHL vs UPS format differences).
- GIVEN shipment with special instructions, WHEN booking submitted, THEN instructions included in carrier shipment notes.

### Tracking Number Import (FR-7.48)

#### Automatic Import (Post-Booking)
- GIVEN successful carrier booking, WHEN tracking number returned, THEN shipment.tracking_number updated automatically.
- GIVEN booking with multiple packages, WHEN carrier returns multiple tracking numbers, THEN saved to shipment_boxes.tracking_number.

#### Manual Import
- GIVEN shipment booked externally (carrier portal), WHEN user enters tracking number manually, THEN tracking number saved and validated.
- GIVEN manual tracking number entry, WHEN tracking number format invalid for carrier, THEN warning "Tracking format may be incorrect for DHL".
- GIVEN bulk import CSV, WHEN CSV uploaded with shipment_number and tracking_number, THEN updates multiple shipments.

### Shipment Tracking Webhook (FR-7.49)

#### Webhook Receiver Setup
- GIVEN carrier webhook configured, WHEN carrier sends tracking update, THEN endpoint receives and validates signature.
- GIVEN valid webhook payload, WHEN status is "in_transit", THEN tracking_status field updated on shipment.
- GIVEN webhook with delivery event, WHEN status is "delivered", THEN shipment.status updated to 'delivered' and delivered_at set.

#### Webhook Security
- GIVEN webhook request without valid signature, WHEN received, THEN 401 Unauthorized returned and event logged.
- GIVEN webhook from unknown IP (if IP whitelist enabled), WHEN received, THEN 403 Forbidden returned.
- GIVEN duplicate webhook (replay attack), WHEN received, THEN ignored with 200 OK (idempotent).

#### Tracking Status Mapping
- GIVEN DHL status "transit", WHEN mapped, THEN internal status = "in_transit".
- GIVEN UPS status "D" (Delivered), WHEN mapped, THEN internal status = "delivered", shipment.delivered_at set.
- GIVEN carrier exception status, WHEN mapped, THEN internal status = "exception", alert created for review.

### Carrier Label Print (FR-7.50)

#### Generate Label via API
- GIVEN booked shipment, WHEN user clicks "Print Label", THEN carrier API called for label generation.
- GIVEN label response (PDF or ZPL), WHEN received, THEN label rendered or sent to printer.
- GIVEN multi-box shipment, WHEN labels generated, THEN one label per box with correct tracking number.

#### Label Formats
- GIVEN Zebra printer configured, WHEN label requested, THEN ZPL format returned for direct print.
- GIVEN PDF printer configured, WHEN label requested, THEN PDF format returned for browser print.
- GIVEN label format preference in carrier config, WHEN labels generated, THEN requested format returned.

#### Label Storage
- GIVEN generated label, WHEN stored, THEN saved to shipment_labels table with type, format, and URL.
- GIVEN label regeneration requested, WHEN generated again, THEN new label stored, old label marked replaced.

### Proof of Delivery Capture (FR-7.51)

#### POD via Webhook
- GIVEN webhook with POD data (signature image URL), WHEN received, THEN signature_url saved to shipment.
- GIVEN webhook with POD (signed by name), WHEN received, THEN signed_by_name saved to shipment.
- GIVEN webhook with POD timestamp, WHEN received, THEN actual_delivery_time updated.

#### POD Display
- GIVEN shipment with POD data, WHEN user views shipment detail, THEN displays POD section with signature image.
- GIVEN POD with photo URL, WHEN displayed, THEN shows delivery photo (package at door).
- GIVEN POD data, WHEN exported, THEN includes in shipment export/report.

#### Manual POD Entry
- GIVEN shipment without automatic POD, WHEN user manually marks delivered, THEN can enter signed_by_name.
- GIVEN manual POD entry, WHEN photo uploaded, THEN stored and linked to shipment.

### Multi-tenancy
- GIVEN Org A carrier config, WHEN Org B requests rates, THEN only Org B configs used.
- GIVEN webhook for Org A shipment, WHEN processing, THEN only Org A shipment updated.
- GIVEN carrier_configs table, WHEN queried, THEN RLS filters by org_id.

## Technical Specification

### Database Schema

#### carrier_configs table

```sql
CREATE TABLE carrier_configs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,

  -- Carrier identification
  carrier TEXT NOT NULL CHECK (carrier IN ('dhl', 'ups', 'dpd', 'fedex')),
  carrier_name TEXT NOT NULL, -- Display name: "DHL Express"

  -- API credentials (encrypted)
  api_endpoint TEXT NOT NULL,
  api_key TEXT NOT NULL, -- Encrypted via Supabase Vault
  api_secret TEXT, -- Optional, encrypted
  account_number TEXT NOT NULL,

  -- Configuration
  is_active BOOLEAN DEFAULT true,
  is_default BOOLEAN DEFAULT false,
  service_levels JSONB DEFAULT '[]', -- ["EXPRESS", "GROUND", "ECONOMY"]
  config_json JSONB DEFAULT '{}', -- Carrier-specific settings

  -- Connection status
  last_connection_test TIMESTAMPTZ,
  connection_status TEXT DEFAULT 'untested', -- 'ok', 'failed', 'untested'
  connection_error TEXT,

  -- Audit
  created_at TIMESTAMPTZ DEFAULT NOW(),
  created_by UUID REFERENCES users(id),
  updated_at TIMESTAMPTZ DEFAULT NOW(),

  -- Constraints
  UNIQUE (org_id, carrier, account_number)
);

-- Indexes
CREATE INDEX idx_carrier_configs_org ON carrier_configs(org_id);
CREATE INDEX idx_carrier_configs_active ON carrier_configs(org_id, is_active) WHERE is_active = true;
```

#### carrier_rate_quotes table (cache)

```sql
CREATE TABLE carrier_rate_quotes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  shipment_id UUID NOT NULL REFERENCES shipments(id) ON DELETE CASCADE,

  -- Quote details
  carrier TEXT NOT NULL,
  service_level TEXT NOT NULL,
  price DECIMAL(10,2) NOT NULL,
  currency TEXT DEFAULT 'USD',
  estimated_delivery TIMESTAMPTZ,

  -- Request hash (for cache lookup)
  request_hash TEXT NOT NULL, -- Hash of weight, dimensions, addresses

  -- Timestamps
  quoted_at TIMESTAMPTZ DEFAULT NOW(),
  expires_at TIMESTAMPTZ NOT NULL, -- quoted_at + 15 minutes

  -- Selected
  is_selected BOOLEAN DEFAULT false,
  selected_at TIMESTAMPTZ,

  UNIQUE (shipment_id, carrier, service_level)
);

-- Cleanup expired quotes
CREATE INDEX idx_rate_quotes_expires ON carrier_rate_quotes(expires_at);
```

#### carrier_webhooks table (audit log)

```sql
CREATE TABLE carrier_webhooks (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id),

  -- Webhook details
  carrier TEXT NOT NULL,
  event_type TEXT NOT NULL, -- 'tracking_update', 'delivery', 'exception'
  tracking_number TEXT,
  shipment_id UUID REFERENCES shipments(id),

  -- Payload
  raw_payload JSONB NOT NULL,
  processed BOOLEAN DEFAULT false,
  process_error TEXT,

  -- Timestamps
  received_at TIMESTAMPTZ DEFAULT NOW(),
  processed_at TIMESTAMPTZ
);

-- Index for processing
CREATE INDEX idx_webhooks_unprocessed ON carrier_webhooks(processed) WHERE processed = false;
CREATE INDEX idx_webhooks_tracking ON carrier_webhooks(tracking_number);
```

#### shipment_labels table

```sql
CREATE TABLE shipment_labels (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  shipment_id UUID NOT NULL REFERENCES shipments(id) ON DELETE CASCADE,
  shipment_box_id UUID REFERENCES shipment_boxes(id),

  -- Label details
  carrier TEXT NOT NULL,
  tracking_number TEXT,
  label_format TEXT NOT NULL CHECK (label_format IN ('pdf', 'zpl', 'png')),
  label_type TEXT DEFAULT 'shipping', -- 'shipping', 'return'

  -- Storage
  label_url TEXT, -- S3/Supabase Storage URL
  label_data TEXT, -- Base64 encoded or ZPL string (small labels)

  -- Timestamps
  generated_at TIMESTAMPTZ DEFAULT NOW(),
  expires_at TIMESTAMPTZ, -- Some carriers expire label URLs
  is_current BOOLEAN DEFAULT true, -- False if regenerated

  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Index
CREATE INDEX idx_labels_shipment ON shipment_labels(shipment_id);
```

#### shipments table extension

```sql
-- Add carrier integration fields to existing shipments table
ALTER TABLE shipments ADD COLUMN IF NOT EXISTS
  carrier_config_id UUID REFERENCES carrier_configs(id);

ALTER TABLE shipments ADD COLUMN IF NOT EXISTS
  carrier_booking_id TEXT; -- Carrier's internal booking reference

ALTER TABLE shipments ADD COLUMN IF NOT EXISTS
  carrier_service_level TEXT;

ALTER TABLE shipments ADD COLUMN IF NOT EXISTS
  carrier_booked_at TIMESTAMPTZ;

ALTER TABLE shipments ADD COLUMN IF NOT EXISTS
  tracking_status TEXT; -- 'pending', 'in_transit', 'out_for_delivery', 'delivered', 'exception'

ALTER TABLE shipments ADD COLUMN IF NOT EXISTS
  tracking_last_update TIMESTAMPTZ;

ALTER TABLE shipments ADD COLUMN IF NOT EXISTS
  tracking_events JSONB DEFAULT '[]'; -- Array of tracking events

-- POD fields
ALTER TABLE shipments ADD COLUMN IF NOT EXISTS
  pod_signature_url TEXT;

ALTER TABLE shipments ADD COLUMN IF NOT EXISTS
  pod_signed_by TEXT;

ALTER TABLE shipments ADD COLUMN IF NOT EXISTS
  pod_photo_url TEXT;

ALTER TABLE shipments ADD COLUMN IF NOT EXISTS
  pod_received_at TIMESTAMPTZ;
```

### RLS Policies

```sql
-- carrier_configs: Admin only for write, all authenticated for read
CREATE POLICY "carrier_configs_read" ON carrier_configs
FOR SELECT USING (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
);

CREATE POLICY "carrier_configs_write" ON carrier_configs
FOR ALL USING (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  AND (SELECT r.code FROM roles r JOIN users u ON u.role_id = r.id WHERE u.id = auth.uid()) IN ('SUPER_ADMIN', 'ADMIN')
);

-- carrier_rate_quotes: Standard org isolation
CREATE POLICY "rate_quotes_org" ON carrier_rate_quotes
FOR ALL USING (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
);

-- carrier_webhooks: Read for all, write for service role only
CREATE POLICY "webhooks_read" ON carrier_webhooks
FOR SELECT USING (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
);

-- shipment_labels: Standard org isolation
CREATE POLICY "labels_org" ON shipment_labels
FOR ALL USING (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
);
```

### API Endpoints

```
# Carrier Configuration
GET    /api/shipping/carriers                      - List carrier configs
GET    /api/shipping/carriers/:id                  - Get carrier config (masked API key)
POST   /api/shipping/carriers                      - Create carrier config (Admin)
PUT    /api/shipping/carriers/:id                  - Update carrier config (Admin)
DELETE /api/shipping/carriers/:id                  - Delete carrier config (Admin)
POST   /api/shipping/carriers/:id/test-connection  - Test API connection

# Rate Shopping
POST   /api/shipping/shipments/:id/rates           - Get rate quotes from all carriers
GET    /api/shipping/shipments/:id/rates           - Get cached rate quotes
POST   /api/shipping/shipments/:id/rates/select    - Select rate for shipment

# Shipment Booking
POST   /api/shipping/shipments/:id/book            - Book shipment with carrier
POST   /api/shipping/shipments/:id/cancel-booking  - Cancel carrier booking

# Labels
POST   /api/shipping/shipments/:id/labels          - Generate labels from carrier
GET    /api/shipping/shipments/:id/labels          - Get generated labels
GET    /api/shipping/shipments/:id/labels/:labelId - Get specific label

# Tracking
GET    /api/shipping/shipments/:id/tracking        - Get tracking info (poll carrier)
POST   /api/shipping/webhooks/:carrier             - Receive carrier webhook
GET    /api/shipping/shipments/:id/tracking-events - Get tracking event history

# POD
GET    /api/shipping/shipments/:id/pod             - Get POD data
POST   /api/shipping/shipments/:id/pod             - Manual POD entry
```

### Service Methods

**Location:** `lib/services/carrier-service.ts`

```typescript
interface CarrierService {
  // Configuration
  getCarrierConfigs(orgId: string): Promise<CarrierConfig[]>;
  createCarrierConfig(data: CreateCarrierConfigDTO): Promise<CarrierConfig>;
  updateCarrierConfig(id: string, data: UpdateCarrierConfigDTO): Promise<CarrierConfig>;
  deleteCarrierConfig(id: string): Promise<void>;
  testConnection(configId: string): Promise<ConnectionTestResult>;

  // Rate Shopping
  getRates(shipmentId: string): Promise<RateQuote[]>;
  getCachedRates(shipmentId: string): Promise<RateQuote[] | null>;
  selectRate(shipmentId: string, quoteId: string): Promise<Shipment>;

  // Booking
  bookShipment(shipmentId: string): Promise<BookingResult>;
  cancelBooking(shipmentId: string): Promise<void>;

  // Labels
  generateLabels(shipmentId: string, format?: LabelFormat): Promise<ShipmentLabel[]>;
  getLabels(shipmentId: string): Promise<ShipmentLabel[]>;

  // Tracking
  getTrackingStatus(shipmentId: string): Promise<TrackingInfo>;
  processWebhook(carrier: string, payload: unknown): Promise<void>;

  // POD
  getPOD(shipmentId: string): Promise<PODData | null>;
  savePOD(shipmentId: string, data: PODInput): Promise<PODData>;
}

interface CarrierAdapter {
  carrier: string;

  // Connection
  testConnection(config: CarrierConfig): Promise<boolean>;

  // Rates
  getRates(request: RateRequest): Promise<RateResponse[]>;

  // Booking
  createShipment(request: BookingRequest): Promise<BookingResponse>;
  cancelShipment(bookingId: string): Promise<void>;

  // Labels
  getLabel(trackingNumber: string, format: LabelFormat): Promise<LabelResponse>;

  // Tracking
  getTracking(trackingNumber: string): Promise<TrackingResponse>;
  parseWebhook(payload: unknown): Promise<WebhookEvent>;
}
```

**Location:** `lib/services/carrier-adapters/`

```
carrier-adapters/
  index.ts              # Factory function
  types.ts              # Shared types
  dhl-adapter.ts        # DHL Express API
  ups-adapter.ts        # UPS API
  dpd-adapter.ts        # DPD API
```

### Zod Validation Schemas

**Location:** `lib/validation/carrier-schema.ts`

```typescript
import { z } from 'zod';

// Carrier config
export const carrierConfigSchema = z.object({
  carrier: z.enum(['dhl', 'ups', 'dpd', 'fedex']),
  carrier_name: z.string().min(1).max(100),
  api_endpoint: z.string().url(),
  api_key: z.string().min(10),
  api_secret: z.string().optional(),
  account_number: z.string().min(1),
  is_active: z.boolean().default(true),
  is_default: z.boolean().default(false),
  service_levels: z.array(z.string()).default([]),
  config_json: z.record(z.unknown()).default({})
});

export const createCarrierConfigSchema = carrierConfigSchema;

export const updateCarrierConfigSchema = carrierConfigSchema.partial().omit({
  carrier: true // Cannot change carrier type
});

// Rate request
export const rateRequestSchema = z.object({
  shipment_id: z.string().uuid(),
  include_inactive: z.boolean().default(false)
});

// Rate selection
export const selectRateSchema = z.object({
  quote_id: z.string().uuid()
});

// Booking
export const bookShipmentSchema = z.object({
  shipment_id: z.string().uuid(),
  label_format: z.enum(['pdf', 'zpl', 'png']).default('pdf')
});

// Label request
export const labelRequestSchema = z.object({
  shipment_id: z.string().uuid(),
  format: z.enum(['pdf', 'zpl', 'png']).default('pdf'),
  box_ids: z.array(z.string().uuid()).optional() // Specific boxes, or all
});

// Webhook payload (generic, carrier-specific validation in adapter)
export const webhookPayloadSchema = z.object({
  carrier: z.enum(['dhl', 'ups', 'dpd']),
  event_type: z.string(),
  tracking_number: z.string().optional(),
  timestamp: z.string().datetime().optional(),
  data: z.record(z.unknown())
});

// POD input
export const podInputSchema = z.object({
  signed_by: z.string().max(100).optional(),
  signature_url: z.string().url().optional(),
  photo_url: z.string().url().optional(),
  notes: z.string().max(500).optional()
});

// Rate quote response
export const rateQuoteSchema = z.object({
  id: z.string().uuid(),
  carrier: z.string(),
  carrier_name: z.string(),
  service_level: z.string(),
  service_name: z.string(),
  price: z.number(),
  currency: z.string(),
  estimated_delivery: z.string().datetime().nullable(),
  transit_days: z.number().nullable(),
  is_selected: z.boolean()
});

export const rateQuotesResponseSchema = z.object({
  quotes: z.array(rateQuoteSchema),
  cached: z.boolean(),
  expires_at: z.string().datetime().nullable()
});
```

## UI Components

### Pages

- `app/(authenticated)/settings/carriers/page.tsx` - Carrier configuration list
- `app/(authenticated)/settings/carriers/new/page.tsx` - New carrier config form
- `app/(authenticated)/settings/carriers/[id]/page.tsx` - Edit carrier config

### Components

**Location:** `components/shipping/carriers/`

```
CarrierConfigList.tsx        - List of configured carriers
CarrierConfigCard.tsx        - Single carrier display with status
CarrierConfigForm.tsx        - Create/edit carrier form
ConnectionTestButton.tsx     - Test connection with loading state
ServiceLevelSelector.tsx     - Multi-select for service levels
```

**Location:** `components/shipping/rates/`

```
RateShoppingPanel.tsx        - Rate quotes panel for shipment
RateQuoteCard.tsx            - Single rate quote display
RateQuotesList.tsx           - List of quotes with sorting
SelectRateButton.tsx         - Select rate action button
RateLoadingState.tsx         - Loading skeleton while fetching
RateErrorState.tsx           - Error display when rate fetch fails
```

**Location:** `components/shipping/booking/`

```
BookShipmentButton.tsx       - Book shipment action
BookingConfirmDialog.tsx     - Confirm booking dialog
BookingErrorDialog.tsx       - Display booking errors
CancelBookingButton.tsx      - Cancel booking action
```

**Location:** `components/shipping/labels/`

```
GenerateLabelButton.tsx      - Generate label action
LabelPreview.tsx             - Label preview (PDF/image)
LabelDownloadButton.tsx      - Download label
PrintLabelButton.tsx         - Send to printer
LabelFormatSelector.tsx      - PDF/ZPL format toggle
```

**Location:** `components/shipping/tracking/`

```
TrackingStatusBadge.tsx      - Status badge (in_transit, delivered)
TrackingTimeline.tsx         - Timeline of tracking events
TrackingEventCard.tsx        - Single tracking event
RefreshTrackingButton.tsx    - Manual refresh tracking
TrackingWebhookStatus.tsx    - Webhook connection status
```

**Location:** `components/shipping/pod/`

```
PODDisplay.tsx               - Display POD data
PODSignature.tsx             - Signature image display
PODPhotoGallery.tsx          - Delivery photos
PODManualEntryForm.tsx       - Manual POD input
```

### Component Details

**RateShoppingPanel.tsx**
```tsx
interface RateShoppingPanelProps {
  shipmentId: string;
  onRateSelected: (quoteId: string) => void;
  selectedQuoteId?: string;
}

// Displays:
// +------------------------------------------+
// | Get Shipping Rates      [Refresh Rates]  |
// +------------------------------------------+
// | DHL Express - $15.50                     |
// | Est. Dec 18  | 2-3 days      [Select]    |
// +------------------------------------------+
// | UPS Ground - $12.00           SELECTED   |
// | Est. Dec 20  | 3-5 days                  |
// +------------------------------------------+
// | DPD Classic - $10.50                     |
// | Est. Dec 21  | 4-6 days      [Select]    |
// +------------------------------------------+
// | Rates cached | Expires in 12 min         |
// +------------------------------------------+
```

**BookingConfirmDialog.tsx**
```tsx
interface BookingConfirmDialogProps {
  shipment: Shipment;
  selectedRate: RateQuote;
  onConfirm: () => void;
  onCancel: () => void;
  isLoading: boolean;
}

// Dialog content:
// Title: "Confirm Shipment Booking"
// - Carrier: UPS Ground
// - Price: $12.00 USD
// - Estimated Delivery: Dec 20, 2025
// - Ship To: Customer ABC, 123 Main St...
// - Weight: 5.2 kg | Boxes: 2
// [Cancel] [Book Shipment]
```

## Test Cases

### Unit Tests

**carrier-service.test.ts**
```typescript
describe('CarrierService', () => {
  describe('getRates', () => {
    it('queries all active carriers in parallel');
    it('returns cached rates if not expired');
    it('handles partial carrier failures gracefully');
    it('sorts rates by price ascending');
    it('includes transit days in response');
  });

  describe('bookShipment', () => {
    it('calls carrier adapter with correct data');
    it('saves tracking number on success');
    it('updates shipment status to booked');
    it('handles booking failure with rollback');
    it('prevents double booking');
  });

  describe('generateLabels', () => {
    it('generates label for each box');
    it('stores label in shipment_labels table');
    it('supports PDF and ZPL formats');
    it('handles label generation failure');
  });

  describe('processWebhook', () => {
    it('validates webhook signature');
    it('updates shipment tracking status');
    it('handles delivery event correctly');
    it('captures POD data from webhook');
    it('rejects duplicate webhooks');
  });
});
```

**carrier-adapters.test.ts**
```typescript
describe('DHL Adapter', () => {
  describe('getRates', () => {
    it('maps request to DHL API format');
    it('parses DHL rate response correctly');
    it('handles DHL error responses');
  });

  describe('createShipment', () => {
    it('creates booking with DHL API');
    it('returns tracking number from response');
    it('handles address validation errors');
  });

  describe('getLabel', () => {
    it('fetches label in requested format');
    it('returns base64 encoded PDF');
    it('returns ZPL string for ZPL format');
  });
});

// Similar tests for UPS and DPD adapters
```

### Integration Tests

**carrier-api.test.ts**
```typescript
describe('Carrier API', () => {
  describe('POST /api/shipping/carriers', () => {
    it('creates carrier config (admin only)');
    it('rejects non-admin users');
    it('validates required fields');
    it('encrypts API key before storage');
  });

  describe('POST /api/shipping/carriers/:id/test-connection', () => {
    it('tests connection successfully');
    it('returns error for invalid credentials');
    it('updates connection_status field');
  });

  describe('POST /api/shipping/shipments/:id/rates', () => {
    it('returns rates from all active carriers');
    it('caches rates for 15 minutes');
    it('handles carrier timeout gracefully');
  });

  describe('POST /api/shipping/shipments/:id/book', () => {
    it('books shipment with selected carrier');
    it('saves tracking number to shipment');
    it('requires rate selection first');
  });

  describe('POST /api/shipping/webhooks/:carrier', () => {
    it('receives DHL webhook successfully');
    it('validates signature header');
    it('updates shipment status from webhook');
    it('captures POD data');
  });
});
```

### E2E Tests

**carrier-integration.spec.ts**
```typescript
describe('Carrier Integration', () => {
  it('configures new carrier account');
  it('tests carrier connection');
  it('gets rate quotes for shipment');
  it('selects best rate');
  it('books shipment with carrier');
  it('generates and prints labels');
  it('displays tracking timeline');
});
```

**rate-shopping.spec.ts**
```typescript
describe('Rate Shopping', () => {
  it('displays rates from multiple carriers');
  it('shows cached rates indicator');
  it('refreshes rates on demand');
  it('selects rate and updates shipment');
  it('handles carrier unavailability');
});
```

## Security Considerations

1. **API Key Encryption**
   - Store api_key and api_secret encrypted via Supabase Vault
   - Never return full API key in API responses (mask: ****XXXX)
   - Rotate encryption keys periodically

2. **Webhook Security**
   - Validate carrier signature header on all webhooks
   - Implement IP whitelist for carrier IPs (optional)
   - Rate limit webhook endpoint (100/minute)
   - Log all webhook attempts (success and failure)

3. **Rate Limiting**
   - Carrier API calls: Max 10/minute per carrier per org
   - Rate shopping: Max 5 requests/minute per shipment
   - Booking: Max 3 attempts/minute per shipment

4. **Audit Trail**
   - Log all carrier config changes
   - Log all bookings with user and timestamp
   - Log webhook events for debugging

5. **Error Handling**
   - Never expose carrier API errors to end users directly
   - Map carrier-specific errors to user-friendly messages
   - Log full error details for debugging

## Implementation Notes

### Carrier Adapter Pattern

```typescript
// lib/services/carrier-adapters/index.ts

import { DHLAdapter } from './dhl-adapter';
import { UPSAdapter } from './ups-adapter';
import { DPDAdapter } from './dpd-adapter';

export function getCarrierAdapter(carrier: string): CarrierAdapter {
  switch (carrier.toLowerCase()) {
    case 'dhl':
      return new DHLAdapter();
    case 'ups':
      return new UPSAdapter();
    case 'dpd':
      return new DPDAdapter();
    default:
      throw new Error(`Unsupported carrier: ${carrier}`);
  }
}
```

### Rate Shopping Algorithm

```typescript
async function getRates(shipmentId: string): Promise<RateQuote[]> {
  const shipment = await getShipment(shipmentId);
  const configs = await getActiveCarrierConfigs(shipment.org_id);

  // Parallel rate requests with timeout
  const ratePromises = configs.map(config =>
    Promise.race([
      getCarrierAdapter(config.carrier).getRates(buildRateRequest(shipment, config)),
      timeout(5000).then(() => ({ error: 'timeout', carrier: config.carrier }))
    ])
  );

  const results = await Promise.allSettled(ratePromises);

  // Flatten and sort by price
  const quotes = results
    .filter(r => r.status === 'fulfilled' && !r.value.error)
    .flatMap(r => r.value)
    .sort((a, b) => a.price - b.price);

  // Cache results
  await cacheRates(shipmentId, quotes);

  return quotes;
}
```

### Webhook Signature Validation

```typescript
function validateWebhookSignature(
  carrier: string,
  payload: string,
  signature: string,
  config: CarrierConfig
): boolean {
  const adapter = getCarrierAdapter(carrier);
  return adapter.validateSignature(payload, signature, config.api_secret);
}

// DHL example
class DHLAdapter {
  validateSignature(payload: string, signature: string, secret: string): boolean {
    const expected = crypto
      .createHmac('sha256', secret)
      .update(payload)
      .digest('hex');
    return crypto.timingSafeEqual(
      Buffer.from(signature),
      Buffer.from(expected)
    );
  }
}
```

## Deliverables

- [ ] `carrier_configs` table migration
- [ ] `carrier_rate_quotes` table migration
- [ ] `carrier_webhooks` table migration
- [ ] `shipment_labels` table migration
- [ ] Shipments table extension migration
- [ ] RLS policies for all new tables
- [ ] CarrierService (`lib/services/carrier-service.ts`)
- [ ] Carrier adapters (DHL, UPS, DPD)
- [ ] Zod schemas (`lib/validation/carrier-schema.ts`)
- [ ] API routes for carrier management
- [ ] API routes for rate shopping
- [ ] API routes for booking
- [ ] API routes for labels
- [ ] API routes for tracking
- [ ] Webhook endpoint with signature validation
- [ ] Carrier config UI components
- [ ] Rate shopping UI components
- [ ] Booking UI components
- [ ] Label generation UI components
- [ ] Tracking UI components
- [ ] POD display components
- [ ] Unit tests (>80% coverage)
- [ ] Integration tests
- [ ] E2E tests

## Definition of Done

- [ ] Carrier configs can be created, updated, deleted (Admin only)
- [ ] Connection test validates API credentials with carrier
- [ ] API keys stored encrypted in database
- [ ] Rate shopping queries all active carriers in parallel
- [ ] Rate quotes cached for 15 minutes
- [ ] Rate selection updates shipment with carrier and service
- [ ] Shipment booking creates booking with carrier API
- [ ] Tracking number imported automatically on booking
- [ ] Labels generated via carrier API in PDF and ZPL formats
- [ ] Labels stored in shipment_labels table
- [ ] Webhook endpoint receives and validates carrier updates
- [ ] Tracking status updated from webhook events
- [ ] POD data captured from webhook (signature, photo)
- [ ] Manual POD entry supported
- [ ] RLS policies enforce org isolation
- [ ] Unit tests pass (>80% coverage)
- [ ] Integration tests pass
- [ ] E2E tests pass (full rate-book-track flow)
- [ ] Security review completed (API key handling, webhook validation)

## Risks

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| Carrier API changes | Medium | High | Version lock adapters, monitor deprecation notices |
| Rate quote timeout | Medium | Medium | 5s timeout, return partial results |
| Webhook delivery failures | Low | Medium | Implement retry endpoint, manual sync option |
| API key exposure | Low | Critical | Encrypt at rest, mask in UI, audit access |

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-01-15 | Initial story | ARCHITECT-AGENT |
