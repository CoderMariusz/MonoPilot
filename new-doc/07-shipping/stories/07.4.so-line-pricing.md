# 07.4 - SO Line Pricing + Totals Calculation

**Priority**: P0 (MVP Core)
**Complexity**: S (1-2 days)
**Type:** backend + frontend
**Phase:** 1A

**State:** ready
**Primary PRD:** `docs/1-BASELINE/product/modules/shipping.md`
**Architecture:** `docs/1-BASELINE/architecture/modules/shipping.md` (lines 109-127)

---

## MVP Scope

**This story covers:**
- Auto-populate `unit_price` from `products.std_price` when adding SO line
- Manual override of unit_price allowed (before SO confirmation)
- Line total calculation: `line_total = quantity_ordered * unit_price`
- Discount field on SO line (JSONB: `{type: 'percent'|'fixed', value: decimal}`)
- SO total calculation: `total_amount = SUM(lines.line_total) - discounts`
- Real-time total recalculation on:
  - Line add/edit/delete
  - Quantity change
  - Unit price change
  - Discount change
- Frontend: display running total in SO form
- Decimal precision: (15,4) for qty/unit_price, (15,2) for totals

**This story does NOT cover:**
- Tax calculation (Epic 09 Finance)
- Customer-specific pricing agreements (Phase 2, FR-7.8)
- Payment terms / credit limits (Phase 2, FR-7.4, FR-7.6)
- Multi-currency pricing (Phase 3)
- Bulk pricing tiers (Phase 3)

---

## Dependencies

### Epic Dependencies
- **Epic 01.1** - Org context, RLS, users, roles (COMPLETE)
- **Epic 02.1** - Products table with `std_price` field (REQUIRED)

### Story Dependencies (within Epic 07)
- **07.3** - Sales Orders CRUD (REQUIRED - provides sales_orders table)
- **Provides to 07.5** - SO Confirmation workflow (needs validated pricing)

---

## Goal

Enable accurate pricing and total calculation for sales order lines, auto-populating from product master data while allowing manual overrides, with real-time total display in the SO form.

## User Story

As a **sales clerk**, I want **sales order lines to automatically populate with product prices and calculate totals** so that **I can quickly create accurate quotes and orders without manual price lookups or spreadsheet calculations**.

## Scope

**In scope (this story)**
- Database schema updates:
  - Add `discount` field to `sales_order_lines` (JSONB)
  - Add database triggers or service methods for total calculation
- API endpoints:
  - Auto-price lookup when adding SO line
  - Recalculate line totals on quantity/price/discount change
  - Recalculate SO total on line changes
- Service layer:
  - `calculateLineTotal(quantity, unitPrice, discount)`
  - `calculateOrderTotal(soId)`
  - `getProductPrice(productId, customerId?)` - Phase 1: just std_price
- Frontend:
  - Display unit_price (editable field)
  - Display line_total (read-only, calculated)
  - Display SO total_amount (read-only, calculated)
  - Real-time recalculation on change
  - Discount input field (optional, percentage or fixed)
- Validation:
  - unit_price > 0
  - discount >= 0 (cannot be negative)
  - discount validation: if type='percent', value <= 100

**Out of scope (this story)**
- Tax calculation (Epic 09 Finance)
- Customer-specific pricing rules (Phase 2)
- Payment terms logic (Phase 2)
- Credit limit validation (Phase 2)
- Historical price tracking (Phase 3)
- Price approval workflows (Phase 3)

---

## Acceptance Criteria (Given/When/Then)

### AC-1: Auto-populate unit_price from product master

**Given** a user is creating a new SO line
**When** they select a product from the dropdown
**Then** the unit_price field auto-populates with `products.std_price`
**And** the field remains editable (manual override allowed)

### AC-2: Calculate line_total on quantity/price change

**Given** an SO line with quantity_ordered = 100 and unit_price = 12.50
**When** the line is saved
**Then** line_total is calculated as 100 * 12.50 = 1250.00
**And** the value is stored in `sales_order_lines.line_total`

### AC-3: Apply percentage discount to line

**Given** an SO line with quantity = 50, unit_price = 20.00
**When** user enters discount: {type: 'percent', value: 10}
**Then** line_total = (50 * 20.00) * (1 - 0.10) = 900.00

### AC-4: Apply fixed discount to line

**Given** an SO line with quantity = 25, unit_price = 40.00
**When** user enters discount: {type: 'fixed', value: 50.00}
**Then** line_total = (25 * 40.00) - 50.00 = 950.00

### AC-5: Calculate SO total_amount from all lines

**Given** a sales order with 3 lines:
  - Line 1: line_total = 500.00
  - Line 2: line_total = 750.00
  - Line 3: line_total = 250.00
**When** the SO is displayed
**Then** total_amount = 500.00 + 750.00 + 250.00 = 1500.00
**And** the value is stored in `sales_orders.total_amount`

### AC-6: Recalculate totals on line edit

**Given** an SO with total_amount = 1500.00
**When** user edits Line 2 quantity from 30 to 40 (unit_price = 25.00)
**Then** Line 2 line_total recalculates to 40 * 25.00 = 1000.00
**And** SO total_amount recalculates to 500.00 + 1000.00 + 250.00 = 1750.00

### AC-7: Recalculate totals on line delete

**Given** an SO with total_amount = 1500.00
**When** user deletes Line 3 (line_total = 250.00)
**Then** SO total_amount recalculates to 500.00 + 750.00 = 1250.00

### AC-8: Validate positive unit_price

**Given** a user is creating/editing an SO line
**When** they enter unit_price = 0 or negative value
**Then** validation error displays: "Unit price must be greater than zero"
**And** the line cannot be saved

### AC-9: Validate non-negative discount

**Given** a user is entering a discount
**When** they enter a negative discount value
**Then** validation error displays: "Discount cannot be negative"

### AC-10: Validate percentage discount <= 100%

**Given** a user is entering a percentage discount
**When** they enter discount.value > 100
**Then** validation error displays: "Percentage discount cannot exceed 100%"

### AC-11: Handle products without std_price

**Given** a product with std_price = NULL
**When** user selects this product for SO line
**Then** unit_price defaults to 0.00
**And** warning message displays: "Product has no standard price, please enter manually"
**And** field is editable for manual entry

### AC-12: Real-time total display in SO form

**Given** a user is creating/editing an SO
**When** they add, edit, or delete lines
**Then** the SO total_amount updates in real-time without page refresh
**And** the updated total is displayed prominently at the bottom of the line items table

---

## Implementation Notes

### Database Schema Changes

#### sales_order_lines table updates

Add discount field:

```sql
ALTER TABLE sales_order_lines
ADD COLUMN discount JSONB DEFAULT NULL;

-- Example discount values:
-- NULL or {} = no discount
-- {"type": "percent", "value": 10.00} = 10% off
-- {"type": "fixed", "value": 50.00} = $50 off

-- Add comment
COMMENT ON COLUMN sales_order_lines.discount IS 'Discount config: {type: "percent"|"fixed", value: decimal}';
```

#### Existing fields (no changes needed)

```sql
-- From architecture doc (lines 109-127):
unit_price    DECIMAL(15,4) NOT NULL
line_total    DECIMAL(15,2)           -- Calculated
```

```sql
-- sales_orders.total_amount already exists:
total_amount  DECIMAL(15,2)           -- Calculated
```

### Calculation Logic

#### Line Total Calculation

```typescript
// lib/services/pricing-service.ts

export function calculateLineTotal(
  quantity: number,
  unitPrice: number,
  discount?: { type: 'percent' | 'fixed'; value: number }
): number {
  // Base amount
  let lineTotal = quantity * unitPrice;

  // Apply discount if present
  if (discount) {
    if (discount.type === 'percent') {
      lineTotal = lineTotal * (1 - discount.value / 100);
    } else if (discount.type === 'fixed') {
      lineTotal = lineTotal - discount.value;
    }
  }

  // Round to 2 decimal places for currency
  return Math.round(lineTotal * 100) / 100;
}
```

#### Order Total Calculation

```typescript
export async function calculateOrderTotal(soId: string): Promise<number> {
  const { data: lines } = await supabase
    .from('sales_order_lines')
    .select('line_total')
    .eq('sales_order_id', soId);

  const total = lines?.reduce((sum, line) => sum + (line.line_total || 0), 0) || 0;

  // Round to 2 decimal places
  return Math.round(total * 100) / 100;
}
```

#### Get Product Price

```typescript
export async function getProductPrice(
  productId: string,
  customerId?: string
): Promise<number | null> {
  // Phase 1: Just return std_price
  const { data: product } = await supabase
    .from('products')
    .select('std_price')
    .eq('id', productId)
    .single();

  return product?.std_price || null;

  // Phase 2: Add customer-specific pricing lookup
  // Phase 3: Add pricing tier logic
}
```

### API Endpoints

```typescript
// Existing endpoints (no new routes needed, enhance existing)

PUT /api/shipping/sales-orders/:id/lines/:lineId
// Endpoint updates:
// - Accept discount field in request body
// - Recalculate line_total after update
// - Recalculate SO total_amount
// - Return updated line + SO total

POST /api/shipping/sales-orders/:id/lines
// Endpoint updates:
// - Auto-populate unit_price from products.std_price
// - Calculate line_total
// - Recalculate SO total_amount
// - Return created line + SO total

DELETE /api/shipping/sales-orders/:id/lines/:lineId
// Endpoint updates:
// - Recalculate SO total_amount after deletion
// - Return updated SO total

GET /api/shipping/products/:id/price
// New helper endpoint (optional):
// - Return current selling price for a product
// - Used for price lookup without creating line
```

### Frontend Components

#### SO Line Form Component

```typescript
// apps/frontend/app/(authenticated)/shipping/sales-orders/[id]/components/SOLineForm.tsx

interface SOLineFormProps {
  onLineChange: (line: SOLine) => void;
  productId?: string;
}

export function SOLineForm({ onLineChange, productId }: SOLineFormProps) {
  const [quantity, setQuantity] = useState<number>(1);
  const [unitPrice, setUnitPrice] = useState<number>(0);
  const [discount, setDiscount] = useState<Discount | null>(null);
  const [lineTotal, setLineTotal] = useState<number>(0);

  // Auto-populate price when product selected
  useEffect(() => {
    if (productId) {
      fetchProductPrice(productId).then((price) => {
        setUnitPrice(price || 0);
        if (!price) {
          toast.warning('Product has no standard price');
        }
      });
    }
  }, [productId]);

  // Recalculate line total on change
  useEffect(() => {
    const total = calculateLineTotal(quantity, unitPrice, discount);
    setLineTotal(total);
    onLineChange({ quantity, unitPrice, discount, lineTotal: total });
  }, [quantity, unitPrice, discount]);

  return (
    <div className="space-y-4">
      <Input
        label="Quantity"
        type="number"
        value={quantity}
        onChange={(e) => setQuantity(Number(e.target.value))}
      />
      <Input
        label="Unit Price"
        type="number"
        step="0.01"
        value={unitPrice}
        onChange={(e) => setUnitPrice(Number(e.target.value))}
      />
      <DiscountInput
        value={discount}
        onChange={setDiscount}
      />
      <div className="text-lg font-semibold">
        Line Total: ${lineTotal.toFixed(2)}
      </div>
    </div>
  );
}
```

#### SO Total Display

```typescript
// apps/frontend/app/(authenticated)/shipping/sales-orders/[id]/components/SOTotalDisplay.tsx

interface SOTotalDisplayProps {
  lines: SOLine[];
}

export function SOTotalDisplay({ lines }: SOTotalDisplayProps) {
  const total = lines.reduce((sum, line) => sum + (line.line_total || 0), 0);

  return (
    <Card className="mt-4">
      <CardContent>
        <div className="flex justify-between items-center">
          <span className="text-xl font-semibold">Order Total:</span>
          <span className="text-2xl font-bold text-green-600">
            ${total.toFixed(2)}
          </span>
        </div>
      </CardContent>
    </Card>
  );
}
```

### Validation (Zod)

```typescript
// lib/validation/sales-order-line-schema.ts

const discountSchema = z.object({
  type: z.enum(['percent', 'fixed']),
  value: z.number().min(0, 'Discount cannot be negative'),
}).refine((data) => {
  if (data.type === 'percent' && data.value > 100) {
    return false;
  }
  return true;
}, {
  message: 'Percentage discount cannot exceed 100%',
});

export const salesOrderLineSchema = z.object({
  product_id: z.string().uuid(),
  quantity_ordered: z.number().positive('Quantity must be greater than zero'),
  unit_price: z.number().positive('Unit price must be greater than zero'),
  discount: discountSchema.optional().nullable(),
  line_total: z.number().optional(), // Calculated field
  requested_lot: z.string().optional(),
  notes: z.string().optional(),
});

export type SOLineInput = z.infer<typeof salesOrderLineSchema>;
```

### Services

```typescript
// lib/services/pricing-service.ts

export class PricingService {
  static async getProductPrice(
    productId: string,
    customerId?: string
  ): Promise<number | null> {
    // Phase 1: Return std_price from products
    const { data, error } = await supabase
      .from('products')
      .select('std_price')
      .eq('id', productId)
      .single();

    if (error) throw error;
    return data?.std_price || null;
  }

  static calculateLineTotal(
    quantity: number,
    unitPrice: number,
    discount?: { type: 'percent' | 'fixed'; value: number }
  ): number {
    let lineTotal = quantity * unitPrice;

    if (discount) {
      if (discount.type === 'percent') {
        lineTotal = lineTotal * (1 - discount.value / 100);
      } else if (discount.type === 'fixed') {
        lineTotal = Math.max(0, lineTotal - discount.value);
      }
    }

    return Math.round(lineTotal * 100) / 100;
  }

  static async calculateOrderTotal(soId: string): Promise<number> {
    const { data: lines, error } = await supabase
      .from('sales_order_lines')
      .select('line_total')
      .eq('sales_order_id', soId);

    if (error) throw error;

    const total = lines?.reduce((sum, line) => sum + (line.line_total || 0), 0) || 0;
    return Math.round(total * 100) / 100;
  }

  static async updateOrderTotal(soId: string): Promise<void> {
    const total = await this.calculateOrderTotal(soId);

    const { error } = await supabase
      .from('sales_orders')
      .update({ total_amount: total })
      .eq('id', soId);

    if (error) throw error;
  }
}
```

### Key Business Rules

1. **Price Lookup Priority** (Phase 1 only step 1):
   - Look up `products.std_price`
   - If NULL, default to 0.00 and warn user
   - User can manually override

2. **Price Override Rules**:
   - Unit price can be edited ONLY when SO status = 'draft'
   - Once SO is confirmed, price is locked
   - Price override does NOT update product master data

3. **Discount Rules**:
   - Discount is optional (can be NULL or empty)
   - Percentage discount: 0-100%
   - Fixed discount: Cannot exceed line subtotal (prevent negative totals)
   - Discount can be edited only in 'draft' status

4. **Calculation Precision**:
   - Store unit_price as DECIMAL(15,4) - up to 4 decimal places
   - Store quantity_ordered as DECIMAL(15,4) - allows fractional quantities
   - Calculate line_total = quantity * unit_price - discount
   - Round line_total to 2 decimal places (currency)
   - Store line_total as DECIMAL(15,2)
   - SO total_amount = SUM(line_total) - rounded to 2 decimals

5. **Recalculation Triggers**:
   - Line add → Calculate line_total, update SO total
   - Line edit (qty/price/discount) → Recalculate line_total, update SO total
   - Line delete → Update SO total
   - SO load → Display current total (no recalc unless draft mode)

6. **Edge Cases**:
   - Zero quantity → Validation error (must be > 0)
   - Zero unit_price → Validation error (must be > 0)
   - Discount > line subtotal (fixed type) → Set line_total = 0.00 (minimum)
   - Product deleted after line creation → Keep existing unit_price

---

## Deliverables

### Database Changes
- [ ] Migration: Add `sales_order_lines.discount` (JSONB)
- [ ] Migration: Add comment on discount column

### API Routes
- [ ] Update `POST /api/shipping/sales-orders/:id/lines`
  - Auto-populate unit_price from products.std_price
  - Calculate line_total
  - Update SO total_amount
- [ ] Update `PUT /api/shipping/sales-orders/:id/lines/:lineId`
  - Accept discount field
  - Recalculate line_total
  - Update SO total_amount
- [ ] Update `DELETE /api/shipping/sales-orders/:id/lines/:lineId`
  - Recalculate SO total_amount after deletion
- [ ] Optional: `GET /api/shipping/products/:id/price` (helper endpoint)

### Services
- [ ] `lib/services/pricing-service.ts`
  - `getProductPrice(productId, customerId?)`
  - `calculateLineTotal(quantity, unitPrice, discount?)`
  - `calculateOrderTotal(soId)`
  - `updateOrderTotal(soId)`

### Validation
- [ ] Update `lib/validation/sales-order-line-schema.ts`
  - Add discount field (optional, with type + value validation)
  - Add unit_price > 0 validation
  - Add discount >= 0 validation
  - Add percent discount <= 100 validation

### Frontend Components
- [ ] Update `SOLineForm.tsx`
  - Auto-populate unit_price on product select
  - Add discount input (type + value)
  - Display calculated line_total (read-only)
  - Real-time recalculation
- [ ] Update `SOLineTable.tsx`
  - Display unit_price (editable in draft mode)
  - Display discount (if present)
  - Display line_total
- [ ] Add/Update `SOTotalDisplay.tsx`
  - Display SO total_amount prominently
  - Update in real-time as lines change
- [ ] Add `DiscountInput.tsx` component
  - Type selector: Percentage / Fixed
  - Value input (numeric)
  - Validation feedback

### Tests
- [ ] Unit tests: `pricing-service.test.ts`
  - Test calculateLineTotal with various scenarios
  - Test discount calculations (percent + fixed)
  - Test calculateOrderTotal
  - Test edge cases (zero, negative, NULL)
- [ ] Integration tests: `sales-order-lines-api.test.ts`
  - Test auto-price population
  - Test line total recalculation
  - Test SO total recalculation
- [ ] E2E tests: `sales-order-pricing.spec.ts`
  - Create SO → Add line → Verify auto-price
  - Edit quantity → Verify line + SO total update
  - Add discount → Verify calculation
  - Delete line → Verify SO total update

---

## Definition of Done

- [ ] Database migration applied and tested
- [ ] Discount field added to sales_order_lines
- [ ] API endpoints updated and tested (unit + integration)
- [ ] Auto-price lookup working from products.std_price
- [ ] Line total calculation correct (qty * price - discount)
- [ ] SO total calculation correct (sum of line totals)
- [ ] Real-time total display working in frontend
- [ ] Manual price override allowed in draft mode
- [ ] Discount input (percent/fixed) working with validation
- [ ] Validation prevents negative prices, negative discounts, >100% discounts
- [ ] Warning shown when product has no std_price
- [ ] Unit tests passing (>80% coverage for pricing-service)
- [ ] Integration tests passing for API endpoints
- [ ] E2E test passing for pricing workflow
- [ ] RLS policies verified (org_id isolation)
- [ ] Edge cases handled (zero, NULL, product deletion)
- [ ] Code reviewed and approved
- [ ] Documentation updated (if API contract changed)

---

## Future Enhancements (Not in This Story)

### Phase 2
- **Customer-Specific Pricing** (FR-7.8)
  - Create `customer_pricing` table
  - Look up customer price before std_price
  - Support price agreements with date ranges

- **Payment Terms** (FR-7.6)
  - Add `payment_terms_days` to customers
  - Display due date on SO based on payment terms

- **Credit Limit Check** (FR-7.4)
  - Check customer.credit_limit before confirming SO
  - Block/warn if SO total exceeds available credit

### Phase 3
- **Multi-Currency Pricing**
  - Add currency_id to sales_orders
  - Convert prices based on exchange rates

- **Bulk Pricing Tiers**
  - Tiered pricing: 1-100 = $10, 101-500 = $9, 501+ = $8
  - Auto-apply tier based on quantity

- **Historical Price Tracking**
  - Track price changes in audit log
  - Display price history for product

- **Tax Calculation** (Epic 09 Finance)
  - Apply tax rates by jurisdiction
  - Calculate tax_amount per line
  - Display subtotal, tax, grand total

- **Price Approval Workflows**
  - Require manager approval for prices below cost
  - Require approval for discounts > threshold

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-12-16 | Initial story creation | PM-AGENT |
