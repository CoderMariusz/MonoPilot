# 07.3 - Sales Order Status Workflow + Hold/Cancel

| Field | Value |
|-------|-------|
| **Story ID** | 07.3 |
| **Epic** | 07 - Shipping |
| **Status** | Ready |
| **Phase** | 1A |
| **Complexity** | S (Small) |
| **Estimate** | 1-2 days |
| **Type** | Backend + Frontend |

---

## PRD References

| FR ID | Requirement | Priority | Covered |
|-------|-------------|----------|---------|
| FR-7.11 | SO Status Workflow | P0 | YES |
| FR-7.13 | SO Confirmation/Hold | P0 | YES (Hold only) |
| FR-7.17 | SO Cancellation | P0 | YES |
| FR-7.19 | Promised Ship Date | P1 | REF ONLY |

**Primary PRD:** `docs/1-BASELINE/product/modules/shipping.md` (lines 189-197, 759-774)
**Architecture:** `docs/1-BASELINE/architecture/modules/shipping.md` (lines 96, 1001-1008)

---

## User Story

As a **Sales Manager or Warehouse Manager**, I want to **place sales orders on hold or cancel them with proper status tracking and audit trails** so that **I can manage order exceptions and maintain accurate shipment visibility**.

---

## Dependencies

| Dependency | Story/Epic | Type | Reason |
|------------|------------|------|--------|
| 01.1 | Org Context + Base RLS | HARD | Requires org_id context and RLS patterns |
| 02.1 | Products CRUD | HARD | Sales orders reference products |
| 07.1 | Customers CRUD | HARD | Sales orders reference customers |
| 07.2 | Sales Orders CRUD | HARD | Requires sales_orders table |

**Dependents:**
- 07.7 (Inventory Allocation) - Hold status prevents allocation
- 07.8 (Pick List Generation) - Cannot create pick lists for cancelled orders
- 07.15 (Shipping Dashboard) - Status counts for KPIs

---

## MVP Scope

**In Scope (This Story):**
- Extend `sales_orders.status` enum to include `on_hold` and `cancelled` states
- POST `/api/shipping/sales-orders/:id/hold` endpoint
- POST `/api/shipping/sales-orders/:id/cancel` endpoint
- Business rules for status transitions (can only hold/cancel from draft or confirmed)
- Role-based authorization (Manager+ can cancel)
- Status timeline component for UI display
- Audit trail tracking (created_at, confirmed_at, updated_at timestamps)
- Status badge component with color coding

**Out of Scope (This Story):**
- Allocation release on cancel (Story 07.7)
- Backorder handling on cancellation (Epic 03 Planning)
- Email notifications for status changes (Phase 2)
- Bulk status operations (Phase 2)
- Cancel reason codes (Phase 2)

---

## Acceptance Criteria (Gherkin)

### AC-1: Status Enum Extension (FR-7.11)

```gherkin
Scenario: Sales order status states
  Given sales_orders table exists
  When database migration runs
  Then status column accepts: draft, confirmed, on_hold, cancelled, allocated, picking, packing, shipped, delivered
  And default status is 'draft'
```

### AC-2: Hold Sales Order (FR-7.13)

```gherkin
Scenario: Hold sales order from draft status
  Given sales order SO-001 with status 'draft'
  When manager calls POST /api/shipping/sales-orders/SO-001/hold
  Then status changes to 'on_hold'
  And updated_at timestamp is updated
  And response returns 200 with success message

Scenario: Hold sales order from confirmed status
  Given sales order SO-002 with status 'confirmed'
  When manager calls POST /api/shipping/sales-orders/SO-002/hold
  Then status changes to 'on_hold'
  And updated_at timestamp is updated

Scenario: Cannot hold sales order after allocation starts
  Given sales order SO-003 with status 'allocated'
  When manager calls POST /api/shipping/sales-orders/SO-003/hold
  Then error 400 returned
  And message "Cannot hold order after allocation has started"
  And status remains 'allocated'

Scenario: Cannot hold already cancelled order
  Given sales order SO-004 with status 'cancelled'
  When manager calls POST /api/shipping/sales-orders/SO-004/hold
  Then error 400 returned
  And message "Cannot hold a cancelled order"

Scenario: Hold reason is optional
  Given sales order SO-005 with status 'draft'
  When manager calls POST /api/shipping/sales-orders/SO-005/hold with body { "reason": "Customer requested delay" }
  Then status changes to 'on_hold'
  And notes field is appended with "[HOLD] Customer requested delay"
```

### AC-3: Cancel Sales Order (FR-7.17)

```gherkin
Scenario: Cancel sales order from draft status
  Given sales order SO-006 with status 'draft'
  When manager calls POST /api/shipping/sales-orders/SO-006/cancel
  Then status changes to 'cancelled'
  And updated_at timestamp is updated
  And response returns 200 with success message

Scenario: Cancel sales order from confirmed status
  Given sales order SO-007 with status 'confirmed'
  When manager calls POST /api/shipping/sales-orders/SO-007/cancel
  Then status changes to 'cancelled'
  And updated_at timestamp is updated

Scenario: Cancel sales order from on_hold status
  Given sales order SO-008 with status 'on_hold'
  When manager calls POST /api/shipping/sales-orders/SO-008/cancel
  Then status changes to 'cancelled'
  And updated_at timestamp is updated

Scenario: Cannot cancel after picking starts
  Given sales order SO-009 with status 'picking'
  When manager calls POST /api/shipping/sales-orders/SO-009/cancel
  Then error 400 returned
  And message "Cannot cancel order after picking has started. Please contact warehouse manager."
  And status remains 'picking'

Scenario: Cancel reason is required
  Given sales order SO-010 with status 'draft'
  When manager calls POST /api/shipping/sales-orders/SO-010/cancel with no body
  Then error 400 returned
  And message "Cancel reason is required"

Scenario: Cancel with reason appends to notes
  Given sales order SO-011 with status 'confirmed'
  When manager calls POST /api/shipping/sales-orders/SO-011/cancel with body { "reason": "Customer cancelled order" }
  Then status changes to 'cancelled'
  And notes field is appended with "[CANCELLED] Customer cancelled order"
```

### AC-4: Status State Machine Validation (FR-7.11)

```gherkin
Scenario: Valid status transitions enforced
  Given the following valid transitions are defined:
    | From State | To State | Action |
    | draft | confirmed | confirm |
    | draft | on_hold | hold |
    | draft | cancelled | cancel |
    | confirmed | on_hold | hold |
    | confirmed | cancelled | cancel |
    | confirmed | allocated | allocate |
    | on_hold | confirmed | release hold |
    | on_hold | cancelled | cancel |
  When any status transition is attempted
  Then only transitions in the table are allowed
  And invalid transitions return 400 error

Scenario: Cannot skip status states
  Given sales order with status 'draft'
  When attempting to set status to 'allocated' directly
  Then error 400 returned
  And message "Invalid status transition: draft â†’ allocated"
```

### AC-5: Role-Based Authorization (FR-7.17)

```gherkin
Scenario: Sales role can hold orders
  Given user has 'Sales' role
  When calling POST /api/shipping/sales-orders/:id/hold
  Then operation succeeds

Scenario: Manager role can cancel orders
  Given user has 'Manager' role
  When calling POST /api/shipping/sales-orders/:id/cancel
  Then operation succeeds

Scenario: Admin role can cancel orders
  Given user has 'Admin' role
  When calling POST /api/shipping/sales-orders/:id/cancel
  Then operation succeeds

Scenario: Sales role cannot cancel orders
  Given user has 'Sales' role
  When calling POST /api/shipping/sales-orders/:id/cancel
  Then error 403 returned
  And message "Insufficient permissions to cancel orders"

Scenario: Warehouse role cannot cancel orders
  Given user has 'Warehouse' role
  When calling POST /api/shipping/sales-orders/:id/cancel
  Then error 403 returned
```

### AC-6: Status Timeline Component (FR-7.11)

```gherkin
Scenario: Display status history timeline
  Given sales order with following history:
    | Status | Timestamp | User |
    | draft | 2025-01-01 10:00 | John |
    | confirmed | 2025-01-01 11:00 | Mary |
    | on_hold | 2025-01-01 14:00 | Mary |
    | confirmed | 2025-01-02 09:00 | Mary |
  When viewing sales order detail page
  Then status timeline component displays chronologically
  And each status shows icon, label, timestamp, and user name
  And most recent status is highlighted

Scenario: Timeline shows cancelled endpoint
  Given sales order with status 'cancelled'
  When viewing status timeline
  Then cancelled status is displayed at bottom
  And cancelled badge shows red color
  And no further statuses appear below cancelled
```

### AC-7: Status Badge Component (FR-7.11)

```gherkin
Scenario: Status badge colors
  Given sales order detail page displays
  When rendering status badge
  Then colors match the following:
    | Status | Color |
    | draft | Gray |
    | confirmed | Blue |
    | on_hold | Yellow |
    | allocated | Purple |
    | picking | Purple |
    | packing | Purple |
    | shipped | Green |
    | delivered | Green |
    | cancelled | Red |

Scenario: Status badge with icon
  Given sales order list page displays
  When viewing status column
  Then each status badge shows:
    - Color-coded background
    - Icon (pause for on_hold, x for cancelled)
    - Status label text
```

### AC-8: Audit Trail (FR-7.11)

```gherkin
Scenario: Track status change timestamps
  Given sales order SO-012
  When status changes from 'draft' to 'confirmed'
  Then updated_at timestamp is set to current time
  And confirmed_at timestamp is set to current time

Scenario: Track hold timestamp
  Given sales order SO-013
  When status changes to 'on_hold'
  Then updated_at timestamp is set
  And notes field contains timestamp of hold action

Scenario: Track cancelled timestamp
  Given sales order SO-014
  When status changes to 'cancelled'
  Then updated_at timestamp is set
  And notes field contains timestamp and reason for cancellation
```

---

## Implementation Notes

### API Endpoints

```typescript
POST   /api/shipping/sales-orders/:id/hold
  // Put sales order on hold
  Body: { reason?: string }
  Auth: true
  Roles: ['Sales', 'Manager', 'Admin']
  Response: { success: true, status: 'on_hold', updated_at: timestamp }
  Errors:
    400: "Cannot hold order after allocation has started"
    400: "Cannot hold a cancelled order"
    404: "Sales order not found"

POST   /api/shipping/sales-orders/:id/cancel
  // Cancel sales order
  Body: { reason: string }  // Required
  Auth: true
  Roles: ['Manager', 'Admin']
  Response: { success: true, status: 'cancelled', updated_at: timestamp }
  Errors:
    400: "Cancel reason is required"
    400: "Cannot cancel order after picking has started"
    404: "Sales order not found"
    403: "Insufficient permissions to cancel orders"
```

### Database Changes

```sql
-- Extend status enum in sales_orders table
ALTER TYPE sales_order_status ADD VALUE IF NOT EXISTS 'on_hold';
-- Note: cancelled is already in the enum from Architecture doc
-- Status enum should be: 'draft', 'confirmed', 'on_hold', 'cancelled',
--                        'allocated', 'picking', 'packing', 'shipped', 'delivered'

-- Add index for status queries
CREATE INDEX IF NOT EXISTS idx_sales_orders_status_updated
  ON sales_orders(org_id, status, updated_at);
```

### Service Logic

```typescript
// lib/services/sales-order-service.ts

export class SalesOrderService {
  /**
   * Put sales order on hold
   * Valid from: draft, confirmed
   * Invalid from: allocated, picking, packing, shipped, delivered, cancelled
   */
  static async holdOrder(orderId: string, reason?: string): Promise<SalesOrder> {
    const order = await this.getById(orderId);

    // Validate current status
    const validFromStatuses = ['draft', 'confirmed'];
    if (!validFromStatuses.includes(order.status)) {
      if (order.status === 'cancelled') {
        throw new Error('Cannot hold a cancelled order');
      }
      throw new Error('Cannot hold order after allocation has started');
    }

    // Update status
    const updated = await supabase
      .from('sales_orders')
      .update({
        status: 'on_hold',
        updated_at: new Date().toISOString(),
        notes: reason
          ? `${order.notes || ''}\n[HOLD - ${new Date().toISOString()}] ${reason}`.trim()
          : order.notes
      })
      .eq('id', orderId)
      .select()
      .single();

    return updated.data;
  }

  /**
   * Cancel sales order
   * Valid from: draft, confirmed, on_hold
   * Invalid from: picking, packing, shipped, delivered, cancelled
   */
  static async cancelOrder(orderId: string, reason: string): Promise<SalesOrder> {
    if (!reason || reason.trim().length === 0) {
      throw new Error('Cancel reason is required');
    }

    const order = await this.getById(orderId);

    // Validate current status
    const validFromStatuses = ['draft', 'confirmed', 'on_hold', 'allocated'];
    if (!validFromStatuses.includes(order.status)) {
      throw new Error('Cannot cancel order after picking has started. Please contact warehouse manager.');
    }

    // Update status
    const updated = await supabase
      .from('sales_orders')
      .update({
        status: 'cancelled',
        updated_at: new Date().toISOString(),
        notes: `${order.notes || ''}\n[CANCELLED - ${new Date().toISOString()}] ${reason}`.trim()
      })
      .eq('id', orderId)
      .select()
      .single();

    // Note: Allocation release handled in Story 07.7

    return updated.data;
  }
}
```

### Frontend Components

```typescript
// components/shipping/sales-orders/SOStatusBadge.tsx
// Color-coded status badge with icon

// components/shipping/sales-orders/SOStatusTimeline.tsx
// Vertical timeline showing status history with timestamps

// components/shipping/sales-orders/HoldOrderDialog.tsx
// Confirmation dialog for hold action with optional reason input

// components/shipping/sales-orders/CancelOrderDialog.tsx
// Confirmation dialog for cancel action with required reason input
```

### Validation (Zod)

```typescript
// lib/validation/sales-order-schema.ts

export const holdOrderSchema = z.object({
  reason: z.string().max(500).optional()
});

export const cancelOrderSchema = z.object({
  reason: z.string().min(1, 'Cancel reason is required').max(500)
});
```

### Key Business Rules

1. **Status State Machine:**
   - Hold allowed from: draft, confirmed
   - Cancel allowed from: draft, confirmed, on_hold, allocated
   - Cannot hold/cancel after picking starts (status = picking, packing, shipped, delivered)

2. **Authorization:**
   - Hold: Sales, Manager, Admin roles
   - Cancel: Manager, Admin roles only

3. **Reason Tracking:**
   - Hold reason is optional
   - Cancel reason is required
   - Both append to notes field with timestamp

4. **Audit Trail:**
   - updated_at always updated on status change
   - confirmed_at set when status = confirmed (Story 07.2)
   - Notes field contains full history of hold/cancel actions

5. **Cascade Effects:**
   - on_hold status prevents allocation (enforced in Story 07.7)
   - cancelled status releases allocations (handled in Story 07.7)

---

## Deliverables

- Migration: Extend sales_orders.status enum with 'on_hold'
- API routes:
  - POST `/api/shipping/sales-orders/:id/hold`
  - POST `/api/shipping/sales-orders/:id/cancel`
- Service methods:
  - `SalesOrderService.holdOrder()`
  - `SalesOrderService.cancelOrder()`
- Validation schemas: holdOrderSchema, cancelOrderSchema
- Components:
  - `SOStatusBadge.tsx` (color-coded badge)
  - `SOStatusTimeline.tsx` (status history timeline)
  - `HoldOrderDialog.tsx` (confirmation dialog)
  - `CancelOrderDialog.tsx` (confirmation dialog with reason)
- Unit tests for service methods
- Integration tests for API endpoints
- E2E tests for hold/cancel flows

---

## Definition of Done

- [ ] Database migration adds 'on_hold' to status enum
- [ ] Index created on (org_id, status, updated_at)
- [ ] POST /hold endpoint implemented with validation
- [ ] POST /cancel endpoint implemented with validation
- [ ] Status state machine enforced (valid transitions only)
- [ ] Role-based authorization enforced (Manager+ for cancel)
- [ ] Reason tracking appended to notes field
- [ ] updated_at timestamp updated on status change
- [ ] SOStatusBadge component with 9 status colors
- [ ] SOStatusTimeline component showing status history
- [ ] HoldOrderDialog with optional reason input
- [ ] CancelOrderDialog with required reason input
- [ ] RLS policies enforce org isolation
- [ ] Multi-tenancy tested (cross-org returns 404)
- [ ] Unit tests >= 80% coverage
- [ ] Integration tests for hold/cancel endpoints
- [ ] E2E tests for hold/cancel flows
- [ ] Toast notifications on success/error
- [ ] Permission matrix enforced in UI (hide cancel button for Sales role)

---

## Future Phases (Not in This Story)

### Phase 1B
- Allocation release on cancel (Story 07.7)
- on_hold prevention in allocation logic (Story 07.7)

### Phase 2
- Bulk hold/cancel operations
- Cancel reason codes (predefined dropdown)
- Email notifications on status change
- Backorder creation on cancellation (with Epic 03 Planning)

### Phase 3
- Advanced status analytics
- Cancellation rate reporting
- Automated hold triggers (e.g., credit limit exceeded)

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-12-16 | Initial story for SO status workflow + hold/cancel | PM-AGENT |
