# 07.9 - Pick Confirmation - Desktop UI

**Priority**: P0 (MVP Core)
**Complexity**: M (3-4 days)
**Type:** frontend + backend
**Phase:** 1B (After Story 07.8 - Pick List Generation)

**State:** ready
**Primary PRD:** `docs/1-BASELINE/product/modules/shipping.md` (FR-7.24, FR-7.26, FR-7.27, FR-7.28, FR-7.30)
**Architecture:** `docs/1-BASELINE/architecture/modules/shipping.md` (lines 159-176, 419-427, 696-722)

---

## MVP Scope

This story implements desktop-based pick confirmation workflow for warehouse pickers who don't have handheld scanners. Covers manual entry of picked quantities, short pick handling, and real-time progress tracking for pick lists.

**What's IN scope:**
- Desktop pick confirmation page at `/shipping/pick-lists/:id/pick`
- PUT /api/shipping/pick-lists/:id/lines/:lineId/pick endpoint
  - Update `pick_list_lines`: quantity_picked, picked_license_plate_id, picked_at, picked_by, status='picked'
  - Update `inventory_allocations`: quantity_picked
  - Update `sales_order_lines`: quantity_picked
  - Update `license_plates`: quantity_on_hand (decrement)
- POST /api/shipping/pick-lists/:id/lines/:lineId/short-pick endpoint
  - Record partial pick with reason
  - Create backorder signal if needed
  - Status='short'
- POST /api/shipping/pick-lists/:id/start (status: pending/assigned → in_progress)
- POST /api/shipping/pick-lists/:id/complete (status: in_progress → completed, validate all lines picked)
- Desktop UI components:
  - PickConfirmationPage with real-time progress (X of Y lines picked)
  - PickLineCard with quantity input (default = quantity_to_pick, editable)
  - ShortPickModal (reason selection required)
  - LP barcode display (scannable if user has scanner)
- Allergen warnings displayed per line (if product has allergens)
- Validation: cannot pick more than allocated
- Permission: only assigned picker or Warehouse+ can confirm picks

**What's OUT of scope (deferred to other stories):**
- Scanner UI workflow (Story 07.10)
- Wave picking UI (Phase 2)
- Route optimization display (Phase 2)
- Pick list cancellation workflow (Story 07.9 or Phase 2)
- Pick performance metrics (Phase 3, Story 07.33)

---

## Dependencies

### Epic Dependencies
- **Epic 01.1** - Organizations, RLS, users, roles (HARD)
- **Epic 01.8** - Warehouses (HARD)
- **Epic 01.9** - Locations (zone, aisle, bin hierarchy) (HARD)
- **Epic 02.1** - Products (HARD)
- **Epic 02.3** - Allergens (for customer restrictions) (HARD)
- **Epic 05.1** - License Plates (HARD)
- **Epic 05.3** - LP Reservations/Allocations (HARD)

### Story Dependencies (within Epic 07)
- **07.3** - Sales Orders CRUD (provides sales_orders table)
- **07.4** - SO Lines Management (provides sales_order_lines table)
- **07.7** - Inventory Allocation (provides inventory_allocations records) **[BLOCKER]**
- **07.8** - Pick List Generation (provides pick_lists, pick_list_lines) **[BLOCKER]**

### Provides To
- **07.10** - Pick Confirmation Scanner (shares pick confirmation logic)
- **07.11** - Packing Station (picks feed into packing workflow)
- **07.14** - Shipment + Ship Confirm (completed picks enable shipment)

---

## Goal

Enable warehouse pickers to confirm picked inventory on desktop computers (without handheld scanners) by manually entering picked quantities, handling short picks with reasons, and updating inventory in real-time while maintaining full traceability.

## User Story

As a **warehouse picker**, I want to **confirm picked quantities on a desktop screen and handle short picks** so that **I can complete my pick list without a scanner, record partial picks accurately, and keep inventory synchronized with actual warehouse operations**.

## Scope

**In scope (this story)**
- Desktop pick confirmation page with line-by-line workflow
- Start pick list workflow (status: assigned → in_progress)
- Pick confirmation with quantity validation
  - Default quantity = quantity_to_pick (editable)
  - Cannot exceed allocated quantity
  - Update inventory_allocations, sales_order_lines, license_plates
- Short pick workflow
  - Modal with reason selection (required)
  - Create backorder signal if partial SO fulfillment
  - Status = 'short'
- Complete pick list workflow (validate all lines picked/short)
- Real-time progress indicator (X of Y lines picked)
- Allergen warning display per line (if customer has restrictions)
- LP barcode display (human-readable + barcode format for handheld scanner users)
- Permission validation (only assigned picker or Warehouse+ roles)
- Multi-tenant RLS enforcement

**Out of scope (this story)**
- Scanner UI workflow (dedicated mobile/tablet UI) - Story 07.10
- Pick list cancellation - Future story
- Route optimization display - Phase 2
- Pick performance tracking - Phase 3
- Batch/wave picking UI enhancements - Phase 2

---

## Acceptance Criteria (Given/When/Then)

### AC-1: Start Pick List

**Given** a pick list with status = 'assigned'
**And** the current user is the assigned picker (or has Warehouse+ role)
**When** the user clicks "Start Picking" on the pick list detail page
**Then** the system updates pick_list.status to 'in_progress'
**And** updates pick_list.started_at to current timestamp
**And** navigates to /shipping/pick-lists/:id/pick (pick confirmation page)
**And** displays the first pending pick line (sorted by pick_sequence)

### AC-2: Display Pick Confirmation Page

**Given** a pick list with status = 'in_progress'
**When** the user navigates to /shipping/pick-lists/:id/pick
**Then** the system displays:
- Pick list header: PL number, type, priority, assigned picker
- Progress indicator: "Picked 3 of 12 lines (25%)"
- Current pick line card:
  - Location: Zone A → Aisle 3 → Bin 5-A
  - Product: Name, SKU, Image thumbnail
  - Lot: LOT-2025-001, Expiry: 2025-06-30 (if applicable)
  - License Plate: LP-2025-00042 (with barcode display)
  - Quantity to pick: 50 units (editable input)
  - Allergen warning (if product has allergens and customer has restrictions)
- Action buttons: "Confirm Pick" (primary), "Short Pick" (secondary), "Skip" (tertiary)
- Navigation: "Previous Line" / "Next Line" buttons
- "Complete Pick List" button (enabled when all lines picked/short)

### AC-3: Confirm Full Pick

**Given** a pick line with quantity_to_pick = 50 units
**And** the picker has physically picked 50 units from the license plate
**When** the picker enters 50 in the quantity input and clicks "Confirm Pick"
**Then** the system:
1. Validates quantity_picked (50) <= quantity_to_pick (50) ✓
2. Updates pick_list_lines:
   - quantity_picked = 50
   - picked_license_plate_id = license_plate_id (same as suggested)
   - status = 'picked'
   - picked_at = current timestamp
   - picked_by = current user_id
3. Updates inventory_allocations:
   - quantity_picked = 50 (for this allocation)
4. Updates sales_order_lines:
   - quantity_picked += 50 (increment)
5. Updates license_plates:
   - quantity_on_hand -= 50 (decrement)
6. Shows success toast: "Line picked successfully"
7. Advances to next pending line (or completion screen if last line)
8. Updates progress indicator: "Picked 4 of 12 lines (33%)"

### AC-4: Confirm Partial Pick (Short Pick)

**Given** a pick line with quantity_to_pick = 50 units
**And** the license plate only has 30 units available
**When** the picker enters 30 in the quantity input and clicks "Short Pick"
**Then** the system displays ShortPickModal with:
- Reason dropdown (required):
  - Insufficient inventory
  - Damaged product
  - Expired product
  - Location empty
  - Quality hold
  - Other (requires text note)
- Notes field (optional)
- "Confirm Short Pick" button
**When** the picker selects reason "Insufficient inventory" and clicks "Confirm Short Pick"
**Then** the system:
1. Updates pick_list_lines:
   - quantity_picked = 30
   - status = 'short'
   - picked_at = current timestamp
   - picked_by = current user_id
   - notes = reason + user notes
2. Updates inventory_allocations:
   - quantity_picked = 30
3. Updates sales_order_lines:
   - quantity_picked += 30
4. Updates license_plates:
   - quantity_on_hand -= 30
5. Checks if sales_order can be fully fulfilled:
   - If quantity_picked < quantity_ordered for any line → Create backorder signal
   - Create backorder_lines record (future Epic 03 Planning integration)
6. Shows warning toast: "Short pick recorded. Backorder created for 20 units."
7. Advances to next line

### AC-5: Validation - Cannot Pick More Than Allocated

**Given** a pick line with quantity_to_pick = 50 units
**When** the picker enters 60 units and clicks "Confirm Pick"
**Then** the system displays error message: "Cannot pick more than allocated quantity (50 units)"
**And** the pick is not recorded
**And** the quantity input field is highlighted in red

### AC-6: Allergen Warning Display

**Given** a sales order for a customer with allergen_restrictions = ["gluten", "dairy"]
**And** a pick line for a product with allergens = ["gluten"]
**When** the pick confirmation page displays this line
**Then** the system shows a prominent warning banner:
- Icon: Red alert icon
- Text: "ALLERGEN ALERT: This product contains GLUTEN. Customer is allergic to GLUTEN."
- Color: Red/orange background
**And** requires the picker to acknowledge the warning (checkbox) before confirming pick

### AC-7: Complete Pick List

**Given** a pick list with 12 lines
**And** 10 lines have status = 'picked'
**And** 2 lines have status = 'short'
**When** the picker clicks "Complete Pick List"
**Then** the system validates:
- All lines have status IN ('picked', 'short') ✓
**And** updates pick_list:
- status = 'completed'
- completed_at = current timestamp
**And** updates all associated sales_orders:
- If all lines fully picked → status = 'packing'
- If any lines short → status = 'partial' (or remain 'picking' if more pick lists exist)
**And** displays success message: "Pick list PL-2025-00042 completed. 10 lines picked, 2 short picks."
**And** navigates to /shipping/pick-lists/my-picks (or pick list detail page)

### AC-8: Real-Time Progress Indicator

**Given** a pick list with 12 lines in progress
**When** the picker confirms each pick
**Then** the progress indicator updates in real-time:
- "Picked 0 of 12 lines (0%)" → "Picked 1 of 12 lines (8%)" → ... → "Picked 12 of 12 lines (100%)"
**And** the progress bar fills proportionally
**And** displays breakdown: "10 picked, 2 short picks"

### AC-9: Permission Validation - Assigned Picker Only

**Given** a pick list assigned to User A
**And** the current user is User B (not assigned, Picker role)
**When** User B attempts to access /shipping/pick-lists/:id/pick
**Then** the system displays error: "Access denied. This pick list is assigned to another picker."
**And** redirects to /shipping/pick-lists/my-picks

**Given** a pick list assigned to User A
**And** the current user is Manager (Warehouse Manager role)
**When** Manager attempts to access /shipping/pick-lists/:id/pick
**Then** the system allows access (Warehouse+ roles can override assignment)

### AC-10: LP Barcode Display for Scanner Users

**Given** a pick line with license_plate.lp_number = "LP-2025-00042"
**When** the pick confirmation page displays this line
**Then** the system shows:
- Human-readable LP number: "LP-2025-00042" (large font)
- CODE128 barcode image (scannable with handheld scanner)
- "Scan LP" instruction text
**And** if picker has a handheld scanner, they can scan the barcode to auto-fill the LP field
**And** if no scanner, they can visually verify the LP number manually

### AC-11: Multi-Tenant Isolation

**Given** two organizations (Org A and Org B)
**And** a pick list belonging to Org A
**When** a user from Org B attempts to access this pick list
**Then** the system returns 404 Not Found (RLS policy blocks access)
**And** all pick confirmation API calls enforce org_id filter

---

## Implementation Notes

### API Endpoints

```typescript
// Start pick list
POST /api/shipping/pick-lists/:id/start
Response: { success: true; started_at: string; }

// Confirm pick (full quantity)
PUT /api/shipping/pick-lists/:id/lines/:lineId/pick
Body: {
  quantity_picked: number;
  picked_license_plate_id: string;  // Usually same as license_plate_id
}
Response: { success: true; line_status: 'picked'; }

// Short pick (partial quantity)
POST /api/shipping/pick-lists/:id/lines/:lineId/short-pick
Body: {
  quantity_picked: number;
  reason: 'insufficient_inventory' | 'damaged' | 'expired' | 'location_empty' | 'quality_hold' | 'other';
  notes?: string;
}
Response: {
  success: true;
  line_status: 'short';
  backorder_created: boolean;
  backorder_quantity?: number;
}

// Complete pick list
POST /api/shipping/pick-lists/:id/complete
Response: {
  success: true;
  completed_at: string;
  total_picked: number;
  total_short: number;
}

// Get pick list with lines (for confirmation page)
GET /api/shipping/pick-lists/:id?include=lines,allocations,products,allergens
Response: {
  pick_list: PickList;
  lines: PickListLine[];
  sales_orders: SalesOrder[];
}
```

### Database Updates

No new tables needed. Updates to existing tables:

```sql
-- pick_list_lines already has these columns (from Story 07.8)
-- Updates during pick confirmation:
UPDATE pick_list_lines SET
  quantity_picked = :quantity,
  status = 'picked' | 'short',
  picked_license_plate_id = :lp_id,
  picked_at = NOW(),
  picked_by = :user_id,
  notes = :reason || ' - ' || :notes  -- For short picks
WHERE id = :line_id AND org_id = :org_id;

-- Cascade updates
UPDATE inventory_allocations SET
  quantity_picked = :quantity
WHERE sales_order_line_id = :so_line_id;

UPDATE sales_order_lines SET
  quantity_picked = quantity_picked + :quantity
WHERE id = :so_line_id;

UPDATE license_plates SET
  quantity_on_hand = quantity_on_hand - :quantity,
  allocated_quantity = allocated_quantity - :quantity
WHERE id = :lp_id AND org_id = :org_id;

-- Pick list completion
UPDATE pick_lists SET
  status = 'completed',
  completed_at = NOW()
WHERE id = :pick_list_id AND org_id = :org_id;

-- Sales order status update (if all pick lists completed)
UPDATE sales_orders SET
  status = CASE
    WHEN (quantity_picked = quantity_ordered) THEN 'packing'
    WHEN (quantity_picked < quantity_ordered) THEN 'partial'
    ELSE status
  END
WHERE id = :so_id;
```

### Frontend Components

```typescript
// apps/frontend/app/(authenticated)/shipping/pick-lists/[id]/pick/page.tsx
// Main pick confirmation page

import { PickConfirmationHeader } from './components/PickConfirmationHeader';
import { PickLineCard } from './components/PickLineCard';
import { ShortPickModal } from './components/ShortPickModal';
import { PickProgressBar } from './components/PickProgressBar';

export default async function PickConfirmationPage({ params }: { params: { id: string } }) {
  // Fetch pick list with lines
  // Validate user is assigned picker or Warehouse+
  // Track current line index (useState)
  // Handle pick confirmation, short pick, navigation
}

// components/PickConfirmationHeader.tsx
export function PickConfirmationHeader({ pickList }: { pickList: PickList }) {
  // Display: PL number, type, priority, assigned picker
  // "Complete Pick List" button (disabled until all lines picked/short)
}

// components/PickLineCard.tsx
export function PickLineCard({
  line,
  onPickConfirm,
  onShortPick
}: {
  line: PickListLine;
  onPickConfirm: (qty: number) => void;
  onShortPick: (qty: number) => void;
}) {
  // Display location, product, lot, LP barcode, allergen warning
  // Quantity input (default = quantity_to_pick, editable)
  // "Confirm Pick" button (primary)
  // "Short Pick" button (secondary)
  // Validation: qty <= quantity_to_pick
}

// components/ShortPickModal.tsx
export function ShortPickModal({
  isOpen,
  onClose,
  onConfirm
}: {
  isOpen: boolean;
  onClose: () => void;
  onConfirm: (reason: string, notes?: string) => void;
}) {
  // Reason dropdown (required)
  // Notes textarea (optional)
  // "Confirm Short Pick" button
  // "Cancel" button
}

// components/PickProgressBar.tsx
export function PickProgressBar({
  totalLines,
  pickedLines,
  shortLines
}: {
  totalLines: number;
  pickedLines: number;
  shortLines: number;
}) {
  // Progress bar (0-100%)
  // Text: "Picked X of Y lines (Z%)"
  // Breakdown: "X picked, Y short picks"
}

// components/AllergenWarningBanner.tsx
export function AllergenWarningBanner({
  product,
  customerRestrictions
}: {
  product: Product;
  customerRestrictions: string[];
}) {
  // Check for allergen conflicts
  // Display red warning banner if conflict
  // Require checkbox acknowledgment before enabling "Confirm Pick"
}

// components/LPBarcodeDisplay.tsx
export function LPBarcodeDisplay({ lpNumber }: { lpNumber: string }) {
  // Display LP number (large font)
  // Generate CODE128 barcode image (using barcode library)
  // "Scan LP" instruction text
}
```

### Services

```typescript
// lib/services/pick-confirmation-service.ts
import { supabase } from '@/lib/supabase/client';
import { getOrgId, getUserId } from '@/lib/auth/context';

export class PickConfirmationService {
  /**
   * Start pick list (status: assigned → in_progress)
   */
  static async startPickList(pickListId: string): Promise<void> {
    const org_id = await getOrgId();
    const user_id = await getUserId();

    // Validate user is assigned picker or has Warehouse+ role
    const { data: pickList } = await supabase
      .from('pick_lists')
      .select('assigned_to')
      .eq('id', pickListId)
      .eq('org_id', org_id)
      .single();

    const userRole = await this.getUserRole(user_id);
    const canAccess = pickList.assigned_to === user_id ||
                      ['Warehouse', 'Manager', 'Admin'].includes(userRole);

    if (!canAccess) {
      throw new Error('Access denied. Not assigned to this pick list.');
    }

    const { error } = await supabase
      .from('pick_lists')
      .update({
        status: 'in_progress',
        started_at: new Date().toISOString()
      })
      .eq('id', pickListId)
      .eq('org_id', org_id)
      .in('status', ['assigned', 'pending']);

    if (error) throw error;
  }

  /**
   * Confirm pick (full quantity)
   */
  static async confirmPick(params: {
    pickListId: string;
    lineId: string;
    quantityPicked: number;
    pickedLicensePlateId: string;
  }): Promise<void> {
    const org_id = await getOrgId();
    const user_id = await getUserId();

    // 1. Fetch pick line with allocations
    const { data: line } = await supabase
      .from('pick_list_lines')
      .select(`
        *,
        sales_order_line:sales_order_lines(*),
        license_plate:license_plates(*)
      `)
      .eq('id', params.lineId)
      .eq('org_id', org_id)
      .single();

    if (!line) throw new Error('Pick line not found');

    // 2. Validate quantity
    if (params.quantityPicked > line.quantity_to_pick) {
      throw new Error(`Cannot pick more than allocated quantity (${line.quantity_to_pick})`);
    }

    // 3. Start transaction
    const { error: lineError } = await supabase
      .from('pick_list_lines')
      .update({
        quantity_picked: params.quantityPicked,
        picked_license_plate_id: params.pickedLicensePlateId,
        status: 'picked',
        picked_at: new Date().toISOString(),
        picked_by: user_id
      })
      .eq('id', params.lineId)
      .eq('org_id', org_id);

    if (lineError) throw lineError;

    // 4. Update inventory_allocations
    await supabase
      .from('inventory_allocations')
      .update({ quantity_picked: params.quantityPicked })
      .eq('sales_order_line_id', line.sales_order_line_id)
      .eq('license_plate_id', line.license_plate_id);

    // 5. Update sales_order_lines
    await supabase.rpc('increment_so_line_qty_picked', {
      so_line_id: line.sales_order_line_id,
      qty: params.quantityPicked
    });

    // 6. Update license_plates (decrement on_hand)
    await supabase.rpc('decrement_lp_quantity', {
      lp_id: params.pickedLicensePlateId,
      qty: params.quantityPicked
    });
  }

  /**
   * Confirm short pick (partial quantity)
   */
  static async confirmShortPick(params: {
    pickListId: string;
    lineId: string;
    quantityPicked: number;
    reason: string;
    notes?: string;
  }): Promise<{ backorderCreated: boolean; backorderQuantity?: number }> {
    const org_id = await getOrgId();
    const user_id = await getUserId();

    // Similar to confirmPick but:
    // - status = 'short'
    // - Check if backorder needed
    // - Create backorder_lines record (if Epic 03 Planning available)

    const { data: line } = await supabase
      .from('pick_list_lines')
      .select(`
        *,
        sales_order_line:sales_order_lines(quantity_ordered, quantity_picked)
      `)
      .eq('id', params.lineId)
      .eq('org_id', org_id)
      .single();

    if (!line) throw new Error('Pick line not found');

    // Update pick_list_lines
    await supabase
      .from('pick_list_lines')
      .update({
        quantity_picked: params.quantityPicked,
        status: 'short',
        picked_at: new Date().toISOString(),
        picked_by: user_id,
        notes: `${params.reason}${params.notes ? ' - ' + params.notes : ''}`
      })
      .eq('id', params.lineId)
      .eq('org_id', org_id);

    // Update allocations, SO lines, LPs (same as confirmPick)
    // ... (similar updates)

    // Check if backorder needed
    const shortQty = line.quantity_to_pick - params.quantityPicked;
    const totalPicked = line.sales_order_line.quantity_picked + params.quantityPicked;
    const backorderNeeded = totalPicked < line.sales_order_line.quantity_ordered;

    if (backorderNeeded) {
      // Create backorder signal (future Epic 03 integration)
      // For now, just flag the SO line
      await supabase
        .from('sales_order_lines')
        .update({ backorder_quantity: shortQty })
        .eq('id', line.sales_order_line_id);

      return { backorderCreated: true, backorderQuantity: shortQty };
    }

    return { backorderCreated: false };
  }

  /**
   * Complete pick list
   */
  static async completePickList(pickListId: string): Promise<{
    totalPicked: number;
    totalShort: number;
  }> {
    const org_id = await getOrgId();

    // 1. Fetch all lines
    const { data: lines } = await supabase
      .from('pick_list_lines')
      .select('status')
      .eq('pick_list_id', pickListId)
      .eq('org_id', org_id);

    // 2. Validate all lines picked or short
    const allCompleted = lines?.every(line =>
      ['picked', 'short'].includes(line.status)
    );

    if (!allCompleted) {
      throw new Error('Cannot complete pick list. Some lines are still pending.');
    }

    // 3. Count picked vs short
    const pickedCount = lines.filter(l => l.status === 'picked').length;
    const shortCount = lines.filter(l => l.status === 'short').length;

    // 4. Update pick_lists status
    await supabase
      .from('pick_lists')
      .update({
        status: 'completed',
        completed_at: new Date().toISOString()
      })
      .eq('id', pickListId)
      .eq('org_id', org_id);

    // 5. Update sales_order status (if all lines fully picked)
    const { data: pickList } = await supabase
      .from('pick_lists')
      .select('sales_order_id')  // Assuming we track this
      .eq('id', pickListId)
      .single();

    // Check if SO is fully picked
    const { data: soLines } = await supabase
      .from('sales_order_lines')
      .select('quantity_ordered, quantity_picked')
      .eq('sales_order_id', pickList.sales_order_id);

    const fullyPicked = soLines?.every(line =>
      line.quantity_picked >= line.quantity_ordered
    );

    if (fullyPicked) {
      await supabase
        .from('sales_orders')
        .update({ status: 'packing' })
        .eq('id', pickList.sales_order_id);
    } else {
      await supabase
        .from('sales_orders')
        .update({ status: 'partial' })
        .eq('id', pickList.sales_order_id);
    }

    return { totalPicked: pickedCount, totalShort: shortCount };
  }

  /**
   * Get user role (helper)
   */
  private static async getUserRole(userId: string): Promise<string> {
    const { data } = await supabase
      .from('users')
      .select('role')
      .eq('id', userId)
      .single();

    return data?.role || 'Picker';
  }
}
```

### Validation (Zod)

```typescript
// lib/validation/pick-confirmation-schema.ts
import { z } from 'zod';

export const confirmPickSchema = z.object({
  quantity_picked: z.number().positive('Quantity must be positive'),
  picked_license_plate_id: z.string().uuid('Invalid license plate ID')
});

export const shortPickSchema = z.object({
  quantity_picked: z.number().positive('Quantity must be positive'),
  reason: z.enum([
    'insufficient_inventory',
    'damaged',
    'expired',
    'location_empty',
    'quality_hold',
    'other'
  ]),
  notes: z.string().max(500).optional()
});

export type ConfirmPickInput = z.infer<typeof confirmPickSchema>;
export type ShortPickInput = z.infer<typeof shortPickSchema>;
```

### Key Business Rules

1. **Permission**: Only assigned picker or Warehouse+ roles can confirm picks
2. **Quantity Validation**: Cannot pick more than quantity_to_pick
3. **Status Workflow**: pending/assigned → in_progress → completed
4. **Cascade Updates**: Pick confirmation updates 4 tables (pick_list_lines, inventory_allocations, sales_order_lines, license_plates)
5. **Short Pick**: Requires reason selection, creates backorder if SO partially fulfilled
6. **Allergen Warning**: Display alert if product allergens match customer restrictions
7. **LP Barcode**: Display barcode for scanner users (but workflow is desktop-based)
8. **Completion Validation**: All lines must be 'picked' or 'short' before completing pick list
9. **SO Status Update**: Fully picked → 'packing', Partially picked → 'partial'
10. **RLS Enforcement**: All queries filtered by org_id

---

## Food Safety Rules

### Allergen Validation

- Check `customer.allergen_restrictions` (from sales_order → customer)
- For each pick line product, check `products.allergens`
- If conflict detected:
  - Display AllergenWarningBanner (red, prominent)
  - Require picker acknowledgment (checkbox) before confirming pick
  - Log acknowledgment in audit trail (picked_by + timestamp)
- Separate allergen products warning (suggest different pick container)

### FIFO/FEFO Enforcement

- Pick lines already sorted by lot (oldest first) from Story 07.7 allocation
- Display lot_number and expiry date (best_before_date) in PickLineCard
- Visual indicator if picking oldest lot (green checkmark)
- Warning if not picking oldest lot (orange alert, but allow override)

---

## GS1 Compliance

### LP Barcode Display

- Display license_plate.lp_number as CODE128 barcode
- Scannable with handheld scanner (for hybrid desktop/scanner users)
- Human-readable LP number (large font, above barcode)
- If picker has scanner, they can scan barcode to auto-fill LP field
- If no scanner, visual verification only

---

## Deliverables

### API Routes
- `apps/frontend/app/api/shipping/pick-lists/[id]/start/route.ts` (POST)
- `apps/frontend/app/api/shipping/pick-lists/[id]/lines/[lineId]/pick/route.ts` (PUT)
- `apps/frontend/app/api/shipping/pick-lists/[id]/lines/[lineId]/short-pick/route.ts` (POST)
- `apps/frontend/app/api/shipping/pick-lists/[id]/complete/route.ts` (POST)

### Services
- `lib/services/pick-confirmation-service.ts`

### Validation
- `lib/validation/pick-confirmation-schema.ts`

### Frontend Pages
- `apps/frontend/app/(authenticated)/shipping/pick-lists/[id]/pick/page.tsx`

### Components
- `apps/frontend/app/(authenticated)/shipping/pick-lists/[id]/pick/components/PickConfirmationHeader.tsx`
- `apps/frontend/app/(authenticated)/shipping/pick-lists/[id]/pick/components/PickLineCard.tsx`
- `apps/frontend/app/(authenticated)/shipping/pick-lists/[id]/pick/components/ShortPickModal.tsx`
- `apps/frontend/app/(authenticated)/shipping/pick-lists/[id]/pick/components/PickProgressBar.tsx`
- `apps/frontend/app/(authenticated)/shipping/pick-lists/[id]/pick/components/AllergenWarningBanner.tsx`
- `apps/frontend/app/(authenticated)/shipping/pick-lists/[id]/pick/components/LPBarcodeDisplay.tsx`

### Database Functions
- `supabase/migrations/YYYYMMDDHHMMSS_add_pick_confirmation_functions.sql`
  - `increment_so_line_qty_picked(so_line_id, qty)` RPC function
  - `decrement_lp_quantity(lp_id, qty)` RPC function

### Tests
- `lib/services/__tests__/pick-confirmation-service.test.ts` (unit tests)
- `tests/e2e/shipping/pick-confirmation-desktop.spec.ts` (E2E tests)

---

## Definition of Done

- [ ] POST /api/shipping/pick-lists/:id/start updates status to 'in_progress'
- [ ] PUT /api/shipping/pick-lists/:id/lines/:lineId/pick updates 4 tables (pick_list_lines, allocations, SO lines, LPs)
- [ ] POST /api/shipping/pick-lists/:id/lines/:lineId/short-pick records partial pick with reason
- [ ] POST /api/shipping/pick-lists/:id/complete validates all lines picked/short
- [ ] PickConfirmationPage displays current line with location, product, lot, LP barcode
- [ ] PickLineCard has editable quantity input (default = quantity_to_pick)
- [ ] ShortPickModal requires reason selection (dropdown)
- [ ] PickProgressBar updates in real-time (X of Y lines picked)
- [ ] AllergenWarningBanner displays if product allergens conflict with customer restrictions
- [ ] LPBarcodeDisplay shows CODE128 barcode + human-readable LP number
- [ ] Validation: Cannot pick more than quantity_to_pick
- [ ] Permission check: Only assigned picker or Warehouse+ can access
- [ ] Backorder created if short pick results in partial SO fulfillment
- [ ] SO status updates to 'packing' if fully picked, 'partial' if not
- [ ] RLS policies enforce multi-tenant isolation
- [ ] Unit tests pass (>80% coverage for PickConfirmationService)
- [ ] E2E test: Start pick list → Pick all lines → Complete → Verify SO status = 'packing'
- [ ] E2E test: Short pick → Verify backorder created + reason recorded
- [ ] E2E test: Allergen warning displayed → Require acknowledgment before pick
- [ ] Multi-tenant isolation verified (Org A cannot pick Org B's lists)

---

## Future Phases (Not in This Story)

### Phase 1B (Story 07.10)
- Scanner UI workflow (mobile-first, touch targets, audio feedback)
- Barcode scanning for location, LP, product validation
- Offline support (PWA sync on reconnect)

### Phase 2
- Pick list cancellation workflow
- Route optimization display (TSP algorithm)
- Wave picking UI enhancements (consolidation view)

### Phase 3
- Pick performance metrics (lines/hour, accuracy tracking)
- Pick time estimation (ML-based)
- Heatmaps (most-picked locations)

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-12-16 | Initial story creation | PM-AGENT |
