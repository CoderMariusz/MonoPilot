# Story 07.3 - Index File (Entry Point)
# Generated: 2025-12-18
# Purpose: Story metadata and dependencies - read this first

story:
  id: "07.3"
  name: "Sales Order Status Workflow + Hold/Cancel"
  slug: "so-status-workflow"
  epic: "07-shipping"
  phase: "1A"
  complexity: "M"
  estimate_days: 2
  type: "backend + frontend"
  state: "ready"

# Files in this context folder
context_files:
  - _index.yaml      # This file - metadata, dependencies
  - database.yaml    # Tables, enums, RLS, seed data
  - api.yaml         # Endpoints, auth, errors, services
  - frontend.yaml    # Components, types, hooks
  - tests.yaml       # Acceptance criteria, test specs

# Dependencies
dependencies:
  required:
    - story: "01.1"
      name: "Org Context + Base RLS"
      provides: ["organizations", "users", "roles", "RLS patterns"]
    - story: "07.1"
      name: "Customers CRUD"
      provides: ["customers table", "customer service"]
    - story: "07.2"
      name: "Sales Orders CRUD"
      provides: ["sales_orders table", "SO service", "base status workflow"]
    - story: "02.1"
      name: "Products CRUD"
      provides: ["products table"]
  blocked_by: []
  blocks:
    - story: "07.4"
      name: "Inventory Allocation"
      reason: "Hold status prevents allocation"
    - story: "07.5"
      name: "Pick List Generation"
      reason: "Cannot create picks for cancelled orders"
    - story: "07.15"
      name: "Shipping Dashboard"
      reason: "Status counts for KPIs"

# Reference Documents
files_to_read:
  prd:
    path: "docs/1-BASELINE/product/modules/shipping.md"
    sections: ["FR-7.11 SO Status Workflow", "FR-7.13 SO Hold", "FR-7.17 SO Cancellation", "Section 6.2 Status Workflows"]
  architecture:
    path: "docs/1-BASELINE/architecture/modules/shipping.md"
    sections: ["Database Schema", "Sales Order Status Workflow", "Business Rules"]
  story:
    path: "docs/2-MANAGEMENT/epics/current/07-shipping/07.3.so-status-workflow.md"
  wireframes:
    - path: "SHIP-007-sales-order-detail.md"
      relevance: "SO detail page with status badge and timeline"
    - path: "SHIP-009-so-confirmation-hold.md"
      relevance: "Hold dialog and status transitions"
  adrs:
    - path: "docs/1-BASELINE/architecture/decisions/ADR-013-rls-org-isolation-pattern.md"
      relevance: "RLS pattern for sales_orders org isolation"

# High-level deliverables
deliverables:
  - type: "migration"
    count: 1
    description: "Add 'on_hold' to sales_order_status enum, create index"
  - type: "service"
    count: 1
    description: "sales-order-service.ts - holdOrder(), cancelOrder() methods"
  - type: "api"
    count: 2
    description: "POST /hold, POST /cancel endpoints with auth & validation"
  - type: "component"
    count: 4
    description: "SOStatusBadge, SOStatusTimeline, HoldOrderDialog, CancelOrderDialog"
  - type: "validation"
    count: 1
    description: "hold/cancel order schemas"
  - type: "test"
    count: 3
    description: "Unit + integration + e2e tests"

# Technical notes
technical_notes:
  - "Extends sales_orders table from Story 07.2"
  - "Enum: draft, confirmed, on_hold, cancelled, allocated, picking, packing, shipped, delivered"
  - "Status transitions: draft/confirmed -> on_hold/cancelled, on_hold -> confirmed/cancelled"
  - "Hold: optional reason, appended to notes. Cancel: required reason"
  - "Role-based: Sales can hold, Manager/Admin can cancel"
  - "Updated_at always changed. Notes field contains timestamp + reason"
  - "Cascade: cancelled status releases allocations (Story 07.7)"
