database_schema:
  organization_changes:
    table: "organizations"
    existing_table: true
    description: "Add SSCC support columns to organizations table"

    columns_to_add:
      gs1_company_prefix:
        type: "TEXT"
        nullable: true
        default: null
        constraint: "CHECK (gs1_company_prefix IS NULL OR gs1_company_prefix ~ '^\\d{7,10}$')"
        description: |
          GS1 Company Prefix (7-10 digits)
          - Assigned by GS1 organization
          - Globally unique identifier for organization
          - Required to enable SSCC generation
          - Format: numeric only, 7-10 digits

        example_values:
          - "0614141"      # 7 digits
          - "10614141"     # 10 digits

        business_logic:
          - "Must be configured in Organization Settings before SSCC can be generated"
          - "If NULL, generate-sscc endpoint returns error GS1_PREFIX_NOT_CONFIGURED"
          - "Used in SSCC algorithm: GS1_PREFIX + SERIAL_REFERENCE = middle 16-19 digits"

      next_sscc_sequence:
        type: "BIGINT"
        nullable: false
        default: 1
        description: |
          Auto-incrementing sequence for SSCC serial reference numbers
          - Incremented for each SSCC generated for this organization
          - Per-organization counter (resets per org, not globally)
          - Used to ensure uniqueness combined with GS1 prefix

        business_logic:
          - "Incremented atomically using SELECT FOR UPDATE to prevent duplicates"
          - "Padded to fill remaining SSCC digits (17 - 1 extension - prefix_length)"
          - "Never decremented, always monotonically increasing"
          - "Database transaction serialization ensures no gaps or duplicates"

    migration_sql: |
      ALTER TABLE organizations
      ADD COLUMN IF NOT EXISTS gs1_company_prefix TEXT
        CONSTRAINT chk_gs1_prefix_format
        CHECK (gs1_company_prefix IS NULL OR gs1_company_prefix ~ '^\d{7,10}$'),
      ADD COLUMN IF NOT EXISTS next_sscc_sequence BIGINT DEFAULT 1;

  shipment_boxes_changes:
    table: "shipment_boxes"
    existing_table: true
    description: "Verify and enhance SSCC support in shipment_boxes"

    existing_columns:
      sscc:
        type: "TEXT"
        nullable: true
        current_constraint: "UNIQUE(sscc)"
        description: |
          SSCC-18 barcode (18 digits)
          - Globally unique across all organizations
          - Generated by generate-sscc endpoint
          - GS1 compliant format with check digit
          - Immutable once assigned (set once, never changed)

        format: "XXXXXXXXXXXXXXXXXX (18 digits)"
        example: "006141410000123452"

      weight:
        type: "DECIMAL(10,3)"
        nullable: true
        unit: "kilograms (kg)"
        constraint: "CHECK(weight > 0 OR weight IS NULL)"
        required_for:
          - "BOL PDF generation"
          - "Packing completion"
          - "Freight calculation"

      length:
        type: "DECIMAL(10,2)"
        nullable: true
        unit: "centimeters (cm)"
        constraint: "CHECK(length > 0 OR length IS NULL)"
        range: "10-200 cm"
        description: "Length of box for freight calculation"

      width:
        type: "DECIMAL(10,2)"
        nullable: true
        unit: "centimeters (cm)"
        constraint: "CHECK(width > 0 OR width IS NULL)"
        range: "10-200 cm"
        description: "Width of box for freight calculation"

      height:
        type: "DECIMAL(10,2)"
        nullable: true
        unit: "centimeters (cm)"
        constraint: "CHECK(height > 0 OR height IS NULL)"
        range: "10-200 cm"
        description: "Height of box for freight calculation"

    indexes_to_verify:
      idx_shipment_boxes_sscc:
        definition: "CREATE INDEX idx_shipment_boxes_sscc ON shipment_boxes(sscc) WHERE sscc IS NOT NULL"
        purpose: "Fast lookup by SSCC barcode for label printing"
        migration_sql: |
          CREATE INDEX IF NOT EXISTS idx_shipment_boxes_sscc
          ON shipment_boxes(sscc) WHERE sscc IS NOT NULL;

  database_functions:
    generate_sscc_for_org:
      language: "PL/pgSQL"
      description: "Generate SSCC-18 for organization with atomic sequence increment"

      parameters:
        org_uuid:
          type: "UUID"
          description: "Organization ID"

        extension_digit:
          type: "TEXT"
          default: "'0'"
          description: "Extension digit: 0=carton, 9=pallet"

      returns: "TEXT"
      description: "18-digit SSCC barcode string"

      algorithm: |
        1. Acquire lock on organizations row for update (SELECT FOR UPDATE)
        2. Retrieve gs1_company_prefix and next_sscc_sequence atomically
        3. If gs1_prefix is NULL, raise exception "GS1 Company Prefix not configured"
        4. Increment next_sscc_sequence by 1 (UPDATE organizations)
        5. Calculate serial_length = 17 - 1 - LENGTH(gs1_prefix)
        6. Build base_digits = extension_digit || gs1_prefix || LPAD(serial_num, serial_length, '0')
        7. Calculate check_digit using calculate_gs1_check_digit(base_digits)
        8. Return base_digits || check_digit

      error_handling:
        - "Exception if gs1_prefix not configured"
        - "Exception if serial reference overflow (very rare)"
        - "Transaction rolls back on error (atomic failure)"

      example_call: |
        SELECT generate_sscc_for_org('org-uuid-123', '0')
        RETURNS: '006141410000123452'

      migration_sql: |
        CREATE OR REPLACE FUNCTION generate_sscc_for_org(
          org_uuid UUID,
          extension_digit TEXT DEFAULT '0'
        )
        RETURNS TEXT AS $$
        DECLARE
          gs1_prefix TEXT;
          serial_num BIGINT;
          base_digits TEXT;
          check_digit TEXT;
          serial_length INT;
          sscc TEXT;
        BEGIN
          -- Get GS1 prefix and increment sequence atomically
          SELECT gs1_company_prefix, next_sscc_sequence
          INTO gs1_prefix, serial_num
          FROM organizations
          WHERE id = org_uuid
          FOR UPDATE;

          IF gs1_prefix IS NULL THEN
            RAISE EXCEPTION 'GS1 Company Prefix not configured for organization';
          END IF;

          -- Update sequence
          UPDATE organizations
          SET next_sscc_sequence = next_sscc_sequence + 1
          WHERE id = org_uuid;

          -- Calculate serial length (17 - 1 extension - prefix length)
          serial_length := 17 - 1 - LENGTH(gs1_prefix);

          -- Build base (17 digits)
          base_digits := extension_digit || gs1_prefix ||
                         LPAD(serial_num::TEXT, serial_length, '0');

          -- Calculate check digit (MOD 10 algorithm)
          check_digit := calculate_gs1_check_digit(base_digits);

          sscc := base_digits || check_digit;

          RETURN sscc;
        END;
        $$ LANGUAGE plpgsql;

    calculate_gs1_check_digit:
      language: "PL/pgSQL"
      description: "Calculate GS1 MOD 10 check digit for 17-digit SSCC base"

      parameters:
        digits:
          type: "TEXT"
          length: 17
          description: "17-digit SSCC base (without check digit)"

      returns: "TEXT"
      description: "Single check digit (0-9)"

      algorithm: |
        MOD 10 Algorithm (GS1 Standard):
        1. Starting from rightmost digit, assign multipliers (odd positions = 3, even = 1)
        2. Multiply each digit by its multiplier
        3. Sum all products
        4. Check digit = (10 - (sum % 10)) % 10

        Positions (17 digits):
        Position (from right): 17 16 15 14 13 12 11 10  9  8  7  6  5  4  3  2  1
        Multiplier:            3  1  3  1  3  1  3  1  3  1  3  1  3  1  3  1  3

      example_calculation: |
        SSCC Base: 0 0614141 000012345 (17 digits)

        Position:  17 16 15 14 13 12 11 10  9  8  7  6  5  4  3  2  1
        Digit:      0  0  6  1  4  1  4  1  0  0  0  0  1  2  3  4  5
        Multiplier: 3  1  3  1  3  1  3  1  3  1  3  1  3  1  3  1  3
        Product:    0  0 18  1 12  1 12  1  0  0  0  0  3  2  9  4 15

        Sum = 0+0+18+1+12+1+12+1+0+0+0+0+3+2+9+4+15 = 78
        Check = (10 - (78 % 10)) % 10 = (10 - 8) % 10 = 2

        Full SSCC: 00614141000012345 + 2 = 006141410000123452

      migration_sql: |
        CREATE OR REPLACE FUNCTION calculate_gs1_check_digit(digits TEXT)
        RETURNS TEXT AS $$
        DECLARE
          sum_val INT := 0;
          i INT;
          digit INT;
          multiplier INT;
        BEGIN
          IF LENGTH(digits) != 17 THEN
            RAISE EXCEPTION 'SSCC base must be exactly 17 digits';
          END IF;

          FOR i IN 1..17 LOOP
            digit := CAST(SUBSTRING(digits, i, 1) AS INT);
            -- Position from right: odd = 3, even = 1
            multiplier := CASE WHEN (17 - i + 1) % 2 = 1 THEN 3 ELSE 1 END;
            sum_val := sum_val + (digit * multiplier);
          END LOOP;

          RETURN ((10 - (sum_val % 10)) % 10)::TEXT;
        END;
        $$ LANGUAGE plpgsql IMMUTABLE;

  rls_policies:
    description: |
      RLS policies enforce organization isolation for shipment data.
      All SSCC/BOL operations use org_id to filter queries.

    policies:
      shipment_boxes_org_isolation:
        table: "shipment_boxes"
        policy_name: "org_isolation"
        definition: "(auth.uid() IN (SELECT user_id FROM organization_users WHERE org_id = org_id))"
        description: "User can only access boxes for their organization"

      bol_storage_path_prefix:
        storage_bucket: "bol"
        path_format: "/bol/{org_id}/{shipment_id}.pdf"
        description: "BOL PDFs organized by org_id to ensure multi-tenant isolation"

      packing_slip_storage_path_prefix:
        storage_bucket: "packing-slip"
        path_format: "/packing-slip/{org_id}/{shipment_id}.pdf"
        description: "Packing slip PDFs organized by org_id"

constraints_and_validation:
  sscc_uniqueness:
    constraint: "UNIQUE(sscc) ON shipment_boxes"
    scope: "Global (across all organizations)"
    enforcement: "Database constraint + application validation"
    note: |
      SSCC must be globally unique because each SSCC is a unique identifier
      for a physical pallet/carton in the world. No two shipment boxes
      (across any organization) can have the same SSCC.

  gs1_prefix_format:
    constraint: "CHECK (gs1_company_prefix ~ '^\\d{7,10}$')"
    description: "GS1 prefix must be 7-10 numeric digits"
    error_if_violated: "Cannot insert organization without valid GS1 prefix"

  box_dimensions_validation:
    checks:
      - "weight > 0 OR weight IS NULL"
      - "length > 0 OR length IS NULL (if provided, 10-200 cm range)"
      - "width > 0 OR width IS NULL (if provided, 10-200 cm range)"
      - "height > 0 OR height IS NULL (if provided, 10-200 cm range)"
    enforcement: "Application validation (Zod schema) + database CHECK constraints"

  sscc_generation_prerequisites:
    - "organizations.gs1_company_prefix IS NOT NULL"
    - "shipment_boxes.weight > 0 (for all boxes)"
    - "shipment_boxes.length, width, height defined (for BOL generation)"
    - "shipment.status IN ('packed', 'manifested', 'shipped', 'delivered')"

migration_checklist:
  - "[ ] Add gs1_company_prefix column to organizations table"
  - "[ ] Add next_sscc_sequence column to organizations table"
  - "[ ] Add CHECK constraint on gs1_company_prefix format"
  - "[ ] Create generate_sscc_for_org() PL/pgSQL function"
  - "[ ] Create calculate_gs1_check_digit() PL/pgSQL function"
  - "[ ] Verify UNIQUE constraint exists on shipment_boxes.sscc"
  - "[ ] Create index on shipment_boxes(sscc) WHERE sscc IS NOT NULL"
  - "[ ] Test atomicity of SSCC generation (no concurrent duplicates)"
  - "[ ] Test MOD 10 algorithm with known good values"
  - "[ ] Test RLS policies prevent cross-org access"

performance_considerations:
  sscc_generation:
    atomicity: "SELECT FOR UPDATE on organizations row prevents duplicate sequences"
    latency: "<100ms per SSCC generated"
    bottleneck: "Serialization on organizations.next_sscc_sequence (accept for correctness)"

  sscc_lookup:
    index: "idx_shipment_boxes_sscc on (sscc)"
    lookup_time: "<1ms for single SSCC lookup"
    use_case: "Print label preview, validate SSCC exists"

  box_filtering:
    index: "idx_shipment_boxes_shipment on (shipment_id)"
    batch_query: "<10ms to fetch all boxes for shipment"
    use_case: "Generate SSCC for all boxes, BOL generation"

version_history:
  - version: "1.0"
    date: "2025-12-18"
    changes: "Database schema specifications for Story 07.13 SSCC/BOL labels"
    author: "TECH-WRITER"
