# Story 07.8 - Acceptance Criteria Mapping

## Overview

This document maps the 10 acceptance criteria (AC-1 through AC-10) from Story 07.8 to implementation requirements, test cases, and deliverables.

---

## AC-1: Auto-Generate Pick List Number

### Requirement
Generate unique pick_list_number in format **PL-YYYY-NNNNN** (e.g., PL-2025-00042)
- Sequence increments per org (not global)
- Number stored in pick_lists.pick_list_number

### Implementation
**Database Function:**
```sql
CREATE OR REPLACE FUNCTION generate_pick_list_number(org_uuid UUID)
RETURNS TEXT AS $$
DECLARE
  next_seq INTEGER;
  year_str TEXT;
BEGIN
  year_str := TO_CHAR(CURRENT_DATE, 'YYYY');

  SELECT COALESCE(MAX(
    CAST(SUBSTRING(pick_list_number FROM 9) AS INTEGER)
  ), 0) + 1 INTO next_seq
  FROM pick_lists
  WHERE org_id = org_uuid
    AND pick_list_number LIKE 'PL-' || year_str || '-%';

  RETURN 'PL-' || year_str || '-' || LPAD(next_seq::TEXT, 5, '0');
END;
$$ LANGUAGE plpgsql;
```

**Service Call:**
```typescript
// In PickListService.createPickList()
const { data: numberData } = await supabase.rpc('generate_pick_list_number', {
  org_uuid: org_id
});
```

### Test Cases
1. **Unit Test**: Call generate_pick_list_number() 10 times → Verify sequence increments 1-10
2. **Unit Test**: Test with different org_id → Verify per-org sequence isolation
3. **Unit Test**: Test year boundary (Dec 31 → Jan 1) → Verify sequence resets
4. **Integration Test**: Create 5 pick lists in same org → Verify pick_list_number format PL-YYYY-NNNNN
5. **Integration Test**: Create pick lists in 2 different orgs → Verify independent sequences

### Deliverable
- Database migration creating generate_pick_list_number() function
- PickListService.createPickList() calls RPC function
- Unit tests covering numbering logic (>90% coverage)

---

## AC-2: Create Pick List from Single Sales Order

### Requirement
Create pick_list record from confirmed SO with inventory_allocations
- pick_type = 'single_order'
- status = 'pending'
- priority = 'normal' (default)
- created_by = current user
- Generate pick_list_lines from inventory_allocations
- Update sales_order.status to 'picking'

### Implementation

**API Endpoint:**
```typescript
POST /api/shipping/pick-lists
Body: {
  sales_order_ids: ["uuid-so-1"],
  priority?: "low" | "normal" | "high" | "urgent",
  assigned_to?: "uuid-user-1"
}
Response: {
  pick_list_id: string;
  pick_list_number: string;
  line_count: number;
}
```

**Service Method:**
```typescript
// lib/services/pick-list-service.ts
async createPickList(params: {
  sales_order_ids: string[];
  priority?: string;
  assigned_to?: string;
}): Promise<{ pick_list_id: string; pick_list_number: string }> {
  // 1. Validate: sales_orders exist and status = 'confirmed'
  // 2. Determine pick_type: 'single_order' if 1 SO, 'wave' if 2+
  // 3. Call generate_pick_list_number(org_id)
  // 4. Create pick_lists record
  // 5. Fetch inventory_allocations for these sales orders
  // 6. Create pick_list_lines (1 per allocation)
  // 7. Update sales_orders.status = 'picking'
  // 8. Return pick_list_id and pick_list_number
}
```

### Test Cases
1. **Acceptance Test**: Create SO with 3 lines → Allocate inventory → Create pick list
   - Verify pick_list created with status='pending'
   - Verify pick_type='single_order'
   - Verify 3 pick_list_lines created (1 per allocation)
   - Verify sales_order.status updated to 'picking'

2. **Error Test**: Try to create from draft SO → Expect error "SO must be confirmed"

3. **Error Test**: Try to create from SO with no allocations → Expect error "No allocations found"

4. **Integration Test**: Create pick list → Verify SO detail page shows pick list link

### Deliverable
- POST /api/shipping/pick-lists route with validation
- PickListService.createPickList() method
- Integration tests for single-order creation
- Error handling for invalid SO status

---

## AC-3: Generate Pick Lines with Location-Based Sequencing

### Requirement
Lines sorted by location hierarchy:
1. **Zone** (alphabetical: Chilled → Dry → Frozen)
2. **Aisle** (numeric/alphabetical)
3. **Bin** (numeric/alphabetical)
- pick_sequence assigned as integer (1, 2, 3, ...)
- Picker follows sequence to minimize warehouse travel

### Implementation

**Sorting Logic:**
```typescript
// PickListService.sortByLocation()
private static sortByLocation(allocations: any[], locations: any[]): any[] {
  const locationMap = new Map(locations.map(loc => [loc.id, loc]));

  return allocations.sort((a, b) => {
    const locA = locationMap.get(a.license_plates.location_id);
    const locB = locationMap.get(b.license_plates.location_id);

    // Sort by zone (alphabetical)
    if (locA.zone !== locB.zone) {
      return locA.zone.localeCompare(locB.zone);
    }

    // Sort by aisle (alphanumeric)
    if (locA.aisle !== locB.aisle) {
      return locA.aisle.localeCompare(locB.aisle, undefined, { numeric: true });
    }

    // Sort by bin (alphanumeric)
    return locA.bin.localeCompare(locB.bin, undefined, { numeric: true });
  });
}
```

**Data Structure:**
```sql
-- Locations table (from Epic 01/05)
locations:
  id: uuid
  org_id: uuid
  zone: TEXT ('Chilled', 'Dry', 'Frozen')
  aisle: TEXT ('A1', 'A2', 'B1')
  bin: TEXT ('01', '02', '03')
  name: TEXT ('Chilled A1-01')
```

### Test Cases
1. **Unit Test**: Sort 6 allocations across 3 zones
   - Input: Dry B1, Frozen A1, Chilled A2, Dry A1, Chilled A1, Frozen B1
   - Expected: Chilled A1, Chilled A2, Dry A1, Dry B1, Frozen A1, Frozen B1
   - Verify pick_sequence: 1-6

2. **Unit Test**: Alphanumeric sorting within same zone
   - Input: Zone 'Chilled', Aisles A1, A2, A10, A3, A20
   - Expected order: A1, A2, A3, A10, A20 (numeric sort, not lexicographic)

3. **Integration Test**: Create pick list with mixed zones
   - Verify PickLinesTable displays with zone headers
   - Verify pick_sequence increments correctly
   - Verify picker UI shows optimal route

### Deliverable
- PickListService.sortByLocation() method
- Database indexes on location (zone, aisle, bin)
- PickLinesTable.tsx component grouping by location
- Unit tests for sorting logic
- E2E test showing pick sequence in detail page

---

## AC-4: Create Wave Pick List from Multiple Sales Orders

### Requirement
Create pick_list from 3+ confirmed SOs:
- pick_type = 'wave'
- status = 'pending'
- wave_id = unique identifier
- Consolidate lines with same product + location (sum quantities)
- Sort by location hierarchy (pick_sequence)
- Update all SOs' status to 'picking'

### Implementation

**API Endpoint:**
```typescript
POST /api/shipping/pick-lists
Body: {
  sales_order_ids: ["uuid-so-1", "uuid-so-2", "uuid-so-3"],
  priority?: "normal"
}
// System detects 2+ SOs → sets pick_type='wave'
```

**Consolidation Logic:**
```typescript
// Group allocations by (product_id, location_id) and sum quantities
const consolidated = allocations.reduce((acc, alloc) => {
  const key = `${alloc.product_id}:${alloc.location_id}`;
  if (!acc[key]) {
    acc[key] = {
      ...alloc,
      quantity_allocated: 0
    };
  }
  acc[key].quantity_allocated += alloc.quantity_allocated;
  return acc;
}, {});

// Sort consolidated lines by location hierarchy
const sortedConsolidated = sortByLocation(Object.values(consolidated));

// Assign pick_sequence 1, 2, 3, ...
const pickLines = sortedConsolidated.map((line, index) => ({
  ...line,
  pick_sequence: index + 1
}));
```

### Test Cases
1. **E2E Test**: Wave Picking Workflow
   - Create 3 SOs with overlapping products in same location
   - Example:
     - SO1: Product A (100 units, Location Chilled A1)
     - SO2: Product A (50 units, Location Chilled A1)
     - SO3: Product B (75 units, Location Dry B1)
   - Expected consolidated lines:
     - Line 1: Product A, 150 units, Chilled A1, Seq 1
     - Line 2: Product B, 75 units, Dry B1, Seq 2
   - Verify pick_list_type='wave'
   - Verify all 3 SOs updated to status='picking'

2. **Unit Test**: Consolidation logic
   - Input: 6 allocations from 3 SOs
   - Verify only 2 consolidated lines (Product A and B)
   - Verify quantities summed correctly

3. **Integration Test**: Wave detail page
   - Verify PickLinesTable shows consolidated lines
   - Verify pick_sequence correct (1, 2)
   - Verify clicking SO link shows source orders

### Deliverable
- Wave picking detection (sales_order_ids.length > 1)
- Consolidation algorithm in PickListService
- wave_id generation (UUID)
- PickLinesTable grouping for wave (show consolidated qty + source SOs)
- E2E tests for wave picking workflow

---

## AC-5: Assign Pick List to Picker

### Requirement
Update pick_list.assigned_to with selected user:
- Only for pending status
- Update pick_list.status = 'assigned'
- Pick list appears in picker's "My Picks" view
- Only users with Picker, Warehouse, Manager, or Admin role eligible

### Implementation

**API Endpoint:**
```typescript
POST /api/shipping/pick-lists/:id/assign
Body: { assigned_to: "uuid-user-1" }
Response: { status: "assigned", assigned_to: "John Smith" }
```

**Service Method:**
```typescript
async assignPicker(pickListId: string, userId: string): Promise<void> {
  const org_id = await getOrgId();

  const { error } = await supabase
    .from('pick_lists')
    .update({
      assigned_to: userId,
      status: 'assigned'
    })
    .eq('id', pickListId)
    .eq('org_id', org_id)
    .eq('status', 'pending');  // Only assign pending lists

  if (error) throw error;
}
```

**Component (AssignPickerModal):**
```typescript
export function AssignPickerModal({ pickListId, onSuccess }: Props) {
  const [selectedUser, setSelectedUser] = useState<string>('');
  const { data: pickers } = useQuery({
    queryKey: ['pickers'],
    queryFn: async () => {
      return supabase
        .from('users')
        .select('id, name')
        .in('role', ['Picker', 'Warehouse', 'Manager', 'Admin'])
        .eq('is_active', true);
    }
  });

  const handleAssign = async () => {
    await supabase
      .rpc('assign_pick_list', { pick_list_id: pickListId, user_id: selectedUser });
    onSuccess?.();
  };

  return (
    <Dialog open={open}>
      <Select value={selectedUser} onValueChange={setSelectedUser}>
        {pickers?.map(picker => (
          <SelectItem key={picker.id} value={picker.id}>
            {picker.name}
          </SelectItem>
        ))}
      </Select>
      <Button onClick={handleAssign}>Assign</Button>
    </Dialog>
  );
}
```

### Test Cases
1. **E2E Test**: Assign Picker Workflow
   - Create pending pick list
   - Click [Assign] → AssignPickerModal opens
   - Select "John Smith" (Picker role)
   - Click [Assign] → Status updates to 'assigned'
   - Verify pick list appears in John's "My Picks" view

2. **Permissions Test**: Only Manager+ can assign
   - Login as Viewer → Try POST /api/shipping/pick-lists/:id/assign
   - Expect 403 Forbidden

3. **Validation Test**: Cannot assign non-Picker user
   - Try to assign user with role='Sales'
   - Expect validation error or user not in dropdown

4. **Error Test**: Cannot assign completed pick list
   - Try to assign pick list with status='completed'
   - Expect error "Cannot assign completed pick list"

### Deliverable
- POST /api/shipping/pick-lists/:id/assign endpoint
- AssignPickerModal component
- Role-based user filtering
- RLS policy enforcement
- E2E tests for assignment workflow

---

## AC-6: List Pick Lists with Filters

### Requirement
Display PickListTable with filters and pagination:
- Status (multi-select: pending, assigned, in_progress, completed, cancelled)
- Assigned To (user dropdown)
- Priority (low, normal, high, urgent)
- Date range (created_at)
- Sorting by any column
- Pagination (20 per page, max 50)

### Implementation

**API Endpoint:**
```typescript
GET /api/shipping/pick-lists?
  status=pending,assigned&
  assigned_to=uuid-user-1&
  priority=high&
  date_from=2025-12-01&
  date_to=2025-12-31&
  sort_by=created_at&
  sort_order=desc&
  page=1&
  limit=20

Response: {
  pick_lists: PickList[],
  total: 47,
  page: 1,
  pages: 3
}
```

**PickListTable Component:**
```typescript
<DataTable
  columns={[
    { id: 'checkbox', header: '', cell: <Checkbox /> },
    { id: 'pick_list_number', header: 'Pick List #', sortable: true },
    { id: 'so_number', header: 'SO #', sortable: true },
    { id: 'customer_name', header: 'Customer', sortable: true },
    { id: 'created_at', header: 'Created', sortable: true },
    { id: 'assigned_to', header: 'Assigned To', sortable: true },
    { id: 'status', header: 'Status', sortable: true },
    { id: 'actions', header: 'Actions' }
  ]}
  data={pickLists}
  filters={[
    { type: 'multi-select', field: 'status', options: ['pending', 'assigned', 'in_progress', 'completed', 'cancelled'] },
    { type: 'select', field: 'assigned_to', options: [...] },
    { type: 'select', field: 'priority', options: ['low', 'normal', 'high', 'urgent'] },
    { type: 'date-range', field: 'created_at' }
  ]}
  pagination={{ page: 1, limit: 20, total: 47, pages: 3 }}
/>
```

### Test Cases
1. **Filter Test**: Status = 'in_progress' → Show only active picks
2. **Filter Test**: Assigned To = 'John Smith' → Show only his picks
3. **Filter Test**: Date Range (last 7 days) → Verify filter applied
4. **Filter Test**: Combine filters (status + assigned) → AND logic
5. **Sort Test**: Click "Created" header → Sort ascending/descending
6. **Pagination Test**: Load page 2 → Verify 20 items on next page
7. **Pagination Test**: Change limit to 50 → Verify pagination recalculates
8. **Search Test**: Type "PL-2025" → Filter in real-time (debounced)

### Deliverable
- GET /api/shipping/pick-lists endpoint with filters
- PickListTable component (ShadCN DataTable)
- Filter UI (dropdowns, date pickers)
- Pagination controls
- Search bar with debounce
- E2E tests for filtering and sorting

---

## AC-7: Picker View - My Picks

### Requirement
Picker-specific view showing:
- Only pick lists where assigned_to = current user_id
- Filter to status IN ('assigned', 'in_progress')
- Sort by priority DESC, created_at ASC (urgent first, oldest first)
- "Start Picking" button for assigned lists
- "Continue" button for in_progress lists

### Implementation

**API Endpoint:**
```typescript
GET /api/shipping/pick-lists/my-picks

Response: {
  pick_lists: [
    {
      id: "uuid",
      pick_list_number: "PL-2025-00042",
      status: "assigned",
      priority: "high",
      created_at: "2025-12-15T10:30:00Z",
      line_count: 8
    }
  ]
}
```

**Service Method:**
```typescript
async getMyPicks(): Promise<PickList[]> {
  const org_id = await getOrgId();
  const user = (await supabase.auth.getUser()).data.user;

  const { data, error } = await supabase
    .from('pick_lists')
    .select('*')
    .eq('org_id', org_id)
    .eq('assigned_to', user?.id)
    .in('status', ['assigned', 'in_progress'])
    .order('priority', { ascending: false })
    .order('created_at', { ascending: true });

  if (error) throw error;
  return data || [];
}
```

**Page Component:**
```typescript
// apps/frontend/app/(authenticated)/shipping/pick-lists/my-picks/page.tsx
export default function MyPicksPage() {
  const { data: myPicks } = useQuery({
    queryKey: ['my-picks'],
    queryFn: PickListService.getMyPicks
  });

  return (
    <div className="space-y-4">
      <h1>My Picks</h1>
      {myPicks?.map(pl => (
        <Card key={pl.id}>
          <h2>{pl.pick_list_number}</h2>
          <p>Lines: {pl.line_count}</p>
          <Badge>{pl.status}</Badge>
          {pl.status === 'assigned' && (
            <Button onClick={() => router.push(`/pick-lists/${pl.id}`)}>
              Start Picking
            </Button>
          )}
          {pl.status === 'in_progress' && (
            <Button>Continue</Button>
          )}
        </Card>
      ))}
    </div>
  );
}
```

### Test Cases
1. **E2E Test**: Picker Login
   - Login as Picker user
   - Navigate to /shipping/pick-lists/my-picks
   - Verify only assigned and in_progress picks shown
   - Verify other users' picks NOT visible

2. **Priority Test**: Multiple picks with different priorities
   - User has 3 picks: normal (oldest), high (newest), urgent (middle)
   - Expected order: urgent, high, normal (priority DESC)

3. **Status Test**: Click "Start Picking" on assigned
   - Status transitions to 'in_progress'
   - Button changes to "Continue"

4. **Permissions Test**: Viewer user cannot access
   - Login as Viewer
   - Try to access /my-picks
   - Expect redirect to /shipping/pick-lists

### Deliverable
- GET /api/shipping/pick-lists/my-picks endpoint
- MyPicksPage component (/my-picks route)
- Priority + date sorting
- Status-specific action buttons
- E2E tests for picker workflow

---

## AC-8: Pick List Detail View with Pick Lines

### Requirement
Display:
- Pick list header (Pick #, Type, Status, Priority, Assigned To, Timestamps)
- PickLinesTable grouped by location (Zone → Aisle → Bin)
- Each location shows: Product, Lot, LP#, Qty to Pick, Pick Sequence
- Summary stats (Total lines, Total qty, Locations count)

### Implementation

**Page:**
```typescript
// apps/frontend/app/(authenticated)/shipping/pick-lists/[id]/page.tsx
export default function PickListDetailPage({ params }: Props) {
  const { data: pickListData } = useQuery({
    queryKey: ['pick-list', params.id],
    queryFn: () => PickListService.getPickListDetail(params.id)
  });

  return (
    <div>
      <PickListHeader pickList={pickListData?.pick_list} />
      <PickLinesTable lines={pickListData?.lines} />
      <Summary lines={pickListData?.lines} />
    </div>
  );
}
```

**PickLinesTable (Grouped by Location):**
```typescript
// Group lines by location hierarchy
const groupedLines = lines.reduce((acc, line) => {
  const zoneKey = line.location.zone;
  const aisleKey = `${zoneKey}:${line.location.aisle}`;
  const binKey = `${aisleKey}:${line.location.bin}`;

  if (!acc[zoneKey]) acc[zoneKey] = {};
  if (!acc[zoneKey][aisleKey]) acc[zoneKey][aisleKey] = {};
  if (!acc[zoneKey][aisleKey][binKey]) acc[zoneKey][aisleKey][binKey] = [];

  acc[zoneKey][aisleKey][binKey].push(line);
  return acc;
}, {});

// Render with collapsible groups
{Object.entries(groupedLines).map(([zone, aisles]) => (
  <div key={zone} className="border-l-4">
    <div className="font-bold cursor-pointer" onClick={...}>
      Zone: {zone}
    </div>
    {Object.entries(aisles).map(([aisle, bins]) => (
      <div key={aisle} className="ml-4">
        <div className="font-semibold cursor-pointer">
          Aisle: {aisle}
        </div>
        {Object.entries(bins).map(([bin, lines]) => (
          <table key={bin} className="ml-8">
            {lines.map(line => (
              <tr key={line.id}>
                <td>{line.pick_sequence}</td>
                <td>{line.product_name}</td>
                <td>{line.lot_number}</td>
                <td>{line.license_plate?.lp_number}</td>
                <td>{line.quantity_to_pick}</td>
              </tr>
            ))}
          </table>
        ))}
      </div>
    ))}
  </div>
))}
```

### Test Cases
1. **E2E Test**: View pick list detail
   - Click pick list # from table → Detail page loads
   - Header shows: PL-2025-00042, Type: single_order, Status: Assigned, John Smith
   - Lines grouped by zone (Chilled, Dry, Frozen)
   - Summary: 12 lines, 350 units, 8 locations

2. **UI Test**: Collapsible groups
   - Click zone header → Aisles collapse/expand
   - Click aisle header → Bins collapse/expand

3. **Data Test**: Pick sequence correct
   - Verify pick_sequence 1, 2, 3, ... in order
   - Verify location sorting correct (zone→aisle→bin)

### Deliverable
- GET /api/shipping/pick-lists/:id endpoint
- PickListDetailPage component
- PickListHeader component
- PickLinesTable component (grouped)
- Summary stats component
- E2E tests for detail page

---

## AC-9: RLS Policy for Multi-Tenant Isolation

### Requirement
- pick_lists.org_id = current user's org_id
- pick_list_lines.org_id = current user's org_id
- Prevent access to other orgs' pick lists via RLS policy
- Auto-populate org_id on INSERT

### Implementation

**RLS Policies:**
```sql
ALTER TABLE pick_lists ENABLE ROW LEVEL SECURITY;

CREATE POLICY "pick_lists_org_isolation" ON pick_lists
  FOR ALL USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

CREATE POLICY "pick_lists_insert" ON pick_lists
  FOR INSERT WITH CHECK (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

ALTER TABLE pick_list_lines ENABLE ROW LEVEL SECURITY;

CREATE POLICY "pick_list_lines_org_isolation" ON pick_list_lines
  FOR ALL USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

CREATE POLICY "pick_list_lines_insert" ON pick_list_lines
  FOR INSERT WITH CHECK (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));
```

**Service Method (auto-populate org_id):**
```typescript
async createPickList(params: {...}): Promise<...> {
  const org_id = await getOrgId();  // From user context

  const { data: pickList } = await supabase
    .from('pick_lists')
    .insert({
      org_id,  // Auto-populated from context
      pick_list_number: numberData,
      pick_type,
      status: 'pending',
      priority: params.priority || 'normal',
      created_by: user.id
    })
    .select()
    .single();
}
```

### Test Cases
1. **Multi-Tenant Test**: Create 2 orgs with same data
   - Org A: Create pick list PL-2025-00001
   - Org B: Create pick list PL-2025-00001 (same number, different org)
   - Verify Org A sees only their PL-2025-00001
   - Verify Org B sees only their PL-2025-00001
   - Verify Org A cannot query Org B's pick lists

2. **RLS Enforcement Test**: Direct SQL query
   - Login as Org A user
   - Try: SELECT * FROM pick_lists WHERE org_id = 'org-b-id'
   - Expect 0 rows (RLS policy blocks)

3. **Auth Test**: Unauthenticated request
   - Try: GET /api/shipping/pick-lists without token
   - Expect 401 Unauthorized

### Deliverable
- RLS policies on pick_lists and pick_list_lines
- org_id auto-population in service layer
- Integration tests verifying RLS enforcement
- Multi-tenant test suite

---

## AC-10: Cascade Delete on Sales Order Cancellation

### Requirement
- SO cancellation → delete associated pick_lists (if pending or assigned)
- Delete pick_list_lines (cascade from pick_lists)
- Release inventory_allocations
- Block cancellation if pick_list.status = 'in_progress'

### Implementation

**Database Cascade:**
```sql
ALTER TABLE pick_list_lines
  DROP CONSTRAINT pick_list_lines_fk_pick_lists;

ALTER TABLE pick_list_lines
  ADD CONSTRAINT pick_list_lines_fk_pick_lists
    FOREIGN KEY (pick_list_id)
    REFERENCES pick_lists(id)
    ON DELETE CASCADE;

ALTER TABLE pick_lists
  DROP CONSTRAINT pick_lists_fk_so;

ALTER TABLE pick_lists
  ADD CONSTRAINT pick_lists_fk_so
    FOREIGN KEY (sales_order_id)  -- Assuming this column exists
    REFERENCES sales_orders(id)
    ON DELETE CASCADE;
```

**Service Method (SO cancellation):**
```typescript
async cancelSalesOrder(soId: string): Promise<void> {
  const org_id = await getOrgId();

  // 1. Check if any pick_lists in 'in_progress' status
  const { data: inProgressLists } = await supabase
    .from('pick_lists')
    .select('id, pick_list_number')
    .eq('org_id', org_id)
    .eq('sales_order_id', soId)
    .eq('status', 'in_progress');

  if (inProgressLists?.length > 0) {
    throw new Error(
      `Cannot cancel SO: Pick lists in progress (${inProgressLists.map(pl => pl.pick_list_number).join(', ')})`
    );
  }

  // 2. Delete pick_lists (cascade deletes pick_list_lines)
  await supabase
    .from('pick_lists')
    .delete()
    .eq('sales_order_id', soId)
    .in('status', ['pending', 'assigned', 'cancelled']);  // Don't delete completed

  // 3. Release inventory_allocations
  await supabase
    .from('inventory_allocations')
    .update({ released_at: now() })
    .eq('sales_order_id', soId);

  // 4. Update SO status
  await supabase
    .from('sales_orders')
    .update({ status: 'cancelled' })
    .eq('id', soId);
}
```

### Test Cases
1. **Cascade Test**: Delete SO with pending pick list
   - Create SO → Create pick list (pending)
   - Cancel SO
   - Verify: pick_list deleted, pick_list_lines deleted
   - Verify: inventory_allocations released

2. **Block Test**: Cannot delete SO with in_progress pick list
   - Create SO → Create pick list → Start picking (in_progress)
   - Try to cancel SO
   - Expect error: "Cannot cancel SO: Pick lists in progress (PL-2025-00042)"

3. **Allocation Release Test**: Verify inventory freed
   - Create SO + allocations
   - Create pick list
   - Cancel SO
   - Verify: license_plates.status reset to 'available'
   - Verify: inventory_allocations.released_at set

4. **Partial Delete Test**: Keep completed pick lists
   - Create SO with 2 pick lists (1 pending, 1 completed)
   - Cancel SO
   - Verify: pending deleted, completed kept (for audit trail)

### Deliverable
- ON DELETE CASCADE constraints on pick_list_lines
- Blocking logic in SO cancellation service
- Allocation release logic
- Integration tests for cascade delete
- Error messages for in_progress blocking

---

## Definition of Done (All ACs)

- [ ] AC-1: Auto-number function creates PL-YYYY-NNNNN format
- [ ] AC-2: Single-order pick lists create correctly with status updates
- [ ] AC-3: Pick lines sorted by location hierarchy (zone→aisle→bin)
- [ ] AC-4: Wave pick lists consolidate lines by product+location
- [ ] AC-5: Assign picker updates status to 'assigned'
- [ ] AC-6: List endpoint filters by status, assigned_to, priority, date
- [ ] AC-7: My Picks view shows only assigned/in_progress picks
- [ ] AC-8: Detail page groups lines by location with summary stats
- [ ] AC-9: RLS policies enforce org isolation
- [ ] AC-10: Cascade delete respects in_progress blocking

---

## Test Coverage Summary

| AC | Unit Tests | Integration Tests | E2E Tests | Status |
|----|-----------|------------------|-----------|--------|
| AC-1 | Numbering logic (3) | RPC function (2) | Auto-increment (1) | 6 total |
| AC-2 | Allocation linking (2) | SO status update (1) | Create from SO (1) | 4 total |
| AC-3 | Sort logic (3) | Location indexes (1) | UI grouping (1) | 5 total |
| AC-4 | Consolidation (2) | Wave creation (1) | Full workflow (1) | 4 total |
| AC-5 | Assignment (1) | Role checking (1) | Modal workflow (1) | 3 total |
| AC-6 | Filter logic (5) | Query building (2) | UI filtering (1) | 8 total |
| AC-7 | Priority sort (1) | Query filtering (1) | My Picks page (1) | 3 total |
| AC-8 | Grouping logic (1) | Detail query (1) | Detail page (1) | 3 total |
| AC-9 | RLS (2) | Multi-tenant (2) | Auth blocking (1) | 5 total |
| AC-10 | Cascade logic (1) | Delete blocking (1) | Error message (1) | 3 total |

**Total Test Cases**: 44
**Target Coverage**: >80% for services, >60% for routes

---

**Created**: 2025-12-18
**Story**: 07.8 - Pick List Generation + Wave Picking
**Version**: 1.0
