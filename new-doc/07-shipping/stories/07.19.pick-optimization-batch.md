# 07.19 - Pick Optimization & Batch Picking

**Story ID:** 07.19
**Epic:** 07 - Shipping
**Phase:** 2-3
**Complexity:** L (Large)
**Estimate:** 5-7 days
**Priority:** P2
**Type:** Backend + Frontend
**State:** ready

**Primary PRD:** `docs/1-BASELINE/product/modules/shipping.md` (FR-7.29, FR-7.32, FR-7.33)
**UX Wireframes:** SHIP-019 (Pick Optimization), SHIP-020 (Batch Picking), SHIP-021 (Pick Metrics Dashboard)

---

## PRD References

| FR ID | Requirement | Priority | Phase | Covered |
|-------|-------------|----------|-------|---------|
| FR-7.29 | Pick List Optimization (Zone/Route) | P1 | 2 | Yes |
| FR-7.32 | Batch Picking Support | P2 | 2 | Yes |
| FR-7.33 | Pick Performance Metrics | P2 | 3 | Yes |

---

## User Stories

**As a** warehouse manager,
**I want** to optimize pick routes using zone-based sequencing and route optimization,
**So that** pickers travel less distance, complete more picks per hour, and reduce fatigue.

**As a** warehouse picker,
**I want** to pick for multiple orders simultaneously (batch picking),
**So that** I can consolidate trips to the same location and improve my efficiency.

**As a** operations manager,
**I want** to view pick performance metrics (picks/hour, accuracy rate, picker rankings),
**So that** I can identify bottlenecks, coach underperformers, and optimize staffing.

---

## Goal

Implement advanced pick optimization features including zone-based route optimization (traveling salesman approximation), batch picking support for multi-order simultaneous picking, and a comprehensive pick performance dashboard with KPIs and analytics.

---

## Scope

**In scope:**
- Zone-based pick sequencing (temperature zones: Chilled -> Frozen -> Dry)
- Route optimization algorithm (nearest neighbor TSP approximation)
- Location distance matrix calculation
- Batch picking mode (pick for N orders simultaneously)
- Batch pick consolidation (same product/location across orders)
- Batch pick distribution (split picked qty back to orders)
- Pick performance metrics collection
- Pick performance dashboard (picks/hour, accuracy, time per pick)
- Picker leaderboard (daily/weekly/monthly rankings)
- Historical pick analysis (trend charts, heat maps)

**Out of scope:**
- Real-time GPS tracking of pickers
- AI-based demand prediction
- Dynamic re-routing during pick
- Integration with wearable devices (smart glasses, etc.)
- Voice picking integration

---

## Dependencies

### Story Dependencies (within Epic 07)

| Story | Requirement | Status |
|-------|-------------|--------|
| 07.8 | Pick List Generation (provides pick_lists, pick_list_lines) | Required |
| 07.9 | Pick Confirmation Desktop (provides pick completion workflow) | Required |
| 07.10 | Pick Confirmation Scanner (provides mobile pick completion) | Soft |

### Epic Dependencies

| Epic | Requirement | Status |
|------|-------------|--------|
| 01.9 | Locations (zone, aisle, bin hierarchy, coordinates) | Required |
| 05.1 | License Plates (inventory source) | Required |

### Provides To

- **07.15** - Shipping Dashboard (pick metrics integration)
- **Future** - Predictive pick time estimation

---

## Acceptance Criteria (Given/When/Then)

### Zone-Based Pick Sequencing (FR-7.29)

#### AC-1: Temperature Zone Ordering

**Given** a pick list with items from Chilled, Frozen, and Dry zones
**When** the system calculates pick_sequence
**Then** items are ordered: Chilled first -> Frozen second -> Dry last
**And** this minimizes temperature exposure time for chilled/frozen products
**And** the pick_sequence reflects this zone ordering

#### AC-2: Within-Zone Route Optimization

**Given** a pick list with 15 items in the Dry zone
**When** the system calculates pick_sequence within the zone
**Then** items are sorted using nearest neighbor algorithm
**And** travel distance is minimized by visiting closest locations next
**And** estimated travel distance is calculated and stored

#### AC-3: Location Distance Matrix

**Given** warehouse locations with (x, y) coordinates or (aisle, bin) numbers
**When** distance matrix is calculated
**Then** Manhattan distance formula used: |x1-x2| + |y1-y2|
**And** fallback to aisle/bin numeric sorting if no coordinates
**And** matrix cached for performance (per org, refresh on location change)

#### AC-4: Re-optimize Existing Pick List

**Given** an existing pick list with status = 'pending' or 'assigned'
**When** warehouse manager clicks "Optimize Route"
**Then** system recalculates pick_sequence using TSP algorithm
**And** displays estimated improvement (e.g., "Route optimized: -15% distance")
**And** pick_list.optimization_applied = true

### Batch Picking Support (FR-7.32)

#### AC-5: Create Batch Pick List

**Given** 5 sales orders with status = 'allocated'
**When** warehouse manager selects all 5 and clicks "Create Batch Pick"
**Then** system creates pick_list with pick_type = 'batch'
**And** generates consolidated pick_list_lines (merge same product/location)
**And** stores original SO line mappings in pick_batch_allocations table
**And** displays consolidated view: "Product A: 100 units (from 5 orders)"

#### AC-6: Batch Pick Consolidation

**Given** 3 orders each needing 20 units of Product A from Location B-01
**When** batch pick list generated
**Then** single pick_list_line created: Product A, Location B-01, qty = 60
**And** pick_batch_allocations records: SO1->20, SO2->20, SO3->20
**And** picker sees one pick task for 60 units (not 3 tasks for 20 each)

#### AC-7: Batch Pick Distribution

**Given** picker completes batch pick line (60 units of Product A)
**When** pick confirmed with quantity_picked = 60
**Then** system auto-distributes qty back to original SO lines (FIFO by order date)
**And** SO1 gets 20, SO2 gets 20, SO3 gets 20
**And** each sales_order_line.quantity_picked updated accordingly

#### AC-8: Partial Batch Pick Distribution

**Given** batch pick line for 60 units (3 orders x 20 each)
**When** picker picks only 50 units (short pick)
**Then** system distributes 50 units FIFO: SO1->20, SO2->20, SO3->10
**And** SO3 gets partial (10 of 20 requested)
**And** remaining 10 units create backorder for SO3

#### AC-9: Batch Pick Sorting Area

**Given** completed batch pick with items for 5 orders
**When** picker arrives at sorting station
**Then** system displays sorting instructions per order
**And** shows: "Order SO-001: 20x Product A, 15x Product B"
**And** sorting sequence optimized by delivery route (if configured)

### Pick Performance Metrics (FR-7.33)

#### AC-10: Capture Pick Metrics

**Given** picker completes a pick line
**When** pick_confirmed_at timestamp saved
**Then** system calculates and stores:
- pick_duration_seconds (time from previous pick or start)
- travel_time_seconds (estimated based on distance)
- pick_time_seconds (actual pick minus travel)
**And** metrics stored in pick_performance_logs table

#### AC-11: Calculate Picks Per Hour

**Given** picker with 50 completed picks today
**When** manager views picker performance
**Then** system calculates: picks_per_hour = total_picks / hours_worked
**And** displays comparison to org average
**And** shows trend (improving/declining) vs last 7 days

#### AC-12: Calculate Pick Accuracy Rate

**Given** picker with 100 completed picks this week
**And** 3 picks resulted in short picks or errors
**When** accuracy calculated
**Then** accuracy_rate = (97 correct / 100 total) * 100 = 97%
**And** target comparison shown (e.g., "97% vs 99% target")
**And** error breakdown displayed (2 short picks, 1 wrong LP)

#### AC-13: Picker Leaderboard

**Given** warehouse with 8 pickers
**When** manager views pick performance dashboard
**Then** leaderboard displays ranked by picks_per_hour
**And** shows: Rank, Picker Name, Picks Today, Picks/Hour, Accuracy %
**And** filterable by: Today, This Week, This Month
**And** current user highlighted if they are a picker

#### AC-14: Pick Time Analysis

**Given** 1000 completed picks in last 30 days
**When** manager views pick time analysis
**Then** chart displays: Average pick time by zone (bar chart)
**And** shows: Average pick time by hour of day (line chart)
**And** identifies peak times and bottleneck zones
**And** displays: "Slowest zone: Frozen (avg 45s vs 30s overall)"

#### AC-15: Pick Heat Map

**Given** warehouse layout with location coordinates
**When** manager views pick heat map
**Then** heat map displays pick frequency by location
**And** high-frequency locations highlighted (hot zones)
**And** suggests: "Consider moving Product A closer to staging"
**And** supports date range filtering

### Multi-tenancy & Security

#### AC-16: RLS Isolation

**Given** two organizations (Org A and Org B)
**When** Org A user queries pick optimization or metrics
**Then** only Org A data returned
**And** pick_performance_logs filtered by org_id
**And** location distance matrix cached per org

---

## Technical Specification

### Database Schema

#### pick_batch_allocations table (new)

```sql
CREATE TABLE pick_batch_allocations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  pick_list_line_id UUID NOT NULL REFERENCES pick_list_lines(id) ON DELETE CASCADE,
  sales_order_line_id UUID NOT NULL REFERENCES sales_order_lines(id),
  quantity_allocated DECIMAL(15,4) NOT NULL,
  quantity_distributed DECIMAL(15,4) DEFAULT 0,
  distribution_sequence INTEGER NOT NULL, -- FIFO order
  created_at TIMESTAMPTZ DEFAULT NOW(),

  UNIQUE(pick_list_line_id, sales_order_line_id)
);

CREATE INDEX idx_pick_batch_alloc_line ON pick_batch_allocations(pick_list_line_id);
CREATE INDEX idx_pick_batch_alloc_so ON pick_batch_allocations(sales_order_line_id);
```

#### pick_performance_logs table (new)

```sql
CREATE TABLE pick_performance_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  pick_list_id UUID NOT NULL REFERENCES pick_lists(id) ON DELETE CASCADE,
  pick_list_line_id UUID NOT NULL REFERENCES pick_list_lines(id) ON DELETE CASCADE,
  picker_id UUID NOT NULL REFERENCES users(id),

  -- Timing metrics
  pick_started_at TIMESTAMPTZ NOT NULL,
  pick_completed_at TIMESTAMPTZ NOT NULL,
  pick_duration_seconds INTEGER NOT NULL,
  travel_time_seconds INTEGER, -- Estimated
  pick_time_seconds INTEGER, -- Actual pick action

  -- Location info
  from_location_id UUID REFERENCES locations(id),
  to_location_id UUID NOT NULL REFERENCES locations(id),
  distance_traveled DECIMAL(10,2), -- meters

  -- Outcome
  quantity_requested DECIMAL(15,4) NOT NULL,
  quantity_picked DECIMAL(15,4) NOT NULL,
  is_short_pick BOOLEAN DEFAULT false,
  is_error BOOLEAN DEFAULT false,
  error_type VARCHAR(50), -- 'wrong_lp', 'wrong_product', 'wrong_qty'

  -- Context
  zone VARCHAR(50),
  pick_sequence INTEGER,

  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_pick_perf_org_date ON pick_performance_logs(org_id, created_at);
CREATE INDEX idx_pick_perf_picker ON pick_performance_logs(picker_id, created_at);
CREATE INDEX idx_pick_perf_zone ON pick_performance_logs(zone, created_at);
```

#### location_distances table (cached distance matrix)

```sql
CREATE TABLE location_distances (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  from_location_id UUID NOT NULL REFERENCES locations(id) ON DELETE CASCADE,
  to_location_id UUID NOT NULL REFERENCES locations(id) ON DELETE CASCADE,
  distance_meters DECIMAL(10,2) NOT NULL,
  calculated_at TIMESTAMPTZ DEFAULT NOW(),

  UNIQUE(org_id, from_location_id, to_location_id)
);

CREATE INDEX idx_loc_dist_org ON location_distances(org_id);
CREATE INDEX idx_loc_dist_from ON location_distances(from_location_id);
```

#### pick_lists table extension

```sql
ALTER TABLE pick_lists ADD COLUMN IF NOT EXISTS
  optimization_applied BOOLEAN DEFAULT false;

ALTER TABLE pick_lists ADD COLUMN IF NOT EXISTS
  estimated_distance_meters DECIMAL(10,2);

ALTER TABLE pick_lists ADD COLUMN IF NOT EXISTS
  actual_distance_meters DECIMAL(10,2);

ALTER TABLE pick_lists ADD COLUMN IF NOT EXISTS
  estimated_duration_minutes INTEGER;
```

#### locations table extension

```sql
ALTER TABLE locations ADD COLUMN IF NOT EXISTS
  x_coordinate DECIMAL(10,2);

ALTER TABLE locations ADD COLUMN IF NOT EXISTS
  y_coordinate DECIMAL(10,2);

ALTER TABLE locations ADD COLUMN IF NOT EXISTS
  pick_frequency INTEGER DEFAULT 0;

ALTER TABLE locations ADD COLUMN IF NOT EXISTS
  avg_pick_time_seconds INTEGER;
```

### RLS Policies

```sql
-- pick_batch_allocations: Org isolation
ALTER TABLE pick_batch_allocations ENABLE ROW LEVEL SECURITY;

CREATE POLICY "batch_alloc_org_isolation" ON pick_batch_allocations
FOR ALL USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

-- pick_performance_logs: Org isolation, pickers see own, managers see all
ALTER TABLE pick_performance_logs ENABLE ROW LEVEL SECURITY;

CREATE POLICY "pick_perf_org_isolation" ON pick_performance_logs
FOR SELECT USING (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  AND (
    picker_id = auth.uid()
    OR (SELECT r.code FROM roles r JOIN users u ON u.role_id = r.id WHERE u.id = auth.uid())
       IN ('SUPER_ADMIN', 'ADMIN', 'MANAGER', 'WAREHOUSE_MANAGER')
  )
);

CREATE POLICY "pick_perf_insert" ON pick_performance_logs
FOR INSERT WITH CHECK (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
);

-- location_distances: Org isolation
ALTER TABLE location_distances ENABLE ROW LEVEL SECURITY;

CREATE POLICY "loc_dist_org_isolation" ON location_distances
FOR ALL USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));
```

### API Endpoints

```
# Route Optimization
POST   /api/shipping/pick-lists/:id/optimize          - Optimize pick route
GET    /api/shipping/pick-lists/:id/route-preview     - Preview optimized route
POST   /api/shipping/locations/calculate-distances    - Recalculate distance matrix

# Batch Picking
POST   /api/shipping/pick-lists/batch                 - Create batch pick list
GET    /api/shipping/pick-lists/:id/batch-allocations - Get batch allocations
POST   /api/shipping/pick-lists/:id/distribute        - Distribute batch picks to orders
GET    /api/shipping/pick-lists/:id/sorting-guide     - Get sorting instructions

# Performance Metrics
GET    /api/shipping/metrics/overview                 - Dashboard overview
GET    /api/shipping/metrics/pickers                  - Picker leaderboard
GET    /api/shipping/metrics/pickers/:userId          - Individual picker stats
GET    /api/shipping/metrics/zones                    - Zone performance
GET    /api/shipping/metrics/trends                   - Trend analysis
GET    /api/shipping/metrics/heatmap                  - Pick frequency heat map
POST   /api/shipping/metrics/log                      - Log pick performance (internal)
```

### Service Methods

**Location:** `lib/services/pick-optimization-service.ts`

```typescript
interface PickOptimizationService {
  // Route optimization
  optimizePickRoute(pickListId: string): Promise<OptimizationResult>;
  calculateZoneSequence(lines: PickListLine[]): PickListLine[];
  nearestNeighborTSP(locations: Location[], startId?: string): string[];

  // Distance matrix
  calculateDistanceMatrix(orgId: string): Promise<void>;
  getDistance(fromLocationId: string, toLocationId: string): Promise<number>;
  invalidateDistanceCache(orgId: string): Promise<void>;

  // Helpers
  manhattanDistance(loc1: Location, loc2: Location): number;
  estimateTravelTime(distanceMeters: number): number; // Based on avg walk speed
}

interface OptimizationResult {
  pick_list_id: string;
  original_distance: number;
  optimized_distance: number;
  improvement_percent: number;
  new_sequence: { line_id: string; sequence: number }[];
}
```

**Location:** `lib/services/batch-picking-service.ts`

```typescript
interface BatchPickingService {
  // Batch creation
  createBatchPickList(params: CreateBatchPickParams): Promise<BatchPickList>;
  consolidatePickLines(lines: PickListLine[]): ConsolidatedLine[];

  // Distribution
  distributeBatchPicks(pickListId: string): Promise<DistributionResult>;
  calculateFIFODistribution(
    totalQty: number,
    allocations: BatchAllocation[]
  ): Distribution[];

  // Sorting guide
  getSortingGuide(pickListId: string): Promise<SortingGuide>;
}

interface CreateBatchPickParams {
  sales_order_ids: string[];
  max_orders_per_batch?: number; // Default 10
  optimize_route?: boolean; // Default true
}

interface ConsolidatedLine {
  product_id: string;
  location_id: string;
  total_quantity: number;
  source_lines: { so_line_id: string; quantity: number }[];
}

interface SortingGuide {
  pick_list_id: string;
  orders: {
    sales_order_id: string;
    order_number: string;
    items: { product_name: string; quantity: number; lot_number: string }[];
  }[];
}
```

**Location:** `lib/services/pick-metrics-service.ts`

```typescript
interface PickMetricsService {
  // Logging
  logPickPerformance(params: PickPerformanceParams): Promise<void>;

  // Dashboard
  getDashboardOverview(orgId: string, dateRange: DateRange): Promise<DashboardOverview>;
  getPickerLeaderboard(orgId: string, period: 'day' | 'week' | 'month'): Promise<PickerRanking[]>;
  getPickerStats(userId: string, dateRange: DateRange): Promise<PickerStats>;

  // Analysis
  getZonePerformance(orgId: string, dateRange: DateRange): Promise<ZoneStats[]>;
  getTrendAnalysis(orgId: string, days: number): Promise<TrendData>;
  getPickHeatMap(orgId: string, dateRange: DateRange): Promise<HeatMapData>;

  // Calculations
  calculatePicksPerHour(pickerId: string, date: Date): Promise<number>;
  calculateAccuracyRate(pickerId: string, dateRange: DateRange): Promise<number>;
}

interface DashboardOverview {
  total_picks_today: number;
  avg_picks_per_hour: number;
  avg_accuracy_rate: number;
  active_pickers: number;
  picks_by_zone: { zone: string; count: number }[];
  hourly_trend: { hour: number; picks: number }[];
}

interface PickerRanking {
  rank: number;
  user_id: string;
  user_name: string;
  picks_count: number;
  picks_per_hour: number;
  accuracy_rate: number;
  avg_pick_time_seconds: number;
}

interface PickerStats {
  user_id: string;
  total_picks: number;
  picks_per_hour: number;
  accuracy_rate: number;
  total_distance_meters: number;
  avg_pick_time_seconds: number;
  best_zone: string;
  worst_zone: string;
  daily_trend: { date: string; picks: number; accuracy: number }[];
}
```

### Zod Validation Schemas

**Location:** `lib/validation/pick-optimization-schema.ts`

```typescript
import { z } from 'zod';

// Optimize route request
export const optimizeRouteSchema = z.object({
  pick_list_id: z.string().uuid(),
  algorithm: z.enum(['nearest_neighbor', 'zone_first']).default('zone_first'),
});

// Batch pick request
export const createBatchPickSchema = z.object({
  sales_order_ids: z.array(z.string().uuid()).min(2, 'At least 2 orders required for batch'),
  max_orders_per_batch: z.number().int().min(2).max(20).optional(),
  optimize_route: z.boolean().optional(),
  priority: z.enum(['low', 'normal', 'high', 'urgent']).optional(),
});

// Distribute batch picks
export const distributeBatchSchema = z.object({
  pick_list_id: z.string().uuid(),
  distribution_method: z.enum(['fifo', 'equal']).default('fifo'),
});

// Metrics query
export const metricsQuerySchema = z.object({
  period: z.enum(['day', 'week', 'month']).optional(),
  start_date: z.string().datetime().optional(),
  end_date: z.string().datetime().optional(),
  picker_id: z.string().uuid().optional(),
  zone: z.string().optional(),
});

// Performance log
export const pickPerformanceLogSchema = z.object({
  pick_list_id: z.string().uuid(),
  pick_list_line_id: z.string().uuid(),
  pick_started_at: z.string().datetime(),
  pick_completed_at: z.string().datetime(),
  quantity_requested: z.number().positive(),
  quantity_picked: z.number().min(0),
  from_location_id: z.string().uuid().optional(),
  to_location_id: z.string().uuid(),
  is_short_pick: z.boolean().optional(),
  error_type: z.enum(['wrong_lp', 'wrong_product', 'wrong_qty']).optional(),
});
```

---

## UI Components

### Pages

- `app/(authenticated)/shipping/pick-lists/[id]/optimize/page.tsx` - Route optimization view
- `app/(authenticated)/shipping/pick-lists/batch/page.tsx` - Batch picking creation
- `app/(authenticated)/shipping/metrics/page.tsx` - Pick performance dashboard

### Components

**Location:** `components/shipping/pick-optimization/`

```
RouteOptimizer.tsx           - Route optimization controls and preview
RoutePreviewMap.tsx          - Visual route preview (2D warehouse map)
ZoneSequenceList.tsx         - Display zone-ordered pick sequence
OptimizationStats.tsx        - Show before/after distance comparison
```

**Location:** `components/shipping/batch-picking/`

```
BatchPickCreator.tsx         - Multi-order selection for batch
ConsolidatedPickList.tsx     - Display consolidated pick lines
BatchDistributionView.tsx    - Show distribution results
SortingGuide.tsx             - Post-pick sorting instructions
```

**Location:** `components/shipping/metrics/`

```
PickMetricsDashboard.tsx     - Main dashboard layout
PickerLeaderboard.tsx        - Ranked picker list
PickerStatsCard.tsx          - Individual picker metrics
ZonePerformanceChart.tsx     - Bar chart by zone
HourlyTrendChart.tsx         - Line chart by hour
PickHeatMap.tsx              - Heat map visualization
PickAccuracyGauge.tsx        - Circular accuracy indicator
```

### Component Details

**RouteOptimizer.tsx**
```tsx
interface RouteOptimizerProps {
  pickListId: string;
  currentLines: PickListLine[];
  onOptimize: (result: OptimizationResult) => void;
}

// Features:
// - "Optimize Route" button
// - Algorithm selector (Zone-first, Nearest Neighbor)
// - Before/After comparison
// - Estimated time savings
```

**PickMetricsDashboard.tsx**
```tsx
interface PickMetricsDashboardProps {
  dateRange: DateRange;
  onDateRangeChange: (range: DateRange) => void;
}

// Layout:
// +-------------------+-------------------+
// | KPI Cards (4)                         |
// +-------------------+-------------------+
// | Hourly Trend Chart| Zone Performance  |
// +-------------------+-------------------+
// | Picker Leaderboard                    |
// +--------------------------------------+
```

**PickerLeaderboard.tsx**
```tsx
interface PickerLeaderboardProps {
  period: 'day' | 'week' | 'month';
  limit?: number;
  highlightUserId?: string;
}

// Columns: Rank, Name, Picks, Picks/Hour, Accuracy, Trend
// Sortable by any column
// Click row -> navigate to picker detail
```

---

## Algorithms

### Zone-Based Sequencing

```typescript
const ZONE_ORDER = {
  'Chilled': 1,   // Pick first (temperature sensitive)
  'Frozen': 2,    // Pick second (most temperature sensitive)
  'Dry': 3,       // Pick last (ambient)
  'Ambient': 3,   // Alias for Dry
};

function sortByZone(lines: PickListLine[]): PickListLine[] {
  return lines.sort((a, b) => {
    const zoneA = ZONE_ORDER[a.location.zone] || 99;
    const zoneB = ZONE_ORDER[b.location.zone] || 99;
    return zoneA - zoneB;
  });
}
```

### Nearest Neighbor TSP

```typescript
function nearestNeighborTSP(
  locations: Location[],
  distanceMatrix: Map<string, Map<string, number>>,
  startLocationId?: string
): string[] {
  const route: string[] = [];
  const unvisited = new Set(locations.map(l => l.id));

  // Start from first location or specified start
  let current = startLocationId || locations[0].id;
  route.push(current);
  unvisited.delete(current);

  while (unvisited.size > 0) {
    let nearest: string | null = null;
    let minDistance = Infinity;

    for (const locId of unvisited) {
      const distance = distanceMatrix.get(current)?.get(locId) || Infinity;
      if (distance < minDistance) {
        minDistance = distance;
        nearest = locId;
      }
    }

    if (nearest) {
      route.push(nearest);
      unvisited.delete(nearest);
      current = nearest;
    }
  }

  return route;
}
```

### Manhattan Distance

```typescript
function manhattanDistance(loc1: Location, loc2: Location): number {
  // If coordinates available
  if (loc1.x_coordinate && loc2.x_coordinate) {
    return Math.abs(loc1.x_coordinate - loc2.x_coordinate) +
           Math.abs(loc1.y_coordinate - loc2.y_coordinate);
  }

  // Fallback: aisle/bin numeric distance
  const aisleDistance = Math.abs(
    parseInt(loc1.aisle) - parseInt(loc2.aisle)
  ) * 5; // 5 meters per aisle

  const binDistance = Math.abs(
    parseInt(loc1.bin) - parseInt(loc2.bin)
  ) * 1; // 1 meter per bin

  return aisleDistance + binDistance;
}
```

### FIFO Batch Distribution

```typescript
function distributeFIFO(
  totalPicked: number,
  allocations: BatchAllocation[]
): Distribution[] {
  // Sort by order date (oldest first)
  const sorted = allocations.sort((a, b) =>
    new Date(a.order_date).getTime() - new Date(b.order_date).getTime()
  );

  let remaining = totalPicked;
  const distributions: Distribution[] = [];

  for (const alloc of sorted) {
    const toDistribute = Math.min(remaining, alloc.quantity_allocated);
    distributions.push({
      sales_order_line_id: alloc.sales_order_line_id,
      quantity_distributed: toDistribute,
      is_partial: toDistribute < alloc.quantity_allocated,
    });
    remaining -= toDistribute;

    if (remaining <= 0) break;
  }

  return distributions;
}
```

---

## Test Cases

### Unit Tests

**pick-optimization-service.test.ts**
```typescript
describe('PickOptimizationService', () => {
  describe('calculateZoneSequence', () => {
    it('orders Chilled before Frozen before Dry');
    it('maintains original order within same zone');
    it('handles unknown zones at end');
  });

  describe('nearestNeighborTSP', () => {
    it('returns optimal route for 5 locations');
    it('starts from specified location');
    it('visits all locations exactly once');
    it('minimizes total distance');
  });

  describe('manhattanDistance', () => {
    it('calculates correct distance with coordinates');
    it('falls back to aisle/bin calculation');
  });
});
```

**batch-picking-service.test.ts**
```typescript
describe('BatchPickingService', () => {
  describe('consolidatePickLines', () => {
    it('merges lines with same product and location');
    it('preserves source line mappings');
    it('sums quantities correctly');
  });

  describe('distributeFIFO', () => {
    it('distributes to oldest order first');
    it('handles partial distribution');
    it('marks short picks correctly');
  });
});
```

**pick-metrics-service.test.ts**
```typescript
describe('PickMetricsService', () => {
  describe('calculatePicksPerHour', () => {
    it('calculates correct rate for full shift');
    it('excludes break time');
    it('handles multiple pick lists');
  });

  describe('calculateAccuracyRate', () => {
    it('returns 100% for no errors');
    it('correctly calculates with short picks');
    it('handles mixed error types');
  });

  describe('getPickerLeaderboard', () => {
    it('ranks pickers by picks_per_hour');
    it('respects date range filter');
    it('includes accuracy in ranking');
  });
});
```

### Integration Tests

**pick-optimization-api.test.ts**
```typescript
describe('Pick Optimization API', () => {
  describe('POST /api/shipping/pick-lists/:id/optimize', () => {
    it('optimizes route and returns improvement');
    it('updates pick_sequence in database');
    it('returns 404 for non-existent pick list');
    it('returns 400 for already started pick list');
  });
});
```

**batch-picking-api.test.ts**
```typescript
describe('Batch Picking API', () => {
  describe('POST /api/shipping/pick-lists/batch', () => {
    it('creates batch pick list from multiple orders');
    it('consolidates same product/location');
    it('returns 400 for single order');
    it('returns 400 for unallocated orders');
  });

  describe('POST /api/shipping/pick-lists/:id/distribute', () => {
    it('distributes picks FIFO');
    it('updates sales_order_lines.quantity_picked');
    it('creates backorder for partial');
  });
});
```

**pick-metrics-api.test.ts**
```typescript
describe('Pick Metrics API', () => {
  describe('GET /api/shipping/metrics/overview', () => {
    it('returns dashboard overview for org');
    it('respects date range filter');
    it('returns zero counts for new org');
  });

  describe('GET /api/shipping/metrics/pickers', () => {
    it('returns leaderboard sorted by picks/hour');
    it('limits results to specified count');
    it('returns 403 for non-manager role');
  });
});
```

### E2E Tests

**pick-optimization.spec.ts**
```typescript
describe('Pick Optimization', () => {
  it('optimizes route and shows improvement');
  it('displays zone-ordered sequence');
  it('shows before/after comparison');
});
```

**batch-picking.spec.ts**
```typescript
describe('Batch Picking', () => {
  it('creates batch from multiple orders');
  it('shows consolidated pick list');
  it('distributes picks after completion');
  it('displays sorting guide');
});
```

**pick-metrics.spec.ts**
```typescript
describe('Pick Metrics Dashboard', () => {
  it('displays KPI cards');
  it('shows picker leaderboard');
  it('filters by date range');
  it('navigates to picker detail');
});
```

---

## Deliverables

### Database
- [ ] Migration: `supabase/migrations/YYYYMMDDHHMMSS_pick_batch_allocations.sql`
- [ ] Migration: `supabase/migrations/YYYYMMDDHHMMSS_pick_performance_logs.sql`
- [ ] Migration: `supabase/migrations/YYYYMMDDHHMMSS_location_distances.sql`
- [ ] Migration: `supabase/migrations/YYYYMMDDHHMMSS_pick_lists_optimization_fields.sql`
- [ ] Migration: `supabase/migrations/YYYYMMDDHHMMSS_locations_coordinates.sql`
- [ ] RLS policies for all new tables

### API Routes
- [ ] `apps/frontend/app/api/shipping/pick-lists/[id]/optimize/route.ts`
- [ ] `apps/frontend/app/api/shipping/pick-lists/[id]/route-preview/route.ts`
- [ ] `apps/frontend/app/api/shipping/pick-lists/batch/route.ts`
- [ ] `apps/frontend/app/api/shipping/pick-lists/[id]/batch-allocations/route.ts`
- [ ] `apps/frontend/app/api/shipping/pick-lists/[id]/distribute/route.ts`
- [ ] `apps/frontend/app/api/shipping/pick-lists/[id]/sorting-guide/route.ts`
- [ ] `apps/frontend/app/api/shipping/metrics/overview/route.ts`
- [ ] `apps/frontend/app/api/shipping/metrics/pickers/route.ts`
- [ ] `apps/frontend/app/api/shipping/metrics/pickers/[userId]/route.ts`
- [ ] `apps/frontend/app/api/shipping/metrics/zones/route.ts`
- [ ] `apps/frontend/app/api/shipping/metrics/trends/route.ts`
- [ ] `apps/frontend/app/api/shipping/metrics/heatmap/route.ts`
- [ ] `apps/frontend/app/api/shipping/locations/calculate-distances/route.ts`

### Services
- [ ] `lib/services/pick-optimization-service.ts`
- [ ] `lib/services/batch-picking-service.ts`
- [ ] `lib/services/pick-metrics-service.ts`

### Validation
- [ ] `lib/validation/pick-optimization-schema.ts`

### Frontend Pages
- [ ] `apps/frontend/app/(authenticated)/shipping/pick-lists/[id]/optimize/page.tsx`
- [ ] `apps/frontend/app/(authenticated)/shipping/pick-lists/batch/page.tsx`
- [ ] `apps/frontend/app/(authenticated)/shipping/metrics/page.tsx`
- [ ] `apps/frontend/app/(authenticated)/shipping/metrics/pickers/[userId]/page.tsx`

### Components
- [ ] `components/shipping/pick-optimization/RouteOptimizer.tsx`
- [ ] `components/shipping/pick-optimization/RoutePreviewMap.tsx`
- [ ] `components/shipping/pick-optimization/ZoneSequenceList.tsx`
- [ ] `components/shipping/pick-optimization/OptimizationStats.tsx`
- [ ] `components/shipping/batch-picking/BatchPickCreator.tsx`
- [ ] `components/shipping/batch-picking/ConsolidatedPickList.tsx`
- [ ] `components/shipping/batch-picking/BatchDistributionView.tsx`
- [ ] `components/shipping/batch-picking/SortingGuide.tsx`
- [ ] `components/shipping/metrics/PickMetricsDashboard.tsx`
- [ ] `components/shipping/metrics/PickerLeaderboard.tsx`
- [ ] `components/shipping/metrics/PickerStatsCard.tsx`
- [ ] `components/shipping/metrics/ZonePerformanceChart.tsx`
- [ ] `components/shipping/metrics/HourlyTrendChart.tsx`
- [ ] `components/shipping/metrics/PickHeatMap.tsx`
- [ ] `components/shipping/metrics/PickAccuracyGauge.tsx`

### Tests
- [ ] `lib/services/__tests__/pick-optimization-service.test.ts`
- [ ] `lib/services/__tests__/batch-picking-service.test.ts`
- [ ] `lib/services/__tests__/pick-metrics-service.test.ts`
- [ ] `tests/e2e/shipping/pick-optimization.spec.ts`
- [ ] `tests/e2e/shipping/batch-picking.spec.ts`
- [ ] `tests/e2e/shipping/pick-metrics.spec.ts`

---

## Definition of Done

### Route Optimization (FR-7.29)
- [ ] Zone-based sequencing orders: Chilled -> Frozen -> Dry
- [ ] Nearest neighbor TSP algorithm implemented and tested
- [ ] Distance matrix calculated and cached per org
- [ ] "Optimize Route" updates pick_sequence in database
- [ ] Improvement percentage displayed after optimization
- [ ] Estimated travel distance stored on pick list

### Batch Picking (FR-7.32)
- [ ] Batch pick list created from 2+ sales orders
- [ ] Pick lines consolidated by product + location
- [ ] pick_batch_allocations records created for distribution
- [ ] FIFO distribution algorithm implemented
- [ ] Partial distribution creates backorders
- [ ] Sorting guide displays post-pick instructions

### Performance Metrics (FR-7.33)
- [ ] pick_performance_logs populated on each pick confirmation
- [ ] Picks per hour calculated correctly
- [ ] Accuracy rate calculated (correct picks / total picks)
- [ ] Picker leaderboard displays rankings
- [ ] Zone performance chart shows avg pick time per zone
- [ ] Hourly trend chart shows picks by hour
- [ ] Heat map visualizes pick frequency by location

### General
- [ ] RLS policies enforce multi-tenant isolation
- [ ] All API endpoints return correct HTTP status codes
- [ ] Unit test coverage > 80% for services
- [ ] E2E tests pass for critical paths
- [ ] Performance: < 500ms for optimization of 50-line pick list
- [ ] Performance: < 1s for metrics dashboard load

---

## Future Enhancements (Not in This Story)

### Phase 3+
- Machine learning for pick time prediction
- Dynamic re-routing based on real-time congestion
- Voice picking integration
- Wearable device support (smart glasses)
- A/B testing for optimization algorithms
- Gamification (badges, achievements for pickers)
- Integration with WMS slotting optimization

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2026-01-15 | Initial story creation | ARCHITECT-AGENT |
