# BUG-003: Schema and API Role Field Mismatch

| Field | Value |
|-------|-------|
| **ID** | BUG-003 |
| **Severity** | MEDIUM |
| **Priority** | P2 - High |
| **Feature** | TD-007: User Invitation Flow / TD-002: Roles |
| **Status** | Open |
| **Blocking Deployment** | Potentially Yes (needs runtime verification) |
| **Found Date** | 2024-12-24 |
| **Found By** | QA-AGENT |
| **Sprint** | Sprint 1/2 |

---

## Summary

There is a three-way mismatch between the validation schema, the UserForm component, and the API route handler regarding the role field:

1. **Schema**: `CreateUserSchema` expects `role_id` (UUID)
2. **Form**: `UserForm` sends `role` (role code string)
3. **API**: `/api/settings/users` route uses `validatedData.role` (expects code string)

This would cause the Zod validation to fail since the schema expects `role_id` but receives `role`.

---

## Evidence

### 1. CreateUserSchema (user-schemas.ts Lines 56-58)
```typescript
role_id: z
  .string()
  .min(1, 'Role is required'),
```

### 2. UserForm (UserForm.tsx Lines 59-67)
```typescript
const form = useForm<CreateUserInput>({
  resolver: zodResolver(CreateUserSchema),
  defaultValues: {
    email: '',
    first_name: '',
    last_name: '',
    role: 'viewer',  // <-- Field is 'role', not 'role_id'
  },
})
```

### 3. API Route (route.ts Lines 170-171, 187, 222)
```typescript
// Line 171: Validates against CreateUserSchema (expects role_id)
const validatedData = CreateUserSchema.parse(body)

// Line 187: Uses validatedData.role (would be undefined since schema has role_id)
role: validatedData.role,

// Line 222: Stores role in database
role: validatedData.role,
```

---

## Root Cause

The schema was updated to use `role_id` (likely for Story 01.5a as noted in comment), but:
- The UserForm was not updated
- The API route handler was not updated
- The database expects `role` (code string), not `role_id` (UUID)

---

## Impact

### If Schema is Enforced
- Form submission fails with Zod validation error
- User sees "Invalid request data" error
- Cannot create new users

### If Schema is Not Enforced (different import)
- `validatedData.role` would be `undefined`
- `user_metadata.role` and DB `role` would be `undefined`
- Data integrity issue

---

## Steps to Reproduce

1. Navigate to `/settings/users`
2. Click "Add User" button
3. Fill in email, first name, last name
4. Select a role from dropdown
5. Click "Create User"
6. Expected: Zod validation error OR user created with undefined role

---

## Resolution Options

### Option 1: Align Everything to Use role Code (Recommended)

Since the database stores `role` as a code string and the form uses role codes:

**Update Schema** (user-schemas.ts):
```typescript
// Change from:
role_id: z.string().min(1, 'Role is required'),

// To:
role: UserRoleEnum, // Use the existing enum
```

**No changes needed to**:
- UserForm (already uses `role`)
- API route (already uses `validatedData.role`)
- Database (already stores `role` code)

### Option 2: Align Everything to Use role_id UUID

**Update UserForm**:
- Fetch roles from `/api/v1/settings/roles`
- Change field from `role` to `role_id`
- Submit role UUID

**Update API Route**:
- Change `validatedData.role` to `validatedData.role_id`
- Look up role code from UUID before storing

**Update Database**:
- Store `role_id` UUID instead of `role` code

### Recommendation

**Option 1 is simpler** because:
- Minimal code changes
- Database already uses role codes
- Form already uses role codes
- Only schema needs update

---

## Estimated Effort

- Option 1: 30 minutes
- Option 2: 4-6 hours

---

## Acceptance Criteria

- [ ] Form field matches schema field name
- [ ] Schema validates correctly
- [ ] API receives and stores correct role data
- [ ] User creation succeeds
- [ ] Role is correctly assigned in database

---

## Related Files

| File | Issue |
|------|-------|
| `lib/validation/user-schemas.ts` | Schema expects `role_id` |
| `components/settings/UserForm.tsx` | Form sends `role` |
| `app/api/settings/users/route.ts` | API uses `validatedData.role` |

---

## Related Issues

- BUG-004: Role Filter Dropdown Outdated
- BUG-005: InvitationsTable Role Labels Outdated

---

## Verification Required

This bug was found through static code analysis. **Runtime testing is required** to confirm:
1. Whether user creation actually fails
2. What error message users see
3. Whether there's a different code path that works

The API might be using a different schema import or have error handling that masks this issue.
