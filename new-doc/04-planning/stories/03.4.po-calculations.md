# 03.4 - PO Totals + Tax Calculations

**Priority**: P0 (MVP)
**Story Points**: S (Small) - 1-2 days
**Type**: backend + frontend

**State:** ready
**Primary PRD:** `docs/1-BASELINE/product/modules/planning.md` (FR-PLAN-006, FR-PLAN-010)
**Architecture:** `docs/1-BASELINE/architecture/modules/planning.md`
**UX Wireframes:** PLAN-005 (PO Create/Edit Modal), PLAN-006 (PO Detail Page)

---

## MVP Scope

Implement automatic calculation of PO totals (subtotal, tax, discount, shipping, total) with support for:
- Line-level tax calculation (supports mixed tax rates)
- Per-line discount calculations
- Shipping cost at PO header level
- Database triggers for auto-calculation
- Service layer calculation methods
- UI display components for totals breakdown
- Multi-currency support

**In Scope:**
- Subtotal calculation (sum of line totals)
- Line-level tax calculation with mixed rate support
- Per-line discount (percentage or fixed amount)
- Shipping cost at header level
- Total calculation: subtotal + tax + shipping - discount
- Database triggers for automatic recalculation
- Service layer methods for calculations
- Validation schemas for calculation fields
- UI components for totals display with tax breakdown

**Out of Scope:**
- Complex discount rules (tiered discounts, promo codes) - Phase 2
- Multi-currency conversion - Phase 2
- Tax exemption handling - Phase 2
- Line-level shipping allocation - Phase 2

---

## Goal

Ensure accurate, automatic calculation of purchase order totals with line-level tax support, enabling transparent pricing, proper tax accounting, and multi-rate tax compliance for small-to-medium food manufacturers.

## User Story

As a **Purchaser**, I want **PO totals to calculate automatically based on line items, taxes, discounts, and shipping** so that **I can see accurate order costs without manual calculation, and tax amounts are properly tracked for accounting**.

## Scope

**In scope (this story)**
- Subtotal calculation: SUM(line.quantity * line.unit_price)
- Tax calculation per line: line_total * (tax_rate / 100), then summed
- Discount per line: percentage or fixed amount
- Shipping cost field at PO header level
- Total calculation: subtotal + tax + shipping - discount
- Database triggers: update totals on line add/edit/delete
- Service layer: `calculatePOTotals()` method
- UI: Totals section with tax breakdown for mixed rates
- Validation: discount cannot exceed subtotal, shipping >= 0

**Out of scope (this story)**
- 03.3 - PO CRUD + Lines (line item management)
- 03.5a - PO Approval (approval workflow based on totals)
- Currency conversion (single currency per PO)
- Tax exemption certificates
- Promotional discounts / promo codes

## Dependencies

- **01.1** - Org Context + Base RLS (multi-tenancy for POs)
- **01.13** - Tax Codes CRUD (tax_codes table with rates)
- **03.1** - Suppliers CRUD (supplier default tax code)
- **03.3** - PO CRUD + Lines (purchase_orders, purchase_order_lines tables)

---

## Acceptance Criteria (Given/When/Then)

### AC-1: Subtotal Calculation

**Given** a PO with 3 lines:
  - Line 1: 500 kg x $1.20 = $600.00
  - Line 2: 200 kg x $0.85 = $170.00
  - Line 3: 100 kg x $0.30 = $30.00
**When** PO totals are calculated
**Then** subtotal = $800.00 (sum of all line totals)
**And** subtotal updates automatically when lines change

### AC-2: Line-Level Tax Calculation (Single Rate)

**Given** a PO with tax code "VAT 23%" applied to all lines
**When** calculating tax
**Then** tax is calculated per line:
  - Line 1: $600.00 * 23% = $138.00
  - Line 2: $170.00 * 23% = $39.10
  - Line 3: $30.00 * 23% = $6.90
**And** total tax = $184.00 (sum of line taxes)

### AC-3: Mixed Tax Rate Calculation

**Given** a PO with mixed tax rates:
  - Line 1: $600.00 @ 23% tax = $138.00
  - Line 2: $170.00 @ 23% tax = $39.10
  - Line 3: $30.00 @ 8% tax = $2.40
**When** calculating totals
**Then** total tax = $179.50
**And** tax breakdown shows:
  - "23% on $770.00: $177.10"
  - "8% on $30.00: $2.40"
**And** UI displays "Tax (mixed): $179.50" with expandable breakdown

### AC-4: Discount Calculation (Percentage)

**Given** a line with quantity 500, unit_price $1.20, discount_percent 10%
**When** calculating line totals
**Then** line_total = $600.00
**And** discount_amount = $60.00 (10% of $600.00)
**And** line_total_after_discount = $540.00
**And** PO discount_total = sum of all line discount_amounts

### AC-5: Discount Calculation (Fixed Amount)

**Given** a line with quantity 500, unit_price $1.20, discount_amount $50.00
**When** calculating line totals
**Then** line_total = $600.00
**And** line_total_after_discount = $550.00
**And** discount_percent = calculated as 8.33%

### AC-6: Shipping Cost

**Given** a PO with subtotal $800.00, tax $184.00, shipping_cost $25.00
**When** calculating total
**Then** total = $800.00 + $184.00 + $25.00 = $1,009.00
**And** shipping cost is editable at header level
**And** shipping cost defaults to $0.00

### AC-7: Total Calculation Formula

**Given** a PO with:
  - Subtotal: $800.00
  - Tax: $179.50 (mixed rates)
  - Discount: $50.00
  - Shipping: $25.00
**When** calculating final total
**Then** total = $800.00 + $179.50 + $25.00 - $50.00 = $954.50
**And** formula is: subtotal + tax + shipping - discount

### AC-8: Automatic Recalculation on Line Add

**Given** a PO with subtotal $800.00, tax $184.00, total $984.00
**When** new line added: 50 kg x $0.50 = $25.00 @ 23% tax
**Then** subtotal updates to $825.00
**And** tax updates to $189.75
**And** total updates to $1,014.75
**And** recalculation happens within 100ms

### AC-9: Automatic Recalculation on Line Edit

**Given** Line 1 has quantity 500, unit_price $1.20, line_total $600.00
**When** quantity changed to 600
**Then** line_total recalculates to $720.00
**And** PO subtotal updates automatically
**And** PO tax recalculates based on new line_total
**And** PO total updates

### AC-10: Automatic Recalculation on Line Delete

**Given** a PO with 3 lines, total $984.00
**When** Line 3 deleted (was $30.00)
**Then** subtotal decreases by $30.00
**And** tax recalculates for remaining lines
**And** total updates to reflect deletion

### AC-11: Database Trigger - Update PO Totals on Line Insert

**Given** purchase_order with id PO-123
**When** new line inserted into purchase_order_lines with po_id = PO-123
**Then** trigger `update_po_totals()` fires
**And** purchase_orders row updated with new subtotal, tax_amount, total
**And** updated_at timestamp refreshed

### AC-12: Database Trigger - Update PO Totals on Line Update

**Given** existing line with id LINE-456
**When** line quantity or unit_price updated
**Then** trigger `update_po_totals()` fires
**And** parent PO totals recalculated and updated

### AC-13: Database Trigger - Update PO Totals on Line Delete

**Given** line with po_id = PO-123
**When** line deleted
**Then** trigger `update_po_totals()` fires
**And** parent PO totals recalculated excluding deleted line

### AC-14: Discount Validation

**Given** a line with line_total $600.00
**When** user attempts to set discount_amount $700.00
**Then** validation error: "Discount cannot exceed line total"
**And** form submission blocked

### AC-15: Negative Discount Validation

**Given** user creating/editing a PO line
**When** discount_percent is set to -10%
**Then** validation error: "Discount cannot be negative"
**And** form submission blocked

### AC-16: Shipping Cost Validation

**Given** user editing PO header
**When** shipping_cost is set to -50.00
**Then** validation error: "Shipping cost cannot be negative"
**And** form submission blocked

### AC-17: Multi-Currency Display

**Given** a PO with currency = "PLN"
**When** viewing totals
**Then** all amounts display with "PLN" suffix:
  - Subtotal: $800.00 PLN
  - Tax: $184.00 PLN
  - Total: $984.00 PLN

### AC-18: Zero Tax Handling

**Given** a line with tax_code "VAT 0%" (tax_rate = 0.00)
**When** calculating line tax
**Then** line_tax = $0.00
**And** total tax calculation includes this line as $0.00 contribution
**And** no error thrown for zero tax rate

### AC-19: Rounding Precision

**Given** a line with quantity 333, unit_price $0.33333, tax_rate 23%
**When** calculating totals
**Then** line_total rounded to 2 decimals: $110.99
**And** tax_amount rounded to 2 decimals: $25.53
**And** all currency amounts use DECIMAL(15,4) in DB, displayed as 2 decimals

### AC-20: Performance - Calculation Speed

**Given** a PO with 50 lines
**When** calculating totals via service method
**Then** calculation completes in < 50ms
**And** database trigger execution < 100ms

---

## Implementation Notes

### API Endpoints

No new endpoints required - calculations embedded in existing PO endpoints:

```typescript
// Existing endpoints that use calculation logic
POST /api/planning/purchase-orders           // Creates PO, calculates totals
PUT /api/planning/purchase-orders/:id        // Updates PO, recalculates totals
POST /api/planning/purchase-orders/:id/lines // Adds line, triggers recalc
PUT /api/planning/purchase-orders/:id/lines/:lineId  // Updates line, triggers recalc
DELETE /api/planning/purchase-orders/:id/lines/:lineId  // Deletes line, triggers recalc
```

**Response includes calculated fields:**
```json
{
  "id": "uuid-po-123",
  "po_number": "PO-2024-00156",
  "subtotal": 800.00,
  "tax_amount": 179.50,
  "discount_total": 50.00,
  "shipping_cost": 25.00,
  "total": 954.50,
  "tax_breakdown": [
    { "rate": 23.00, "subtotal": 770.00, "tax": 177.10 },
    { "rate": 8.00, "subtotal": 30.00, "tax": 2.40 }
  ],
  "lines": [...]
}
```

### Database

**Schema Additions:**

```sql
-- purchase_orders table (existing, add calculated fields)
ALTER TABLE purchase_orders ADD COLUMN IF NOT EXISTS subtotal DECIMAL(15,4) DEFAULT 0;
ALTER TABLE purchase_orders ADD COLUMN IF NOT EXISTS tax_amount DECIMAL(15,4) DEFAULT 0;
ALTER TABLE purchase_orders ADD COLUMN IF NOT EXISTS discount_total DECIMAL(15,4) DEFAULT 0;
ALTER TABLE purchase_orders ADD COLUMN IF NOT EXISTS shipping_cost DECIMAL(15,4) DEFAULT 0;
ALTER TABLE purchase_orders ADD COLUMN IF NOT EXISTS total DECIMAL(15,4) DEFAULT 0;

-- purchase_order_lines table (existing, add calculated fields)
ALTER TABLE purchase_order_lines ADD COLUMN IF NOT EXISTS discount_percent DECIMAL(5,2) DEFAULT 0;
ALTER TABLE purchase_order_lines ADD COLUMN IF NOT EXISTS discount_amount DECIMAL(15,4) DEFAULT 0;
ALTER TABLE purchase_order_lines ADD COLUMN IF NOT EXISTS line_total DECIMAL(15,4) DEFAULT 0;
ALTER TABLE purchase_order_lines ADD COLUMN IF NOT EXISTS tax_rate DECIMAL(5,2) NOT NULL;
ALTER TABLE purchase_order_lines ADD COLUMN IF NOT EXISTS tax_amount DECIMAL(15,4) DEFAULT 0;

-- Constraints
ALTER TABLE purchase_order_lines ADD CONSTRAINT check_discount_percent_range
  CHECK (discount_percent >= 0 AND discount_percent <= 100);
ALTER TABLE purchase_order_lines ADD CONSTRAINT check_discount_amount_positive
  CHECK (discount_amount >= 0);
ALTER TABLE purchase_orders ADD CONSTRAINT check_shipping_cost_positive
  CHECK (shipping_cost >= 0);
```

**Database Triggers:**

```sql
-- Function: Calculate PO Totals
CREATE OR REPLACE FUNCTION calculate_po_totals()
RETURNS TRIGGER AS $$
DECLARE
  po_id_val UUID;
  calculated_subtotal DECIMAL(15,4);
  calculated_tax DECIMAL(15,4);
  calculated_discount DECIMAL(15,4);
  calculated_total DECIMAL(15,4);
  current_shipping DECIMAL(15,4);
BEGIN
  -- Get po_id from NEW or OLD record
  IF TG_OP = 'DELETE' THEN
    po_id_val := OLD.po_id;
  ELSE
    po_id_val := NEW.po_id;
  END IF;

  -- Get current shipping cost
  SELECT COALESCE(shipping_cost, 0) INTO current_shipping
  FROM purchase_orders WHERE id = po_id_val;

  -- Calculate subtotal (sum of line totals before discount)
  SELECT COALESCE(SUM(quantity * unit_price), 0)
  INTO calculated_subtotal
  FROM purchase_order_lines
  WHERE po_id = po_id_val;

  -- Calculate tax (line-level, supports mixed rates)
  SELECT COALESCE(SUM((quantity * unit_price - discount_amount) * (tax_rate / 100)), 0)
  INTO calculated_tax
  FROM purchase_order_lines
  WHERE po_id = po_id_val;

  -- Calculate total discount
  SELECT COALESCE(SUM(discount_amount), 0)
  INTO calculated_discount
  FROM purchase_order_lines
  WHERE po_id = po_id_val;

  -- Calculate total: subtotal + tax + shipping - discount
  calculated_total := calculated_subtotal + calculated_tax + current_shipping - calculated_discount;

  -- Update parent PO
  UPDATE purchase_orders
  SET
    subtotal = calculated_subtotal,
    tax_amount = calculated_tax,
    discount_total = calculated_discount,
    total = calculated_total,
    updated_at = NOW()
  WHERE id = po_id_val;

  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Trigger: On line insert
CREATE TRIGGER tr_po_line_insert_update_totals
AFTER INSERT ON purchase_order_lines
FOR EACH ROW
EXECUTE FUNCTION calculate_po_totals();

-- Trigger: On line update
CREATE TRIGGER tr_po_line_update_update_totals
AFTER UPDATE OF quantity, unit_price, discount_percent, discount_amount, tax_rate ON purchase_order_lines
FOR EACH ROW
EXECUTE FUNCTION calculate_po_totals();

-- Trigger: On line delete
CREATE TRIGGER tr_po_line_delete_update_totals
AFTER DELETE ON purchase_order_lines
FOR EACH ROW
EXECUTE FUNCTION calculate_po_totals();

-- Trigger: On PO shipping cost update
CREATE TRIGGER tr_po_shipping_update_totals
AFTER UPDATE OF shipping_cost ON purchase_orders
FOR EACH ROW
EXECUTE FUNCTION recalculate_po_total_with_shipping();

-- Function: Recalculate total when shipping changes
CREATE OR REPLACE FUNCTION recalculate_po_total_with_shipping()
RETURNS TRIGGER AS $$
BEGIN
  NEW.total := NEW.subtotal + NEW.tax_amount + NEW.shipping_cost - NEW.discount_total;
  NEW.updated_at := NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;
```

**Indexes:**

```sql
-- Index for fast PO line lookups (used by trigger)
CREATE INDEX IF NOT EXISTS idx_po_lines_po_id ON purchase_order_lines(po_id);
```

### Frontend Components

```
components/planning/purchase-orders/
  POTotalsSection.tsx               -- Totals display with breakdown
  TaxBreakdownTooltip.tsx           -- Expandable tax breakdown for mixed rates
  DiscountInput.tsx                 -- Discount field (percent or amount toggle)
  ShippingCostInput.tsx             -- Shipping cost field
```

**POTotalsSection.tsx:**
```tsx
interface POTotalsSectionProps {
  subtotal: number;
  tax_amount: number;
  discount_total: number;
  shipping_cost: number;
  total: number;
  tax_breakdown?: TaxBreakdownItem[];
  currency: string;
}

interface TaxBreakdownItem {
  rate: number;      // e.g., 23.00
  subtotal: number;  // Subtotal for this tax rate
  tax: number;       // Tax amount for this rate
}

// Display:
// Subtotal:         $800.00 PLN
// Tax (mixed):      $179.50 PLN [?]  <- expandable tooltip
// Discount:         -$50.00 PLN
// Shipping Cost:    $25.00 PLN
// ---------------------------
// Total:            $954.50 PLN
```

**TaxBreakdownTooltip.tsx:**
```tsx
// When tax_breakdown has multiple rates, show:
// Tax Breakdown:
//   23% on $770.00: $177.10
//   8% on $30.00:   $2.40
// ---------------------------
// Total Tax:        $179.50
```

**DiscountInput.tsx:**
```tsx
// Toggle between percentage and fixed amount
// [10] [%]  OR  [$] [50.00]
// Validates discount <= line_total
```

### Services

```typescript
// lib/services/po-calculation-service.ts
export interface POCalculationService {
  calculateLineTotals(line: POLine): POLineCalculation;
  calculatePOTotals(lines: POLine[], shipping_cost: number): POTotals;
  calculateTaxBreakdown(lines: POLine[]): TaxBreakdownItem[];
  validateDiscount(line: POLine): ValidationResult;
  validateShippingCost(shipping_cost: number): ValidationResult;
}

export interface POLine {
  quantity: number;
  unit_price: number;
  discount_percent?: number;
  discount_amount?: number;
  tax_rate: number;  // From tax_code
}

export interface POLineCalculation {
  line_total: number;           // quantity * unit_price
  discount_amount: number;      // Calculated from percent or direct
  line_total_after_discount: number;  // line_total - discount_amount
  tax_amount: number;           // line_total_after_discount * (tax_rate / 100)
  line_total_with_tax: number;  // line_total_after_discount + tax_amount
}

export interface POTotals {
  subtotal: number;            // Sum of all line_totals (before discount)
  tax_amount: number;          // Sum of all line tax_amounts
  discount_total: number;      // Sum of all line discount_amounts
  shipping_cost: number;       // Header-level shipping
  total: number;               // subtotal + tax + shipping - discount
  tax_breakdown: TaxBreakdownItem[];
}

export interface TaxBreakdownItem {
  rate: number;
  subtotal: number;  // Subtotal for lines with this rate
  tax: number;       // Tax amount for this rate
}

// Implementation
export function calculateLineTotals(line: POLine): POLineCalculation {
  const line_total = line.quantity * line.unit_price;

  // Calculate discount
  let discount_amount = 0;
  if (line.discount_amount) {
    discount_amount = line.discount_amount;
  } else if (line.discount_percent) {
    discount_amount = line_total * (line.discount_percent / 100);
  }

  const line_total_after_discount = line_total - discount_amount;
  const tax_amount = line_total_after_discount * (line.tax_rate / 100);
  const line_total_with_tax = line_total_after_discount + tax_amount;

  return {
    line_total: roundCurrency(line_total),
    discount_amount: roundCurrency(discount_amount),
    line_total_after_discount: roundCurrency(line_total_after_discount),
    tax_amount: roundCurrency(tax_amount),
    line_total_with_tax: roundCurrency(line_total_with_tax),
  };
}

export function calculatePOTotals(lines: POLine[], shipping_cost: number = 0): POTotals {
  let subtotal = 0;
  let tax_amount = 0;
  let discount_total = 0;

  lines.forEach(line => {
    const lineCalc = calculateLineTotals(line);
    subtotal += lineCalc.line_total;
    tax_amount += lineCalc.tax_amount;
    discount_total += lineCalc.discount_amount;
  });

  const total = subtotal + tax_amount + shipping_cost - discount_total;
  const tax_breakdown = calculateTaxBreakdown(lines);

  return {
    subtotal: roundCurrency(subtotal),
    tax_amount: roundCurrency(tax_amount),
    discount_total: roundCurrency(discount_total),
    shipping_cost: roundCurrency(shipping_cost),
    total: roundCurrency(total),
    tax_breakdown,
  };
}

export function calculateTaxBreakdown(lines: POLine[]): TaxBreakdownItem[] {
  const breakdown = new Map<number, { subtotal: number; tax: number }>();

  lines.forEach(line => {
    const lineCalc = calculateLineTotals(line);

    if (!breakdown.has(line.tax_rate)) {
      breakdown.set(line.tax_rate, { subtotal: 0, tax: 0 });
    }

    const entry = breakdown.get(line.tax_rate)!;
    entry.subtotal += lineCalc.line_total_after_discount;
    entry.tax += lineCalc.tax_amount;
  });

  return Array.from(breakdown.entries())
    .map(([rate, amounts]) => ({
      rate,
      subtotal: roundCurrency(amounts.subtotal),
      tax: roundCurrency(amounts.tax),
    }))
    .sort((a, b) => b.rate - a.rate);  // Descending order
}

function roundCurrency(value: number): number {
  return Math.round(value * 100) / 100;  // Round to 2 decimals
}

export function validateDiscount(line: POLine): ValidationResult {
  const line_total = line.quantity * line.unit_price;

  if (line.discount_percent && (line.discount_percent < 0 || line.discount_percent > 100)) {
    return { valid: false, error: "Discount must be between 0% and 100%" };
  }

  if (line.discount_amount && line.discount_amount < 0) {
    return { valid: false, error: "Discount cannot be negative" };
  }

  const discount_amount = line.discount_amount || (line_total * (line.discount_percent || 0) / 100);
  if (discount_amount > line_total) {
    return { valid: false, error: "Discount cannot exceed line total" };
  }

  return { valid: true };
}

export function validateShippingCost(shipping_cost: number): ValidationResult {
  if (shipping_cost < 0) {
    return { valid: false, error: "Shipping cost cannot be negative" };
  }
  return { valid: true };
}
```

### Validation (Zod)

```typescript
// lib/validation/po-calculation.ts
import { z } from 'zod';

export const poLineCalculationSchema = z.object({
  quantity: z.number().positive("Quantity must be greater than 0"),
  unit_price: z.number().min(0, "Unit price cannot be negative"),
  discount_percent: z.number()
    .min(0, "Discount percent cannot be negative")
    .max(100, "Discount percent cannot exceed 100%")
    .optional(),
  discount_amount: z.number()
    .min(0, "Discount amount cannot be negative")
    .optional(),
  tax_rate: z.number()
    .min(0, "Tax rate cannot be negative")
    .max(100, "Tax rate cannot exceed 100%"),
}).refine(
  (data) => {
    if (data.discount_amount) {
      const line_total = data.quantity * data.unit_price;
      return data.discount_amount <= line_total;
    }
    return true;
  },
  { message: "Discount amount cannot exceed line total", path: ["discount_amount"] }
);

export const poHeaderCalculationSchema = z.object({
  shipping_cost: z.number()
    .min(0, "Shipping cost cannot be negative")
    .default(0),
});

export const poTotalsSchema = z.object({
  subtotal: z.number().min(0),
  tax_amount: z.number().min(0),
  discount_total: z.number().min(0),
  shipping_cost: z.number().min(0),
  total: z.number().min(0),
});

export type POLineCalculationInput = z.infer<typeof poLineCalculationSchema>;
export type POHeaderCalculationInput = z.infer<typeof poHeaderCalculationSchema>;
export type POTotalsOutput = z.infer<typeof poTotalsSchema>;
```

### Key Business Rules

1. **Calculation Order:**
   - Line level: line_total = qty * unit_price
   - Line level: discount applied to line_total
   - Line level: tax applied to (line_total - discount)
   - PO level: subtotal = sum(line_totals before discount)
   - PO level: tax = sum(line taxes)
   - PO level: discount = sum(line discounts)
   - PO level: total = subtotal + tax + shipping - discount

2. **Tax Calculation:**
   - ALWAYS calculate tax at line level (supports mixed rates)
   - Tax applies to line total AFTER discount
   - Store tax_rate with each line (snapshot from tax_code)

3. **Discount Rules:**
   - Line can have discount_percent OR discount_amount (not both)
   - If discount_percent set, calculate discount_amount = line_total * (percent / 100)
   - Discount cannot exceed line_total
   - Discount cannot be negative

4. **Shipping Cost:**
   - Header-level field (not allocated to lines)
   - Defaults to $0.00
   - Cannot be negative
   - Included in total but not in subtotal

5. **Rounding:**
   - All currency values rounded to 2 decimal places for display
   - Database stores DECIMAL(15,4) for precision
   - Rounding applied after all calculations

6. **Performance:**
   - Database triggers update totals automatically
   - No manual recalculation API call needed
   - Service layer methods used for UI preview before save

---

## Deliverables

- **API updates**: Extend existing PO endpoints with calculated fields
- **Database migration**: Add calculated columns, triggers, constraints
- **Service methods**:
  - `calculateLineTotals()`
  - `calculatePOTotals()`
  - `calculateTaxBreakdown()`
  - `validateDiscount()`
  - `validateShippingCost()`
- **UI Components**:
  - `POTotalsSection.tsx`
  - `TaxBreakdownTooltip.tsx`
  - `DiscountInput.tsx`
  - `ShippingCostInput.tsx`
- **Tests**:
  - Unit tests for calculation functions (20+ test cases)
  - Integration tests for database triggers (3 triggers)
  - E2E tests for UI totals updates (5 scenarios)

---

## Definition of Done

- [ ] Database migration creates calculated columns in `purchase_orders` and `purchase_order_lines`
- [ ] Database constraints enforce discount >= 0, shipping_cost >= 0
- [ ] Database trigger `calculate_po_totals()` fires on line insert/update/delete
- [ ] Database trigger `recalculate_po_total_with_shipping()` fires on shipping_cost update
- [ ] Service method `calculateLineTotals()` returns correct line_total, discount, tax
- [ ] Service method `calculatePOTotals()` returns correct subtotal, tax, discount, total
- [ ] Service method `calculateTaxBreakdown()` groups by tax_rate correctly
- [ ] Tax calculation supports mixed rates (tested with 2+ rates)
- [ ] Discount validation prevents discount > line_total
- [ ] Negative discount validation blocks submission
- [ ] Shipping cost validation prevents negative values
- [ ] UI component `POTotalsSection` displays subtotal, tax, discount, shipping, total
- [ ] UI component `TaxBreakdownTooltip` shows per-rate breakdown for mixed taxes
- [ ] UI component `DiscountInput` toggles between percent and fixed amount
- [ ] Multi-currency display shows correct currency suffix (PLN, EUR, USD, GBP)
- [ ] Zero tax handling works (no errors, $0.00 tax)
- [ ] Rounding precision: all amounts rounded to 2 decimals
- [ ] Performance: calculation completes in < 50ms for 50 lines
- [ ] Database trigger execution < 100ms
- [ ] Unit tests >= 85% coverage
  - Single rate tax calculation (AC-2)
  - Mixed rate tax calculation (AC-3)
  - Percentage discount calculation (AC-4)
  - Fixed amount discount calculation (AC-5)
  - Shipping cost addition (AC-6)
  - Total formula (AC-7)
  - Discount validation (AC-14, AC-15)
  - Shipping validation (AC-16)
  - Zero tax handling (AC-18)
  - Rounding precision (AC-19)
- [ ] Integration tests for all 3 database triggers:
  - Insert line -> PO totals update (AC-11)
  - Update line -> PO totals update (AC-12)
  - Delete line -> PO totals update (AC-13)
- [ ] E2E tests for UI scenarios:
  - Add line updates totals automatically (AC-8)
  - Edit line quantity updates totals (AC-9)
  - Delete line updates totals (AC-10)
  - Mixed tax rates show breakdown (AC-3)
  - Discount validation error displays (AC-14)
- [ ] Multi-tenancy: calculations work per org_id
- [ ] Documentation: calculation formulas documented in service code
- [ ] Edge case: PO with 0 lines shows $0.00 totals (no error)

---

## Test Cases

### Unit Tests

**File:** `__tests__/unit/services/po-calculation-service.test.ts`

| Test Case | Description |
|-----------|-------------|
| `calculateLineTotals()` single line, no discount | Returns correct line_total = qty * price |
| `calculateLineTotals()` with 10% discount | Returns correct discount_amount |
| `calculateLineTotals()` with fixed discount $50 | Returns correct line_total_after_discount |
| `calculateLineTotals()` with tax 23% | Returns correct tax_amount |
| `calculatePOTotals()` single rate 23% | Returns correct subtotal, tax, total |
| `calculatePOTotals()` mixed rates (23%, 8%) | Returns correct total tax sum |
| `calculatePOTotals()` with shipping $25 | Returns total including shipping |
| `calculatePOTotals()` with discounts | Returns correct discount_total |
| `calculateTaxBreakdown()` single rate | Returns 1 item with correct tax |
| `calculateTaxBreakdown()` mixed rates | Returns 2+ items sorted descending |
| `validateDiscount()` negative percent | Returns validation error |
| `validateDiscount()` discount > line_total | Returns validation error |
| `validateDiscount()` valid 10% | Returns valid: true |
| `validateShippingCost()` negative value | Returns validation error |
| `validateShippingCost()` zero | Returns valid: true |
| `validateShippingCost()` positive value | Returns valid: true |
| `roundCurrency()` rounds to 2 decimals | 1.2345 -> 1.23 |
| Zero tax rate handling | No error, tax = 0.00 |
| 50 lines performance | Completes in < 50ms |

### Integration Tests

**File:** `__tests__/integration/api/planning/po-calculations.test.ts`

| Test Case | Description |
|-----------|-------------|
| POST `/purchase-orders` with 3 lines | Returns correct calculated totals |
| POST `/purchase-orders/:id/lines` | Triggers recalculation, totals updated |
| PUT `/purchase-orders/:id/lines/:lineId` qty change | Totals recalculated |
| DELETE `/purchase-orders/:id/lines/:lineId` | Totals recalculated |
| PUT `/purchase-orders/:id` shipping_cost change | Total updated |
| Database trigger on line insert | purchase_orders.total updated |
| Database trigger on line update | purchase_orders.total updated |
| Database trigger on line delete | purchase_orders.total updated |
| Mixed tax rates PO | tax_breakdown populated correctly |
| Discount > line_total validation | Returns 400 Bad Request |
| Negative shipping_cost validation | Returns 400 Bad Request |
| Multi-currency display | Currency suffix correct |

### E2E Tests

**File:** `__tests__/e2e/planning/po-calculations.spec.ts`

| Test Case | Description |
|-----------|-------------|
| Create PO, add 3 lines | Totals section updates after each line |
| Edit line quantity via inline edit | Totals update without page refresh |
| Delete line via [X] button | Totals recalculate instantly |
| Mixed tax rates (23%, 8%) | Tax breakdown tooltip shows 2 rates |
| Add discount to line | Line total and PO total update |
| Change shipping cost | Total updates to include new shipping |
| Validation: discount > line_total | Error message displays inline |
| Validation: negative shipping | Error blocks save |
| Mobile view: totals visible | Totals section scrolls into view |

### Edge Cases

| Test Case | Expected Behavior |
|-----------|-------------------|
| PO with 0 lines | subtotal = 0, tax = 0, total = shipping_cost |
| Line with qty = 0.001 | Calculates correctly with precision |
| Line with price = $0.01 | Calculates correctly (tiny amounts) |
| 100% discount on line | line_total_after_discount = 0, tax = 0 |
| Tax rate = 100% | Calculates correctly (edge case, unlikely) |
| Shipping cost = $10,000 | Handles large amounts |
| 100 lines in PO | Performance acceptable (< 100ms) |

---

## Future Phases (Not in MVP)

### Phase 1
- **Header-level discount** - Apply discount to entire PO (percentage or fixed)
- **Tax exemption certificates** - Link suppliers to tax exemption documents
- **Line-level shipping allocation** - Distribute shipping cost proportionally to lines

### Phase 2
- **Tiered discounts** - Quantity-based discount rules (e.g., 10% off if qty > 500)
- **Promotional codes** - Apply promo codes for special discounts
- **Multi-currency conversion** - Real-time FX rates for cross-border POs
- **Tax jurisdiction rules** - US state tax, Canadian GST/PST
- **Freight cost per line** - Different shipping for different products

### Phase 3
- **Duty and import fees** - Customs duty calculations for international POs
- **Complex tax rules** - VAT reverse charge, intra-community supply
- **Volume rebates** - Automatic rebate calculation based on annual spend

**Implementation**: Per Epic 03.0 guidance, hide or show as "Coming Soon".

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-12-16 | Initial story creation | ARCHITECT-AGENT |
