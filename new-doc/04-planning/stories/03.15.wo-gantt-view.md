# 03.15 - Work Order Gantt Chart View

| Field | Value |
|-------|-------|
| **Story ID** | 03.15 |
| **Epic** | 03 - Planning |
| **Status** | Ready |
| **Phase** | P1 (Phase 1) |
| **Complexity** | M (Medium) |
| **Estimate** | 3-4 days |
| **Type** | Full-stack |

---

## PRD References

| FR ID | Requirement | Priority | Covered |
|-------|-------------|----------|---------|
| FR-PLAN-024 | WO Gantt Chart View | Could Have | YES |

**Primary PRD:** `docs/1-BASELINE/product/modules/planning.md` (Section 7.9, FR-PLAN-024)
**Architecture:** `docs/1-BASELINE/architecture/modules/planning.md`
**UX Wireframes:** PLAN-016 (WO Gantt/Schedule View)

---

## MVP Scope

This story implements Phase 1 (P1) functionality for Work Order visual scheduling via Gantt chart. The Gantt view provides a timeline-based visualization of work orders grouped by production line or machine, with date range filtering and basic rescheduling capabilities.

**MVP Includes**:
- Gantt chart timeline view (day/week/month zoom levels)
- Swimlanes by production line (default) or machine
- WO bars colored by status with duration display
- Date range selector (default: 30 days from today)
- Production line and status filters
- WO detail quick view (slide-in panel)
- Drag-to-reschedule functionality (updates planned_start_date and scheduled times)
- Scheduling conflict validation
- Gantt data aggregation service
- Export to PDF capability

**Deferred to Phase 2+**: See "Future Phases" section below.

---

## User Story

As a **Production Manager or Planner**, I want to **visualize work orders on a Gantt chart timeline grouped by production line** so that **I can see the production schedule at a glance, identify bottlenecks, and easily reschedule work orders by dragging them to new time slots**.

---

## Dependencies

| Dependency | Story/Epic | Type | Reason |
|------------|------------|------|--------|
| 01.1 | Org Context + Base RLS | HARD | Requires org_id context and RLS patterns |
| 01.9 | Production Lines CRUD | SOFT | Gantt swimlanes reference production_line_id |
| 01.10 | Machines CRUD | SOFT | Optional machine-based swimlanes |
| 02.1 | Products CRUD | HARD | WO bars display product names |
| 03.10 | WO CRUD + BOM Auto-Select | HARD | Requires work_orders table and basic CRUD |
| 03.11a | WO Materials (BOM Snapshot) | SOFT | Material availability indicators (optional) |

**Dependents:**
- None (standalone visualization feature)

---

## Acceptance Criteria (Gherkin)

### AC-1: Gantt Chart Page Load (FR-PLAN-024)

```gherkin
Scenario: Navigate to Gantt chart view
  Given planner navigates to `/planning/work-orders/gantt`
  When page loads
  Then Gantt chart displays within 1s for 50 WOs across 5 lines
  And default date range shows next 30 days from today
  And swimlanes grouped by production line (default)
  And WO bars render with status-based colors

Scenario: Empty state - no WOs scheduled
  Given no work orders exist in date range
  When planner views Gantt chart
  Then empty state displays with "No Work Orders Scheduled" message
  And "Create First Work Order" button shown
  And "Switch to List View" link available

Scenario: Today indicator visible
  Given today's date falls within visible date range
  When Gantt chart loads
  Then vertical red dashed line appears at current date/time
  And line auto-updates every 60 seconds
```

### AC-2: Date Range Filtering

```gherkin
Scenario: Select date range preset
  Given planner on Gantt chart page
  When planner selects "This Week" from date range dropdown
  Then Gantt shows WOs scheduled within current week (Mon-Sun)
  And timeline updates to 7-day view
  And API called with from_date and to_date parameters

Scenario: Custom date range selection
  Given planner on Gantt chart page
  When planner selects "Custom" and picks Jan 15 - Jan 31
  Then Gantt shows WOs scheduled between Jan 15-31
  And timeline adjusts to 16-day view

Scenario: No WOs in selected date range
  Given planner selects date range with no scheduled WOs
  When Gantt loads
  Then "No WOs match your filters" message displays
  And "Clear Filters" button shown
```

### AC-3: Production Line Filtering

```gherkin
Scenario: Filter by single production line
  Given Gantt displays WOs across 5 production lines
  When planner selects "Packing Line #1" filter
  Then only "Packing Line #1" swimlane displays
  And WOs on other lines hidden
  And filter badge shows "Line: Packing Line #1"

Scenario: Filter by multiple production lines
  Given Gantt displays WOs across 5 production lines
  When planner selects "Packing Line #1" and "Baking Line #2"
  Then only those 2 swimlanes display
  And WOs on other lines hidden

Scenario: Clear production line filter
  Given planner has filtered by line
  When planner clicks "Clear Filters" or removes line filter
  Then all production lines display again
```

### AC-4: Status Filtering

```gherkin
Scenario: Filter by WO status
  Given Gantt displays WOs with mixed statuses
  When planner selects status filter "Planned"
  Then only WOs with status = "planned" display
  And other WOs hidden from timeline

Scenario: Multi-select status filter
  Given Gantt chart loaded
  When planner selects "Planned" and "Released" statuses
  Then WOs with either status display
  And all other statuses hidden

Scenario: Default status filter excludes completed
  Given planner loads Gantt chart
  When page initializes
  Then status filter defaults to all except "Completed"
  And completed WOs hidden by default
```

### AC-5: WO Bar Display and Colors

```gherkin
Scenario: WO bar renders with correct properties
  Given WO-00156 scheduled for Dec 17, 8:00-16:00 on Packing Line #1
  When Gantt chart loads
  Then WO bar appears in "Packing Line #1" swimlane
  And bar positioned at Dec 17, 8:00 start time
  And bar width spans 8 hours (to 16:00 end time)
  And bar color matches status (blue for "planned")
  And bar label shows "WO-00156: Chocolate Bar (1000 pc)"

Scenario: Status-based bar colors
  Given Gantt displays WOs with various statuses
  When chart renders
  Then "draft" WOs show gray background with dashed border
  And "planned" WOs show blue background (#DBEAFE)
  And "released" WOs show cyan background (#CFFAFE)
  And "in_progress" WOs show purple background (#EDE9FE)
  And "on_hold" WOs show orange background (#FED7AA)
  And "completed" WOs show green background (#D1FAE5)

Scenario: Overdue WO indicator
  Given WO-00152 scheduled end time is Dec 15, 16:00
  And current date is Dec 16
  And WO status is NOT "completed"
  When Gantt chart loads
  Then WO-00152 bar shows red background (#FEE2E2)
  And warning icon [⚠] displays on bar
  And "Overdue" badge shown in WO tooltip

Scenario: In-progress WO shows progress bar
  Given WO-00155 has status "in_progress"
  And progress_percent = 65%
  When Gantt chart loads
  Then WO bar shows progress overlay
  And progress bar fills 65% of bar width
  And progress percentage "65%" displayed on bar
```

### AC-6: Swimlane Grouping

```gherkin
Scenario: Group by production line (default)
  Given planner loads Gantt chart
  When page initializes
  Then swimlanes grouped by production line
  And each line gets one row
  And lines sorted alphabetically
  And swimlane header shows line name (e.g., "Packing Line #1")

Scenario: Group by machine
  Given planner on Gantt chart
  When planner selects "View by: Machine" toggle
  Then swimlanes regroup by machine
  And each machine gets one row
  And WOs with no machine assigned appear in "Unassigned" swimlane

Scenario: Empty swimlanes hidden by default
  Given production lines with no scheduled WOs
  When Gantt chart loads
  Then empty swimlanes not displayed
  And only swimlanes with WOs shown
```

### AC-7: Zoom Levels

```gherkin
Scenario: Day zoom level
  Given planner on Gantt chart
  When planner clicks "Day" zoom button
  Then timeline shows hours (4-hour increments)
  And 1-3 days visible in viewport
  And WO bars show full labels: "WO-00156: Chocolate Bar (1000 pc)"
  And hour markers display (8am, 12pm, 4pm, etc.)

Scenario: Week zoom level
  Given planner on Gantt chart
  When planner clicks "Week" zoom button
  Then timeline shows days
  And 7-14 days visible in viewport
  And WO bars show truncated labels: "WO-00156: Choc..."
  And day markers display (Mon, Tue, Wed, etc.)

Scenario: Month zoom level
  Given planner on Gantt chart
  When planner clicks "Month" zoom button
  Then timeline shows weeks
  And 30-60 days visible in viewport
  And WO bars show minimal labels: "WO-156"
  And week markers display (Week 1, Week 2, etc.)
```

### AC-8: WO Detail Quick View

```gherkin
Scenario: Click WO bar to open quick view
  Given planner on Gantt chart
  When planner clicks WO-00156 bar
  Then slide-in panel opens from right
  And displays WO number, product, status, line, machine
  And shows scheduled date and time range
  And displays quantity and UoM
  And shows material availability status
  And provides action buttons: [View Full Details] [Edit] [Reschedule]

Scenario: Close quick view
  Given WO quick view panel open
  When planner clicks [X] close button
  Then panel slides out and closes
  And focus returns to WO bar

Scenario: View Full Details from quick view
  Given WO quick view panel open for WO-00156
  When planner clicks "View Full Details" button
  Then new tab opens to /planning/work-orders/[id]
  And quick view panel remains open
```

### AC-9: Drag-to-Reschedule (Horizontal - Date/Time Change)

```gherkin
Scenario: Drag WO bar to new date/time
  Given WO-00156 scheduled for Dec 17, 8:00-16:00
  When planner drags bar right to Dec 18, 10:00-18:00
  And releases drag
  Then confirmation dialog appears: "Reschedule WO-00156 to Dec 18, 10:00-18:00?"
  And shows warnings if material availability changes
  And shows warnings if dependencies affected

Scenario: Confirm reschedule
  Given reschedule confirmation dialog open
  When planner clicks "Confirm"
  Then API POST /api/planning/work-orders/{id}/reschedule called
  And WO bar moves to new position on timeline
  And scheduled_date, scheduled_start_time, scheduled_end_time updated
  And success toast "WO-00156 rescheduled to Dec 18" displays

Scenario: Cancel reschedule
  Given reschedule confirmation dialog open
  When planner clicks "Cancel"
  Then dialog closes
  And WO bar reverts to original position
  And no API call made

Scenario: Reschedule validation - line conflict
  Given WO-00160 already scheduled on Packing Line #1 at Dec 18, 10:00-14:00
  When planner drags WO-00156 to Dec 18, 12:00-20:00 (overlaps)
  And releases drag
  Then error dialog appears: "Line already scheduled for this time slot"
  And conflicting WO details shown: "WO-00160: Vanilla Cookie (10:00-14:00)"
  And WO bar reverts to original position

Scenario: Reschedule validation - material shortage warning
  Given WO-00156 requires 150kg sugar
  And sugar inventory for Dec 18 is only 120kg (below required)
  When planner drags WO to Dec 18
  Then warning dialog shows: "Material availability low for Sugar Fine (120 kg available, 150 kg needed)"
  And planner can choose "Proceed Anyway" or "Cancel"
```

### AC-10: Drag-to-Reschedule (Vertical - Line Change)

```gherkin
Scenario: Drag WO bar to different production line
  Given WO-00156 assigned to Packing Line #1
  When planner drags bar down to Baking Line #2 swimlane
  And releases drag
  Then confirmation dialog appears: "Reassign WO-00156 to Baking Line #2?"
  And shows warning if line incompatible with product

Scenario: Confirm line change
  Given line change confirmation dialog open
  When planner clicks "Confirm"
  Then API POST /api/planning/work-orders/{id}/reschedule called
  And WO bar moves to Baking Line #2 swimlane
  And production_line_id updated in database
  And success toast "WO-00156 reassigned to Baking Line #2" displays

Scenario: Line change validation - line compatibility warning
  Given WO-00156 product "Chocolate Bar" typically produced on Packing lines
  When planner drags to Baking Line #2 (not typical)
  Then warning shows: "Product not typically produced on this line"
  And planner can choose "Proceed Anyway" or "Cancel"
```

### AC-11: Scheduling Conflict Detection

```gherkin
Scenario: Check line availability before drop
  Given planner starts dragging WO-00156
  When planner hovers over Dec 18, 10:00 time slot on Packing Line #1
  Then API POST /api/planning/work-orders/check-availability called
  And ghost bar shows green border if available
  And ghost bar shows red border if conflict detected

Scenario: Detect overlapping WOs
  Given Packing Line #1 has WO-00160 scheduled Dec 18, 10:00-14:00
  When planner drags WO-00156 to Dec 18, 12:00-20:00 (overlaps)
  Then validation detects time conflict
  And error prevents drop: "Line already scheduled for this time slot"
  And conflicting WO highlighted in red

Scenario: Validate duration constraints
  Given planner drags WO bar handles to resize
  When duration becomes < 1 hour
  Then error shows: "Duration must be at least 1 hour"
  And resize reverts to 1 hour minimum

Scenario: Prevent scheduling in the past
  Given current date is Dec 16
  When planner drags WO to Dec 15 (past date)
  Then error shows: "Cannot schedule in the past"
  And WO bar reverts to original position
```

### AC-12: Export to PDF

```gherkin
Scenario: Export Gantt chart to PDF
  Given planner on Gantt chart page
  When planner clicks "Print" or "Export PDF" button
  Then API GET /api/planning/work-orders/schedule/export called
  And PDF generated with current filters applied
  And PDF includes date range, swimlanes, WO bars, legend
  And browser downloads PDF file: "wo-gantt-schedule-YYYY-MM-DD.pdf"

Scenario: PDF generation completes within 3s
  Given Gantt has 50 WOs across 5 lines, 7-day range
  When planner exports to PDF
  Then PDF generation completes within 3 seconds
  And file size < 2MB
```

### AC-13: Search WO by Number or Product

```gherkin
Scenario: Search WO by WO number
  Given Gantt displays 50 WOs
  When planner enters "WO-00156" in search box
  Then only WO-00156 bar displays
  And timeline auto-scrolls to WO date
  And WO bar highlighted

Scenario: Search WO by product name
  Given Gantt displays WOs for various products
  When planner enters "Chocolate" in search box
  Then only WOs with product name containing "Chocolate" display
  And other WOs hidden
```

### AC-14: Responsive Behavior

```gherkin
Scenario: Desktop view (>1024px)
  Given planner on desktop browser
  When Gantt chart loads
  Then full Gantt chart renders
  And drag-and-drop enabled for rescheduling
  And all zoom levels available
  And swimlane headers fixed on left

Scenario: Tablet view (768-1024px)
  Given planner on tablet device
  When Gantt chart loads
  Then condensed Gantt chart renders
  And bar height reduced to 40px
  And labels truncated to fit
  And long-press to reschedule (opens modal)

Scenario: Mobile view (<768px)
  Given planner on mobile device
  When Gantt chart loads
  Then list-based timeline view renders (NOT full Gantt)
  And swimlanes become collapsible sections
  And WO bars become cards within sections
  And long-press opens action menu with reschedule option
```

### AC-15: Performance Targets

```gherkin
Scenario: Gantt chart load time
  Given database has 50 WOs across 5 lines for 7-day range
  When planner loads Gantt chart page
  Then chart renders within 1 second
  And all WO bars display within 1.5 seconds

Scenario: Drag validation latency
  Given planner dragging WO bar
  When planner hovers over new time slot
  Then availability check completes within 200ms
  And visual feedback (green/red border) displays immediately

Scenario: Reschedule API response time
  Given planner confirms reschedule
  When API call sent
  Then response received within 800ms
  And WO bar position updates immediately
```

### AC-16: Future Features (Phase 2+)

Features deferred to Phase 2+:
- **WO Dependencies with Arrow Lines** - Visual arrows showing finish-to-start, start-to-start, finish-to-finish constraints
- **Capacity Utilization Indicators** - Bar under swimlane header showing % of line capacity used per day
- **Real-time Updates via WebSocket** - Auto-refresh Gantt when other users create/reschedule WOs
- **Batch Reschedule** - Select multiple WOs and reschedule together
- **Critical Path Highlighting** - Highlight WOs on critical path for on-time delivery
- **Resource Leveling** - Auto-suggest reschedules to balance line capacity
- **Multi-shift Support** - Color-code WO bars by shift (1st, 2nd, 3rd)
- **Custom Swimlane Grouping** - Group by product, priority, customer order

**Implementation**: Per Epic 03.0 guidance, hide or show as "Coming Soon".

---

## Implementation Notes

### API Endpoints

```typescript
// Get Gantt chart data with filters
GET /api/planning/work-orders/gantt
Query params:
  - view_by: 'line' | 'machine' (default: 'line')
  - from_date: string (ISO date, default: today)
  - to_date: string (ISO date, default: today + 30 days)
  - status[]: string[] (default: all except 'completed')
  - line_id?: string (UUID)
  - product_id?: string (UUID)
  - search?: string

Response:
{
  success: true,
  data: {
    swimlanes: [
      {
        id: string,           // line_id or machine_id
        name: string,         // line name or machine name
        type: 'line' | 'machine',
        capacity_hours_per_day?: number,
        work_orders: [
          {
            id: string,
            wo_number: string,
            product: {
              id: string,
              code: string,
              name: string
            },
            status: string,
            priority: string,
            quantity: number,
            uom: string,
            scheduled_date: string,      // ISO date
            scheduled_start_time: string, // HH:mm
            scheduled_end_time: string,   // HH:mm
            duration_hours: number,
            progress_percent?: number,
            material_status: 'ok' | 'low' | 'insufficient',
            is_overdue: boolean,
            created_at: string
          }
        ]
      }
    ],
    date_range: {
      from_date: string,
      to_date: string
    },
    filters_applied: {
      view_by: string,
      status: string[],
      line_id?: string,
      product_id?: string
    }
  }
}

// Reschedule WO (drag-and-drop)
POST /api/planning/work-orders/:id/reschedule
Body:
{
  scheduled_date: string,        // ISO date
  scheduled_start_time: string,  // HH:mm
  scheduled_end_time: string,    // HH:mm
  production_line_id?: string,   // UUID (if changing line)
  validate_dependencies: boolean,
  validate_materials: boolean
}

Response:
{
  success: true,
  data: {
    id: string,
    wo_number: string,
    scheduled_date: string,
    scheduled_start_time: string,
    scheduled_end_time: string,
    production_line_id: string,
    line_name: string,
    duration_hours: number
  },
  warnings: string[],  // e.g., "Material availability low for Sugar Fine"
  conflicts: []        // e.g., overlapping WOs
}

// Check line availability (pre-drop validation)
POST /api/planning/work-orders/check-availability
Body:
{
  line_id: string,
  scheduled_date: string,
  scheduled_start_time: string,
  scheduled_end_time: string,
  exclude_wo_id?: string  // current WO being dragged
}

Response:
{
  success: true,
  data: {
    is_available: boolean,
    conflicts: [
      {
        wo_id: string,
        wo_number: string,
        product_name: string,
        scheduled_start_time: string,
        scheduled_end_time: string
      }
    ],
    capacity_utilization: number,  // 0.0 to 1.0
    warnings: string[]
  }
}

// Export Gantt chart to PDF
GET /api/planning/work-orders/gantt/export
Query params:
  - format: 'pdf' (default)
  - from_date: string
  - to_date: string
  - view_by: 'line' | 'machine'
  - status[]: string[]

Response: Binary PDF file download
```

### Database

The work_orders table already exists (from 03.10). Key fields for Gantt:

```sql
-- work_orders table (from architecture/modules/planning.md)
id                  UUID PRIMARY KEY
org_id              UUID NOT NULL REFERENCES organizations(id)
wo_number           TEXT NOT NULL
product_id          UUID NOT NULL REFERENCES products(id)
status              TEXT DEFAULT 'draft'
planned_start_date  DATE
planned_end_date    DATE
scheduled_start_time TIME
scheduled_end_time  TIME
production_line_id  UUID REFERENCES production_lines(id)
machine_id          UUID REFERENCES machines(id)
priority            TEXT DEFAULT 'normal'
produced_quantity   DECIMAL(15,4) DEFAULT 0
planned_quantity    DECIMAL(15,4) NOT NULL
uom                 TEXT NOT NULL
created_at          TIMESTAMPTZ DEFAULT now()
updated_at          TIMESTAMPTZ DEFAULT now()

-- Indexes for Gantt performance
CREATE INDEX idx_work_orders_gantt_line
  ON work_orders(org_id, production_line_id, planned_start_date, scheduled_start_time)
  WHERE status != 'completed';

CREATE INDEX idx_work_orders_gantt_machine
  ON work_orders(org_id, machine_id, planned_start_date, scheduled_start_time)
  WHERE status != 'completed';

CREATE INDEX idx_work_orders_gantt_date_status
  ON work_orders(org_id, planned_start_date, status)
  WHERE status != 'completed';
```

No new tables required. Story uses existing work_orders schema.

### Frontend Components

```
app/(authenticated)/planning/work-orders/
  gantt/
    page.tsx                        -- Main Gantt chart page
    components/
      GanttChart.tsx                -- Main Gantt component
      GanttTimeline.tsx             -- Timeline header with date/time scale
      GanttSwimlane.tsx             -- Individual swimlane row
      GanttWOBar.tsx                -- Work order bar (draggable)
      GanttFilters.tsx              -- Filters bar (date, line, status, search)
      GanttLegend.tsx               -- Status color legend
      GanttQuickView.tsx            -- WO detail slide-in panel
      GanttRescheduleDialog.tsx     -- Confirmation dialog for reschedule
      GanttTodayIndicator.tsx       -- Vertical "today" line
      GanttEmptyState.tsx           -- Empty state when no WOs
      GanttErrorState.tsx           -- Error state on API failure
```

### Services

```typescript
// lib/services/gantt-service.ts
export async function getGanttData(params: {
  orgId: string;
  viewBy: 'line' | 'machine';
  fromDate: string;
  toDate: string;
  status?: string[];
  lineId?: string;
  productId?: string;
  search?: string;
}): Promise<GanttDataResponse> {
  // Build query with filters
  // Join work_orders with products, production_lines/machines
  // Group by swimlane (line_id or machine_id)
  // Calculate duration_hours, progress_percent, is_overdue, material_status
  // Return swimlanes array with work_orders nested
}

export async function rescheduleWO(params: {
  woId: string;
  scheduledDate: string;
  scheduledStartTime: string;
  scheduledEndTime: string;
  productionLineId?: string;
  validateDependencies: boolean;
  validateMaterials: boolean;
}): Promise<RescheduleResponse> {
  // Validate line availability (check overlaps)
  // Validate material availability (optional)
  // Update work_orders record
  // Return updated WO with warnings/conflicts
}

export async function checkLineAvailability(params: {
  lineId: string;
  scheduledDate: string;
  scheduledStartTime: string;
  scheduledEndTime: string;
  excludeWoId?: string;
}): Promise<AvailabilityCheckResponse> {
  // Query work_orders on same line, same date
  // Check for overlapping time ranges
  // Calculate capacity utilization
  // Return conflicts array if any
}

export async function exportGanttPDF(params: {
  orgId: string;
  fromDate: string;
  toDate: string;
  viewBy: 'line' | 'machine';
  status?: string[];
}): Promise<Buffer> {
  // Generate PDF using html2canvas + jsPDF
  // Render Gantt chart to canvas
  // Convert to PDF
  // Return binary buffer
}
```

### Validation (Zod)

```typescript
// lib/validation/gantt-schemas.ts
import { z } from 'zod';

export const getGanttDataSchema = z.object({
  view_by: z.enum(['line', 'machine']).default('line'),
  from_date: z.string().regex(/^\d{4}-\d{2}-\d{2}$/),
  to_date: z.string().regex(/^\d{4}-\d{2}-\d{2}$/),
  status: z.array(z.string()).optional(),
  line_id: z.string().uuid().optional(),
  product_id: z.string().uuid().optional(),
  search: z.string().optional()
});

export const rescheduleWOSchema = z.object({
  scheduled_date: z.string().regex(/^\d{4}-\d{2}-\d{2}$/),
  scheduled_start_time: z.string().regex(/^\d{2}:\d{2}$/),
  scheduled_end_time: z.string().regex(/^\d{2}:\d{2}$/),
  production_line_id: z.string().uuid().optional(),
  validate_dependencies: z.boolean().default(true),
  validate_materials: z.boolean().default(true)
}).refine(
  (data) => {
    // Validate start_time < end_time
    const start = new Date(`1970-01-01T${data.scheduled_start_time}`);
    const end = new Date(`1970-01-01T${data.scheduled_end_time}`);
    return start < end;
  },
  { message: 'scheduled_start_time must be before scheduled_end_time' }
).refine(
  (data) => {
    // Validate duration >= 1 hour
    const start = new Date(`1970-01-01T${data.scheduled_start_time}`);
    const end = new Date(`1970-01-01T${data.scheduled_end_time}`);
    const durationHours = (end.getTime() - start.getTime()) / (1000 * 60 * 60);
    return durationHours >= 1;
  },
  { message: 'Duration must be at least 1 hour' }
);

export const checkAvailabilitySchema = z.object({
  line_id: z.string().uuid(),
  scheduled_date: z.string().regex(/^\d{4}-\d{2}-\d{2}$/),
  scheduled_start_time: z.string().regex(/^\d{2}:\d{2}$/),
  scheduled_end_time: z.string().regex(/^\d{2}:\d{2}$/),
  exclude_wo_id: z.string().uuid().optional()
});
```

### Key Business Rules

1. **Swimlane Grouping**:
   - Default: Group by production_line_id (one swimlane per line)
   - Alternative: Group by machine_id (one swimlane per machine)
   - WOs with no line/machine assigned appear in "Unassigned" swimlane
   - Empty swimlanes (no WOs) hidden by default

2. **WO Bar Positioning**:
   - X-axis = time (horizontal position based on scheduled_start_time)
   - Y-axis = swimlane (vertical position based on line_id or machine_id)
   - Bar width = (scheduled_end_time - scheduled_start_time) in hours
   - If multiple WOs overlap on same line/time → stack vertically with 8px offset

3. **Date Range Defaults**:
   - Default from_date: today
   - Default to_date: today + 30 days
   - Presets: Today, This Week, This Month, Next Week, Next Month, Custom

4. **Status-Based Colors** (per PLAN-016 wireframe):
   - draft: #F3F4F6 (gray), dashed border
   - planned: #DBEAFE (blue)
   - released: #CFFAFE (cyan)
   - in_progress: #EDE9FE (purple) + progress bar overlay
   - on_hold: #FED7AA (orange)
   - completed: #D1FAE5 (green)
   - overdue: #FEE2E2 (red) + warning icon

5. **Overdue Detection**:
   - WO is overdue if: (scheduled_end_time < now) AND status NOT IN ('completed', 'closed')
   - Overdue WOs show red background and ⚠ icon

6. **Drag-and-Drop Validation**:
   - Horizontal drag (reschedule date/time): Check line availability, material availability
   - Vertical drag (change line): Check line compatibility, availability at new time slot
   - Prevent: Scheduling in past, overlapping WOs on same line, duration < 1 hour

7. **Scheduling Conflict Detection**:
   - Query: `SELECT * FROM work_orders WHERE org_id = ? AND production_line_id = ? AND planned_start_date = ? AND status != 'completed' AND id != ?`
   - Check time overlap: `(new_start < existing_end) AND (new_end > existing_start)`
   - If overlap exists → block drop, show error with conflicting WO details

8. **Material Availability Indicator** (if 03.11a completed):
   - Query wo_materials for WO, check available inventory
   - Status: 'ok' (all materials >= required), 'low' (some < required), 'insufficient' (blocking)
   - Display [!] icon on WO bar if status = 'low' or 'insufficient'

9. **Today Indicator**:
   - Vertical red dashed line at current date/time
   - Auto-updates every 60 seconds
   - Only visible if today within visible date range
   - Z-index highest to overlay all bars

10. **Zoom Level Time Scales**:
    - Day: 4-hour increments (8am, 12pm, 4pm, 8pm), 1-3 days visible
    - Week: Daily increments (Mon, Tue, Wed...), 7-14 days visible
    - Month: Weekly increments (Week 1, Week 2...), 30-60 days visible

---

## Deliverables

- API routes:
  - `GET /api/planning/work-orders/gantt` - Get Gantt data with filters
  - `POST /api/planning/work-orders/:id/reschedule` - Reschedule WO via drag-drop
  - `POST /api/planning/work-orders/check-availability` - Pre-drop validation
  - `GET /api/planning/work-orders/gantt/export` - Export to PDF

- Components:
  - `app/(authenticated)/planning/work-orders/gantt/page.tsx` - Main page
  - `GanttChart.tsx` - Main Gantt component
  - `GanttTimeline.tsx` - Timeline header
  - `GanttSwimlane.tsx` - Swimlane row
  - `GanttWOBar.tsx` - Draggable WO bar
  - `GanttFilters.tsx` - Filters bar
  - `GanttLegend.tsx` - Status legend
  - `GanttQuickView.tsx` - WO detail slide-in
  - `GanttRescheduleDialog.tsx` - Confirmation dialog
  - `GanttTodayIndicator.tsx` - Today line
  - `GanttEmptyState.tsx` - Empty state
  - `GanttErrorState.tsx` - Error state

- Services:
  - `lib/services/gantt-service.ts` - Gantt data aggregation, reschedule, availability check, PDF export

- Validation:
  - `lib/validation/gantt-schemas.ts` - Zod schemas for API validation

- Tests:
  - Unit tests: WO bar positioning, zoom calculations, overdue detection, color mapping, validation rules
  - Integration tests: API endpoints, RLS enforcement, cache invalidation, PDF generation
  - E2E tests: Page load, drag-drop reschedule, filters, zoom levels, quick view, empty/error states

---

## Definition of Done

- [ ] Gantt chart page renders within 1s for 50 WOs, 5 lines, 7-day range
- [ ] All 4 API endpoints implemented and tested
- [ ] Swimlanes group by production line (default) and machine (toggle)
- [ ] WO bars display with correct status colors per PLAN-016 wireframe
- [ ] Date range selector with presets (Today, This Week, This Month, Custom)
- [ ] Production line and status filters functional
- [ ] Search by WO number or product name
- [ ] Drag-to-reschedule (horizontal) updates scheduled date/time
- [ ] Drag-to-change-line (vertical) updates production_line_id
- [ ] Scheduling conflict validation blocks overlapping WOs
- [ ] Material availability warning shown if materials low
- [ ] WO detail quick view slide-in panel functional
- [ ] Zoom levels (Day, Week, Month) adjust timeline scale
- [ ] Today indicator displays vertical red line at current date/time
- [ ] Overdue WOs highlighted in red with ⚠ icon
- [ ] In-progress WOs show progress bar overlay
- [ ] Export to PDF generates valid PDF within 3s
- [ ] Empty state displays "No Work Orders Scheduled" with create button
- [ ] Error state displays retry button on API failure
- [ ] Responsive: Desktop (full Gantt), Tablet (condensed), Mobile (list-based timeline)
- [ ] API tests passing (>80% coverage)
- [ ] E2E smoke test for critical path (load, filter, drag-reschedule, export PDF)
- [ ] Performance: Gantt load <1s, drag validation <200ms, reschedule API <800ms, PDF export <3s
- [ ] RLS policies enforced (org_id isolation on all queries)
- [ ] Cache strategy implemented (2-min TTL for schedule data)

---

## Future Phases (Not in MVP)

### Phase 2

- **WO Dependencies with Arrow Lines** (FR-PLAN-024 extension)
  - Visual arrows connecting dependent WOs
  - Constraint types: Finish-to-Start, Start-to-Start, Finish-to-Finish
  - Dependency validation on reschedule
  - Auto-suggest reschedule if dependency broken

- **Capacity Utilization Indicators**
  - Bar under swimlane header showing % of line capacity used per day
  - Color-coded: 0-50% green, 50-80% yellow, 80-100% orange, >100% red
  - Capacity defined in production_lines.capacity_hours_per_day

- **Real-time Updates via WebSocket**
  - WebSocket channel: `planning:org:{orgId}:gantt`
  - Events: wo.created, wo.rescheduled, wo.status_changed, wo.progress_updated
  - Auto-refresh Gantt when other users make changes
  - Fallback to 60s polling if WebSocket unavailable

- **Batch Reschedule**
  - Select multiple WOs (checkbox or lasso select)
  - Reschedule all selected WOs together
  - Shift all by X days or assign all to new line

### Phase 3

- **Critical Path Highlighting**
  - Highlight WOs on critical path for on-time delivery
  - Calculate critical path based on dependencies and due dates
  - Red border for critical WOs

- **Resource Leveling**
  - Auto-suggest reschedules to balance line capacity
  - Algorithm: Minimize idle time, maximize utilization
  - "Auto-Level" button to apply suggestions

- **Multi-shift Support**
  - Color-code WO bars by shift (1st, 2nd, 3rd)
  - Filter by shift
  - Shift definitions in settings

- **Custom Swimlane Grouping**
  - Group by product, priority, customer order
  - Configurable in settings
  - Save custom views per user

**Implementation**: See Epic 03.0 "Future Feature Handling" section. Features marked as "Coming Soon" in UI.

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-12-16 | Initial story creation | Claude Sonnet 4.5 |
