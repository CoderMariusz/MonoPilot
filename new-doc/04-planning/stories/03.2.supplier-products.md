# 03.2 - Supplier-Product Assignments

**Priority**: P0 (MVP)
**Story Points**: S (Small)
**Type:** backend + frontend

**State:** ready
**Primary PRD:** `docs/1-BASELINE/product/modules/planning.md` (FR-PLAN-002, FR-PLAN-003)
**Architecture:** `docs/1-BASELINE/architecture/modules/planning.md`
**UX Wireframes:** PLA-002 (if available)

---

## MVP Scope

This story implements the supplier-product assignment junction table, enabling organizations to link products to suppliers with optional overrides for pricing, lead time, and MOQ. The default supplier designation enables automatic PO line population.

**MVP Includes**:
- Supplier-product assignment CRUD operations
- Default supplier selection per product (one-to-many)
- Supplier-specific overrides (price, lead time, MOQ, order multiple)
- Product assignment table in supplier detail view
- Auto-population of PO lines from default supplier data

**Deferred to Phase 1+**:
- Bulk supplier-product import
- Price history tracking
- Multi-currency conversion preview
- Supplier-product analytics

---

## Goal

Enable planners to manage which suppliers can provide which products, with configurable pricing and procurement terms, so that PO creation is fast and data-driven.

## User Story

As a **Planner**, I want to **assign products to suppliers with negotiated pricing and lead times** so that **purchase order creation is automated with accurate supplier-specific data**.

## Scope

**In scope (this story)**
- Supplier-product junction table (`supplier_products`)
- API endpoints for assigning/unassigning products to suppliers
- Supplier detail page showing assigned products table
- Product selector modal for assigning new products
- Default supplier toggle (one per product enforced)
- Supplier-specific overrides: `unit_price`, `currency`, `lead_time_days`, `moq`, `order_multiple`, `supplier_product_code`
- Validation: prevent duplicate supplier-product pairs, enforce single default per product
- Auto-update `last_purchase_date` and `last_purchase_price` on PO confirmation (future integration)

**Out of scope (this story)**
- Bulk import of supplier-product assignments (Phase 1)
- Price history tracking (Phase 1)
- Supplier performance analytics (Phase 3)
- Automated price updates from supplier catalogs (Phase 3)
- Multi-supplier comparison tool (Phase 1)

## Dependencies
- **01.1** - Org Context + RLS (required for multi-tenancy)
- **02.1** - Products CRUD (required for product_id FK)
- **03.1** - Suppliers CRUD (required for supplier_id FK)

## Acceptance Criteria (Given/When/Then)

### AC-1: Assign Product to Supplier

**Given** a user viewing a supplier detail page
**When** they click "Assign Product" and select a product from the dropdown
**Then** the product is linked to the supplier with default values (no price, no overrides) and appears in the supplier's products table

### AC-2: Supplier-Specific Pricing

**Given** a user assigning a product to a supplier
**When** they enter a `unit_price` and select a `currency`
**Then** the price is saved and displayed in the supplier-product table
**And** this price is used as the default when creating PO lines for this supplier-product pair

### AC-3: Default Supplier Designation

**Given** a product with multiple suppliers assigned
**When** a user toggles the "Default" checkbox for one supplier
**Then** only ONE supplier-product assignment has `is_default = true` for that product
**And** any previous default is automatically unset

### AC-4: Supplier-Specific Lead Time Override

**Given** a product with a default `supplier_lead_time_days` in the products table
**When** a user assigns the product to a supplier and specifies a different `lead_time_days`
**Then** the supplier-specific lead time is used for PO calculations for this supplier
**And** if no override is set, the product's default lead time is used

### AC-5: Prevent Duplicate Assignments

**Given** a product already assigned to a supplier
**When** a user attempts to assign the same product to the same supplier again
**Then** an error message "This product is already assigned to this supplier" is displayed
**And** the duplicate assignment is blocked

### AC-6: Supplier Product Code (SKU Mapping)

**Given** a user assigning a product to a supplier
**When** they enter a `supplier_product_code` (supplier's SKU)
**Then** the code is saved and displayed in the supplier-product table
**And** this code can be used for supplier communication and PO export

### AC-7: MOQ and Order Multiple

**Given** a user assigning a product to a supplier
**When** they specify `moq` (minimum order quantity) and `order_multiple`
**Then** these values override the product's default MOQ
**And** PO line validation warns if quantity < MOQ or not a multiple of `order_multiple`

### AC-8: Unassign Product from Supplier

**Given** a supplier-product assignment exists
**When** a user clicks "Remove" on the assignment
**Then** the assignment is deleted (no cascade to products or suppliers)
**And** the product no longer appears in the supplier's products list

### AC-9: Display Products on Supplier Detail Page

**Given** a supplier with assigned products
**When** a user views the supplier detail page
**Then** a "Products" table displays all assigned products with columns: Product Code, Product Name, Price, Currency, Lead Time, MOQ, Default
**And** the table supports search by product code or name

### AC-10: Auto-Update Last Purchase Data (Placeholder)

**Given** a PO line is created for a supplier-product pair
**When** the PO is confirmed (status = 'confirmed')
**Then** the `last_purchase_date` and `last_purchase_price` are updated in `supplier_products`
**And** this data is displayed in the supplier-product table for reference

**Note:** Full PO integration is implemented in Story 03.3. This AC is a placeholder for the update logic.

### AC-11: Future Features (Phase 1+)

Features deferred to Phase 1+:
- **Bulk Import** - Import supplier-product assignments from CSV/Excel
- **Price History** - Track historical pricing changes over time
- **Multi-Supplier Comparison** - Compare prices across suppliers for a product
- **Supplier Catalogs** - Auto-sync supplier catalogs via API

**Implementation**: Per Epic 03.0 guidance, hide or show as "Coming Soon".

---

## Implementation Notes

### API Endpoints

```typescript
// Get supplier's assigned products
GET /api/planning/suppliers/:supplierId/products
// Response: SupplierProduct[]

// Assign product to supplier
POST /api/planning/suppliers/:supplierId/products
// Body: { product_id: UUID, unit_price?: number, currency?: string, ... }
// Response: SupplierProduct

// Update supplier-product assignment
PUT /api/planning/suppliers/:supplierId/products/:productId
// Body: Partial<SupplierProduct>
// Response: SupplierProduct

// Remove product from supplier
DELETE /api/planning/suppliers/:supplierId/products/:productId
// Response: { success: true }

// Get default supplier for a product (used in PO creation)
GET /api/planning/products/:productId/default-supplier
// Response: SupplierProduct | null
```

### Database

```sql
-- Reference: docs/1-BASELINE/architecture/modules/planning.md

CREATE TABLE supplier_products (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  supplier_id UUID NOT NULL REFERENCES suppliers(id) ON DELETE CASCADE,
  product_id UUID NOT NULL REFERENCES products(id) ON DELETE CASCADE,
  is_default BOOLEAN DEFAULT false,
  supplier_product_code TEXT,
  unit_price DECIMAL(15,4),
  currency TEXT,
  moq DECIMAL(15,4),
  order_multiple DECIMAL(15,4),
  last_purchase_date DATE,
  last_purchase_price DECIMAL(15,4),
  notes TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),

  UNIQUE(supplier_id, product_id)
);

-- Indexes
CREATE INDEX idx_supplier_products_supplier ON supplier_products(supplier_id);
CREATE INDEX idx_supplier_products_product ON supplier_products(product_id);
CREATE INDEX idx_supplier_products_default ON supplier_products(product_id, is_default) WHERE is_default = true;

-- RLS Policies
CREATE POLICY "Supplier-products org isolation"
ON supplier_products FOR ALL
USING (
  supplier_id IN (SELECT id FROM suppliers WHERE org_id = (SELECT org_id FROM users WHERE id = auth.uid()))
);
```

**Migration Name:** `create_supplier_products_table.sql`

**Note:** Lead time and MOQ are stored at product level (`products.supplier_lead_time_days`, `products.moq`) per ADR-010. The `supplier_products` table provides optional supplier-specific overrides.

### Frontend Components

```
app/(authenticated)/planning/suppliers/[id]/
  page.tsx                                  -- Supplier detail page with products tab

components/planning/
  SupplierProductsTable.tsx                 -- DataTable of assigned products
  AssignProductModal.tsx                    -- Modal to assign new product
  SupplierProductForm.tsx                   -- Form for price/lead time overrides
  ProductSelectorCombobox.tsx               -- Searchable product dropdown
```

### Services

```typescript
// lib/services/supplier-product-service.ts

export async function getSupplierProducts(supplierId: string): Promise<SupplierProduct[]> {
  // Fetch supplier_products with joined product data
  // Filter by supplier_id
  // Return array ordered by product code
}

export async function assignProductToSupplier(
  supplierId: string,
  data: AssignProductInput
): Promise<SupplierProduct> {
  // Validate supplier and product exist in org
  // Check for duplicate supplier_id + product_id
  // If is_default=true, unset other defaults for this product
  // Insert supplier_products record
  // Return created record
}

export async function updateSupplierProduct(
  supplierId: string,
  productId: string,
  data: Partial<SupplierProduct>
): Promise<SupplierProduct> {
  // Validate assignment exists
  // If is_default=true, unset other defaults for this product
  // Update supplier_products record
  // Return updated record
}

export async function removeSupplierProduct(
  supplierId: string,
  productId: string
): Promise<void> {
  // Delete supplier_products record
  // No cascade to products or suppliers
}

export async function getDefaultSupplierForProduct(
  productId: string
): Promise<SupplierProduct | null> {
  // Fetch supplier_products where product_id = productId AND is_default = true
  // Join with supplier to get supplier details
  // Return single record or null
}

export async function updateLastPurchaseData(
  supplierId: string,
  productId: string,
  price: number,
  date: Date
): Promise<void> {
  // Called from PO confirmation (Story 03.3)
  // Update last_purchase_date and last_purchase_price
}
```

### Validation (Zod)

```typescript
// lib/validation/supplier-product-validation.ts

import { z } from 'zod';

export const assignProductSchema = z.object({
  product_id: z.string().uuid('Product ID must be a valid UUID'),
  is_default: z.boolean().default(false),
  supplier_product_code: z.string().max(50).optional().nullable(),
  unit_price: z.number().positive('Price must be positive').optional().nullable(),
  currency: z.enum(['PLN', 'EUR', 'USD', 'GBP']).optional().nullable(),
  moq: z.number().positive('MOQ must be positive').optional().nullable(),
  order_multiple: z.number().positive('Order multiple must be positive').optional().nullable(),
  notes: z.string().max(1000).optional().nullable(),
});

export const updateSupplierProductSchema = assignProductSchema.partial().omit({ product_id: true });

export type AssignProductInput = z.infer<typeof assignProductSchema>;
export type UpdateSupplierProductInput = z.infer<typeof updateSupplierProductSchema>;
```

### Key Business Rules

1. **Single Default per Product:** Only one `supplier_products` record per product can have `is_default = true`. When setting a new default, automatically unset the previous one.

2. **Lead Time Resolution:** PO expected delivery date calculation:
   ```typescript
   const leadTime = supplierProduct.lead_time_days ?? product.supplier_lead_time_days ?? 0;
   const expectedDeliveryDate = addDays(orderDate, leadTime);
   ```

3. **MOQ Resolution:** PO line validation uses:
   ```typescript
   const moq = supplierProduct.moq ?? product.moq ?? 0;
   ```

4. **Currency Default:** If `supplier_products.currency` is NULL, use `suppliers.currency` as default.

5. **Cascade Delete:** ON DELETE CASCADE for supplier_id and product_id ensures orphaned records are cleaned up.

6. **Last Purchase Auto-Update:** When a PO is confirmed (Story 03.3), call `updateLastPurchaseData()` to track most recent purchase info.

7. **Price Display:** Always display price with currency symbol. Use organization's locale settings for formatting.

---

## Deliverables

### API Routes
- `GET /api/planning/suppliers/:supplierId/products`
- `POST /api/planning/suppliers/:supplierId/products`
- `PUT /api/planning/suppliers/:supplierId/products/:productId`
- `DELETE /api/planning/suppliers/:supplierId/products/:productId`
- `GET /api/planning/products/:productId/default-supplier`

### Components
- `SupplierProductsTable.tsx` - DataTable with search, sort, pagination
- `AssignProductModal.tsx` - Modal dialog for assigning products
- `SupplierProductForm.tsx` - Form with price, lead time, MOQ fields
- `ProductSelectorCombobox.tsx` - Searchable product dropdown (reusable)

### Services
- `supplier-product-service.ts` - All business logic for supplier-product assignments

### Database
- Migration: `create_supplier_products_table.sql`
- RLS policies for org isolation
- Indexes for performance

### Tests
- Unit tests for service layer (>80% coverage)
- API tests for all endpoints
- E2E test: Assign product to supplier, set default, verify in PO creation

---

## Definition of Done

- [ ] `supplier_products` table created with RLS policies
- [ ] All 5 API endpoints implemented and tested
- [ ] `SupplierProductsTable` displays assigned products with search/filter
- [ ] `AssignProductModal` successfully assigns products with validation
- [ ] Default supplier toggle works (only one default per product)
- [ ] Duplicate assignment prevention working
- [ ] Service layer business logic implemented (default toggle, lead time resolution)
- [ ] Zod validation schemas implemented and tested
- [ ] Unit tests passing (>80% coverage)
- [ ] API integration tests passing
- [ ] E2E smoke test: Assign product, set default, verify data
- [ ] Performance: Supplier detail page loads assigned products in <500ms for 100 products
- [ ] RLS verified: Users can only see supplier-products for their org
- [ ] Code reviewed and approved
- [ ] Documentation updated (API docs, schema docs)

---

## Future Phases (Not in MVP)

### Phase 1
- **Bulk Import** - CSV/Excel import for supplier-product assignments with price updates
- **Price History Tracking** - Track all price changes over time with effective dates
- **Multi-Supplier Comparison** - UI to compare prices across suppliers for a product
- **Supplier Catalogs** - Upload and parse supplier catalogs (PDF, Excel)
- **Negotiated Price Alerts** - Notify when actual PO price deviates from negotiated price

### Phase 2
- **Automated Price Updates** - API integration to sync supplier pricing automatically
- **Contract Management** - Link supplier-product assignments to contracts with term dates
- **Volume Discounts** - Tiered pricing based on order quantity
- **Multi-Currency Conversion** - Real-time FX rates for price comparison

### Phase 3
- **EDI Integration** - Auto-sync supplier catalogs via EDI/EDIFACT
- **Vendor Managed Inventory (VMI)** - Supplier portal to update pricing and lead times
- **AI Price Suggestions** - ML-based pricing recommendations based on market data

**Implementation**: See Epic 03.0 "Future Feature Handling" section.

---

## Technical Notes

### Performance Considerations

1. **Lazy Loading:** Load supplier-products only when "Products" tab is selected on supplier detail page
2. **Pagination:** For suppliers with >100 products, paginate table (20 per page)
3. **Caching:** Cache default supplier lookups for 5 minutes (used frequently in PO creation)
4. **Index Usage:** Ensure queries use `idx_supplier_products_product` when fetching by product_id

### Security

1. **RLS Enforcement:** All queries filtered by org_id through supplier FK
2. **Role Check:** Only Admin, Planner roles can assign/modify supplier-products
3. **Input Sanitization:** Zod validation prevents SQL injection and XSS
4. **Audit Trail:** Log all assignment changes for compliance

### Integration Points

| Upstream | Data Received | Usage |
|----------|---------------|-------|
| Epic 01 (Settings) | org_id, tax_codes | Multi-tenancy, tax defaults |
| Epic 02 (Technical) | products | Product dropdown, default values |
| Epic 03.1 (Suppliers) | suppliers | Supplier dropdown, currency defaults |

| Downstream | Data Provided | Usage |
|------------|---------------|-------|
| Epic 03.3 (PO CRUD) | Default supplier, prices, lead times | Auto-populate PO lines |
| Epic 03.4 (Bulk PO) | Default suppliers by product | Group products by supplier |

### Migration Strategy

**Migration Name:** `YYYYMMDDHHMMSS_create_supplier_products_table.sql`

```sql
-- Create table
CREATE TABLE supplier_products (...);

-- Create indexes
CREATE INDEX idx_supplier_products_supplier ON supplier_products(supplier_id);
CREATE INDEX idx_supplier_products_product ON supplier_products(product_id);
CREATE INDEX idx_supplier_products_default ON supplier_products(product_id, is_default) WHERE is_default = true;

-- Enable RLS
ALTER TABLE supplier_products ENABLE ROW LEVEL SECURITY;

-- Create RLS policy
CREATE POLICY "Supplier-products org isolation"
ON supplier_products FOR ALL
USING (
  supplier_id IN (SELECT id FROM suppliers WHERE org_id = (SELECT org_id FROM users WHERE id = auth.uid()))
);

-- Grant permissions
GRANT ALL ON supplier_products TO authenticated;
```

---

## Open Questions

1. **Q:** Should we validate that `currency` matches supplier's default currency?
   **A:** No. Allow override to support multi-currency purchases (supplier may accept multiple currencies).

2. **Q:** What happens if a product assigned to a supplier is deleted?
   **A:** ON DELETE CASCADE removes the supplier_products record automatically.

3. **Q:** Can a supplier have the same product assigned twice with different prices?
   **A:** No. UNIQUE(supplier_id, product_id) constraint prevents duplicates.

4. **Q:** Should we track who assigned the product to the supplier?
   **A:** Not in MVP. Could add `assigned_by` and `assigned_at` in Phase 1 for audit purposes.

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-12-16 | Initial story creation | ARCHITECT-AGENT |
