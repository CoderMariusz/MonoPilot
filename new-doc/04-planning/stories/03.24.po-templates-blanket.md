# 03.24 - PO Templates & Blanket POs

**Story ID:** 03.24
**Epic:** 03 - Planning
**Phase:** Phase 2
**Complexity:** M (Medium)
**Estimate:** 4-5 days
**Type:** Full-stack
**State:** ready

**Primary PRD:** `docs/1-BASELINE/product/modules/PLANNING.md` (FR-PLAN-041, FR-PLAN-042)
**UX Wireframes:** PLA-024 (Template List), PLA-025 (Template Form), PLA-026 (Blanket PO Detail)

## PRD References

| FR ID | Requirement | Priority | Phase | Covered |
|-------|-------------|----------|-------|---------|
| FR-PLAN-041 | PO Templates | Should Have | 2 | Yes |
| FR-PLAN-042 | Blanket POs | Could Have | 2 | Yes |

## User Story

**As a** Planner or Purchaser,
**I want** to create and use purchase order templates for recurring orders,
**So that** I can quickly generate POs without re-entering the same supplier, products, and quantities each time.

**As a** Purchaser,
**I want** to manage blanket purchase orders with scheduled releases,
**So that** I can negotiate long-term supplier agreements with locked pricing and track commitment fulfillment.

## Goal

Implement PO templates for reusable order patterns and blanket POs for long-term agreements. Templates allow quick PO creation from saved configurations. Blanket POs enable standing orders with multiple releases against a committed quantity over time.

## Scope

**In scope:**
- PO template CRUD (create, read, update, delete)
- Template with supplier, warehouse, and default items
- Create PO from template (pre-fill all fields)
- Template categories for organization
- Template sharing (organization-wide or user-specific)
- Blanket PO creation (long-term agreement flag)
- Blanket PO commitment tracking (total qty, released qty)
- Blanket PO releases (call-off orders)
- Release scheduling and tracking
- Price locking for blanket period
- Remaining commitment visibility
- Template auto-generation (optional scheduled PO creation)

**Out of scope:**
- EDI integration for blanket orders (Phase 3)
- Supplier portal for blanket visibility (Phase 3)
- Complex pricing tiers within blanket (fixed price only)
- Multi-currency blanket POs (single currency per blanket)

## Dependencies

| Story | Requirement | Status |
|-------|-------------|--------|
| 03.3 | PO CRUD + Lines | Required - base PO functionality |
| 03.1 | Suppliers CRUD | Required - template supplier reference |
| 01.8 | Warehouses CRUD | Required - template warehouse reference |
| 02.1 | Products CRUD | Required - template line products |

## Acceptance Criteria (Given/When/Then)

### PO Templates (FR-PLAN-041)

#### Template CRUD

- GIVEN user navigates to `/planning/purchase-orders/templates`, WHEN page loads, THEN template list displays with name, supplier, items count, last used date.
- GIVEN user clicks "New Template", WHEN form opens, THEN fields include: name, description, supplier, warehouse, category, is_shared, items.
- GIVEN user enters template name "Weekly Flour Order", WHEN saving, THEN template created with unique ID.
- GIVEN user edits existing template, WHEN changes saved, THEN template updated and updated_at timestamp refreshed.
- GIVEN user deletes template, WHEN confirmed, THEN template and all template lines removed.

#### Template Fields

- GIVEN user creates template, WHEN supplier selected, THEN default currency and payment terms inherit from supplier.
- GIVEN user adds template line, WHEN product selected, THEN default quantity can be set (required) and notes (optional).
- GIVEN template has 5 product lines, WHEN viewing template detail, THEN all lines display with product code, name, quantity, UoM.
- GIVEN template has no supplier set, WHEN creating PO from template, THEN user must select supplier before proceeding.

#### Create PO from Template

- GIVEN user clicks "Create PO" on template "Weekly Flour Order", WHEN action triggered, THEN new PO form opens pre-filled with template data.
- GIVEN PO created from template, WHEN form displays, THEN supplier, warehouse, and all lines pre-populated.
- GIVEN PO created from template, WHEN user reviews, THEN all quantities and prices editable before saving.
- GIVEN PO created from template, WHEN saved, THEN PO created in "draft" status with reference to source template.
- GIVEN template has 3 items, WHEN PO created, THEN all 3 items appear as PO lines with current supplier-product prices.
- GIVEN template product has no current supplier price, WHEN PO created, THEN falls back to product.std_price.

#### Template Categories

- GIVEN user creates template, WHEN category field shown, THEN can select from: Raw Materials, Packaging, Ingredients, Supplies, Other.
- GIVEN template list displayed, WHEN filtering by category "Packaging", THEN only packaging templates shown.
- GIVEN category is optional, WHEN creating template without category, THEN template saved with category = null.

#### Template Sharing

- GIVEN user creates template with is_shared = false, WHEN other users view templates, THEN private template not visible.
- GIVEN user creates template with is_shared = true, WHEN other users view templates, THEN shared template visible to all org users.
- GIVEN shared template, WHEN non-creator user edits, THEN changes saved (any org user can modify shared templates).
- GIVEN private template, WHEN creator views list, THEN marked with "Private" badge.

#### Auto-Generate (Optional)

- GIVEN template has auto_generate = true, WHEN frequency set to "weekly", THEN next_generate_date calculated.
- GIVEN scheduled generation date reached, WHEN system job runs, THEN draft PO created automatically from template.
- GIVEN auto-generated PO created, WHEN created, THEN notification sent to template owner.
- GIVEN auto-generate disabled (default), WHEN template saved, THEN no scheduled generation occurs.

### Blanket POs (FR-PLAN-042)

#### Blanket PO Creation

- GIVEN user creates new PO, WHEN "Blanket Order" checkbox enabled, THEN blanket-specific fields appear.
- GIVEN blanket order enabled, WHEN form shown, THEN additional fields: agreement_start, agreement_end, total_commitment, price_locked.
- GIVEN blanket PO created, WHEN saved, THEN is_blanket = true and released_qty = 0.
- GIVEN blanket PO header, WHEN viewing, THEN shows commitment progress bar (released_qty / total_commitment).

#### Blanket Agreement Fields

- GIVEN blanket PO form, WHEN entering dates, THEN agreement_start must be <= agreement_end.
- GIVEN blanket PO with price_locked = true, WHEN release created, THEN release uses blanket line prices (not current prices).
- GIVEN blanket agreement expired (current_date > agreement_end), WHEN creating release, THEN warning "Agreement expired" displays but release still allowed.
- GIVEN blanket PO total_commitment = 10000 kg, WHEN released_qty = 8000 kg, THEN remaining = 2000 kg displayed.

#### Blanket PO Releases (Call-Off Orders)

- GIVEN blanket PO confirmed, WHEN user clicks "Create Release", THEN release PO form opens linked to blanket.
- GIVEN release PO form, WHEN opened, THEN supplier, warehouse pre-filled from blanket PO.
- GIVEN release PO, WHEN line added, THEN only products from blanket lines available for selection.
- GIVEN release quantity entered, WHEN exceeds remaining commitment, THEN warning "Release exceeds remaining commitment" displays.
- GIVEN release PO saved, WHEN completed, THEN blanket.released_qty updated (sum of all release line quantities).
- GIVEN release PO, WHEN saved, THEN parent_po_id references blanket PO header.

#### Release Tracking

- GIVEN blanket PO detail page, WHEN viewing, THEN "Releases" tab shows all release orders.
- GIVEN releases tab, WHEN displayed, THEN columns: Release #, Date, Quantity, Status, Received Qty.
- GIVEN 5 releases created for blanket, WHEN viewing releases tab, THEN all 5 display sorted by created_at desc.
- GIVEN release PO received, WHEN fully received, THEN blanket PO commitment tracking updates.

#### Blanket PO Lifecycle

- GIVEN blanket PO in draft, WHEN confirmed, THEN status = "confirmed" and releases can be created.
- GIVEN blanket PO fully released (released_qty >= total_commitment), WHEN viewing, THEN status = "fully_released".
- GIVEN blanket agreement expired AND not fully released, WHEN viewing, THEN status = "expired".
- GIVEN blanket PO with releases, WHEN attempting delete, THEN blocked with error "Cannot delete blanket PO with releases".
- GIVEN blanket PO without releases, WHEN user cancels, THEN blanket PO cancelled with status = "cancelled".

#### Price Locking

- GIVEN blanket PO with price_locked = true, WHEN release created, THEN line unit_price copied from blanket lines.
- GIVEN release from blanket, WHEN prices locked, THEN price fields read-only on release form.
- GIVEN blanket PO with price_locked = false, WHEN release created, THEN current supplier-product prices used.

### Multi-tenancy

- GIVEN User A from Org A, WHEN requesting templates, THEN only Org A templates returned.
- GIVEN User A from Org A, WHEN attempting to access Org B template, THEN 404 Not Found returns.
- GIVEN User A from Org A, WHEN creating blanket release for Org B blanket PO, THEN 404 Not Found returns.

### Permission Enforcement

- GIVEN user with PLANNER role, WHEN accessing templates, THEN full CRUD available.
- GIVEN user with VIEWER role, WHEN accessing templates, THEN read-only access.
- GIVEN user with PURCHASER role, WHEN creating blanket release, THEN action allowed.
- GIVEN user without PO permissions, WHEN accessing templates page, THEN 403 Forbidden returns.

## Technical Specification

### Database Schema

#### po_templates table

```sql
CREATE TABLE po_templates (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,

  -- Template info
  name VARCHAR(100) NOT NULL,
  description TEXT,
  category VARCHAR(50), -- 'raw_materials', 'packaging', 'ingredients', 'supplies', 'other'

  -- Default values for PO
  supplier_id UUID REFERENCES suppliers(id),
  warehouse_id UUID REFERENCES warehouses(id),
  currency VARCHAR(3) DEFAULT 'PLN',
  payment_terms VARCHAR(50),

  -- Sharing
  is_shared BOOLEAN DEFAULT true, -- org-wide visibility
  created_by UUID REFERENCES users(id),

  -- Auto-generation (optional)
  frequency VARCHAR(20), -- 'weekly', 'biweekly', 'monthly', 'quarterly', 'custom'
  auto_generate BOOLEAN DEFAULT false,
  next_generate_date DATE,
  last_generated_at TIMESTAMPTZ,

  -- Status
  is_active BOOLEAN DEFAULT true,
  last_used_at TIMESTAMPTZ,
  use_count INTEGER DEFAULT 0,

  -- Audit
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),

  CONSTRAINT po_templates_org_name_unique UNIQUE(org_id, name),
  CONSTRAINT po_templates_category_check CHECK (
    category IS NULL OR category IN ('raw_materials', 'packaging', 'ingredients', 'supplies', 'other')
  ),
  CONSTRAINT po_templates_frequency_check CHECK (
    frequency IS NULL OR frequency IN ('weekly', 'biweekly', 'monthly', 'quarterly', 'custom')
  )
);

-- Indexes
CREATE INDEX idx_po_templates_org_id ON po_templates(org_id);
CREATE INDEX idx_po_templates_supplier ON po_templates(supplier_id);
CREATE INDEX idx_po_templates_category ON po_templates(org_id, category);
CREATE INDEX idx_po_templates_active ON po_templates(org_id) WHERE is_active = true;
CREATE INDEX idx_po_templates_auto_gen ON po_templates(next_generate_date) WHERE auto_generate = true;
```

#### po_template_lines table

```sql
CREATE TABLE po_template_lines (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  template_id UUID NOT NULL REFERENCES po_templates(id) ON DELETE CASCADE,

  -- Line info
  line_number INTEGER NOT NULL,
  product_id UUID NOT NULL REFERENCES products(id),
  quantity NUMERIC(15,4) NOT NULL,
  uom VARCHAR(20) NOT NULL,
  notes TEXT,

  -- Audit
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),

  CONSTRAINT po_template_lines_unique UNIQUE(template_id, line_number),
  CONSTRAINT po_template_lines_product_unique UNIQUE(template_id, product_id),
  CONSTRAINT po_template_lines_qty_positive CHECK (quantity > 0)
);

-- Indexes
CREATE INDEX idx_po_template_lines_template ON po_template_lines(template_id);
CREATE INDEX idx_po_template_lines_product ON po_template_lines(product_id);
```

#### purchase_orders table extension (Blanket PO)

```sql
-- Add blanket PO fields to existing purchase_orders table
ALTER TABLE purchase_orders ADD COLUMN IF NOT EXISTS
  is_blanket BOOLEAN DEFAULT false;

ALTER TABLE purchase_orders ADD COLUMN IF NOT EXISTS
  parent_po_id UUID REFERENCES purchase_orders(id);

ALTER TABLE purchase_orders ADD COLUMN IF NOT EXISTS
  agreement_start DATE;

ALTER TABLE purchase_orders ADD COLUMN IF NOT EXISTS
  agreement_end DATE;

ALTER TABLE purchase_orders ADD COLUMN IF NOT EXISTS
  total_commitment NUMERIC(15,4);

ALTER TABLE purchase_orders ADD COLUMN IF NOT EXISTS
  released_qty NUMERIC(15,4) DEFAULT 0;

ALTER TABLE purchase_orders ADD COLUMN IF NOT EXISTS
  price_locked BOOLEAN DEFAULT false;

ALTER TABLE purchase_orders ADD COLUMN IF NOT EXISTS
  source_template_id UUID REFERENCES po_templates(id);

-- Constraints
ALTER TABLE purchase_orders ADD CONSTRAINT po_blanket_dates_check
  CHECK (NOT is_blanket OR (agreement_start IS NOT NULL AND agreement_end IS NOT NULL AND agreement_start <= agreement_end));

ALTER TABLE purchase_orders ADD CONSTRAINT po_blanket_commitment_check
  CHECK (NOT is_blanket OR total_commitment > 0);

ALTER TABLE purchase_orders ADD CONSTRAINT po_release_parent_check
  CHECK (parent_po_id IS NULL OR NOT is_blanket);

-- Indexes
CREATE INDEX idx_po_blanket ON purchase_orders(org_id) WHERE is_blanket = true;
CREATE INDEX idx_po_parent ON purchase_orders(parent_po_id) WHERE parent_po_id IS NOT NULL;
CREATE INDEX idx_po_template ON purchase_orders(source_template_id) WHERE source_template_id IS NOT NULL;
```

### RLS Policies

```sql
-- Enable RLS
ALTER TABLE po_templates ENABLE ROW LEVEL SECURITY;
ALTER TABLE po_template_lines ENABLE ROW LEVEL SECURITY;

-- PO Templates: Org isolation with shared/private logic
CREATE POLICY "po_templates_select" ON po_templates
FOR SELECT TO authenticated
USING (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  AND (is_shared = true OR created_by = auth.uid())
);

CREATE POLICY "po_templates_insert" ON po_templates
FOR INSERT TO authenticated
WITH CHECK (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  AND (
    (SELECT r.code FROM roles r JOIN users u ON u.role_id = r.id WHERE u.id = auth.uid())
    IN ('SUPER_ADMIN', 'ADMIN', 'PLANNER', 'PURCHASER')
  )
);

CREATE POLICY "po_templates_update" ON po_templates
FOR UPDATE TO authenticated
USING (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  AND (is_shared = true OR created_by = auth.uid())
  AND (
    (SELECT r.code FROM roles r JOIN users u ON u.role_id = r.id WHERE u.id = auth.uid())
    IN ('SUPER_ADMIN', 'ADMIN', 'PLANNER', 'PURCHASER')
  )
);

CREATE POLICY "po_templates_delete" ON po_templates
FOR DELETE TO authenticated
USING (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  AND (created_by = auth.uid() OR
    (SELECT r.code FROM roles r JOIN users u ON u.role_id = r.id WHERE u.id = auth.uid())
    IN ('SUPER_ADMIN', 'ADMIN')
  )
);

-- PO Template Lines: Access through template
CREATE POLICY "po_template_lines_select" ON po_template_lines
FOR SELECT TO authenticated
USING (
  EXISTS (
    SELECT 1 FROM po_templates t
    WHERE t.id = po_template_lines.template_id
      AND t.org_id = (SELECT org_id FROM users WHERE id = auth.uid())
      AND (t.is_shared = true OR t.created_by = auth.uid())
  )
);

CREATE POLICY "po_template_lines_insert" ON po_template_lines
FOR INSERT TO authenticated
WITH CHECK (
  EXISTS (
    SELECT 1 FROM po_templates t
    WHERE t.id = po_template_lines.template_id
      AND t.org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  )
);

CREATE POLICY "po_template_lines_update" ON po_template_lines
FOR UPDATE TO authenticated
USING (
  EXISTS (
    SELECT 1 FROM po_templates t
    WHERE t.id = po_template_lines.template_id
      AND t.org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  )
);

CREATE POLICY "po_template_lines_delete" ON po_template_lines
FOR DELETE TO authenticated
USING (
  EXISTS (
    SELECT 1 FROM po_templates t
    WHERE t.id = po_template_lines.template_id
      AND t.org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  )
);
```

### API Endpoints

```
# PO Templates
GET    /api/v1/planning/po-templates                        - List templates (paginated, filtered)
POST   /api/v1/planning/po-templates                        - Create template with lines
GET    /api/v1/planning/po-templates/:id                    - Get template with lines
PUT    /api/v1/planning/po-templates/:id                    - Update template
DELETE /api/v1/planning/po-templates/:id                    - Delete template

# Template Actions
POST   /api/v1/planning/po-templates/:id/create-po          - Create PO from template
POST   /api/v1/planning/po-templates/:id/duplicate          - Duplicate template

# Template Lines
POST   /api/v1/planning/po-templates/:id/lines              - Add line to template
PUT    /api/v1/planning/po-templates/:id/lines/:lineId      - Update template line
DELETE /api/v1/planning/po-templates/:id/lines/:lineId      - Delete template line

# Blanket POs
GET    /api/v1/planning/purchase-orders/blanket             - List blanket POs
POST   /api/v1/planning/purchase-orders/blanket             - Create blanket PO
GET    /api/v1/planning/purchase-orders/:id/releases        - List releases for blanket PO
POST   /api/v1/planning/purchase-orders/:id/releases        - Create release from blanket

# Blanket PO Analytics
GET    /api/v1/planning/purchase-orders/:id/commitment      - Get commitment summary
```

**Query Parameters (Templates List):**
- `search` - Filter by template name (min 2 chars)
- `category` - Filter by category
- `supplier_id` - Filter by supplier
- `is_shared` - Filter by shared status (true/false)
- `is_active` - Filter by active status (true/false)
- `sort` - Sort field (name, created_at, last_used_at, use_count)
- `order` - Sort order (asc, desc)
- `page` - Page number (default 1)
- `limit` - Items per page (default 20, max 100)

### Service Methods

**Location:** `lib/services/po-template-service.ts`

```typescript
interface POTemplateService {
  // Template CRUD
  list(params: TemplateListParams): Promise<PaginatedResult<POTemplateListItem>>;
  getById(id: string): Promise<POTemplateWithLines | null>;
  create(data: CreateTemplateInput): Promise<POTemplateWithLines>;
  update(id: string, data: UpdateTemplateInput): Promise<POTemplateWithLines>;
  delete(id: string): Promise<void>;

  // Template actions
  createPOFromTemplate(templateId: string, overrides?: CreatePOOverrides): Promise<PurchaseOrder>;
  duplicateTemplate(id: string, newName: string): Promise<POTemplateWithLines>;

  // Template lines
  addLine(templateId: string, line: CreateTemplateLineInput): Promise<POTemplateLine>;
  updateLine(templateId: string, lineId: string, data: UpdateTemplateLineInput): Promise<POTemplateLine>;
  deleteLine(templateId: string, lineId: string): Promise<void>;

  // Auto-generation
  getScheduledTemplates(): Promise<POTemplate[]>;
  generateScheduledPOs(): Promise<PurchaseOrder[]>;
  calculateNextGenerateDate(frequency: string, fromDate?: Date): Date;

  // Stats
  incrementUseCount(id: string): Promise<void>;
}

interface POTemplate {
  id: string;
  org_id: string;
  name: string;
  description: string | null;
  category: TemplateCategory | null;
  supplier_id: string | null;
  warehouse_id: string | null;
  currency: string;
  payment_terms: string | null;
  is_shared: boolean;
  created_by: string;
  frequency: TemplateFrequency | null;
  auto_generate: boolean;
  next_generate_date: string | null;
  last_generated_at: string | null;
  is_active: boolean;
  last_used_at: string | null;
  use_count: number;
  created_at: string;
  updated_at: string;
}

interface POTemplateLine {
  id: string;
  template_id: string;
  line_number: number;
  product_id: string;
  quantity: number;
  uom: string;
  notes: string | null;
  product?: {
    code: string;
    name: string;
  };
}

type TemplateCategory = 'raw_materials' | 'packaging' | 'ingredients' | 'supplies' | 'other';
type TemplateFrequency = 'weekly' | 'biweekly' | 'monthly' | 'quarterly' | 'custom';
```

**Location:** `lib/services/blanket-po-service.ts`

```typescript
interface BlanketPOService {
  // Blanket PO CRUD
  listBlanketPOs(params: BlanketListParams): Promise<PaginatedResult<BlanketPOListItem>>;
  createBlanketPO(data: CreateBlanketPOInput): Promise<PurchaseOrder>;

  // Releases
  listReleases(blanketPoId: string): Promise<PurchaseOrder[]>;
  createRelease(blanketPoId: string, data: CreateReleaseInput): Promise<PurchaseOrder>;

  // Commitment tracking
  getCommitmentSummary(blanketPoId: string): Promise<CommitmentSummary>;
  updateReleasedQty(blanketPoId: string): Promise<void>;

  // Validation
  validateReleaseQuantity(blanketPoId: string, lineQuantities: LineQuantity[]): ValidationResult;
  canCreateRelease(blanketPoId: string): Promise<{ allowed: boolean; reason?: string }>;

  // Status helpers
  getBlanketStatus(blanketPO: PurchaseOrder): BlanketStatus;
  isAgreementExpired(blanketPO: PurchaseOrder): boolean;
  isFullyReleased(blanketPO: PurchaseOrder): boolean;
}

interface CommitmentSummary {
  blanket_po_id: string;
  total_commitment: number;
  released_qty: number;
  remaining_qty: number;
  release_count: number;
  percentage_released: number;
  agreement_start: string;
  agreement_end: string;
  days_remaining: number;
  is_expired: boolean;
}

type BlanketStatus = 'active' | 'fully_released' | 'expired' | 'cancelled';
```

### Zod Validation Schemas

**Location:** `lib/validation/po-template.ts`

```typescript
import { z } from 'zod';

export const templateCategoryEnum = z.enum([
  'raw_materials',
  'packaging',
  'ingredients',
  'supplies',
  'other'
]);

export const templateFrequencyEnum = z.enum([
  'weekly',
  'biweekly',
  'monthly',
  'quarterly',
  'custom'
]);

export const createTemplateLineSchema = z.object({
  product_id: z.string().uuid('Invalid product ID'),
  quantity: z.number().positive('Quantity must be positive'),
  uom: z.string().min(1, 'UoM is required').max(20),
  notes: z.string().max(500).optional().nullable(),
});

export const createTemplateSchema = z.object({
  name: z.string()
    .min(1, 'Name is required')
    .max(100, 'Name too long'),
  description: z.string().max(500).optional().nullable(),
  category: templateCategoryEnum.optional().nullable(),
  supplier_id: z.string().uuid().optional().nullable(),
  warehouse_id: z.string().uuid().optional().nullable(),
  currency: z.string().length(3).default('PLN'),
  payment_terms: z.string().max(50).optional().nullable(),
  is_shared: z.boolean().default(true),
  frequency: templateFrequencyEnum.optional().nullable(),
  auto_generate: z.boolean().default(false),
  lines: z.array(createTemplateLineSchema).max(100),
}).refine(
  (data) => !data.auto_generate || data.frequency,
  { message: 'Frequency required when auto-generate enabled', path: ['frequency'] }
);

export const updateTemplateSchema = createTemplateSchema.partial().extend({
  is_active: z.boolean().optional(),
});

export const createPOFromTemplateSchema = z.object({
  expected_delivery_date: z.string().date().optional(),
  supplier_id: z.string().uuid().optional(), // Override if template has no supplier
  warehouse_id: z.string().uuid().optional(),
  notes: z.string().max(2000).optional(),
});
```

**Location:** `lib/validation/blanket-po.ts`

```typescript
import { z } from 'zod';

export const createBlanketPOSchema = z.object({
  supplier_id: z.string().uuid('Invalid supplier ID'),
  warehouse_id: z.string().uuid('Invalid warehouse ID'),
  agreement_start: z.string().date('Invalid start date'),
  agreement_end: z.string().date('Invalid end date'),
  total_commitment: z.number().positive('Commitment must be positive'),
  price_locked: z.boolean().default(false),
  currency: z.string().length(3).default('PLN'),
  tax_code_id: z.string().uuid().optional().nullable(),
  payment_terms: z.string().max(50).optional().nullable(),
  notes: z.string().max(2000).optional().nullable(),
  lines: z.array(z.object({
    product_id: z.string().uuid(),
    quantity: z.number().positive(),
    unit_price: z.number().min(0),
    uom: z.string().min(1).max(20),
    notes: z.string().max(500).optional().nullable(),
  })).min(1, 'At least one line required'),
}).refine(
  (data) => new Date(data.agreement_start) <= new Date(data.agreement_end),
  { message: 'Start date must be before end date', path: ['agreement_end'] }
);

export const createReleaseSchema = z.object({
  expected_delivery_date: z.string().date('Invalid date'),
  warehouse_id: z.string().uuid().optional(),
  notes: z.string().max(2000).optional().nullable(),
  lines: z.array(z.object({
    product_id: z.string().uuid(),
    quantity: z.number().positive('Quantity must be positive'),
    notes: z.string().max(500).optional().nullable(),
  })).min(1, 'At least one line required'),
});
```

## UI Components

### Pages

- `app/(authenticated)/planning/purchase-orders/templates/page.tsx` - Template list page
- `app/(authenticated)/planning/purchase-orders/templates/[id]/page.tsx` - Template detail page
- `app/(authenticated)/planning/purchase-orders/blanket/page.tsx` - Blanket PO list page

### Components

**Location:** `components/planning/purchase-orders/templates/`

```
POTemplateDataTable.tsx         - Template list table with actions
POTemplateFilters.tsx           - Search, category, supplier filters
POTemplateForm.tsx              - Create/edit template form
POTemplateDetailCard.tsx        - Template summary card
POTemplateLinesTable.tsx        - Template lines editor
POTemplateLineModal.tsx         - Add/edit template line
POTemplateActionsMenu.tsx       - Actions dropdown (create PO, duplicate, delete)
CreatePOFromTemplateDialog.tsx  - Override options dialog
POTemplateScheduleForm.tsx      - Auto-generation settings
POTemplateCategoryBadge.tsx     - Category badge with color
POTemplateSharedBadge.tsx       - Shared/Private indicator
```

**Location:** `components/planning/purchase-orders/blanket/`

```
BlanketPODataTable.tsx          - Blanket PO list table
BlanketPOForm.tsx               - Create blanket PO form
BlanketPODetailHeader.tsx       - Blanket header with commitment progress
BlanketCommitmentCard.tsx       - Commitment summary card
BlanketReleasesTable.tsx        - Releases list table
CreateReleaseDialog.tsx         - Create release from blanket
CreateReleaseForm.tsx           - Release form with line selection
BlanketCommitmentProgress.tsx   - Visual progress bar
BlanketStatusBadge.tsx          - Status badge (active, expired, fully_released)
BlanketAgreementDates.tsx       - Agreement period display
```

### Component Details

**POTemplateForm.tsx**
```tsx
interface POTemplateFormProps {
  template?: POTemplateWithLines;
  onSave: (data: CreateTemplateInput | UpdateTemplateInput) => void;
  onCancel: () => void;
  isLoading: boolean;
}

// Sections:
// - Basic Info (name, description, category)
// - Defaults (supplier, warehouse, currency, payment terms)
// - Sharing (is_shared checkbox)
// - Auto-Generation (frequency, auto_generate toggle)
// - Lines (embedded table with add/edit/remove)
```

**CreateReleaseForm.tsx**
```tsx
interface CreateReleaseFormProps {
  blanketPO: PurchaseOrderWithLines;
  commitment: CommitmentSummary;
  onSubmit: (data: CreateReleaseInput) => void;
  onCancel: () => void;
  isLoading: boolean;
}

// Shows:
// - Remaining commitment per product
// - Product selection (only blanket products)
// - Quantity input with remaining limit warning
// - Expected delivery date
// - Notes
```

### UI Patterns

**Template List Layout:**
```
+--------------------------------------------------------+
| PO Templates                        [+ New Template]    |
+--------------------------------------------------------+
| Search: [________]  Category: [All v]  [Active Only]   |
+--------------------------------------------------------+
| Name          | Supplier  | Items | Last Used | Actions|
|---------------|-----------|-------|-----------|--------|
| Weekly Flour  | Mill Co.  |   5   | 2 days ago| [...] |
| [Private]     |           |       |           |        |
|---------------|-----------|-------|-----------|--------|
| Monthly Pack  | Pack Ltd. |   12  | 1 week ago| [...] |
| [Shared]      |           |       |           |        |
+--------------------------------------------------------+
```

**Blanket PO Commitment Card:**
```
+------------------------------------------+
| Commitment Progress                       |
+------------------------------------------+
| Total: 10,000 kg                         |
| [========--------] 75%                   |
| Released: 7,500 kg  |  Remaining: 2,500  |
+------------------------------------------+
| Agreement: Jan 1 - Dec 31, 2025          |
| Days Remaining: 180                       |
| Releases: 5                              |
+------------------------------------------+
```

### Category Badge Colors

| Category | Badge Class |
|----------|-------------|
| raw_materials | `bg-amber-100 text-amber-800` |
| packaging | `bg-blue-100 text-blue-800` |
| ingredients | `bg-green-100 text-green-800` |
| supplies | `bg-gray-100 text-gray-800` |
| other | `bg-slate-100 text-slate-800` |

### Blanket Status Badge Colors

| Status | Badge Class |
|--------|-------------|
| active | `bg-green-100 text-green-800` |
| fully_released | `bg-emerald-100 text-emerald-800` |
| expired | `bg-red-100 text-red-800` |
| cancelled | `bg-gray-100 text-gray-800` |

## Test Cases

### Unit Tests

**po-template-service.test.ts**
```typescript
describe('POTemplateService', () => {
  describe('create()', () => {
    it('creates template with lines');
    it('validates unique name per org');
    it('sets created_by to current user');
    it('calculates next_generate_date when auto_generate enabled');
  });

  describe('createPOFromTemplate()', () => {
    it('creates PO with template lines');
    it('fetches current supplier-product prices');
    it('falls back to std_price when no supplier price');
    it('increments template use_count');
    it('updates last_used_at timestamp');
    it('applies overrides for delivery date and warehouse');
  });

  describe('duplicateTemplate()', () => {
    it('creates copy with new name');
    it('copies all lines');
    it('resets use_count to 0');
  });

  describe('auto-generation', () => {
    it('calculates weekly next_generate_date correctly');
    it('calculates monthly next_generate_date correctly');
    it('generates PO when date reached');
    it('updates next_generate_date after generation');
  });
});
```

**blanket-po-service.test.ts**
```typescript
describe('BlanketPOService', () => {
  describe('createBlanketPO()', () => {
    it('creates blanket PO with is_blanket=true');
    it('validates agreement dates');
    it('sets released_qty to 0');
  });

  describe('createRelease()', () => {
    it('creates release with parent_po_id');
    it('uses blanket prices when price_locked');
    it('uses current prices when not price_locked');
    it('updates blanket released_qty');
    it('validates quantity against remaining commitment');
  });

  describe('getCommitmentSummary()', () => {
    it('calculates remaining correctly');
    it('calculates percentage released');
    it('detects expired agreement');
    it('counts releases');
  });

  describe('getBlanketStatus()', () => {
    it('returns active for ongoing agreement');
    it('returns fully_released when commitment met');
    it('returns expired when past agreement_end');
  });
});
```

### Integration Tests

**po-template-api.test.ts**
```typescript
describe('PO Template API', () => {
  describe('GET /api/v1/planning/po-templates', () => {
    it('returns paginated templates');
    it('filters by category');
    it('filters by supplier');
    it('shows only visible templates (shared + own private)');
    it('returns 401 for unauthenticated');
  });

  describe('POST /api/v1/planning/po-templates', () => {
    it('creates template with lines');
    it('validates required fields');
    it('returns 400 for duplicate name');
    it('returns 403 for unauthorized role');
  });

  describe('POST /api/v1/planning/po-templates/:id/create-po', () => {
    it('creates draft PO from template');
    it('applies overrides');
    it('returns 404 for non-existent template');
    it('returns 404 for other org template');
  });

  describe('DELETE /api/v1/planning/po-templates/:id', () => {
    it('deletes template and lines');
    it('allows creator to delete private template');
    it('allows admin to delete any template');
    it('returns 403 for non-creator of private template');
  });
});
```

**blanket-po-api.test.ts**
```typescript
describe('Blanket PO API', () => {
  describe('POST /api/v1/planning/purchase-orders/blanket', () => {
    it('creates blanket PO');
    it('validates agreement dates');
    it('requires at least one line');
    it('returns 400 for start > end date');
  });

  describe('POST /api/v1/planning/purchase-orders/:id/releases', () => {
    it('creates release from blanket');
    it('updates released_qty');
    it('copies prices when price_locked');
    it('returns 400 when quantity exceeds remaining');
    it('returns 404 for non-blanket PO');
    it('returns 404 for other org blanket');
  });

  describe('GET /api/v1/planning/purchase-orders/:id/releases', () => {
    it('returns all releases for blanket');
    it('returns empty array for no releases');
    it('returns 404 for non-blanket PO');
  });

  describe('GET /api/v1/planning/purchase-orders/:id/commitment', () => {
    it('returns commitment summary');
    it('calculates remaining correctly');
    it('indicates expired status');
  });
});
```

### E2E Tests

**po-templates.spec.ts**
```typescript
describe('PO Templates', () => {
  it('creates new template with lines');
  it('edits existing template');
  it('deletes template with confirmation');
  it('creates PO from template');
  it('filters templates by category');
  it('toggles template sharing');
  it('duplicates template');
  it('configures auto-generation');
});
```

**blanket-po.spec.ts**
```typescript
describe('Blanket POs', () => {
  it('creates blanket PO with agreement dates');
  it('creates release from blanket');
  it('shows commitment progress');
  it('validates release quantity against remaining');
  it('shows release history');
  it('handles expired agreement warning');
  it('uses locked prices when enabled');
});
```

## Business Rules

1. **Template Names**: Unique per organization
2. **Template Sharing**: Shared templates visible to all org users; private only to creator
3. **Template Lines**: Same product cannot appear twice in template
4. **Auto-Generation**: Requires frequency to be set; generates draft POs
5. **Blanket PO**: Must have agreement_start <= agreement_end
6. **Blanket Commitment**: Total quantity agreed for the agreement period
7. **Release Orders**: Reference parent blanket PO; deduct from commitment
8. **Price Locking**: When enabled, releases use blanket line prices regardless of current prices
9. **Blanket Deletion**: Cannot delete blanket PO with releases
10. **Commitment Warning**: Warn when release exceeds remaining but allow override
11. **Agreement Expiry**: Warn when creating release for expired agreement but allow

## Performance Requirements

| Metric | Target |
|--------|--------|
| Template list load | < 300ms |
| Template detail load | < 200ms |
| Create PO from template | < 1s |
| Blanket commitment summary | < 200ms |
| Release creation | < 1s |

## Deliverables

- [ ] `po_templates` table migration
- [ ] `po_template_lines` table migration
- [ ] `purchase_orders` blanket fields migration
- [ ] RLS policies for templates and template lines
- [ ] `po-template-service.ts` with all methods
- [ ] `blanket-po-service.ts` with all methods
- [ ] Zod schemas (`lib/validation/po-template.ts`, `lib/validation/blanket-po.ts`)
- [ ] API routes for template CRUD and actions
- [ ] API routes for blanket PO and releases
- [ ] Template list page with DataTable
- [ ] Template form with lines editor
- [ ] Create PO from template dialog
- [ ] Blanket PO form with agreement fields
- [ ] Blanket commitment summary card
- [ ] Release creation dialog
- [ ] Releases list table
- [ ] Category and status badges
- [ ] Unit tests (>80% coverage)
- [ ] Integration tests for all endpoints
- [ ] E2E tests for critical flows

## Definition of Done

- [ ] PO templates CRUD fully functional
- [ ] Template lines management working
- [ ] Create PO from template with price lookup
- [ ] Template categories and filtering work
- [ ] Template sharing (public/private) enforced
- [ ] Blanket PO creation with agreement dates
- [ ] Release creation from blanket PO
- [ ] Price locking applied correctly
- [ ] Commitment tracking accurate
- [ ] Remaining quantity displayed and validated
- [ ] Multi-tenancy: cross-org returns 404
- [ ] Permission matrix enforced
- [ ] Loading, empty, error states implemented
- [ ] Toast notifications on success/error
- [ ] Unit test coverage >= 80%
- [ ] Integration tests pass
- [ ] E2E tests pass

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2026-01-14 | Initial story creation | ARCHITECT-AGENT |
