# 03.7 - PO Status Lifecycle (Configurable Statuses)

| Field | Value |
|-------|-------|
| **Story ID** | 03.7 |
| **Epic** | 03 - Planning |
| **Status** | Ready |
| **Phase** | P0 (MVP) |
| **Complexity** | S (Small) |
| **Estimate** | 1-2 days |
| **Type** | Full-stack |

---

## PRD References

| FR ID | Requirement | Priority | Covered |
|-------|-------------|----------|---------|
| FR-PLAN-007 | PO Status Lifecycle | Must Have | YES |
| FR-PLAN-011 | Configurable PO Statuses | Should Have | YES |

**Primary PRD:** `docs/1-BASELINE/product/modules/planning.md` (Section 5.4)
**Architecture:** `docs/1-BASELINE/architecture/modules/planning.md`
**UX Wireframes:** PLA-004 (Status Config), PLA-005 (Status History Timeline)

---

## MVP Scope

This story implements configurable PO status lifecycle management, allowing organizations to customize their purchase order status workflow while maintaining system integrity and transition rules.

**MVP Includes**:
- Configurable status list (admin-defined per organization)
- Default status set provided during organization setup
- Status transition rules engine with validation
- Status history tracking and audit trail
- UI components for status management (dropdown, badges, timeline)
- Service layer methods for status validation and transitions
- Validation schemas for status operations
- Tests for invalid transition blocking

**MVP Excludes**: See "Out of Scope" section below.

---

## User Story

As an **Administrator**, I want to **customize the purchase order status list and define valid status transitions** so that **the PO workflow matches our organization's procurement process and terminology**.

As a **Planner**, I want to **see a clear status history timeline for each PO** so that **I can track the complete lifecycle and understand when status changes occurred and why**.

---

## Dependencies

| Dependency | Story/Epic | Type | Reason |
|------------|------------|------|--------|
| 01.1 | Org Context + Base RLS | HARD | Requires org_id context for multi-tenancy |
| 03.3 | PO CRUD + Lines | HARD | Extends PO with configurable status management |

**Dependents:**
- 03.5a/b (PO Approval) - Uses status transitions for approval workflow
- 03.6 (Bulk PO Creation) - Uses status management for batch operations
- Epic 05 (Warehouse - PO Receiving) - Triggers status transitions on receipt

---

## Acceptance Criteria (Gherkin)

### AC-1: Default Status Configuration (FR-PLAN-011)

```gherkin
Scenario: New organization receives default PO statuses
  Given a new organization is created
  When system runs organization setup
  Then 7 default PO statuses are created:
    | Code | Name | Color | Order | Is_System |
    | draft | Draft | gray | 1 | true |
    | submitted | Submitted | blue | 2 | true |
    | pending_approval | Pending Approval | yellow | 3 | false |
    | confirmed | Confirmed | green | 4 | true |
    | receiving | Receiving | purple | 5 | true |
    | closed | Closed | emerald | 6 | true |
    | cancelled | Cancelled | red | 7 | true |
  And transition rules are configured per default workflow

Scenario: View PO status configuration
  Given admin navigates to `/settings/planning/po-statuses`
  When page loads
  Then status list displays with columns: Name, Code, Color, Order, In Use Count
  And drag-to-reorder handles are visible
  And "Add Status" button is visible
```

### AC-2: Add Custom Status (FR-PLAN-011)

```gherkin
Scenario: Admin adds custom status
  Given admin on PO status config page
  When clicks "Add Status"
  Then modal opens with fields: name, code, color picker, display order
  And all fields are empty

Scenario: Create custom status
  Given admin in add status modal
  When enters name "Awaiting Vendor Confirmation"
  And enters code "awaiting_vendor"
  And selects color "orange"
  And selects order "3" (between submitted and confirmed)
  And clicks "Save"
  Then status is created
  And status appears in list at position 3
  And toast "Status added successfully" displays
  And modal closes

Scenario: Duplicate code validation
  Given status with code "confirmed" exists
  When admin attempts to create status with code "confirmed"
  Then error "Status code must be unique" displays
  And save is blocked

Scenario: Required field validation
  Given admin in add status modal
  When leaves name or code empty
  And clicks "Save"
  Then error "Name and code are required" displays
  And save is blocked
```

### AC-3: Edit Status (FR-PLAN-011)

```gherkin
Scenario: Edit custom status
  Given custom status "awaiting_vendor" exists
  When admin clicks edit icon
  Then modal opens with current values pre-filled
  And can modify name, color, order
  And code field is disabled (immutable after creation)

Scenario: Save status changes
  Given admin editing status "awaiting_vendor"
  When changes name to "Vendor Review"
  And changes color to "amber"
  And clicks "Save"
  Then status is updated
  And changes reflect in list
  And POs using this status show new name/color

Scenario: Cannot edit system status name/code
  Given system status "draft" selected for edit
  When admin opens edit modal
  Then name and code fields are disabled
  And only color and order can be changed
  And warning "System statuses cannot be renamed" displays
```

### AC-4: Delete Status (FR-PLAN-011)

```gherkin
Scenario: Delete unused custom status
  Given custom status "awaiting_vendor" exists
  And 0 POs use this status
  When admin clicks delete icon
  Then confirmation dialog "Delete status 'awaiting_vendor'?" displays
  And upon confirm, status is deleted
  And removed from list

Scenario: Cannot delete status in use
  Given custom status "awaiting_vendor" exists
  And 5 POs currently use this status
  When admin attempts to delete
  Then error "Cannot delete. 5 POs use this status. Change their status first." displays
  And delete is blocked

Scenario: Cannot delete system status
  Given system status "draft" is selected
  When admin hovers over delete icon
  Then delete icon is disabled/hidden
  And tooltip "System statuses cannot be deleted" displays
```

### AC-5: Reorder Statuses (FR-PLAN-011)

```gherkin
Scenario: Drag to reorder statuses
  Given admin on status config page
  When drags "pending_approval" from position 3 to position 2
  Then status order updates
  And auto-saves new order
  And toast "Status order updated" displays

Scenario: Order reflected in PO status dropdown
  Given statuses reordered: draft, pending_approval, submitted, confirmed
  When planner views PO status dropdown
  Then statuses appear in configured order
```

### AC-6: Status Transition Rules (FR-PLAN-007)

```gherkin
Scenario: Configure allowed transitions
  Given admin on status config page
  When clicks "Configure Transitions" for status "draft"
  Then modal shows transition rules editor
  And list of all statuses as checkboxes
  And default allowed transitions pre-checked:
    | From Status | To Status |
    | draft | submitted, cancelled |

Scenario: Add allowed transition
  Given configuring transitions for "submitted"
  When checks "pending_approval"
  And clicks "Save"
  Then transition rule created
  And submitted -> pending_approval is now valid

Scenario: Remove allowed transition
  Given "draft -> submitted" transition exists
  When admin unchecks "submitted"
  And clicks "Save"
  Then transition rule removed
  And draft -> submitted is now invalid

Scenario: Cannot remove system-required transitions
  Given system transition "receiving -> closed" (auto-triggered)
  When admin attempts to uncheck
  Then checkbox is disabled
  And tooltip "System-required transition" displays
```

### AC-7: Status Transition Validation (FR-PLAN-007)

```gherkin
Scenario: Valid status transition allowed
  Given PO is in "draft" status
  And "draft -> submitted" transition is allowed
  When planner clicks "Submit"
  Then status changes to "submitted"
  And status_history record created
  And toast "PO submitted successfully" displays

Scenario: Invalid status transition blocked
  Given PO is in "confirmed" status
  And "confirmed -> draft" transition is NOT allowed
  When planner attempts to change status to "draft"
  Then error "Invalid status transition: confirmed -> draft" displays
  And status remains "confirmed"
  And no history record created

Scenario: System-triggered transitions
  Given PO is in "confirmed" status
  And first receipt is recorded (received_qty > 0)
  When receipt is saved
  Then PO status auto-changes to "receiving"
  And status_history recorded with changed_by = SYSTEM
  And notes = "Auto-transitioned: first receipt recorded"

Scenario: Conditional transitions enforced
  Given PO is in "draft" status
  And PO has 0 line items
  When planner attempts "Submit"
  Then error "Cannot submit PO without line items" displays
  And status remains "draft"
```

### AC-8: Status History Timeline (FR-PLAN-007)

```gherkin
Scenario: View status history on PO detail
  Given PO has status history:
    | From | To | When | By | Notes |
    | null | draft | 2024-12-01 10:00 | User A | PO created |
    | draft | submitted | 2024-12-02 11:30 | User A | - |
    | submitted | confirmed | 2024-12-02 14:00 | User B | Approved |
    | confirmed | receiving | 2024-12-05 09:00 | SYSTEM | First receipt |
  When viewing PO detail page
  Then "Status History" section displays timeline with 4 entries
  And each entry shows: status badge, timestamp, user/system, notes
  And entries are in reverse chronological order (newest first)

Scenario: Status history entry details
  Given viewing status history timeline
  When entry shows "draft -> submitted"
  Then displays:
    - From badge: "Draft" (gray)
    - Arrow icon
    - To badge: "Submitted" (blue)
    - Timestamp: "Dec 2, 2024 11:30 AM"
    - User: "John Doe" (with avatar)
    - Notes: (empty or custom text)

Scenario: Expand history entry for details
  Given status history timeline displayed
  When clicks on history entry
  Then entry expands to show:
    - Full timestamp (with timezone)
    - User ID link
    - Any transition validation notes
    - Related actions (e.g., "Approval granted by Manager")
```

### AC-9: Status Badge Component (UI)

```gherkin
Scenario: Status badge displays correctly
  Given PO has status "confirmed"
  When rendering status badge
  Then badge shows:
    - Text: "Confirmed"
    - Background: green (per config)
    - Text color: auto-contrasted for readability
    - Border radius: rounded-md
    - Padding: px-2 py-1

Scenario: Status badge color updates
  Given admin changes "confirmed" color from green to teal
  When viewing PO list
  Then all "confirmed" badges now show teal background
  And change is immediate (cache invalidated)
```

### AC-10: Status Dropdown in PO Form

```gherkin
Scenario: Status dropdown shows allowed transitions only
  Given editing PO with status "submitted"
  And allowed transitions are: pending_approval, confirmed, cancelled
  When clicks status dropdown
  Then dropdown shows:
    - Current: "Submitted" (checked/highlighted)
    - Allowed: "Pending Approval", "Confirmed", "Cancelled"
  And other statuses are NOT shown

Scenario: Status dropdown disabled by permissions
  Given PO is "confirmed"
  And user has VIEWER role
  When viewing PO detail
  Then status field is read-only badge (not dropdown)

Scenario: Status change with confirmation
  Given PO status is "confirmed"
  When planner selects "Cancelled" from dropdown
  Then confirmation dialog appears:
    - Title: "Change PO status to Cancelled?"
    - Message: "This will cancel the purchase order."
    - Input: "Reason (optional)"
    - Actions: "Cancel", "Confirm"
  And upon confirm, status changes and reason saved to history
```

### AC-11: Multi-tenancy and Permissions

```gherkin
Scenario: Status configs isolated by org
  Given User A from Org A
  And Org A has custom status "awaiting_vendor"
  And Org B does NOT have this status
  When User B from Org B views PO statuses
  Then "awaiting_vendor" is NOT visible
  And only Org B's statuses appear

Scenario: Admin-only status configuration
  Given user has PLANNER role (not ADMIN)
  When navigating to `/settings/planning/po-statuses`
  Then 403 Forbidden or redirect to dashboard
  And toast "Admin access required" displays

Scenario: Planners can transition statuses
  Given user has PLANNER role
  And on PO detail page
  When changes PO status (within allowed transitions)
  Then transition succeeds
  And status_history records planner as changed_by
```

### AC-12: Service Layer Methods

```gherkin
Scenario: getAvailableTransitions() returns valid next statuses
  Given PO with status "submitted"
  When calling poStatusService.getAvailableTransitions("submitted", poId)
  Then returns: ["pending_approval", "confirmed", "cancelled"]
  And excludes: "draft", "receiving", "closed"

Scenario: validateTransition() enforces rules
  Given PO with status "confirmed"
  When calling poStatusService.validateTransition(poId, "draft")
  Then returns: { valid: false, reason: "Invalid transition: confirmed -> draft" }

Scenario: transitionStatus() with business rules
  Given PO with status "draft" and 0 lines
  When calling poStatusService.transitionStatus(poId, "submitted")
  Then throws error: "Cannot submit PO without line items"
  And status remains "draft"

Scenario: recordStatusHistory() creates audit record
  Given transitioning PO from "draft" to "submitted"
  When calling poStatusService.recordStatusHistory(poId, "draft", "submitted", userId, "Ready to order")
  Then status_history record created with:
    - po_id, from_status, to_status, changed_by, changed_at, notes
```

---

## Technical Specification

### Database Schema

```sql
-- PO Status Configuration (per organization)
CREATE TABLE po_statuses (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  code VARCHAR(50) NOT NULL,
  name VARCHAR(100) NOT NULL,
  color VARCHAR(20) NOT NULL DEFAULT 'gray',  -- TailwindCSS color name
  display_order INTEGER NOT NULL,
  is_system BOOLEAN DEFAULT false,  -- true = cannot delete/rename
  is_active BOOLEAN DEFAULT true,
  description TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),

  CONSTRAINT po_status_org_code_unique UNIQUE(org_id, code),
  CONSTRAINT po_status_color_check CHECK (color IN ('gray', 'blue', 'yellow', 'green', 'purple', 'emerald', 'red', 'orange', 'amber', 'teal', 'indigo'))
);

-- Status Transition Rules (defines valid status changes)
CREATE TABLE po_status_transitions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  from_status_id UUID NOT NULL REFERENCES po_statuses(id) ON DELETE CASCADE,
  to_status_id UUID NOT NULL REFERENCES po_statuses(id) ON DELETE CASCADE,
  is_system BOOLEAN DEFAULT false,  -- true = required by system, cannot remove
  requires_approval BOOLEAN DEFAULT false,
  requires_reason BOOLEAN DEFAULT false,
  condition_function TEXT,  -- Optional: name of function to check conditions
  created_at TIMESTAMPTZ DEFAULT NOW(),

  CONSTRAINT po_transition_org_from_to_unique UNIQUE(org_id, from_status_id, to_status_id),
  CONSTRAINT po_transition_no_self_loop CHECK (from_status_id != to_status_id)
);

-- PO Status History (audit trail) - extends existing table from 03.3
-- NOTE: This table was created in 03.3, we're just documenting it here
CREATE TABLE IF NOT EXISTS po_status_history (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  po_id UUID NOT NULL REFERENCES purchase_orders(id) ON DELETE CASCADE,
  from_status VARCHAR(50),  -- NULL for initial creation
  to_status VARCHAR(50) NOT NULL,
  changed_by UUID REFERENCES users(id),  -- NULL if SYSTEM
  changed_at TIMESTAMPTZ DEFAULT NOW(),
  notes TEXT,
  transition_metadata JSONB  -- Additional context (e.g., approval_id, receipt_id)
);

-- Indexes
CREATE INDEX idx_po_statuses_org ON po_statuses(org_id, display_order);
CREATE INDEX idx_po_transitions_from ON po_status_transitions(from_status_id);
CREATE INDEX idx_po_history_po ON po_status_history(po_id, changed_at DESC);

-- Function: Get default statuses for new org
CREATE OR REPLACE FUNCTION create_default_po_statuses(p_org_id UUID)
RETURNS VOID AS $$
DECLARE
  v_draft_id UUID;
  v_submitted_id UUID;
  v_pending_id UUID;
  v_confirmed_id UUID;
  v_receiving_id UUID;
  v_closed_id UUID;
  v_cancelled_id UUID;
BEGIN
  -- Create default statuses
  INSERT INTO po_statuses (org_id, code, name, color, display_order, is_system)
  VALUES
    (p_org_id, 'draft', 'Draft', 'gray', 1, true),
    (p_org_id, 'submitted', 'Submitted', 'blue', 2, true),
    (p_org_id, 'pending_approval', 'Pending Approval', 'yellow', 3, false),
    (p_org_id, 'confirmed', 'Confirmed', 'green', 4, true),
    (p_org_id, 'receiving', 'Receiving', 'purple', 5, true),
    (p_org_id, 'closed', 'Closed', 'emerald', 6, true),
    (p_org_id, 'cancelled', 'Cancelled', 'red', 7, true)
  RETURNING id INTO v_draft_id, v_submitted_id, v_pending_id, v_confirmed_id, v_receiving_id, v_closed_id, v_cancelled_id;

  -- Get status IDs for transition rules
  SELECT id INTO v_draft_id FROM po_statuses WHERE org_id = p_org_id AND code = 'draft';
  SELECT id INTO v_submitted_id FROM po_statuses WHERE org_id = p_org_id AND code = 'submitted';
  SELECT id INTO v_pending_id FROM po_statuses WHERE org_id = p_org_id AND code = 'pending_approval';
  SELECT id INTO v_confirmed_id FROM po_statuses WHERE org_id = p_org_id AND code = 'confirmed';
  SELECT id INTO v_receiving_id FROM po_statuses WHERE org_id = p_org_id AND code = 'receiving';
  SELECT id INTO v_closed_id FROM po_statuses WHERE org_id = p_org_id AND code = 'closed';
  SELECT id INTO v_cancelled_id FROM po_statuses WHERE org_id = p_org_id AND code = 'cancelled';

  -- Create default transition rules
  INSERT INTO po_status_transitions (org_id, from_status_id, to_status_id, is_system)
  VALUES
    -- From draft
    (p_org_id, v_draft_id, v_submitted_id, false),
    (p_org_id, v_draft_id, v_cancelled_id, false),

    -- From submitted
    (p_org_id, v_submitted_id, v_pending_id, false),
    (p_org_id, v_submitted_id, v_confirmed_id, false),
    (p_org_id, v_submitted_id, v_cancelled_id, false),

    -- From pending_approval
    (p_org_id, v_pending_id, v_confirmed_id, false),
    (p_org_id, v_pending_id, v_cancelled_id, false),

    -- From confirmed
    (p_org_id, v_confirmed_id, v_receiving_id, true),  -- System-triggered
    (p_org_id, v_confirmed_id, v_cancelled_id, false),

    -- From receiving
    (p_org_id, v_receiving_id, v_closed_id, true),  -- System-triggered
    (p_org_id, v_receiving_id, v_cancelled_id, false);

END;
$$ LANGUAGE plpgsql;

-- Trigger: Call default status setup on org creation
-- Note: This would be added to organization creation flow
```

### RLS Policies

```sql
-- Enable RLS
ALTER TABLE po_statuses ENABLE ROW LEVEL SECURITY;
ALTER TABLE po_status_transitions ENABLE ROW LEVEL SECURITY;
-- po_status_history RLS already enabled in 03.3

-- PO Statuses: Org isolation
CREATE POLICY "po_statuses_select" ON po_statuses
FOR SELECT TO authenticated
USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

CREATE POLICY "po_statuses_insert" ON po_statuses
FOR INSERT TO authenticated
WITH CHECK (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  AND (
    (SELECT r.code FROM roles r JOIN users u ON u.role_id = r.id WHERE u.id = auth.uid())
    IN ('SUPER_ADMIN', 'ADMIN')
  )
);

CREATE POLICY "po_statuses_update" ON po_statuses
FOR UPDATE TO authenticated
USING (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  AND (
    (SELECT r.code FROM roles r JOIN users u ON u.role_id = r.id WHERE u.id = auth.uid())
    IN ('SUPER_ADMIN', 'ADMIN')
  )
);

CREATE POLICY "po_statuses_delete" ON po_statuses
FOR DELETE TO authenticated
USING (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  AND is_system = false
  AND NOT EXISTS (
    SELECT 1 FROM purchase_orders po WHERE po.status = po_statuses.code AND po.org_id = po_statuses.org_id
  )
  AND (
    (SELECT r.code FROM roles r JOIN users u ON u.role_id = r.id WHERE u.id = auth.uid())
    IN ('SUPER_ADMIN', 'ADMIN')
  )
);

-- PO Status Transitions: Org isolation
CREATE POLICY "po_transitions_select" ON po_status_transitions
FOR SELECT TO authenticated
USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

CREATE POLICY "po_transitions_insert" ON po_status_transitions
FOR INSERT TO authenticated
WITH CHECK (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  AND (
    (SELECT r.code FROM roles r JOIN users u ON u.role_id = r.id WHERE u.id = auth.uid())
    IN ('SUPER_ADMIN', 'ADMIN')
  )
);

CREATE POLICY "po_transitions_update" ON po_status_transitions
FOR UPDATE TO authenticated
USING (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  AND (
    (SELECT r.code FROM roles r JOIN users u ON u.role_id = r.id WHERE u.id = auth.uid())
    IN ('SUPER_ADMIN', 'ADMIN')
  )
);

CREATE POLICY "po_transitions_delete" ON po_status_transitions
FOR DELETE TO authenticated
USING (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  AND is_system = false
  AND (
    (SELECT r.code FROM roles r JOIN users u ON u.role_id = r.id WHERE u.id = auth.uid())
    IN ('SUPER_ADMIN', 'ADMIN')
  )
);
```

### API Endpoints

```
# PO Status Configuration (Admin only)
GET    /api/v1/settings/planning/po-statuses              - List all PO statuses for org
POST   /api/v1/settings/planning/po-statuses              - Create custom status
GET    /api/v1/settings/planning/po-statuses/:id          - Get status details
PUT    /api/v1/settings/planning/po-statuses/:id          - Update status (name, color, order)
DELETE /api/v1/settings/planning/po-statuses/:id          - Delete custom status
PUT    /api/v1/settings/planning/po-statuses/reorder      - Bulk update display_order

# Status Transitions Configuration (Admin only)
GET    /api/v1/settings/planning/po-statuses/:id/transitions      - Get allowed transitions for status
PUT    /api/v1/settings/planning/po-statuses/:id/transitions      - Update allowed transitions
POST   /api/v1/settings/planning/po-statuses/transitions/validate - Validate transition rule

# PO Status Operations (Planner/User)
GET    /api/v1/planning/purchase-orders/:id/status/available      - Get available next statuses
POST   /api/v1/planning/purchase-orders/:id/status                - Change PO status
GET    /api/v1/planning/purchase-orders/:id/status/history        - Get status history timeline
GET    /api/v1/planning/purchase-orders/:id/status/validate       - Validate status transition

# Utilities
GET    /api/v1/settings/planning/po-statuses/defaults             - Get default status config (for setup)
```

### Service Layer

```typescript
// lib/services/po-status-service.ts

export interface POStatusService {
  // Status CRUD (Admin)
  listStatuses(orgId: string): Promise<POStatus[]>;
  getStatus(id: string): Promise<POStatus | null>;
  createStatus(data: CreateStatusInput): Promise<POStatus>;
  updateStatus(id: string, data: UpdateStatusInput): Promise<POStatus>;
  deleteStatus(id: string): Promise<void>;
  reorderStatuses(orgId: string, statusIds: string[]): Promise<void>;

  // Transition Rules (Admin)
  getStatusTransitions(statusId: string): Promise<POStatusTransition[]>;
  updateStatusTransitions(statusId: string, allowedToStatusIds: string[]): Promise<void>;

  // Status Operations (User)
  getAvailableTransitions(currentStatus: string, poId: string): Promise<POStatus[]>;
  validateTransition(poId: string, toStatus: string): Promise<ValidationResult>;
  transitionStatus(poId: string, toStatus: string, userId: string, notes?: string): Promise<PurchaseOrder>;

  // Status History
  getStatusHistory(poId: string): Promise<POStatusHistory[]>;
  recordStatusHistory(poId: string, fromStatus: string | null, toStatus: string, userId: string | null, notes?: string): Promise<POStatusHistory>;

  // Business Rules
  canDeleteStatus(statusId: string): Promise<{ allowed: boolean; reason?: string; poCount?: number }>;
  getStatusUsageCount(statusId: string): Promise<number>;

  // Setup
  createDefaultStatuses(orgId: string): Promise<void>;
}

// Type definitions
export interface POStatus {
  id: string;
  org_id: string;
  code: string;
  name: string;
  color: string;
  display_order: number;
  is_system: boolean;
  is_active: boolean;
  description: string | null;
  created_at: string;
  updated_at: string;
}

export interface POStatusTransition {
  id: string;
  org_id: string;
  from_status_id: string;
  to_status_id: string;
  is_system: boolean;
  requires_approval: boolean;
  requires_reason: boolean;
  condition_function: string | null;
  created_at: string;
  from_status?: POStatus;
  to_status?: POStatus;
}

export interface POStatusHistory {
  id: string;
  po_id: string;
  from_status: string | null;
  to_status: string;
  changed_by: string | null;
  changed_at: string;
  notes: string | null;
  transition_metadata: Record<string, any> | null;
  user?: {
    name: string;
    email: string;
  };
}

export interface CreateStatusInput {
  code: string;
  name: string;
  color?: string;
  display_order?: number;
  description?: string;
}

export interface UpdateStatusInput {
  name?: string;
  color?: string;
  display_order?: number;
  description?: string;
  is_active?: boolean;
}

export interface ValidationResult {
  valid: boolean;
  reason?: string;
  warnings?: string[];
}

export const STATUS_COLORS = [
  'gray', 'blue', 'yellow', 'green', 'purple',
  'emerald', 'red', 'orange', 'amber', 'teal', 'indigo'
] as const;

export type StatusColor = typeof STATUS_COLORS[number];
```

### Validation Schema (Zod)

```typescript
// lib/validation/po-status.ts
import { z } from 'zod';

export const statusColorEnum = z.enum([
  'gray', 'blue', 'yellow', 'green', 'purple',
  'emerald', 'red', 'orange', 'amber', 'teal', 'indigo'
]);

export const createPOStatusSchema = z.object({
  code: z.string()
    .min(2, 'Code must be at least 2 characters')
    .max(50, 'Code too long')
    .regex(/^[a-z_]+$/, 'Code must be lowercase letters and underscores only'),
  name: z.string()
    .min(2, 'Name must be at least 2 characters')
    .max(100, 'Name too long'),
  color: statusColorEnum.default('gray'),
  display_order: z.number()
    .int('Display order must be an integer')
    .min(1, 'Display order must be positive')
    .optional(),
  description: z.string()
    .max(500, 'Description too long')
    .optional()
    .nullable(),
});

export const updatePOStatusSchema = z.object({
  name: z.string()
    .min(2, 'Name must be at least 2 characters')
    .max(100, 'Name too long')
    .optional(),
  color: statusColorEnum.optional(),
  display_order: z.number()
    .int()
    .min(1)
    .optional(),
  description: z.string()
    .max(500)
    .optional()
    .nullable(),
  is_active: z.boolean().optional(),
});

export const updateStatusTransitionsSchema = z.object({
  allowed_to_status_ids: z.array(z.string().uuid())
    .min(0, 'At least one transition must be allowed')
    .max(20, 'Too many transitions'),
});

export const transitionStatusSchema = z.object({
  to_status: z.string()
    .min(2, 'Status code is required')
    .max(50, 'Status code too long'),
  notes: z.string()
    .max(500, 'Notes too long')
    .optional()
    .nullable(),
});

export const reorderStatusesSchema = z.object({
  status_ids: z.array(z.string().uuid())
    .min(1, 'At least one status required'),
});

// Type exports
export type CreatePOStatusInput = z.infer<typeof createPOStatusSchema>;
export type UpdatePOStatusInput = z.infer<typeof updatePOStatusSchema>;
export type UpdateStatusTransitionsInput = z.infer<typeof updateStatusTransitionsSchema>;
export type TransitionStatusInput = z.infer<typeof transitionStatusSchema>;
export type StatusColor = z.infer<typeof statusColorEnum>;
```

---

## UI Components

```
app/(authenticated)/settings/planning/po-statuses/
  page.tsx                              -- PO status config page (admin only)

components/settings/planning/
  POStatusList.tsx                      -- DataTable of statuses with drag-to-reorder
  POStatusModal.tsx                     -- Add/Edit status modal
  POStatusDeleteDialog.tsx              -- Delete confirmation with usage check
  POTransitionRulesModal.tsx            -- Configure allowed transitions
  POStatusColorPicker.tsx               -- Color selector component

components/planning/purchase-orders/
  POStatusBadge.tsx                     -- Status badge with dynamic color
  POStatusDropdown.tsx                  -- Status selector (filtered by allowed transitions)
  POStatusTimeline.tsx                  -- Status history timeline component
  POStatusTimelineItem.tsx              -- Single timeline entry
  POStatusTransitionDialog.tsx          -- Confirmation dialog for status change
```

### Status Badge Color Mapping (TailwindCSS)

```typescript
// components/planning/purchase-orders/POStatusBadge.tsx
const STATUS_COLOR_CLASSES: Record<string, string> = {
  gray: 'bg-gray-100 text-gray-800 border-gray-300',
  blue: 'bg-blue-100 text-blue-800 border-blue-300',
  yellow: 'bg-yellow-100 text-yellow-800 border-yellow-300',
  green: 'bg-green-100 text-green-800 border-green-300',
  purple: 'bg-purple-100 text-purple-800 border-purple-300',
  emerald: 'bg-emerald-100 text-emerald-800 border-emerald-300',
  red: 'bg-red-100 text-red-800 border-red-300',
  orange: 'bg-orange-100 text-orange-800 border-orange-300',
  amber: 'bg-amber-100 text-amber-800 border-amber-300',
  teal: 'bg-teal-100 text-teal-800 border-teal-300',
  indigo: 'bg-indigo-100 text-indigo-800 border-indigo-300',
};
```

---

## Key Business Rules

1. **System Statuses**: `draft`, `submitted`, `confirmed`, `receiving`, `closed`, `cancelled` cannot be deleted or have their codes changed
2. **Status Uniqueness**: Status code must be unique per organization
3. **In-Use Protection**: Cannot delete status if any POs currently use it
4. **Transition Validation**: All status changes must have an allowed transition rule
5. **System Transitions**: `confirmed -> receiving` and `receiving -> closed` are auto-triggered by system and cannot be removed
6. **Conditional Transitions**: `draft -> submitted` requires at least 1 line item
7. **Status History**: All status changes are recorded with user, timestamp, and optional notes
8. **Display Order**: Statuses appear in dropdown/list in configured order
9. **Multi-tenancy**: Status configurations are isolated per organization
10. **Admin-Only Config**: Only ADMIN/SUPER_ADMIN roles can manage status configuration

---

## Out of Scope

| Feature | Reason | Future Story/Phase |
|---------|--------|-------------------|
| Workflow automation rules | Complex feature | Phase 2 |
| Email notifications on status change | Integration feature | Epic 11 |
| Custom status icons | Nice-to-have | Phase 2 |
| Status-based permissions (beyond transitions) | Advanced RBAC | Phase 3 |
| Bulk status changes | Efficiency feature | Future |
| Status change approval workflow | Separate approval system | Story 03.5b |
| Transfer Order status config | Separate entity | Story 03.18 |
| Work Order status config | Separate entity | Story 03.17 |

---

## Deliverables

- **Database Migration**: `po_statuses`, `po_status_transitions` tables with constraints, indexes, and triggers
- **API Routes**: 11 endpoints for status CRUD, transitions, and operations
- **Service**: `po-status-service.ts` with all methods implemented
- **Validation**: Zod schemas for all status operations
- **UI Components**: 9 components for status management and display
- **Tests**: Unit (15+ tests), Integration (10+ tests), E2E (5+ tests)
- **Documentation**: API docs, service docs, component docs

---

## Definition of Done

- [ ] Database migration creates `po_statuses` and `po_status_transitions` tables
- [ ] All constraints, indexes, and FK relationships in place
- [ ] `create_default_po_statuses()` function working and tested
- [ ] RLS policies enforce org isolation and admin-only config
- [ ] All 11 API endpoints implemented and documented
- [ ] Zod schemas validate all inputs
- [ ] `po-status-service.ts` implements all methods
- [ ] Status CRUD operations working (list, create, update, delete)
- [ ] Transition rules configuration working
- [ ] Status dropdown filters by allowed transitions
- [ ] Status badge displays with configured colors
- [ ] Status timeline shows complete history with user info
- [ ] Drag-to-reorder statuses working
- [ ] Cannot delete system statuses
- [ ] Cannot delete statuses in use
- [ ] Invalid transitions blocked with clear error messages
- [ ] Status history records all changes with audit info
- [ ] Default statuses created on org setup
- [ ] Multi-tenancy: cross-org isolation verified
- [ ] Admin permission checks working
- [ ] Unit tests >= 80% coverage
- [ ] Integration tests for all endpoints
- [ ] E2E tests for critical flows (add status, configure transitions, change PO status)
- [ ] Loading, empty, error states implemented
- [ ] Toast notifications on success/error
- [ ] Accessibility: keyboard nav, ARIA labels, screen reader support

---

## Test Cases

### Unit Tests

**File:** `__tests__/unit/services/po-status-service.test.ts`

| Test Case | Description |
|-----------|-------------|
| `listStatuses()` returns org-specific statuses | Org isolation |
| `createStatus()` validates unique code | Duplicate code rejected |
| `createStatus()` auto-assigns display_order | Last order + 1 |
| `updateStatus()` prevents code change on system status | Immutability check |
| `deleteStatus()` blocked if status in use | Business rule |
| `deleteStatus()` blocked for system status | Immutability check |
| `reorderStatuses()` updates display_order | Batch update |
| `getAvailableTransitions()` returns allowed next statuses | Transition filtering |
| `validateTransition()` checks transition rules | Validation logic |
| `validateTransition()` checks business conditions | Conditional logic |
| `transitionStatus()` creates history record | Audit trail |
| `transitionStatus()` updates PO status | Integration |
| `getStatusHistory()` returns chronological order | Sorting |
| `canDeleteStatus()` calculates usage count | PO count query |
| `createDefaultStatuses()` creates 7 defaults | Setup function |

### Integration Tests

**File:** `__tests__/integration/api/settings/planning/po-statuses.test.ts`

| Test Case | Description |
|-----------|-------------|
| GET `/po-statuses` returns org statuses only | Multi-tenancy |
| POST `/po-statuses` creates custom status | Create flow |
| POST `/po-statuses` duplicate code returns 400 | Validation |
| PUT `/po-statuses/:id` updates name and color | Update flow |
| PUT `/po-statuses/:id` cannot change system code | Immutability |
| DELETE `/po-statuses/:id` deletes unused status | Delete flow |
| DELETE `/po-statuses/:id` in use returns 400 | Business rule |
| DELETE `/po-statuses/:id` system status returns 400 | Immutability |
| GET `/po-statuses/:id/transitions` returns rules | Transition query |
| PUT `/po-statuses/:id/transitions` updates rules | Transition update |
| POST `/purchase-orders/:id/status` valid transition | Status change |
| POST `/purchase-orders/:id/status` invalid returns 400 | Validation |
| GET `/purchase-orders/:id/status/history` returns timeline | History query |
| Non-admin access returns 403 | Permission check |
| Cross-org access returns 404 | Multi-tenancy |

### E2E Tests

**File:** `__tests__/e2e/settings/planning/po-statuses.spec.ts`

| Test Case | Description |
|-----------|-------------|
| Add custom status flow | Form > fill > save > appears in list |
| Edit status name and color | Edit > change > save > updates |
| Reorder statuses via drag | Drag status > drop > order changes |
| Configure transition rules | Status > transitions > check/uncheck > save |
| Delete unused status | Status > delete > confirm > removed |
| Cannot delete status in use | Status > delete > error message |
| Change PO status via dropdown | PO detail > status dropdown > select > confirm |
| View status history timeline | PO detail > timeline appears with entries |
| Admin-only access | Non-admin sees 403 or redirect |
| Status color reflects in badges | Config change > badge updates |

---

## Future Phases (Not in MVP)

### Phase 1
- **Status-based Notifications** - Email/Slack on status change
- **Custom Status Icons** - Upload or select icon per status
- **Conditional Transition Rules** - Define complex conditions (e.g., "total > $10k requires approval")

### Phase 2
- **Workflow Automation** - Auto-transition based on triggers
- **Status Analytics** - Time-in-status reports, bottleneck detection
- **Bulk Status Changes** - Change status for multiple POs at once
- **Status Change Templates** - Pre-defined transition notes

### Phase 3
- **Status-based Permissions** - Fine-grained access control by status
- **External Status Sync** - EDI status updates from suppliers
- **Status Webhooks** - Trigger external systems on status change

**Implementation**: See Epic 03.0 "Future Feature Handling" for guidance on Phase 1+ features in UI/API.

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-12-16 | Initial story creation | ARCHITECT-AGENT |
