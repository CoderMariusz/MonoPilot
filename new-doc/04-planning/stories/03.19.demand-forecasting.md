# 03.19 - Basic Demand Forecasting

**Story ID:** 03.19
**Epic:** 03 - Planning
**Phase:** 2 (MRP/Forecasting)
**Complexity:** L (Large)
**Estimate:** 5-7 days
**Type:** Full-stack
**State:** ready

**Primary PRD:** `docs/1-BASELINE/product/modules/PLANNING.md` (FR-PLAN-031, FR-PLAN-032, FR-PLAN-033)
**Depends On:** 03.18 (Demand History Tracking)

## PRD References

| FR ID | Requirement | Priority | Phase | Covered |
|-------|-------------|----------|-------|---------|
| FR-PLAN-031 | Basic Demand Forecasting | Should Have | 2 | Yes |
| FR-PLAN-032 | Safety Stock Management | Should Have | 2 | Yes |
| FR-PLAN-033 | Reorder Point Alerts | Should Have | 2 | Yes |

## User Story

**As a** planner,
**I want** to generate demand forecasts based on historical consumption data,
**So that** I can proactively order materials before stockouts occur.

**As an** operations manager,
**I want** to see products below safety stock and at reorder point,
**So that** I can prioritize procurement actions and prevent production disruptions.

## Goal

Implement basic demand forecasting using simple moving average (SMA), calculate safety stock levels considering lead time and demand variability, and generate reorder point alerts when inventory reaches critical levels. This enables proactive inventory management without complex MRP algorithms.

## Scope

**In scope:**
- Simple Moving Average (SMA) forecasting (7, 14, 30 day horizons)
- Weighted Moving Average (WMA) as alternative method
- Safety stock calculation (lead time + demand variability)
- Reorder point calculation (ROP = avg daily demand x lead time + safety stock)
- Product-level safety stock overrides
- Dashboard showing products below safety stock
- Dashboard showing products at/below reorder point
- Forecast confidence level calculation
- Integration with current inventory levels
- Email notifications for reorder alerts (optional)
- Drill-down to suggested PO creation

**Out of scope:**
- Seasonal adjustment algorithms (future enhancement)
- Machine learning forecasting
- Multi-location safety stock optimization
- Auto-PO generation (see 03.20 Auto-Replenishment)
- MRP explosion calculations (see 03.21 MRP Engine)

## Dependencies

| Story | Requirement | Status |
|-------|-------------|--------|
| 03.18 | Demand History Tracking | Required - provides historical data |
| 03.17 | Planning Settings | Required - MRP settings configuration |
| 01.1 | Org Context + Base RLS | Required - multi-tenancy |

## Acceptance Criteria (Given/When/Then)

### Basic Demand Forecasting (FR-PLAN-031)

#### Forecast Generation
- GIVEN demand history exists for a product (minimum 14 days), WHEN user generates forecast, THEN system calculates using selected method.
- GIVEN SMA method selected with 7-day window, WHEN forecast generated, THEN system averages last 7 days of consumption data.
- GIVEN WMA method selected, WHEN forecast generated, THEN recent days weighted higher (weights: 0.4, 0.3, 0.2, 0.1 for 4-period).
- GIVEN insufficient history (<14 days), WHEN forecast requested, THEN warning displayed "Insufficient data for reliable forecast".

#### Forecast Horizons
- GIVEN forecast generated, WHEN displayed, THEN 7-day, 14-day, and 30-day horizons shown.
- GIVEN 7-day horizon, WHEN calculated, THEN daily forecast values shown for next 7 days.
- GIVEN 30-day horizon, WHEN calculated, THEN weekly aggregated forecasts shown.

#### Confidence Level
- GIVEN forecast calculated, WHEN confidence computed, THEN based on coefficient of variation (CV = StdDev/Mean).
- GIVEN CV < 0.25, WHEN confidence displayed, THEN "High" (>80%) confidence shown.
- GIVEN CV between 0.25-0.50, WHEN confidence displayed, THEN "Medium" (50-80%) confidence shown.
- GIVEN CV > 0.50, WHEN confidence displayed, THEN "Low" (<50%) confidence shown.

#### Product/Group Forecasting
- GIVEN user selects single product, WHEN forecast generated, THEN product-specific forecast displayed.
- GIVEN user selects product category, WHEN forecast generated, THEN aggregated forecast for category displayed.
- GIVEN forecast results, WHEN exported, THEN CSV download available with all forecast data.

### Safety Stock Management (FR-PLAN-032)

#### Safety Stock Calculation
- GIVEN product with demand history, WHEN safety stock calculated, THEN formula: `SS = ADD * SSD * (1 + CV)`.
  - ADD = Average Daily Demand
  - SSD = Safety Stock Days (from settings, default 7)
  - CV = Coefficient of Variation (demand variability)
- GIVEN product with lead time 5 days and ADD = 100 units, WHEN SS calculated with SSD=7 and CV=0.2, THEN SS = 100 * 7 * 1.2 = 840 units.

#### Safety Stock Override
- GIVEN calculated safety stock, WHEN user wants different value, THEN manual override allowed per product.
- GIVEN manual override set, WHEN dashboard displays SS, THEN override value shown with "Manual" indicator.
- GIVEN override removed, WHEN SS displayed, THEN reverts to calculated value.

#### Safety Stock Dashboard
- GIVEN products with safety stock levels, WHEN dashboard loaded, THEN products below SS highlighted in red.
- GIVEN product inventory = 500, SS = 840, WHEN displayed, THEN shows "340 units below safety stock".
- GIVEN dashboard, WHEN filtered by "Below Safety Stock", THEN only critical products shown.
- GIVEN dashboard sorted by criticality, WHEN displayed, THEN most critical (lowest % of SS) shown first.

#### Safety Stock Alerts
- GIVEN product drops below safety stock, WHEN alert generated, THEN notification shown in dashboard.
- GIVEN alert generated, WHEN email notifications enabled, THEN email sent to configured recipients.
- GIVEN alert acknowledged, WHEN user dismisses, THEN alert marked as read but history retained.

### Reorder Point Alerts (FR-PLAN-033)

#### Reorder Point Calculation
- GIVEN product with lead time and safety stock, WHEN ROP calculated, THEN formula: `ROP = (ADD * LTD) + SS`.
  - ADD = Average Daily Demand
  - LTD = Lead Time Days (from product or supplier)
  - SS = Safety Stock
- GIVEN ADD = 100, LTD = 5, SS = 840, WHEN ROP calculated, THEN ROP = (100 * 5) + 840 = 1,340 units.

#### ROP Dashboard
- GIVEN products with ROP levels, WHEN dashboard loaded, THEN products at/below ROP shown.
- GIVEN product inventory = 1,200, ROP = 1,340, WHEN displayed, THEN shows "At reorder point - 140 units below".
- GIVEN ROP dashboard, WHEN product clicked, THEN drill-down shows demand details and suggested PO.

#### ROP Notifications
- GIVEN product reaches ROP, WHEN notification triggered, THEN in-app alert created.
- GIVEN email notifications enabled in settings, WHEN ROP breached, THEN email sent with product details.
- GIVEN multiple products at ROP, WHEN notifications sent, THEN grouped into single daily digest (if configured).

#### Suggested PO Creation
- GIVEN product at ROP, WHEN "Create PO" clicked, THEN PO modal opens with:
  - Default supplier pre-selected
  - Suggested quantity = ROP + (ADD * LTD) - current inventory (order up to reorder level)
  - Expected delivery date = today + supplier lead time
- GIVEN suggested PO created, WHEN saved, THEN draft PO created and linked to ROP alert.

### Integration with Inventory

- GIVEN forecast dashboard, WHEN loaded, THEN current inventory levels shown alongside forecasts.
- GIVEN current inventory = 2,000, forecast 7-day consumption = 700, WHEN displayed, THEN "Days of Supply: 20 days" shown.
- GIVEN days of supply < lead time + safety stock days, WHEN displayed, THEN warning indicator shown.

### Multi-tenancy

- GIVEN User A from Org A, WHEN viewing forecasts, THEN only Org A product data shown.
- GIVEN User A from Org A, WHEN accessing Org B forecast, THEN 404 Not Found returned.

## Technical Specification

### Database Schema

#### product_inventory_levels table (new or extend products)

```sql
-- Extend products table or create inventory tracking view
-- Option: Add columns to products table
ALTER TABLE products ADD COLUMN IF NOT EXISTS
  safety_stock_override NUMERIC(15,4);

ALTER TABLE products ADD COLUMN IF NOT EXISTS
  safety_stock_calculated NUMERIC(15,4);

ALTER TABLE products ADD COLUMN IF NOT EXISTS
  reorder_point_calculated NUMERIC(15,4);

ALTER TABLE products ADD COLUMN IF NOT EXISTS
  avg_daily_demand NUMERIC(15,4);

ALTER TABLE products ADD COLUMN IF NOT EXISTS
  demand_variability NUMERIC(5,4);

ALTER TABLE products ADD COLUMN IF NOT EXISTS
  last_forecast_date TIMESTAMPTZ;
```

#### demand_forecasts table (from PRD)

```sql
CREATE TABLE IF NOT EXISTS demand_forecasts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id),
  product_id UUID NOT NULL REFERENCES products(id),
  forecast_date DATE NOT NULL,
  horizon_days INTEGER NOT NULL, -- 7, 14, 30
  forecast_qty NUMERIC(15,4) NOT NULL,
  confidence NUMERIC(5,2), -- 0-100%
  method_used TEXT NOT NULL, -- 'sma', 'wma'
  parameters JSONB, -- {window_size: 7, weights: [...]}
  generated_at TIMESTAMPTZ DEFAULT NOW(),
  generated_by UUID REFERENCES users(id),
  created_at TIMESTAMPTZ DEFAULT NOW(),

  UNIQUE(org_id, product_id, forecast_date, horizon_days)
);

-- Indexes
CREATE INDEX idx_forecasts_org_product ON demand_forecasts(org_id, product_id);
CREATE INDEX idx_forecasts_date ON demand_forecasts(forecast_date);
```

#### reorder_alerts table

```sql
CREATE TABLE reorder_alerts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id),
  product_id UUID NOT NULL REFERENCES products(id),
  alert_type TEXT NOT NULL, -- 'below_safety_stock', 'at_reorder_point'
  current_inventory NUMERIC(15,4) NOT NULL,
  threshold_value NUMERIC(15,4) NOT NULL, -- SS or ROP value
  shortage_qty NUMERIC(15,4) NOT NULL,
  status TEXT NOT NULL DEFAULT 'active', -- 'active', 'acknowledged', 'resolved'
  acknowledged_by UUID REFERENCES users(id),
  acknowledged_at TIMESTAMPTZ,
  resolved_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW(),

  -- Indexes
  CONSTRAINT reorder_alerts_active_unique
    UNIQUE(org_id, product_id, alert_type) WHERE status = 'active'
);

CREATE INDEX idx_reorder_alerts_org_status ON reorder_alerts(org_id, status);
CREATE INDEX idx_reorder_alerts_product ON reorder_alerts(product_id);
```

#### planning_settings extension

```sql
-- Extend planning_settings table
ALTER TABLE planning_settings ADD COLUMN IF NOT EXISTS
  forecast_default_method TEXT DEFAULT 'sma';

ALTER TABLE planning_settings ADD COLUMN IF NOT EXISTS
  forecast_sma_window INTEGER DEFAULT 7;

ALTER TABLE planning_settings ADD COLUMN IF NOT EXISTS
  reorder_alert_email_enabled BOOLEAN DEFAULT false;

ALTER TABLE planning_settings ADD COLUMN IF NOT EXISTS
  reorder_alert_email_recipients JSONB DEFAULT '[]';

ALTER TABLE planning_settings ADD COLUMN IF NOT EXISTS
  reorder_alert_digest_enabled BOOLEAN DEFAULT true;

ALTER TABLE planning_settings ADD COLUMN IF NOT EXISTS
  reorder_alert_digest_time TIME DEFAULT '08:00';
```

### RLS Policies

```sql
-- demand_forecasts: org isolation
CREATE POLICY "forecasts_tenant_isolation" ON demand_forecasts
FOR ALL USING (
  current_setting('request.jwt.claims', true)::json->>'role' = 'service_role'
  OR org_id = (auth.jwt() ->> 'org_id')::uuid
);

-- reorder_alerts: org isolation
CREATE POLICY "reorder_alerts_tenant_isolation" ON reorder_alerts
FOR ALL USING (
  current_setting('request.jwt.claims', true)::json->>'role' = 'service_role'
  OR org_id = (auth.jwt() ->> 'org_id')::uuid
);
```

### API Endpoints

```
# Demand Forecasting
GET    /api/planning/mrp/forecasts                     - List forecasts with filters
GET    /api/planning/mrp/forecasts/:productId         - Get product forecast details
POST   /api/planning/mrp/forecasts/generate           - Generate forecasts for products
POST   /api/planning/mrp/forecasts/generate-all       - Batch generate for all products
GET    /api/planning/mrp/forecasts/export             - Export forecasts to CSV

# Safety Stock
GET    /api/planning/mrp/safety-stock                 - List products with SS status
GET    /api/planning/mrp/safety-stock/:productId      - Get product SS details
PUT    /api/planning/mrp/safety-stock/:productId      - Update SS override
POST   /api/planning/mrp/safety-stock/calculate       - Recalculate SS for products
GET    /api/planning/mrp/safety-stock/below           - Products below safety stock

# Reorder Points
GET    /api/planning/mrp/reorder-points               - List products with ROP status
GET    /api/planning/mrp/reorder-points/alerts        - Get active ROP alerts
PUT    /api/planning/mrp/reorder-points/alerts/:id    - Acknowledge/dismiss alert
POST   /api/planning/mrp/reorder-points/suggested-po  - Get suggested PO for product

# Dashboard
GET    /api/planning/mrp/dashboard                    - Aggregated MRP dashboard data
GET    /api/planning/mrp/dashboard/critical           - Critical items needing attention
```

### Service Methods

**Location:** `lib/services/forecast-service.ts`

```typescript
interface ForecastService {
  // Forecast generation
  generateForecast(
    productId: string,
    method: 'sma' | 'wma',
    horizons: number[]
  ): Promise<Forecast[]>;

  generateBulkForecasts(
    productIds: string[],
    method: 'sma' | 'wma'
  ): Promise<BulkForecastResult>;

  // Forecast retrieval
  getForecasts(productId: string): Promise<Forecast[]>;
  getForecastsByHorizon(horizon: number): Promise<Forecast[]>;

  // Calculation methods
  calculateSMA(demandHistory: DemandData[], windowSize: number): number;
  calculateWMA(demandHistory: DemandData[], weights: number[]): number;
  calculateConfidence(demandHistory: DemandData[]): ConfidenceResult;

  // Export
  exportForecasts(filters: ForecastFilters): Promise<CSVData>;
}

interface Forecast {
  id: string;
  product_id: string;
  forecast_date: string;
  horizon_days: number;
  forecast_qty: number;
  confidence: number;
  method_used: string;
  generated_at: string;
}

interface ConfidenceResult {
  cv: number; // Coefficient of Variation
  confidence_pct: number;
  confidence_level: 'high' | 'medium' | 'low';
}
```

**Location:** `lib/services/safety-stock-service.ts`

```typescript
interface SafetyStockService {
  // Calculation
  calculateSafetyStock(productId: string): Promise<SafetyStockResult>;
  calculateBulkSafetyStock(productIds: string[]): Promise<BulkSSResult>;

  // Override management
  setSafetyStockOverride(productId: string, value: number): Promise<void>;
  removeSafetyStockOverride(productId: string): Promise<void>;

  // Queries
  getProductSafetyStock(productId: string): Promise<SafetyStockDetails>;
  getProductsBelowSafetyStock(): Promise<ProductSSStatus[]>;

  // Helpers
  getAverageDailyDemand(productId: string, days: number): Promise<number>;
  getDemandVariability(productId: string, days: number): Promise<number>;
}

interface SafetyStockResult {
  product_id: string;
  avg_daily_demand: number;
  safety_stock_days: number;
  demand_variability: number;
  calculated_ss: number;
  override_ss: number | null;
  effective_ss: number;
}

interface ProductSSStatus {
  product_id: string;
  product_name: string;
  product_code: string;
  current_inventory: number;
  safety_stock: number;
  shortage: number;
  shortage_pct: number;
  is_critical: boolean;
}
```

**Location:** `lib/services/reorder-point-service.ts`

```typescript
interface ReorderPointService {
  // Calculation
  calculateReorderPoint(productId: string): Promise<ReorderPointResult>;
  calculateBulkReorderPoints(productIds: string[]): Promise<BulkROPResult>;

  // Alert management
  checkReorderPoints(): Promise<ReorderAlert[]>;
  createAlert(productId: string, type: AlertType): Promise<ReorderAlert>;
  acknowledgeAlert(alertId: string, userId: string): Promise<void>;
  resolveAlert(alertId: string): Promise<void>;

  // Queries
  getActiveAlerts(): Promise<ReorderAlert[]>;
  getAlertHistory(productId: string): Promise<ReorderAlert[]>;

  // Suggested PO
  getSuggestedPO(productId: string): Promise<SuggestedPO>;

  // Notifications
  sendAlertNotifications(alerts: ReorderAlert[]): Promise<void>;
  sendDailyDigest(): Promise<void>;
}

interface ReorderPointResult {
  product_id: string;
  avg_daily_demand: number;
  lead_time_days: number;
  safety_stock: number;
  reorder_point: number;
  current_inventory: number;
  is_at_rop: boolean;
  shortage: number;
}

interface SuggestedPO {
  supplier_id: string;
  supplier_name: string;
  product_id: string;
  product_name: string;
  suggested_qty: number;
  expected_delivery: string;
  unit_price: number;
  total_value: number;
}

type AlertType = 'below_safety_stock' | 'at_reorder_point';
```

### Zod Validation Schemas

**Location:** `lib/validation/forecast.ts`

```typescript
import { z } from 'zod';

export const forecastMethodSchema = z.enum(['sma', 'wma']);

export const generateForecastSchema = z.object({
  product_ids: z.array(z.string().uuid()).min(1),
  method: forecastMethodSchema.default('sma'),
  horizons: z.array(z.number().int().positive()).default([7, 14, 30]),
  window_size: z.number().int().min(3).max(30).optional(),
});

export const forecastResponseSchema = z.object({
  id: z.string().uuid(),
  product_id: z.string().uuid(),
  forecast_date: z.string(),
  horizon_days: z.number(),
  forecast_qty: z.number(),
  confidence: z.number().min(0).max(100),
  method_used: forecastMethodSchema,
  generated_at: z.string().datetime(),
});

export const forecastFiltersSchema = z.object({
  product_id: z.string().uuid().optional(),
  category_id: z.string().uuid().optional(),
  horizon_days: z.number().optional(),
  min_confidence: z.number().min(0).max(100).optional(),
  from_date: z.string().optional(),
  to_date: z.string().optional(),
});
```

**Location:** `lib/validation/safety-stock.ts`

```typescript
import { z } from 'zod';

export const safetyStockOverrideSchema = z.object({
  override_value: z.number().positive().nullable(),
});

export const safetyStockStatusSchema = z.object({
  product_id: z.string().uuid(),
  product_name: z.string(),
  product_code: z.string(),
  current_inventory: z.number(),
  safety_stock: z.number(),
  shortage: z.number(),
  shortage_pct: z.number(),
  is_override: z.boolean(),
  is_critical: z.boolean(),
});

export const bulkCalculateSchema = z.object({
  product_ids: z.array(z.string().uuid()).optional(),
  category_id: z.string().uuid().optional(),
  recalculate_all: z.boolean().default(false),
});
```

**Location:** `lib/validation/reorder-point.ts`

```typescript
import { z } from 'zod';

export const reorderAlertSchema = z.object({
  id: z.string().uuid(),
  product_id: z.string().uuid(),
  alert_type: z.enum(['below_safety_stock', 'at_reorder_point']),
  current_inventory: z.number(),
  threshold_value: z.number(),
  shortage_qty: z.number(),
  status: z.enum(['active', 'acknowledged', 'resolved']),
  created_at: z.string().datetime(),
});

export const acknowledgeAlertSchema = z.object({
  alert_id: z.string().uuid(),
});

export const suggestedPOSchema = z.object({
  supplier_id: z.string().uuid(),
  product_id: z.string().uuid(),
  suggested_qty: z.number().positive(),
  expected_delivery: z.string(),
});
```

## UI Components

### Pages

- `app/(authenticated)/planning/mrp/page.tsx` - MRP Dashboard (forecasts, SS, ROP)
- `app/(authenticated)/planning/mrp/forecasts/page.tsx` - Forecast management
- `app/(authenticated)/planning/mrp/safety-stock/page.tsx` - Safety stock management
- `app/(authenticated)/planning/mrp/alerts/page.tsx` - Reorder alerts list

### Components

**Location:** `components/planning/mrp/`

```
ForecastDashboard.tsx         - Main forecast overview
ForecastChart.tsx             - Line chart showing forecast vs actuals
ForecastTable.tsx             - Tabular forecast data with export
GenerateForecastModal.tsx     - Modal to trigger forecast generation
ForecastConfidenceBadge.tsx   - Visual confidence indicator

SafetyStockDashboard.tsx      - SS overview with critical items
SafetyStockTable.tsx          - Products with SS status
SafetyStockOverrideModal.tsx  - Override SS for product
SafetyStockProgressBar.tsx    - Visual SS level indicator

ReorderPointDashboard.tsx     - ROP overview with alerts
ReorderAlertCard.tsx          - Individual alert card
ReorderAlertList.tsx          - List of active alerts
SuggestedPOModal.tsx          - Create PO from ROP alert
AlertAcknowledgeDialog.tsx    - Confirm alert acknowledgment

MRPKPICards.tsx               - Summary KPI metrics
DaysOfSupplyIndicator.tsx     - Days of supply calculation
CriticalItemsBanner.tsx       - Banner for urgent items
```

### Component Details

**ForecastDashboard.tsx**
```tsx
interface ForecastDashboardProps {
  filters: ForecastFilters;
  onFilterChange: (filters: ForecastFilters) => void;
}

// Displays:
// - KPI cards (total products forecasted, avg confidence, etc.)
// - Forecast chart for selected product
// - Table of all forecasts
// - Generate forecast button
```

**SafetyStockDashboard.tsx**
```tsx
interface SafetyStockDashboardProps {
  showCriticalOnly: boolean;
  onToggleCritical: (value: boolean) => void;
}

// Displays:
// - KPI cards (products below SS, total shortage value)
// - Critical items list (sorted by severity)
// - SS table with override capability
// - Recalculate button
```

**ReorderPointDashboard.tsx**
```tsx
interface ReorderPointDashboardProps {
  alertFilter: AlertFilter;
  onFilterChange: (filter: AlertFilter) => void;
}

// Displays:
// - Active alerts count badge
// - Alert cards with actions
// - Quick PO creation button
// - Alert history toggle
```

### UI Patterns

**Forecast Card Layout:**
```
+------------------------------------------+
| Flour (RM-FLOUR-001)                     |
| Forecast: 1,250 units/week               |
| Confidence: [====] 78% Medium            |
|                                          |
| 7-day:  8,750 units | 14-day: 17,500    |
| Current Stock: 12,000 | DoS: 10 days    |
+------------------------------------------+
```

**Safety Stock Status Row:**
```
| Product | Current | SS Level | Status    | Action     |
|---------|---------|----------|-----------|------------|
| Flour   | 500     | 840      | -340 RED  | [Override] |
| Sugar   | 2,000   | 1,200    | OK GREEN  | [Override] |
```

**Reorder Alert Card:**
```
+------------------------------------------+
| ! REORDER POINT REACHED                  |
| Sugar (RM-SUGAR-001)                     |
|                                          |
| Current: 1,200 units | ROP: 1,340 units |
| Shortage: 140 units                      |
|                                          |
| Default Supplier: Sugar Inc.             |
| Lead Time: 5 days                        |
|                                          |
| [Acknowledge] [Create PO] [Dismiss]      |
+------------------------------------------+
```

## Test Cases

### Unit Tests

**forecast-service.test.ts**
```typescript
describe('ForecastService', () => {
  describe('calculateSMA', () => {
    it('calculates simple moving average correctly');
    it('handles window size larger than data');
    it('returns null for insufficient data');
  });

  describe('calculateWMA', () => {
    it('applies weights correctly to recent periods');
    it('validates weights sum to 1');
  });

  describe('calculateConfidence', () => {
    it('returns high confidence for CV < 0.25');
    it('returns medium confidence for CV 0.25-0.50');
    it('returns low confidence for CV > 0.50');
  });

  describe('generateForecast', () => {
    it('generates forecast for all horizons');
    it('stores forecast in database');
    it('handles product without history gracefully');
  });
});
```

**safety-stock-service.test.ts**
```typescript
describe('SafetyStockService', () => {
  describe('calculateSafetyStock', () => {
    it('uses formula: ADD * SSD * (1 + CV)');
    it('respects safety_stock_days from settings');
    it('returns override value when set');
  });

  describe('getProductsBelowSafetyStock', () => {
    it('returns products where inventory < SS');
    it('sorts by shortage percentage descending');
    it('respects RLS for org isolation');
  });

  describe('setSafetyStockOverride', () => {
    it('updates product with override value');
    it('validates positive number');
  });
});
```

**reorder-point-service.test.ts**
```typescript
describe('ReorderPointService', () => {
  describe('calculateReorderPoint', () => {
    it('uses formula: (ADD * LTD) + SS');
    it('uses product lead time when available');
    it('falls back to supplier lead time');
  });

  describe('checkReorderPoints', () => {
    it('creates alerts for products at/below ROP');
    it('does not duplicate active alerts');
    it('auto-resolves alerts when inventory restored');
  });

  describe('getSuggestedPO', () => {
    it('selects default supplier');
    it('calculates order-up-to quantity');
    it('sets delivery date based on lead time');
  });
});
```

### Integration Tests

**forecast-api.test.ts**
```typescript
describe('Forecast API', () => {
  describe('POST /api/planning/mrp/forecasts/generate', () => {
    it('generates forecasts for specified products');
    it('validates product belongs to org');
    it('requires minimum history data');
    it('returns generated forecasts');
  });

  describe('GET /api/planning/mrp/forecasts', () => {
    it('returns forecasts filtered by product');
    it('respects org isolation');
    it('supports pagination');
  });

  describe('GET /api/planning/mrp/forecasts/export', () => {
    it('exports CSV with all forecast data');
    it('includes confidence levels');
  });
});
```

**safety-stock-api.test.ts**
```typescript
describe('Safety Stock API', () => {
  describe('GET /api/planning/mrp/safety-stock/below', () => {
    it('returns products below SS');
    it('includes current inventory levels');
    it('sorts by criticality');
  });

  describe('PUT /api/planning/mrp/safety-stock/:productId', () => {
    it('sets override value');
    it('validates positive number');
    it('returns 404 for other org product');
  });
});
```

**reorder-point-api.test.ts**
```typescript
describe('Reorder Point API', () => {
  describe('GET /api/planning/mrp/reorder-points/alerts', () => {
    it('returns active alerts');
    it('includes product and supplier details');
    it('respects org isolation');
  });

  describe('PUT /api/planning/mrp/reorder-points/alerts/:id', () => {
    it('acknowledges alert');
    it('records acknowledging user');
    it('returns 404 for other org alert');
  });

  describe('POST /api/planning/mrp/reorder-points/suggested-po', () => {
    it('returns suggested PO details');
    it('includes default supplier');
    it('calculates suggested quantity');
  });
});
```

### E2E Tests

**forecast-management.spec.ts**
```typescript
describe('Forecast Management', () => {
  it('generates forecast for selected product');
  it('displays forecast chart with confidence');
  it('shows warning for insufficient data');
  it('exports forecasts to CSV');
});
```

**safety-stock-management.spec.ts**
```typescript
describe('Safety Stock Management', () => {
  it('displays products below safety stock');
  it('allows override of calculated SS');
  it('removes override and reverts to calculated');
  it('triggers recalculation for all products');
});
```

**reorder-alerts.spec.ts**
```typescript
describe('Reorder Point Alerts', () => {
  it('displays active alerts');
  it('acknowledges alert');
  it('creates PO from alert');
  it('shows alert history');
});
```

## Calculations Reference

### Simple Moving Average (SMA)
```
SMA = (D1 + D2 + ... + Dn) / n

Where:
- D = Daily demand value
- n = Window size (e.g., 7 days)
```

### Weighted Moving Average (WMA)
```
WMA = (w1 * D1 + w2 * D2 + ... + wn * Dn)

Default weights for 4-period:
- w1 (most recent) = 0.4
- w2 = 0.3
- w3 = 0.2
- w4 = 0.1
```

### Coefficient of Variation (CV)
```
CV = StdDev(demand) / Mean(demand)

Confidence mapping:
- CV < 0.25: High confidence (>80%)
- CV 0.25-0.50: Medium confidence (50-80%)
- CV > 0.50: Low confidence (<50%)
```

### Safety Stock (SS)
```
SS = ADD * SSD * (1 + CV)

Where:
- ADD = Average Daily Demand
- SSD = Safety Stock Days (setting, default 7)
- CV = Coefficient of Variation
```

### Reorder Point (ROP)
```
ROP = (ADD * LTD) + SS

Where:
- ADD = Average Daily Demand
- LTD = Lead Time Days
- SS = Safety Stock
```

### Order-Up-To Quantity
```
Order Qty = ROP + (ADD * LTD) - Current Inventory

This orders enough to cover:
- Lead time demand (ADD * LTD)
- Safety stock buffer
- Brings inventory to reorder level
```

## Deliverables

- [ ] Database migration for demand_forecasts table
- [ ] Database migration for reorder_alerts table
- [ ] Database migration for planning_settings extensions
- [ ] Database migration for products table extensions (SS fields)
- [ ] RLS policies for new tables
- [ ] Forecast service (`lib/services/forecast-service.ts`)
- [ ] Safety stock service (`lib/services/safety-stock-service.ts`)
- [ ] Reorder point service (`lib/services/reorder-point-service.ts`)
- [ ] Zod schemas for validation
- [ ] API routes for forecasting
- [ ] API routes for safety stock
- [ ] API routes for reorder alerts
- [ ] MRP Dashboard page
- [ ] Forecast Dashboard component
- [ ] Safety Stock Dashboard component
- [ ] Reorder Alert Dashboard component
- [ ] Suggested PO Modal component
- [ ] Unit tests (>85% coverage)
- [ ] Integration tests
- [ ] E2E tests

## Definition of Done

- [ ] Forecasts generated using SMA method for products with sufficient history
- [ ] Forecasts show 7, 14, 30 day horizons with confidence levels
- [ ] Confidence calculated based on coefficient of variation
- [ ] Safety stock calculated using formula: ADD * SSD * (1 + CV)
- [ ] Safety stock override allowed per product
- [ ] Dashboard shows products below safety stock sorted by criticality
- [ ] Reorder point calculated using formula: (ADD * LTD) + SS
- [ ] Alerts created when inventory reaches reorder point
- [ ] Alerts can be acknowledged and dismissed
- [ ] Suggested PO created with default supplier and calculated quantity
- [ ] Current inventory levels integrated with forecasts
- [ ] Days of supply indicator shown on dashboard
- [ ] Email notifications sent when enabled in settings
- [ ] Multi-tenant isolation enforced (RLS)
- [ ] Unit test coverage >= 85%
- [ ] Integration tests pass
- [ ] E2E tests pass
