# 03.21 - MRP Calculation Engine

**Story ID:** 03.21
**Epic:** 03 - Planning
**Phase:** Phase 2
**Complexity:** XL (Extra Large)
**Estimate:** 7-10 days
**Type:** Backend + Frontend
**State:** ready
**Priority:** P2

**Primary PRD:** `docs/1-BASELINE/product/modules/PLANNING.md` (FR-PLAN-035, FR-PLAN-036)
**Architecture:** MRP/MPS Section (Section 8)

## PRD References

| FR ID | Requirement | Priority | Phase | Covered |
|-------|-------------|----------|-------|---------|
| FR-PLAN-035 | MRP Calculation Engine | Should Have | 2 | Yes |
| FR-PLAN-036 | Suggested Order Generation | Should Have | 2 | Yes |

## User Story

**As a** production planner,
**I want** the system to calculate material requirements based on production schedules,
**So that** I can ensure materials are available when needed and avoid production delays.

**As a** purchaser,
**I want** to receive suggested purchase orders with optimal quantities and dates,
**So that** I can efficiently procure materials without overstocking or stockouts.

## Goal

Implement a comprehensive MRP (Material Requirements Planning) calculation engine that:
1. Takes gross requirements from MPS (Master Production Schedule)
2. Explodes multi-level BOMs to determine component needs
3. Considers on-hand inventory from License Plates
4. Accounts for open POs and WOs (scheduled receipts)
5. Calculates net requirements with safety stock consideration
6. Generates suggested POs and WOs with lead time offsetting
7. Applies lot sizing rules (EOQ, FOQ, LFL)

## Scope

**In scope:**
- MRP calculation algorithm (gross -> net requirements)
- Multi-level BOM explosion
- On-hand inventory query (from license_plates table)
- Scheduled receipts calculation (open POs, open WOs)
- Net requirements calculation with safety stock
- Lead time offsetting for order dates
- Lot sizing rules (EOQ, FOQ, LFL, Min-Max)
- Suggested PO generation
- Suggested WO generation
- Accept/Reject/Modify suggestions
- Create draft orders from accepted suggestions
- MRP run history and audit

**Out of scope:**
- MRP Dashboard (FR-PLAN-037 - separate story 03.22)
- Capacity-constrained MRP (Phase 3)
- Demand forecasting integration (separate story 03.19)
- Auto-replenishment rules (separate story 03.23)
- Finite scheduling

## Dependencies

| Story | Requirement | Status |
|-------|-------------|--------|
| 03.20 | MPS (Master Production Schedule) | Required - source of gross requirements |
| 02.5a | BOM Items | Required - BOM explosion |
| 05.1 | LP Table (license_plates) | Required - on-hand inventory |
| 03.3 | PO CRUD | Required - scheduled receipts, create PO |
| 03.10 | WO CRUD | Required - scheduled receipts, create WO |
| 03.17 | Planning Settings | Required - MRP settings |

## Acceptance Criteria (Given/When/Then)

### MRP Calculation Core (FR-PLAN-035)

#### Gross Requirements Calculation
- GIVEN MPS entries exist for date range, WHEN MRP runs, THEN gross requirements equal sum of MPS planned_qty per product per period.
- GIVEN MPS entry for finished good, WHEN BOM exploded, THEN gross requirements generated for all component levels.
- GIVEN BOM with by-products, WHEN MRP runs, THEN by-product output adds to projected available.
- GIVEN multiple MPS entries same product same period, WHEN MRP runs, THEN quantities aggregated.

#### BOM Explosion (Multi-Level)
- GIVEN finished good with 2-level BOM, WHEN MRP explodes BOM, THEN requirements calculated for both levels.
- GIVEN BOM item with scrap_percent = 5%, WHEN quantity calculated, THEN quantity = base_qty * 1.05.
- GIVEN BOM with sub-assembly that has own BOM, WHEN MRP runs, THEN sub-assembly BOM also exploded.
- GIVEN circular BOM reference (A -> B -> A), WHEN MRP runs, THEN error returned, calculation stopped.
- GIVEN BOM with yield_percent, WHEN calculating, THEN output adjusted: required_input = output_qty / (yield_percent / 100).
- GIVEN product with multiple active BOMs, WHEN MRP runs, THEN BOM with latest effective_from before requirement date selected.

#### Scheduled Receipts
- GIVEN open PO line for product with expected_delivery_date, WHEN MRP runs, THEN quantity added to scheduled receipts for that period.
- GIVEN open WO producing product with scheduled_date, WHEN MRP runs, THEN expected output added to scheduled receipts.
- GIVEN PO with status 'cancelled', WHEN MRP runs, THEN PO not included in scheduled receipts.
- GIVEN WO with status in ['draft', 'planned', 'released', 'in_progress'], WHEN MRP runs, THEN WO output included in scheduled receipts.
- GIVEN WO with status 'cancelled' or 'closed', WHEN MRP runs, THEN WO not included in scheduled receipts.
- GIVEN partial PO receipt (received_qty > 0), WHEN MRP runs, THEN scheduled receipt = ordered_qty - received_qty.

#### On-Hand Inventory
- GIVEN license_plates for product in warehouse, WHEN MRP queries on-hand, THEN SUM(quantity) where status = 'available'.
- GIVEN LP with status 'reserved' or 'consumed', WHEN MRP queries, THEN LP excluded from on-hand.
- GIVEN multiple warehouses, WHEN MRP runs with warehouse_id filter, THEN only that warehouse inventory counted.
- GIVEN MRP runs without warehouse filter, WHEN querying inventory, THEN all org warehouses aggregated.

#### Projected Available Calculation
- GIVEN on_hand = 100, scheduled_receipts = 50, gross_requirements = 120, WHEN calculating projected available, THEN projected = 100 + 50 - 120 = 30.
- GIVEN projected_available calculated per period, WHEN displayed, THEN running balance shown period by period.
- GIVEN beginning_inventory for period 2, WHEN calculating, THEN beginning_inventory = ending_inventory of period 1.

#### Net Requirements Calculation
- GIVEN projected_available = 30, safety_stock = 50, WHEN calculating net requirement, THEN net_requirement = 50 - 30 = 20.
- GIVEN projected_available > safety_stock, WHEN calculating, THEN net_requirement = 0 (no shortage).
- GIVEN projected_available < 0 (stockout), WHEN calculating, THEN net_requirement = ABS(projected_available) + safety_stock.
- GIVEN safety_stock = 0 for product, WHEN calculating, THEN net_requirement = MAX(0, -projected_available).

#### Lead Time Offsetting
- GIVEN product.supplier_lead_time_days = 7, requirement_date = Jan 15, WHEN calculating order_date, THEN order_date = Jan 8.
- GIVEN planning_settings.auto_po_lead_time_buffer = 2, WHEN calculating order_date, THEN order_date = requirement_date - lead_time - buffer.
- GIVEN lead_time = 0 (same-day), WHEN calculating, THEN order_date = requirement_date.
- GIVEN order_date calculated as past date, WHEN suggestion generated, THEN order_date = today (urgent flag set).

### Lot Sizing Rules

#### Lot-for-Lot (LFL)
- GIVEN lot_sizing_rule = 'lfl', net_requirement = 75, WHEN calculating order_qty, THEN order_qty = 75.

#### Fixed Order Quantity (FOQ)
- GIVEN lot_sizing_rule = 'foq', fixed_order_qty = 100, net_requirement = 75, WHEN calculating, THEN order_qty = 100.
- GIVEN lot_sizing_rule = 'foq', fixed_order_qty = 100, net_requirement = 150, WHEN calculating, THEN order_qty = 200 (2 x 100).

#### Economic Order Quantity (EOQ)
- GIVEN lot_sizing_rule = 'eoq', WHEN calculating, THEN EOQ = sqrt(2 * annual_demand * order_cost / holding_cost).
- GIVEN EOQ = 120, net_requirement = 50, WHEN order placed, THEN order_qty = 120 (EOQ rounded).
- GIVEN EOQ = 120, net_requirement = 200, WHEN order placed, THEN order_qty = 240 (2 x EOQ).

#### Min-Max
- GIVEN lot_sizing_rule = 'min_max', min_qty = 50, max_qty = 200, projected_available = 30, WHEN calculating, THEN order_qty = 200 - 30 = 170 (order up to max).
- GIVEN min_qty = 50, net_requirement = 20, WHEN calculating, THEN order_qty = 50 (minimum order).

#### Order Multiple
- GIVEN product.order_multiple = 25, calculated_qty = 78, WHEN finalizing order_qty, THEN order_qty = 100 (rounded up to multiple).
- GIVEN MOQ = 100, calculated_qty = 75, WHEN finalizing, THEN order_qty = 100 (MOQ applied).

### Suggested Order Generation (FR-PLAN-036)

#### Suggested PO Generation
- GIVEN net_requirement > 0 for purchased product, WHEN MRP completes, THEN suggested PO created in mrp_suggestions table.
- GIVEN suggested PO created, WHEN suggestion includes, THEN: product_id, supplier_id (default supplier), quantity, required_date, order_date, status='suggested'.
- GIVEN product has multiple suppliers, WHEN suggestion created, THEN default supplier (is_default=true) selected.
- GIVEN no default supplier for product, WHEN suggestion created, THEN supplier_id = null, warning flag set.
- GIVEN multiple suggestions for same product same supplier, WHEN within consolidation_days, THEN suggestions consolidated into single PO.

#### Suggested WO Generation
- GIVEN net_requirement > 0 for manufactured product (has BOM), WHEN MRP completes, THEN suggested WO created.
- GIVEN suggested WO created, WHEN suggestion includes, THEN: product_id, quantity, required_date, start_date (= required_date - production_lead_time).
- GIVEN manufactured product with routing, WHEN calculating production_lead_time, THEN lead_time = SUM(routing_operations.expected_duration_minutes) / 60 / 8 (8h day).

#### Accept Suggestion
- GIVEN suggestion with status='suggested', WHEN user clicks Accept, THEN status changes to 'accepted'.
- GIVEN PO suggestion accepted, WHEN processing, THEN draft PO created with suggested values.
- GIVEN WO suggestion accepted, WHEN processing, THEN draft WO created with suggested values (BOM snapshot taken).
- GIVEN suggestion accepted, WHEN complete, THEN created_order_id populated with new PO/WO id.
- GIVEN suggestion accepted, WHEN complete, THEN accepted_by = current_user_id, accepted_at = now().

#### Reject Suggestion
- GIVEN suggestion with status='suggested', WHEN user clicks Reject, THEN status changes to 'rejected'.
- GIVEN suggestion rejected, WHEN next MRP run, THEN new suggestion may be generated if requirement still exists.
- GIVEN rejected suggestion, WHEN displayed, THEN shown in history with rejection reason.

#### Modify Suggestion
- GIVEN suggestion with status='suggested', WHEN user modifies quantity/date, THEN suggestion updated.
- GIVEN modified suggestion accepted, WHEN creating order, THEN modified values used.
- GIVEN user modifies supplier for PO suggestion, WHEN accepted, THEN PO created with modified supplier.

### MRP Run Management

#### Run Initiation
- GIVEN user clicks "Run MRP", WHEN modal opens, THEN options shown: date range, warehouse filter, product filter.
- GIVEN MRP run initiated, WHEN processing starts, THEN mrp_runs record created with status='running'.
- GIVEN MRP run completes, WHEN successful, THEN status='completed', completed_at set.
- GIVEN MRP run fails, WHEN error occurs, THEN status='failed', error_message stored.

#### Run History
- GIVEN MRP completed, WHEN viewing history, THEN run shows: started_at, completed_at, products_processed, suggestions_generated.
- GIVEN previous suggestions exist, WHEN new MRP run, THEN old 'suggested' status suggestions marked 'superseded'.
- GIVEN MRP run history, WHEN user clicks run, THEN details show parameters and summary stats.

#### Performance
- GIVEN 1000 products in org, WHEN MRP runs, THEN calculation completes in < 30 seconds.
- GIVEN MRP running, WHEN progress updates, THEN progress bar shows products processed / total.
- GIVEN large BOM explosion (5+ levels), WHEN calculating, THEN async processing with status updates.

### Multi-tenancy
- GIVEN User A from Org A runs MRP, WHEN calculating, THEN only Org A data processed.
- GIVEN User A views suggestions, WHEN listing, THEN only Org A suggestions returned.
- GIVEN User A attempts to accept Org B suggestion, WHEN API called, THEN 404 Not Found.

## Technical Specification

### Database Schema

#### mrp_runs table

```sql
CREATE TABLE mrp_runs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,

  -- Run parameters
  start_date DATE NOT NULL,
  end_date DATE NOT NULL,
  warehouse_id UUID REFERENCES warehouses(id), -- null = all warehouses
  product_ids UUID[], -- null = all products

  -- Run status
  status TEXT NOT NULL DEFAULT 'pending', -- pending, running, completed, failed
  started_at TIMESTAMPTZ,
  completed_at TIMESTAMPTZ,
  error_message TEXT,

  -- Run statistics
  products_processed INTEGER DEFAULT 0,
  suggestions_generated INTEGER DEFAULT 0,
  bom_levels_exploded INTEGER DEFAULT 0,

  -- Audit
  created_at TIMESTAMPTZ DEFAULT NOW(),
  created_by UUID NOT NULL REFERENCES users(id),

  CONSTRAINT mrp_runs_org_id_idx UNIQUE (org_id, id)
);

CREATE INDEX idx_mrp_runs_org_status ON mrp_runs(org_id, status);
CREATE INDEX idx_mrp_runs_created ON mrp_runs(org_id, created_at DESC);
```

#### mrp_suggestions table

```sql
CREATE TABLE mrp_suggestions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  mrp_run_id UUID NOT NULL REFERENCES mrp_runs(id) ON DELETE CASCADE,

  -- Suggestion type
  suggestion_type TEXT NOT NULL, -- 'po', 'wo'

  -- Product and source
  product_id UUID NOT NULL REFERENCES products(id),
  supplier_id UUID REFERENCES suppliers(id), -- for PO suggestions
  bom_id UUID REFERENCES boms(id), -- for WO suggestions

  -- Quantities
  net_requirement NUMERIC(15,4) NOT NULL,
  quantity NUMERIC(15,4) NOT NULL, -- After lot sizing

  -- Dates
  required_date DATE NOT NULL,
  order_date DATE NOT NULL, -- Lead-time offset

  -- Lot sizing info
  lot_sizing_rule TEXT, -- 'lfl', 'foq', 'eoq', 'min_max'
  lot_sizing_details JSONB, -- {eoq_value, moq_applied, order_multiple_applied}

  -- Flags
  is_urgent BOOLEAN DEFAULT false, -- order_date in past
  has_warning BOOLEAN DEFAULT false, -- no supplier, etc.
  warning_messages TEXT[],

  -- Status
  status TEXT NOT NULL DEFAULT 'suggested', -- suggested, accepted, rejected, superseded

  -- Acceptance tracking
  accepted_by UUID REFERENCES users(id),
  accepted_at TIMESTAMPTZ,
  rejected_by UUID REFERENCES users(id),
  rejected_at TIMESTAMPTZ,
  rejection_reason TEXT,

  -- Created order reference
  created_order_id UUID, -- FK to PO or WO (polymorphic)
  created_order_type TEXT, -- 'po', 'wo'

  -- Audit
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),

  CONSTRAINT mrp_suggestions_org_id_idx UNIQUE (org_id, id)
);

CREATE INDEX idx_mrp_suggestions_org_status ON mrp_suggestions(org_id, status);
CREATE INDEX idx_mrp_suggestions_run ON mrp_suggestions(mrp_run_id);
CREATE INDEX idx_mrp_suggestions_product ON mrp_suggestions(product_id);
CREATE INDEX idx_mrp_suggestions_required ON mrp_suggestions(required_date);
```

#### mrp_requirements table (calculation working table)

```sql
CREATE TABLE mrp_requirements (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  mrp_run_id UUID NOT NULL REFERENCES mrp_runs(id) ON DELETE CASCADE,

  -- Product and period
  product_id UUID NOT NULL REFERENCES products(id),
  period_date DATE NOT NULL,
  bom_level INTEGER DEFAULT 0, -- 0 = finished good, 1+ = components

  -- Requirements
  gross_requirement NUMERIC(15,4) DEFAULT 0,
  scheduled_receipts NUMERIC(15,4) DEFAULT 0,
  projected_available NUMERIC(15,4) DEFAULT 0,
  net_requirement NUMERIC(15,4) DEFAULT 0,
  planned_order_receipt NUMERIC(15,4) DEFAULT 0,
  planned_order_release NUMERIC(15,4) DEFAULT 0,

  -- Reference data
  safety_stock NUMERIC(15,4) DEFAULT 0,
  lead_time_days INTEGER DEFAULT 0,

  -- Audit
  created_at TIMESTAMPTZ DEFAULT NOW(),

  CONSTRAINT mrp_requirements_unique UNIQUE (mrp_run_id, product_id, period_date)
);

CREATE INDEX idx_mrp_requirements_run ON mrp_requirements(mrp_run_id);
CREATE INDEX idx_mrp_requirements_product ON mrp_requirements(mrp_run_id, product_id);
```

#### products table extension

```sql
-- Add MRP-related fields to products
ALTER TABLE products ADD COLUMN IF NOT EXISTS
  lot_sizing_rule TEXT DEFAULT 'lfl' CHECK (lot_sizing_rule IN ('lfl', 'foq', 'eoq', 'min_max'));

ALTER TABLE products ADD COLUMN IF NOT EXISTS
  fixed_order_qty NUMERIC(15,4);

ALTER TABLE products ADD COLUMN IF NOT EXISTS
  eoq_annual_demand NUMERIC(15,4);

ALTER TABLE products ADD COLUMN IF NOT EXISTS
  eoq_order_cost NUMERIC(15,4);

ALTER TABLE products ADD COLUMN IF NOT EXISTS
  eoq_holding_cost_percent NUMERIC(5,2);

ALTER TABLE products ADD COLUMN IF NOT EXISTS
  min_stock NUMERIC(15,4);

ALTER TABLE products ADD COLUMN IF NOT EXISTS
  max_stock NUMERIC(15,4);

ALTER TABLE products ADD COLUMN IF NOT EXISTS
  order_multiple NUMERIC(15,4);

ALTER TABLE products ADD COLUMN IF NOT EXISTS
  production_lead_time_days INTEGER DEFAULT 1;
```

#### planning_settings extension

```sql
-- Add MRP settings to planning_settings
ALTER TABLE planning_settings ADD COLUMN IF NOT EXISTS
  mrp_enabled BOOLEAN DEFAULT false;

ALTER TABLE planning_settings ADD COLUMN IF NOT EXISTS
  mrp_default_horizon_days INTEGER DEFAULT 30;

ALTER TABLE planning_settings ADD COLUMN IF NOT EXISTS
  mrp_consolidation_days INTEGER DEFAULT 3; -- Consolidate orders within X days

ALTER TABLE planning_settings ADD COLUMN IF NOT EXISTS
  mrp_auto_accept_threshold NUMERIC(15,4); -- Auto-accept suggestions below this qty

ALTER TABLE planning_settings ADD COLUMN IF NOT EXISTS
  mrp_default_safety_stock_days INTEGER DEFAULT 7;
```

### RLS Policies

```sql
-- mrp_runs: Users can see their org's runs
CREATE POLICY "mrp_runs_org_read" ON mrp_runs
FOR SELECT USING (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
);

CREATE POLICY "mrp_runs_org_insert" ON mrp_runs
FOR INSERT WITH CHECK (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
);

-- mrp_suggestions: Users can see their org's suggestions
CREATE POLICY "mrp_suggestions_org_read" ON mrp_suggestions
FOR SELECT USING (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
);

CREATE POLICY "mrp_suggestions_org_update" ON mrp_suggestions
FOR UPDATE USING (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
);

-- mrp_requirements: Users can see their org's requirements
CREATE POLICY "mrp_requirements_org_read" ON mrp_requirements
FOR SELECT USING (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
);
```

### API Endpoints

```
# MRP Run Management
POST   /api/planning/mrp/run                      - Initiate MRP calculation
GET    /api/planning/mrp/runs                     - List MRP run history
GET    /api/planning/mrp/runs/:id                 - Get MRP run details
GET    /api/planning/mrp/runs/:id/progress        - Get run progress (SSE/polling)
DELETE /api/planning/mrp/runs/:id                 - Cancel running MRP

# MRP Requirements (read-only results)
GET    /api/planning/mrp/requirements             - Get requirements by product/period
GET    /api/planning/mrp/requirements/:productId  - Get product requirements timeline

# MRP Suggestions
GET    /api/planning/mrp/suggestions              - List suggestions (with filters)
GET    /api/planning/mrp/suggestions/:id          - Get suggestion details
PUT    /api/planning/mrp/suggestions/:id          - Modify suggestion
POST   /api/planning/mrp/suggestions/:id/accept   - Accept suggestion (creates order)
POST   /api/planning/mrp/suggestions/:id/reject   - Reject suggestion
POST   /api/planning/mrp/suggestions/bulk-accept  - Accept multiple suggestions
POST   /api/planning/mrp/suggestions/bulk-reject  - Reject multiple suggestions

# Coverage Analysis
GET    /api/planning/mrp/coverage                 - Get coverage analysis
GET    /api/planning/mrp/coverage/:productId      - Get product coverage details
```

### Service Methods

**Location:** `lib/services/mrp-service.ts`

```typescript
interface MrpService {
  // MRP Run
  initiateRun(params: MrpRunParams): Promise<MrpRun>;
  cancelRun(runId: string): Promise<void>;
  getRunProgress(runId: string): Promise<MrpRunProgress>;
  getRuns(filters: MrpRunFilters): Promise<PaginatedResult<MrpRun>>;
  getRun(runId: string): Promise<MrpRunDetails>;

  // Core MRP Calculation (internal)
  calculateRequirements(run: MrpRun): Promise<void>;
  explodeBom(productId: string, qty: number, level: number): Promise<BomExplosion[]>;
  getOnHandInventory(productId: string, warehouseId?: string): Promise<number>;
  getScheduledReceipts(productId: string, startDate: Date, endDate: Date): Promise<ScheduledReceipt[]>;
  calculateNetRequirement(grossReq: number, onHand: number, scheduled: number, safetyStock: number): number;
  calculateOrderQty(netReq: number, product: Product): number;
  calculateOrderDate(requiredDate: Date, leadTime: number, buffer: number): Date;

  // Suggestion Management
  getSuggestions(filters: SuggestionFilters): Promise<PaginatedResult<MrpSuggestion>>;
  getSuggestion(id: string): Promise<MrpSuggestionDetails>;
  updateSuggestion(id: string, data: SuggestionUpdate): Promise<MrpSuggestion>;
  acceptSuggestion(id: string): Promise<AcceptResult>;
  rejectSuggestion(id: string, reason?: string): Promise<void>;
  bulkAcceptSuggestions(ids: string[]): Promise<BulkAcceptResult>;
  bulkRejectSuggestions(ids: string[], reason?: string): Promise<void>;

  // Coverage Analysis
  getCoverageAnalysis(filters: CoverageFilters): Promise<CoverageResult[]>;
  getProductCoverage(productId: string): Promise<ProductCoverage>;
}

interface MrpRunParams {
  start_date: Date;
  end_date: Date;
  warehouse_id?: string;
  product_ids?: string[];
}

interface MrpRun {
  id: string;
  org_id: string;
  start_date: string;
  end_date: string;
  warehouse_id?: string;
  product_ids?: string[];
  status: 'pending' | 'running' | 'completed' | 'failed';
  started_at?: string;
  completed_at?: string;
  error_message?: string;
  products_processed: number;
  suggestions_generated: number;
  created_at: string;
  created_by: string;
}

interface MrpSuggestion {
  id: string;
  mrp_run_id: string;
  suggestion_type: 'po' | 'wo';
  product_id: string;
  product?: Product;
  supplier_id?: string;
  supplier?: Supplier;
  bom_id?: string;
  net_requirement: number;
  quantity: number;
  required_date: string;
  order_date: string;
  lot_sizing_rule: string;
  is_urgent: boolean;
  has_warning: boolean;
  warning_messages?: string[];
  status: 'suggested' | 'accepted' | 'rejected' | 'superseded';
  created_order_id?: string;
  created_order_type?: string;
}

interface BomExplosion {
  product_id: string;
  bom_level: number;
  parent_product_id?: string;
  quantity: number;
  scrap_percent: number;
  effective_qty: number; // qty * (1 + scrap_percent/100)
}

interface ScheduledReceipt {
  source_type: 'po' | 'wo';
  source_id: string;
  source_number: string;
  product_id: string;
  quantity: number;
  expected_date: string;
}

interface AcceptResult {
  suggestion_id: string;
  created_order_type: 'po' | 'wo';
  created_order_id: string;
  created_order_number: string;
}
```

**Location:** `lib/services/bom-explosion-service.ts`

```typescript
interface BomExplosionService {
  // Multi-level BOM explosion
  explode(productId: string, quantity: number, asOfDate: Date): Promise<BomExplosionResult>;

  // Circular reference detection
  detectCircularReference(productId: string, visited: Set<string>): boolean;

  // Get effective BOM for date
  getEffectiveBom(productId: string, asOfDate: Date): Promise<Bom | null>;
}

interface BomExplosionResult {
  items: BomExplosionItem[];
  levels: number;
  has_circular: boolean;
  circular_path?: string[];
}

interface BomExplosionItem {
  product_id: string;
  product_code: string;
  product_name: string;
  bom_level: number;
  parent_product_id?: string;
  bom_id: string;
  bom_item_id: string;
  base_quantity: number;
  scrap_percent: number;
  effective_quantity: number;
  is_by_product: boolean;
  yield_percent?: number;
  product_type: 'purchased' | 'manufactured';
}
```

### Zod Validation Schemas

**Location:** `lib/validation/mrp.ts`

```typescript
import { z } from 'zod';

// MRP Run initiation
export const mrpRunParamsSchema = z.object({
  start_date: z.string().regex(/^\d{4}-\d{2}-\d{2}$/),
  end_date: z.string().regex(/^\d{4}-\d{2}-\d{2}$/),
  warehouse_id: z.string().uuid().optional(),
  product_ids: z.array(z.string().uuid()).optional(),
}).refine(
  (data) => new Date(data.start_date) <= new Date(data.end_date),
  { message: 'Start date must be before or equal to end date' }
);

// Suggestion update
export const suggestionUpdateSchema = z.object({
  quantity: z.number().positive().optional(),
  required_date: z.string().regex(/^\d{4}-\d{2}-\d{2}$/).optional(),
  order_date: z.string().regex(/^\d{4}-\d{2}-\d{2}$/).optional(),
  supplier_id: z.string().uuid().optional(),
});

// Suggestion reject
export const suggestionRejectSchema = z.object({
  reason: z.string().max(500).optional(),
});

// Bulk operations
export const bulkSuggestionSchema = z.object({
  suggestion_ids: z.array(z.string().uuid()).min(1).max(100),
  reason: z.string().max(500).optional(), // for bulk reject
});

// MRP suggestion response
export const mrpSuggestionSchema = z.object({
  id: z.string().uuid(),
  mrp_run_id: z.string().uuid(),
  suggestion_type: z.enum(['po', 'wo']),
  product_id: z.string().uuid(),
  supplier_id: z.string().uuid().nullable(),
  bom_id: z.string().uuid().nullable(),
  net_requirement: z.number(),
  quantity: z.number(),
  required_date: z.string(),
  order_date: z.string(),
  lot_sizing_rule: z.string(),
  is_urgent: z.boolean(),
  has_warning: z.boolean(),
  warning_messages: z.array(z.string()).nullable(),
  status: z.enum(['suggested', 'accepted', 'rejected', 'superseded']),
  created_order_id: z.string().uuid().nullable(),
  created_order_type: z.string().nullable(),
});

// MRP run response
export const mrpRunSchema = z.object({
  id: z.string().uuid(),
  start_date: z.string(),
  end_date: z.string(),
  warehouse_id: z.string().uuid().nullable(),
  product_ids: z.array(z.string().uuid()).nullable(),
  status: z.enum(['pending', 'running', 'completed', 'failed']),
  started_at: z.string().nullable(),
  completed_at: z.string().nullable(),
  error_message: z.string().nullable(),
  products_processed: z.number(),
  suggestions_generated: z.number(),
  bom_levels_exploded: z.number(),
  created_at: z.string(),
});

// Lot sizing rule enum
export const lotSizingRuleSchema = z.enum(['lfl', 'foq', 'eoq', 'min_max']);

// Coverage analysis
export const coverageAnalysisSchema = z.object({
  product_id: z.string().uuid(),
  product_code: z.string(),
  product_name: z.string(),
  on_hand: z.number(),
  scheduled_receipts: z.number(),
  gross_requirements: z.number(),
  net_requirements: z.number(),
  days_of_stock: z.number(),
  coverage_status: z.enum(['critical', 'low', 'adequate', 'excess']),
});
```

## UI Components

### Pages

- `app/(authenticated)/planning/mrp/page.tsx` - MRP main page with suggestions list
- `app/(authenticated)/planning/mrp/run/page.tsx` - Initiate MRP run
- `app/(authenticated)/planning/mrp/history/page.tsx` - MRP run history
- `app/(authenticated)/planning/mrp/requirements/page.tsx` - Requirements view

### Components

**Location:** `components/planning/mrp/`

```
MrpRunModal.tsx              - Modal to initiate MRP run
MrpRunProgress.tsx           - Progress indicator during run
MrpSuggestionsTable.tsx      - List of suggestions with filters
MrpSuggestionRow.tsx         - Single suggestion row with actions
MrpSuggestionDetail.tsx      - Suggestion detail view
AcceptSuggestionDialog.tsx   - Confirmation for accept
RejectSuggestionDialog.tsx   - Rejection with reason input
ModifySuggestionModal.tsx    - Edit suggestion before accept
BulkActionsBar.tsx           - Bulk accept/reject toolbar
MrpRunHistoryTable.tsx       - List of past MRP runs
MrpRunDetail.tsx             - Run details with stats
RequirementsTimeline.tsx     - Timeline view of requirements
CoverageAnalysisTable.tsx    - Product coverage overview
LotSizingBadge.tsx           - Display lot sizing rule badge
UrgentBadge.tsx              - Urgent order indicator
WarningTooltip.tsx           - Warning messages display
```

### Component Details

**MrpRunModal.tsx**
```tsx
interface MrpRunModalProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  onRunInitiated: (run: MrpRun) => void;
}

// Form fields:
// - Date range picker (start_date, end_date)
// - Warehouse select (optional)
// - Product multi-select (optional)
// - Run button
```

**MrpSuggestionsTable.tsx**
```tsx
interface MrpSuggestionsTableProps {
  suggestions: MrpSuggestion[];
  onAccept: (id: string) => void;
  onReject: (id: string) => void;
  onModify: (suggestion: MrpSuggestion) => void;
  selectedIds: string[];
  onSelectionChange: (ids: string[]) => void;
  isLoading: boolean;
}

// Columns:
// - Checkbox (bulk select)
// - Type (PO/WO badge)
// - Product (code + name)
// - Supplier/BOM
// - Net Requirement
// - Order Qty
// - Required Date
// - Order Date
// - Status
// - Urgent/Warning badges
// - Actions (Accept, Reject, Modify)
```

**RequirementsTimeline.tsx**
```tsx
interface RequirementsTimelineProps {
  productId: string;
  startDate: string;
  endDate: string;
}

// Displays:
// | Period | Gross Req | Sched Rcpt | Proj Avail | Net Req | Planned Order |
// |--------|-----------|------------|------------|---------|---------------|
// | Week 1 | 100       | 50         | 150        | 0       | 0             |
// | Week 2 | 200       | 0          | -50        | 100     | 150           |
```

### UI Patterns

**MRP Suggestions List:**
```
+-----------------------------------------------------------------------------+
| MRP Suggestions                           [Run MRP] [Bulk Accept] [Export]  |
+-----------------------------------------------------------------------------+
| Filters: Type [All v] Status [Suggested v] Product [___] Date Range [___]   |
+-----------------------------------------------------------------------------+
| [ ] | Type | Product        | Supplier    | Qty  | Required | Order | Status|
|-----|------|----------------|-------------|------|----------|-------|-------|
| [x] | PO   | RM-FLOUR-001   | Mill Co.    | 500  | Jan 15   | Jan 8 | !Urg  |
| [x] | WO   | FG-BREAD-001   | BOM-001     | 200  | Jan 20   | Jan 18| Sugg  |
| [ ] | PO   | RM-SUGAR-001   | Sugar Inc.  | 300  | Jan 22   | Jan 12| Sugg  |
+-----------------------------------------------------------------------------+
| Selected: 2                              [Accept Selected] [Reject Selected] |
+-----------------------------------------------------------------------------+
```

**MRP Run Progress:**
```
+------------------------------------------+
| MRP Calculation in Progress              |
|                                          |
| [===================>          ] 65%     |
|                                          |
| Products processed: 650 / 1000           |
| BOM levels exploded: 3                   |
| Suggestions generated: 45                |
|                                          |
| Elapsed: 12s                  [Cancel]   |
+------------------------------------------+
```

## MRP Algorithm Pseudocode

```
FUNCTION runMRP(params):
  run = createMrpRun(params)

  TRY:
    // 1. Get all MPS entries in date range
    mpsEntries = getMpsEntries(params.start_date, params.end_date)

    // 2. Initialize requirements for finished goods
    FOR EACH mps IN mpsEntries:
      addGrossRequirement(mps.product_id, mps.period_date, mps.planned_qty, level=0)

    // 3. Explode BOMs (iterative, level by level)
    currentLevel = 0
    WHILE hasUnexplodedProducts(currentLevel):
      FOR EACH product IN getProductsAtLevel(currentLevel):
        IF product.has_bom:
          bom = getEffectiveBom(product.id, requirement.period_date)
          IF bom IS NULL:
            addWarning(product, "No active BOM found")
            CONTINUE

          FOR EACH item IN bom.items:
            IF item.is_by_product:
              // By-products add to supply
              addScheduledReceipt(item.product_id, period_date, item.quantity * yield)
            ELSE:
              // Components add to demand
              componentQty = item.quantity * (1 + item.scrap_percent/100)
              addGrossRequirement(item.product_id, period_date, componentQty, level+1)

        currentLevel++
        IF currentLevel > MAX_BOM_LEVELS:
          THROW "Max BOM levels exceeded (circular reference?)"

    // 4. Calculate projected available and net requirements
    FOR EACH product IN getAllRequirementProducts():
      onHand = getOnHandInventory(product.id)
      safetyStock = product.safety_stock ?? settings.default_safety_stock

      carryForward = onHand
      FOR EACH period IN getSortedPeriods():
        grossReq = getGrossRequirement(product.id, period)
        schedRcpt = getScheduledReceipts(product.id, period)

        projAvail = carryForward + schedRcpt - grossReq

        IF projAvail < safetyStock:
          netReq = safetyStock - projAvail
          orderQty = calculateOrderQty(netReq, product)
          orderDate = calculateOrderDate(period, product.lead_time, settings.buffer)

          // Create suggestion
          IF product.type == 'purchased':
            createPoSuggestion(product, orderQty, period, orderDate)
          ELSE:
            createWoSuggestion(product, orderQty, period, orderDate)

          // Planned order increases projected available
          projAvail += orderQty

        updateRequirement(product.id, period, projAvail, netReq)
        carryForward = projAvail

    // 5. Consolidate suggestions within consolidation window
    consolidateSuggestions(settings.consolidation_days)

    // 6. Mark run complete
    run.status = 'completed'
    run.completed_at = NOW()

  CATCH error:
    run.status = 'failed'
    run.error_message = error.message

  RETURN run

FUNCTION calculateOrderQty(netReq, product):
  SWITCH product.lot_sizing_rule:
    CASE 'lfl':
      qty = netReq
    CASE 'foq':
      qty = CEILING(netReq / product.fixed_order_qty) * product.fixed_order_qty
    CASE 'eoq':
      eoq = calculateEOQ(product)
      qty = CEILING(netReq / eoq) * eoq
    CASE 'min_max':
      qty = MAX(product.min_stock, product.max_stock - currentAvail)

  // Apply MOQ
  IF qty < product.moq:
    qty = product.moq

  // Apply order multiple
  IF product.order_multiple:
    qty = CEILING(qty / product.order_multiple) * product.order_multiple

  RETURN qty
```

## Test Cases

### Unit Tests

**mrp-service.test.ts**
```typescript
describe('MrpService', () => {
  describe('calculateNetRequirement', () => {
    it('returns 0 when projected available exceeds safety stock');
    it('returns positive net requirement when below safety stock');
    it('includes safety stock in net requirement calculation');
    it('handles zero safety stock correctly');
  });

  describe('explodeBom', () => {
    it('explodes single-level BOM correctly');
    it('explodes multi-level BOM with correct quantities');
    it('applies scrap percentage to quantities');
    it('handles by-products as supply additions');
    it('detects circular BOM references');
    it('selects effective BOM for given date');
    it('throws error when no active BOM found');
  });

  describe('calculateOrderQty', () => {
    it('returns net requirement for LFL');
    it('rounds up to fixed quantity for FOQ');
    it('calculates EOQ correctly');
    it('orders up to max for min-max');
    it('applies MOQ when calculated qty is lower');
    it('rounds to order multiple');
  });

  describe('calculateOrderDate', () => {
    it('subtracts lead time from required date');
    it('adds buffer days');
    it('returns today if calculated date is in past');
    it('sets urgent flag for past dates');
  });

  describe('getOnHandInventory', () => {
    it('sums available LP quantities');
    it('excludes reserved and consumed LPs');
    it('filters by warehouse when specified');
    it('aggregates all warehouses when not specified');
  });

  describe('getScheduledReceipts', () => {
    it('includes open PO quantities');
    it('includes open WO outputs');
    it('excludes cancelled orders');
    it('calculates remaining qty for partial receipts');
  });
});
```

**bom-explosion-service.test.ts**
```typescript
describe('BomExplosionService', () => {
  describe('explode', () => {
    it('returns empty for product without BOM');
    it('explodes single level correctly');
    it('explodes 3 levels correctly');
    it('calculates effective quantity with scrap');
    it('identifies by-products correctly');
    it('detects circular reference A->B->A');
    it('handles same component at multiple levels');
  });

  describe('getEffectiveBom', () => {
    it('returns BOM with effective_from before date');
    it('returns most recent when multiple match');
    it('returns null when no active BOM');
    it('excludes BOMs with effective_to before date');
  });
});
```

### Integration Tests

**mrp-api.test.ts**
```typescript
describe('MRP API', () => {
  describe('POST /api/planning/mrp/run', () => {
    it('creates MRP run with valid parameters');
    it('validates date range');
    it('returns 400 for invalid date format');
    it('filters by warehouse when specified');
    it('filters by products when specified');
    it('enforces org isolation');
  });

  describe('GET /api/planning/mrp/suggestions', () => {
    it('returns suggestions for current org');
    it('filters by suggestion type');
    it('filters by status');
    it('filters by date range');
    it('includes product and supplier details');
    it('returns 404 for other org suggestions');
  });

  describe('POST /api/planning/mrp/suggestions/:id/accept', () => {
    it('creates draft PO for PO suggestion');
    it('creates draft WO for WO suggestion');
    it('updates suggestion status to accepted');
    it('stores created order reference');
    it('returns 400 for already accepted suggestion');
    it('returns 404 for other org suggestion');
  });

  describe('POST /api/planning/mrp/suggestions/:id/reject', () => {
    it('updates status to rejected');
    it('stores rejection reason');
    it('returns 400 for already processed suggestion');
  });

  describe('POST /api/planning/mrp/suggestions/bulk-accept', () => {
    it('accepts multiple suggestions');
    it('creates orders for each');
    it('returns partial success if some fail');
    it('limits batch size to 100');
  });
});
```

### E2E Tests

**mrp-workflow.spec.ts**
```typescript
describe('MRP Workflow', () => {
  it('runs MRP calculation and displays progress');
  it('shows suggestions list after completion');
  it('filters suggestions by type');
  it('accepts suggestion and creates PO');
  it('accepts suggestion and creates WO');
  it('rejects suggestion with reason');
  it('bulk accepts multiple suggestions');
  it('modifies suggestion before accepting');
  it('shows urgent badge for past order dates');
  it('shows warning for missing supplier');
});
```

**mrp-requirements.spec.ts**
```typescript
describe('MRP Requirements', () => {
  it('displays requirements timeline for product');
  it('shows gross requirements from MPS');
  it('shows scheduled receipts from open orders');
  it('shows calculated net requirements');
  it('shows planned orders for net requirements');
});
```

## Error Handling

| Error | Response | User Message |
|-------|----------|--------------|
| No MPS entries in range | 400 | "No production schedule entries found for the selected date range" |
| Circular BOM detected | 400 | "Circular BOM reference detected: {path}" |
| Max BOM levels exceeded | 400 | "BOM explosion exceeded maximum levels (10)" |
| No active BOM for product | Warning | "Product {code} has no active BOM for {date}" |
| No default supplier | Warning | "Product {code} has no default supplier assigned" |
| MRP already running | 409 | "An MRP calculation is already in progress" |
| Suggestion already processed | 400 | "Suggestion has already been {accepted/rejected}" |

## Performance Considerations

1. **Batch Processing**
   - Process products in batches of 100
   - Use database transactions for consistency
   - Update progress every 10 products

2. **Query Optimization**
   - Index on mrp_requirements(mrp_run_id, product_id)
   - Index on license_plates(product_id, status)
   - Preload BOM data to avoid N+1 queries

3. **BOM Explosion Caching**
   - Cache exploded BOMs during single run
   - Reuse explosion for same product/date

4. **Async Processing**
   - Run MRP calculation in background job
   - Use Server-Sent Events for progress updates
   - Support cancellation mid-run

## Deliverables

- [ ] `mrp_runs` table migration
- [ ] `mrp_suggestions` table migration
- [ ] `mrp_requirements` table migration
- [ ] Products table MRP fields extension
- [ ] Planning settings MRP fields extension
- [ ] RLS policies for MRP tables
- [ ] MRP service (`lib/services/mrp-service.ts`)
- [ ] BOM explosion service (`lib/services/bom-explosion-service.ts`)
- [ ] Zod schemas (`lib/validation/mrp.ts`)
- [ ] API routes for MRP run
- [ ] API routes for suggestions
- [ ] API routes for requirements
- [ ] MrpRunModal component
- [ ] MrpRunProgress component
- [ ] MrpSuggestionsTable component
- [ ] AcceptSuggestionDialog component
- [ ] RejectSuggestionDialog component
- [ ] ModifySuggestionModal component
- [ ] RequirementsTimeline component
- [ ] MRP main page
- [ ] MRP run history page
- [ ] Unit tests (>80% coverage)
- [ ] Integration tests
- [ ] E2E tests
- [ ] Performance validation (<30s for 1000 products)

## Definition of Done

- [ ] MRP calculation correctly calculates gross requirements from MPS
- [ ] Multi-level BOM explosion works correctly (tested with 3+ levels)
- [ ] Circular BOM references detected and reported
- [ ] On-hand inventory correctly queried from license_plates
- [ ] Scheduled receipts include open POs and WOs
- [ ] Net requirements consider safety stock
- [ ] Lead time offsetting calculates correct order dates
- [ ] All lot sizing rules implemented (LFL, FOQ, EOQ, Min-Max)
- [ ] MOQ and order multiple applied correctly
- [ ] PO suggestions generated with default supplier
- [ ] WO suggestions generated with BOM reference
- [ ] Accept suggestion creates draft PO/WO
- [ ] Reject suggestion updates status with reason
- [ ] Bulk accept/reject works for multiple suggestions
- [ ] MRP run progress displayed during calculation
- [ ] MRP run history accessible
- [ ] Requirements timeline displays correctly
- [ ] Urgent badge shown for past order dates
- [ ] Warning shown for products without supplier
- [ ] Cross-tenant access returns 404
- [ ] Performance: <30s for 1000 products
- [ ] Unit test coverage >= 80%
- [ ] Integration tests pass
- [ ] E2E tests pass

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2026-01-14 | Initial story creation | ARCHITECT-AGENT |
