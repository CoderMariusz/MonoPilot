# 03.23 - Replenishment Rules & Auto PO Generation

**Story ID:** 03.23
**Epic:** 03 - Planning
**Phase:** 2 (MRP/Forecasting)
**Complexity:** L (Large)
**Estimate:** 5-7 days
**Type:** Full-stack
**State:** ready

**Primary PRD:** `docs/1-BASELINE/product/modules/PLANNING.md` (FR-PLAN-038, FR-PLAN-039, FR-PLAN-040)
**Depends On:** 03.3 (PO CRUD), 03.19 (Demand Forecasting - recommended)

## PRD References

| FR ID | Requirement | Priority | Phase | Covered |
|-------|-------------|----------|-------|---------|
| FR-PLAN-038 | Replenishment Rules | Should Have | 2 | Yes |
| FR-PLAN-039 | Auto PO Generation | Should Have | 2 | Yes |
| FR-PLAN-040 | Replenishment Dashboard | Could Have | 2 | Yes |

## User Story

**As a** planner,
**I want** to define automatic replenishment rules per product,
**So that** the system can proactively create purchase orders when inventory falls below defined thresholds.

**As a** purchaser,
**I want** to review and approve auto-generated POs before they are sent to suppliers,
**So that** I maintain control over procurement while benefiting from automation.

**As an** operations manager,
**I want** to monitor replenishment activity on a dashboard,
**So that** I can track what triggered auto-orders and identify optimization opportunities.

## Goal

Implement automatic inventory replenishment by allowing users to define rules per product/warehouse. When inventory drops below reorder points, the system automatically creates draft POs for approval. A dedicated dashboard provides visibility into active rules, auto-generated POs, and products approaching reorder points.

## Scope

**In scope:**
- Replenishment rule CRUD (create, read, update, delete)
- Rule types: Min/Max, Reorder Point (ROP), Time-based
- Reorder methods: Fixed Qty, Economic Order Qty (EOQ), Days Supply, Up to Max
- Per-product or per-product/warehouse rules
- Preferred supplier assignment per rule
- Auto PO generation when conditions met
- Duplicate PO prevention (no open PO for same product)
- Draft PO creation with approval workflow integration
- Notification to purchasers when auto-PO created
- Replenishment dashboard with rule status
- Activity log showing triggers and outcomes
- Integration with supplier lead times
- Rule activation/deactivation

**Out of scope:**
- Auto-WO generation (separate story)
- MRP-driven suggestions (see 03.21)
- Blanket PO releases
- EDI auto-submission
- Supplier VMI (Vendor Managed Inventory)

## Dependencies

| Story | Requirement | Status |
|-------|-------------|--------|
| 03.3 | PO CRUD | Required - auto-PO generation target |
| 03.1 | Suppliers CRUD | Required - supplier assignment |
| 03.2 | Supplier-Product Assignment | Required - pricing defaults |
| 03.17 | Planning Settings | Required - auto_po_enabled flag |
| 03.19 | Demand Forecasting | Recommended - ROP/ADD calculations |
| 01.8 | Warehouses CRUD | Required - warehouse-specific rules |

## Acceptance Criteria (Given/When/Then)

### Replenishment Rules (FR-PLAN-038)

#### Rule Creation
- GIVEN user navigates to replenishment rules, WHEN "New Rule" clicked, THEN rule creation form displays.
- GIVEN form displayed, WHEN user selects product, THEN available suppliers for that product shown.
- GIVEN product selected, WHEN no default supplier assigned, THEN warning "No default supplier. Select one." displays.
- GIVEN rule created, WHEN saved, THEN rule immediately active (or inactive if toggled off).

#### Rule Configuration
- GIVEN rule creation form, WHEN displayed, THEN fields include: product, warehouse (optional), supplier, reorder point, reorder qty, method, days supply, max stock, is_active.
- GIVEN method "Fixed Quantity" selected, WHEN rule triggers, THEN reorder_qty used directly.
- GIVEN method "Days Supply" selected, WHEN rule triggers, THEN qty = avg_daily_demand * days_supply.
- GIVEN method "Economic Order Qty" selected, WHEN rule triggers, THEN qty = sqrt(2 * annual_demand * order_cost / holding_cost).
- GIVEN method "Up to Max" selected, WHEN rule triggers, THEN qty = max_stock - current_stock.

#### Rule per Warehouse
- GIVEN user creates rule with warehouse = null, WHEN conditions evaluated, THEN all warehouse inventory aggregated.
- GIVEN user creates rule for specific warehouse, WHEN conditions evaluated, THEN only that warehouse inventory checked.
- GIVEN product has rules for 2 warehouses, WHEN one triggers, THEN separate PO created for that warehouse.

#### Rule Management
- GIVEN rule exists, WHEN user edits rule, THEN all fields editable except product (create new rule instead).
- GIVEN rule is_active = true, WHEN user toggles off, THEN rule ignored during inventory checks.
- GIVEN rule deleted, WHEN removed, THEN audit log entry created and rule no longer triggers.
- GIVEN rule list, WHEN displayed, THEN shows: product, warehouse, supplier, reorder point, method, last triggered, status.

#### Last Triggered Tracking
- GIVEN rule triggers auto-PO, WHEN PO created, THEN rule.last_triggered updated to current timestamp.
- GIVEN rule list view, WHEN last_triggered displayed, THEN shows relative time ("2 hours ago", "Yesterday").

### Auto PO Generation (FR-PLAN-039)

#### Inventory Monitoring
- GIVEN auto_po_enabled = true in planning settings, WHEN inventory check runs, THEN system evaluates all active rules.
- GIVEN inventory check can run on: scheduled job (hourly), on inventory change, on-demand via dashboard.
- GIVEN rule for product A with reorder_point = 1000, current inventory = 950, WHEN check runs, THEN rule triggers.
- GIVEN rule for product A with reorder_point = 1000, current inventory = 1050, WHEN check runs, THEN no action taken.

#### Draft PO Creation
- GIVEN rule triggers, WHEN no open PO exists for product, THEN draft PO created automatically.
- GIVEN auto-PO created, WHEN PO fields populated, THEN:
  - supplier_id from rule.supplier_id
  - warehouse_id from rule.warehouse_id (or default)
  - expected_delivery_date = today + supplier.lead_time_days + buffer
  - currency, tax_code, payment_terms from supplier defaults
  - notes = "Auto-generated from replenishment rule [RULE-ID]"
  - PO line with calculated quantity

#### Duplicate Prevention
- GIVEN rule triggers for product A, WHEN open PO exists (status = draft, submitted, pending_approval, confirmed), THEN skip auto-PO creation.
- GIVEN duplicate detected, WHEN skipped, THEN activity log records "Skipped: Open PO exists [PO-NUMBER]".
- GIVEN PO for product A is closed/cancelled, WHEN rule triggers again, THEN new PO can be created.

#### Quantity Calculation
- GIVEN method = "fixed_qty", WHEN auto-PO created, THEN qty = rule.reorder_qty.
- GIVEN method = "days_supply", WHEN auto-PO created, THEN qty = product.avg_daily_demand * rule.days_supply.
- GIVEN method = "up_to_max", WHEN auto-PO created, THEN qty = rule.max_stock - current_inventory.
- GIVEN method = "economic_qty", WHEN auto-PO created, THEN qty calculated via EOQ formula (or fallback to reorder_qty if params missing).

#### Notification
- GIVEN auto-PO created, WHEN purchaser notification enabled, THEN in-app notification sent to users with PURCHASER role.
- GIVEN email notifications enabled, WHEN auto-PO created, THEN email sent with PO details.
- GIVEN multiple auto-POs created in single run, WHEN notifications sent, THEN grouped into single notification.

#### Approval Integration
- GIVEN organization has PO approval enabled, WHEN auto-PO created, THEN PO status = "draft" (requires manual submit).
- GIVEN organization has auto-submit enabled, WHEN auto-PO created, THEN PO auto-submitted to approval workflow.
- GIVEN auto-PO submitted, WHEN approval required, THEN status = "pending_approval".
- GIVEN approval not required (threshold not met), WHEN auto-PO submitted, THEN status = "confirmed".

### Replenishment Dashboard (FR-PLAN-040)

#### Dashboard Overview
- GIVEN user navigates to /planning/replenishment, WHEN dashboard loads, THEN shows summary cards.
- GIVEN summary cards, WHEN displayed, THEN show: Active Rules count, Products Below ROP count, Auto-POs This Week count, Rules Triggered Today count.

#### Active Rules Section
- GIVEN dashboard, WHEN "Active Rules" tab clicked, THEN DataTable shows all active replenishment rules.
- GIVEN rules table, WHEN displayed, THEN columns: Product, Warehouse, Supplier, Reorder Point, Method, Last Triggered, Status, Actions.
- GIVEN rules table, WHEN filtered, THEN can filter by: product, warehouse, supplier, method, status.
- GIVEN rule in table, WHEN "Trigger Now" clicked, THEN manual rule evaluation runs immediately.

#### Products at ROP Section
- GIVEN dashboard, WHEN "At Reorder Point" tab clicked, THEN products at/below ROP shown.
- GIVEN products list, WHEN displayed, THEN columns: Product, Current Stock, Reorder Point, Below By, Rule Status, Open PO, Actions.
- GIVEN product has no rule, WHEN displayed, THEN "No Rule" badge shown with "Create Rule" action.
- GIVEN product has open PO, WHEN displayed, THEN "PO [NUMBER]" link shown.
- GIVEN product has no open PO, WHEN "Create PO" clicked, THEN PO creation modal opens with pre-filled data.

#### Auto-Generated POs Section
- GIVEN dashboard, WHEN "Auto-Generated POs" tab clicked, THEN shows POs created by replenishment rules.
- GIVEN auto-POs list, WHEN displayed, THEN columns: PO Number, Created Date, Supplier, Products, Total, Status, Actions.
- GIVEN auto-PO filter, WHEN "Last 7 Days" selected, THEN only recent auto-POs shown.
- GIVEN auto-PO in list, WHEN clicked, THEN navigates to PO detail page.

#### Activity Log
- GIVEN dashboard, WHEN "Activity Log" tab clicked, THEN chronological event log shown.
- GIVEN activity log, WHEN displayed, THEN shows: Timestamp, Event Type, Product, Rule, Outcome, Details.
- GIVEN event types, WHEN logged, THEN include: Rule Triggered, PO Created, Skipped (Open PO), Skipped (Above ROP), Error.
- GIVEN activity log, WHEN filtered, THEN can filter by: date range, event type, product.

#### Rule Performance Metrics
- GIVEN rule details view, WHEN displayed, THEN shows performance metrics.
- GIVEN metrics, WHEN calculated, THEN include:
  - Times triggered (last 30 days)
  - POs generated (last 30 days)
  - Average days between triggers
  - Fill rate (% of time above ROP)
- GIVEN low fill rate (<80%), WHEN displayed, THEN warning "Consider adjusting reorder point" shown.

### Multi-tenancy
- GIVEN User A from Org A, WHEN accessing rules, THEN only Org A rules visible.
- GIVEN User A from Org A, WHEN accessing Org B rule, THEN 404 Not Found returned.
- GIVEN activity log, WHEN queried, THEN only current org events shown.

### Permission Enforcement
- GIVEN user with PLANNER or PURCHASER role, WHEN accessing replenishment, THEN full CRUD access granted.
- GIVEN user with VIEWER role, WHEN accessing replenishment, THEN read-only access (view rules, dashboard).
- GIVEN user without planning permissions, WHEN accessing /planning/replenishment, THEN 403 Forbidden.

## Technical Specification

### Database Schema

#### replenishment_rules table (from PRD)

```sql
CREATE TABLE replenishment_rules (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  product_id UUID NOT NULL REFERENCES products(id) ON DELETE CASCADE,
  warehouse_id UUID REFERENCES warehouses(id) ON DELETE SET NULL,
  supplier_id UUID REFERENCES suppliers(id) ON DELETE SET NULL,

  -- Trigger conditions
  reorder_point NUMERIC(15,4) NOT NULL,
  reorder_method TEXT NOT NULL DEFAULT 'fixed_qty', -- fixed_qty, days_supply, economic_qty, up_to_max

  -- Method parameters
  reorder_qty NUMERIC(15,4), -- For fixed_qty method
  days_supply INTEGER, -- For days_supply method
  max_stock NUMERIC(15,4), -- For up_to_max method
  eoq_order_cost NUMERIC(15,4), -- For economic_qty (optional)
  eoq_holding_cost NUMERIC(15,4), -- For economic_qty (optional)

  -- Status
  is_active BOOLEAN DEFAULT true,
  last_triggered TIMESTAMPTZ,
  last_checked TIMESTAMPTZ,
  trigger_count INTEGER DEFAULT 0,

  -- Audit
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  created_by UUID REFERENCES users(id),
  updated_by UUID REFERENCES users(id),

  -- Constraints
  CONSTRAINT repl_reorder_point_positive CHECK (reorder_point > 0),
  CONSTRAINT repl_reorder_qty_positive CHECK (reorder_qty IS NULL OR reorder_qty > 0),
  CONSTRAINT repl_days_supply_positive CHECK (days_supply IS NULL OR days_supply > 0),
  CONSTRAINT repl_max_stock_positive CHECK (max_stock IS NULL OR max_stock > 0),
  CONSTRAINT repl_method_check CHECK (reorder_method IN ('fixed_qty', 'days_supply', 'economic_qty', 'up_to_max')),
  CONSTRAINT repl_unique_product_warehouse UNIQUE (org_id, product_id, warehouse_id)
);

-- Indexes
CREATE INDEX idx_repl_rules_org_active ON replenishment_rules(org_id, is_active);
CREATE INDEX idx_repl_rules_product ON replenishment_rules(product_id);
CREATE INDEX idx_repl_rules_supplier ON replenishment_rules(supplier_id);
CREATE INDEX idx_repl_rules_warehouse ON replenishment_rules(warehouse_id);
```

#### replenishment_activity_log table (new)

```sql
CREATE TABLE replenishment_activity_log (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  rule_id UUID REFERENCES replenishment_rules(id) ON DELETE SET NULL,
  product_id UUID NOT NULL REFERENCES products(id) ON DELETE CASCADE,

  -- Event details
  event_type TEXT NOT NULL, -- 'rule_triggered', 'po_created', 'skipped_open_po', 'skipped_above_rop', 'error'
  event_timestamp TIMESTAMPTZ DEFAULT NOW(),

  -- Context
  current_inventory NUMERIC(15,4),
  reorder_point NUMERIC(15,4),
  calculated_qty NUMERIC(15,4),

  -- Outcome
  created_po_id UUID REFERENCES purchase_orders(id) ON DELETE SET NULL,
  skip_reason TEXT, -- For skipped events
  error_message TEXT, -- For error events

  -- Details
  details JSONB, -- Additional context (method params, etc.)

  created_at TIMESTAMPTZ DEFAULT NOW(),

  CONSTRAINT repl_log_event_type_check CHECK (event_type IN (
    'rule_triggered', 'po_created', 'skipped_open_po', 'skipped_above_rop', 'error', 'manual_trigger'
  ))
);

-- Indexes
CREATE INDEX idx_repl_log_org_timestamp ON replenishment_activity_log(org_id, event_timestamp DESC);
CREATE INDEX idx_repl_log_rule ON replenishment_activity_log(rule_id);
CREATE INDEX idx_repl_log_product ON replenishment_activity_log(product_id);
CREATE INDEX idx_repl_log_event_type ON replenishment_activity_log(event_type);
CREATE INDEX idx_repl_log_created_po ON replenishment_activity_log(created_po_id);

-- Cleanup: Auto-delete logs older than 90 days
-- (via scheduled function or cron)
```

#### planning_settings extension

```sql
-- Add replenishment settings to planning_settings table
ALTER TABLE planning_settings ADD COLUMN IF NOT EXISTS
  auto_po_enabled BOOLEAN DEFAULT false;

ALTER TABLE planning_settings ADD COLUMN IF NOT EXISTS
  auto_po_lead_time_buffer INTEGER DEFAULT 2; -- Days buffer added to lead time

ALTER TABLE planning_settings ADD COLUMN IF NOT EXISTS
  auto_po_auto_submit BOOLEAN DEFAULT false; -- Auto-submit to approval

ALTER TABLE planning_settings ADD COLUMN IF NOT EXISTS
  replenishment_check_interval TEXT DEFAULT 'hourly'; -- hourly, on_change, manual

ALTER TABLE planning_settings ADD COLUMN IF NOT EXISTS
  replenishment_notification_email BOOLEAN DEFAULT true;

ALTER TABLE planning_settings ADD COLUMN IF NOT EXISTS
  replenishment_notification_digest BOOLEAN DEFAULT false; -- Group notifications
```

### RLS Policies

```sql
-- Enable RLS
ALTER TABLE replenishment_rules ENABLE ROW LEVEL SECURITY;
ALTER TABLE replenishment_activity_log ENABLE ROW LEVEL SECURITY;

-- Replenishment Rules: Org isolation
CREATE POLICY "repl_rules_select" ON replenishment_rules
FOR SELECT TO authenticated
USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

CREATE POLICY "repl_rules_insert" ON replenishment_rules
FOR INSERT TO authenticated
WITH CHECK (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  AND (
    (SELECT r.code FROM roles r JOIN users u ON u.role_id = r.id WHERE u.id = auth.uid())
    IN ('SUPER_ADMIN', 'ADMIN', 'PLANNER', 'PURCHASER')
  )
);

CREATE POLICY "repl_rules_update" ON replenishment_rules
FOR UPDATE TO authenticated
USING (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  AND (
    (SELECT r.code FROM roles r JOIN users u ON u.role_id = r.id WHERE u.id = auth.uid())
    IN ('SUPER_ADMIN', 'ADMIN', 'PLANNER', 'PURCHASER')
  )
);

CREATE POLICY "repl_rules_delete" ON replenishment_rules
FOR DELETE TO authenticated
USING (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  AND (
    (SELECT r.code FROM roles r JOIN users u ON u.role_id = r.id WHERE u.id = auth.uid())
    IN ('SUPER_ADMIN', 'ADMIN', 'PLANNER')
  )
);

-- Activity Log: Read-only via org
CREATE POLICY "repl_log_select" ON replenishment_activity_log
FOR SELECT TO authenticated
USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

CREATE POLICY "repl_log_insert" ON replenishment_activity_log
FOR INSERT TO authenticated
WITH CHECK (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));
```

### API Endpoints

```
# Replenishment Rules
GET    /api/v1/planning/replenishment/rules              - List rules (paginated, filtered)
POST   /api/v1/planning/replenishment/rules              - Create rule
GET    /api/v1/planning/replenishment/rules/:id          - Get rule details
PUT    /api/v1/planning/replenishment/rules/:id          - Update rule
DELETE /api/v1/planning/replenishment/rules/:id          - Delete rule
POST   /api/v1/planning/replenishment/rules/:id/toggle   - Toggle active status
POST   /api/v1/planning/replenishment/rules/:id/trigger  - Manual trigger

# Auto PO Generation
POST   /api/v1/planning/replenishment/run                - Run inventory check (all rules)
POST   /api/v1/planning/replenishment/run-product/:id    - Run check for specific product
GET    /api/v1/planning/replenishment/pending            - Get pending auto-PO candidates

# Dashboard
GET    /api/v1/planning/replenishment/dashboard          - Dashboard summary stats
GET    /api/v1/planning/replenishment/products-at-rop    - Products at/below ROP
GET    /api/v1/planning/replenishment/auto-pos           - List auto-generated POs
GET    /api/v1/planning/replenishment/activity-log       - Activity log (paginated)

# Utilities
GET    /api/v1/planning/replenishment/calculate-qty      - Preview qty calculation for rule
```

**Query Parameters (Rules List):**
- `product_id` - Filter by product
- `warehouse_id` - Filter by warehouse
- `supplier_id` - Filter by supplier
- `is_active` - Filter by active status (true/false)
- `method` - Filter by reorder method
- `sort` - Sort field (product_name, reorder_point, last_triggered, created_at)
- `order` - Sort order (asc, desc)
- `page`, `limit` - Pagination

**Query Parameters (Activity Log):**
- `rule_id` - Filter by rule
- `product_id` - Filter by product
- `event_type` - Filter by event type
- `date_from`, `date_to` - Date range
- `page`, `limit` - Pagination

### Service Layer

```typescript
// lib/services/replenishment-service.ts

export interface ReplenishmentService {
  // Rule CRUD
  listRules(params: RuleListParams): Promise<PaginatedResult<ReplenishmentRule>>;
  getRule(id: string): Promise<ReplenishmentRule | null>;
  createRule(data: CreateRuleInput): Promise<ReplenishmentRule>;
  updateRule(id: string, data: UpdateRuleInput): Promise<ReplenishmentRule>;
  deleteRule(id: string): Promise<void>;
  toggleRule(id: string, isActive: boolean): Promise<ReplenishmentRule>;

  // Auto PO Generation
  runInventoryCheck(orgId: string): Promise<ReplenishmentRunResult>;
  runCheckForProduct(productId: string): Promise<ReplenishmentRunResult>;
  manualTriggerRule(ruleId: string): Promise<ReplenishmentRunResult>;

  // Quantity Calculation
  calculateOrderQty(rule: ReplenishmentRule, currentStock: number): number;
  calculateEOQ(annualDemand: number, orderCost: number, holdingCost: number): number;

  // Dashboard
  getDashboardStats(orgId: string): Promise<DashboardStats>;
  getProductsAtROP(orgId: string): Promise<ProductAtROP[]>;
  getAutoGeneratedPOs(params: AutoPOListParams): Promise<PaginatedResult<AutoPO>>;
  getActivityLog(params: ActivityLogParams): Promise<PaginatedResult<ActivityLogEntry>>;

  // Utilities
  hasOpenPO(productId: string, warehouseId?: string): Promise<{ hasOpen: boolean; poNumber?: string }>;
  getSupplierLeadTime(supplierId: string): Promise<number>;
  previewQtyCalculation(ruleId: string): Promise<QtyPreview>;
}

// Types
export type ReorderMethod = 'fixed_qty' | 'days_supply' | 'economic_qty' | 'up_to_max';
export type ActivityEventType = 'rule_triggered' | 'po_created' | 'skipped_open_po' | 'skipped_above_rop' | 'error' | 'manual_trigger';

export interface ReplenishmentRule {
  id: string;
  org_id: string;
  product_id: string;
  warehouse_id: string | null;
  supplier_id: string | null;
  reorder_point: number;
  reorder_method: ReorderMethod;
  reorder_qty: number | null;
  days_supply: number | null;
  max_stock: number | null;
  eoq_order_cost: number | null;
  eoq_holding_cost: number | null;
  is_active: boolean;
  last_triggered: string | null;
  last_checked: string | null;
  trigger_count: number;
  created_at: string;
  updated_at: string;
  // Joined fields
  product?: { code: string; name: string; uom: string };
  warehouse?: { code: string; name: string };
  supplier?: { code: string; name: string; lead_time_days: number };
}

export interface CreateRuleInput {
  product_id: string;
  warehouse_id?: string | null;
  supplier_id?: string | null;
  reorder_point: number;
  reorder_method: ReorderMethod;
  reorder_qty?: number | null;
  days_supply?: number | null;
  max_stock?: number | null;
  eoq_order_cost?: number | null;
  eoq_holding_cost?: number | null;
  is_active?: boolean;
}

export interface UpdateRuleInput extends Partial<Omit<CreateRuleInput, 'product_id'>> {}

export interface ReplenishmentRunResult {
  rules_evaluated: number;
  rules_triggered: number;
  pos_created: number;
  skipped_open_po: number;
  skipped_above_rop: number;
  errors: number;
  created_pos: { po_id: string; po_number: string; product_id: string; qty: number }[];
  log_entries: string[];
}

export interface DashboardStats {
  active_rules: number;
  products_below_rop: number;
  auto_pos_this_week: number;
  rules_triggered_today: number;
}

export interface ProductAtROP {
  product_id: string;
  product_code: string;
  product_name: string;
  current_stock: number;
  reorder_point: number;
  below_by: number;
  has_rule: boolean;
  rule_id: string | null;
  open_po_id: string | null;
  open_po_number: string | null;
}

export interface ActivityLogEntry {
  id: string;
  rule_id: string | null;
  product_id: string;
  event_type: ActivityEventType;
  event_timestamp: string;
  current_inventory: number | null;
  reorder_point: number | null;
  calculated_qty: number | null;
  created_po_id: string | null;
  created_po_number: string | null;
  skip_reason: string | null;
  error_message: string | null;
  details: Record<string, unknown>;
  // Joined
  product?: { code: string; name: string };
}
```

### Validation Schema (Zod)

```typescript
// lib/validation/replenishment.ts
import { z } from 'zod';

export const reorderMethodEnum = z.enum(['fixed_qty', 'days_supply', 'economic_qty', 'up_to_max']);

export const createReplenishmentRuleSchema = z.object({
  product_id: z.string().uuid('Invalid product ID'),
  warehouse_id: z.string().uuid().optional().nullable(),
  supplier_id: z.string().uuid().optional().nullable(),
  reorder_point: z.number()
    .positive('Reorder point must be positive')
    .max(999999999, 'Reorder point too large'),
  reorder_method: reorderMethodEnum,
  reorder_qty: z.number()
    .positive('Reorder quantity must be positive')
    .max(999999999, 'Quantity too large')
    .optional()
    .nullable(),
  days_supply: z.number()
    .int('Days must be an integer')
    .positive('Days supply must be positive')
    .max(365, 'Maximum 365 days')
    .optional()
    .nullable(),
  max_stock: z.number()
    .positive('Max stock must be positive')
    .max(999999999, 'Max stock too large')
    .optional()
    .nullable(),
  eoq_order_cost: z.number()
    .positive('Order cost must be positive')
    .optional()
    .nullable(),
  eoq_holding_cost: z.number()
    .positive('Holding cost must be positive')
    .optional()
    .nullable(),
  is_active: z.boolean().default(true),
}).refine(
  (data) => {
    // Validate method-specific required fields
    if (data.reorder_method === 'fixed_qty' && !data.reorder_qty) {
      return false;
    }
    if (data.reorder_method === 'days_supply' && !data.days_supply) {
      return false;
    }
    if (data.reorder_method === 'up_to_max' && !data.max_stock) {
      return false;
    }
    return true;
  },
  { message: 'Required field missing for selected reorder method' }
);

export const updateReplenishmentRuleSchema = createReplenishmentRuleSchema
  .omit({ product_id: true })
  .partial();

export const activityLogFilterSchema = z.object({
  rule_id: z.string().uuid().optional(),
  product_id: z.string().uuid().optional(),
  event_type: z.enum(['rule_triggered', 'po_created', 'skipped_open_po', 'skipped_above_rop', 'error', 'manual_trigger']).optional(),
  date_from: z.string().datetime().optional(),
  date_to: z.string().datetime().optional(),
  page: z.number().int().positive().default(1),
  limit: z.number().int().positive().max(100).default(20),
});

// Type exports
export type CreateRuleInput = z.infer<typeof createReplenishmentRuleSchema>;
export type UpdateRuleInput = z.infer<typeof updateReplenishmentRuleSchema>;
export type ReorderMethod = z.infer<typeof reorderMethodEnum>;
```

## UI Components

```
app/(authenticated)/planning/replenishment/
  page.tsx                                    -- Dashboard page (main)
  rules/page.tsx                              -- Rules list page
  rules/[id]/page.tsx                         -- Rule detail/edit page
  rules/new/page.tsx                          -- Create new rule page
  activity/page.tsx                           -- Activity log page

components/planning/replenishment/
  ReplenishmentDashboard.tsx                  -- Main dashboard layout
  DashboardStatsCards.tsx                     -- Summary stat cards
  DashboardTabs.tsx                           -- Tab navigation

  -- Rules Management
  RulesDataTable.tsx                          -- Rules list table
  RuleFilters.tsx                             -- Rule filtering controls
  RuleForm.tsx                                -- Create/edit rule form
  RuleMethodSelect.tsx                        -- Method dropdown with help
  RuleStatusBadge.tsx                         -- Active/Inactive badge
  RuleDeleteDialog.tsx                        -- Delete confirmation

  -- Products at ROP
  ProductsAtROPTable.tsx                      -- Products needing attention
  ProductROPCard.tsx                          -- Individual product card
  CreateRuleFromProductDialog.tsx             -- Quick rule creation

  -- Auto POs
  AutoPOsTable.tsx                            -- Auto-generated POs list
  AutoPOBadge.tsx                             -- "Auto-Generated" badge

  -- Activity Log
  ActivityLogTable.tsx                        -- Event log table
  ActivityLogFilters.tsx                      -- Log filtering
  ActivityEventBadge.tsx                      -- Event type badge (color coded)
  ActivityLogDetail.tsx                       -- Expanded log entry

  -- Shared
  RunCheckButton.tsx                          -- Manual check trigger
  TriggerRuleButton.tsx                       -- Manual rule trigger
  NotificationSettingsPanel.tsx               -- Email/notification prefs
```

### Status Badge Colors (TailwindCSS)

| Element | Status | Badge Class |
|---------|--------|-------------|
| Rule | Active | `bg-green-100 text-green-800` |
| Rule | Inactive | `bg-gray-100 text-gray-800` |
| Event | po_created | `bg-blue-100 text-blue-800` |
| Event | rule_triggered | `bg-yellow-100 text-yellow-800` |
| Event | skipped_open_po | `bg-orange-100 text-orange-800` |
| Event | skipped_above_rop | `bg-gray-100 text-gray-800` |
| Event | error | `bg-red-100 text-red-800` |
| Event | manual_trigger | `bg-purple-100 text-purple-800` |

### Dashboard Layout

```
+------------------------------------------------------------------+
| Replenishment Dashboard                          [Run Check Now] |
+------------------------------------------------------------------+
| [Active Rules: 24] [Below ROP: 5] [Auto-POs: 12] [Triggered: 3]  |
+------------------------------------------------------------------+
| [Active Rules] [At Reorder Point] [Auto-Generated POs] [Log]    |
+------------------------------------------------------------------+
| Tab Content Area                                                 |
|                                                                  |
| (DataTable or Cards based on selected tab)                       |
|                                                                  |
+------------------------------------------------------------------+
```

## Test Cases

### Unit Tests

**File:** `__tests__/unit/services/replenishment-service.test.ts`

| Test Case | Description |
|-----------|-------------|
| `calculateOrderQty()` fixed_qty method | Returns reorder_qty directly |
| `calculateOrderQty()` days_supply method | Returns ADD * days_supply |
| `calculateOrderQty()` up_to_max method | Returns max_stock - current |
| `calculateOrderQty()` economic_qty method | Returns EOQ formula result |
| `calculateEOQ()` correct formula | sqrt(2 * D * S / H) |
| `hasOpenPO()` detects draft PO | Returns true with PO number |
| `hasOpenPO()` ignores closed PO | Returns false |
| `runInventoryCheck()` triggers below ROP | Creates draft PO |
| `runInventoryCheck()` skips above ROP | No PO created |
| `runInventoryCheck()` skips open PO | Logs skip reason |
| `manualTriggerRule()` works | Creates PO regardless of ROP |
| `createRule()` validates method params | Rejects missing reorder_qty for fixed_qty |
| `createRule()` unique constraint | Rejects duplicate product/warehouse |

### Integration Tests

**File:** `__tests__/integration/api/planning/replenishment.test.ts`

| Test Case | Description |
|-----------|-------------|
| GET `/replenishment/rules` returns list | Paginated, filtered by org |
| POST `/replenishment/rules` creates rule | All fields persisted |
| POST `/replenishment/rules` validates method | Returns 400 for invalid |
| PUT `/replenishment/rules/:id` updates rule | Partial update works |
| DELETE `/replenishment/rules/:id` deletes | Audit log created |
| POST `/replenishment/rules/:id/toggle` toggles | is_active flips |
| POST `/replenishment/run` evaluates rules | Returns summary |
| POST `/replenishment/run` creates POs | Draft POs created |
| POST `/replenishment/run` prevents duplicates | Skips with open PO |
| GET `/replenishment/dashboard` returns stats | Correct counts |
| GET `/replenishment/activity-log` returns log | Paginated, filtered |
| Cross-org rule access returns 404 | Multi-tenancy |
| VIEWER role gets 403 on create | Permission enforcement |

### E2E Tests

**File:** `__tests__/e2e/planning/replenishment.spec.ts`

| Test Case | Description |
|-----------|-------------|
| Create replenishment rule flow | Form -> save -> listed |
| Edit rule flow | Detail -> edit -> save |
| Toggle rule active/inactive | Click toggle -> status changes |
| Delete rule with confirmation | Click delete -> confirm -> removed |
| Manual trigger rule | Click trigger -> PO created |
| Run inventory check | Click run -> results shown |
| Dashboard shows correct stats | Stats match data |
| Filter rules by product | Filter -> results update |
| Activity log displays events | Events listed with details |
| Create rule from product at ROP | Quick create -> rule active |

## Key Business Rules

1. **Rule Uniqueness**: One rule per product per warehouse (or one global if warehouse = null)
2. **Supplier Required**: If method generates PO, supplier must be assigned to rule or product
3. **Open PO Check**: No auto-PO if draft/submitted/pending/confirmed PO exists for product
4. **Lead Time Buffer**: Expected delivery = today + supplier_lead_time + buffer (from settings)
5. **Method Validation**: Required fields depend on selected method
6. **Activity Retention**: Activity log retained for 90 days (configurable)
7. **Manual Trigger**: Bypasses ROP check - creates PO regardless
8. **Auto-Submit**: If enabled, auto-POs go to approval workflow
9. **Multi-Warehouse**: Separate rules per warehouse, separate PO per warehouse
10. **Demand Data**: Days supply method requires avg_daily_demand from forecasting

## Performance Requirements

| Metric | Target |
|--------|--------|
| Rules list load | < 300ms |
| Dashboard stats load | < 500ms |
| Inventory check (100 rules) | < 5s |
| Activity log query | < 300ms |
| Rule create/update | < 500ms |

## Definition of Done

- [ ] Database migration creates `replenishment_rules` and `replenishment_activity_log` tables
- [ ] Planning settings extended with auto_po config
- [ ] All constraints and indexes created
- [ ] RLS policies enforce org isolation and role permissions
- [ ] All API endpoints implemented (rules CRUD, run check, dashboard, log)
- [ ] Zod schemas validate all inputs with method-specific rules
- [ ] `replenishment-service.ts` implements all methods
- [ ] Quantity calculation for all 4 methods working
- [ ] Open PO duplicate prevention working
- [ ] Auto-PO creation with supplier defaults cascade
- [ ] Activity log records all events
- [ ] Dashboard page with 4 tabs implemented
- [ ] Rules DataTable with filtering and actions
- [ ] Products at ROP view with quick actions
- [ ] Auto-generated POs list with status
- [ ] Activity log with event type badges
- [ ] Manual trigger button working
- [ ] Run Check Now button working
- [ ] Rule toggle (active/inactive) working
- [ ] Permission matrix implemented
- [ ] Multi-tenancy: cross-org returns 404
- [ ] Unit tests >= 80% coverage
- [ ] Integration tests for all endpoints
- [ ] E2E tests for critical flows
- [ ] Loading, empty, error states implemented
- [ ] Toast notifications on success/error
- [ ] Notification to purchasers on auto-PO creation

## Future Enhancements

- **Auto-WO Generation**: Extend to create Work Orders for make-to-stock items
- **Vendor Managed Inventory (VMI)**: Supplier-driven replenishment
- **Blanket PO Integration**: Auto-release from blanket POs
- **Seasonal Adjustments**: Adjust ROP based on seasonal demand patterns
- **Multi-Location Optimization**: Cross-warehouse inventory balancing
- **EDI Integration**: Auto-submit confirmed POs via EDI

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-01-14 | Initial story creation | ARCHITECT-AGENT |
