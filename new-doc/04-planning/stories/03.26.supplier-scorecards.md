# 03.26 - Supplier Scorecards & Performance

**Story ID:** 03.26
**Epic:** 03 - Planning
**Phase:** Phase 3 (Could Have)
**Complexity:** L (Large)
**Estimate:** 5-7 days
**Type:** Backend + Frontend
**State:** ready

**Primary PRD:** `docs/1-BASELINE/product/modules/PLANNING.md` (FR-PLAN-051, FR-PLAN-052)
**Architecture:** `docs/1-BASELINE/architecture/modules/planning.md`
**UX Wireframes:** PLAN-026 (Scorecard Dashboard), PLAN-027 (Supplier Performance), PLAN-028 (Audit List)

## PRD References

| FR ID | Requirement | Priority | Phase | Covered |
|-------|-------------|----------|-------|---------|
| FR-PLAN-051 | Supplier Scorecards | Could Have | Phase 3 | Yes |
| FR-PLAN-052 | Supplier Audits | Could Have | Phase 3 | Yes |

## User Story

**As a** Quality Manager,
**I want** to track supplier performance through automated scorecards and scheduled audits,
**So that** I can identify underperforming suppliers, ensure quality compliance, and make data-driven procurement decisions.

**As a** Purchaser,
**I want** to view supplier ratings and performance trends,
**So that** I can prioritize reliable suppliers when creating purchase orders and negotiate better terms.

## Goal

Implement comprehensive supplier performance management with automatic scorecard calculation from receipt data (PO/GRN), trend analysis, supplier rankings, and audit scheduling. Provide visibility into supplier quality, delivery reliability, and compliance status.

## Scope

**In scope:**
- Supplier scorecard calculation with weighted metrics:
  - Quality Score (30%): % of receipts passing QA inspection
  - Delivery Score (30%): % on-time deliveries
  - Quantity Score (20%): % correct quantities (no over/under delivery)
  - Documentation Score (10%): CoA completeness
  - Price Score (10%): Price competitiveness vs. baseline
- Automatic score updates on GRN completion
- Supplier performance dashboard with rankings
- Trend analysis (monthly/quarterly charts)
- Performance alerts for declining suppliers
- Supplier audit CRUD (initial, periodic, unannounced, incident)
- Audit scheduling with due date tracking
- Audit results with findings and corrective actions
- Integration with supplier approved status (FR-PLAN-050)
- Export scorecard reports to PDF/Excel

**Out of scope:**
- Automated audit scheduling from templates (Phase 4)
- Corrective action workflow with tasks (Phase 4)
- Supplier portal for self-service audit submissions (VMI - Phase 4)
- EDI integration for automatic delivery tracking (Phase 4)
- Predictive supplier risk scoring (Phase 4)

## Dependencies

| Story | Requirement | Status |
|-------|-------------|--------|
| 03.1 | Suppliers CRUD | Required - supplier master data |
| 03.3 | PO CRUD + Lines | Required - delivery date, quantities for scoring |
| 05.10 | GRN CRUD | Required - receipt data for quality metrics |
| 06.x | Quality Inspection | Soft - QA status from inspections |

**Dependents:**
- FR-PLAN-050 (Approved Supplier List) - uses scorecard for approval decisions
- Procurement dashboards - supplier ranking widgets

## Acceptance Criteria (Given/When/Then)

### Scorecard Calculation (FR-PLAN-051)

#### AC-1: Automatic Score Calculation on GRN
- GIVEN GRN completed for supplier "Mill Co." with PO-2024-00001
- WHEN GRN status changes to 'completed'
- THEN system calculates and updates supplier performance metrics:
  - Quality Score: receipts with qa_status='passed' / total receipts
  - Delivery Score: receipts on or before expected_delivery_date / total receipts
  - Quantity Score: receipts where received_qty within tolerance (+-5%) of ordered_qty / total receipts
  - Documentation Score: receipts with CoA attached / total receipts (where CoA required)
  - Price Score: 100 - (avg_actual_price - baseline_price) / baseline_price * 100 (capped 0-100)
- AND overall rating calculated as weighted sum: (30*Q + 30*D + 20*QT + 10*DC + 10*P) / 100
- AND star rating assigned: 5=90-100, 4=80-89, 3=70-79, 2=60-69, 1=<60

#### AC-2: View Supplier Scorecard
- GIVEN I navigate to `/planning/suppliers/{id}/scorecard`
- WHEN page loads
- THEN I see:
  - Overall rating (1-5 stars) with numeric score
  - 5 metric breakdown with individual scores and visual indicators
  - Rolling calculation period (last 12 months by default)
  - Number of deliveries in calculation period
  - Last updated timestamp

#### AC-3: Scorecard Dashboard
- GIVEN I navigate to `/planning/suppliers/scorecards`
- WHEN page loads
- THEN I see:
  - KPI cards: Average Rating, Top Performers (5-star), At Risk (<70), Total Rated
  - Supplier ranking table: Rank, Supplier, Rating, Trend, Deliveries, Last Delivery
  - Trend indicator (up/down/stable vs previous period)
  - Filter by: Rating (1-5 stars), Category, Active status
  - Search by supplier name/code

#### AC-4: Supplier Rankings
- GIVEN scorecard dashboard with 20+ suppliers
- WHEN I sort by "Rating" descending
- THEN suppliers display in order of overall score (highest first)
- AND top 3 suppliers have gold/silver/bronze badges
- AND suppliers with <70 score have red "At Risk" badge

#### AC-5: Performance Trend Analysis
- GIVEN I view supplier "Mill Co." performance
- WHEN I select "Trend Analysis" tab
- THEN I see:
  - Line chart showing monthly overall score (last 12 months)
  - Breakdown chart showing each metric trend
  - Comparison vs. category average line
  - Data table with monthly values

#### AC-6: Period Selection
- GIVEN I am on scorecard view
- WHEN I select period "Last 6 months" or "Last Quarter" or "Custom"
- THEN scorecard recalculates for selected period
- AND all metrics reflect only receipts within that period

#### AC-7: Performance Alerts
- GIVEN supplier "Mill Co." score drops below 70 (threshold)
- WHEN scorecard recalculated
- THEN system creates alert "Supplier Mill Co. score dropped to 68 (At Risk)"
- AND alert visible in supplier dashboard notifications
- AND supplier marked with "At Risk" badge in lists

#### AC-8: Score Not Available
- GIVEN new supplier with 0 deliveries
- WHEN viewing scorecard
- THEN display "No data available" with message "Complete at least one delivery to generate scorecard"
- AND overall rating shows as "-" (not 0)

### Supplier Audits (FR-PLAN-052)

#### AC-9: Create Supplier Audit
- GIVEN I am on supplier detail page for "Mill Co."
- WHEN I click "Schedule Audit"
- THEN modal opens with fields:
  - Audit Type: Initial, Periodic, Unannounced, Incident (required)
  - Audit Date: Date picker (required, can be past for recording completed audits)
  - Auditor: Text field (name of auditor, required)
  - Score: 0-100 numeric (optional, entered after audit)
  - Result: Pass, Conditional Pass, Fail (optional, entered after audit)
  - Findings: Rich text area for observations
  - Corrective Actions: Structured list with item, due date, responsible
  - Next Audit Date: Date picker for scheduling follow-up

#### AC-10: Audit Type Rules
- GIVEN I create an audit
- WHEN audit type is "Initial"
- THEN audit is linked to supplier's first approval evaluation
- AND supplier cannot be marked as "Approved Supplier" until initial audit passes

- GIVEN I create an audit
- WHEN audit type is "Periodic"
- THEN system suggests next audit date based on supplier risk level (annual for 5-star, quarterly for <70)

- GIVEN I create an audit
- WHEN audit type is "Unannounced"
- THEN audit date must be today or past (cannot pre-schedule unannounced)

- GIVEN I create an audit
- WHEN audit type is "Incident"
- THEN audit requires linked incident reference (text description of triggering event)

#### AC-11: View Audit History
- GIVEN supplier "Mill Co." with 3 audits
- WHEN I navigate to supplier detail and click "Audits" tab
- THEN I see table with: Audit Date, Type, Auditor, Score, Result, Findings Summary, Actions
- AND audits sorted by date descending (most recent first)
- AND can expand row to see full findings and corrective actions

#### AC-12: Due Date Tracking
- GIVEN audit scheduled with next_audit_date
- WHEN next_audit_date is within 30 days
- THEN supplier shows "Audit Due Soon" badge (yellow)

- GIVEN audit with next_audit_date in the past
- WHEN viewing supplier list
- THEN supplier shows "Audit Overdue" badge (red)

#### AC-13: Audit List View
- GIVEN I navigate to `/planning/suppliers/audits`
- WHEN page loads
- THEN I see all audits across suppliers with:
  - Filter by: Type, Result, Date range, Supplier
  - Columns: Date, Supplier, Type, Auditor, Score, Result, Next Due
  - KPI cards: Upcoming (30 days), Overdue, Passed, Failed

#### AC-14: Corrective Action Tracking
- GIVEN audit with 2 corrective actions
- WHEN I view audit detail
- THEN I see corrective action list with:
  - Description, Responsible party, Due date, Status (Open, In Progress, Closed)
- AND can update status inline
- AND overdue actions highlighted in red

#### AC-15: Audit Impact on Scorecard
- GIVEN supplier fails audit (Result = Fail)
- WHEN audit saved
- THEN supplier's Documentation Score reduced by 20 points
- AND supplier flagged for review
- AND optional: auto-suspend from Approved Supplier List pending review

### Integration & Reports

#### AC-16: Export Scorecard Report
- GIVEN I am on supplier scorecard page
- WHEN I click "Export Report"
- THEN I can select format: PDF or Excel
- AND PDF includes: supplier info, overall rating, metric breakdown, trend chart, audit history
- AND Excel includes: raw data for all metrics, monthly breakdown, audit records

#### AC-17: Bulk Export Rankings
- GIVEN I am on scorecard dashboard
- WHEN I click "Export Rankings"
- THEN Excel downloads with all suppliers ranked by score
- AND includes columns: Rank, Supplier, Code, Score, Quality, Delivery, Qty, Docs, Price, Trend

#### AC-18: RLS Policy Enforcement
- GIVEN user from Org A views scorecards
- WHEN loading data
- THEN only Org A suppliers and their scores are visible
- AND cannot access Org B supplier data via API

#### AC-19: Multi-tenancy Data Isolation
- GIVEN GRN completed for Org A supplier
- WHEN scorecard calculated
- THEN only Org A GRN data is included in calculation
- AND Org B GRN data is excluded

### Edge Cases

#### AC-20: Minimum Delivery Threshold
- GIVEN supplier has only 2 deliveries
- WHEN viewing scorecard
- THEN display warning "Low data confidence - based on 2 deliveries (minimum 5 recommended)"
- AND score still calculated but marked as preliminary

#### AC-21: Missing Data Handling
- GIVEN GRN without expected_delivery_date on PO
- WHEN calculating delivery score
- THEN receipt excluded from delivery calculation with note "Delivery date unknown"
- AND quality/quantity scores still calculated normally

#### AC-22: Concurrent Audit Updates
- GIVEN two users edit same audit simultaneously
- WHEN second user saves
- THEN optimistic locking prevents overwrite
- AND second user sees "Audit was modified. Please refresh and retry."

## Technical Specification

### Database Schema

#### supplier_scorecards table

```sql
CREATE TABLE supplier_scorecards (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  supplier_id UUID NOT NULL REFERENCES suppliers(id) ON DELETE CASCADE,

  -- Period tracking
  period_start DATE NOT NULL,
  period_end DATE NOT NULL,

  -- Metric scores (0-100)
  quality_score NUMERIC(5,2),
  delivery_score NUMERIC(5,2),
  quantity_score NUMERIC(5,2),
  documentation_score NUMERIC(5,2),
  price_score NUMERIC(5,2),
  overall_score NUMERIC(5,2),

  -- Star rating (1-5)
  star_rating INTEGER CHECK (star_rating >= 1 AND star_rating <= 5),

  -- Delivery stats
  total_deliveries INTEGER DEFAULT 0,
  on_time_deliveries INTEGER DEFAULT 0,
  quality_passed INTEGER DEFAULT 0,
  quantity_correct INTEGER DEFAULT 0,
  docs_complete INTEGER DEFAULT 0,

  -- Trend comparison
  previous_score NUMERIC(5,2),
  trend VARCHAR(10), -- 'up', 'down', 'stable'

  -- Timestamps
  calculated_at TIMESTAMPTZ DEFAULT NOW(),

  -- Unique constraint per supplier per period
  UNIQUE(org_id, supplier_id, period_start, period_end)
);

-- Indexes
CREATE INDEX idx_scorecards_org_supplier ON supplier_scorecards(org_id, supplier_id);
CREATE INDEX idx_scorecards_overall ON supplier_scorecards(org_id, overall_score DESC);
CREATE INDEX idx_scorecards_period ON supplier_scorecards(period_end DESC);
```

#### supplier_performance_history table

```sql
CREATE TABLE supplier_performance_history (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  supplier_id UUID NOT NULL REFERENCES suppliers(id) ON DELETE CASCADE,

  -- Monthly snapshot
  month DATE NOT NULL, -- First day of month

  -- Individual scores
  quality_score NUMERIC(5,2),
  delivery_score NUMERIC(5,2),
  quantity_score NUMERIC(5,2),
  documentation_score NUMERIC(5,2),
  price_score NUMERIC(5,2),
  overall_score NUMERIC(5,2),

  -- Counts
  delivery_count INTEGER DEFAULT 0,

  created_at TIMESTAMPTZ DEFAULT NOW(),

  UNIQUE(org_id, supplier_id, month)
);

CREATE INDEX idx_perf_history_supplier ON supplier_performance_history(org_id, supplier_id, month DESC);
```

#### supplier_audits table (from PRD)

```sql
CREATE TABLE supplier_audits (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  supplier_id UUID NOT NULL REFERENCES suppliers(id) ON DELETE CASCADE,

  -- Audit details
  audit_type VARCHAR(20) NOT NULL CHECK (audit_type IN ('initial', 'periodic', 'unannounced', 'incident')),
  audit_date DATE NOT NULL,
  auditor VARCHAR(255) NOT NULL,

  -- Results
  score NUMERIC(5,2) CHECK (score >= 0 AND score <= 100),
  result VARCHAR(20) CHECK (result IN ('pass', 'conditional_pass', 'fail')),

  -- Findings and actions
  findings JSONB, -- { items: [{ id, description, severity, category }] }
  corrective_actions JSONB, -- { items: [{ id, description, responsible, due_date, status }] }

  -- Scheduling
  next_audit_date DATE,

  -- Incident reference (for incident type)
  incident_reference TEXT,

  -- Timestamps
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  created_by UUID REFERENCES users(id),
  updated_by UUID REFERENCES users(id),

  -- Optimistic locking
  version INTEGER DEFAULT 1
);

-- Indexes
CREATE INDEX idx_audits_org_supplier ON supplier_audits(org_id, supplier_id);
CREATE INDEX idx_audits_next_due ON supplier_audits(org_id, next_audit_date) WHERE next_audit_date IS NOT NULL;
CREATE INDEX idx_audits_type ON supplier_audits(org_id, audit_type);
```

#### suppliers table extension

```sql
-- Add performance fields to existing suppliers table (if not already present)
ALTER TABLE suppliers ADD COLUMN IF NOT EXISTS
  current_score NUMERIC(5,2);

ALTER TABLE suppliers ADD COLUMN IF NOT EXISTS
  current_rating INTEGER CHECK (current_rating >= 1 AND current_rating <= 5);

ALTER TABLE suppliers ADD COLUMN IF NOT EXISTS
  last_score_date TIMESTAMPTZ;

ALTER TABLE suppliers ADD COLUMN IF NOT EXISTS
  score_trend VARCHAR(10);

-- Already exists from PRD:
-- supplier_rating NUMERIC(3,2)
-- last_audit_date DATE
-- next_audit_due DATE
```

### RLS Policies

```sql
-- supplier_scorecards: Org isolation
ALTER TABLE supplier_scorecards ENABLE ROW LEVEL SECURITY;

CREATE POLICY scorecards_org_isolation ON supplier_scorecards
  FOR ALL
  USING (org_id = current_setting('app.current_org_id')::uuid);

-- supplier_performance_history: Org isolation
ALTER TABLE supplier_performance_history ENABLE ROW LEVEL SECURITY;

CREATE POLICY perf_history_org_isolation ON supplier_performance_history
  FOR ALL
  USING (org_id = current_setting('app.current_org_id')::uuid);

-- supplier_audits: Org isolation
ALTER TABLE supplier_audits ENABLE ROW LEVEL SECURITY;

CREATE POLICY audits_org_isolation ON supplier_audits
  FOR ALL
  USING (org_id = current_setting('app.current_org_id')::uuid);
```

### API Endpoints

```
# Scorecard APIs
GET    /api/planning/suppliers/scorecards               - List all supplier scorecards with rankings
GET    /api/planning/suppliers/scorecards/summary       - KPI summary (avg rating, at risk count, etc.)
GET    /api/planning/suppliers/:id/scorecard            - Get supplier scorecard detail
GET    /api/planning/suppliers/:id/scorecard/history    - Get monthly performance history
POST   /api/planning/suppliers/:id/scorecard/calculate  - Force recalculate scorecard
POST   /api/planning/suppliers/scorecards/export        - Export rankings to Excel

# Audit APIs
GET    /api/planning/suppliers/audits                   - List all audits (with filters)
GET    /api/planning/suppliers/audits/summary           - Audit KPIs (upcoming, overdue, etc.)
GET    /api/planning/suppliers/:id/audits               - List audits for supplier
GET    /api/planning/suppliers/audits/:auditId          - Get audit detail
POST   /api/planning/suppliers/:id/audits               - Create audit
PUT    /api/planning/suppliers/audits/:auditId          - Update audit
DELETE /api/planning/suppliers/audits/:auditId          - Delete audit
PUT    /api/planning/suppliers/audits/:auditId/actions/:actionId - Update corrective action status
POST   /api/planning/suppliers/:id/scorecard/export-pdf - Export scorecard to PDF
```

### Service Methods

**Location:** `lib/services/supplier-scorecard-service.ts`

```typescript
interface SupplierScorecardService {
  // Scorecard CRUD
  getScorecard(supplierId: string, period?: DateRange): Promise<SupplierScorecard>;
  getScorecardsRanking(filters: ScorecardFilters): Promise<ScorecardRanking[]>;
  getScorecardSummary(): Promise<ScorecardSummary>;

  // Calculation
  calculateScorecard(supplierId: string, period: DateRange): Promise<SupplierScorecard>;
  recalculateAllScorecards(period: DateRange): Promise<void>;

  // History
  getPerformanceHistory(supplierId: string, months: number): Promise<PerformanceHistory[]>;
  recordMonthlySnapshot(supplierId: string, month: Date): Promise<void>;

  // Alerts
  checkPerformanceAlerts(supplierId: string): Promise<PerformanceAlert[]>;

  // Export
  exportRankingsToExcel(filters: ScorecardFilters): Promise<Blob>;
  exportScorecardToPDF(supplierId: string): Promise<Blob>;
}

interface ScorecardFilters {
  minRating?: number;
  maxRating?: number;
  category?: string;
  isActive?: boolean;
  search?: string;
  sortBy?: 'rating' | 'deliveries' | 'name';
  sortOrder?: 'asc' | 'desc';
}

interface SupplierScorecard {
  supplier_id: string;
  supplier_name: string;
  supplier_code: string;
  period_start: string;
  period_end: string;
  quality_score: number;
  delivery_score: number;
  quantity_score: number;
  documentation_score: number;
  price_score: number;
  overall_score: number;
  star_rating: number;
  total_deliveries: number;
  trend: 'up' | 'down' | 'stable';
  previous_score: number;
  calculated_at: string;
}
```

**Location:** `lib/services/supplier-audit-service.ts`

```typescript
interface SupplierAuditService {
  // CRUD
  createAudit(supplierId: string, data: CreateAuditDto): Promise<SupplierAudit>;
  updateAudit(auditId: string, data: UpdateAuditDto): Promise<SupplierAudit>;
  deleteAudit(auditId: string): Promise<void>;
  getAudit(auditId: string): Promise<SupplierAudit>;

  // Lists
  listAudits(filters: AuditFilters): Promise<PaginatedResult<SupplierAudit>>;
  listSupplierAudits(supplierId: string): Promise<SupplierAudit[]>;
  getAuditSummary(): Promise<AuditSummary>;

  // Due dates
  getUpcomingAudits(days: number): Promise<SupplierAudit[]>;
  getOverdueAudits(): Promise<SupplierAudit[]>;

  // Corrective actions
  updateCorrectiveAction(auditId: string, actionId: string, status: string): Promise<void>;

  // Validation
  validateAuditType(type: string, auditDate: Date): ValidationResult;
}

interface CreateAuditDto {
  audit_type: 'initial' | 'periodic' | 'unannounced' | 'incident';
  audit_date: string;
  auditor: string;
  score?: number;
  result?: 'pass' | 'conditional_pass' | 'fail';
  findings?: Finding[];
  corrective_actions?: CorrectiveAction[];
  next_audit_date?: string;
  incident_reference?: string;
}

interface CorrectiveAction {
  id: string;
  description: string;
  responsible: string;
  due_date: string;
  status: 'open' | 'in_progress' | 'closed';
}
```

### Zod Validation Schemas

**Location:** `lib/validation/supplier-scorecard.ts`

```typescript
import { z } from 'zod';

export const scorecardPeriodSchema = z.object({
  start_date: z.string().datetime().optional(),
  end_date: z.string().datetime().optional(),
  months: z.number().min(1).max(24).optional().default(12),
});

export const scorecardFiltersSchema = z.object({
  min_rating: z.number().min(1).max(5).optional(),
  max_rating: z.number().min(1).max(5).optional(),
  category: z.string().optional(),
  is_active: z.boolean().optional(),
  search: z.string().max(100).optional(),
  sort_by: z.enum(['rating', 'deliveries', 'name']).optional().default('rating'),
  sort_order: z.enum(['asc', 'desc']).optional().default('desc'),
  page: z.number().min(1).optional().default(1),
  limit: z.number().min(1).max(100).optional().default(20),
});
```

**Location:** `lib/validation/supplier-audit.ts`

```typescript
import { z } from 'zod';

const correctiveActionSchema = z.object({
  id: z.string().uuid(),
  description: z.string().min(1).max(500),
  responsible: z.string().min(1).max(100),
  due_date: z.string().regex(/^\d{4}-\d{2}-\d{2}$/),
  status: z.enum(['open', 'in_progress', 'closed']).default('open'),
});

const findingSchema = z.object({
  id: z.string().uuid(),
  description: z.string().min(1).max(1000),
  severity: z.enum(['low', 'medium', 'high', 'critical']),
  category: z.string().max(50).optional(),
});

export const createAuditSchema = z.object({
  audit_type: z.enum(['initial', 'periodic', 'unannounced', 'incident'], {
    required_error: 'Audit type is required',
  }),
  audit_date: z.string().regex(/^\d{4}-\d{2}-\d{2}$/, 'Invalid date format'),
  auditor: z.string().min(1, 'Auditor name is required').max(255),
  score: z.number().min(0).max(100).optional(),
  result: z.enum(['pass', 'conditional_pass', 'fail']).optional(),
  findings: z.array(findingSchema).optional(),
  corrective_actions: z.array(correctiveActionSchema).optional(),
  next_audit_date: z.string().regex(/^\d{4}-\d{2}-\d{2}$/).optional(),
  incident_reference: z.string().max(500).optional(),
}).refine(
  (data) => {
    // Unannounced audits cannot be in the future
    if (data.audit_type === 'unannounced') {
      const auditDate = new Date(data.audit_date);
      return auditDate <= new Date();
    }
    return true;
  },
  { message: 'Unannounced audits cannot be scheduled in advance', path: ['audit_date'] }
).refine(
  (data) => {
    // Incident audits require incident_reference
    if (data.audit_type === 'incident' && !data.incident_reference) {
      return false;
    }
    return true;
  },
  { message: 'Incident reference is required for incident audits', path: ['incident_reference'] }
);

export const updateAuditSchema = createAuditSchema.partial();

export const updateCorrectiveActionSchema = z.object({
  status: z.enum(['open', 'in_progress', 'closed']),
});

export const auditFiltersSchema = z.object({
  audit_type: z.enum(['initial', 'periodic', 'unannounced', 'incident']).optional(),
  result: z.enum(['pass', 'conditional_pass', 'fail']).optional(),
  supplier_id: z.string().uuid().optional(),
  date_from: z.string().regex(/^\d{4}-\d{2}-\d{2}$/).optional(),
  date_to: z.string().regex(/^\d{4}-\d{2}-\d{2}$/).optional(),
  overdue_only: z.boolean().optional(),
  page: z.number().min(1).optional().default(1),
  limit: z.number().min(1).max(100).optional().default(20),
});
```

## UI Components

### Pages

- `app/(authenticated)/planning/suppliers/scorecards/page.tsx` - Scorecard dashboard with rankings
- `app/(authenticated)/planning/suppliers/[id]/scorecard/page.tsx` - Individual supplier scorecard detail
- `app/(authenticated)/planning/suppliers/audits/page.tsx` - All audits list
- `app/(authenticated)/planning/suppliers/[id]/audits/page.tsx` - Supplier audit history (tab)

### Components

**Location:** `components/planning/suppliers/scorecard/`

```
ScorecardDashboard.tsx        - Main dashboard with rankings table and KPIs
ScorecardKPIs.tsx             - KPI cards (avg rating, at risk, top performers)
ScorecardRankingTable.tsx     - Ranked supplier list with scores
ScorecardDetail.tsx           - Individual scorecard view with metrics
MetricBreakdown.tsx           - Visual breakdown of 5 metrics
StarRating.tsx                - 1-5 star display component
TrendIndicator.tsx            - Up/down/stable arrow indicator
PerformanceTrendChart.tsx     - Line chart for historical trends
ScorecardExportButton.tsx     - Export to PDF/Excel buttons
PeriodSelector.tsx            - Date range selection for calculations
```

**Location:** `components/planning/suppliers/audit/`

```
AuditListTable.tsx            - Audits list with filters
AuditKPIs.tsx                 - KPI cards (upcoming, overdue, passed, failed)
AuditCreateModal.tsx          - Create/edit audit form
AuditDetailModal.tsx          - View audit detail with findings
AuditTypeSelect.tsx           - Audit type dropdown with rules
FindingsEditor.tsx            - JSONB findings editor
CorrectiveActionsEditor.tsx   - Corrective actions list editor
CorrectiveActionStatus.tsx    - Status badge with update option
AuditDueBadge.tsx             - Due/Overdue badge component
AuditTimeline.tsx             - Timeline view of supplier audits
```

### UI Patterns

**Scorecard Dashboard Layout:**
```
+--------------------------------------------------+
| Supplier Scorecards                    [Export]   |
+--------------------------------------------------+
| [Avg Rating]  [Top (5*)]  [At Risk]  [Total]      |
|    3.8           12          4          45        |
+--------------------------------------------------+
| Search: [____________]  Rating: [All v]  Active   |
+--------------------------------------------------+
| Rank | Supplier     | Rating | Trend | Deliveries |
|------|--------------|--------|-------|------------|
| 1.   | Mill Co.     | ★★★★★  |  ↑    |    45      |
| 2.   | ACME Foods   | ★★★★☆  |  →    |    32      |
| 3.   | Baker Supply | ★★★★☆  |  ↓    |    28      |
| ...  | ...          | ...    | ...   |   ...      |
+--------------------------------------------------+
```

**Supplier Scorecard Detail:**
```
+--------------------------------------------------+
| Mill Co. - Scorecard                    [Export]  |
+--------------------------------------------------+
| Overall: ★★★★★ 92/100  |  Trend: ↑ +3 from last  |
|                         |  Based on 45 deliveries |
+--------------------------------------------------+
| Quality (30%)    |████████████████    | 95        |
| Delivery (30%)   |███████████████     | 90        |
| Quantity (20%)   |████████████████    | 94        |
| Documentation    |███████████████     | 88        |
| Price (10%)      |████████████████    | 92        |
+--------------------------------------------------+
| [Trend Chart - 12 month line graph]               |
+--------------------------------------------------+
| Period: [Last 12 months v]  Calculated: 2024-01-15|
+--------------------------------------------------+
```

**Audit Form:**
```
+--------------------------------------------------+
| Schedule Audit - Mill Co.                    [X]  |
+--------------------------------------------------+
| Audit Type*:  [Periodic        v]                 |
| Audit Date*:  [2024-02-15      ]                  |
| Auditor*:     [John Smith      ]                  |
+--------------------------------------------------+
| Score:        [85              ] /100             |
| Result:       [Pass            v]                 |
+--------------------------------------------------+
| Findings:                                         |
| [+ Add Finding]                                   |
| - Minor labeling issue (Low)                      |
| - Temperature log incomplete (Medium)             |
+--------------------------------------------------+
| Corrective Actions:                               |
| [+ Add Action]                                    |
| - Update labeling procedure | Due: 2024-03-01    |
|   Responsible: Quality Team | Status: [Open v]   |
+--------------------------------------------------+
| Next Audit Date: [2025-02-15   ]                  |
+--------------------------------------------------+
|                        [Cancel]  [Save Audit]     |
+--------------------------------------------------+
```

## Test Cases

### Unit Tests

**supplier-scorecard-service.test.ts**
```typescript
describe('SupplierScorecardService', () => {
  describe('calculateScorecard', () => {
    it('calculates quality score from GRN qa_status');
    it('calculates delivery score from PO expected_date vs GRN receipt_date');
    it('calculates quantity score within tolerance');
    it('calculates documentation score from CoA presence');
    it('calculates price score vs baseline');
    it('applies correct weights (30/30/20/10/10)');
    it('assigns star rating based on overall score');
    it('calculates trend vs previous period');
    it('handles supplier with zero deliveries');
    it('excludes data outside period');
  });

  describe('getScorecardsRanking', () => {
    it('returns suppliers sorted by score descending');
    it('filters by minimum rating');
    it('includes trend indicators');
    it('paginates results correctly');
  });
});
```

**supplier-audit-service.test.ts**
```typescript
describe('SupplierAuditService', () => {
  describe('createAudit', () => {
    it('creates audit with valid data');
    it('validates unannounced cannot be future date');
    it('validates incident requires reference');
    it('suggests next audit date for periodic audits');
    it('updates supplier last_audit_date');
  });

  describe('updateCorrectiveAction', () => {
    it('updates action status');
    it('uses optimistic locking');
    it('tracks completion date');
  });

  describe('getOverdueAudits', () => {
    it('returns audits with next_audit_date in past');
    it('excludes suppliers without scheduled audits');
  });
});
```

### Integration Tests

**scorecard-api.test.ts**
```typescript
describe('Scorecard API', () => {
  describe('GET /api/planning/suppliers/scorecards', () => {
    it('returns ranked supplier list');
    it('filters by rating range');
    it('respects RLS org isolation');
  });

  describe('GET /api/planning/suppliers/:id/scorecard', () => {
    it('returns scorecard for specific supplier');
    it('includes metric breakdown');
    it('returns 404 for supplier with no deliveries');
  });

  describe('POST /api/planning/suppliers/:id/scorecard/calculate', () => {
    it('recalculates scorecard');
    it('updates supplier current_score');
    it('creates performance alert if score drops');
  });
});
```

**audit-api.test.ts**
```typescript
describe('Audit API', () => {
  describe('POST /api/planning/suppliers/:id/audits', () => {
    it('creates audit with valid data');
    it('returns 400 for invalid audit type rules');
    it('updates supplier next_audit_due');
  });

  describe('PUT /api/planning/suppliers/audits/:id', () => {
    it('updates audit details');
    it('handles optimistic locking conflict');
    it('validates score range');
  });

  describe('GET /api/planning/suppliers/audits', () => {
    it('returns all audits with filters');
    it('filters by type and result');
    it('returns overdue audits first when requested');
  });
});
```

### E2E Tests

**scorecard-dashboard.spec.ts**
```typescript
describe('Scorecard Dashboard', () => {
  it('displays supplier rankings');
  it('shows KPI summary cards');
  it('filters by rating');
  it('exports rankings to Excel');
  it('navigates to supplier detail');
});
```

**supplier-audit.spec.ts**
```typescript
describe('Supplier Audits', () => {
  it('creates new periodic audit');
  it('validates unannounced date restriction');
  it('adds corrective actions');
  it('updates action status');
  it('shows audit due badge on supplier');
  it('displays audit history timeline');
});
```

## Security Considerations

1. **Data Access**
   - All scorecard data filtered by org_id via RLS
   - Audit records visible only within organization
   - Score manipulation prevented via server-side calculation

2. **Audit Integrity**
   - Optimistic locking prevents concurrent edit conflicts
   - Audit trail for all score changes
   - Cannot backdate score calculations

3. **Role-Based Access**
   - Quality Manager: Full audit CRUD
   - Purchaser: View scorecards, view audits
   - Supplier (if portal): View own scorecard only

## Deliverables

- [ ] `supplier_scorecards` table migration
- [ ] `supplier_performance_history` table migration
- [ ] `supplier_audits` table migration
- [ ] Suppliers table extensions (current_score, current_rating)
- [ ] RLS policies for all new tables
- [ ] Scorecard service (`lib/services/supplier-scorecard-service.ts`)
- [ ] Audit service (`lib/services/supplier-audit-service.ts`)
- [ ] Zod schemas (`lib/validation/supplier-scorecard.ts`, `lib/validation/supplier-audit.ts`)
- [ ] Scorecard API routes (5 endpoints)
- [ ] Audit API routes (8 endpoints)
- [ ] ScorecardDashboard component
- [ ] ScorecardDetail component
- [ ] PerformanceTrendChart component
- [ ] AuditListTable component
- [ ] AuditCreateModal component
- [ ] FindingsEditor component
- [ ] CorrectiveActionsEditor component
- [ ] Scorecard dashboard page
- [ ] Supplier scorecard detail page
- [ ] Audits list page
- [ ] Unit tests (>85% coverage)
- [ ] Integration tests
- [ ] E2E tests

## Definition of Done

- [ ] Scorecard calculated automatically on GRN completion
- [ ] All 5 metrics calculated with correct weights (30/30/20/10/10)
- [ ] Star rating assigned correctly (1-5 based on score ranges)
- [ ] Trend analysis shows monthly comparison
- [ ] Supplier rankings display correctly sorted
- [ ] At Risk suppliers (<70) flagged with badge
- [ ] Performance alerts generated for score drops
- [ ] Audit CRUD works for all 4 types
- [ ] Audit type rules enforced (unannounced, incident)
- [ ] Corrective actions tracked with status updates
- [ ] Due date badges show upcoming/overdue audits
- [ ] Export to PDF/Excel works for scorecards
- [ ] Export rankings to Excel works
- [ ] RLS policies enforce org isolation
- [ ] Multi-tenant data correctly isolated in calculations
- [ ] Low data confidence warning for <5 deliveries
- [ ] Missing data handled gracefully in calculations
- [ ] Optimistic locking prevents concurrent edit conflicts
- [ ] Unit test coverage >= 85%
- [ ] Integration tests pass
- [ ] E2E tests pass
- [ ] Performance: Dashboard loads in <500ms (P95)
- [ ] Performance: Scorecard calculation <200ms

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2026-01-14 | Initial story creation | ARCHITECT-AGENT |
