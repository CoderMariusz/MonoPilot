# Story 03.13 - Test Specification
# Purpose: Acceptance criteria and test coverage
# Status: COMPLETE - 82 backend + 177 frontend tests GREEN

test_files:
  - path: "apps/frontend/lib/services/__tests__/material-availability-service.test.ts"
    type: "unit"
    count: 82
    status: "green"
  - path: "apps/frontend/components/planning/work-orders/availability/__tests__/WOAvailabilityPanel.test.tsx"
    type: "component"
    status: "green"
  - path: "apps/frontend/components/planning/work-orders/availability/__tests__/AvailabilitySummaryCard.test.tsx"
    type: "component"
    status: "green"
  - path: "apps/frontend/components/planning/work-orders/availability/__tests__/AvailabilityTrafficLight.test.tsx"
    type: "component"
    status: "green"
  - path: "apps/frontend/components/planning/work-orders/availability/__tests__/AvailabilityWarningModal.test.tsx"
    type: "component"
    status: "green"

acceptance_criteria:
  - id: "AC-01"
    given: "WO has wo_materials with required quantities"
    when: "availability endpoint is called"
    then: "coverage_percent = (available / required) * 100"
    status: "passed"
  - id: "AC-02"
    given: "LPs with various expiry dates"
    when: "availability calculated"
    then: "expired LPs excluded from available count"
    status: "passed"
  - id: "AC-03"
    given: "Coverage percentages"
    when: "status calculated"
    then: "Green >= 100%, Yellow 50-99%, Red < 50%, Red outline 0%"
    status: "passed"
  - id: "AC-04"
    given: "Materials with mixed statuses"
    when: "overall status calculated"
    then: "worst case status returned"
    status: "passed"
  - id: "AC-05"
    given: "wo_material_check = false"
    when: "availability endpoint called"
    then: "API returns { enabled: false }"
    status: "passed"
  - id: "AC-06"
    given: "WO has material shortages"
    when: "user clicks Release"
    then: "warning modal shown"
    status: "passed"
  - id: "AC-07"
    given: "User from different org"
    when: "availability API called"
    then: "returns 404 (RLS isolation)"
    status: "passed"
  - id: "AC-08"
    given: "Availability checked for WO"
    when: "same request within 30 seconds"
    then: "cached result returned"
    status: "passed"

unit_test_coverage:
  coverage_calculation:
    - "100 required, 150 available -> 150% coverage, surplus -50"
    - "100 required, 75 available -> 75% coverage, shortage 25"
    - "100 required, 0 available -> 0% coverage, no_stock"
    - "0 required, any available -> 100% coverage"
  status_thresholds:
    - ">= 100% -> sufficient"
    - "50-99% -> low_stock"
    - "1-49% -> shortage"
    - "0% -> no_stock"
  overall_status:
    - "All sufficient -> sufficient"
    - "Any low_stock -> low_stock"
    - "Any shortage -> shortage"
    - "Any no_stock -> no_stock"

definition_of_done:
  - "[x] API endpoint returns correct availability data"
  - "[x] Coverage percentage calculated correctly"
  - "[x] Traffic light indicators display correctly"
  - "[x] Shortage/surplus quantities calculated correctly"
  - "[x] Expired LPs excluded from available count"
  - "[x] Reservations from other WOs deducted"
  - "[x] Overall status reflects worst-case material"
  - "[x] Setting toggle wo_material_check respected"
  - "[x] Warning modal shown when proceeding with shortages"
  - "[x] Caching implemented (30 sec TTL)"
  - "[x] RLS enforces org isolation"
  - "[x] All 82 backend tests passing"
  - "[x] All frontend component tests passing"

performance_targets:
  initial_load: "<500ms"
  cached_response: "<100ms"
  large_wo_50_materials: "<1s"
  very_large_wo_200_materials: "<2s"
