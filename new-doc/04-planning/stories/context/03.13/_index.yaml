# Story 03.13 - Index File (Entry Point)
# Generated: 2026-01-14
# Purpose: Story metadata and dependencies - read this first
# Status: COMPLETE (82 backend + 177 frontend tests GREEN)

story:
  id: "03.13"
  name: "WO Material Availability Check"
  slug: "wo-material-availability"
  epic: "03-planning"
  phase: "1B"
  complexity: "M"
  estimate_days: 4
  type: "full-stack"
  state: "complete"
  priority: "P0"

context_files:
  - _index.yaml      # This file - metadata, dependencies
  - database.yaml    # Queries for LP/reservations, no new tables
  - api.yaml         # GET /api/planning/work-orders/:id/availability
  - frontend.yaml    # WOAvailabilityPanel, TrafficLight, SummaryCard, WarningModal
  - tests.yaml       # Acceptance criteria, 82 backend + frontend tests

dependencies:
  required:
    - story: "03.10"
      name: "Work Orders CRUD"
      provides: ["work_orders table", "WOService"]
    - story: "03.11a"
      name: "WO Materials Snapshot"
      provides: ["wo_materials table", "BOM snapshot"]
    - story: "03.16"
      name: "Planning Settings"
      provides: ["planning_settings.wo_material_check toggle"]
    - epic: "05"
      name: "Warehouse Module"
      provides: ["license_plates table", "lp_reservations table"]
  blocks:
    - story: "03.14"
      name: "WO Release with Validation"
      reason: "Release needs availability check results"

files_to_read:
  prd:
    path: "docs/1-BASELINE/product/modules/planning.md"
    sections: ["FR-PLAN-021"]
  architecture:
    path: "docs/1-BASELINE/architecture/modules/planning.md"
    sections: ["Material Availability", "Work Order Management"]
  story:
    path: "docs/2-MANAGEMENT/epics/current/03-planning/03.13.material-availability.md"
  wireframe:
    path: "docs/3-ARCHITECTURE/ux/wireframes/PLAN-027-wo-availability-panel.md"
    sections: ["WOAvailabilityPanel", "AvailabilityWarningModal"]
  adrs:
    - path: "docs/1-BASELINE/architecture/decisions/ADR-013-rls-org-isolation-pattern.md"
      relevance: "RLS policy pattern for availability queries"

deliverables:
  - type: "api"
    count: 1
    description: "GET /api/planning/work-orders/:id/availability"
    status: "complete"
  - type: "service"
    count: 1
    description: "MaterialAvailabilityService with calculateAvailability()"
    status: "complete"
  - type: "validation"
    count: 1
    description: "material-availability.ts Zod schemas"
    status: "complete"
  - type: "types"
    count: 1
    description: "wo-availability.ts TypeScript interfaces"
    status: "complete"
  - type: "hook"
    count: 2
    description: "useWOAvailability, useCheckAvailability"
    status: "complete"
  - type: "component"
    count: 5
    description: "WOAvailabilityPanel, AvailabilityMaterialRow, AvailabilityTrafficLight, AvailabilitySummaryCard, AvailabilityWarningModal"
    status: "complete"
  - type: "test"
    count: 2
    description: "82 backend tests + frontend component tests"
    status: "green"

mvp_scope:
  in_scope:
    - "Calculate availability from LP quantities minus reservations"
    - "Traffic light indicators (green/yellow/red)"
    - "Overall status as worst-case material"
    - "30 second cache TTL with auto-refresh"
    - "Warning modal when proceeding with shortages"
    - "Respect wo_material_check setting toggle"
    - "Exclude expired LPs from available count"
  out_of_scope:
    - "Auto-reservation of materials"
    - "Purchase order suggestions"
    - "Alternative material suggestions"
    - "Historical availability trends"

functional_requirements:
  - id: "FR-PLA-13-001"
    name: "Availability Calculation Algorithm"
    description: "Calculate material availability by summing LP quantities minus reservations from other WOs"
  - id: "FR-PLA-13-002"
    name: "Traffic Light Status Indicators"
    description: "Visual indicators showing material sufficiency status (green/yellow/red)"
  - id: "FR-PLA-13-003"
    name: "WO Availability Panel Component"
    description: "Main panel displaying material availability for Work Order"
  - id: "FR-PLA-13-004"
    name: "Warning Modal for Shortages"
    description: "Modal warning user when proceeding with material shortages"
  - id: "FR-PLA-13-005"
    name: "Setting Toggle and Disabled State"
    description: "Respect wo_material_check setting from planning_settings"

acceptance_criteria:
  - id: "AC-01"
    given: "WO has wo_materials with required quantities"
    when: "availability endpoint is called"
    then: "system calculates coverage_percent = (available / required) * 100"
  - id: "AC-02"
    given: "Various coverage percentages"
    when: "status calculated"
    then: "Green >= 100%, Yellow 50-99%, Red < 50%, Red outline 0%"
  - id: "AC-03"
    given: "Materials with mixed statuses"
    when: "overall status calculated"
    then: "worst case status returned (no_stock > shortage > low_stock > sufficient)"
  - id: "AC-04"
    given: "wo_material_check = false in planning_settings"
    when: "availability endpoint called"
    then: "API returns { enabled: false }"
  - id: "AC-05"
    given: "WO has material shortages"
    when: "user clicks Release button"
    then: "warning modal shown with option to proceed or cancel"
