# 03.9b - TO License Plate Pre-selection

**Priority**: P1 (Phase 1) - COMPLETE
**Story Points**: M (Medium - 3-4 days)
**Type:** backend + frontend

**State:** complete
**Primary PRD:** `docs/1-BASELINE/product/modules/planning.md` (FR-PLAN-016)
**Architecture:** `docs/1-BASELINE/architecture/modules/planning.md`
**UX Wireframes:** PLAN-025 (LP Picker Modal)

**COMPLETED**: 2026-01-08 - Full implementation with 105 passing tests.

---

## MVP Scope

This story implements **optional** License Plate (LP) pre-selection for Transfer Orders, allowing users to specify exact inventory units to transfer BEFORE shipping execution. This is a Phase 1 enhancement that provides:

- LP picker modal at TO creation/editing
- LP assignment to TO lines via junction table
- LP availability validation (warehouse, product, qty checks)
- Visual display of assigned LPs on TO Detail page
- Auto-picking of pre-selected LPs during shipping (Epic 05 integration)
- Settings toggle to make LP selection mandatory or optional

**In MVP:**
- `to_line_lps` junction table creation
- LP picker component with filters (product, warehouse, expiry, lot)
- LP assignment API endpoints
- Quantity validation (sum of LP quantities = TO line quantity)
- LP availability checks (correct warehouse, sufficient quantity)
- Integration with Epic 05 license_plates table

**Not in MVP:**
- FIFO/FEFO auto-suggestion (uses Epic 05 picking service)
- LP splitting during transfer (must use full LP or partial qty)
- LP consolidation across multiple TOs
- Barcode scanning for LP selection (Phase 2)

---

## Goal

Enable planners to pre-select specific License Plates when creating Transfer Orders, ensuring precise inventory control and reducing picking errors during shipping execution.

## User Story

As a **Warehouse Planner**, I want to **pre-select specific License Plates when creating a Transfer Order** so that **I can guarantee the correct inventory (by lot, expiry, or location) is transferred and warehouse staff pick exactly what I planned**.

## Scope

**In scope (this story)**
- `to_line_lps` junction table (to_line_id, lp_id, quantity)
- LP Picker modal component with filters:
  - Filter by warehouse (from_warehouse_id)
  - Filter by product (from selected TO line)
  - Filter by expiry date range
  - Filter by lot number
  - Show available quantity per LP
  - Multi-select interface for assigning multiple LPs to one TO line
- API endpoints:
  - POST `/api/planning/transfer-orders/:id/lines/:lineId/assign-lps`
  - DELETE `/api/planning/transfer-orders/:id/lines/:lineId/lps/:lpId`
  - GET `/api/planning/transfer-orders/:id/lines/:lineId/lps`
- Service layer methods:
  - `assignLPsToTOLine()` - Validate and assign LPs
  - `validateLPAvailability()` - Check warehouse, product, quantity
  - `getAvailableLPsForTOLine()` - Filter LPs by TO line criteria
  - `removeLPFromTOLine()` - Remove LP assignment
- Validation:
  - LP must exist in from_warehouse
  - LP product_id must match TO line product_id
  - Sum of LP quantities must equal TO line quantity (if setting requires)
  - LP must not be already allocated to another TO
  - LP available_qty >= assigned quantity
- UI updates:
  - "Assign LPs" button on TO Detail page (per line)
  - LP assignments display on TO line (badges or table)
  - Warning if LP quantities don't match TO line quantity
- Integration with Epic 05:
  - Query `license_plates` table for available LPs
  - Check `lp_inventory` for available quantities
  - Update LP status during shipping (handled by Epic 05 ship action)

**Out of scope (this story)**
- Automatic FIFO/FEFO LP suggestion (use Epic 05 picking service)
- LP splitting (moving partial qty from LP to new LP) - Epic 05 feature
- Barcode scanning for LP selection - Phase 2
- Cross-warehouse LP visibility (only show from_warehouse LPs)
- LP reservation/allocation table (deferred to WO Material Reservation 03.11b)
- Shipping execution (handled by Epic 05 TO Ship action)

## Dependencies

- **01.1** - Org Context + RLS (HARD) - org_id filtering
- **02.1** - Products CRUD (HARD) - product_id FK validation
- **03.8** - TO CRUD + Lines (HARD) - TO and TO line entities
- **03.9a** - TO Partial Shipments (SOFT) - Ship/Receive actions that consume LP assignments
- **Epic 05** - Warehouse Module (HARD) - `license_plates` table, `lp_inventory` table, LP availability logic

## Implementation Summary

### Files Created

**Database:**
- `supabase/migrations/101_create_to_line_lps.sql` - Junction table with RLS

**API Routes:**
- `apps/frontend/app/api/planning/transfer-orders/[id]/lines/[lineId]/assign-lps/route.ts`
- `apps/frontend/app/api/planning/transfer-orders/[id]/lines/[lineId]/lps/route.ts`
- `apps/frontend/app/api/planning/transfer-orders/[id]/lines/[lineId]/lps/[lpId]/route.ts`
- `apps/frontend/app/api/planning/transfer-orders/[id]/lines/[lineId]/available-lps/route.ts`

**Services:**
- `apps/frontend/lib/services/to-lp-service.ts`

**Validation:**
- `apps/frontend/lib/validation/to-lp-validation.ts`

**Components:**
- `apps/frontend/app/(authenticated)/planning/transfer-orders/[id]/components/TOLPPickerModal.tsx`
- `apps/frontend/app/(authenticated)/planning/transfer-orders/[id]/components/TOLineLPAssignments.tsx`
- `apps/frontend/app/(authenticated)/planning/transfer-orders/[id]/components/LPAssignmentBadge.tsx`
- `apps/frontend/app/(authenticated)/planning/transfer-orders/[id]/components/use-to-line-lps.ts`

**UX Wireframe:**
- `docs/3-ARCHITECTURE/ux/wireframes/PLAN-025-to-lp-picker-modal.md`

### Tests
- 105 tests passing across unit, integration, and validation tests

### Deferred Items
- **AC-11**: Settings toggle (depends on Story 03.17 - Planning Settings CRUD)
- **AC-13**: Epic 05 Ship TO integration (will consume pre-selected LPs)
- **AC-14**: Future features (FIFO/FEFO, barcode scanning) - Phase 2

## Acceptance Criteria (Given/When/Then)

### AC-1: Create to_line_lps Junction Table (Migration) - DONE

**Given** Epic 05 has created the `license_plates` table
**When** migration is applied
**Then** new table `to_line_lps` exists with schema:
```sql
id                  UUID PRIMARY KEY DEFAULT gen_random_uuid()
to_line_id          UUID NOT NULL REFERENCES transfer_order_lines(id) ON DELETE CASCADE
lp_id               UUID NOT NULL REFERENCES license_plates(id)
quantity            DECIMAL(15,4) NOT NULL CHECK (quantity > 0)
created_at          TIMESTAMPTZ DEFAULT now()
created_by          UUID REFERENCES users(id)

UNIQUE(to_line_id, lp_id)  -- Same LP cannot be assigned twice to same line
INDEX ON (to_line_id)
INDEX ON (lp_id)
```

**And** RLS policy `to_line_lps_org_isolation` enforces org_id via TO line -> TO -> org_id chain

### AC-2: LP Picker Modal - Open and Display Available LPs - DONE

**Given** I am on the TO Detail page with TO status = DRAFT or PLANNED
**And** TO line exists: Product A, qty = 100 units, from_warehouse = "WH-001"
**When** I click "Assign LPs" button next to the TO line
**Then** LP Picker modal opens showing:
- Modal title: "Assign License Plates - Product A (100 units needed)"
- Filter panel:
  - Warehouse: "WH-001" (readonly, pre-filled from TO from_warehouse_id)
  - Product: "Product A" (readonly, pre-filled from TO line)
  - Lot Number (text input, optional filter)
  - Expiry Date From/To (date range, optional filter)
  - Search (LP number search)
- LP list table with columns:
  - [ ] Checkbox (multi-select)
  - LP Number (e.g., "LP-2024-00123")
  - Lot Number
  - Expiry Date
  - Location
  - Available Qty (e.g., "50 units")
  - UOM
- "Assign Qty" input field per row (numeric, defaulted to available qty)
- Total Selected: "0 / 100 units" progress indicator
- "Assign LPs" and "Cancel" buttons

**And** only LPs matching criteria are shown:
  - LP.warehouse_id = TO.from_warehouse_id
  - LP.product_id = TO line.product_id
  - LP.available_qty > 0
  - LP not already assigned to another TO (check `to_line_lps` table)

### AC-3: LP Picker Modal - Assign Single LP (Full Quantity) - DONE

**Given** LP Picker modal is open for TO line with qty = 100
**And** LP-2024-00123 is available with available_qty = 100
**When** I check the checkbox for LP-2024-00123
**And** I leave "Assign Qty" = 100 (default)
**And** I click "Assign LPs"
**Then**:
- API POST to `/api/planning/transfer-orders/:toId/lines/:lineId/assign-lps` with body:
  ```json
  {
    "lps": [
      { "lp_id": "uuid-123", "quantity": 100 }
    ]
  }
  ```
- New row inserted into `to_line_lps`:
  - to_line_id = TO line UUID
  - lp_id = "uuid-123"
  - quantity = 100
- Modal closes
- Success toast: "1 License Plate assigned successfully"
- TO Detail page refreshes, TO line shows:
  - Badge: "1 LP Assigned" (green)
  - Expandable section showing:
    - LP-2024-00123 | Lot: ABC-001 | Expiry: 2025-06-01 | Qty: 100 units
    - Remove button (X icon) next to each LP

### AC-4: LP Picker Modal - Assign Multiple LPs (Partial Quantities) - DONE

**Given** LP Picker modal is open for TO line with qty = 100
**And** available LPs:
  - LP-001: available_qty = 50
  - LP-002: available_qty = 30
  - LP-003: available_qty = 20
**When** I select:
  - LP-001, Assign Qty = 50
  - LP-002, Assign Qty = 30
  - LP-003, Assign Qty = 20
**And** Total Selected shows: "100 / 100 units" (green checkmark)
**And** I click "Assign LPs"
**Then**:
- 3 rows inserted into `to_line_lps` table
- TO line shows:
  - Badge: "3 LPs Assigned" (green)
  - Expandable section with all 3 LPs listed
- Success toast: "3 License Plates assigned successfully"

### AC-5: LP Picker Modal - Validation: Quantity Mismatch - DONE

**Given** LP Picker modal is open for TO line with qty = 100
**And** setting "Require Exact LP Quantity Match" = true
**When** I select LPs with total = 80 (less than required)
**And** I click "Assign LPs"
**Then**:
- API returns 400 error: "Total LP quantity (80) does not match TO line quantity (100). Assign exactly 100 units or disable exact match requirement in settings."
- Error toast displayed
- Modal remains open with error message

**Given** setting "Require Exact LP Quantity Match" = false
**When** I select LPs with total = 80
**And** I click "Assign LPs"
**Then**:
- Assignment succeeds
- Warning badge on TO line: "80 / 100 units assigned" (yellow)
- TO Detail page shows warning: "Some lines have incomplete LP assignments"

### AC-6: LP Picker Modal - Validation: LP Not in Source Warehouse - DONE

**Given** LP Picker modal is open for TO with from_warehouse = "WH-001"
**When** API receives assignment request with lp_id pointing to LP in "WH-002"
**Then**:
- API returns 400 error: "LP-2024-00456 is not located in source warehouse WH-001"
- Error toast displayed

### AC-7: LP Picker Modal - Validation: Product Mismatch - DONE

**Given** LP Picker modal is open for TO line with product = "Product A"
**When** API receives assignment request with lp_id pointing to LP containing "Product B"
**Then**:
- API returns 400 error: "LP-2024-00456 contains Product B, but TO line requires Product A"
- Error toast displayed

### AC-8: LP Picker Modal - Validation: Insufficient LP Quantity - DONE

**Given** LP-001 has available_qty = 50
**When** I assign LP-001 with Assign Qty = 60
**And** I click "Assign LPs"
**Then**:
- API returns 400 error: "LP-001 has only 50 units available, cannot assign 60 units"
- Error toast displayed

### AC-9: LP Picker Modal - Validation: LP Already Assigned to Another TO - DONE

**Given** LP-001 is already assigned to TO-2024-00001 (different TO)
**When** LP Picker modal loads for TO-2024-00002
**Then**:
- LP-001 does NOT appear in available LPs list
- Filter info message: "LPs already assigned to other TOs are hidden"

**Alternative behavior (if business rule allows partial allocation):**
- LP-001 appears but shows "Available Qty: 30 (70 allocated to TO-2024-00001)"
- Can assign up to 30 units from this LP

### AC-10: Remove LP Assignment - DONE

**Given** TO line has 2 LPs assigned:
  - LP-001: qty = 50
  - LP-002: qty = 50
**When** I click the Remove (X) button next to LP-001
**Then** confirmation dialog appears: "Remove LP-001 from this Transfer Order line?"
**And** on confirm:
- API DELETE to `/api/planning/transfer-orders/:toId/lines/:lineId/lps/:lpId`
- Row deleted from `to_line_lps` table
- TO line badge updates: "1 LP Assigned"
- TO line shows warning: "50 / 100 units assigned" (yellow badge)
- Success toast: "LP-001 removed successfully"

### AC-11: Settings Toggle - Require LP Selection - DEFERRED (Story 03.17)

**Given** I am on Planning Settings page (Story 03.17)
**Then** I should see toggle:
- Label: "Require License Plate Selection for Transfer Orders"
- Description: "When enabled, Transfer Orders cannot be shipped without pre-assigned License Plates"
- Default: Disabled (false)
- Sub-setting (visible when enabled):
  - Checkbox: "Require Exact Quantity Match"
  - Description: "Sum of assigned LP quantities must equal TO line quantity"

### AC-12: TO Detail Page - Display LP Assignments - DONE

**Given** TO line has 2 LPs assigned:
  - LP-001: Lot ABC-001, Expiry 2025-06-01, Qty 50
  - LP-002: Lot ABC-002, Expiry 2025-07-01, Qty 50
**When** I view TO Detail page
**Then** TO lines table shows:
- Column: "LP Assignments"
  - Badge: "2 LPs Assigned" (green) if total qty matches TO line qty
  - Badge: "Partial Assignment" (yellow) if total qty < TO line qty
  - Expandable row showing:
    - Table with columns: LP Number, Lot, Expiry, Location, Assigned Qty, Actions
    - Each LP has a Remove (X) button
- "Assign LPs" button visible if status = DRAFT or PLANNED

### AC-13: Integration with Ship TO Action (Epic 05) - DEFERRED

**Note:** Shipping execution details are handled by Epic 05 Warehouse Ship TO action. This story only handles LP pre-selection.

### AC-14: Future Features (Phase 2+) - DEFERRED

Features deferred to future phases:
- **FIFO/FEFO Auto-Suggestion** (Phase 2)
- **Barcode Scanning for LP Selection** (Phase 2)
- **LP Splitting During Transfer** (Phase 2)
- **Cross-Warehouse LP Visibility** (Phase 3)
- **LP Reservation Table** (Phase 3)

## Definition of Done

- [x] Migration applied successfully creating `to_line_lps` table
- [x] RLS policy enforces org isolation for LP assignments
- [x] LP Picker modal implemented with all filters (warehouse, product, lot, expiry)
- [x] LP assignment API endpoint validates all business rules
- [x] Available LPs endpoint queries Epic 05 license_plates table correctly
- [x] LP assignments display on TO Detail page with badges
- [x] Remove LP functionality works correctly
- [ ] Settings toggle "Require LP Selection" functional (DEFERRED - Story 03.17)
- [ ] Settings sub-toggle "Require Exact Quantity Match" functional (DEFERRED - Story 03.17)
- [x] Validation prevents:
  - Assigning LP from wrong warehouse
  - Assigning LP with wrong product
  - Assigning more quantity than LP has available
  - Duplicate LP assignments to same line
- [x] LP assignments block/warn based on settings (exact match requirement)
- [x] Service methods implement all business rules correctly
- [x] Zod schemas validate all edge cases
- [x] Unit tests passing (105 tests)
- [x] Integration tests passing for all API endpoints
- [x] E2E smoke test passing (TO with LP assignment full cycle)
- [x] Integration with Epic 05 verified:
  - Can query license_plates table
  - Can query lp_inventory for available quantities
- [ ] Ship TO action (Epic 05) consumes LP assignments correctly (DEFERRED - Epic 05)
- [x] Performance: LP picker loads available LPs in <500ms
- [x] Accessibility: Modals keyboard-navigable, ARIA labels present
- [x] Documentation updated in PRD/Architecture docs
- [x] Code review approved
- [ ] Merged to main branch (pending)

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-12-16 | Initial story creation | ARCHITECT-AGENT |
| 2.0 | 2026-01-08 | Story completed - 105 tests passing | DEV-TEAM |
