# PLAN-007: Purchase Order Bulk Import Modal

**Module**: Planning
**Feature**: Bulk PO Creation from Excel (FR-PLAN-008)
**Status**: Ready for Implementation
**Last Updated**: 2025-12-14

---

## ASCII Wireframe

### Step 1: File Upload

```
+--------------------------------------------------------------------------------------------------+
|                                    Import Purchase Orders                                    [X]  |
+--------------------------------------------------------------------------------------------------+
|                                                                                                    |
|  Step 1 of 4: Upload File                                                                         |
|  [====]---------------------------------------                                                    |
|   1         2           3           4                                                             |
|  Upload    Preview    Validate    Create                                                          |
|                                                                                                    |
|  +----------------------------------------------------------------------------------------------+  |
|  |                                                                                              |  |
|  |                          +--------------------------------+                                  |  |
|  |                          |                                |                                  |  |
|  |                          |      [Upload Icon]             |                                  |  |
|  |                          |                                |                                  |  |
|  |                          |   Drag & drop Excel file here  |                                  |  |
|  |                          |          or click to browse    |                                  |  |
|  |                          |                                |                                  |  |
|  |                          |   Supported: .xlsx, .xls       |                                  |  |
|  |                          |   Max size: 5 MB               |                                  |  |
|  |                          |                                |                                  |  |
|  |                          +--------------------------------+                                  |  |
|  |                                                                                              |  |
|  |                          [Download Template]                                                 |  |
|  |                                                                                              |  |
|  +----------------------------------------------------------------------------------------------+  |
|                                                                                                    |
|  Template Format:                                                                                 |
|  +----------------------------------------------------------------------------------------------+  |
|  | Column         | Required | Description                           | Example                 |  |
|  +----------------------------------------------------------------------------------------------+  |
|  | product_code   | Yes      | Product code or SKU                   | RM-FLOUR-001           |  |
|  | quantity       | Yes      | Order quantity                        | 500                    |  |
|  | unit_price     | No       | Unit price (uses default if empty)    | 1.20                   |  |
|  | supplier_code  | No       | Override default supplier             | SUP-001                |  |
|  | expected_date  | No       | Expected delivery (YYYY-MM-DD)        | 2024-12-20             |  |
|  | notes          | No       | Line notes                            | Urgent order           |  |
|  +----------------------------------------------------------------------------------------------+  |
|                                                                                                    |
|  +----------------------------------------------------------------------------------------------+  |
|  |                                                                    [Cancel]    [Next: Preview]|  |
|  +----------------------------------------------------------------------------------------------+  |
|                                                                                                    |
+--------------------------------------------------------------------------------------------------+
```

### Step 2: Preview Parsed Data

```
+--------------------------------------------------------------------------------------------------+
|                                    Import Purchase Orders                                    [X]  |
+--------------------------------------------------------------------------------------------------+
|                                                                                                    |
|  Step 2 of 4: Preview Data                                                                        |
|  ==========[====]--------------------                                                            |
|   1         2           3           4                                                             |
|  Upload    Preview    Validate    Create                                                          |
|                                                                                                    |
|  File: purchase_orders_december.xlsx (15 rows parsed)                    [Change File]           |
|                                                                                                    |
|  Grouping by Default Supplier:                                                                    |
|  +----------------------------------------------------------------------------------------------+  |
|  |                                                                                              |  |
|  |  +-- PO Group 1: Mill Co. (SUP-001) -----------------------------------------------------+  |  |
|  |  |                                                                                        |  |  |
|  |  |  Expected Delivery: Dec 20, 2024 (based on lead time: 7 days)                         |  |  |
|  |  |                                                                                        |  |  |
|  |  |  | Product            | Qty      | Unit Price | Subtotal    | Notes                 |  |  |
|  |  |  |--------------------+----------+------------+-------------+-----------------------|  |  |
|  |  |  | Flour Type A       | 500 kg   | $1.20      | $600.00     | -                     |  |  |
|  |  |  | Flour Type B       | 300 kg   | $1.35      | $405.00     | -                     |  |  |
|  |  |  | Salt Industrial    | 100 kg   | $0.30      | $30.00      | Urgent order          |  |  |
|  |  |  |                                                                                        |  |  |
|  |  |  Subtotal: $1,035.00 PLN                                           [Edit Group]          |  |  |
|  |  +----------------------------------------------------------------------------------------+  |  |
|  |                                                                                              |  |
|  |  +-- PO Group 2: Sugar Inc. (SUP-002) ---------------------------------------------------+  |  |
|  |  |                                                                                        |  |  |
|  |  |  Expected Delivery: Dec 18, 2024 (based on lead time: 5 days)                         |  |  |
|  |  |                                                                                        |  |  |
|  |  |  | Product            | Qty      | Unit Price | Subtotal    | Notes                 |  |  |
|  |  |  |--------------------+----------+------------+-------------+-----------------------|  |  |
|  |  |  | Sugar White        | 400 kg   | $0.85      | $340.00     | -                     |  |  |
|  |  |  | Sugar Brown        | 200 kg   | $0.90      | $180.00     | -                     |  |  |
|  |  |  |                                                                                        |  |  |
|  |  |  Subtotal: $520.00 EUR                                             [Edit Group]          |  |  |
|  |  +----------------------------------------------------------------------------------------+  |  |
|  |                                                                                              |  |
|  |  +-- PO Group 3: Pack Ltd. (SUP-003) ----------------------------------------------------+  |  |
|  |  |                                                                                        |  |  |
|  |  |  Expected Delivery: Dec 22, 2024 (based on lead time: 10 days)                        |  |  |
|  |  |                                                                                        |  |  |
|  |  |  | Product            | Qty      | Unit Price | Subtotal    | Notes                 |  |  |
|  |  |  |--------------------+----------+------------+-------------+-----------------------|  |  |
|  |  |  | Box Small          | 5000 pcs | $0.12      | $600.00     | -                     |  |  |
|  |  |  | Box Large          | 2000 pcs | $0.25      | $500.00     | -                     |  |  |
|  |  |  | Labels Roll        | 50 rolls | $8.00      | $400.00     | -                     |  |  |
|  |  |  |                                                                                        |  |  |
|  |  |  Subtotal: $1,500.00 PLN                                           [Edit Group]          |  |  |
|  |  +----------------------------------------------------------------------------------------+  |  |
|  |                                                                                              |  |
|  +----------------------------------------------------------------------------------------------+  |
|                                                                                                    |
|  Summary: 3 POs will be created | 10 line items | Total: $3,055.00                              |
|                                                                                                    |
|  +----------------------------------------------------------------------------------------------+  |
|  |                                         [Back: Upload]    [Cancel]    [Next: Validate]       |  |
|  +----------------------------------------------------------------------------------------------+  |
|                                                                                                    |
+--------------------------------------------------------------------------------------------------+
```

### Edit Group Modal

```
+--------------------------------------------------------------------------------------------------+
|                                       Edit PO Group                                          [X]  |
+--------------------------------------------------------------------------------------------------+
|                                                                                                    |
|  PO Group: Mill Co. (SUP-001)                                                                     |
|                                                                                                    |
|  +----------------------------------------------------------------------------------------------+  |
|  |                                                                                              |  |
|  |  Supplier:         [Mill Co. (SUP-001)                                             v]       |  |
|  |                                                                                              |  |
|  |  Warehouse:        [Main Warehouse (WH-MAIN)                                       v]       |  |
|  |                                                                                              |  |
|  |  Expected Date:    [2024-12-20                                                ]             |  |
|  |                    Based on supplier lead time (7 days). Override if needed.                |  |
|  |                                                                                              |  |
|  |  Payment Terms:    [Net 30                                                    v]            |  |
|  |                                                                                              |  |
|  |  Tax Code:         [Standard 23%                                              v]            |  |
|  |                                                                                              |  |
|  |  Notes:            +---------------------------------------------------------------+       |  |
|  |                    |                                                               |       |  |
|  |                    |                                                               |       |  |
|  |                    +---------------------------------------------------------------+       |  |
|  |                                                                                              |  |
|  +----------------------------------------------------------------------------------------------+  |
|                                                                                                    |
|  Line Items (3):                                                                                  |
|  +----------------------------------------------------------------------------------------------+  |
|  | # | Product            | Qty      | UoM  | Unit Price | Subtotal    | Notes        | Action  |  |
|  +----------------------------------------------------------------------------------------------+  |
|  | 1 | Flour Type A       | 500      | kg   | $1.20      | $600.00     | -            | [X]     |  |
|  |   | RM-FLOUR-001       |          |      |            |             |              |         |  |
|  +----------------------------------------------------------------------------------------------+  |
|  | 2 | Flour Type B       | 300      | kg   | $1.35      | $405.00     | -            | [X]     |  |
|  |   | RM-FLOUR-002       |          |      |            |             |              |         |  |
|  +----------------------------------------------------------------------------------------------+  |
|  | 3 | Salt Industrial    | 100      | kg   | $0.30      | $30.00      | Urgent order | [X]     |  |
|  |   | RM-SALT-001        |          |      |            |             |              |         |  |
|  +----------------------------------------------------------------------------------------------+  |
|  |                                                                                              |  |
|  |  [+ Add Line]                                                      Subtotal: $1,035.00 PLN  |  |
|  |                                                                                              |  |
|  +----------------------------------------------------------------------------------------------+  |
|                                                                                                    |
|  +----------------------------------------------------------------------------------------------+  |
|  |                                                                    [Cancel]    [Save Changes]|  |
|  +----------------------------------------------------------------------------------------------+  |
|                                                                                                    |
+--------------------------------------------------------------------------------------------------+
```

### Step 3: Validation Results

```
+--------------------------------------------------------------------------------------------------+
|                                    Import Purchase Orders                                    [X]  |
+--------------------------------------------------------------------------------------------------+
|                                                                                                    |
|  Step 3 of 4: Validation Results                                                                  |
|  ====================[====]------                                                                |
|   1         2           3           4                                                             |
|  Upload    Preview    Validate    Create                                                          |
|                                                                                                    |
|  +----------------------------------------------------------------------------------------------+  |
|  |  [!] 2 Issues Found (1 Error, 1 Warning)                             [Fix All] [Skip All]   |  |
|  +----------------------------------------------------------------------------------------------+  |
|                                                                                                    |
|  +-- ERRORS (must fix to continue) ----------------------------------------------------------+    |
|  |                                                                                            |    |
|  |  Row 8: Product Not Found                                                                 |    |
|  |  +--------------------------------------------------------------------------------------+ |    |
|  |  | product_code: "RM-YEAST-001" not found in product catalog                            | |    |
|  |  |                                                                                      | |    |
|  |  | Actions:                                                                             | |    |
|  |  | [Create Product]  [Map to Existing Product v]  [Remove Row]                          | |    |
|  |  |                                                                                      | |    |
|  |  | Mapped to: [Select product...                                             v]         | |    |
|  |  +--------------------------------------------------------------------------------------+ |    |
|  |                                                                                            |    |
|  +--------------------------------------------------------------------------------------------+    |
|                                                                                                    |
|  +-- WARNINGS (review recommended) ----------------------------------------------------------+    |
|  |                                                                                            |    |
|  |  Row 3: Non-Default Supplier                                                              |    |
|  |  +--------------------------------------------------------------------------------------+ |    |
|  |  | "Salt Industrial" has default supplier "Mill Co.", but file specified "Bulk Salt Co" | |    |
|  |  |                                                                                      | |    |
|  |  | Actions:                                                                             | |    |
|  |  | [Use File Supplier] [Use Default Supplier] [Ignore Warning]                          | |    |
|  |  +--------------------------------------------------------------------------------------+ |    |
|  |                                                                                            |    |
|  +--------------------------------------------------------------------------------------------+    |
|                                                                                                    |
|  +-- VALID ROWS -----------------------------------------------------------------------------+    |
|  |                                                                                            |    |
|  |  [OK] 13 of 15 rows validated successfully                                                |    |
|  |  [Show Valid Rows]                                                                        |    |
|  |                                                                                            |    |
|  +--------------------------------------------------------------------------------------------+    |
|                                                                                                    |
|  +----------------------------------------------------------------------------------------------+  |
|  |                                      [Back: Preview]    [Cancel]    [Next: Create POs]       |  |
|  |                                                         (Disabled until errors resolved)     |  |
|  +----------------------------------------------------------------------------------------------+  |
|                                                                                                    |
+--------------------------------------------------------------------------------------------------+
```

### Step 4: Create POs (Progress)

```
+--------------------------------------------------------------------------------------------------+
|                                    Import Purchase Orders                                    [X]  |
+--------------------------------------------------------------------------------------------------+
|                                                                                                    |
|  Step 4 of 4: Creating Purchase Orders                                                            |
|  ===============================[====]                                                           |
|   1         2           3           4                                                             |
|  Upload    Preview    Validate    Create                                                          |
|                                                                                                    |
|  +----------------------------------------------------------------------------------------------+  |
|  |                                                                                              |  |
|  |                              Creating Purchase Orders...                                    |  |
|  |                                                                                              |  |
|  |                    [==========================================--------]                     |  |
|  |                                      67% (2 of 3 POs)                                       |  |
|  |                                                                                              |  |
|  |  +----------------------------------------------------------------------------------------+ |  |
|  |  | [OK]  PO-2024-00158 | Mill Co.      | 3 lines | $1,035.00 PLN | Draft               | |  |
|  |  +----------------------------------------------------------------------------------------+ |  |
|  |  | [OK]  PO-2024-00159 | Sugar Inc.    | 2 lines | $520.00 EUR   | Draft               | |  |
|  |  +----------------------------------------------------------------------------------------+ |  |
|  |  | [...]  Creating PO for Pack Ltd...                                                     | |  |
|  |  +----------------------------------------------------------------------------------------+ |  |
|  |                                                                                              |  |
|  |                              Please wait, do not close this window.                         |  |
|  |                                                                                              |  |
|  +----------------------------------------------------------------------------------------------+  |
|                                                                                                    |
+--------------------------------------------------------------------------------------------------+
```

### Step 4: Complete (Full Success)

```
+--------------------------------------------------------------------------------------------------+
|                                    Import Purchase Orders                                    [X]  |
+--------------------------------------------------------------------------------------------------+
|                                                                                                    |
|  Step 4 of 4: Complete                                                                            |
|  =====================================[OK]                                                       |
|   1         2           3           4                                                             |
|  Upload    Preview    Validate    Create                                                          |
|                                                                                                    |
|  +----------------------------------------------------------------------------------------------+  |
|  |                                                                                              |  |
|  |                                      [Checkmark Icon]                                       |  |
|  |                                                                                              |  |
|  |                              Import Completed Successfully!                                 |  |
|  |                                                                                              |  |
|  |                      3 Purchase Orders created (10 line items)                              |  |
|  |                                                                                              |  |
|  |  +----------------------------------------------------------------------------------------+ |  |
|  |  | PO Number      | Supplier       | Lines | Total         | Status | Action             | |  |
|  |  +----------------------------------------------------------------------------------------+ |  |
|  |  | PO-2024-00158  | Mill Co.       | 3     | $1,035.00 PLN | Draft  | [View] [Submit]    | |  |
|  |  | PO-2024-00159  | Sugar Inc.     | 2     | $520.00 EUR   | Draft  | [View] [Submit]    | |  |
|  |  | PO-2024-00160  | Pack Ltd.      | 5     | $1,500.00 PLN | Draft  | [View] [Submit]    | |  |
|  |  +----------------------------------------------------------------------------------------+ |  |
|  |                                                                                              |  |
|  |                                 Total Value: $3,055.00                                      |  |
|  |                                                                                              |  |
|  |  +----------------------------------------------------------------------------------------+ |  |
|  |  |                                                                                        | |  |
|  |  |   What would you like to do next?                                                     | |  |
|  |  |                                                                                        | |  |
|  |  |   [Submit All POs]     [View PO List]     [Import More]     [Close]                   | |  |
|  |  |                                                                                        | |  |
|  |  +----------------------------------------------------------------------------------------+ |  |
|  |                                                                                              |  |
|  +----------------------------------------------------------------------------------------------+  |
|                                                                                                    |
+--------------------------------------------------------------------------------------------------+
```

### Step 4: Complete (Partial Failure)

```
+--------------------------------------------------------------------------------------------------+
|                                    Import Purchase Orders                                    [X]  |
+--------------------------------------------------------------------------------------------------+
|                                                                                                    |
|  Step 4 of 4: Complete with Errors                                                                |
|  =====================================[!]                                                        |
|   1         2           3           4                                                             |
|  Upload    Preview    Validate    Create                                                          |
|                                                                                                    |
|  +----------------------------------------------------------------------------------------------+  |
|  |                                                                                              |  |
|  |                                      [Warning Icon]                                         |  |
|  |                                                                                              |  |
|  |                        Import Completed with Errors                                         |  |
|  |                                                                                              |  |
|  |                  2 of 3 Purchase Orders created successfully                                |  |
|  |                  1 PO failed to create                                                      |  |
|  |                                                                                              |  |
|  |  +-- SUCCESSFUL -----------------------------------------------------------------+        |  |
|  |  |                                                                                |        |  |
|  |  |  +--------------------------------------------------------------------------+  |        |  |
|  |  |  | PO Number     | Supplier    | Lines | Total         | Status | Action   |  |        |  |
|  |  |  +--------------------------------------------------------------------------+  |        |  |
|  |  |  | PO-2024-00158 | Mill Co.    | 3     | $1,035.00 PLN | Draft  | [View]   |  |        |  |
|  |  |  | PO-2024-00159 | Sugar Inc.  | 2     | $520.00 EUR   | Draft  | [View]   |  |        |  |
|  |  |  +--------------------------------------------------------------------------+  |        |  |
|  |  |                                                                                |        |  |
|  |  +--------------------------------------------------------------------------------+        |  |
|  |                                                                                              |  |
|  |  +-- FAILED --------------------------------------------------------------------+        |  |
|  |  |                                                                                |        |  |
|  |  |  PO Group 3: Pack Ltd. (SUP-003)                                              |        |  |
|  |  |  +--------------------------------------------------------------------------+  |        |  |
|  |  |  | [X] Error: SUPPLIER_CREDIT_LIMIT_EXCEEDED                                |  |        |  |
|  |  |  |                                                                          |  |        |  |
|  |  |  | Supplier "Pack Ltd." has reached credit limit ($5,000.00).            |  |        |  |
|  |  |  | Current outstanding: $3,700.00                                           |  |        |  |
|  |  |  | Attempted PO total: $1,500.00                                            |  |        |  |
|  |  |  | Available credit: $300.00                                                |  |        |  |
|  |  |  |                                                                          |  |        |  |
|  |  |  | Resolution:                                                              |  |        |  |
|  |  |  | - Contact finance to increase credit limit                              |  |        |  |
|  |  |  | - Process payment to reduce outstanding balance                         |  |        |  |
|  |  |  | - Reduce PO quantity to fit within limit                                |  |        |  |
|  |  |  |                                                                          |  |        |  |
|  |  |  | [Retry] [Edit Group] [Skip]                                             |  |        |  |
|  |  |  +--------------------------------------------------------------------------+  |        |  |
|  |  |                                                                                |        |  |
|  |  +--------------------------------------------------------------------------------+        |  |
|  |                                                                                              |  |
|  |  Summary:                                                                                   |  |
|  |  - Successful: 2 POs | $1,555.00 total                                                     |  |
|  |  - Failed: 1 PO | $1,500.00 not created                                                    |  |
|  |                                                                                              |  |
|  |  +----------------------------------------------------------------------------------------+ |  |
|  |  |                                                                                        | |  |
|  |  |   What would you like to do next?                                                     | |  |
|  |  |                                                                                        | |  |
|  |  |   [Retry Failed POs]     [View Successful POs]     [Download Error Report]            | |  |
|  |  |   [Import More]     [Close]                                                           | |  |
|  |  |                                                                                        | |  |
|  |  +----------------------------------------------------------------------------------------+ |  |
|  |                                                                                              |  |
|  +----------------------------------------------------------------------------------------------+  |
|                                                                                                    |
+--------------------------------------------------------------------------------------------------+
```

### Error State - File Parse Failed

```
+--------------------------------------------------------------------------------------------------+
|                                    Import Purchase Orders                                    [X]  |
+--------------------------------------------------------------------------------------------------+
|                                                                                                    |
|  Step 1 of 4: Upload File                                                                         |
|  [====]---------------------------------------                                                    |
|                                                                                                    |
|  +----------------------------------------------------------------------------------------------+  |
|  |                                                                                              |  |
|  |                          +--------------------------------+                                  |  |
|  |                          |                                |                                  |  |
|  |                          |      [Error Icon]              |                                  |  |
|  |                          |                                |                                  |  |
|  |                          |   File could not be parsed     |                                  |  |
|  |                          |                                |                                  |  |
|  |                          |   Error: Invalid column header |                                  |  |
|  |                          |   "product_sku" - expected     |                                  |  |
|  |                          |   "product_code"               |                                  |  |
|  |                          |                                |                                  |  |
|  |                          +--------------------------------+                                  |  |
|  |                                                                                              |  |
|  |                          [Try Different File]  [Download Template]                           |  |
|  |                                                                                              |  |
|  +----------------------------------------------------------------------------------------------+  |
|  |                                                                    [Cancel]                   |  |
|  +----------------------------------------------------------------------------------------------+  |
|                                                                                                    |
+--------------------------------------------------------------------------------------------------+
```

### Mobile View - Step 2 Preview

```
+----------------------------------+
|        Import POs           [X]  |
+----------------------------------+
|                                  |
|  Step 2: Preview                 |
|  [==]----------------------      |
|                                  |
|  File: orders.xlsx (15 rows)     |
|  [Change]                        |
|                                  |
|  +----------------------------+  |
|  | Mill Co. (SUP-001)         |  |
|  | 3 items | $1,035.00 PLN    |  |
|  | Due: Dec 20                |  |
|  |                            |  |
|  | - Flour Type A  500kg      |  |
|  | - Flour Type B  300kg      |  |
|  | - Salt          100kg      |  |
|  |                            |  |
|  | [Edit Group]               |  |
|  +----------------------------+  |
|                                  |
|  +----------------------------+  |
|  | Sugar Inc. (SUP-002)       |  |
|  | 2 items | $520.00 EUR      |  |
|  | Due: Dec 18                |  |
|  |                            |  |
|  | - Sugar White   400kg      |  |
|  | - Sugar Brown   200kg      |  |
|  |                            |  |
|  | [Edit Group]               |  |
|  +----------------------------+  |
|                                  |
|  +----------------------------+  |
|  | Pack Ltd. (SUP-003)        |  |
|  | 5 items | $1,500.00 PLN    |  |
|  | Due: Dec 22                |  |
|  | [View Items] [Edit Group]  |  |
|  +----------------------------+  |
|                                  |
|  Summary:                        |
|  3 POs | 10 items | $3,055      |
|                                  |
|  +----------------------------+  |
|  | [Back]  [Validate ->]      |  |
|  +----------------------------+  |
|                                  |
+----------------------------------+
```

---

## Key Components

### 1. Progress Stepper

| Step | Name | Description |
|------|------|-------------|
| 1 | Upload | Upload Excel file or download template |
| 2 | Preview | Review parsed data grouped by supplier |
| 3 | Validate | Fix errors, review warnings |
| 4 | Create | Progress bar, results summary |

### 2. Template Format

| Column | Required | Type | Description | Validation |
|--------|----------|------|-------------|------------|
| product_code | Yes | String | Product code/SKU | Must exist in catalog |
| quantity | Yes | Number | Order quantity | > 0 |
| unit_price | No | Number | Unit price | >= 0 (defaults from supplier/product) |
| supplier_code | No | String | Override default supplier | Must exist if provided |
| expected_date | No | Date | Expected delivery (YYYY-MM-DD) | Must be >= today |
| notes | No | String | Line notes | Max 500 chars |

### 3. Edit Group Modal Fields

| Field | Type | Description | Editable |
|-------|------|-------------|----------|
| Supplier | Dropdown | Select supplier | Yes |
| Warehouse | Dropdown | Destination warehouse | Yes |
| Expected Date | Date | Delivery date | Yes |
| Payment Terms | Dropdown | Payment terms (Net 30, etc.) | Yes |
| Tax Code | Dropdown | Default tax code | Yes |
| Notes | Textarea | PO-level notes | Yes |
| Line Items | Table | List of products/quantities | Yes (add/remove) |

**Edit Group Actions**:
- **Change Supplier**: Recalculates pricing, expected date
- **Add Line**: Add additional product to group
- **Remove Line** (X): Remove product from group
- **Save Changes**: Updates group, recalculates subtotal
- **Cancel**: Discards changes

### 4. Supplier Grouping Logic

```typescript
// Algorithm for grouping import rows by supplier
function groupBySupplier(rows: ImportRow[]): POGroup[] {
  const groups = new Map<string, POGroup>();

  for (const row of rows) {
    // Get supplier: explicit from row OR default from product
    const supplierId = row.supplier_code
      ? await getSupplierByCode(row.supplier_code)
      : await getDefaultSupplier(row.product_code);

    if (!groups.has(supplierId)) {
      const supplier = await getSupplier(supplierId);
      groups.set(supplierId, {
        supplier,
        expectedDate: calculateExpectedDate(supplier.lead_time_days),
        lines: [],
        subtotal: 0
      });
    }

    const group = groups.get(supplierId)!;
    const line = await buildPOLine(row, supplier);
    group.lines.push(line);
    group.subtotal += line.line_total;
  }

  return Array.from(groups.values());
}
```

### 5. Validation Rules

| Validation | Type | Resolution Options |
|------------|------|---------------------|
| Product not found | Error | Create product, Map to existing, Remove row |
| Invalid quantity | Error | Fix in file, Edit inline |
| Supplier not found | Error | Create supplier, Map to existing, Remove row |
| Non-default supplier | Warning | Use file supplier, Use default, Ignore |
| Duplicate product (same PO) | Warning | Merge lines, Keep separate, Ignore |
| Price differs from catalog | Info | Use file price, Use catalog price |

### 6. Error Resolution Actions

| Action | Description | Result |
|--------|-------------|--------|
| **Create Product** | Opens quick product creation modal | New product created, row revalidated |
| **Map to Existing** | Dropdown to select existing product | Product code replaced, row revalidated |
| **Remove Row** | Exclude row from import | Row marked for skip |
| **Edit Inline** | Quick edit field in place | Value updated, row revalidated |
| **Skip All Warnings** | Accept all warnings | Continue with current values |

### 7. Partial Failure Error Types

| Error Code | Description | Resolution |
|------------|-------------|------------|
| SUPPLIER_CREDIT_LIMIT_EXCEEDED | Supplier credit limit reached | Increase limit, reduce order, pay balance |
| INSUFFICIENT_BUDGET | Org budget exceeded | Adjust budget, reduce order |
| DUPLICATE_PO_NUMBER | PO number collision | System retries with new number |
| VALIDATION_FAILED | Line validation failed during create | Edit group, fix data |
| DATABASE_ERROR | Database constraint violation | Retry, contact support |
| NETWORK_ERROR | Network timeout | Retry |

---

## Main Actions

### Step 1 Actions

| Action | Description |
|--------|-------------|
| **Drag & Drop** | Upload Excel file |
| **Browse** | Open file picker |
| **Download Template** | Download empty template with headers |
| **Cancel** | Close modal |
| **Next: Preview** | Parse file and proceed (disabled until file uploaded) |

### Step 2 Actions

| Action | Description |
|--------|-------------|
| **Change File** | Go back to upload new file |
| **Edit Group** | Opens Edit Group modal for PO group |
| **Back: Upload** | Return to step 1 |
| **Cancel** | Close modal |
| **Next: Validate** | Run validation checks |

### Step 3 Actions

| Action | Description |
|--------|-------------|
| **Fix All** | Auto-resolve all resolvable issues |
| **Skip All** | Skip all warnings (errors must be fixed) |
| **Individual resolution** | Per-row fix actions |
| **Back: Preview** | Return to step 2 |
| **Cancel** | Close modal |
| **Next: Create POs** | Proceed to creation (disabled if errors remain) |

### Step 4 Actions (Full Success)

| Action | Description |
|--------|-------------|
| **Submit All POs** | Submit all created POs for approval |
| **View PO List** | Navigate to PO list page |
| **Import More** | Reset wizard for another import |
| **Close** | Close modal |
| **View (per PO)** | Navigate to PO detail |
| **Submit (per PO)** | Submit individual PO |

### Step 4 Actions (Partial Failure)

| Action | Description |
|--------|-------------|
| **Retry Failed POs** | Retry creating failed POs |
| **View Successful POs** | Navigate to PO list filtered to created POs |
| **Download Error Report** | Download CSV with error details |
| **Edit Group** | Open Edit Group modal to fix failed PO |
| **Skip** | Ignore failed PO |
| **Import More** | Reset wizard for another import |
| **Close** | Close modal |

---

## States

| State | Description | Elements Shown |
|-------|-------------|----------------|
| **Step 1: Empty** | No file uploaded | Upload zone, template link |
| **Step 1: Uploading** | File being uploaded | Progress indicator |
| **Step 1: Parse Error** | File cannot be parsed | Error message, retry option |
| **Step 2: Preview** | Data parsed successfully | Grouped PO preview |
| **Step 3: Validating** | Running validation | Progress indicator |
| **Step 3: Has Errors** | Validation found errors | Error list, resolution options |
| **Step 3: Warnings Only** | Only warnings (no errors) | Warning list, Next enabled |
| **Step 3: All Valid** | No issues | Success message, Next enabled |
| **Step 4: Creating** | POs being created | Progress bar, per-PO status |
| **Step 4: Complete** | All POs created | Summary, next actions |
| **Step 4: Partial Failure** | Some POs failed | Success/failure breakdown, retry options |

---

## API Endpoints

### Upload and Parse File

```
POST /api/planning/purchase-orders/import/parse
Content-Type: multipart/form-data
Body: { file: <Excel file> }

Response:
{
  "success": true,
  "data": {
    "rows_parsed": 15,
    "groups": [
      {
        "supplier": {
          "id": "uuid-supplier-1",
          "code": "SUP-001",
          "name": "Mill Co.",
          "currency": "PLN",
          "lead_time_days": 7
        },
        "expected_date": "2024-12-20",
        "lines": [
          {
            "row_number": 1,
            "product_code": "RM-FLOUR-001",
            "product_name": "Flour Type A",
            "quantity": 500,
            "uom": "kg",
            "unit_price": 1.20,
            "line_total": 600.00,
            "notes": null
          },
          // ... more lines
        ],
        "subtotal": 1035.00
      },
      // ... more groups
    ],
    "total_value": 3055.00
  }
}
```

### Validate Import

```
POST /api/planning/purchase-orders/import/validate
Body: {
  "groups": [ ... parsed groups from step 2 ... ]
}

Response:
{
  "success": true,
  "data": {
    "valid_count": 13,
    "error_count": 1,
    "warning_count": 1,
    "issues": [
      {
        "row_number": 8,
        "type": "error",
        "code": "PRODUCT_NOT_FOUND",
        "message": "Product code \"RM-YEAST-001\" not found in catalog",
        "field": "product_code",
        "value": "RM-YEAST-001",
        "resolutions": [
          { "action": "create_product", "label": "Create Product" },
          { "action": "map_product", "label": "Map to Existing Product" },
          { "action": "remove_row", "label": "Remove Row" }
        ]
      },
      {
        "row_number": 3,
        "type": "warning",
        "code": "NON_DEFAULT_SUPPLIER",
        "message": "Salt Industrial has default supplier Mill Co., but file specified Bulk Salt Co",
        "field": "supplier_code",
        "value": "SUP-099",
        "resolutions": [
          { "action": "use_file", "label": "Use File Supplier" },
          { "action": "use_default", "label": "Use Default Supplier" },
          { "action": "ignore", "label": "Ignore Warning" }
        ]
      }
    ]
  }
}
```

### Create POs from Import

```
POST /api/planning/purchase-orders/bulk
Body: {
  "groups": [
    {
      "supplier_id": "uuid-supplier-1",
      "warehouse_id": "uuid-warehouse-main",
      "expected_delivery_date": "2024-12-20",
      "currency": "PLN",
      "tax_code_id": "uuid-tax-23",
      "lines": [
        {
          "product_id": "uuid-flour",
          "quantity": 500,
          "unit_price": 1.20,
          "tax_code_id": "uuid-tax-23"
        },
        // ... more lines
      ]
    },
    // ... more groups
  ]
}

Response (Full Success):
{
  "success": true,
  "data": {
    "created_count": 3,
    "failed_count": 0,
    "purchase_orders": [
      {
        "id": "uuid-po-158",
        "po_number": "PO-2024-00158",
        "supplier": { "id": "uuid-supplier-1", "name": "Mill Co." },
        "lines_count": 3,
        "total": 1035.00,
        "currency": "PLN",
        "status": "draft"
      },
      {
        "id": "uuid-po-159",
        "po_number": "PO-2024-00159",
        "supplier": { "id": "uuid-supplier-2", "name": "Sugar Inc." },
        "lines_count": 2,
        "total": 520.00,
        "currency": "EUR",
        "status": "draft"
      },
      {
        "id": "uuid-po-160",
        "po_number": "PO-2024-00160",
        "supplier": { "id": "uuid-supplier-3", "name": "Pack Ltd." },
        "lines_count": 5,
        "total": 1500.00,
        "currency": "PLN",
        "status": "draft"
      }
    ],
    "failed_orders": [],
    "total_value": 3055.00,
    "total_lines": 10
  }
}

Response (Partial Failure):
{
  "success": true,
  "data": {
    "created_count": 2,
    "failed_count": 1,
    "purchase_orders": [
      {
        "id": "uuid-po-158",
        "po_number": "PO-2024-00158",
        "supplier": { "id": "uuid-supplier-1", "name": "Mill Co." },
        "lines_count": 3,
        "total": 1035.00,
        "currency": "PLN",
        "status": "draft"
      },
      {
        "id": "uuid-po-159",
        "po_number": "PO-2024-00159",
        "supplier": { "id": "uuid-supplier-2", "name": "Sugar Inc." },
        "lines_count": 2,
        "total": 520.00,
        "currency": "EUR",
        "status": "draft"
      }
    ],
    "failed_orders": [
      {
        "group_index": 2,
        "supplier": { "id": "uuid-supplier-3", "name": "Pack Ltd." },
        "lines_count": 5,
        "total": 1500.00,
        "currency": "PLN",
        "error": {
          "code": "SUPPLIER_CREDIT_LIMIT_EXCEEDED",
          "message": "Supplier 'Pack Ltd.' has reached credit limit ($5,000.00)",
          "details": {
            "credit_limit": 5000.00,
            "current_outstanding": 3700.00,
            "attempted_amount": 1500.00,
            "available_credit": 300.00
          },
          "resolutions": [
            "Contact finance to increase credit limit",
            "Process payment to reduce outstanding balance",
            "Reduce PO quantity to fit within limit"
          ]
        }
      }
    ],
    "total_value": 1555.00,
    "total_lines": 5
  }
}
```

### Submit All Created POs

```
POST /api/planning/purchase-orders/bulk-submit
Body: {
  "po_ids": ["uuid-po-158", "uuid-po-159", "uuid-po-160"]
}

Response:
{
  "success": true,
  "data": {
    "submitted_count": 3,
    "results": [
      { "id": "uuid-po-158", "status": "pending_approval" },
      { "id": "uuid-po-159", "status": "submitted" },
      { "id": "uuid-po-160", "status": "pending_approval" }
    ]
  }
}
```

---

## Validation Rules

### File Validation

| Rule | Error Message |
|------|---------------|
| File type not xlsx/xls | "Unsupported file type. Please upload .xlsx or .xls file" |
| File size > 5MB | "File size exceeds 5MB limit" |
| No data rows | "File contains no data rows" |
| Missing required columns | "Missing required column: {column_name}" |
| Invalid column headers | "Invalid column header: {header}" |

### Row Validation

| Rule | Type | Error Message |
|------|------|---------------|
| product_code empty | Error | "Product code is required (row {n})" |
| product_code not found | Error | "Product \"{code}\" not found (row {n})" |
| quantity empty | Error | "Quantity is required (row {n})" |
| quantity <= 0 | Error | "Quantity must be greater than 0 (row {n})" |
| unit_price < 0 | Error | "Unit price cannot be negative (row {n})" |
| supplier_code not found | Error | "Supplier \"{code}\" not found (row {n})" |
| expected_date < today | Error | "Expected date must be in the future (row {n})" |
| non-default supplier | Warning | "Using non-default supplier for {product}" |
| duplicate product | Warning | "Product {code} appears multiple times in same PO" |
| price differs | Info | "Price differs from catalog ({file} vs {catalog})" |

---

## Business Rules

### Supplier Grouping

1. Rows without explicit supplier_code use product's default supplier
2. One PO is created per unique supplier
3. If product has no default supplier and no supplier_code provided, error

### Expected Date Calculation

```typescript
// For each PO group
expected_date = MAX(
  today + supplier.lead_time_days,
  MAX(row.expected_date for rows with explicit dates)
)
```

### Price Resolution Priority

1. Use explicit unit_price from file (if provided)
2. Use supplier_products.unit_price (supplier-specific pricing)
3. Use products.std_price (standard price)

### Currency Handling

- Each PO group inherits currency from supplier
- Mixed currencies result in separate POs
- File cannot specify currency per row

### Duplicate Product Handling

- Same product code multiple times in same PO group: Warn user
- Options: Merge quantities, Keep separate lines
- Default: Keep separate lines

### Partial Failure Handling

1. **Transaction per PO**: Each PO created in separate transaction
2. **Continue on failure**: If one PO fails, continue with remaining
3. **Report all results**: Show success + failure breakdown
4. **Retry option**: Allow retry of failed POs
5. **Error logging**: Log all failures with details

---

## Accessibility

### Touch Targets
- Upload zone: Full width, min 200px height
- Step navigation: 48dp height
- Action buttons: 48x48dp minimum
- Row action buttons: 48dp height
- Edit Group modal buttons: 48x48dp

### Contrast
- Progress stepper: Active step clearly distinguished
- Error/Warning badges: High contrast colors
- Table text: 4.5:1 minimum
- Modal text: 4.5:1 minimum

### Screen Reader
- Steps announced: "Step 2 of 4: Preview Data"
- File upload: "File upload zone, drag and drop or click to browse"
- Validation issues: "2 issues found, 1 error, 1 warning"
- Progress: "Creating purchase orders, 67 percent complete"
- Partial failure: "Import completed with errors, 2 of 3 purchase orders created"

### Keyboard Navigation
- Tab: Navigate between steps, fields, buttons
- Enter: Activate buttons, submit forms
- Escape: Close modal
- Arrow keys: Navigate validation issues

---

## Responsive Breakpoints

| Breakpoint | Layout |
|------------|--------|
| Desktop (>1024px) | Full width modal (max 900px), table view |
| Tablet (768-1024px) | Full width, condensed tables |
| Mobile (<768px) | Full-screen, card-based groups |

### Mobile-Specific
- Wizard steps shown as compact dots
- PO groups as expandable cards
- Validation issues as expandable list
- Action buttons stacked vertically
- Edit Group modal full-screen

---

## Performance Notes

### File Processing
- Parse on client-side using SheetJS (xlsx)
- Max 1000 rows per import (show error if exceeded)
- Progress indicator for large files

### API Calls
- Parse: Single call with file upload
- Validate: Single call with parsed data
- Create: Batch API call for all POs (parallel transactions)

### Caching
- Product lookups cached during import session
- Supplier lookups cached during import session

### Load Time Targets
- File upload: <2s for 5MB file
- Parse: <3s for 1000 rows
- Validation: <5s for 1000 rows
- PO creation: <10s for 50 POs
- Edit Group modal open: <200ms

---

## Testing Requirements

### Unit Tests
- Supplier grouping algorithm
- Expected date calculation
- Price resolution logic
- Validation rules (all error/warning types)
- Template column parsing
- Partial failure handling logic
- Edit Group modal state management

### Integration Tests
- POST /api/planning/purchase-orders/import/parse
- POST /api/planning/purchase-orders/import/validate
- POST /api/planning/purchase-orders/bulk (success case)
- POST /api/planning/purchase-orders/bulk (partial failure case)
- POST /api/planning/purchase-orders/bulk-submit

### E2E Tests
- Upload valid file, preview, validate, create
- Upload file with errors, resolve errors, create
- Upload file with warnings, skip warnings, create
- Edit PO group before creation
- Submit all POs after creation
- Handle partial failure scenario
- Retry failed PO creation
- Download template, fill, upload
- Mobile responsive flow
- Large file (500 rows) performance

### Performance Tests
- Parse 1000-row file in <5s
- Create 50 POs in <10s
- Handle 10 concurrent imports

---

## Quality Gates

Before handoff to FRONTEND-DEV:
- [x] All 4 wizard steps defined
- [x] Edit Group modal wireframe complete
- [x] File parsing logic documented
- [x] Supplier grouping algorithm specified
- [x] All validation rules listed with resolution options
- [x] Error handling for file upload failures
- [x] Partial failure state wireframe complete
- [x] Partial failure API response structure documented
- [x] API endpoints documented
- [x] Mobile responsive design
- [x] Accessibility requirements met
- [x] Performance targets defined

---

## Handoff to FRONTEND-DEV

```yaml
feature: PO Bulk Import Modal
story: PLAN-007
fr_coverage: FR-PLAN-008
approval_status:
  mode: "review_each"
  user_approved: false  # PENDING USER REVIEW
deliverables:
  wireframe: docs/3-ARCHITECTURE/ux/wireframes/PLAN-007-po-bulk-import.md
  api_endpoints:
    - POST /api/planning/purchase-orders/import/parse
    - POST /api/planning/purchase-orders/import/validate
    - POST /api/planning/purchase-orders/bulk
    - POST /api/planning/purchase-orders/bulk-submit
wizard_steps: [upload, preview, validate, create]
modals: [edit_group]
states_per_step:
  upload: [empty, uploading, parse_error, success]
  preview: [loading, success]
  validate: [validating, has_errors, warnings_only, all_valid]
  create: [creating, complete_success, complete_partial_failure]
breakpoints:
  mobile: "<768px (full-screen, card layout)"
  tablet: "768-1024px (condensed)"
  desktop: ">1024px (max 900px modal)"
file_limits:
  max_size: "5MB"
  max_rows: 1000
  supported_types: [".xlsx", ".xls"]
partial_failure_handling:
  transaction_model: "per_po"
  continue_on_error: true
  retry_enabled: true
accessibility:
  touch_targets: "48dp minimum"
  contrast: "4.5:1 minimum"
performance_targets:
  file_parse: "<3s for 1000 rows"
  validation: "<5s for 1000 rows"
  po_creation: "<10s for 50 POs"
  edit_modal_open: "<200ms"
related_screens:
  - PLAN-004: PO List Page
  - PLAN-005: PO Create/Edit Modal
```

---

**Status**: Ready for Implementation
**Approval Mode**: review_each (default)
**User Approved**: Pending
**Iterations**: 0 of 3
**Estimated Effort**: 18-22 hours
**Quality Target**: 97/100
