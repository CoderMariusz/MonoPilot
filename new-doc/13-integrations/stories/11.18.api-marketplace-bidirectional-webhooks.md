# 11.18 - API Marketplace & Bi-directional Webhooks

**Priority**: P2 (Phase 3 Enterprise)
**Story Points**: M (Medium)
**Type**: fullstack
**Phase**: 3
**Model**: OPUS

**State:** ready
**Estimate:** M (3-4 days)
**Primary PRD:** `docs/1-BASELINE/product/modules/integrations.md` (FR-INT-029, FR-INT-030, Section 4.2)
**Architecture:** Public API directory, bi-directional webhooks, inbound HTTP POST handler, webhook auth verification

---

## Goal

Create a public API marketplace showcasing MonoPilot's integration capabilities and enable bi-directional webhooks (inbound HTTP POST from external systems). The marketplace serves as a developer portal with API documentation, SDKs, and integration examples. Bi-directional webhooks allow external systems to push data to MonoPilot (e.g., inventory updates from WMS, order status from 3PL).

---

## MVP Scope

**MVP Includes**:
- Public API marketplace (developer portal)
- API endpoint directory (all public endpoints documented)
- Interactive API explorer (Swagger/OpenAPI UI)
- Webhook inbound receiver (POST /api/webhooks/inbound/:webhook_id)
- Webhook signature verification (HMAC validation)
- Webhook response handling (200 OK, retry on failure)
- Webhook routing (route to internal handlers based on event type)
- Webhook security (API key or HMAC verification)
- Marketplace landing page (public, no auth)

**Deferred to Phase 4**:
- SDK generation (JavaScript, Python, PHP)
- Webhook retry policy configuration
- Webhook transformation pipeline
- Rate limiting per webhook
- Webhook analytics dashboard

---

## User Story

As a **Developer**, I want to **browse MonoPilot's API marketplace and discover available endpoints** so that **I can build custom integrations and understand API capabilities**.

As an **External System**, I want to **send webhook events to MonoPilot (inbound)** so that **I can push inventory updates, order statuses, or alerts without polling APIs**.

As a **System Administrator**, I want to **configure inbound webhooks with authentication** so that **only authorized systems can send data to MonoPilot**.

---

## Scope

**In scope (this story)**
- API marketplace landing page (public)
- API directory (list all public endpoints)
- Interactive API explorer (Swagger UI)
- Inbound webhook receiver endpoint
- Webhook signature verification (HMAC-SHA256)
- Webhook routing to internal handlers
- inbound_webhooks table (configuration)
- inbound_webhook_logs table (audit trail)
- GET /api/marketplace (public API directory)
- GET /api/marketplace/docs (OpenAPI spec)
- POST /api/webhooks/inbound/:webhook_id (inbound receiver)
- POST /api/integrations/webhooks/inbound (create inbound webhook config)

**Out of scope (this story)**
- SDK generation (Phase 4)
- Advanced webhook transformations (Phase 4)
- Public integration examples repository (Phase 4)
- Webhook analytics (Phase 4)

---

## Dependencies

### Cross-Epic Dependencies

| Dependency | Story/Epic | Type | What It Provides | Status |
|------------|------------|------|------------------|--------|
| 01.1 | Org Context + RLS | HARD | organizations, users | Ready |

### Within Epic Dependencies

| Dependency | Story | Type | What It Provides |
|------------|-------|------|------------------|
| 11.2 | API Keys Management | HARD | API key authentication patterns | Ready |
| 11.3 | Integration Logs | HARD | integration_logs table | Ready |
| 11.4 | Webhook Configuration | HARD | Webhook patterns (outbound) | Ready |

### Provides To (Downstream)

| Story | What This Provides |
|-------|-------------------|
| Phase 4 | Foundation for public integration ecosystem |

---

## Database Schema

### inbound_webhooks Table

```sql
-- Migration: YYYYMMDDHHMMSS_create_inbound_webhooks.sql

CREATE TABLE inbound_webhooks (
    -- Identity
    id                      UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id                  UUID NOT NULL REFERENCES organizations(id),
    webhook_id              TEXT NOT NULL,              -- Public webhook ID (in URL)
    name                    TEXT NOT NULL,

    -- Configuration
    event_type              TEXT NOT NULL,              -- What this webhook handles
    handler_type            TEXT NOT NULL               -- 'inventory_update', 'order_status', 'custom', etc.
                            CHECK (handler_type IN ('inventory_update', 'order_status', 'shipment_tracking', 'custom')),
    custom_handler_config   JSONB,                      -- For custom handlers

    -- Security
    auth_type               TEXT NOT NULL DEFAULT 'hmac'
                            CHECK (auth_type IN ('hmac', 'api_key', 'basic_auth', 'none')),
    secret                  TEXT,                       -- HMAC secret or API key
    allowed_ips             TEXT[],                     -- IP whitelist (optional)

    -- Processing
    status                  TEXT NOT NULL DEFAULT 'active'
                            CHECK (status IN ('active', 'paused', 'disabled')),
    auto_process            BOOLEAN DEFAULT true,       -- Auto-process or queue for manual review

    -- Stats
    last_received_at        TIMESTAMPTZ,
    receive_count           INTEGER DEFAULT 0,
    success_count           INTEGER DEFAULT 0,
    error_count             INTEGER DEFAULT 0,

    -- Audit
    created_at              TIMESTAMPTZ NOT NULL DEFAULT now(),
    created_by              UUID REFERENCES users(id),
    updated_at              TIMESTAMPTZ NOT NULL DEFAULT now(),

    -- Constraints
    CONSTRAINT uq_webhook_id UNIQUE (webhook_id)
);

CREATE TABLE inbound_webhook_logs (
    -- Identity
    id                      UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id                  UUID NOT NULL REFERENCES organizations(id),
    webhook_id              UUID NOT NULL REFERENCES inbound_webhooks(id) ON DELETE CASCADE,

    -- Request
    received_at             TIMESTAMPTZ NOT NULL DEFAULT now(),
    request_method          TEXT NOT NULL,
    request_headers         JSONB,
    request_body            JSONB,
    source_ip               INET,

    -- Authentication
    auth_verified           BOOLEAN,
    auth_error              TEXT,

    -- Processing
    status                  TEXT NOT NULL DEFAULT 'pending'
                            CHECK (status IN ('pending', 'success', 'error', 'ignored')),
    processing_started_at   TIMESTAMPTZ,
    processing_completed_at TIMESTAMPTZ,
    processing_duration_ms  INTEGER,

    -- Result
    response_status         INTEGER,
    response_body           JSONB,
    error_message           TEXT,
    handler_result          JSONB,                      -- Data created/updated by handler

    -- Audit
    created_at              TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- Indexes
CREATE INDEX idx_inbound_webhooks_org ON inbound_webhooks(org_id);
CREATE INDEX idx_inbound_webhooks_id ON inbound_webhooks(webhook_id);
CREATE INDEX idx_inbound_logs_webhook ON inbound_webhook_logs(webhook_id);
CREATE INDEX idx_inbound_logs_org_status ON inbound_webhook_logs(org_id, status);
CREATE INDEX idx_inbound_logs_date ON inbound_webhook_logs(org_id, received_at);

-- RLS
ALTER TABLE inbound_webhooks ENABLE ROW LEVEL SECURITY;
ALTER TABLE inbound_webhook_logs ENABLE ROW LEVEL SECURITY;

CREATE POLICY "inbound_webhooks_org" ON inbound_webhooks
    FOR ALL TO authenticated
    USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

CREATE POLICY "inbound_logs_org" ON inbound_webhook_logs
    FOR ALL TO authenticated
    USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

-- Triggers
CREATE TRIGGER update_inbound_webhooks_updated_at
    BEFORE UPDATE ON inbound_webhooks
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();
```

---

## Acceptance Criteria (Given/When/Then)

### AC-1: API Marketplace Landing Page

```gherkin
Scenario: Public marketplace page
  Given user navigates to /marketplace (public, no auth)
  When page loads
  Then landing page shows:
    | Section | Content |
    | Hero | "MonoPilot API - Connect Anything" |
    | Features | API endpoints count, uptime, rate limits |
    | Quick Start | API key setup, first request example |
    | Categories | Products, Orders, Production, Warehouse, etc. |
    | Developer Resources | Docs, Swagger UI, Postman collection |
  And no authentication required for viewing

Scenario: API endpoint directory
  Given marketplace page
  When clicking [Browse APIs]
  Then directory shows categorized endpoints:
    | Category | Endpoints |
    | Products | GET /api/technical/products, POST /api/technical/products, etc. |
    | Orders | GET /api/planning/orders, etc. |
    | Warehouse | GET /api/warehouse/inventory, etc. |
  And each endpoint shows:
    - Method, Path
    - Description
    - Authentication required (yes/no)
    - Rate limit
    - [Try it] button
```

### AC-2: Interactive API Explorer (Swagger UI)

```gherkin
Scenario: Swagger UI integration
  Given marketplace page
  When clicking [API Explorer]
  Then Swagger UI loads with MonoPilot OpenAPI spec
  And all public endpoints listed
  And user can:
    - Expand endpoint to see parameters, request/response schemas
    - Click [Try it out]
    - Enter API key (from /integrations/api-keys)
    - Execute request
    - See live response

Scenario: OpenAPI spec generation
  Given MonoPilot has 99 API endpoints
  When generating OpenAPI spec
  Then GET /api/marketplace/docs returns:
    - OpenAPI 3.0 JSON
    - All public endpoints documented
    - Request/response schemas (Zod -> JSON Schema)
    - Authentication schemes (Bearer token)
  And spec validates against OpenAPI 3.0 standard
```

### AC-3: Inbound Webhook Configuration

```gherkin
Scenario: Create inbound webhook
  Given admin navigates to /integrations/webhooks/inbound
  And clicks [+ New Inbound Webhook]
  When form filled:
    | Field | Value |
    | Name | WMS Inventory Update |
    | Event Type | inventory.updated |
    | Handler | Inventory Update |
    | Auth Type | HMAC-SHA256 |
    | Secret | Auto-generated or custom |
    | Auto Process | Yes |
  And clicks [Create]
  Then inbound_webhooks entry created with:
    - webhook_id: auto-generated (e.g., "wh_abc123def456")
    - secret: generated HMAC secret
    - status: active
  And webhook URL shown: POST /api/webhooks/inbound/wh_abc123def456
  And secret displayed once (copy to clipboard)

Scenario: Webhook URL format
  Given inbound webhook created with webhook_id = "wh_abc123"
  Then public URL is: https://app.monopilot.app/api/webhooks/inbound/wh_abc123
  And external systems POST to this URL
```

### AC-4: Inbound Webhook Receiver

```gherkin
Scenario: Receive inbound webhook with HMAC auth
  Given inbound webhook configured with auth_type = 'hmac'
  And secret = "my_secret_key"
  When external system POSTs to /api/webhooks/inbound/wh_abc123:
    | Headers | Value |
    | Content-Type | application/json |
    | X-MonoPilot-Signature | sha256={hmac_signature} |
    | X-MonoPilot-Event | inventory.updated |
  And body:
    {
      "event": "inventory.updated",
      "timestamp": "2025-01-15T10:00:00Z",
      "data": {
        "product_code": "SKU-001",
        "location": "A1-01-01",
        "quantity": 1000,
        "source": "WMS"
      }
    }
  Then MonoPilot:
    1. Verifies HMAC signature
    2. Logs request to inbound_webhook_logs
    3. Routes to inventory_update handler
    4. Updates inventory in MonoPilot
    5. Returns 200 OK with { "status": "received" }

Scenario: HMAC signature verification
  Given webhook with secret = "my_secret"
  When external system sends request
  Then MonoPilot computes HMAC:
    - Algorithm: HMAC-SHA256
    - Key: secret
    - Data: raw request body (JSON string)
    - Expected: sha256={computed_hmac}
  And compares with X-MonoPilot-Signature header
  And if match: auth_verified = true
  And if mismatch: return 401 Unauthorized

Scenario: Invalid signature
  Given webhook with HMAC auth
  When request with invalid signature
  Then return 401 Unauthorized
  And log entry with auth_verified = false
  And error_message = "Invalid HMAC signature"
  And request not processed
```

### AC-5: Webhook Handlers

```gherkin
Scenario: Inventory update handler
  Given inbound webhook with handler_type = 'inventory_update'
  When webhook received with data:
    {
      "product_code": "SKU-001",
      "location": "A1-01-01",
      "quantity": 1000
    }
  Then handler:
    1. Finds product by product_code
    2. Finds location by location_code
    3. Updates inventory level (or creates if not exists)
    4. Logs update to inventory_audit_log
  And response includes:
    {
      "status": "success",
      "inventory_updated": true,
      "product_id": "uuid",
      "location_id": "uuid",
      "new_quantity": 1000
    }

Scenario: Order status handler
  Given inbound webhook with handler_type = 'order_status'
  When webhook received with data:
    {
      "order_number": "WO-2025-001",
      "status": "completed",
      "completed_at": "2025-01-15T14:30:00Z"
    }
  Then handler:
    1. Finds work order by order_number
    2. Updates status to 'completed'
    3. Sets completed_at timestamp
  And response includes updated work order ID

Scenario: Custom handler
  Given inbound webhook with handler_type = 'custom'
  And custom_handler_config = { "action": "log_only" }
  When webhook received
  Then data logged to inbound_webhook_logs
  And no further processing (manual review required)
  And response: { "status": "queued" }
```

### AC-6: Error Handling

```gherkin
Scenario: Handler processing error
  Given inventory update webhook
  When webhook received but product not found
  Then return 422 Unprocessable Entity
  And error response:
    {
      "status": "error",
      "error": "Product not found",
      "details": { "product_code": "SKU-999" }
    }
  And log entry with status = 'error'

Scenario: Invalid request body
  Given webhook expects JSON
  When request with invalid JSON
  Then return 400 Bad Request
  And error: "Invalid JSON body"

Scenario: Webhook paused
  Given webhook with status = 'paused'
  When request received
  Then return 503 Service Unavailable
  And error: "Webhook is paused"
```

### AC-7: Webhook Logs UI

```gherkin
Scenario: View inbound webhook logs
  Given 50 inbound webhook requests received
  When admin navigates to /integrations/webhooks/inbound/:id/logs
  Then DataTable shows:
    | Column | Content |
    | Received At | Timestamp |
    | Event Type | From X-MonoPilot-Event header |
    | Source IP | Request IP |
    | Status | Badge (success/error) |
    | Duration | Processing time |
    | Actions | View Details |
  And filters: Status, Date range, Event type

Scenario: View log entry details
  Given log entry with status = 'error'
  When clicking [View Details]
  Then modal shows:
    | Section | Content |
    | Request | Headers, body (JSON) |
    | Authentication | Verified (yes/no), signature |
    | Processing | Handler used, duration |
    | Result | Response status, body, error message |
    | Handler Result | Data created/updated |
  And [Retry] button for failed requests
```

### AC-8: API Marketplace Features

```gherkin
Scenario: Rate limit information
  Given marketplace directory
  When viewing endpoint details
  Then rate limit shown:
    | Tier | Requests/Min |
    | Basic | 60 |
    | Standard | 300 |
    | Premium | 1000 |
  And link to /integrations/api-keys to check current tier

Scenario: Postman collection download
  Given marketplace page
  When clicking [Download Postman Collection]
  Then JSON file downloaded with:
    - All public endpoints
    - Example requests
    - Variables for base URL, API key
  And user can import to Postman

Scenario: cURL examples
  Given endpoint in directory
  When viewing details
  Then cURL example shown:
    curl -X GET "https://api.monopilot.app/api/technical/products" \
      -H "Authorization: Bearer YOUR_API_KEY"
  And copy button available
```

### AC-9: Security

```gherkin
Scenario: IP whitelist
  Given inbound webhook with allowed_ips = ['192.168.1.100', '10.0.0.0/24']
  When request from 192.168.1.100
  Then request processed
  When request from 192.168.1.200
  Then return 403 Forbidden
  And error: "IP not whitelisted"

Scenario: API key authentication (alternative to HMAC)
  Given inbound webhook with auth_type = 'api_key'
  When request with header:
    Authorization: Bearer {api_key}
  Then validate API key
  And if valid, process request
  And if invalid, return 401 Unauthorized
```

### AC-10: Audit Trail

```gherkin
Scenario: All inbound requests logged
  Given any inbound webhook request
  Then inbound_webhook_logs entry created with:
    | Field | Value |
    | webhook_id | Webhook config ID |
    | request_method | POST |
    | request_headers | All headers (JSON) |
    | request_body | Body (JSON) |
    | source_ip | Request IP |
    | auth_verified | true/false |
    | status | pending/success/error |
    | processing_duration_ms | Time taken |
  And retention: 90 days
```

---

## Implementation Notes

### HMAC Signature Verification

```typescript
// lib/utils/hmac-verification.ts

import crypto from 'crypto';

export function verifyHMACSignature(
  body: string,
  signature: string,
  secret: string
): boolean {
  // Compute HMAC
  const computedSignature = crypto
    .createHmac('sha256', secret)
    .update(body)
    .digest('hex');

  const expectedSignature = `sha256=${computedSignature}`;

  // Constant-time comparison to prevent timing attacks
  return crypto.timingSafeEqual(
    Buffer.from(signature),
    Buffer.from(expectedSignature)
  );
}
```

### Inbound Webhook Handler Registry

```typescript
// lib/services/inbound-webhook-handlers.ts

type WebhookHandler = (
  data: any,
  webhookConfig: InboundWebhook
) => Promise<WebhookHandlerResult>;

const handlerRegistry: Record<string, WebhookHandler> = {
  inventory_update: async (data) => {
    const { product_code, location, quantity } = data;
    // Update inventory logic
    return { success: true, inventory_updated: true };
  },

  order_status: async (data) => {
    const { order_number, status } = data;
    // Update order status logic
    return { success: true, order_updated: true };
  },

  custom: async (data, config) => {
    // Custom handler based on config
    return { success: true, queued: true };
  },
};

export function getHandler(handlerType: string): WebhookHandler | null {
  return handlerRegistry[handlerType] || null;
}
```

### OpenAPI Spec Generation

```typescript
// lib/utils/openapi-generator.ts

export function generateOpenAPISpec(): OpenAPISpec {
  return {
    openapi: '3.0.0',
    info: {
      title: 'MonoPilot API',
      version: '1.0.0',
      description: 'Food Manufacturing MES API',
    },
    servers: [
      { url: 'https://api.monopilot.app', description: 'Production' },
    ],
    paths: {
      '/api/technical/products': {
        get: {
          summary: 'List products',
          tags: ['Products'],
          security: [{ bearerAuth: [] }],
          responses: {
            200: {
              description: 'Successful response',
              content: {
                'application/json': {
                  schema: { /* Generated from Zod schema */ },
                },
              },
            },
          },
        },
      },
      // ... all other endpoints
    },
    components: {
      securitySchemes: {
        bearerAuth: {
          type: 'http',
          scheme: 'bearer',
          bearerFormat: 'API Key',
        },
      },
    },
  };
}
```

---

## Deliverables

### Database
- [ ] inbound_webhooks table
- [ ] inbound_webhook_logs table

### Backend
- [ ] Inbound webhook receiver endpoint (POST /api/webhooks/inbound/:webhook_id)
- [ ] HMAC signature verification
- [ ] Webhook handler registry (inventory_update, order_status, custom)
- [ ] OpenAPI spec generator
- [ ] GET /api/marketplace (public endpoint directory)
- [ ] GET /api/marketplace/docs (OpenAPI JSON)
- [ ] POST /api/integrations/webhooks/inbound (create inbound webhook)
- [ ] GET /api/integrations/webhooks/inbound (list)
- [ ] GET /api/integrations/webhooks/inbound/:id/logs

### Frontend
- [ ] API marketplace landing page (public)
- [ ] API directory (categorized endpoints)
- [ ] Swagger UI integration
- [ ] Inbound webhooks list
- [ ] Create inbound webhook form
- [ ] Inbound webhook logs table
- [ ] Log entry detail modal

### Tests
- [ ] Unit: HMAC signature verification
- [ ] Unit: Webhook handlers (inventory, order status)
- [ ] Integration: Inbound webhook receiver
- [ ] Integration: OpenAPI spec generation
- [ ] E2E: Full inbound webhook flow

---

## Definition of Done

- [ ] API marketplace landing page live (public access)
- [ ] API directory shows all public endpoints
- [ ] Swagger UI functional with live API explorer
- [ ] OpenAPI spec accurate and validates
- [ ] Inbound webhook receiver accepts POST requests
- [ ] HMAC signature verification working
- [ ] Webhook handlers process data correctly
- [ ] Inbound webhooks configurable via UI
- [ ] Webhook logs capture all requests
- [ ] Error handling for all scenarios
- [ ] Unit tests >80% coverage
- [ ] E2E tests pass

---

## Risk Assessment

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| HMAC timing attacks | MEDIUM | LOW | Use constant-time comparison (crypto.timingSafeEqual) |
| DDoS on public webhook endpoint | HIGH | MEDIUM | Rate limiting per IP, webhook ID validation |
| Invalid webhook data | MEDIUM | HIGH | Schema validation, error responses, logging |
| Handler processing failures | MEDIUM | MEDIUM | Try-catch, rollback, error logging, retry queue |
| OpenAPI spec maintenance | LOW | HIGH | Auto-generate from code, validate in CI/CD |

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2026-01-15 | Initial Phase 3 story - API marketplace & bi-directional webhooks | ARCHITECT-AGENT |

---

**Document Status**: Ready for Implementation
**Created**: 2026-01-15
**Lines**: ~580
**Complexity**: M (Medium - 3-4 days)
**Phase**: 3 (Enterprise)
