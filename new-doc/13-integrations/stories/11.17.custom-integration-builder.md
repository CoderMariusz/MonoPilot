# 11.17 - Custom Integration Builder

**Priority**: P2 (Phase 3 Enterprise)
**Story Points**: L (Large)
**Type**: fullstack
**Phase**: 3
**Model**: OPUS

**State:** ready
**Estimate:** L (4-5 days)
**Primary PRD:** `docs/1-BASELINE/product/modules/integrations.md` (FR-INT-028, Section 4.2)
**Architecture:** Low-code workflow builder, connector library, field mapping, test mode, template system

---

## Goal

Provide a low-code visual integration builder for users to create custom integrations without coding. Users can drag-and-drop workflow steps (trigger -> actions -> connectors), map fields between systems, test in sandbox mode, and save reusable templates. Empowers non-technical users to integrate MonoPilot with internal systems, custom APIs, and third-party services.

---

## MVP Scope

**MVP Includes**:
- Visual workflow builder (drag-and-drop canvas)
- Connector library (REST API, SOAP, FTP, Email, Webhook)
- Field mapping UI (source field -> target field with transformations)
- Test mode (run workflow with sample data)
- Template library (save/load common workflows)
- Trigger types (schedule, event, manual)
- Action types (HTTP request, data transform, conditional logic)
- Workflow execution logs
- Workflow enable/disable toggle

**Deferred to Phase 4**:
- Advanced connectors (SFTP, GraphQL, Kafka)
- Complex transformations (JavaScript code blocks)
- Multi-step conditional branching
- Error recovery workflows
- Workflow versioning

---

## User Story

As a **System Administrator**, I want to **build custom integrations using a visual workflow builder** so that **I can connect MonoPilot to internal systems without writing code or waiting for IT**.

As an **Integration Specialist**, I want to **create reusable integration templates** so that **other organizations can quickly deploy common integrations (e.g., sync products to Shopify, push orders to WMS)**.

---

## Scope

**In scope (this story)**
- Workflow builder UI (React Flow or similar)
- Connector nodes (REST API, SOAP, FTP, Email, Webhook)
- Trigger nodes (schedule, event, manual)
- Action nodes (HTTP request, data transform, conditional)
- Field mapping UI with drag-drop
- Test mode (sandbox execution)
- Template CRUD (save, load, share)
- POST /api/integrations/workflows (create workflow)
- PUT /api/integrations/workflows/:id (update)
- POST /api/integrations/workflows/:id/execute (manual run)
- GET /api/integrations/workflows/:id/logs (execution history)
- integration_workflows table
- workflow_executions table
- workflow_templates table

**Out of scope (this story)**
- Advanced connectors (SFTP, GraphQL, Kafka) - Phase 4
- JavaScript code blocks - Phase 4
- Workflow versioning - Phase 4
- Public template marketplace - Phase 4

---

## Dependencies

### Cross-Epic Dependencies

| Dependency | Story/Epic | Type | What It Provides | Status |
|------------|------------|------|------------------|--------|
| 01.1 | Org Context + RLS | HARD | organizations, users | Ready |

### Within Epic Dependencies

| Dependency | Story | Type | What It Provides |
|------------|-------|------|------------------|
| 11.3 | Integration Logs | HARD | integration_logs table | Ready |
| 11.4 | Webhook Configuration | SOFT | Webhook patterns | Ready |

### Provides To (Downstream)

| Story | What This Provides |
|-------|-------------------|
| Phase 4 | Custom integration framework for advanced use cases |

---

## Database Schema

### integration_workflows Table

```sql
-- Migration: YYYYMMDDHHMMSS_create_integration_workflows.sql

CREATE TABLE integration_workflows (
    -- Identity
    id                      UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id                  UUID NOT NULL REFERENCES organizations(id),
    name                    TEXT NOT NULL,
    description             TEXT,

    -- Workflow Definition (JSON)
    workflow_definition     JSONB NOT NULL,          -- Nodes, edges, config
    field_mappings          JSONB,                   -- Field mapping rules

    -- Trigger
    trigger_type            TEXT NOT NULL
                            CHECK (trigger_type IN ('schedule', 'event', 'manual')),
    trigger_config          JSONB,                   -- Cron, event name, etc.

    -- Status
    status                  TEXT NOT NULL DEFAULT 'draft'
                            CHECK (status IN ('draft', 'active', 'paused', 'error')),
    enabled                 BOOLEAN DEFAULT false,

    -- Template
    is_template             BOOLEAN DEFAULT false,
    template_category       TEXT,                    -- 'ecommerce', 'wms', 'accounting', etc.

    -- Execution Stats
    last_executed_at        TIMESTAMPTZ,
    execution_count         INTEGER DEFAULT 0,
    success_count           INTEGER DEFAULT 0,
    error_count             INTEGER DEFAULT 0,

    -- Audit
    created_at              TIMESTAMPTZ NOT NULL DEFAULT now(),
    created_by              UUID REFERENCES users(id),
    updated_at              TIMESTAMPTZ NOT NULL DEFAULT now(),
    updated_by              UUID REFERENCES users(id),

    -- Constraints
    CONSTRAINT uq_workflow_name UNIQUE (org_id, name)
);

CREATE TABLE workflow_executions (
    -- Identity
    id                      UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id                  UUID NOT NULL REFERENCES organizations(id),
    workflow_id             UUID NOT NULL REFERENCES integration_workflows(id) ON DELETE CASCADE,

    -- Execution
    trigger_type            TEXT NOT NULL,           -- schedule, event, manual
    triggered_by            UUID REFERENCES users(id),
    started_at              TIMESTAMPTZ NOT NULL DEFAULT now(),
    completed_at            TIMESTAMPTZ,
    duration_ms             INTEGER,

    -- Status
    status                  TEXT NOT NULL DEFAULT 'running'
                            CHECK (status IN ('running', 'success', 'partial_success', 'error')),

    -- Input/Output
    input_data              JSONB,                   -- Trigger data
    output_data             JSONB,                   -- Result data
    error_message           TEXT,
    error_details           JSONB,                   -- Stack trace, failed node

    -- Step Results
    step_results            JSONB,                   -- Array of step execution results

    -- Audit
    created_at              TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE TABLE workflow_templates (
    -- Identity
    id                      UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name                    TEXT NOT NULL,
    description             TEXT,
    category                TEXT NOT NULL,           -- 'ecommerce', 'wms', 'accounting', etc.

    -- Template Definition
    workflow_definition     JSONB NOT NULL,
    field_mappings          JSONB,
    default_config          JSONB,

    -- Metadata
    version                 TEXT DEFAULT '1.0',
    author                  TEXT,
    tags                    TEXT[],
    icon                    TEXT,                    -- Icon name or URL

    -- Usage Stats
    install_count           INTEGER DEFAULT 0,
    rating                  DECIMAL(3,2),

    -- Audit
    created_at              TIMESTAMPTZ NOT NULL DEFAULT now(),
    updated_at              TIMESTAMPTZ NOT NULL DEFAULT now(),
    published               BOOLEAN DEFAULT false
);

-- Indexes
CREATE INDEX idx_workflows_org ON integration_workflows(org_id);
CREATE INDEX idx_workflows_status ON integration_workflows(org_id, status);
CREATE INDEX idx_workflows_enabled ON integration_workflows(org_id) WHERE enabled = true;
CREATE INDEX idx_executions_workflow ON workflow_executions(workflow_id);
CREATE INDEX idx_executions_org_status ON workflow_executions(org_id, status);
CREATE INDEX idx_executions_date ON workflow_executions(org_id, started_at);
CREATE INDEX idx_templates_category ON workflow_templates(category) WHERE published = true;

-- RLS
ALTER TABLE integration_workflows ENABLE ROW LEVEL SECURITY;
ALTER TABLE workflow_executions ENABLE ROW LEVEL SECURITY;

CREATE POLICY "workflows_org" ON integration_workflows
    FOR ALL TO authenticated
    USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

CREATE POLICY "executions_org" ON workflow_executions
    FOR ALL TO authenticated
    USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

-- workflow_templates is global (no RLS needed for read, admin-only write)

-- Triggers
CREATE TRIGGER update_workflows_updated_at
    BEFORE UPDATE ON integration_workflows
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();
```

---

## Acceptance Criteria (Given/When/Then)

### AC-1: Workflow Builder Canvas

```gherkin
Scenario: Admin creates new workflow
  Given user navigates to /integrations/workflows
  And clicks [+ New Workflow]
  When workflow builder page loads
  Then canvas shows:
    - Drag-and-drop node palette (left sidebar)
    - Empty canvas (center)
    - Properties panel (right sidebar)
    - Toolbar (top): Save, Test, Deploy, Cancel
  And node palette contains:
    | Category | Nodes |
    | Triggers | Schedule, Event, Manual |
    | Actions | HTTP Request, Data Transform, Conditional |
    | Connectors | REST API, SOAP, FTP, Email, Webhook |

Scenario: Drag-and-drop nodes
  Given workflow builder canvas
  When dragging "Schedule Trigger" from palette to canvas
  Then node appears on canvas at drop position
  And node shows icon, label, input/output ports
  And clicking node shows properties in right panel

Scenario: Connect nodes
  Given two nodes on canvas
  When dragging from output port of node A to input port of node B
  Then edge drawn between nodes
  And data flow direction indicated (arrow)
  And clicking edge allows delete
```

### AC-2: Trigger Configuration

```gherkin
Scenario: Configure schedule trigger
  Given "Schedule Trigger" node on canvas
  When clicking node
  Then properties panel shows:
    | Field | Type | Description |
    | Schedule Type | Dropdown | Cron, Interval, One-time |
    | Cron Expression | Text | e.g., "0 9 * * *" (daily at 9 AM) |
    | Interval | Number + Unit | e.g., 5 minutes, 1 hour |
    | Timezone | Dropdown | Organization timezone |
  And cron helper shows next 5 execution times

Scenario: Configure event trigger
  Given "Event Trigger" node
  When configuring
  Then properties show:
    | Field | Options |
    | Event Type | order.created, shipment.dispatched, etc. |
    | Filters | JSON path filters (optional) |
  And event data available as {{ trigger.data.* }}

Scenario: Manual trigger
  Given "Manual Trigger" node
  Then requires no configuration
  And workflow can be executed via [Run] button
```

### AC-3: HTTP Request Action

```gherkin
Scenario: Configure HTTP request
  Given "HTTP Request" action node
  When configuring
  Then properties show:
    | Field | Type | Example |
    | Method | Dropdown | GET, POST, PUT, DELETE |
    | URL | Text | https://api.example.com/orders |
    | Headers | Key-value | Authorization: Bearer {token} |
    | Body | JSON editor | { "order_id": "{{trigger.data.id}}" } |
    | Timeout | Number | 30 seconds |
  And variable picker available for {{ }} placeholders
  And [Test Request] button sends test request

Scenario: HTTP response handling
  Given HTTP request configured
  When request succeeds
  Then response available as {{ http_response.body.* }}
  And status code available as {{ http_response.status }}
  And next nodes can use response data

Scenario: HTTP error handling
  Given HTTP request fails (404, 500, timeout)
  Then workflow execution marked as 'error'
  And error_message captured
  And optional retry configuration (3 attempts, 5s delay)
```

### AC-4: Data Transform Action

```gherkin
Scenario: Configure data transform
  Given "Data Transform" action node
  When configuring
  Then properties show:
    | Field | Type | Description |
    | Transform Type | Dropdown | Map Fields, Filter Array, Aggregate, Custom |
    | Input Data | Dropdown | Previous node output |
    | Mappings | Key-value | target_field: {{ source_field }} |
  And output preview with sample data

Scenario: Field mapping with transformations
  Given data transform node
  When mapping fields:
    | Source Field | Target Field | Transformation |
    | {{ order.customer.name }} | customer_name | Uppercase |
    | {{ order.total }} | total_amount | Multiply by 100 (cents) |
    | {{ order.created_at }} | order_date | Format date (YYYY-MM-DD) |
  Then output data includes transformed fields

Scenario: Filter array
  Given array of items
  When filter condition: {{ item.status == 'active' }}
  Then output contains only active items
```

### AC-5: Conditional Logic

```gherkin
Scenario: Configure conditional branch
  Given "Conditional" action node
  When configuring
  Then properties show:
    | Field | Type | Example |
    | Condition | Expression | {{ order.total > 1000 }} |
    | True Branch | Node connection | Send notification |
    | False Branch | Node connection | Log only |
  And visual branching on canvas (green/red paths)

Scenario: Multiple conditions
  Given conditional node
  When adding multiple conditions:
    - If {{ order.total > 5000 }}: Send urgent alert
    - Else if {{ order.total > 1000 }}: Send standard alert
    - Else: No action
  Then workflow branches accordingly
```

### AC-6: Field Mapping UI

```gherkin
Scenario: Visual field mapper
  Given workflow with HTTP request to external API
  When clicking [Map Fields] button
  Then modal shows:
    - Left: Source fields (from previous node output)
    - Right: Target fields (API request body schema)
    - Drag source field to target field to map
  And mappings saved as {{ target_field: source_path }}

Scenario: Transformation options
  Given field mapping modal
  When mapping field with transformation dropdown
  Then options include:
    | Transformation | Example |
    | None | Direct mapping |
    | Uppercase | "john" -> "JOHN" |
    | Lowercase | "JOHN" -> "john" |
    | Trim | " value " -> "value" |
    | Date format | "2025-01-15T10:00:00Z" -> "2025-01-15" |
    | Number format | 1000.5 -> "1,000.50" |
    | Multiply/Divide | 10 * 100 = 1000 |
```

### AC-7: Test Mode

```gherkin
Scenario: Test workflow with sample data
  Given workflow configured with nodes connected
  When clicking [Test] button
  Then test mode dialog shows:
    | Field | Content |
    | Test Input | JSON editor with sample trigger data |
    | Run Test | Button to execute |
  And user can edit sample data
  And clicking [Run Test] executes workflow

Scenario: View test execution results
  Given test executed
  Then results panel shows:
    - Execution status (success/error)
    - Duration
    - Step-by-step results:
      | Step | Status | Output | Duration |
      | Trigger | Success | { ... } | 0ms |
      | HTTP Request | Success | { status: 200, body: ... } | 320ms |
      | Data Transform | Success | { ... } | 5ms |
  And error details if any step failed
  And output data from each step

Scenario: Test mode does not affect production
  Given workflow in test mode
  When test execution runs
  Then no actual external API calls (use mocks)
  And no database changes (rollback)
  And test execution not counted in stats
```

### AC-8: Save and Deploy Workflow

```gherkin
Scenario: Save workflow as draft
  Given workflow configured
  When clicking [Save]
  Then workflow saved with status = 'draft'
  And enabled = false
  And workflow appears in workflows list

Scenario: Deploy workflow
  Given workflow in draft status
  When clicking [Deploy]
  Then validation runs:
    - All required nodes connected
    - All required fields configured
    - No disconnected nodes
  And if valid:
    - status = 'active'
    - enabled = true
    - Trigger activated (cron scheduled, event listener registered)
  And success toast "Workflow deployed and enabled"

Scenario: Validation errors
  Given workflow with missing configuration
  When attempting to deploy
  Then error messages shown:
    - "HTTP Request node missing URL"
    - "Trigger node not configured"
  And deployment blocked until fixed
```

### AC-9: Workflow Templates

```gherkin
Scenario: Save workflow as template
  Given active workflow
  When clicking [Save as Template]
  Then template form shows:
    | Field | Required |
    | Name | Yes |
    | Description | Yes |
    | Category | Yes (dropdown) |
    | Tags | Optional |
  And clicking [Save] creates workflow_templates entry
  And template available in template library

Scenario: Load workflow from template
  Given template library with 10 templates
  When user clicks [New from Template]
  Then template browser shows:
    - Categories (ecommerce, wms, accounting, etc.)
    - Templates with description, icon, rating
  And clicking template:
    - Workflow definition loaded to canvas
    - User prompted to configure organization-specific values
    - Workflow saved as new workflow instance

Scenario: Public template library
  Given workflow_templates with published = true
  Then templates visible to all organizations
  And install_count incremented on use
```

### AC-10: Execution Logs

```gherkin
Scenario: View workflow execution history
  Given workflow executed 20 times
  When navigating to workflow detail page
  Then executions table shows:
    | Column | Content |
    | Execution # | ID |
    | Triggered By | User or "Schedule" |
    | Started At | Timestamp |
    | Duration | Milliseconds |
    | Status | Badge (success/error) |
    | Actions | View Details |
  And pagination (10 per page)

Scenario: View execution details
  Given execution with status = 'error'
  When clicking [View Details]
  Then modal shows:
    - Execution summary (status, duration, trigger)
    - Step-by-step results (with output data)
    - Error message and stack trace
    - Input data (trigger payload)
    - Output data (final result)
  And [Retry] button available for failed executions
```

---

## Implementation Notes

### Workflow Definition JSON Schema

```typescript
interface WorkflowDefinition {
  nodes: WorkflowNode[];
  edges: WorkflowEdge[];
  config: {
    timeout_seconds: number;
    retry_policy: 'none' | 'immediate' | 'exponential';
    max_retries: number;
  };
}

interface WorkflowNode {
  id: string;
  type: 'trigger' | 'action' | 'connector' | 'conditional';
  subtype: string; // 'schedule', 'http_request', 'rest_api', etc.
  position: { x: number; y: number };
  config: Record<string, any>; // Node-specific configuration
  label?: string;
}

interface WorkflowEdge {
  id: string;
  source: string; // Source node ID
  target: string; // Target node ID
  sourceHandle?: string; // For conditional branches
  targetHandle?: string;
}
```

### Field Mapping Schema

```typescript
interface FieldMapping {
  target_field: string;
  source_path: string; // JSONPath or variable path
  transformation?: {
    type: 'uppercase' | 'lowercase' | 'trim' | 'date_format' | 'number_format' | 'multiply' | 'divide';
    params?: Record<string, any>; // e.g., { format: 'YYYY-MM-DD', multiplier: 100 }
  };
  default_value?: any;
  required?: boolean;
}
```

### Workflow Execution Engine

```typescript
// lib/services/workflow-execution-service.ts

export class WorkflowExecutionService {
  /**
   * Execute workflow (manual or triggered)
   */
  static async execute(
    workflowId: string,
    inputData: any,
    triggeredBy?: string
  ): Promise<WorkflowExecutionResult>;

  /**
   * Execute single node
   */
  static async executeNode(
    node: WorkflowNode,
    context: ExecutionContext
  ): Promise<NodeExecutionResult>;

  /**
   * Apply field mappings
   */
  static applyFieldMappings(
    data: any,
    mappings: FieldMapping[]
  ): any;

  /**
   * Evaluate conditional expression
   */
  static evaluateCondition(
    expression: string,
    context: any
  ): boolean;
}
```

### Frontend Libraries

```typescript
// Workflow builder using React Flow
import ReactFlow, { Node, Edge } from 'reactflow';

// Node types registry
const nodeTypes = {
  trigger_schedule: ScheduleTriggerNode,
  trigger_event: EventTriggerNode,
  action_http: HTTPRequestNode,
  action_transform: DataTransformNode,
  action_conditional: ConditionalNode,
};

// Custom node components
function HTTPRequestNode({ data }: { data: any }) {
  return (
    <div className="http-request-node">
      <div className="node-header">
        <Icon name="globe" />
        <span>HTTP Request</span>
      </div>
      <Handle type="target" position="left" />
      <Handle type="source" position="right" />
    </div>
  );
}
```

---

## Deliverables

### Database
- [ ] integration_workflows table
- [ ] workflow_executions table
- [ ] workflow_templates table

### Backend
- [ ] Workflow Execution Service (execute, node execution, mapping, conditionals)
- [ ] POST /api/integrations/workflows
- [ ] PUT /api/integrations/workflows/:id
- [ ] DELETE /api/integrations/workflows/:id
- [ ] POST /api/integrations/workflows/:id/execute
- [ ] POST /api/integrations/workflows/:id/test
- [ ] GET /api/integrations/workflows/:id/logs
- [ ] POST /api/integrations/workflow-templates (save template)
- [ ] GET /api/integrations/workflow-templates (list)
- [ ] Cron scheduler for scheduled workflows

### Frontend
- [ ] Workflow builder canvas (React Flow)
- [ ] Node palette (triggers, actions, connectors)
- [ ] Node properties panel
- [ ] Field mapping UI (drag-drop)
- [ ] Test mode dialog
- [ ] Template browser
- [ ] Execution logs table
- [ ] Execution detail modal
- [ ] Workflows list page

### Tests
- [ ] Unit: Field mapping transformations
- [ ] Unit: Conditional evaluation
- [ ] Integration: Execute workflow end-to-end
- [ ] Integration: Save/load template
- [ ] E2E: Build, test, deploy workflow

---

## Definition of Done

- [ ] Workflow builder canvas functional (drag-drop, connect nodes)
- [ ] All node types implemented (trigger, action, connector, conditional)
- [ ] Field mapping UI working
- [ ] Test mode executes workflows without side effects
- [ ] Workflows can be saved, deployed, paused
- [ ] Template system functional (save, load, public library)
- [ ] Execution logs capture all workflow runs
- [ ] Scheduled workflows trigger correctly
- [ ] Error handling and retry logic working
- [ ] Unit tests >80% coverage
- [ ] E2E tests pass

---

## Risk Assessment

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Complex UX for non-technical users | HIGH | HIGH | Intuitive drag-drop, templates, tooltips, video tutorials |
| Workflow execution performance | MEDIUM | MEDIUM | Timeout limits, async execution, queue for large workflows |
| Security (user-defined workflows) | HIGH | MEDIUM | Sandbox execution, API rate limits, input validation |
| Template quality inconsistency | MEDIUM | MEDIUM | Review process for published templates, ratings |
| External API failures | MEDIUM | HIGH | Retry logic, error logging, graceful degradation |

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2026-01-15 | Initial Phase 3 story - Custom integration builder | ARCHITECT-AGENT |

---

**Document Status**: Ready for Implementation
**Created**: 2026-01-15
**Lines**: ~600
**Complexity**: L (Large - 4-5 days)
**Phase**: 3 (Enterprise)
