# 11.10 - EDI DESADV Outbound (ASN)

**Priority**: P1 (Phase 2)
**Story Points**: M (Medium)
**Type**: backend
**Phase**: 2
**Model**: OPUS

**State:** ready
**Estimate:** M (3-4 days)
**Primary PRD:** `docs/1-BASELINE/product/modules/integrations.md` (FR-INT-017, Section 4.2)
**Architecture:** EDIFACT DESADV generator, shipment-to-ASN mapping, SSCC pallet tracking

---

## Goal

Implement outbound EDI Advanced Shipping Notice (EDIFACT DESADV message). System generates DESADV from MonoPilot shipments, including pallet-level SSCC tracking, batch/lot numbers, and expiry dates. Large retailers require ASN for automated warehouse receiving.

---

## Food Safety Compliance

This story is **critical for retail compliance**:

- [x] **Batch/Lot Traceability** - DESADV includes batch numbers per product
- [x] **Expiry Date Tracking** - Perishables include expiry dates in ASN
- [x] **SSCC Pallet Tracking** - GS1-compliant SSCC-18 for pallet identification
- [x] **Temperature Requirements** - Storage temp included (if configured)

**Regulatory Context:**
- Major retailers (Carrefour, Tesco, Biedronka) require DESADV for receiving
- SSCC-18 mandatory for pallet tracking (GS1 standard)
- Batch/expiry traceability required for food safety recalls

---

## MVP Scope

**MVP Includes**:
- EDIFACT DESADV message generation (D.96A standard)
- Shipment-to-DESADV mapping (carrier, tracking, delivery address)
- SSCC-18 pallet tracking (if pallets exist in shipment)
- Batch/lot numbers and expiry dates per line item
- Manual "Send ASN" button on shipment detail page
- POST /api/integrations/edi/shipments/:id/send-asn
- GET /api/integrations/edi/shipments/:id/preview-asn
- Integration logs for transmissions

**Deferred to Phase 3**:
- Auto-send on shipment dispatch
- Real-time VAN API integration
- DESADV acknowledgment (CONTRL)
- Multi-delivery ASN (consolidated shipments)
- Temperature logger data integration

---

## User Story

As a **Large Retail Customer**, I want to **receive Advanced Shipping Notices via EDI (DESADV)** so that **my warehouse can prepare for receiving, auto-match incoming deliveries, and update inventory without manual data entry**.

As a **MonoPilot Administrator**, I want to **send ASN via EDI** so that **I can meet customer EDI requirements and speed up delivery acceptance**.

---

## Scope

**In scope (this story)**
- EDIFACT DESADV message generator
- Shipment-to-DESADV mapping (products, quantities, batch, expiry)
- SSCC-18 pallet mapping (if pallets exist)
- Manual send button on shipment detail page
- POST /api/integrations/edi/shipments/:id/send-asn
- GET /api/integrations/edi/shipments/:id/preview-asn
- EDI message storage (outbound)
- Integration logs

**Out of scope (this story)**
- Auto-send on dispatch (Phase 3)
- CONTRL acknowledgment (Phase 3)
- Multi-delivery consolidation (Phase 3)
- Real-time VAN API (MVP: manual download)

---

## Dependencies

### Cross-Epic Dependencies

| Dependency | Story/Epic | Type | What It Provides | Status |
|------------|------------|------|------------------|--------|
| 01.1 | Org Context + RLS | HARD | organizations table | Ready |
| 02.1 | Products CRUD | HARD | products table | Ready |
| 05.15 | Shipments | HARD | shipments, shipment_items, batch/lot data | Ready |
| 05.23 | GS1 SSCC Support (future) | SOFT | SSCC-18 pallet tracking | Planned |

### Within Epic Dependencies

| Dependency | Story | Type | What It Provides |
|------------|-------|------|------------------|
| 11.1 | Integrations Dashboard | HARD | EDI health status |
| 11.3 | Integration Logs | HARD | Transmission logging |
| 11.8 | EDI ORDERS | HARD | EDIFACT patterns |
| 11.9 | EDI INVOIC | HARD | EDIFACT generation patterns |

### Provides To (Downstream)

| Story | What This Provides |
|-------|-------------------|
| Phase 3 | Multi-delivery ASN patterns |

---

## Acceptance Criteria (Given/When/Then)

### AC-1: Generate EDIFACT DESADV from Shipment

```gherkin
Scenario: Generate DESADV from dispatched shipment
  Given shipment exists with:
    | Field | Value |
    | shipment_number | SHP-2025-001 |
    | dispatch_date | 2025-01-15 |
    | est_delivery_date | 2025-01-16 |
    | carrier | DHL |
    | tracking_number | 1234567890 |
    | customer.gln | 5412345000013 |
    | delivery_address | Warsaw, Poland |
  And shipment_items:
    | Product | Qty | Batch | Expiry | SSCC |
    | PROD-001 | 1000 | BATCH-2025-001 | 2025-02-15 | 354123450000000018 |
  When generating EDIFACT DESADV
  Then message contains:
    | Segment | Value |
    | BGM.C002.1004 | SHP-2025-001 |
    | DTM.2005 | 20250115 (dispatch date) |
    | DTM.2005 | 20250116 (delivery date) |
    | NAD+DP | 5412345000013 (delivery party GLN) |
    | TDT.C220.8067 | DHL (carrier) |
    | RFF.C506.1154 | 1234567890 (tracking number) |
    | CPS+1 | Packing sequence 1 |
    | PAC+1 | Number of packages |
    | PCI+33E | SSCC label |
    | GIN+BJ | 354123450000000018 (SSCC-18) |
    | LIN.C212.7140 | PROD-001 (product code) |
    | QTY.6060 | 1000 (qty shipped) |
    | RFF.BT | BATCH-2025-001 (batch number) |
    | DTM.36 | 20250215 (expiry date) |
  And message validates against D.96A schema
```

### AC-2: Send DESADV via EDI

```gherkin
Scenario: Admin sends ASN for shipment
  Given shipment SHP-2025-001 dispatched
  And customer has EDI enabled (gln populated)
  When admin clicks [Send ASN via EDI]
  Then EDIFACT DESADV generated
  And edi_messages record created:
    | Field | Value |
    | direction | outbound |
    | message_type | DESADV |
    | reference_id | SHP-2025-001 |
    | status | pending |
  And success toast "ASN queued for EDI transmission"
  And integration_logs entry created

Scenario: Download DESADV file (MVP)
  Given DESADV message generated
  When clicking [Download EDI File]
  Then .edi file downloaded (filename: DESADV_SHP2025001_20250115.edi)
  And admin manually uploads to VAN provider portal
```

### AC-3: SSCC-18 Pallet Tracking

```gherkin
Scenario: Shipment with SSCC-18 pallets
  Given shipment with 2 pallets
  And pallet 1 SSCC = 354123450000000018
  And pallet 2 SSCC = 354123450000000025
  When generating DESADV
  Then message contains:
    | Segment | Value |
    | CPS+1 | Packing unit 1 |
    | GIN+BJ | 354123450000000018 |
    | CPS+2 | Packing unit 2 |
    | GIN+BJ | 354123450000000025 |
  And each pallet linked to line items

Scenario: Shipment without SSCC (loose items)
  Given shipment with no pallet tracking
  When generating DESADV
  Then CPS/GIN segments omitted
  And only LIN segments for products
```

### AC-4: Batch and Expiry Dates

```gherkin
Scenario: Product with batch and expiry
  Given shipment_item with:
    | Product | PROD-001 (Bread Loaf) |
    | Batch | BATCH-2025-001 |
    | Expiry | 2025-02-15 |
  When generating DESADV
  Then LIN segment includes:
    | Segment | Value |
    | RFF+BT | BATCH-2025-001 |
    | DTM+36 | 20250215 |

Scenario: Product without expiry (shelf-stable)
  Given shipment_item with batch but no expiry
  Then RFF+BT included
  And DTM+36 omitted
```

### AC-5: Multiple Line Items

```gherkin
Scenario: Shipment with 5 products
  Given shipment with 5 different products
  When generating DESADV
  Then message contains 5 LIN segments
  And each with product code, qty, batch, expiry (if applicable)
```

### AC-6: Preview DESADV

```gherkin
Scenario: Preview ASN before sending
  Given shipment SHP-2025-001
  When clicking [Preview ASN]
  Then modal shows generated EDIFACT DESADV
  And syntax highlighted
  And [Copy], [Download], [Send] buttons
```

### AC-7: Carrier and Tracking Info

```gherkin
Scenario: Carrier and tracking number mapping
  Given shipment with:
    | Carrier | DHL |
    | Tracking | 1234567890 |
  When generating DESADV
  Then TDT segment includes carrier code
  And RFF segment includes tracking number

Scenario: No tracking number
  Given shipment without tracking number
  Then RFF segment omitted
  And warning logged
```

### AC-8: Delivery Address

```gherkin
Scenario: Delivery address mapping
  Given shipment with delivery address:
    | Name | Carrefour Warsaw DC |
    | Street | Wiśniowa 12 |
    | City | Warsaw |
    | Postal Code | 02-520 |
    | Country | PL |
  When generating DESADV
  Then NAD+DP segment includes:
    | Field | Value |
    | GLN | 5412345000013 |
    | Name | Carrefour Warsaw DC |
    | Address | Wiśniowa 12, 02-520 Warsaw, PL |
```

### AC-9: Customer EDI Not Enabled

```gherkin
Scenario: Customer without EDI
  Given shipment for customer without gln
  When attempting to send ASN
  Then error: "Customer does not have EDI enabled. GLN required."
  And send blocked
```

### AC-10: Resend Failed DESADV

```gherkin
Scenario: Resend failed ASN
  Given edi_message with status = 'error'
  When clicking [Resend]
  Then DESADV regenerated
  And status = 'pending'
  And retry logged
```

---

## Implementation Notes

### EDIFACT DESADV Generation

**Standard**: UN/EDIFACT D.96A

**Segment Mapping**:

```
UNB - Interchange Header
UNH - Message Header (DESADV)
BGM - Shipment Number
DTM - Dispatch Date, Delivery Date
NAD - Consignor (supplier), Consignee (customer delivery point)
TDT - Transport Details (carrier, mode)
RFF - Shipment Reference, Tracking Number
CPS - Packing Sequence (per pallet/package)
PAC - Number of Packages
PCI - Package Identification (SSCC label type)
GIN - SSCC-18 Number
LIN - Line Item (product)
PIA - Product Code
IMD - Product Description
QTY - Quantity Shipped
RFF - Batch Number
DTM - Expiry Date, Production Date
UNT - Message Trailer
UNZ - Interchange Trailer
```

**Example EDIFACT DESADV**:

```
UNA:+.? '
UNB+UNOC:3+MONOPILOT:14+5412345000013:14+250115:1430+1++DESADV'
UNH+1+DESADV:D:96A:UN'
BGM+351+SHP-2025-001+9'
DTM+137:20250115:102'
DTM+2:20250116:102'
NAD+SU+MONOPILOT::92'
NAD+DP+5412345000013::9++Carrefour Warsaw DC+Wiśniowa 12+Warsaw++02-520+PL'
TDT+20++30:DHL'
RFF+CN:1234567890'
CPS+1'
PAC+1'
PCI+33E'
GIN+BJ+354123450000000018'
LIN+1++PROD-001:SA'
QTY+12:1000'
RFF+BT:BATCH-2025-001'
DTM+36:20250215:102'
UNT+16+1'
UNZ+1+1'
```

### Service Layer

```typescript
// lib/services/edi-desadv-service.ts

export class EDIDESADVService {
  /**
   * Generate EDIFACT DESADV from shipment
   */
  static async generateDESADV(shipmentId: string, orgId: string): Promise<string>;

  /**
   * Send DESADV via EDI
   */
  static async sendDESADV(shipmentId: string, userId: string): Promise<EDIMessage>;

  /**
   * Preview DESADV without sending
   */
  static async previewDESADV(shipmentId: string): Promise<string>;

  /**
   * Resend failed DESADV
   */
  static async resendDESADV(messageId: string, userId: string): Promise<void>;
}
```

---

## Key Business Rules

1. **Customer EDI Required**: Customer must have `gln` populated
2. **Shipment Dispatched**: Only dispatched shipments can send ASN
3. **SSCC-18 Optional**: If no pallets, send product-level ASN only
4. **Batch Traceability**: Include batch/lot numbers if available
5. **Expiry Dates**: Mandatory for perishables, optional for shelf-stable
6. **Manual Transmission (MVP)**: Admin downloads .edi file and uploads to VAN
7. **Audit Trail**: All transmissions logged

---

## Deliverables

### API Routes
- [ ] `GET /api/integrations/edi/shipments/:id/preview-asn` - Preview DESADV
- [ ] `POST /api/integrations/edi/shipments/:id/send-asn` - Send DESADV
- [ ] `POST /api/integrations/edi/messages/:id/resend` - Retry

### Service Layer
- [ ] `EDIDESADVService.generateDESADV()` - EDIFACT generator
- [ ] `EDIDESADVService.sendDESADV()` - Queue for transmission
- [ ] `EDIDESADVService.previewDESADV()` - Preview
- [ ] `EDIDESADVService.resendDESADV()` - Retry

### Frontend
- [ ] [Send ASN via EDI] button on shipment detail page
- [ ] Preview DESADV modal
- [ ] Download .edi file

### Tests
- [ ] Unit tests: DESADV generation (>80% coverage)
- [ ] Integration tests: All endpoints
- [ ] E2E: Generate -> Preview -> Send -> Download

---

## Definition of Done

### API
- [ ] All endpoints functional
- [ ] DESADV generation works
- [ ] SSCC-18 mapping works

### Service
- [ ] EDIFACT generator complete
- [ ] Batch/expiry mapping

### Frontend
- [ ] Send button works
- [ ] Preview modal works
- [ ] Download file works

### Testing
- [ ] Unit tests: >80% coverage
- [ ] Integration tests: All endpoints
- [ ] E2E: Full flow passing

---

## Risk Assessment

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| SSCC-18 format errors | MEDIUM | LOW | Validate against GS1 standard |
| Missing batch data | MEDIUM | MEDIUM | Warn if batch/expiry missing |
| Carrier code mapping | LOW | MEDIUM | Maintain carrier code lookup table |

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2026-01-15 | Initial Phase 2 story creation | ARCHITECT |

---

**Document Status**: Ready for Implementation
**Created**: 2026-01-15
**Lines**: ~450
**Complexity**: M (Medium)
**Phase**: 2
