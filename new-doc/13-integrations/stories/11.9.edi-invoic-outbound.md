# 11.9 - EDI INVOIC Outbound

**Priority**: P1 (Phase 2)
**Story Points**: M (Medium)
**Type**: backend
**Phase**: 2
**Model**: OPUS

**State:** ready
**Estimate:** M (3-4 days)
**Primary PRD:** `docs/1-BASELINE/product/modules/integrations.md` (FR-INT-016, Section 4.2)
**Architecture:** EDIFACT INVOIC generator, VAN transmission, delivery tracking

---

## Goal

Implement outbound EDI invoice transmission (EDIFACT INVOIC message). System generates EDIFACT-formatted invoices from MonoPilot shipments/invoices, sends to customer EDI mailbox via VAN provider, and tracks delivery confirmation.

---

## Food Safety Compliance

This story supports **financial traceability**:

- [x] **Invoice-to-Batch Linkage** - EDI invoice references batch/lot numbers from shipment
- [x] **Audit Trail** - All EDI transmissions logged
- [x] **VAT Compliance** - INVOIC includes VAT rates per line item

**Regulatory Context:**
- EDI invoices legally equivalent to paper invoices (EU eIDAS regulation)
- Must include batch/lot traceability for food products
- VAT breakdown required for cross-border transactions

---

## MVP Scope

**MVP Includes**:
- EDIFACT INVOIC message generation (D.96A standard)
- Mapping from MonoPilot invoice/shipment to EDIFACT
- Manual "Send via EDI" button on invoice page
- EDI VAN transmission (manual file download in MVP)
- Delivery confirmation tracking (log transmission status)
- GET /api/integrations/edi/invoices/:id (generate preview)
- POST /api/integrations/edi/invoices/:id/send (transmit)
- Integration logs for all transmissions

**Deferred to Phase 3**:
- Auto-send on invoice finalization
- Real-time VAN API integration (MVP: manual file upload to VAN)
- INVOIC acknowledgment (CONTRL message)
- Multi-currency support
- Credit notes (INVOIC with credit indicator)

---

## User Story

As a **Large Customer** (EDI-enabled), I want to **receive invoices via EDI (EDIFACT INVOIC)** so that **invoices are automatically imported into my accounting system without manual data entry**.

As a **MonoPilot Administrator**, I want to **send invoices via EDI** so that **I can meet customer EDI requirements and speed up payment processing**.

---

## Scope

**In scope (this story)**
- EDIFACT INVOIC message generator
- Mapping from invoice/shipment to EDIFACT
- Manual send button on invoice detail page
- POST /api/integrations/edi/invoices/:id/send
- GET /api/integrations/edi/invoices/:id/preview (preview EDIFACT)
- EDI message storage in edi_messages (outbound)
- Integration logs for transmissions
- Status tracking (pending, sent, confirmed, error)

**Out of scope (this story)**
- Auto-send on invoice finalization (Phase 3)
- CONTRL acknowledgment processing (Phase 3)
- Credit notes (Phase 3)
- Multi-currency (Phase 3)
- Real-time VAN API (MVP: manual file download)

---

## Dependencies

### Cross-Epic Dependencies

| Dependency | Story/Epic | Type | What It Provides | Status |
|------------|------------|------|------------------|--------|
| 01.1 | Org Context + RLS | HARD | organizations table | Ready |
| 02.1 | Products CRUD | HARD | products table | Ready |
| 05.15 | Shipments | HARD | shipments, shipment_items tables | Ready |
| 09.1 | Invoices (future) | SOFT | invoices table | Planned |

### Within Epic Dependencies

| Dependency | Story | Type | What It Provides |
|------------|-------|------|------------------|
| 11.1 | Integrations Dashboard | HARD | EDI health status |
| 11.3 | Integration Logs | HARD | Transmission logging |
| 11.8 | EDI ORDERS | HARD | EDIFACT parsing patterns |

### Provides To (Downstream)

| Story | What This Provides |
|-------|-------------------|
| 11.10 | EDIFACT generation patterns for DESADV |
| Phase 3 | Credit note patterns |

---

## Acceptance Criteria (Given/When/Then)

### AC-1: Generate EDIFACT INVOIC from Invoice

```gherkin
Scenario: Generate INVOIC from finalized invoice
  Given invoice exists with:
    | Field | Value |
    | invoice_number | INV-2025-001 |
    | issue_date | 2025-01-15 |
    | customer.gln | 5412345000013 |
    | customer.name | Acme Bakery Ltd |
    | customer.tax_id | PL1234567890 |
    | line_items[0].product_code | PROD-001 |
    | line_items[0].qty | 1000 |
    | line_items[0].unit_price | 2.50 |
    | line_items[0].vat_rate | 23% |
    | total_net | 2500.00 |
    | total_vat | 575.00 |
    | total_gross | 3075.00 |
  When generating EDIFACT INVOIC
  Then message contains:
    | Segment | Value |
    | BGM.C002.1004 | INV-2025-001 |
    | DTM.2005 | 20250115 (issue date) |
    | NAD+BY | 5412345000013 (buyer GLN) |
    | LIN.C212.7140 | PROD-001 (product code) |
    | QTY.6060 | 1000 (quantity) |
    | PRI.C509.5118 | 2.50 (unit price) |
    | TAX.C243.5278 | 23 (VAT rate) |
    | MOA.5004 | 2500.00 (net amount) |
    | MOA.5004 | 3075.00 (gross amount) |
  And message validates against D.96A schema
```

### AC-2: Send INVOIC via EDI

```gherkin
Scenario: Admin sends invoice via EDI
  Given invoice INV-2025-001 finalized
  And customer has EDI enabled (gln populated)
  When admin clicks [Send via EDI]
  Then EDIFACT INVOIC generated
  And edi_messages record created:
    | Field | Value |
    | direction | outbound |
    | message_type | INVOIC |
    | reference_id | INV-2025-001 |
    | status | pending |
  And success toast "Invoice queued for EDI transmission"
  And integration_logs entry created

Scenario: Download EDIFACT file (MVP)
  Given INVOIC message generated
  When clicking [Download EDI File]
  Then .edi file downloaded (filename: INVOIC_INV2025001_20250115.edi)
  And admin manually uploads to VAN provider portal

Scenario: Customer EDI not enabled
  Given invoice for customer without gln
  When attempting to send via EDI
  Then error: "Customer does not have EDI enabled. GLN required."
  And send blocked
```

### AC-3: Preview EDIFACT Message

```gherkin
Scenario: Preview INVOIC before sending
  Given invoice INV-2025-001
  When clicking [Preview EDI]
  Then modal shows generated EDIFACT message
  And syntax highlighted
  And [Copy to Clipboard] button
  And [Download] button
  And [Send] button
```

### AC-4: Track Transmission Status

```gherkin
Scenario: Mark message as sent
  Given edi_message with status = 'pending'
  And admin manually uploads to VAN
  When clicking [Mark as Sent]
  Then status = 'sent'
  And edi_messages.processed_at = now
  And integration_logs entry created

Scenario: VAN delivery confirmation (Phase 3)
  Given edi_message sent
  And VAN confirms delivery (CONTRL message)
  Then status = 'confirmed'
  And delivery_confirmed_at = timestamp
```

### AC-5: Multiple Line Items

```gherkin
Scenario: Invoice with 10 line items
  Given invoice with 10 products
  When generating INVOIC
  Then message contains 10 LIN segments
  And each with product code, qty, price, VAT
  And total amounts correct
```

### AC-6: VAT Breakdown

```gherkin
Scenario: Invoice with multiple VAT rates
  Given invoice with:
    | Line | Product | VAT Rate | Net Amount |
    | 1 | Bread | 5% | 1000.00 |
    | 2 | Juice | 23% | 500.00 |
  When generating INVOIC
  Then message contains:
    | Segment | Content |
    | TAX+VAT+5 | 1000.00 net, 50.00 VAT |
    | TAX+VAT+23 | 500.00 net, 115.00 VAT |
    | MOA total | 1500.00 net, 165.00 VAT, 1665.00 gross |
```

### AC-7: Batch/Lot Traceability

```gherkin
Scenario: INVOIC includes batch numbers
  Given invoice linked to shipment
  And shipment_items have batch_numbers
  When generating INVOIC
  Then LIN segments include:
    | Segment | Value |
    | RFF.C506.1154 | Batch number (e.g., BATCH-2025-001) |
    | DTM.2005 | Expiry date (if applicable) |
```

### AC-8: Invoice Not Found

```gherkin
Scenario: Invoice does not exist
  Given invoice_id = invalid-uuid
  When requesting POST /api/integrations/edi/invoices/:id/send
  Then 404 Not Found
```

### AC-9: EDI Outbox View

```gherkin
Scenario: View sent invoices
  Given admin navigates to /integrations/edi/outbox
  Then DataTable shows outbound edi_messages:
    | Column | Description |
    | Message Type | INVOIC |
    | Reference | INV-2025-001 |
    | Customer | Customer name |
    | Status | Badge (pending/sent/confirmed/error) |
    | Sent At | Timestamp |
    | Actions | Download, Resend |
  And filter by status, date range
```

### AC-10: Resend Failed Message

```gherkin
Scenario: Resend failed INVOIC
  Given edi_message with status = 'error'
  When clicking [Resend]
  Then EDIFACT regenerated (in case of data updates)
  And status = 'pending'
  And retry attempt logged
```

---

## Implementation Notes

### EDIFACT INVOIC Generation

**Standard**: UN/EDIFACT D.96A

**Segment Mapping**:

```
UNB - Interchange Header
UNH - Message Header (INVOIC)
BGM - Invoice Number, Invoice Type
DTM - Invoice Date, Delivery Date
NAD - Buyer, Supplier
CUX - Currency (EUR, PLN, etc.)
LIN - Line Item
PIA - Product Code (GTIN, internal code)
IMD - Product Description
QTY - Quantity Invoiced
MOA - Line Amount
PRI - Unit Price
TAX - VAT Rate and Amount
RFF - Batch Number Reference
DTM - Expiry Date
UNS - Section Separator
MOA - Total Net, Total VAT, Total Gross
TAX - VAT Summary per Rate
UNT - Message Trailer
UNZ - Interchange Trailer
```

**Example EDIFACT INVOIC**:

```
UNA:+.? '
UNB+UNOC:3+MONOPILOT:14+5412345000013:14+250115:1430+1++INVOIC'
UNH+1+INVOIC:D:96A:UN'
BGM+380+INV-2025-001+9'
DTM+137:20250115:102'
NAD+BY+5412345000013::9++Acme Bakery Ltd'
NAD+SU+MONOPILOT::92'
CUX+2:PLN:9'
LIN+1++PROD-001:SA'
QTY+47:1000'
MOA+203:2500.00'
PRI+AAA:2.50'
TAX+7+VAT+++:::23'
RFF+BT:BATCH-2025-001'
UNS+S'
MOA+79:2500.00'
MOA+176:575.00'
MOA+86:3075.00'
TAX+7+VAT+++:::23+2500.00'
UNT+16+1'
UNZ+1+1'
```

### Service Layer

```typescript
// lib/services/edi-invoic-service.ts

export class EDIInvoicService {
  /**
   * Generate EDIFACT INVOIC from invoice
   */
  static async generateINVOIC(invoiceId: string, orgId: string): Promise<string>;

  /**
   * Send INVOIC via EDI (creates edi_message record)
   */
  static async sendINVOIC(invoiceId: string, userId: string): Promise<EDIMessage>;

  /**
   * Preview INVOIC without sending
   */
  static async previewINVOIC(invoiceId: string): Promise<string>;

  /**
   * Mark message as sent (manual confirmation)
   */
  static async markAsSent(messageId: string, userId: string): Promise<void>;

  /**
   * Resend failed message
   */
  static async resendINVOIC(messageId: string, userId: string): Promise<void>;
}
```

### Validation Rules

```typescript
interface INVOICValidationRules {
  customer_gln: {
    required: true;
    format: /^\d{13}$/; // 13-digit GLN
  };
  line_items: {
    min: 1;
    product_code_required: true;
  };
  vat_rates: {
    allowed: [0, 5, 8, 23]; // Polish VAT rates
  };
  totals: {
    validate_sum: true; // net + VAT = gross
  };
}
```

---

## Key Business Rules

1. **Customer EDI Required**: Customer must have `gln` populated (13-digit GLN)
2. **Invoice Finalized**: Only finalized invoices can be sent via EDI
3. **VAT Breakdown**: Must include VAT summary per rate (TAX segments)
4. **Batch Traceability**: Include batch/lot numbers from shipment if available
5. **Manual Transmission (MVP)**: Admin downloads .edi file and uploads to VAN portal
6. **Resend Allowed**: Failed messages can be regenerated and resent
7. **Audit Trail**: All transmissions logged to integration_logs

---

## Deliverables

### API Routes
- [ ] `GET /api/integrations/edi/invoices/:id/preview` - Preview EDIFACT
- [ ] `POST /api/integrations/edi/invoices/:id/send` - Send INVOIC
- [ ] `POST /api/integrations/edi/messages/:id/mark-sent` - Manual confirmation
- [ ] `POST /api/integrations/edi/messages/:id/resend` - Retry transmission

### Service Layer
- [ ] `EDIInvoicService.generateINVOIC()` - EDIFACT generator
- [ ] `EDIInvoicService.sendINVOIC()` - Queue for transmission
- [ ] `EDIInvoicService.previewINVOIC()` - Preview without sending
- [ ] `EDIInvoicService.markAsSent()` - Manual confirmation
- [ ] `EDIInvoicService.resendINVOIC()` - Retry failed

### Frontend
- [ ] [Send via EDI] button on invoice detail page
- [ ] Preview EDIFACT modal
- [ ] Download .edi file button
- [ ] EDI outbox page (`/integrations/edi/outbox`)
- [ ] Resend action

### Tests
- [ ] Unit tests: EDIFACT generation (>80% coverage)
- [ ] Integration tests: All API endpoints
- [ ] E2E: Generate -> Preview -> Send -> Download

---

## Definition of Done

### API
- [ ] All endpoints functional
- [ ] EDIFACT INVOIC generation works
- [ ] Preview and send flows work

### Service
- [ ] EDIFACT generator complete
- [ ] Validation rules enforced
- [ ] Transmission logging

### Frontend
- [ ] Send button works
- [ ] Preview modal displays EDIFACT
- [ ] Download file works
- [ ] Outbox displays messages

### Testing
- [ ] Unit tests: >80% coverage
- [ ] Integration tests: All endpoints
- [ ] E2E: Full flow passing

---

## Risk Assessment

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| EDIFACT format errors | MEDIUM | MEDIUM | Validate against D.96A schema, test with real customers |
| VAT calculation errors | HIGH | LOW | Comprehensive unit tests, validate totals |
| Missing batch numbers | LOW | MEDIUM | Warn if shipment has no batch data |

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2026-01-15 | Initial Phase 2 story creation | ARCHITECT |

---

**Document Status**: Ready for Implementation
**Created**: 2026-01-15
**Lines**: ~500
**Complexity**: M (Medium)
**Phase**: 2
