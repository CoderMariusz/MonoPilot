# 11.16 - Comarch Payment Reconciliation

**Priority**: P2 (Phase 3 Enterprise)
**Story Points**: M (Medium)
**Type**: backend
**Phase**: 3
**Model**: OPUS

**State:** ready
**Estimate:** M (3-4 days)
**Primary PRD:** `docs/1-BASELINE/product/modules/integrations.md` (FR-INT-027, Section 4.2)
**Architecture:** Comarch Optima API, payment sync, invoice matching, reconciliation reporting

---

## Goal

Extend Comarch Optima integration (stories 11.6, 11.13) with payment reconciliation. Sync payments from Comarch Optima accounting system, automatically match payments to MonoPilot invoices, generate reconciliation reports, and update invoice payment status. Critical for cash flow visibility and accounting accuracy.

---

## MVP Scope

**MVP Includes**:
- Sync payments from Comarch Optima (pull from API)
- Match payments to invoices (by invoice number, amount, customer)
- Update invoice payment_status (unpaid -> partial -> paid)
- Reconciliation report (matched/unmatched payments)
- Manual payment matching UI (for unmatched payments)
- Scheduled sync (daily or manual trigger)
- Payment sync history and logs

**Deferred to Future**:
- Payment write-back to Comarch (currently read-only)
- Multi-currency payment handling
- Payment allocation wizard (split payment across invoices)
- Automated bank reconciliation

---

## User Story

As a **Finance Manager**, I want to **sync payments from Comarch Optima and match them to MonoPilot invoices** so that **I have real-time visibility of invoice payment status and can identify unmatched payments quickly**.

As an **Accountant**, I want to **manually match unmatched payments to invoices** so that **all payments are reconciled correctly even when automatic matching fails**.

---

## Scope

**In scope (this story)**
- GET payments from Comarch Optima API
- Parse payment data (payment_id, amount, date, customer, invoice_reference)
- Match payments to invoices (by invoice_number or customer + amount)
- Update invoice.payment_status (unpaid/partial/paid)
- Create payment_transactions table (store synced payments)
- Generate reconciliation report (matched vs unmatched)
- POST /api/integrations/comarch/sync-payments (trigger sync)
- GET /api/integrations/comarch/payments (list synced payments)
- POST /api/integrations/comarch/payments/:id/match (manual match)
- GET /api/integrations/comarch/reconciliation (report)
- UI: Payment sync trigger, reconciliation dashboard, manual matching

**Out of scope (this story)**
- Payment write-back to Comarch (Phase 4)
- Multi-currency support (Phase 4)
- Payment allocation wizard (Phase 4)
- Bank statement import (separate feature)

---

## Dependencies

### Cross-Epic Dependencies

| Dependency | Story/Epic | Type | What It Provides | Status |
|------------|------------|------|------------------|--------|
| 01.1 | Org Context + RLS | HARD | organizations, users | Ready |
| 09.1 | Invoices CRUD | HARD | invoices table, payment_status field | Planned (Epic 09) |

### Within Epic Dependencies

| Dependency | Story | Type | What It Provides |
|------------|-------|------|------------------|
| 11.3 | Integration Logs | HARD | integration_logs table | Ready |
| 11.6 | Comarch Basic | HARD | comarch_optima_config table | Ready |
| 11.13 | Comarch Advanced | HARD | Comarch API patterns, chart of accounts sync | Ready |

### Provides To (Downstream)

| Story | What This Provides |
|-------|-------------------|
| Phase 4 | Payment reconciliation patterns for other accounting systems |

---

## Database Schema

### payment_transactions Table

```sql
-- Migration: YYYYMMDDHHMMSS_create_payment_transactions.sql

CREATE TABLE payment_transactions (
    -- Identity
    id                      UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id                  UUID NOT NULL REFERENCES organizations(id),

    -- External Reference
    external_payment_id     TEXT NOT NULL,              -- Comarch payment ID
    external_system         TEXT NOT NULL DEFAULT 'comarch_optima',

    -- Payment Details
    payment_date            DATE NOT NULL,
    amount                  DECIMAL(15,2) NOT NULL,
    currency                TEXT DEFAULT 'PLN',
    payment_method          TEXT,                       -- transfer, card, cash, etc.

    -- Customer Reference
    customer_id             UUID REFERENCES customers(id),
    customer_name           TEXT,
    customer_tax_id         TEXT,

    -- Invoice Reference (from Comarch)
    invoice_reference       TEXT,                       -- Invoice number from payment

    -- Matching
    matched                 BOOLEAN DEFAULT false,
    invoice_id              UUID REFERENCES invoices(id),
    matched_at              TIMESTAMPTZ,
    matched_by              UUID REFERENCES users(id),
    match_confidence        TEXT,                       -- auto_high, auto_low, manual

    -- Additional Info
    description             TEXT,
    notes                   TEXT,                       -- Manual notes

    -- Sync Metadata
    synced_at               TIMESTAMPTZ NOT NULL DEFAULT now(),
    sync_batch_id           UUID,                       -- Group payments from same sync

    -- Audit
    created_at              TIMESTAMPTZ NOT NULL DEFAULT now(),
    updated_at              TIMESTAMPTZ NOT NULL DEFAULT now(),

    -- Constraints
    CONSTRAINT uq_payment_external UNIQUE (org_id, external_payment_id, external_system)
);

-- Indexes
CREATE INDEX idx_payments_org ON payment_transactions(org_id);
CREATE INDEX idx_payments_matched ON payment_transactions(org_id, matched);
CREATE INDEX idx_payments_customer ON payment_transactions(customer_id) WHERE customer_id IS NOT NULL;
CREATE INDEX idx_payments_invoice ON payment_transactions(invoice_id) WHERE invoice_id IS NOT NULL;
CREATE INDEX idx_payments_date ON payment_transactions(org_id, payment_date);
CREATE INDEX idx_payments_sync ON payment_transactions(sync_batch_id) WHERE sync_batch_id IS NOT NULL;

-- RLS
ALTER TABLE payment_transactions ENABLE ROW LEVEL SECURITY;

CREATE POLICY "payments_org" ON payment_transactions
    FOR ALL TO authenticated
    USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

-- Trigger
CREATE TRIGGER update_payment_transactions_updated_at
    BEFORE UPDATE ON payment_transactions
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();
```

### invoices Table Update

```sql
-- Add payment tracking fields to invoices (Epic 09)
ALTER TABLE invoices ADD COLUMN IF NOT EXISTS payment_status TEXT DEFAULT 'unpaid'
    CHECK (payment_status IN ('unpaid', 'partial', 'paid', 'overdue'));
ALTER TABLE invoices ADD COLUMN IF NOT EXISTS amount_paid DECIMAL(15,2) DEFAULT 0;
ALTER TABLE invoices ADD COLUMN IF NOT EXISTS last_payment_date DATE;
```

---

## Acceptance Criteria (Given/When/Then)

### AC-1: Sync Payments from Comarch

```gherkin
Scenario: Manual payment sync
  Given Comarch Optima configured with valid API credentials
  And 20 new payments exist in Comarch since last sync
  When admin navigates to /integrations/comarch/payments
  And clicks [Sync Payments]
  Then GET request to Comarch API:
    | Endpoint | /api/platnosci |
    | Query | ?od={last_sync_date}&typ=wpłata |
  And for each payment:
    - Create payment_transactions entry
    - Attempt automatic matching
    - Update sync_batch_id (same for all in batch)
  And success toast "Synced 20 payments, 15 matched, 5 unmatched"
  And comarch_optima_config.last_payment_sync_at updated

Scenario: Scheduled payment sync
  Given payment sync scheduled daily at 6 AM
  When cron job executes
  Then sync payments automatically
  And send notification if unmatched payments > 10

Scenario: Duplicate payment prevention
  Given payment with external_payment_id = "PAY-123" already exists
  When syncing same payment again
  Then skip duplicate (no new row created)
  And log "Payment PAY-123 already synced"
```

### AC-2: Automatic Payment Matching

```gherkin
Scenario: Match payment by invoice number (high confidence)
  Given payment with invoice_reference = "INV-2025-001"
  And invoice INV-2025-001 exists with amount = 1000.00
  And payment.amount = 1000.00
  When syncing payment
  Then automatically match:
    | Field | Value |
    | matched | true |
    | invoice_id | INV-2025-001 UUID |
    | match_confidence | auto_high |
    | matched_at | now |
  And invoice.payment_status updated to 'paid'
  And invoice.amount_paid = 1000.00
  And invoice.last_payment_date = payment.payment_date

Scenario: Partial payment matching
  Given invoice INV-2025-001 amount = 1000.00
  And payment.amount = 500.00
  And invoice_reference matches
  When syncing payment
  Then match with:
    | invoice.payment_status | partial |
    | invoice.amount_paid | 500.00 |
  And remaining balance = 500.00

Scenario: Match by customer and amount (low confidence)
  Given payment with no invoice_reference
  But payment.customer_id matches customer C-001
  And payment.amount = 1000.00
  And customer C-001 has unpaid invoice with amount = 1000.00
  When syncing payment
  Then suggest match with:
    | matched | false (pending manual confirmation) |
    | match_confidence | auto_low |
  And payment appears in "Review Matches" queue

Scenario: No match found
  Given payment with no matching invoice
  When syncing payment
  Then:
    | matched | false |
    | match_confidence | null |
  And payment appears in "Unmatched Payments" list
```

### AC-3: Manual Payment Matching

```gherkin
Scenario: Admin manually matches unmatched payment
  Given unmatched payment of 1000.00 PLN
  And multiple candidate invoices for customer
  When admin navigates to /integrations/comarch/payments
  And clicks [Match] on payment row
  Then modal shows:
    | Field | Content |
    | Payment Details | Amount, date, customer, description |
    | Candidate Invoices | List of unpaid invoices for customer |
    | Search | Search by invoice number |
  And admin selects invoice INV-2025-001
  And clicks [Match Payment]
  Then:
    - payment_transactions.matched = true
    - payment_transactions.invoice_id = INV-2025-001
    - payment_transactions.match_confidence = 'manual'
    - payment_transactions.matched_by = current user
    - invoice.payment_status updated
  And success toast "Payment matched to INV-2025-001"

Scenario: Unmatch payment
  Given payment matched to invoice
  When admin clicks [Unmatch]
  Then:
    - payment_transactions.matched = false
    - payment_transactions.invoice_id = NULL
    - invoice.payment_status reverted
  And payment back in unmatched list
```

### AC-4: Invoice Payment Status Update

```gherkin
Scenario: Update invoice to paid
  Given invoice with total = 1000.00, payment_status = 'unpaid'
  When payment of 1000.00 matched
  Then invoice updated:
    | payment_status | paid |
    | amount_paid | 1000.00 |
    | last_payment_date | {payment.payment_date} |

Scenario: Update invoice to partial
  Given invoice with total = 1000.00, payment_status = 'unpaid'
  When payment of 400.00 matched
  Then invoice updated:
    | payment_status | partial |
    | amount_paid | 400.00 |

Scenario: Multiple payments for one invoice
  Given invoice with total = 1000.00
  And payment 1 of 400.00 already matched (partial)
  When payment 2 of 600.00 matched to same invoice
  Then invoice updated:
    | payment_status | paid |
    | amount_paid | 1000.00 |
    | last_payment_date | {payment2.payment_date} |
```

### AC-5: Reconciliation Report

```gherkin
Scenario: View reconciliation dashboard
  Given 100 payments synced in last 30 days
  And 80 matched, 20 unmatched
  When admin navigates to /integrations/comarch/reconciliation
  Then dashboard shows:
    | Metric | Value |
    | Total Payments | 100 |
    | Matched Payments | 80 (80%) |
    | Unmatched Payments | 20 (20%) |
    | Total Amount Synced | 250,000 PLN |
    | Matched Amount | 200,000 PLN |
    | Unmatched Amount | 50,000 PLN |
  And charts:
    - Payment matching rate over time (line chart)
    - Unmatched payments by age (bar chart)
    - Payment methods breakdown (pie chart)

Scenario: Export reconciliation report
  Given reconciliation dashboard
  When clicking [Export Report]
  Then generate CSV with:
    | Columns | payment_date, amount, customer, invoice, status, matched_date |
  And download file "reconciliation_2025-01-15.csv"

Scenario: Filter by date range
  Given reconciliation dashboard
  When selecting date range: 2025-01-01 to 2025-01-15
  Then show only payments in range
  And recalculate metrics
```

### AC-6: Payment List UI

```gherkin
Scenario: View all synced payments
  Given 50 payments synced
  When navigating to /integrations/comarch/payments
  Then DataTable shows:
    | Column | Content |
    | Payment Date | Date |
    | Amount | Amount with currency |
    | Customer | Customer name |
    | Invoice | Matched invoice # (link) or "Unmatched" |
    | Status | Badge (matched/unmatched) |
    | Confidence | auto_high/auto_low/manual |
    | Actions | Match, View, Unmatch |
  And pagination (20 per page)
  And filters:
    - Status (matched/unmatched)
    - Date range
    - Customer
    - Match confidence

Scenario: Search payments
  Given payments list
  When searching "INV-2025-001"
  Then show payments with invoice_reference matching
  And highlight search term
```

### AC-7: Comarch API Mapping

```gherkin
Scenario: Map Comarch payment to MonoPilot fields
  Given Comarch payment object:
    {
      "Id": 12345,
      "DataPlatnosci": "2025-01-15",
      "Kwota": 1000.00,
      "Waluta": "PLN",
      "Kontrahent": {
        "Nazwa": "Piekarnia ABC",
        "NIP": "1234567890"
      },
      "NumerDokumentu": "INV-2025-001",
      "Opis": "Płatność za fakturę"
    }
  Then map to payment_transactions:
    | Comarch Field | MonoPilot Field | Value |
    | Id | external_payment_id | "12345" |
    | DataPlatnosci | payment_date | 2025-01-15 |
    | Kwota | amount | 1000.00 |
    | Waluta | currency | PLN |
    | Kontrahent.Nazwa | customer_name | "Piekarnia ABC" |
    | Kontrahent.NIP | customer_tax_id | "1234567890" |
    | NumerDokumentu | invoice_reference | "INV-2025-001" |
    | Opis | description | "Płatność za fakturę" |
```

### AC-8: Error Handling

```gherkin
Scenario: Comarch API unavailable
  Given Comarch API returns 500 error
  When triggering payment sync
  Then error toast "Failed to sync payments from Comarch Optima"
  And integration_logs entry created
  And retry available after 5 minutes

Scenario: Invalid payment data
  Given Comarch returns payment with missing required field (amount)
  When syncing
  Then skip invalid payment
  And log error "Payment {id} missing required field: amount"
  And continue with other payments

Scenario: Customer not found
  Given payment with customer_tax_id not in MonoPilot
  When syncing
  Then create payment_transactions entry
  But matched = false (cannot match without customer)
  And admin notification "Payments for unknown customers"
```

### AC-9: Audit Trail

```gherkin
Scenario: All payment operations logged
  Given any payment sync or matching operation
  Then integration_logs entry created with:
    | Field | Value |
    | integration_type | comarch |
    | event_type | payment.sync / payment.match / payment.unmatch |
    | status | success / error |
    | request_body | API request (if applicable) |
    | response_body | API response |
```

---

## Implementation Notes

### Service Methods

```typescript
// lib/services/comarch-payment-service.ts

export class ComarchPaymentService {
  /**
   * Sync payments from Comarch Optima
   */
  static async syncPayments(params: {
    fromDate?: Date;
    toDate?: Date;
  }): Promise<{
    synced: number;
    matched: number;
    unmatched: number;
    syncBatchId: string;
  }>;

  /**
   * Attempt automatic matching for payment
   */
  static async autoMatchPayment(paymentId: string): Promise<{
    matched: boolean;
    confidence: 'auto_high' | 'auto_low' | null;
    invoiceId?: string;
  }>;

  /**
   * Manual match payment to invoice
   */
  static async manualMatchPayment(
    paymentId: string,
    invoiceId: string,
    userId: string
  ): Promise<void>;

  /**
   * Unmatch payment from invoice
   */
  static async unmatchPayment(
    paymentId: string,
    userId: string
  ): Promise<void>;

  /**
   * Update invoice payment status based on matched payments
   */
  static async updateInvoicePaymentStatus(invoiceId: string): Promise<void>;

  /**
   * Generate reconciliation report
   */
  static async getReconciliationReport(params: {
    fromDate: Date;
    toDate: Date;
  }): Promise<{
    totalPayments: number;
    matchedPayments: number;
    unmatchedPayments: number;
    totalAmount: number;
    matchedAmount: number;
    unmatchedAmount: number;
    payments: PaymentTransaction[];
  }>;
}
```

### Matching Algorithm

```typescript
// Matching priority:
// 1. Invoice reference + amount exact match (auto_high)
// 2. Invoice reference + amount within 5% (auto_high)
// 3. Customer + amount exact match + single unpaid invoice (auto_low)
// 4. No match (manual review required)

function matchPayment(payment: Payment): MatchResult {
  // Step 1: Try invoice reference match
  if (payment.invoice_reference) {
    const invoice = findInvoiceByNumber(payment.invoice_reference);
    if (invoice) {
      const amountMatch = Math.abs(invoice.total - payment.amount) < 0.01;
      const amountClose = Math.abs(invoice.total - payment.amount) / invoice.total < 0.05;

      if (amountMatch || amountClose) {
        return { matched: true, invoiceId: invoice.id, confidence: 'auto_high' };
      }
    }
  }

  // Step 2: Try customer + amount match
  if (payment.customer_id) {
    const unpaidInvoices = findUnpaidInvoicesForCustomer(payment.customer_id);
    const exactMatch = unpaidInvoices.find(inv =>
      Math.abs(inv.total - payment.amount) < 0.01
    );

    if (exactMatch && unpaidInvoices.length === 1) {
      return { matched: false, suggestedInvoiceId: exactMatch.id, confidence: 'auto_low' };
    }
  }

  // Step 3: No match
  return { matched: false, confidence: null };
}
```

---

## Deliverables

### Database
- [ ] payment_transactions table
- [ ] invoices table updates (payment_status, amount_paid, last_payment_date)

### Backend
- [ ] Comarch Payment Service (sync, match, reconciliation logic)
- [ ] POST /api/integrations/comarch/sync-payments
- [ ] GET /api/integrations/comarch/payments
- [ ] POST /api/integrations/comarch/payments/:id/match
- [ ] POST /api/integrations/comarch/payments/:id/unmatch
- [ ] GET /api/integrations/comarch/reconciliation
- [ ] Cron job: daily payment sync

### Frontend
- [ ] Payment sync trigger button
- [ ] Payments list page with filters
- [ ] Manual match modal
- [ ] Reconciliation dashboard
- [ ] Unmatched payments queue
- [ ] Payment detail view

### Tests
- [ ] Unit: Auto-match algorithm
- [ ] Unit: Invoice payment status update
- [ ] Integration: Sync payments from Comarch mock
- [ ] Integration: Match/unmatch operations
- [ ] E2E: Full payment reconciliation workflow

---

## Definition of Done

- [ ] Payments synced from Comarch Optima API
- [ ] Automatic matching works (high/low confidence)
- [ ] Manual matching UI functional
- [ ] Invoice payment_status updated correctly
- [ ] Reconciliation report accurate
- [ ] Duplicate payments prevented
- [ ] Unmatched payments identifiable
- [ ] All error scenarios handled
- [ ] Unit tests >80% coverage
- [ ] E2E tests pass

---

## Risk Assessment

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Comarch API changes | HIGH | MEDIUM | Version API calls, test environment, error handling |
| Customer matching failures | MEDIUM | HIGH | Robust tax ID matching, manual review queue |
| Duplicate payment sync | MEDIUM | MEDIUM | External payment ID unique constraint |
| Invoice status out of sync | MEDIUM | LOW | Transaction-based updates, rollback on error |
| Large payment volume | LOW | LOW | Batch processing, async sync |

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2026-01-15 | Initial Phase 3 story - Comarch payment reconciliation | ARCHITECT-AGENT |

---

**Document Status**: Ready for Implementation
**Created**: 2026-01-15
**Lines**: ~560
**Complexity**: M (Medium - 3-4 days)
**Phase**: 3 (Enterprise)
