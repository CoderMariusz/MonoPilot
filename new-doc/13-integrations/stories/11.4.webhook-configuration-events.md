# 11.4 - Webhook Configuration & Events

**Priority**: P0 (MVP)
**Story Points**: L (Large)
**Type**: fullstack
**Phase**: 1 (MVP)
**Model**: OPUS

**State:** ready
**Estimate:** L (4-5 days)
**Primary PRD:** `docs/1-BASELINE/product/modules/integrations.md` (FR-INT-006, FR-INT-007)
**Architecture:** `docs/1-BASELINE/architecture/modules/integrations.md` (webhook delivery patterns)

---

## Goal

Implement outbound webhook system - allow admins to configure HTTP endpoints that receive real-time notifications when events occur (order.created, workorder.completed, shipment.dispatched). Includes HMAC signature authentication, configurable retry policies (immediate/exponential/manual), 30s timeout, and delivery logging.

---

## User Story

As a **System Administrator**, I want to **configure webhooks that notify external systems when events occur** so that **our partners and integrations receive real-time updates without polling our API**.

As an **Integration Developer**, I want to **receive signed webhook payloads with retry logic** so that **temporary failures don't result in lost events and I can verify payload authenticity**.

---

## Dependencies

### Cross-Epic Dependencies

| Dependency | Story/Epic | Type | What It Provides | Status |
|------------|------------|------|------------------|--------|
| 01.1 | Org Context + RLS | HARD | organizations, users, roles tables | Ready |
| 11.1 | Dashboard | HARD | integration_health, nav shell | Ready |
| 11.3 | Integration Logs | HARD | Delivery logging | Ready |

### Provides To (Downstream)

| Story | What This Provides |
|-------|-------------------|
| Planning | Order event webhooks |
| Production | Work order event webhooks |
| Warehouse | Inventory event webhooks |
| Shipping | Shipment event webhooks |

---

## Database Migration

### Migration: Create integration_webhooks table

```sql
-- Migration: YYYYMMDDHHMMSS_create_integration_webhooks.sql

-- Webhook configurations
CREATE TABLE integration_webhooks (
    id                  UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id              UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,

    -- Webhook config
    name                VARCHAR(255) NOT NULL,
    url                 VARCHAR(500) NOT NULL CHECK (url ~* '^https://.*'), -- HTTPS only
    events              JSONB NOT NULL DEFAULT '[]', -- ["order.created", "shipment.dispatched"]
    status              VARCHAR(20) NOT NULL DEFAULT 'active' CHECK (status IN ('active', 'paused')),

    -- Security
    secret              VARCHAR(255) NOT NULL, -- For HMAC signature (generated on creation)

    -- Retry configuration
    retry_policy        VARCHAR(20) NOT NULL DEFAULT 'exponential' CHECK (retry_policy IN ('immediate', 'exponential', 'manual')),
    max_retries         INTEGER NOT NULL DEFAULT 3 CHECK (max_retries >= 0 AND max_retries <= 10),

    -- Custom headers (optional)
    custom_headers      JSONB DEFAULT '{}', -- {"X-Custom-Header": "value"}

    -- Usage tracking
    last_triggered_at   TIMESTAMPTZ,
    total_deliveries    INTEGER DEFAULT 0,
    failed_deliveries   INTEGER DEFAULT 0,

    -- Audit
    created_by          UUID REFERENCES users(id),
    created_at          TIMESTAMPTZ NOT NULL DEFAULT now(),
    updated_at          TIMESTAMPTZ NOT NULL DEFAULT now(),

    CONSTRAINT uq_webhook_name UNIQUE (org_id, name)
);

-- Indexes
CREATE INDEX idx_webhooks_org ON integration_webhooks(org_id);
CREATE INDEX idx_webhooks_active ON integration_webhooks(org_id, status) WHERE status = 'active';
CREATE INDEX idx_webhooks_events ON integration_webhooks USING GIN (events);

-- RLS Policies
ALTER TABLE integration_webhooks ENABLE ROW LEVEL SECURITY;

CREATE POLICY "webhooks_select" ON integration_webhooks
    FOR SELECT USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
        AND (SELECT r.code FROM roles r JOIN users u ON u.role_id = r.id WHERE u.id = auth.uid()) IN ('SUPER_ADMIN', 'ADMIN', 'IT_MANAGER')
    );

CREATE POLICY "webhooks_insert" ON integration_webhooks
    FOR INSERT WITH CHECK (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
        AND (SELECT r.code FROM roles r JOIN users u ON u.role_id = r.id WHERE u.id = auth.uid()) IN ('SUPER_ADMIN', 'ADMIN')
    );

CREATE POLICY "webhooks_update" ON integration_webhooks
    FOR UPDATE USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
        AND (SELECT r.code FROM roles r JOIN users u ON u.role_id = r.id WHERE u.id = auth.uid()) IN ('SUPER_ADMIN', 'ADMIN')
    );

CREATE POLICY "webhooks_delete" ON integration_webhooks
    FOR DELETE USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
        AND (SELECT r.code FROM roles r JOIN users u ON u.role_id = r.id WHERE u.id = auth.uid()) IN ('SUPER_ADMIN', 'ADMIN')
    );

-- Trigger for updated_at
CREATE TRIGGER update_webhooks_updated_at
    BEFORE UPDATE ON integration_webhooks
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- =============================================================================
-- Webhook Delivery Queue
-- =============================================================================

CREATE TABLE webhook_deliveries (
    id                  UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    webhook_id          UUID NOT NULL REFERENCES integration_webhooks(id) ON DELETE CASCADE,
    org_id              UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,

    -- Event
    event_type          VARCHAR(100) NOT NULL,
    payload             JSONB NOT NULL,

    -- Delivery status
    status              VARCHAR(20) NOT NULL DEFAULT 'pending' CHECK (status IN ('pending', 'delivered', 'failed')),
    http_status         INTEGER,
    response_body       TEXT,
    error_message       TEXT,

    -- Retry tracking
    attempt_count       INTEGER DEFAULT 0,
    next_retry_at       TIMESTAMPTZ,
    last_attempt_at     TIMESTAMPTZ,

    -- Performance
    duration_ms         INTEGER,

    -- Timestamps
    created_at          TIMESTAMPTZ NOT NULL DEFAULT now(),
    delivered_at        TIMESTAMPTZ
);

-- Indexes
CREATE INDEX idx_webhook_deliveries_webhook ON webhook_deliveries(webhook_id, created_at DESC);
CREATE INDEX idx_webhook_deliveries_org ON webhook_deliveries(org_id, created_at DESC);
CREATE INDEX idx_webhook_deliveries_status ON webhook_deliveries(status, next_retry_at) WHERE status = 'pending';

-- RLS Policies
ALTER TABLE webhook_deliveries ENABLE ROW LEVEL SECURITY;

CREATE POLICY "webhook_deliveries_select" ON webhook_deliveries
    FOR SELECT USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

CREATE POLICY "webhook_deliveries_insert" ON webhook_deliveries
    FOR INSERT WITH CHECK (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

-- =============================================================================
-- Function: Trigger webhook event
-- =============================================================================

CREATE OR REPLACE FUNCTION trigger_webhook_event(
    p_org_id UUID,
    p_event_type VARCHAR,
    p_payload JSONB
) RETURNS INTEGER AS $$
DECLARE
    v_webhook RECORD;
    v_delivery_id UUID;
    v_count INTEGER := 0;
BEGIN
    -- Find all active webhooks subscribed to this event
    FOR v_webhook IN
        SELECT id, url, secret, retry_policy, max_retries, custom_headers
        FROM integration_webhooks
        WHERE org_id = p_org_id
          AND status = 'active'
          AND events @> to_jsonb(ARRAY[p_event_type])
    LOOP
        -- Create delivery record
        INSERT INTO webhook_deliveries (webhook_id, org_id, event_type, payload)
        VALUES (v_webhook.id, p_org_id, p_event_type, p_payload)
        RETURNING id INTO v_delivery_id;

        v_count := v_count + 1;

        -- Trigger async delivery (via background job)
        -- PERFORM pg_notify('webhook_delivery', v_delivery_id::text);
    END LOOP;

    RETURN v_count;
END;
$$ LANGUAGE plpgsql;
```

---

## Acceptance Criteria (Given/When/Then)

### AC-1: Create Webhook

```gherkin
Scenario: Admin creates webhook
  Given user has ADMIN role
  When creating webhook with:
    | name | "Order Notifications" |
    | url | "https://partner.com/webhooks/orders" |
    | events | ["order.created", "order.updated"] |
    | retry_policy | "exponential" |
    | max_retries | 5 |
  Then webhook created successfully
  And secret auto-generated (32 random bytes)
  And status = "active"
  And success message shown

Scenario: URL must be HTTPS
  Given creating webhook
  When url = "http://partner.com/webhook" (not HTTPS)
  Then validation error "Webhook URL must use HTTPS"
  And webhook not created

Scenario: At least one event required
  Given creating webhook
  When events = [] (empty array)
  Then error "At least one event subscription required"
  And form submission prevented
```

### AC-2: Available Events

```gherkin
Scenario: Event selector shows all event types
  Given creating/editing webhook
  Then event selector shows:
    | Event | Description |
    | order.created | New purchase order created |
    | order.updated | Purchase order status changed |
    | workorder.started | Work order production started |
    | workorder.completed | Work order finished |
    | shipment.dispatched | Shipment sent out |
    | inventory.low | Stock below reorder point |
    | product.created | New product added |
  And checkboxes for each event

Scenario: Subscribe to multiple events
  Given creating webhook
  When selecting:
    - order.created
    - order.updated
    - shipment.dispatched
  Then all 3 events stored in events array
  And webhook triggered for any of these events
```

### AC-3: Webhook Delivery Flow

```gherkin
Scenario: Event triggers webhook delivery
  Given active webhook subscribed to "order.created"
  When new purchase order created
  Then webhook_deliveries record created
  And HTTP POST sent to webhook URL
  And request includes:
    | Header | Value |
    | Content-Type | application/json |
    | X-MonoPilot-Signature | sha256=<hmac> |
    | X-MonoPilot-Event | order.created |
    | X-MonoPilot-Delivery-ID | <uuid> |
  And custom headers appended (if configured)

Scenario: Successful delivery (2xx response)
  Given webhook delivery in progress
  When endpoint responds with 200 OK within 30s
  Then delivery status = "delivered"
  And delivered_at = now()
  And http_status = 200
  And response_body stored
  And total_deliveries incremented on webhook

Scenario: Failed delivery (4xx/5xx)
  Given webhook delivery in progress
  When endpoint responds with 500 Internal Server Error
  Then delivery status = "failed"
  And error_message stored
  And http_status = 500
  And failed_deliveries incremented
  And retry scheduled based on policy
```

### AC-4: HMAC Signature

```gherkin
Scenario: Sign webhook payload
  Given webhook with secret = "secret123"
  And payload = {"event": "order.created", "data": {...}}
  When generating signature
  Then signature = HMAC-SHA256(payload_json, secret)
  And header = "X-MonoPilot-Signature: sha256=<hex>"

Scenario: Consumer verifies signature
  Given webhook consumer receives request
  When computing HMAC with shared secret
  And comparing to X-MonoPilot-Signature header
  Then signatures match (payload authentic)
  Or signatures differ (reject request)
```

### AC-5: Retry Policies

```gherkin
Scenario: Immediate retry policy
  Given webhook with retry_policy = "immediate"
  And max_retries = 3
  When delivery fails
  Then retry 1 after 5 seconds
  And retry 2 after 5 seconds (from last attempt)
  And retry 3 after 5 seconds
  If all fail: move to failed (no more retries)

Scenario: Exponential backoff retry
  Given webhook with retry_policy = "exponential"
  And max_retries = 5
  When delivery fails
  Then retry schedule:
    | Attempt | Delay |
    | 1 | 5 seconds |
    | 2 | 30 seconds |
    | 3 | 5 minutes |
    | 4 | 30 minutes |
    | 5 | 2 hours |
  If all fail: move to failed

Scenario: Manual retry policy
  Given webhook with retry_policy = "manual"
  When delivery fails
  Then no auto-retry
  And admin must manually trigger retry
  And delivery remains in "failed" state
```

### AC-6: Timeout Handling

```gherkin
Scenario: Delivery timeout after 30s
  Given webhook delivery in progress
  When endpoint does not respond within 30s
  Then request cancelled
  And delivery status = "failed"
  And error_message = "Request timeout after 30 seconds"
  And retry scheduled (if retries remaining)
```

### AC-7: View Webhook List

```gherkin
Scenario: Admin views webhooks table
  Given organization has 3 webhooks
  When navigating to /integrations/webhooks
  Then table displays:
    | Column | Content |
    | Name | "Order Notifications" |
    | URL | "https://partner.com/webhooks..." |
    | Events | "order.created, order.updated (2)" |
    | Status | Badge (active/paused) |
    | Success Rate | "92% (230/250)" |
    | Last Triggered | "5 minutes ago" |
    | Actions | [Edit] [Test] [Pause] [Delete] |
```

### AC-8: Test Webhook

```gherkin
Scenario: Send test webhook
  Given webhook configuration
  When clicking [Test Webhook]
  Then sample payload sent:
    {
      "event": "test",
      "timestamp": "2025-01-15T10:30:00Z",
      "data": {"message": "Test webhook from MonoPilot"}
    }
  And delivery attempted with actual config
  And result displayed:
    - HTTP status
    - Response time
    - Response body
  If success: "Test successful" toast
  If failure: error details shown

Scenario: Test webhook validates URL
  Given testing webhook
  When endpoint unreachable
  Then error shown "Cannot reach webhook URL"
  And suggestion "Check firewall and DNS settings"
```

### AC-9: Pause/Resume Webhook

```gherkin
Scenario: Pause active webhook
  Given webhook with status = "active"
  When clicking [Pause]
  Then status changed to "paused"
  And webhook no longer receives events
  And badge shows "Paused" (gray)
  And [Resume] button shown

Scenario: Resume paused webhook
  Given paused webhook
  When clicking [Resume]
  Then status changed to "active"
  And webhook starts receiving events again
  And badge shows "Active" (green)
```

### AC-10: Delete Webhook

```gherkin
Scenario: Delete webhook with confirmation
  Given existing webhook
  When clicking [Delete]
  And confirming action
  Then webhook soft-deleted
  And no longer triggers on events
  And past deliveries preserved (for audit)
  And success toast "Webhook deleted"

Scenario: Cannot delete if has pending deliveries
  Given webhook with pending deliveries
  When attempting to delete
  Then warning shown "5 pending deliveries - pause instead?"
  And delete blocked until deliveries complete/fail
```

### AC-11: View Delivery Logs

```gherkin
Scenario: View webhook delivery history
  Given webhook details page
  When viewing "Deliveries" tab
  Then table shows last 100 deliveries:
    | Column | Content |
    | Timestamp | "2025-01-15 10:30:00" |
    | Event | "order.created" |
    | Status | Badge (delivered/failed) |
    | HTTP Status | 200 / 500 / timeout |
    | Attempts | "1 of 3" |
    | Duration | "245 ms" |
    | Actions | [View Payload] [Retry] |

Scenario: View delivery payload
  Given delivery log entry
  When clicking [View Payload]
  Then modal shows:
    - Sent payload (formatted JSON)
    - Response body
    - Request headers (including signature)
    - Error message (if failed)
```

### AC-12: Custom Headers

```gherkin
Scenario: Configure custom headers
  Given creating/editing webhook
  When adding custom header:
    - Name: "X-API-Key"
    - Value: "partner-key-123"
  Then header stored in custom_headers JSONB
  And included in all webhook requests

Scenario: Reserved headers cannot be overridden
  Given configuring custom headers
  When attempting to set:
    - Content-Type
    - X-MonoPilot-Signature
    - X-MonoPilot-Event
  Then validation error "Header is reserved and cannot be customized"
```

### AC-13: Webhook Statistics

```gherkin
Scenario: Dashboard shows webhook health
  Given 5 active webhooks
  And 340 successful deliveries, 60 failed (last 24h)
  When viewing integrations dashboard
  Then Webhooks health card shows:
    | Metric | Value |
    | Status | Warning (yellow) - 85% success |
    | Active Webhooks | 5 |
    | Deliveries (24h) | 400 |
    | Success Rate | "85%" |
    | Failed | 60 |
```

---

## Implementation Notes

### API Endpoints

```typescript
// =============================================================================
// Webhooks Endpoints
// =============================================================================

// GET /api/integrations/webhooks - List webhooks
interface WebhookListResponse {
  webhooks: Webhook[];
  total: number;
}

// POST /api/integrations/webhooks - Create webhook
interface CreateWebhookRequest {
  name: string;
  url: string; // HTTPS only
  events: string[]; // Event type array
  retry_policy?: 'immediate' | 'exponential' | 'manual';
  max_retries?: number;
  custom_headers?: Record<string, string>;
}

interface CreateWebhookResponse {
  id: string;
  name: string;
  url: string;
  events: string[];
  status: 'active';
  secret: string; // Shown ONCE
  retry_policy: string;
  max_retries: number;
  created_at: string;
}

// PUT /api/integrations/webhooks/:id - Update webhook
interface UpdateWebhookRequest {
  name?: string;
  url?: string;
  events?: string[];
  retry_policy?: string;
  max_retries?: number;
  custom_headers?: Record<string, string>;
}

// POST /api/integrations/webhooks/:id/test - Test webhook
interface TestWebhookResponse {
  success: boolean;
  http_status?: number;
  duration_ms?: number;
  response_body?: string;
  error?: string;
}

// POST /api/integrations/webhooks/:id/pause - Pause webhook
// POST /api/integrations/webhooks/:id/resume - Resume webhook
// DELETE /api/integrations/webhooks/:id - Delete webhook

// GET /api/integrations/webhooks/:id/deliveries - Delivery logs
interface DeliveryLogsResponse {
  deliveries: WebhookDelivery[];
  pagination: PaginationMeta;
}

// POST /api/integrations/webhooks/deliveries/:id/retry - Manual retry
```

### Validation Schemas (Zod)

```typescript
import { z } from 'zod';

export const webhookEvents = [
  'order.created',
  'order.updated',
  'workorder.started',
  'workorder.completed',
  'shipment.dispatched',
  'inventory.low',
  'product.created',
] as const;

export const createWebhookSchema = z.object({
  name: z.string().min(3).max(255),
  url: z.string().url().regex(/^https:\/\/.*/, 'URL must use HTTPS'),
  events: z.array(z.enum(webhookEvents)).min(1, 'At least one event required'),
  retry_policy: z.enum(['immediate', 'exponential', 'manual']).default('exponential'),
  max_retries: z.number().int().min(0).max(10).default(3),
  custom_headers: z.record(z.string()).optional(),
}).refine(
  (data) => {
    // Check custom headers don't override reserved ones
    const reserved = ['Content-Type', 'X-MonoPilot-Signature', 'X-MonoPilot-Event', 'X-MonoPilot-Delivery-ID'];
    if (data.custom_headers) {
      for (const key of Object.keys(data.custom_headers)) {
        if (reserved.includes(key)) {
          return false;
        }
      }
    }
    return true;
  },
  { message: 'Custom headers cannot override reserved headers' }
);

export const updateWebhookSchema = createWebhookSchema.partial();
```

### Service Layer

```typescript
// lib/services/webhook-service.ts

export class WebhookService {
  /**
   * Create new webhook
   */
  static async create(orgId: string, data: CreateWebhookRequest, userId: string): Promise<CreateWebhookResponse>;

  /**
   * List webhooks
   */
  static async list(orgId: string): Promise<Webhook[]>;

  /**
   * Update webhook
   */
  static async update(id: string, data: UpdateWebhookRequest): Promise<Webhook>;

  /**
   * Test webhook delivery
   */
  static async test(id: string): Promise<TestWebhookResponse>;

  /**
   * Pause/resume webhook
   */
  static async pause(id: string): Promise<void>;
  static async resume(id: string): Promise<void>;

  /**
   * Delete webhook
   */
  static async delete(id: string): Promise<void>;

  /**
   * Trigger webhook event (called by app when events occur)
   */
  static async triggerEvent(orgId: string, eventType: string, payload: Record<string, any>): Promise<number>;

  /**
   * Deliver webhook (background job)
   */
  static async deliverWebhook(deliveryId: string): Promise<void>;

  /**
   * Generate HMAC signature
   */
  static generateSignature(payload: string, secret: string): string;

  /**
   * Get delivery logs
   */
  static async getDeliveries(webhookId: string, page?: number): Promise<DeliveryLogsResponse>;

  /**
   * Manual retry delivery
   */
  static async retryDelivery(deliveryId: string): Promise<void>;

  /**
   * Calculate retry delay based on policy
   */
  static getRetryDelay(policy: string, attemptCount: number): number; // Returns milliseconds
}
```

### Frontend Components

```
apps/frontend/app/(authenticated)/integrations/
  webhooks/
    page.tsx                    -- Webhooks list page
    [id]/
      page.tsx                  -- Webhook detail/edit page

components/integrations/webhooks/
  WebhooksTable.tsx             -- DataTable for webhooks
  CreateWebhookModal.tsx        -- Create webhook form
  EditWebhookModal.tsx          -- Edit webhook
  EventSelector.tsx             -- Event checkboxes
  RetryPolicySelector.tsx       -- Retry policy dropdown
  TestWebhookButton.tsx         -- Test delivery trigger
  WebhookDeliveriesTable.tsx    -- Delivery logs
  DeliveryDetailModal.tsx       -- Payload viewer
  WebhookStatusBadge.tsx        -- Status badge
  CustomHeadersInput.tsx        -- Key-value header input
```

---

## Key Business Rules

1. **HTTPS Only**: Webhook URLs must use HTTPS (security)
2. **HMAC Signature**: All payloads signed with HMAC-SHA256
3. **Timeout**: 30 second timeout per delivery attempt
4. **Retry Policies**: Immediate (5s), Exponential (5s, 30s, 5m, 30m, 2h), Manual (no auto-retry)
5. **Event Subscription**: Webhook only triggered for subscribed events
6. **Secret Generation**: Auto-generated 32-byte random secret on creation
7. **Admin-Only**: Only ADMIN can create/edit/delete webhooks
8. **Reserved Headers**: Cannot override Content-Type, X-MonoPilot-* headers
9. **Delivery Retention**: Keep delivery logs for 30 days
10. **Success Criteria**: HTTP 2xx response within 30s

---

## Deliverables

### Database
- [ ] `integration_webhooks` table with RLS
- [ ] `webhook_deliveries` table with RLS
- [ ] `trigger_webhook_event()` function
- [ ] Indexes for performance

### API Routes
- [ ] GET /api/integrations/webhooks
- [ ] POST /api/integrations/webhooks
- [ ] GET /api/integrations/webhooks/:id
- [ ] PUT /api/integrations/webhooks/:id
- [ ] POST /api/integrations/webhooks/:id/test
- [ ] POST /api/integrations/webhooks/:id/pause
- [ ] POST /api/integrations/webhooks/:id/resume
- [ ] DELETE /api/integrations/webhooks/:id
- [ ] GET /api/integrations/webhooks/:id/deliveries
- [ ] POST /api/integrations/webhooks/deliveries/:id/retry

### Service Layer
- [ ] WebhookService with all methods
- [ ] HMAC signature generation
- [ ] HTTP client for delivery (timeout, retries)
- [ ] Background job for async delivery
- [ ] Retry scheduling logic

### Validation
- [ ] createWebhookSchema
- [ ] updateWebhookSchema

### Frontend
- [ ] Webhooks list page
- [ ] Create webhook modal
- [ ] Edit webhook modal
- [ ] Event selector
- [ ] Retry policy selector
- [ ] Test webhook button
- [ ] Delivery logs table
- [ ] Delivery detail modal
- [ ] Custom headers input

### Tests
- [ ] Unit tests: WebhookService (>80% coverage)
- [ ] Integration tests: All endpoints
- [ ] Signature verification tests
- [ ] Retry policy tests
- [ ] Timeout tests
- [ ] RLS tests: Multi-tenancy
- [ ] E2E: Create, test, monitor webhooks

---

## Definition of Done

### Database
- [ ] Tables created with constraints
- [ ] RLS policies enforced
- [ ] Indexes optimized
- [ ] Trigger function works

### API
- [ ] All endpoints functional
- [ ] HTTPS-only validation
- [ ] Secret auto-generated
- [ ] Test webhook works
- [ ] Response times < 500ms

### Service
- [ ] Webhooks deliver correctly
- [ ] HMAC signatures valid
- [ ] Retry policies work
- [ ] Timeout enforcement (30s)
- [ ] Background job processes deliveries

### Frontend
- [ ] Create webhook flow works
- [ ] Event selector functional
- [ ] Test webhook displays results
- [ ] Delivery logs viewable
- [ ] Pause/resume works

### Testing
- [ ] Unit tests: >80% coverage
- [ ] Integration tests passing
- [ ] Signature tests verified
- [ ] E2E workflow passing

---

## Risk Assessment

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Webhook endpoint abuse | MEDIUM | LOW | Rate limiting, timeout, admin-only |
| Secret exposure | CRITICAL | LOW | Never log secrets, HTTPS only, secure storage |
| Delivery queue buildup | MEDIUM | MEDIUM | Background job monitoring, DLQ for failures |
| Consumer endpoint down | LOW | HIGH | Exponential backoff, manual retry UI |

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2026-01-15 | Initial story for Epic 11 Phase 1 | ARCHITECT-AGENT |

---

**Document Status**: Ready for Implementation
**Created**: 2026-01-15
**Lines**: ~590
**Complexity**: L (Large)
**Phase**: 1 (MVP)
