story:
  id: "11.4"
  name: "Webhook Configuration & Events"
  epic: "11-integrations"
  phase: "1"
  complexity: "L"
  estimate_days: 4-5

dependencies:
  required:
    - story: "01.1"
      provides: ["organizations", "users", "roles"]
    - story: "11.1"
      provides: ["integration_health", "nav shell"]
    - story: "11.3"
      provides: ["integration_logs for delivery logging"]

files_to_read:
  prd: "docs/1-BASELINE/product/modules/integrations.md"
  prd_sections: ["FR-INT-006", "FR-INT-007"]
  story: "docs/2-MANAGEMENT/epics/current/11-integrations/11.4.webhook-configuration-events.md"

files_to_create:
  database:
    - path: "supabase/migrations/YYYYMMDDHHMMSS_create_integration_webhooks.sql"
      type: "migration"
  api:
    - path: "apps/frontend/app/api/integrations/webhooks/route.ts"
      methods: ["GET", "POST"]
    - path: "apps/frontend/app/api/integrations/webhooks/[id]/route.ts"
      methods: ["GET", "PUT", "DELETE"]
    - path: "apps/frontend/app/api/integrations/webhooks/[id]/test/route.ts"
      methods: ["POST"]
    - path: "apps/frontend/app/api/integrations/webhooks/[id]/pause/route.ts"
      methods: ["POST"]
    - path: "apps/frontend/app/api/integrations/webhooks/[id]/resume/route.ts"
      methods: ["POST"]
    - path: "apps/frontend/app/api/integrations/webhooks/[id]/deliveries/route.ts"
      methods: ["GET"]
  services:
    - path: "apps/frontend/lib/services/webhook-service.ts"
  validation:
    - path: "apps/frontend/lib/validation/webhook.ts"
  pages:
    - path: "apps/frontend/app/(authenticated)/integrations/webhooks/page.tsx"
    - path: "apps/frontend/app/(authenticated)/integrations/webhooks/[id]/page.tsx"
  components:
    - path: "apps/frontend/components/integrations/webhooks/WebhooksTable.tsx"
    - path: "apps/frontend/components/integrations/webhooks/CreateWebhookModal.tsx"
    - path: "apps/frontend/components/integrations/webhooks/EditWebhookModal.tsx"
    - path: "apps/frontend/components/integrations/webhooks/EventSelector.tsx"
    - path: "apps/frontend/components/integrations/webhooks/TestWebhookButton.tsx"
    - path: "apps/frontend/components/integrations/webhooks/WebhookDeliveriesTable.tsx"

database:
  tables:
    - name: "integration_webhooks"
      columns: ["id", "org_id", "name", "url", "events", "status", "secret", "retry_policy", "max_retries", "custom_headers", "last_triggered_at"]
      rls: true
      indexes: ["org_id", "status", "GIN on events"]
    - name: "webhook_deliveries"
      columns: ["id", "webhook_id", "org_id", "event_type", "payload", "status", "http_status", "response_body", "error_message", "attempt_count", "next_retry_at", "duration_ms"]
      rls: true
      indexes: ["webhook_id", "org_id", "status + next_retry_at"]

api_endpoints:
  - method: "POST"
    path: "/api/integrations/webhooks"
    auth: true
    roles: ["SUPER_ADMIN", "ADMIN"]
  - method: "GET"
    path: "/api/integrations/webhooks"
    auth: true
    roles: ["SUPER_ADMIN", "ADMIN", "IT_MANAGER"]

patterns:
  rls: "ADR-013"
  security: "HTTPS only, HMAC-SHA256 signatures"
  delivery: "Background job, async processing"
  retry: "Immediate (5s), Exponential (5s/30s/5m/30m/2h), Manual"
  timeout: "30 seconds per delivery attempt"

acceptance_checklist:
  - "Webhooks created with auto-generated secret"
  - "URL validation enforces HTTPS only"
  - "Event subscription checkboxes functional"
  - "HMAC-SHA256 signatures generated correctly"
  - "HTTP POST delivery with 30s timeout"
  - "Retry policies work (immediate/exponential/manual)"
  - "Test webhook sends sample payload"
  - "Pause/resume toggles delivery"
  - "Delivery logs viewable per webhook"
  - "Admin-only CRUD, IT_MANAGER read-only"
  - "RLS enforces org isolation"
  - "Unit tests >80% coverage"

output_artifacts:
  - "integration_webhooks table with RLS"
  - "webhook_deliveries table with RLS"
  - "trigger_webhook_event() function"
  - "API endpoints for CRUD + test/pause/resume"
  - "WebhookService with delivery, signature, retry"
  - "Background job for async delivery"
  - "Frontend components for webhook management"
  - "Unit + integration + E2E tests"
