# 08.10 - Risk Management

**Priority**: P1 (MVP - Phase 1)
**Story Points**: M (Medium)
**Type**: fullstack
**Estimate**: 3-4 days

**State**: ready
**Primary PRD**: `docs/1-BASELINE/product/modules/npd.md` (Section 6, FR-NPD-48, 49, 50, 51, 52)
**Dependencies**: 08.2 (NPD Projects CRUD)

---

## Goal

Implement risk register CRUD operations with likelihood/impact scoring, risk matrix visualization, and mitigation planning to enable NPD teams to identify, assess, and manage project risks throughout the development lifecycle.

---

## User Story

As an **NPD Lead**, I want to **track and manage project risks with likelihood/impact scoring** so that **I can identify high-priority threats, develop mitigation plans, and ensure successful product launches**.

As an **R&D Manager**, I want to **view a risk matrix visualization** so that **I can quickly identify which projects have critical risks requiring immediate attention**.

---

## Scope

**In scope (this story)**
- GET /api/npd/projects/:id/risks - List risks for project
- POST /api/npd/risks - Create new risk
- PUT /api/npd/risks/:id - Update existing risk
- DELETE /api/npd/risks/:id - Delete risk
- Risk register CRUD with fields: risk_description, likelihood (1-5), impact (1-5), risk_score (calculated), mitigation_plan, status (open/mitigated/closed), owner_id
- Risk scoring formula: risk_score = likelihood × impact (range 1-25)
- Risk matrix visualization: 5×5 grid showing risk distribution
- Risk list sorted by risk_score descending (highest risk first)
- Risk status management: open → mitigated → closed
- Risk filtering by status, owner, score threshold
- Risk detail modal with full information
- Risk owner assignment (user selector)

**Out of scope (this story)**
- Risk templates/library (Phase 2)
- Risk history/audit trail (Phase 2)
- Risk notifications/alerts (Phase 2)
- Risk export to PDF (Phase 2)
- Risk dependencies between projects (Phase 3)
- Automated risk detection (Phase 3)

---

## Dependencies

### Hard Dependencies
| Story | Provides | Status |
|-------|----------|--------|
| 08.2 | NPD Projects CRUD, npd_projects table | Ready |
| 01.1 | Org context + RLS, users table | Ready |

### Soft Dependencies
| Story | Provides | Impact if Missing |
|-------|----------|-------------------|
| 08.3 | Stage-Gate Workflow | Risk gate criteria unavailable (minor) |

---

## Acceptance Criteria (Given/When/Then)

### AC-1: Risk List Display

```gherkin
Scenario: View risk register for project
  Given user navigates to NPD project detail page for NPD-001
  And project has 5 risks
  When user clicks [Risks] tab
  Then risk list displays within 300ms
  And risks sorted by risk_score descending (highest first)
  And list shows columns:
    | Column | Description |
    | Risk Description | First 100 chars with "..." |
    | Likelihood | 1-5 badge |
    | Impact | 1-5 badge |
    | Risk Score | Calculated value (1-25) with color |
    | Status | Badge (Open/Mitigated/Closed) |
    | Owner | User name or "Unassigned" |
    | Actions | Edit, Delete |
```

```gherkin
Scenario: Risk score color coding
  Given risk list displayed
  When viewing risk score column
  Then scores display with colors:
    | Score Range | Color | Severity |
    | 20-25 | Red | Critical |
    | 12-19 | Orange | High |
    | 6-11 | Yellow | Medium |
    | 1-5 | Green | Low |
```

```gherkin
Scenario: Empty risk register
  Given project NPD-001 has no risks
  When viewing risks tab
  Then empty state displays "No risks identified yet"
  And [+ Add Risk] button prominently displayed
```

### AC-2: Create Risk

```gherkin
Scenario: Add new risk
  Given user clicks [+ Add Risk]
  When modal displays
  Then form shows fields:
    | Field | Type | Required |
    | Risk Description | Textarea | Yes |
    | Likelihood | Select (1-5) | Yes |
    | Impact | Select (1-5) | Yes |
    | Risk Score | Calculated (read-only) | Auto |
    | Mitigation Plan | Textarea | No |
    | Status | Select | Yes (default: Open) |
    | Risk Owner | User selector | No |
  And risk score auto-calculates as user selects likelihood/impact
```

```gherkin
Scenario: Risk score auto-calculation
  Given add risk modal open
  When user selects Likelihood = 5 (High)
  And user selects Impact = 5 (High)
  Then risk score displays "25" with red badge "Critical"
```

```gherkin
Scenario: Create risk successfully
  Given add risk modal with valid data:
    | Field | Value |
    | Risk Description | Supplier lead time延长 delays launch |
    | Likelihood | 4 |
    | Impact | 5 |
    | Mitigation Plan | Identify backup suppliers |
    | Status | Open |
    | Owner | John Doe |
  When user clicks [Save Risk]
  Then risk created with risk_score = 20 (4 × 5)
  And risk appears at top of list (sorted by score)
  And success toast "Risk added successfully"
  And modal closes
```

```gherkin
Scenario: Create risk validation - missing description
  Given add risk modal
  When user leaves risk_description empty
  And clicks [Save Risk]
  Then error "Risk description is required" displays
  And save button disabled
```

```gherkin
Scenario: Create risk validation - invalid likelihood
  Given add risk modal
  When user selects likelihood = 0 or > 5
  Then error "Likelihood must be between 1 and 5" displays
```

### AC-3: Edit Risk

```gherkin
Scenario: Update existing risk
  Given user clicks [Edit] on risk "Supplier delay"
  When modal displays
  Then form pre-populated with current values
  And user updates Impact from 5 to 3
  And clicks [Update Risk]
  Then risk_score recalculates (4 × 3 = 12)
  And risk moves down in list (sorted by score)
  And success toast "Risk updated"
```

```gherkin
Scenario: Update risk status to mitigated
  Given risk status = "Open"
  When user edits risk
  And changes status to "Mitigated"
  And provides mitigation notes
  Then risk status updates
  And risk moves to "Mitigated" filter section
```

```gherkin
Scenario: Close risk
  Given risk status = "Mitigated"
  When user changes status to "Closed"
  Then risk status updates to "Closed"
  And risk hidden from default view (only shows in "All" or "Closed" filter)
```

### AC-4: Delete Risk

```gherkin
Scenario: Delete risk with confirmation
  Given user clicks [Delete] on risk
  When confirmation dialog displays "Delete this risk? This action cannot be undone."
  And user confirms
  Then risk deleted from database
  And removed from list immediately
  And success toast "Risk deleted"
```

```gherkin
Scenario: Cancel delete
  Given delete confirmation dialog displayed
  When user clicks [Cancel]
  Then dialog closes
  And risk remains in list
```

### AC-5: Risk Matrix Visualization

```gherkin
Scenario: View risk matrix
  Given user clicks [Risk Matrix] button on risks tab
  When matrix modal displays
  Then 5×5 grid shows:
    | Y-axis | Impact (1-5, bottom to top) |
    | X-axis | Likelihood (1-5, left to right) |
    | Cells | Risk count badges in each cell |
  And cell colors match risk score ranges (red/orange/yellow/green)
```

```gherkin
Scenario: Risk matrix cell data
  Given project has risks:
    | Risk | Likelihood | Impact | Score |
    | A | 5 | 5 | 25 |
    | B | 4 | 4 | 16 |
    | C | 2 | 3 | 6 |
  When viewing risk matrix
  Then cell [5, 5] shows badge "1" (red)
  And cell [4, 4] shows badge "1" (orange)
  And cell [2, 3] shows badge "1" (yellow)
  And empty cells show no badge
```

```gherkin
Scenario: Click risk matrix cell
  Given risk matrix displayed
  When user clicks cell [5, 5] with 2 risks
  Then cell expands or tooltip shows:
    | Risk 1 | Supplier delay (Score: 25) |
    | Risk 2 | Regulatory approval (Score: 25) |
  And clicking risk name navigates to risk detail
```

```gherkin
Scenario: Empty risk matrix
  Given project has no risks
  When viewing risk matrix
  Then all cells empty
  And message "No risks to display. Add risks to see matrix."
```

### AC-6: Risk Filtering

```gherkin
Scenario: Filter by status
  Given risk list displayed with 10 risks (5 open, 3 mitigated, 2 closed)
  When user selects filter "Status: Open"
  Then only 5 open risks display
  And risk count badge shows "5"
```

```gherkin
Scenario: Filter by owner
  Given risk list with risks assigned to John, Jane, Unassigned
  When user selects filter "Owner: John Doe"
  Then only John's risks display
```

```gherkin
Scenario: Filter by risk score threshold
  Given risk list with scores ranging 1-25
  When user sets filter "Score ≥ 12" (High and Critical)
  Then only risks with score ≥ 12 display (orange and red)
  And list shows "Showing 3 of 10 risks (High & Critical only)"
```

```gherkin
Scenario: Combined filters
  Given user sets filters:
    | Filter | Value |
    | Status | Open |
    | Owner | John Doe |
    | Score Threshold | ≥ 12 |
  Then only risks matching all criteria display
  And filter summary shows "Filters: Open, John Doe, Score ≥12 (2 results)"
```

```gherkin
Scenario: Clear filters
  Given filters applied
  When user clicks [Clear Filters]
  Then all risks display
  And filter controls reset to defaults
```

### AC-7: Risk Sorting

```gherkin
Scenario: Default sort by risk score descending
  Given risk list loaded
  When viewing list
  Then risks sorted by risk_score DESC (highest first)
  And sort indicator shows "Score ↓"
```

```gherkin
Scenario: Sort by status
  Given user clicks [Status] column header
  When sort applied
  Then risks sorted: Open → Mitigated → Closed
  And sort indicator shows "Status ↓"
```

```gherkin
Scenario: Sort by owner
  Given user clicks [Owner] column header
  Then risks sorted alphabetically by owner name
  And unassigned risks appear at end
```

### AC-8: Risk Detail Modal

```gherkin
Scenario: View full risk details
  Given user clicks risk row in list
  When detail modal displays
  Then shows:
    | Section | Content |
    | Header | Risk description (full text) |
    | Scoring | Likelihood (badge), Impact (badge), Risk Score (large badge with color) |
    | Status | Current status with badge |
    | Owner | User avatar + name or "Unassigned" |
    | Mitigation | Mitigation plan text (if provided) |
    | Audit | Created by, Created at, Last updated |
    | Actions | [Edit], [Delete], [Close] |
```

```gherkin
Scenario: Edit from detail modal
  Given risk detail modal displayed
  When user clicks [Edit]
  Then edit modal opens with current values
  And user can update fields
```

```gherkin
Scenario: Close risk from detail modal
  Given risk status = "Mitigated"
  And detail modal displayed
  When user clicks [Close Risk]
  Then confirmation "Close this risk?"
  And status updates to "Closed"
  And detail modal refreshes to show closed status
```

### AC-9: Risk Owner Assignment

```gherkin
Scenario: Assign owner to risk
  Given add/edit risk modal
  When user clicks [Owner] field
  Then user selector displays with:
    | Option | Users with NPD_LEAD or R&D roles in org |
    | Default | "Unassigned" |
  And user selects "John Doe"
  Then owner_id set to John's user ID
```

```gherkin
Scenario: Unassign owner
  Given risk has owner "John Doe"
  When user edits risk
  And selects "Unassigned" in owner field
  Then owner_id set to NULL
  And risk list shows "Unassigned" in owner column
```

```gherkin
Scenario: Owner filter shows all owners
  Given project has risks assigned to 3 different users
  When user opens owner filter dropdown
  Then dropdown shows:
    | Option |
    | All Owners |
    | Unassigned |
    | John Doe (3 risks) |
    | Jane Smith (2 risks) |
    | Bob Johnson (1 risk) |
```

### AC-10: Permission Enforcement

```gherkin
Scenario: NPD Lead permissions
  Given user has NPD_LEAD role
  Then can create, edit, delete any risk
  And can assign any user as owner
```

```gherkin
Scenario: R&D permissions
  Given user has R&D role
  And risk is assigned to current user
  Then can edit own risks
  And cannot delete risks created by others
  And cannot reassign owner to others
```

```gherkin
Scenario: Viewer permissions
  Given user has VIEWER role
  When viewing risks tab
  Then [+ Add Risk] button hidden
  And [Edit], [Delete] actions hidden
  And risk list is read-only
  And can view risk detail modal
```

---

## Implementation Notes

### API Endpoints

```typescript
// GET /api/npd/projects/:projectId/risks
interface RisksListResponse {
  risks: RiskWithOwner[];
  total: number;
  summary: {
    total_count: number;
    open_count: number;
    mitigated_count: number;
    closed_count: number;
    critical_count: number; // score >= 20
    high_count: number; // score >= 12
  };
}

interface RiskWithOwner {
  id: number;
  org_id: string;
  npd_project_id: number;
  risk_description: string;
  likelihood: 1 | 2 | 3 | 4 | 5;
  impact: 1 | 2 | 3 | 4 | 5;
  risk_score: number; // likelihood × impact (1-25)
  mitigation_plan: string | null;
  status: 'open' | 'mitigated' | 'closed';
  owner_id: string | null;
  owner: {
    id: string;
    name: string;
    email: string;
  } | null;
  created_at: string;
  updated_at: string;
  created_by: string;
  created_by_name: string;
}

// POST /api/npd/risks
interface CreateRiskRequest {
  npd_project_id: number;
  risk_description: string; // min 10 chars, max 2000
  likelihood: 1 | 2 | 3 | 4 | 5;
  impact: 1 | 2 | 3 | 4 | 5;
  mitigation_plan?: string; // optional, max 2000
  status?: 'open' | 'mitigated' | 'closed'; // default: 'open'
  owner_id?: string | null; // optional
}

// PUT /api/npd/risks/:id
interface UpdateRiskRequest {
  risk_description?: string;
  likelihood?: 1 | 2 | 3 | 4 | 5;
  impact?: 1 | 2 | 3 | 4 | 5;
  mitigation_plan?: string | null;
  status?: 'open' | 'mitigated' | 'closed';
  owner_id?: string | null;
}

// DELETE /api/npd/risks/:id
// Returns 204 No Content on success

// GET /api/npd/projects/:projectId/risks/matrix
interface RiskMatrixResponse {
  project: {
    id: number;
    project_number: string;
    project_name: string;
  };
  matrix: RiskMatrixCell[][];
  total_risks: number;
}

interface RiskMatrixCell {
  likelihood: 1 | 2 | 3 | 4 | 5;
  impact: 1 | 2 | 3 | 4 | 5;
  count: number;
  risk_score: number;
  severity: 'critical' | 'high' | 'medium' | 'low';
  risks: RiskMatrixRisk[];
}

interface RiskMatrixRisk {
  id: number;
  risk_description: string; // truncated to 100 chars
  status: 'open' | 'mitigated' | 'closed';
  owner_name: string | null;
}
```

### Database Migration

```sql
-- npd_risks table (from PRD)
CREATE TABLE npd_risks (
    id SERIAL PRIMARY KEY,
    org_id UUID NOT NULL REFERENCES organizations(id),
    npd_project_id INTEGER NOT NULL REFERENCES npd_projects(id) ON DELETE CASCADE,
    risk_description TEXT NOT NULL CHECK (char_length(risk_description) >= 10),
    likelihood INTEGER NOT NULL CHECK (likelihood BETWEEN 1 AND 5),
    impact INTEGER NOT NULL CHECK (impact BETWEEN 1 AND 5),
    risk_score INTEGER NOT NULL, -- calculated: likelihood × impact
    mitigation_plan TEXT,
    status VARCHAR(20) NOT NULL DEFAULT 'open' CHECK (status IN ('open', 'mitigated', 'closed')),
    owner_id UUID REFERENCES users(id),
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    created_by UUID REFERENCES users(id),
    updated_by UUID REFERENCES users(id)
);

-- Indexes
CREATE INDEX idx_npd_risks_org_project ON npd_risks(org_id, npd_project_id);
CREATE INDEX idx_npd_risks_project_score ON npd_risks(npd_project_id, risk_score DESC);
CREATE INDEX idx_npd_risks_status ON npd_risks(npd_project_id, status);
CREATE INDEX idx_npd_risks_owner ON npd_risks(owner_id) WHERE owner_id IS NOT NULL;

-- RLS Policies
ALTER TABLE npd_risks ENABLE ROW LEVEL SECURITY;

CREATE POLICY "npd_risks_select" ON npd_risks
    FOR SELECT USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

CREATE POLICY "npd_risks_insert" ON npd_risks
    FOR INSERT WITH CHECK (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

CREATE POLICY "npd_risks_update" ON npd_risks
    FOR UPDATE USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

CREATE POLICY "npd_risks_delete" ON npd_risks
    FOR DELETE USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

-- Auto-calculate risk_score trigger
CREATE OR REPLACE FUNCTION calculate_risk_score()
RETURNS TRIGGER AS $$
BEGIN
  NEW.risk_score := NEW.likelihood * NEW.impact;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_calculate_risk_score
BEFORE INSERT OR UPDATE OF likelihood, impact ON npd_risks
FOR EACH ROW EXECUTE FUNCTION calculate_risk_score();

-- Updated_at trigger
CREATE TRIGGER update_npd_risks_updated_at
    BEFORE UPDATE ON npd_risks
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();
```

### Service Layer

```typescript
// lib/services/risk-service.ts

export class RiskService {
  /**
   * List risks for project with filtering and sorting
   */
  static async listRisks(
    projectId: number,
    filters?: {
      status?: 'open' | 'mitigated' | 'closed';
      owner_id?: string;
      min_score?: number;
    },
    sortBy: string = 'risk_score',
    sortOrder: 'asc' | 'desc' = 'desc'
  ): Promise<RisksListResponse>;

  /**
   * Get single risk by ID
   */
  static async getRisk(id: number): Promise<RiskWithOwner>;

  /**
   * Create new risk
   */
  static async createRisk(data: CreateRiskRequest): Promise<RiskWithOwner> {
    // 1. Validate npd_project_id exists
    // 2. Validate owner_id exists (if provided)
    // 3. Calculate risk_score (done by trigger)
    // 4. Insert risk record
    // 5. Return risk with owner joined
  }

  /**
   * Update existing risk
   */
  static async updateRisk(id: number, data: UpdateRiskRequest): Promise<RiskWithOwner> {
    // 1. Validate risk exists
    // 2. Validate new owner_id (if provided)
    // 3. Update risk (risk_score recalculated by trigger if likelihood/impact changed)
    // 4. Return updated risk with owner joined
  }

  /**
   * Delete risk
   */
  static async deleteRisk(id: number): Promise<void>;

  /**
   * Get risk matrix data for visualization
   */
  static async getRiskMatrix(projectId: number): Promise<RiskMatrixResponse> {
    // 1. Fetch all open/mitigated risks for project
    // 2. Build 5×5 matrix (likelihood × impact)
    // 3. Count risks in each cell
    // 4. Categorize severity (critical/high/medium/low)
    // 5. Return matrix with risk details per cell
  }

  /**
   * Get risk summary counts
   */
  static async getRiskSummary(projectId: number): Promise<RiskSummary> {
    // Count by status, count by severity
  }

  /**
   * Calculate severity level from risk_score
   */
  static calculateSeverity(score: number): 'critical' | 'high' | 'medium' | 'low' {
    if (score >= 20) return 'critical'; // 20-25
    if (score >= 12) return 'high';     // 12-19
    if (score >= 6) return 'medium';    // 6-11
    return 'low';                       // 1-5
  }

  /**
   * Validate user can edit risk (permission check)
   */
  static async canEditRisk(riskId: number, userId: string): Promise<boolean>;
}
```

### Frontend Components

```
app/(authenticated)/npd/projects/[id]/page.tsx -- Project detail with risks tab

components/npd/risk/
  RiskRegisterTable.tsx          -- Risk list table with sorting, filtering
  RiskFilters.tsx                -- Filter panel (status, owner, score threshold)
  RiskScoreBadge.tsx             -- Color-coded score badge (1-25)
  RiskStatusBadge.tsx            -- Status badge (Open/Mitigated/Closed)
  RiskSeverityBadge.tsx          -- Severity label (Critical/High/Medium/Low)
  RiskLikelihoodSelect.tsx       -- Likelihood dropdown (1-5)
  RiskImpactSelect.tsx           -- Impact dropdown (1-5)
  CreateRiskModal.tsx            -- Create risk modal
  EditRiskModal.tsx              -- Edit risk modal
  RiskDetailModal.tsx            -- View full risk details
  DeleteRiskDialog.tsx           -- Delete confirmation
  RiskMatrix.tsx                 -- 5×5 risk matrix visualization
  RiskMatrixCell.tsx             -- Individual matrix cell
  RiskMatrixLegend.tsx           -- Legend for severity colors
  RiskSummaryCards.tsx           -- Summary stats (total, critical, high, etc.)
  RiskOwnerSelector.tsx          -- User selector for risk owner
```

### Validation (Zod)

```typescript
const likelihoodEnum = z.union([
  z.literal(1),
  z.literal(2),
  z.literal(3),
  z.literal(4),
  z.literal(5),
]);

const impactEnum = z.union([
  z.literal(1),
  z.literal(2),
  z.literal(3),
  z.literal(4),
  z.literal(5),
]);

const riskStatusEnum = z.enum(['open', 'mitigated', 'closed']);

const createRiskSchema = z.object({
  npd_project_id: z.number().int().positive("Invalid project ID"),
  risk_description: z.string()
    .min(10, "Risk description must be at least 10 characters")
    .max(2000, "Risk description too long"),
  likelihood: likelihoodEnum,
  impact: impactEnum,
  mitigation_plan: z.string()
    .max(2000, "Mitigation plan too long")
    .optional()
    .nullable(),
  status: riskStatusEnum.default('open'),
  owner_id: z.string().uuid("Invalid owner ID").optional().nullable(),
});

const updateRiskSchema = createRiskSchema.partial().omit({ npd_project_id: true });

const riskListQuerySchema = z.object({
  status: riskStatusEnum.optional(),
  owner_id: z.string().uuid().optional(),
  min_score: z.coerce.number().int().min(1).max(25).optional(),
  sort_by: z.enum(['risk_score', 'status', 'owner', 'created_at']).default('risk_score'),
  sort_order: z.enum(['asc', 'desc']).default('desc'),
});
```

---

## Deliverables

### Database
- [ ] npd_risks table migration with constraints
- [ ] calculate_risk_score() trigger function
- [ ] RLS policies for npd_risks
- [ ] Indexes for performance

### API Routes
- [ ] GET /api/npd/projects/:projectId/risks
- [ ] POST /api/npd/risks
- [ ] PUT /api/npd/risks/:id
- [ ] DELETE /api/npd/risks/:id
- [ ] GET /api/npd/projects/:projectId/risks/matrix

### Service Layer
- [ ] RiskService.listRisks()
- [ ] RiskService.getRisk()
- [ ] RiskService.createRisk()
- [ ] RiskService.updateRisk()
- [ ] RiskService.deleteRisk()
- [ ] RiskService.getRiskMatrix()
- [ ] RiskService.calculateSeverity()

### Frontend
- [ ] Risks tab in project detail page
- [ ] RiskRegisterTable with sorting and filtering
- [ ] CreateRiskModal with auto-calculating score
- [ ] EditRiskModal
- [ ] RiskDetailModal
- [ ] DeleteRiskDialog
- [ ] RiskMatrix 5×5 visualization
- [ ] RiskScoreBadge, RiskStatusBadge, RiskSeverityBadge
- [ ] RiskFilters component
- [ ] RiskSummaryCards
- [ ] RiskOwnerSelector

### Validation
- [ ] createRiskSchema (Zod)
- [ ] updateRiskSchema (Zod)
- [ ] riskListQuerySchema (Zod)

### Tests
- [ ] Integration test: GET /api/npd/projects/:id/risks
- [ ] Integration test: POST /api/npd/risks
- [ ] Integration test: PUT /api/npd/risks/:id
- [ ] Integration test: DELETE /api/npd/risks/:id
- [ ] Integration test: GET /api/npd/projects/:id/risks/matrix
- [ ] Unit test: RiskService.createRisk()
- [ ] Unit test: RiskService.updateRisk()
- [ ] Unit test: RiskService.getRiskMatrix()
- [ ] Unit test: RiskService.calculateSeverity()
- [ ] Unit test: calculate_risk_score() trigger
- [ ] E2E test: Full risk CRUD workflow
- [ ] E2E test: Risk matrix visualization

---

## Definition of Done

- [ ] Risk list loads within 300ms for 50 risks
- [ ] Create risk modal auto-calculates risk_score on likelihood/impact change
- [ ] Risk score badge displays correct color (red/orange/yellow/green)
- [ ] Risks sorted by risk_score descending by default
- [ ] Risk status filter works (Open/Mitigated/Closed)
- [ ] Risk owner filter shows all assigned users
- [ ] Risk score threshold filter works (≥12, ≥20)
- [ ] Risk matrix displays 5×5 grid with correct cell counts
- [ ] Risk matrix cells color-coded by severity
- [ ] Risk matrix cells clickable with risk details
- [ ] Edit risk updates risk_score automatically
- [ ] Delete risk requires confirmation
- [ ] Risk owner selector shows NPD_LEAD and R&D users
- [ ] Unassigned risks show "Unassigned" in owner column
- [ ] Permission checks hide create/edit/delete for VIEWER role
- [ ] Empty state displays when no risks exist
- [ ] All API endpoints return correct status codes
- [ ] Integration tests cover all CRUD operations
- [ ] Unit tests achieve >80% coverage on RiskService
- [ ] E2E tests verify full risk workflow and matrix visualization
- [ ] Error states display clear messages with retry option

---

## Risk Assessment

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Risk matrix performance with many risks | MEDIUM | LOW | Limit display to 100 risks, pagination |
| User confusion with likelihood/impact scale | MEDIUM | MEDIUM | Clear labels (1=Very Low, 5=Very High), help tooltips |
| Risk score calculation errors | HIGH | LOW | Database trigger ensures consistency, comprehensive tests |
| Permission complexity (owner vs creator) | MEDIUM | MEDIUM | Clear permission logic, owner can edit own risks |
| Risk filtering performance | LOW | LOW | Database indexes on status, owner_id, risk_score |

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2026-01-15 | Initial version - Risk Management | ARCHITECT-AGENT |

---

**Document Status**: Ready for Implementation
**Created**: 2026-01-15
**Lines**: ~750
**Complexity**: M (Medium)
**Phase**: 1 (MVP)
