# 08.11 - Handoff Wizard

**Priority**: P0 (Critical - Handoff Blocker)
**Story Points**: L (Large)
**Type**: fullstack
**Estimate**: 5-6 days

**State**: ready
**Primary PRD**: `docs/1-BASELINE/product/modules/npd.md` (Section 8, FR-NPD-37 to FR-NPD-47)
**Dependencies**: 08.2, 08.4, 08.6, 08.7, 08.8, 02.2, 03.2

---

## Goal

Implement an 8-step handoff wizard that transfers approved NPD formulations to production by creating Products, BOMs, and optional Pilot Work Orders with full validation, transactional execution, and rollback on failure.

---

## User Story

As an **NPD Lead**, I want to **hand off an approved formulation to production through a guided wizard** so that **I can seamlessly transition from development to manufacturing with proper validation and traceability**.

As a **Production Manager**, I want to **receive validated product specifications from NPD** so that **I can execute pilot runs and commercial production without data re-entry**.

---

## Scope

**In scope (this story)**
- POST /api/npd/projects/:id/handoff/validate - Pre-handoff validation
- POST /api/npd/projects/:id/handoff/execute - Execute handoff transactionally
- 8-step wizard UI at `/npd/projects/:id/handoff`
- Step 1: Validation Checklist (G4 complete, costing approved, compliance docs uploaded, formulation locked)
- Step 2: Product Decision (create new product or update existing product with new BOM version)
- Step 3: BOM Generation Preview (formulation items ‚Üí bom_items mapping)
- Step 4: Pilot WO Toggle (optional pilot work order creation)
- Step 5: Routing Selection (for pilot WO if enabled)
- Step 6: Summary Review (all handoff actions)
- Step 7: Execute Transactional Handoff (database transaction)
- Step 8: Success Confirmation (with links to created records)
- Rollback on failure (database transaction rollback)
- Handoff event logging (npd_events table)
- Status update: project status ‚Üí 'launched', formulation status ‚Üí 'locked'
- Validation blockers prevent wizard progression
- Dual mode support: Integrated (with Production) vs NPD-Only (export PDF)

**Out of scope (this story)**
- NPD-only mode PDF export (Phase 2)
- Multi-formulation handoff (Phase 2)
- Handoff scheduling (Phase 2)
- Handoff approval workflow (Phase 3)
- Automated handoff triggers (Phase 3)

---

## Dependencies

### Hard Dependencies
| Story | Provides | Status |
|-------|----------|--------|
| 08.2 | NPD Projects CRUD, npd_projects table | Ready |
| 08.4 | Formulations CRUD, npd_formulations table | Ready |
| 08.6 | Gate Approvals, gate checklist completion | Ready |
| 08.7 | Formulation Costing, costing approval | Ready |
| 08.8 | Compliance Documents, document upload | Ready |
| 02.2 | BOMs CRUD, boms table | Ready |
| 02.1 | Products CRUD, products table | Ready |
| 03.2 | Work Orders CRUD, work_orders table | Ready |
| 01.1 | Org context + RLS | Ready |

### Soft Dependencies
| Story | Provides | Impact if Missing |
|-------|----------|-------------------|
| 04.1 | Routings CRUD | Cannot select routing for pilot WO (manual entry) |
| 08.5 | Allergen Aggregation | Allergens not transferred to BOM (minor) |

---

## Acceptance Criteria (Given/When/Then)

### AC-1: Access Handoff Wizard

```gherkin
Scenario: Navigate to handoff wizard from project detail
  Given user viewing NPD project NPD-001 at gate G4
  And project status = 'testing'
  When user clicks [Start Handoff] button
  Then navigates to /npd/projects/:id/handoff
  And Step 1 (Validation Checklist) loads within 500ms
```

```gherkin
Scenario: Handoff blocked if not at G4
  Given project NPD-001 at gate G3
  When user attempts to access handoff wizard
  Then error "Handoff only available at Gate G4"
  And [Start Handoff] button disabled with tooltip
```

```gherkin
Scenario: Handoff blocked if already launched
  Given project NPD-001 status = 'launched'
  When user attempts handoff
  Then error "Project already handed off"
  And wizard unavailable
```

### AC-2: Step 1 - Validation Checklist

```gherkin
Scenario: Validation checklist displays
  Given handoff wizard at Step 1
  When page loads
  Then checklist displays items:
    | Check | Description | Status |
    | Gate G4 Complete | All G4 checklist items marked complete | Pass/Fail |
    | Formulation Locked | Active formulation status = 'locked' | Pass/Fail |
    | Costing Approved | Costing status = 'approved' by Finance | Pass/Fail |
    | Compliance Docs Complete | Required doc types uploaded (HACCP, Label) | Pass/Fail |
    | Allergen Declaration | Allergens aggregated (if feature enabled) | Pass/Fail |
  And each item shows ‚úÖ or ‚ùå icon
```

```gherkin
Scenario: All validations pass
  Given all validation checks pass (‚úÖ)
  When viewing Step 1
  Then [Next: Product Selection] button enabled
  And summary shows "All checks passed - Ready for handoff"
```

```gherkin
Scenario: Validation failure - G4 not complete
  Given project has incomplete G4 checklist items
  When viewing Step 1
  Then "Gate G4 Complete" shows ‚ùå
  And blocker message "Complete all G4 checklist items before handoff"
  And [Fix Issue] button links to gate checklist
  And [Next] button disabled
```

```gherkin
Scenario: Validation failure - Formulation not locked
  Given active formulation status = 'approved' (not locked)
  When viewing Step 1
  Then "Formulation Locked" shows ‚ùå
  And blocker message "Lock formulation v2.0 before handoff"
  And [Lock Formulation] button available
  And [Next] button disabled
```

```gherkin
Scenario: Validation failure - Costing not approved
  Given costing status = 'submitted' (pending approval)
  When viewing Step 1
  Then "Costing Approved" shows ‚ùå
  And blocker message "Finance approval required for costing"
  And [Next] button disabled
```

```gherkin
Scenario: Validation failure - Missing compliance docs
  Given required doc types: HACCP, Label Proof
  And only HACCP uploaded
  When viewing Step 1
  Then "Compliance Docs Complete" shows ‚ùå
  And blocker message "Missing: Label Proof"
  And [Upload Documents] button links to documents tab
  And [Next] button disabled
```

```gherkin
Scenario: Fix validation issues and re-check
  Given validation checklist with failures
  When user clicks [Re-check Validation]
  Then validation runs again
  And checklist updates with current status
  And [Next] button enables if all pass
```

### AC-3: Step 2 - Product Decision

```gherkin
Scenario: Product creation options
  Given validation passed (Step 1)
  And user navigates to Step 2
  When page loads
  Then displays radio options:
    | Option | Description |
    | Create New Product | Create a new product record |
    | Update Existing Product | Add new BOM version to existing product |
  And default selection = "Create New Product"
```

```gherkin
Scenario: Create new product
  Given "Create New Product" selected
  When viewing form
  Then fields display:
    | Field | Default Value | Editable |
    | Product Code | Auto-generated (PROD-NPD-001) | Yes |
    | Product Name | Project name (copy) | Yes |
    | Product Type | Finished Good (default) | Yes |
    | Description | Formulation notes (copy) | Yes |
    | UoM | Formulation UoM (kg) | Yes |
    | Status | draft (locked) | No |
  And user can edit all fields except status
  And [Next: BOM Preview] button enabled
```

```gherkin
Scenario: Update existing product
  Given "Update Existing Product" selected
  When viewing form
  Then product selector displays with search:
    | Products | Active products in org |
  And user searches "Burger"
  And selects "Premium Beef Burger (PROD-001)"
  Then selected product details display:
    | Product Code | PROD-001 (locked) |
    | Product Name | Premium Beef Burger (locked) |
    | Current BOM | BOM-PROD-001-v1.2 (effective) |
  And message "New BOM version will be created for this product"
  And [Next: BOM Preview] button enabled
```

```gherkin
Scenario: Validation - Duplicate product code
  Given "Create New Product" selected
  And user enters product code "PROD-001" (exists)
  When user clicks [Next]
  Then error "Product code PROD-001 already exists"
  And [Next] button disabled until code changed
```

```gherkin
Scenario: Validation - Product name required
  Given product name field empty
  When user attempts [Next]
  Then error "Product name is required"
  And [Next] button disabled
```

### AC-4: Step 3 - BOM Generation Preview

```gherkin
Scenario: BOM preview displays
  Given Step 2 completed (product decision made)
  When Step 3 loads
  Then BOM preview table displays:
    | Column | Content |
    | Source Item | Formulation item (product name, qty, uom, %) |
    | ‚Üí | Arrow indicator |
    | BOM Item | Mapped bom_item (same product, qty, uom, %) |
    | Item Type | input (default for all) |
    | Notes | Formulation item notes (copied) |
  And all formulation items mapped 1:1 to bom_items
```

```gherkin
Scenario: BOM metadata display
  Given BOM preview loaded
  When viewing BOM header section
  Then shows:
    | Field | Value |
    | BOM Number | Auto-generated (BOM-PROD-NPD-001-v1.0) |
    | Product | Selected product (PROD-NPD-001) |
    | BOM Version | v1.0 (first version for new product) or v1.3 (next for existing) |
    | Status | draft (locked) |
    | Effective From | [Date picker - default: today] |
    | Effective To | [Date picker - optional] |
    | Total Qty | Formulation total_qty (100 kg) |
    | Source | NPD Formulation v2.0 (link) |
  And user can edit effective dates only
```

```gherkin
Scenario: Allergen transfer (if 08.5 available)
  Given formulation has allergen data
  When BOM preview loads
  Then allergen section displays:
    | Allergen | Status |
    | Contains: Gluten, Dairy | From formulation |
  And message "Allergens will be transferred to BOM"
```

```gherkin
Scenario: BOM item type override (Phase 2 - future)
  Given BOM preview displayed
  When user clicks item type dropdown (Phase 2)
  Then can change from 'input' to 'output' (co-products)
  And percentage recalculates (Phase 2 feature - deferred)
```

```gherkin
Scenario: Validation - Effective date range
  Given user sets effective_from = 2025-01-01
  And effective_to = 2024-12-31 (before effective_from)
  When user clicks [Next]
  Then error "Effective To must be after Effective From"
  And [Next] button disabled
```

### AC-5: Step 4 - Pilot WO Toggle

```gherkin
Scenario: Pilot WO option display
  Given Step 3 completed (BOM preview confirmed)
  When Step 4 loads
  Then toggle displays:
    | Option | Description |
    | Create Pilot Work Order | Optional - Create small batch trial WO |
  And default = ON (enabled)
  And pilot WO form displays
```

```gherkin
Scenario: Pilot WO form fields
  Given "Create Pilot Work Order" toggle ON
  When viewing form
  Then fields display:
    | Field | Default Value | Editable |
    | WO Number | Auto-generated (WO-PILOT-NPD-001) | No |
    | WO Type | pilot (locked) | No |
    | Product | Selected product (PROD-NPD-001) | No |
    | BOM | New BOM (BOM-PROD-NPD-001-v1.0) | No |
    | Quantity | Formulation total_qty (100 kg) | Yes |
    | UoM | Product UoM (kg) | No |
    | Scheduled Date | [Date picker - default: +7 days] | Yes |
    | Status | planned (locked) | No |
    | NPD Project Link | NPD-001 (locked) | No |
  And user can edit quantity and scheduled date
```

```gherkin
Scenario: Skip pilot WO
  Given "Create Pilot Work Order" toggle ON
  When user toggles OFF
  Then pilot WO form hides
  And message "Pilot WO will not be created"
  And [Next: Routing Selection] skips to Step 6 (Summary)
```

```gherkin
Scenario: Pilot WO quantity validation
  Given pilot WO quantity = 0
  When user attempts [Next]
  Then error "Pilot WO quantity must be greater than 0"
  And [Next] button disabled
```

### AC-6: Step 5 - Routing Selection (Optional)

```gherkin
Scenario: Routing selection displays (if pilot WO enabled)
  Given "Create Pilot Work Order" toggle ON
  When Step 5 loads
  Then routing selector displays:
    | Field | Options |
    | Routing | Dropdown with active routings in org |
    | Default Routing | From npd_settings.default_pilot_routing (if set) |
  And user can select routing or skip
```

```gherkin
Scenario: Default routing pre-selected
  Given npd_settings.default_pilot_routing = "ROUTING-TRIAL-001"
  When Step 5 loads
  Then routing selector pre-populated with "ROUTING-TRIAL-001"
  And user can change or accept default
```

```gherkin
Scenario: No default routing
  Given npd_settings.default_pilot_routing = NULL
  When Step 5 loads
  Then routing selector shows "No routing selected (optional)"
  And message "Routing can be assigned later to pilot WO"
  And [Next: Summary] button enabled (routing optional)
```

```gherkin
Scenario: Skip routing selection
  Given routing selector displayed
  When user clicks [Skip - No Routing]
  Then routing_id = NULL for pilot WO
  And navigates to Step 6 (Summary)
```

### AC-7: Step 6 - Summary Review

```gherkin
Scenario: Summary displays all handoff actions
  Given all wizard steps completed
  When Step 6 (Summary) loads
  Then summary displays sections:
    | Section | Content |
    | Validation Status | All checks passed ‚úÖ |
    | Product Action | "Create new product: PROD-NPD-001 - Premium Burger" OR "Update product: PROD-001 with new BOM v1.3" |
    | BOM Creation | "BOM-PROD-NPD-001-v1.0 (15 items, effective 2025-01-01)" |
    | Pilot WO | "Create WO-PILOT-NPD-001 (100 kg, scheduled 2025-01-08)" OR "No pilot WO" |
    | Routing | "ROUTING-TRIAL-001" OR "No routing assigned" |
    | Project Status Update | "NPD-001 status: testing ‚Üí launched" |
    | Formulation Lock | "Formulation v2.0 locked (immutable)" |
  And all details editable via [‚Üê Back] navigation
```

```gherkin
Scenario: Summary review with warnings
  Given BOM effective_from = 2025-06-01 (future date)
  When viewing summary
  Then warning displays "BOM effective from 2025-06-01 (future) - Product not available for production until then"
  And user can proceed or go back to edit
```

```gherkin
Scenario: Edit from summary
  Given summary displayed
  When user clicks [‚Üê Back to Product Selection]
  Then navigates to Step 2
  And current selections preserved (form pre-filled)
  And user can modify and re-confirm
```

### AC-8: Step 7 - Execute Handoff (Transactional)

```gherkin
Scenario: Execute handoff successfully
  Given summary reviewed and confirmed
  When user clicks [Execute Handoff]
  Then progress indicator shows "Creating product..."
  And database transaction begins
  And steps execute in order:
    1. Lock formulation (status = 'locked')
    2. Create/update product record
    3. Create BOM record
    4. Copy formulation_items to bom_items (15 items)
    5. Create pilot WO (if enabled)
    6. Link WO to routing (if selected)
    7. Update project status to 'launched'
    8. Log handoff event to npd_events
    9. Commit transaction
  And navigates to Step 8 (Success) within 5 seconds
```

```gherkin
Scenario: Handoff transaction rollback on failure
  Given handoff execution started
  And step 4 (create BOM) fails (e.g., duplicate BOM number)
  When failure detected
  Then transaction rolls back (no records created)
  And error displays "Handoff failed: Duplicate BOM number"
  And user returns to Step 6 (Summary) with error message
  And project status remains 'testing' (not changed)
  And formulation status remains 'approved' (not locked)
```

```gherkin
Scenario: Handoff event logging
  Given handoff executed successfully
  When viewing npd_events table
  Then event created with:
    | Field | Value |
    | event_type | NPD.HandoffCompleted |
    | entity_type | npd_project |
    | entity_id | NPD-001 ID |
    | payload | JSON with product_id, bom_id, wo_id, formulation_id |
    | status | completed |
    | created_at | Execution timestamp |
```

```gherkin
Scenario: Concurrent handoff prevention
  Given user A starts handoff for NPD-001
  And user B attempts handoff for NPD-001 simultaneously
  When user B clicks [Execute Handoff]
  Then error "Handoff already in progress or completed by another user"
  And execution blocked (optimistic locking)
```

### AC-9: Step 8 - Success Confirmation

```gherkin
Scenario: Success page displays
  Given handoff executed successfully
  When Step 8 loads
  Then success message displays:
    | Message | "üéâ Handoff Complete! NPD-001 successfully launched to production." |
  And created records display with links:
    | Record | Link |
    | Product | PROD-NPD-001 - Premium Burger (link to /technical/products/:id) |
    | BOM | BOM-PROD-NPD-001-v1.0 (link to /technical/boms/:id) |
    | Pilot WO | WO-PILOT-NPD-001 (link to /production/work-orders/:id) |
  And actions display:
    | Action | Description |
    | [View Product] | Navigate to product detail |
    | [View BOM] | Navigate to BOM detail |
    | [View Pilot WO] | Navigate to WO detail |
    | [Back to NPD Projects] | Return to NPD dashboard |
```

```gherkin
Scenario: Download handoff summary (Phase 2 - future)
  Given success page displayed
  When user clicks [Download Summary PDF] (Phase 2)
  Then PDF generated with:
    - Project details
    - Formulation summary
    - BOM items list
    - Pilot WO details
    - Handoff timestamp and user
```

```gherkin
Scenario: Success notification to Production
  Given handoff completed
  When execution finishes
  Then notification sent to Production Manager role:
    | Subject | "New Product Handed Off: PROD-NPD-001" |
    | Body | "NPD project NPD-001 completed handoff. Pilot WO scheduled for 2025-01-08." |
    | Link | Pilot WO detail page |
```

### AC-10: NPD-Only Mode (Export - Phase 2)

```gherkin
Scenario: NPD-only mode activated (Phase 2 - deferred)
  Given npd_settings.npd_only_mode = true
  When user reaches Step 6 (Summary)
  Then [Execute Handoff] button replaced with [Export to PDF/Excel]
  And no production records created
  And export contains formulation, costing, compliance docs
```

### AC-11: Permission Enforcement

```gherkin
Scenario: NPD Lead permissions
  Given user has NPD_LEAD role
  Then full access to handoff wizard
  And can execute handoff
```

```gherkin
Scenario: R&D permissions
  Given user has R&D role (not NPD_LEAD)
  When attempting handoff
  Then error "Only NPD Lead can execute handoff"
  And wizard accessible (read-only) but [Execute] button disabled
```

```gherkin
Scenario: Production Manager permissions
  Given user has PRODUCTION_MANAGER role (not NPD roles)
  When accessing NPD project
  Then can view handoff status (read-only)
  And cannot initiate or modify handoff
```

### AC-12: Error Handling

```gherkin
Scenario: Network error during handoff
  Given handoff execution started
  And network connection lost during step 3
  When timeout occurs
  Then transaction rolls back
  And error "Handoff failed: Network error. Please retry."
  And [Retry Handoff] button available
  And user can retry from Step 7
```

```gherkin
Scenario: Database constraint violation
  Given product code "PROD-NPD-001" already exists (race condition)
  When handoff execution attempts product creation
  Then transaction rolls back
  And error "Product code PROD-NPD-001 already exists. Please choose different code."
  And user returns to Step 2 (Product Decision)
```

```gherkin
Scenario: Validation failure after wizard started
  Given user at Step 5 (Routing Selection)
  And another user deletes formulation in background (edge case)
  When user clicks [Next]
  Then validation re-runs
  And error "Formulation no longer exists. Handoff aborted."
  And wizard resets to Step 1
```

---

## Implementation Notes

### API Endpoints

```typescript
// GET /api/npd/projects/:projectId/handoff/validate
interface HandoffValidationResponse {
  project: {
    id: number;
    project_number: string;
    project_name: string;
    current_gate: string;
    status: string;
  };
  validation: {
    can_handoff: boolean;
    checks: ValidationCheck[];
    blockers: string[];
  };
}

interface ValidationCheck {
  name: string;
  description: string;
  status: 'pass' | 'fail' | 'warning';
  message: string | null;
  fix_action?: string; // e.g., "Complete G4 checklist items"
}

// POST /api/npd/projects/:projectId/handoff/execute
interface ExecuteHandoffRequest {
  // Step 2: Product decision
  product_action: 'create' | 'update';
  product_id?: string; // if update existing
  product_data?: {
    product_code: string;
    product_name: string;
    product_type: string;
    description: string;
    uom: string;
  };

  // Step 3: BOM generation
  bom_data: {
    bom_number?: string; // auto-generated if not provided
    effective_from: string; // ISO date, required
    effective_to?: string | null; // ISO date, optional
  };

  // Step 4-5: Pilot WO (optional)
  create_pilot_wo: boolean;
  pilot_wo_data?: {
    quantity: number;
    scheduled_date: string; // ISO date
    routing_id?: string | null;
  };

  // Formulation to transfer
  formulation_id: number;
}

interface ExecuteHandoffResponse {
  success: boolean;
  handoff_id: string; // event ID for tracking
  created_records: {
    product_id: string;
    product_code: string;
    bom_id: string;
    bom_number: string;
    pilot_wo_id?: string;
    pilot_wo_number?: string;
  };
  project_status: 'launched';
  formulation_status: 'locked';
  executed_at: string; // timestamp
}

interface HandoffErrorResponse {
  success: false;
  error: string;
  error_code: string; // e.g., "DUPLICATE_PRODUCT_CODE", "VALIDATION_FAILED"
  rollback_completed: boolean;
  step_failed: string; // e.g., "create_bom"
}
```

### Service Layer

```typescript
// lib/services/handoff-service.ts

export class HandoffService {
  /**
   * Validate project readiness for handoff
   */
  static async validateHandoff(projectId: number): Promise<HandoffValidationResponse> {
    const checks: ValidationCheck[] = [];

    // 1. Check Gate G4 complete
    const g4Complete = await this.checkGateComplete(projectId, 'G4');
    checks.push({
      name: 'gate_g4_complete',
      description: 'Gate G4 checklist complete',
      status: g4Complete ? 'pass' : 'fail',
      message: g4Complete ? null : 'Complete all G4 checklist items',
      fix_action: 'Go to Gate Checklist',
    });

    // 2. Check formulation locked
    const formulation = await this.getActiveFormulation(projectId);
    checks.push({
      name: 'formulation_locked',
      description: 'Active formulation locked',
      status: formulation?.status === 'locked' ? 'pass' : 'fail',
      message: formulation?.status === 'locked' ? null : `Lock formulation ${formulation?.formulation_number}`,
      fix_action: 'Lock Formulation',
    });

    // 3. Check costing approved
    const costing = await this.getProjectCosting(projectId);
    checks.push({
      name: 'costing_approved',
      description: 'Costing approved by Finance',
      status: costing?.status === 'approved' ? 'pass' : 'fail',
      message: costing?.status === 'approved' ? null : 'Finance approval required',
    });

    // 4. Check compliance docs
    const docs = await this.getComplianceDocs(projectId);
    const requiredDocs = ['haccp', 'label'];
    const missingDocs = requiredDocs.filter(type => !docs.find(d => d.file_type === type));
    checks.push({
      name: 'compliance_docs',
      description: 'Compliance documents uploaded',
      status: missingDocs.length === 0 ? 'pass' : 'fail',
      message: missingDocs.length === 0 ? null : `Missing: ${missingDocs.join(', ')}`,
      fix_action: 'Upload Documents',
    });

    // 5. Check allergen aggregation (if feature enabled)
    const allergens = await this.getAllergenDeclaration(formulation?.id);
    checks.push({
      name: 'allergen_declaration',
      description: 'Allergen declaration available',
      status: allergens ? 'pass' : 'warning',
      message: allergens ? null : 'Allergens will not be transferred (optional)',
    });

    const canHandoff = checks.filter(c => c.status === 'fail').length === 0;
    const blockers = checks.filter(c => c.status === 'fail').map(c => c.message!);

    return {
      project: await this.getProject(projectId),
      validation: { can_handoff: canHandoff, checks, blockers },
    };
  }

  /**
   * Execute handoff transactionally
   */
  static async executeHandoff(
    projectId: number,
    data: ExecuteHandoffRequest,
    userId: string
  ): Promise<ExecuteHandoffResponse> {
    const client = await db.connect();

    try {
      await client.query('BEGIN');

      // Step 1: Lock formulation
      await client.query(
        'UPDATE npd_formulations SET status = $1 WHERE id = $2',
        ['locked', data.formulation_id]
      );

      // Step 2: Create or update product
      let productId: string;
      if (data.product_action === 'create') {
        const product = await this.createProduct(client, data.product_data!, userId);
        productId = product.id;
      } else {
        productId = data.product_id!;
      }

      // Step 3: Create BOM
      const bom = await this.createBOM(client, {
        product_id: productId,
        formulation_id: data.formulation_id,
        effective_from: data.bom_data.effective_from,
        effective_to: data.bom_data.effective_to,
      }, userId);

      // Step 4: Copy formulation items to BOM items
      await this.copyFormulationItemsToBOM(client, data.formulation_id, bom.id);

      // Step 5: Create pilot WO (optional)
      let pilotWO = null;
      if (data.create_pilot_wo) {
        pilotWO = await this.createPilotWO(client, {
          product_id: productId,
          bom_id: bom.id,
          npd_project_id: projectId,
          quantity: data.pilot_wo_data!.quantity,
          scheduled_date: data.pilot_wo_data!.scheduled_date,
          routing_id: data.pilot_wo_data?.routing_id,
        }, userId);
      }

      // Step 6: Update project status to 'launched'
      await client.query(
        'UPDATE npd_projects SET status = $1, actual_launch_date = $2 WHERE id = $3',
        ['launched', new Date(), projectId]
      );

      // Step 7: Log handoff event
      const event = await this.logHandoffEvent(client, {
        project_id: projectId,
        product_id: productId,
        bom_id: bom.id,
        wo_id: pilotWO?.id,
        formulation_id: data.formulation_id,
        user_id: userId,
      });

      await client.query('COMMIT');

      return {
        success: true,
        handoff_id: event.id,
        created_records: {
          product_id: productId,
          product_code: data.product_data?.product_code || 'existing',
          bom_id: bom.id,
          bom_number: bom.bom_number,
          pilot_wo_id: pilotWO?.id,
          pilot_wo_number: pilotWO?.wo_number,
        },
        project_status: 'launched',
        formulation_status: 'locked',
        executed_at: new Date().toISOString(),
      };
    } catch (error) {
      await client.query('ROLLBACK');
      throw new HandoffError('Handoff execution failed', error);
    } finally {
      client.release();
    }
  }

  /**
   * Copy formulation items to BOM items
   */
  private static async copyFormulationItemsToBOM(
    client: PoolClient,
    formulationId: number,
    bomId: string
  ): Promise<void> {
    await client.query(`
      INSERT INTO bom_items (bom_id, product_id, quantity, uom, percentage, item_type, notes)
      SELECT $1, product_id, quantity, uom, percentage, 'input', notes
      FROM npd_formulation_items
      WHERE formulation_id = $2
    `, [bomId, formulationId]);
  }

  /**
   * Create product record
   */
  private static async createProduct(
    client: PoolClient,
    data: ProductData,
    userId: string
  ): Promise<Product> {
    const result = await client.query(`
      INSERT INTO products (product_code, product_name, product_type, description, uom, status, npd_project_id, source, created_by)
      VALUES ($1, $2, $3, $4, $5, 'draft', $6, 'npd', $7)
      RETURNING *
    `, [data.product_code, data.product_name, data.product_type, data.description, data.uom, projectId, userId]);
    return result.rows[0];
  }

  /**
   * Create BOM record
   */
  private static async createBOM(
    client: PoolClient,
    data: BOMData,
    userId: string
  ): Promise<BOM> {
    const bomNumber = await this.generateBOMNumber(data.product_id);
    const result = await client.query(`
      INSERT INTO boms (bom_number, product_id, effective_from, effective_to, status, npd_formulation_id, source, created_by)
      VALUES ($1, $2, $3, $4, 'draft', $5, 'npd', $6)
      RETURNING *
    `, [bomNumber, data.product_id, data.effective_from, data.effective_to, data.formulation_id, userId]);
    return result.rows[0];
  }

  /**
   * Create pilot Work Order
   */
  private static async createPilotWO(
    client: PoolClient,
    data: PilotWOData,
    userId: string
  ): Promise<WorkOrder> {
    const woNumber = await this.generatePilotWONumber(data.npd_project_id);
    const result = await client.query(`
      INSERT INTO work_orders (wo_number, product_id, bom_id, quantity, scheduled_date, status, type, npd_project_id, routing_id, created_by)
      VALUES ($1, $2, $3, $4, $5, 'planned', 'pilot', $6, $7, $8)
      RETURNING *
    `, [woNumber, data.product_id, data.bom_id, data.quantity, data.scheduled_date, data.npd_project_id, data.routing_id, userId]);
    return result.rows[0];
  }

  /**
   * Log handoff event to npd_events
   */
  private static async logHandoffEvent(
    client: PoolClient,
    data: HandoffEventData
  ): Promise<Event> {
    const result = await client.query(`
      INSERT INTO npd_events (event_type, entity_type, entity_id, payload, status, created_at)
      VALUES ('NPD.HandoffCompleted', 'npd_project', $1, $2, 'completed', NOW())
      RETURNING *
    `, [data.project_id, JSON.stringify(data)]);
    return result.rows[0];
  }
}

class HandoffError extends Error {
  constructor(message: string, public originalError: any) {
    super(message);
    this.name = 'HandoffError';
  }
}
```

### Frontend Components

```
app/(authenticated)/npd/projects/[id]/handoff/page.tsx -- Handoff wizard main page

components/npd/handoff/
  HandoffWizard.tsx              -- Main wizard container with stepper
  HandoffStep1Validation.tsx     -- Validation checklist
  HandoffStep2Product.tsx        -- Product creation/selection
  HandoffStep3BOMPreview.tsx     -- BOM generation preview
  HandoffStep4PilotWO.tsx        -- Pilot WO toggle and form
  HandoffStep5Routing.tsx        -- Routing selection
  HandoffStep6Summary.tsx        -- Summary review
  HandoffStep7Execute.tsx        -- Execution progress
  HandoffStep8Success.tsx        -- Success confirmation
  ValidationChecklistItem.tsx    -- Individual validation check
  ProductCreationForm.tsx        -- New product form fields
  ProductSelector.tsx            -- Existing product search/select
  BOMPreviewTable.tsx            -- Formulation ‚Üí BOM mapping table
  PilotWOForm.tsx                -- Pilot WO fields
  RoutingSelector.tsx            -- Routing dropdown
  HandoffSummaryCard.tsx         -- Summary section card
  HandoffProgressBar.tsx         -- Execution progress indicator
  HandoffSuccessCard.tsx         -- Success record links
  HandoffErrorAlert.tsx          -- Error display with retry
```

### Validation (Zod)

```typescript
const executeHandoffSchema = z.object({
  product_action: z.enum(['create', 'update']),
  product_id: z.string().uuid().optional(),
  product_data: z.object({
    product_code: z.string().min(1).max(50),
    product_name: z.string().min(1).max(200),
    product_type: z.string().min(1).max(50),
    description: z.string().max(2000).optional(),
    uom: z.string().min(1).max(20),
  }).optional(),
  bom_data: z.object({
    bom_number: z.string().optional(),
    effective_from: z.string().refine((val) => !isNaN(Date.parse(val)), "Invalid date"),
    effective_to: z.string().refine((val) => !val || !isNaN(Date.parse(val)), "Invalid date").nullable().optional(),
  }).refine((data) => {
    if (data.effective_to && data.effective_from) {
      return new Date(data.effective_to) >= new Date(data.effective_from);
    }
    return true;
  }, { message: "Effective To must be after Effective From", path: ["effective_to"] }),
  create_pilot_wo: z.boolean(),
  pilot_wo_data: z.object({
    quantity: z.number().positive("Quantity must be greater than 0"),
    scheduled_date: z.string().refine((val) => !isNaN(Date.parse(val)), "Invalid date"),
    routing_id: z.string().uuid().optional().nullable(),
  }).optional(),
  formulation_id: z.number().int().positive("Invalid formulation ID"),
}).refine((data) => {
  if (data.product_action === 'create' && !data.product_data) {
    return false;
  }
  if (data.product_action === 'update' && !data.product_id) {
    return false;
  }
  if (data.create_pilot_wo && !data.pilot_wo_data) {
    return false;
  }
  return true;
}, { message: "Missing required data for selected action" });
```

---

## Deliverables

### Database
- No new tables (uses existing npd_projects, npd_formulations, products, boms, bom_items, work_orders, npd_events)
- Ensure npd_formulation_id FK exists in boms table
- Ensure npd_project_id FK exists in work_orders table
- Ensure npd_project_id FK exists in products table
- Transaction support for rollback on failure

### API Routes
- [ ] GET /api/npd/projects/:projectId/handoff/validate
- [ ] POST /api/npd/projects/:projectId/handoff/execute

### Service Layer
- [ ] HandoffService.validateHandoff()
- [ ] HandoffService.executeHandoff()
- [ ] HandoffService.checkGateComplete()
- [ ] HandoffService.copyFormulationItemsToBOM()
- [ ] HandoffService.createProduct()
- [ ] HandoffService.createBOM()
- [ ] HandoffService.createPilotWO()
- [ ] HandoffService.logHandoffEvent()
- [ ] HandoffService.generateBOMNumber()
- [ ] HandoffService.generatePilotWONumber()

### Frontend
- [ ] Handoff wizard page (/npd/projects/:id/handoff)
- [ ] 8-step wizard with stepper navigation
- [ ] Step 1: Validation checklist with pass/fail indicators
- [ ] Step 2: Product creation/selection forms
- [ ] Step 3: BOM preview table
- [ ] Step 4: Pilot WO toggle and form
- [ ] Step 5: Routing selector
- [ ] Step 6: Summary review
- [ ] Step 7: Execution progress bar
- [ ] Step 8: Success confirmation with links
- [ ] Error handling with retry option
- [ ] Back navigation preserves form state
- [ ] Permission-based access control

### Validation
- [ ] executeHandoffSchema (Zod)
- [ ] Product validation (code uniqueness, required fields)
- [ ] BOM validation (effective date range)
- [ ] Pilot WO validation (quantity > 0, valid date)

### Tests
- [ ] Integration test: GET /api/npd/projects/:id/handoff/validate
- [ ] Integration test: POST /api/npd/projects/:id/handoff/execute (success)
- [ ] Integration test: Handoff rollback on failure
- [ ] Unit test: HandoffService.validateHandoff() (all checks)
- [ ] Unit test: HandoffService.executeHandoff() (transaction)
- [ ] Unit test: HandoffService.copyFormulationItemsToBOM()
- [ ] E2E test: Full handoff wizard workflow
- [ ] E2E test: Handoff failure and retry
- [ ] E2E test: Validation blocker prevents handoff

---

## Definition of Done

- [ ] Handoff wizard loads all steps within 500ms per step
- [ ] Validation checklist shows accurate pass/fail status
- [ ] Validation blockers prevent wizard progression
- [ ] Product creation form validates duplicate codes
- [ ] Product selector searches existing products
- [ ] BOM preview displays formulation ‚Üí BOM mapping
- [ ] BOM effective dates validate (to >= from)
- [ ] Pilot WO toggle shows/hides form
- [ ] Pilot WO quantity validates (> 0)
- [ ] Routing selector shows active routings
- [ ] Summary displays all handoff actions accurately
- [ ] Execute handoff completes within 5 seconds (p95)
- [ ] Transaction rolls back on any failure (atomic)
- [ ] Project status updates to 'launched' on success
- [ ] Formulation status locks on success
- [ ] Handoff event logged to npd_events
- [ ] Success page displays links to created records
- [ ] Error handling shows clear messages with retry option
- [ ] Back navigation preserves form state
- [ ] Permission checks block non-NPD-Lead users
- [ ] All API endpoints return correct status codes
- [ ] Integration tests cover handoff execution and rollback
- [ ] Unit tests achieve >80% coverage on HandoffService
- [ ] E2E tests verify full wizard workflow end-to-end

---

## Risk Assessment

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Transaction rollback failure (data inconsistency) | CRITICAL | LOW | Comprehensive transaction tests, database constraints |
| Concurrent handoff race condition | HIGH | MEDIUM | Optimistic locking on project status, duplicate check |
| Long execution time (timeout) | MEDIUM | MEDIUM | Optimize BOM item copy (batch insert), progress indicator |
| Validation checks out of sync with actual data | HIGH | MEDIUM | Re-validate before execution, real-time checks |
| User navigates away during execution | MEDIUM | HIGH | Block navigation during execution, show warning |
| BOM number generation collision | MEDIUM | LOW | Use database sequence, retry on collision |
| Missing dependencies (routing, allergens) | LOW | HIGH | Graceful degradation, make dependencies optional |

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2026-01-15 | Initial version - Handoff Wizard | ARCHITECT-AGENT |

---

**Document Status**: Ready for Implementation
**Created**: 2026-01-15
**Lines**: ~950
**Complexity**: L (Large)
**Phase**: 1 (MVP - Critical)
