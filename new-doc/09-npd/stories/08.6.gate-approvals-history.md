# 08.6 - Gate Approvals & History

| Field | Value |
|-------|-------|
| **Story ID** | 08.6 |
| **Epic** | 08 - NPD |
| **Status** | Ready |
| **Phase** | Phase 1 (P1 - MVP) |
| **Complexity** | M (Medium) |
| **Estimate** | 2-3 days |
| **Type** | Full-stack |

---

## PRD References

| FR ID | Requirement | Priority | Covered |
|-------|-------------|----------|---------|
| NPD-FR-19 | System shall support gate approvals | Must | FULL |
| NPD-FR-21 | System shall log approvals | Must | FULL |
| NPD-FR-22 | System shall show approval history | Should | FULL |

**Primary PRD:** `docs/1-BASELINE/product/modules/npd.md` (Section 4 - Gate Checklists, FR-NPD-19, 21, 22)
**Architecture:** `docs/1-BASELINE/architecture/modules/npd.md` (npd_approvals table)
**UX Wireframes:** PLAN-008 (PO Approval Modal - similar pattern)

---

## MVP Scope

This story implements the **gate approval workflow** for NPD projects. Each gate (G0-G4) requires approval from designated roles before a project can advance to the next stage.

**MVP Includes**:
- Gate approval modal (approve/reject)
- Role-based approval permissions (NPD_LEAD, QA_MANAGER, DIRECTOR)
- Approval history timeline
- E-signature support (optional password confirmation)
- Rejection reason requirement
- Approval logging in `npd_approvals` table
- Email notifications to project owner

**Deferred to Phase 2**:
- Multi-level approval chains
- Conditional approval rules
- Delegation (OOO approvers)
- Mobile signature capture

---

## Goal

Enable authorized users to approve or reject gate transitions in NPD projects with full audit trail and notification support.

## User Story

As an **NPD Lead/QA Manager/Director**, I want to **approve or reject gate transitions with notes and optional e-signature** so that **I can ensure proper oversight of product development and maintain compliance documentation**.

---

## Scope

**In scope (this story)**
- Gate approval modal UI (approve/reject modes)
- Approval history timeline component
- Role-based approval permission checks:
  - G0-G2: NPD_LEAD role
  - G3: QA_MANAGER role
  - G4: DIRECTOR role
- E-signature modal (password confirmation)
- Rejection reason requirement
- `npd_approvals` table for audit trail
- API endpoints for approval/rejection
- Email notifications to project owner
- Approval status indicators on project detail page

**Out of scope (this story)**
- Multi-level approval chains (Phase 2)
- Conditional approval rules (Phase 2)
- Delegation (Phase 2)
- Mobile signature capture (Phase 2)
- Approval dashboard (separate story)

---

## Dependencies

| Dependency | Story/Epic | Type | Reason |
|------------|------------|------|--------|
| 01.1 | Org Context + Base RLS | HARD | Requires org_id context and RLS patterns |
| 01.10 | Roles CRUD | HARD | Role-based approval permissions |
| 08.1 | NPD Projects CRUD | HARD | Requires npd_projects table and gate workflow |
| 08.3 | Gate Checklists | HARD | Approval validates checklist completion |

**Dependents:**
- 08.7 (Handoff Wizard) - Requires G4 approval before handoff

---

## Acceptance Criteria (Given/When/Then)

### AC-1: Gate Approval Modal - Basic Display

**Given** user with NPD_LEAD role views project at G0
**When** user clicks "Request G1 Approval"
**Then** approval modal opens with:
- Project number and name
- Current gate (G0)
- Target gate (G1)
- Gate checklist completion status (X/Y items complete)
- Approval notes field (optional)
- "Approve" and "Reject" buttons

### AC-2: Checklist Validation Before Approval

**Given** project has G0 checklist with 5 required items
**And** only 3 items are completed
**When** user attempts to request approval
**Then** validation error: "Cannot request approval - 2 required checklist items incomplete"
**And** modal shows incomplete items with warning icons

**Given** all required checklist items are complete
**When** user requests approval
**Then** approval modal opens successfully

### AC-3: Role-Based Approval Permissions (G0-G2)

**Given** project at G0 awaiting G1 approval
**And** user has role NPD_LEAD
**When** user opens approval modal
**Then** "Approve" and "Reject" buttons are enabled

**Given** user has role QA_MANAGER (not authorized for G0-G2)
**When** user views project
**Then** approval button is hidden/disabled
**And** message: "Only NPD Leads can approve this gate"

### AC-4: Role-Based Approval Permissions (G3)

**Given** project at G3 awaiting G4 approval
**And** user has role QA_MANAGER
**When** user opens approval modal
**Then** "Approve" and "Reject" buttons are enabled

**Given** user has role NPD_LEAD (not authorized for G3)
**When** user views project
**Then** approval button is hidden/disabled
**And** message: "Only QA Managers can approve Gate 3"

### AC-5: Role-Based Approval Permissions (G4)

**Given** project at G4 awaiting Launch approval
**And** user has role DIRECTOR
**When** user opens approval modal
**Then** "Approve" and "Reject" buttons are enabled

**Given** user has role NPD_LEAD or QA_MANAGER
**When** user views project
**Then** approval button is hidden/disabled
**And** message: "Only Directors can approve Gate 4"

### AC-6: Approve Gate - Basic Flow

**Given** user with approval permission opens modal
**And** enters notes: "Concept approved for feasibility study"
**When** user clicks "Approve"
**Then** confirmation prompt: "Approve gate transition from G0 to G1?"

**When** user confirms
**Then** system:
- Updates project.current_gate to G1
- Updates project.status to 'feasibility'
- Creates approval record with result='approved'
- Sends email to project owner
- Shows success message: "Gate approved successfully"
- Closes modal

### AC-7: Reject Gate - Required Reason

**Given** user clicks "Reject" button
**When** reason field is empty
**Then** validation error: "Rejection reason is required"
**And** submit button is disabled

**Given** user enters reason: "Incomplete cost analysis"
**When** user clicks "Reject Gate"
**Then** confirmation prompt: "Reject gate transition? Project will remain at G0."

**When** user confirms
**Then** system:
- Keeps project.current_gate at G0
- Creates approval record with result='rejected'
- Stores rejection reason in notes field
- Sends email to project owner with reason
- Shows warning message: "Gate rejected - project owner notified"
- Closes modal

### AC-8: Rejection Reason Validation

**Given** user enters rejection reason "No"
**When** submit attempted
**Then** validation error: "Please provide a more detailed reason (min 10 characters)"

**Given** user enters 1500 character reason
**When** submit attempted
**Then** validation error: "Reason cannot exceed 1000 characters"

**Given** user enters 50 character reason
**When** submit attempted
**Then** validation passes

### AC-9: E-Signature Support (Optional)

**Given** org has e-signature enabled in NPD settings
**And** user clicks "Approve" with notes
**When** confirmation prompt appears
**Then** additional prompt: "Enter password to confirm approval"

**Given** user enters correct password
**When** submit clicked
**Then** approval proceeds with e_signature=true in record

**Given** user enters incorrect password
**When** submit clicked
**Then** error: "Invalid password - approval not recorded"
**And** modal remains open for retry

**Given** user cancels password prompt
**Then** approval is cancelled
**And** modal remains open

### AC-10: Approval History Timeline

**Given** project has 3 approval records:
- G0→G1: Approved by John Smith on Jan 5
- G1→G2: Approved by Jane Doe on Jan 12
- G2→G3: Rejected by Bob Lee on Jan 15

**When** user views project detail page
**Then** approval history section displays timeline:
```
Jan 15, 2024 14:30
Gate 2 → 3: REJECTED
By: Bob Lee (NPD Lead)
Reason: Cost analysis incomplete. Need revised formulation.

Jan 12, 2024 09:15
Gate 1 → 2: APPROVED
By: Jane Doe (NPD Lead)
Notes: Business case approved. Good market potential.

Jan 5, 2024 11:45
Gate 0 → 1: APPROVED
By: John Smith (NPD Lead)
Notes: Concept approved for feasibility study.
```

### AC-11: Approval History - E-Signature Indicator

**Given** approval record has e_signature=true
**When** displayed in history timeline
**Then** shows badge: "E-signed" with lock icon

**Given** approval record has e_signature=false or null
**When** displayed in history timeline
**Then** no e-signature indicator shown

### AC-12: Concurrent Approval Prevention

**Given** two users (Manager A and Manager B) open approval modal for same gate
**And** Manager A approves first
**When** Manager B clicks "Approve"
**Then** error: "This gate has already been approved by Manager A"
**And** modal refreshes to show current project state

### AC-13: Approval Notification Email

**Given** project owner is user@example.com
**And** Manager approves G0→G1 transition
**When** approval is saved
**Then** email sent to user@example.com with:
- Subject: "NPD Project NPD-2024-001: Gate 0 approved"
- Project number and name
- Gate transition (G0 → G1)
- Approved by: Manager Name
- Approval notes
- Link to project detail page

**Given** Manager rejects G1→G2 transition
**When** rejection is saved
**Then** email sent with:
- Subject: "NPD Project NPD-2024-001: Gate 1 rejected"
- Project number and name
- Gate transition (G1 → G2)
- Rejected by: Manager Name
- Rejection reason
- Next steps guidance

### AC-14: Approval Audit Trail

**Given** approval is created
**When** record is saved to npd_approvals table
**Then** all fields are populated:
- project_id
- gate (e.g., 'G0')
- target_gate (e.g., 'G1')
- result ('approved' or 'rejected')
- approved_by (user ID)
- approved_at (timestamp)
- notes (approval notes or rejection reason)
- e_signature (true/false)
- org_id (for RLS)

### AC-15: RLS Policy Enforcement

**Given** user logged in as Org A
**When** user queries npd_approvals
**Then** only Org A's approval records are visible
**And** user cannot see/modify Org B's approvals via API

### AC-16: Approval History Performance

**Given** project has 20 approval records
**When** approval history loads
**Then** all records display within 300ms
**And** timeline is sorted chronologically DESC (newest first)

### AC-17: Mobile Responsive Approval Modal

**Given** user on mobile device (<768px)
**When** approval modal opens
**Then** modal is full-screen
**And** gate info stacked vertically
**And** action buttons full-width
**And** all touch targets ≥48dp

---

## Implementation Notes

### API Endpoints

```typescript
// Get approval history for project
GET /api/npd/projects/:id/approvals
Response: {
  success: true,
  data: [
    {
      id: string,
      project_id: integer,
      gate: 'G0' | 'G1' | 'G2' | 'G3' | 'G4',
      target_gate: 'G1' | 'G2' | 'G3' | 'G4' | 'Launched',
      result: 'approved' | 'rejected',
      approved_by: {
        id: string,
        name: string,
        role: string
      },
      approved_at: string,
      notes: string,
      e_signature: boolean,
      created_at: string
    }
  ]
}

// Approve gate transition
POST /api/npd/projects/:id/gates/:gate/approve
Body: {
  notes?: string,
  password?: string  // for e-signature
}
Response: {
  success: true,
  data: {
    project: NPDProject,
    approval: NPDApproval
  },
  message: "Gate approved successfully"
}

// Reject gate transition
POST /api/npd/projects/:id/gates/:gate/reject
Body: {
  reason: string  // required, min 10 chars
}
Response: {
  success: true,
  data: {
    project: NPDProject,
    approval: NPDApproval
  },
  message: "Gate rejected"
}
```

### Database Schema

```sql
-- NPD Approvals Table
CREATE TABLE npd_approvals (
  id SERIAL PRIMARY KEY,
  org_id UUID NOT NULL REFERENCES organizations(id),
  project_id INTEGER NOT NULL REFERENCES npd_projects(id),

  -- Gate Info
  gate VARCHAR(10) NOT NULL,           -- 'G0', 'G1', 'G2', 'G3', 'G4'
  target_gate VARCHAR(10) NOT NULL,    -- 'G1', 'G2', 'G3', 'G4', 'Launched'

  -- Approval Data
  result VARCHAR(20) NOT NULL,         -- 'approved', 'rejected'
  approved_by UUID NOT NULL REFERENCES auth.users(id),
  approved_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  notes TEXT,                          -- approval notes or rejection reason
  e_signature BOOLEAN DEFAULT false,   -- true if password confirmed

  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),

  CONSTRAINT valid_result CHECK (result IN ('approved', 'rejected')),
  CONSTRAINT valid_gate CHECK (gate IN ('G0', 'G1', 'G2', 'G3', 'G4')),
  CONSTRAINT valid_target_gate CHECK (target_gate IN ('G1', 'G2', 'G3', 'G4', 'Launched'))
);

-- RLS Policies
ALTER TABLE npd_approvals ENABLE ROW LEVEL SECURITY;

CREATE POLICY npd_approvals_org_isolation ON npd_approvals
  FOR ALL
  USING (org_id = current_setting('app.current_org_id')::uuid);

-- Indexes
CREATE INDEX idx_npd_approvals_project ON npd_approvals(project_id);
CREATE INDEX idx_npd_approvals_org ON npd_approvals(org_id);
CREATE INDEX idx_npd_approvals_gate ON npd_approvals(gate, result);
CREATE INDEX idx_npd_approvals_approved_by ON npd_approvals(approved_by);
```

### Frontend Components

```
app/(authenticated)/npd/
  projects/[id]/page.tsx              -- Project detail with approval history

components/npd/
  GateApprovalModal.tsx               -- Main approval modal
  ApprovalHistoryTimeline.tsx         -- Timeline component
  ESignatureModal.tsx                 -- Password confirmation modal
  GateApprovalButton.tsx              -- Button with role permission check
```

### Services

```typescript
// lib/services/npd-approval-service.ts

export async function getApprovalHistory(
  projectId: number
): Promise<NPDApproval[]> {
  // Fetch all approvals for project
  // Sort by approved_at DESC
}

export async function approveGate(
  projectId: number,
  gate: string,
  data: {
    notes?: string;
    password?: string;
  }
): Promise<{ project: NPDProject; approval: NPDApproval }> {
  // Validate checklist completion
  // Validate user has approval role
  // Verify password if e-signature enabled
  // Update project gate
  // Create approval record
  // Send notification email
}

export async function rejectGate(
  projectId: number,
  gate: string,
  reason: string
): Promise<{ project: NPDProject; approval: NPDApproval }> {
  // Validate reason
  // Validate user has approval role
  // Keep project at current gate
  // Create rejection record
  // Send notification email
}

export function canApproveGate(
  userRole: string,
  gate: string
): boolean {
  const permissions = {
    'G0': ['NPD_LEAD'],
    'G1': ['NPD_LEAD'],
    'G2': ['NPD_LEAD'],
    'G3': ['QA_MANAGER'],
    'G4': ['DIRECTOR']
  };
  return permissions[gate]?.includes(userRole) || false;
}
```

### Validation (Zod)

```typescript
// lib/validation/npd-approval-schema.ts

import { z } from 'zod';

export const gateApprovalSchema = z.object({
  notes: z
    .string()
    .max(1000, 'Notes cannot exceed 1000 characters')
    .optional(),
  password: z.string().optional()
});

export const gateRejectionSchema = z.object({
  reason: z
    .string()
    .min(10, 'Please provide a more detailed reason (min 10 characters)')
    .max(1000, 'Reason cannot exceed 1000 characters')
});

export const approvalRecordSchema = z.object({
  project_id: z.number().int().positive(),
  gate: z.enum(['G0', 'G1', 'G2', 'G3', 'G4']),
  target_gate: z.enum(['G1', 'G2', 'G3', 'G4', 'Launched']),
  result: z.enum(['approved', 'rejected']),
  approved_by: z.string().uuid(),
  notes: z.string().max(1000).optional(),
  e_signature: z.boolean().default(false)
});

export type GateApprovalInput = z.infer<typeof gateApprovalSchema>;
export type GateRejectionInput = z.infer<typeof gateRejectionSchema>;
export type ApprovalRecord = z.infer<typeof approvalRecordSchema>;
```

### Key Business Rules

1. **Role-Based Approval Matrix**:
   - G0-G2: NPD_LEAD role only
   - G3: QA_MANAGER role only
   - G4: DIRECTOR role only

2. **Checklist Enforcement**: All required checklist items must be complete before approval request

3. **Gate Transition on Approval**:
   - G0 → G1: status = 'feasibility'
   - G1 → G2: status = 'business_case'
   - G2 → G3: status = 'development'
   - G3 → G4: status = 'testing'
   - G4 → Launched: status = 'launched'

4. **Rejection Handling**: Project remains at current gate, can be re-submitted after addressing feedback

5. **E-Signature**: Optional per org settings, requires password confirmation

6. **Notification**: Always send email to project owner (npd_projects.owner_id)

7. **Concurrent Approval**: First approval wins, subsequent attempts fail with error

8. **Audit Trail**: All approvals/rejections permanently logged in npd_approvals table

---

## Deliverables

### Database Migration
- `npd_approvals` table with RLS policies
- Indexes for performance

### API Routes
- `GET /api/npd/projects/:id/approvals` - Get approval history
- `POST /api/npd/projects/:id/gates/:gate/approve` - Approve gate
- `POST /api/npd/projects/:id/gates/:gate/reject` - Reject gate

### Components
- `GateApprovalModal.tsx` - Approval/rejection modal
- `ApprovalHistoryTimeline.tsx` - Timeline display
- `ESignatureModal.tsx` - Password confirmation
- `GateApprovalButton.tsx` - Action button with permissions

### Services
- `npd-approval-service.ts` - CRUD operations and business logic

### Validation
- `npd-approval-schema.ts` - Zod schemas for validation

### Tests
- `npd-approval-service.test.ts` - Unit tests for service methods
- `npd-approvals-api.test.ts` - API route tests
- `gate-approval-modal.test.tsx` - Component tests
- `approval-permissions.test.ts` - Role-based permission tests

---

## Definition of Done

- [ ] `npd_approvals` table created with proper schema
- [ ] RLS policies applied and tested
- [ ] Indexes created for performance
- [ ] API endpoints implemented and tested (GET, POST x2)
- [ ] Service methods implemented with validation
- [ ] Zod schemas defined and validated
- [ ] UI components built with role permission checks
- [ ] Approval history timeline displays correctly
- [ ] E-signature modal functional (if enabled)
- [ ] Email notifications sent on approve/reject
- [ ] Unit tests passing (>80% coverage for service layer)
- [ ] API tests passing for all endpoints
- [ ] Component tests passing for modals
- [ ] Permission tests passing (role-based access)
- [ ] Checklist validation enforced
- [ ] Concurrent approval prevention working
- [ ] RLS isolation verified (org A cannot see org B approvals)
- [ ] E2E smoke test: NPD Lead approves G0→G1 transition
- [ ] Performance: Approval history loads in <300ms
- [ ] Performance: Approval action completes in <500ms
- [ ] Code review completed
- [ ] Documentation updated (API docs, approval workflow guide)

---

## Future Phases (Not in This Story)

### Phase 2 - Advanced Approvals
- **Multi-Level Approval Chains** - Sequential approvals (e.g., NPD Lead then Director)
- **Conditional Approval Rules** - Different approvers based on project type/risk
- **Delegation** - Approvers can delegate to others when OOO
- **Approval Templates** - Pre-configured approval flows
- **Mobile Signature Capture** - Touch-based signature on mobile
- **Approval Dashboard** - View all pending approvals across projects
- **Approval SLA Tracking** - Track time to approve, send reminders
- **Batch Approval** - Approve multiple gates at once

**Implementation**: See Epic 08.0 "Future Feature Handling" section.

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-01-15 | Initial story - Gate Approvals & History | ARCHITECT-AGENT |
