# 08.15 - Event Sourcing & Notifications

**Priority**: P1 (High - Audit Trail Required)
**Story Points**: M (Medium)
**Type**: backend
**Estimate**: 3-4 days

**State**: ready
**Primary PRD**: `docs/1-BASELINE/product/modules/npd.md` (FR-NPD-53, FR-NPD-54, FR-NPD-55, FR-NPD-56, FR-NPD-70-74)
**Dependencies**: 08.2, 08.3, 08.7, 08.11, 01.1

---

## Goal

Implement event sourcing for critical NPD events (gate advance, formulation lock, costing submission, handoff completion) with retry mechanism for failed events and admin replay capability. Add notification system for key NPD milestones to ensure timely approvals and stakeholder communication.

---

## User Story

As an **NPD Lead**, I want to **receive notifications when approvals are required** so that **I don't miss critical gate decisions or finance approvals that block my project progress**.

As a **Finance Manager**, I want to **be notified when costing requires approval** so that **I can review and approve within SLA timeframes**.

As a **System Admin**, I want to **view failed events and retry them** so that **I can recover from transient failures and maintain system reliability**.

---

## Scope

**In scope (this story)**
- Event log table (npd_events) for critical events
- Event types: gate_advanced, formulation_locked, costing_submitted, handoff_completed
- Event retry mechanism (failed events retry after 1min, max 3 retries)
- GET /api/npd/events (admin view event log)
- POST /api/npd/events/:id/retry (admin replay failed events)
- Notification system:
  - Gate approval required → NPD Lead
  - Costing approval required → Finance
  - Cost variance alert → NPD Lead + Finance
  - Missing compliance docs → Regulatory
  - Handoff completed → Production
- Email notifications via Supabase Edge Functions
- In-app notification center (badge count)
- Notification preferences per user

**Out of scope (this story)**
- Real-time event streaming (WebSockets) - Phase 2
- Event replay with state reconstruction - Phase 3
- Custom notification templates - Phase 3
- SMS/Slack notifications - Phase 3

---

## Dependencies

### Hard Dependencies
| Story | Provides | Status |
|-------|----------|--------|
| 01.1 | Org Context + RLS, users table | Ready |
| 08.2 | NPD Projects CRUD, npd_projects table | Ready |
| 08.3 | Stage-Gate Workflow, gate advancement | Ready |

### Soft Dependencies
| Story | Provides | Impact if Missing |
|-------|----------|-------------------|
| 08.7 | Formulation Costing | Costing events not logged (minor) |
| 08.11 | Handoff Wizard | Handoff events not logged (minor) |

---

## Acceptance Criteria (Given/When/Then)

### AC-1: Event Table Creation

```gherkin
Scenario: npd_events table exists
  Given database migration runs
  When schema inspected
  Then npd_events table has columns:
    | Column | Type | Description |
    | id | SERIAL PK | Event ID |
    | org_id | UUID FK | Organization |
    | event_type | VARCHAR(50) | Event type enum |
    | entity_type | VARCHAR(50) | npd_project, npd_formulation, etc. |
    | entity_id | INTEGER | Entity ID |
    | payload | JSONB | Event data |
    | status | VARCHAR(20) | pending, processing, completed, failed |
    | retry_count | INTEGER | Retry attempts |
    | error_message | TEXT | Failure reason |
    | created_at | TIMESTAMPTZ | When created |
    | processed_at | TIMESTAMPTZ | When processed |
  And RLS policies enforce org isolation
  And indexes on (org_id, status), (event_type), (created_at)
```

### AC-2: Log Gate Advancement Event

```gherkin
Scenario: Gate advanced event logged
  Given NPD project NPD-001 at gate G2
  When gate advanced to G3 via POST /api/npd/projects/:id/advance-gate
  Then event created with:
    | event_type | NPD.GateAdvanced |
    | entity_type | npd_project |
    | entity_id | NPD-001 ID |
    | payload | { from_gate: 'G2', to_gate: 'G3', approved_by: user-123 } |
    | status | completed |
    | created_at | Now |
    | processed_at | Now |
```

```gherkin
Scenario: Formulation locked event logged
  Given formulation v2.0 status = 'approved'
  When formulation locked via POST /api/npd/formulations/:id/lock
  Then event created with:
    | event_type | NPD.FormulationLocked |
    | entity_type | npd_formulation |
    | entity_id | Formulation ID |
    | payload | { formulation_number: 'v2.0', locked_by: user-123 } |
    | status | completed |
```

```gherkin
Scenario: Costing submitted event logged
  Given costing status = 'draft'
  When costing submitted for approval via POST /api/npd/costing/:id/submit
  Then event created with:
    | event_type | NPD.CostingSubmitted |
    | entity_type | npd_costing |
    | entity_id | Costing ID |
    | payload | { target_cost: 10.50, estimated_cost: 11.20, submitted_by: user-123 } |
    | status | completed |
```

```gherkin
Scenario: Handoff completed event logged
  Given handoff wizard executed successfully
  When handoff completes via POST /api/npd/projects/:id/handoff
  Then event created with:
    | event_type | NPD.HandoffCompleted |
    | entity_type | npd_project |
    | entity_id | NPD-001 ID |
    | payload | { product_id: uuid, bom_id: uuid, wo_id: uuid, handoff_by: user-123 } |
    | status | completed |
```

### AC-3: Event Retry Mechanism

```gherkin
Scenario: Failed event retry (transient error)
  Given event type = NPD.HandoffCompleted
  And event status = 'failed'
  And retry_count = 0
  And error_message = 'Network timeout'
  When retry worker runs (every 1 minute)
  Then event status = 'processing'
  And retry_count = 1
  And event re-processes
  And if successful: status = 'completed', processed_at = now
  And if failed again: status = 'failed', retry_count = 2

Scenario: Max retries reached (permanent failure)
  Given event with retry_count = 3 (max)
  And status = 'failed'
  When retry worker runs
  Then event skipped (no more retries)
  And admin notification sent: "Event {id} permanently failed"

Scenario: Admin manual retry
  Given event with retry_count = 3 and status = 'failed'
  When admin calls POST /api/npd/events/:id/retry with force = true
  Then retry_count reset to 0
  And event status = 'processing'
  And event re-processes
```

```gherkin
Scenario: Retry exponential backoff
  Given event with retry_count = 1
  When retry worker runs
  Then wait 1 minute before retry

  Given event with retry_count = 2
  When retry worker runs
  Then wait 2 minutes before retry

  Given event with retry_count = 3
  When retry worker runs
  Then wait 4 minutes before retry (exponential)
```

### AC-4: Admin View Event Log

```gherkin
Scenario: Admin lists all events
  Given admin user
  When GET /api/npd/events
  Then response 200 with:
    {
      "events": [
        {
          "id": 1,
          "event_type": "NPD.GateAdvanced",
          "entity_type": "npd_project",
          "entity_id": 123,
          "status": "completed",
          "created_at": "2025-01-15T14:00:00Z",
          "processed_at": "2025-01-15T14:00:05Z"
        },
        ...
      ],
      "pagination": { "total": 50, "page": 1, "limit": 20 }
    }

Scenario: Filter events by status
  Given events with various statuses
  When GET /api/npd/events?status=failed
  Then only failed events returned

Scenario: Filter events by type
  Given events with various types
  When GET /api/npd/events?event_type=NPD.HandoffCompleted
  Then only handoff events returned

Scenario: Non-admin access denied
  Given user with R&D role (not admin)
  When GET /api/npd/events
  Then error 403 "Admin access required"
```

### AC-5: Notification - Gate Approval Required

```gherkin
Scenario: Notify NPD Lead on gate approval required
  Given NPD project NPD-001 at gate G3
  And all G3 checklist items complete
  When gate ready for approval
  Then notification sent to NPD Lead:
    | Subject | Gate G3 Approval Required: NPD-001 |
    | Body | Project NPD-001 is ready for G3 gate approval. |
    | Link | /npd/projects/:id |
    | Type | email + in-app |
  And in-app notification created:
    | user_id | NPD Lead |
    | type | gate_approval_required |
    | is_read | false |
    | created_at | Now |
```

### AC-6: Notification - Costing Approval Required

```gherkin
Scenario: Notify Finance on costing approval required
  Given costing submitted for approval
  When costing status = 'submitted'
  Then notification sent to all users with FINANCE role:
    | Subject | Costing Approval Required: NPD-001 |
    | Body | NPD project NPD-001 costing submitted for approval. Target: $10.50, Estimated: $11.20. |
    | Link | /npd/projects/:id/costing |
    | Type | email + in-app |
  And in-app notification badge count increments
```

### AC-7: Notification - Cost Variance Alert

```gherkin
Scenario: Alert on cost variance exceeds warning threshold
  Given npd_settings.cost_variance_warning_pct = 20
  And pilot WO actual cost = $13.00
  And target cost = $10.00
  And variance = 30% (exceeds 20% warning)
  When pilot WO completes
  Then notification sent to NPD Lead + Finance:
    | Subject | Cost Variance Alert: NPD-001 |
    | Body | Actual cost ($13.00) exceeds target ($10.00) by 30%. |
    | Link | /npd/projects/:id/costing |
    | Type | email + in-app |
    | Priority | high |

Scenario: No alert if variance within threshold
  Given variance = 15% (below 20% warning)
  When pilot WO completes
  Then no variance alert sent
```

### AC-8: Notification - Missing Compliance Docs

```gherkin
Scenario: Alert Regulatory on missing compliance docs
  Given NPD project NPD-001 at gate G4
  And required doc types: HACCP, Label Proof
  And only HACCP uploaded (Label Proof missing)
  When gate advance attempted
  Then notification sent to all users with REGULATORY role:
    | Subject | Missing Compliance Docs: NPD-001 |
    | Body | Project NPD-001 missing required documents: Label Proof. |
    | Link | /npd/projects/:id/documents |
    | Type | email + in-app |
```

### AC-9: Notification - Handoff Completed

```gherkin
Scenario: Notify Production on handoff completed
  Given handoff executed successfully
  And pilot WO created
  When handoff completes
  Then notification sent to all users with PRODUCTION_MANAGER role:
    | Subject | New Product Handed Off: PROD-NPD-001 |
    | Body | NPD project NPD-001 completed handoff. Pilot WO WO-PILOT-NPD-001-001 scheduled for 2025-01-22. |
    | Link | /production/work-orders/:id |
    | Type | email + in-app |
```

### AC-10: In-App Notification Center

```gherkin
Scenario: User views notification center
  Given user has 5 unread notifications
  When user clicks notification bell icon
  Then notification panel displays:
    | Notification | Time | Read Status |
    | Costing Approval Required: NPD-001 | 5 min ago | Unread |
    | Gate G3 Approval Required: NPD-002 | 1 hour ago | Unread |
    | ... | ... | ... |
  And badge count shows "5"

Scenario: Mark notification as read
  Given notification ID = 123 with is_read = false
  When user clicks notification
  Then notification.is_read = true
  And badge count decrements by 1
  And user redirected to notification.link

Scenario: Mark all notifications as read
  Given user has 5 unread notifications
  When user clicks [Mark All Read]
  Then all notifications.is_read = true
  And badge count = 0
```

### AC-11: Notification Preferences

```gherkin
Scenario: User sets notification preferences
  Given user navigates to Profile > Notification Preferences
  When user toggles:
    | Notification Type | Email | In-App |
    | Gate Approvals | Yes | Yes |
    | Costing Approvals | No | Yes |
    | Cost Variance Alerts | Yes | Yes |
  Then preferences saved to user_notification_preferences table
  And notifications sent according to preferences

Scenario: Default notification preferences
  Given new user created
  Then default preferences:
    | All notification types | Email: Yes | In-App: Yes |
```

### AC-12: Email Notification via Edge Function

```gherkin
Scenario: Send email notification via Supabase Edge Function
  Given notification payload:
    {
      "to": "finance@example.com",
      "subject": "Costing Approval Required: NPD-001",
      "body": "NPD project NPD-001 costing submitted...",
      "link": "https://app.monopilot.com/npd/projects/123/costing"
    }
  When email sent via Edge Function
  Then Supabase edge function invoked with payload
  And email delivered to recipient
  And notification.email_sent_at = now

Scenario: Email send failure (retry)
  Given email send fails (transient network error)
  When notification event retries
  Then email re-sent on retry attempt
  And if successful: email_sent_at updated
  And if failed after 3 retries: admin alert
```

### AC-13: Performance Requirements

```gherkin
Scenario: Event creation performance
  Given critical event (handoff completed)
  When event logged
  Then operation completes < 100ms
  And does not block main request

Scenario: Notification send performance
  Given 10 Finance users to notify
  When costing approval required
  Then all notifications created < 500ms
  And emails queued for async send

Scenario: Event retry worker performance
  Given 50 failed events
  When retry worker runs
  Then all events processed < 5 seconds
```

---

## Implementation Notes

### Database Migration

```sql
-- npd_events table
CREATE TABLE npd_events (
    id SERIAL PRIMARY KEY,
    org_id UUID NOT NULL REFERENCES organizations(id),
    event_type VARCHAR(50) NOT NULL,
    entity_type VARCHAR(50) NOT NULL,
    entity_id INTEGER NOT NULL,
    payload JSONB NOT NULL,
    status VARCHAR(20) NOT NULL DEFAULT 'pending'
        CHECK (status IN ('pending', 'processing', 'completed', 'failed')),
    retry_count INTEGER DEFAULT 0,
    error_message TEXT,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    processed_at TIMESTAMPTZ
);

CREATE INDEX idx_npd_events_org_status ON npd_events(org_id, status);
CREATE INDEX idx_npd_events_type ON npd_events(event_type);
CREATE INDEX idx_npd_events_created ON npd_events(created_at);
CREATE INDEX idx_npd_events_retry ON npd_events(status, retry_count)
    WHERE status = 'failed' AND retry_count < 3;

-- RLS policies
ALTER TABLE npd_events ENABLE ROW LEVEL SECURITY;

CREATE POLICY "events_admin_select" ON npd_events
    FOR SELECT USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
        AND EXISTS (SELECT 1 FROM user_roles WHERE user_id = auth.uid() AND role = 'ADMIN')
    );

-- notifications table
CREATE TABLE notifications (
    id SERIAL PRIMARY KEY,
    org_id UUID NOT NULL REFERENCES organizations(id),
    user_id UUID NOT NULL REFERENCES auth.users(id),
    type VARCHAR(50) NOT NULL,
    title VARCHAR(200) NOT NULL,
    body TEXT NOT NULL,
    link VARCHAR(500),
    priority VARCHAR(20) DEFAULT 'normal'
        CHECK (priority IN ('low', 'normal', 'high', 'urgent')),
    is_read BOOLEAN DEFAULT false,
    email_sent_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_notifications_user_read ON notifications(user_id, is_read);
CREATE INDEX idx_notifications_created ON notifications(created_at DESC);

-- RLS policies
ALTER TABLE notifications ENABLE ROW LEVEL SECURITY;

CREATE POLICY "notifications_user_select" ON notifications
    FOR SELECT USING (user_id = auth.uid());

CREATE POLICY "notifications_user_update" ON notifications
    FOR UPDATE USING (user_id = auth.uid());

-- user_notification_preferences table
CREATE TABLE user_notification_preferences (
    id SERIAL PRIMARY KEY,
    user_id UUID NOT NULL REFERENCES auth.users(id) UNIQUE,
    gate_approvals_email BOOLEAN DEFAULT true,
    gate_approvals_in_app BOOLEAN DEFAULT true,
    costing_approvals_email BOOLEAN DEFAULT true,
    costing_approvals_in_app BOOLEAN DEFAULT true,
    cost_variance_email BOOLEAN DEFAULT true,
    cost_variance_in_app BOOLEAN DEFAULT true,
    compliance_docs_email BOOLEAN DEFAULT true,
    compliance_docs_in_app BOOLEAN DEFAULT true,
    handoff_completed_email BOOLEAN DEFAULT true,
    handoff_completed_in_app BOOLEAN DEFAULT true,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- RLS policies
ALTER TABLE user_notification_preferences ENABLE ROW LEVEL SECURITY;

CREATE POLICY "preferences_user_all" ON user_notification_preferences
    FOR ALL USING (user_id = auth.uid());
```

### Service Layer

```typescript
// lib/services/npd-event-service.ts

export class NPDEventService {
  /**
   * Log NPD event
   */
  static async logEvent(
    orgId: string,
    eventType: string,
    entityType: string,
    entityId: number,
    payload: Record<string, any>
  ): Promise<void> {
    await db.query(
      `INSERT INTO npd_events (org_id, event_type, entity_type, entity_id, payload, status)
       VALUES ($1, $2, $3, $4, $5, 'completed')`,
      [orgId, eventType, entityType, entityId, JSON.stringify(payload)]
    );
  }

  /**
   * List events (admin only)
   */
  static async listEvents(
    params: EventListParams
  ): Promise<PaginatedResult<NPDEvent>> {
    const { status, event_type, page = 1, limit = 20 } = params;
    const offset = (page - 1) * limit;

    let query = `SELECT * FROM npd_events WHERE 1=1`;
    const values: any[] = [];

    if (status) {
      values.push(status);
      query += ` AND status = $${values.length}`;
    }

    if (event_type) {
      values.push(event_type);
      query += ` AND event_type = $${values.length}`;
    }

    query += ` ORDER BY created_at DESC LIMIT $${values.length + 1} OFFSET $${values.length + 2}`;
    values.push(limit, offset);

    const result = await db.query(query, values);

    const countResult = await db.query(
      `SELECT COUNT(*) FROM npd_events WHERE 1=1${status ? ' AND status = $1' : ''}${event_type ? ' AND event_type = $2' : ''}`,
      status && event_type ? [status, event_type] : status ? [status] : event_type ? [event_type] : []
    );

    return {
      data: result.rows,
      pagination: {
        total: parseInt(countResult.rows[0].count, 10),
        page,
        limit,
        pages: Math.ceil(parseInt(countResult.rows[0].count, 10) / limit),
      },
    };
  }

  /**
   * Retry failed event (admin)
   */
  static async retryEvent(eventId: number, force: boolean = false): Promise<void> {
    const event = await db.query(
      `SELECT * FROM npd_events WHERE id = $1`,
      [eventId]
    );

    if (event.rows.length === 0) {
      throw new Error('Event not found');
    }

    const evt = event.rows[0];

    if (!force && evt.retry_count >= 3) {
      throw new Error('Max retries reached. Use force=true to retry.');
    }

    await db.query(
      `UPDATE npd_events
       SET status = 'processing', retry_count = ${force ? 0 : 'retry_count + 1'}, error_message = NULL
       WHERE id = $1`,
      [eventId]
    );

    // Re-process event (delegate to specific handler based on event_type)
    await this.processEvent(evt);
  }

  /**
   * Process event (dispatcher)
   */
  private static async processEvent(event: NPDEvent): Promise<void> {
    try {
      switch (event.event_type) {
        case 'NPD.GateAdvanced':
          // Handle gate advancement logic
          break;
        case 'NPD.HandoffCompleted':
          // Handle handoff completion logic
          break;
        // ... other event types
      }

      await db.query(
        `UPDATE npd_events SET status = 'completed', processed_at = NOW() WHERE id = $1`,
        [event.id]
      );
    } catch (error) {
      await db.query(
        `UPDATE npd_events SET status = 'failed', error_message = $1 WHERE id = $2`,
        [error.message, event.id]
      );
    }
  }
}

// lib/services/npd-notification-service.ts

export class NPDNotificationService {
  /**
   * Send notification (email + in-app)
   */
  static async sendNotification(
    userId: string,
    type: string,
    title: string,
    body: string,
    link: string,
    priority: string = 'normal'
  ): Promise<void> {
    const prefs = await this.getUserPreferences(userId);

    // Create in-app notification (if enabled)
    if (this.isInAppEnabled(prefs, type)) {
      await db.query(
        `INSERT INTO notifications (org_id, user_id, type, title, body, link, priority)
         VALUES ((SELECT org_id FROM users WHERE id = $1), $1, $2, $3, $4, $5, $6)`,
        [userId, type, title, body, link, priority]
      );
    }

    // Send email notification (if enabled)
    if (this.isEmailEnabled(prefs, type)) {
      await this.sendEmail(userId, title, body, link);
    }
  }

  /**
   * Send email via Supabase Edge Function
   */
  private static async sendEmail(
    userId: string,
    subject: string,
    body: string,
    link: string
  ): Promise<void> {
    const user = await db.query(`SELECT email FROM auth.users WHERE id = $1`, [userId]);

    if (user.rows.length === 0) return;

    const email = user.rows[0].email;

    await fetch('https://YOUR_SUPABASE_PROJECT.functions.supabase.co/send-email', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ to: email, subject, body, link }),
    });
  }

  /**
   * Get user notification preferences
   */
  private static async getUserPreferences(userId: string): Promise<NotificationPreferences> {
    const result = await db.query(
      `SELECT * FROM user_notification_preferences WHERE user_id = $1`,
      [userId]
    );

    if (result.rows.length === 0) {
      // Return default preferences
      return { all_email: true, all_in_app: true };
    }

    return result.rows[0];
  }

  /**
   * Check if in-app notification enabled for type
   */
  private static isInAppEnabled(prefs: NotificationPreferences, type: string): boolean {
    const field = `${type}_in_app`;
    return prefs[field] !== false;
  }

  /**
   * Check if email notification enabled for type
   */
  private static isEmailEnabled(prefs: NotificationPreferences, type: string): boolean {
    const field = `${type}_email`;
    return prefs[field] !== false;
  }

  /**
   * Mark notification as read
   */
  static async markAsRead(notificationId: number, userId: string): Promise<void> {
    await db.query(
      `UPDATE notifications SET is_read = true WHERE id = $1 AND user_id = $2`,
      [notificationId, userId]
    );
  }

  /**
   * Get unread count for user
   */
  static async getUnreadCount(userId: string): Promise<number> {
    const result = await db.query(
      `SELECT COUNT(*) FROM notifications WHERE user_id = $1 AND is_read = false`,
      [userId]
    );
    return parseInt(result.rows[0].count, 10);
  }
}
```

### API Endpoints

```typescript
// GET /api/npd/events (admin only)
interface EventListParams {
  status?: 'pending' | 'processing' | 'completed' | 'failed';
  event_type?: string;
  page?: number;
  limit?: number;
}

interface EventListResponse {
  events: NPDEvent[];
  pagination: {
    total: number;
    page: number;
    limit: number;
    pages: number;
  };
}

// POST /api/npd/events/:id/retry (admin only)
interface RetryEventRequest {
  force?: boolean; // Force retry even if max retries reached
}

interface RetryEventResponse {
  success: boolean;
  event: NPDEvent;
  message: string;
}

// GET /api/notifications (user)
interface NotificationListResponse {
  notifications: Notification[];
  unread_count: number;
}

// PUT /api/notifications/:id/read (user)
interface MarkReadResponse {
  success: boolean;
}
```

---

## Deliverables

### Database
- [ ] Migration: npd_events table with RLS
- [ ] Migration: notifications table with RLS
- [ ] Migration: user_notification_preferences table with RLS
- [ ] Indexes for performance

### API Routes
- [ ] GET /api/npd/events (admin)
- [ ] POST /api/npd/events/:id/retry (admin)
- [ ] GET /api/notifications (user)
- [ ] PUT /api/notifications/:id/read (user)
- [ ] GET /api/notifications/unread-count (user)

### Service Layer
- [ ] NPDEventService.logEvent()
- [ ] NPDEventService.listEvents()
- [ ] NPDEventService.retryEvent()
- [ ] NPDEventService.processEvent()
- [ ] NPDNotificationService.sendNotification()
- [ ] NPDNotificationService.sendEmail()
- [ ] NPDNotificationService.markAsRead()
- [ ] NPDNotificationService.getUnreadCount()

### Edge Functions
- [ ] send-email Edge Function (Supabase)

### Frontend
- [ ] Notification bell icon with badge count
- [ ] Notification center panel
- [ ] Notification preferences page
- [ ] Admin event log page

### Tests
- [ ] Unit test: NPDEventService.logEvent()
- [ ] Unit test: NPDEventService.retryEvent()
- [ ] Unit test: NPDNotificationService.sendNotification()
- [ ] Integration test: GET /api/npd/events
- [ ] Integration test: POST /api/npd/events/:id/retry
- [ ] Integration test: Notification delivery
- [ ] E2E test: Full notification workflow

---

## Definition of Done

- [ ] npd_events table created with all columns
- [ ] Event logging works for all critical events
- [ ] Retry mechanism processes failed events (1min, 2min, 4min)
- [ ] Max retries (3) enforced
- [ ] Admin can view event log
- [ ] Admin can retry failed events
- [ ] Notifications sent for all defined triggers
- [ ] Email notifications delivered via Edge Function
- [ ] In-app notification center displays notifications
- [ ] Badge count shows unread notifications
- [ ] Mark as read works
- [ ] Notification preferences save and apply
- [ ] Permission checks enforce ADMIN role for events
- [ ] RLS policies enforce org isolation
- [ ] Event creation < 100ms
- [ ] Notification send < 500ms for 10 users
- [ ] Unit tests achieve >80% coverage
- [ ] Integration tests cover all event types
- [ ] E2E tests verify notification delivery

---

## Risk Assessment

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Email delivery failure (spam filters) | MEDIUM | MEDIUM | Use reputable email service, SPF/DKIM records |
| Retry worker overload (many failed events) | MEDIUM | LOW | Rate limit retry worker, prioritize by event type |
| Notification spam (too many notifications) | LOW | MEDIUM | Smart batching, daily digest option |
| Event log storage growth | LOW | HIGH | Auto-cleanup after 90 days, archive to S3 |
| Edge Function cold start latency | LOW | MEDIUM | Keep function warm, async email send |

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2026-01-15 | Initial version - Event sourcing & notifications | ARCHITECT-AGENT |

---

**Document Status**: Ready for Implementation
**Created**: 2026-01-15
**Lines**: ~900
**Complexity**: M (Medium)
**Phase**: 2 (Event & Notification System)
