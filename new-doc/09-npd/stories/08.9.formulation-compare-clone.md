# 08.9 - Formulation Compare & Clone

**Priority**: P1 (MVP - Phase 1)
**Story Points**: M (Medium)
**Type**: frontend
**Estimate**: 2-3 days

**State**: ready
**Primary PRD**: `docs/1-BASELINE/product/modules/npd.md` (Section 3.6, FR-NPD-15, FR-NPD-16)
**Dependencies**: 08.4 (Formulations CRUD & Versioning)

---

## Goal

Implement side-by-side formulation version comparison and clone functionality to enable NPD teams to analyze recipe changes, understand evolution, and create new versions efficiently.

---

## User Story

As an **R&D Specialist**, I want to **compare two formulation versions side-by-side and clone formulations to create new versions** so that **I can understand recipe evolution, analyze cost impacts, and efficiently iterate on product formulations**.

---

## Scope

**In scope (this story)**
- GET /api/npd/formulations/compare?v1=:id1&v2=:id2 - Compare two formulation versions
- POST /api/npd/formulations/:id/clone - Clone formulation to new version
- Side-by-side comparison view at `/npd/formulations/compare?v1=:id1&v2=:id2`
- Diff highlighting: added items (green), removed items (red), changed items (yellow)
- Cost difference display (if costing data available)
- Quantity and percentage change indicators
- Clone formulation modal with version number selection
- Clone preserves formulation items but resets status to 'draft'
- Clone sets parent_formulation_id for lineage tracking
- Version selection dropdown (compare any two versions from same project)

**Out of scope (this story)**
- Allergen comparison (covered in 08.5)
- Detailed costing calculation (covered in 08.7)
- Export comparison to PDF (Phase 2)
- Three-way comparison (Phase 3)
- Inline editing in comparison view (Phase 3)

---

## Dependencies

### Hard Dependencies
| Story | Provides | Status |
|-------|----------|--------|
| 08.4 | Formulations CRUD, npd_formulations table, versioning | Ready |
| 02.1 | Products CRUD, products table | Ready |
| 01.1 | Org context + RLS | Ready |

### Soft Dependencies
| Story | Provides | Impact if Missing |
|-------|----------|-------------------|
| 08.7 | Formulation costing | Cost diff unavailable (graceful degradation) |
| 08.5 | Allergen aggregation | Allergen diff unavailable (Phase 2 feature) |

---

## Acceptance Criteria (Given/When/Then)

### AC-1: Access Comparison View

```gherkin
Scenario: Navigate to comparison from formulation list
  Given user viewing formulation list for project NPD-001
  And multiple versions exist (v1.0, v1.1, v2.0)
  When user clicks [Compare Versions] button
  Then version selection modal displays with dropdown for Version 1 and Version 2
  And user selects v1.0 and v2.0
  And clicks [Compare]
  Then navigates to /npd/formulations/compare?v1=123&v2=456
  And comparison view loads within 500ms
```

```gherkin
Scenario: Direct URL access with query params
  Given URL /npd/formulations/compare?v1=123&v2=456
  When page loads
  Then comparison view displays both versions side-by-side
  And header shows "Comparing v1.0 vs v2.0 - Project NPD-001"
```

```gherkin
Scenario: Invalid version IDs in URL
  Given URL /npd/formulations/compare?v1=999&v2=888
  And versions do not exist or belong to different projects
  When page loads
  Then error "Cannot compare: versions not found or from different projects"
  And redirects to formulation list after 3 seconds
```

### AC-2: Comparison View Layout

```gherkin
Scenario: Comparison view structure
  Given comparison view loaded for v1.0 vs v2.0
  When viewing page
  Then layout displays:
    | Section | Content |
    | Header | "Comparing v1.0 vs v2.0 - Project NPD-001" |
    | Summary Cards | Total items, Added items, Removed items, Changed items, Cost difference |
    | Version Headers | Left: v1.0 details, Right: v2.0 details |
    | Items Table | Side-by-side item comparison with diff highlighting |
    | Actions | [Clone v1.0], [Clone v2.0], [Back to List] |
```

```gherkin
Scenario: Version details display
  Given comparison view loaded
  When viewing version headers
  Then each side shows:
    | Field | Example |
    | Version | v1.0 |
    | Status | Approved (badge) |
    | Effective Dates | 2024-01-01 to 2024-06-30 |
    | Total Qty | 100 kg |
    | Items Count | 5 items |
    | Created | 2024-01-01 by John Doe |
```

### AC-3: Diff Highlighting - Added Items

```gherkin
Scenario: Items added in newer version
  Given v1.0 has items: Flour (50 kg), Sugar (30 kg)
  And v2.0 has items: Flour (50 kg), Sugar (30 kg), Salt (5 kg)
  When comparison view displayed
  Then Salt row shows:
    | v1.0 Column | v2.0 Column |
    | [Empty with gray background] | Salt 5 kg (50%) [Green highlight] |
  And summary card shows "Added: 1 item"
```

```gherkin
Scenario: Multiple added items
  Given v2.0 adds 3 new ingredients
  When comparison displayed
  Then all 3 items show green highlight in v2.0 column
  And empty cells in v1.0 column
  And summary shows "Added: 3 items"
```

### AC-4: Diff Highlighting - Removed Items

```gherkin
Scenario: Items removed in newer version
  Given v1.0 has items: Flour (50 kg), Sugar (30 kg), Water (20 kg)
  And v2.0 has items: Flour (50 kg), Sugar (30 kg)
  When comparison view displayed
  Then Water row shows:
    | v1.0 Column | v2.0 Column |
    | Water 20 kg (20%) [Red highlight] | [Empty with gray background] |
  And summary card shows "Removed: 1 item"
```

### AC-5: Diff Highlighting - Changed Items

```gherkin
Scenario: Item quantity changed
  Given v1.0 has Flour: 50 kg (50%)
  And v2.0 has Flour: 60 kg (60%)
  When comparison view displayed
  Then Flour row shows:
    | v1.0 Column | v2.0 Column |
    | Flour 50 kg (50%) | Flour 60 kg (60%) [Yellow highlight] |
  And change indicator shows "+10 kg (+10%)" in v2.0 column
  And summary card shows "Changed: 1 item"
```

```gherkin
Scenario: Item UoM changed
  Given v1.0 has Sugar: 30 kg
  And v2.0 has Sugar: 30000 g (equivalent)
  When comparison displayed
  Then Sugar row shows yellow highlight
  And UoM change indicated
```

```gherkin
Scenario: No changes
  Given v1.0 has Flour: 50 kg
  And v2.0 has Flour: 50 kg (unchanged)
  When comparison displayed
  Then Flour row shows no highlight (white background)
  And no change indicator
```

### AC-6: Cost Difference Display

```gherkin
Scenario: Cost difference with costing data
  Given v1.0 has estimated_cost = $100
  And v2.0 has estimated_cost = $120
  When comparison view displayed
  Then summary card shows:
    | v1.0 Cost | v2.0 Cost | Difference |
    | $100.00 | $120.00 | +$20.00 (+20%) [Red if increase] |
```

```gherkin
Scenario: Cost decrease
  Given v1.0 cost = $100
  And v2.0 cost = $80
  Then difference shows "-$20.00 (-20%) [Green if decrease]"
```

```gherkin
Scenario: No costing data
  Given v1.0 has no costing record
  When comparison displayed
  Then cost difference card shows "Costing data not available"
  And card is grayed out
```

### AC-7: Clone Formulation

```gherkin
Scenario: Clone from comparison view
  Given comparison view loaded for v1.0 vs v2.0
  When user clicks [Clone v1.0]
  Then clone modal displays with:
    | Field | Default Value |
    | Source Version | v1.0 (locked) |
    | New Version Number | v3.0 (auto-suggested next major) |
    | Status | draft (locked) |
    | Total Qty | 100 kg (editable) |
    | UoM | kg (editable) |
    | Effective From | [Empty] (optional) |
    | Effective To | [Empty] (optional) |
    | Notes | [Empty] (optional) |
  And user can edit version number, qty, dates, notes
```

```gherkin
Scenario: Clone with custom version number
  Given clone modal displayed
  When user changes version from "v3.0" to "v2.1"
  And clicks [Clone Formulation]
  Then new formulation created with:
    | Field | Value |
    | formulation_number | v2.1 |
    | npd_project_id | Same as source (NPD-001) |
    | status | draft |
    | parent_formulation_id | v1.0 ID (lineage) |
    | total_qty | 100 kg (or user-edited) |
    | items | Copied from v1.0 |
  And percentages recalculated if total_qty changed
  And success toast "Formulation v2.1 cloned from v1.0"
  And redirects to /npd/formulations/:newId/edit
```

```gherkin
Scenario: Clone validation - duplicate version
  Given project NPD-001 has v1.0, v1.1, v2.0
  When user attempts to clone as "v2.0" (exists)
  Then error "Version v2.0 already exists for this project"
  And clone button disabled until version changed
```

```gherkin
Scenario: Clone validation - invalid version format
  Given clone modal displayed
  When user enters version "2.0" (missing 'v' prefix)
  Then error "Version must be in format v1.0, v1.1, v2.0, etc."
  And clone button disabled
```

```gherkin
Scenario: Clone from formulation detail page
  Given user viewing formulation detail for v1.0
  When user clicks [Clone Formulation] action button
  Then clone modal displays (same as comparison view)
  And clone proceeds with same logic
```

### AC-8: Summary Cards

```gherkin
Scenario: Summary cards display
  Given comparison of v1.0 (5 items) vs v2.0 (6 items, 1 added, 2 changed)
  When viewing summary section
  Then cards display:
    | Card | Value | Color |
    | Total Items v1.0 | 5 | Blue |
    | Total Items v2.0 | 6 | Blue |
    | Added | 1 | Green |
    | Removed | 0 | Gray |
    | Changed | 2 | Yellow |
    | Cost Difference | +$20 (+20%) | Red |
```

```gherkin
Scenario: No changes summary
  Given v1.0 and v1.1 are identical (same items, quantities)
  When comparison displayed
  Then cards show:
    | Added | 0 |
    | Removed | 0 |
    | Changed | 0 |
  And message "No differences found between versions"
```

### AC-9: Items Table Comparison

```gherkin
Scenario: Items table structure
  Given comparison view loaded
  When viewing items table
  Then columns display:
    | Column | Description |
    | Product | Product name (from products table) |
    | v1.0 Quantity | Qty + UoM or [Empty] |
    | v1.0 Percentage | % of total or [Empty] |
    | Change | Arrow indicator (↑/↓/=) or [Empty] |
    | v2.0 Quantity | Qty + UoM or [Empty] |
    | v2.0 Percentage | % of total or [Empty] |
  And rows sorted by product name (alphabetically)
```

```gherkin
Scenario: Change indicator icons
  Given comparison with quantity changes
  When viewing change column
  Then indicators show:
    | Change Type | Icon | Color |
    | Increase | ↑ +10 kg (+10%) | Green |
    | Decrease | ↓ -5 kg (-5%) | Red |
    | No change | = | Gray |
    | Added | + New | Green |
    | Removed | - Removed | Red |
```

### AC-10: Permission Enforcement

```gherkin
Scenario: Viewer role permissions
  Given user has VIEWER role
  When viewing comparison
  Then [Clone v1.0] and [Clone v2.0] buttons hidden
  And comparison view is read-only
```

```gherkin
Scenario: R&D role permissions
  Given user has R&D role
  When viewing comparison
  Then [Clone] buttons visible
  And clone modal allows creation
```

```gherkin
Scenario: NPD Lead permissions
  Given user has NPD_LEAD role
  Then full access to compare and clone
```

---

## Implementation Notes

### API Endpoints

```typescript
// GET /api/npd/formulations/compare?v1=:id1&v2=:id2
interface CompareFormulationsResponse {
  v1: FormulationWithItems;
  v2: FormulationWithItems;
  diff: {
    added: ProductDiff[];
    removed: ProductDiff[];
    changed: ProductDiff[];
    unchanged: ProductDiff[];
  };
  summary: {
    v1_total_items: number;
    v2_total_items: number;
    added_count: number;
    removed_count: number;
    changed_count: number;
    cost_difference: CostDifference | null;
  };
}

interface FormulationWithItems {
  id: number;
  formulation_number: string;
  status: 'draft' | 'approved' | 'locked';
  effective_from: string | null;
  effective_to: string | null;
  total_qty: number;
  uom: string;
  notes: string | null;
  created_at: string;
  created_by: string;
  items: FormulationItemWithProduct[];
  estimated_cost: number | null; // from npd_costing if available
}

interface FormulationItemWithProduct {
  id: number;
  product_id: string;
  product_code: string;
  product_name: string;
  quantity: number;
  uom: string;
  percentage: number;
  notes: string | null;
}

interface ProductDiff {
  product_id: string;
  product_code: string;
  product_name: string;
  v1_quantity: number | null;
  v1_uom: string | null;
  v1_percentage: number | null;
  v2_quantity: number | null;
  v2_uom: string | null;
  v2_percentage: number | null;
  change_type: 'added' | 'removed' | 'changed' | 'unchanged';
  change_qty: number | null; // v2 - v1
  change_pct: number | null; // percentage change
}

interface CostDifference {
  v1_cost: number;
  v2_cost: number;
  difference: number; // v2 - v1
  difference_pct: number; // (v2 - v1) / v1 * 100
}

// POST /api/npd/formulations/:id/clone
interface CloneFormulationRequest {
  formulation_number: string; // v3.0, v2.1, etc.
  total_qty?: number; // optional, defaults to source total_qty
  uom?: string; // optional, defaults to source uom
  effective_from?: string | null;
  effective_to?: string | null;
  notes?: string;
}

interface CloneFormulationResponse {
  formulation: Formulation;
  cloned_items_count: number;
  parent_version: string; // source formulation_number
}
```

### Service Layer

```typescript
// lib/services/formulation-service.ts

export class FormulationService {
  /**
   * Compare two formulation versions
   * Returns diff with added/removed/changed items
   */
  static async compareFormulations(
    v1Id: number,
    v2Id: number
  ): Promise<CompareFormulationsResponse> {
    // 1. Fetch both formulations with items
    // 2. Validate both from same project
    // 3. Fetch costing data if available
    // 4. Calculate diff:
    //    - added: items in v2 but not in v1 (by product_id)
    //    - removed: items in v1 but not in v2
    //    - changed: items in both but different qty/uom
    //    - unchanged: items in both with same qty/uom
    // 5. Calculate summary counts
    // 6. Return comparison response
  }

  /**
   * Clone formulation to new version
   * Copies all items, sets status to draft, tracks lineage
   */
  static async cloneFormulation(
    sourceId: number,
    data: CloneFormulationRequest
  ): Promise<CloneFormulationResponse> {
    // 1. Validate source formulation exists
    // 2. Validate new version number unique for project
    // 3. Create new formulation record:
    //    - npd_project_id: same as source
    //    - formulation_number: data.formulation_number
    //    - status: 'draft' (always)
    //    - parent_formulation_id: sourceId
    //    - total_qty: data.total_qty || source.total_qty
    //    - uom: data.uom || source.uom
    //    - effective_from, effective_to, notes: from data
    // 4. Copy all formulation_items:
    //    - INSERT INTO npd_formulation_items (formulation_id, product_id, quantity, uom, notes)
    //      SELECT :newFormulationId, product_id, quantity, uom, notes
    //      FROM npd_formulation_items WHERE formulation_id = :sourceId
    // 5. Trigger auto-calculates percentages
    // 6. Return new formulation with items count
  }

  /**
   * Calculate diff between two item lists
   */
  private static calculateDiff(
    v1Items: FormulationItemWithProduct[],
    v2Items: FormulationItemWithProduct[]
  ): Diff {
    // Use product_id as key
    // Compare quantities and UoM
    // Categorize as added/removed/changed/unchanged
  }

  /**
   * Validate formulations are from same project
   */
  private static validateSameProject(v1: Formulation, v2: Formulation): void {
    if (v1.npd_project_id !== v2.npd_project_id) {
      throw new Error('Cannot compare formulations from different projects');
    }
  }
}
```

### Frontend Components

```
app/(authenticated)/npd/formulations/compare/page.tsx -- Comparison view page

components/npd/formulation/
  FormulationCompareView.tsx        -- Main comparison container
  FormulationCompareHeader.tsx      -- Header with version details
  FormulationCompareSummary.tsx     -- Summary cards (added/removed/changed)
  FormulationCompareTable.tsx       -- Side-by-side items table
  FormulationCompareRow.tsx         -- Individual item row with diff highlighting
  FormulationCompareCostCard.tsx    -- Cost difference card
  FormulationCompareActions.tsx     -- Action buttons (clone, back)
  CloneFormulationModal.tsx         -- Clone modal with version input
  VersionSelectorModal.tsx          -- Select two versions to compare
  DiffBadge.tsx                     -- Badge for change type (added/removed/changed)
  ChangeIndicator.tsx               -- Arrow and value for quantity changes
```

### Validation (Zod)

```typescript
const cloneFormulationSchema = z.object({
  formulation_number: z.string()
    .regex(/^v\d+\.\d+$/, "Version must be in format v1.0, v1.1, etc."),
  total_qty: z.number()
    .positive("Total quantity must be greater than 0")
    .max(999999999, "Total quantity too large")
    .optional(),
  uom: z.string()
    .min(1, "Unit of measure is required")
    .max(20)
    .optional(),
  effective_from: z.string()
    .refine((val) => !val || !isNaN(Date.parse(val)), "Invalid date")
    .nullable()
    .optional(),
  effective_to: z.string()
    .refine((val) => !val || !isNaN(Date.parse(val)), "Invalid date")
    .nullable()
    .optional(),
  notes: z.string()
    .max(2000)
    .optional(),
}).refine((data) => {
  if (data.effective_to && data.effective_from) {
    return new Date(data.effective_to) >= new Date(data.effective_from);
  }
  return true;
}, {
  message: "Effective To must be after Effective From",
  path: ["effective_to"],
});

const compareFormulationsQuerySchema = z.object({
  v1: z.coerce.number().int().positive("Invalid version 1 ID"),
  v2: z.coerce.number().int().positive("Invalid version 2 ID"),
});
```

---

## Deliverables

### Database
- No new tables (uses existing npd_formulations, npd_formulation_items)
- Clone operation uses INSERT...SELECT for efficient copy

### API Routes
- [ ] GET /api/npd/formulations/compare?v1=:id1&v2=:id2
- [ ] POST /api/npd/formulations/:id/clone

### Service Layer
- [ ] FormulationService.compareFormulations()
- [ ] FormulationService.cloneFormulation()
- [ ] FormulationService.calculateDiff()
- [ ] FormulationService.validateSameProject()

### Frontend
- [ ] Comparison view page (/npd/formulations/compare)
- [ ] FormulationCompareView component
- [ ] FormulationCompareSummary component with cards
- [ ] FormulationCompareTable with diff highlighting
- [ ] CloneFormulationModal component
- [ ] VersionSelectorModal component
- [ ] DiffBadge and ChangeIndicator components
- [ ] Cost difference display (if data available)
- [ ] Permission-based UI rendering

### Validation
- [ ] cloneFormulationSchema (Zod)
- [ ] compareFormulationsQuerySchema (Zod)

### Tests
- [ ] Integration test: GET /api/npd/formulations/compare
- [ ] Integration test: POST /api/npd/formulations/:id/clone
- [ ] Unit test: FormulationService.compareFormulations()
- [ ] Unit test: FormulationService.cloneFormulation()
- [ ] Unit test: calculateDiff logic (added/removed/changed)
- [ ] E2E test: Full comparison workflow
- [ ] E2E test: Clone formulation end-to-end

---

## Definition of Done

- [ ] Comparison view loads within 500ms for formulations with 50 items each
- [ ] Diff highlighting displays correctly (green/red/yellow)
- [ ] Added items show in v2 column only with green highlight
- [ ] Removed items show in v1 column only with red highlight
- [ ] Changed items show yellow highlight with change indicator
- [ ] Summary cards show accurate counts (added/removed/changed)
- [ ] Cost difference displays if costing data available
- [ ] Cost card grayed out if costing data missing (graceful degradation)
- [ ] Clone modal opens with correct defaults
- [ ] Clone creates new formulation with status 'draft'
- [ ] Clone copies all formulation items
- [ ] Clone sets parent_formulation_id for lineage
- [ ] Clone recalculates percentages if total_qty changed
- [ ] Clone validation prevents duplicate version numbers
- [ ] Version selector allows choosing any two versions from project
- [ ] Comparison blocked if versions from different projects
- [ ] Permission checks hide clone buttons for VIEWER role
- [ ] All API endpoints return correct status codes
- [ ] Integration tests cover compare and clone endpoints
- [ ] Unit tests achieve >80% coverage on comparison logic
- [ ] E2E tests verify full comparison and clone workflows
- [ ] Empty state displays "Select versions to compare" CTA
- [ ] Error states display clear messages with retry option

---

## Risk Assessment

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Performance with large formulations (100+ items) | MEDIUM | LOW | Pagination in comparison table, limit to 200 items |
| Complex diff algorithm bugs | HIGH | MEDIUM | Comprehensive unit tests, edge cases (null values, UoM conversion) |
| Clone creates stale data (cost/allergens) | LOW | MEDIUM | Clear messaging that cloned formulations are draft, require re-validation |
| User confusion with version selection | MEDIUM | MEDIUM | Clear UX with project validation, helpful error messages |
| Cost data missing (integration with 08.7) | LOW | HIGH | Graceful degradation, card grayed out with explanation |

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2026-01-15 | Initial version - Formulation Compare & Clone | ARCHITECT-AGENT |

---

**Document Status**: Ready for Implementation
**Created**: 2026-01-15
**Lines**: ~600
**Complexity**: M (Medium)
**Phase**: 1 (MVP)
