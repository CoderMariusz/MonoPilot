# 08.4 - Formulations CRUD & Versioning

**Priority**: P1 (MVP - Phase 1)
**Story Points**: L (Large)
**Type:** fullstack

**State:** ready
**Primary PRD:** `docs/1-BASELINE/product/modules/npd.md` (Section 3, FR-NPD-08, 09, 11, 12, 13, 14)
**UX Wireframes:** NPD-004 (Formulation List), NPD-005 (Formulation Editor), NPD-006 (Formulation Timeline)

---

## MVP Scope

This story implements Phase 1 (MVP) functionality only. Features listed in "Future Phases" are deferred.

---

## Goal

Implement complete formulation CRUD operations with version control, effective date management, lineage tracking, and auto-calculated percentages. Enable NPD teams to develop and iterate recipes before handoff to production.

## User Story

As an **R&D Specialist**, I want to **create and manage formulations with version control and effective dates** so that **I can iterate on recipes during product development and track the evolution of formulations**.

## Scope

**In scope (MVP)**
- GET /api/npd/formulations (list with pagination, search, filters by project/status)
- POST /api/npd/formulations (create new formulation)
- PUT /api/npd/formulations/:id (update existing formulation header)
- DELETE /api/npd/formulations/:id (delete formulation if not approved/locked)
- Formulation list page at `/npd/projects/:id/formulations` with DataTable
- Create/Edit formulation page with form validation
- Formulation header fields: npd_project_id, formulation_number, status, effective_from, effective_to, total_qty, uom, notes
- Formulation items: product_id, quantity, uom, percentage (auto-calculated)
- Date validity: effective_from optional, effective_to optional (NULL = no end)
- Date overlap prevention (database trigger enforces no overlaps for same project)
- Formulation status management: draft, approved, locked
- Version numbering (v1.0, v1.1, v2.0 - major/minor versions)
- Lineage tracking (parent_formulation_id)
- Lock formulation on approval (immutable after lock)
- Auto-calculate percentages: item_qty / total_qty * 100
- **Version timeline visualization - show all formulation versions for a project on a timeline**

**Out of scope (this story)**
- Formulation allergen aggregation (covered in 08.5)
- Formulation clone/copy functionality (covered in 08.6)
- Formulation comparison/diff view (covered in 08.7)
- Formulation costing (covered in 08.8)
- Handoff wizard (covered in 08.9)
- Export to PDF/Excel (covered in 08.10)

## Dependencies
- **08.1** - NPD Projects CRUD (required for npd_project_id foreign key and project selector)
- **02.1** - Products CRUD (required for product_id foreign key and product selector in formulation items)
- **01.1** - Org context + RLS (required for tenant isolation)

## Acceptance Criteria (Given/When/Then)

### AC-1: Formulation List Page

**Given** user navigates to `/npd/projects/:id/formulations`
**When** page loads
**Then** formulation list displays within 500ms for up to 100 formulations

**Given** formulation list displayed
**When** user searches "v1"
**Then** filtered results show only formulations containing "v1" in version number within 300ms

**Given** formulation list displayed
**When** user filters by status "Approved"
**Then** only Approved formulations appear

**Given** formulation list displayed
**When** user filters by date "Currently Effective"
**Then** only formulations where current date is between effective_from and effective_to (or dates are NULL) appear

**Given** formulation list has pagination
**When** page 2 clicked
**Then** next 20 formulations display

**Given** formulation table rendered
**When** viewing formulation row
**Then** shows: Version (v1.0), Status (badge), Eff. From (date or "-"), Eff. To (date or "-"), Items count (5), Total Qty (100 kg)

### AC-2: Create Formulation

**Given** user clicks "[+ Create Formulation]"
**When** page loads
**Then** create form displays with empty fields and version set to "v1.0"

**Given** user selects project "NPD-001"
**When** form updates
**Then** version auto-calculates to next available (v1.0 if first, v1.1 or v2.0 based on last version)

**Given** valid formulation data (project: NPD-001, version: v1.0, total_qty: 100, uom: kg)
**When** "[Save Formulation]" clicked
**Then** formulation created with status "draft" and redirects to formulation detail page

**Given** project already has formulation with effective_from=2024-01-01, effective_to=NULL (no end)
**When** user creates new formulation with effective_from=2024-06-01 (overlaps)
**Then** error "Date range overlaps with existing formulation v1.0 (2024-01-01 to ongoing)" displays

**Given** project has no existing formulations
**When** formulation created with status "approved"
**Then** formulation saved as approved (no overlap check needed)

**Given** effective_to date set before effective_from
**When** save attempted
**Then** error "Effective To must be after Effective From" displays inline

**Given** total_qty is 0 or negative
**When** save attempted
**Then** error "Total quantity must be greater than 0" displays inline

### AC-3: Edit Formulation

**Given** user clicks edit on existing formulation v1.0 (Draft)
**When** page loads
**Then** current formulation data pre-populates form with project field locked

**Given** user updates effective_to from NULL to "2024-12-31"
**When** save completes
**Then** updated date displays in list

**Given** user attempts to change npd_project_id on existing formulation
**Then** project field is disabled with tooltip "Project cannot be changed after formulation creation"

**Given** formulation is Draft and user changes status to "Approved"
**When** save completes
**Then** formulation status updates and info toast "Formulation approved - ready for lock" displays

**Given** formulation is Locked
**When** edit attempted
**Then** error "Cannot edit locked formulation" displays and form is disabled

### AC-4: Date Overlap Prevention

**Given** project NPD-001 has formulation v1.0 (2024-01-01 to 2024-06-30) and formulation v1.1 (2024-07-01 to NULL)
**When** user creates formulation v2.0 with effective_from=2024-04-01
**Then** error "Date range overlaps with formulation v1.0"

**Given** project NPD-001 has formulation v1.0 (2024-01-01 to 2024-06-30)
**When** user creates formulation v1.1 with effective_from=2024-07-01
**Then** formulation v1.1 created successfully (no overlap)

**Given** user creates formulation with effective_to=NULL
**When** another formulation exists with effective_to=NULL for same project
**Then** error "Only one formulation can have no end date per project"

### AC-5: Version Control & Lineage

**Given** project NPD-001 has formulations v1.0, v1.1
**When** user creates new formulation
**Then** version auto-suggests v1.2 (minor) or v2.0 (major) based on user selection

**Given** formulation list for project NPD-001
**When** viewing version column
**Then** versions display chronologically (v1.0, v1.1, v2.0) with newest at top by created_at

**Given** formulation detail page
**When** viewing header
**Then** shows "Formulation v1.1 - Project NPD-001" with status badge

**Given** user creates v1.1 from v1.0
**When** formulation saved
**Then** parent_formulation_id is set to v1.0 ID (lineage tracked)

**Given** formulation detail page shows lineage tree
**When** user clicks parent version link
**Then** navigates to parent formulation detail page

### AC-6: Lock Formulation on Approval

**Given** formulation v1.0 status is "Draft"
**When** user changes status to "Approved"
**Then** formulation can still be edited

**Given** formulation v1.0 status is "Approved"
**When** user clicks "[Lock Formulation]"
**Then** status changes to "Locked" and form becomes read-only

**Given** formulation v1.0 status is "Locked"
**When** user attempts to edit
**Then** error "Locked formulation cannot be edited" displays

**Given** formulation v1.0 status is "Locked"
**When** user attempts to delete
**Then** error "Cannot delete locked formulation" displays

### AC-7: Formulation Items Auto-Calculate Percentages

**Given** formulation total_qty = 100 kg
**When** user adds item: Flour, 50 kg
**Then** percentage auto-calculates to 50%

**Given** formulation total_qty = 100 kg with items: Flour 50 kg, Sugar 30 kg, Water 20 kg
**When** viewing items table
**Then** percentages display: Flour 50%, Sugar 30%, Water 20%

**Given** formulation total_qty changes from 100 kg to 200 kg
**When** items exist
**Then** percentages recalculate (Flour 50 kg becomes 25%)

### AC-8: Version Timeline Visualization

**Given** user clicks "[View Timeline]" or "[Timeline]" icon on formulation list row
**When** timeline modal/panel opens
**Then** all formulation versions for that project display on a horizontal timeline

**Given** timeline displayed
**When** viewing timeline bars
**Then** each version shows: version number (v1.0, v1.1, v2.0), effective date range, status (color-coded), and is clickable

**Given** timeline displayed for project with 3 versions
**When** user hovers over version bar
**Then** tooltip shows: version, status, effective dates, total qty, notes preview

**Given** timeline displayed
**When** user clicks on a version bar
**Then** navigates to that formulation detail page

**Given** project has overlapping draft formulations
**When** timeline renders
**Then** overlapping regions are highlighted with warning color

**Given** timeline displayed
**When** current date is within a version's effective range
**Then** that version is highlighted as "Currently Active"

**Given** timeline displayed
**When** versions have gaps between effective dates
**Then** gaps are visually indicated (no coverage period)

### AC-9: Delete Formulation

**Given** user clicks delete on formulation v1.0 (Draft)
**When** confirmation dialog accepted
**Then** formulation deleted and removed from list (including all formulation items)

**Given** formulation v1.0 is status "Locked"
**When** delete attempted
**Then** error "Cannot delete locked formulation"

**Given** formulation v1.0 is referenced by BOM (after handoff)
**When** delete attempted
**Then** error "Cannot delete formulation used in BOM handoff: BOM-001"

**Given** user clicks delete on formulation
**Then** confirmation dialog shows "Delete Formulation v1.0? This will also delete all formulation items. This action cannot be undone."

### AC-10: Permission Enforcement

**Given** user has role VIEWER (read-only)
**When** `/npd/projects/:id/formulations` loaded
**Then** "[+ Create Formulation]" button hidden, edit/delete actions hidden

**Given** user has role R&D
**When** `/npd/projects/:id/formulations` loaded
**Then** create/edit actions available for assigned projects

**Given** user has role NPD_LEAD
**When** delete action clicked
**Then** delete proceeds (NPD Lead can delete draft formulations)

## Implementation Notes

### API Endpoints

```typescript
// GET /api/npd/formulations
// Query params: page, limit, search, npd_project_id, status, effective_date, sortBy, sortOrder
interface FormulationsListResponse {
  formulations: FormulationWithProject[];
  total: number;
  page: number;
  limit: number;
}

interface FormulationWithProject {
  id: number;
  org_id: string;
  npd_project_id: number;
  project: {
    id: number;
    project_number: string;
    project_name: string;
    current_gate: string;
  };
  formulation_number: string; // v1.0, v1.1, v2.0
  status: 'draft' | 'approved' | 'locked';
  effective_from: string | null; // ISO date
  effective_to: string | null;
  parent_formulation_id: number | null;
  total_qty: number;
  uom: string;
  notes: string | null;
  approved_by: string | null;
  approved_at: string | null;
  created_at: string;
  updated_at: string;
  items_count: number; // calculated
}

// POST /api/npd/formulations
interface CreateFormulationRequest {
  npd_project_id: number;
  formulation_number: string; // v1.0, v1.1, v2.0
  effective_from?: string | null; // ISO date, optional
  effective_to?: string | null; // ISO date, optional
  status?: 'draft' | 'approved'; // default: 'draft'
  total_qty: number; // required, > 0
  uom: string; // required
  parent_formulation_id?: number | null; // optional, for lineage
  notes?: string;
}

// PUT /api/npd/formulations/:id
interface UpdateFormulationRequest {
  formulation_number?: string;
  effective_from?: string | null;
  effective_to?: string | null;
  status?: 'draft' | 'approved' | 'locked';
  total_qty?: number;
  uom?: string;
  notes?: string;
}

// DELETE /api/npd/formulations/:id
// Returns 400 if formulation is locked or used in BOM handoff

// POST /api/npd/formulations/:id/lock
// Sets status to 'locked', makes immutable

// GET /api/npd/formulations/:id/lineage
interface FormulationLineageResponse {
  current: FormulationWithProject;
  parent: FormulationWithProject | null;
  children: FormulationWithProject[];
}

// GET /api/npd/formulations/timeline/:projectId
interface FormulationTimelineResponse {
  project: {
    id: number;
    project_number: string;
    project_name: string;
  };
  versions: FormulationTimelineVersion[];
  current_date: string;
}

interface FormulationTimelineVersion {
  id: number;
  formulation_number: string; // v1.0
  status: 'draft' | 'approved' | 'locked';
  effective_from: string | null;
  effective_to: string | null;
  total_qty: number;
  uom: string;
  notes: string | null;
  is_currently_active: boolean;
  has_overlap: boolean;
}
```

### Database

```sql
-- npd_formulations table (existing in PRD)
CREATE TABLE npd_formulations (
    id SERIAL PRIMARY KEY,
    org_id UUID NOT NULL REFERENCES organizations(id),
    npd_project_id INTEGER NOT NULL REFERENCES npd_projects(id),
    formulation_number VARCHAR(20) NOT NULL, -- v1.0, v1.1, v2.0
    status VARCHAR(20) NOT NULL DEFAULT 'draft' CHECK (status IN ('draft', 'approved', 'locked')),
    effective_from DATE,
    effective_to DATE,
    parent_formulation_id INTEGER REFERENCES npd_formulations(id),
    total_qty DECIMAL(15,4) NOT NULL CHECK (total_qty > 0),
    uom VARCHAR(20) NOT NULL,
    notes TEXT,
    approved_by UUID REFERENCES users(id),
    approved_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    created_by UUID REFERENCES users(id),
    updated_by UUID REFERENCES users(id),
    UNIQUE(npd_project_id, formulation_number)
);

-- npd_formulation_items table (existing in PRD)
CREATE TABLE npd_formulation_items (
    id SERIAL PRIMARY KEY,
    formulation_id INTEGER NOT NULL REFERENCES npd_formulations(id) ON DELETE CASCADE,
    product_id UUID NOT NULL REFERENCES products(id),
    quantity DECIMAL(15,4) NOT NULL CHECK (quantity > 0),
    uom VARCHAR(20) NOT NULL,
    percentage DECIMAL(5,2), -- auto-calculated
    notes TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Date overlap prevention trigger
CREATE OR REPLACE FUNCTION check_formulation_date_overlap()
RETURNS TRIGGER AS $$
BEGIN
  -- Allow NULL dates (no overlap check)
  IF NEW.effective_from IS NULL AND NEW.effective_to IS NULL THEN
    RETURN NEW;
  END IF;

  IF EXISTS (
    SELECT 1 FROM npd_formulations
    WHERE org_id = NEW.org_id
      AND npd_project_id = NEW.npd_project_id
      AND id != COALESCE(NEW.id, 0)
      AND (
        (NEW.effective_from IS NOT NULL AND NEW.effective_to IS NOT NULL
         AND effective_from IS NOT NULL AND effective_to IS NOT NULL
         AND daterange(effective_from, effective_to, '[]') &&
             daterange(NEW.effective_from, NEW.effective_to, '[]'))
        OR
        (NEW.effective_to IS NULL AND effective_to IS NULL)
      )
  ) THEN
    RAISE EXCEPTION 'Date range overlaps with existing formulation for this project';
  END IF;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_check_formulation_date_overlap
BEFORE INSERT OR UPDATE ON npd_formulations
FOR EACH ROW EXECUTE FUNCTION check_formulation_date_overlap();

-- Auto-calculate percentage trigger
CREATE OR REPLACE FUNCTION auto_calculate_formulation_item_percentage()
RETURNS TRIGGER AS $$
DECLARE
  v_total_qty DECIMAL(15,4);
BEGIN
  SELECT total_qty INTO v_total_qty
  FROM npd_formulations
  WHERE id = NEW.formulation_id;

  IF v_total_qty > 0 THEN
    NEW.percentage := (NEW.quantity / v_total_qty) * 100;
  ELSE
    NEW.percentage := 0;
  END IF;

  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_auto_calculate_percentage
BEFORE INSERT OR UPDATE ON npd_formulation_items
FOR EACH ROW EXECUTE FUNCTION auto_calculate_formulation_item_percentage();

-- Prevent edit/delete on locked formulations
CREATE OR REPLACE FUNCTION prevent_locked_formulation_changes()
RETURNS TRIGGER AS $$
BEGIN
  IF OLD.status = 'locked' THEN
    RAISE EXCEPTION 'Cannot modify locked formulation';
  END IF;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_prevent_locked_formulation_update
BEFORE UPDATE ON npd_formulations
FOR EACH ROW EXECUTE FUNCTION prevent_locked_formulation_changes();

CREATE TRIGGER trg_prevent_locked_formulation_delete
BEFORE DELETE ON npd_formulations
FOR EACH ROW EXECUTE FUNCTION prevent_locked_formulation_changes();
```

### Frontend Components

```
app/(authenticated)/npd/projects/[id]/formulations/page.tsx       -- Formulation list page
app/(authenticated)/npd/formulations/new/page.tsx                 -- Create formulation page
app/(authenticated)/npd/formulations/[id]/page.tsx                -- Formulation detail page
app/(authenticated)/npd/formulations/[id]/edit/page.tsx           -- Edit formulation page

components/npd/formulation/
  FormulationsDataTable.tsx      -- Table with sorting, filtering, pagination
  FormulationHeaderForm.tsx      -- Reusable form for formulation header fields
  FormulationItemsTable.tsx      -- Items table with auto-calculated percentages
  ProjectSelector.tsx            -- Combobox for project search/select
  FormulationStatusBadge.tsx     -- Status indicator (draft/approved/locked)
  DeleteFormulationDialog.tsx    -- Confirmation dialog
  LockFormulationDialog.tsx      -- Lock confirmation dialog
  FormulationVersionTimeline.tsx -- Timeline visualization
  FormulationTimelineModal.tsx   -- Modal wrapper for timeline
  FormulationTimelineBar.tsx     -- Individual version bar
  FormulationLineageTree.tsx     -- Parent/child lineage visualization
```

### Services

```typescript
// lib/services/formulation-service.ts
export async function listFormulations(filters): Promise<FormulationsListResponse>
export async function getFormulation(id: number): Promise<FormulationWithProject>
export async function createFormulation(data: CreateFormulationRequest): Promise<Formulation>
export async function updateFormulation(id: number, data: UpdateFormulationRequest): Promise<Formulation>
export async function deleteFormulation(id: number): Promise<void>
export async function lockFormulation(id: number): Promise<Formulation>
export async function getNextVersion(projectId: number): Promise<string>
export async function checkDateOverlap(projectId: number, from: string | null, to: string | null, excludeId?: number): Promise<boolean>
export async function getFormulationTimeline(projectId: number): Promise<FormulationTimelineResponse>
export async function getFormulationLineage(id: number): Promise<FormulationLineageResponse>
```

### Validation (Zod)

```typescript
const createFormulationSchema = z.object({
  npd_project_id: z.number().int().positive("Invalid project ID"),
  formulation_number: z.string().regex(/^v\d+\.\d+$/, "Version must be in format v1.0, v1.1, etc."),
  effective_from: z.string().refine((val) => !val || !isNaN(Date.parse(val)), "Invalid date").nullable().optional(),
  effective_to: z.string().refine((val) => !val || !isNaN(Date.parse(val)), "Invalid date").nullable().optional(),
  status: z.enum(['draft', 'approved']).default('draft'),
  total_qty: z.number().positive("Total quantity must be greater than 0").max(999999999, "Total quantity too large"),
  uom: z.string().min(1, "Unit of measure is required").max(20),
  parent_formulation_id: z.number().int().positive().nullable().optional(),
  notes: z.string().max(2000).optional(),
}).refine((data) => {
  if (data.effective_to && data.effective_from) {
    return new Date(data.effective_to) >= new Date(data.effective_from);
  }
  return true;
}, {
  message: "Effective To must be after Effective From",
  path: ["effective_to"],
});

const updateFormulationSchema = createFormulationSchema.partial().omit({ npd_project_id: true });

const lockFormulationSchema = z.object({
  confirmation: z.literal(true, { errorMap: () => ({ message: "Please confirm lock action" }) })
});
```

## Deliverables

- Database migration for npd_formulations, npd_formulation_items tables + triggers
- API routes for formulation CRUD operations
- API route for formulation lock: POST /api/npd/formulations/:id/lock
- API route for formulation lineage: GET /api/npd/formulations/:id/lineage
- API route for formulation timeline: GET /api/npd/formulations/timeline/:projectId
- Formulations list page with DataTable, search, filters
- Create formulation page with validation
- Edit formulation page with project field locked
- Date overlap prevention (server-side validation + database trigger)
- Version numbering logic (v1.0, v1.1, v2.0)
- Lineage tracking (parent_formulation_id)
- Lock formulation functionality
- Auto-calculate percentages (database trigger)
- Delete with locked status check
- Permission-based UI rendering
- FormulationVersionTimeline component
- FormulationTimelineModal component
- FormulationLineageTree component
- Zod validation schemas
- Integration tests for API endpoints
- Unit tests for formulation-service

## Definition of Done

- [ ] Formulation list page loads within 500ms for 100 formulations
- [ ] Create formulation with auto-versioning works end-to-end
- [ ] Edit formulation updates immediately in UI (project field locked)
- [ ] Date overlap prevented by database trigger with clear error message
- [ ] Delete blocked if formulation is locked
- [ ] Status badge displays correct colors (Draft/Approved/Locked)
- [ ] Filters work: status, date range, search
- [ ] Version numbers display correctly (v1.0, v1.1, v2.0)
- [ ] Lineage tracked via parent_formulation_id
- [ ] Lock formulation makes it immutable (edit/delete blocked)
- [ ] Percentages auto-calculate on item quantity change
- [ ] Version timeline displays all versions with correct date ranges
- [ ] Timeline highlights currently active version
- [ ] Timeline shows overlap warnings visually
- [ ] Timeline bars are clickable and navigate to formulation detail
- [ ] Timeline tooltip shows version details on hover
- [ ] Lineage tree shows parent/child relationships
- [ ] Permission checks hide unauthorized actions (create/edit/delete)
- [ ] All API endpoints have integration tests
- [ ] Unit tests cover formulation-service (>80% coverage)
- [ ] Zod schemas validate all input fields
- [ ] Empty state shows "Create Your First Formulation" CTA
- [ ] Error states display clear messages with retry option

---

## Future Phases (Not in MVP)

### Phase 2
- **Allergen aggregation** (08.5) - Auto-aggregate allergens from formulation items
- **Clone formulation** (08.6) - Copy formulation to new version
- **Comparison view** (08.7) - Side-by-side version comparison
- **Costing integration** (08.8) - Calculate formulation cost
- **Handoff wizard** (08.9) - Transfer formulation to BOM
- **Export to PDF/Excel** (08.10) - Export formulation data

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2026-01-15 | Initial version - Formulations CRUD & Versioning | ARCHITECT-AGENT |
