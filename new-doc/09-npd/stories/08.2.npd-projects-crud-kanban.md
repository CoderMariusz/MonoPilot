# 08.2 - NPD Projects CRUD & Kanban Dashboard

**Priority**: P1 (Phase 1 MVP)
**Story Points**: L (Large)
**Type**: fullstack
**Phase**: 1 (Core NPD)
**Model**: OPUS

**State:** ready
**Estimate:** L (4-5 days)
**Primary PRD:** `docs/1-BASELINE/product/modules/npd.md` (FR-NPD-01, 02, 04, 05, Section 2)
**Architecture:** `docs/1-BASELINE/architecture/modules/npd.md` (npd_projects table)

---

## Goal

Implement the NPD Projects CRUD functionality with Stage-Gate workflow and Kanban dashboard. This enables NPD teams to create, manage, and track product innovation projects from idea (G0) through launch, providing visual pipeline management and filtering capabilities.

---

## Premium Module Notice

NPD is a **premium add-on** module for Growth/Enterprise tiers.

**Module Activation:**
- Feature flag: `org_settings.enabled_modules` includes `'npd'`
- Per-organization activation
- Free tier: Module disabled, navigation hidden
- Growth/Enterprise: Module available after activation

**Key Value Propositions:**
- Stage-Gate methodology for structured innovation
- Full traceability from concept to production
- Integration with Production module (handoff to BOM/WO)
- R&D consultancy mode (NPD-only, no production)

---

## MVP Scope

This story implements Phase 1 (Core NPD) functionality. NPD Projects are the foundation for all other NPD features.

**MVP Includes**:
- `npd_projects` table with Stage-Gate workflow
- `npd_project_number_sequences` table for auto-generated numbers
- Project number auto-generation: NPD-YYYY-NNNNN
- Stage-Gate workflow: G0 → G1 → G2 → G3 → G4 → Launched
- Project status: idea, feasibility, business_case, development, testing, launched, cancelled
- Priority levels: low, medium, high
- Owner assignment (NPD Lead)
- Target launch date tracking
- **Kanban dashboard** with drag-and-drop gate advancement
- Kanban columns per gate (G0, G1, G2, G3, G4, Launched)
- Filter by category, priority, owner, status
- Project list view (DataTable pattern)
- Project detail page
- Create/Edit project forms
- Archive/Cancel project workflow

**Deferred to Phase 1+**: See "Future Phases" section below.

---

## Future Phases (Not in MVP)

### Phase 1+ (Story 08.2b - Advanced Projects)
- **Timeline view** - Horizontal bars showing project duration
- **Gantt chart** - Dependency visualization
- **Portfolio categories** - Custom taxonomy management
- **Project cloning** - Duplicate projects with variations
- **Bulk operations** - Multi-select for archive/reassign
- **Export to CSV/PDF** - Project list export

### Phase 2
- **Project templates** - Pre-configured gate checklists
- **Resource allocation** - Team member workload tracking
- **Gate approval workflow** - Formal approval routing
- **Approval history** - Gate decision audit trail
- **Dashboard analytics** - Gate velocity, success rates

### Phase 3
- **Project budget tracking** - Cost vs target throughout gates
- **Milestone tracking** - Key dates beyond launch
- **Notifications** - Gate approval reminders, overdue alerts
- **Integration with external tools** - Slack, Jira, Trello

### Deferred to Other Stories
- **Formulations** - Story 08.3 (Formulations CRUD)
- **Gate checklists** - Story 08.4 (Gate Checklists)
- **Costing** - Story 08.5 (NPD Costing)
- **Compliance documents** - Story 08.6 (Document Management)
- **Handoff wizard** - Story 08.7 (Handoff to Production)
- **Event sourcing** - Story 08.8 (NPD Events)

---

## User Story

As an **NPD Lead**, I want to **create and manage NPD projects through a Kanban dashboard, tracking progress from idea to launch** so that **I can visualize our innovation pipeline and ensure projects advance through Stage-Gate milestones**.

As an **R&D Manager**, I want to **filter projects by category, priority, and owner** so that **I can focus on specific product lines or team members**.

As an **Executive**, I want to **see a high-level view of all NPD projects by gate** so that **I can understand our innovation portfolio health**.

---

## Scope

**In scope (this story)**
- `npd_projects` table with all Stage-Gate fields
- `npd_project_number_sequences` table
- Project number generation: NPD-YYYY-NNNNN
- GET /api/npd/projects (list with filters)
- GET /api/npd/projects/:id (project detail)
- POST /api/npd/projects (create project)
- PUT /api/npd/projects/:id (update project)
- POST /api/npd/projects/:id/advance-gate (move to next gate)
- DELETE /api/npd/projects/:id (archive project)
- Kanban dashboard with drag-and-drop
- Filter by category, priority, owner, status
- Project list view (DataTable)
- Project detail page
- Create/Edit project modals
- Archive/Cancel confirmation
- Gate advancement modal with validation

**Out of scope (this story)**
- Formulation management (story 08.3)
- Gate checklists (story 08.4)
- Costing (story 08.5)
- Compliance documents (story 08.6)
- Handoff wizard (story 08.7)
- Timeline/Gantt view (Phase 1+)
- Approval workflow (Phase 2)
- Budget tracking (Phase 3)

---

## Dependencies

### Cross-Epic Dependencies

| Dependency | Story/Epic | Type | What It Provides | Status |
|------------|------------|------|------------------|--------|
| 01.1 | Org Context + RLS | HARD | organizations, users, roles tables | Ready |
| 01.0 | Settings Module | HARD | org_settings.enabled_modules for NPD feature flag | Ready |

### Within Epic Dependencies

| Dependency | Story | Type | What It Provides |
|------------|-------|------|------------------|
| 08.1 | NPD Settings | HARD | npd_settings table for module configuration | Blocked (create 08.1 first) |

### Provides To (Downstream)

| Story | What This Provides |
|-------|-------------------|
| 08.3 | Formulations CRUD - npd_project_id reference |
| 08.4 | Gate Checklists - npd_project_id, current_gate |
| 08.5 | NPD Costing - npd_project_id reference |
| 08.6 | Document Management - npd_project_id reference |
| 08.7 | Handoff Wizard - project validation, status update |
| 08.8 | NPD Events - project entity tracking |

---

## Database Migration

### Migration: Create npd_projects table

```sql
-- Migration: YYYYMMDDHHMMSS_create_npd_projects.sql

CREATE TABLE npd_projects (
    -- Identity
    id                      UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id                  UUID NOT NULL REFERENCES organizations(id),
    project_number          TEXT NOT NULL,

    -- Basic Info
    project_name            TEXT NOT NULL,
    description             TEXT,
    portfolio_category      TEXT,

    -- Stage-Gate Workflow
    current_gate            TEXT NOT NULL DEFAULT 'G0'
                            CHECK (current_gate IN ('G0', 'G1', 'G2', 'G3', 'G4', 'Launched')),

    -- Status
    status                  TEXT NOT NULL DEFAULT 'idea'
                            CHECK (status IN ('idea', 'feasibility', 'business_case', 'development', 'testing', 'launched', 'cancelled')),

    -- Priority
    priority                TEXT DEFAULT 'medium'
                            CHECK (priority IN ('low', 'medium', 'high')),

    -- Ownership
    owner_id                UUID REFERENCES users(id),

    -- Timeline
    target_launch_date      DATE,
    actual_launch_date      DATE,

    -- Audit
    created_at              TIMESTAMPTZ NOT NULL DEFAULT now(),
    created_by              UUID REFERENCES users(id),
    updated_at              TIMESTAMPTZ NOT NULL DEFAULT now(),
    updated_by              UUID REFERENCES users(id),

    -- Constraints
    CONSTRAINT uq_project_number UNIQUE (org_id, project_number)
);

-- =============================================================================
-- Indexes for Performance
-- =============================================================================

CREATE INDEX idx_npd_projects_org_status ON npd_projects(org_id, status);
CREATE INDEX idx_npd_projects_org_gate ON npd_projects(org_id, current_gate);
CREATE INDEX idx_npd_projects_gate_status ON npd_projects(org_id, current_gate, status);
CREATE INDEX idx_npd_projects_owner ON npd_projects(owner_id) WHERE owner_id IS NOT NULL;
CREATE INDEX idx_npd_projects_category ON npd_projects(org_id, portfolio_category) WHERE portfolio_category IS NOT NULL;
CREATE INDEX idx_npd_projects_priority ON npd_projects(org_id, priority);
CREATE INDEX idx_npd_projects_target_date ON npd_projects(org_id, target_launch_date) WHERE target_launch_date IS NOT NULL;
CREATE INDEX idx_npd_projects_created ON npd_projects(org_id, created_at);

-- =============================================================================
-- Project Number Sequence
-- =============================================================================

CREATE TABLE npd_project_number_sequences (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    year INTEGER NOT NULL,
    current_value BIGINT NOT NULL DEFAULT 0,
    updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
    UNIQUE(org_id, year)
);

-- Function to generate project number (NPD-YYYY-NNNNN)
CREATE OR REPLACE FUNCTION generate_npd_project_number(p_org_id UUID)
RETURNS TEXT AS $$
DECLARE
    v_year INTEGER;
    v_next_val BIGINT;
    v_project_number TEXT;
BEGIN
    v_year := EXTRACT(YEAR FROM CURRENT_DATE);

    -- Upsert sequence and get next value
    INSERT INTO npd_project_number_sequences (org_id, year, current_value)
    VALUES (p_org_id, v_year, 1)
    ON CONFLICT (org_id, year)
    DO UPDATE SET
        current_value = npd_project_number_sequences.current_value + 1,
        updated_at = NOW()
    RETURNING current_value INTO v_next_val;

    -- Format project number
    v_project_number := 'NPD-' || v_year::TEXT || '-' || LPAD(v_next_val::TEXT, 5, '0');

    RETURN v_project_number;
END;
$$ LANGUAGE plpgsql;

-- =============================================================================
-- RLS Policies
-- =============================================================================

ALTER TABLE npd_projects ENABLE ROW LEVEL SECURITY;

CREATE POLICY "npd_projects_select" ON npd_projects
    FOR SELECT USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

CREATE POLICY "npd_projects_insert" ON npd_projects
    FOR INSERT WITH CHECK (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

CREATE POLICY "npd_projects_update" ON npd_projects
    FOR UPDATE USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

-- Only allow delete of cancelled/idea projects
CREATE POLICY "npd_projects_delete" ON npd_projects
    FOR DELETE USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
        AND status IN ('cancelled', 'idea')
    );

ALTER TABLE npd_project_number_sequences ENABLE ROW LEVEL SECURITY;

CREATE POLICY "npd_seq_org" ON npd_project_number_sequences
    FOR ALL TO authenticated
    USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

-- =============================================================================
-- Trigger for updated_at
-- =============================================================================

CREATE TRIGGER update_npd_projects_updated_at
    BEFORE UPDATE ON npd_projects
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();
```

---

## Acceptance Criteria (Given/When/Then)

### AC-1: Project Table Creation

```gherkin
Scenario: npd_projects table exists with all required columns
  Given database migration runs
  When schema is inspected
  Then npd_projects table has all columns from schema
  And UNIQUE constraint exists on (org_id, project_number)
  And FK constraints exist for org_id, owner_id
  And RLS policies enforce org isolation
```

### AC-2: Project Number Auto-Generation

```gherkin
Scenario: Generate project number with year-based format
  Given organization exists
  When NPD project created
  Then project_number format is 'NPD-2025-00001'
  And next project gets 'NPD-2025-00002'
  And year resets sequence (first 2026 = 'NPD-2026-00001')

Scenario: Project number uniqueness
  Given project 'NPD-2025-00001' exists in org A
  When creating another with same number in org A
  Then system returns 409 Conflict error
```

### AC-3: Create NPD Project

```gherkin
Scenario: Create project with required fields
  Given user navigates to NPD dashboard
  And clicks [+ New Project]
  When user enters:
    | Field | Value |
    | Project Name | Premium Vegan Burger |
    | Portfolio Category | Vegan Line |
    | Priority | High |
    | Owner | John Doe (NPD Lead) |
    | Target Launch | 2025-06-30 |
  And clicks [Create]
  Then project created with status = 'idea'
  And current_gate = 'G0'
  And project_number auto-generated
  And success toast "Project NPD-2025-00001 created"

Scenario: Create project with minimal fields
  Given user provides only project_name
  When creating project
  Then project created with defaults:
    | Field | Default |
    | current_gate | G0 |
    | status | idea |
    | priority | medium |
    | owner_id | current user |

Scenario: Validation - Project name required
  Given user creates project without project_name
  When submitting
  Then error "Project name is required"
```

### AC-4: Kanban Dashboard Display

```gherkin
Scenario: Kanban dashboard loads
  Given user navigates to NPD > Dashboard
  When page loads
  Then Kanban board displays with 6 columns:
    | Column | Gate |
    | Ideas | G0 |
    | Feasibility | G1 |
    | Business Case | G2 |
    | Development | G3 |
    | Testing | G4 |
    | Launched | Launched |
  And each project card shows:
    | Field | Display |
    | Project Number | Link to detail |
    | Project Name | Title |
    | Priority | Badge (high=red, medium=orange, low=gray) |
    | Owner | Avatar + name |
    | Target Date | Formatted date or "No target" |
    | Category | Tag |
  And cards sorted by priority DESC, then created_at DESC

Scenario: Empty state
  Given no projects exist
  When viewing Kanban
  Then each column shows "No projects in this gate"
  And [+ New Project] button visible
```

### AC-5: Drag-and-Drop Gate Advancement

```gherkin
Scenario: Drag project to next gate
  Given project in G0 column with status = 'idea'
  When user drags project to G1 column
  Then confirmation modal appears:
    | Message | "Advance project to G1 (Feasibility)?" |
    | Current Gate | G0 |
    | New Gate | G1 |
    | Warning | "This will update status to 'feasibility'" |
  And user clicks [Confirm]
  Then current_gate = 'G1'
  And status = 'feasibility'
  And project moves to G1 column
  And success toast "Project advanced to G1"

Scenario: Drag to non-adjacent gate blocked
  Given project in G0
  When user drags to G3 (skipping G1, G2)
  Then error "Cannot skip gates. Advance sequentially."
  And card returns to G0 column

Scenario: Drag backwards allowed with warning
  Given project in G2
  When user drags to G1
  Then warning modal "Move project back to G1? This is unusual."
  And user can confirm or cancel
```

### AC-6: Filter Projects

```gherkin
Scenario: Filter by category
  Given projects with various categories
  When user selects category = 'Vegan Line'
  Then only projects with portfolio_category = 'Vegan Line' display
  And URL updates with filter state

Scenario: Filter by priority
  Given projects with mixed priorities
  When user selects priority = 'high'
  Then only high priority projects display

Scenario: Filter by owner
  Given projects assigned to different owners
  When user selects owner = 'John Doe'
  Then only projects where owner_id = John Doe's ID display

Scenario: Filter by status
  Given projects with various statuses
  When user selects status = 'development'
  Then only projects with status = 'development' display

Scenario: Multiple filters
  Given user applies category = 'Vegan Line' AND priority = 'high'
  Then only projects matching both filters display
  And filter count badge shows "2 filters"

Scenario: Clear filters
  Given filters applied
  When user clicks [Clear Filters]
  Then all projects display
  And URL filter params removed
```

### AC-7: Search Projects

```gherkin
Scenario: Search by project name or number
  Given projects exist
  When user searches "Burger" or "NPD-2025-00001"
  Then matching projects display
  And search debounced (300ms)
  And search case-insensitive
```

### AC-8: Project List View

```gherkin
Scenario: Switch to list view
  Given user viewing Kanban
  When user clicks [List View] toggle
  Then DataTable displays with columns:
    | Column | Description |
    | Project # | Link to detail |
    | Name | Project name |
    | Category | Portfolio category |
    | Gate | Current gate badge |
    | Status | Status badge |
    | Priority | Priority badge |
    | Owner | Owner name |
    | Target Date | Formatted date |
    | Created | Created date |
  And pagination available (20 per page)
  And sort by any column

Scenario: List view persistence
  Given user switches to list view
  When navigating away and returning
  Then list view still active (localStorage)
```

### AC-9: Project Detail Page

```gherkin
Scenario: View project detail
  Given project NPD-2025-00001 exists
  When user clicks project card or row
  Then navigates to /npd/projects/NPD-2025-00001
  And page displays:
    | Section | Content |
    | Header | Project #, Name, Status badge, Priority badge |
    | Overview | Description, Category, Owner, Dates |
    | Gate | Current gate with progress indicator |
    | Actions | Based on status and permissions |
    | Tabs | Overview, Formulations (08.3), Checklists (08.4), Costing (08.5), Documents (08.6) |
  And [Edit], [Advance Gate], [Archive] buttons visible (if permitted)

Scenario: Empty tabs message
  Given project has no formulations yet
  When viewing Formulations tab
  Then "No formulations created. Click [+ New Formulation] to begin."
```

### AC-10: Edit Project

```gherkin
Scenario: Update project fields
  Given user views project detail
  And clicks [Edit]
  Then modal shows form with current values
  And user updates:
    | Field | New Value |
    | Project Name | Super Premium Vegan Burger |
    | Priority | High → Medium |
    | Target Date | 2025-06-30 → 2025-07-15 |
  And clicks [Save]
  Then project updated
  And success toast "Project updated"
  And modal closes

Scenario: Edit validation
  Given user edits project
  When clearing project_name
  Then error "Project name is required"
  And cannot save

Scenario: Cannot edit launched project
  Given project with status = 'launched'
  When viewing detail
  Then [Edit] button disabled
  And tooltip "Cannot edit launched projects"
```

### AC-11: Advance Gate Manually

```gherkin
Scenario: Advance gate via button
  Given project in G0
  And user clicks [Advance to G1]
  Then confirmation modal appears
  And user confirms
  Then current_gate = 'G1'
  And status updated to match gate (idea → feasibility)
  And success toast "Project advanced to G1"

Scenario: Advance gate validation (Phase 1+ - skip for MVP)
  Given gate checklists feature enabled (story 08.4)
  When attempting to advance gate
  Then system validates required checklist items complete
  And blocks if incomplete
```

### AC-12: Cancel/Archive Project

```gherkin
Scenario: Cancel project
  Given project in any gate
  And user clicks [Cancel Project]
  Then confirmation modal "Cancel project? This cannot be undone."
  And user provides cancellation reason
  And clicks [Confirm]
  Then status = 'cancelled'
  And project moved to Cancelled section or hidden
  And audit log records cancellation

Scenario: Archive completed project
  Given project with status = 'launched'
  When user clicks [Archive]
  Then project hidden from active views
  And accessible via "Show Archived" filter

Scenario: Delete idea project
  Given project with status = 'idea' (G0)
  When user clicks [Delete]
  Then hard delete allowed (RLS policy)
  And project removed from database
```

### AC-13: Permission Enforcement

```gherkin
Scenario: NPD Lead has full access
  Given user with NPD_LEAD role
  When viewing NPD dashboard
  Then can create, edit, delete, advance projects
  And can assign projects to self or others

Scenario: R&D can view assigned projects
  Given user with R&D role
  When viewing NPD dashboard
  Then sees only projects where owner_id = self
  And can view but not edit/delete

Scenario: Viewer cannot create
  Given user with VIEWER role
  When viewing NPD dashboard
  Then [+ New Project] button hidden
  And can view projects but no actions

Scenario: Production role cannot access NPD
  Given user with PRODUCTION_MANAGER role
  And org has NPD module enabled
  When accessing /npd/projects
  Then 403 Forbidden (NPD-specific roles required)
```

### AC-14: Gate-Status Mapping

```gherkin
Scenario: Status updates with gate advancement
  Given gate-status mapping:
    | Gate | Status |
    | G0 | idea |
    | G1 | feasibility |
    | G2 | business_case |
    | G3 | development |
    | G4 | testing |
    | Launched | launched |
  When project advances from G0 to G1
  Then status changes from 'idea' to 'feasibility'

Scenario: Manual status override
  Given project in G2 with status = 'business_case'
  When user edits status to 'development'
  Then warning "Status 'development' typically matches G3. Continue?"
  And user can confirm or cancel
```

### AC-15: RLS Policy Enforcement

```gherkin
Scenario: Org isolation on project list
  Given User A from Org A and User B from Org B
  And projects exist in both orgs
  When User A requests GET /api/npd/projects
  Then only Org A projects returned

Scenario: Cannot view project from different org
  Given project belongs to Org B
  When User A (Org A) requests GET /api/npd/projects/:id
  Then 404 Not Found returned

Scenario: Project inherits org_id from user
  Given User A from Org A creates project
  Then project.org_id = Org A (automatic)
```

### AC-16: Performance Requirements

```gherkin
Scenario: Kanban dashboard performance
  Given 50 projects in organization
  When loading Kanban dashboard
  Then response time < 500ms
  And columns render progressively

Scenario: Project list performance
  Given 200 projects in organization
  When listing with pagination
  Then response time < 500ms

Scenario: Project detail performance
  Given project with related data
  When loading detail page
  Then response time < 300ms
```

---

## Implementation Notes

### API Endpoints

```typescript
// =============================================================================
// NPD Projects Endpoints
// =============================================================================

// GET /api/npd/projects
// List projects with filters
interface ProjectsListParams {
  current_gate?: 'G0' | 'G1' | 'G2' | 'G3' | 'G4' | 'Launched';
  status?: 'idea' | 'feasibility' | 'business_case' | 'development' | 'testing' | 'launched' | 'cancelled';
  priority?: 'low' | 'medium' | 'high';
  portfolio_category?: string;
  owner_id?: string;
  search?: string;
  sort_by?: 'project_number' | 'project_name' | 'target_launch_date' | 'created_at' | 'priority';
  sort_order?: 'asc' | 'desc';
  page?: number;
  limit?: number;
}

interface ProjectsListResponse {
  projects: NPDProject[];
  pagination: {
    total: number;
    page: number;
    limit: number;
    pages: number;
  };
}

interface NPDProject {
  id: string;
  org_id: string;
  project_number: string;
  project_name: string;
  description?: string;
  portfolio_category?: string;
  current_gate: 'G0' | 'G1' | 'G2' | 'G3' | 'G4' | 'Launched';
  status: 'idea' | 'feasibility' | 'business_case' | 'development' | 'testing' | 'launched' | 'cancelled';
  priority: 'low' | 'medium' | 'high';
  owner_id?: string;
  owner_name?: string;
  target_launch_date?: string;
  actual_launch_date?: string;
  created_at: string;
  created_by: string;
  updated_at: string;
}

// GET /api/npd/projects/:id
interface ProjectDetailResponse {
  project: NPDProject;
  formulation_count: number;
  checklist_completion_pct: number;
  costing_status?: 'draft' | 'submitted' | 'approved' | 'rejected';
  can_advance_gate: boolean;
}

// POST /api/npd/projects
interface CreateProjectRequest {
  project_name: string;
  description?: string;
  portfolio_category?: string;
  priority?: 'low' | 'medium' | 'high';
  owner_id?: string;
  target_launch_date?: string;
}

interface CreateProjectResponse {
  project: NPDProject;
}

// PUT /api/npd/projects/:id
interface UpdateProjectRequest {
  project_name?: string;
  description?: string;
  portfolio_category?: string;
  priority?: 'low' | 'medium' | 'high';
  owner_id?: string;
  target_launch_date?: string;
  status?: 'idea' | 'feasibility' | 'business_case' | 'development' | 'testing' | 'launched' | 'cancelled';
}

// POST /api/npd/projects/:id/advance-gate
interface AdvanceGateRequest {
  skip_validation?: boolean; // MVP: true (no checklist validation)
}

interface AdvanceGateResponse {
  project: NPDProject;
  previous_gate: string;
  new_gate: string;
}

// DELETE /api/npd/projects/:id
// No body, returns 204 No Content on success

// GET /api/npd/dashboard
interface DashboardResponse {
  kanban: {
    G0: NPDProject[];
    G1: NPDProject[];
    G2: NPDProject[];
    G3: NPDProject[];
    G4: NPDProject[];
    Launched: NPDProject[];
  };
  summary: {
    total_projects: number;
    by_gate: { gate: string; count: number }[];
    by_priority: { priority: string; count: number }[];
  };
}
```

### Validation Schemas (Zod)

```typescript
import { z } from 'zod';

export const npdGateEnum = z.enum(['G0', 'G1', 'G2', 'G3', 'G4', 'Launched']);
export const npdStatusEnum = z.enum(['idea', 'feasibility', 'business_case', 'development', 'testing', 'launched', 'cancelled']);
export const npdPriorityEnum = z.enum(['low', 'medium', 'high']);

export const createProjectSchema = z.object({
  project_name: z.string().min(3, 'Project name must be at least 3 characters').max(200),
  description: z.string().max(5000).optional(),
  portfolio_category: z.string().max(100).optional(),
  priority: npdPriorityEnum.default('medium'),
  owner_id: z.string().uuid('Invalid owner ID').optional(),
  target_launch_date: z.string().regex(/^\d{4}-\d{2}-\d{2}$/).optional(),
});

export const updateProjectSchema = z.object({
  project_name: z.string().min(3).max(200).optional(),
  description: z.string().max(5000).optional(),
  portfolio_category: z.string().max(100).optional(),
  priority: npdPriorityEnum.optional(),
  owner_id: z.string().uuid().optional(),
  target_launch_date: z.string().regex(/^\d{4}-\d{2}-\d{2}$/).optional(),
  status: npdStatusEnum.optional(),
});

export const advanceGateSchema = z.object({
  skip_validation: z.boolean().default(true), // MVP: always true
});

export const projectListQuerySchema = z.object({
  current_gate: npdGateEnum.optional(),
  status: npdStatusEnum.optional(),
  priority: npdPriorityEnum.optional(),
  portfolio_category: z.string().optional(),
  owner_id: z.string().uuid().optional(),
  search: z.string().min(1).optional(),
  sort_by: z.enum(['project_number', 'project_name', 'target_launch_date', 'created_at', 'priority']).default('created_at'),
  sort_order: z.enum(['asc', 'desc']).default('desc'),
  page: z.coerce.number().int().positive().default(1),
  limit: z.coerce.number().int().min(1).max(100).default(20),
});
```

### Service Layer

```typescript
// lib/services/npd-project-service.ts

export class NPDProjectService {
  // ==========================================================================
  // CRUD Operations
  // ==========================================================================

  /**
   * List projects with filtering and pagination
   */
  static async list(params: ProjectListParams): Promise<PaginatedResult<NPDProject>>;

  /**
   * Get project by ID with related counts
   */
  static async getById(id: string): Promise<ProjectDetail | null>;

  /**
   * Get project by number
   */
  static async getByNumber(projectNumber: string): Promise<NPDProject | null>;

  /**
   * Create new project with auto-generated number
   */
  static async create(input: CreateProjectInput): Promise<NPDProject>;

  /**
   * Update project (non-launched only)
   */
  static async update(id: string, input: UpdateProjectInput): Promise<NPDProject>;

  /**
   * Delete project (idea status only)
   */
  static async delete(id: string): Promise<void>;

  // ==========================================================================
  // Workflow Operations
  // ==========================================================================

  /**
   * Advance project to next gate
   */
  static async advanceGate(id: string, userId: string): Promise<{
    project: NPDProject;
    previous_gate: string;
    new_gate: string;
  }>;

  /**
   * Move project backwards (rollback)
   */
  static async rollbackGate(id: string, targetGate: string, userId: string): Promise<NPDProject>;

  /**
   * Cancel project
   */
  static async cancel(id: string, reason: string, userId: string): Promise<NPDProject>;

  /**
   * Archive launched project
   */
  static async archive(id: string, userId: string): Promise<NPDProject>;

  // ==========================================================================
  // Kanban Dashboard
  // ==========================================================================

  /**
   * Get Kanban data (projects grouped by gate)
   */
  static async getKanbanData(): Promise<{
    kanban: Record<string, NPDProject[]>;
    summary: DashboardSummary;
  }>;

  // ==========================================================================
  // Utility
  // ==========================================================================

  /**
   * Generate next project number
   */
  static async generateProjectNumber(): Promise<string>;

  /**
   * Get next gate in workflow
   */
  static getNextGate(currentGate: string): string | null;

  /**
   * Map gate to default status
   */
  static gateToStatus(gate: string): string;

  /**
   * Validate gate transition
   */
  static canAdvanceGate(currentGate: string, targetGate: string): {
    can: boolean;
    reason?: string;
  };
}
```

### Frontend Components

```
apps/frontend/app/(authenticated)/npd/
  dashboard/
    page.tsx                       -- Kanban dashboard
  projects/
    page.tsx                       -- Project list view
    [id]/
      page.tsx                     -- Project detail
    new/
      page.tsx                     -- Create project form

components/npd/projects/
  ProjectKanbanBoard.tsx           -- Kanban board container
  ProjectKanbanColumn.tsx          -- Single gate column
  ProjectCard.tsx                  -- Project card in Kanban
  ProjectDataTable.tsx             -- List view DataTable
  ProjectFilters.tsx               -- Filter panel
  ProjectStatusBadge.tsx           -- Status badge component
  ProjectPriorityBadge.tsx         -- Priority badge (color-coded)
  ProjectGateBadge.tsx             -- Gate badge
  ProjectDetail.tsx                -- Detail view container
  ProjectHeader.tsx                -- Header with status, actions
  ProjectOverview.tsx              -- Overview section
  ProjectActions.tsx               -- Action buttons
  CreateProjectModal.tsx           -- Create project modal
  EditProjectModal.tsx             -- Edit project modal
  AdvanceGateModal.tsx             -- Gate advancement confirmation
  CancelProjectDialog.tsx          -- Cancellation with reason
  ProjectSummaryCard.tsx           -- Summary card for dashboard
  ProjectOwnerAvatar.tsx           -- Owner avatar + name
```

### UI Component Details

**ProjectKanbanBoard.tsx**
- 6 columns for gates (G0, G1, G2, G3, G4, Launched)
- Drag-and-drop using react-beautiful-dnd or dnd-kit
- Column headers with project count
- Filter panel at top
- View toggle (Kanban/List)

**ProjectCard.tsx**
- Compact card design
- Project number + name
- Priority badge (color-coded)
- Owner avatar
- Target date or "No target"
- Category tag
- Click to navigate to detail

**ProjectDataTable.tsx**
- ShadCN DataTable pattern
- Columns: Project #, Name, Category, Gate, Status, Priority, Owner, Target Date, Created
- Row click navigates to detail
- Inline actions: Edit, View
- Sort by any column
- Pagination (20 per page)

**AdvanceGateModal.tsx**
- Shows current gate and next gate
- Explains status change
- Warning if skipping validation (MVP: always skip)
- Confirm/Cancel buttons

---

## Key Business Rules

1. **Sequential Gate Advancement**: Projects should advance G0 → G1 → G2 → G3 → G4 → Launched (warn if skipping)
2. **Gate-Status Mapping**: Each gate has default status (G0=idea, G1=feasibility, etc.)
3. **Project Number Uniqueness**: Auto-generated numbers unique per org per year
4. **Edit Restrictions**: Cannot edit launched projects
5. **Delete Restrictions**: Only idea (G0) projects can be hard deleted (RLS enforced)
6. **Owner Assignment**: Defaults to current user if not specified
7. **Audit Trail Required**: All gate changes, status updates logged
8. **NPD Module Feature Flag**: Module must be enabled in org_settings.enabled_modules
9. **Role-Based Access**: NPD_LEAD, R&D roles required for access
10. **Cancelled Projects Hidden**: Status='cancelled' excluded from active views by default

---

## Deliverables

### Database
- [ ] Migration: `npd_projects` table with all columns
- [ ] Migration: `npd_project_number_sequences` table
- [ ] Function: `generate_npd_project_number(org_id)`
- [ ] RLS policies for npd_projects
- [ ] All performance indexes

### API Routes
- [ ] `GET /api/npd/projects` - List with filters
- [ ] `GET /api/npd/projects/:id` - Get detail
- [ ] `POST /api/npd/projects` - Create project
- [ ] `PUT /api/npd/projects/:id` - Update project
- [ ] `DELETE /api/npd/projects/:id` - Delete project
- [ ] `POST /api/npd/projects/:id/advance-gate` - Advance gate
- [ ] `GET /api/npd/dashboard` - Kanban data

### Service Layer
- [ ] `NPDProjectService.list()` - List with pagination
- [ ] `NPDProjectService.getById()` - Get with related counts
- [ ] `NPDProjectService.create()` - Create with number generation
- [ ] `NPDProjectService.update()` - Update project
- [ ] `NPDProjectService.delete()` - Delete project
- [ ] `NPDProjectService.advanceGate()` - Gate workflow
- [ ] `NPDProjectService.cancel()` - Cancel project
- [ ] `NPDProjectService.getKanbanData()` - Kanban view
- [ ] `NPDProjectService.generateProjectNumber()` - Number generation

### Validation
- [ ] `createProjectSchema`
- [ ] `updateProjectSchema`
- [ ] `advanceGateSchema`
- [ ] `projectListQuerySchema`

### Frontend
- [ ] Kanban dashboard page
- [ ] Project list view page
- [ ] Project detail page
- [ ] Create project modal
- [ ] Edit project modal
- [ ] Advance gate modal
- [ ] Cancel project dialog
- [ ] Status, priority, gate badges
- [ ] Filter panel
- [ ] Search functionality
- [ ] Drag-and-drop functionality

### Tests
- [ ] Unit tests: NPDProjectService methods (>80% coverage)
- [ ] Integration tests: All API endpoints
- [ ] RLS tests: Multi-tenancy isolation
- [ ] E2E: Full project workflow (create → advance gates → launch)

---

## Test Strategy

### Unit Tests

```typescript
describe('NPDProjectService', () => {
  describe('create', () => {
    it('creates project with correct fields', async () => {});
    it('generates project number', async () => {});
    it('defaults to current user as owner', async () => {});
    it('defaults current_gate to G0', async () => {});
    it('defaults status to idea', async () => {});
  });

  describe('advanceGate', () => {
    it('advances G0 to G1', async () => {});
    it('updates status with gate', async () => {});
    it('creates audit log entry', async () => {});
    it('blocks advancement from Launched', async () => {});
  });

  describe('generateProjectNumber', () => {
    it('generates NPD-YYYY-NNNNN format', async () => {});
    it('increments sequence', async () => {});
    it('resets per year', async () => {});
  });

  describe('gateToStatus', () => {
    it('maps G0 to idea', () => {});
    it('maps G1 to feasibility', () => {});
    it('maps G4 to testing', () => {});
    it('maps Launched to launched', () => {});
  });
});
```

### Integration Tests

```typescript
describe('NPD Projects API', () => {
  describe('POST /api/npd/projects', () => {
    it('creates project with valid data', async () => {});
    it('returns 400 for missing project_name', async () => {});
    it('enforces org_id from auth', async () => {});
  });

  describe('POST /api/npd/projects/:id/advance-gate', () => {
    it('advances gate from G0 to G1', async () => {});
    it('updates status', async () => {});
    it('returns 403 for unauthorized user', async () => {});
  });

  describe('GET /api/npd/dashboard', () => {
    it('returns Kanban data grouped by gate', async () => {});
    it('respects RLS for org isolation', async () => {});
  });
});
```

### E2E Tests

```typescript
describe('NPD Projects Workflow', () => {
  it('complete workflow: create → advance gates → launch', async () => {
    // 1. Navigate to NPD dashboard
    // 2. Create new project
    // 3. Verify appears in G0 column
    // 4. Advance to G1
    // 5. Verify moves to G1 column
    // 6. Continue through G2, G3, G4
    // 7. Advance to Launched
    // 8. Verify status = 'launched'
  });

  it('drag-and-drop gate advancement', async () => {
    // 1. Create project in G0
    // 2. Drag to G1 column
    // 3. Confirm modal
    // 4. Verify gate updated
  });

  it('filter projects by category and priority', async () => {
    // 1. Create projects with different categories
    // 2. Apply category filter
    // 3. Verify only matching projects display
  });
});
```

---

## Definition of Done

### Database
- [ ] `npd_projects` table created with all columns
- [ ] `npd_project_number_sequences` table created
- [ ] All indexes created for performance
- [ ] RLS policies enforce org isolation
- [ ] Project number generation works correctly

### API
- [ ] All endpoints return correct HTTP status codes
- [ ] Validation errors return 400 with detailed messages
- [ ] Cross-tenant access returns 404
- [ ] Response times:
  - Project list: < 500ms
  - Kanban dashboard: < 500ms
  - Project detail: < 300ms
  - Create/Update: < 300ms

### Service
- [ ] Complete workflow: create → advance gates → launch
- [ ] Gate advancement logic correct
- [ ] Audit trail created for all actions
- [ ] Permission checks enforced

### Frontend
- [ ] Kanban dashboard displays correctly
- [ ] Drag-and-drop works smoothly
- [ ] Project list view displays correctly
- [ ] Project detail page shows all information
- [ ] Create/Edit modals work
- [ ] Advance gate modal with confirmation
- [ ] Filters and search work
- [ ] Badges display correctly

### Testing
- [ ] Unit tests: >80% coverage on service
- [ ] Integration tests: All endpoints covered
- [ ] RLS tests: Multi-tenancy verified
- [ ] E2E tests: Full workflow passing

---

## Risk Assessment

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Drag-and-drop complexity | MEDIUM | MEDIUM | Use battle-tested library (dnd-kit), fallback to manual buttons |
| Gate workflow confusion | MEDIUM | LOW | Clear UX with confirmation modals, tooltips |
| Performance with many projects | MEDIUM | LOW | Proper indexes, pagination, virtual scrolling |
| Feature flag enforcement | HIGH | LOW | Middleware check, comprehensive tests |
| Role permission complexity | MEDIUM | MEDIUM | Clear role definitions, comprehensive tests |

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2026-01-15 | Initial story creation for NPD Projects CRUD & Kanban | ARCHITECT-AGENT |

---

**Document Status**: Ready for Implementation
**Created**: 2026-01-15
**Lines**: ~900
**Complexity**: L (Large)
**Phase**: 1 (Core NPD)
