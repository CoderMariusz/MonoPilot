# 08.7 - Formulation Costing

**Priority**: P1 (MVP - Phase 1)
**Story Points**: M
**Type:** fullstack

**State:** ready
**Primary PRD:** `docs/1-BASELINE/product/modules/npd.md` (Section 5, FR-NPD-23, 24, 25, 26, 27, 28, 29)
**UX Wireframes:** NPD-007 (Formulation Costing View), NPD-008 (Cost Variance Alerts)

---

## MVP Scope

This story implements Phase 1 (MVP) functionality only. Features listed in "Future Phases" are deferred.

---

## Goal

Implement formulation costing with target cost entry, estimated cost calculation, actual cost recording from pilot WOs, variance calculation, and cost history tracking. Enable Finance approval workflow and variance alerts to ensure new products meet profitability targets before handoff.

## User Story

As a **Finance Manager**, I want to **set target costs, track estimated vs actual costs, and approve formulation costing before handoff** so that **new products meet profitability targets and cost variances are flagged early**.

## Scope

**In scope (MVP)**
- PUT /api/npd/formulations/:id/costing/target (set/update target cost)
- GET /api/npd/formulations/:id/costing (get costing data with breakdown)
- POST /api/npd/formulations/:id/costing/recalculate (recalculate estimated cost)
- POST /api/npd/formulations/:id/costing/submit (submit for Finance approval)
- POST /api/npd/formulations/:id/costing/approve (Finance approves costing)
- POST /api/npd/formulations/:id/costing/reject (Finance rejects costing)
- Target cost entry (manual input at G2 Business Case gate)
- Estimated cost calculation (sum of formulation item costs from products.cost_per_unit)
- Actual cost recording (from pilot WO material consumption via work_order_costs)
- Cost variance calculation: ((actual - target) / target) * 100
- Variance alerts: warning if > 20%, blocker if > 50%
- Cost history tracking (per formulation version in npd_costing table)
- Display: target vs estimated vs actual with variance % and color-coded indicators
- Finance approval workflow (status: draft, submitted, approved, rejected)
- Costing section on formulation detail page
- Cost breakdown table (per ingredient)

**Out of scope (this story)**
- Multi-currency support (Phase 1)
- Cost versioning with effective dates (Phase 1)
- Batch cost locking (Phase 1)
- Cost variance analysis across multiple versions (Phase 2)
- Historical cost trend charts (Phase 2)
- Cost scenario modeling (Phase 2)
- Cost optimization suggestions (Phase 2)

## Dependencies
- **08.4** - Formulations CRUD (required for formulation_id FK and formulation data)
- **02.1** - Products CRUD (required for products.cost_per_unit for ingredient costs)
- **04.x** - Work Orders CRUD (required for pilot WO cost capture)
- **01.1** - Org context + RLS (required for tenant isolation)

## Acceptance Criteria (Given/When/Then)

### AC-1: Target Cost Entry

**Given** user with Finance role views formulation costing section
**When** formulation is at G2 Business Case gate
**Then** "[Set Target Cost]" button is visible

**Given** user clicks "[Set Target Cost]"
**When** modal opens
**Then** input field for target_cost displays with currency label (PLN)

**Given** user enters target cost $50.00
**When** "[Save]" clicked
**Then** target_cost saved to npd_costing table and displays in costing summary

**Given** target cost already set to $50.00
**When** user clicks "[Edit Target Cost]"
**Then** modal pre-populates with current value and allows update

**Given** user enters target cost = 0 or negative
**When** save attempted
**Then** error "Target cost must be greater than 0" displays

**Given** target cost set
**When** costing summary renders
**Then** displays: "Target Cost: $50.00"

### AC-2: Estimated Cost Calculation

**Given** formulation has items: Flour ($20), Sugar ($10), Water ($5)
**When** estimated cost calculation runs
**Then** estimated_cost = 20 + 10 + 5 = $35.00

**Given** formulation item has product_id with products.cost_per_unit = NULL
**When** cost calculation runs
**Then** error "Missing cost data for ingredient: [Product Name]" displays

**Given** formulation item quantity = 50 kg, products.cost_per_unit = $2.00/kg
**When** cost calculated
**Then** item cost = 50 * 2.00 = $100.00

**Given** formulation total_qty = 100 kg with 3 items
**When** cost calculation completes
**Then** estimated_cost updates and displays within 500ms

**Given** user clicks "[Recalculate Estimated Cost]"
**When** API call completes
**Then** estimated_cost recalculated using current products.cost_per_unit values and toast "Estimated cost updated" displays

**Given** formulation items change (add/remove/update quantity)
**When** formulation saved
**Then** estimated_cost auto-recalculates (if auto_recalc setting enabled)

### AC-3: Actual Cost Recording

**Given** pilot WO for formulation NPD-001-v1.0 completed
**When** WO material consumption recorded
**Then** actual_cost calculated from work_order_costs and stored in npd_costing

**Given** pilot WO consumes Flour 52 kg (@ $2.00/kg), Sugar 31 kg (@ $1.00/kg), Water 21 L (@ $0.10/L)
**When** WO closed
**Then** actual_cost = (52 * 2.00) + (31 * 1.00) + (21 * 0.10) = $137.10

**Given** no pilot WO executed yet
**When** costing summary displays
**Then** actual_cost shows "-" or "Pending Pilot"

**Given** actual_cost recorded
**When** costing summary displays
**Then** displays: "Actual Cost: $137.10" with timestamp of pilot WO completion

### AC-4: Cost Variance Calculation

**Given** target_cost = $100.00, actual_cost = $110.00
**When** variance calculated
**Then** variance_pct = ((110 - 100) / 100) * 100 = 10%

**Given** target_cost = $100.00, actual_cost = $130.00
**When** variance calculated
**Then** variance_pct = ((130 - 100) / 100) * 100 = 30%

**Given** target_cost = $100.00, actual_cost = $90.00
**When** variance calculated
**Then** variance_pct = ((90 - 100) / 100) * 100 = -10% (favorable variance)

**Given** variance_pct calculated
**When** costing summary renders
**Then** variance displays with color coding: green (<0%), yellow (0-20%), orange (20-50%), red (>50%)

### AC-5: Variance Alerts

**Given** cost_variance_warning_pct = 20% (setting from npd_settings)
**When** variance_pct = 25%
**Then** warning alert displays: "Cost variance exceeds 20% target. Review formulation or adjust target cost."

**Given** cost_variance_blocker_pct = 50% (setting from npd_settings)
**When** variance_pct = 55%
**Then** blocker alert displays: "Cost variance exceeds 50% limit. Handoff blocked until variance resolved." AND handoff wizard validation fails

**Given** variance_pct = 15% (within target)
**When** costing summary displays
**Then** no alert shown, green checkmark indicator

**Given** variance_pct = -5% (favorable, under target)
**When** costing summary displays
**Then** green badge "Under Target" displays

**Given** variance_pct = 45% (warning but not blocker)
**When** handoff wizard validation runs
**Then** warning shown but handoff allowed (Finance approval required)

### AC-6: Cost History Tracking

**Given** formulation v1.0 has costing record created 2024-01-15
**When** formulation v1.1 created
**Then** new npd_costing record created for v1.1, v1.0 record retained

**Given** formulation v1.0 costing record exists
**When** target_cost updated from $50 to $55
**Then** existing record updated (no new record created for target cost changes)

**Given** formulation has 3 costing records (historical versions)
**When** "[View Cost History]" clicked
**Then** table displays all records sorted by created_at DESC with columns: Version, Target, Estimated, Actual, Variance %, Status, Date

**Given** cost history table displayed
**When** viewing multiple versions
**Then** each version shows its own target/estimated/actual costs independently

### AC-7: Finance Approval Workflow

**Given** costing status = 'draft'
**When** user with R&D role clicks "[Submit for Approval]"
**Then** status changes to 'submitted' and Finance notified (if notifications enabled)

**Given** costing status = 'submitted'
**When** user with Finance role clicks "[Approve]"
**Then** status changes to 'approved', approved_by = current_user, approved_at = NOW()

**Given** costing status = 'submitted'
**When** Finance user clicks "[Reject]" with reason "Target cost too low"
**Then** status changes to 'rejected', notes field updated with rejection reason, R&D notified

**Given** costing status = 'approved'
**When** handoff wizard validation runs
**Then** costing approval check passes

**Given** costing status = 'draft' or 'rejected'
**When** handoff wizard validation runs
**Then** error "Costing must be approved before handoff" displays

**Given** require_costing_approval = false (npd_settings)
**When** handoff wizard runs
**Then** costing approval check skipped

**Given** costing status = 'approved'
**When** user attempts to edit target_cost or estimated_cost
**Then** error "Cannot edit approved costing. Reject and resubmit to make changes."

### AC-8: Costing Section Display

**Given** formulation detail page loaded
**When** costing section renders
**Then** displays:
  - Target Cost: $50.00
  - Estimated Cost: $35.00
  - Actual Cost: $37.50 (or "-" if no pilot WO)
  - Variance: +7.1% (color-coded badge)
  - Status: Approved (badge)
  - Approved By: Jane Doe (Finance)
  - Approved At: 2024-06-15 14:30
  - Actions: [Recalculate], [Submit for Approval] (if draft), [Approve]/[Reject] (if submitted)

**Given** costing breakdown displayed
**When** user clicks "[View Breakdown]"
**Then** table shows per-ingredient costs:
  | Ingredient | Quantity | Unit Cost | Total Cost | % of Total |
  | Flour | 50 kg | $2.00/kg | $100.00 | 71.4% |
  | Sugar | 30 kg | $1.00/kg | $30.00 | 21.4% |
  | Water | 20 L | $0.10/L | $2.00 | 1.4% |
  | TOTAL | 100 kg | - | $140.00 | 100% |

**Given** costing summary displays variance
**When** variance > 20%
**Then** warning icon and text "Review formulation - variance exceeds target" displays

**Given** costing summary displays variance
**When** variance > 50%
**Then** blocker icon and text "Handoff blocked - variance exceeds limit" displays in red

### AC-9: Permission Enforcement

**Given** user has role VIEWER (read-only)
**When** costing section loads
**Then** all action buttons hidden (Set Target, Recalculate, Submit, Approve)

**Given** user has role R&D
**When** costing section loads
**Then** "[Set Target Cost]" and "[Recalculate]" buttons visible, approve/reject hidden

**Given** user has role Finance
**When** costing status = 'submitted'
**Then** "[Approve]" and "[Reject]" buttons visible

**Given** user has role Finance
**When** costing status = 'draft'
**Then** approve/reject buttons hidden (must be submitted first)

### AC-10: Auto-Recalculate on Formulation Change

**Given** auto_recalc setting enabled (default true)
**When** formulation item quantity changed
**Then** estimated_cost auto-recalculates on save

**Given** formulation has estimated_cost = $50.00
**When** new item added
**Then** estimated_cost recalculates to include new item cost

**Given** formulation item removed
**When** save completes
**Then** estimated_cost recalculates to exclude removed item

**Given** products.cost_per_unit updated for ingredient used in formulation
**When** formulation costing page loaded
**Then** warning "Cost data updated for ingredients. Recalculate for latest estimate." displays

## Implementation Notes

### API Endpoints

```typescript
// PUT /api/npd/formulations/:id/costing/target
interface SetTargetCostRequest {
  target_cost: number; // required, > 0
  notes?: string;
}

interface SetTargetCostResponse {
  id: number;
  formulation_id: number;
  target_cost: number;
  estimated_cost: number | null;
  actual_cost: number | null;
  variance_pct: number | null;
  status: 'draft' | 'submitted' | 'approved' | 'rejected';
  updated_at: string;
}

// GET /api/npd/formulations/:id/costing
interface FormulationCostingResponse {
  id: number;
  org_id: string;
  npd_project_id: number;
  formulation_id: number;
  formulation_number: string; // v1.0
  target_cost: number | null;
  estimated_cost: number | null;
  actual_cost: number | null;
  variance_pct: number | null;
  status: 'draft' | 'submitted' | 'approved' | 'rejected';
  approved_by: string | null;
  approved_at: string | null;
  notes: string | null;
  created_at: string;
  updated_at: string;
  breakdown: FormulationCostBreakdown;
  variance_alert: {
    type: 'none' | 'warning' | 'blocker';
    message: string | null;
    threshold_exceeded: boolean;
  };
  can_submit: boolean;
  can_approve: boolean;
  can_edit: boolean;
}

interface FormulationCostBreakdown {
  items: FormulationCostItem[];
  total_cost: number;
  currency: string;
}

interface FormulationCostItem {
  product_id: string;
  product_code: string;
  product_name: string;
  quantity: number;
  uom: string;
  unit_cost: number; // from products.cost_per_unit
  total_cost: number; // quantity * unit_cost
  percentage: number; // (total_cost / breakdown.total_cost) * 100
}

// POST /api/npd/formulations/:id/costing/recalculate
// No request body - recalculates using current formulation items
// Returns: FormulationCostingResponse with updated estimated_cost

// POST /api/npd/formulations/:id/costing/submit
interface SubmitCostingRequest {
  notes?: string; // Optional submission notes
}
// Returns: FormulationCostingResponse with status = 'submitted'

// POST /api/npd/formulations/:id/costing/approve
interface ApproveCostingRequest {
  notes?: string; // Optional approval notes
}
// Returns: FormulationCostingResponse with status = 'approved', approved_by, approved_at

// POST /api/npd/formulations/:id/costing/reject
interface RejectCostingRequest {
  reason: string; // Required rejection reason
}
// Returns: FormulationCostingResponse with status = 'rejected', notes updated

// GET /api/npd/formulations/:id/costing/history
interface CostingHistoryResponse {
  history: CostingHistoryRecord[];
}

interface CostingHistoryRecord {
  formulation_id: number;
  formulation_number: string;
  target_cost: number | null;
  estimated_cost: number | null;
  actual_cost: number | null;
  variance_pct: number | null;
  status: string;
  created_at: string;
  approved_at: string | null;
}
```

### Database

```sql
-- npd_costing table (existing in PRD)
CREATE TABLE npd_costing (
    id SERIAL PRIMARY KEY,
    org_id UUID NOT NULL REFERENCES organizations(id),
    npd_project_id INTEGER NOT NULL REFERENCES npd_projects(id),
    formulation_id INTEGER REFERENCES npd_formulations(id),
    target_cost DECIMAL(15,4), -- Manual entry at G2
    estimated_cost DECIMAL(15,4), -- Calculated from formulation items
    actual_cost DECIMAL(15,4), -- From pilot WO
    variance_pct DECIMAL(5,2), -- ((actual - target) / target) * 100
    status VARCHAR(20) NOT NULL DEFAULT 'draft' CHECK (status IN ('draft', 'submitted', 'approved', 'rejected')),
    approved_by UUID REFERENCES users(id),
    approved_at TIMESTAMPTZ,
    notes TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    created_by UUID REFERENCES users(id),
    updated_by UUID REFERENCES users(id)
);

-- Indexes
CREATE INDEX idx_npd_costing_formulation ON npd_costing(formulation_id);
CREATE INDEX idx_npd_costing_project ON npd_costing(npd_project_id);
CREATE INDEX idx_npd_costing_status ON npd_costing(org_id, status);

-- Function: Calculate Formulation Cost
CREATE OR REPLACE FUNCTION calculate_formulation_cost(p_formulation_id INTEGER)
RETURNS DECIMAL(15,4) AS $$
DECLARE
  v_total_cost DECIMAL(15,4);
BEGIN
  SELECT COALESCE(SUM(fi.quantity * p.cost_per_unit), 0)
  INTO v_total_cost
  FROM npd_formulation_items fi
  JOIN products p ON fi.product_id = p.id
  WHERE fi.formulation_id = p_formulation_id;

  RETURN v_total_cost;
END;
$$ LANGUAGE plpgsql;

-- Trigger: Auto-update estimated_cost on formulation_items change
CREATE OR REPLACE FUNCTION auto_update_formulation_cost()
RETURNS TRIGGER AS $$
BEGIN
  UPDATE npd_costing
  SET
    estimated_cost = calculate_formulation_cost(COALESCE(NEW.formulation_id, OLD.formulation_id)),
    updated_at = NOW()
  WHERE formulation_id = COALESCE(NEW.formulation_id, OLD.formulation_id);

  RETURN COALESCE(NEW, OLD);
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_auto_update_formulation_cost
AFTER INSERT OR UPDATE OR DELETE ON npd_formulation_items
FOR EACH ROW EXECUTE FUNCTION auto_update_formulation_cost();

-- Trigger: Auto-calculate variance_pct
CREATE OR REPLACE FUNCTION auto_calculate_cost_variance()
RETURNS TRIGGER AS $$
BEGIN
  IF NEW.target_cost IS NOT NULL AND NEW.actual_cost IS NOT NULL AND NEW.target_cost > 0 THEN
    NEW.variance_pct := ((NEW.actual_cost - NEW.target_cost) / NEW.target_cost) * 100;
  ELSE
    NEW.variance_pct := NULL;
  END IF;

  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_auto_calculate_cost_variance
BEFORE INSERT OR UPDATE ON npd_costing
FOR EACH ROW EXECUTE FUNCTION auto_calculate_cost_variance();

-- RLS Policy
ALTER TABLE npd_costing ENABLE ROW LEVEL SECURITY;

CREATE POLICY npd_costing_org_isolation ON npd_costing
  USING (org_id = current_setting('app.current_org_id')::UUID);

CREATE POLICY npd_costing_select ON npd_costing FOR SELECT
  USING (org_id = current_setting('app.current_org_id')::UUID);

CREATE POLICY npd_costing_insert ON npd_costing FOR INSERT
  WITH CHECK (org_id = current_setting('app.current_org_id')::UUID);

CREATE POLICY npd_costing_update ON npd_costing FOR UPDATE
  USING (org_id = current_setting('app.current_org_id')::UUID);

CREATE POLICY npd_costing_delete ON npd_costing FOR DELETE
  USING (org_id = current_setting('app.current_org_id')::UUID);
```

### Frontend Components

```
app/(authenticated)/npd/formulations/[id]/page.tsx  -- Add costing section

components/npd/formulation/
  FormulationCostingCard.tsx       -- Main costing summary card
  CostBreakdownTable.tsx           -- Per-ingredient cost table
  SetTargetCostModal.tsx           -- Modal to set/edit target cost
  RecalculateCostButton.tsx        -- Button with loading state
  SubmitCostingButton.tsx          -- Submit for approval button
  ApproveCostingDialog.tsx         -- Finance approval dialog
  RejectCostingDialog.tsx          -- Finance rejection dialog
  CostVarianceIndicator.tsx        -- Color-coded variance badge
  CostVarianceAlert.tsx            -- Warning/blocker alert banner
  CostHistoryModal.tsx             -- Cost history table modal
```

### Services

```typescript
// lib/services/formulation-costing-service.ts

export async function getFormulationCosting(formulationId: number): Promise<FormulationCostingResponse>;
export async function setTargetCost(formulationId: number, targetCost: number, notes?: string): Promise<FormulationCostingResponse>;
export async function recalculateEstimatedCost(formulationId: number): Promise<FormulationCostingResponse>;
export async function submitCosting(formulationId: number, notes?: string): Promise<FormulationCostingResponse>;
export async function approveCosting(formulationId: number, notes?: string): Promise<FormulationCostingResponse>;
export async function rejectCosting(formulationId: number, reason: string): Promise<FormulationCostingResponse>;
export async function getCostingHistory(formulationId: number): Promise<CostingHistoryResponse>;
export async function calculateFormulationCost(formulationId: number): Promise<number>;
export async function getVarianceAlert(variance: number | null, settings: NPDSettings): Promise<VarianceAlert>;

// Internal helpers
function calculateVariancePercent(target: number, actual: number): number;
function getVarianceType(variance: number, warningThreshold: number, blockerThreshold: number): 'none' | 'warning' | 'blocker';
```

### Validation (Zod)

```typescript
const setTargetCostSchema = z.object({
  target_cost: z.number().positive("Target cost must be greater than 0").max(999999999, "Target cost too large"),
  notes: z.string().max(2000).optional(),
});

const submitCostingSchema = z.object({
  notes: z.string().max(2000).optional(),
});

const approveCostingSchema = z.object({
  notes: z.string().max(2000).optional(),
});

const rejectCostingSchema = z.object({
  reason: z.string().min(5, "Rejection reason is required (min 5 characters)").max(2000),
});
```

### Business Rules

1. **Target Cost Entry**: Manual input, typically set at G2 Business Case gate
2. **Estimated Cost Calculation**: Sum of all formulation item costs using products.cost_per_unit
3. **Actual Cost Recording**: Captured from pilot WO material consumption (work_order_costs table)
4. **Variance Calculation**: ((actual - target) / target) * 100
5. **Variance Alerts**:
   - Warning: variance > 20% (default, configurable via npd_settings.cost_variance_warning_pct)
   - Blocker: variance > 50% (default, configurable via npd_settings.cost_variance_blocker_pct)
6. **Finance Approval**: Required before handoff if require_costing_approval = true (default)
7. **Auto-Recalculate**: Estimated cost auto-updates when formulation items change (if auto_recalc enabled)
8. **Immutability**: Approved costing cannot be edited directly - must reject and resubmit
9. **Cost History**: One npd_costing record per formulation version (historical tracking)
10. **Currency**: Single currency per org (default PLN, from npd_settings or org settings)

## Deliverables

- Database migration for npd_costing table + triggers + RLS policies
- SQL function: calculate_formulation_cost(formulation_id)
- API routes: PUT costing/target, GET costing, POST recalculate, POST submit, POST approve, POST reject, GET history
- formulation-costing-service.ts with all calculation and workflow functions
- FormulationCostingCard component
- CostBreakdownTable component
- SetTargetCostModal component
- RecalculateCostButton component
- SubmitCostingButton component
- ApproveCostingDialog component
- RejectCostingDialog component
- CostVarianceIndicator component
- CostVarianceAlert component
- CostHistoryModal component
- Zod validation schemas
- Integration tests for API endpoints
- Unit tests for formulation-costing-service (>80% coverage)

## Definition of Done

- [ ] npd_costing table created with RLS policies
- [ ] calculate_formulation_cost() function works correctly
- [ ] Auto-update trigger recalculates estimated_cost on formulation_items change
- [ ] Auto-calculate variance_pct trigger works on target/actual cost updates
- [ ] PUT /api/npd/formulations/:id/costing/target sets target cost
- [ ] GET /api/npd/formulations/:id/costing returns full costing breakdown
- [ ] POST recalculate updates estimated_cost using current product costs
- [ ] POST submit changes status to 'submitted'
- [ ] POST approve changes status to 'approved' (Finance role only)
- [ ] POST reject changes status to 'rejected' with reason
- [ ] GET history returns all costing records for formulation versions
- [ ] Variance calculation accurate: ((actual - target) / target) * 100
- [ ] Variance alerts display correctly (warning > 20%, blocker > 50%)
- [ ] Costing section displays on formulation detail page
- [ ] Cost breakdown table shows per-ingredient costs
- [ ] Permission checks enforce Finance approval workflow
- [ ] Approved costing cannot be edited directly
- [ ] Handoff wizard validates costing approval (if required)
- [ ] Variance > 50% blocks handoff
- [ ] All API endpoints have integration tests
- [ ] Unit tests cover formulation-costing-service (>80% coverage)
- [ ] Zod schemas validate all input fields
- [ ] Empty state shows "Set target cost to begin costing" CTA
- [ ] Error states display clear messages

---

## Future Phases (Not in MVP)

### Phase 1
- **Multi-currency support** - Handle target/estimated/actual costs in different currencies with conversion
- **Cost versioning with effective dates** - Track cost changes over time with effective_from/effective_to
- **Batch cost locking** - Lock costs for specific production runs

### Phase 2
- **Cost variance analysis across versions** - Compare cost performance across multiple formulation versions
- **Historical cost trend charts** - Visualize cost changes over time with charts
- **Cost scenario modeling** - "What-if" analysis for ingredient cost changes
- **Cost optimization suggestions** - AI-driven recommendations for cost reduction

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2026-01-15 | Initial version - Formulation Costing | ARCHITECT-AGENT |
