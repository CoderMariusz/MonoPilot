# NPD-012: Formulation Costing Card

**Module**: NPD (New Product Development)
**Feature**: Formulation Cost Tracking and Approval (FR-NPD-20 to FR-NPD-24)
**Type**: Card Component (Embedded in NPD-007 Formulation Editor or NPD-002 Project Detail)
**Path**: Embedded within `/npd/projects/{projectId}/formulations/{id}`
**ID**: NPD-012
**Parent**: NPD-007 (Formulation Editor) or NPD-002 (Project Detail - Formulations Tab)
**Status**: Ready for Review
**Last Updated**: 2026-01-15

---

## Overview

The Formulation Costing Card provides a comprehensive view of formulation costs during NPD development. It tracks target cost, estimated cost (auto-calculated from ingredients), and actual cost (from pilot work orders). Cost variance is displayed with color-coded badges to highlight budget concerns.

**Business Context:**
- Target cost = manually set cost goal for formulation (editable in draft, locked when submitted)
- Estimated cost = auto-calculated from ingredient quantities and unit costs
- Actual cost = populated from completed pilot work orders
- Variance tracking enables early detection of cost overruns
- Approval workflow for cost sign-off before production handoff

**Critical PRD Coverage:**
- NPD-FR-20: Set target cost for formulations - Must
- NPD-FR-21: Auto-calculate estimated cost from ingredients - Must
- NPD-FR-22: Track actual cost from pilot WOs - Must
- NPD-FR-23: Display cost variance with thresholds - Must
- NPD-FR-24: Cost approval workflow - Must

**Card Purpose:**
- Display target, estimated, and actual costs
- Show cost breakdown by ingredient
- Track variance with visual indicators
- Enable cost approval workflow
- Support cost iteration during development

---

## ASCII Wireframe

### State: Draft - No Target (Initial State)

```
+-----------------------------------------------------------------------------+
|  FORMULATION COSTING                                              [Draft]   |
+-----------------------------------------------------------------------------+
|                                                                             |
|  +-----------------------------------------------------------------------+  |
|  |                                                                       |  |
|  |  Target Cost *                                                        |  |
|  |  +------------------------------------------+                         |  |
|  |  | Enter target cost...              PLN/kg |                         |  |
|  |  +------------------------------------------+                         |  |
|  |  Set your cost goal for this formulation                              |  |
|  |                                                                       |  |
|  +-----------------------------------------------------------------------+  |
|                                                                             |
|  +-----------------------------------------------------------------------+  |
|  |  COST SUMMARY                                                         |  |
|  |                                                                       |  |
|  |  Estimated Cost:         --                                           |  |
|  |  (Add ingredients to calculate)                                       |  |
|  |                                                                       |  |
|  |  Actual Cost:            --                                           |  |
|  |  (Available after pilot WO)                                           |  |
|  |                                                                       |  |
|  |  Variance:               --                                           |  |
|  |                                                                       |  |
|  +-----------------------------------------------------------------------+  |
|                                                                             |
|  +-----------------------------------------------------------------------+  |
|  |  COST BREAKDOWN                                                       |  |
|  |  +-------------------------------------------------------------------+|  |
|  |  |                          [beaker icon]                            ||  |
|  |  |                                                                   ||  |
|  |  |                    No ingredients added yet                       ||  |
|  |  |                                                                   ||  |
|  |  |         Add ingredients to see cost breakdown                     ||  |
|  |  |                                                                   ||  |
|  |  +-------------------------------------------------------------------+|  |
|  +-----------------------------------------------------------------------+  |
|                                                                             |
|  [Recalculate]  (disabled)                                                  |
|                                                                             |
+-----------------------------------------------------------------------------+
```

### State: Draft - With Target (Editable)

```
+-----------------------------------------------------------------------------+
|  FORMULATION COSTING                                              [Draft]   |
+-----------------------------------------------------------------------------+
|                                                                             |
|  +-----------------------------------------------------------------------+  |
|  |                                                                       |  |
|  |  Target Cost *                                                        |  |
|  |  +------------------------------------------+                         |  |
|  |  | 4.50                              PLN/kg |   [Edit]                |  |
|  |  +------------------------------------------+                         |  |
|  |  Editable until submitted for approval                                |  |
|  |                                                                       |  |
|  +-----------------------------------------------------------------------+  |
|                                                                             |
|  +-----------------------------------------------------------------------+  |
|  |  COST SUMMARY                                                         |  |
|  |  -------------------------------------------------------------------  |  |
|  |                                                                       |  |
|  |  +-----------------------+  +-----------------------+                 |  |
|  |  | ESTIMATED             |  | ACTUAL                |                 |  |
|  |  |                       |  |                       |                 |  |
|  |  |       4.72            |  |         --            |                 |  |
|  |  |      PLN/kg           |  |      PLN/kg           |                 |  |
|  |  |                       |  |  (No pilot WO yet)    |                 |  |
|  |  +-----------------------+  +-----------------------+                 |  |
|  |                                                                       |  |
|  |  Variance from Target:                                                |  |
|  |  +-------------------------------------------------------------------+|  |
|  |  |  +4.89%  (0.22 PLN/kg over target)            [Yellow Badge]     ||  |
|  |  +-------------------------------------------------------------------+|  |
|  |                                                                       |  |
|  +-----------------------------------------------------------------------+  |
|                                                                             |
|  +-----------------------------------------------------------------------+  |
|  |  COST BREAKDOWN                                        [Expand All]   |  |
|  |  -------------------------------------------------------------------  |  |
|  |                                                                       |  |
|  |  +-------------------------------------------------------------------+|  |
|  |  | Ingredient           | Qty      | Unit Cost | Total    | %       ||  |
|  |  +-------------------------------------------------------------------+|  |
|  |  | ING-001              | 45.000kg | 5.50/kg   | 247.50   | 52.4%   ||  |
|  |  | Pea Protein Isolate  |          |           |          |         ||  |
|  |  +-------------------------------------------------------------------+|  |
|  |  | ING-002              | 25.000kg | 0.05/kg   | 1.25     | 0.3%    ||  |
|  |  | Water                |          |           |          |         ||  |
|  |  +-------------------------------------------------------------------+|  |
|  |  | ING-003              | 15.000kg | 8.20/kg   | 123.00   | 26.1%   ||  |
|  |  | Coconut Oil          |          |           |          |         ||  |
|  |  +-------------------------------------------------------------------+|  |
|  |  | ING-004              | 8.000kg  | 4.80/kg   | 38.40    | 8.1%    ||  |
|  |  | Methylcellulose      |          |           |          |         ||  |
|  |  +-------------------------------------------------------------------+|  |
|  |  | ING-005              | 7.000kg  | 8.50/kg   | 59.50    | 12.6%   ||  |
|  |  | Seasoning Blend      |          |           |          |         ||  |
|  |  +-------------------------------------------------------------------+|  |
|  |  |                                                                   ||  |
|  |  | TOTAL                | 100.00kg |           | 469.65   | 100%    ||  |
|  |  | Cost per kg:         |          |           | 4.70/kg  |         ||  |
|  |  +-------------------------------------------------------------------+|  |
|  |                                                                       |  |
|  +-----------------------------------------------------------------------+  |
|                                                                             |
|  [Recalculate]                              [Submit for Approval]           |
|                                                                             |
+-----------------------------------------------------------------------------+
```

### State: Submitted - Pending Approval

```
+-----------------------------------------------------------------------------+
|  FORMULATION COSTING                                [Submitted - Pending]   |
+-----------------------------------------------------------------------------+
|                                                                             |
|  +-----------------------------------------------------------------------+  |
|  | [i] Cost submitted for approval on Jan 14, 2026 by John Smith         |  |
|  |     Awaiting approval from Finance Manager                            |  |
|  +-----------------------------------------------------------------------+  |
|                                                                             |
|  +-----------------------------------------------------------------------+  |
|  |                                                                       |  |
|  |  Target Cost                                                          |  |
|  |  +------------------------------------------+                         |  |
|  |  | 4.50                              PLN/kg |   [Locked]              |  |
|  |  +------------------------------------------+                         |  |
|  |  Locked after submission                                              |  |
|  |                                                                       |  |
|  +-----------------------------------------------------------------------+  |
|                                                                             |
|  +-----------------------------------------------------------------------+  |
|  |  COST SUMMARY                                                         |  |
|  |  -------------------------------------------------------------------  |  |
|  |                                                                       |  |
|  |  +-----------------------+  +-----------------------+                 |  |
|  |  | ESTIMATED             |  | ACTUAL                |                 |  |
|  |  |                       |  |                       |                 |  |
|  |  |       4.72            |  |         --            |                 |  |
|  |  |      PLN/kg           |  |      PLN/kg           |                 |  |
|  |  |                       |  |  (Pending pilot)      |                 |  |
|  |  +-----------------------+  +-----------------------+                 |  |
|  |                                                                       |  |
|  |  Variance from Target:                                                |  |
|  |  +-------------------------------------------------------------------+|  |
|  |  |  +4.89%  (0.22 PLN/kg over target)            [Yellow Badge]     ||  |
|  |  +-------------------------------------------------------------------+|  |
|  |                                                                       |  |
|  +-----------------------------------------------------------------------+  |
|                                                                             |
|  +-----------------------------------------------------------------------+  |
|  |  COST BREAKDOWN                                        (Read-Only)    |  |
|  |  -------------------------------------------------------------------  |  |
|  |  (Same table as draft state - all fields read-only)                   |  |
|  +-----------------------------------------------------------------------+  |
|                                                                             |
|  +-----------------------------------------------------------------------+  |
|  |  APPROVAL ACTIONS                                       (Finance Only)|  |
|  |                                                                       |  |
|  |  Approval Notes (Optional):                                           |  |
|  |  +-------------------------------------------------------------------+|  |
|  |  | Cost is slightly over target but acceptable for initial pilot.   ||  |
|  |  +-------------------------------------------------------------------+|  |
|  |                                                                       |  |
|  |                                    [Reject]      [Approve]            |  |
|  |                                                                       |  |
|  +-----------------------------------------------------------------------+  |
|                                                                             |
+-----------------------------------------------------------------------------+
```

### State: Approved

```
+-----------------------------------------------------------------------------+
|  FORMULATION COSTING                                            [Approved]  |
+-----------------------------------------------------------------------------+
|                                                                             |
|  +-----------------------------------------------------------------------+  |
|  | [check] Cost approved on Jan 15, 2026 by Sarah Finance                |  |
|  |         "Cost is slightly over target but acceptable for pilot."      |  |
|  +-----------------------------------------------------------------------+  |
|                                                                             |
|  +-----------------------------------------------------------------------+  |
|  |                                                                       |  |
|  |  Target Cost                                                          |  |
|  |  +------------------------------------------+                         |  |
|  |  | 4.50                              PLN/kg |   [Locked]              |  |
|  |  +------------------------------------------+                         |  |
|  |                                                                       |  |
|  +-----------------------------------------------------------------------+  |
|                                                                             |
|  +-----------------------------------------------------------------------+  |
|  |  COST SUMMARY                                                         |  |
|  |  -------------------------------------------------------------------  |  |
|  |                                                                       |  |
|  |  +-----------------------+  +-----------------------+                 |  |
|  |  | ESTIMATED             |  | ACTUAL                |                 |  |
|  |  |                       |  |                       |                 |  |
|  |  |       4.72            |  |       4.85            |                 |  |
|  |  |      PLN/kg           |  |      PLN/kg           |                 |  |
|  |  |                       |  | from WO-2026-0042     |                 |  |
|  |  +-----------------------+  +-----------------------+                 |  |
|  |                                                                       |  |
|  |  Variance from Target:                                                |  |
|  |  +-------------------------------------------------------------------+|  |
|  |  |  Estimated: +4.89%  |  Actual: +7.78%            [Yellow Badge]  ||  |
|  |  +-------------------------------------------------------------------+|  |
|  |                                                                       |  |
|  +-----------------------------------------------------------------------+  |
|                                                                             |
|  +-----------------------------------------------------------------------+  |
|  |  COST BREAKDOWN                                        (Read-Only)    |  |
|  |  -------------------------------------------------------------------  |  |
|  |  (Same table as before)                                               |  |
|  +-----------------------------------------------------------------------+  |
|                                                                             |
|  +-----------------------------------------------------------------------+  |
|  |  PILOT WO COSTS                                     [View WO Details] |  |
|  |  -------------------------------------------------------------------  |  |
|  |                                                                       |  |
|  |  WO-2026-0042 (Completed)                                             |  |
|  |  +-------------------------------------------------------------------+|  |
|  |  | Material Cost:         458.25 PLN                                 ||  |
|  |  | Labor Cost:            28.50 PLN                                  ||  |
|  |  | Overhead:              13.25 PLN                                  ||  |
|  |  | -------------------------------------------------------------------||  |
|  |  | Total WO Cost:         500.00 PLN                                 ||  |
|  |  | Output Qty:            103.2 kg                                   ||  |
|  |  | -------------------------------------------------------------------||  |
|  |  | Actual Cost/kg:        4.85 PLN/kg                                ||  |
|  |  +-------------------------------------------------------------------+|  |
|  |                                                                       |  |
|  +-----------------------------------------------------------------------+  |
|                                                                             |
+-----------------------------------------------------------------------------+
```

### State: Rejected

```
+-----------------------------------------------------------------------------+
|  FORMULATION COSTING                                            [Rejected]  |
+-----------------------------------------------------------------------------+
|                                                                             |
|  +-----------------------------------------------------------------------+  |
|  | [!] Cost rejected on Jan 15, 2026 by Sarah Finance                    |  |
|  |     "Cost exceeds budget by more than 10%. Please reformulate."       |  |
|  |                                                                       |  |
|  |     [Revise Formulation]                                              |  |
|  +-----------------------------------------------------------------------+  |
|                                                                             |
|  +-----------------------------------------------------------------------+  |
|  |                                                                       |  |
|  |  Target Cost                                                          |  |
|  |  +------------------------------------------+                         |  |
|  |  | 4.50                              PLN/kg |   [Edit Target]         |  |
|  |  +------------------------------------------+                         |  |
|  |  Target can be revised after rejection                                |  |
|  |                                                                       |  |
|  +-----------------------------------------------------------------------+  |
|                                                                             |
|  +-----------------------------------------------------------------------+  |
|  |  COST SUMMARY                                                         |  |
|  |  -------------------------------------------------------------------  |  |
|  |                                                                       |  |
|  |  +-----------------------+  +-----------------------+                 |  |
|  |  | ESTIMATED             |  | ACTUAL                |                 |  |
|  |  |                       |  |                       |                 |  |
|  |  |       5.10            |  |         --            |                 |  |
|  |  |      PLN/kg           |  |      PLN/kg           |                 |  |
|  |  |                       |  |                       |                 |  |
|  |  +-----------------------+  +-----------------------+                 |  |
|  |                                                                       |  |
|  |  Variance from Target:                                                |  |
|  |  +-------------------------------------------------------------------+|  |
|  |  |  +13.33%  (0.60 PLN/kg over target)           [Orange Badge]     ||  |
|  |  +-------------------------------------------------------------------+|  |
|  |                                                                       |  |
|  +-----------------------------------------------------------------------+  |
|                                                                             |
|  +-----------------------------------------------------------------------+  |
|  |  REJECTION HISTORY                                                    |  |
|  |  -------------------------------------------------------------------  |  |
|  |                                                                       |  |
|  |  Jan 15, 2026 14:30 - Rejected by Sarah Finance                       |  |
|  |  Reason: "Cost exceeds budget by more than 10%. Please reformulate."  |  |
|  |                                                                       |  |
|  +-----------------------------------------------------------------------+  |
|                                                                             |
|  [Recalculate]                              [Resubmit for Approval]         |
|                                                                             |
+-----------------------------------------------------------------------------+
```

### State: Variance Warning (5-10%)

```
+-----------------------------------------------------------------------------+
|  FORMULATION COSTING                                              [Draft]   |
+-----------------------------------------------------------------------------+
|                                                                             |
|  +-----------------------------------------------------------------------+  |
|  | [!] Warning: Estimated cost is 8.2% above target                      |  |
|  |     Consider reviewing ingredient costs or adjusting target           |  |
|  +-----------------------------------------------------------------------+  |
|                                                                             |
|  +-----------------------------------------------------------------------+  |
|  |                                                                       |  |
|  |  Target Cost *                                                        |  |
|  |  +------------------------------------------+                         |  |
|  |  | 4.50                              PLN/kg |   [Edit]                |  |
|  |  +------------------------------------------+                         |  |
|  |                                                                       |  |
|  +-----------------------------------------------------------------------+  |
|                                                                             |
|  +-----------------------------------------------------------------------+  |
|  |  COST SUMMARY                                                         |  |
|  |  -------------------------------------------------------------------  |  |
|  |                                                                       |  |
|  |  +-----------------------+  +-----------------------+                 |  |
|  |  | ESTIMATED             |  | ACTUAL                |                 |  |
|  |  |                       |  |                       |                 |  |
|  |  |       4.87            |  |         --            |                 |  |
|  |  |      PLN/kg           |  |      PLN/kg           |                 |  |
|  |  +-----------------------+  +-----------------------+                 |  |
|  |                                                                       |  |
|  |  Variance from Target:                                                |  |
|  |  +-------------------------------------------------------------------+|  |
|  |  |  +8.22%  (0.37 PLN/kg over target)            [Yellow Badge]     ||  |
|  |  |                                                                   ||  |
|  |  |  [!] Within warning threshold (5-10%)                            ||  |
|  |  +-------------------------------------------------------------------+|  |
|  |                                                                       |  |
|  +-----------------------------------------------------------------------+  |
|                                                                             |
|  (Cost breakdown table same as draft state)                                 |
|                                                                             |
|  [Recalculate]                              [Submit for Approval]           |
|                                                                             |
+-----------------------------------------------------------------------------+
```

### State: Variance Blocker (>20%)

```
+-----------------------------------------------------------------------------+
|  FORMULATION COSTING                                              [Draft]   |
+-----------------------------------------------------------------------------+
|                                                                             |
|  +-----------------------------------------------------------------------+  |
|  | [X] BLOCKER: Estimated cost exceeds target by 25.6%                   |  |
|  |     Submission blocked. Reduce cost or adjust target to proceed.      |  |
|  |                                                                       |  |
|  |     Suggestions:                                                      |  |
|  |     - Review high-cost ingredients (Pea Protein Isolate: 52.4%)       |  |
|  |     - Consider alternative suppliers                                  |  |
|  |     - Adjust formulation quantities                                   |  |
|  |     - Request target cost increase from Finance                       |  |
|  +-----------------------------------------------------------------------+  |
|                                                                             |
|  +-----------------------------------------------------------------------+  |
|  |                                                                       |  |
|  |  Target Cost *                                                        |  |
|  |  +------------------------------------------+                         |  |
|  |  | 4.50                              PLN/kg |   [Edit]                |  |
|  |  +------------------------------------------+                         |  |
|  |                                                                       |  |
|  +-----------------------------------------------------------------------+  |
|                                                                             |
|  +-----------------------------------------------------------------------+  |
|  |  COST SUMMARY                                                         |  |
|  |  -------------------------------------------------------------------  |  |
|  |                                                                       |  |
|  |  +-----------------------+  +-----------------------+                 |  |
|  |  | ESTIMATED             |  | ACTUAL                |                 |  |
|  |  |                       |  |                       |                 |  |
|  |  |       5.65            |  |         --            |                 |  |
|  |  |      PLN/kg           |  |      PLN/kg           |                 |  |
|  |  +-----------------------+  +-----------------------+                 |  |
|  |                                                                       |  |
|  |  Variance from Target:                                                |  |
|  |  +-------------------------------------------------------------------+|  |
|  |  |  +25.56%  (1.15 PLN/kg over target)            [Red Badge]       ||  |
|  |  |                                                                   ||  |
|  |  |  [X] EXCEEDS THRESHOLD - Submission blocked (>20%)               ||  |
|  |  +-------------------------------------------------------------------+|  |
|  |                                                                       |  |
|  +-----------------------------------------------------------------------+  |
|                                                                             |
|  +-----------------------------------------------------------------------+  |
|  |  HIGH COST INGREDIENTS                                                |  |
|  |  -------------------------------------------------------------------  |  |
|  |                                                                       |  |
|  |  [!] ING-001 Pea Protein Isolate                                      |  |
|  |      247.50 PLN (52.4% of total cost)                                 |  |
|  |      Unit cost: 5.50 PLN/kg                                           |  |
|  |      [Find Alternatives]                                              |  |
|  |                                                                       |  |
|  |  [!] ING-003 Coconut Oil                                              |  |
|  |      123.00 PLN (26.1% of total cost)                                 |  |
|  |      Unit cost: 8.20 PLN/kg                                           |  |
|  |      [Find Alternatives]                                              |  |
|  |                                                                       |  |
|  +-----------------------------------------------------------------------+  |
|                                                                             |
|  [Recalculate]                        [Submit for Approval] (disabled)      |
|                                                                             |
+-----------------------------------------------------------------------------+
```

### Loading State

```
+-----------------------------------------------------------------------------+
|  FORMULATION COSTING                                              [...]     |
+-----------------------------------------------------------------------------+
|                                                                             |
|  +-----------------------------------------------------------------------+  |
|  |                                                                       |  |
|  |  Target Cost                                                          |  |
|  |  [========================================]                           |  |
|  |                                                                       |  |
|  +-----------------------------------------------------------------------+  |
|                                                                             |
|  +-----------------------------------------------------------------------+  |
|  |  COST SUMMARY                                                         |  |
|  |                                                                       |  |
|  |                    [Spinner]                                          |  |
|  |                                                                       |  |
|  |               Loading cost data...                                    |  |
|  |                                                                       |  |
|  +-----------------------------------------------------------------------+  |
|                                                                             |
|  +-----------------------------------------------------------------------+  |
|  |  COST BREAKDOWN                                                       |  |
|  |                                                                       |  |
|  |  [========================================]                           |  |
|  |  [================================]                                   |  |
|  |  [====================================]                               |  |
|  |  [====================]                                               |  |
|  |                                                                       |  |
|  +-----------------------------------------------------------------------+  |
|                                                                             |
+-----------------------------------------------------------------------------+
```

### Error State

```
+-----------------------------------------------------------------------------+
|  FORMULATION COSTING                                              [Error]   |
+-----------------------------------------------------------------------------+
|                                                                             |
|  +-----------------------------------------------------------------------+  |
|  |                         [Warning Icon]                                |  |
|  |                                                                       |  |
|  |                  Failed to Load Cost Data                             |  |
|  |                                                                       |  |
|  |         Unable to calculate formulation costs.                        |  |
|  |         Error: INGREDIENT_COST_MISSING (ING-003)                      |  |
|  |                                                                       |  |
|  |         Some ingredients are missing cost information.                |  |
|  |         Please update product costs in Technical module.              |  |
|  |                                                                       |  |
|  |            [Update Product Costs]      [Retry]                        |  |
|  |                                                                       |  |
|  +-----------------------------------------------------------------------+  |
|                                                                             |
+-----------------------------------------------------------------------------+
```

### Mobile View (< 768px)

```
+----------------------------------+
|  FORMULATION COSTING             |
|  Status: [Draft]                 |
+----------------------------------+
|                                  |
|  Target Cost                     |
|  +----------------------------+  |
|  | 4.50 PLN/kg         [Edit]|  |
|  +----------------------------+  |
|                                  |
|  +----------------------------+  |
|  | ESTIMATED    | ACTUAL      |  |
|  |    4.72      |    --       |  |
|  |   PLN/kg     |  PLN/kg     |  |
|  +----------------------------+  |
|                                  |
|  Variance: +4.89%                |
|  +----------------------------+  |
|  | [Yellow Badge]             |  |
|  | 0.22 PLN/kg over target    |  |
|  +----------------------------+  |
|                                  |
|  Cost Breakdown       [Expand]   |
|  +----------------------------+  |
|  | ING-001                    |  |
|  | Pea Protein Isolate        |  |
|  | 45kg x 5.50 = 247.50 (52%) |  |
|  +----------------------------+  |
|  | ING-002                    |  |
|  | Water                      |  |
|  | 25kg x 0.05 = 1.25 (0.3%)  |  |
|  +----------------------------+  |
|  | ING-003                    |  |
|  | Coconut Oil                |  |
|  | 15kg x 8.20 = 123.00 (26%) |  |
|  +----------------------------+  |
|  | ... 2 more                 |  |
|  +----------------------------+  |
|                                  |
|  Total: 469.65 PLN (4.70/kg)     |
|                                  |
|  [Recalculate]                   |
|  [Submit for Approval]           |
|                                  |
+----------------------------------+
```

---

## Key Components

### 1. Status Badge

| Status | Color | Icon | Description |
|--------|-------|------|-------------|
| Draft | Yellow | Pencil | Cost editable, not yet submitted |
| Submitted | Blue | Clock | Awaiting approval |
| Approved | Green | Check | Cost approved, ready for production |
| Rejected | Red | X | Rejected, needs revision |

### 2. Target Cost Field

| Property | Description |
|----------|-------------|
| Type | Currency input (decimal, 2 places) |
| UoM | Per output unit (PLN/kg, PLN/L, etc.) |
| Editable | Draft and Rejected status only |
| Locked | Submitted and Approved status |
| Required | Yes, for submission |

### 3. Cost Summary Cards

| Card | Value Source | Display |
|------|--------------|---------|
| Estimated Cost | Auto-calculated from ingredients | Currency/UoM |
| Actual Cost | From pilot WO (if available) | Currency/UoM or "--" |
| Variance | (Estimated - Target) / Target * 100 | Percentage with badge |

### 4. Variance Badge

| Threshold | Color | Icon | Behavior |
|-----------|-------|------|----------|
| <= 5% | Green | Check | Normal, proceed |
| 5-10% | Yellow | Warning | Warning shown, can proceed |
| 10-20% | Orange | Alert | Strong warning, can proceed with note |
| > 20% | Red | Block | Blocker, submission disabled |

### 5. Cost Breakdown Table

| Column | Description | Width |
|--------|-------------|-------|
| Ingredient | Product code + name | 35% |
| Qty | Quantity with UoM | 15% |
| Unit Cost | Cost per unit | 15% |
| Total | Qty x Unit Cost | 20% |
| % | Percentage of total cost | 15% |

### 6. Action Buttons

| Button | Visible When | Action |
|--------|--------------|--------|
| [Recalculate] | Draft, Rejected | Refresh costs from current ingredient prices |
| [Submit for Approval] | Draft (variance <= 20%) | Submit to Finance for approval |
| [Approve] | Submitted (Finance role) | Approve cost |
| [Reject] | Submitted (Finance role) | Reject cost with reason |
| [Resubmit for Approval] | Rejected | Resubmit after changes |
| [Edit Target] | Draft, Rejected | Enable target cost editing |

---

## Main Actions

### Primary Actions

| Action | Button | Visible When | Result |
|--------|--------|--------------|--------|
| Submit | [Submit for Approval] | status = draft, variance <= 20% | Changes status to submitted, locks target |
| Approve | [Approve] | status = submitted, user = Finance | Changes status to approved |
| Reject | [Reject] | status = submitted, user = Finance | Changes status to rejected with reason |
| Recalculate | [Recalculate] | status = draft OR rejected | Refreshes cost calculations |

### Secondary Actions

| Action | Button | Visible When | Result |
|--------|--------|--------------|--------|
| Edit Target | [Edit] / [Edit Target] | status = draft OR rejected | Enables target cost input |
| View WO | [View WO Details] | actual_cost available | Opens pilot WO detail |
| Find Alternatives | [Find Alternatives] | variance > 20% | Opens ingredient search |
| Revise Formulation | [Revise Formulation] | status = rejected | Returns to formulation editor |

---

## States Summary

| State | Description | Target Editable | Submit Enabled | Approval Actions |
|-------|-------------|-----------------|----------------|------------------|
| draft-no-target | Initial, no target set | Yes | No | Hidden |
| draft-with-target | Target set, editable | Yes | Yes (if variance <= 20%) | Hidden |
| submitted-pending | Awaiting approval | No (locked) | No | [Approve] [Reject] |
| approved | Cost approved | No (locked) | No | Hidden |
| rejected | Cost rejected | Yes (unlocked) | Yes (resubmit) | Hidden |
| variance-warning | Variance 5-20% | Yes | Yes (with warning) | Hidden |
| variance-blocker | Variance > 20% | Yes | No (blocked) | Hidden |

---

## Validation Rules

### Target Cost

```typescript
{
  target_cost: {
    required: "Target cost is required for submission",
    min: { value: 0.01, message: "Target cost must be greater than 0" },
    validate: (value) => {
      const decimals = (value.toString().split('.')[1] || '').length
      if (decimals > 2) {
        return "Maximum 2 decimal places allowed"
      }
      return true
    }
  }
}
```

### Submission Validation

```typescript
{
  // Before Submit for Approval
  validate: () => {
    if (!target_cost) {
      return "Target cost is required"
    }
    if (items.length === 0) {
      return "Formulation must have ingredients to calculate cost"
    }
    if (variance > 20) {
      return "Variance exceeds 20% threshold. Reduce cost or adjust target."
    }
    return true
  }
}
```

### Approval Validation

```typescript
{
  // Before Reject
  rejection_reason: {
    required: "Rejection reason is required",
    minLength: { value: 10, message: "Please provide a detailed reason (min 10 chars)" }
  }
}
```

---

## Data Required

### Cost Calculation

```typescript
interface FormulationCost {
  formulation_id: string
  target_cost: number | null
  estimated_cost: number
  actual_cost: number | null
  variance_percent: number | null
  status: 'draft' | 'submitted' | 'approved' | 'rejected'
  submitted_at: Date | null
  submitted_by: string | null
  approved_at: Date | null
  approved_by: string | null
  approval_notes: string | null
  rejected_at: Date | null
  rejected_by: string | null
  rejection_reason: string | null
}

interface CostBreakdownItem {
  ingredient_id: string
  product_code: string
  product_name: string
  quantity: number
  uom: string
  unit_cost: number
  total_cost: number
  cost_percentage: number
}
```

### API Endpoints

```
GET /api/npd/formulations/:id/costing
Response: {
  formulation_id: string
  target_cost: number | null
  estimated_cost: number
  actual_cost: number | null
  variance_percent: number | null
  status: string
  breakdown: CostBreakdownItem[]
  pilot_wo: PilotWOCost | null
  history: CostApprovalHistory[]
}

PUT /api/npd/formulations/:id/costing/target
Request: { target_cost: number }
Response: { success: true, target_cost: number }

POST /api/npd/formulations/:id/costing/submit
Response: { success: true, status: 'submitted', submitted_at: Date }

POST /api/npd/formulations/:id/costing/approve
Request: { notes?: string }
Response: { success: true, status: 'approved', approved_at: Date }

POST /api/npd/formulations/:id/costing/reject
Request: { reason: string }
Response: { success: true, status: 'rejected', rejected_at: Date }

POST /api/npd/formulations/:id/costing/recalculate
Response: { success: true, estimated_cost: number, breakdown: CostBreakdownItem[] }
```

---

## Technical Notes

### Cost Calculation Logic

```typescript
const calculateEstimatedCost = (
  items: FormulationItem[],
  totalOutputQty: number
): { totalCost: number; costPerUnit: number; breakdown: CostBreakdownItem[] } => {
  let totalCost = 0
  const breakdown: CostBreakdownItem[] = []

  items.forEach(item => {
    const itemCost = item.quantity * item.product.cost_per_unit
    totalCost += itemCost

    breakdown.push({
      ingredient_id: item.id,
      product_code: item.product.code,
      product_name: item.product.name,
      quantity: item.quantity,
      uom: item.uom,
      unit_cost: item.product.cost_per_unit,
      total_cost: itemCost,
      cost_percentage: 0 // Calculated after total known
    })
  })

  // Calculate percentages
  breakdown.forEach(item => {
    item.cost_percentage = (item.total_cost / totalCost) * 100
  })

  const costPerUnit = totalCost / totalOutputQty

  return { totalCost, costPerUnit, breakdown }
}
```

### Variance Calculation

```typescript
const calculateVariance = (
  estimated: number,
  target: number
): { percent: number; absolute: number; threshold: VarianceThreshold } => {
  if (!target || target === 0) {
    return { percent: 0, absolute: 0, threshold: 'none' }
  }

  const absolute = estimated - target
  const percent = (absolute / target) * 100

  let threshold: VarianceThreshold
  if (percent <= 5) threshold = 'green'
  else if (percent <= 10) threshold = 'yellow'
  else if (percent <= 20) threshold = 'orange'
  else threshold = 'red'

  return { percent, absolute, threshold }
}
```

### Actual Cost from Pilot WO

```typescript
const getActualCostFromWO = (wo: WorkOrder): number | null => {
  if (wo.status !== 'completed') return null
  if (!wo.actual_cost || !wo.output_qty) return null

  // actual_cost includes: materials + labor + overhead
  return wo.actual_cost / wo.output_qty
}
```

---

## Accessibility (WCAG 2.1 AA)

### Touch Targets
- All buttons: 48x48dp minimum
- Edit icons: 48x48dp
- Table rows: 48dp height minimum

### Contrast
- Text: 4.5:1 minimum
- Variance badges: Meet WCAG AA with text labels
- Status badges: Color + text + icon

### Screen Reader
- Card title: "Formulation Costing Card, Status: Draft"
- Target cost: "Target cost: 4.50 PLN per kilogram, editable"
- Variance: "Variance: plus 4.89 percent over target, yellow warning threshold"
- Breakdown table: "Cost breakdown table, 5 ingredients"
- Actions: "Submit for approval button" / "Button disabled, variance exceeds threshold"

### Keyboard Navigation
- Tab: Navigate between fields and buttons
- Enter: Activate buttons, submit forms
- Escape: Cancel edit mode

### Color Independence
- Variance badges include text percentage + icon
- Status badges include text label + icon
- Error states include text message + icon

---

## Responsive Breakpoints

| Breakpoint | Layout |
|------------|--------|
| Desktop (>1024px) | Full card with side-by-side cost summary |
| Tablet (768-1024px) | Stacked cost summary, full breakdown table |
| Mobile (<768px) | Compact card, collapsible breakdown, stacked buttons |

---

## Permissions

| Role | View | Edit Target | Submit | Approve/Reject |
|------|------|-------------|--------|----------------|
| Admin | Yes | Yes | Yes | Yes |
| NPD Lead | Yes | Yes | Yes | No |
| R&D | Yes | Yes (assigned project) | Yes | No |
| Finance | Yes | No | No | Yes |
| Regulatory | Yes | No | No | No |

---

## Related Screens

- **Parent**: NPD-007 (Formulation Editor)
- **Related**: NPD-002 (Project Detail Page - Formulations Tab)
- **Related**: PLAN-015 (Work Order Detail - for pilot WO costs)
- **Related**: TEC-004 (Products - for ingredient cost data)

---

## Handoff to FRONTEND-DEV

```yaml
feature: NPD Formulation Costing Card
story: NPD-012
fr_coverage: NPD-FR-20 to NPD-FR-24
approval_status:
  mode: "review_each"
  user_approved: false  # PENDING USER REVIEW
deliverables:
  wireframe: docs/3-ARCHITECTURE/ux/wireframes/NPD-012-formulation-costing-card.md
  api_endpoints:
    - GET /api/npd/formulations/:id/costing
    - PUT /api/npd/formulations/:id/costing/target
    - POST /api/npd/formulations/:id/costing/submit
    - POST /api/npd/formulations/:id/costing/approve
    - POST /api/npd/formulations/:id/costing/reject
    - POST /api/npd/formulations/:id/costing/recalculate
states_per_screen:
  - draft-no-target
  - draft-with-target
  - submitted-pending
  - approved
  - rejected
  - variance-warning
  - variance-blocker
  - loading
  - error
components:
  - Status badge (Draft/Submitted/Approved/Rejected)
  - Target cost field (editable in draft, locked when submitted)
  - Estimated cost display (auto-calculated, read-only)
  - Actual cost display (from pilot WO, read-only)
  - Variance badge (green/yellow/orange/red thresholds)
  - Cost breakdown table (ingredient, qty, unit cost, total, %)
  - Action buttons (Recalculate, Submit, Approve, Reject)
  - Approval notes textarea
  - Rejection history panel
  - Pilot WO costs panel
breakpoints:
  mobile: "<768px"
  tablet: "768-1024px"
  desktop: ">1024px"
accessibility:
  touch_targets: "48dp minimum"
  contrast: "4.5:1 minimum"
  screen_reader: "Full ARIA support"
  color_independence: "Badges include text + icon"
critical_ux_requirements:
  - Auto-calculate estimated cost from ingredients
  - Real-time variance calculation with threshold badges
  - Target cost locked after submission
  - Submission blocked when variance > 20%
  - Actual cost populated from pilot WO
  - Approval workflow with notes/reason
  - Cost recalculation on demand
libraries:
  - ShadCN Card (for card container)
  - ShadCN Badge (for status and variance badges)
  - ShadCN Input (for target cost)
  - ShadCN Table (for cost breakdown)
  - ShadCN Button (for actions)
  - ShadCN Textarea (for approval notes)
  - ShadCN Alert (for variance warnings)
```

---

## Quality Gates

Before handoff to FRONTEND-DEV:
- [x] All states defined (draft-no-target, draft-with-target, submitted-pending, approved, rejected, variance-warning, variance-blocker, loading, error)
- [x] All components specified (status badge, target cost, cost summary, variance badge, breakdown table, actions)
- [x] API endpoints documented
- [x] Variance thresholds defined (green/yellow/orange/red)
- [x] Status-based field editability defined
- [x] Accessibility requirements met
- [x] Responsive design documented
- [x] Validation rules specified
- [x] Cost calculation logic documented
- [x] Approval workflow defined
- [x] Permission matrix defined

---

**Status**: Ready for User Review
**Approval Mode**: review_each (default)
**User Approved**: Pending
**Iterations**: 0 of 3
**PRD Coverage**: NPD-FR-20 to NPD-FR-24 (100%)
**Estimated Effort**: 6-8 hours implementation
**Quality Target**: 95/100
