# 06.27 - CoA Templates

**Priority**: P0 (MVP)
**Story Points**: M (Medium)
**Type**: full-stack
**Phase**: 3 (CoA & HACCP)
**Model**: OPUS

**State:** ready
**Estimate:** M (3-4 days)
**Primary PRD:** `docs/1-BASELINE/product/modules/quality.md` (FR-QA-012, Section 13.2)
**Architecture:** `docs/1-BASELINE/architecture/modules/quality.md` (coa_templates table)

---

## Goal

Implement CoA template management allowing QA teams to create, configure, and maintain certificate templates for different products or product types. Templates define the structure, branding, and parameter layout for generated certificates of analysis. This story establishes the foundation for automatic CoA generation (06.28).

---

## Food Safety Compliance

This story is **critical for regulatory compliance**:

- [x] **FDA 21 CFR Part 11** - Template versioning with audit trail required
- [x] **CoA Standardization** - Consistent format across all customer certificates
- [x] **Traceability** - Template changes tracked with version history
- [x] **Document Control** - Active template selection with effective dating

**Regulatory Context:**
- CoA format must be consistent per product type
- Template changes require approval and version control
- Historical templates retained for audit purposes (10 years)
- Customer-specific templates supported for contract requirements
- Logo and branding must be archival-quality (PDF/A compatible)

---

## MVP Scope

This story implements Phase 3 CoA template functionality as the prerequisite for CoA generation.

**MVP Includes**:
- `coa_templates` table with versioning support
- Template CRUD operations
- Template builder UI (header, footer, parameters, compliance statements)
- Parameter selection from quality_spec_parameters
- Logo upload with format validation (PNG/JPEG/SVG)
- Template preview rendering
- Template versioning with approval workflow
- Active template selection (one active per product/product_type)
- Template duplication for creating variants

**Deferred to Phase 3+**:
- Multi-language templates (Phase 4)
- Customer-specific template overrides (Phase 4)
- Advanced layout customization (drag-and-drop builder) (Phase 4)
- Barcode/QR code customization (Phase 4)
- Template usage analytics (Phase 4)

---

## User Story

As a **QA Manager**, I want to **create and configure CoA templates for different product types, defining header/footer branding, test parameter layout, and compliance statements** so that **automatically generated certificates are professional, consistent, and meet customer requirements**.

As a **Quality Director**, I want to **approve template versions and control which template is active for each product type** so that **CoA generation uses the correct approved format**.

---

## Scope

**In scope (this story)**
- `coa_templates` table with version control
- GET /api/quality/coa-templates (list with filters)
- GET /api/quality/coa-templates/:id (detail)
- POST /api/quality/coa-templates (create)
- PUT /api/quality/coa-templates/:id (update draft)
- POST /api/quality/coa-templates/:id/approve (approve version)
- POST /api/quality/coa-templates/:id/activate (set as active)
- POST /api/quality/coa-templates/:id/duplicate (clone template)
- DELETE /api/quality/coa-templates/:id (delete draft)
- POST /api/quality/coa-templates/:id/upload-logo (logo upload)
- GET /api/quality/coa-templates/:id/preview (preview rendering)
- Template builder page with sections editor
- Parameter selector from quality_spec_parameters
- Logo uploader component
- Template preview component
- Version history display
- Active template badge

**Out of scope (this story)**
- CoA generation from templates (story 06.28)
- PDF export of CoA (story 06.29)
- Batch release integration (story 06.12)
- Customer-specific templates (Phase 4)
- Multi-language support (Phase 4)
- Advanced layout editor (Phase 4)

---

## Dependencies

### Cross-Epic Dependencies

| Dependency | Story/Epic | Type | What It Provides | Status |
|------------|------------|------|------------------|--------|
| 01.1 | Org Context + RLS | HARD | organizations, users, roles tables | Ready |
| 02.1 | Products CRUD | HARD | products table, product types | Ready |
| 06.3 | Product Specifications | HARD | quality_specifications table | Ready |
| 06.4 | Test Parameters | HARD | quality_spec_parameters for template params | Ready |

### Within Epic Dependencies

| Dependency | Story | Type | What It Provides |
|------------|-------|------|------------------|
| 06.0 | Quality Settings | SOFT | Default template settings |
| 06.1 | Quality Status Types | SOFT | Quality approval roles |

### Provides To (Downstream)

| Story | What This Provides |
|-------|-------------------|
| 06.28 | CoA Generation Engine - template_id reference, template structure |
| 06.29 | CoA PDF Export - template rendering logic |

---

## Database Migration

### Migration: Create coa_templates table

```sql
-- Migration: YYYYMMDDHHMMSS_create_coa_templates.sql

CREATE TABLE coa_templates (
    -- Identity
    id                      UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id                  UUID NOT NULL REFERENCES organizations(id),
    template_number         TEXT NOT NULL,

    -- Template Info
    name                    TEXT NOT NULL,
    description             TEXT,

    -- Applicability
    product_id              UUID REFERENCES products(id),
    product_type            TEXT,

    -- Template Structure
    header_template         TEXT,
    footer_template         TEXT,
    logo_url                TEXT,

    -- Parameters (JSON array of parameter IDs and display settings)
    parameters_config       JSONB NOT NULL DEFAULT '[]'::jsonb,

    -- Compliance Statements
    compliance_statements   TEXT[],

    -- Layout Settings
    layout_config           JSONB DEFAULT '{
        "show_header": true,
        "show_footer": true,
        "show_logo": true,
        "parameter_columns": ["name", "specification", "result", "method", "status"],
        "font_family": "Arial",
        "font_size": 10,
        "page_size": "A4",
        "orientation": "portrait"
    }'::jsonb,

    -- Versioning
    version                 INTEGER NOT NULL DEFAULT 1,
    is_active               BOOLEAN NOT NULL DEFAULT false,
    status                  TEXT NOT NULL DEFAULT 'draft'
                            CHECK (status IN ('draft', 'pending_approval', 'approved', 'archived')),

    -- Approval
    approved_by             UUID REFERENCES users(id),
    approved_at             TIMESTAMPTZ,
    approval_notes          TEXT,

    -- Effective Dating
    effective_date          DATE,
    expiry_date             DATE,

    -- Audit
    created_at              TIMESTAMPTZ NOT NULL DEFAULT now(),
    created_by              UUID REFERENCES users(id),
    updated_at              TIMESTAMPTZ NOT NULL DEFAULT now(),
    updated_by              UUID REFERENCES users(id),

    -- Constraints
    CONSTRAINT uq_template_number UNIQUE (org_id, template_number),
    CONSTRAINT chk_product_or_type CHECK (
        (product_id IS NOT NULL AND product_type IS NULL) OR
        (product_id IS NULL AND product_type IS NOT NULL) OR
        (product_id IS NULL AND product_type IS NULL)
    ),
    CONSTRAINT chk_effective_dates CHECK (
        expiry_date IS NULL OR effective_date IS NULL OR expiry_date > effective_date
    )
);

-- =============================================================================
-- Indexes for Performance
-- =============================================================================

CREATE INDEX idx_coa_templates_org ON coa_templates(org_id);
CREATE INDEX idx_coa_templates_org_status ON coa_templates(org_id, status);
CREATE INDEX idx_coa_templates_product ON coa_templates(product_id) WHERE product_id IS NOT NULL;
CREATE INDEX idx_coa_templates_product_type ON coa_templates(org_id, product_type) WHERE product_type IS NOT NULL;
CREATE INDEX idx_coa_templates_active ON coa_templates(org_id, is_active) WHERE is_active = true;
CREATE INDEX idx_coa_templates_created ON coa_templates(org_id, created_at);

-- =============================================================================
-- Template Number Sequence
-- =============================================================================

CREATE TABLE coa_template_number_sequences (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    year INTEGER NOT NULL,
    current_value BIGINT NOT NULL DEFAULT 0,
    updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
    UNIQUE(org_id, year)
);

-- Function to generate template number (COA-TPL-YYYY-NNNNN)
CREATE OR REPLACE FUNCTION generate_coa_template_number(p_org_id UUID)
RETURNS TEXT AS $$
DECLARE
    v_year INTEGER;
    v_next_val BIGINT;
    v_template_number TEXT;
BEGIN
    v_year := EXTRACT(YEAR FROM CURRENT_DATE);

    -- Upsert sequence and get next value
    INSERT INTO coa_template_number_sequences (org_id, year, current_value)
    VALUES (p_org_id, v_year, 1)
    ON CONFLICT (org_id, year)
    DO UPDATE SET
        current_value = coa_template_number_sequences.current_value + 1,
        updated_at = NOW()
    RETURNING current_value INTO v_next_val;

    -- Format template number
    v_template_number := 'COA-TPL-' || v_year::TEXT || '-' || LPAD(v_next_val::TEXT, 5, '0');

    RETURN v_template_number;
END;
$$ LANGUAGE plpgsql;

-- =============================================================================
-- Template Version History
-- =============================================================================

CREATE TABLE coa_template_versions (
    id                      UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id                  UUID NOT NULL REFERENCES organizations(id),
    template_id             UUID NOT NULL REFERENCES coa_templates(id) ON DELETE CASCADE,

    version                 INTEGER NOT NULL,

    -- Snapshot of template at version
    template_snapshot       JSONB NOT NULL,

    -- Version metadata
    change_summary          TEXT,
    changed_by              UUID REFERENCES users(id),
    changed_at              TIMESTAMPTZ NOT NULL DEFAULT now(),

    CONSTRAINT uq_template_version UNIQUE (template_id, version)
);

CREATE INDEX idx_template_versions_template ON coa_template_versions(template_id);
CREATE INDEX idx_template_versions_org ON coa_template_versions(org_id);

-- =============================================================================
-- RLS Policies
-- =============================================================================

ALTER TABLE coa_templates ENABLE ROW LEVEL SECURITY;

CREATE POLICY "coa_templates_select" ON coa_templates
    FOR SELECT USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

CREATE POLICY "coa_templates_insert" ON coa_templates
    FOR INSERT WITH CHECK (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

CREATE POLICY "coa_templates_update" ON coa_templates
    FOR UPDATE USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

-- Only allow delete of draft templates
CREATE POLICY "coa_templates_delete" ON coa_templates
    FOR DELETE USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
        AND status = 'draft'
    );

ALTER TABLE coa_template_number_sequences ENABLE ROW LEVEL SECURITY;

CREATE POLICY "coa_template_seq_org" ON coa_template_number_sequences
    FOR ALL TO authenticated
    USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

ALTER TABLE coa_template_versions ENABLE ROW LEVEL SECURITY;

CREATE POLICY "coa_template_versions_org" ON coa_template_versions
    FOR ALL TO authenticated
    USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

-- =============================================================================
-- Trigger for updated_at
-- =============================================================================

CREATE TRIGGER update_coa_templates_updated_at
    BEFORE UPDATE ON coa_templates
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- =============================================================================
-- Function: Enforce single active template per product/type
-- =============================================================================

CREATE OR REPLACE FUNCTION enforce_single_active_template()
RETURNS TRIGGER AS $$
BEGIN
    -- If setting template to active, deactivate others for same product/type
    IF NEW.is_active = true AND (OLD.is_active IS NULL OR OLD.is_active = false) THEN

        -- Deactivate templates for same product
        IF NEW.product_id IS NOT NULL THEN
            UPDATE coa_templates
            SET is_active = false, updated_at = NOW()
            WHERE org_id = NEW.org_id
              AND product_id = NEW.product_id
              AND id != NEW.id
              AND is_active = true;

        -- Deactivate templates for same product type
        ELSIF NEW.product_type IS NOT NULL THEN
            UPDATE coa_templates
            SET is_active = false, updated_at = NOW()
            WHERE org_id = NEW.org_id
              AND product_type = NEW.product_type
              AND id != NEW.id
              AND is_active = true;
        END IF;
    END IF;

    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_enforce_single_active_template
    BEFORE UPDATE ON coa_templates
    FOR EACH ROW
    WHEN (NEW.is_active = true)
    EXECUTE FUNCTION enforce_single_active_template();

-- =============================================================================
-- Function: Create version snapshot on approval
-- =============================================================================

CREATE OR REPLACE FUNCTION create_template_version_snapshot()
RETURNS TRIGGER AS $$
DECLARE
    v_snapshot JSONB;
BEGIN
    -- When status changes to 'approved', create version snapshot
    IF NEW.status = 'approved' AND (OLD.status IS NULL OR OLD.status != 'approved') THEN

        -- Create JSON snapshot of current template
        SELECT to_jsonb(NEW) INTO v_snapshot;

        -- Insert version record
        INSERT INTO coa_template_versions (
            org_id,
            template_id,
            version,
            template_snapshot,
            change_summary,
            changed_by,
            changed_at
        ) VALUES (
            NEW.org_id,
            NEW.id,
            NEW.version,
            v_snapshot,
            'Template approved',
            NEW.approved_by,
            NEW.approved_at
        );
    END IF;

    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_create_template_version
    AFTER UPDATE ON coa_templates
    FOR EACH ROW
    WHEN (NEW.status = 'approved')
    EXECUTE FUNCTION create_template_version_snapshot();
```

---

## Acceptance Criteria (Given/When/Then)

### AC-1: Template Table Creation

```gherkin
Scenario: coa_templates table exists with all required columns
  Given database migration runs
  When schema is inspected
  Then coa_templates table has all columns from schema
  And UNIQUE constraint exists on (org_id, template_number)
  And FK constraints exist for all references
  And RLS policies enforce org isolation
```

### AC-2: Template Number Auto-Generation

```gherkin
Scenario: Generate template number with year-based format
  Given organization exists
  When template created
  Then template_number format is 'COA-TPL-2025-00001'
  And next template gets 'COA-TPL-2025-00002'
  And year resets sequence (first 2026 = 'COA-TPL-2026-00001')

Scenario: Template number uniqueness
  Given template 'COA-TPL-2025-00001' exists in org A
  When creating another with same number in org A
  Then system returns 409 Conflict error
```

### AC-3: Create Template

```gherkin
Scenario: Create new template for product type
  Given user navigates to CoA Templates
  And clicks [+ New Template]
  When user fills:
    | Field | Value |
    | Name | Standard Flour CoA |
    | Product Type | Flour |
    | Header | "Certified Analysis Report" |
    | Footer | "Accredited Lab #12345" |
  And selects parameters: Protein, Moisture, Ash
  And uploads logo (PNG, 500KB)
  And clicks [Save Draft]
  Then template created with status = 'draft'
  And template_number auto-generated
  And success toast "Template COA-TPL-2025-00001 created"

Scenario: Create template for specific product
  Given product SKU-001 exists
  When user creates template
  And selects Product = SKU-001 (instead of Product Type)
  Then template.product_id = SKU-001
  And template.product_type = NULL

Scenario: Validation - must specify product OR product_type
  Given user creates template
  And leaves both Product and Product Type blank
  When clicking [Save]
  Then error: "Select either a specific product or product type"
```

### AC-4: Template Parameter Selection

```gherkin
Scenario: Select parameters from quality specs
  Given product has quality_specification with 5 parameters
  When building template
  And clicking [Add Parameter]
  Then modal shows available parameters from quality_spec_parameters
  And user can multi-select parameters
  And selected parameters appear in template preview

Scenario: Configure parameter display settings
  Given parameter "Protein" added to template
  When user edits parameter settings
  Then can configure:
    | Setting | Options |
    | Display Name | Override label |
    | Show Spec | Yes/No |
    | Show Method | Yes/No |
    | Column Order | Drag to reorder |

Scenario: Parameters saved in JSONB config
  Given template with 3 parameters configured
  When template saved
  Then parameters_config contains:
    [
      {"parameter_id": "uuid1", "display_name": "Protein %", "show_spec": true, "order": 1},
      {"parameter_id": "uuid2", "display_name": "Moisture %", "show_spec": true, "order": 2},
      {"parameter_id": "uuid3", "display_name": "Ash %", "show_spec": false, "order": 3}
    ]
```

### AC-5: Logo Upload

```gherkin
Scenario: Upload company logo
  Given user editing template
  When clicking [Upload Logo]
  And selects PNG file (800x200, 300KB)
  Then file uploads to storage (S3/Supabase Storage)
  And logo_url populated with CDN path
  And preview shows logo in header

Scenario: Logo format validation
  Given user uploads file
  When file is not PNG/JPEG/SVG
  Then error: "Logo must be PNG, JPEG, or SVG format"

Scenario: Logo size validation
  Given user uploads PNG
  When file size > 2MB
  Then error: "Logo file size must be under 2MB"
```

### AC-6: Template Versioning

```gherkin
Scenario: Template version increments on approval
  Given template in draft with version = 1
  When template approved
  Then version remains 1
  And version snapshot created in coa_template_versions

Scenario: Edit approved template creates new version
  Given template approved (version 1, status = 'approved')
  When user clicks [Edit Template]
  Then warning: "Editing will create version 2. Continue?"
  And if confirmed:
    | Action | Result |
    | version | 2 |
    | status | draft |
    | is_active | false |
    | approved_by | NULL |

Scenario: Version history display
  Given template with 3 approved versions
  When viewing template detail
  Then version history shows:
    | Version | Status | Approved By | Approved At | Changes |
    | 3 | approved | Jane QA | 2025-01-15 | Added Gluten param |
    | 2 | approved | Jane QA | 2025-01-10 | Updated footer |
    | 1 | approved | Jane QA | 2025-01-05 | Initial version |
```

### AC-7: Template Approval Workflow

```gherkin
Scenario: Submit template for approval
  Given template in draft
  When user clicks [Submit for Approval]
  Then status changes to 'pending_approval'
  And QA Manager notified
  And [Edit] button disabled

Scenario: QA Manager approves template
  Given template in pending_approval
  And current user is QA_MANAGER
  When clicking [Approve Template]
  And adding approval notes: "Reviewed and approved"
  Then status changes to 'approved'
  And approved_by = current user
  And approved_at = now
  And version snapshot created

Scenario: QA Manager rejects template
  Given template in pending_approval
  When QA Manager clicks [Reject]
  And provides reason: "Logo quality insufficient"
  Then status changes back to 'draft'
  And notification sent to creator with reason
```

### AC-8: Active Template Selection

```gherkin
Scenario: Set template as active
  Given approved template for product_type = 'Flour'
  And template is_active = false
  When user clicks [Set as Active]
  Then is_active = true
  And any other active templates for 'Flour' deactivated
  And badge "ACTIVE" displayed

Scenario: Only one active template per product type
  Given template A active for product_type = 'Flour'
  And template B approved for product_type = 'Flour'
  When activating template B
  Then template B.is_active = true
  And template A.is_active = false (automatically)

Scenario: Active template cannot be deleted
  Given template is_active = true
  When attempting to delete
  Then error: "Cannot delete active template. Deactivate first."
```

### AC-9: Template Preview

```gherkin
Scenario: Preview template rendering
  Given template configured with header, footer, logo, parameters
  When clicking [Preview]
  Then modal shows:
    | Section | Content |
    | Header | Header text with logo |
    | Product Info | Product name, batch, date placeholders |
    | Parameters Table | Columns: Parameter, Spec, Result, Method, Status |
    | Compliance | List of compliance statements |
    | Footer | Footer text with signatures section |

Scenario: Preview with sample data
  Given template preview
  When toggling [Show Sample Data]
  Then parameters populated with example values:
    | Parameter | Spec | Result | Method | Status |
    | Protein % | 12-14% | 13.2% | AOAC 990.03 | PASS |
    | Moisture % | Max 14% | 12.5% | AOAC 925.10 | PASS |
```

### AC-10: Template Duplication

```gherkin
Scenario: Duplicate template to create variant
  Given template "Standard Flour CoA" exists
  When user clicks [Duplicate]
  And provides new name: "Premium Flour CoA"
  Then new template created with:
    | Field | Value |
    | name | Premium Flour CoA |
    | template_number | COA-TPL-2025-00002 (new) |
    | version | 1 |
    | status | draft |
    | is_active | false |
    | All other fields | Copied from original |

Scenario: Duplicate preserves parameters and layout
  Given original template has 5 parameters configured
  When duplicated
  Then new template has same parameters_config (deep copy)
  And logo_url copied (reference to same file)
```

### AC-11: Template List and Filters

```gherkin
Scenario: CoA templates list loads
  Given user navigates to Quality > CoA Templates
  When page loads
  Then DataTable displays templates with columns:
    | Column | Description |
    | Template # | Link to detail |
    | Name | Template name |
    | Product/Type | Product or type applicability |
    | Version | Current version |
    | Status | Badge (draft/pending/approved) |
    | Active | Checkmark if is_active |
    | Created | Date created |
    | Actions | View, Edit, Duplicate, Activate |

Scenario: Filter by status
  Given templates exist with various statuses
  When user filters by status = 'approved'
  Then only approved templates display

Scenario: Filter by product type
  Given templates for Flour, Sugar, Salt
  When user filters by product_type = 'Flour'
  Then only Flour templates display

Scenario: Search by name or template number
  Given templates exist
  When user searches "COA-TPL-2025-00001" or "Flour"
  Then matching templates display
```

### AC-12: Template Detail Page

```gherkin
Scenario: View template detail
  Given template COA-TPL-2025-00001 exists
  When user navigates to /quality/coa-templates/COA-TPL-2025-00001
  Then page displays:
    | Section | Content |
    | Header | Template #, Name, Status badge, Active badge |
    | Info | Product/Type, Version, Created/Updated |
    | Structure | Header text, Footer text, Logo preview |
    | Parameters | List of selected parameters with display config |
    | Compliance | List of compliance statements |
    | Layout | Layout settings (font, page size, orientation) |
    | Preview | Live template preview |
    | Version History | List of approved versions |
    | Actions | Edit, Approve, Activate, Duplicate, Delete |
```

### AC-13: Template Deletion

```gherkin
Scenario: Delete draft template
  Given template with status = 'draft'
  When user clicks [Delete]
  And confirms deletion
  Then template deleted from database
  And success toast "Template deleted"

Scenario: Cannot delete approved template
  Given template with status = 'approved'
  Then [Delete] button disabled
  And tooltip: "Approved templates cannot be deleted"

Scenario: Cannot delete active template
  Given template with is_active = true
  When attempting to delete
  Then error: "Cannot delete active template. Deactivate first."
```

### AC-14: Compliance Statements

```gherkin
Scenario: Add compliance statements
  Given user editing template
  When clicking [Add Compliance Statement]
  Then text area appears
  And user enters: "This product complies with FDA regulations"
  And clicks [Add]
  Then statement added to compliance_statements array

Scenario: Reorder compliance statements
  Given template has 3 compliance statements
  When user drags statement 3 to position 1
  Then statements reordered in array
  And preview updates order

Scenario: Common statements library
  Given user adding compliance statement
  When clicking [Insert from Library]
  Then dropdown shows common statements:
    - "Certified Kosher"
    - "Certified Organic"
    - "Non-GMO Project Verified"
    - "Gluten-Free Certified"
  And selecting inserts text
```

### AC-15: Layout Configuration

```gherkin
Scenario: Configure layout settings
  Given user editing template
  When opening Layout Settings panel
  Then can configure:
    | Setting | Options |
    | Font Family | Arial, Times New Roman, Helvetica |
    | Font Size | 8-14pt |
    | Page Size | A4, Letter, Legal |
    | Orientation | Portrait, Landscape |
    | Header/Footer | Show/Hide toggles |
    | Logo Position | Left, Center, Right |

Scenario: Layout settings stored in JSONB
  Given user configures layout
  When template saved
  Then layout_config contains:
    {
      "font_family": "Arial",
      "font_size": 10,
      "page_size": "A4",
      "orientation": "portrait",
      "show_header": true,
      "show_footer": true,
      "logo_position": "left"
    }
```

### AC-16: Permission Enforcement

```gherkin
Scenario: QA Inspector can create draft templates
  Given user with QA_INSPECTOR role
  When creating template
  Then can create and save as draft
  But cannot approve templates

Scenario: QA Manager can approve templates
  Given user with QA_MANAGER role
  When template in pending_approval
  Then can approve or reject
  And can activate templates

Scenario: Viewer cannot create templates
  Given user with VIEWER role
  When viewing templates list
  Then [+ New Template] button hidden
  And can only view template details
```

### AC-17: RLS Policy Enforcement

```gherkin
Scenario: Org isolation on template list
  Given User A from Org A and User B from Org B
  And templates exist in both orgs
  When User A requests GET /api/quality/coa-templates
  Then only Org A templates returned

Scenario: Cannot view template from different org
  Given template belongs to Org B
  When User A (Org A) requests GET /api/quality/coa-templates/:id
  Then 404 Not Found returned
```

### AC-18: Performance Requirements

```gherkin
Scenario: Template list performance
  Given 100 templates in organization
  When listing templates with pagination
  Then response time < 500ms

Scenario: Template preview performance
  Given template with 20 parameters
  When generating preview
  Then preview renders < 2 seconds

Scenario: Logo upload performance
  Given valid logo file (1MB)
  When uploading
  Then upload completes < 5 seconds
```

---

## Implementation Notes

### API Endpoints

```typescript
// =============================================================================
// CoA Template Endpoints
// =============================================================================

// GET /api/quality/coa-templates
interface CoATemplateListParams {
  status?: 'draft' | 'pending_approval' | 'approved' | 'archived';
  product_id?: string;
  product_type?: string;
  is_active?: boolean;
  search?: string;
  sort_by?: 'template_number' | 'name' | 'created_at' | 'version';
  sort_order?: 'asc' | 'desc';
  page?: number;
  limit?: number;
}

interface CoATemplate {
  id: string;
  org_id: string;
  template_number: string;
  name: string;
  description?: string;
  product_id?: string;
  product_name?: string;
  product_type?: string;
  header_template?: string;
  footer_template?: string;
  logo_url?: string;
  parameters_config: ParameterConfig[];
  compliance_statements: string[];
  layout_config: LayoutConfig;
  version: number;
  is_active: boolean;
  status: 'draft' | 'pending_approval' | 'approved' | 'archived';
  approved_by?: string;
  approved_at?: string;
  approval_notes?: string;
  effective_date?: string;
  expiry_date?: string;
  created_at: string;
  created_by: string;
  updated_at: string;
}

interface ParameterConfig {
  parameter_id: string;
  parameter_name?: string;
  display_name?: string;
  show_spec: boolean;
  show_method: boolean;
  order: number;
}

interface LayoutConfig {
  show_header: boolean;
  show_footer: boolean;
  show_logo: boolean;
  parameter_columns: string[];
  font_family: string;
  font_size: number;
  page_size: 'A4' | 'Letter' | 'Legal';
  orientation: 'portrait' | 'landscape';
  logo_position?: 'left' | 'center' | 'right';
}

// POST /api/quality/coa-templates
interface CreateCoATemplateRequest {
  name: string;
  description?: string;
  product_id?: string;
  product_type?: string;
  header_template?: string;
  footer_template?: string;
  parameters_config?: ParameterConfig[];
  compliance_statements?: string[];
  layout_config?: Partial<LayoutConfig>;
}

// PUT /api/quality/coa-templates/:id
interface UpdateCoATemplateRequest {
  name?: string;
  description?: string;
  header_template?: string;
  footer_template?: string;
  parameters_config?: ParameterConfig[];
  compliance_statements?: string[];
  layout_config?: Partial<LayoutConfig>;
}

// POST /api/quality/coa-templates/:id/approve
interface ApproveTemplateRequest {
  approval_notes?: string;
}

// POST /api/quality/coa-templates/:id/duplicate
interface DuplicateTemplateRequest {
  name: string;
}

// POST /api/quality/coa-templates/:id/upload-logo
// Form-data with file field

// GET /api/quality/coa-templates/:id/preview
interface PreviewTemplateResponse {
  html: string;
  sample_data: {
    product_name: string;
    batch_number: string;
    test_results: Array<{
      parameter: string;
      specification: string;
      result: string;
      method: string;
      status: 'pass' | 'fail';
    }>;
  };
}

// GET /api/quality/coa-templates/:id/versions
interface TemplateVersionsResponse {
  versions: Array<{
    version: number;
    approved_by: string;
    approved_at: string;
    change_summary: string;
  }>;
}
```

---

## Validation Schemas (Zod)

```typescript
import { z } from 'zod';

export const templateStatusEnum = z.enum(['draft', 'pending_approval', 'approved', 'archived']);
export const pageSizeEnum = z.enum(['A4', 'Letter', 'Legal']);
export const orientationEnum = z.enum(['portrait', 'landscape']);

export const parameterConfigSchema = z.object({
  parameter_id: z.string().uuid(),
  display_name: z.string().max(100).optional(),
  show_spec: z.boolean().default(true),
  show_method: z.boolean().default(true),
  order: z.number().int().min(0),
});

export const layoutConfigSchema = z.object({
  show_header: z.boolean().default(true),
  show_footer: z.boolean().default(true),
  show_logo: z.boolean().default(true),
  parameter_columns: z.array(z.string()).default(['name', 'specification', 'result', 'method', 'status']),
  font_family: z.string().default('Arial'),
  font_size: z.number().int().min(8).max(14).default(10),
  page_size: pageSizeEnum.default('A4'),
  orientation: orientationEnum.default('portrait'),
  logo_position: z.enum(['left', 'center', 'right']).optional(),
});

export const createCoATemplateSchema = z.object({
  name: z.string().min(3, 'Name must be at least 3 characters').max(200),
  description: z.string().max(1000).optional(),
  product_id: z.string().uuid().optional(),
  product_type: z.string().max(100).optional(),
  header_template: z.string().max(5000).optional(),
  footer_template: z.string().max(5000).optional(),
  parameters_config: z.array(parameterConfigSchema).default([]),
  compliance_statements: z.array(z.string().max(500)).default([]),
  layout_config: layoutConfigSchema.optional(),
}).refine(
  (data) => {
    // Must specify product_id OR product_type (or neither for global template)
    return !(data.product_id && data.product_type);
  },
  {
    message: 'Cannot specify both product_id and product_type',
  }
);

export const updateCoATemplateSchema = z.object({
  name: z.string().min(3).max(200).optional(),
  description: z.string().max(1000).optional(),
  header_template: z.string().max(5000).optional(),
  footer_template: z.string().max(5000).optional(),
  parameters_config: z.array(parameterConfigSchema).optional(),
  compliance_statements: z.array(z.string().max(500)).optional(),
  layout_config: layoutConfigSchema.partial().optional(),
});

export const approveTemplateSchema = z.object({
  approval_notes: z.string().max(1000).optional(),
});

export const duplicateTemplateSchema = z.object({
  name: z.string().min(3).max(200),
});

export const templateListQuerySchema = z.object({
  status: templateStatusEnum.optional(),
  product_id: z.string().uuid().optional(),
  product_type: z.string().optional(),
  is_active: z.boolean().optional(),
  search: z.string().min(1).optional(),
  sort_by: z.enum(['template_number', 'name', 'created_at', 'version']).default('created_at'),
  sort_order: z.enum(['asc', 'desc']).default('desc'),
  page: z.coerce.number().int().positive().default(1),
  limit: z.coerce.number().int().min(1).max(100).default(20),
});
```

---

## Service Layer

```typescript
// lib/services/coa-template-service.ts

export class CoATemplateService {
  /**
   * List templates with filtering and pagination
   */
  static async list(params: TemplateListParams): Promise<PaginatedResult<CoATemplate>>;

  /**
   * Get template by ID with parameters
   */
  static async getById(id: string): Promise<CoATemplate | null>;

  /**
   * Get active template for product or product type
   */
  static async getActiveTemplate(productId?: string, productType?: string): Promise<CoATemplate | null>;

  /**
   * Create new template
   */
  static async create(input: CreateCoATemplateInput): Promise<CoATemplate>;

  /**
   * Update template (draft only)
   */
  static async update(id: string, input: UpdateCoATemplateInput): Promise<CoATemplate>;

  /**
   * Submit template for approval
   */
  static async submitForApproval(id: string): Promise<CoATemplate>;

  /**
   * Approve template (QA Manager only)
   */
  static async approve(id: string, notes?: string, userId?: string): Promise<CoATemplate>;

  /**
   * Reject template back to draft
   */
  static async reject(id: string, reason: string): Promise<CoATemplate>;

  /**
   * Activate template (deactivates others)
   */
  static async activate(id: string): Promise<CoATemplate>;

  /**
   * Deactivate template
   */
  static async deactivate(id: string): Promise<CoATemplate>;

  /**
   * Duplicate template
   */
  static async duplicate(id: string, newName: string): Promise<CoATemplate>;

  /**
   * Delete template (draft only)
   */
  static async delete(id: string): Promise<void>;

  /**
   * Upload logo
   */
  static async uploadLogo(templateId: string, file: File): Promise<string>;

  /**
   * Generate preview HTML
   */
  static async generatePreview(id: string, useSampleData?: boolean): Promise<PreviewResponse>;

  /**
   * Get version history
   */
  static async getVersionHistory(id: string): Promise<TemplateVersion[]>;

  /**
   * Generate template number
   */
  static async generateTemplateNumber(): Promise<string>;
}
```

---

## Frontend Components

```
apps/frontend/app/(authenticated)/quality/
  coa-templates/
    page.tsx                       -- Templates list
    new/
      page.tsx                     -- Create template
    [id]/
      page.tsx                     -- Template detail/edit

components/quality/coa/
  CoATemplateDataTable.tsx         -- DataTable with filters
  CoATemplateFilters.tsx           -- Filter panel
  CoATemplateStatusBadge.tsx       -- Status badge
  CoATemplateDetail.tsx            -- Detail view
  CoATemplateBuilder.tsx           -- Template builder form
  TemplateHeaderEditor.tsx         -- Header text editor
  TemplateFooterEditor.tsx         -- Footer text editor
  TemplateParameterSelector.tsx    -- Parameter selection modal
  TemplateParameterList.tsx        -- Selected parameters list with reorder
  TemplateComplianceEditor.tsx     -- Compliance statements editor
  TemplateLayoutSettings.tsx       -- Layout configuration panel
  TemplateLogoUploader.tsx         -- Logo upload component
  TemplatePreview.tsx              -- Live preview component
  TemplateVersionHistory.tsx       -- Version history display
  ApproveTemplateModal.tsx         -- Approval modal
  DuplicateTemplateModal.tsx       -- Duplicate with new name
```

---

## Deliverables

### Database
- [ ] Migration: `coa_templates` table
- [ ] Migration: `coa_template_number_sequences` table
- [ ] Migration: `coa_template_versions` table
- [ ] Function: `generate_coa_template_number()`
- [ ] Function: `enforce_single_active_template()` trigger
- [ ] Function: `create_template_version_snapshot()` trigger
- [ ] RLS policies for all CoA template tables
- [ ] All performance indexes

### API Routes
- [ ] `GET /api/quality/coa-templates` - List with filters
- [ ] `GET /api/quality/coa-templates/:id` - Get detail
- [ ] `POST /api/quality/coa-templates` - Create template
- [ ] `PUT /api/quality/coa-templates/:id` - Update draft
- [ ] `DELETE /api/quality/coa-templates/:id` - Delete draft
- [ ] `POST /api/quality/coa-templates/:id/approve` - Approve template
- [ ] `POST /api/quality/coa-templates/:id/activate` - Activate template
- [ ] `POST /api/quality/coa-templates/:id/duplicate` - Duplicate template
- [ ] `POST /api/quality/coa-templates/:id/upload-logo` - Upload logo
- [ ] `GET /api/quality/coa-templates/:id/preview` - Preview rendering
- [ ] `GET /api/quality/coa-templates/:id/versions` - Version history

### Service Layer
- [ ] `CoATemplateService.list()` - List with pagination
- [ ] `CoATemplateService.getById()` - Get with parameters
- [ ] `CoATemplateService.getActiveTemplate()` - Get active for product/type
- [ ] `CoATemplateService.create()` - Create template
- [ ] `CoATemplateService.update()` - Update draft
- [ ] `CoATemplateService.approve()` - Approve workflow
- [ ] `CoATemplateService.activate()` - Activate template
- [ ] `CoATemplateService.duplicate()` - Clone template
- [ ] `CoATemplateService.uploadLogo()` - Logo upload
- [ ] `CoATemplateService.generatePreview()` - Preview HTML
- [ ] `CoATemplateService.getVersionHistory()` - Version history

### Validation
- [ ] `createCoATemplateSchema`
- [ ] `updateCoATemplateSchema`
- [ ] `approveTemplateSchema`
- [ ] `duplicateTemplateSchema`
- [ ] `templateListQuerySchema`
- [ ] `parameterConfigSchema`
- [ ] `layoutConfigSchema`

### Frontend
- [ ] Templates list page with filters
- [ ] Template detail/edit page
- [ ] Template builder form
- [ ] Parameter selector
- [ ] Logo uploader
- [ ] Template preview component
- [ ] Version history display
- [ ] Approval workflow UI
- [ ] Status badges

### Tests
- [ ] Unit tests: CoATemplateService methods (>80% coverage)
- [ ] Integration tests: All API endpoints
- [ ] Template versioning tests
- [ ] Active template enforcement tests
- [ ] RLS tests: Multi-tenancy isolation
- [ ] E2E: Full template creation and approval workflow

---

## Definition of Done

### Database
- [ ] All tables created with proper constraints
- [ ] Indexes optimize query performance
- [ ] RLS policies enforce org isolation
- [ ] Triggers work correctly (active template, versioning)
- [ ] Template number generation works

### API
- [ ] All endpoints return correct HTTP status codes
- [ ] Validation errors return 400 with detailed messages
- [ ] Cross-tenant access returns 404
- [ ] Response times meet NFRs

### Service
- [ ] Template CRUD operations work
- [ ] Approval workflow functions correctly
- [ ] Active template enforcement works
- [ ] Version snapshot creation works
- [ ] Logo upload to storage works

### Frontend
- [ ] Template builder UI functional
- [ ] Parameter selection works
- [ ] Preview renders correctly
- [ ] Approval workflow UI works
- [ ] Version history displays

### Testing
- [ ] Unit tests: >80% coverage on service
- [ ] Integration tests: All endpoints covered
- [ ] E2E tests: Template creation and approval workflow
- [ ] RLS tests: Multi-tenancy verified

---

## Risk Assessment

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| JSONB parameter config complexity | MEDIUM | LOW | Clear schema, validation, examples |
| Logo upload storage issues | MEDIUM | MEDIUM | Fallback to URL, file validation |
| Template preview performance | MEDIUM | LOW | Server-side rendering, caching |
| Version history size | LOW | LOW | Archive old versions after X years |
| Active template enforcement race | LOW | LOW | Database trigger with row locking |

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-01-15 | Initial story creation | ARCHITECT-AGENT |

---

**Document Status**: Ready for Implementation
**Created**: 2025-01-15
**Lines**: ~980
**Complexity**: M (Medium)
**Phase**: 3 (CoA & HACCP)
