# 06.2 - Quality Holds CRUD

**Priority**: P0 (MVP - Phase 1A)
**Story Points**: M (Medium)
**Type**: backend + frontend

**State:** ready
**Estimate:** M (medium story)
**Primary PRD:** `docs/1-BASELINE/product/modules/quality.md` (FR-QA-002)
**Architecture:** `docs/1-BASELINE/architecture/modules/quality.md`
**Phase:** 1A (Core Quality)

## Goal

Implement quality hold management system to block inventory (LPs, WOs, batches) from consumption pending investigation. Includes hold creation, release workflow, disposition decision, and LP blocking logic integration.

## MVP Scope

This story implements Phase 1A (Core Quality) functionality only.

**MVP Includes**:
- Quality holds CRUD operations
- Hold creation with reason and priority
- Quality hold items (generic reference: LP/WO/batch)
- Hold release workflow with disposition decision
- LP blocking logic integration
- Hold aging alerts (basic)
- Hold status management (active/released/disposed)

**Deferred to Phase 1B+**:
- Advanced hold aging analytics
- Hold escalation workflows
- Bulk hold operations
- Hold templates
- Integration with NCR workflow (Phase 2 - Story 06.13)
- Automated hold creation from CCP deviations (Phase 3)

## Dependencies

### Cross-Epic Dependencies
- **01.1** - Org Context + Base RLS (organizations, users tables) - **REQUIRED**
- **01.5** - Users CRUD (user assignments for held_by, released_by) - **REQUIRED**
- **02.1** - Products CRUD (products table for reference) - **REQUIRED**
- **05.1** - License Plates Table (LP blocking integration) - **REQUIRED**
- **05.7** - LP QA Status Management (QA status field updates) - **REQUIRED**
- **04.3** - Work Orders Table (WO reference) - OPTIONAL
- **06.1** - Quality Status Types (status enum definitions) - **REQUIRED**

### Internal Dependencies
- **06.0** - Quality Settings (quality_settings table for hold configuration) - **REQUIRED**

## Database Migration

### Migration: Quality Holds Table

**File:** `supabase/migrations/062_create_quality_holds_table.sql`

```sql
-- Quality Holds Table
CREATE TABLE quality_holds (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    hold_number TEXT NOT NULL,
    reason TEXT NOT NULL,
    hold_type TEXT NOT NULL CHECK (hold_type IN ('qa_pending', 'investigation', 'recall', 'quarantine')),
    status TEXT NOT NULL DEFAULT 'active' CHECK (status IN ('active', 'released', 'disposed')),
    priority TEXT NOT NULL DEFAULT 'medium' CHECK (priority IN ('low', 'medium', 'high', 'critical')),
    held_by UUID NOT NULL REFERENCES users(id),
    held_at TIMESTAMPTZ NOT NULL DEFAULT now(),
    released_by UUID REFERENCES users(id),
    released_at TIMESTAMPTZ,
    release_notes TEXT,
    disposition TEXT CHECK (disposition IN ('release', 'rework', 'scrap', 'return')),
    ncr_id UUID REFERENCES ncr_reports(id),
    created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
    created_by UUID REFERENCES users(id),
    updated_by UUID REFERENCES users(id),

    CONSTRAINT unique_hold_number_per_org UNIQUE(org_id, hold_number),
    CONSTRAINT released_fields_consistency CHECK (
        (status = 'released' AND released_by IS NOT NULL AND released_at IS NOT NULL) OR
        (status != 'released')
    ),
    CONSTRAINT disposition_on_release CHECK (
        (status = 'released' AND disposition IS NOT NULL) OR
        (status != 'released')
    )
);

-- Quality Hold Items Table (Generic Reference)
CREATE TABLE quality_hold_items (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    hold_id UUID NOT NULL REFERENCES quality_holds(id) ON DELETE CASCADE,
    reference_type TEXT NOT NULL CHECK (reference_type IN ('lp', 'wo', 'batch')),
    reference_id UUID NOT NULL,
    quantity_held DECIMAL(15,4),
    uom TEXT,
    location_id UUID REFERENCES locations(id),
    notes TEXT,
    created_at TIMESTAMPTZ NOT NULL DEFAULT now(),

    CONSTRAINT unique_hold_item_per_hold UNIQUE(hold_id, reference_type, reference_id)
);

-- Indexes for Performance
CREATE INDEX idx_quality_holds_org_status ON quality_holds(org_id, status);
CREATE INDEX idx_quality_holds_org_held_at ON quality_holds(org_id, held_at DESC);
CREATE INDEX idx_quality_holds_org_priority ON quality_holds(org_id, priority) WHERE status = 'active';
CREATE INDEX idx_quality_holds_ncr ON quality_holds(ncr_id) WHERE ncr_id IS NOT NULL;
CREATE INDEX idx_quality_hold_items_hold ON quality_hold_items(hold_id);
CREATE INDEX idx_quality_hold_items_reference ON quality_hold_items(reference_type, reference_id);

-- RLS Policies
ALTER TABLE quality_holds ENABLE ROW LEVEL SECURITY;
ALTER TABLE quality_hold_items ENABLE ROW LEVEL SECURITY;

-- Quality Holds Policies
CREATE POLICY "quality_holds_org_isolation"
    ON quality_holds
    FOR ALL
    USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

CREATE POLICY "quality_holds_insert"
    ON quality_holds
    FOR INSERT
    WITH CHECK (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

CREATE POLICY "quality_holds_update"
    ON quality_holds
    FOR UPDATE
    USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

-- Quality Hold Items Policies
CREATE POLICY "quality_hold_items_org_isolation"
    ON quality_hold_items
    FOR ALL
    USING (
        EXISTS (
            SELECT 1 FROM quality_holds
            WHERE quality_holds.id = quality_hold_items.hold_id
            AND quality_holds.org_id = (SELECT org_id FROM users WHERE id = auth.uid())
        )
    );

-- Trigger for auto-numbering
CREATE OR REPLACE FUNCTION generate_hold_number()
RETURNS TRIGGER AS $$
BEGIN
    IF NEW.hold_number IS NULL OR NEW.hold_number = '' THEN
        NEW.hold_number := 'QH-' ||
            TO_CHAR(CURRENT_DATE, 'YYYYMMDD') || '-' ||
            LPAD(
                (
                    SELECT COALESCE(MAX(
                        CAST(
                            SUBSTRING(hold_number FROM '[0-9]+$') AS INTEGER
                        )
                    ), 0) + 1
                    FROM quality_holds
                    WHERE org_id = NEW.org_id
                    AND hold_number LIKE 'QH-' || TO_CHAR(CURRENT_DATE, 'YYYYMMDD') || '-%'
                )::TEXT,
                4,
                '0'
            );
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER set_hold_number
    BEFORE INSERT ON quality_holds
    FOR EACH ROW
    EXECUTE FUNCTION generate_hold_number();

-- Trigger for updated_at
CREATE TRIGGER set_quality_holds_updated_at
    BEFORE UPDATE ON quality_holds
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- Comments
COMMENT ON TABLE quality_holds IS 'Quality holds to block inventory from consumption pending investigation';
COMMENT ON TABLE quality_hold_items IS 'Items (LPs, WOs, batches) placed on quality hold';
COMMENT ON COLUMN quality_holds.hold_type IS 'qa_pending (awaiting inspection), investigation (under review), recall (safety recall), quarantine (isolated)';
COMMENT ON COLUMN quality_holds.priority IS 'low, medium, high, critical (impacts aging alerts)';
COMMENT ON COLUMN quality_holds.disposition IS 'release (approve), rework (reprocess), scrap (destroy), return (send back to supplier)';
```

## Acceptance Criteria (Given/When/Then)

### Hold Creation

- **AC-2.1:** GIVEN user is on Quality Holds list page, WHEN user clicks [+ Create Hold] button, THEN Create Hold modal opens within 200ms showing form with fields: reason (required), hold_type (dropdown), priority (dropdown), and items selection.

- **AC-2.2:** GIVEN user is creating a hold, WHEN user enters reason "Failed metal detection test" and selects hold_type "investigation" and priority "high", THEN form validates successfully.

- **AC-2.3:** GIVEN user has selected hold parameters, WHEN user clicks [Add Items] and selects 3 license plates, THEN items table shows 3 rows with LP numbers, current location, and quantity.

- **AC-2.4:** GIVEN user has completed hold form, WHEN user clicks [Create Hold], THEN hold saved with auto-generated hold_number format "QH-YYYYMMDD-NNNN" (e.g., "QH-20251216-0001"), status "active", held_by current user ID, held_at current timestamp.

- **AC-2.5:** GIVEN hold creation succeeds, WHEN response received, THEN toast notification shows "Hold QH-20251216-0001 created successfully" and user redirected to Hold Detail page.

- **AC-2.6:** GIVEN user tries to create hold without reason, WHEN [Create Hold] clicked, THEN validation error "Reason is required" displays under reason field.

- **AC-2.7:** GIVEN user tries to create hold without selecting items, WHEN [Create Hold] clicked, THEN validation error "At least one item must be added to the hold" displays.

### Hold Detail View

- **AC-2.8:** GIVEN user navigates to Hold Detail page, WHEN page loads, THEN hold details display within 500ms showing: hold_number, status badge, priority badge, reason, hold_type, held_by user name, held_at timestamp, and items table.

- **AC-2.9:** GIVEN hold has 5 items (3 LPs, 2 WOs), WHEN items table renders, THEN each row shows: reference_type icon, reference_id (clickable link), quantity_held, uom, location_id (if LP), and notes.

- **AC-2.10:** GIVEN hold status is "active", WHEN detail page loads, THEN [Release Hold] button visible in header, [Edit] and [Delete] buttons visible (if user has permission).

- **AC-2.11:** GIVEN hold status is "released", WHEN detail page loads, THEN release information section shows: released_by user name, released_at timestamp, disposition (badge), and release_notes.

### Hold Release Workflow

- **AC-2.12:** GIVEN user is viewing active hold, WHEN user clicks [Release Hold] button, THEN Release Hold modal opens showing disposition options (release/rework/scrap/return) and release_notes textarea.

- **AC-2.13:** GIVEN user is releasing hold, WHEN user selects disposition "release" and enters notes "All items passed re-inspection", THEN [Confirm Release] button enabled.

- **AC-2.14:** GIVEN user confirms release, WHEN [Confirm Release] clicked, THEN hold status updated to "released", released_by set to current user, released_at set to current timestamp, disposition and release_notes saved.

- **AC-2.15:** GIVEN hold release succeeds, WHEN response received, THEN toast notification shows "Hold QH-20251216-0001 released successfully" and hold detail refreshes showing release information.

- **AC-2.16:** GIVEN user tries to release hold without selecting disposition, WHEN [Confirm Release] clicked, THEN validation error "Disposition decision is required" displays.

- **AC-2.17:** GIVEN hold has disposition "scrap", WHEN release confirmed, THEN all hold items with reference_type "lp" have qa_status updated to "scrap" in license_plates table.

### LP Blocking Logic Integration

- **AC-2.18:** GIVEN license plate LP-001 is added to active hold, WHEN hold saved, THEN LP-001 qa_status updated to "hold" in license_plates table.

- **AC-2.19:** GIVEN LP-001 has qa_status "hold", WHEN user attempts to consume LP-001 in production (picking operation), THEN system blocks transaction and displays error "License plate LP-001 is on quality hold QH-20251216-0001. Cannot consume."

- **AC-2.20:** GIVEN LP-001 is on hold and hold is released with disposition "release", WHEN release confirmed, THEN LP-001 qa_status updated to "passed" in license_plates table.

- **AC-2.21:** GIVEN LP-001 is on hold and hold is released with disposition "scrap", WHEN release confirmed, THEN LP-001 qa_status updated to "scrap" and quantity_available set to 0.

- **AC-2.22:** GIVEN multiple LPs are on same hold, WHEN hold released with disposition "rework", THEN all LP qa_status values updated to "pending" for re-inspection.

### Hold Aging Alerts

- **AC-2.23:** GIVEN hold with priority "high" is active for >48 hours, WHEN Hold List page loads, THEN hold row displays yellow warning icon with tooltip "Hold aging: 52 hours".

- **AC-2.24:** GIVEN hold with priority "critical" is active for >24 hours, WHEN Hold List page loads, THEN hold row displays red critical icon with tooltip "Hold aging: 30 hours (CRITICAL)".

- **AC-2.25:** GIVEN hold with priority "medium" is active for >72 hours, WHEN background job runs, THEN email notification sent to QA Manager with subject "Quality Hold Aging Alert: QH-20251216-0001".

- **AC-2.26:** GIVEN user is on Hold Detail page, WHEN hold is >48 hours old, THEN banner displays at top "This hold has been active for 3 days. Please review and release or escalate."

### Hold List and Filters

- **AC-2.27:** GIVEN user navigates to Quality Holds list page, WHEN page loads, THEN holds table displays within 1 second showing columns: hold_number, status, priority, reason (truncated), items_count, held_at, held_by, aging indicator.

- **AC-2.28:** GIVEN holds list has 50 active holds, WHEN user applies filter status "active" and priority "high", THEN table shows only holds matching both criteria within 500ms.

- **AC-2.29:** GIVEN user searches for hold_number "QH-20251216-0001", WHEN search input changes, THEN table filters to show only matching hold within 300ms (debounced).

- **AC-2.30:** GIVEN user clicks on hold_number link in table, WHEN clicked, THEN navigates to Hold Detail page for that hold.

### NCR Linkage (Phase 2 Preview)

- **AC-2.31:** GIVEN hold is linked to NCR (ncr_id not null), WHEN Hold Detail page loads, THEN "Related NCR" section shows NCR number (clickable link) and NCR title.

- **AC-2.32:** GIVEN hold is not linked to NCR, WHEN Hold Detail page loads, THEN "Related NCR" section shows "No NCR linked" with [Create NCR from Hold] button (disabled in Phase 1A).

### Permission Enforcement

- **AC-2.33:** GIVEN user with VIEWER role, WHEN Quality Holds page loads, THEN [+ Create Hold] button hidden, [Edit] and [Delete] buttons hidden in Hold Detail.

- **AC-2.34:** GIVEN user without Quality write permission, WHEN attempting to create hold via API, THEN API returns 403 Forbidden with message "Insufficient permissions to create quality holds".

- **AC-2.35:** GIVEN user with QA Inspector role, WHEN viewing Hold Detail, THEN [Release Hold] button visible only if user is assigned to hold (held_by = current user) or user has QA Manager role.

## Implementation Notes

### API Endpoints

```typescript
// GET /api/quality/holds
// Returns: Paginated list of holds with filters
interface HoldsListResponse {
  holds: QualityHoldSummary[];
  pagination: {
    total: number;
    page: number;
    limit: number;
    total_pages: number;
  };
  filters_applied: {
    status?: string[];
    priority?: string[];
    hold_type?: string[];
    date_range?: { from: string; to: string };
  };
}

interface QualityHoldSummary {
  id: string;
  hold_number: string;
  status: 'active' | 'released' | 'disposed';
  priority: 'low' | 'medium' | 'high' | 'critical';
  hold_type: 'qa_pending' | 'investigation' | 'recall' | 'quarantine';
  reason: string; // Truncated to 100 chars for list
  items_count: number;
  held_by: { id: string; name: string };
  held_at: string;
  aging_hours: number; // Calculated field
  aging_status: 'normal' | 'warning' | 'critical'; // Based on priority thresholds
}

// GET /api/quality/holds/:id
// Returns: Hold detail with items
interface HoldDetailResponse {
  hold: QualityHold;
  items: QualityHoldItem[];
  ncr?: {
    id: string;
    ncr_number: string;
    title: string;
    status: string;
  };
}

interface QualityHold {
  id: string;
  org_id: string;
  hold_number: string;
  reason: string;
  hold_type: 'qa_pending' | 'investigation' | 'recall' | 'quarantine';
  status: 'active' | 'released' | 'disposed';
  priority: 'low' | 'medium' | 'high' | 'critical';
  held_by: { id: string; name: string; email: string };
  held_at: string;
  released_by?: { id: string; name: string; email: string };
  released_at?: string;
  release_notes?: string;
  disposition?: 'release' | 'rework' | 'scrap' | 'return';
  ncr_id?: string;
  created_at: string;
  updated_at: string;
}

interface QualityHoldItem {
  id: string;
  hold_id: string;
  reference_type: 'lp' | 'wo' | 'batch';
  reference_id: string;
  reference_display: string; // LP number, WO number, or batch number
  quantity_held?: number;
  uom?: string;
  location_id?: string;
  location_name?: string; // Joined from locations table
  notes?: string;
  created_at: string;
}

// POST /api/quality/holds
// Creates new hold with items
interface CreateHoldRequest {
  reason: string; // Required, 10-500 chars
  hold_type: 'qa_pending' | 'investigation' | 'recall' | 'quarantine';
  priority?: 'low' | 'medium' | 'high' | 'critical'; // Default: medium
  items: {
    reference_type: 'lp' | 'wo' | 'batch';
    reference_id: string;
    quantity_held?: number;
    uom?: string;
    notes?: string;
  }[];
}

interface CreateHoldResponse {
  hold: QualityHold;
  items: QualityHoldItem[];
  lp_updates?: { // LPs that had qa_status updated to 'hold'
    lp_id: string;
    lp_number: string;
    previous_status: string;
    new_status: 'hold';
  }[];
}

// PATCH /api/quality/holds/:id/release
// Releases hold with disposition
interface ReleaseHoldRequest {
  disposition: 'release' | 'rework' | 'scrap' | 'return'; // Required
  release_notes: string; // Required, 10-1000 chars
}

interface ReleaseHoldResponse {
  hold: QualityHold; // Updated with released_* fields
  lp_updates?: { // LPs that had qa_status updated based on disposition
    lp_id: string;
    lp_number: string;
    previous_status: 'hold';
    new_status: string; // 'passed', 'pending', 'scrap', etc.
    disposition_action: string;
  }[];
}

// GET /api/quality/holds/active
// Returns: Active holds only (status = 'active')
interface ActiveHoldsResponse {
  holds: QualityHoldSummary[];
  aging_summary: {
    normal: number; // Count of holds within aging threshold
    warning: number; // Count of holds approaching threshold
    critical: number; // Count of holds exceeding threshold
  };
}

// GET /api/quality/holds/stats
// Returns: Hold statistics for dashboard
interface HoldStatsResponse {
  active_count: number;
  released_today: number;
  aging_critical: number;
  by_priority: {
    low: number;
    medium: number;
    high: number;
    critical: number;
  };
  by_type: {
    qa_pending: number;
    investigation: number;
    recall: number;
    quarantine: number;
  };
  avg_resolution_time_hours: number; // Average time from held_at to released_at
}

// DELETE /api/quality/holds/:id
// Soft-delete hold (only if status = 'active' and no items)
// Returns: 204 No Content
```

### Database Queries

**Hold Creation with LP Blocking:**
```sql
-- Step 1: Insert hold
INSERT INTO quality_holds (org_id, reason, hold_type, priority, held_by)
VALUES ($1, $2, $3, $4, auth.uid())
RETURNING *;

-- Step 2: Insert hold items
INSERT INTO quality_hold_items (hold_id, reference_type, reference_id, quantity_held, uom, notes)
VALUES ($1, $2, $3, $4, $5, $6);

-- Step 3: Update LP qa_status to 'hold' for all LP items
UPDATE license_plates
SET qa_status = 'hold',
    updated_at = now(),
    updated_by = auth.uid()
WHERE id IN (
    SELECT reference_id
    FROM quality_hold_items
    WHERE hold_id = $1 AND reference_type = 'lp'
)
AND org_id = $2;
```

**Hold Release with Disposition:**
```sql
-- Step 1: Update hold
UPDATE quality_holds
SET status = 'released',
    released_by = auth.uid(),
    released_at = now(),
    disposition = $2,
    release_notes = $3,
    updated_at = now(),
    updated_by = auth.uid()
WHERE id = $1 AND org_id = $4
RETURNING *;

-- Step 2: Update LP qa_status based on disposition
-- If disposition = 'release': qa_status = 'passed'
-- If disposition = 'rework': qa_status = 'pending'
-- If disposition = 'scrap': qa_status = 'scrap', quantity_available = 0
-- If disposition = 'return': qa_status = 'rejected'

UPDATE license_plates
SET qa_status = CASE
    WHEN $2 = 'release' THEN 'passed'
    WHEN $2 = 'rework' THEN 'pending'
    WHEN $2 = 'scrap' THEN 'scrap'
    WHEN $2 = 'return' THEN 'rejected'
END,
quantity_available = CASE
    WHEN $2 = 'scrap' THEN 0
    ELSE quantity_available
END,
updated_at = now(),
updated_by = auth.uid()
WHERE id IN (
    SELECT reference_id
    FROM quality_hold_items
    WHERE hold_id = $1 AND reference_type = 'lp'
)
AND org_id = $4;
```

**Aging Holds Query:**
```sql
SELECT
    qh.*,
    EXTRACT(EPOCH FROM (now() - qh.held_at)) / 3600 AS aging_hours,
    CASE
        WHEN qh.priority = 'critical' AND (now() - qh.held_at) > INTERVAL '24 hours' THEN 'critical'
        WHEN qh.priority = 'high' AND (now() - qh.held_at) > INTERVAL '48 hours' THEN 'critical'
        WHEN qh.priority = 'critical' AND (now() - qh.held_at) > INTERVAL '12 hours' THEN 'warning'
        WHEN qh.priority = 'high' AND (now() - qh.held_at) > INTERVAL '24 hours' THEN 'warning'
        ELSE 'normal'
    END AS aging_status,
    (SELECT COUNT(*) FROM quality_hold_items WHERE hold_id = qh.id) AS items_count
FROM quality_holds qh
WHERE qh.org_id = $1
AND qh.status = 'active'
ORDER BY qh.priority DESC, qh.held_at ASC
LIMIT 20 OFFSET $2;
```

### Frontend Components

```
apps/frontend/app/(authenticated)/quality/holds/
├── page.tsx                    -- Holds list with filters
├── [id]/page.tsx              -- Hold detail page
├── new/page.tsx               -- Create hold page (optional, or modal)
└── components/
    ├── HoldTable.tsx          -- Holds list table with aging indicators
    ├── HoldForm.tsx           -- Create/edit hold form
    ├── HoldItemsTable.tsx     -- Items table with reference links
    ├── ReleaseModal.tsx       -- Release hold modal with disposition
    ├── HoldStatusBadge.tsx    -- Status badge component
    ├── HoldPriorityBadge.tsx  -- Priority badge component
    ├── AgingIndicator.tsx     -- Aging warning/critical icons
    └── HoldStats.tsx          -- Stats cards for dashboard
```

### Services

**File:** `lib/services/quality-hold-service.ts`

```typescript
export class QualityHoldService {
  static async createHold(data: CreateHoldRequest, orgId: string, userId: string): Promise<CreateHoldResponse> {
    // 1. Validate items exist and belong to org
    // 2. Insert hold record
    // 3. Insert hold_items
    // 4. Update LP qa_status to 'hold'
    // 5. Return hold with items and LP updates
  }

  static async getHoldById(holdId: string, orgId: string): Promise<HoldDetailResponse> {
    // Join hold with items, users, locations, NCR (if linked)
  }

  static async releaseHold(
    holdId: string,
    disposition: string,
    releaseNotes: string,
    orgId: string,
    userId: string
  ): Promise<ReleaseHoldResponse> {
    // 1. Validate hold exists and status = 'active'
    // 2. Update hold with release fields
    // 3. Update LP qa_status based on disposition
    // 4. Return updated hold and LP updates
  }

  static async getActiveHolds(orgId: string): Promise<ActiveHoldsResponse> {
    // Query active holds with aging calculations
  }

  static async calculateAgingStatus(priority: string, heldAt: Date): string {
    // Critical: 24h threshold
    // High: 48h threshold
    // Medium: 72h threshold
    // Low: 168h (7d) threshold
  }

  static async blockLPConsumption(lpId: string, orgId: string): Promise<boolean> {
    // Check if LP is on active hold, return true to block
    const hold = await this.getActiveLPHold(lpId, orgId);
    return !!hold;
  }

  static async getActiveLPHold(lpId: string, orgId: string): Promise<QualityHold | null> {
    // Query for active hold containing this LP
  }
}
```

### Validation (Zod)

**File:** `lib/validation/quality-hold-validation.ts`

```typescript
import { z } from 'zod';

export const createHoldSchema = z.object({
  reason: z.string()
    .min(10, 'Reason must be at least 10 characters')
    .max(500, 'Reason must not exceed 500 characters'),
  hold_type: z.enum(['qa_pending', 'investigation', 'recall', 'quarantine']),
  priority: z.enum(['low', 'medium', 'high', 'critical']).default('medium'),
  items: z.array(
    z.object({
      reference_type: z.enum(['lp', 'wo', 'batch']),
      reference_id: z.string().uuid('Invalid reference ID'),
      quantity_held: z.number().positive().optional(),
      uom: z.string().max(20).optional(),
      notes: z.string().max(500).optional(),
    })
  ).min(1, 'At least one item must be added to the hold'),
});

export const releaseHoldSchema = z.object({
  disposition: z.enum(['release', 'rework', 'scrap', 'return']),
  release_notes: z.string()
    .min(10, 'Release notes must be at least 10 characters')
    .max(1000, 'Release notes must not exceed 1000 characters'),
});

export type CreateHoldInput = z.infer<typeof createHoldSchema>;
export type ReleaseHoldInput = z.infer<typeof releaseHoldSchema>;
```

### LP Blocking Integration

**File:** `lib/services/lp-validation-service.ts` (Update existing service)

```typescript
export class LPValidationService {
  static async validateLPForConsumption(lpId: string, orgId: string): Promise<ValidationResult> {
    // Check if LP has qa_status = 'hold'
    const lp = await this.getLPById(lpId, orgId);

    if (lp.qa_status === 'hold') {
      // Get active hold details
      const hold = await QualityHoldService.getActiveLPHold(lpId, orgId);

      if (hold) {
        return {
          valid: false,
          error: `License plate ${lp.lp_number} is on quality hold ${hold.hold_number}. Cannot consume.`,
          blockingHold: hold,
        };
      }
    }

    return { valid: true };
  }
}
```

### Aging Alert Background Job

**File:** `supabase/functions/quality-hold-aging-alert/index.ts`

```typescript
// Edge Function: Runs every 6 hours
// Queries holds exceeding aging thresholds
// Sends email notifications to QA Managers

Deno.serve(async (req) => {
  const { orgId } = await req.json();

  // Query aging holds
  const agingHolds = await getAgingHolds(orgId);

  // Group by priority
  const critical = agingHolds.filter(h => h.aging_status === 'critical');
  const warning = agingHolds.filter(h => h.aging_status === 'warning');

  // Send notification if critical or warning holds exist
  if (critical.length > 0 || warning.length > 0) {
    await sendAgingAlertEmail({
      orgId,
      critical,
      warning,
    });
  }

  return new Response(JSON.stringify({ success: true }));
});
```

### Hold Auto-Numbering Pattern

Format: `QH-YYYYMMDD-NNNN`
- **QH**: Quality Hold prefix
- **YYYYMMDD**: Date (e.g., 20251216)
- **NNNN**: Sequential number per day (0001, 0002, ...)

Example: `QH-20251216-0001`

Implemented via database trigger (see migration above).

## Deliverables

- [ ] Migration 062: quality_holds and quality_hold_items tables with RLS policies
- [ ] Hold auto-numbering trigger (QH-YYYYMMDD-NNNN format)
- [ ] GET /api/quality/holds (list with filters)
- [ ] GET /api/quality/holds/:id (detail with items)
- [ ] POST /api/quality/holds (create with items)
- [ ] PATCH /api/quality/holds/:id/release (release with disposition)
- [ ] GET /api/quality/holds/active (active holds)
- [ ] GET /api/quality/holds/stats (dashboard stats)
- [ ] QualityHoldService with LP blocking logic
- [ ] LP consumption validation integration
- [ ] Holds list page with filters and aging indicators
- [ ] Hold detail page with items table
- [ ] Create hold modal/page with items selection
- [ ] Release hold modal with disposition selector
- [ ] Hold status and priority badge components
- [ ] Aging indicator component with tooltips
- [ ] Zod validation schemas (createHoldSchema, releaseHoldSchema)
- [ ] Unit tests for QualityHoldService (>80% coverage)
- [ ] Integration tests for all API endpoints
- [ ] E2E test: Create hold -> Block LP consumption -> Release hold

## Test Strategy

### Unit Tests

**Hold Service Tests:**
- Create hold with valid data returns hold with auto-generated number
- Create hold without items returns validation error
- Release hold updates status, released_by, released_at, disposition
- Release hold with disposition 'release' updates LP qa_status to 'passed'
- Release hold with disposition 'scrap' updates LP qa_status to 'scrap' and quantity to 0
- Calculate aging status returns 'critical' for critical priority hold >24h old
- Block LP consumption returns true if LP is on active hold
- Get active holds returns only holds with status 'active'

**Validation Tests:**
- createHoldSchema accepts valid hold data
- createHoldSchema rejects reason <10 chars
- createHoldSchema rejects empty items array
- releaseHoldSchema rejects release_notes <10 chars
- releaseHoldSchema accepts valid disposition values

### Integration Tests

**API Endpoint Tests:**
- POST /api/quality/holds creates hold and returns 201
- POST /api/quality/holds without reason returns 400 validation error
- GET /api/quality/holds/:id returns hold detail with items
- GET /api/quality/holds/:id for non-existent hold returns 404
- PATCH /api/quality/holds/:id/release updates hold and returns 200
- PATCH /api/quality/holds/:id/release without disposition returns 400
- GET /api/quality/holds with filters returns filtered results
- DELETE /api/quality/holds/:id soft-deletes hold and returns 204

**RLS Policy Tests:**
- User from org A cannot read holds from org B
- User from org A cannot update holds from org B
- Unauthenticated request returns 401

### E2E Tests

**Hold Workflow:**
1. Create hold with 2 LPs
2. Verify LPs have qa_status 'hold'
3. Attempt to consume LP in production (should block)
4. Release hold with disposition 'release'
5. Verify LPs have qa_status 'passed'
6. Verify LP can now be consumed

**Aging Alert:**
1. Create hold with priority 'critical'
2. Advance system time by 25 hours (mock)
3. Load holds list
4. Verify aging indicator shows 'critical' status

## Definition of Done

- [ ] quality_holds and quality_hold_items tables created with RLS policies
- [ ] Hold auto-numbering generates QH-YYYYMMDD-NNNN format
- [ ] All API endpoints implemented and tested (>80% coverage)
- [ ] Hold creation with items works end-to-end
- [ ] Hold release workflow updates hold status and LP qa_status correctly
- [ ] LP blocking logic prevents consumption of LPs on hold
- [ ] Disposition logic correctly updates LP qa_status based on disposition type
- [ ] Holds list displays within 1 second for 100+ holds
- [ ] Hold detail page loads within 500ms
- [ ] Aging indicators display correctly based on priority thresholds
- [ ] Validation errors display clearly in UI
- [ ] Permission checks enforce read/write access correctly
- [ ] Unit tests achieve >80% coverage
- [ ] Integration tests cover all API endpoints
- [ ] E2E test validates full hold lifecycle
- [ ] Migration tested on dev/staging environments
- [ ] Documentation updated with API endpoint specs
- [ ] Code review completed and approved
- [ ] QA team sign-off received

---

**Story Dependencies Resolved:**
- 01.1 (Org Context) - REQUIRED
- 01.5 (Users CRUD) - REQUIRED
- 02.1 (Products CRUD) - REQUIRED
- 05.1 (License Plates) - REQUIRED
- 05.7 (LP QA Status) - REQUIRED
- 06.0 (Quality Settings) - REQUIRED
- 06.1 (Quality Status Types) - REQUIRED

**Unblocks:**
- 06.5 (Incoming Inspection) - Can create holds from failed inspections
- 06.9 (Basic NCR Creation) - Can link NCR to hold
- 06.13 (NCR Workflow) - Full NCR-hold integration

**Estimated Effort:** 2-3 days (1 developer)
- Database migration: 0.5 day
- API endpoints: 1 day
- Frontend components: 1 day
- LP blocking integration: 0.5 day
- Testing: 0.5-1 day
