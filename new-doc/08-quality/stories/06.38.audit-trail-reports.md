# 06.38 - Audit Trail Reports

**Priority**: P0 (MVP)
**Story Points**: M (Medium)
**Type**: fullstack
**Phase**: 4 (Analytics & Reporting)
**Model**: OPUS

**State:** ready
**Estimate:** M (3-4 days)
**Primary PRD:** `docs/1-BASELINE/product/modules/quality.md` (FR-QA-021, Section 16.2)
**Architecture:** `docs/1-BASELINE/architecture/modules/quality.md` (quality_audit_log table)

---

## Goal

Implement comprehensive audit trail query, reporting, and export capabilities to support FDA 21 CFR Part 11 compliance. Enable QA Managers and auditors to search, filter, and export complete change histories for inspections, NCRs, specifications, and CAPA records with full traceability (who, what, when, why).

---

## Food Safety Compliance

This story is **critical for regulatory compliance**:

- [x] **FDA 21 CFR Part 11** - Electronic records and signatures require complete audit trail
- [x] **ISO 9001:2015** - Clause 7.5 requires documented information and change control
- [x] **HACCP** - Audit trail for CCP monitoring and deviation records
- [x] **Immutable Audit Log** - INSERT only, no UPDATE/DELETE allowed

**Regulatory Context:**
- FDA inspections require proof of data integrity (who changed what, when, why)
- Audit trail retention: minimum 2 years (configurable up to 10 years)
- Change reason required for critical fields (quality status, NCR severity, CAPA actions)
- Audit trail must include: user ID, timestamp, old value, new value, change reason
- Electronic signatures require audit trail of signature events

---

## MVP Scope

This story implements Phase 4 (Analytics & Reporting) functionality. Audit Trail Reports are essential for compliance audits and internal quality reviews.

**MVP Includes**:
- `quality_audit_log` table (immutable, INSERT-only)
- Audit trail query interface with filters (entity type, entity ID, action, user, date range)
- Audit trail list view (DataTable with pagination)
- Audit trail detail view (old value vs new value comparison)
- Audit trail export (CSV, PDF)
- Change history comparison (side-by-side diff)
- Audit trail search (full-text search on change reason, notes)
- Audit trail retention policy (archive after 2 years, configurable)
- GET /api/quality/audit-trail (list with filters)
- GET /api/quality/audit-trail/:id (detail with diff)
- POST /api/quality/audit-trail/export (CSV/PDF export)

**Deferred to Phase 4+**: Advanced analytics on audit trail (user activity heatmap, change frequency trends), integration with external audit tools.

---

## User Story

As a **QA Manager**, I want to **query and export audit trail records for quality entities** so that **I can demonstrate compliance during FDA audits and investigate data integrity issues**.

As an **Internal Auditor**, I want to **view complete change histories with old/new value comparisons** so that **I can verify that changes were authorized and properly documented**.

---

## Scope

**In scope (this story)**
- `quality_audit_log` table with immutable RLS policy
- Audit trail query interface (entity type, entity ID, action, user, date range)
- Audit trail list DataTable with filters
- Audit trail detail view (old vs new value comparison)
- Audit trail export (CSV, PDF)
- Change history timeline view
- Full-text search on change reason and notes
- Audit trail retention policy (archive after 2 years)
- GET /api/quality/audit-trail (paginated list)
- GET /api/quality/audit-trail/:id (detail)
- POST /api/quality/audit-trail/export (CSV/PDF)

**Out of scope (this story)**
- User activity analytics (heatmap, frequency trends) - story 06.39
- Integration with external audit tools (SIEM, GRC systems) - Phase 5
- Real-time audit trail streaming (WebSocket) - Phase 5
- Audit trail anomaly detection (ML-based) - Phase 6
- E-signature audit trail (separate story if needed)

---

## Dependencies

### Cross-Epic Dependencies

| Dependency | Story/Epic | Type | What It Provides | Status |
|------------|------------|------|------------------|--------|
| 01.1 | Org Context + RLS | HARD | organizations, users tables | Ready |

### Within Epic Dependencies

| Dependency | Story | Type | What It Provides |
|------------|-------|------|------------------|
| 06.5 | Incoming Inspection | HARD | quality_inspections audit log entries |
| 06.9 | Basic NCR Creation | HARD | ncr_reports audit log entries |
| 06.13 | NCR Workflow | HARD | NCR status transition audit log |
| 06.31 | CAPA Creation | HARD | capa_records audit log entries |
| 06.3 | Product Specifications | HARD | quality_specifications audit log |

### Provides To (Downstream)

| Story | What This Provides |
|-------|-------------------|
| 06.39 | Quality Analytics - Audit trail data for user activity analysis |
| Phase 5 | Compliance module - Audit trail export for external audits |

---

## Database Migration

### Migration: Create quality_audit_log table

```sql
-- Migration: YYYYMMDDHHMMSS_create_quality_audit_log.sql

CREATE TABLE quality_audit_log (
    -- Identity
    id                      UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id                  UUID NOT NULL REFERENCES organizations(id),

    -- Entity Reference (polymorphic - what was changed)
    entity_type             TEXT NOT NULL
                            CHECK (entity_type IN (
                                'inspection', 'ncr', 'capa', 'specification',
                                'test_result', 'ccp_monitoring', 'quality_hold',
                                'sampling_plan', 'supplier_audit', 'coa', 'batch_release'
                            )),
    entity_id               UUID NOT NULL,

    -- Action Type
    action                  TEXT NOT NULL
                            CHECK (action IN (
                                'create', 'update', 'delete', 'approve', 'reject',
                                'start', 'complete', 'cancel', 'assign', 'release',
                                'hold', 'sign', 'export'
                            )),

    -- Change Details
    field_name              TEXT, -- Specific field changed (NULL for entity-level actions like 'create')
    old_value               JSONB, -- Previous value (NULL for create)
    new_value               JSONB, -- New value (NULL for delete)

    -- User Context
    user_id                 UUID NOT NULL REFERENCES users(id),
    user_name               TEXT NOT NULL, -- Denormalized for audit trail permanence
    user_email              TEXT NOT NULL, -- Denormalized
    user_role               TEXT NOT NULL, -- Role at time of action

    -- Change Reason (required for critical fields)
    change_reason           TEXT, -- Why the change was made
    notes                   TEXT, -- Additional context

    -- Audit Metadata
    action_timestamp        TIMESTAMPTZ NOT NULL DEFAULT now(),
    ip_address              INET, -- Optional: IP address of user
    user_agent              TEXT, -- Optional: Browser/device info

    -- Retention
    archived_at             TIMESTAMPTZ, -- When record was archived
    retention_until         TIMESTAMPTZ NOT NULL DEFAULT (now() + INTERVAL '2 years'),

    CONSTRAINT check_change_fields CHECK (
        -- For create: old_value must be NULL
        -- For delete: new_value must be NULL
        -- For update: both must be present
        (action = 'create' AND old_value IS NULL) OR
        (action = 'delete' AND new_value IS NULL) OR
        (action NOT IN ('create', 'delete'))
    )
);

-- =============================================================================
-- Indexes for Performance
-- =============================================================================

CREATE INDEX idx_audit_log_org_entity ON quality_audit_log(org_id, entity_type, entity_id);
CREATE INDEX idx_audit_log_org_timestamp ON quality_audit_log(org_id, action_timestamp DESC);
CREATE INDEX idx_audit_log_user ON quality_audit_log(user_id, action_timestamp DESC);
CREATE INDEX idx_audit_log_action ON quality_audit_log(org_id, action);
CREATE INDEX idx_audit_log_retention ON quality_audit_log(retention_until) WHERE archived_at IS NULL;

-- Full-text search on change reason and notes
CREATE INDEX idx_audit_log_search ON quality_audit_log
    USING gin(to_tsvector('english', COALESCE(change_reason, '') || ' ' || COALESCE(notes, '')));

-- =============================================================================
-- RLS Policies (SELECT-only, INSERT-only for application)
-- =============================================================================

ALTER TABLE quality_audit_log ENABLE ROW LEVEL SECURITY;

-- Allow SELECT for org members
CREATE POLICY "audit_log_select" ON quality_audit_log
    FOR SELECT USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

-- Allow INSERT for org members (application creates audit entries)
CREATE POLICY "audit_log_insert" ON quality_audit_log
    FOR INSERT WITH CHECK (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

-- NO UPDATE OR DELETE POLICIES - Audit log is immutable
-- This enforces FDA 21 CFR Part 11 requirement for tamper-proof records

-- =============================================================================
-- Trigger: Prevent UPDATE and DELETE
-- =============================================================================

CREATE OR REPLACE FUNCTION prevent_audit_log_modification()
RETURNS TRIGGER AS $$
BEGIN
    RAISE EXCEPTION 'Audit log records are immutable and cannot be modified or deleted';
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER prevent_audit_log_update
    BEFORE UPDATE ON quality_audit_log
    FOR EACH ROW
    EXECUTE FUNCTION prevent_audit_log_modification();

CREATE TRIGGER prevent_audit_log_delete
    BEFORE DELETE ON quality_audit_log
    FOR EACH ROW
    EXECUTE FUNCTION prevent_audit_log_modification();

-- =============================================================================
-- Function: Create Audit Log Entry (Helper)
-- =============================================================================

CREATE OR REPLACE FUNCTION create_audit_log_entry(
    p_entity_type TEXT,
    p_entity_id UUID,
    p_action TEXT,
    p_field_name TEXT DEFAULT NULL,
    p_old_value JSONB DEFAULT NULL,
    p_new_value JSONB DEFAULT NULL,
    p_change_reason TEXT DEFAULT NULL,
    p_notes TEXT DEFAULT NULL
)
RETURNS UUID AS $$
DECLARE
    v_user_record RECORD;
    v_audit_id UUID;
BEGIN
    -- Get current user details
    SELECT u.id, u.full_name, u.email, u.role, u.org_id
    INTO v_user_record
    FROM users u
    WHERE u.id = auth.uid();

    IF v_user_record IS NULL THEN
        RAISE EXCEPTION 'User not found or not authenticated';
    END IF;

    -- Insert audit log entry
    INSERT INTO quality_audit_log (
        org_id,
        entity_type,
        entity_id,
        action,
        field_name,
        old_value,
        new_value,
        user_id,
        user_name,
        user_email,
        user_role,
        change_reason,
        notes
    ) VALUES (
        v_user_record.org_id,
        p_entity_type,
        p_entity_id,
        p_action,
        p_field_name,
        p_old_value,
        p_new_value,
        v_user_record.id,
        v_user_record.full_name,
        v_user_record.email,
        v_user_record.role,
        p_change_reason,
        p_notes
    ) RETURNING id INTO v_audit_id;

    RETURN v_audit_id;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- =============================================================================
-- Function: Archive Old Audit Logs
-- =============================================================================

CREATE OR REPLACE FUNCTION archive_old_audit_logs()
RETURNS INTEGER AS $$
DECLARE
    v_archived_count INTEGER;
BEGIN
    -- Mark records as archived when retention period expires
    UPDATE quality_audit_log
    SET archived_at = NOW()
    WHERE retention_until < NOW()
      AND archived_at IS NULL;

    GET DIAGNOSTICS v_archived_count = ROW_COUNT;

    RETURN v_archived_count;
END;
$$ LANGUAGE plpgsql;

-- Note: Schedule this function via cron or pg_cron extension
-- SELECT cron.schedule('archive-audit-logs', '0 2 * * *', 'SELECT archive_old_audit_logs();');
```

---

## Acceptance Criteria (Given/When/Then)

### AC-1: Audit Log Table Creation

```gherkin
Scenario: quality_audit_log table created
  Given database migration runs
  When schema inspected
  Then quality_audit_log table exists with all columns
  And RLS policies allow SELECT and INSERT only
  And NO UPDATE or DELETE policies exist
  And triggers prevent UPDATE and DELETE operations

Scenario: Audit log immutability enforced
  Given audit log entry exists
  When attempting to UPDATE record
  Then error: "Audit log records are immutable"
  When attempting to DELETE record
  Then error: "Audit log records are immutable"
```

### AC-2: Audit Log Entry Creation

```gherkin
Scenario: Create audit log entry for inspection update
  Given inspection with id = ABC-123
  When inspection.result changed from NULL to 'pass'
  Then audit log entry created with:
    | Field | Value |
    | entity_type | inspection |
    | entity_id | ABC-123 |
    | action | update |
    | field_name | result |
    | old_value | null |
    | new_value | "pass" |
    | user_id | current user |
    | user_name | John Doe |
    | action_timestamp | now |

Scenario: Create audit log entry with change reason
  Given NCR status change from 'open' to 'closed'
  And change reason required
  When NCR status updated with reason "Corrective action verified effective"
  Then audit log entry includes:
    | Field | Value |
    | entity_type | ncr |
    | action | update |
    | field_name | status |
    | change_reason | Corrective action verified effective |
```

### AC-3: Audit Trail Query Interface

```gherkin
Scenario: Query audit trail by entity
  Given user navigates to Quality > Audit Trail
  When filtering by:
    | Filter | Value |
    | Entity Type | Inspection |
    | Entity ID | INS-INC-2025-00001 |
  Then audit log entries for that inspection displayed
  And sorted by action_timestamp DESC

Scenario: Query audit trail by user
  Given user navigates to audit trail
  When filtering by:
    | Filter | Value |
    | User | John Doe |
    | Date From | 2025-01-01 |
    | Date To | 2025-01-15 |
  Then all audit log entries by John Doe in date range displayed

Scenario: Query audit trail by action
  Given audit trail page loaded
  When filtering by action = 'approve'
  Then only approval actions displayed
  And includes approvals for inspections, NCRs, CAPAs, batch releases
```

### AC-4: Audit Trail List View

```gherkin
Scenario: Display audit trail list
  Given user views audit trail page
  Then DataTable displays columns:
    | Column | Description |
    | Timestamp | ISO datetime with timezone |
    | Entity Type | Inspection, NCR, CAPA, etc. |
    | Entity ID | Link to entity detail |
    | Action | create, update, approve, etc. |
    | Field | Field name (if update) |
    | User | User name with role |
    | Change Reason | Truncated to 50 chars |
  And pagination available (50 per page)
  And total count displayed

Scenario: Sort audit trail
  Given audit trail list loaded
  When user sorts by timestamp ascending
  Then oldest entries shown first
  When user sorts by user
  Then entries grouped by user alphabetically
```

### AC-5: Audit Trail Detail View

```gherkin
Scenario: View audit log detail with diff
  Given user clicks on audit log entry for field update
  Then detail modal opens showing:
    | Section | Content |
    | Entity | Type, ID, link to entity |
    | Action | Action type, timestamp |
    | User | Name, email, role, IP address |
    | Change | Old value vs new value (side-by-side) |
    | Reason | Change reason (if provided) |
    | Notes | Additional notes (if provided) |
  And old/new values displayed as formatted JSON diff

Scenario: View audit log for entity creation
  Given audit log entry for action = 'create'
  When viewing detail
  Then old_value is NULL
  And new_value shows full entity state at creation
  And highlighted as "Entity Created"

Scenario: View audit log for entity deletion
  Given audit log entry for action = 'delete'
  When viewing detail
  Then old_value shows entity state before deletion
  And new_value is NULL
  And highlighted as "Entity Deleted" with warning color
```

### AC-6: Change History Timeline

```gherkin
Scenario: View change history for entity
  Given inspection INS-INC-2025-00001 exists
  When user navigates to inspection detail page
  And clicks [View Change History]
  Then timeline modal opens showing:
    - All audit log entries for that inspection
    - Chronological order (newest first)
    - User avatar + name + action + timestamp
    - Expandable entries showing old/new values
    - Change reasons displayed
  And timeline shows full lifecycle: created -> assigned -> started -> completed

Scenario: Timeline diff highlighting
  Given change history timeline displayed
  When user expands entry for field update
  Then diff shows:
    - Removed values in red (strikethrough)
    - Added values in green (highlight)
    - Unchanged values in gray
```

### AC-7: Audit Trail Export (CSV)

```gherkin
Scenario: Export audit trail as CSV
  Given user viewing audit trail with filters applied
  When clicking [Export CSV]
  Then CSV file downloads with columns:
    | Column |
    | Timestamp |
    | Entity Type |
    | Entity ID |
    | Action |
    | Field Name |
    | Old Value |
    | New Value |
    | User Name |
    | User Email |
    | User Role |
    | Change Reason |
    | Notes |
  And filename = "Audit-Trail-{YYYY-MM-DD}.csv"
  And export completes within 10 seconds for 10,000 records

Scenario: Export filtered audit trail
  Given user filters by entity_type = 'ncr' and date range
  When exporting CSV
  Then only filtered records exported
  And CSV includes filter metadata in header comment
```

### AC-8: Audit Trail Export (PDF)

```gherkin
Scenario: Export audit trail as PDF
  Given user viewing audit trail
  When clicking [Export PDF]
  Then PDF generated with:
    - Header: Org name, "Audit Trail Report", date range, generated timestamp
    - Table: All audit log entries with columns (timestamp, entity, action, user, change reason)
    - Old/new values formatted as inline text
    - Footer: Page numbers, MonoPilot branding, "Confidential"
  And PDF downloads as "Audit-Trail-Report-{YYYY-MM-DD}.pdf"
  And generation completes within 15 seconds for 1,000 records

Scenario: PDF export for compliance audit
  Given audit trail filtered for entity_type = 'inspection' and date range = last 2 years
  When exporting PDF
  Then PDF includes:
    - Cover page with report metadata
    - Summary table (total entries, unique users, actions breakdown)
    - Detailed audit log entries (paginated)
    - Certification statement: "This report was generated from the MonoPilot Quality Management System and represents a true and accurate record of all quality audit trail entries for the specified period."
```

### AC-9: Full-Text Search

```gherkin
Scenario: Search audit trail by change reason
  Given audit trail page loaded
  When user searches "Corrective action verified"
  Then audit log entries containing that phrase in change_reason or notes displayed
  And search is case-insensitive
  And partial word matches included

Scenario: Search debouncing
  Given user typing in search box
  When user types "corr"
  Then no search triggered
  When user pauses typing for 300ms
  Then search executes with "corr"
```

### AC-10: Audit Trail Retention

```gherkin
Scenario: Archive old audit logs
  Given audit log entries with retention_until < today
  When archive job runs (cron daily at 2am)
  Then archived_at timestamp set for expired entries
  And archived entries still visible in audit trail
  And archived badge displayed

Scenario: Configure retention period
  Given user with QUALITY_DIRECTOR role
  When navigating to Quality > Settings
  Then audit trail retention period configurable (1-10 years, default 2 years)
  And retention applies to new audit log entries
```

### AC-11: Permission Enforcement

```gherkin
Scenario: Viewer can view audit trail
  Given user with VIEWER role
  When viewing audit trail
  Then can view audit log entries
  And cannot export (export button hidden)

Scenario: QA Manager can export audit trail
  Given user with QA_MANAGER role
  When viewing audit trail
  Then can view and export (CSV, PDF)

Scenario: Quality Director has full access
  Given user with QUALITY_DIRECTOR role
  Then can view, export, and configure retention period
```

### AC-12: RLS Policy Enforcement

```gherkin
Scenario: Org isolation on audit trail
  Given User A from Org A and User B from Org B
  When User A queries audit trail
  Then sees only Org A audit log entries
  And cannot access Org B audit logs

Scenario: Cross-org audit log access blocked
  Given User A from Org A
  When attempting to load audit trail with org_id=B in query params
  Then API returns 404 Not Found
  And RLS policy blocks data access
```

### AC-13: Performance Requirements

```gherkin
Scenario: Audit trail query performance
  Given organization with 100,000 audit log entries
  When querying audit trail with filters
  Then response time < 500ms for paginated results (50 per page)

Scenario: Audit trail export performance
  Given organization with 10,000 audit log entries
  When exporting to CSV
  Then export completes within 10 seconds
  When exporting to PDF
  Then export completes within 15 seconds
```

---

## Implementation Notes

### API Endpoints

```typescript
// =============================================================================
// Audit Trail Endpoints
// =============================================================================

// GET /api/quality/audit-trail
interface AuditTrailListRequest {
  entity_type?: 'inspection' | 'ncr' | 'capa' | 'specification' | 'test_result' | 'ccp_monitoring' | 'quality_hold';
  entity_id?: string;
  action?: 'create' | 'update' | 'delete' | 'approve' | 'reject' | 'start' | 'complete';
  user_id?: string;
  date_from?: string; // ISO date
  date_to?: string;
  search?: string; // Full-text search on change_reason, notes
  include_archived?: boolean; // Default false
  sort_by?: 'action_timestamp' | 'entity_type' | 'user_name';
  sort_order?: 'asc' | 'desc';
  page?: number;
  limit?: number;
}

interface AuditTrailListResponse {
  audit_logs: AuditLogEntry[];
  pagination: {
    total: number;
    page: number;
    limit: number;
    pages: number;
  };
}

interface AuditLogEntry {
  id: string;
  org_id: string;
  entity_type: string;
  entity_id: string;
  action: string;
  field_name?: string;
  old_value?: any; // JSONB
  new_value?: any; // JSONB
  user_id: string;
  user_name: string;
  user_email: string;
  user_role: string;
  change_reason?: string;
  notes?: string;
  action_timestamp: string;
  ip_address?: string;
  archived_at?: string;
}

// GET /api/quality/audit-trail/:id
interface AuditTrailDetailResponse {
  audit_log: AuditLogEntry;
  diff: {
    field_name: string;
    old_value: any;
    new_value: any;
    diff_html: string; // HTML-formatted diff for display
  };
}

// POST /api/quality/audit-trail/export
interface AuditTrailExportRequest {
  format: 'csv' | 'pdf';
  entity_type?: string;
  entity_id?: string;
  action?: string;
  user_id?: string;
  date_from?: string;
  date_to?: string;
  include_archived?: boolean;
}

interface AuditTrailExportResponse {
  file_url: string; // Temporary signed URL (expires in 1 hour)
  filename: string;
  generated_at: string;
  record_count: number;
}
```

### Service Layer

```typescript
// lib/services/audit-trail-service.ts

export class AuditTrailService {
  /**
   * Query audit trail with filters and pagination
   */
  static async list(params: AuditTrailListParams): Promise<PaginatedResult<AuditLogEntry>>;

  /**
   * Get audit log entry by ID with diff
   */
  static async getById(id: string): Promise<AuditLogEntryWithDiff | null>;

  /**
   * Get change history for entity (all audit logs for entity_id)
   */
  static async getChangeHistory(
    entityType: string,
    entityId: string
  ): Promise<AuditLogEntry[]>;

  /**
   * Create audit log entry
   */
  static async createEntry(
    entityType: string,
    entityId: string,
    action: string,
    fieldName?: string,
    oldValue?: any,
    newValue?: any,
    changeReason?: string,
    notes?: string
  ): Promise<string>; // Returns audit_log_id

  /**
   * Export audit trail as CSV
   */
  static async exportCSV(params: AuditTrailExportParams): Promise<{ url: string; filename: string }>;

  /**
   * Export audit trail as PDF
   */
  static async exportPDF(params: AuditTrailExportParams): Promise<{ url: string; filename: string }>;

  /**
   * Generate diff HTML for old/new values
   */
  static generateDiffHTML(oldValue: any, newValue: any): string;

  /**
   * Archive old audit logs (cron job)
   */
  static async archiveOldLogs(): Promise<number>; // Returns count of archived logs
}
```

### Frontend Components

```
apps/frontend/app/(authenticated)/quality/
  audit-trail/
    page.tsx                          -- Audit trail list page
    [id]/
      page.tsx                        -- Audit trail detail page

components/quality/audit-trail/
  AuditTrailDataTable.tsx             -- DataTable with filters
  AuditTrailFilters.tsx               -- Filter panel (entity type, action, user, date)
  AuditTrailDetailModal.tsx           -- Detail modal with diff
  AuditTrailDiff.tsx                  -- Old/new value diff component
  AuditTrailChangeHistory.tsx         -- Timeline view for entity
  AuditTrailExportButtons.tsx         -- CSV/PDF export buttons
  AuditTrailSearchBox.tsx             -- Full-text search input
  AuditTrailActionBadge.tsx           -- Action badge (create/update/approve)
  AuditTrailEntityLink.tsx            -- Link to entity detail
  AuditTrailUserInfo.tsx              -- User name/role/email display
```

---

## Key Business Rules

1. **Audit Log Immutability**: No UPDATE or DELETE allowed on quality_audit_log table (enforced by RLS + triggers)
2. **Change Reason Required**: For critical fields (quality status, NCR severity, CAPA actions), change_reason is required
3. **User Denormalization**: User name, email, role denormalized in audit log for permanence (survives user deletion)
4. **Retention Period Default**: 2 years (configurable per organization up to 10 years)
5. **Archive Not Delete**: Old audit logs archived (archived_at timestamp) but never deleted
6. **Full-Text Search**: Search on change_reason and notes using PostgreSQL tsvector
7. **Export Permissions**: CSV/PDF export requires QA_MANAGER or QUALITY_DIRECTOR role
8. **Org Isolation**: RLS enforces org_id isolation on all audit trail queries
9. **Diff Formatting**: Old/new values formatted as JSON diff with color highlighting
10. **Entity Lifecycle**: Audit trail shows complete lifecycle (create → updates → approve/complete)

---

## Deliverables

### Database
- [ ] Migration: `quality_audit_log` table with all columns
- [ ] Indexes for performance and full-text search
- [ ] RLS policies: SELECT and INSERT only (no UPDATE/DELETE)
- [ ] Triggers: prevent_audit_log_update, prevent_audit_log_delete
- [ ] Function: `create_audit_log_entry()` helper
- [ ] Function: `archive_old_audit_logs()` cron job

### API Routes
- [ ] `GET /api/quality/audit-trail` - List with filters
- [ ] `GET /api/quality/audit-trail/:id` - Detail with diff
- [ ] `POST /api/quality/audit-trail/export` - CSV/PDF export

### Service Layer
- [ ] `AuditTrailService.list()` - Query with pagination
- [ ] `AuditTrailService.getById()` - Get with diff
- [ ] `AuditTrailService.getChangeHistory()` - Entity timeline
- [ ] `AuditTrailService.createEntry()` - Create audit log
- [ ] `AuditTrailService.exportCSV()` - CSV export
- [ ] `AuditTrailService.exportPDF()` - PDF export
- [ ] `AuditTrailService.generateDiffHTML()` - Diff formatting
- [ ] `AuditTrailService.archiveOldLogs()` - Archive job

### Frontend
- [ ] Audit trail list page with filters
- [ ] Audit trail detail modal with diff
- [ ] Change history timeline component
- [ ] CSV/PDF export buttons
- [ ] Full-text search box
- [ ] Action/entity badges
- [ ] Loading and empty states

### Tests
- [ ] Unit tests: AuditTrailService methods (>80% coverage)
- [ ] Integration tests: All API endpoints
- [ ] E2E: Full audit trail query and export
- [ ] E2E: Immutability enforcement (UPDATE/DELETE blocked)
- [ ] Performance tests: Query and export with 100,000 records

---

## Definition of Done

### Database
- [ ] `quality_audit_log` table created
- [ ] RLS policies enforce SELECT/INSERT only
- [ ] Triggers prevent UPDATE/DELETE
- [ ] All indexes created
- [ ] Full-text search index works

### API
- [ ] All 3 endpoints return correct data
- [ ] Response times < 500ms for paginated queries
- [ ] CSV export completes within 10 seconds for 10,000 records
- [ ] PDF export completes within 15 seconds for 1,000 records
- [ ] RLS policies prevent cross-org access

### Service
- [ ] All service methods work correctly
- [ ] Diff generation accurate
- [ ] Export includes all filtered records
- [ ] Archive job marks expired logs

### Frontend
- [ ] Audit trail list displays correctly
- [ ] Filters and search work
- [ ] Detail modal shows diff
- [ ] Change history timeline works
- [ ] CSV/PDF export downloads successfully
- [ ] Loading and empty states display

### Testing
- [ ] Unit tests: >80% coverage
- [ ] Integration tests: All endpoints covered
- [ ] E2E tests: Full workflow
- [ ] Immutability tests: UPDATE/DELETE blocked
- [ ] Performance tests: Query and export verified

---

## Risk Assessment

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Audit log table growth | MEDIUM | HIGH | Archiving policy, partitioning by date if needed |
| Export timeout for large datasets | MEDIUM | MEDIUM | Streaming export, background job for >10,000 records |
| Diff formatting complexity | LOW | MEDIUM | Use proven diff library (diff-match-patch) |
| Performance degradation | MEDIUM | LOW | Proper indexes, materialized view for summary stats |
| Immutability bypass | HIGH | LOW | RLS + triggers enforce at database level |

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-01-15 | Initial story creation for Audit Trail Reports | OPUS |

---

**Document Status**: Ready for Implementation
**Created**: 2025-01-15
**Lines**: ~850
**Complexity**: M (Medium)
**Phase**: 4 (Analytics & Reporting)
