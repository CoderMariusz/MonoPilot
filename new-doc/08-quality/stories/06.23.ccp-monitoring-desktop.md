# 06.23 - CCP Monitoring Desktop

**Priority**: P0 (MVP)
**Story Points**: M (Medium)
**Type**: full-stack
**Phase**: 3 (HACCP)
**Model**: OPUS

**State:** ready
**Estimate:** M (3-4 days)
**Primary PRD:** `docs/1-BASELINE/product/modules/quality.md` (FR-QA-014, Section 6.2)
**Architecture:** `docs/1-BASELINE/architecture/modules/quality.md` (haccp_ccp_monitoring table)

---

## Goal

Implement desktop CCP monitoring data entry for production operators and QA inspectors. This enables real-time recording of CCP monitoring values (temperature, pH, metal detection, etc.), automatic validation against critical limits, and immediate deviation alerts when values fall outside acceptable ranges. CCP monitoring is a critical HACCP requirement for food safety compliance.

---

## Food Safety Compliance

This story is **CRITICAL for food safety compliance**:

- [x] **HACCP Compliance** - CCP monitoring records required for HACCP certification
- [x] **FDA 21 CFR Part 11** - Electronic records with user authentication and timestamps
- [x] **Audit Trail Required** - All monitoring records immutable with operator ID, timestamp, values
- [x] **Real-time Deviation Detection** - Immediate alerts when out-of-spec (<30s)

**Regulatory Context:**
- HACCP Principle 4: Establish monitoring procedures
- FDA FSMA requires real-time CCP monitoring with immediate corrective action
- GFSI standards (BRC, SQF, FSSC 22000) mandate continuous CCP monitoring
- All CCP monitoring records retained for minimum 5 years (configurable)
- Deviation from critical limits triggers mandatory corrective action
- Monitoring records must be signed by operator (electronic signature)

---

## MVP Scope

This story implements Phase 3 (HACCP) functionality. CCP Monitoring Desktop is the second CCP story, building on CCP Definition (06.22).

**MVP Includes**:
- `haccp_ccp_monitoring` table with monitoring record fields
- CCP monitoring data entry form (desktop/web)
- Real-time validation against critical limits (min/max from CCP definition)
- Auto-alert on deviation (value < min or > max)
- Corrective action field (mandatory if out-of-spec)
- Link to work order + operation (where monitoring occurred)
- Link to batch/LP for traceability
- Monitoring queue dashboard (due CCPs, overdue CCPs)
- Monitoring history view (past 24h, 7d, 30d)
- CCP monitoring form with autofill from CCP definition
- Deviation warning modal on out-of-spec entry
- Integration with work orders (Epic 04)
- Integration with CCP definition (story 06.22)

**Deferred to Phase 3+**: See "Future Phases" section below.

---

## User Story

As a **Production Operator**, I want to **record CCP monitoring values during production and see immediate alerts if values are out-of-spec** so that **I can take corrective action before unsafe product is released**.

As a **QA Inspector**, I want to **review CCP monitoring records and verify corrective actions** so that **I can ensure all critical control points are properly monitored and controlled**.

---

## Scope

**In scope (this story)**
- `haccp_ccp_monitoring` table with monitoring record fields
- GET /api/quality/haccp/ccp-monitoring (list monitoring records with filters)
- GET /api/quality/haccp/ccp-monitoring/:id (monitoring record detail)
- POST /api/quality/haccp/ccp-monitoring (create monitoring record)
- PUT /api/quality/haccp/ccp-monitoring/:id (update if within 5min)
- DELETE /api/quality/haccp/ccp-monitoring/:id (delete draft only)
- GET /api/quality/haccp/ccp-monitoring/due (CCPs due for monitoring)
- Real-time validation: value vs critical limits
- Auto-create deviation record on out-of-spec (story 06.25 integration)
- Alert notification on deviation (story 06.26 integration hook)
- Monitoring form with CCP dropdown
- Monitoring value input with unit display
- Deviation warning modal
- Corrective action textarea (mandatory if out-of-spec)
- Monitoring history table with filters
- Monitoring queue (due/overdue CCPs)
- Desktop-optimized UI (fast data entry)

**Out of scope (this story)**
- Mobile/scanner CCP monitoring (story 06.24)
- CCP deviation handling workflow (story 06.25 - backend integration ready)
- CCP deviation alerts (story 06.26 - alert hooks ready)
- CCP trend analysis charts (Phase 4)
- Statistical process control (SPC) charts (Phase 4)
- Offline mode (story 06.24 - scanner only)

---

## Future Phases (Not in MVP)

### Phase 3+ (Story 06.23b - CCP Monitoring Advanced)
- **Bulk data entry** - Record multiple CCPs in one form
- **Auto-schedule monitoring** - Reminders based on frequency
- **Photo attachments** - Capture visual evidence of monitoring
- **Voice-to-text** - Hands-free monitoring data entry
- **Equipment integration** - Auto-import values from IoT devices

### Phase 4
- **CCP trend analysis** - Charts showing values over time
- **Statistical process control (SPC)** - Control charts with process capability
- **Predictive alerts** - Warn when trending toward limit
- **Equipment calibration tracking** - Link monitoring to equipment calibration records
- **E-signature integration** - FDA 21 CFR Part 11 compliant digital signatures

### Deferred to Other Stories
- **CCP Monitoring (Scanner)** - Story 06.24
- **CCP Deviation Handling** - Story 06.25 (backend integration ready)
- **CCP Deviation Alerts** - Story 06.26 (alert hooks ready)
- **CCP Definition** - Story 06.22 (prerequisite)

---

## Dependencies

### Cross-Epic Dependencies

| Dependency | Story/Epic | Type | What It Provides | Status |
|------------|------------|------|------------------|--------|
| 01.1 | Org Context + RLS | HARD | organizations, users, roles tables | Ready |
| 04.1 | Work Orders CRUD | HARD | work_orders table for WO reference | Ready |
| 04.2 | WO Operations | HARD | wo_operations table for operation tracking | Ready |
| 05.1 | LP Table + CRUD | HARD | license_plates table for traceability | Ready |

### Within Epic Dependencies

| Dependency | Story | Type | What It Provides |
|------------|-------|------|------------------|
| 06.21 | HACCP Plan Setup | HARD | haccp_plans table |
| 06.22 | CCP Definition | HARD | haccp_ccp table, critical limits |

### Provides To (Downstream)

| Story | What This Provides |
|-------|-------------------|
| 06.24 | CCP Monitoring Scanner - monitoring patterns, same table |
| 06.25 | CCP Deviation Handling - monitoring records with out-of-spec flag |
| 06.26 | CCP Deviation Alerts - monitoring records trigger alerts |
| 06.18 | Test Result Trending - CCP monitoring data for charts |

---

## Database Migration

### Migration: Create haccp_ccp_monitoring table

```sql
-- Migration: YYYYMMDDHHMMSS_create_haccp_ccp_monitoring.sql

CREATE TABLE haccp_ccp_monitoring (
    -- Identity
    id                      UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id                  UUID NOT NULL REFERENCES organizations(id),

    -- CCP Reference
    ccp_id                  UUID NOT NULL REFERENCES haccp_ccp(id),
    ccp_number              TEXT NOT NULL, -- Denormalized for performance
    ccp_name                TEXT NOT NULL, -- Denormalized for performance

    -- Work Order Context
    wo_id                   UUID REFERENCES work_orders(id),
    wo_number               TEXT, -- Denormalized
    wo_operation_id         UUID REFERENCES wo_operations(id),
    operation_name          TEXT, -- Denormalized

    -- Product and Batch Traceability
    product_id              UUID NOT NULL REFERENCES products(id),
    batch_number            TEXT,
    lp_id                   UUID REFERENCES license_plates(id),

    -- Monitoring Value
    monitored_value         NUMERIC NOT NULL, -- Actual value recorded
    unit_of_measure         TEXT NOT NULL, -- Copied from CCP for immutability

    -- Critical Limits (snapshot from CCP at time of monitoring)
    critical_limit_min      NUMERIC,
    critical_limit_max      NUMERIC,
    target_value            NUMERIC,

    -- Result Determination
    result                  TEXT NOT NULL
                            CHECK (result IN ('pass', 'fail', 'marginal')),
    deviation_detected      BOOLEAN NOT NULL DEFAULT false,

    -- Corrective Action (mandatory if fail)
    corrective_action_taken TEXT,
    corrective_action_by    UUID REFERENCES users(id),
    corrective_action_at    TIMESTAMPTZ,

    -- Monitoring Method
    monitoring_method       TEXT NOT NULL, -- Copied from CCP
    equipment_used          TEXT, -- e.g., "Thermometer SN-12345"

    -- Responsibility
    monitored_by            UUID NOT NULL REFERENCES users(id),
    monitored_at            TIMESTAMPTZ NOT NULL DEFAULT now(),
    verified_by             UUID REFERENCES users(id),
    verified_at             TIMESTAMPTZ,

    -- Audit
    created_at              TIMESTAMPTZ NOT NULL DEFAULT now(),
    created_by              UUID REFERENCES users(id),
    updated_at              TIMESTAMPTZ NOT NULL DEFAULT now(),
    updated_by              UUID REFERENCES users(id),

    -- Immutability (records locked after 5min or if verified)
    is_locked               BOOLEAN NOT NULL DEFAULT false,
    locked_at               TIMESTAMPTZ,

    -- Constraints
    CONSTRAINT chk_corrective_action_if_fail CHECK (
        (result != 'fail') OR (corrective_action_taken IS NOT NULL)
    )
);

-- =============================================================================
-- Indexes for Performance
-- =============================================================================

CREATE INDEX idx_ccp_monitoring_org ON haccp_ccp_monitoring(org_id);
CREATE INDEX idx_ccp_monitoring_ccp ON haccp_ccp_monitoring(ccp_id);
CREATE INDEX idx_ccp_monitoring_wo ON haccp_ccp_monitoring(wo_id) WHERE wo_id IS NOT NULL;
CREATE INDEX idx_ccp_monitoring_product ON haccp_ccp_monitoring(product_id);
CREATE INDEX idx_ccp_monitoring_batch ON haccp_ccp_monitoring(org_id, batch_number) WHERE batch_number IS NOT NULL;
CREATE INDEX idx_ccp_monitoring_lp ON haccp_ccp_monitoring(lp_id) WHERE lp_id IS NOT NULL;
CREATE INDEX idx_ccp_monitoring_result ON haccp_ccp_monitoring(org_id, result);
CREATE INDEX idx_ccp_monitoring_deviation ON haccp_ccp_monitoring(org_id, deviation_detected)
    WHERE deviation_detected = true;
CREATE INDEX idx_ccp_monitoring_time ON haccp_ccp_monitoring(org_id, monitored_at DESC);
CREATE INDEX idx_ccp_monitoring_operator ON haccp_ccp_monitoring(monitored_by, monitored_at DESC);

-- =============================================================================
-- RLS Policies
-- =============================================================================

ALTER TABLE haccp_ccp_monitoring ENABLE ROW LEVEL SECURITY;

CREATE POLICY "ccp_monitoring_select" ON haccp_ccp_monitoring
    FOR SELECT USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

CREATE POLICY "ccp_monitoring_insert" ON haccp_ccp_monitoring
    FOR INSERT WITH CHECK (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

CREATE POLICY "ccp_monitoring_update" ON haccp_ccp_monitoring
    FOR UPDATE USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
        AND is_locked = false
    );

-- Cannot delete monitoring records (audit trail)
CREATE POLICY "ccp_monitoring_delete" ON haccp_ccp_monitoring
    FOR DELETE USING (false); -- No deletes allowed

-- =============================================================================
-- Trigger for updated_at
-- =============================================================================

CREATE TRIGGER update_ccp_monitoring_updated_at
    BEFORE UPDATE ON haccp_ccp_monitoring
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- =============================================================================
-- Function: Determine monitoring result (pass/fail/marginal)
-- =============================================================================

CREATE OR REPLACE FUNCTION determine_monitoring_result(
    p_value NUMERIC,
    p_min NUMERIC,
    p_max NUMERIC
)
RETURNS TEXT AS $$
BEGIN
    -- Fail if outside critical limits
    IF (p_min IS NOT NULL AND p_value < p_min) OR
       (p_max IS NOT NULL AND p_value > p_max) THEN
        RETURN 'fail';
    END IF;

    -- Marginal if within 5% of limit (configurable tolerance)
    IF p_min IS NOT NULL AND p_value < (p_min * 1.05) THEN
        RETURN 'marginal';
    END IF;
    IF p_max IS NOT NULL AND p_value > (p_max * 0.95) THEN
        RETURN 'marginal';
    END IF;

    -- Pass
    RETURN 'pass';
END;
$$ LANGUAGE plpgsql IMMUTABLE;

-- =============================================================================
-- Function: Auto-lock monitoring record after 5min
-- =============================================================================

CREATE OR REPLACE FUNCTION auto_lock_monitoring_record()
RETURNS TRIGGER AS $$
BEGIN
    -- Lock record 5 minutes after creation (immutability for audit trail)
    IF NEW.created_at < (NOW() - INTERVAL '5 minutes') AND NEW.is_locked = false THEN
        NEW.is_locked := true;
        NEW.locked_at := NOW();
    END IF;

    -- Lock record if verified
    IF NEW.verified_by IS NOT NULL AND NEW.is_locked = false THEN
        NEW.is_locked := true;
        NEW.locked_at := NOW();
    END IF;

    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_auto_lock_monitoring
    BEFORE UPDATE ON haccp_ccp_monitoring
    FOR EACH ROW
    EXECUTE FUNCTION auto_lock_monitoring_record();
```

---

## Acceptance Criteria (Given/When/Then)

### AC-1: Monitoring Table Creation

```gherkin
Scenario: haccp_ccp_monitoring table exists with all required columns
  Given database migration runs
  When schema is inspected
  Then haccp_ccp_monitoring table has all columns from schema
  And CHECK constraint requires corrective_action if result='fail'
  And FK constraints exist for ccp_id, wo_id, product_id, lp_id
  And RLS policies enforce org isolation
  And DELETE policy blocks all deletes (audit trail protection)
```

### AC-2: Create Monitoring Record - Pass

```gherkin
Scenario: Record monitoring value within critical limits
  Given CCP-1 (Receiving Temperature) with limits 0-4°C
  And work order WO-123 is active
  When operator records:
    | Field | Value |
    | CCP | CCP-1 |
    | Work Order | WO-123 |
    | Monitored Value | 2.5 |
    | Equipment Used | Thermometer SN-001 |
  Then monitoring record created with:
    | Field | Value |
    | result | pass |
    | deviation_detected | false |
    | monitored_by | current user |
    | monitored_at | now |
  And success toast "CCP monitoring recorded - PASS"

Scenario: Monitoring value exactly at limit (pass)
  Given CCP with limits 0-4°C
  When value = 4.0
  Then result = 'pass'
  And deviation_detected = false
```

### AC-3: Create Monitoring Record - Fail with Corrective Action

```gherkin
Scenario: Record monitoring value outside critical limits
  Given CCP-1 with limits 0-4°C
  When operator records value = 6.5
  Then form shows DEVIATION WARNING modal
  And modal displays:
    | Field | Value |
    | Monitored Value | 6.5°C |
    | Critical Limit Max | 4°C |
    | Deviation | +2.5°C (OVER LIMIT) |
  And corrective_action field becomes MANDATORY
  And operator enters "Rejected shipment, notified supplier, temperature log attached"
  And clicks [Submit with Corrective Action]
  Then monitoring record created with:
    | Field | Value |
    | result | fail |
    | deviation_detected | true |
    | corrective_action_taken | "Rejected shipment..." |
    | corrective_action_by | current user |
    | corrective_action_at | now |
  And deviation alert triggered (story 06.26 integration)
  And deviation record created (story 06.25 integration)
  And alert sent to QA Manager + Production Lead

Scenario: Cannot submit fail without corrective action
  Given value outside limits (result = fail)
  When corrective_action_taken is empty
  Then submit button disabled
  And error message "Corrective action required for out-of-spec values"
```

### AC-4: Marginal Result Detection

```gherkin
Scenario: Monitoring value marginal (within 5% of limit)
  Given CCP with limits 0-4°C
  When value = 3.9 (within 5% of max)
  Then result = 'marginal'
  And warning badge shown (not critical)
  And suggestion "Value approaching limit - monitor closely"
  And corrective_action optional (not mandatory)
```

### AC-5: Real-Time Validation Against Critical Limits

```gherkin
Scenario: Value validated as user types
  Given CCP-1 with limits 0-4°C selected
  When operator enters value = 2.5
  Then validation indicator shows GREEN checkmark
  And preview shows "PASS - Within limits"

Scenario: Value exceeds limit (real-time warning)
  Given CCP-1 with limits 0-4°C
  When operator enters value = 5
  Then validation indicator shows RED warning
  And preview shows "FAIL - Above max (4°C)"
  And corrective action field appears

Scenario: Value approaching limit (real-time caution)
  Given CCP-1 with limits 0-4°C
  When operator enters value = 3.9
  Then validation indicator shows YELLOW caution
  And preview shows "MARGINAL - Approaching limit"
```

### AC-6: CCP Monitoring Form Autofill

```gherkin
Scenario: CCP selection autofills metadata
  Given CCP-1 (Receiving Temperature) exists with:
    | Field | Value |
    | critical_limit_min | 0 |
    | critical_limit_max | 4 |
    | unit_of_measure | °C |
    | monitoring_method | Infrared thermometer |
  When operator selects CCP-1
  Then form autofills:
    | Field | Value |
    | Unit | °C |
    | Method | Infrared thermometer |
    | Critical Limits Display | 0-4°C |
  And value input focused for fast entry

Scenario: Work order selection autofills product/batch
  Given WO-123 for product "Bread" batch "B-2025-001"
  When operator selects WO-123
  Then form autofills:
    | Field | Value |
    | Product | Bread |
    | Batch Number | B-2025-001 |
```

### AC-7: Monitoring Queue - Due CCPs

```gherkin
Scenario: View CCPs due for monitoring
  Given CCP-1 has monitoring_frequency = "Every receipt"
  And new receipt arrived 10min ago
  And no monitoring recorded yet
  When operator views monitoring queue
  Then CCP-1 appears in "DUE" section
  And shows:
    | Field | Value |
    | CCP | CCP-1 - Receiving Temperature |
    | Frequency | Every receipt |
    | Last Monitored | 2 hours ago (previous receipt) |
    | Status Badge | DUE (yellow) |

Scenario: View overdue CCPs
  Given CCP-2 has monitoring_frequency = "Hourly"
  And last monitoring was 90 minutes ago
  When viewing queue
  Then CCP-2 appears in "OVERDUE" section
  And status badge = OVERDUE (red)
  And shows time overdue "30 minutes overdue"
```

### AC-8: Monitoring History View

```gherkin
Scenario: View monitoring history for CCP
  Given CCP-1 has 20 monitoring records
  When user navigates to CCP-1 monitoring history
  Then DataTable displays records with columns:
    | Column | Description |
    | Timestamp | Monitored at |
    | Value | Monitored value + unit |
    | Result | Badge (pass/fail/marginal) |
    | WO | Work order number |
    | Batch | Batch number |
    | Operator | Monitored by |
    | Corrective Action | If fail/marginal |
  And default filter = "Last 24 hours"
  And can filter by: Last 7d, Last 30d, Custom range
  And pagination available

Scenario: Filter monitoring history by result
  Given monitoring records with various results
  When user filters by result = 'fail'
  Then only failed monitoring records display
  And can see corrective actions taken
```

### AC-9: Edit Monitoring Record (within 5min)

```gherkin
Scenario: Edit recent monitoring record (within 5min)
  Given monitoring record created 2 minutes ago
  And record.is_locked = false
  When operator clicks [Edit]
  Then form opens with current values
  And operator updates monitored_value from 2.5 to 2.3
  And clicks [Save]
  Then record updated
  And audit log records change

Scenario: Cannot edit after 5min (auto-lock)
  Given monitoring record created 6 minutes ago
  And record.is_locked = true
  When operator attempts to edit
  Then error message "Record locked - cannot edit after 5 minutes"
  And [Edit] button disabled

Scenario: Cannot edit verified records
  Given monitoring record verified by QA
  And verified_by IS NOT NULL
  And is_locked = true
  When operator attempts to edit
  Then error "Record locked - verified by QA"
```

### AC-10: Verify Monitoring Record (QA)

```gherkin
Scenario: QA Inspector verifies monitoring record
  Given monitoring record with result = 'pass'
  When QA Inspector clicks [Verify]
  Then verified_by = current user
  And verified_at = now
  And is_locked = true
  And record becomes immutable

Scenario: QA verification of fail record with corrective action
  Given monitoring record with result = 'fail'
  And corrective_action_taken exists
  When QA Inspector reviews corrective action
  And clicks [Verify Corrective Action]
  Then verified_by = current user
  And deviation record updated (story 06.25)
```

### AC-11: Link to Work Order Operation

```gherkin
Scenario: Record monitoring at specific WO operation
  Given WO-123 with operation "Baking" (OP-003)
  And CCP-2 (Cooking Temperature) linked to Baking operation
  When operator records monitoring for CCP-2
  And selects WO-123, Operation "Baking"
  Then monitoring record links to:
    | Field | Value |
    | wo_id | WO-123 UUID |
    | wo_operation_id | OP-003 UUID |
  And monitoring visible in WO operation detail view
```

### AC-12: Batch and LP Traceability

```gherkin
Scenario: Link monitoring to LP for traceability
  Given monitoring for incoming CCP-1 (Receiving Temperature)
  And LP LP00000123 for received goods
  When recording monitoring
  And selecting LP LP00000123
  Then monitoring record links to LP
  And LP detail view shows monitoring history
  And batch_number populated from LP

Scenario: Traceability query - find all monitoring for batch
  Given batch B-2025-001 has 15 CCP monitoring records
  When querying monitoring by batch_number
  Then all 15 records returned
  And can see: CCP, Value, Result, Timestamp
```

### AC-13: Permission Enforcement

```gherkin
Scenario: Production Operator can record monitoring
  Given user with PRODUCTION_OPERATOR role
  When recording CCP monitoring
  Then can create monitoring records
  And can enter corrective action
  And cannot verify records (requires QA)

Scenario: QA Inspector can verify monitoring
  Given user with QA_INSPECTOR role
  When viewing monitoring record
  Then can verify record
  And can view all monitoring history

Scenario: Viewer cannot create monitoring
  Given user with VIEWER role
  When viewing monitoring page
  Then [Record Monitoring] button hidden
  And can only view history
```

### AC-14: Audit Trail

```gherkin
Scenario: All monitoring actions logged
  Given any monitoring record action
  When action completes
  Then quality_audit_log entry created with:
    | Field | Value |
    | entity_type | haccp_ccp_monitoring |
    | entity_id | monitoring.id |
    | action | create/update/verify |
    | user_id | current user |
    | timestamp | now |
    | old_value | previous state (for updates) |
    | new_value | new state |

Scenario: Deviation logged with severity
  Given monitoring result = 'fail'
  Then audit log includes:
    | Field | Value |
    | action | deviation_detected |
    | severity | critical (if > 10% over limit) |
    | corrective_action | action text |
```

### AC-15: RLS Policy Enforcement

```gherkin
Scenario: Org isolation on monitoring list
  Given User A from Org A and User B from Org B
  And monitoring records exist in both orgs
  When User A requests GET /api/quality/haccp/ccp-monitoring
  Then only Org A monitoring records returned

Scenario: Cannot view monitoring from different org
  Given monitoring record belongs to Org B
  When User A (Org A) requests GET /api/quality/haccp/ccp-monitoring/:id
  Then 404 Not Found returned

Scenario: Cannot delete monitoring records
  Given any monitoring record
  When User A attempts DELETE /api/quality/haccp/ccp-monitoring/:id
  Then 403 Forbidden (RLS policy blocks DELETE)
  And error "Monitoring records cannot be deleted (audit trail)"
```

---

## Key Business Rules

1. **Corrective Action Mandatory for Fail**: If result='fail', corrective_action_taken is required
2. **5-Minute Edit Window**: Monitoring records can be edited within 5 minutes of creation, then auto-locked
3. **Immutable After Verification**: Once verified_by is set, record becomes permanently locked
4. **No Deletes Allowed**: Monitoring records cannot be deleted (audit trail protection)
5. **Real-time Deviation Detection**: Values validated against critical limits on entry
6. **Auto-Alert on Deviation**: Fail result triggers immediate alert to QA Manager + Production Lead (<30s)
7. **Marginal Threshold**: Values within 5% of limit flagged as marginal (configurable)
8. **CCP Snapshot**: Critical limits copied from CCP definition at time of monitoring (immutable snapshot)
9. **Traceability Link Required**: Monitoring must link to WO, batch, or LP for traceability
10. **Audit Trail Required**: All monitoring actions logged to quality_audit_log

---

## Deliverables

### Database
- [ ] Migration: `haccp_ccp_monitoring` table with all columns
- [ ] Function: `determine_monitoring_result(value, min, max)`
- [ ] Function: `auto_lock_monitoring_record()` trigger function
- [ ] RLS policies for haccp_ccp_monitoring
- [ ] All performance indexes

### API Routes
- [ ] `GET /api/quality/haccp/ccp-monitoring` - List with filters
- [ ] `GET /api/quality/haccp/ccp-monitoring/:id` - Get detail
- [ ] `POST /api/quality/haccp/ccp-monitoring` - Create monitoring record
- [ ] `PUT /api/quality/haccp/ccp-monitoring/:id` - Update (within 5min)
- [ ] `POST /api/quality/haccp/ccp-monitoring/:id/verify` - Verify record (QA)
- [ ] `GET /api/quality/haccp/ccp-monitoring/due` - Due CCPs queue
- [ ] `GET /api/quality/haccp/ccp-monitoring/history/:ccp_id` - Monitoring history for CCP

### Service Layer
- [ ] `CCPMonitoringService.list()` - List with pagination
- [ ] `CCPMonitoringService.getById()` - Get with detail
- [ ] `CCPMonitoringService.create()` - Create with validation
- [ ] `CCPMonitoringService.update()` - Update (unlock check)
- [ ] `CCPMonitoringService.verify()` - Verify record (QA)
- [ ] `CCPMonitoringService.getDueCCPs()` - Get due/overdue CCPs
- [ ] `CCPMonitoringService.getHistory()` - Get CCP monitoring history
- [ ] `CCPMonitoringService.validateValue()` - Real-time validation
- [ ] `CCPMonitoringService.determineResult()` - Result determination logic

### Validation
- [ ] `createCCPMonitoringSchema`
- [ ] `updateCCPMonitoringSchema`
- [ ] `verifyCCPMonitoringSchema`
- [ ] `ccpMonitoringListQuerySchema`

### Frontend
- [ ] CCP monitoring form page
- [ ] Monitoring queue page (due/overdue CCPs)
- [ ] Monitoring history page
- [ ] Deviation warning modal
- [ ] Corrective action form
- [ ] Verify record dialog (QA)
- [ ] Result badges (pass/fail/marginal)
- [ ] Real-time validation indicator
- [ ] Filter panel
- [ ] Search functionality

### Tests
- [ ] Unit tests: CCPMonitoringService methods (>80% coverage)
- [ ] Integration tests: All API endpoints
- [ ] Real-time validation tests
- [ ] Auto-lock tests (5min rule)
- [ ] Corrective action validation tests
- [ ] RLS tests: Multi-tenancy isolation
- [ ] E2E: Full monitoring workflow (select CCP -> record value -> pass/fail -> corrective action)

---

## Definition of Done

### Database
- [ ] `haccp_ccp_monitoring` table created with all columns
- [ ] All indexes created for performance
- [ ] RLS policies enforce org isolation
- [ ] DELETE policy blocks all deletes
- [ ] Auto-lock trigger works (5min rule)
- [ ] Result determination function works

### API
- [ ] All endpoints return correct HTTP status codes
- [ ] Validation errors return 400 with detailed messages
- [ ] Cross-tenant access returns 404
- [ ] Response times:
  - Monitoring list: < 500ms
  - Monitoring detail: < 500ms
  - Create: < 300ms

### Service
- [ ] Complete workflow: create -> validate -> deviation alert
- [ ] Result determination logic works (pass/fail/marginal)
- [ ] Auto-lock after 5min works
- [ ] Corrective action required for fail
- [ ] Audit trail created for all actions

### Frontend
- [ ] Monitoring form displays correctly
- [ ] Real-time validation works
- [ ] Deviation warning modal appears on fail
- [ ] Corrective action field mandatory if fail
- [ ] Monitoring queue shows due/overdue CCPs
- [ ] Monitoring history displays correctly
- [ ] Result badges display correctly
- [ ] Filters and search work

### Testing
- [ ] Unit tests: >80% coverage on service
- [ ] Integration tests: All endpoints covered
- [ ] Real-time validation tests passing
- [ ] Auto-lock tests passing
- [ ] RLS tests: Multi-tenancy verified
- [ ] E2E tests: Full workflow passing

### Integration
- [ ] Works with story 06.22 (CCP Definition)
- [ ] Works with Epic 04 (Work Orders)
- [ ] Works with Epic 05 (License Plates)
- [ ] Ready for story 06.24 (CCP Monitoring Scanner)
- [ ] Hooks for story 06.25 (CCP Deviation Handling)
- [ ] Hooks for story 06.26 (CCP Deviation Alerts)

---

## Risk Assessment

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Real-time validation performance | MEDIUM | LOW | Optimized validation logic, client-side caching |
| Auto-lock timing conflicts | MEDIUM | MEDIUM | Database trigger with timestamp check |
| Corrective action validation gaps | HIGH | LOW | Required field validation, unit tests |
| Deviation alert latency | HIGH | MEDIUM | Asynchronous alert processing, <30s SLA |
| Immutability enforcement | HIGH | LOW | RLS policies, is_locked checks |
| Performance with many records | MEDIUM | LOW | Proper indexes, pagination |

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-01-15 | Initial story creation - CCP Monitoring Desktop | OPUS |

---

**Document Status**: Ready for Implementation
**Created**: 2025-01-15
**Lines**: ~840
**Complexity**: M (Medium)
**Phase**: 3 (HACCP)
