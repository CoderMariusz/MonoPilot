# 06.28 - CoA Generation Engine

**Priority**: P0 (MVP)
**Story Points**: L (Large)
**Type**: backend
**Phase**: 3 (CoA & HACCP)
**Model**: OPUS

**State:** ready
**Estimate:** L (4-5 days)
**Primary PRD:** `docs/1-BASELINE/product/modules/quality.md` (FR-QA-011, Section 13)
**Architecture:** `docs/1-BASELINE/architecture/modules/quality.md` (certificates_of_analysis table)

---

## Goal

Implement the CoA generation engine that automatically creates certificates of analysis from templates after batch release. The engine populates CoA data from final inspection test results, batch information, and specification details. This is a critical regulatory compliance feature that enables automatic certificate generation for customer deliveries.

---

## Food Safety Compliance

This story is **critical for regulatory compliance**:

- [x] **FDA 21 CFR Part 11** - Electronic signatures and approval workflow required
- [x] **Customer Requirements** - CoA required for most food ingredient shipments
- [x] **Traceability** - CoA links batch to test results and specifications
- [x] **Audit Trail** - All CoA generation actions logged with timestamps
- [x] **Document Control** - CoA versioning and archival (10 years retention)

**Regulatory Context:**
- CoA generation must occur AFTER batch release approval
- All test results must be finalized before CoA generation
- QA Manager approval required before CoA issuance
- E-signature must capture user identity and meaning
- CoA number must be unique and sequential
- CoA must be immutable once approved (no edits)

---

## MVP Scope

This story implements Phase 3 CoA generation as the core engine for certificate creation.

**MVP Includes**:
- `certificates_of_analysis` table with immutability
- `coa_parameters` table for test result storage
- Auto-generate CoA from template after batch release
- Populate CoA with batch info (product, lot, date, expiry)
- Include all test results from final inspection
- Compliance statement generation
- QA Manager approval workflow with e-signature
- CoA number generation (COA-YYYY-NNNNN)
- CoA status workflow (draft → pending_approval → approved)
- Manual CoA creation for on-demand requests
- CoA regeneration if test results change (before approval)

**Deferred to Phase 3+**:
- PDF export (story 06.29)
- Email delivery to customers (story 06.29)
- Customer portal access (Phase 4)
- Barcode/QR code on CoA (story 06.29)
- Multi-language CoA (Phase 4)
- Customer-specific CoA overrides (Phase 4)

---

## User Story

As a **QA Manager**, I want **the system to automatically generate certificates of analysis from templates after batch release, populated with all test results and batch information** so that **I can review, approve, and issue CoAs to customers without manual data entry**.

As a **Quality Director**, I want **to approve CoAs with electronic signature before they are issued to customers** so that **we maintain regulatory compliance and document control**.

---

## Scope

**In scope (this story)**
- `certificates_of_analysis` table with approval workflow
- `coa_parameters` table for test results snapshot
- GET /api/quality/coas (list with filters)
- GET /api/quality/coas/:id (detail)
- POST /api/quality/coas (manual creation)
- POST /api/quality/coas/generate (auto-generate from batch)
- PUT /api/quality/coas/:id (update draft)
- POST /api/quality/coas/:id/approve (approve with e-signature)
- POST /api/quality/coas/:id/regenerate (regenerate if test results changed)
- DELETE /api/quality/coas/:id (delete draft)
- CoA generation service
- CoA approval workflow
- E-signature capture
- CoA data model and validation

**Out of scope (this story)**
- PDF export (story 06.29)
- Email delivery (story 06.29)
- S3/CDN storage (story 06.29)
- QR code generation (story 06.29)
- Batch release integration UI (story 06.12 handles trigger)
- Customer portal (Phase 4)

---

## Dependencies

### Cross-Epic Dependencies

| Dependency | Story/Epic | Type | What It Provides | Status |
|------------|------------|------|------------------|--------|
| 01.1 | Org Context + RLS | HARD | organizations, users, roles tables | Ready |
| 02.1 | Products CRUD | HARD | products table for product reference | Ready |
| 04.1 | Work Orders | HARD | work_orders table for batch reference | Ready |
| 06.3 | Product Specifications | HARD | quality_specifications table | Ready |
| 06.4 | Test Parameters | HARD | quality_spec_parameters for test data | Ready |
| 06.11 | Final Inspection | HARD | quality_inspections, quality_test_results | Ready |
| 06.12 | Batch Release Approval | HARD | Batch release triggers CoA generation | Ready |

### Within Epic Dependencies

| Dependency | Story | Type | What It Provides |
|------------|-------|------|------------------|
| 06.27 | CoA Templates | HARD | coa_templates table, template structure |

### Provides To (Downstream)

| Story | What This Provides |
|-------|-------------------|
| 06.29 | CoA PDF Export - CoA data for PDF generation |

---

## Database Migration

### Migration: Create certificates_of_analysis and coa_parameters tables

```sql
-- Migration: YYYYMMDDHHMMSS_create_certificates_of_analysis.sql

CREATE TABLE certificates_of_analysis (
    -- Identity
    id                      UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id                  UUID NOT NULL REFERENCES organizations(id),
    coa_number              TEXT NOT NULL,

    -- Batch Reference
    batch_id                UUID REFERENCES work_orders(id),
    batch_number            TEXT NOT NULL,

    -- Product Reference
    product_id              UUID NOT NULL REFERENCES products(id),

    -- Template Reference
    template_id             UUID REFERENCES coa_templates(id),

    -- Specification Reference
    spec_id                 UUID REFERENCES quality_specifications(id),

    -- Final Inspection Reference
    inspection_id           UUID REFERENCES quality_inspections(id),

    -- Batch Info (snapshot at time of CoA generation)
    manufactured_date       DATE NOT NULL,
    expiry_date             DATE,
    lot_number              TEXT,
    quantity                DECIMAL(12,3),
    unit                    TEXT,

    -- CoA Metadata
    issue_date              DATE NOT NULL DEFAULT CURRENT_DATE,
    issued_by               UUID REFERENCES users(id),

    -- Status
    status                  TEXT NOT NULL DEFAULT 'draft'
                            CHECK (status IN ('draft', 'pending_approval', 'approved', 'void')),

    -- Approval
    approved_by             UUID REFERENCES users(id),
    approved_at             TIMESTAMPTZ,
    approval_signature      TEXT,
    approval_meaning        TEXT,

    -- Document
    document_url            TEXT,

    -- Compliance Statements (snapshot from template)
    compliance_statements   TEXT[],

    -- Header/Footer (snapshot from template)
    header_text             TEXT,
    footer_text             TEXT,
    logo_url                TEXT,

    -- Immutability
    is_locked               BOOLEAN NOT NULL DEFAULT false,

    -- Void
    void_reason             TEXT,
    voided_by               UUID REFERENCES users(id),
    voided_at               TIMESTAMPTZ,

    -- Audit
    created_at              TIMESTAMPTZ NOT NULL DEFAULT now(),
    created_by              UUID REFERENCES users(id),
    updated_at              TIMESTAMPTZ NOT NULL DEFAULT now(),
    updated_by              UUID REFERENCES users(id),

    -- Constraints
    CONSTRAINT uq_coa_number UNIQUE (org_id, coa_number)
);

-- =============================================================================
-- CoA Parameters (Test Results Snapshot)
-- =============================================================================

CREATE TABLE coa_parameters (
    -- Identity
    id                      UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id                  UUID NOT NULL REFERENCES organizations(id),
    coa_id                  UUID NOT NULL REFERENCES certificates_of_analysis(id) ON DELETE CASCADE,

    -- Parameter Info
    parameter_name          TEXT NOT NULL,
    parameter_type          TEXT,

    -- Specification
    specification           TEXT,
    min_value               DECIMAL(12,3),
    max_value               DECIMAL(12,3),
    target_value            DECIMAL(12,3),
    unit                    TEXT,

    -- Test Result
    result_value            DECIMAL(12,3),
    result_text             TEXT,

    -- Method
    test_method             TEXT,

    -- Pass/Fail
    pass_fail               TEXT NOT NULL
                            CHECK (pass_fail IN ('pass', 'fail', 'n/a')),

    -- Display Order
    display_order           INTEGER NOT NULL DEFAULT 0,

    -- Audit
    created_at              TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- =============================================================================
-- Indexes for Performance
-- =============================================================================

CREATE INDEX idx_coas_org ON certificates_of_analysis(org_id);
CREATE INDEX idx_coas_org_status ON certificates_of_analysis(org_id, status);
CREATE INDEX idx_coas_batch ON certificates_of_analysis(batch_id) WHERE batch_id IS NOT NULL;
CREATE INDEX idx_coas_product ON certificates_of_analysis(product_id);
CREATE INDEX idx_coas_issue_date ON certificates_of_analysis(org_id, issue_date);
CREATE INDEX idx_coas_created ON certificates_of_analysis(org_id, created_at);
CREATE INDEX idx_coas_approved ON certificates_of_analysis(org_id, approved_at) WHERE approved_at IS NOT NULL;

CREATE INDEX idx_coa_params_coa ON coa_parameters(coa_id);
CREATE INDEX idx_coa_params_org ON coa_parameters(org_id);

-- =============================================================================
-- CoA Number Sequence
-- =============================================================================

CREATE TABLE coa_number_sequences (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    year INTEGER NOT NULL,
    current_value BIGINT NOT NULL DEFAULT 0,
    updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
    UNIQUE(org_id, year)
);

-- Function to generate CoA number (COA-YYYY-NNNNN)
CREATE OR REPLACE FUNCTION generate_coa_number(p_org_id UUID)
RETURNS TEXT AS $$
DECLARE
    v_year INTEGER;
    v_next_val BIGINT;
    v_coa_number TEXT;
BEGIN
    v_year := EXTRACT(YEAR FROM CURRENT_DATE);

    -- Upsert sequence and get next value
    INSERT INTO coa_number_sequences (org_id, year, current_value)
    VALUES (p_org_id, v_year, 1)
    ON CONFLICT (org_id, year)
    DO UPDATE SET
        current_value = coa_number_sequences.current_value + 1,
        updated_at = NOW()
    RETURNING current_value INTO v_next_val;

    -- Format CoA number
    v_coa_number := 'COA-' || v_year::TEXT || '-' || LPAD(v_next_val::TEXT, 5, '0');

    RETURN v_coa_number;
END;
$$ LANGUAGE plpgsql;

-- =============================================================================
-- RLS Policies
-- =============================================================================

ALTER TABLE certificates_of_analysis ENABLE ROW LEVEL SECURITY;

CREATE POLICY "coas_select" ON certificates_of_analysis
    FOR SELECT USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

CREATE POLICY "coas_insert" ON certificates_of_analysis
    FOR INSERT WITH CHECK (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

CREATE POLICY "coas_update" ON certificates_of_analysis
    FOR UPDATE USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
        AND is_locked = false
    );

-- Only allow delete of draft CoAs
CREATE POLICY "coas_delete" ON certificates_of_analysis
    FOR DELETE USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
        AND status = 'draft'
    );

ALTER TABLE coa_parameters ENABLE ROW LEVEL SECURITY;

CREATE POLICY "coa_params_org" ON coa_parameters
    FOR ALL TO authenticated
    USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

ALTER TABLE coa_number_sequences ENABLE ROW LEVEL SECURITY;

CREATE POLICY "coa_seq_org" ON coa_number_sequences
    FOR ALL TO authenticated
    USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

-- =============================================================================
-- Trigger for updated_at
-- =============================================================================

CREATE TRIGGER update_coas_updated_at
    BEFORE UPDATE ON certificates_of_analysis
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- =============================================================================
-- Function: Lock CoA on approval
-- =============================================================================

CREATE OR REPLACE FUNCTION lock_coa_on_approval()
RETURNS TRIGGER AS $$
BEGIN
    -- When CoA is approved, lock it (immutable)
    IF NEW.status = 'approved' AND (OLD.status IS NULL OR OLD.status != 'approved') THEN
        NEW.is_locked := true;
    END IF;

    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_lock_coa_on_approval
    BEFORE UPDATE ON certificates_of_analysis
    FOR EACH ROW
    WHEN (NEW.status = 'approved')
    EXECUTE FUNCTION lock_coa_on_approval();

-- =============================================================================
-- Function: Prevent updates to locked CoAs
-- =============================================================================

CREATE OR REPLACE FUNCTION prevent_locked_coa_update()
RETURNS TRIGGER AS $$
BEGIN
    IF OLD.is_locked = true AND NEW.status != 'void' THEN
        RAISE EXCEPTION 'Cannot update locked CoA. CoA is immutable once approved.';
    END IF;

    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_prevent_locked_update
    BEFORE UPDATE ON certificates_of_analysis
    FOR EACH ROW
    WHEN (OLD.is_locked = true)
    EXECUTE FUNCTION prevent_locked_coa_update();
```

---

## Acceptance Criteria (Given/When/Then)

### AC-1: CoA Table Creation

```gherkin
Scenario: certificates_of_analysis table exists with all required columns
  Given database migration runs
  When schema is inspected
  Then certificates_of_analysis table has all columns from schema
  And UNIQUE constraint exists on (org_id, coa_number)
  And FK constraints exist for all references
  And RLS policies enforce org isolation
```

### AC-2: CoA Number Auto-Generation

```gherkin
Scenario: Generate CoA number with year-based format
  Given organization exists
  When CoA created
  Then coa_number format is 'COA-2025-00001'
  And next CoA gets 'COA-2025-00002'
  And year resets sequence (first 2026 = 'COA-2026-00001')

Scenario: CoA number uniqueness
  Given CoA 'COA-2025-00001' exists in org A
  When creating another with same number in org A
  Then system returns 409 Conflict error
```

### AC-3: Auto-Generate CoA from Batch Release

```gherkin
Scenario: CoA generated after batch release
  Given batch WO-2025-00001 completed final inspection
  And all test results status = 'pass'
  And batch released by QA Manager
  When CoA generation triggered
  Then CoA created with:
    | Field | Value |
    | coa_number | COA-2025-00001 (auto-generated) |
    | batch_id | WO-2025-00001 |
    | product_id | From batch |
    | template_id | Active template for product |
    | spec_id | From final inspection |
    | inspection_id | Final inspection ID |
    | status | draft |
    | issue_date | Today |
  And coa_parameters records created from test results
  And compliance_statements copied from template

Scenario: CoA data snapshot from batch
  Given batch with:
    | Field | Value |
    | batch_number | B-2025-001 |
    | manufactured_date | 2025-01-10 |
    | expiry_date | 2025-07-10 |
    | quantity | 1000 kg |
  When CoA generated
  Then CoA contains snapshot:
    | manufactured_date | 2025-01-10 |
    | expiry_date | 2025-07-10 |
    | quantity | 1000 |
    | unit | kg |
```

### AC-4: Test Results Population

```gherkin
Scenario: CoA parameters populated from final inspection
  Given final inspection with test results:
    | Parameter | Spec | Result | Method | Status |
    | Protein % | 12-14% | 13.2% | AOAC 990.03 | pass |
    | Moisture % | Max 14% | 12.5% | AOAC 925.10 | pass |
    | Ash % | Max 0.8% | 0.65% | AOAC 923.03 | pass |
  When CoA generated
  Then coa_parameters table contains 3 records with:
    | parameter_name | specification | result_value | test_method | pass_fail |
    | Protein % | 12-14% | 13.2 | AOAC 990.03 | pass |
    | Moisture % | Max 14% | 12.5 | AOAC 925.10 | pass |
    | Ash % | Max 0.8% | 0.65 | AOAC 923.03 | pass |

Scenario: Result snapshot is immutable
  Given CoA generated with test results
  When final inspection test results updated after CoA creation
  Then CoA parameters remain unchanged (snapshot preserved)
```

### AC-5: Manual CoA Creation

```gherkin
Scenario: Create CoA manually for historical batch
  Given batch completed 30 days ago without CoA
  And user navigates to Quality > Certificates of Analysis
  When clicking [+ Generate CoA]
  And selecting batch B-2024-365
  And clicking [Generate]
  Then CoA created with status = 'draft'
  And test results populated from final inspection
  And success toast "CoA COA-2025-00001 generated"

Scenario: Manual CoA for customer request
  Given customer requests CoA for specific lot
  When QA Manager creates manual CoA
  Then can select batch from dropdown
  And can override issue_date (default = today)
```

### AC-6: CoA Approval Workflow

```gherkin
Scenario: Submit CoA for approval
  Given CoA in draft status
  When user clicks [Submit for Approval]
  Then status changes to 'pending_approval'
  And QA Manager notified
  And [Edit] button disabled

Scenario: QA Manager approves CoA with e-signature
  Given CoA in pending_approval
  And current user is QA_MANAGER
  When clicking [Approve CoA]
  And entering e-signature password
  And providing approval meaning: "Reviewed and approved for release"
  Then status changes to 'approved'
  And approved_by = current user
  And approved_at = now
  And approval_signature = encrypted signature
  And approval_meaning = provided text
  And is_locked = true (immutable)

Scenario: CoA becomes immutable after approval
  Given CoA with status = 'approved' and is_locked = true
  When attempting to update any field
  Then error: "Cannot update locked CoA. CoA is immutable once approved."
```

### AC-7: E-Signature Capture

```gherkin
Scenario: E-signature modal for approval
  Given QA Manager approving CoA
  When clicking [Approve]
  Then e-signature modal appears with:
    | Field | Description |
    | Username | Current user (read-only) |
    | Password | Password confirmation required |
    | Meaning | Text: "I approve this CoA for release" |
    | Approval Notes | Optional notes field |
  And user enters password
  And clicks [Sign and Approve]
  Then signature captured with timestamp

Scenario: E-signature validation
  Given e-signature modal
  When user enters incorrect password
  Then error: "Password incorrect. Cannot sign."
  And approval blocked

Scenario: E-signature meaning required
  Given e-signature modal
  When approval_meaning field is empty
  Then error: "Approval meaning required for FDA 21 CFR Part 11 compliance"
```

### AC-8: CoA Regeneration

```gherkin
Scenario: Regenerate draft CoA if test results updated
  Given CoA in draft status
  And final inspection test result updated (value changed)
  When user clicks [Regenerate CoA]
  Then coa_parameters deleted and recreated from latest test results
  And warning: "CoA will be regenerated with latest test data. Continue?"
  And if confirmed, CoA parameters updated

Scenario: Cannot regenerate approved CoA
  Given CoA with status = 'approved'
  Then [Regenerate] button disabled
  And tooltip: "Approved CoAs cannot be regenerated"
```

### AC-9: CoA List and Filters

```gherkin
Scenario: CoA list loads
  Given user navigates to Quality > Certificates of Analysis
  When page loads
  Then DataTable displays CoAs with columns:
    | Column | Description |
    | CoA # | Link to detail |
    | Batch | Batch number |
    | Product | Product name |
    | Issue Date | Date issued |
    | Status | Badge (draft/pending/approved/void) |
    | Approved By | User name or "Pending" |
    | Approved At | Timestamp |
    | Actions | View, Approve, Download (if approved) |

Scenario: Filter by status
  Given CoAs exist with various statuses
  When user filters by status = 'approved'
  Then only approved CoAs display

Scenario: Filter by date range
  Given CoAs issued in last 90 days
  When user filters by issue_date range = last 30 days
  Then only CoAs from last 30 days display

Scenario: Search by CoA number or batch
  Given CoAs exist
  When user searches "COA-2025-00001" or "B-2025-001"
  Then matching CoAs display
```

### AC-10: CoA Detail Page

```gherkin
Scenario: View CoA detail
  Given CoA COA-2025-00001 exists
  When user navigates to /quality/coas/COA-2025-00001
  Then page displays:
    | Section | Content |
    | Header | CoA #, Status badge, Issue date |
    | Batch Info | Batch #, Product, Manufactured date, Expiry, Quantity |
    | Specification | Spec name/version |
    | Test Results | Parameters table (name, spec, result, method, pass/fail) |
    | Compliance | List of compliance statements |
    | Approval | Approved by, Approved at, Signature, Meaning |
    | Actions | Download PDF (if approved), Void (if approved) |
```

### AC-11: CoA Void Workflow

```gherkin
Scenario: Void approved CoA
  Given CoA with status = 'approved'
  And current user is QA_MANAGER or QUALITY_DIRECTOR
  When clicking [Void CoA]
  And providing void_reason: "Incorrect batch number"
  And confirming action
  Then status changes to 'void'
  And voided_by = current user
  And voided_at = now
  And void_reason saved
  And CoA remains immutable (no edits allowed)

Scenario: Voided CoA marked in list
  Given CoA with status = 'void'
  When viewing CoA list
  Then status badge shows "VOID" in red
  And row styled differently (strikethrough or grayed out)
```

### AC-12: CoA Deletion

```gherkin
Scenario: Delete draft CoA
  Given CoA with status = 'draft'
  When user clicks [Delete]
  And confirms deletion
  Then CoA and all coa_parameters deleted from database
  And success toast "CoA deleted"

Scenario: Cannot delete approved CoA
  Given CoA with status = 'approved'
  Then [Delete] button disabled
  And tooltip: "Approved CoAs cannot be deleted. Use Void instead."
```

### AC-13: Template Snapshot

```gherkin
Scenario: CoA snapshots template data on generation
  Given active template has:
    | Field | Value |
    | header_template | "Certified Analysis Report" |
    | footer_template | "Lab #12345" |
    | logo_url | "https://cdn.../logo.png" |
    | compliance_statements | ["Kosher", "Organic"] |
  When CoA generated from template
  Then CoA contains snapshot:
    | header_text | "Certified Analysis Report" |
    | footer_text | "Lab #12345" |
    | logo_url | "https://cdn.../logo.png" |
    | compliance_statements | ["Kosher", "Organic"] |
  And if template later updated, CoA remains unchanged

Scenario: CoA without template uses defaults
  Given product has no active CoA template
  When CoA generated
  Then header_text = NULL
  And footer_text = NULL
  And logo_url = NULL
  And compliance_statements = []
  And CoA still created successfully
```

### AC-14: Permission Enforcement

```gherkin
Scenario: QA Inspector can create draft CoAs
  Given user with QA_INSPECTOR role
  When generating CoA
  Then can create CoA with status = 'draft'
  But cannot approve CoA

Scenario: QA Manager can approve CoAs
  Given user with QA_MANAGER role
  When CoA in pending_approval
  Then can approve with e-signature
  And can void approved CoAs

Scenario: Viewer cannot create CoAs
  Given user with VIEWER role
  When viewing CoA list
  Then [+ Generate CoA] button hidden
  And can only view CoA details
```

### AC-15: RLS Policy Enforcement

```gherkin
Scenario: Org isolation on CoA list
  Given User A from Org A and User B from Org B
  And CoAs exist in both orgs
  When User A requests GET /api/quality/coas
  Then only Org A CoAs returned

Scenario: Cannot view CoA from different org
  Given CoA belongs to Org B
  When User A (Org A) requests GET /api/quality/coas/:id
  Then 404 Not Found returned
```

### AC-16: Performance Requirements

```gherkin
Scenario: CoA generation performance
  Given batch with 20 test results
  When generating CoA
  Then CoA creation completes < 2 seconds

Scenario: CoA list performance
  Given 500 CoAs in organization
  When listing CoAs with pagination
  Then response time < 500ms

Scenario: CoA detail performance
  Given CoA with 30 parameters
  When loading CoA detail page
  Then response time < 500ms
```

---

## Implementation Notes

### API Endpoints

```typescript
// =============================================================================
// CoA Endpoints
// =============================================================================

// GET /api/quality/coas
interface CoAListParams {
  status?: 'draft' | 'pending_approval' | 'approved' | 'void';
  product_id?: string;
  batch_id?: string;
  issue_date_from?: string;
  issue_date_to?: string;
  search?: string;
  sort_by?: 'coa_number' | 'issue_date' | 'batch_number' | 'created_at';
  sort_order?: 'asc' | 'desc';
  page?: number;
  limit?: number;
}

interface CertificateOfAnalysis {
  id: string;
  org_id: string;
  coa_number: string;
  batch_id?: string;
  batch_number: string;
  product_id: string;
  product_name: string;
  product_code: string;
  template_id?: string;
  template_name?: string;
  spec_id?: string;
  spec_number?: string;
  inspection_id?: string;
  manufactured_date: string;
  expiry_date?: string;
  lot_number?: string;
  quantity: number;
  unit: string;
  issue_date: string;
  issued_by?: string;
  status: 'draft' | 'pending_approval' | 'approved' | 'void';
  approved_by?: string;
  approved_at?: string;
  approval_meaning?: string;
  document_url?: string;
  compliance_statements: string[];
  header_text?: string;
  footer_text?: string;
  logo_url?: string;
  is_locked: boolean;
  void_reason?: string;
  voided_by?: string;
  voided_at?: string;
  created_at: string;
  created_by: string;
  updated_at: string;
}

interface CoAParameter {
  id: string;
  parameter_name: string;
  parameter_type?: string;
  specification?: string;
  min_value?: number;
  max_value?: number;
  target_value?: number;
  unit?: string;
  result_value?: number;
  result_text?: string;
  test_method?: string;
  pass_fail: 'pass' | 'fail' | 'n/a';
  display_order: number;
}

// POST /api/quality/coas/generate
interface GenerateCoARequest {
  batch_id: string;
  template_id?: string; // Optional override
  issue_date?: string; // Optional override (default = today)
}

interface GenerateCoAResponse {
  coa: CertificateOfAnalysis;
  parameters: CoAParameter[];
}

// POST /api/quality/coas/:id/approve
interface ApproveCoARequest {
  password: string; // E-signature password
  approval_meaning: string;
  approval_notes?: string;
}

interface ApproveCoAResponse {
  coa: CertificateOfAnalysis;
  signature_captured: boolean;
}

// POST /api/quality/coas/:id/void
interface VoidCoARequest {
  void_reason: string;
}

// POST /api/quality/coas/:id/regenerate
interface RegenerateCoAResponse {
  coa: CertificateOfAnalysis;
  parameters: CoAParameter[];
  regenerated: boolean;
}

// GET /api/quality/coas/:id
interface CoADetailResponse {
  coa: CertificateOfAnalysis;
  parameters: CoAParameter[];
  batch_info: {
    work_order_number: string;
    routing_name: string;
    completed_at: string;
  };
}
```

---

## Service Layer

```typescript
// lib/services/coa-service.ts

export class CoAService {
  /**
   * List CoAs with filtering and pagination
   */
  static async list(params: CoAListParams): Promise<PaginatedResult<CertificateOfAnalysis>>;

  /**
   * Get CoA by ID with parameters
   */
  static async getById(id: string): Promise<CoADetail | null>;

  /**
   * Generate CoA from batch (manual or auto)
   */
  static async generate(batchId: string, options?: GenerateOptions): Promise<CoADetail>;

  /**
   * Update CoA (draft only)
   */
  static async update(id: string, input: UpdateCoAInput): Promise<CertificateOfAnalysis>;

  /**
   * Submit CoA for approval
   */
  static async submitForApproval(id: string): Promise<CertificateOfAnalysis>;

  /**
   * Approve CoA with e-signature
   */
  static async approve(
    id: string,
    password: string,
    meaning: string,
    userId: string
  ): Promise<CertificateOfAnalysis>;

  /**
   * Void approved CoA
   */
  static async void(id: string, reason: string, userId: string): Promise<CertificateOfAnalysis>;

  /**
   * Regenerate CoA parameters from latest test results (draft only)
   */
  static async regenerate(id: string): Promise<CoADetail>;

  /**
   * Delete CoA (draft only)
   */
  static async delete(id: string): Promise<void>;

  /**
   * Populate CoA parameters from inspection test results
   */
  static async populateParameters(coaId: string, inspectionId: string): Promise<CoAParameter[]>;

  /**
   * Snapshot template data to CoA
   */
  static async snapshotTemplate(coaId: string, templateId: string): Promise<void>;

  /**
   * Generate CoA number
   */
  static async generateCoANumber(): Promise<string>;

  /**
   * Verify e-signature password
   */
  static async verifySignature(userId: string, password: string): Promise<boolean>;
}
```

---

## Deliverables

### Database
- [ ] Migration: `certificates_of_analysis` table
- [ ] Migration: `coa_parameters` table
- [ ] Migration: `coa_number_sequences` table
- [ ] Function: `generate_coa_number()`
- [ ] Function: `lock_coa_on_approval()` trigger
- [ ] Function: `prevent_locked_coa_update()` trigger
- [ ] RLS policies for all CoA tables
- [ ] All performance indexes

### API Routes
- [ ] `GET /api/quality/coas` - List with filters
- [ ] `GET /api/quality/coas/:id` - Get detail with parameters
- [ ] `POST /api/quality/coas/generate` - Generate from batch
- [ ] `PUT /api/quality/coas/:id` - Update draft
- [ ] `DELETE /api/quality/coas/:id` - Delete draft
- [ ] `POST /api/quality/coas/:id/approve` - Approve with e-signature
- [ ] `POST /api/quality/coas/:id/void` - Void CoA
- [ ] `POST /api/quality/coas/:id/regenerate` - Regenerate parameters

### Service Layer
- [ ] `CoAService.generate()` - Generate from batch
- [ ] `CoAService.approve()` - Approval with e-signature
- [ ] `CoAService.populateParameters()` - Test results snapshot
- [ ] `CoAService.snapshotTemplate()` - Template snapshot
- [ ] `CoAService.verifySignature()` - E-signature validation
- [ ] `CoAService.regenerate()` - Regenerate parameters

### Validation
- [ ] `generateCoASchema`
- [ ] `approveCoASchema`
- [ ] `voidCoASchema`
- [ ] `coaListQuerySchema`

### Tests
- [ ] Unit tests: CoAService methods (>80% coverage)
- [ ] Integration tests: All API endpoints
- [ ] CoA generation from batch tests
- [ ] E-signature validation tests
- [ ] Immutability tests (locked CoAs)
- [ ] RLS tests: Multi-tenancy isolation
- [ ] E2E: Full CoA generation and approval workflow

---

## Definition of Done

### Database
- [ ] All tables created with proper constraints
- [ ] Indexes optimize query performance
- [ ] RLS policies enforce org isolation
- [ ] Triggers work correctly (locking, immutability)
- [ ] CoA number generation works

### API
- [ ] All endpoints return correct HTTP status codes
- [ ] Validation errors return 400 with detailed messages
- [ ] Cross-tenant access returns 404
- [ ] Response times meet NFRs

### Service
- [ ] CoA generation from batch works
- [ ] Parameters populated from test results
- [ ] Template snapshot works
- [ ] Approval workflow with e-signature works
- [ ] Immutability enforced after approval

### Testing
- [ ] Unit tests: >80% coverage on service
- [ ] Integration tests: All endpoints covered
- [ ] E2E tests: CoA generation and approval workflow
- [ ] RLS tests: Multi-tenancy verified

---

## Risk Assessment

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Test result snapshot inconsistency | HIGH | LOW | Transaction, data validation |
| E-signature security | HIGH | MEDIUM | Password hash verification, audit log |
| CoA immutability race condition | MEDIUM | LOW | Database trigger with row locking |
| Template not found for product | MEDIUM | MEDIUM | Fallback to manual template selection |
| Performance with many parameters | MEDIUM | LOW | Pagination, indexed queries |

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-01-15 | Initial story creation | ARCHITECT-AGENT |

---

**Document Status**: Ready for Implementation
**Created**: 2025-01-15
**Lines**: ~960
**Complexity**: L (Large)
**Phase**: 3 (CoA & HACCP)
