# 06.14 - NCR Root Cause Analysis

**Priority**: P0 (MVP)
**Story Points**: M (Medium)
**Type**: fullstack
**Phase**: 2B (NCR Workflow)
**Model**: OPUS

**State:** ready
**Estimate:** M (2-3 days)
**Primary PRD:** `docs/1-BASELINE/product/modules/quality.md` (FR-QA-009, Section 8.2)
**Architecture:** `docs/1-BASELINE/architecture/modules/quality.md` (ncr_root_causes table)

---

## Goal

Implement **NCR Root Cause Analysis** functionality including 5-Why analysis tool, Fishbone (Ishikawa) diagram builder, root cause classification, evidence upload, impact assessment, and QA Manager approval workflow. This story enables systematic identification of root causes for non-conformances, ensuring proper investigation before corrective actions are planned.

---

## Food Safety Compliance

This story is **critical for food safety compliance**:

- [x] **FDA 21 CFR Part 11** - Audit trail for all root cause analysis actions
- [x] **HACCP Compliance** - Root cause analysis required for CCP deviations
- [x] **ISO 9001/22000** - Systematic root cause analysis methodology
- [x] **FSMA** - Corrective actions must address root cause, not symptoms

**Regulatory Context:**
- FDA requires documented root cause for food safety non-conformances
- ISO 22000 requires systematic investigation of quality issues
- Root cause must be identified before corrective actions
- QA Manager approval required for critical NCRs
- All evidence and analysis retained for 10+ years

---

## MVP Scope

This story implements **Phase 2B Root Cause Analysis** functionality.

**MVP Includes**:
- `ncr_root_causes` table with root cause details
- `ncr_root_cause_factors` table (Fishbone categories)
- `ncr_evidence_attachments` table for supporting documents
- 5-Why analysis tool (iterative questioning up to 5 levels)
- Fishbone diagram builder (6 M categories)
- Root cause classification (systemic/random/procedural)
- Supporting evidence upload (photos, documents)
- Impact assessment (cost, customer impact, regulatory)
- Root cause approval workflow (QA Manager)
- Root cause summary display on NCR detail page

**Deferred to Phase 2+ (Stories 06.15-06.16)**:
- Corrective action planning (story 06.15)
- Verification and closure (story 06.16)
- CAPA auto-creation for systemic issues (story 06.31)

---

## User Story

As a **QA Investigator**, I want to **systematically analyze root causes using 5-Why and Fishbone methods, document contributing factors, and upload evidence** so that **we identify the true root cause of non-conformances, not just symptoms**.

As a **QA Manager**, I want to **review and approve root cause analyses for critical NCRs before corrective actions proceed** so that **we ensure thorough investigation and appropriate response to quality issues**.

---

## Scope

**In scope (this story)**
- `ncr_root_causes` table with analysis data
- `ncr_root_cause_factors` table for Fishbone factors
- `ncr_evidence_attachments` table for uploads
- POST /api/quality/ncrs/:id/root-cause (create/update analysis)
- PUT /api/quality/ncrs/:id/root-cause/:causeId (update analysis)
- POST /api/quality/ncrs/:id/root-cause/approve (QA Manager approval)
- POST /api/quality/ncrs/:id/root-cause/attachments (upload evidence)
- GET /api/quality/ncrs/:id/root-cause (get analysis)
- DELETE /api/quality/ncrs/:id/root-cause/attachments/:attachmentId
- 5-Why wizard UI (5 sequential questions)
- Fishbone diagram interactive builder
- Root cause classification selector
- Impact assessment form
- Evidence upload component
- Root cause summary card
- Approval workflow UI
- NCR status transition: root_cause -> approved_root_cause

**Out of scope (this story)**
- Corrective action planning (story 06.15)
- Verification workflow (story 06.16)
- Auto-CAPA creation (story 06.31)
- AI-assisted root cause suggestions (future)
- Integration with external LIMS (future)

---

## Dependencies

### Cross-Epic Dependencies

| Dependency | Story/Epic | Type | What It Provides | Status |
|------------|------------|------|------------------|--------|
| 01.1 | Org Context + RLS | HARD | organizations, users, roles tables | Ready |
| 01.x | File Storage | SOFT | Attachment storage (Supabase Storage) | Ready |

### Within Epic Dependencies

| Dependency | Story | Type | What It Provides |
|------------|-------|------|------------------|
| 06.9 | Basic NCR Creation | HARD | ncr_reports table, NCR basic structure |
| 06.13 | NCR Workflow | HARD | NCR workflow states, status='root_cause' |

### Provides To (Downstream)

| Story | What This Provides |
|-------|-------------------|
| 06.15 | NCR Corrective Action - approved root cause analysis |
| 06.16 | NCR Verification - root cause reference |
| 06.31 | CAPA Creation - systemic root cause triggers |

---

## Database Migration

### Migration: Create ncr_root_causes table

```sql
-- Migration: YYYYMMDDHHMMSS_create_ncr_root_causes.sql

-- =============================================================================
-- NCR Root Causes Table
-- =============================================================================

CREATE TABLE ncr_root_causes (
    -- Identity
    id                      UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id                  UUID NOT NULL REFERENCES organizations(id),
    ncr_id                  UUID NOT NULL REFERENCES ncr_reports(id) ON DELETE CASCADE,

    -- 5-Why Analysis
    why_1                   TEXT,
    why_1_answer            TEXT,
    why_2                   TEXT,
    why_2_answer            TEXT,
    why_3                   TEXT,
    why_3_answer            TEXT,
    why_4                   TEXT,
    why_4_answer            TEXT,
    why_5                   TEXT,
    why_5_answer            TEXT,
    why_levels_used         INTEGER DEFAULT 0 CHECK (why_levels_used >= 0 AND why_levels_used <= 5),

    -- Root Cause Statement
    root_cause_statement    TEXT,
    root_cause_summary      TEXT,

    -- Classification
    classification          TEXT NOT NULL DEFAULT 'unknown'
                            CHECK (classification IN ('systemic', 'random', 'procedural', 'human_error',
                                                      'equipment', 'material', 'environmental', 'unknown')),
    is_recurring            BOOLEAN DEFAULT false,
    recurrence_count        INTEGER DEFAULT 0,
    related_ncr_ids         UUID[],

    -- Impact Assessment
    impact_cost             DECIMAL(12,2),
    impact_cost_currency    TEXT DEFAULT 'USD',
    impact_customer         TEXT
                            CHECK (impact_customer IN ('none', 'minor', 'moderate', 'major', 'critical')),
    impact_customer_notes   TEXT,
    impact_regulatory       TEXT
                            CHECK (impact_regulatory IN ('none', 'notification_required', 'audit_finding',
                                                         'violation', 'recall_potential')),
    impact_regulatory_notes TEXT,
    impact_production       TEXT
                            CHECK (impact_production IN ('none', 'minor_delay', 'significant_delay',
                                                         'batch_loss', 'line_shutdown')),
    impact_production_notes TEXT,

    -- Approval Workflow
    status                  TEXT NOT NULL DEFAULT 'draft'
                            CHECK (status IN ('draft', 'submitted', 'approved', 'rejected', 'revision_required')),
    submitted_at            TIMESTAMPTZ,
    submitted_by            UUID REFERENCES users(id),
    approved_at             TIMESTAMPTZ,
    approved_by             UUID REFERENCES users(id),
    approval_notes          TEXT,
    rejection_reason        TEXT,

    -- Investigator
    investigator_id         UUID REFERENCES users(id),
    investigation_started   TIMESTAMPTZ,
    investigation_completed TIMESTAMPTZ,

    -- Audit
    created_at              TIMESTAMPTZ NOT NULL DEFAULT now(),
    created_by              UUID REFERENCES users(id),
    updated_at              TIMESTAMPTZ NOT NULL DEFAULT now(),
    updated_by              UUID REFERENCES users(id),

    -- Constraints
    CONSTRAINT uq_ncr_root_cause UNIQUE (ncr_id),
    CONSTRAINT check_approval_fields CHECK (
        (status = 'approved' AND approved_at IS NOT NULL AND approved_by IS NOT NULL)
        OR (status != 'approved')
    ),
    CONSTRAINT check_rejection_fields CHECK (
        (status = 'rejected' AND rejection_reason IS NOT NULL)
        OR (status != 'rejected')
    )
);

-- =============================================================================
-- NCR Root Cause Factors Table (Fishbone/Ishikawa Categories)
-- =============================================================================

CREATE TABLE ncr_root_cause_factors (
    -- Identity
    id                      UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id                  UUID NOT NULL REFERENCES organizations(id),
    root_cause_id           UUID NOT NULL REFERENCES ncr_root_causes(id) ON DELETE CASCADE,

    -- Fishbone Category (6 M's)
    category                TEXT NOT NULL
                            CHECK (category IN ('man', 'machine', 'material', 'method', 'measurement', 'mother_nature')),

    -- Factor Details
    factor_description      TEXT NOT NULL,
    is_contributing         BOOLEAN DEFAULT true,
    is_primary              BOOLEAN DEFAULT false,
    evidence_notes          TEXT,
    sequence                INTEGER DEFAULT 0,

    -- Audit
    created_at              TIMESTAMPTZ NOT NULL DEFAULT now(),
    created_by              UUID REFERENCES users(id),
    updated_at              TIMESTAMPTZ NOT NULL DEFAULT now(),
    updated_by              UUID REFERENCES users(id)
);

-- =============================================================================
-- NCR Evidence Attachments Table
-- =============================================================================

CREATE TABLE ncr_evidence_attachments (
    -- Identity
    id                      UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id                  UUID NOT NULL REFERENCES organizations(id),
    ncr_id                  UUID NOT NULL REFERENCES ncr_reports(id) ON DELETE CASCADE,
    root_cause_id           UUID REFERENCES ncr_root_causes(id) ON DELETE SET NULL,

    -- File Information
    file_name               TEXT NOT NULL,
    file_type               TEXT NOT NULL,
    file_size               INTEGER NOT NULL,
    file_path               TEXT NOT NULL,
    storage_bucket          TEXT DEFAULT 'ncr-evidence',

    -- Metadata
    description             TEXT,
    attachment_type         TEXT NOT NULL DEFAULT 'other'
                            CHECK (attachment_type IN ('photo', 'document', 'video', 'test_result',
                                                       'coa', 'inspection_record', 'other')),
    is_primary_evidence     BOOLEAN DEFAULT false,

    -- Upload Details
    uploaded_at             TIMESTAMPTZ NOT NULL DEFAULT now(),
    uploaded_by             UUID NOT NULL REFERENCES users(id),

    -- Audit
    created_at              TIMESTAMPTZ NOT NULL DEFAULT now(),
    updated_at              TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- =============================================================================
-- Indexes for Performance
-- =============================================================================

CREATE INDEX idx_root_cause_ncr ON ncr_root_causes(ncr_id);
CREATE INDEX idx_root_cause_org ON ncr_root_causes(org_id);
CREATE INDEX idx_root_cause_status ON ncr_root_causes(org_id, status);
CREATE INDEX idx_root_cause_classification ON ncr_root_causes(org_id, classification);
CREATE INDEX idx_root_cause_investigator ON ncr_root_causes(investigator_id) WHERE investigator_id IS NOT NULL;

CREATE INDEX idx_root_cause_factors_root ON ncr_root_cause_factors(root_cause_id);
CREATE INDEX idx_root_cause_factors_category ON ncr_root_cause_factors(root_cause_id, category);

CREATE INDEX idx_evidence_ncr ON ncr_evidence_attachments(ncr_id);
CREATE INDEX idx_evidence_root_cause ON ncr_evidence_attachments(root_cause_id) WHERE root_cause_id IS NOT NULL;
CREATE INDEX idx_evidence_org ON ncr_evidence_attachments(org_id);
CREATE INDEX idx_evidence_type ON ncr_evidence_attachments(org_id, attachment_type);

-- =============================================================================
-- RLS Policies
-- =============================================================================

ALTER TABLE ncr_root_causes ENABLE ROW LEVEL SECURITY;

CREATE POLICY "root_cause_select" ON ncr_root_causes
    FOR SELECT USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

CREATE POLICY "root_cause_insert" ON ncr_root_causes
    FOR INSERT WITH CHECK (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

CREATE POLICY "root_cause_update" ON ncr_root_causes
    FOR UPDATE USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
        AND (status IN ('draft', 'revision_required') OR approved_by = auth.uid())
    );

CREATE POLICY "root_cause_delete" ON ncr_root_causes
    FOR DELETE USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
        AND status = 'draft'
    );

ALTER TABLE ncr_root_cause_factors ENABLE ROW LEVEL SECURITY;

CREATE POLICY "factors_select" ON ncr_root_cause_factors
    FOR SELECT USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

CREATE POLICY "factors_insert" ON ncr_root_cause_factors
    FOR INSERT WITH CHECK (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

CREATE POLICY "factors_update" ON ncr_root_cause_factors
    FOR UPDATE USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

CREATE POLICY "factors_delete" ON ncr_root_cause_factors
    FOR DELETE USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

ALTER TABLE ncr_evidence_attachments ENABLE ROW LEVEL SECURITY;

CREATE POLICY "evidence_select" ON ncr_evidence_attachments
    FOR SELECT USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

CREATE POLICY "evidence_insert" ON ncr_evidence_attachments
    FOR INSERT WITH CHECK (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

CREATE POLICY "evidence_delete" ON ncr_evidence_attachments
    FOR DELETE USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

-- =============================================================================
-- Triggers for updated_at
-- =============================================================================

CREATE TRIGGER update_ncr_root_causes_updated_at
    BEFORE UPDATE ON ncr_root_causes
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_ncr_root_cause_factors_updated_at
    BEFORE UPDATE ON ncr_root_cause_factors
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_ncr_evidence_attachments_updated_at
    BEFORE UPDATE ON ncr_evidence_attachments
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- =============================================================================
-- Comments
-- =============================================================================

COMMENT ON TABLE ncr_root_causes IS 'NCR Root Cause Analysis - 5-Why, Fishbone, Impact Assessment';
COMMENT ON COLUMN ncr_root_causes.classification IS 'Root cause type: systemic, random, procedural, etc.';
COMMENT ON COLUMN ncr_root_causes.why_levels_used IS 'Number of why levels completed (1-5)';
COMMENT ON TABLE ncr_root_cause_factors IS 'Fishbone (Ishikawa) diagram factors - 6 M categories';
COMMENT ON COLUMN ncr_root_cause_factors.category IS '6 M: Man, Machine, Material, Method, Measurement, Mother Nature';
COMMENT ON TABLE ncr_evidence_attachments IS 'Supporting evidence uploads for NCR investigation';
```

---

## Acceptance Criteria (Given/When/Then)

### AC-1: Root Cause Tables Creation

```gherkin
Scenario: ncr_root_causes table exists with all required columns
  Given database migration runs
  When schema is inspected
  Then ncr_root_causes table has all columns from schema
  And UNIQUE constraint exists on ncr_id
  And FK constraints exist for all references
  And RLS policies enforce org isolation
  And status CHECK constraint allows: draft, submitted, approved, rejected, revision_required

Scenario: ncr_root_cause_factors table exists
  Given migration runs
  Then ncr_root_cause_factors table created
  And category CHECK includes all 6 M's

Scenario: ncr_evidence_attachments table exists
  Given migration runs
  Then ncr_evidence_attachments table created
  And attachment_type includes: photo, document, video, test_result, coa, inspection_record, other
```

### AC-2: 5-Why Analysis Tool

```gherkin
Scenario: Start 5-Why analysis
  Given NCR with status = 'root_cause'
  And user navigates to NCR Root Cause tab
  When user clicks [Start 5-Why Analysis]
  Then 5-Why wizard opens with first question
  And form displays:
    | Field | Description |
    | Why 1 | "Why did [NCR title] occur?" |
    | Answer 1 | Text input for answer |
    | [Next Why] | Button to add next level |

Scenario: Complete 5-Why iteratively
  Given user starts 5-Why analysis
  When user enters Why 1 answer: "Temperature exceeded limit"
  And clicks [Add Next Why]
  Then Why 2 shows: "Why did temperature exceed limit?"
  And placeholder shows previous answer
  When user enters Why 2: "Refrigeration unit failed"
  And clicks [Add Next Why]
  Then Why 3 shows: "Why did refrigeration unit fail?"
  And process continues up to Why 5

Scenario: 5-Why can stop before level 5
  Given user has answered Why 1, Why 2, Why 3
  And root cause is evident
  When user clicks [Root Cause Identified]
  Then why_levels_used = 3
  And root_cause_statement auto-populated from Why 3 answer
  And user can edit/confirm statement

Scenario: 5-Why validation
  Given user on Why 1
  When user clicks [Next Why] without answer
  Then error: "Please provide an answer before proceeding"
  And minimum 10 characters required per answer
```

### AC-3: Fishbone Diagram Builder

```gherkin
Scenario: Open Fishbone builder
  Given NCR with status = 'root_cause'
  When user clicks [Fishbone Analysis] tab
  Then interactive Fishbone diagram displays with 6 categories:
    | Category | Display Name | Icon |
    | man | Man (People) | Person icon |
    | machine | Machine (Equipment) | Gear icon |
    | material | Material (Inputs) | Box icon |
    | method | Method (Process) | Flow icon |
    | measurement | Measurement (Data) | Ruler icon |
    | mother_nature | Mother Nature (Environment) | Cloud icon |

Scenario: Add factor to Fishbone category
  Given Fishbone diagram visible
  When user clicks [+] on "Machine" category
  Then factor input form appears:
    | Field | Required |
    | Description | Yes |
    | Is Contributing | Yes (default true) |
    | Is Primary Cause | No (default false) |
    | Evidence Notes | No |
  And user enters: "Compressor seal degraded"
  And marks as contributing
  Then factor appears as branch on Machine bone
  And factor saved to ncr_root_cause_factors table

Scenario: Mark primary contributing factor
  Given multiple factors added across categories
  When user marks one factor as "Primary Cause"
  Then factor highlighted in red
  And other primary flags cleared (only one primary allowed)
  And root_cause_statement suggestion updated

Scenario: Edit/Delete factor
  Given factor exists in Fishbone
  When user clicks factor
  Then edit form appears
  And user can modify or delete factor
  And changes saved immediately

Scenario: Visual Fishbone representation
  Given multiple factors in categories
  When viewing Fishbone diagram
  Then factors displayed as branches from main categories
  And contributing factors in blue
  And primary factor in red with star
  And non-contributing factors in gray (strikethrough)
```

### AC-4: Root Cause Classification

```gherkin
Scenario: Classify root cause type
  Given root cause analysis in progress
  When user selects classification dropdown
  Then options displayed:
    | Classification | Description |
    | systemic | Recurring organizational/process issue |
    | random | One-time occurrence, no pattern |
    | procedural | SOP not followed or SOP inadequate |
    | human_error | Individual mistake (training issue) |
    | equipment | Equipment failure or malfunction |
    | material | Raw material or input defect |
    | environmental | External conditions (temp, humidity) |
    | unknown | Unable to determine |

Scenario: Systemic classification triggers CAPA suggestion
  Given user selects classification = 'systemic'
  Then message displays: "Systemic root cause identified. Consider creating CAPA."
  And [Create CAPA] button appears (future - story 06.31)
  And is_recurring checkbox enabled

Scenario: Mark as recurring issue
  Given classification = 'systemic' or 'procedural'
  When user checks "This is a recurring issue"
  Then is_recurring = true
  And related_ncr_ids field appears
  And user can link related NCR numbers
```

### AC-5: Impact Assessment

```gherkin
Scenario: Complete impact assessment
  Given root cause analysis in progress
  When user navigates to Impact Assessment section
  Then form displays:
    | Field | Type | Options |
    | Cost Impact | Currency input | 0-999999.99 |
    | Customer Impact | Dropdown | none/minor/moderate/major/critical |
    | Customer Notes | Text | Optional explanation |
    | Regulatory Impact | Dropdown | none/notification_required/audit_finding/violation/recall_potential |
    | Regulatory Notes | Text | Optional explanation |
    | Production Impact | Dropdown | none/minor_delay/significant_delay/batch_loss/line_shutdown |
    | Production Notes | Text | Optional explanation |

Scenario: High impact triggers escalation message
  Given user selects impact_customer = 'critical'
  Or impact_regulatory = 'recall_potential'
  Then warning displays: "High impact detected. QA Manager review required."
  And NCR automatically flagged for priority review

Scenario: Cost impact validation
  Given user enters cost impact
  Then currency selector available (USD default)
  And maximum 12 digits, 2 decimal places
  And negative values not allowed
```

### AC-6: Evidence Upload

```gherkin
Scenario: Upload supporting evidence
  Given root cause analysis in progress
  When user clicks [Upload Evidence]
  Then file upload dialog appears
  And allowed file types: jpg, png, pdf, doc, docx, xls, xlsx, mp4
  And max file size: 25MB per file
  And max files per NCR: 20

Scenario: Categorize uploaded evidence
  Given user uploads file "compressor_photo.jpg"
  Then categorization form appears:
    | Field | Value |
    | File Name | compressor_photo.jpg (editable) |
    | Description | Optional text |
    | Type | photo (auto-detected) |
    | Is Primary Evidence | Checkbox |
  And user confirms upload
  Then file stored in Supabase Storage bucket 'ncr-evidence'
  And record created in ncr_evidence_attachments

Scenario: View uploaded evidence
  Given evidence files attached to NCR
  When viewing Evidence section
  Then files displayed as cards with:
    - Thumbnail (for images)
    - File icon (for documents)
    - File name
    - File size
    - Upload date
    - Uploaded by
    - Type badge
  And clicking opens file preview or download

Scenario: Delete evidence
  Given evidence file exists
  When user clicks [Delete] on evidence
  Then confirmation: "Delete evidence file?"
  And user confirms
  Then file deleted from storage
  And record removed from database
  And audit log entry created
```

### AC-7: Root Cause Summary Card

```gherkin
Scenario: View root cause summary
  Given root cause analysis completed
  When viewing NCR detail page
  Then Root Cause Summary card displays:
    | Section | Content |
    | Classification | Badge (e.g., "Systemic") |
    | Root Cause | Root cause statement |
    | 5-Why Summary | "X levels analyzed" with expand |
    | Primary Factor | From Fishbone if marked |
    | Impact | Icons for cost/customer/regulatory/production |
    | Evidence | "X files attached" |
    | Status | Draft/Submitted/Approved/Rejected badge |

Scenario: Expand 5-Why summary
  Given root cause summary visible
  When user clicks "Expand 5-Why"
  Then all why levels displayed:
    | Level | Question | Answer |
    | Why 1 | Why did X occur? | Answer 1 |
    | Why 2 | Why Answer 1? | Answer 2 |
    | ... | ... | ... |
  And final root cause highlighted
```

### AC-8: Root Cause Submission

```gherkin
Scenario: Submit root cause for approval
  Given root cause analysis completed
  And root_cause_statement is not empty
  And at least one classification selected
  And at least one fishbone factor marked as contributing
  When user clicks [Submit for Approval]
  Then confirmation: "Submit root cause analysis for QA Manager approval?"
  And user confirms
  Then status changes to 'submitted'
  And submitted_at = now
  And submitted_by = current user
  And NCR status updated to 'pending_root_cause_approval'
  And notification sent to QA Manager
  And success toast "Root cause submitted for approval"

Scenario: Validation before submission
  Given root cause analysis incomplete
  When user clicks [Submit for Approval]
  Then error messages display:
    - "Root cause statement required"
    - "Classification required"
    - "At least one contributing factor required"
  And submission blocked
```

### AC-9: Root Cause Approval (QA Manager)

```gherkin
Scenario: QA Manager approves root cause
  Given root cause with status = 'submitted'
  And current user has QA_MANAGER role
  When user clicks [Approve Root Cause]
  Then approval form appears:
    | Field | Required |
    | Approval Notes | Optional |
  And user clicks [Approve]
  Then status changes to 'approved'
  And approved_at = now
  And approved_by = current user
  And NCR status transitions to 'corrective_action'
  And notification sent to investigator
  And success toast "Root cause approved"

Scenario: QA Manager rejects root cause
  Given root cause with status = 'submitted'
  When QA Manager clicks [Reject]
  Then rejection form appears:
    | Field | Required |
    | Rejection Reason | Yes (min 20 characters) |
  And user enters reason: "Need more evidence for machine failure claim"
  And clicks [Reject]
  Then status changes to 'rejected'
  And rejection_reason saved
  And NCR status = 'root_cause' (back for revision)
  And notification sent to investigator
  And error toast (red) "Root cause rejected - revision required"

Scenario: Request revision
  Given root cause with status = 'submitted'
  When QA Manager clicks [Request Revision]
  Then revision form appears:
    | Field | Required |
    | Revision Notes | Yes |
  And user enters feedback
  Then status changes to 'revision_required'
  And approval_notes saved
  And investigator notified

Scenario: Resubmit after revision
  Given root cause with status = 'revision_required'
  And investigator makes corrections
  When investigator clicks [Resubmit]
  Then status changes back to 'submitted'
  And QA Manager re-notified
```

### AC-10: Permission Enforcement

```gherkin
Scenario: Viewer can view but not edit
  Given user with VIEWER role
  When viewing NCR root cause
  Then all analysis data visible
  And [Edit], [Submit], [Approve] buttons hidden

Scenario: QA Investigator can analyze
  Given user with QA_INVESTIGATOR role
  And NCR status = 'root_cause'
  When viewing NCR
  Then can edit 5-Why, Fishbone, Impact, Evidence
  And can submit for approval
  And cannot approve (QA Manager only)

Scenario: QA Manager has full access
  Given user with QA_MANAGER role
  Then can edit root cause (if draft/revision_required)
  And can approve/reject submitted analyses
  And can view all NCRs in org

Scenario: Cannot edit approved root cause
  Given root cause with status = 'approved'
  When any user views
  Then [Edit] button disabled
  And tooltip "Approved root cause cannot be modified"
```

### AC-11: Audit Trail

```gherkin
Scenario: All root cause actions logged
  Given any root cause action
  When action completes
  Then quality_audit_log entry created with:
    | Field | Value |
    | entity_type | ncr_root_cause |
    | entity_id | root_cause.id |
    | action | create/update/submit/approve/reject |
    | user_id | current user |
    | timestamp | now |
    | old_value | previous state |
    | new_value | new state |

Scenario: Evidence upload logged
  Given user uploads evidence
  Then audit log records:
    | action | evidence_upload |
    | new_value | { file_name, file_type, attachment_type } |

Scenario: Approval logged with details
  Given QA Manager approves root cause
  Then audit log records:
    | action | approve |
    | new_value | { approved_by, approval_notes, approved_at } |
```

### AC-12: RLS Policy Enforcement

```gherkin
Scenario: Org isolation on root cause
  Given User A from Org A and User B from Org B
  And root causes exist in both orgs
  When User A requests root cause data
  Then only Org A data returned

Scenario: Cannot access root cause from different org
  Given root cause belongs to Org B
  When User A (Org A) requests GET /api/quality/ncrs/:id/root-cause
  Then 404 Not Found returned
```

### AC-13: Performance Requirements

```gherkin
Scenario: Root cause page performance
  Given NCR with complete root cause analysis
  And 10 Fishbone factors
  And 15 evidence attachments
  When loading root cause tab
  Then response time < 500ms

Scenario: Evidence upload performance
  Given 10MB file upload
  When uploading evidence
  Then upload completes < 30 seconds
  And progress indicator shown

Scenario: Fishbone diagram rendering
  Given 20 factors across categories
  When rendering Fishbone diagram
  Then render time < 200ms
```

---

## Implementation Notes

### API Endpoints

```typescript
// =============================================================================
// Root Cause Analysis Endpoints
// =============================================================================

// GET /api/quality/ncrs/:id/root-cause
// Get root cause analysis for NCR
interface RootCauseResponse {
  root_cause: NCRRootCause | null;
  factors: NCRRootCauseFactor[];
  attachments: NCREvidenceAttachment[];
  permissions: {
    can_edit: boolean;
    can_submit: boolean;
    can_approve: boolean;
    can_reject: boolean;
  };
}

interface NCRRootCause {
  id: string;
  org_id: string;
  ncr_id: string;

  // 5-Why Analysis
  why_1?: string;
  why_1_answer?: string;
  why_2?: string;
  why_2_answer?: string;
  why_3?: string;
  why_3_answer?: string;
  why_4?: string;
  why_4_answer?: string;
  why_5?: string;
  why_5_answer?: string;
  why_levels_used: number;

  // Root Cause
  root_cause_statement?: string;
  root_cause_summary?: string;

  // Classification
  classification: 'systemic' | 'random' | 'procedural' | 'human_error' | 'equipment' | 'material' | 'environmental' | 'unknown';
  is_recurring: boolean;
  recurrence_count: number;
  related_ncr_ids?: string[];

  // Impact Assessment
  impact_cost?: number;
  impact_cost_currency: string;
  impact_customer?: 'none' | 'minor' | 'moderate' | 'major' | 'critical';
  impact_customer_notes?: string;
  impact_regulatory?: 'none' | 'notification_required' | 'audit_finding' | 'violation' | 'recall_potential';
  impact_regulatory_notes?: string;
  impact_production?: 'none' | 'minor_delay' | 'significant_delay' | 'batch_loss' | 'line_shutdown';
  impact_production_notes?: string;

  // Approval Workflow
  status: 'draft' | 'submitted' | 'approved' | 'rejected' | 'revision_required';
  submitted_at?: string;
  submitted_by?: string;
  submitted_by_name?: string;
  approved_at?: string;
  approved_by?: string;
  approved_by_name?: string;
  approval_notes?: string;
  rejection_reason?: string;

  // Investigator
  investigator_id?: string;
  investigator_name?: string;
  investigation_started?: string;
  investigation_completed?: string;

  // Audit
  created_at: string;
  created_by: string;
  updated_at: string;
}

interface NCRRootCauseFactor {
  id: string;
  root_cause_id: string;
  category: 'man' | 'machine' | 'material' | 'method' | 'measurement' | 'mother_nature';
  factor_description: string;
  is_contributing: boolean;
  is_primary: boolean;
  evidence_notes?: string;
  sequence: number;
}

interface NCREvidenceAttachment {
  id: string;
  ncr_id: string;
  root_cause_id?: string;
  file_name: string;
  file_type: string;
  file_size: number;
  file_path: string;
  storage_bucket: string;
  description?: string;
  attachment_type: 'photo' | 'document' | 'video' | 'test_result' | 'coa' | 'inspection_record' | 'other';
  is_primary_evidence: boolean;
  uploaded_at: string;
  uploaded_by: string;
  uploaded_by_name: string;
}

// POST /api/quality/ncrs/:id/root-cause
// Create or update root cause analysis
interface CreateRootCauseRequest {
  // 5-Why (optional, can build incrementally)
  why_1?: string;
  why_1_answer?: string;
  why_2?: string;
  why_2_answer?: string;
  why_3?: string;
  why_3_answer?: string;
  why_4?: string;
  why_4_answer?: string;
  why_5?: string;
  why_5_answer?: string;
  why_levels_used?: number;

  // Root Cause
  root_cause_statement?: string;
  root_cause_summary?: string;

  // Classification
  classification?: string;
  is_recurring?: boolean;
  related_ncr_ids?: string[];

  // Impact Assessment
  impact_cost?: number;
  impact_cost_currency?: string;
  impact_customer?: string;
  impact_customer_notes?: string;
  impact_regulatory?: string;
  impact_regulatory_notes?: string;
  impact_production?: string;
  impact_production_notes?: string;

  // Factors (Fishbone)
  factors?: {
    category: string;
    factor_description: string;
    is_contributing: boolean;
    is_primary: boolean;
    evidence_notes?: string;
    sequence?: number;
  }[];
}

interface CreateRootCauseResponse {
  root_cause: NCRRootCause;
  factors: NCRRootCauseFactor[];
}

// PUT /api/quality/ncrs/:id/root-cause/:causeId
// Update existing root cause analysis
interface UpdateRootCauseRequest extends Partial<CreateRootCauseRequest> {}

// POST /api/quality/ncrs/:id/root-cause/submit
// Submit root cause for approval
interface SubmitRootCauseRequest {
  // No body needed - validation happens server-side
}

interface SubmitRootCauseResponse {
  root_cause: NCRRootCause;
  ncr_status: string;
}

// POST /api/quality/ncrs/:id/root-cause/approve
// Approve root cause (QA Manager only)
interface ApproveRootCauseRequest {
  approval_notes?: string;
}

interface ApproveRootCauseResponse {
  root_cause: NCRRootCause;
  ncr_status: string;  // Will be 'corrective_action'
}

// POST /api/quality/ncrs/:id/root-cause/reject
// Reject root cause (QA Manager only)
interface RejectRootCauseRequest {
  rejection_reason: string;  // Required, min 20 characters
}

// POST /api/quality/ncrs/:id/root-cause/revision
// Request revision (QA Manager only)
interface RevisionRootCauseRequest {
  revision_notes: string;  // Required
}

// POST /api/quality/ncrs/:id/root-cause/attachments
// Upload evidence attachment
// Content-Type: multipart/form-data
interface UploadEvidenceRequest {
  file: File;
  description?: string;
  attachment_type?: string;
  is_primary_evidence?: boolean;
}

interface UploadEvidenceResponse {
  attachment: NCREvidenceAttachment;
}

// DELETE /api/quality/ncrs/:id/root-cause/attachments/:attachmentId
// Delete evidence attachment
// Returns 204 No Content on success

// GET /api/quality/ncrs/:id/root-cause/attachments/:attachmentId/download
// Get signed URL for file download
interface DownloadEvidenceResponse {
  url: string;
  expires_at: string;
}
```

### Validation Schemas (Zod)

```typescript
import { z } from 'zod';

export const rootCauseClassificationEnum = z.enum([
  'systemic', 'random', 'procedural', 'human_error',
  'equipment', 'material', 'environmental', 'unknown'
]);

export const impactCustomerEnum = z.enum(['none', 'minor', 'moderate', 'major', 'critical']);
export const impactRegulatoryEnum = z.enum([
  'none', 'notification_required', 'audit_finding', 'violation', 'recall_potential'
]);
export const impactProductionEnum = z.enum([
  'none', 'minor_delay', 'significant_delay', 'batch_loss', 'line_shutdown'
]);

export const fishboneCategoryEnum = z.enum([
  'man', 'machine', 'material', 'method', 'measurement', 'mother_nature'
]);

export const attachmentTypeEnum = z.enum([
  'photo', 'document', 'video', 'test_result', 'coa', 'inspection_record', 'other'
]);

export const fishboneFactorSchema = z.object({
  category: fishboneCategoryEnum,
  factor_description: z.string()
    .min(5, 'Factor description must be at least 5 characters')
    .max(500, 'Factor description must not exceed 500 characters'),
  is_contributing: z.boolean().default(true),
  is_primary: z.boolean().default(false),
  evidence_notes: z.string().max(1000).optional(),
  sequence: z.number().int().min(0).default(0),
});

export const createRootCauseSchema = z.object({
  // 5-Why
  why_1: z.string().min(5).max(500).optional(),
  why_1_answer: z.string().min(10).max(1000).optional(),
  why_2: z.string().min(5).max(500).optional(),
  why_2_answer: z.string().min(10).max(1000).optional(),
  why_3: z.string().min(5).max(500).optional(),
  why_3_answer: z.string().min(10).max(1000).optional(),
  why_4: z.string().min(5).max(500).optional(),
  why_4_answer: z.string().min(10).max(1000).optional(),
  why_5: z.string().min(5).max(500).optional(),
  why_5_answer: z.string().min(10).max(1000).optional(),
  why_levels_used: z.number().int().min(0).max(5).optional(),

  // Root Cause
  root_cause_statement: z.string().min(20).max(2000).optional(),
  root_cause_summary: z.string().max(500).optional(),

  // Classification
  classification: rootCauseClassificationEnum.optional(),
  is_recurring: z.boolean().optional(),
  related_ncr_ids: z.array(z.string().uuid()).optional(),

  // Impact Assessment
  impact_cost: z.number().min(0).max(999999999.99).optional(),
  impact_cost_currency: z.string().length(3).default('USD'),
  impact_customer: impactCustomerEnum.optional(),
  impact_customer_notes: z.string().max(1000).optional(),
  impact_regulatory: impactRegulatoryEnum.optional(),
  impact_regulatory_notes: z.string().max(1000).optional(),
  impact_production: impactProductionEnum.optional(),
  impact_production_notes: z.string().max(1000).optional(),

  // Factors
  factors: z.array(fishboneFactorSchema).optional(),
});

export const updateRootCauseSchema = createRootCauseSchema.partial();

export const submitRootCauseSchema = z.object({
  // Validated on server - must have:
  // - root_cause_statement (min 20 chars)
  // - classification (not 'unknown')
  // - at least one contributing factor
});

export const approveRootCauseSchema = z.object({
  approval_notes: z.string().max(2000).optional(),
});

export const rejectRootCauseSchema = z.object({
  rejection_reason: z.string()
    .min(20, 'Rejection reason must be at least 20 characters')
    .max(2000, 'Rejection reason must not exceed 2000 characters'),
});

export const revisionRootCauseSchema = z.object({
  revision_notes: z.string()
    .min(10, 'Revision notes required')
    .max(2000, 'Revision notes must not exceed 2000 characters'),
});

export const uploadEvidenceSchema = z.object({
  description: z.string().max(500).optional(),
  attachment_type: attachmentTypeEnum.default('other'),
  is_primary_evidence: z.boolean().default(false),
});
```

### Service Layer

```typescript
// lib/services/ncr-root-cause-service.ts

export class NCRRootCauseService {
  // ==========================================================================
  // CRUD Operations
  // ==========================================================================

  /**
   * Get root cause analysis for NCR
   */
  static async getByNCRId(ncrId: string): Promise<RootCauseDetail | null>;

  /**
   * Create or update root cause analysis
   * Creates if not exists, updates if exists
   */
  static async upsert(
    ncrId: string,
    input: CreateRootCauseInput,
    userId: string
  ): Promise<RootCauseResult>;

  /**
   * Update existing root cause
   */
  static async update(
    rootCauseId: string,
    input: UpdateRootCauseInput,
    userId: string
  ): Promise<NCRRootCause>;

  // ==========================================================================
  // 5-Why Analysis
  // ==========================================================================

  /**
   * Add next why level
   */
  static async addWhyLevel(
    rootCauseId: string,
    level: number,
    question: string,
    answer: string,
    userId: string
  ): Promise<NCRRootCause>;

  /**
   * Generate why question based on previous answer
   */
  static generateWhyQuestion(previousAnswer: string, level: number): string;

  // ==========================================================================
  // Fishbone Factors
  // ==========================================================================

  /**
   * Add factor to root cause
   */
  static async addFactor(
    rootCauseId: string,
    factor: CreateFactorInput,
    userId: string
  ): Promise<NCRRootCauseFactor>;

  /**
   * Update factor
   */
  static async updateFactor(
    factorId: string,
    input: UpdateFactorInput,
    userId: string
  ): Promise<NCRRootCauseFactor>;

  /**
   * Delete factor
   */
  static async deleteFactor(factorId: string, userId: string): Promise<void>;

  /**
   * Set primary factor (clears other primary flags)
   */
  static async setPrimaryFactor(
    rootCauseId: string,
    factorId: string,
    userId: string
  ): Promise<void>;

  /**
   * Get factors grouped by category
   */
  static async getFactorsByCategory(rootCauseId: string): Promise<{
    man: NCRRootCauseFactor[];
    machine: NCRRootCauseFactor[];
    material: NCRRootCauseFactor[];
    method: NCRRootCauseFactor[];
    measurement: NCRRootCauseFactor[];
    mother_nature: NCRRootCauseFactor[];
  }>;

  // ==========================================================================
  // Evidence Attachments
  // ==========================================================================

  /**
   * Upload evidence attachment
   */
  static async uploadEvidence(
    ncrId: string,
    rootCauseId: string | null,
    file: File,
    metadata: UploadEvidenceInput,
    userId: string
  ): Promise<NCREvidenceAttachment>;

  /**
   * Delete evidence attachment
   */
  static async deleteEvidence(attachmentId: string, userId: string): Promise<void>;

  /**
   * Get download URL for attachment
   */
  static async getDownloadUrl(attachmentId: string): Promise<{ url: string; expires_at: string }>;

  /**
   * List evidence for NCR
   */
  static async listEvidence(ncrId: string): Promise<NCREvidenceAttachment[]>;

  // ==========================================================================
  // Approval Workflow
  // ==========================================================================

  /**
   * Submit root cause for approval
   * Validates completeness before submission
   */
  static async submit(rootCauseId: string, userId: string): Promise<NCRRootCause>;

  /**
   * Approve root cause (QA Manager only)
   * Updates NCR status to 'corrective_action'
   */
  static async approve(
    rootCauseId: string,
    approvalNotes: string | null,
    userId: string
  ): Promise<NCRRootCause>;

  /**
   * Reject root cause (QA Manager only)
   * Returns NCR to 'root_cause' status
   */
  static async reject(
    rootCauseId: string,
    rejectionReason: string,
    userId: string
  ): Promise<NCRRootCause>;

  /**
   * Request revision (QA Manager only)
   */
  static async requestRevision(
    rootCauseId: string,
    revisionNotes: string,
    userId: string
  ): Promise<NCRRootCause>;

  // ==========================================================================
  // Validation
  // ==========================================================================

  /**
   * Validate root cause completeness for submission
   */
  static async validateForSubmission(rootCauseId: string): Promise<{
    isValid: boolean;
    errors: string[];
  }>;

  /**
   * Check user permissions for root cause
   */
  static async checkPermissions(rootCauseId: string, userId: string): Promise<{
    can_edit: boolean;
    can_submit: boolean;
    can_approve: boolean;
    can_reject: boolean;
  }>;

  // ==========================================================================
  // Impact Assessment
  // ==========================================================================

  /**
   * Calculate impact severity based on all factors
   */
  static calculateOverallImpact(rootCause: NCRRootCause): 'low' | 'medium' | 'high' | 'critical';

  /**
   * Check if impact requires escalation
   */
  static requiresEscalation(rootCause: NCRRootCause): boolean;
}
```

### Frontend Components

```
apps/frontend/app/(authenticated)/quality/
  ncrs/
    [id]/
      root-cause/
        page.tsx                     -- Root cause analysis page (or tab)

components/quality/ncrs/root-cause/
  RootCauseTab.tsx                   -- Main container for root cause section
  FiveWhyWizard.tsx                  -- 5-Why iterative analysis component
  FiveWhyStep.tsx                    -- Single why level component
  FiveWhySummary.tsx                 -- Summary of completed 5-Why
  FishboneDiagram.tsx                -- Interactive Fishbone visualization
  FishboneCategory.tsx               -- Single category bone with factors
  FishboneFactor.tsx                 -- Factor item on bone
  AddFactorModal.tsx                 -- Modal to add/edit Fishbone factor
  ClassificationSelector.tsx         -- Root cause classification dropdown
  RecurringIssueToggle.tsx           -- Toggle for recurring issues
  RelatedNCRSelector.tsx             -- Multi-select for related NCRs
  ImpactAssessmentForm.tsx           -- Impact assessment section
  ImpactBadge.tsx                    -- Visual badge for impact level
  EvidenceUploader.tsx               -- File upload component
  EvidenceGallery.tsx                -- Grid of uploaded evidence
  EvidenceCard.tsx                   -- Single evidence item card
  EvidencePreviewModal.tsx           -- Modal to preview evidence
  RootCauseSummaryCard.tsx           -- Summary display on NCR detail
  SubmitForApprovalDialog.tsx        -- Confirmation dialog for submission
  ApprovalPanel.tsx                  -- QA Manager approval actions
  ApproveDialog.tsx                  -- Approval confirmation
  RejectDialog.tsx                   -- Rejection with reason
  RevisionDialog.tsx                 -- Request revision dialog
  RootCauseStatusBadge.tsx           -- Status badge (draft/submitted/approved/rejected)
  RootCauseTimeline.tsx              -- Timeline of analysis changes
```

### UI Component Details

**FiveWhyWizard.tsx**
- Step-by-step wizard interface
- Each step shows previous context
- Progressive disclosure (next why unlocked after answer)
- "Root Cause Found" button to stop early
- Auto-generates next question from previous answer
- Save progress between steps (auto-save)

**FishboneDiagram.tsx**
- SVG-based interactive diagram
- 6 main bones from center spine
- Click category to add factor
- Drag factors to reorder
- Visual differentiation:
  - Contributing factors: blue
  - Primary factor: red with star
  - Non-contributing: gray, strikethrough
- Responsive layout (horizontal on desktop, vertical on mobile)
- Export as image option

**ImpactAssessmentForm.tsx**
- Four impact categories in grid layout
- Each with dropdown + notes field
- Color coding based on severity
- Auto-calculate overall impact score
- Warning banner for high-impact selections

**EvidenceUploader.tsx**
- Drag-and-drop zone
- File type validation (image, document, video)
- Size limit display (25MB max)
- Upload progress indicator
- Auto-categorization based on file type
- Thumbnail generation for images

**ApprovalPanel.tsx**
- Visible only to QA Manager
- Three action buttons: Approve, Reject, Request Revision
- Shows submitted_by and submitted_at
- Review checklist (optional)
- Approval history/notes display

---

## Key Business Rules

1. **One Root Cause per NCR**: Each NCR has exactly one root cause analysis record (1:1 relationship)
2. **5-Why Minimum**: At least 1 why level required, maximum 5
3. **Contributing Factor Required**: Submission requires at least one Fishbone factor marked as contributing
4. **Single Primary Factor**: Only one factor can be marked as primary cause
5. **Classification Required**: Cannot submit without selecting classification (not 'unknown')
6. **Root Cause Statement Required**: Submission requires root_cause_statement (min 20 chars)
7. **Approval Required for Corrective Action**: NCR cannot proceed to corrective_action status without approved root cause
8. **QA Manager Approval**: Only QA_MANAGER role can approve/reject root cause analyses
9. **No Edit After Approval**: Approved root cause cannot be modified
10. **Evidence Retention**: Evidence files retained for 10+ years (regulatory compliance)
11. **Audit Trail**: All actions logged to quality_audit_log
12. **High Impact Escalation**: Critical customer or regulatory impact triggers escalation

---

## Deliverables

### Database
- [ ] Migration: `ncr_root_causes` table with all columns
- [ ] Migration: `ncr_root_cause_factors` table
- [ ] Migration: `ncr_evidence_attachments` table
- [ ] RLS policies for all tables
- [ ] All performance indexes
- [ ] Triggers: update_updated_at for all tables
- [ ] Supabase Storage bucket: 'ncr-evidence'

### API Routes
- [ ] `GET /api/quality/ncrs/:id/root-cause` - Get analysis
- [ ] `POST /api/quality/ncrs/:id/root-cause` - Create/update analysis
- [ ] `PUT /api/quality/ncrs/:id/root-cause/:causeId` - Update analysis
- [ ] `POST /api/quality/ncrs/:id/root-cause/submit` - Submit for approval
- [ ] `POST /api/quality/ncrs/:id/root-cause/approve` - Approve (QA Manager)
- [ ] `POST /api/quality/ncrs/:id/root-cause/reject` - Reject (QA Manager)
- [ ] `POST /api/quality/ncrs/:id/root-cause/revision` - Request revision
- [ ] `POST /api/quality/ncrs/:id/root-cause/attachments` - Upload evidence
- [ ] `DELETE /api/quality/ncrs/:id/root-cause/attachments/:id` - Delete evidence
- [ ] `GET /api/quality/ncrs/:id/root-cause/attachments/:id/download` - Get download URL

### Service Layer
- [ ] `NCRRootCauseService.getByNCRId()` - Get analysis
- [ ] `NCRRootCauseService.upsert()` - Create/update
- [ ] `NCRRootCauseService.addFactor()` - Add Fishbone factor
- [ ] `NCRRootCauseService.updateFactor()` - Update factor
- [ ] `NCRRootCauseService.deleteFactor()` - Delete factor
- [ ] `NCRRootCauseService.setPrimaryFactor()` - Set primary
- [ ] `NCRRootCauseService.uploadEvidence()` - Upload file
- [ ] `NCRRootCauseService.deleteEvidence()` - Delete file
- [ ] `NCRRootCauseService.submit()` - Submit for approval
- [ ] `NCRRootCauseService.approve()` - Approve analysis
- [ ] `NCRRootCauseService.reject()` - Reject analysis
- [ ] `NCRRootCauseService.requestRevision()` - Request revision
- [ ] `NCRRootCauseService.validateForSubmission()` - Validation

### Validation
- [ ] `createRootCauseSchema`
- [ ] `updateRootCauseSchema`
- [ ] `fishboneFactorSchema`
- [ ] `submitRootCauseSchema`
- [ ] `approveRootCauseSchema`
- [ ] `rejectRootCauseSchema`
- [ ] `revisionRootCauseSchema`
- [ ] `uploadEvidenceSchema`

### Frontend
- [ ] Root Cause tab on NCR detail page
- [ ] 5-Why wizard component
- [ ] Fishbone diagram interactive builder
- [ ] Classification selector
- [ ] Impact assessment form
- [ ] Evidence upload component
- [ ] Evidence gallery/preview
- [ ] Root cause summary card
- [ ] Submit for approval dialog
- [ ] QA Manager approval panel
- [ ] Approve/Reject/Revision dialogs
- [ ] Status badges
- [ ] Responsive layout

### Tests
- [ ] Unit tests: NCRRootCauseService methods (>80% coverage)
- [ ] Integration tests: All API endpoints
- [ ] RLS tests: Multi-tenancy isolation
- [ ] Permission tests: Role-based access
- [ ] Approval workflow tests
- [ ] File upload tests
- [ ] E2E: Full root cause workflow (analyze -> submit -> approve)

---

## Test Strategy

### Unit Tests

```typescript
describe('NCRRootCauseService', () => {
  describe('upsert', () => {
    it('creates new root cause for NCR', async () => {});
    it('updates existing root cause', async () => {});
    it('validates 5-why answer lengths', async () => {});
    it('prevents edit of approved root cause', async () => {});
  });

  describe('addFactor', () => {
    it('adds factor to correct category', async () => {});
    it('validates factor description', async () => {});
    it('increments sequence correctly', async () => {});
  });

  describe('setPrimaryFactor', () => {
    it('sets primary flag on factor', async () => {});
    it('clears other primary flags', async () => {});
    it('updates root_cause_statement suggestion', async () => {});
  });

  describe('submit', () => {
    it('validates completeness before submission', async () => {});
    it('requires root_cause_statement', async () => {});
    it('requires at least one contributing factor', async () => {});
    it('requires non-unknown classification', async () => {});
    it('changes status to submitted', async () => {});
    it('updates NCR status', async () => {});
  });

  describe('approve', () => {
    it('approves submitted root cause', async () => {});
    it('requires QA_MANAGER role', async () => {});
    it('updates NCR status to corrective_action', async () => {});
    it('creates audit log entry', async () => {});
  });

  describe('reject', () => {
    it('rejects with reason', async () => {});
    it('requires rejection_reason', async () => {});
    it('returns NCR to root_cause status', async () => {});
    it('notifies investigator', async () => {});
  });

  describe('uploadEvidence', () => {
    it('uploads file to storage', async () => {});
    it('creates attachment record', async () => {});
    it('validates file type', async () => {});
    it('validates file size', async () => {});
    it('auto-detects attachment_type', async () => {});
  });

  describe('validateForSubmission', () => {
    it('returns errors for missing root_cause_statement', async () => {});
    it('returns errors for unknown classification', async () => {});
    it('returns errors for no contributing factors', async () => {});
    it('returns valid when all requirements met', async () => {});
  });
});
```

### Integration Tests

```typescript
describe('Root Cause API', () => {
  describe('POST /api/quality/ncrs/:id/root-cause', () => {
    it('creates root cause analysis', async () => {});
    it('updates existing analysis', async () => {});
    it('returns 400 for invalid data', async () => {});
    it('returns 403 for wrong NCR status', async () => {});
  });

  describe('POST /api/quality/ncrs/:id/root-cause/submit', () => {
    it('submits for approval', async () => {});
    it('returns 400 for incomplete analysis', async () => {});
    it('updates NCR status', async () => {});
  });

  describe('POST /api/quality/ncrs/:id/root-cause/approve', () => {
    it('approves as QA Manager', async () => {});
    it('returns 403 for non-QA Manager', async () => {});
    it('transitions NCR to corrective_action', async () => {});
  });

  describe('POST /api/quality/ncrs/:id/root-cause/attachments', () => {
    it('uploads evidence file', async () => {});
    it('returns 400 for invalid file type', async () => {});
    it('returns 400 for oversized file', async () => {});
  });
});
```

### E2E Tests

```typescript
describe('NCR Root Cause Analysis Workflow', () => {
  it('complete 5-Why analysis', async () => {
    // 1. Navigate to NCR in root_cause status
    // 2. Click Start 5-Why Analysis
    // 3. Enter Why 1 and answer
    // 4. Continue through Why 2, 3
    // 5. Click Root Cause Identified
    // 6. Verify root_cause_statement populated
    // 7. Save analysis
  });

  it('build Fishbone diagram', async () => {
    // 1. Navigate to Fishbone tab
    // 2. Add factor to Machine category
    // 3. Add factor to Man category
    // 4. Mark one as primary
    // 5. Verify visual updates
    // 6. Save factors
  });

  it('complete impact assessment', async () => {
    // 1. Navigate to Impact section
    // 2. Select customer impact = major
    // 3. Enter cost impact
    // 4. See escalation warning
    // 5. Save assessment
  });

  it('upload and manage evidence', async () => {
    // 1. Navigate to Evidence section
    // 2. Upload photo file
    // 3. Add description
    // 4. See thumbnail in gallery
    // 5. Preview file
    // 6. Delete file
  });

  it('submit and approve workflow', async () => {
    // 1. Complete analysis
    // 2. Click Submit for Approval
    // 3. Confirm submission
    // 4. Login as QA Manager
    // 5. Review analysis
    // 6. Click Approve
    // 7. Verify NCR status = corrective_action
  });

  it('reject and revise workflow', async () => {
    // 1. Submit analysis
    // 2. Login as QA Manager
    // 3. Click Reject with reason
    // 4. Login as investigator
    // 5. See rejection reason
    // 6. Make corrections
    // 7. Resubmit
  });
});
```

---

## Definition of Done

### Database
- [ ] `ncr_root_causes` table created with all columns
- [ ] `ncr_root_cause_factors` table created
- [ ] `ncr_evidence_attachments` table created
- [ ] All indexes created for performance
- [ ] RLS policies enforce org isolation
- [ ] Supabase Storage bucket configured

### API
- [ ] All endpoints return correct HTTP status codes
- [ ] Validation errors return 400 with detailed messages
- [ ] Cross-tenant access returns 404
- [ ] Response times:
  - Root cause get: < 500ms
  - Create/Update: < 300ms
  - Evidence upload (10MB): < 30s

### Service
- [ ] CRUD operations work correctly
- [ ] 5-Why analysis saves incrementally
- [ ] Fishbone factors manage correctly
- [ ] Primary factor logic works (single primary)
- [ ] Evidence upload/delete works
- [ ] Approval workflow: submit -> approve/reject
- [ ] Validation prevents incomplete submission
- [ ] Audit trail created for all actions

### Frontend
- [ ] 5-Why wizard functional
- [ ] Fishbone diagram renders and is interactive
- [ ] Factors can be added/edited/deleted
- [ ] Classification selector works
- [ ] Impact assessment form works
- [ ] Evidence upload works with progress
- [ ] Evidence gallery displays correctly
- [ ] Submit dialog with validation
- [ ] Approval panel (QA Manager)
- [ ] Approve/Reject dialogs
- [ ] Responsive design works

### Testing
- [ ] Unit tests: >80% coverage on service
- [ ] Integration tests: All endpoints covered
- [ ] RLS tests: Multi-tenancy verified
- [ ] Permission tests: Role-based access
- [ ] File upload tests: Size/type validation
- [ ] E2E tests: Full workflow passing

### Integration
- [ ] NCR status transitions correctly (root_cause -> corrective_action)
- [ ] Ready for story 06.15 (Corrective Action)
- [ ] Audit log integration working

---

## Risk Assessment

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Fishbone diagram complexity | MEDIUM | MEDIUM | Start with simple SVG, enhance iteratively |
| File upload size limits | LOW | LOW | Clear error messages, compression options |
| Approval workflow edge cases | MEDIUM | MEDIUM | Comprehensive state machine tests |
| Performance with many factors | LOW | LOW | Proper indexes, pagination if needed |
| Evidence storage costs | LOW | MEDIUM | Storage policies, archival after 10 years |
| Mobile Fishbone UX | MEDIUM | HIGH | Vertical layout, simplified mobile view |

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-01-15 | Initial story creation | ARCHITECT-AGENT |

---

**Document Status**: Ready for Implementation
**Created**: 2025-01-15
**Lines**: ~1650
**Complexity**: M (Medium)
**Phase**: 2B (NCR Workflow)
