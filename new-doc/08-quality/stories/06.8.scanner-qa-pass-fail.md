# 06.8 - Scanner QA Pass/Fail

**Priority**: P0 (MVP)
**Story Points**: M (Medium)
**Type**: scanner + backend

**State:** ready
**Estimate:** M (3-4 days)
**Primary PRD:** `docs/1-BASELINE/product/modules/quality.md` (FR-QA-025, Section 3 NFRs)
**Architecture:** `docs/1-BASELINE/architecture/decisions/ADR-006-scanner-first-mobile-ux.md`
**UX Wireframes:** QA-009 (Scanner QA Home), QA-010 (Scanner Inspection Flow)

## Goal

Implement mobile-optimized scanner workflows for QA inspections, enabling inspectors to quickly perform pass/fail quality checks on the warehouse floor by scanning LP or WO barcodes, recording test results, and updating QA status - all with large touch targets, offline support, and audio feedback.

## MVP Scope

This story implements Phase 1 (Core Quality) scanner functionality only. Features listed in "Future Phases" are deferred to Phase 2+ and should be handled per Epic 06.0 "Future Feature Handling" guidance.

**MVP Includes**:
- Scanner-optimized QA workflow pages (`/scanner/qa/*`)
- Scan LP/WO barcode to load inspection
- Quick pass/fail entry (no full test battery in MVP)
- Simple test result recording (up to 5 parameters)
- Offline mode with queue (max 50 records)
- Real-time sync when online
- Audio feedback (success/error beeps)
- Large touch targets (minimum 48px)
- High contrast dark theme UI

**Deferred to Phase 2+**: See "Future Phases" section below.

---

## Food Safety Compliance

This story is **important for food safety compliance**:

- [x] **Audit Trail Required** - All scanner actions logged with user, timestamp, location
- [ ] HACCP Compliance (Phase 3 - CCP monitoring)
- [ ] FDA 21 CFR Part 11 (Phase 3 - E-signature)

**Regulatory Context:**
- Inspection results must be traceable to inspector
- Timestamp with timezone required for all results
- Offline actions synced within 15 minutes of connectivity
- All scanner actions logged in `quality_audit_log`

---

## User Story

As a **QA Inspector**, I want to **use my mobile scanner device to quickly inspect materials on the warehouse floor by scanning barcodes and recording pass/fail results** so that **I can perform quality checks without returning to my desktop workstation**.

As a **Warehouse Operator**, I want to **scan a license plate and immediately see its QA status (pending/passed/failed)** so that **I know if I can use the material in production**.

---

## Scope

**In scope (this story)**
- Scanner route: `/scanner/qa/`
- Scanner layout with minimal chrome (no sidebar)
- Scan LP or WO barcode to load inspection
- Quick pass/fail workflow (3 screen max)
- Simple test result recording (numeric, text, pass/fail)
- Offline action queue (IndexedDB)
- Auto-sync when online
- Audio feedback (success beep, error beep)
- 48px+ touch targets
- High contrast dark theme (slate-900 bg)
- LP QA status badge display
- Scanner QA home (task selection)
- POST /api/quality/scanner/quick-inspection (new endpoint)
- POST /api/quality/scanner/sync-offline (bulk sync)

**Out of scope (this story)**
- Desktop inspection workflow (story 06.5 - Incoming Inspection)
- Full test battery recording (story 06.6 - Test Results Recording)
- Sampling plans integration (story 06.7)
- CCP monitoring scanner (story 06.24)
- Photo attachments (Phase 2)
- E-signature (Phase 3)
- Multi-language support (Phase 3)

---

## Future Phases (Not in MVP)

### Phase 2 (Advanced Scanner QA)
- **Photo attachments** - Capture defect photos inline
- **Multi-sample inspections** - Record results for multiple samples
- **Temperature logging** - IoT sensor integration
- **Voice notes** - Audio notes for inspectors
- **Inspection templates** - Pre-configured test sets
- **Batch scanning** - Scan multiple LPs in sequence

### Phase 3 (HACCP Scanner)
- **CCP monitoring scanner** - Story 06.24 (CCP Monitoring Scanner)
- **E-signature on complete** - FDA 21 CFR Part 11 compliance
- **Bluetooth barcode scanner** - Ring scanner support (Zebra RS6000)
- **Geolocation tagging** - GPS coordinates for inspections
- **Multi-language UI** - Spanish, French language support

### Phase 4 (Analytics & Optimization)
- **Scanner analytics** - Time per inspection, usage patterns
- **Predictive sampling** - AI-suggested sample locations
- **Offline limit increase** - 500+ offline records

### Deferred to Other Modules
- **In-process QA** - Story 06.10 (In-Process Inspection) with WO scanning
- **Final inspection** - Story 06.11 (Final Inspection) with batch scanning
- **NCR creation from scanner** - Story 06.9 extension

**Implementation**: See Epic 06.0 "Future Feature Handling" for how to handle Phase 2+ features in UI/API.

---

## Dependencies

### Cross-Epic Dependencies
| Dependency | Story/Epic | Type | What It Provides | Status |
|------------|------------|------|------------------|--------|
| 01.1 | Org Context + RLS | HARD | organizations, users tables | Ready |
| 02.1 | Products CRUD | HARD | products table for product reference | Ready |
| 05.1 | LP Table + CRUD | HARD | license_plates table, LP lookup | Ready |

### Within Epic Dependencies
| Dependency | Story | Type | What It Provides |
|------------|-------|------|------------------|
| 06.1 | Quality Status Types | HARD | QA status enum for LP updates |
| 06.3 | Product Specifications | SOFT | Specifications for inspection context (optional) |
| 06.4 | Test Parameters | SOFT | Test parameters for result recording (optional) |
| 06.5 | Incoming Inspection | HARD | quality_inspections table, inspection service |

### Provides To (Downstream)
| Story | What This Provides |
|-------|-------------------|
| 06.24 | CCP Monitoring Scanner - Scanner UX patterns |
| Epic 04 | Production scanner - Reusable scanner components |
| Epic 05 | Warehouse scanner - Shared scanner layout |

---

## Database Migration

### Migration: Scanner Offline Queue Table

```sql
-- File: supabase/migrations/060_create_scanner_offline_queue.sql

-- Table for offline scanner actions (local IndexedDB mirrored to DB after sync)
CREATE TABLE scanner_offline_queue (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id UUID NOT NULL REFERENCES organizations(id),
    user_id UUID NOT NULL REFERENCES users(id),

    -- Action tracking
    action_type TEXT NOT NULL CHECK (action_type IN ('quick_inspection', 'test_result', 'qa_status_update')),
    action_payload JSONB NOT NULL,

    -- Metadata
    device_id TEXT,  -- Device identifier (for debugging)
    created_at_local TIMESTAMPTZ NOT NULL,  -- Local device timestamp
    synced_at TIMESTAMPTZ DEFAULT now(),  -- Server sync timestamp

    -- Status
    sync_status TEXT DEFAULT 'synced' CHECK (sync_status IN ('synced', 'failed', 'duplicate')),
    error_message TEXT,

    -- Audit
    created_at TIMESTAMPTZ DEFAULT now()
);

-- Indexes
CREATE INDEX idx_scanner_queue_org ON scanner_offline_queue(org_id);
CREATE INDEX idx_scanner_queue_user ON scanner_offline_queue(user_id);
CREATE INDEX idx_scanner_queue_sync_status ON scanner_offline_queue(sync_status);
CREATE INDEX idx_scanner_queue_created ON scanner_offline_queue(created_at);

-- RLS Policies
ALTER TABLE scanner_offline_queue ENABLE ROW LEVEL SECURITY;

CREATE POLICY "scanner_queue_org_isolation"
ON scanner_offline_queue FOR ALL
USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

-- Comments
COMMENT ON TABLE scanner_offline_queue IS 'Offline scanner actions synced to server';
COMMENT ON COLUMN scanner_offline_queue.action_payload IS 'JSON payload of the action (inspection data, test results, etc.)';
COMMENT ON COLUMN scanner_offline_queue.created_at_local IS 'Timestamp when action was created on device (may differ from synced_at)';
```

### Extension: Add scanner metadata to quality_inspections

```sql
-- File: supabase/migrations/061_add_scanner_metadata_to_inspections.sql

-- Add scanner metadata columns to quality_inspections
ALTER TABLE quality_inspections
    ADD COLUMN inspection_method TEXT DEFAULT 'desktop' CHECK (inspection_method IN ('desktop', 'scanner')),
    ADD COLUMN scanner_device_id TEXT,
    ADD COLUMN scanner_location TEXT,  -- Optional GPS coordinates
    ADD COLUMN inspection_duration_seconds INTEGER;  -- Time to complete

-- Index for scanner inspections
CREATE INDEX idx_inspections_method ON quality_inspections(org_id, inspection_method);

-- Comments
COMMENT ON COLUMN quality_inspections.inspection_method IS 'How inspection was performed (desktop or scanner)';
COMMENT ON COLUMN quality_inspections.scanner_device_id IS 'Device ID for scanner inspections (for analytics)';
COMMENT ON COLUMN quality_inspections.inspection_duration_seconds IS 'Time from start to complete (for performance tracking)';
```

---

## Acceptance Criteria (Given/When/Then)

### AC-8.1: Scanner Home Page Display

**Given** user navigates to `/scanner/qa/`
**When** page loads
**Then** scanner home displays with:
  - Dark theme (slate-900 background, white text)
  - Header: "Quality Inspection" title, user badge, sync status indicator
  - Large button (96px height): "Scan LP or WO" (primary action)
  - Secondary button: "View Pending Inspections" (64px height)
  - Footer: Last sync timestamp, connection status badge
**And** scan input field auto-focused for hardware scanner

### AC-8.2: Scan LP to Load Inspection

**Given** inspector is on scanner QA home
**When** inspector scans LP barcode "LP00000001" (hardware scanner or manual entry)
**Then** system performs lookup: `GET /api/warehouse/license-plates/lookup?barcode=LP00000001`
**And** if LP has pending inspection:
  - Load inspection: `GET /api/quality/inspections/by-lp/:lpId`
  - Navigate to inspection detail screen
**And** if LP has no inspection:
  - Show message: "No pending inspection for LP00000001"
  - Option: "Create Inspection" (navigates to desktop)
**And** if LP not found:
  - Error beep (audio feedback)
  - Error message: "LP not found. Scan again or enter manually."
  - Clear input, refocus

### AC-8.3: Inspection Detail Display (Scanner Optimized)

**Given** inspection loaded from LP scan
**When** inspection detail screen displays
**Then** screen shows:
  - Header: Inspection number, LP number (large text 24px)
  - Product info card (64px height):
    - Product name (18px)
    - Batch number (if available)
    - Current QA status badge (color-coded)
  - Test parameters list (if spec linked):
    - Each parameter as card (72px height)
    - Parameter name (18px)
    - Min/max values (if numeric)
    - Touch to record result
  - Footer action bar (fixed bottom):
    - [Quick Pass] button (green, 56px height, 48% width)
    - [Quick Fail] button (red, 56px height, 48% width)
**And** all touch targets >= 48px

### AC-8.4: Quick Pass Workflow

**Given** inspector viewing inspection detail
**When** inspector taps [Quick Pass] button
**Then** confirmation dialog appears:
  - Title: "Confirm Pass" (24px)
  - Message: "Mark inspection as PASSED?"
  - Product: "[Product Name]"
  - LP: "[LP Number]"
  - Buttons:
    - [Cancel] (secondary, 48px)
    - [Confirm Pass] (green, primary, 56px)
**When** inspector taps [Confirm Pass]
**Then** system calls API: `POST /api/quality/scanner/quick-inspection`
  ```json
  {
    "inspection_id": "uuid",
    "result": "pass",
    "inspection_method": "scanner",
    "scanner_device_id": "device_uuid"
  }
  ```
**And** if online:
  - API updates inspection.result = 'pass', status = 'completed'
  - API updates license_plates.qa_status = 'passed'
  - Success beep (audio feedback)
  - Success screen: "Inspection Passed" (green checkmark, 3 seconds)
  - Return to scanner home
**And** if offline:
  - Queue action in IndexedDB
  - Show "Queued for sync" message
  - Success beep
  - Return to scanner home

### AC-8.5: Quick Fail Workflow

**Given** inspector viewing inspection detail
**When** inspector taps [Quick Fail] button
**Then** fail confirmation dialog appears:
  - Title: "Confirm Fail" (24px)
  - Message: "Mark inspection as FAILED?"
  - Notes field (optional, 4 rows, 18px text)
  - Defect count input (optional, numeric, 48px height)
  - Buttons:
    - [Cancel] (secondary, 48px)
    - [Confirm Fail] (red, primary, 56px)
**When** inspector taps [Confirm Fail]
**Then** system calls API: `POST /api/quality/scanner/quick-inspection`
  ```json
  {
    "inspection_id": "uuid",
    "result": "fail",
    "result_notes": "notes text",
    "defects_found": 3,
    "inspection_method": "scanner"
  }
  ```
**And** if online:
  - API updates inspection.result = 'fail', status = 'completed'
  - API updates license_plates.qa_status = 'failed'
  - Error beep (different tone from success)
  - Fail screen: "Inspection Failed" (red X, 3 seconds)
  - Return to scanner home
**And** if offline:
  - Queue action in IndexedDB
  - Show "Queued for sync" message
  - Return to scanner home

### AC-8.6: Test Result Recording (Optional in MVP)

**Given** inspection detail screen displays test parameters
**When** inspector taps on a parameter card
**Then** parameter detail modal appears:
  - Parameter name (24px)
  - Specification: "Min: X, Max: Y, Unit: Z"
  - Result input field (large, 56px height, numeric keypad if numeric)
  - Result status buttons (if boolean):
    - [Pass] (green, 56px, 48% width)
    - [Fail] (red, 56px, 48% width)
  - Notes field (optional, 2 rows)
  - Buttons:
    - [Cancel] (secondary, 48px)
    - [Save Result] (primary, 56px)
**When** inspector enters result and taps [Save Result]
**Then** system records test result:
  - If online: `POST /api/quality/test-results`
  - If offline: Queue in IndexedDB
  - Parameter card shows green checkmark (result recorded)
  - Modal closes, return to inspection detail
**And** inspector can record results for multiple parameters before final pass/fail

### AC-8.7: Offline Mode Detection

**Given** scanner device loses network connectivity
**When** connectivity changes to offline
**Then** sync status indicator changes to "Offline" (orange badge)
**And** footer message: "Working offline. Actions will sync when online."
**And** all actions queue to IndexedDB
**And** queue count badge shows: "3 actions queued"

### AC-8.8: Offline Action Queue

**Given** device is offline
**When** inspector completes 3 inspections (pass/fail)
**Then** each action queued in IndexedDB:
  ```typescript
  interface OfflineAction {
    id: string; // local UUID
    type: 'quick_inspection';
    payload: {
      inspection_id: string;
      result: 'pass' | 'fail';
      result_notes?: string;
      defects_found?: number;
    };
    timestamp: Date;
    synced: boolean;
    retry_count: number;
  }
  ```
**And** queue count badge updates: "3 actions queued"
**And** max queue size enforced: 50 actions
**And** if queue full: Warning "Offline queue full (50). Connect to sync."

### AC-8.9: Auto-Sync When Online

**Given** device was offline with 3 queued actions
**When** network connectivity restored
**Then** sync status changes to "Syncing..." (blue badge)
**And** system calls: `POST /api/quality/scanner/sync-offline`
  ```json
  {
    "actions": [
      { "id": "local-uuid-1", "type": "quick_inspection", "payload": {...}, "timestamp": "2025-12-16T10:30:00Z" },
      { "id": "local-uuid-2", "type": "quick_inspection", "payload": {...}, "timestamp": "2025-12-16T10:35:00Z" },
      { "id": "local-uuid-3", "type": "quick_inspection", "payload": {...}, "timestamp": "2025-12-16T10:40:00Z" }
    ]
  }
  ```
**And** API processes actions sequentially:
  - Validates each inspection exists
  - Updates inspection results
  - Updates LP QA status
  - Logs to `scanner_offline_queue` table
  - Returns: `{ success: 3, failed: 0, errors: [] }`
**And** if all succeed:
  - Clear IndexedDB queue
  - Sync status: "Synced" (green badge)
  - Toast: "3 actions synced successfully"
  - Success beep
**And** if some fail:
  - Mark failed actions in IndexedDB (retain for retry)
  - Sync status: "Sync errors" (orange badge)
  - Toast: "2 synced, 1 failed. Tap to retry."
  - Error details available for review

### AC-8.10: Audio Feedback

**Given** device supports audio
**When** inspector scans valid LP barcode
**Then** play success beep (440 Hz, 100ms)
**When** inspector scans invalid barcode
**Then** play error beep (220 Hz, 200ms)
**When** inspection completed as pass
**Then** play success chime (ascending tone)
**When** inspection completed as fail
**Then** play alert tone (descending tone)
**And** audio can be muted via settings toggle (persistent)

### AC-8.11: Touch Target Sizes

**Given** scanner UI elements rendered
**Then** all interactive elements have:
  - Minimum touch target: 48x48 pixels
  - Primary action buttons: 56px height (e.g., Pass/Fail)
  - Secondary buttons: 48px height
  - List items: 64px height minimum
  - Text input fields: 56px height
  - Icon buttons: 48x48 pixels minimum
**And** spacing between targets: minimum 8px
**And** buttons use high contrast colors (WCAG AAA)

### AC-8.12: Scan WO for In-Process Inspection (Deferred to Phase 2)

**Given** inspector scans WO barcode (e.g., "WO-2025-00001")
**When** barcode detected as WO format
**Then** system shows "WO scanning available in Phase 2" message
**And** [View on Desktop] button to open WO detail page
**And** does not attempt to load inspection

### AC-8.13: Performance Requirements

**Given** scanner device (Zebra TC52 or similar)
**When** inspector scans LP barcode
**Then** LP lookup completes in < 500ms
**When** inspector taps [Quick Pass]
**Then** API call completes in < 1 second (online)
**When** inspector taps [Quick Pass] offline
**Then** action queued in < 100ms (instant feedback)
**When** 50 offline actions sync
**Then** sync completes in < 10 seconds (bulk API)

### AC-8.14: Permission Enforcement

**Given** user with VIEWER role
**When** user navigates to `/scanner/qa/`
**Then** access denied: "Scanner access requires QA Inspector role"
**And** redirect to dashboard

**Given** user with QA_INSPECTOR role
**When** user accesses scanner QA
**Then** full access to scan, inspect, pass/fail

**Given** user with QA_MANAGER role
**When** user accesses scanner QA
**Then** full access plus ability to override failed inspections (Phase 2)

### AC-8.15: Audit Trail Logging

**Given** any scanner action (pass/fail/sync)
**When** action completes
**Then** entry created in `quality_audit_log`:
  ```sql
  INSERT INTO quality_audit_log (
    entity_type, entity_id, action, user_id, timestamp,
    old_value, new_value, change_reason, metadata
  ) VALUES (
    'inspection', :inspection_id, 'scanner_complete', :user_id, now(),
    '{"status": "in_progress", "result": null}',
    '{"status": "completed", "result": "pass"}',
    'Scanner quick pass',
    '{"inspection_method": "scanner", "device_id": "...", "offline_queued": false}'
  );
  ```
**And** metadata includes:
  - inspection_method: 'scanner'
  - device_id: Device identifier
  - offline_queued: true/false
  - sync_delay_seconds: Time from local timestamp to sync (if offline)

---

## Implementation Notes

### API Endpoints

```typescript
// =============================================================================
// Scanner Quick Inspection Endpoint (NEW)
// =============================================================================

// POST /api/quality/scanner/quick-inspection
// Quick pass/fail for scanner workflow (simplified version of complete inspection)
interface QuickInspectionRequest {
  inspection_id: string;
  result: 'pass' | 'fail';
  result_notes?: string;
  defects_found?: number;
  inspection_method: 'scanner';
  scanner_device_id?: string;
  scanner_location?: string;  // GPS coordinates (optional)
}

interface QuickInspectionResponse {
  inspection: QualityInspection;
  lp_status_updated: boolean;
  lp_new_status: 'passed' | 'failed';
}

// POST /api/quality/scanner/sync-offline
// Bulk sync offline actions
interface SyncOfflineRequest {
  actions: OfflineAction[];
}

interface OfflineAction {
  id: string;  // Local UUID
  type: 'quick_inspection' | 'test_result';
  payload: QuickInspectionRequest | TestResultRequest;
  timestamp: string;  // ISO 8601
}

interface SyncOfflineResponse {
  success: number;
  failed: number;
  errors: {
    action_id: string;
    error: string;
  }[];
}

// GET /api/quality/inspections/by-lp/:lpId
// Get pending inspection for LP (shortcut for scanner)
interface InspectionByLPResponse {
  inspection: QualityInspection | null;
  lp: LicensePlate;
  has_pending_inspection: boolean;
}

// GET /api/warehouse/license-plates/lookup?barcode=LP00000001
// Lookup LP by barcode (reuse existing endpoint from Epic 05)
interface LPLookupResponse {
  lp: LicensePlate;
  current_location: Location;
  qa_status: string;
  pending_inspections_count: number;
}
```

### Frontend Components

```
apps/frontend/app/(authenticated)/scanner/
  qa/
    layout.tsx                         # Scanner QA layout (inherits from scanner/layout.tsx)
    page.tsx                           # Scanner QA home (task selection)
    inspection/
      [id]/page.tsx                    # Inspection detail with quick pass/fail
    scan/
      page.tsx                         # Dedicated scan page (if needed)

components/scanner/
  ScannerLayout.tsx                    # Base scanner layout (dark theme, minimal chrome)
  ScanInput.tsx                        # Barcode scan input with audio feedback
  ScannerActionBar.tsx                 # Fixed bottom action bar
  SyncStatusBadge.tsx                  # Online/offline/syncing indicator
  AudioFeedback.tsx                    # Audio beep/chime player
  OfflineBadge.tsx                     # Queue count badge

components/scanner/qa/
  QAScannerHome.tsx                    # QA scanner home screen
  QuickInspectionDetail.tsx            # Inspection detail for scanner
  QuickPassFailButtons.tsx             # Large pass/fail buttons
  QuickPassConfirmDialog.tsx           # Pass confirmation dialog
  QuickFailConfirmDialog.tsx           # Fail confirmation with notes
  TestParameterCard.tsx                # Parameter card (large touch target)
  TestParameterModal.tsx               # Parameter result entry modal
  InspectionSuccessScreen.tsx          # Success animation/feedback
  InspectionFailScreen.tsx             # Fail animation/feedback
  QAStatusBadge.tsx                    # QA status badge (large, color-coded)
```

### Services

```typescript
// lib/services/scanner-qa-service.ts

export class ScannerQAService {
  /**
   * Lookup LP and check for pending inspection
   */
  static async lookupLPForInspection(barcode: string): Promise<{
    lp: LicensePlate;
    inspection: QualityInspection | null;
  }>;

  /**
   * Quick pass/fail inspection (simplified workflow)
   */
  static async quickInspection(input: QuickInspectionRequest): Promise<QuickInspectionResponse>;

  /**
   * Sync offline actions in bulk
   */
  static async syncOfflineActions(actions: OfflineAction[]): Promise<SyncOfflineResponse>;

  /**
   * Get offline queue from IndexedDB
   */
  static async getOfflineQueue(): Promise<OfflineAction[]>;

  /**
   * Queue action for offline sync
   */
  static async queueOfflineAction(action: Omit<OfflineAction, 'id' | 'synced'>): Promise<void>;

  /**
   * Clear synced actions from queue
   */
  static async clearSyncedActions(actionIds: string[]): Promise<void>;
}

// lib/services/audio-feedback-service.ts

export class AudioFeedbackService {
  /**
   * Play success beep (440 Hz, 100ms)
   */
  static playSuccessBeep(): void;

  /**
   * Play error beep (220 Hz, 200ms)
   */
  static playErrorBeep(): void;

  /**
   * Play success chime (ascending tone)
   */
  static playSuccessChime(): void;

  /**
   * Play alert tone (descending tone)
   */
  static playAlertTone(): void;

  /**
   * Check if audio is muted
   */
  static isMuted(): boolean;

  /**
   * Toggle audio mute
   */
  static toggleMute(): void;
}

// lib/services/offline-sync-service.ts

export class OfflineSyncService {
  /**
   * Initialize IndexedDB for offline queue
   */
  static async init(): Promise<void>;

  /**
   * Check if device is online
   */
  static isOnline(): boolean;

  /**
   * Listen for online/offline events
   */
  static onConnectivityChange(callback: (online: boolean) => void): () => void;

  /**
   * Trigger sync of offline queue
   */
  static async syncNow(): Promise<SyncOfflineResponse>;

  /**
   * Get queue count
   */
  static async getQueueCount(): Promise<number>;
}
```

### Validation (Zod)

```typescript
import { z } from 'zod';

export const quickInspectionSchema = z.object({
  inspection_id: z.string().uuid('Invalid inspection ID'),
  result: z.enum(['pass', 'fail']),
  result_notes: z.string().max(2000).optional(),
  defects_found: z.number().int().min(0).max(1000).optional(),
  inspection_method: z.literal('scanner'),
  scanner_device_id: z.string().max(100).optional(),
  scanner_location: z.string().max(100).optional(),  // GPS coordinates
});

export const offlineActionSchema = z.object({
  id: z.string().uuid(),
  type: z.enum(['quick_inspection', 'test_result']),
  payload: z.record(z.any()),  // Union of all possible payloads
  timestamp: z.string().datetime(),
});

export const syncOfflineSchema = z.object({
  actions: z.array(offlineActionSchema).min(1).max(100),  // Max 100 actions per sync
});
```

### IndexedDB Schema

```typescript
// Scanner offline queue storage
const DB_NAME = 'monopilot-scanner';
const DB_VERSION = 1;

interface IndexedDBSchema {
  offline_queue: {
    key: string;  // UUID
    value: OfflineAction;
    indexes: {
      by_timestamp: Date;
      by_type: string;
      by_synced: boolean;
    };
  };
  settings: {
    key: string;
    value: {
      audio_muted: boolean;
      device_id: string;
      last_sync: Date;
    };
  };
}

// Initialize IndexedDB
async function initDB(): Promise<IDBDatabase> {
  return new Promise((resolve, reject) => {
    const request = indexedDB.open(DB_NAME, DB_VERSION);

    request.onerror = () => reject(request.error);
    request.onsuccess = () => resolve(request.result);

    request.onupgradeneeded = (event) => {
      const db = (event.target as IDBOpenDBRequest).result;

      // Create offline_queue store
      const queueStore = db.createObjectStore('offline_queue', { keyPath: 'id' });
      queueStore.createIndex('by_timestamp', 'timestamp');
      queueStore.createIndex('by_type', 'type');
      queueStore.createIndex('by_synced', 'synced');

      // Create settings store
      db.createObjectStore('settings', { keyPath: 'key' });
    };
  });
}
```

### Key Business Rules

1. **Scanner Access**: Requires QA_INSPECTOR or QA_MANAGER role
2. **One Active Inspection per LP**: Quick pass/fail only works if LP has pending inspection
3. **Offline Queue Limit**: Maximum 50 actions queued offline (configurable)
4. **Sync Priority**: Actions processed in chronological order (oldest first)
5. **Duplicate Prevention**: API checks inspection not already completed before applying offline action
6. **Audit Trail**: All scanner actions logged with device_id, timestamp, online/offline status
7. **LP Status Update**: Quick pass/fail automatically updates LP.qa_status (same as desktop)
8. **Test Results Optional**: Quick pass/fail skips test results in MVP (Phase 2 feature)
9. **Audio Feedback**: Success/error beeps configurable per user (persisted in IndexedDB)
10. **Touch Targets**: Minimum 48px, primary actions 56px (WCAG AAA)

---

## Deliverables

### Database
- [ ] Migration: `scanner_offline_queue` table
- [ ] Migration: Add scanner metadata to `quality_inspections` table
- [ ] RLS policies for scanner_offline_queue

### API Routes
- [ ] `POST /api/quality/scanner/quick-inspection` - Quick pass/fail
- [ ] `POST /api/quality/scanner/sync-offline` - Bulk sync
- [ ] `GET /api/quality/inspections/by-lp/:lpId` - Get inspection by LP

### Service Layer
- [ ] `ScannerQAService.lookupLPForInspection()` - LP lookup with inspection check
- [ ] `ScannerQAService.quickInspection()` - Quick pass/fail workflow
- [ ] `ScannerQAService.syncOfflineActions()` - Bulk sync handler
- [ ] `ScannerQAService.queueOfflineAction()` - Queue to IndexedDB
- [ ] `AudioFeedbackService` - Audio beep/chime player
- [ ] `OfflineSyncService` - IndexedDB and connectivity management

### Frontend
- [ ] Scanner QA home page (`/scanner/qa/`)
- [ ] Inspection detail page (`/scanner/qa/inspection/[id]`)
- [ ] ScanInput component with audio feedback
- [ ] QuickPassFailButtons component (large touch targets)
- [ ] QuickPassConfirmDialog component
- [ ] QuickFailConfirmDialog component
- [ ] SyncStatusBadge component (online/offline/syncing)
- [ ] OfflineBadge component (queue count)
- [ ] InspectionSuccessScreen component
- [ ] InspectionFailScreen component
- [ ] Scanner layout with dark theme

### Validation
- [ ] `quickInspectionSchema`
- [ ] `syncOfflineSchema`
- [ ] `offlineActionSchema`

### Tests
- [ ] Unit tests: ScannerQAService methods (>80% coverage)
- [ ] Unit tests: AudioFeedbackService
- [ ] Unit tests: OfflineSyncService
- [ ] Integration tests: POST /api/quality/scanner/quick-inspection
- [ ] Integration tests: POST /api/quality/scanner/sync-offline
- [ ] IndexedDB tests: Queue operations
- [ ] E2E tests: Full scanner workflow (scan -> pass/fail -> sync)
- [ ] E2E tests: Offline mode (queue -> go offline -> go online -> sync)
- [ ] Touch target size tests (verify 48px+ for all interactive elements)

---

## Test Strategy

### Unit Tests

```typescript
describe('ScannerQAService', () => {
  describe('lookupLPForInspection', () => {
    it('returns LP and inspection if pending', async () => {});
    it('returns LP and null if no inspection', async () => {});
    it('throws error if LP not found', async () => {});
  });

  describe('quickInspection', () => {
    it('completes inspection as pass', async () => {});
    it('completes inspection as fail with notes', async () => {});
    it('updates LP QA status on completion', async () => {});
    it('logs audit trail with scanner metadata', async () => {});
    it('prevents duplicate completion', async () => {});
  });

  describe('syncOfflineActions', () => {
    it('syncs 3 queued actions successfully', async () => {});
    it('handles partial failures', async () => {});
    it('prevents duplicate inspections', async () => {});
    it('processes actions in chronological order', async () => {});
  });

  describe('queueOfflineAction', () => {
    it('adds action to IndexedDB queue', async () => {});
    it('enforces max queue size (50)', async () => {});
  });
});

describe('AudioFeedbackService', () => {
  it('plays success beep', () => {});
  it('plays error beep', () => {});
  it('respects mute setting', () => {});
});

describe('OfflineSyncService', () => {
  it('detects online/offline status', () => {});
  it('triggers sync on online event', async () => {});
  it('returns queue count', async () => {});
});
```

### Integration Tests

```typescript
describe('Scanner QA API', () => {
  describe('POST /api/quality/scanner/quick-inspection', () => {
    it('completes inspection with pass result', async () => {});
    it('updates LP QA status to passed', async () => {});
    it('completes inspection with fail result and notes', async () => {});
    it('returns 400 if inspection already completed', async () => {});
    it('returns 403 if user not QA Inspector', async () => {});
    it('logs audit trail with scanner metadata', async () => {});
  });

  describe('POST /api/quality/scanner/sync-offline', () => {
    it('syncs 3 actions successfully', async () => {});
    it('returns errors for invalid actions', async () => {});
    it('prevents duplicate completions', async () => {});
    it('processes actions in timestamp order', async () => {});
    it('returns 400 if actions exceed 100', async () => {});
  });

  describe('GET /api/quality/inspections/by-lp/:lpId', () => {
    it('returns inspection if pending', async () => {});
    it('returns null if no inspection', async () => {});
    it('respects RLS for org isolation', async () => {});
  });
});
```

### E2E Tests (Playwright)

```typescript
describe('Scanner QA Workflow', () => {
  it('complete workflow: scan LP -> view inspection -> quick pass', async () => {
    // 1. Navigate to scanner QA home
    await page.goto('/scanner/qa/');
    await expect(page.locator('h1')).toContainText('Quality Inspection');

    // 2. Scan LP barcode (simulate hardware scanner)
    await page.locator('input[placeholder="Scan barcode"]').fill('LP00000001');
    await page.keyboard.press('Enter');

    // 3. Verify inspection detail displays
    await expect(page.locator('h2')).toContainText('INS-INC-2025-00001');
    await expect(page.locator('.product-name')).toContainText('Flour');

    // 4. Tap Quick Pass button
    await page.locator('button:has-text("Quick Pass")').click();

    // 5. Confirm pass
    await page.locator('button:has-text("Confirm Pass")').click();

    // 6. Verify success screen
    await expect(page.locator('.success-message')).toContainText('Inspection Passed');

    // 7. Verify redirect to scanner home
    await page.waitForURL('/scanner/qa/');
  });

  it('offline mode: queue action -> go offline -> go online -> sync', async () => {
    // 1. Go offline
    await page.context().setOffline(true);

    // 2. Scan LP and quick pass
    await page.goto('/scanner/qa/');
    await page.locator('input[placeholder="Scan barcode"]').fill('LP00000001');
    await page.keyboard.press('Enter');
    await page.locator('button:has-text("Quick Pass")').click();
    await page.locator('button:has-text("Confirm Pass")').click();

    // 3. Verify action queued
    await expect(page.locator('.queue-badge')).toContainText('1 action queued');

    // 4. Go online
    await page.context().setOffline(false);

    // 5. Wait for sync
    await page.waitForSelector('.sync-status:has-text("Synced")');

    // 6. Verify queue cleared
    await expect(page.locator('.queue-badge')).not.toBeVisible();
  });

  it('touch targets are 48px+', async () => {
    await page.goto('/scanner/qa/');

    // Verify primary button height
    const passButton = page.locator('button:has-text("Quick Pass")');
    const boundingBox = await passButton.boundingBox();
    expect(boundingBox?.height).toBeGreaterThanOrEqual(48);
    expect(boundingBox?.width).toBeGreaterThanOrEqual(48);
  });
});
```

---

## Definition of Done

### Database
- [ ] `scanner_offline_queue` table created with RLS policies
- [ ] Scanner metadata columns added to `quality_inspections` table
- [ ] Indexes created for scanner queries

### API
- [ ] `POST /api/quality/scanner/quick-inspection` endpoint working
- [ ] `POST /api/quality/scanner/sync-offline` endpoint working
- [ ] `GET /api/quality/inspections/by-lp/:lpId` endpoint working
- [ ] All endpoints return correct HTTP status codes
- [ ] Validation errors return 400 with detailed messages
- [ ] Response times:
  - Quick inspection: < 1 second (online)
  - Offline queue: < 100ms
  - Bulk sync (50 actions): < 10 seconds

### Service
- [ ] ScannerQAService methods implemented
- [ ] AudioFeedbackService working (success/error beeps)
- [ ] OfflineSyncService managing IndexedDB queue
- [ ] Offline actions queue and sync correctly
- [ ] LP QA status updated on quick pass/fail
- [ ] Audit trail logged for all scanner actions

### Frontend
- [ ] Scanner QA home page displays correctly
- [ ] Scan input with audio feedback working
- [ ] Inspection detail page with large touch targets
- [ ] Quick pass/fail buttons working (56px height)
- [ ] Pass/fail confirmation dialogs working
- [ ] Success/fail screens display
- [ ] Sync status badge shows online/offline/syncing
- [ ] Offline queue badge shows count
- [ ] Dark theme applied (slate-900 bg)
- [ ] All touch targets >= 48px
- [ ] Audio feedback working (can be muted)

### IndexedDB
- [ ] Offline queue storage working
- [ ] Queue limit enforced (50 actions)
- [ ] Settings persisted (audio mute, device ID)
- [ ] Synced actions cleared from queue

### Testing
- [ ] Unit tests: >80% coverage on services
- [ ] Integration tests: All endpoints covered
- [ ] IndexedDB tests: Queue operations verified
- [ ] E2E tests: Full workflow passing
- [ ] E2E tests: Offline mode passing
- [ ] Touch target size tests passing
- [ ] Audio feedback tests passing

### Integration
- [ ] Works with story 06.5 (Incoming Inspection)
- [ ] Works with Epic 05 LP service (LP lookup)
- [ ] Audit trail integrates with quality_audit_log

---

## Risk Assessment

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| IndexedDB quota exceeded | MEDIUM | LOW | Enforce 50 action limit, clear on sync |
| Audio not supported on device | LOW | LOW | Graceful degradation, visual feedback |
| Offline sync conflicts | HIGH | MEDIUM | Timestamp-based ordering, duplicate check |
| Touch target too small | MEDIUM | LOW | Strict 48px enforcement, design review |
| Network flaky (offline/online loop) | MEDIUM | MEDIUM | Debounce sync, exponential backoff |
| Scanner hardware incompatibility | MEDIUM | LOW | Test on Zebra/Honeywell devices |

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-12-16 | Initial story creation with scanner-optimized QA workflow | OPUS |

---

**Document Status**: Ready for Implementation
**Created**: 2025-12-16
**Lines**: ~1400
**Complexity**: M (Medium)
**Phase**: 1 (Core Quality)
