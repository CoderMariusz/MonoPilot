# 06.22 - CCP Definition

**Priority**: P0 (MVP)
**Story Points**: M (Medium)
**Type**: full-stack
**Phase**: 3 (HACCP)
**Model**: OPUS

**State:** ready
**Estimate:** M (3-4 days)
**Primary PRD:** `docs/1-BASELINE/product/modules/quality.md` (FR-QA-014, Section 6.2)
**Architecture:** `docs/1-BASELINE/architecture/modules/quality.md` (haccp_ccp table)

---

## Goal

Implement Critical Control Point (CCP) definition and management within HACCP plans for products. This enables QA teams to define CCPs at critical production steps, set critical limits (min/max values), assign monitoring frequencies, and link CCPs to routing operations. CCP definition is the foundation for real-time monitoring and food safety compliance.

---

## Food Safety Compliance

This story is **CRITICAL for food safety compliance**:

- [x] **HACCP Compliance** - CCPs are mandatory for HACCP-certified processes
- [x] **FDA FSMA** - Preventive controls require documented CCPs
- [x] **Audit Trail Required** - All CCP setup changes logged with user ID and timestamp
- [x] **Critical Limits Validation** - Scientifically validated limits for food safety hazards

**Regulatory Context:**
- HACCP Principle 2: Determine Critical Control Points
- HACCP Principle 3: Establish critical limits for each CCP
- FDA FSMA Preventive Controls require hazard analysis and critical control points
- GFSI standards (BRC, SQF, FSSC 22000) mandate CCP documentation
- CCPs must have measurable limits and monitoring procedures
- All records retained for minimum 5 years (configurable)

---

## MVP Scope

This story implements Phase 3 (HACCP) functionality. CCP Definition is the first CCP story, establishing patterns for CCP monitoring and deviation handling.

**MVP Includes**:
- `haccp_ccp` table with CCP definition fields
- CCP CRUD operations (Create, Read, Update, Delete)
- CCP attributes: number, name, hazard type, critical limits (min/max), unit, monitoring frequency
- CCP decision tree wizard (7-question HACCP decision tree)
- Link CCP to routing operation (where monitored in production)
- Critical limits validation rules (min < max, numeric validation)
- CCP versioning (effective_date, expiry_date)
- CCP status (draft, active, inactive)
- Link to HACCP plan (from story 06.21)
- CCP list page with search and filters
- CCP detail page with linked operations
- CCP creation wizard with decision tree
- CCP edit modal
- Integration with routing operations (Epic 04)

**Deferred to Phase 3+**: See "Future Phases" section below.

---

## User Story

As a **QA Manager**, I want to **define Critical Control Points for my HACCP plans, set critical limits, and link them to routing operations** so that **I can ensure food safety hazards are controlled at critical production steps**.

As a **Production Manager**, I want to **view CCPs linked to routing operations** so that **operators know which steps require CCP monitoring**.

---

## Scope

**In scope (this story)**
- `haccp_ccp` table with CCP definition fields
- GET /api/quality/haccp/ccp (list CCPs with filters)
- GET /api/quality/haccp/ccp/:id (CCP detail)
- POST /api/quality/haccp/ccp (create CCP)
- PUT /api/quality/haccp/ccp/:id (update CCP)
- DELETE /api/quality/haccp/ccp/:id (delete draft CCP)
- POST /api/quality/haccp/ccp/:id/activate (activate CCP)
- POST /api/quality/haccp/ccp/:id/deactivate (deactivate CCP)
- CCP decision tree wizard (7-question flow)
- Critical limits validation (min/max, unit validation)
- Link CCP to routing operation
- CCP list page with DataTable and filters
- CCP detail page
- CCP creation wizard
- CCP edit modal
- CCP status badges (draft/active/inactive)

**Out of scope (this story)**
- CCP monitoring data entry (story 06.23 - desktop)
- CCP monitoring mobile (story 06.24 - scanner)
- CCP deviation handling (story 06.25)
- CCP deviation alerts (story 06.26)
- CCP monitoring reports (Phase 4)
- CCP trend analysis (Phase 4)
- Auto-create CCP from templates (Phase 4)

---

## Future Phases (Not in MVP)

### Phase 3+ (Story 06.22b - CCP Definition Advanced)
- **CCP Templates** - Pre-configured CCP templates for common hazards
- **Auto-create from industry standards** - CCP templates from BRC/SQF
- **Multi-language CCP names** - Support for multilingual CCP descriptions
- **Photo attachments** - Visual aids for CCP identification
- **CCP history tracking** - Version history with diff view

### Phase 4
- **CCP risk assessment integration** - Link to risk analysis (Severity x Likelihood)
- **CCP verification schedules** - Periodic verification activities
- **CCP effectiveness metrics** - Track CCP performance over time
- **CCP audit trail reports** - Comprehensive audit logs for regulators
- **E-signature for CCP activation** - FDA 21 CFR Part 11 compliant signatures

### Deferred to Other Stories
- **CCP Monitoring (Desktop)** - Story 06.23
- **CCP Monitoring (Scanner)** - Story 06.24
- **CCP Deviation Handling** - Story 06.25
- **CCP Deviation Alerts** - Story 06.26
- **HACCP Plan Setup** - Story 06.21 (prerequisite)

---

## Dependencies

### Cross-Epic Dependencies

| Dependency | Story/Epic | Type | What It Provides | Status |
|------------|------------|------|------------------|--------|
| 01.1 | Org Context + RLS | HARD | organizations, users, roles tables | Ready |
| 02.1 | Products CRUD | HARD | products table for product reference | Ready |
| 04.1 | Routings CRUD | HARD | routings, routing_operations tables | Ready |

### Within Epic Dependencies

| Dependency | Story | Type | What It Provides |
|------------|-------|------|------------------|
| 06.21 | HACCP Plan Setup | HARD | haccp_plans table, HACCP plan context |

### Provides To (Downstream)

| Story | What This Provides |
|-------|-------------------|
| 06.23 | CCP Monitoring Desktop - haccp_ccp table, CCP reference |
| 06.24 | CCP Monitoring Scanner - CCP limits for validation |
| 06.25 | CCP Deviation Handling - CCP definition for deviation rules |
| 06.26 | CCP Deviation Alerts - CCP escalation rules |

---

## Database Migration

### Migration: Create haccp_ccp table

```sql
-- Migration: YYYYMMDDHHMMSS_create_haccp_ccp.sql

CREATE TABLE haccp_ccp (
    -- Identity
    id                      UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id                  UUID NOT NULL REFERENCES organizations(id),

    -- HACCP Plan Reference
    haccp_plan_id           UUID NOT NULL REFERENCES haccp_plans(id) ON DELETE CASCADE,

    -- CCP Identification
    ccp_number              TEXT NOT NULL, -- e.g., "CCP-1", "CCP-2"
    ccp_name                TEXT NOT NULL, -- e.g., "Receiving Temperature", "Cooking Temperature"

    -- Hazard Classification
    hazard_type             TEXT NOT NULL
                            CHECK (hazard_type IN ('biological', 'chemical', 'physical')),
    hazard_description      TEXT NOT NULL, -- e.g., "Pathogen survival (Salmonella)"

    -- Control Measure
    control_measure         TEXT NOT NULL, -- e.g., "Monitor refrigerator temp", "Metal detector scan"

    -- Critical Limits
    critical_limit_min      NUMERIC,       -- e.g., 0 (for 0-4°C)
    critical_limit_max      NUMERIC,       -- e.g., 4 (for 0-4°C)
    unit_of_measure         TEXT NOT NULL, -- e.g., "°C", "pH", "ppm", "mm"
    target_value            NUMERIC,       -- Optional target (e.g., 2°C)

    -- Monitoring
    monitoring_frequency    TEXT NOT NULL, -- e.g., "Every receipt", "Hourly", "Every batch"
    monitoring_method       TEXT NOT NULL, -- e.g., "Infrared thermometer", "pH meter", "Metal detector"

    -- Routing Integration
    routing_id              UUID REFERENCES routings(id), -- Link to routing
    routing_operation_id    UUID REFERENCES routing_operations(id), -- Link to specific operation

    -- Corrective Action
    corrective_action_std   TEXT NOT NULL, -- Standard corrective action if out of limit

    -- Verification
    verification_method     TEXT, -- e.g., "Calibrate thermometer weekly"
    verification_frequency  TEXT, -- e.g., "Weekly", "Monthly"

    -- Responsibility
    responsible_role        TEXT NOT NULL, -- e.g., "Receiving Operator", "QA Inspector"
    responsible_user_id     UUID REFERENCES users(id), -- Optional: specific user assignment

    -- Versioning
    version                 INTEGER NOT NULL DEFAULT 1,
    effective_date          DATE NOT NULL DEFAULT CURRENT_DATE,
    expiry_date             DATE,

    -- Status
    status                  TEXT NOT NULL DEFAULT 'draft'
                            CHECK (status IN ('draft', 'active', 'inactive', 'superseded')),

    -- Approval
    approved_by             UUID REFERENCES users(id),
    approved_at             TIMESTAMPTZ,

    -- Decision Tree (HACCP 7-question tree answers stored as JSONB)
    decision_tree_answers   JSONB, -- Store Q1-Q7 answers for audit trail

    -- Audit
    created_at              TIMESTAMPTZ NOT NULL DEFAULT now(),
    created_by              UUID REFERENCES users(id),
    updated_at              TIMESTAMPTZ NOT NULL DEFAULT now(),
    updated_by              UUID REFERENCES users(id),

    -- Constraints
    CONSTRAINT uq_ccp_number UNIQUE (org_id, haccp_plan_id, ccp_number),
    CONSTRAINT chk_critical_limits CHECK (
        critical_limit_min IS NULL OR critical_limit_max IS NULL OR critical_limit_min < critical_limit_max
    )
);

-- =============================================================================
-- Indexes for Performance
-- =============================================================================

CREATE INDEX idx_haccp_ccp_org ON haccp_ccp(org_id);
CREATE INDEX idx_haccp_ccp_plan ON haccp_ccp(haccp_plan_id);
CREATE INDEX idx_haccp_ccp_status ON haccp_ccp(org_id, status);
CREATE INDEX idx_haccp_ccp_routing ON haccp_ccp(routing_id) WHERE routing_id IS NOT NULL;
CREATE INDEX idx_haccp_ccp_operation ON haccp_ccp(routing_operation_id) WHERE routing_operation_id IS NOT NULL;
CREATE INDEX idx_haccp_ccp_hazard ON haccp_ccp(org_id, hazard_type);
CREATE INDEX idx_haccp_ccp_effective ON haccp_ccp(org_id, effective_date, expiry_date)
    WHERE status = 'active';

-- =============================================================================
-- RLS Policies
-- =============================================================================

ALTER TABLE haccp_ccp ENABLE ROW LEVEL SECURITY;

CREATE POLICY "ccp_select" ON haccp_ccp
    FOR SELECT USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

CREATE POLICY "ccp_insert" ON haccp_ccp
    FOR INSERT WITH CHECK (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

CREATE POLICY "ccp_update" ON haccp_ccp
    FOR UPDATE USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

-- Only allow delete of draft CCPs (not active)
CREATE POLICY "ccp_delete" ON haccp_ccp
    FOR DELETE USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
        AND status = 'draft'
    );

-- =============================================================================
-- Trigger for updated_at
-- =============================================================================

CREATE TRIGGER update_haccp_ccp_updated_at
    BEFORE UPDATE ON haccp_ccp
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- =============================================================================
-- Function: Validate critical limits before activation
-- =============================================================================

CREATE OR REPLACE FUNCTION validate_ccp_before_activation()
RETURNS TRIGGER AS $$
BEGIN
    -- Only validate on activation (draft -> active)
    IF NEW.status = 'active' AND (OLD.status IS NULL OR OLD.status = 'draft') THEN

        -- Require critical limits
        IF NEW.critical_limit_min IS NULL AND NEW.critical_limit_max IS NULL THEN
            RAISE EXCEPTION 'CCP activation requires at least one critical limit (min or max)';
        END IF;

        -- Require routing link
        IF NEW.routing_id IS NULL THEN
            RAISE EXCEPTION 'CCP activation requires routing link';
        END IF;

        -- Require approval
        IF NEW.approved_by IS NULL THEN
            RAISE EXCEPTION 'CCP activation requires approval by QA Manager';
        END IF;

    END IF;

    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_validate_ccp_activation
    BEFORE UPDATE ON haccp_ccp
    FOR EACH ROW
    EXECUTE FUNCTION validate_ccp_before_activation();
```

---

## Acceptance Criteria (Given/When/Then)

### AC-1: CCP Table Creation

```gherkin
Scenario: haccp_ccp table exists with all required columns
  Given database migration runs
  When schema is inspected
  Then haccp_ccp table has all columns from schema
  And UNIQUE constraint exists on (org_id, haccp_plan_id, ccp_number)
  And CHECK constraint validates critical_limit_min < critical_limit_max
  And FK constraints exist for haccp_plan_id, routing_id, routing_operation_id
  And RLS policies enforce org isolation
```

### AC-2: CCP Creation - Basic

```gherkin
Scenario: Create CCP with valid data
  Given user is QA Manager
  And HACCP plan exists
  When creating CCP with:
    | Field | Value |
    | ccp_number | CCP-1 |
    | ccp_name | Receiving Temperature |
    | hazard_type | biological |
    | hazard_description | Pathogen survival (Salmonella, Listeria) |
    | control_measure | Monitor refrigerator temperature |
    | critical_limit_min | 0 |
    | critical_limit_max | 4 |
    | unit_of_measure | °C |
    | monitoring_frequency | Every receipt |
    | monitoring_method | Infrared thermometer |
    | corrective_action_std | Reject shipment if temp >4°C |
    | responsible_role | Receiving Operator |
  Then CCP created with status = 'draft'
  And CCP.version = 1
  And success toast "CCP-1 created successfully"

Scenario: CCP number uniqueness per HACCP plan
  Given CCP-1 exists for HACCP Plan A
  When creating another CCP-1 for same HACCP Plan A
  Then system returns 409 Conflict
  And error message "CCP-1 already exists for this HACCP plan"

Scenario: CCP number can repeat across different HACCP plans
  Given CCP-1 exists for HACCP Plan A
  When creating CCP-1 for HACCP Plan B (different product)
  Then CCP created successfully
```

### AC-3: CCP Creation - Critical Limits Validation

```gherkin
Scenario: Critical limits min < max validation
  Given creating CCP
  When critical_limit_min = 10 and critical_limit_max = 5
  Then system returns 400 Bad Request
  And error message "Critical limit min must be less than max"

Scenario: At least one critical limit required
  Given creating CCP
  When both critical_limit_min and critical_limit_max are NULL
  Then CCP saved as draft (warning shown)
  And activation blocked until limits set

Scenario: Unit of measure required
  Given creating CCP
  When unit_of_measure is NULL
  Then system returns 400 Bad Request
  And error message "Unit of measure is required"

Scenario: Numeric critical limits validation
  Given creating CCP
  When critical_limit_min = "not_a_number"
  Then system returns 400 Bad Request
  And error message "Critical limits must be numeric"
```

### AC-4: CCP Decision Tree Wizard

```gherkin
Scenario: CCP decision tree wizard (7 questions)
  Given user creating new CCP
  When clicking [Use Decision Tree]
  Then wizard displays 7 HACCP questions:
    | Q# | Question |
    | Q1 | Do preventive measures exist for the identified hazard? |
    | Q2 | Does this step eliminate or reduce the hazard to an acceptable level? |
    | Q3 | Could contamination occur or increase to unacceptable levels? |
    | Q4 | Will a subsequent step eliminate or reduce the hazard? |
  And user answers Yes/No to each
  Then system determines if step is CCP or not
  And decision stored in decision_tree_answers JSONB
  And if CCP confirmed, form pre-fills hazard fields

Scenario: Decision tree result - Is CCP
  Given user completes decision tree
  When answers indicate this is a CCP (Q2=Yes or Q3=Yes+Q4=No)
  Then result: "This is a Critical Control Point (CCP)"
  And form continues to CCP definition
  And decision_tree_answers saved for audit trail

Scenario: Decision tree result - Not CCP
  Given user completes decision tree
  When answers indicate not a CCP
  Then result: "This is NOT a CCP - it is a control point (CP)"
  And suggest creating control point instead (not CCP)
```

### AC-5: Link CCP to Routing Operation

```gherkin
Scenario: Link CCP to routing operation
  Given CCP draft exists
  And routing with operations exists
  When QA Manager selects:
    | Field | Value |
    | Routing | Batch Bread Production (R-001) |
    | Operation | Baking (OP-003) |
  Then CCP.routing_id = R-001
  And CCP.routing_operation_id = OP-003
  And success message "CCP linked to Baking operation"

Scenario: View routing operations with CCPs
  Given CCP linked to Baking operation
  When viewing routing detail page
  Then Baking operation shows CCP badge
  And badge displays "CCP-1: Cooking Temperature"
  And clicking badge opens CCP detail

Scenario: Multiple CCPs per operation allowed
  Given Baking operation exists
  When linking CCP-1 (Temperature) and CCP-2 (Time)
  Then both CCPs link to same operation
  And operation shows "2 CCPs" badge
```

### AC-6: CCP Activation

```gherkin
Scenario: Activate CCP with all required fields
  Given CCP in draft status
  And CCP has:
    | Field | Status |
    | Critical limits | Set (min/max) |
    | Routing link | Set |
    | Approved by | QA Manager |
  When user clicks [Activate CCP]
  Then CCP.status = 'active'
  And CCP.approved_at = now
  And effective_date = today (if not set)
  And success message "CCP-1 activated"

Scenario: Cannot activate without critical limits
  Given CCP in draft status
  And critical_limit_min and critical_limit_max are NULL
  When attempting to activate
  Then error message "Cannot activate: critical limits required"
  And CCP remains draft

Scenario: Cannot activate without routing link
  Given CCP in draft status
  And routing_id is NULL
  When attempting to activate
  Then error message "Cannot activate: routing link required"

Scenario: Cannot activate without QA Manager approval
  Given CCP in draft status
  And approved_by is NULL
  When user (not QA Manager) attempts to activate
  Then error message "CCP activation requires QA Manager approval"
```

### AC-7: CCP Deactivation

```gherkin
Scenario: Deactivate active CCP
  Given CCP with status = 'active'
  When QA Manager clicks [Deactivate]
  And provides reason "Product discontinued"
  Then CCP.status = 'inactive'
  And expiry_date = today
  And audit log records deactivation with reason

Scenario: Cannot delete active CCP
  Given CCP with status = 'active'
  When attempting to delete
  Then error message "Cannot delete active CCP. Deactivate first."
  And delete button disabled
```

### AC-8: CCP Versioning

```gherkin
Scenario: Update CCP creates new version
  Given CCP-1 v1 is active
  When QA Manager updates critical_limit_max from 4 to 5
  Then new CCP-1 v2 created with status = 'draft'
  And old v1 remains active until v2 activated
  And v2.effective_date = NULL (set on activation)

Scenario: Activate new version supersedes old
  Given CCP-1 v2 in draft
  When v2 activated
  Then v1.status = 'superseded'
  And v1.expiry_date = today
  And v2.status = 'active'
  And v2.effective_date = today
```

### AC-9: CCP List Page

```gherkin
Scenario: CCP list page loads
  Given user navigates to Quality > HACCP > CCP
  When page loads
  Then DataTable displays CCPs with columns:
    | Column | Description |
    | CCP # | Link to detail (e.g., CCP-1) |
    | CCP Name | e.g., Receiving Temperature |
    | Hazard Type | Badge (Biological/Chemical/Physical) |
    | Critical Limits | e.g., "0-4 °C" |
    | Routing | Linked routing name |
    | Status | Badge (draft/active/inactive) |
    | Effective Date | Date |
    | Actions | View, Edit, Activate, Deactivate |
  And list loads within 500ms
  And pagination available (20 per page)

Scenario: Filter by hazard type
  Given CCPs exist with various hazard types
  When user filters by hazard_type = 'biological'
  Then only biological hazard CCPs display
  And URL updates with filter state

Scenario: Filter by status
  Given CCPs with mixed statuses
  When user filters by status = 'active'
  Then only active CCPs display

Scenario: Search by CCP name or number
  Given CCPs exist
  When user searches "Temperature" or "CCP-1"
  Then matching CCPs display
  And search debounced (300ms)
```

### AC-10: CCP Detail Page

```gherkin
Scenario: View CCP detail
  Given CCP-1 exists
  When user navigates to /quality/haccp/ccp/CCP-1
  Then page displays:
    | Section | Content |
    | Header | CCP #, Name, Status badge, Hazard badge |
    | Hazard | Hazard type, description, control measure |
    | Critical Limits | Min, Max, Unit, Target value |
    | Monitoring | Frequency, Method, Responsible role |
    | Corrective Action | Standard corrective action |
    | Verification | Method, Frequency |
    | Routing | Linked routing and operation with link |
    | Approval | Approved by, Approved at |
    | Version History | All versions with effective dates |
    | Actions | Edit, Activate, Deactivate, View Monitoring Data |

Scenario: View CCP monitoring records link
  Given CCP-1 has monitoring records (story 06.23)
  When viewing CCP detail
  Then [View Monitoring Data] button shown
  And clicking opens monitoring records for this CCP
```

### AC-11: CCP Edit

```gherkin
Scenario: Edit draft CCP
  Given CCP in draft status
  When QA Manager clicks [Edit]
  Then modal opens with all fields editable
  And user updates fields
  And clicks [Save]
  Then CCP updated
  And audit log records changes

Scenario: Cannot edit active CCP directly
  Given CCP in active status
  When clicking [Edit]
  Then message "Active CCP cannot be edited. Create new version?"
  And [Create New Version] button shown

Scenario: Create new version from active CCP
  Given CCP-1 v1 active
  When clicking [Create New Version]
  Then new draft CCP-1 v2 created
  And v2 pre-filled with v1 data
  And v2.version = 2
  And v2.status = 'draft'
  And user can edit v2
```

### AC-12: Permission Enforcement

```gherkin
Scenario: Viewer can view but not create
  Given user with VIEWER role
  When viewing CCP list
  Then [+ New CCP] button hidden
  And can click to view CCP detail
  And [Edit], [Activate], [Deactivate] buttons hidden

Scenario: QA Inspector can view and create drafts
  Given user with QA_INSPECTOR role
  Then can create CCP (saved as draft)
  And cannot activate CCP (requires QA_MANAGER)

Scenario: QA Manager can activate CCPs
  Given user with QA_MANAGER role
  Then can create, edit, activate, deactivate CCPs
  And can approve CCPs (approved_by field)
```

### AC-13: Audit Trail

```gherkin
Scenario: All CCP actions logged
  Given any CCP state change
  When action completes
  Then quality_audit_log entry created with:
    | Field | Value |
    | entity_type | haccp_ccp |
    | entity_id | ccp.id |
    | action | create/update/activate/deactivate/version |
    | user_id | current user |
    | timestamp | now |
    | old_value | previous state (for updates) |
    | new_value | new state |

Scenario: Critical limits change logged
  Given CCP critical_limit_max changed from 4 to 5
  Then audit log includes:
    | Field | Value |
    | action | update_critical_limit |
    | old_value | { critical_limit_max: 4 } |
    | new_value | { critical_limit_max: 5 } |
```

### AC-14: RLS Policy Enforcement

```gherkin
Scenario: Org isolation on CCP list
  Given User A from Org A and User B from Org B
  And CCPs exist in both orgs
  When User A requests GET /api/quality/haccp/ccp
  Then only Org A CCPs returned

Scenario: Cannot view CCP from different org
  Given CCP belongs to Org B
  When User A (Org A) requests GET /api/quality/haccp/ccp/:id
  Then 404 Not Found returned

Scenario: CCP inherits org_id from user
  Given User A from Org A creates CCP
  Then CCP.org_id = Org A (automatic)
```

### AC-15: Performance Requirements

```gherkin
Scenario: CCP list performance
  Given 100 CCPs in organization
  When listing CCPs with pagination
  Then response time < 500ms

Scenario: CCP detail performance
  Given CCP with version history
  When loading CCP detail page
  Then response time < 500ms

Scenario: CCP creation performance
  Given valid CCP data
  When creating CCP
  Then operation completes < 300ms
```

---

## Implementation Notes

### API Endpoints

```typescript
// =============================================================================
// CCP Endpoints
// =============================================================================

// GET /api/quality/haccp/ccp
// List CCPs with filters
interface CCPListParams {
  haccp_plan_id?: string;
  status?: 'draft' | 'active' | 'inactive' | 'superseded';
  hazard_type?: 'biological' | 'chemical' | 'physical';
  routing_id?: string;
  search?: string;
  sort_by?: 'ccp_number' | 'ccp_name' | 'effective_date' | 'created_at';
  sort_order?: 'asc' | 'desc';
  page?: number;
  limit?: number;
}

interface CCPListResponse {
  ccps: HACCPCCP[];
  pagination: {
    total: number;
    page: number;
    limit: number;
    pages: number;
  };
}

interface HACCPCCP {
  id: string;
  org_id: string;
  haccp_plan_id: string;
  haccp_plan_name: string;

  // CCP Identity
  ccp_number: string;
  ccp_name: string;

  // Hazard
  hazard_type: 'biological' | 'chemical' | 'physical';
  hazard_description: string;
  control_measure: string;

  // Critical Limits
  critical_limit_min?: number;
  critical_limit_max?: number;
  unit_of_measure: string;
  target_value?: number;

  // Monitoring
  monitoring_frequency: string;
  monitoring_method: string;

  // Routing
  routing_id?: string;
  routing_name?: string;
  routing_operation_id?: string;
  operation_name?: string;

  // Corrective Action
  corrective_action_std: string;

  // Verification
  verification_method?: string;
  verification_frequency?: string;

  // Responsibility
  responsible_role: string;
  responsible_user_id?: string;
  responsible_user_name?: string;

  // Versioning
  version: number;
  effective_date?: string;
  expiry_date?: string;

  // Status
  status: 'draft' | 'active' | 'inactive' | 'superseded';

  // Approval
  approved_by?: string;
  approved_by_name?: string;
  approved_at?: string;

  // Decision Tree
  decision_tree_answers?: Record<string, string>;

  // Audit
  created_at: string;
  created_by: string;
  updated_at: string;
}

// GET /api/quality/haccp/ccp/:id
interface CCPDetailResponse {
  ccp: HACCPCCP;
  version_history: HACCPCCP[]; // All versions
  monitoring_records_count: number; // From story 06.23
}

// POST /api/quality/haccp/ccp
interface CreateCCPRequest {
  haccp_plan_id: string;
  ccp_number: string;
  ccp_name: string;
  hazard_type: 'biological' | 'chemical' | 'physical';
  hazard_description: string;
  control_measure: string;
  critical_limit_min?: number;
  critical_limit_max?: number;
  unit_of_measure: string;
  target_value?: number;
  monitoring_frequency: string;
  monitoring_method: string;
  routing_id?: string;
  routing_operation_id?: string;
  corrective_action_std: string;
  verification_method?: string;
  verification_frequency?: string;
  responsible_role: string;
  responsible_user_id?: string;
  decision_tree_answers?: Record<string, string>;
}

interface CreateCCPResponse {
  ccp: HACCPCCP;
}

// PUT /api/quality/haccp/ccp/:id
interface UpdateCCPRequest {
  // Same as CreateCCPRequest (all fields optional)
}

// POST /api/quality/haccp/ccp/:id/activate
interface ActivateCCPRequest {
  effective_date?: string; // Default: today
}

interface ActivateCCPResponse {
  ccp: HACCPCCP;
}

// POST /api/quality/haccp/ccp/:id/deactivate
interface DeactivateCCPRequest {
  reason: string;
  expiry_date?: string; // Default: today
}

// POST /api/quality/haccp/ccp/:id/version
// Create new version from active CCP
interface CreateCCPVersionResponse {
  ccp: HACCPCCP; // New draft version
  previous_version: HACCPCCP;
}
```

### Validation Schemas (Zod)

```typescript
import { z } from 'zod';

export const hazardTypeEnum = z.enum(['biological', 'chemical', 'physical']);
export const ccpStatusEnum = z.enum(['draft', 'active', 'inactive', 'superseded']);

export const createCCPSchema = z.object({
  haccp_plan_id: z.string().uuid('Invalid HACCP plan ID'),
  ccp_number: z.string().regex(/^CCP-\d+$/, 'CCP number must be format CCP-N (e.g., CCP-1)'),
  ccp_name: z.string().min(3).max(200),
  hazard_type: hazardTypeEnum,
  hazard_description: z.string().min(10).max(1000),
  control_measure: z.string().min(10).max(1000),
  critical_limit_min: z.number().optional(),
  critical_limit_max: z.number().optional(),
  unit_of_measure: z.string().min(1).max(50),
  target_value: z.number().optional(),
  monitoring_frequency: z.string().min(3).max(200),
  monitoring_method: z.string().min(3).max(500),
  routing_id: z.string().uuid().optional(),
  routing_operation_id: z.string().uuid().optional(),
  corrective_action_std: z.string().min(10).max(2000),
  verification_method: z.string().max(500).optional(),
  verification_frequency: z.string().max(200).optional(),
  responsible_role: z.string().min(3).max(100),
  responsible_user_id: z.string().uuid().optional(),
  decision_tree_answers: z.record(z.string()).optional(),
}).refine(
  (data) => {
    if (data.critical_limit_min !== undefined && data.critical_limit_max !== undefined) {
      return data.critical_limit_min < data.critical_limit_max;
    }
    return true;
  },
  {
    message: 'Critical limit min must be less than max',
    path: ['critical_limit_min'],
  }
);

export const updateCCPSchema = createCCPSchema.partial();

export const activateCCPSchema = z.object({
  effective_date: z.string().regex(/^\d{4}-\d{2}-\d{2}$/).optional(),
});

export const deactivateCCPSchema = z.object({
  reason: z.string().min(10, 'Reason must be at least 10 characters').max(500),
  expiry_date: z.string().regex(/^\d{4}-\d{2}-\d{2}$/).optional(),
});

export const ccpListQuerySchema = z.object({
  haccp_plan_id: z.string().uuid().optional(),
  status: ccpStatusEnum.optional(),
  hazard_type: hazardTypeEnum.optional(),
  routing_id: z.string().uuid().optional(),
  search: z.string().min(1).optional(),
  sort_by: z.enum(['ccp_number', 'ccp_name', 'effective_date', 'created_at']).default('ccp_number'),
  sort_order: z.enum(['asc', 'desc']).default('asc'),
  page: z.coerce.number().int().positive().default(1),
  limit: z.coerce.number().int().min(1).max(100).default(20),
});
```

### Service Layer

```typescript
// lib/services/haccp-ccp-service.ts

export class HACCPCCPService {
  // ==========================================================================
  // CRUD Operations
  // ==========================================================================

  /**
   * List CCPs with filtering and pagination
   */
  static async list(params: CCPListParams): Promise<PaginatedResult<HACCPCCP>>;

  /**
   * Get CCP by ID with version history
   */
  static async getById(id: string): Promise<CCPDetail | null>;

  /**
   * Get CCP by number
   */
  static async getByNumber(ccpNumber: string, haccpPlanId: string): Promise<HACCPCCP | null>;

  /**
   * Create new CCP
   */
  static async create(input: CreateCCPInput): Promise<HACCPCCP>;

  /**
   * Update CCP (draft only)
   */
  static async update(id: string, input: UpdateCCPInput): Promise<HACCPCCP>;

  /**
   * Delete CCP (draft only)
   */
  static async delete(id: string): Promise<void>;

  // ==========================================================================
  // Activation/Deactivation
  // ==========================================================================

  /**
   * Activate CCP (draft -> active)
   * Validates all required fields
   */
  static async activate(id: string, effectiveDate?: string): Promise<HACCPCCP>;

  /**
   * Deactivate CCP (active -> inactive)
   */
  static async deactivate(id: string, reason: string, expiryDate?: string): Promise<HACCPCCP>;

  // ==========================================================================
  // Versioning
  // ==========================================================================

  /**
   * Create new version from active CCP
   */
  static async createVersion(id: string): Promise<HACCPCCP>;

  /**
   * Get version history for CCP
   */
  static async getVersionHistory(ccpNumber: string, haccpPlanId: string): Promise<HACCPCCP[]>;

  // ==========================================================================
  // Decision Tree
  // ==========================================================================

  /**
   * Evaluate HACCP decision tree (7 questions)
   * Returns whether step is a CCP
   */
  static evaluateDecisionTree(answers: Record<string, boolean>): {
    isCCP: boolean;
    reason: string;
    recommendation: string;
  };

  // ==========================================================================
  // Routing Integration
  // ==========================================================================

  /**
   * Get CCPs for routing operation
   */
  static async getCCPsForOperation(routingOperationId: string): Promise<HACCPCCP[]>;

  /**
   * Link CCP to routing operation
   */
  static async linkToOperation(
    ccpId: string,
    routingId: string,
    routingOperationId: string
  ): Promise<HACCPCCP>;

  // ==========================================================================
  // Validation
  // ==========================================================================

  /**
   * Validate CCP can be activated
   */
  static async canActivate(id: string): Promise<{
    canActivate: boolean;
    missingFields: string[];
    warnings: string[];
  }>;

  /**
   * Check if CCP number is unique within HACCP plan
   */
  static async isCCPNumberUnique(
    ccpNumber: string,
    haccpPlanId: string,
    excludeId?: string
  ): Promise<boolean>;
}
```

### Frontend Components

```
apps/frontend/app/(authenticated)/quality/
  haccp/
    ccp/
      page.tsx                       -- CCP list page
      [id]/
        page.tsx                     -- CCP detail page
      new/
        page.tsx                     -- Create CCP wizard

components/quality/haccp/ccp/
  CCPDataTable.tsx                   -- DataTable with filters
  CCPFilters.tsx                     -- Filter panel (status, hazard type, routing)
  CCPStatusBadge.tsx                 -- Status badge (draft/active/inactive)
  CCPHazardBadge.tsx                 -- Hazard type badge (Biological/Chemical/Physical)
  CCPDetail.tsx                      -- Detail view container
  CCPHeader.tsx                      -- Header with status, actions
  CCPCriticalLimits.tsx              -- Critical limits display (min/max, unit)
  CCPMonitoringInfo.tsx              -- Monitoring frequency, method, responsible
  CCPCorrectiveAction.tsx            -- Corrective action display
  CCPRoutingLink.tsx                 -- Routing and operation link
  CCPVersionHistory.tsx              -- Version history table
  CCPActions.tsx                     -- Action buttons based on status
  CreateCCPWizard.tsx                -- Multi-step CCP creation wizard
  CCPDecisionTreeWizard.tsx          -- 7-question HACCP decision tree
  CCPFormBasic.tsx                   -- Basic CCP info form (Step 1)
  CCPFormCriticalLimits.tsx          -- Critical limits form (Step 2)
  CCPFormMonitoring.tsx              -- Monitoring setup form (Step 3)
  CCPFormRouting.tsx                 -- Routing link form (Step 4)
  EditCCPModal.tsx                   -- Edit CCP modal (draft only)
  ActivateCCPDialog.tsx              -- Activation confirmation
  DeactivateCCPDialog.tsx            -- Deactivation with reason
  CreateVersionDialog.tsx            -- Create new version confirmation
```

### UI Component Details

**CCPDataTable.tsx**
- ShadCN DataTable pattern
- Columns: CCP #, CCP Name, Hazard Type, Critical Limits, Routing, Status, Effective Date, Actions
- Row click navigates to detail
- Inline actions: View, Edit (draft only), Activate, Deactivate
- Hazard badge colors: biological=red, chemical=orange, physical=blue
- Status badge colors: draft=gray, active=green, inactive=yellow, superseded=gray

**CCPDecisionTreeWizard.tsx**
- 7-step wizard with HACCP decision tree questions
- Q1: Do preventive measures exist?
- Q2: Does this step eliminate or reduce hazard?
- Q3: Could contamination occur or increase?
- Q4: Will subsequent step eliminate hazard?
- Logic determines if CCP or control point
- Result page shows recommendation
- Answers stored in decision_tree_answers JSONB

**CreateCCPWizard.tsx**
- Step 1: Basic Info (CCP #, Name, Hazard)
- Step 2: Critical Limits (Min/Max, Unit, Target)
- Step 3: Monitoring (Frequency, Method, Responsible)
- Step 4: Routing Link (Select routing + operation)
- Step 5: Review and Create
- Optional: Start with Decision Tree wizard

---

## Key Business Rules

1. **CCP Number Uniqueness**: CCP number must be unique within HACCP plan (can repeat across plans)
2. **Critical Limits Validation**: Min must be less than max; at least one limit required for activation
3. **Activation Requirements**: CCP must have critical limits, routing link, and QA Manager approval before activation
4. **Versioning on Edit**: Editing active CCP creates new draft version; old version remains active until new version activated
5. **Delete Draft Only**: Only draft CCPs can be deleted; active/inactive must be deactivated
6. **Routing Link Required**: CCP must link to routing operation to activate (where monitoring occurs)
7. **QA Manager Approval**: Only QA_MANAGER role can approve and activate CCPs
8. **Audit Trail Required**: All CCP changes logged to quality_audit_log
9. **RLS Enforcement**: All queries enforce org_id isolation per ADR-013
10. **Decision Tree Optional**: Decision tree wizard is optional; can create CCP directly

---

## Deliverables

### Database
- [ ] Migration: `haccp_ccp` table with all columns
- [ ] Function: `validate_ccp_before_activation()` trigger function
- [ ] RLS policies for haccp_ccp
- [ ] All performance indexes

### API Routes
- [ ] `GET /api/quality/haccp/ccp` - List with filters
- [ ] `GET /api/quality/haccp/ccp/:id` - Get detail with version history
- [ ] `POST /api/quality/haccp/ccp` - Create CCP
- [ ] `PUT /api/quality/haccp/ccp/:id` - Update draft CCP
- [ ] `DELETE /api/quality/haccp/ccp/:id` - Delete draft CCP
- [ ] `POST /api/quality/haccp/ccp/:id/activate` - Activate CCP
- [ ] `POST /api/quality/haccp/ccp/:id/deactivate` - Deactivate CCP
- [ ] `POST /api/quality/haccp/ccp/:id/version` - Create new version

### Service Layer
- [ ] `HACCPCCPService.list()` - List with pagination
- [ ] `HACCPCCPService.getById()` - Get with version history
- [ ] `HACCPCCPService.create()` - Create CCP
- [ ] `HACCPCCPService.update()` - Update draft CCP
- [ ] `HACCPCCPService.delete()` - Delete draft CCP
- [ ] `HACCPCCPService.activate()` - Activate with validation
- [ ] `HACCPCCPService.deactivate()` - Deactivate with reason
- [ ] `HACCPCCPService.createVersion()` - Create new version
- [ ] `HACCPCCPService.evaluateDecisionTree()` - Decision tree logic
- [ ] `HACCPCCPService.canActivate()` - Activation validation

### Validation
- [ ] `createCCPSchema`
- [ ] `updateCCPSchema`
- [ ] `activateCCPSchema`
- [ ] `deactivateCCPSchema`
- [ ] `ccpListQuerySchema`

### Frontend
- [ ] CCP list page
- [ ] CCP detail page
- [ ] Create CCP wizard (4 steps)
- [ ] HACCP decision tree wizard (7 questions)
- [ ] Edit CCP modal
- [ ] Activate/Deactivate dialogs
- [ ] Status, hazard badges
- [ ] Filter panel
- [ ] Search functionality

### Tests
- [ ] Unit tests: HACCPCCPService methods (>80% coverage)
- [ ] Integration tests: All API endpoints
- [ ] Activation validation tests
- [ ] Versioning tests
- [ ] RLS tests: Multi-tenancy isolation
- [ ] E2E: Full CCP workflow (create -> edit -> activate -> deactivate -> version)

---

## Test Strategy

### Unit Tests

```typescript
describe('HACCPCCPService', () => {
  describe('create', () => {
    it('creates CCP with correct fields', async () => {});
    it('validates CCP number format', async () => {});
    it('enforces CCP number uniqueness per HACCP plan', async () => {});
    it('validates critical limits min < max', async () => {});
    it('creates with draft status', async () => {});
  });

  describe('activate', () => {
    it('activates CCP with all required fields', async () => {});
    it('blocks activation without critical limits', async () => {});
    it('blocks activation without routing link', async () => {});
    it('blocks activation without QA Manager approval', async () => {});
    it('sets effective_date to today if not provided', async () => {});
  });

  describe('createVersion', () => {
    it('creates new draft version from active CCP', async () => {});
    it('increments version number', async () => {});
    it('copies all fields from previous version', async () => {});
    it('new version starts as draft', async () => {});
  });

  describe('evaluateDecisionTree', () => {
    it('identifies CCP when Q2=Yes', async () => {});
    it('identifies CCP when Q3=Yes and Q4=No', async () => {});
    it('identifies NOT CCP when answers indicate control point', async () => {});
    it('returns recommendation message', async () => {});
  });
});
```

### Integration Tests

```typescript
describe('HACCP CCP API', () => {
  describe('POST /api/quality/haccp/ccp', () => {
    it('creates CCP with valid data', async () => {});
    it('returns 400 for invalid CCP number format', async () => {});
    it('returns 409 for duplicate CCP number in same plan', async () => {});
    it('allows same CCP number across different plans', async () => {});
    it('enforces org_id from auth', async () => {});
  });

  describe('POST /api/quality/haccp/ccp/:id/activate', () => {
    it('activates CCP with all requirements met', async () => {});
    it('returns 400 without critical limits', async () => {});
    it('returns 403 for non-QA Manager', async () => {});
  });
});
```

### E2E Tests

```typescript
describe('CCP Definition Workflow', () => {
  it('complete workflow: decision tree -> create -> edit -> activate', async () => {
    // 1. Navigate to CCP list
    // 2. Click [+ New CCP]
    // 3. Run decision tree wizard (7 questions)
    // 4. Complete CCP form (4 steps)
    // 5. Save as draft
    // 6. Edit critical limits
    // 7. Link to routing operation
    // 8. Get QA Manager approval
    // 9. Activate CCP
    // 10. Verify status = active
  });

  it('create new version from active CCP', async () => {
    // 1. View active CCP
    // 2. Click [Create New Version]
    // 3. Edit fields in new draft version
    // 4. Activate new version
    // 5. Verify old version superseded
  });
});
```

---

## Definition of Done

### Database
- [ ] `haccp_ccp` table created with all columns
- [ ] All indexes created for performance
- [ ] RLS policies enforce org isolation
- [ ] Trigger for activation validation works
- [ ] Critical limits CHECK constraint works

### API
- [ ] All endpoints return correct HTTP status codes
- [ ] Validation errors return 400 with detailed messages
- [ ] Cross-tenant access returns 404
- [ ] Response times:
  - CCP list: < 500ms
  - CCP detail: < 500ms
  - Create/Update: < 300ms

### Service
- [ ] Complete workflow: create -> activate -> deactivate -> version
- [ ] Decision tree evaluation logic works
- [ ] Critical limits validation works
- [ ] Audit trail created for all actions
- [ ] Permission checks enforced

### Frontend
- [ ] CCP list page displays correctly
- [ ] CCP detail page shows all information
- [ ] Decision tree wizard works (7 questions)
- [ ] Create CCP wizard works (4 steps)
- [ ] Edit modal works (draft only)
- [ ] Activate/Deactivate dialogs work
- [ ] Status/hazard badges display correctly
- [ ] Filters and search work
- [ ] Pagination works

### Testing
- [ ] Unit tests: >80% coverage on service
- [ ] Integration tests: All endpoints covered
- [ ] Activation validation tests passing
- [ ] Versioning tests passing
- [ ] RLS tests: Multi-tenancy verified
- [ ] E2E tests: Full workflow passing

### Integration
- [ ] Works with story 06.21 (HACCP Plans)
- [ ] Works with Epic 04 (Routings)
- [ ] Ready for story 06.23 (CCP Monitoring Desktop)

---

## Risk Assessment

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Critical limits validation complexity | MEDIUM | LOW | Comprehensive Zod schemas, unit tests |
| Versioning conflicts | MEDIUM | MEDIUM | Clear version activation workflow, status checks |
| Decision tree logic errors | HIGH | LOW | Well-documented HACCP decision tree, thorough testing |
| Routing link complexity | MEDIUM | MEDIUM | Clear FK relationships, cascade rules |
| Permission enforcement gaps | HIGH | LOW | RLS policies, role-based checks |
| Performance with many versions | MEDIUM | LOW | Proper indexes, pagination |

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-01-15 | Initial story creation - CCP Definition for HACCP | OPUS |

---

**Document Status**: Ready for Implementation
**Created**: 2025-01-15
**Lines**: ~980
**Complexity**: M (Medium)
**Phase**: 3 (HACCP)
