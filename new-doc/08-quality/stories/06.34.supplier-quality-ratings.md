# 06.34 - Supplier Quality Ratings

**Priority**: P1 (Phase 4)
**Story Points**: M (Medium)
**Type**: full-stack
**Phase**: 4 (Advanced Quality)

**State:** ready
**Estimate:** M (3-4 days)
**Primary PRD:** `docs/1-BASELINE/product/modules/quality.md` (FR-QA-018, Section 4.6 Supplier Quality)

---

## Goal

Implement supplier quality scorecard system. Automatically calculate supplier ratings based on quality (defect rate), delivery (on-time %), and responsiveness (issue resolution time). Overall score is weighted average used to determine supplier approval status (approved/conditional/blocked).

---

## User Story

As a **Purchasing Manager**, I want to **view supplier quality scorecards with objective ratings** so that **I can make informed sourcing decisions**.

As a **QA Manager**, I want to **track supplier quality trends and block poor performers** so that **we ensure only approved suppliers provide materials**.

---

## Dependencies

- **Requires**: 01.1 Org Context, 03.3 Suppliers CRUD (from Epic 01/03)
- **Blocks**: 06.35 Supplier Audits

---

## Database Schema

```sql
CREATE TABLE supplier_quality_ratings (
    id                      UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id                  UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    supplier_id             UUID NOT NULL REFERENCES suppliers(id) ON DELETE CASCADE,

    rating_period           TEXT NOT NULL,  -- e.g., "2025-Q1", "2025-03"

    quality_score           DECIMAL(5,2),   -- 0-100 (based on defect rate)
    delivery_score          DECIMAL(5,2),   -- 0-100 (based on on-time %)
    response_score          DECIMAL(5,2),   -- 0-100 (based on issue resolution time)

    overall_score           DECIMAL(5,2) NOT NULL,  -- Weighted average

    rating_status           TEXT NOT NULL
                            CHECK (rating_status IN ('excellent', 'good', 'fair', 'poor')),

    approval_status         TEXT NOT NULL DEFAULT 'approved'
                            CHECK (approval_status IN ('approved', 'conditional', 'blocked')),

    rated_by                UUID REFERENCES users(id),
    rated_at                TIMESTAMPTZ NOT NULL DEFAULT now(),

    notes                   TEXT,

    created_at              TIMESTAMPTZ NOT NULL DEFAULT now(),
    updated_at              TIMESTAMPTZ NOT NULL DEFAULT now(),

    CONSTRAINT uq_supplier_rating_period UNIQUE (org_id, supplier_id, rating_period)
);

CREATE INDEX idx_supplier_ratings_supplier ON supplier_quality_ratings(supplier_id);
CREATE INDEX idx_supplier_ratings_period ON supplier_quality_ratings(org_id, rating_period);
CREATE INDEX idx_supplier_ratings_status ON supplier_quality_ratings(org_id, rating_status);
CREATE INDEX idx_supplier_ratings_overall ON supplier_quality_ratings(org_id, overall_score DESC);
```

---

## API Endpoints

- **GET** `/api/quality/supplier-ratings` - List all supplier ratings
- **GET** `/api/quality/supplier-ratings/:supplierId` - Get supplier scorecard
- **POST** `/api/quality/supplier-ratings` - Create/update rating
- **POST** `/api/quality/supplier-ratings/:id/calculate` - Auto-calculate from data
- **PUT** `/api/quality/supplier-ratings/:id/approval-status` - Update approval status

---

## Key Features

1. **Quality Score Calculation**: Based on incoming inspection failure rate
2. **Delivery Score Calculation**: % of POs received on-time
3. **Response Score Calculation**: Average days to resolve NCRs
4. **Weighted Overall Score**: Quality 50%, Delivery 30%, Response 20%
5. **Rating Status**:
   - Excellent: >95
   - Good: 85-95
   - Fair: 70-85
   - Poor: <70
6. **Approval Status**: approved (score >85), conditional (70-85), blocked (<70)
7. **Auto-Update**: Scores recalculate from incoming inspection results (Epic 05/06 integration)

---

## Acceptance Criteria

### AC-1: Calculate Supplier Quality Score

```gherkin
Scenario: Auto-calculate quality score
  Given supplier received 100 shipments last month
  And 3 failed incoming inspection
  When calculating quality score
  Then quality_score = 97.0 (97% pass rate)
```

### AC-2: Calculate Overall Score

```gherkin
Scenario: Weighted average calculation
  Given supplier scores:
    | Metric | Score | Weight |
    | Quality | 95 | 50% |
    | Delivery | 90 | 30% |
    | Response | 85 | 20% |
  When calculating overall score
  Then overall_score = 91.5
  And rating_status = 'excellent'
  And approval_status = 'approved'
```

### AC-3: Update Approval Status

```gherkin
Scenario: Block poor-performing supplier
  Given supplier overall_score = 65 (poor)
  When QA Manager reviews scorecard
  And clicks [Block Supplier]
  Then approval_status = 'blocked'
  And PO creation for supplier disabled
  And notification sent to purchasing
```

### AC-4: Supplier Scorecard Display

```gherkin
Scenario: View supplier scorecard
  Given supplier has ratings for Q1 2025
  When viewing supplier detail page
  Then scorecard displays:
    | Metric | Score | Trend |
    | Quality | 95 | ▲ +2% |
    | Delivery | 90 | ▼ -1% |
    | Response | 85 | ▲ +3% |
    | Overall | 91.5 | ▲ +1.5% |
  And trend chart shows last 6 periods
```

---

## Deliverables

- [ ] `supplier_quality_ratings` table migration
- [ ] Rating CRUD endpoints (5)
- [ ] SupplierRatingService with auto-calculation
- [ ] Supplier scorecard components
- [ ] Rating trend chart
- [ ] Unit + integration tests

---

**Complexity**: M (3-4 days)
**Created**: 2026-01-15
