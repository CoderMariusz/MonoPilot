# 06.26 - CCP Deviation Alerts

**Priority**: P0 (MVP)
**Story Points**: M (Medium)
**Type**: backend
**Phase**: 3 (HACCP)
**Model**: OPUS

**State:** ready
**Estimate:** M (2-3 days)
**Primary PRD:** `docs/1-BASELINE/product/modules/quality.md` (FR-QA-015, Section 18)

---

## Goal

Implement real-time alert notifications for CCP deviations. When CCP monitoring detects out-of-spec values, system sends immediate alerts (<30s) to QA Manager, Production Lead, and Director via SMS + Email + WebSocket. Includes escalation if not acknowledged within 5 minutes. Critical for immediate response to food safety issues.

---

## Food Safety Compliance

This story is **CRITICAL for food safety incident response**:

- [x] **HACCP Compliance** - Immediate notification of CCP deviations required
- [x] **FDA FSMA** - Rapid response to preventive control failures
- [x] **Alert Latency** - <30 seconds from deviation detection to alert delivery
- [x] **Escalation Required** - If no acknowledgment within 5min, escalate to Director

**Regulatory Context:**
- HACCP requires immediate corrective action on CCP deviations
- Critical deviations require production stop and notification to management
- Alert acknowledgment creates audit trail of response time
- Escalation ensures no deviation goes unaddressed

---

## MVP Scope

**MVP Includes**:
- Alert delivery on CCP deviation detection (hook from story 06.25)
- Multi-channel alerts: SMS (Twilio) + Email (SendGrid) + WebSocket (real-time)
- Alert recipients based on severity:
  - Critical: QA Manager + Production Lead + Director
  - Major: QA Manager + Production Lead
  - Minor: QA Manager
- Alert acknowledgment tracking (who, when)
- Escalation if not acknowledged within 5min (configurable)
- Alert history view (all alerts for org)
- Integration with CCP monitoring (story 06.23) and deviation handling (story 06.25)

**Deferred to Phase 3+**:
- Push notifications (mobile app)
- Phone call alerts (critical escalation)
- Alert preferences per user
- Alert sound customization

---

## User Story

As a **QA Manager**, I want to **receive immediate alerts when CCP deviations occur** so that **I can respond quickly to prevent unsafe product from being released**.

As a **Production Director**, I want to **be escalated critical deviations if not acknowledged within 5 minutes** so that **no food safety incident goes unnoticed**.

---

## Database Migration

### Migration: Create ccp_deviation_alerts table

```sql
-- Migration: YYYYMMDDHHMMSS_create_ccp_deviation_alerts.sql

CREATE TABLE ccp_deviation_alerts (
    id                      UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id                  UUID NOT NULL REFERENCES organizations(id),

    -- Deviation Reference
    deviation_id            UUID NOT NULL REFERENCES haccp_ccp_deviations(id),
    ccp_id                  UUID NOT NULL REFERENCES haccp_ccp(id),
    ccp_number              TEXT NOT NULL,

    -- Alert Details
    severity                TEXT NOT NULL
                            CHECK (severity IN ('critical', 'major', 'minor')),
    alert_message           TEXT NOT NULL,

    -- Recipients
    recipients              JSONB NOT NULL, -- [{user_id, name, role, channels: [sms, email, websocket]}]

    -- Delivery Status
    sms_sent                BOOLEAN DEFAULT false,
    sms_sent_at             TIMESTAMPTZ,
    email_sent              BOOLEAN DEFAULT false,
    email_sent_at           TIMESTAMPTZ,
    websocket_sent          BOOLEAN DEFAULT false,
    websocket_sent_at       TIMESTAMPTZ,

    -- Acknowledgment
    acknowledged            BOOLEAN DEFAULT false,
    acknowledged_by         UUID REFERENCES users(id),
    acknowledged_at         TIMESTAMPTZ,

    -- Escalation
    escalated               BOOLEAN DEFAULT false,
    escalated_at            TIMESTAMPTZ,
    escalation_recipients   JSONB, -- Additional recipients on escalation

    -- Audit
    created_at              TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE INDEX idx_ccp_alerts_org ON ccp_deviation_alerts(org_id);
CREATE INDEX idx_ccp_alerts_deviation ON ccp_deviation_alerts(deviation_id);
CREATE INDEX idx_ccp_alerts_unack ON ccp_deviation_alerts(org_id, acknowledged)
    WHERE acknowledged = false;
CREATE INDEX idx_ccp_alerts_severity ON ccp_deviation_alerts(org_id, severity);

ALTER TABLE ccp_deviation_alerts ENABLE ROW LEVEL SECURITY;

CREATE POLICY "ccp_alerts_org" ON ccp_deviation_alerts
    FOR ALL TO authenticated
    USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));
```

---

## Acceptance Criteria (Condensed)

### AC-1: Alert Creation on Deviation
```gherkin
Given CCP deviation created with severity='critical'
When deviation.status = 'open'
Then alert created with:
  - recipients: QA Manager + Production Lead + Director
  - channels: SMS + Email + WebSocket
And alert delivery initiated (<30s target)
```

### AC-2: SMS Alert Delivery
```gherkin
Given alert created for critical deviation
When SMS send initiated (Twilio API)
Then SMS sent to all recipients with SMS enabled
And SMS content: "CRITICAL CCP DEVIATION: CCP-1 Receiving Temp 10°C (limit 4°C). Immediate action required. ACK: [link]"
And sms_sent = true, sms_sent_at = now
```

### AC-3: Email Alert Delivery
```gherkin
Given alert created
When Email send initiated (SendGrid API)
Then email sent with:
  - Subject: "[CRITICAL] CCP Deviation: CCP-1"
  - Body: Deviation details, corrective action, acknowledgment link
  - Attachments: Monitoring record, CCP definition
And email_sent = true, email_sent_at = now
```

### AC-4: WebSocket Real-Time Alert
```gherkin
Given QA Manager logged in (WebSocket connected)
When alert created
Then WebSocket push notification sent
And browser shows toast notification
And audio alert plays (if enabled)
And alert appears in notification center
```

### AC-5: Alert Acknowledgment
```gherkin
Given alert not acknowledged
When QA Manager clicks [Acknowledge]
Then acknowledged = true
And acknowledged_by = QA Manager user ID
And acknowledged_at = now
And escalation timer stopped
```

### AC-6: Escalation on No Acknowledgment
```gherkin
Given alert created at 14:00
And not acknowledged by 14:05 (5min elapsed)
When escalation job runs (every 1min)
Then escalation triggered:
  - escalated = true
  - escalated_at = now
  - escalation_recipients = [Director]
  - SMS/Email sent to Director
And escalation logged in audit trail
```

### AC-7: Recipient Selection by Severity
```gherkin
Given severity='critical'
Then recipients = [QA Manager, Production Lead, Director]

Given severity='major'
Then recipients = [QA Manager, Production Lead]

Given severity='minor'
Then recipients = [QA Manager]
```

---

## Deliverables

### Database
- [ ] Migration: `ccp_deviation_alerts` table

### API Routes
- [ ] GET /api/quality/haccp/alerts (list)
- [ ] POST /api/quality/haccp/alerts/:id/acknowledge
- [ ] GET /api/quality/haccp/alerts/unacknowledged

### Service Layer
- [ ] `CCPAlertService.createAlert(deviationId)`
- [ ] `CCPAlertService.sendSMS(recipients, message)`
- [ ] `CCPAlertService.sendEmail(recipients, message)`
- [ ] `CCPAlertService.sendWebSocket(recipients, message)`
- [ ] `CCPAlertService.acknowledge(alertId, userId)`
- [ ] `CCPAlertService.escalate(alertId)`

### Background Jobs
- [ ] Escalation job (runs every 1min, checks alerts > 5min unacknowledged)

### Frontend
- [ ] Alert notification center (WebSocket listener)
- [ ] Alert history page
- [ ] Acknowledge alert dialog
- [ ] Audio alert player

---

## Definition of Done

- [ ] Alert table created
- [ ] SMS delivery works (Twilio integration)
- [ ] Email delivery works (SendGrid integration)
- [ ] WebSocket delivery works (real-time push)
- [ ] Acknowledgment tracking works
- [ ] Escalation job works (5min timer)
- [ ] Recipient selection by severity works
- [ ] Tests passing (unit + integration)
- [ ] Alert latency < 30s (measured)

---

**Document Status**: Ready for Implementation
**Created**: 2025-01-15
**Complexity**: M (Medium)
**Phase**: 3 (HACCP)
