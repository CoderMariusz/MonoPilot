# 06.16 - NCR Verification & Close

**Priority**: P0 (MVP)
**Story Points**: M (Medium)
**Type**: fullstack (backend + frontend)
**Phase**: 2B (NCR Lifecycle)
**Model**: OPUS

**State:** ready
**Estimate:** M (2-3 days)
**Primary PRD:** `docs/1-BASELINE/product/modules/quality.md` (FR-QA-009, Section 8)
**Architecture:** `docs/1-BASELINE/architecture/modules/quality.md`

---

## Goal

Implement **NCR Verification and Close** workflow - the final stage of the NCR lifecycle. This story enables QA Managers to verify that all corrective actions have been completed effectively, document lessons learned, close the NCR permanently (immutable after close), generate a final NCR summary report (PDF), and handle reopening if verification fails.

**NCR Lifecycle Context:**
```
Draft -> Open -> Investigation -> Root Cause (06.14) -> Corrective Action (06.15) -> Verification (THIS STORY) -> Closed
                                                                                     |
                                                                                     +-> Reopened (if verification fails)
```

---

## Food Safety Compliance

This story is **critical for food safety compliance**:

- [x] **FDA 21 CFR Part 11** - Verifier signature with timestamp, immutable after close
- [x] **ISO 9001/22000** - Verification of corrective action effectiveness required
- [x] **HACCP Compliance** - NCR closure completes deviation handling cycle
- [x] **Audit Trail Required** - All verification actions logged with reason
- [x] **Lessons Learned** - Knowledge capture for continuous improvement

**Regulatory Context:**
- FDA FSMA requires documented verification of corrective actions
- Verification must confirm effectiveness, not just completion
- Closed NCRs are immutable (no edits after closure)
- Lessons learned contribute to CAPA and preventive controls
- Records retained for minimum 10 years

---

## MVP Scope

This story implements **NCR Verification & Close** functionality as the final step of the NCR workflow.

**MVP Includes**:
- `ncr_verifications` table for verification records
- `ncr_verification_checklist` table for checklist items
- `ncr_lessons_learned` table for lessons documentation
- Verification checklist (all actions completed, effectiveness confirmed)
- Verification method selection (Audit/Inspection/Data review/Process observation)
- Verification result (Pass/Fail/Partial)
- Verifier signature (QA Manager only)
- Close NCR workflow (final state, immutable after close)
- Reopen logic (if verification fails or partial)
- Lessons learned documentation
- Final NCR report generation (PDF summary)
- Permission enforcement (QA_MANAGER only for close)

**Deferred to Phase 3+**:
- E-signature with FDA 21 CFR Part 11 full compliance
- Automated effectiveness monitoring (30/60/90 day checks)
- CAPA auto-creation from lessons learned
- NCR analytics integration
- Email notifications for closure
- Recurrence prevention validation

---

## User Story

As a **QA Manager**, I want to **verify that all corrective actions for an NCR have been completed effectively, document lessons learned, and close the NCR with a final report** so that **we have a complete audit trail of the non-conformance resolution and can prevent recurrence**.

As a **Quality Director**, I want to **review closed NCRs with their verification records and lessons learned** so that **I can ensure quality issues are properly resolved and identify improvement opportunities**.

---

## Scope

**In scope (this story)**
- `ncr_verifications` table for verification records
- `ncr_verification_checklist` table for verification checklist items
- `ncr_lessons_learned` table for lessons learned
- POST /api/quality/ncrs/:id/verify (submit verification)
- POST /api/quality/ncrs/:id/close (close NCR after verification)
- POST /api/quality/ncrs/:id/reopen (reopen if verification fails)
- GET /api/quality/ncrs/:id/report (generate NCR summary PDF)
- GET /api/quality/ncrs/:id/verification (get verification details)
- Verification modal with checklist, method, result, signature
- Close NCR confirmation (final action, cannot undo)
- Reopen NCR workflow (reason required)
- Lessons learned form
- NCR report preview and PDF generation
- Status transition: corrective_action -> verification -> closed/reopened

**Out of scope (this story)**
- E-signature vendor integration (Phase 3)
- Automated 30/60/90 day effectiveness checks (Phase 3)
- CAPA auto-creation from NCR (story 06.31)
- NCR recurrence detection (Phase 4)
- Email notifications (story 06.17)
- NCR analytics dashboard (story 06.39)

---

## Dependencies

### Cross-Epic Dependencies

| Dependency | Story/Epic | Type | What It Provides | Status |
|------------|------------|------|------------------|--------|
| 01.1 | Org Context + RLS | HARD | organizations, users, roles tables | Ready |
| 02.1 | Products CRUD | SOFT | products table for NCR product reference | Ready |

### Within Epic Dependencies

| Dependency | Story | Type | What It Provides |
|------------|-------|------|------------------|
| 06.9 | Basic NCR Creation | HARD | ncr_reports table, NCR structure |
| 06.13 | NCR Workflow | HARD | Workflow states, status transitions |
| 06.14 | NCR Root Cause Analysis | HARD | root_cause field populated |
| 06.15 | NCR Corrective Action | HARD | All corrective actions completed |

### Provides To (Downstream)

| Story | What This Provides |
|-------|-------------------|
| 06.31 | CAPA Creation - lessons_learned as CAPA input |
| 06.37 | Quality Dashboard - NCR closure metrics |
| 06.38 | Audit Trail Reports - verification records |
| 06.39 | Quality Analytics - NCR resolution time data |

---

## Database Migration

### Migration: Create NCR Verification Tables

```sql
-- Migration: YYYYMMDDHHMMSS_create_ncr_verification_tables.sql

-- =============================================================================
-- NCR Verifications Table
-- =============================================================================
-- Verification record for NCR corrective action effectiveness

CREATE TABLE ncr_verifications (
    -- Identity
    id                      UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id                  UUID NOT NULL REFERENCES organizations(id),
    ncr_id                  UUID NOT NULL REFERENCES ncr_reports(id) ON DELETE CASCADE,

    -- Verification Details
    verification_number     TEXT NOT NULL,
    verification_date       DATE NOT NULL DEFAULT CURRENT_DATE,

    -- Verification Method
    verification_method     TEXT NOT NULL
                            CHECK (verification_method IN (
                                'audit',           -- Internal/external audit
                                'inspection',      -- Physical inspection
                                'data_review',     -- Data analysis review
                                'process_observation', -- Observe process in action
                                'document_review', -- Review updated docs/SOPs
                                'testing',         -- Repeat testing
                                'other'
                            )),
    verification_method_notes TEXT,

    -- Verification Result
    result                  TEXT NOT NULL
                            CHECK (result IN ('pass', 'fail', 'partial')),
    result_notes            TEXT NOT NULL,

    -- Evidence
    evidence_description    TEXT,
    evidence_attachments    JSONB DEFAULT '[]'::jsonb,  -- [{filename, url, type}]

    -- Effectiveness Confirmation
    effectiveness_confirmed BOOLEAN NOT NULL DEFAULT false,
    effectiveness_notes     TEXT,

    -- Recurrence Check
    recurrence_checked      BOOLEAN NOT NULL DEFAULT false,
    recurrence_notes        TEXT,

    -- Verifier Signature
    verified_by             UUID NOT NULL REFERENCES users(id),
    verified_at             TIMESTAMPTZ NOT NULL DEFAULT now(),
    verifier_signature      TEXT,  -- Digital signature data (Phase 3: E-signature)
    verifier_title          TEXT,  -- e.g., "QA Manager"

    -- Audit
    created_at              TIMESTAMPTZ NOT NULL DEFAULT now(),
    created_by              UUID REFERENCES users(id),
    updated_at              TIMESTAMPTZ NOT NULL DEFAULT now(),
    updated_by              UUID REFERENCES users(id),

    -- Constraints
    CONSTRAINT uq_verification_number UNIQUE (org_id, verification_number)
);

-- =============================================================================
-- NCR Verification Checklist Table
-- =============================================================================
-- Pre-defined checklist items for verification

CREATE TABLE ncr_verification_checklist (
    -- Identity
    id                      UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id                  UUID NOT NULL REFERENCES organizations(id),
    verification_id         UUID NOT NULL REFERENCES ncr_verifications(id) ON DELETE CASCADE,

    -- Checklist Item
    sequence                INTEGER NOT NULL DEFAULT 1,
    item_description        TEXT NOT NULL,
    item_type               TEXT NOT NULL DEFAULT 'required'
                            CHECK (item_type IN ('required', 'optional', 'conditional')),

    -- Status
    is_checked              BOOLEAN NOT NULL DEFAULT false,
    checked_by              UUID REFERENCES users(id),
    checked_at              TIMESTAMPTZ,
    notes                   TEXT,

    -- Audit
    created_at              TIMESTAMPTZ NOT NULL DEFAULT now(),
    updated_at              TIMESTAMPTZ NOT NULL DEFAULT now(),

    -- Constraints
    CONSTRAINT uq_checklist_item UNIQUE (verification_id, sequence)
);

-- =============================================================================
-- NCR Lessons Learned Table
-- =============================================================================
-- Lessons learned documentation for knowledge management

CREATE TABLE ncr_lessons_learned (
    -- Identity
    id                      UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id                  UUID NOT NULL REFERENCES organizations(id),
    ncr_id                  UUID NOT NULL REFERENCES ncr_reports(id) ON DELETE CASCADE,

    -- Lesson Details
    lesson_number           TEXT NOT NULL,
    title                   TEXT NOT NULL,
    description             TEXT NOT NULL,

    -- Classification
    category                TEXT NOT NULL
                            CHECK (category IN (
                                'process_improvement',
                                'training_need',
                                'equipment_issue',
                                'supplier_issue',
                                'documentation_gap',
                                'communication_gap',
                                'design_issue',
                                'other'
                            )),

    -- Impact
    impact_area             TEXT[]  DEFAULT '{}',  -- ['quality', 'safety', 'cost', 'delivery']
    severity                TEXT NOT NULL
                            CHECK (severity IN ('low', 'medium', 'high')),

    -- Recommendations
    recommendations         TEXT NOT NULL,
    preventive_actions      TEXT,

    -- Knowledge Sharing
    shared_with             TEXT[],  -- ['production', 'quality', 'all_departments']
    shared_date             DATE,

    -- CAPA Linkage (if lesson triggers CAPA)
    capa_id                 UUID,  -- FK to capa_records (story 06.31)
    capa_recommended        BOOLEAN DEFAULT false,

    -- Approval
    status                  TEXT NOT NULL DEFAULT 'draft'
                            CHECK (status IN ('draft', 'approved', 'archived')),
    approved_by             UUID REFERENCES users(id),
    approved_at             TIMESTAMPTZ,

    -- Audit
    created_at              TIMESTAMPTZ NOT NULL DEFAULT now(),
    created_by              UUID REFERENCES users(id),
    updated_at              TIMESTAMPTZ NOT NULL DEFAULT now(),
    updated_by              UUID REFERENCES users(id),

    -- Constraints
    CONSTRAINT uq_lesson_number UNIQUE (org_id, lesson_number)
);

-- =============================================================================
-- Indexes for Performance
-- =============================================================================

-- ncr_verifications indexes
CREATE INDEX idx_verification_org_ncr ON ncr_verifications(org_id, ncr_id);
CREATE INDEX idx_verification_result ON ncr_verifications(org_id, result);
CREATE INDEX idx_verification_date ON ncr_verifications(org_id, verification_date DESC);
CREATE INDEX idx_verification_verified_by ON ncr_verifications(verified_by);

-- ncr_verification_checklist indexes
CREATE INDEX idx_checklist_verification ON ncr_verification_checklist(verification_id);
CREATE INDEX idx_checklist_status ON ncr_verification_checklist(verification_id, is_checked);

-- ncr_lessons_learned indexes
CREATE INDEX idx_lessons_org_ncr ON ncr_lessons_learned(org_id, ncr_id);
CREATE INDEX idx_lessons_category ON ncr_lessons_learned(org_id, category);
CREATE INDEX idx_lessons_status ON ncr_lessons_learned(org_id, status);
CREATE INDEX idx_lessons_severity ON ncr_lessons_learned(org_id, severity);

-- =============================================================================
-- Verification Number Sequence
-- =============================================================================

CREATE TABLE verification_number_sequences (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    year INTEGER NOT NULL,
    current_value BIGINT NOT NULL DEFAULT 0,
    updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
    UNIQUE(org_id, year)
);

-- Function to generate verification number (VER-YYYY-NNNNN)
CREATE OR REPLACE FUNCTION generate_verification_number(p_org_id UUID)
RETURNS TEXT AS $$
DECLARE
    v_year INTEGER;
    v_next_val BIGINT;
    v_number TEXT;
BEGIN
    v_year := EXTRACT(YEAR FROM CURRENT_DATE);

    INSERT INTO verification_number_sequences (org_id, year, current_value)
    VALUES (p_org_id, v_year, 1)
    ON CONFLICT (org_id, year)
    DO UPDATE SET
        current_value = verification_number_sequences.current_value + 1,
        updated_at = NOW()
    RETURNING current_value INTO v_next_val;

    v_number := 'VER-' || v_year::TEXT || '-' || LPAD(v_next_val::TEXT, 5, '0');

    RETURN v_number;
END;
$$ LANGUAGE plpgsql;

-- =============================================================================
-- Lesson Number Sequence
-- =============================================================================

CREATE TABLE lesson_number_sequences (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    year INTEGER NOT NULL,
    current_value BIGINT NOT NULL DEFAULT 0,
    updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
    UNIQUE(org_id, year)
);

-- Function to generate lesson number (LL-YYYY-NNNNN)
CREATE OR REPLACE FUNCTION generate_lesson_number(p_org_id UUID)
RETURNS TEXT AS $$
DECLARE
    v_year INTEGER;
    v_next_val BIGINT;
    v_number TEXT;
BEGIN
    v_year := EXTRACT(YEAR FROM CURRENT_DATE);

    INSERT INTO lesson_number_sequences (org_id, year, current_value)
    VALUES (p_org_id, v_year, 1)
    ON CONFLICT (org_id, year)
    DO UPDATE SET
        current_value = lesson_number_sequences.current_value + 1,
        updated_at = NOW()
    RETURNING current_value INTO v_next_val;

    v_number := 'LL-' || v_year::TEXT || '-' || LPAD(v_next_val::TEXT, 5, '0');

    RETURN v_number;
END;
$$ LANGUAGE plpgsql;

-- =============================================================================
-- Update ncr_reports for verification and close
-- =============================================================================

ALTER TABLE ncr_reports
ADD COLUMN IF NOT EXISTS verification_id UUID REFERENCES ncr_verifications(id),
ADD COLUMN IF NOT EXISTS lessons_learned_count INTEGER DEFAULT 0,
ADD COLUMN IF NOT EXISTS reopen_count INTEGER DEFAULT 0,
ADD COLUMN IF NOT EXISTS last_reopened_at TIMESTAMPTZ,
ADD COLUMN IF NOT EXISTS last_reopened_by UUID REFERENCES users(id),
ADD COLUMN IF NOT EXISTS reopen_reason TEXT,
ADD COLUMN IF NOT EXISTS final_report_generated BOOLEAN DEFAULT false,
ADD COLUMN IF NOT EXISTS final_report_url TEXT;

-- =============================================================================
-- RLS Policies
-- =============================================================================

ALTER TABLE ncr_verifications ENABLE ROW LEVEL SECURITY;

CREATE POLICY "verification_select" ON ncr_verifications
    FOR SELECT USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

CREATE POLICY "verification_insert" ON ncr_verifications
    FOR INSERT WITH CHECK (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

CREATE POLICY "verification_update" ON ncr_verifications
    FOR UPDATE USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

-- Verifications cannot be deleted after NCR is closed
CREATE POLICY "verification_delete" ON ncr_verifications
    FOR DELETE USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
        AND NOT EXISTS (
            SELECT 1 FROM ncr_reports
            WHERE id = ncr_verifications.ncr_id
            AND status = 'closed'
        )
    );

ALTER TABLE ncr_verification_checklist ENABLE ROW LEVEL SECURITY;

CREATE POLICY "checklist_select" ON ncr_verification_checklist
    FOR SELECT USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

CREATE POLICY "checklist_insert" ON ncr_verification_checklist
    FOR INSERT WITH CHECK (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

CREATE POLICY "checklist_update" ON ncr_verification_checklist
    FOR UPDATE USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

ALTER TABLE ncr_lessons_learned ENABLE ROW LEVEL SECURITY;

CREATE POLICY "lessons_select" ON ncr_lessons_learned
    FOR SELECT USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

CREATE POLICY "lessons_insert" ON ncr_lessons_learned
    FOR INSERT WITH CHECK (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

CREATE POLICY "lessons_update" ON ncr_lessons_learned
    FOR UPDATE USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

ALTER TABLE verification_number_sequences ENABLE ROW LEVEL SECURITY;

CREATE POLICY "ver_seq_org" ON verification_number_sequences
    FOR ALL TO authenticated
    USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

ALTER TABLE lesson_number_sequences ENABLE ROW LEVEL SECURITY;

CREATE POLICY "lesson_seq_org" ON lesson_number_sequences
    FOR ALL TO authenticated
    USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

-- =============================================================================
-- Triggers for updated_at
-- =============================================================================

CREATE TRIGGER update_ncr_verifications_updated_at
    BEFORE UPDATE ON ncr_verifications
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_ncr_verification_checklist_updated_at
    BEFORE UPDATE ON ncr_verification_checklist
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_ncr_lessons_learned_updated_at
    BEFORE UPDATE ON ncr_lessons_learned
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- =============================================================================
-- Comments
-- =============================================================================

COMMENT ON TABLE ncr_verifications IS 'NCR verification records - confirms corrective action effectiveness';
COMMENT ON TABLE ncr_verification_checklist IS 'Verification checklist items for structured verification';
COMMENT ON TABLE ncr_lessons_learned IS 'Lessons learned from NCR resolution for knowledge management';
COMMENT ON COLUMN ncr_verifications.result IS 'pass=all actions effective, fail=actions not effective, partial=some effective';
COMMENT ON COLUMN ncr_lessons_learned.capa_recommended IS 'If true, suggests CAPA creation from this lesson';
```

---

## Acceptance Criteria (Given/When/Then)

### AC-1: Verification Tables Creation

```gherkin
Scenario: ncr_verifications table exists with all required columns
  Given database migration runs
  When schema is inspected
  Then ncr_verifications table has all columns from schema
  And ncr_verification_checklist table exists
  And ncr_lessons_learned table exists
  And UNIQUE constraints exist on number fields
  And FK constraints exist for all references
  And RLS policies enforce org isolation
```

### AC-2: Verification Number Auto-Generation

```gherkin
Scenario: Generate verification number with year-based format
  Given organization exists
  When first verification created in 2025
  Then verification_number format is 'VER-2025-00001'
  And next verification gets 'VER-2025-00002'
  And year resets sequence (first 2026 = 'VER-2026-00001')
```

### AC-3: Pre-Verification Checklist Display

```gherkin
Scenario: Display verification checklist
  Given NCR NCR-2025-00001 with status = 'corrective_action'
  And all corrective actions marked as completed
  When QA Manager clicks [Verify & Close]
  Then verification modal opens with checklist:
    | # | Item | Type | Status |
    | 1 | All corrective actions completed | Required | Pending |
    | 2 | Root cause addressed | Required | Pending |
    | 3 | Effectiveness confirmed | Required | Pending |
    | 4 | Documentation updated | Required | Pending |
    | 5 | Recurrence prevention in place | Required | Pending |
    | 6 | Training completed (if required) | Optional | Pending |
    | 7 | Stakeholders notified | Optional | Pending |
  And all required items must be checked to proceed

Scenario: Cannot proceed without required checklist items
  Given verification modal open
  And some required checklist items unchecked
  When user clicks [Submit Verification]
  Then error: "All required checklist items must be completed"
  And unchecked required items highlighted in red
```

### AC-4: Verification Method Selection

```gherkin
Scenario: Select verification method
  Given verification modal open
  When user selects verification method dropdown
  Then options displayed:
    | Method | Description |
    | Audit | Internal or external audit verification |
    | Inspection | Physical inspection of process/product |
    | Data Review | Analysis of quality data and trends |
    | Process Observation | Observe process execution |
    | Document Review | Review updated documents/SOPs |
    | Testing | Repeat testing/verification tests |
    | Other | Other verification method |
  And user can add method notes for clarification

Scenario: Verification method required
  Given verification modal open
  When user submits without selecting method
  Then error: "Verification method is required"
```

### AC-5: Verification Result Recording

```gherkin
Scenario: Record verification result - PASS
  Given verification modal open
  And all checklist items checked
  And verification method selected
  When user selects result = 'Pass'
  Then result_notes field appears (optional for pass)
  And effectiveness_confirmed checkbox enabled
  And recurrence_checked checkbox enabled

Scenario: Record verification result - FAIL
  Given verification modal open
  When user selects result = 'Fail'
  Then result_notes field appears (REQUIRED, min 50 characters)
  And prompt: "Failed verification will REOPEN the NCR"
  And warning displayed: "NCR will return to Corrective Action step"

Scenario: Record verification result - PARTIAL
  Given verification modal open
  When user selects result = 'Partial'
  Then result_notes field appears (REQUIRED, min 50 characters)
  And partial_reason field appears
  And option to close or reopen displayed:
    | Option | Description |
    | Close with conditions | Close NCR with documented conditions |
    | Reopen for additional actions | Return to Corrective Action |
```

### AC-6: Verifier Signature

```gherkin
Scenario: Verifier signature required
  Given verification form completed
  And result selected
  When user clicks [Submit Verification]
  Then signature confirmation modal appears:
    | Field | Value |
    | Verifier Name | [Current User Name] |
    | Verifier Title | [Input: e.g., "QA Manager"] |
    | Verification Date | [Today] |
    | Signature | [Type name to sign] |
    | Statement | "I verify that the corrective actions for this NCR have been reviewed and the result recorded above is accurate." |
  And user types name to confirm signature
  Then verification submitted with signature data

Scenario: QA Manager role required for verification
  Given current user has QA_INSPECTOR role (not QA_MANAGER)
  When viewing NCR in corrective_action status
  Then [Verify & Close] button disabled
  And tooltip: "Only QA Manager can verify and close NCRs"
```

### AC-7: Close NCR - Pass Result

```gherkin
Scenario: Close NCR after successful verification
  Given verification submitted with result = 'Pass'
  And effectiveness_confirmed = true
  When user confirms closure
  Then ncr_reports.status updated to 'closed'
  And ncr_reports.closed_at = now
  And ncr_reports.closed_by = current user
  And ncr_reports.verification_id = verification.id
  And success toast: "NCR NCR-2025-00001 closed successfully"
  And NCR becomes immutable (no edits allowed)

Scenario: Closed NCR is immutable
  Given NCR with status = 'closed'
  When any user attempts to update any field
  Then 403 Forbidden returned
  And message: "Closed NCRs cannot be modified"
  And only read access allowed
```

### AC-8: Reopen NCR - Fail Result

```gherkin
Scenario: Reopen NCR after failed verification
  Given verification submitted with result = 'Fail'
  When user confirms reopen
  Then ncr_reports.status updated to 'reopened'
  And ncr_reports.reopen_count incremented
  And ncr_reports.last_reopened_at = now
  And ncr_reports.last_reopened_by = current user
  And ncr_reports.reopen_reason = result_notes
  And warning toast: "NCR reopened. Return to Corrective Action."
  And NCR returns to corrective_action workflow step
  And new corrective actions can be added

Scenario: Reopen requires reason
  Given verification result = 'Fail'
  When user confirms reopen without notes
  Then error: "Reopen reason required (min 50 characters)"
```

### AC-9: Manual Reopen from Closed NCR

```gherkin
Scenario: Reopen closed NCR (exceptional case)
  Given NCR with status = 'closed'
  And current user is QUALITY_DIRECTOR role
  When user clicks [...] menu > [Reopen NCR]
  Then reopen confirmation dialog appears:
    | Field | Required |
    | Reopen Reason | Yes (min 100 characters) |
    | Approval Reference | Yes (e.g., "QD-2025-001") |
  And warning: "Reopening a closed NCR is an exceptional action and will be logged"
  And user fills form and confirms
  Then ncr_reports.status updated to 'reopened'
  And audit log records exceptional reopen with director approval
  And NCR returns to corrective_action step

Scenario: QA Manager cannot reopen closed NCR
  Given NCR with status = 'closed'
  And current user has QA_MANAGER role (not QUALITY_DIRECTOR)
  Then [Reopen NCR] option not available
  And message: "Only Quality Director can reopen closed NCRs"
```

### AC-10: Lessons Learned Documentation

```gherkin
Scenario: Add lesson learned to NCR
  Given NCR in verification or closed status
  When user clicks [Add Lesson Learned]
  Then lesson learned form appears:
    | Field | Required | Description |
    | Title | Yes | Brief lesson title |
    | Description | Yes | Detailed lesson description |
    | Category | Yes | Dropdown (process_improvement, training_need, etc.) |
    | Severity | Yes | Low/Medium/High impact |
    | Impact Areas | No | Multi-select (quality, safety, cost, delivery) |
    | Recommendations | Yes | What should be done |
    | Preventive Actions | No | Specific preventive actions |
    | Recommend CAPA | No | Checkbox to suggest CAPA creation |
  And user fills form
  Then lesson_number auto-generated: 'LL-2025-00001'
  And lesson linked to NCR
  And ncr_reports.lessons_learned_count incremented

Scenario: View lessons learned for NCR
  Given NCR with 2 lessons learned
  When viewing NCR detail page
  Then Lessons Learned tab displays:
    | # | Lesson | Title | Category | Severity | Status |
    | LL-2025-00001 | Lesson 1 title | Process Improvement | High | Approved |
    | LL-2025-00002 | Lesson 2 title | Training Need | Medium | Draft |
  And clicking row shows full lesson details

Scenario: Approve lesson learned
  Given lesson with status = 'draft'
  And current user has QA_MANAGER role
  When user clicks [Approve]
  Then status updated to 'approved'
  And approved_by = current user
  And approved_at = now
```

### AC-11: NCR Final Report Generation

```gherkin
Scenario: Generate NCR summary report
  Given NCR with status = 'closed'
  When user clicks [Generate Report]
  Then report generation initiates
  And loading indicator displayed
  And report generated within 5 seconds

Scenario: NCR report content
  Given NCR report generated
  Then PDF contains sections:
    | Section | Content |
    | Header | NCR Number, Title, Severity, Status, Dates |
    | Detection | Detection point, Detected by, Source reference |
    | Description | Full NCR description and category |
    | Investigation | Investigation summary and findings |
    | Root Cause | Root cause analysis (5-Why results if available) |
    | Corrective Actions | All actions with status and completion dates |
    | Verification | Verification method, result, verifier signature |
    | Lessons Learned | All documented lessons |
    | Timeline | Complete history of status changes |
    | Signatures | Detector, Investigator, Verifier, Closer |
  And report saved to NCR record
  And ncr_reports.final_report_url updated

Scenario: Preview NCR report
  Given NCR in any status
  When user clicks [Preview Report]
  Then report preview modal opens (read-only)
  And user can [Download PDF] or [Close]

Scenario: Report for open NCR
  Given NCR with status != 'closed'
  When user clicks [Preview Report]
  Then report generated with "DRAFT - NOT FINAL" watermark
  And some sections marked as "Pending"
```

### AC-12: NCR Detail Page - Verification Tab

```gherkin
Scenario: View verification details
  Given NCR with completed verification
  When viewing NCR detail page > Verification tab
  Then verification details displayed:
    | Section | Content |
    | Verification Number | VER-2025-00001 |
    | Verification Date | 2025-12-20 |
    | Method | Audit |
    | Result | Pass (green badge) |
    | Result Notes | Full text |
    | Effectiveness | Confirmed (check icon) |
    | Recurrence Check | Done (check icon) |
    | Verifier | John Smith, QA Manager |
    | Verified At | 2025-12-20 14:35 |
  And checklist items displayed with status

Scenario: View verification for open NCR
  Given NCR with status = 'corrective_action'
  When viewing NCR detail page > Verification tab
  Then message: "Verification pending. Complete all corrective actions first."
  And [Verify & Close] button displayed (if authorized)
```

### AC-13: Status Transitions Validation

```gherkin
Scenario: Cannot verify without completed corrective actions
  Given NCR with status = 'corrective_action'
  And some corrective actions status != 'completed'
  When QA Manager clicks [Verify & Close]
  Then error: "Cannot verify. Complete all corrective actions first."
  And list of incomplete actions displayed

Scenario: Cannot close without root cause
  Given NCR with root_cause = NULL
  When attempting to verify
  Then error: "Root cause analysis required before verification"

Scenario: Status transition on verification pass
  Given NCR with status = 'corrective_action'
  When verification submitted with result = 'Pass'
  And closure confirmed
  Then status transitions:
    | From | To | Trigger |
    | corrective_action | verification | Verification submitted |
    | verification | closed | Closure confirmed |

Scenario: Status transition on verification fail
  Given NCR with status = 'corrective_action'
  When verification submitted with result = 'Fail'
  Then status transitions:
    | From | To | Trigger |
    | corrective_action | verification | Verification submitted |
    | verification | reopened | Fail confirmed |
    | reopened | corrective_action | Auto-transition |
```

### AC-14: Permission Enforcement

```gherkin
Scenario: Viewer can view but not verify
  Given user with VIEWER role
  When viewing NCR detail
  Then can view verification details (if exists)
  And [Verify & Close] button hidden
  And [Add Lesson] button hidden

Scenario: QA Inspector can add lessons but not verify
  Given user with QA_INSPECTOR role
  When viewing NCR in corrective_action status
  Then [Verify & Close] button disabled/hidden
  And [Add Lesson Learned] button visible
  And can create draft lessons (not approve)

Scenario: QA Manager can verify and close
  Given user with QA_MANAGER role
  Then can verify and close NCRs
  And can approve lessons learned
  And cannot reopen closed NCRs

Scenario: Quality Director full access
  Given user with QUALITY_DIRECTOR role
  Then can verify and close NCRs
  And can reopen closed NCRs (exceptional)
  And can approve all lessons
```

### AC-15: Audit Trail

```gherkin
Scenario: Verification actions logged
  Given verification submitted
  Then quality_audit_log entry created:
    | Field | Value |
    | entity_type | ncr_verification |
    | entity_id | verification.id |
    | action | create |
    | user_id | current user |
    | new_value | { result, method, checklist_status } |

Scenario: Close action logged
  Given NCR closed
  Then quality_audit_log entry created:
    | Field | Value |
    | entity_type | ncr_report |
    | entity_id | ncr.id |
    | action | close |
    | user_id | current user |
    | new_value | { status: 'closed', verification_id, closed_at } |

Scenario: Reopen action logged (exceptional)
  Given closed NCR reopened by Quality Director
  Then quality_audit_log entry created:
    | Field | Value |
    | entity_type | ncr_report |
    | entity_id | ncr.id |
    | action | reopen_exceptional |
    | user_id | current user |
    | new_value | { status: 'reopened', reopen_reason, approval_reference } |
```

### AC-16: RLS Policy Enforcement

```gherkin
Scenario: Org isolation on verification
  Given User A from Org A and User B from Org B
  And verifications exist in both orgs
  When User A requests verification data
  Then only Org A verifications returned

Scenario: Cannot view verification from different org
  Given verification belongs to Org B
  When User A (Org A) attempts access
  Then 404 Not Found returned
```

### AC-17: Performance Requirements

```gherkin
Scenario: Verification submission performance
  Given valid verification data
  When submitting verification
  Then operation completes < 500ms

Scenario: NCR report generation performance
  Given NCR with full data (investigation, root cause, actions, verification)
  When generating PDF report
  Then report generated < 5 seconds

Scenario: Lessons learned list performance
  Given 100 lessons learned in organization
  When listing lessons
  Then response time < 500ms
```

---

## Implementation Notes

### API Endpoints

```typescript
// =============================================================================
// NCR Verification Endpoints
// =============================================================================

// GET /api/quality/ncrs/:id/verification
// Get verification details for NCR
interface VerificationDetailResponse {
  verification: NCRVerification | null;
  checklist: VerificationChecklistItem[];
  can_verify: boolean;
  pending_actions: number;
  permissions: {
    can_verify: boolean;
    can_close: boolean;
    can_reopen: boolean;
  };
}

interface NCRVerification {
  id: string;
  org_id: string;
  ncr_id: string;
  verification_number: string;
  verification_date: string;
  verification_method: string;
  verification_method_notes?: string;
  result: 'pass' | 'fail' | 'partial';
  result_notes: string;
  evidence_description?: string;
  evidence_attachments: AttachmentInfo[];
  effectiveness_confirmed: boolean;
  effectiveness_notes?: string;
  recurrence_checked: boolean;
  recurrence_notes?: string;
  verified_by: string;
  verified_by_name: string;
  verified_at: string;
  verifier_title?: string;
  created_at: string;
}

interface VerificationChecklistItem {
  id: string;
  sequence: number;
  item_description: string;
  item_type: 'required' | 'optional' | 'conditional';
  is_checked: boolean;
  checked_by?: string;
  checked_by_name?: string;
  checked_at?: string;
  notes?: string;
}

// POST /api/quality/ncrs/:id/verify
// Submit verification for NCR
interface VerifyNCRRequest {
  verification_method: string;
  verification_method_notes?: string;
  result: 'pass' | 'fail' | 'partial';
  result_notes: string;
  evidence_description?: string;
  evidence_attachments?: AttachmentInfo[];
  effectiveness_confirmed: boolean;
  effectiveness_notes?: string;
  recurrence_checked: boolean;
  recurrence_notes?: string;
  checklist: {
    sequence: number;
    is_checked: boolean;
    notes?: string;
  }[];
  verifier_title: string;
  signature_confirmation: string;  // User types name to confirm
}

interface VerifyNCRResponse {
  verification: NCRVerification;
  ncr_status: string;
  next_action: 'close' | 'reopen' | 'confirm_partial';
}

// POST /api/quality/ncrs/:id/close
// Close NCR after successful verification
interface CloseNCRRequest {
  verification_id: string;
  closure_notes?: string;
  final_remarks?: string;
}

interface CloseNCRResponse {
  ncr: NCRReport;
  verification: NCRVerification;
  report_url?: string;  // If auto-generated
}

// POST /api/quality/ncrs/:id/reopen
// Reopen NCR (after verification fail or exceptional)
interface ReopenNCRRequest {
  reopen_reason: string;
  approval_reference?: string;  // Required for closed NCR reopen
  is_exceptional?: boolean;     // True if reopening closed NCR
}

interface ReopenNCRResponse {
  ncr: NCRReport;
  reopen_count: number;
}

// GET /api/quality/ncrs/:id/report
// Generate NCR summary report
interface NCRReportRequest {
  format?: 'pdf' | 'preview';
}

interface NCRReportResponse {
  report_url?: string;      // For PDF download
  preview_html?: string;    // For preview
  generated_at: string;
}

// =============================================================================
// Lessons Learned Endpoints
// =============================================================================

// GET /api/quality/ncrs/:id/lessons
// List lessons learned for NCR
interface LessonsListResponse {
  lessons: LessonLearned[];
  count: number;
}

interface LessonLearned {
  id: string;
  org_id: string;
  ncr_id: string;
  lesson_number: string;
  title: string;
  description: string;
  category: string;
  severity: 'low' | 'medium' | 'high';
  impact_area: string[];
  recommendations: string;
  preventive_actions?: string;
  shared_with?: string[];
  shared_date?: string;
  capa_recommended: boolean;
  capa_id?: string;
  status: 'draft' | 'approved' | 'archived';
  approved_by?: string;
  approved_at?: string;
  created_at: string;
  created_by: string;
}

// POST /api/quality/ncrs/:id/lessons
// Create lesson learned
interface CreateLessonRequest {
  title: string;
  description: string;
  category: string;
  severity: 'low' | 'medium' | 'high';
  impact_area?: string[];
  recommendations: string;
  preventive_actions?: string;
  capa_recommended?: boolean;
}

interface CreateLessonResponse {
  lesson: LessonLearned;
}

// PUT /api/quality/lessons/:id
// Update lesson learned
interface UpdateLessonRequest {
  title?: string;
  description?: string;
  category?: string;
  severity?: string;
  impact_area?: string[];
  recommendations?: string;
  preventive_actions?: string;
  capa_recommended?: boolean;
}

// POST /api/quality/lessons/:id/approve
// Approve lesson learned (QA Manager)
interface ApproveLessonResponse {
  lesson: LessonLearned;
}

// POST /api/quality/lessons/:id/share
// Share lesson with departments
interface ShareLessonRequest {
  shared_with: string[];  // ['production', 'quality', 'all_departments']
}
```

### Validation Schemas (Zod)

```typescript
import { z } from 'zod';

// Verification method enum
export const verificationMethodEnum = z.enum([
  'audit',
  'inspection',
  'data_review',
  'process_observation',
  'document_review',
  'testing',
  'other'
]);

// Verification result enum
export const verificationResultEnum = z.enum(['pass', 'fail', 'partial']);

// Lesson category enum
export const lessonCategoryEnum = z.enum([
  'process_improvement',
  'training_need',
  'equipment_issue',
  'supplier_issue',
  'documentation_gap',
  'communication_gap',
  'design_issue',
  'other'
]);

// Lesson severity enum
export const lessonSeverityEnum = z.enum(['low', 'medium', 'high']);

// Checklist item schema
export const checklistItemSchema = z.object({
  sequence: z.number().int().positive(),
  is_checked: z.boolean(),
  notes: z.string().max(500).optional(),
});

// Verify NCR schema
export const verifyNCRSchema = z.object({
  verification_method: verificationMethodEnum,
  verification_method_notes: z.string().max(500).optional(),
  result: verificationResultEnum,
  result_notes: z.string()
    .min(10, 'Result notes must be at least 10 characters')
    .max(2000, 'Result notes must not exceed 2000 characters'),
  evidence_description: z.string().max(1000).optional(),
  evidence_attachments: z.array(z.object({
    filename: z.string(),
    url: z.string().url(),
    type: z.string(),
  })).optional(),
  effectiveness_confirmed: z.boolean(),
  effectiveness_notes: z.string().max(1000).optional(),
  recurrence_checked: z.boolean(),
  recurrence_notes: z.string().max(1000).optional(),
  checklist: z.array(checklistItemSchema).min(1, 'Checklist required'),
  verifier_title: z.string().min(2).max(100),
  signature_confirmation: z.string().min(2, 'Signature required'),
}).refine(
  (data) => {
    // If result is fail or partial, notes must be longer
    if (data.result === 'fail' || data.result === 'partial') {
      return data.result_notes.length >= 50;
    }
    return true;
  },
  {
    message: 'Result notes must be at least 50 characters for fail/partial results',
    path: ['result_notes'],
  }
);

// Close NCR schema
export const closeNCRSchema = z.object({
  verification_id: z.string().uuid('Invalid verification ID'),
  closure_notes: z.string().max(2000).optional(),
  final_remarks: z.string().max(1000).optional(),
});

// Reopen NCR schema
export const reopenNCRSchema = z.object({
  reopen_reason: z.string()
    .min(50, 'Reopen reason must be at least 50 characters')
    .max(2000),
  approval_reference: z.string().max(100).optional(),
  is_exceptional: z.boolean().default(false),
}).refine(
  (data) => {
    // If exceptional reopen, approval_reference required
    if (data.is_exceptional) {
      return data.approval_reference && data.approval_reference.length > 0;
    }
    return true;
  },
  {
    message: 'Approval reference required for exceptional reopen',
    path: ['approval_reference'],
  }
);

// Create lesson learned schema
export const createLessonSchema = z.object({
  title: z.string()
    .min(5, 'Title must be at least 5 characters')
    .max(200, 'Title must not exceed 200 characters'),
  description: z.string()
    .min(20, 'Description must be at least 20 characters')
    .max(2000, 'Description must not exceed 2000 characters'),
  category: lessonCategoryEnum,
  severity: lessonSeverityEnum,
  impact_area: z.array(z.string()).optional(),
  recommendations: z.string()
    .min(10, 'Recommendations must be at least 10 characters')
    .max(2000),
  preventive_actions: z.string().max(2000).optional(),
  capa_recommended: z.boolean().default(false),
});

// Update lesson schema
export const updateLessonSchema = createLessonSchema.partial();
```

### Service Layer

```typescript
// lib/services/ncr-verification-service.ts

export class NCRVerificationService {
  // ==========================================================================
  // Verification Operations
  // ==========================================================================

  /**
   * Get verification details for NCR
   */
  static async getVerification(ncrId: string): Promise<VerificationDetail | null>;

  /**
   * Check if NCR can be verified
   * Returns { can_verify, pending_actions, missing_requirements }
   */
  static async canVerify(ncrId: string): Promise<CanVerifyResult>;

  /**
   * Get default verification checklist
   */
  static async getDefaultChecklist(): Promise<ChecklistTemplate[]>;

  /**
   * Submit verification for NCR
   * Creates verification record and transitions NCR status
   */
  static async verify(
    ncrId: string,
    input: VerifyNCRInput,
    userId: string
  ): Promise<{ verification: NCRVerification; nextAction: string }>;

  /**
   * Generate verification number
   */
  static async generateVerificationNumber(orgId: string): Promise<string>;

  // ==========================================================================
  // Close Operations
  // ==========================================================================

  /**
   * Close NCR after successful verification
   * Sets NCR as immutable
   */
  static async close(
    ncrId: string,
    input: CloseNCRInput,
    userId: string
  ): Promise<NCRReport>;

  /**
   * Check if NCR can be closed
   */
  static async canClose(ncrId: string): Promise<{ canClose: boolean; reason?: string }>;

  // ==========================================================================
  // Reopen Operations
  // ==========================================================================

  /**
   * Reopen NCR (after verification fail)
   * Returns NCR to corrective_action status
   */
  static async reopen(
    ncrId: string,
    input: ReopenNCRInput,
    userId: string
  ): Promise<NCRReport>;

  /**
   * Reopen closed NCR (exceptional - Quality Director only)
   */
  static async reopenExceptional(
    ncrId: string,
    input: ReopenNCRInput,
    userId: string
  ): Promise<NCRReport>;

  /**
   * Check if user can reopen NCR
   */
  static async canReopen(
    ncrId: string,
    userId: string
  ): Promise<{ canReopen: boolean; reason?: string }>;

  // ==========================================================================
  // Report Generation
  // ==========================================================================

  /**
   * Generate NCR summary report (PDF)
   */
  static async generateReport(
    ncrId: string,
    format: 'pdf' | 'preview'
  ): Promise<{ url?: string; html?: string }>;

  /**
   * Get report data for NCR
   */
  static async getReportData(ncrId: string): Promise<NCRReportData>;
}

// lib/services/lessons-learned-service.ts

export class LessonsLearnedService {
  // ==========================================================================
  // CRUD Operations
  // ==========================================================================

  /**
   * List lessons learned for NCR
   */
  static async listByNCR(ncrId: string): Promise<LessonLearned[]>;

  /**
   * List all lessons learned (with filters)
   */
  static async list(params: LessonsListParams): Promise<PaginatedResult<LessonLearned>>;

  /**
   * Get lesson by ID
   */
  static async getById(id: string): Promise<LessonLearned | null>;

  /**
   * Create lesson learned
   */
  static async create(
    ncrId: string,
    input: CreateLessonInput,
    userId: string
  ): Promise<LessonLearned>;

  /**
   * Update lesson learned
   */
  static async update(
    id: string,
    input: UpdateLessonInput,
    userId: string
  ): Promise<LessonLearned>;

  /**
   * Delete lesson (draft only)
   */
  static async delete(id: string, userId: string): Promise<void>;

  // ==========================================================================
  // Workflow Operations
  // ==========================================================================

  /**
   * Approve lesson learned (QA Manager)
   */
  static async approve(id: string, userId: string): Promise<LessonLearned>;

  /**
   * Share lesson with departments
   */
  static async share(
    id: string,
    sharedWith: string[],
    userId: string
  ): Promise<LessonLearned>;

  /**
   * Archive lesson
   */
  static async archive(id: string, userId: string): Promise<LessonLearned>;

  // ==========================================================================
  // Utility
  // ==========================================================================

  /**
   * Generate lesson number
   */
  static async generateLessonNumber(orgId: string): Promise<string>;

  /**
   * Get lessons by category
   */
  static async getByCategory(category: string): Promise<LessonLearned[]>;

  /**
   * Get lessons recommending CAPA
   */
  static async getLessonsRecommendingCAPA(): Promise<LessonLearned[]>;
}
```

### Frontend Components

```
apps/frontend/app/(authenticated)/quality/
  ncrs/
    [id]/
      page.tsx                       -- NCR detail (includes Verification tab)
      report/
        page.tsx                     -- NCR report preview page

components/quality/ncrs/
  verification/
    VerificationTab.tsx              -- Verification tab container
    VerificationDetails.tsx          -- View completed verification
    VerificationPending.tsx          -- Pending verification state
    VerifyNCRModal.tsx               -- Main verification modal
    VerificationChecklist.tsx        -- Checklist form component
    VerificationMethodSelect.tsx     -- Method dropdown
    VerificationResultForm.tsx       -- Result selection and notes
    VerificationSignature.tsx        -- Signature confirmation
    CloseNCRDialog.tsx               -- Close confirmation dialog
    ReopenNCRDialog.tsx              -- Reopen with reason dialog
    VerificationResultBadge.tsx      -- Pass/Fail/Partial badge

  lessons/
    LessonsLearnedTab.tsx            -- Lessons tab container
    LessonsLearnedList.tsx           -- List of lessons for NCR
    LessonLearnedCard.tsx            -- Individual lesson card
    CreateLessonModal.tsx            -- Create lesson form
    EditLessonModal.tsx              -- Edit lesson form
    LessonDetailModal.tsx            -- View lesson details
    ApproveLessonDialog.tsx          -- Approve confirmation
    ShareLessonModal.tsx             -- Share with departments
    LessonCategoryBadge.tsx          -- Category badge
    LessonSeverityBadge.tsx          -- Severity badge

  report/
    NCRReportPreview.tsx             -- Report preview component
    NCRReportPDF.tsx                 -- PDF generation component
    NCRReportSections.tsx            -- Report section components
    GenerateReportButton.tsx         -- Generate report action
    DownloadReportButton.tsx         -- Download PDF action
```

### UI Component Details

**VerifyNCRModal.tsx**
- Multi-step modal wizard:
  1. Checklist - Check all required items
  2. Method - Select verification method
  3. Result - Record result and notes
  4. Evidence - Add evidence (optional)
  5. Signature - Confirm with signature
- Progress indicator at top
- Cannot proceed without completing required steps
- Final confirmation before submit

**VerificationChecklist.tsx**
- List of checklist items with checkboxes
- Required items marked with asterisk
- Optional items in different color
- Notes field per item
- Progress counter: "5/7 items completed"
- Validation highlight for unchecked required items

**VerificationSignature.tsx**
- Verifier name (auto-filled, read-only)
- Verifier title (editable input)
- Verification date (auto-filled, read-only)
- Signature statement (read-only)
- "Type your name to sign" input
- Signature confirmation button
- Clear/Cancel actions

**CloseNCRDialog.tsx**
- Confirmation dialog with warning
- "This action is permanent and cannot be undone"
- Optional closure notes
- Final confirmation button
- Close action with loading state

**ReopenNCRDialog.tsx**
- Reason input (required, min 50 chars)
- For exceptional reopen: approval reference input
- Warning about audit trail logging
- Confirmation button

**NCRReportPreview.tsx**
- Full-page report preview
- Print-friendly layout
- Sections matching PDF structure
- DRAFT watermark for non-closed NCRs
- Download PDF button
- Close/Back button

---

## Key Business Rules

1. **QA Manager Only**: Only users with QA_MANAGER role can verify and close NCRs
2. **Quality Director for Exceptional Reopen**: Only QUALITY_DIRECTOR can reopen closed NCRs
3. **All Actions Complete**: Cannot verify until all corrective actions are completed
4. **Root Cause Required**: Cannot verify without documented root cause
5. **Checklist Completion**: All required checklist items must be checked
6. **Signature Required**: Verifier must provide signature confirmation
7. **Immutable After Close**: Closed NCRs cannot be modified (only reopened by Director)
8. **Fail = Reopen**: Verification result 'fail' automatically reopens NCR
9. **Audit Trail**: All verification and close actions logged immutably
10. **Report Generation**: Final report can only be generated for closed NCRs (others get DRAFT)
11. **Lessons Learned**: Can be added at any time but must be approved by QA Manager
12. **Reopen Count Tracked**: Each reopen increments counter for metrics

---

## Deliverables

### Database
- [ ] Migration: `ncr_verifications` table with all columns
- [ ] Migration: `ncr_verification_checklist` table
- [ ] Migration: `ncr_lessons_learned` table
- [ ] Migration: `verification_number_sequences` table
- [ ] Migration: `lesson_number_sequences` table
- [ ] Migration: Update `ncr_reports` with verification columns
- [ ] Function: `generate_verification_number(org_id)`
- [ ] Function: `generate_lesson_number(org_id)`
- [ ] RLS policies for all new tables
- [ ] All performance indexes

### API Routes
- [ ] `GET /api/quality/ncrs/:id/verification` - Get verification details
- [ ] `POST /api/quality/ncrs/:id/verify` - Submit verification
- [ ] `POST /api/quality/ncrs/:id/close` - Close NCR
- [ ] `POST /api/quality/ncrs/:id/reopen` - Reopen NCR
- [ ] `GET /api/quality/ncrs/:id/report` - Generate report
- [ ] `GET /api/quality/ncrs/:id/lessons` - List lessons
- [ ] `POST /api/quality/ncrs/:id/lessons` - Create lesson
- [ ] `PUT /api/quality/lessons/:id` - Update lesson
- [ ] `DELETE /api/quality/lessons/:id` - Delete lesson
- [ ] `POST /api/quality/lessons/:id/approve` - Approve lesson
- [ ] `POST /api/quality/lessons/:id/share` - Share lesson

### Service Layer
- [ ] `NCRVerificationService.verify()` - Submit verification
- [ ] `NCRVerificationService.close()` - Close NCR
- [ ] `NCRVerificationService.reopen()` - Reopen NCR
- [ ] `NCRVerificationService.reopenExceptional()` - Exceptional reopen
- [ ] `NCRVerificationService.generateReport()` - Generate PDF
- [ ] `NCRVerificationService.canVerify()` - Check prerequisites
- [ ] `LessonsLearnedService.create()` - Create lesson
- [ ] `LessonsLearnedService.approve()` - Approve lesson
- [ ] `LessonsLearnedService.share()` - Share lesson

### Validation
- [ ] `verifyNCRSchema`
- [ ] `closeNCRSchema`
- [ ] `reopenNCRSchema`
- [ ] `createLessonSchema`
- [ ] `updateLessonSchema`

### Frontend
- [ ] Verification tab on NCR detail page
- [ ] Verify NCR modal with wizard steps
- [ ] Verification checklist component
- [ ] Verification result form
- [ ] Signature confirmation component
- [ ] Close NCR dialog
- [ ] Reopen NCR dialog
- [ ] Lessons learned tab
- [ ] Create/Edit lesson modals
- [ ] NCR report preview page
- [ ] PDF generation and download

### Tests
- [ ] Unit tests: NCRVerificationService methods (>80% coverage)
- [ ] Unit tests: LessonsLearnedService methods (>80% coverage)
- [ ] Integration tests: All API endpoints
- [ ] Permission tests: Role-based access
- [ ] RLS tests: Multi-tenancy isolation
- [ ] E2E: Full verify -> close workflow
- [ ] E2E: Fail -> reopen workflow

---

## Test Strategy

### Unit Tests

```typescript
describe('NCRVerificationService', () => {
  describe('verify', () => {
    it('creates verification with correct fields', async () => {});
    it('generates verification number', async () => {});
    it('validates all required checklist items checked', async () => {});
    it('requires result notes for fail/partial', async () => {});
    it('records verifier signature data', async () => {});
    it('transitions NCR status to verification', async () => {});
  });

  describe('close', () => {
    it('closes NCR after pass verification', async () => {});
    it('sets closed_at and closed_by', async () => {});
    it('makes NCR immutable', async () => {});
    it('requires QA_MANAGER role', async () => {});
    it('creates audit log entry', async () => {});
  });

  describe('reopen', () => {
    it('reopens NCR on fail verification', async () => {});
    it('increments reopen_count', async () => {});
    it('sets reopen_reason', async () => {});
    it('transitions to corrective_action', async () => {});
  });

  describe('reopenExceptional', () => {
    it('reopens closed NCR', async () => {});
    it('requires QUALITY_DIRECTOR role', async () => {});
    it('requires approval_reference', async () => {});
    it('logs exceptional action', async () => {});
  });

  describe('canVerify', () => {
    it('returns false if actions incomplete', async () => {});
    it('returns false if no root cause', async () => {});
    it('returns true when ready', async () => {});
  });

  describe('generateReport', () => {
    it('generates PDF for closed NCR', async () => {});
    it('includes all sections', async () => {});
    it('adds DRAFT watermark for open NCR', async () => {});
  });
});

describe('LessonsLearnedService', () => {
  describe('create', () => {
    it('creates lesson with correct fields', async () => {});
    it('generates lesson number', async () => {});
    it('links to NCR', async () => {});
    it('validates required fields', async () => {});
  });

  describe('approve', () => {
    it('approves lesson', async () => {});
    it('sets approved_by and approved_at', async () => {});
    it('requires QA_MANAGER role', async () => {});
  });

  describe('share', () => {
    it('updates shared_with', async () => {});
    it('sets shared_date', async () => {});
  });
});
```

### Integration Tests

```typescript
describe('NCR Verification API', () => {
  describe('POST /api/quality/ncrs/:id/verify', () => {
    it('submits verification with valid data', async () => {});
    it('returns 400 for incomplete checklist', async () => {});
    it('returns 400 for missing signature', async () => {});
    it('returns 403 for non-QA_MANAGER', async () => {});
    it('returns 422 if actions incomplete', async () => {});
  });

  describe('POST /api/quality/ncrs/:id/close', () => {
    it('closes NCR after pass verification', async () => {});
    it('returns 403 without verification', async () => {});
    it('returns 409 if already closed', async () => {});
  });

  describe('POST /api/quality/ncrs/:id/reopen', () => {
    it('reopens NCR with reason', async () => {});
    it('returns 400 for short reason', async () => {});
    it('returns 403 for closed NCR (non-Director)', async () => {});
  });

  describe('GET /api/quality/ncrs/:id/report', () => {
    it('generates PDF for closed NCR', async () => {});
    it('generates preview with watermark for open NCR', async () => {});
  });
});

describe('Lessons Learned API', () => {
  describe('POST /api/quality/ncrs/:id/lessons', () => {
    it('creates lesson with valid data', async () => {});
    it('returns 400 for missing title', async () => {});
    it('enforces org_id from auth', async () => {});
  });

  describe('POST /api/quality/lessons/:id/approve', () => {
    it('approves lesson as QA_MANAGER', async () => {});
    it('returns 403 for QA_INSPECTOR', async () => {});
  });
});
```

### E2E Tests

```typescript
describe('NCR Verification & Close Workflow', () => {
  it('complete verification and close flow', async () => {
    // 1. Navigate to NCR in corrective_action status
    // 2. Click [Verify & Close]
    // 3. Complete all checklist items
    // 4. Select verification method
    // 5. Record result = Pass
    // 6. Confirm signature
    // 7. Submit verification
    // 8. Confirm close
    // 9. Verify NCR status = closed
    // 10. Verify NCR is immutable
  });

  it('verification fail and reopen flow', async () => {
    // 1. Navigate to NCR in corrective_action status
    // 2. Click [Verify & Close]
    // 3. Complete checklist
    // 4. Record result = Fail with notes
    // 5. Submit verification
    // 6. Confirm reopen
    // 7. Verify NCR status = reopened
    // 8. Verify reopen_count incremented
  });

  it('add lessons learned flow', async () => {
    // 1. Navigate to NCR detail
    // 2. Click Lessons Learned tab
    // 3. Click [Add Lesson]
    // 4. Fill lesson form
    // 5. Save lesson
    // 6. Verify lesson appears in list
    // 7. Approve lesson (as QA Manager)
  });

  it('generate NCR report flow', async () => {
    // 1. Navigate to closed NCR
    // 2. Click [Generate Report]
    // 3. Verify report preview displays
    // 4. Click [Download PDF]
    // 5. Verify PDF downloads
  });
});
```

---

## Definition of Done

### Database
- [ ] `ncr_verifications` table created with all columns
- [ ] `ncr_verification_checklist` table created
- [ ] `ncr_lessons_learned` table created
- [ ] Sequence tables created for number generation
- [ ] All indexes created for performance
- [ ] RLS policies enforce org isolation
- [ ] Number generation functions work correctly

### API
- [ ] All endpoints return correct HTTP status codes
- [ ] Validation errors return 400 with detailed messages
- [ ] Permission errors return 403 with clear message
- [ ] Cross-tenant access returns 404
- [ ] Response times:
  - Verification submit: < 500ms
  - Close NCR: < 500ms
  - Report generation: < 5 seconds

### Service
- [ ] Complete verification workflow: checklist -> method -> result -> signature
- [ ] Close workflow makes NCR immutable
- [ ] Reopen workflow returns NCR to corrective_action
- [ ] Exceptional reopen requires Quality Director
- [ ] Report generation includes all sections
- [ ] Lessons learned CRUD works correctly
- [ ] Audit trail created for all actions

### Frontend
- [ ] Verification tab displays correctly
- [ ] Verify NCR modal wizard works
- [ ] Checklist validation enforced
- [ ] Signature confirmation works
- [ ] Close dialog with confirmation
- [ ] Reopen dialog with reason
- [ ] Lessons learned tab works
- [ ] Report preview and download work
- [ ] All badges display correctly
- [ ] Permission-based UI elements

### Testing
- [ ] Unit tests: >80% coverage on services
- [ ] Integration tests: All endpoints covered
- [ ] RLS tests: Multi-tenancy verified
- [ ] Permission tests: Role-based access
- [ ] E2E tests: Full workflows passing

### Integration
- [ ] Works with story 06.15 (Corrective Action) - prerequisite check
- [ ] Works with story 06.14 (Root Cause) - root cause check
- [ ] Ready for story 06.31 (CAPA) - lessons learned as input
- [ ] Ready for story 06.38 (Audit Trail) - audit log entries

---

## Risk Assessment

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Immutability enforcement | HIGH | LOW | Database-level constraints, comprehensive tests |
| Report generation performance | MEDIUM | MEDIUM | Pre-render template, background generation |
| Exceptional reopen abuse | HIGH | LOW | Director-only permission, audit logging |
| Checklist validation complexity | MEDIUM | MEDIUM | Clear required/optional distinction |
| Signature legal compliance | HIGH | LOW | Phase 3 e-signature integration planned |
| Lessons learned adoption | MEDIUM | MEDIUM | Simple UI, optional fields |

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-12-20 | Initial story creation - NCR Verification & Close | OPUS |

---

**Document Status**: Ready for Implementation
**Created**: 2025-12-20
**Lines**: ~1500
**Complexity**: M (Medium)
**Phase**: 2B (NCR Lifecycle)
