# 06.9 - Basic NCR Creation

**Priority**: P0 (MVP)
**Story Points**: M (Medium)
**Type**: backend + frontend
**Phase**: 1 (Core Quality)
**Model**: OPUS

**State:** ready
**Estimate:** M (3-4 days)
**Primary PRD:** `docs/1-BASELINE/product/modules/quality.md` (FR-QA-009, Section 8)
**Architecture:** `docs/1-BASELINE/architecture/modules/quality.md` (ncr_reports table)
**UX Wireframes:**
- `docs/3-ARCHITECTURE/ux/wireframes/QA-009-ncr-list.md`
- `docs/3-ARCHITECTURE/ux/wireframes/QA-009-ncr-detail.md`

---

## Goal

Implement **basic NCR (Non-Conformance Report) creation and listing** functionality. This story establishes the foundation for quality issue tracking by enabling users to create NCRs, record essential details (title, description, severity, detection point), and view NCR lists with filtering. This is Phase 1 functionality - NO workflow state machine in this story (deferred to 06.13).

---

## Food Safety Compliance

This story is **critical for food safety compliance**:

- [x] **FDA 21 CFR Part 11** - Audit trail for all NCR actions required
- [x] **HACCP Compliance** - NCRs document CCP deviations
- [x] **ISO 9001/22000** - Non-conformance documentation required
- [x] **Traceability** - NCRs linked to inspections, batches, suppliers

**Regulatory Context:**
- FDA FSMA requires documented corrective actions for food safety issues
- Non-conformance reports are evidence of quality control
- Critical NCRs must be investigated within 24 hours
- All records retained for minimum 10 years

---

## MVP Scope

This story implements **Phase 1 Basic NCR Creation** only. The workflow state machine is deferred to Phase 2 (story 06.13).

**MVP Includes**:
- `ncr_reports` table (basic fields only)
- NCR auto-numbering (NCR-YYYY-NNNNN format)
- NCR creation form (title, description, severity, category)
- Detection point tracking (incoming, in-process, final, customer)
- Source reference linking (inspection, hold, batch, supplier)
- Basic NCR list page with filtering (status, severity, source)
- NCR detail page (read-only view)
- Status field: draft, open, closed (simplified for Phase 1)
- Permissions: QA Inspector can create, QA Manager can view all

**Deferred to Phase 2 (Story 06.13 - NCR Workflow)**:
- Full workflow state machine (Draft -> Open -> Investigation -> Root Cause -> Corrective Action -> Verification -> Closed)
- Workflow transitions and step tracking
- `ncr_workflow` table
- Investigation notes, root cause analysis
- Corrective action plans
- Verification and closure workflow
- Email notifications on workflow transitions
- Escalation rules

**Deferred to Phase 2+ (Stories 06.14-06.16)**:
- Root cause analysis tools (5-Why, Fishbone)
- Corrective action assignment and tracking
- Verification and effectiveness checks
- NCR reopening
- CAPA integration (story 06.31)

---

## User Story

As a **QA Inspector**, I want to **create Non-Conformance Reports to document quality issues discovered during inspections, production, or from customer complaints** so that **we have a traceable record of quality problems and can initiate corrective actions**.

As a **QA Manager**, I want to **view all NCRs with filtering by severity, status, and source** so that **I can monitor quality issues across the organization and prioritize urgent problems**.

---

## Scope

**In scope (this story)**
- `ncr_reports` table (basic fields only - no workflow columns)
- NCR auto-numbering: NCR-YYYY-NNNNN
- GET /api/quality/ncrs (list with filters)
- GET /api/quality/ncrs/:id (detail view)
- POST /api/quality/ncrs (create NCR)
- PUT /api/quality/ncrs/:id (update draft NCRs only)
- DELETE /api/quality/ncrs/:id (delete draft NCRs only)
- NCR list page with DataTable
- NCR detail page (read-only)
- Create NCR form modal
- Status badges (draft, open, closed)
- Severity badges (minor, major, critical)
- Detection point tracking (incoming, in-process, final, customer, internal)
- Source reference linking (inspection, hold, batch, supplier)
- Basic permissions (QA Inspector create, QA Manager full access)

**Out of scope (this story)**
- NCR workflow state machine (story 06.13)
- `ncr_workflow` table (story 06.13)
- Investigation, root cause, corrective action tabs (stories 06.14-06.16)
- Workflow transitions (story 06.13)
- Email notifications (story 06.17)
- Auto-create NCR from failed inspection (story 06.5 integration - Phase 1+)
- Hold linkage (story 06.2 integration - Phase 1+)
- CAPA creation from NCR (story 06.31 - Phase 4)

---

## Future Phases (Not in MVP)

### Phase 2 (Stories 06.13-06.16)
- **Full NCR Workflow** - State machine with all states
- **Investigation Tracking** - Rich text notes, evidence attachments
- **Root Cause Analysis** - 5-Why, Fishbone diagram tools
- **Corrective Action Plan** - Action items, assignments, due dates
- **Verification & Closure** - Effectiveness checks, sign-off
- **Workflow Notifications** - Email alerts on transitions
- **Escalation Rules** - Auto-escalate overdue critical NCRs

### Phase 3
- **CAPA Integration** - Auto-create CAPA from NCR (story 06.31)
- **Trending & Analytics** - NCR pareto charts, defect trends
- **Supplier NCR Scoring** - Impact supplier quality ratings
- **Batch Hold Auto-Link** - Auto-create quality hold on critical NCR

### Phase 4
- **E-signatures** - FDA 21 CFR Part 11 compliant signatures
- **Advanced Reporting** - NCR aging, resolution time dashboards
- **Recurrence Detection** - Flag repeat issues
- **Photo Attachments** - Inline image upload for evidence

---

## Dependencies

### Cross-Epic Dependencies

| Dependency | Story/Epic | Type | What It Provides | Status |
|------------|------------|------|------------------|--------|
| 01.1 | Org Context + RLS | HARD | organizations, users, roles tables | Ready |
| 02.1 | Products CRUD | SOFT | products table for product reference | Ready |
| 05.1 | LP Table + CRUD | SOFT | license_plates for LP reference | Ready |

### Within Epic Dependencies

| Dependency | Story | Type | What It Provides |
|------------|-------|------|------------------|
| 06.0 | Quality Settings | SOFT | quality_settings for defaults |
| 06.1 | Quality Status Types | SOFT | QA status enum reference |
| 06.2 | Quality Holds CRUD | SOFT | Hold linkage (optional in Phase 1) |
| 06.5 | Incoming Inspection | SOFT | Inspection linkage (optional in Phase 1) |

### Provides To (Downstream)

| Story | What This Provides |
|-------|-------------------|
| 06.13 | NCR Workflow - base ncr_reports table |
| 06.14 | NCR Root Cause - ncr_id reference |
| 06.15 | NCR Corrective Action - ncr_id reference |
| 06.16 | NCR Verification - ncr_id reference |
| 06.31 | CAPA Creation - source_type='ncr', source_id=ncr_id |

---

## Database Migration

### Migration: Create ncr_reports table (Phase 1 - Basic)

```sql
-- Migration: YYYYMMDDHHMMSS_create_ncr_reports.sql

-- =============================================================================
-- NCR Reports Table (Phase 1 - Basic Creation)
-- =============================================================================
-- NOTE: This is Phase 1 version with simplified status (draft, open, closed)
-- Story 06.13 will expand to full workflow states

CREATE TABLE ncr_reports (
    -- Identity
    id                      UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id                  UUID NOT NULL REFERENCES organizations(id),
    ncr_number              TEXT NOT NULL,

    -- Basic Information
    title                   TEXT NOT NULL,
    description             TEXT NOT NULL,

    -- Severity and Status
    severity                TEXT NOT NULL
                            CHECK (severity IN ('minor', 'major', 'critical')),
    status                  TEXT NOT NULL DEFAULT 'draft'
                            CHECK (status IN ('draft', 'open', 'closed')),
    -- NOTE: Phase 2 (story 06.13) will expand status to:
    -- 'draft', 'open', 'investigation', 'root_cause', 'corrective_action', 'verification', 'closed', 'reopened'

    -- Category (optional)
    category                TEXT
                            CHECK (category IN ('product_defect', 'process_deviation', 'documentation_error',
                                                'equipment_failure', 'supplier_issue', 'customer_complaint', 'other')),

    -- Detection
    detection_point         TEXT NOT NULL
                            CHECK (detection_point IN ('incoming', 'in_process', 'final', 'customer', 'internal_audit', 'supplier_audit', 'other')),
    detected_date           TIMESTAMPTZ NOT NULL DEFAULT now(),
    detected_by             UUID NOT NULL REFERENCES users(id),

    -- Source Reference (polymorphic - optional in Phase 1)
    source_type             TEXT
                            CHECK (source_type IN ('inspection', 'hold', 'batch', 'work_order', 'supplier', 'customer_complaint', 'audit', 'other')),
    source_id               UUID,
    source_description      TEXT,  -- Human-readable source reference

    -- Assignment (optional in Phase 1)
    assigned_to             UUID REFERENCES users(id),
    assigned_at             TIMESTAMPTZ,

    -- Closure (Phase 1 - simple closure)
    closed_at               TIMESTAMPTZ,
    closed_by               UUID REFERENCES users(id),
    closure_notes           TEXT,

    -- Audit
    created_at              TIMESTAMPTZ NOT NULL DEFAULT now(),
    created_by              UUID REFERENCES users(id),
    updated_at              TIMESTAMPTZ NOT NULL DEFAULT now(),
    updated_by              UUID REFERENCES users(id),

    -- Constraints
    CONSTRAINT uq_ncr_number UNIQUE (org_id, ncr_number),
    CONSTRAINT check_closed_fields CHECK (
        (status = 'closed' AND closed_at IS NOT NULL AND closed_by IS NOT NULL)
        OR (status != 'closed' AND closed_at IS NULL AND closed_by IS NULL)
    )
);

-- =============================================================================
-- Indexes for Performance
-- =============================================================================

CREATE INDEX idx_ncr_org_status ON ncr_reports(org_id, status);
CREATE INDEX idx_ncr_org_severity ON ncr_reports(org_id, severity);
CREATE INDEX idx_ncr_detection_point ON ncr_reports(org_id, detection_point);
CREATE INDEX idx_ncr_detected_date ON ncr_reports(org_id, detected_date DESC);
CREATE INDEX idx_ncr_detected_by ON ncr_reports(detected_by);
CREATE INDEX idx_ncr_assigned_to ON ncr_reports(assigned_to) WHERE assigned_to IS NOT NULL;
CREATE INDEX idx_ncr_source ON ncr_reports(source_type, source_id) WHERE source_type IS NOT NULL;
CREATE INDEX idx_ncr_created ON ncr_reports(org_id, created_at DESC);

-- Composite index for list queries
CREATE INDEX idx_ncr_list_query ON ncr_reports(org_id, status, severity, detected_date DESC);

-- =============================================================================
-- NCR Number Sequence
-- =============================================================================

CREATE TABLE ncr_number_sequences (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    year INTEGER NOT NULL,
    current_value BIGINT NOT NULL DEFAULT 0,
    updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
    UNIQUE(org_id, year)
);

-- Function to generate NCR number (NCR-YYYY-NNNNN)
CREATE OR REPLACE FUNCTION generate_ncr_number(p_org_id UUID)
RETURNS TEXT AS $$
DECLARE
    v_year INTEGER;
    v_next_val BIGINT;
    v_ncr_number TEXT;
BEGIN
    v_year := EXTRACT(YEAR FROM CURRENT_DATE);

    -- Upsert sequence and get next value
    INSERT INTO ncr_number_sequences (org_id, year, current_value)
    VALUES (p_org_id, v_year, 1)
    ON CONFLICT (org_id, year)
    DO UPDATE SET
        current_value = ncr_number_sequences.current_value + 1,
        updated_at = NOW()
    RETURNING current_value INTO v_next_val;

    -- Format NCR number: NCR-YYYY-NNNNN
    v_ncr_number := 'NCR-' || v_year::TEXT || '-' || LPAD(v_next_val::TEXT, 5, '0');

    RETURN v_ncr_number;
END;
$$ LANGUAGE plpgsql;

-- =============================================================================
-- RLS Policies
-- =============================================================================

ALTER TABLE ncr_reports ENABLE ROW LEVEL SECURITY;

CREATE POLICY "ncr_select" ON ncr_reports
    FOR SELECT USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

CREATE POLICY "ncr_insert" ON ncr_reports
    FOR INSERT WITH CHECK (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

CREATE POLICY "ncr_update" ON ncr_reports
    FOR UPDATE USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
        -- Only allow update of draft NCRs or by assigned user
        AND (status = 'draft' OR assigned_to = auth.uid())
    );

-- Only allow delete of draft NCRs
CREATE POLICY "ncr_delete" ON ncr_reports
    FOR DELETE USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
        AND status = 'draft'
    );

ALTER TABLE ncr_number_sequences ENABLE ROW LEVEL SECURITY;

CREATE POLICY "ncr_seq_org" ON ncr_number_sequences
    FOR ALL TO authenticated
    USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

-- =============================================================================
-- Trigger for updated_at
-- =============================================================================

CREATE TRIGGER update_ncr_reports_updated_at
    BEFORE UPDATE ON ncr_reports
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- =============================================================================
-- Comments
-- =============================================================================

COMMENT ON TABLE ncr_reports IS 'Non-Conformance Reports (Phase 1 - Basic). Expanded workflow in story 06.13';
COMMENT ON COLUMN ncr_reports.status IS 'Phase 1: draft, open, closed. Phase 2 (06.13): full workflow states';
COMMENT ON COLUMN ncr_reports.source_type IS 'Polymorphic reference to inspection, hold, batch, etc.';
COMMENT ON COLUMN ncr_reports.detection_point IS 'Where was the non-conformance detected';
COMMENT ON COLUMN ncr_reports.category IS 'Type of non-conformance (product, process, equipment, etc.)';
```

---

## Acceptance Criteria (Given/When/Then)

### AC-1: NCR Table Creation

```gherkin
Scenario: ncr_reports table exists with all required columns
  Given database migration runs
  When schema is inspected
  Then ncr_reports table has all columns from schema
  And UNIQUE constraint exists on (org_id, ncr_number)
  And FK constraints exist for all user references
  And RLS policies enforce org isolation
  And status CHECK constraint allows: draft, open, closed
  And severity CHECK constraint allows: minor, major, critical
```

### AC-2: NCR Number Auto-Generation

```gherkin
Scenario: Generate NCR number with year-based format
  Given organization exists
  When first NCR created in 2025
  Then ncr_number format is 'NCR-2025-00001'
  And next NCR gets 'NCR-2025-00002'
  And year resets sequence (first 2026 = 'NCR-2026-00001')

Scenario: NCR number uniqueness
  Given NCR 'NCR-2025-00001' exists in org A
  When creating another with same number in org A
  Then system returns 409 Conflict error

Scenario: NCR number across orgs
  Given NCR 'NCR-2025-00001' exists in org A
  When creating NCR in org B
  Then ncr_number is 'NCR-2025-00001' (independent sequence)
```

### AC-3: Create NCR - Basic Flow

```gherkin
Scenario: Create NCR with required fields
  Given user is QA Inspector
  And user navigates to Quality > NCRs
  When user clicks [+ Create NCR]
  Then NCR creation modal opens
  And user fills form:
    | Field | Value |
    | Title | Temperature deviation during receiving |
    | Description | Refrigerated ingredients received at 8°C (spec: 0-4°C) |
    | Severity | Major |
    | Detection Point | Incoming |
    | Category | Supplier Issue |
  And clicks [Create NCR]
  Then NCR created with status = 'draft'
  And ncr_number auto-generated: 'NCR-2025-00001'
  And detected_by = current user ID
  And detected_date = now
  And success toast "NCR NCR-2025-00001 created"
  And modal closes
  And NCR appears in list

Scenario: Validation - required fields
  Given user opens NCR creation form
  When user submits without title
  Then error: "Title is required"
  When user submits without description
  Then error: "Description is required (min 20 characters)"
  When user submits without severity
  Then error: "Severity is required"
  When user submits without detection point
  Then error: "Detection point is required"
```

### AC-4: Create NCR with Source Reference

```gherkin
Scenario: Create NCR from failed inspection
  Given inspection INS-INC-2025-00456 failed with result='fail'
  And user views inspection detail page
  When user clicks [Create NCR]
  Then NCR form pre-filled with:
    | Field | Value |
    | Source Type | inspection |
    | Source ID | INS-INC-2025-00456 UUID |
    | Source Description | Inspection INS-INC-2025-00456 (Incoming) |
    | Detection Point | incoming (from inspection type) |
  And user can adjust and submit
  Then NCR created with source reference

Scenario: Create NCR from quality hold
  Given quality hold QH-2025-00123 exists
  When creating NCR and selecting hold as source
  Then source_type = 'hold'
  And source_id = hold UUID
  And source_description = 'Quality Hold QH-2025-00123'

Scenario: Create NCR without source reference
  Given user creates NCR manually
  And does not specify source
  Then source_type = NULL
  And source_id = NULL
  And NCR creation succeeds (source is optional)
```

### AC-5: NCR Severity Levels

```gherkin
Scenario: Severity options and definitions
  Given user opens NCR creation form
  When user clicks severity dropdown
  Then options displayed:
    | Severity | Description | Badge Color |
    | Critical | Food safety risk, regulatory violation | Red |
    | Major | Quality impact, customer complaint | Orange |
    | Minor | Process deviation, no product impact | Yellow |

Scenario: Critical NCR validation
  Given user selects severity = 'critical'
  And creates NCR
  Then NCR created successfully
  And badge displayed in red
  And (future: notification sent to QA Manager - Phase 2)
```

### AC-6: Detection Point Tracking

```gherkin
Scenario: Detection point options
  Given user opens NCR creation form
  When user clicks detection point dropdown
  Then options displayed:
    | Detection Point | Description |
    | incoming | During goods receipt inspection |
    | in_process | During production (WIP) |
    | final | During final inspection |
    | customer | Customer complaint/return |
    | internal_audit | Internal quality audit |
    | supplier_audit | Supplier audit finding |
    | other | Other detection source |

Scenario: Detection metadata captured
  Given user creates NCR
  Then detected_date = now (timestamp)
  And detected_by = current user ID
  And detection_point = selected value
```

### AC-7: NCR Category (Optional)

```gherkin
Scenario: Category options
  Given user opens NCR creation form
  When user clicks category dropdown (optional)
  Then options displayed:
    - Product Defect
    - Process Deviation
    - Documentation Error
    - Equipment Failure
    - Supplier Issue
    - Customer Complaint
    - Other

Scenario: Category is optional
  Given user creates NCR without selecting category
  Then NCR created successfully
  And category = NULL
```

### AC-8: NCR List Page Display

```gherkin
Scenario: NCR list loads
  Given user navigates to Quality > NCRs
  When page loads
  Then DataTable displays NCRs with columns:
    | Column | Description |
    | NCR Number | Link to detail page |
    | Title | NCR title (truncated if long) |
    | Severity | Badge (critical/major/minor) |
    | Status | Badge (draft/open/closed) |
    | Detection Point | Badge with icon |
    | Detected Date | Relative time (e.g., "2 days ago") |
    | Detected By | User name |
    | Actions | View, Edit (if draft), Delete (if draft) |
  And list loads within 500ms
  And pagination available (20 per page)
  And sorted by detected_date DESC (newest first)

Scenario: NCR status badges
  Given NCRs with various statuses
  When viewing list
  Then badges displayed:
    | Status | Badge Color | Icon |
    | draft | gray | Draft |
    | open | blue | Open |
    | closed | green | Closed |
```

### AC-9: NCR List Filters

```gherkin
Scenario: Filter by status
  Given NCRs exist with various statuses
  When user filters by status = 'open'
  Then only open NCRs displayed
  And URL updates with filter state

Scenario: Filter by severity
  Given NCRs with mixed severities
  When user filters by severity = 'critical'
  Then only critical NCRs displayed

Scenario: Filter by detection point
  Given NCRs from various detection points
  When user filters by detection_point = 'incoming'
  Then only incoming NCRs displayed

Scenario: Combined filters
  Given NCRs exist
  When user filters by:
    | Filter | Value |
    | Status | open |
    | Severity | major, critical |
    | Detection Point | incoming, in_process |
  Then only NCRs matching ALL filters displayed

Scenario: Search by NCR number or title
  Given NCRs exist
  When user searches "NCR-2025-00001" or "temperature"
  Then matching NCRs displayed
  And search debounced (300ms)
```

### AC-10: NCR Detail Page

```gherkin
Scenario: View NCR detail
  Given NCR NCR-2025-00001 exists
  When user navigates to /quality/ncrs/NCR-2025-00001
  Then page displays:
    | Section | Content |
    | Header | NCR #, Severity badge, Status badge |
    | Basic Info | Title, Description, Category |
    | Detection | Detection point, Detected date, Detected by |
    | Source | Source type, source description (if linked) |
    | Assignment | Assigned to (if assigned) |
    | Closure | Closed date, Closed by, Closure notes (if closed) |
    | Audit Trail | Created by, Created at, Updated at |
    | Actions | Based on status and permissions |

Scenario: View NCR with source reference
  Given NCR linked to inspection INS-INC-2025-00456
  When viewing detail page
  Then source section shows:
    | Field | Value |
    | Source Type | Inspection |
    | Source Reference | INS-INC-2025-00456 (clickable link) |
  And clicking link navigates to inspection detail

Scenario: View NCR without source reference
  Given NCR with source_type = NULL
  When viewing detail page
  Then source section shows "No source reference linked"
```

### AC-11: Edit Draft NCR

```gherkin
Scenario: Edit draft NCR
  Given NCR with status = 'draft'
  And current user is detected_by or assigned_to
  When user clicks [Edit]
  Then edit form opens with pre-filled values
  And user can modify: title, description, severity, detection_point, category
  And user cannot modify: ncr_number, detected_date, detected_by
  And user saves changes
  Then NCR updated
  And updated_at timestamp refreshed
  And success toast "NCR updated"

Scenario: Cannot edit open NCR
  Given NCR with status = 'open'
  When viewing detail page
  Then [Edit] button disabled
  And tooltip "Cannot edit open NCR. Use workflow to update."

Scenario: Cannot edit closed NCR
  Given NCR with status = 'closed'
  Then [Edit] button not shown
```

### AC-12: Delete Draft NCR

```gherkin
Scenario: Delete draft NCR
  Given NCR with status = 'draft'
  And current user is detected_by
  When user clicks [...] menu > [Delete]
  Then confirmation dialog: "Delete NCR NCR-2025-00001?"
  And user confirms
  Then NCR deleted from database
  And success toast "NCR deleted"
  And user redirected to NCR list

Scenario: Cannot delete open NCR
  Given NCR with status = 'open'
  Then [Delete] option not shown in menu
  And attempt to DELETE via API returns 403

Scenario: Cannot delete closed NCR
  Given NCR with status = 'closed'
  Then [Delete] option not shown
```

### AC-13: Transition Draft to Open

```gherkin
Scenario: Submit draft NCR
  Given NCR with status = 'draft'
  When user clicks [Submit NCR]
  Then confirmation: "Submit NCR? This will change status to Open."
  And user confirms
  Then status updated to 'open'
  And NCR cannot be edited or deleted anymore
  And success toast "NCR submitted. Status: Open"

Scenario: Auto-submit on create
  Given user creates NCR
  And checks "Submit immediately" checkbox
  Then NCR created with status = 'open' (skip draft)
```

### AC-14: Close NCR (Simple - Phase 1)

```gherkin
Scenario: Close NCR (QA Manager only)
  Given NCR with status = 'open'
  And current user has QA_MANAGER role
  When user clicks [Close NCR]
  Then closure form appears:
    | Field | Required |
    | Closure Notes | Yes (min 50 characters) |
  And user fills notes: "Issue resolved. Supplier corrected receiving temperature."
  And clicks [Close NCR]
  Then status updated to 'closed'
  And closed_at = now
  And closed_by = current user ID
  And closure_notes saved
  And success toast "NCR closed"

Scenario: Close requires notes
  Given user attempts to close NCR without notes
  Then error: "Closure notes required (min 50 characters)"

Scenario: QA Inspector cannot close
  Given current user has QA_INSPECTOR role (not QA_MANAGER)
  Then [Close NCR] button not shown
  And tooltip "Only QA Manager can close NCRs"
```

### AC-15: NCR Assignment (Optional in Phase 1)

```gherkin
Scenario: Assign NCR to owner
  Given NCR with status = 'open'
  And current user is QA_MANAGER
  When user clicks [Assign]
  Then assignment modal shows users with QA roles
  And user selects assignee
  Then assigned_to updated
  And assigned_at = now
  And (future: notification sent to assignee - Phase 2)

Scenario: Reassign NCR
  Given NCR assigned to User A
  When QA Manager reassigns to User B
  Then assigned_to updated to User B
  And audit log records reassignment

Scenario: Assignment is optional
  Given NCR created without assignment
  Then assigned_to = NULL
  And NCR can still progress (assignment not required in Phase 1)
```

### AC-16: Permission Enforcement

```gherkin
Scenario: Viewer can view but not create
  Given user with VIEWER role
  When viewing NCR list
  Then [+ Create NCR] button hidden
  And can click to view NCR detail
  And [Edit], [Delete], [Close] buttons hidden

Scenario: QA Inspector can create and edit own drafts
  Given user with QA_INSPECTOR role
  When viewing NCR list
  Then can create NCRs
  And can edit/delete own draft NCRs
  And cannot close NCRs
  And can view all NCRs in org

Scenario: QA Manager has full access
  Given user with QA_MANAGER role
  Then can create, edit (drafts), close NCRs
  And can assign NCRs to others
  And can view all NCRs
```

### AC-17: Audit Trail

```gherkin
Scenario: All NCR actions logged
  Given any NCR state change
  When action completes
  Then quality_audit_log entry created with:
    | Field | Value |
    | entity_type | ncr_report |
    | entity_id | ncr.id |
    | action | create/update/submit/close/assign |
    | user_id | current user |
    | timestamp | now |
    | old_value | previous state (for updates) |
    | new_value | new state |

Scenario: NCR creation logged
  Given user creates NCR
  Then audit log records:
    | action | create |
    | new_value | { title, severity, status, ... } |
```

### AC-18: RLS Policy Enforcement

```gherkin
Scenario: Org isolation on NCR list
  Given User A from Org A and User B from Org B
  And NCRs exist in both orgs
  When User A requests GET /api/quality/ncrs
  Then only Org A NCRs returned

Scenario: Cannot view NCR from different org
  Given NCR belongs to Org B
  When User A (Org A) requests GET /api/quality/ncrs/:id
  Then 404 Not Found returned

Scenario: NCR inherits org_id from user
  Given User A from Org A creates NCR
  Then ncr.org_id = Org A (automatic)
```

### AC-19: Performance Requirements

```gherkin
Scenario: NCR list performance
  Given 1000 NCRs in organization
  When listing NCRs with pagination
  Then response time < 500ms

Scenario: NCR detail performance
  Given NCR exists
  When loading NCR detail page
  Then response time < 300ms

Scenario: NCR creation performance
  Given valid NCR data
  When creating NCR
  Then operation completes < 300ms
```

---

## Implementation Notes

### API Endpoints

```typescript
// =============================================================================
// NCR Endpoints (Phase 1 - Basic)
// =============================================================================

// GET /api/quality/ncrs
// List NCRs with filters
interface NCRListParams {
  status?: 'draft' | 'open' | 'closed';
  severity?: 'minor' | 'major' | 'critical';
  detection_point?: 'incoming' | 'in_process' | 'final' | 'customer' | 'internal_audit' | 'supplier_audit' | 'other';
  category?: string;
  detected_by?: string;
  assigned_to?: string;
  date_from?: string;
  date_to?: string;
  search?: string;
  sort_by?: 'ncr_number' | 'detected_date' | 'severity' | 'status';
  sort_order?: 'asc' | 'desc';
  page?: number;
  limit?: number;
}

interface NCRListResponse {
  ncrs: NCRReport[];
  pagination: {
    total: number;
    page: number;
    limit: number;
    pages: number;
  };
  stats: {
    draft_count: number;
    open_count: number;
    closed_count: number;
    critical_count: number;
  };
}

interface NCRReport {
  id: string;
  org_id: string;
  ncr_number: string;
  title: string;
  description: string;
  severity: 'minor' | 'major' | 'critical';
  status: 'draft' | 'open' | 'closed';
  category?: string;
  detection_point: string;
  detected_date: string;
  detected_by: string;
  detected_by_name: string;
  source_type?: string;
  source_id?: string;
  source_description?: string;
  assigned_to?: string;
  assigned_to_name?: string;
  assigned_at?: string;
  closed_at?: string;
  closed_by?: string;
  closed_by_name?: string;
  closure_notes?: string;
  created_at: string;
  created_by: string;
  updated_at: string;
}

// GET /api/quality/ncrs/:id
interface NCRDetailResponse {
  ncr: NCRReport;
  source_reference?: {
    type: string;
    id: string;
    display_name: string;
    link: string;
  };
  permissions: {
    can_edit: boolean;
    can_delete: boolean;
    can_close: boolean;
    can_assign: boolean;
  };
}

// POST /api/quality/ncrs
interface CreateNCRRequest {
  title: string;
  description: string;
  severity: 'minor' | 'major' | 'critical';
  detection_point: string;
  category?: string;
  source_type?: string;
  source_id?: string;
  source_description?: string;
  submit_immediately?: boolean;  // If true, status='open'; else status='draft'
}

interface CreateNCRResponse {
  ncr: NCRReport;
}

// PUT /api/quality/ncrs/:id (draft only)
interface UpdateNCRRequest {
  title?: string;
  description?: string;
  severity?: 'minor' | 'major' | 'critical';
  detection_point?: string;
  category?: string;
}

// POST /api/quality/ncrs/:id/submit (draft -> open)
interface SubmitNCRRequest {
  // No body needed
}

// POST /api/quality/ncrs/:id/close (QA Manager only)
interface CloseNCRRequest {
  closure_notes: string;  // min 50 characters
}

// POST /api/quality/ncrs/:id/assign
interface AssignNCRRequest {
  assigned_to: string;  // User ID
}

// DELETE /api/quality/ncrs/:id (draft only)
// No request body
```

### Validation Schemas (Zod)

```typescript
import { z } from 'zod';

export const ncrSeverityEnum = z.enum(['minor', 'major', 'critical']);
export const ncrStatusEnum = z.enum(['draft', 'open', 'closed']);
export const ncrDetectionPointEnum = z.enum([
  'incoming',
  'in_process',
  'final',
  'customer',
  'internal_audit',
  'supplier_audit',
  'other'
]);
export const ncrCategoryEnum = z.enum([
  'product_defect',
  'process_deviation',
  'documentation_error',
  'equipment_failure',
  'supplier_issue',
  'customer_complaint',
  'other'
]);
export const ncrSourceTypeEnum = z.enum([
  'inspection',
  'hold',
  'batch',
  'work_order',
  'supplier',
  'customer_complaint',
  'audit',
  'other'
]);

export const createNCRSchema = z.object({
  title: z.string()
    .min(5, 'Title must be at least 5 characters')
    .max(200, 'Title must not exceed 200 characters'),
  description: z.string()
    .min(20, 'Description must be at least 20 characters')
    .max(2000, 'Description must not exceed 2000 characters'),
  severity: ncrSeverityEnum,
  detection_point: ncrDetectionPointEnum,
  category: ncrCategoryEnum.optional(),
  source_type: ncrSourceTypeEnum.optional(),
  source_id: z.string().uuid('Invalid source ID').optional(),
  source_description: z.string().max(500).optional(),
  submit_immediately: z.boolean().default(false),
});

export const updateNCRSchema = z.object({
  title: z.string().min(5).max(200).optional(),
  description: z.string().min(20).max(2000).optional(),
  severity: ncrSeverityEnum.optional(),
  detection_point: ncrDetectionPointEnum.optional(),
  category: ncrCategoryEnum.optional(),
});

export const closeNCRSchema = z.object({
  closure_notes: z.string()
    .min(50, 'Closure notes must be at least 50 characters')
    .max(2000, 'Closure notes must not exceed 2000 characters'),
});

export const assignNCRSchema = z.object({
  assigned_to: z.string().uuid('Invalid user ID'),
});

export const ncrListQuerySchema = z.object({
  status: ncrStatusEnum.optional(),
  severity: ncrSeverityEnum.optional(),
  detection_point: ncrDetectionPointEnum.optional(),
  category: ncrCategoryEnum.optional(),
  detected_by: z.string().uuid().optional(),
  assigned_to: z.string().uuid().optional(),
  date_from: z.string().optional(),
  date_to: z.string().optional(),
  search: z.string().min(1).optional(),
  sort_by: z.enum(['ncr_number', 'detected_date', 'severity', 'status']).default('detected_date'),
  sort_order: z.enum(['asc', 'desc']).default('desc'),
  page: z.coerce.number().int().positive().default(1),
  limit: z.coerce.number().int().min(1).max(100).default(20),
});
```

### Service Layer

```typescript
// lib/services/ncr-service.ts

export class NCRService {
  // ==========================================================================
  // CRUD Operations
  // ==========================================================================

  /**
   * List NCRs with filtering and pagination
   */
  static async list(params: NCRListParams): Promise<PaginatedResult<NCRReport>>;

  /**
   * Get NCR by ID
   */
  static async getById(id: string): Promise<NCRDetail | null>;

  /**
   * Get NCR by number
   */
  static async getByNumber(ncrNumber: string): Promise<NCRReport | null>;

  /**
   * Create new NCR
   */
  static async create(input: CreateNCRInput, userId: string): Promise<NCRReport>;

  /**
   * Update NCR (draft only)
   */
  static async update(id: string, input: UpdateNCRInput, userId: string): Promise<NCRReport>;

  /**
   * Delete NCR (draft only)
   */
  static async delete(id: string, userId: string): Promise<void>;

  // ==========================================================================
  // Status Transitions (Phase 1 - Simple)
  // ==========================================================================

  /**
   * Submit NCR (draft -> open)
   */
  static async submit(id: string, userId: string): Promise<NCRReport>;

  /**
   * Close NCR (open -> closed)
   * QA Manager only
   */
  static async close(
    id: string,
    closureNotes: string,
    userId: string
  ): Promise<NCRReport>;

  // ==========================================================================
  // Assignment
  // ==========================================================================

  /**
   * Assign NCR to user
   */
  static async assign(
    id: string,
    assignedToId: string,
    assignedBy: string
  ): Promise<NCRReport>;

  // ==========================================================================
  // Utility
  // ==========================================================================

  /**
   * Generate next NCR number
   */
  static async generateNCRNumber(orgId: string): Promise<string>;

  /**
   * Get NCR stats for dashboard
   */
  static async getStats(orgId: string): Promise<{
    draft_count: number;
    open_count: number;
    closed_count: number;
    critical_count: number;
    major_count: number;
    minor_count: number;
  }>;

  /**
   * Check user permissions for NCR
   */
  static async checkPermissions(ncrId: string, userId: string): Promise<{
    can_edit: boolean;
    can_delete: boolean;
    can_close: boolean;
    can_assign: boolean;
  }>;
}
```

### Frontend Components

```
apps/frontend/app/(authenticated)/quality/
  ncrs/
    page.tsx                       -- NCR list page
    [id]/
      page.tsx                     -- NCR detail page
    new/
      page.tsx                     -- Create NCR form (or modal)

components/quality/ncrs/
  NCRDataTable.tsx                 -- DataTable with filters
  NCRFilters.tsx                   -- Filter panel (status, severity, detection point)
  NCRStatusBadge.tsx               -- Status badge component (draft/open/closed)
  NCRSeverityBadge.tsx             -- Severity badge (critical/major/minor)
  NCRDetectionPointBadge.tsx       -- Detection point badge
  NCRDetail.tsx                    -- Detail view container
  NCRHeader.tsx                    -- Header with NCR #, status, severity
  NCRBasicInfo.tsx                 -- Title, description, category
  NCRDetectionInfo.tsx             -- Detection point, date, detected by
  NCRSourceInfo.tsx                -- Source type, source reference (if linked)
  NCRAssignmentInfo.tsx            -- Assigned to (if assigned)
  NCRClosureInfo.tsx               -- Closure date, notes (if closed)
  NCRActions.tsx                   -- Action buttons based on status
  CreateNCRModal.tsx               -- NCR creation form modal
  EditNCRModal.tsx                 -- Edit draft NCR modal
  CloseNCRDialog.tsx               -- Close NCR with notes
  AssignNCRModal.tsx               -- Assign NCR to user
  SubmitNCRDialog.tsx              -- Submit draft confirmation
  DeleteNCRDialog.tsx              -- Delete draft confirmation
  NCRSummaryCard.tsx               -- Summary card for dashboard
```

### UI Component Details

**NCRDataTable.tsx**
- ShadCN DataTable pattern
- Columns: NCR #, Title, Severity, Status, Detection Point, Detected Date, Detected By, Actions
- Row click navigates to detail
- Inline actions: View, Edit (draft only), Delete (draft only)
- Severity badge colors: critical=red, major=orange, minor=yellow
- Status badge colors: draft=gray, open=blue, closed=green

**NCRDetail.tsx**
- Three-section layout
- Left: Header (NCR #, badges, actions)
- Center: Basic info, Detection info, Source info
- Right: Assignment, Closure (if applicable)
- Responsive: stacks on mobile

**CreateNCRModal.tsx**
- Form fields: Title, Description, Severity, Detection Point, Category (optional)
- Optional: Source type, Source ID, Source description
- Checkbox: "Submit immediately" (status='open') vs save as draft
- Validation: Required fields, min lengths
- Submit button with loading state

---

## Key Business Rules

1. **NCR Number Unique per Org**: NCR number unique within org, auto-generated, year-based sequence
2. **Draft Editable**: Only draft NCRs can be edited or deleted
3. **Open Immutable**: Once submitted (status='open'), NCR cannot be edited (use workflow in Phase 2)
4. **Close Requires Manager**: Only QA_MANAGER can close NCRs
5. **Closure Notes Mandatory**: Closing NCR requires notes (min 50 characters)
6. **Detection Metadata**: Detected date and detected_by captured automatically on creation
7. **Source Reference Optional**: NCRs can be created with or without source reference
8. **Assignment Optional**: NCRs can be unassigned in Phase 1 (workflow ownership in Phase 2)
9. **Audit Trail Required**: All create, update, close actions logged
10. **RLS Enforced**: Multi-tenancy isolation via RLS policies

---

## Deliverables

### Database
- [ ] Migration: `ncr_reports` table with all columns
- [ ] Migration: `ncr_number_sequences` table
- [ ] Function: `generate_ncr_number(org_id)`
- [ ] RLS policies for ncr_reports
- [ ] All performance indexes
- [ ] Trigger: update_updated_at

### API Routes
- [ ] `GET /api/quality/ncrs` - List with filters
- [ ] `GET /api/quality/ncrs/:id` - Get detail
- [ ] `POST /api/quality/ncrs` - Create NCR
- [ ] `PUT /api/quality/ncrs/:id` - Update draft
- [ ] `DELETE /api/quality/ncrs/:id` - Delete draft
- [ ] `POST /api/quality/ncrs/:id/submit` - Submit draft -> open
- [ ] `POST /api/quality/ncrs/:id/close` - Close NCR
- [ ] `POST /api/quality/ncrs/:id/assign` - Assign owner

### Service Layer
- [ ] `NCRService.list()` - List with pagination
- [ ] `NCRService.getById()` - Get with permissions
- [ ] `NCRService.create()` - Create NCR
- [ ] `NCRService.update()` - Update draft
- [ ] `NCRService.delete()` - Delete draft
- [ ] `NCRService.submit()` - Submit draft
- [ ] `NCRService.close()` - Close with notes
- [ ] `NCRService.assign()` - Assign owner
- [ ] `NCRService.generateNCRNumber()` - Number generation
- [ ] `NCRService.getStats()` - Dashboard stats

### Validation
- [ ] `createNCRSchema`
- [ ] `updateNCRSchema`
- [ ] `closeNCRSchema`
- [ ] `assignNCRSchema`
- [ ] `ncrListQuerySchema`

### Frontend
- [ ] NCR list page with DataTable
- [ ] NCR detail page
- [ ] Create NCR modal
- [ ] Edit NCR modal (draft only)
- [ ] Close NCR dialog
- [ ] Assign NCR modal
- [ ] Submit draft confirmation
- [ ] Delete draft confirmation
- [ ] Status, severity, detection point badges
- [ ] Filter panel
- [ ] Search functionality

### Tests
- [ ] Unit tests: NCRService methods (>80% coverage)
- [ ] Integration tests: All API endpoints
- [ ] RLS tests: Multi-tenancy isolation
- [ ] Permission tests: Role-based access
- [ ] E2E: Full NCR creation flow (create -> submit -> close)

---

## Test Strategy

### Unit Tests

```typescript
describe('NCRService', () => {
  describe('create', () => {
    it('creates NCR with correct fields', async () => {});
    it('generates NCR number', async () => {});
    it('sets status to draft by default', async () => {});
    it('sets status to open if submit_immediately=true', async () => {});
    it('captures detected_by and detected_date', async () => {});
    it('validates required fields', async () => {});
  });

  describe('update', () => {
    it('updates draft NCR', async () => {});
    it('blocks update of open NCR', async () => {});
    it('blocks update of closed NCR', async () => {});
    it('validates updated fields', async () => {});
  });

  describe('submit', () => {
    it('changes status from draft to open', async () => {});
    it('blocks submit of already open NCR', async () => {});
    it('creates audit log entry', async () => {});
  });

  describe('close', () => {
    it('closes NCR with notes', async () => {});
    it('sets closed_at and closed_by', async () => {});
    it('requires QA_MANAGER role', async () => {});
    it('validates closure notes length', async () => {});
  });

  describe('delete', () => {
    it('deletes draft NCR', async () => {});
    it('blocks delete of open NCR', async () => {});
    it('blocks delete of closed NCR', async () => {});
  });

  describe('generateNCRNumber', () => {
    it('generates NCR-YYYY-NNNNN format', async () => {});
    it('increments sequence', async () => {});
    it('resets per year', async () => {});
  });

  describe('checkPermissions', () => {
    it('allows edit/delete for draft', async () => {});
    it('blocks edit/delete for open', async () => {});
    it('allows close for QA_MANAGER only', async () => {});
  });
});
```

### Integration Tests

```typescript
describe('NCRs API', () => {
  describe('POST /api/quality/ncrs', () => {
    it('creates NCR with valid data', async () => {});
    it('returns 400 for missing title', async () => {});
    it('returns 400 for short description', async () => {});
    it('enforces org_id from auth', async () => {});
  });

  describe('PUT /api/quality/ncrs/:id', () => {
    it('updates draft NCR', async () => {});
    it('returns 403 for open NCR', async () => {});
    it('returns 403 for closed NCR', async () => {});
  });

  describe('POST /api/quality/ncrs/:id/close', () => {
    it('closes NCR as QA_MANAGER', async () => {});
    it('returns 403 for QA_INSPECTOR', async () => {});
    it('validates closure notes', async () => {});
  });

  describe('GET /api/quality/ncrs', () => {
    it('returns filtered NCRs', async () => {});
    it('respects RLS for org isolation', async () => {});
    it('paginates correctly', async () => {});
  });
});
```

### E2E Tests

```typescript
describe('NCR Workflow', () => {
  it('complete flow: create draft -> submit -> close', async () => {
    // 1. Navigate to NCRs page
    // 2. Create new NCR as draft
    // 3. Verify appears in list with status=draft
    // 4. Edit draft NCR
    // 5. Submit draft (status -> open)
    // 6. Verify cannot edit anymore
    // 7. Close as QA Manager
    // 8. Verify status=closed
  });

  it('create and submit immediately', async () => {
    // 1. Create NCR with "Submit immediately" checked
    // 2. Verify status=open (skip draft)
  });

  it('permissions: QA Inspector cannot close', async () => {
    // 1. Login as QA Inspector
    // 2. Create NCR
    // 3. Verify [Close] button not shown
  });
});
```

---

## Definition of Done

### Database
- [ ] `ncr_reports` table created with all columns
- [ ] `ncr_number_sequences` table created
- [ ] All indexes created for performance
- [ ] RLS policies enforce org isolation
- [ ] NCR number generation works correctly

### API
- [ ] All endpoints return correct HTTP status codes
- [ ] Validation errors return 400 with detailed messages
- [ ] Cross-tenant access returns 404
- [ ] Response times:
  - NCR list: < 500ms
  - NCR detail: < 300ms
  - Create/Update: < 300ms

### Service
- [ ] Complete CRUD: create, update (draft), delete (draft)
- [ ] Status transitions: submit, close
- [ ] Assignment works
- [ ] Permission checks enforced
- [ ] Audit trail created for all actions

### Frontend
- [ ] NCR list page displays correctly
- [ ] NCR detail page shows all information
- [ ] Create NCR modal works
- [ ] Edit/Delete draft works
- [ ] Close NCR dialog works (QA Manager only)
- [ ] Submit draft confirmation works
- [ ] Status/severity badges display correctly
- [ ] Filters and search work
- [ ] Pagination works

### Testing
- [ ] Unit tests: >80% coverage on service
- [ ] Integration tests: All endpoints covered
- [ ] RLS tests: Multi-tenancy verified
- [ ] Permission tests: Role-based access
- [ ] E2E tests: Full workflow passing

### Integration
- [ ] Ready for story 06.13 (NCR Workflow) to extend
- [ ] Source reference supports inspections, holds, batches
- [ ] Assignment structure ready for workflow

---

## Risk Assessment

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Status field confusion (Phase 1 vs Phase 2) | MEDIUM | MEDIUM | Clear migration plan, comments in schema |
| Permission complexity | MEDIUM | LOW | Clear role definitions, comprehensive tests |
| NCR number collision | HIGH | LOW | Database sequence with unique constraint |
| Source reference ambiguity | LOW | MEDIUM | Clear enum values, optional field |
| Performance with many NCRs | MEDIUM | LOW | Proper indexes, pagination |
| Phase 2 migration complexity | MEDIUM | MEDIUM | Plan status enum expansion, keep backward compatible |

---

## Phase 2 Migration Notes

When implementing story 06.13 (NCR Workflow), the following changes will be needed:

1. **Expand status enum**:
   ```sql
   ALTER TABLE ncr_reports
   DROP CONSTRAINT ncr_reports_status_check;

   ALTER TABLE ncr_reports
   ADD CONSTRAINT ncr_reports_status_check
   CHECK (status IN ('draft', 'open', 'investigation', 'root_cause',
                     'corrective_action', 'verification', 'closed', 'reopened'));
   ```

2. **Add workflow fields**:
   ```sql
   ALTER TABLE ncr_reports
   ADD COLUMN workflow_state jsonb,
   ADD COLUMN investigation_notes text,
   ADD COLUMN root_cause text,
   ADD COLUMN corrective_action text,
   ADD COLUMN verification_notes text;
   ```

3. **Create ncr_workflow table** (story 06.13)

4. **Update API endpoints** to support workflow transitions

5. **Frontend**: Add workflow tabs (Investigation, Root Cause, Corrective Action, Verification)

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-12-16 | Initial story creation - Phase 1 Basic NCR | OPUS |

---

**Document Status**: Ready for Implementation
**Created**: 2025-12-16
**Lines**: ~1500
**Complexity**: M (Medium)
**Phase**: 1 (Core Quality - Basic NCR)
