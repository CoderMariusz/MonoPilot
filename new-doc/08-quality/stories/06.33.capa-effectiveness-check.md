# 06.33 - CAPA Effectiveness Check

**Priority**: P1 (Phase 4)
**Story Points**: M (Medium)
**Type**: full-stack
**Phase**: 4 (Advanced Quality)

**State:** ready
**Estimate:** M (2-3 days)
**Primary PRD:** `docs/1-BASELINE/product/modules/quality.md` (FR-QA-017)

---

## Goal

Implement CAPA effectiveness verification checks. After action items are implemented, effectiveness checks validate that the corrective/preventive actions successfully addressed the root cause. Checks are scheduled at 30/60/90 days post-implementation, with results determining final CAPA closure.

---

## User Story

As a **QA Manager**, I want to **schedule and conduct effectiveness checks for completed CAPAs** so that **I can verify actions successfully prevented recurrence**.

---

## Dependencies

- **Requires**: 06.31 CAPA Creation, 06.32 CAPA Action Items
- **Blocks**: None (final story in CAPA workflow)

---

## Database Schema

```sql
CREATE TABLE capa_effectiveness_checks (
    id                      UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id                  UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    capa_id                 UUID NOT NULL REFERENCES capa_records(id) ON DELETE CASCADE,

    check_date              DATE NOT NULL,
    check_method            TEXT NOT NULL CHECK (check_method IN ('data_review', 'audit', 'inspection', 'trend_analysis')),

    result                  TEXT CHECK (result IN ('effective', 'ineffective', 'partially_effective')),
    evidence_url            TEXT,
    notes                   TEXT,

    checked_by              UUID REFERENCES users(id),
    checked_at              TIMESTAMPTZ,

    created_at              TIMESTAMPTZ NOT NULL DEFAULT now(),
    created_by              UUID REFERENCES users(id),
    updated_at              TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE INDEX idx_capa_effectiveness_capa ON capa_effectiveness_checks(capa_id);
CREATE INDEX idx_capa_effectiveness_date ON capa_effectiveness_checks(org_id, check_date);
```

---

## API Endpoints

- **GET** `/api/quality/capa/:capaId/effectiveness-checks` - List checks
- **POST** `/api/quality/capa/:capaId/effectiveness-checks` - Schedule check
- **PUT** `/api/quality/capa/effectiveness-checks/:id` - Update check result
- **POST** `/api/quality/capa/effectiveness-checks/:id/complete` - Complete check
- **POST** `/api/quality/capa/:capaId/reopen` - Reopen if ineffective

---

## Key Features

1. **Scheduled Checks**: Auto-schedule at 30/60/90 days post-implementation
2. **Check Methods**: Data review, Audit, Inspection, Trend analysis
3. **Result Types**: Effective, Ineffective, Partially Effective
4. **Evidence Upload**: Photos, reports, data analysis
5. **Reopen CAPA**: If check fails, reopen CAPA for additional actions
6. **Final Closure**: All checks must pass (effective) before CAPA closure

---

## Acceptance Criteria

### AC-1: Schedule Effectiveness Check

```gherkin
Scenario: Auto-schedule checks on action completion
  Given CAPA with all action items completed
  When last action marked complete
  Then 3 effectiveness checks auto-created:
    | Check Date | Method |
    | +30 days | Data Review |
    | +60 days | Audit |
    | +90 days | Inspection |
```

### AC-2: Complete Effectiveness Check

```gherkin
Scenario: Conduct effectiveness check
  Given effectiveness check scheduled for today
  When QA Manager clicks [Conduct Check]
  And selects result = 'effective'
  And uploads evidence
  And enters notes
  And clicks [Submit]
  Then check.result = 'effective'
  And checked_by = current user
  And checked_at = now
```

### AC-3: Reopen CAPA on Ineffective Result

```gherkin
Scenario: Reopen CAPA if ineffective
  Given effectiveness check result = 'ineffective'
  When QA Manager clicks [Reopen CAPA]
  Then CAPA status changes to 'in_progress'
  And notification sent to owner
  And requires additional action items
```

### AC-4: Final Closure Requires All Checks Passed

```gherkin
Scenario: Block closure if checks pending
  Given CAPA with 2 of 3 checks passed
  And 1 check pending
  When attempting to close CAPA
  Then error: "1 effectiveness check pending"
  And [Close CAPA] disabled
```

---

## Deliverables

- [ ] `capa_effectiveness_checks` table migration
- [ ] Effectiveness check CRUD endpoints (5)
- [ ] EffectivenessCheckService
- [ ] Effectiveness check components
- [ ] Reopen CAPA workflow
- [ ] Unit + integration tests

---

**Complexity**: M (2-3 days)
**Created**: 2026-01-15
