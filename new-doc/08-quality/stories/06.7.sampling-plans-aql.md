# 06.7 - Sampling Plans (AQL)

**Priority**: P0 (MVP)
**Story Points**: M (Medium)
**Type**: backend + frontend

**State:** ready
**Estimate:** M (medium story)
**Primary PRD:** `docs/1-BASELINE/product/modules/quality.md` (FR-QA-008, Section 12)
**Architecture:** `docs/1-BASELINE/architecture/modules/quality.md` (sampling_plans, sampling_records tables)
**UX Wireframes:** QA-007 (Sampling Plans List), QA-008 (Sampling Plan Detail)

## Goal
Implement AQL-based statistical sampling plans using ISO 2859 / ANSI Z1.4 sample size tables, with support for multiple inspection levels (I, II, III, S-1 to S-4), configurable acceptance/rejection criteria, and sample recording during inspections.

## MVP Scope

This story implements Phase 1 (Core Quality) functionality only. Features listed in "Future Phases" are deferred to Phase 2+ and should be handled per Epic 06.0 "Future Feature Handling" guidance.

**MVP Includes**:
- Sampling plans CRUD with AQL configuration
- ISO 2859 / ANSI Z1.4 sample size tables (General Inspection Levels I, II, III)
- Lot size range to sample size mapping
- Acceptance number (Ac) and Rejection number (Re) configuration
- Plan assignment to inspections
- Sample recording during inspection execution
- Sampling plan selection based on lot size

**Deferred to Phase 2+**: See "Future Phases" section below.

## Scope

**In scope**
- GET /api/quality/sampling-plans (list sampling plans)
- POST /api/quality/sampling-plans (create sampling plan)
- GET /api/quality/sampling-plans/:id (get sampling plan detail)
- PUT /api/quality/sampling-plans/:id (update sampling plan)
- DELETE /api/quality/sampling-plans/:id (soft delete/deactivate)
- POST /api/quality/sampling-records (record sample)
- GET /api/quality/sampling-records/inspection/:inspectionId (list samples for inspection)
- Sampling Plans List page (QA-007)
- Sampling Plan Detail/Edit page (QA-008)
- Sampling Plan Selector in Inspection Form
- Sample Recording UI during inspection
- ISO 2859 sample size table reference (General Inspection Levels I, II, III)
- AQL level configuration (0.065, 0.10, 0.15, 0.25, 0.40, 0.65, 1.0, 1.5, 2.5, 4.0, 6.5, 10.0)
- Inspection level configuration (I, II, III)
- Lot size range to sample size mapping

## Future Phases (Not in MVP)

### Phase 2
- **Special Inspection Levels** - S-1, S-2, S-3, S-4 for smaller sample sizes
- **Switching Rules** - Normal/Tightened/Reduced inspection switching based on quality history
- **Sample Type Selection** - Single, Double, Multiple sampling plans
- **Sequential Sampling** - Accept/reject decisions during sampling
- **Sample Location Stratification** - Location-based sampling (e.g., top/middle/bottom of lot)
- **Sample Selection Algorithms** - Random, systematic, stratified sampling methods

### Phase 3
- **Plan Templates** - Reusable sampling plan templates by product category
- **Sample Size Optimization** - Statistical optimization based on defect history
- **Cost-Benefit Analysis** - Sample size vs. inspection cost modeling
- **Sampling Analytics** - Trend analysis of sampling results over time
- **Sampling Plan Effectiveness** - Historical analysis of plan performance

### Deferred to Other Modules
- **CAPA from Sampling Failures** - Quality module story 06.31 (CAPA Creation)
- **Sampling for CCP Monitoring** - Quality module story 06.23 (CCP Monitoring Desktop)
- **Supplier Sampling Plans** - Quality module story 06.34 (Supplier Quality Ratings)

**Implementation**: See Epic 06.0 "Future Feature Handling" for how to handle Phase 2+ features in UI/API.

## Dependencies

### Cross-Epic Dependencies
- **01.1** - Org Context + Base RLS (organizations, users tables)
- **02.1** - Products CRUD (optional product_id filter in sampling plans)
- **06.3** - Product Specifications (sampling plans used in inspections)
- **06.5** - Incoming Inspection (sampling plan assignment)

### Internal Dependencies
- None (this is a standalone Phase 1 story)

## Database Migration

### Migration: Sampling Plans Table

```sql
-- File: supabase/migrations/057_create_sampling_plans_table.sql
CREATE TABLE sampling_plans (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id UUID NOT NULL REFERENCES organizations(id),
    name TEXT NOT NULL,
    description TEXT,
    inspection_type TEXT NOT NULL CHECK (inspection_type IN ('incoming', 'in_process', 'final')),
    product_id UUID REFERENCES products(id),  -- Optional product filter

    -- AQL Configuration (ISO 2859 / ANSI Z1.4)
    aql_level TEXT CHECK (aql_level IN ('I', 'II', 'III')),  -- General Inspection Level
    special_level TEXT CHECK (special_level IN ('S-1', 'S-2', 'S-3', 'S-4')),  -- Special Level (Phase 2)

    -- Lot Size Range
    lot_size_min INTEGER NOT NULL,
    lot_size_max INTEGER NOT NULL,

    -- Sample Size and Acceptance Criteria
    sample_size INTEGER NOT NULL,
    acceptance_number INTEGER NOT NULL,  -- Ac (max defects to accept)
    rejection_number INTEGER NOT NULL,   -- Re (min defects to reject)

    -- Status
    is_active BOOLEAN DEFAULT true,

    -- Audit
    created_at TIMESTAMPTZ DEFAULT now(),
    created_by UUID REFERENCES users(id),
    updated_at TIMESTAMPTZ DEFAULT now(),
    updated_by UUID REFERENCES users(id),

    CONSTRAINT valid_lot_range CHECK (lot_size_min <= lot_size_max),
    CONSTRAINT valid_acceptance CHECK (acceptance_number < rejection_number),
    CONSTRAINT valid_sample_size CHECK (sample_size > 0),
    UNIQUE(org_id, name)
);

-- Indexes
CREATE INDEX idx_sampling_plans_org ON sampling_plans(org_id);
CREATE INDEX idx_sampling_plans_type ON sampling_plans(org_id, inspection_type);
CREATE INDEX idx_sampling_plans_product ON sampling_plans(product_id) WHERE product_id IS NOT NULL;
CREATE INDEX idx_sampling_plans_lot_range ON sampling_plans(org_id, lot_size_min, lot_size_max);
CREATE INDEX idx_sampling_plans_active ON sampling_plans(org_id, is_active);

-- RLS Policies
ALTER TABLE sampling_plans ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Sampling plans org isolation"
ON sampling_plans FOR ALL
USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

-- Comments
COMMENT ON TABLE sampling_plans IS 'AQL-based sampling plans for quality inspections (ISO 2859 / ANSI Z1.4)';
COMMENT ON COLUMN sampling_plans.aql_level IS 'General Inspection Level (I, II, III) - II is most common';
COMMENT ON COLUMN sampling_plans.special_level IS 'Special Inspection Level (S-1 to S-4) for small sample sizes (Phase 2)';
COMMENT ON COLUMN sampling_plans.acceptance_number IS 'Ac - Maximum defects allowed to accept lot';
COMMENT ON COLUMN sampling_plans.rejection_number IS 'Re - Minimum defects to reject lot';
```

### Migration: Sampling Records Table

```sql
-- File: supabase/migrations/058_create_sampling_records_table.sql
CREATE TABLE sampling_records (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id UUID NOT NULL REFERENCES organizations(id),
    plan_id UUID NOT NULL REFERENCES sampling_plans(id),
    inspection_id UUID NOT NULL REFERENCES quality_inspections(id),

    -- Sample Identification
    sample_identifier TEXT NOT NULL,  -- e.g., "S-001", "S-002"
    location_description TEXT,  -- e.g., "Top layer, pallet 3", "Box 5 of 20"

    -- Sampling Details
    sampled_by UUID NOT NULL REFERENCES users(id),
    sampled_at TIMESTAMPTZ DEFAULT now(),
    notes TEXT,

    -- Audit
    created_at TIMESTAMPTZ DEFAULT now(),

    UNIQUE(inspection_id, sample_identifier)
);

-- Indexes
CREATE INDEX idx_sampling_records_org ON sampling_records(org_id);
CREATE INDEX idx_sampling_records_plan ON sampling_records(plan_id);
CREATE INDEX idx_sampling_records_inspection ON sampling_records(inspection_id);
CREATE INDEX idx_sampling_records_sampled_at ON sampling_records(sampled_at);

-- RLS Policies
ALTER TABLE sampling_records ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Sampling records org isolation"
ON sampling_records FOR ALL
USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

-- Comments
COMMENT ON TABLE sampling_records IS 'Individual sample records taken during inspections';
COMMENT ON COLUMN sampling_records.sample_identifier IS 'Unique sample ID within inspection (e.g., S-001, S-002)';
COMMENT ON COLUMN sampling_records.location_description IS 'Physical location where sample was taken (e.g., top/middle/bottom of lot)';
```

### ISO 2859 Sample Size Reference Table (Seed Data)

```sql
-- File: supabase/migrations/059_seed_iso_2859_sample_sizes.sql
-- This is a reference table for ISO 2859 sample sizes (General Inspection Level II, AQL 2.5)
-- Users can create custom sampling plans using these guidelines

CREATE TABLE IF NOT EXISTS iso_2859_reference (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    lot_size_min INTEGER NOT NULL,
    lot_size_max INTEGER NOT NULL,
    sample_size_code TEXT NOT NULL,  -- A, B, C, D, E, F, G, H, J, K, L, M, N, P, Q, R
    inspection_level TEXT NOT NULL CHECK (inspection_level IN ('I', 'II', 'III')),
    sample_size INTEGER NOT NULL,
    aql_065 JSONB,  -- {Ac: 0, Re: 1}
    aql_10 JSONB,
    aql_15 JSONB,
    aql_25 JSONB,
    aql_40 JSONB,
    aql_65 JSONB,
    aql_100 JSONB,
    aql_150 JSONB,
    aql_250 JSONB,
    aql_400 JSONB,
    aql_650 JSONB,
    aql_1000 JSONB
);

-- Insert ISO 2859 Sample Size Table (General Inspection Level II)
INSERT INTO iso_2859_reference (lot_size_min, lot_size_max, sample_size_code, inspection_level, sample_size, aql_065, aql_10, aql_15, aql_25, aql_40, aql_65, aql_100, aql_150, aql_250, aql_400, aql_650, aql_1000) VALUES
(2, 8, 'A', 'II', 2, '{"Ac": 0, "Re": 1}', '{"Ac": 0, "Re": 1}', '{"Ac": 0, "Re": 1}', '{"Ac": 0, "Re": 1}', '{"Ac": 0, "Re": 1}', '{"Ac": 0, "Re": 1}', '{"Ac": 0, "Re": 1}', '{"Ac": 0, "Re": 1}', '{"Ac": 1, "Re": 2}', '{"Ac": 1, "Re": 2}', '{"Ac": 2, "Re": 3}', '{"Ac": 3, "Re": 4}'),
(9, 15, 'A', 'II', 2, '{"Ac": 0, "Re": 1}', '{"Ac": 0, "Re": 1}', '{"Ac": 0, "Re": 1}', '{"Ac": 0, "Re": 1}', '{"Ac": 0, "Re": 1}', '{"Ac": 0, "Re": 1}', '{"Ac": 0, "Re": 1}', '{"Ac": 0, "Re": 1}', '{"Ac": 1, "Re": 2}', '{"Ac": 1, "Re": 2}', '{"Ac": 2, "Re": 3}', '{"Ac": 3, "Re": 4}'),
(16, 25, 'B', 'II', 3, '{"Ac": 0, "Re": 1}', '{"Ac": 0, "Re": 1}', '{"Ac": 0, "Re": 1}', '{"Ac": 0, "Re": 1}', '{"Ac": 0, "Re": 1}', '{"Ac": 0, "Re": 1}', '{"Ac": 0, "Re": 1}', '{"Ac": 1, "Re": 2}', '{"Ac": 1, "Re": 2}', '{"Ac": 2, "Re": 3}', '{"Ac": 3, "Re": 4}', '{"Ac": 5, "Re": 6}'),
(26, 50, 'C', 'II', 5, '{"Ac": 0, "Re": 1}', '{"Ac": 0, "Re": 1}', '{"Ac": 0, "Re": 1}', '{"Ac": 0, "Re": 1}', '{"Ac": 0, "Re": 1}', '{"Ac": 0, "Re": 1}', '{"Ac": 1, "Re": 2}', '{"Ac": 1, "Re": 2}', '{"Ac": 2, "Re": 3}', '{"Ac": 3, "Re": 4}', '{"Ac": 5, "Re": 6}', '{"Ac": 7, "Re": 8}'),
(51, 90, 'D', 'II', 8, '{"Ac": 0, "Re": 1}', '{"Ac": 0, "Re": 1}', '{"Ac": 0, "Re": 1}', '{"Ac": 0, "Re": 1}', '{"Ac": 0, "Re": 1}', '{"Ac": 1, "Re": 2}', '{"Ac": 1, "Re": 2}', '{"Ac": 2, "Re": 3}', '{"Ac": 3, "Re": 4}', '{"Ac": 5, "Re": 6}', '{"Ac": 7, "Re": 8}', '{"Ac": 10, "Re": 11}'),
(91, 150, 'E', 'II', 13, '{"Ac": 0, "Re": 1}', '{"Ac": 0, "Re": 1}', '{"Ac": 0, "Re": 1}', '{"Ac": 0, "Re": 1}', '{"Ac": 1, "Re": 2}', '{"Ac": 1, "Re": 2}', '{"Ac": 2, "Re": 3}', '{"Ac": 3, "Re": 4}', '{"Ac": 5, "Re": 6}', '{"Ac": 7, "Re": 8}', '{"Ac": 10, "Re": 11}', '{"Ac": 14, "Re": 15}'),
(151, 280, 'F', 'II', 20, '{"Ac": 0, "Re": 1}', '{"Ac": 0, "Re": 1}', '{"Ac": 0, "Re": 1}', '{"Ac": 1, "Re": 2}', '{"Ac": 1, "Re": 2}', '{"Ac": 2, "Re": 3}', '{"Ac": 3, "Re": 4}', '{"Ac": 5, "Re": 6}', '{"Ac": 7, "Re": 8}', '{"Ac": 10, "Re": 11}', '{"Ac": 14, "Re": 15}', '{"Ac": 21, "Re": 22}'),
(281, 500, 'G', 'II', 32, '{"Ac": 0, "Re": 1}', '{"Ac": 0, "Re": 1}', '{"Ac": 1, "Re": 2}', '{"Ac": 1, "Re": 2}', '{"Ac": 2, "Re": 3}', '{"Ac": 3, "Re": 4}', '{"Ac": 5, "Re": 6}', '{"Ac": 7, "Re": 8}', '{"Ac": 10, "Re": 11}', '{"Ac": 14, "Re": 15}', '{"Ac": 21, "Re": 22}', '{"Ac": 21, "Re": 22}'),
(501, 1200, 'H', 'II', 50, '{"Ac": 0, "Re": 1}', '{"Ac": 1, "Re": 2}', '{"Ac": 1, "Re": 2}', '{"Ac": 2, "Re": 3}', '{"Ac": 3, "Re": 4}', '{"Ac": 5, "Re": 6}', '{"Ac": 7, "Re": 8}', '{"Ac": 10, "Re": 11}', '{"Ac": 14, "Re": 15}', '{"Ac": 21, "Re": 22}', '{"Ac": 21, "Re": 22}', '{"Ac": 21, "Re": 22}'),
(1201, 3200, 'J', 'II', 80, '{"Ac": 1, "Re": 2}', '{"Ac": 1, "Re": 2}', '{"Ac": 2, "Re": 3}', '{"Ac": 3, "Re": 4}', '{"Ac": 5, "Re": 6}', '{"Ac": 7, "Re": 8}', '{"Ac": 10, "Re": 11}', '{"Ac": 14, "Re": 15}', '{"Ac": 21, "Re": 22}', '{"Ac": 21, "Re": 22}', '{"Ac": 21, "Re": 22}', '{"Ac": 21, "Re": 22}'),
(3201, 10000, 'K', 'II', 125, '{"Ac": 1, "Re": 2}', '{"Ac": 2, "Re": 3}', '{"Ac": 3, "Re": 4}', '{"Ac": 5, "Re": 6}', '{"Ac": 7, "Re": 8}', '{"Ac": 10, "Re": 11}', '{"Ac": 14, "Re": 15}', '{"Ac": 21, "Re": 22}', '{"Ac": 21, "Re": 22}', '{"Ac": 21, "Re": 22}', '{"Ac": 21, "Re": 22}', '{"Ac": 21, "Re": 22}'),
(10001, 35000, 'L', 'II', 200, '{"Ac": 2, "Re": 3}', '{"Ac": 3, "Re": 4}', '{"Ac": 5, "Re": 6}', '{"Ac": 7, "Re": 8}', '{"Ac": 10, "Re": 11}', '{"Ac": 14, "Re": 15}', '{"Ac": 21, "Re": 22}', '{"Ac": 21, "Re": 22}', '{"Ac": 21, "Re": 22}', '{"Ac": 21, "Re": 22}', '{"Ac": 21, "Re": 22}', '{"Ac": 21, "Re": 22}'),
(35001, 150000, 'M', 'II', 315, '{"Ac": 3, "Re": 4}', '{"Ac": 5, "Re": 6}', '{"Ac": 7, "Re": 8}', '{"Ac": 10, "Re": 11}', '{"Ac": 14, "Re": 15}', '{"Ac": 21, "Re": 22}', '{"Ac": 21, "Re": 22}', '{"Ac": 21, "Re": 22}', '{"Ac": 21, "Re": 22}', '{"Ac": 21, "Re": 22}', '{"Ac": 21, "Re": 22}', '{"Ac": 21, "Re": 22}'),
(150001, 500000, 'N', 'II', 500, '{"Ac": 5, "Re": 6}', '{"Ac": 7, "Re": 8}', '{"Ac": 10, "Re": 11}', '{"Ac": 14, "Re": 15}', '{"Ac": 21, "Re": 22}', '{"Ac": 21, "Re": 22}', '{"Ac": 21, "Re": 22}', '{"Ac": 21, "Re": 22}', '{"Ac": 21, "Re": 22}', '{"Ac": 21, "Re": 22}', '{"Ac": 21, "Re": 22}', '{"Ac": 21, "Re": 22}'),
(500001, 999999999, 'P', 'II', 800, '{"Ac": 7, "Re": 8}', '{"Ac": 10, "Re": 11}', '{"Ac": 14, "Re": 15}', '{"Ac": 21, "Re": 22}', '{"Ac": 21, "Re": 22}', '{"Ac": 21, "Re": 22}', '{"Ac": 21, "Re": 22}', '{"Ac": 21, "Re": 22}', '{"Ac": 21, "Re": 22}', '{"Ac": 21, "Re": 22}', '{"Ac": 21, "Re": 22}', '{"Ac": 21, "Re": 22}');

COMMENT ON TABLE iso_2859_reference IS 'ISO 2859 / ANSI Z1.4 sample size reference table (read-only)';
```

## Acceptance Criteria (Given/When/Then)

### AC-7.1: Sampling Plans List Display
- GIVEN user navigates to Quality > Sampling Plans, WHEN page loads, THEN sampling plans list displays within 500ms showing name, inspection type, lot size range, sample size, Ac/Re numbers, and active status.
- GIVEN org has 50+ sampling plans, WHEN list renders, THEN plans are paginated (20 per page) with search by name and filter by inspection type.
- GIVEN user filters by inspection_type='incoming', WHEN filter applied, THEN only incoming inspection plans display.
- GIVEN user searches for plan name "Raw Material AQL 2.5", WHEN search term entered, THEN matching plans display within 300ms.

### AC-7.2: Create Sampling Plan
- GIVEN user clicks [+ New Sampling Plan], WHEN form opens, THEN fields display: name, description, inspection_type, product (optional), aql_level, lot_size_min, lot_size_max, sample_size, acceptance_number, rejection_number.
- GIVEN user enters name "Incoming RM Level II", inspection_type='incoming', aql_level='II', lot_size_min=50, lot_size_max=90, sample_size=8, Ac=1, Re=2, WHEN [Save] clicked, THEN plan created with is_active=true.
- GIVEN user enters lot_size_min=100 and lot_size_max=50, WHEN [Save] clicked, THEN validation error "Lot size min must be <= max" displays.
- GIVEN user enters Ac=5 and Re=3, WHEN [Save] clicked, THEN validation error "Acceptance number must be < rejection number" displays.
- GIVEN user enters sample_size=0, WHEN [Save] clicked, THEN validation error "Sample size must be > 0" displays.

### AC-7.3: Edit Sampling Plan
- GIVEN user clicks [Edit] on existing plan, WHEN form opens, THEN all fields pre-populated with current values.
- GIVEN user changes sample_size from 8 to 13, WHEN [Save] clicked, THEN plan updated with new sample size.
- GIVEN sampling plan is assigned to 5 active inspections, WHEN user tries to delete, THEN warning "This plan is used by 5 inspections. Deactivate instead?" displays.
- GIVEN user deactivates plan (is_active=false), WHEN plan list reloads, THEN plan shows "Inactive" badge but remains in list.

### AC-7.4: ISO 2859 Reference Helper
- GIVEN user is creating sampling plan, WHEN form displays, THEN [View ISO 2859 Table] button shows.
- GIVEN user clicks [View ISO 2859 Table], WHEN modal opens, THEN ISO 2859 sample size reference table displays with columns: Lot Size Range, Sample Size Code, Sample Size, AQL 2.5 (Ac/Re).
- GIVEN user selects lot size range 51-90 from table, WHEN [Apply] clicked, THEN form auto-fills: sample_size=8, acceptance_number=1, rejection_number=2.
- GIVEN user selects lot size 151-280 and AQL 1.5, WHEN [Apply] clicked, THEN form auto-fills sample_size=20, Ac=1, Re=2.

### AC-7.5: Sampling Plan Assignment to Inspection
- GIVEN user is creating incoming inspection with lot_size=75, WHEN inspection form loads, THEN sampling plan dropdown shows plans where lot_size_min <= 75 <= lot_size_max AND inspection_type='incoming'.
- GIVEN user selects sampling plan "RM Level II (50-90)", WHEN plan selected, THEN inspection.sample_size auto-fills with plan.sample_size (8).
- GIVEN user creates inspection without sampling plan, WHEN inspection saved, THEN sampling_plan_id=null and sample_size=0 (manual sampling).
- GIVEN inspection has sampling plan assigned, WHEN inspection detail loads, THEN sampling plan details display (name, Ac/Re, sample size).

### AC-7.6: Sample Recording During Inspection
- GIVEN user starts inspection with sampling_plan_id set, WHEN sample recording section loads, THEN sample counter shows "0 / 8 samples recorded".
- GIVEN user clicks [+ Record Sample], WHEN modal opens, THEN fields display: sample_identifier (auto-increment S-001, S-002), location_description, notes.
- GIVEN user records sample S-001 with location="Top layer, pallet 1", WHEN [Save] clicked, THEN sampling_records row inserted with sampled_by=current_user, sampled_at=now().
- GIVEN user records 8 samples (matches plan.sample_size), WHEN last sample saved, THEN sample counter shows "8 / 8" and inspection can proceed to completion.
- GIVEN user records 5 samples out of 8 required, WHEN user tries to complete inspection, THEN warning "Only 5 of 8 samples recorded. Proceed anyway?" displays.

### AC-7.7: Sample List Display in Inspection Detail
- GIVEN inspection has 8 sampling_records, WHEN inspection detail page loads, THEN "Samples" tab displays list with columns: sample_identifier, location_description, sampled_by, sampled_at, notes.
- GIVEN user views inspection with sampling_records, WHEN samples list renders, THEN samples sorted by sampled_at ASC (chronological order).
- GIVEN user views inspection without sampling plan, WHEN "Samples" tab accessed, THEN empty state "No sampling plan assigned" displays.

### AC-7.8: Permission Enforcement
- GIVEN user with VIEWER role, WHEN Sampling Plans page loads, THEN [+ New Sampling Plan] button hidden.
- GIVEN user with QA Inspector role, WHEN viewing sampling plan, THEN [Edit] and [Delete] buttons hidden (read-only access).
- GIVEN user with QA Manager role, WHEN viewing sampling plan, THEN [Edit] and [Delete] buttons visible.
- GIVEN user without Technical write permission, WHEN attempting POST /api/quality/sampling-plans, THEN API returns 403 Forbidden.

### AC-7.9: Future Features Handling (Phase 2+)

**GIVEN** user is creating/editing sampling plan
**WHEN** MVP is active (Phase 1)
**THEN** the following Phase 2+ features are HIDDEN:
  - "Special Inspection Level" dropdown (S-1 to S-4)
  - "Switching Rule" configuration (Normal/Tightened/Reduced)
  - "Sample Type" selector (Single/Double/Multiple)
  - "Sample Location Stratification" settings
  - "Sequential Sampling" options
  - "Plan Templates" selector

**Developer Implementation** (per Epic 06.0 guidance):

**Hide completely** (Recommended):
```typescript
{/* Phase 2: Special Inspection Levels
<div className="space-y-2">
  <Label>Special Inspection Level</Label>
  <Select>
    <SelectTrigger>
      <SelectValue placeholder="Select special level" />
    </SelectTrigger>
    <SelectContent>
      <SelectItem value="S-1">S-1 (Smallest sample)</SelectItem>
      <SelectItem value="S-2">S-2</SelectItem>
      <SelectItem value="S-3">S-3</SelectItem>
      <SelectItem value="S-4">S-4</SelectItem>
    </SelectContent>
  </Select>
</div>
*/}

{/* Phase 2: Switching Rules
<div className="space-y-2">
  <Label>Switching Rule</Label>
  <Select>
    <SelectTrigger>
      <SelectValue placeholder="Normal inspection" />
    </SelectTrigger>
    <SelectContent>
      <SelectItem value="normal">Normal Inspection</SelectItem>
      <SelectItem value="tightened">Tightened Inspection (Coming Soon)</SelectItem>
      <SelectItem value="reduced">Reduced Inspection (Coming Soon)</SelectItem>
    </SelectContent>
  </Select>
</div>
*/}

{/* Phase 2: Sample Type
<div className="space-y-2">
  <Label>Sample Type</Label>
  <RadioGroup defaultValue="single">
    <div className="flex items-center space-x-2">
      <RadioGroupItem value="single" id="single" />
      <Label htmlFor="single">Single Sampling</Label>
    </div>
    <div className="flex items-center space-x-2 opacity-50">
      <RadioGroupItem value="double" id="double" disabled />
      <Label htmlFor="double">Double Sampling (Phase 2)</Label>
    </div>
    <div className="flex items-center space-x-2 opacity-50">
      <RadioGroupItem value="multiple" id="multiple" disabled />
      <Label htmlFor="multiple">Multiple Sampling (Phase 2)</Label>
    </div>
  </RadioGroup>
</div>
*/}
```

**Show as Coming Soon** (Alternative):
```typescript
<Tooltip content="Special inspection levels available in Phase 2">
  <Button disabled className="opacity-50">
    <Lock className="w-4 h-4 mr-2" />
    Configure Special Level (Phase 2)
  </Button>
</Tooltip>
```

**API Endpoints** (Phase 2 - return 501 in MVP):
```typescript
// Phase 2 - Not implemented in MVP
router.get('/api/quality/sampling-plans/templates', (req, res) => {
  res.status(501).json({
    error: 'Not Implemented',
    message: 'Sampling plan templates available in Phase 2',
    availableIn: 'v1.2 (Q3 2025)'
  });
});
```

**Validation**:
- Sampling plan form shows only General Inspection Levels (I, II, III)
- No special_level field visible in MVP
- Single sampling type only (no double/multiple)
- Clean UI without switching rules

## Implementation Notes

### API Endpoints

```typescript
// GET /api/quality/sampling-plans
// Returns: List of sampling plans for current org
interface SamplingPlansListResponse {
  sampling_plans: SamplingPlanSummary[];
  total: number;
  page: number;
  page_size: number;
}

interface SamplingPlanSummary {
  id: string;
  name: string;
  description: string;
  inspection_type: 'incoming' | 'in_process' | 'final';
  product_id: string | null;
  product_name: string | null;
  aql_level: 'I' | 'II' | 'III' | null;
  lot_size_min: number;
  lot_size_max: number;
  sample_size: number;
  acceptance_number: number;
  rejection_number: number;
  is_active: boolean;
  created_at: string;
}

// GET /api/quality/sampling-plans/:id
// Returns: Sampling plan detail
interface SamplingPlanDetailResponse {
  sampling_plan: SamplingPlan;
}

interface SamplingPlan {
  id: string;
  org_id: string;
  name: string;
  description: string | null;
  inspection_type: 'incoming' | 'in_process' | 'final';
  product_id: string | null;
  aql_level: 'I' | 'II' | 'III' | null;
  special_level: 'S-1' | 'S-2' | 'S-3' | 'S-4' | null;  // Phase 2
  lot_size_min: number;
  lot_size_max: number;
  sample_size: number;
  acceptance_number: number;
  rejection_number: number;
  is_active: boolean;
  created_at: string;
  created_by: string;
  updated_at: string;
  updated_by: string;
}

// POST /api/quality/sampling-plans
interface CreateSamplingPlanRequest {
  name: string;
  description?: string;
  inspection_type: 'incoming' | 'in_process' | 'final';
  product_id?: string;
  aql_level?: 'I' | 'II' | 'III';
  lot_size_min: number;
  lot_size_max: number;
  sample_size: number;
  acceptance_number: number;
  rejection_number: number;
}

// PUT /api/quality/sampling-plans/:id
// Same as CreateSamplingPlanRequest + is_active

// POST /api/quality/sampling-records
interface CreateSamplingRecordRequest {
  plan_id: string;
  inspection_id: string;
  sample_identifier: string;  // Auto-generated or user-provided
  location_description?: string;
  notes?: string;
}

// GET /api/quality/sampling-records/inspection/:inspectionId
interface SamplingRecordsListResponse {
  sampling_records: SamplingRecord[];
  total_samples: number;
  required_samples: number;  // From sampling_plan.sample_size
}

interface SamplingRecord {
  id: string;
  plan_id: string;
  inspection_id: string;
  sample_identifier: string;
  location_description: string | null;
  sampled_by: string;
  sampled_by_name: string;
  sampled_at: string;
  notes: string | null;
}

// GET /api/quality/iso-2859-reference
// Returns: ISO 2859 sample size reference table
interface ISO2859ReferenceResponse {
  reference_table: ISO2859Entry[];
}

interface ISO2859Entry {
  lot_size_min: number;
  lot_size_max: number;
  sample_size_code: string;
  inspection_level: 'I' | 'II' | 'III';
  sample_size: number;
  aql_065: { Ac: number; Re: number };
  aql_10: { Ac: number; Re: number };
  aql_15: { Ac: number; Re: number };
  aql_25: { Ac: number; Re: number };
  aql_40: { Ac: number; Re: number };
  aql_65: { Ac: number; Re: number };
  aql_100: { Ac: number; Re: number };
  aql_150: { Ac: number; Re: number };
  aql_250: { Ac: number; Re: number };
  aql_400: { Ac: number; Re: number };
  aql_650: { Ac: number; Re: number };
  aql_1000: { Ac: number; Re: number };
}
```

### Frontend Components

- `SamplingPlansList` - List of sampling plans with filters (QA-007)
- `SamplingPlanForm` - Create/edit sampling plan form (QA-008)
- `ISO2859TableModal` - ISO 2859 reference table modal with auto-fill
- `SamplingPlanSelector` - Dropdown for selecting plan in inspection form
- `SampleRecordingForm` - Modal for recording individual samples
- `SamplesList` - List of recorded samples in inspection detail
- `SamplingProgressBar` - Visual indicator of samples recorded vs. required

### Services

- `sampling-plan-service.ts` - CRUD operations for sampling plans
- `sampling-record-service.ts` - Sample recording operations
- `iso-2859-service.ts` - ISO 2859 reference table queries and helper functions

### Validation (Zod)

```typescript
const createSamplingPlanSchema = z.object({
  name: z.string().min(3, 'Name must be at least 3 characters').max(200),
  description: z.string().max(1000).optional(),
  inspection_type: z.enum(['incoming', 'in_process', 'final']),
  product_id: z.string().uuid('Invalid product').optional(),
  aql_level: z.enum(['I', 'II', 'III']).optional(),
  lot_size_min: z.number().int().positive('Lot size min must be positive'),
  lot_size_max: z.number().int().positive('Lot size max must be positive'),
  sample_size: z.number().int().positive('Sample size must be > 0'),
  acceptance_number: z.number().int().nonnegative('Acceptance number must be >= 0'),
  rejection_number: z.number().int().positive('Rejection number must be > 0'),
}).refine(
  (data) => data.lot_size_min <= data.lot_size_max,
  { message: 'Lot size min must be <= max', path: ['lot_size_max'] }
).refine(
  (data) => data.acceptance_number < data.rejection_number,
  { message: 'Acceptance number must be < rejection number', path: ['rejection_number'] }
);

const createSamplingRecordSchema = z.object({
  plan_id: z.string().uuid('Invalid sampling plan'),
  inspection_id: z.string().uuid('Invalid inspection'),
  sample_identifier: z.string().min(1, 'Sample identifier required').max(50),
  location_description: z.string().max(500).optional(),
  notes: z.string().max(1000).optional(),
});
```

### Business Logic

**Auto-select sampling plan for inspection:**
```typescript
async function selectSamplingPlanForInspection(
  inspectionType: 'incoming' | 'in_process' | 'final',
  lotSize: number,
  productId?: string
): Promise<SamplingPlan | null> {
  // 1. Query sampling plans where:
  //    - inspection_type = inspectionType
  //    - lot_size_min <= lotSize <= lot_size_max
  //    - product_id IS NULL OR product_id = productId (product filter optional)
  //    - is_active = true
  // 2. If multiple plans match, prefer product-specific plan
  // 3. If no product-specific plan, use generic plan
  // 4. Return plan or null if no match
}
```

**Auto-generate sample identifier:**
```typescript
async function generateSampleIdentifier(inspectionId: string): Promise<string> {
  // 1. Count existing sampling_records for inspection
  // 2. Return `S-${count + 1}` (e.g., S-001, S-002, ...)
  // 3. Handle concurrent inserts with UNIQUE constraint
}
```

**Determine inspection result based on defects and sampling plan:**
```typescript
function determineInspectionResult(
  defectsFound: number,
  acceptanceNumber: number,
  rejectionNumber: number
): 'pass' | 'fail' | 'conditional' {
  if (defectsFound <= acceptanceNumber) {
    return 'pass';
  } else if (defectsFound >= rejectionNumber) {
    return 'fail';
  } else {
    return 'conditional';  // Between Ac and Re (edge case)
  }
}
```

## Deliverables

- Migration: `sampling_plans` table with RLS policies
- Migration: `sampling_records` table with RLS policies
- Migration: `iso_2859_reference` table with seed data (General Inspection Level II)
- API routes for sampling plan CRUD
- API routes for sampling record creation and listing
- API endpoint for ISO 2859 reference table query
- Sampling Plans List page (QA-007)
- Sampling Plan Form page (QA-008)
- ISO 2859 Reference Table modal
- Sampling Plan Selector component (in inspection form)
- Sample Recording modal
- Samples List component (in inspection detail)
- Zod validation schemas
- Unit tests for sampling plan service
- Unit tests for ISO 2859 helper functions
- Integration tests for API endpoints

## Test Strategy

### Unit Tests
- `sampling-plan-service.ts` - CRUD operations (>90% coverage)
- `iso-2859-service.ts` - Reference table queries and auto-fill logic (>90% coverage)
- `determineInspectionResult()` - Pass/fail logic based on Ac/Re
- Validation schemas for edge cases (lot_size_min > lot_size_max, Ac >= Re)

### Integration Tests
- GET /api/quality/sampling-plans - List with filters
- POST /api/quality/sampling-plans - Create with validation
- PUT /api/quality/sampling-plans/:id - Update plan
- DELETE /api/quality/sampling-plans/:id - Deactivate plan
- POST /api/quality/sampling-records - Record sample
- GET /api/quality/sampling-records/inspection/:id - List samples

### E2E Tests (Playwright)
- Create sampling plan with ISO 2859 auto-fill
- Assign sampling plan to inspection based on lot size
- Record 8 samples during inspection
- Attempt to complete inspection with insufficient samples
- View sampling records in inspection detail

## Definition of Done

- [ ] `sampling_plans` table created with RLS policies
- [ ] `sampling_records` table created with RLS policies
- [ ] `iso_2859_reference` table seeded with General Inspection Level II data (15 lot size ranges)
- [ ] GET /api/quality/sampling-plans returns list within 500ms
- [ ] POST /api/quality/sampling-plans creates plan with validation
- [ ] ISO 2859 reference table modal displays and auto-fills form
- [ ] Sampling plan selector in inspection form filters by lot size and inspection type
- [ ] Sample recording modal saves sampling_records with auto-generated identifier
- [ ] Samples list displays in inspection detail (chronological order)
- [ ] Sample counter shows "X / Y samples recorded" during inspection
- [ ] Validation prevents lot_size_min > lot_size_max
- [ ] Validation prevents Ac >= Re
- [ ] Permission checks hide/show UI elements correctly
- [ ] API returns 403 for unauthorized users
- [ ] Phase 2+ features (special levels, switching rules) hidden per Epic 06.0 guidance
- [ ] Unit tests cover sampling plan service (>90% coverage)
- [ ] Unit tests cover ISO 2859 helper functions (>90% coverage)
- [ ] Integration tests cover all API endpoints
- [ ] E2E tests cover sampling plan creation and sample recording workflow
