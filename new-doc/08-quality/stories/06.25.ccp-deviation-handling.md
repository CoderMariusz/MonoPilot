# 06.25 - CCP Deviation Handling

**Priority**: P0 (MVP)
**Story Points**: M (Medium)
**Type**: backend
**Phase**: 3 (HACCP)
**Model**: OPUS

**State:** ready
**Estimate:** M (3-4 days)
**Primary PRD:** `docs/1-BASELINE/product/modules/quality.md` (FR-QA-015, Section 6.5)

---

## Goal

Implement CCP deviation record creation and handling workflow. When CCP monitoring detects out-of-spec values (result='fail'), system automatically creates deviation records with severity classification (Critical/Major/Minor), links to NCR if critical, and tracks corrective actions through resolution workflow.

---

## Food Safety Compliance

This story is **CRITICAL for food safety compliance**:

- [x] **HACCP Compliance** - Deviation records required for HACCP audits
- [x] **FDA FSMA** - Documented corrective actions for CCP deviations mandatory
- [x] **Audit Trail Required** - All deviation actions logged with timestamps
- [x] **Traceability** - Link deviation to monitoring record, WO, batch, LP

**Regulatory Context:**
- HACCP Principle 5: Establish corrective actions for CCP deviations
- FDA FSMA requires documented corrective actions within defined timeframes
- Critical deviations must trigger immediate action (stop production)
- All deviation records retained for minimum 5 years

---

## MVP Scope

**MVP Includes**:
- `haccp_ccp_deviations` table with deviation record fields
- Auto-create deviation on monitoring result='fail' (hook from story 06.23)
- Deviation severity classification (Critical/Major/Minor based on % over limit)
- Corrective action required (from monitoring record or additional action)
- Link to NCR if severity='critical' (auto-create NCR, story 06.9 integration)
- Deviation resolution workflow (open -> investigating -> resolved -> verified)
- Deviation history view (all deviations for CCP, WO, batch)
- Deviation detail page
- Integration with CCP monitoring (stories 06.23/06.24)

**Deferred to Phase 3+**:
- Deviation trend analysis
- Automated deviation resolution suggestions
- Deviation cost tracking
- Deviation pareto charts

---

## User Story

As a **QA Manager**, I want to **automatically create deviation records when CCPs fail and track corrective actions through resolution** so that **I ensure all CCP deviations are documented and resolved per HACCP requirements**.

---

## Database Migration

### Migration: Create haccp_ccp_deviations table

```sql
-- Migration: YYYYMMDDHHMMSS_create_haccp_ccp_deviations.sql

CREATE TABLE haccp_ccp_deviations (
    id                      UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id                  UUID NOT NULL REFERENCES organizations(id),

    -- CCP Monitoring Reference
    ccp_monitoring_id       UUID NOT NULL REFERENCES haccp_ccp_monitoring(id),
    ccp_id                  UUID NOT NULL REFERENCES haccp_ccp(id),
    ccp_number              TEXT NOT NULL,

    -- Deviation Classification
    severity                TEXT NOT NULL
                            CHECK (severity IN ('critical', 'major', 'minor')),
    deviation_type          TEXT NOT NULL DEFAULT 'out_of_spec'
                            CHECK (deviation_type IN ('out_of_spec', 'equipment_failure', 'procedure_violation')),

    -- Deviation Details
    monitored_value         NUMERIC NOT NULL,
    critical_limit_min      NUMERIC,
    critical_limit_max      NUMERIC,
    deviation_amount        NUMERIC, -- How much over/under limit
    deviation_percentage    NUMERIC, -- % deviation from limit

    -- Work Order and Batch Context
    wo_id                   UUID REFERENCES work_orders(id),
    batch_number            TEXT,
    lp_id                   UUID REFERENCES license_plates(id),

    -- Corrective Action
    corrective_action       TEXT NOT NULL, -- From monitoring or additional
    corrective_action_by    UUID REFERENCES users(id),
    corrective_action_at    TIMESTAMPTZ,

    -- Resolution Workflow
    status                  TEXT NOT NULL DEFAULT 'open'
                            CHECK (status IN ('open', 'investigating', 'resolved', 'verified', 'closed')),
    resolution_notes        TEXT,
    resolved_by             UUID REFERENCES users(id),
    resolved_at             TIMESTAMPTZ,
    verified_by             UUID REFERENCES users(id),
    verified_at             TIMESTAMPTZ,

    -- NCR Linkage (if critical)
    ncr_id                  UUID REFERENCES ncr_reports(id),

    -- Audit
    created_at              TIMESTAMPTZ NOT NULL DEFAULT now(),
    created_by              UUID REFERENCES users(id),
    updated_at              TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE INDEX idx_ccp_deviations_org ON haccp_ccp_deviations(org_id);
CREATE INDEX idx_ccp_deviations_ccp ON haccp_ccp_deviations(ccp_id);
CREATE INDEX idx_ccp_deviations_monitoring ON haccp_ccp_deviations(ccp_monitoring_id);
CREATE INDEX idx_ccp_deviations_severity ON haccp_ccp_deviations(org_id, severity);
CREATE INDEX idx_ccp_deviations_status ON haccp_ccp_deviations(org_id, status);
CREATE INDEX idx_ccp_deviations_open ON haccp_ccp_deviations(org_id, status)
    WHERE status IN ('open', 'investigating');

ALTER TABLE haccp_ccp_deviations ENABLE ROW LEVEL SECURITY;

CREATE POLICY "ccp_deviations_org" ON haccp_ccp_deviations
    FOR ALL TO authenticated
    USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));
```

---

## Acceptance Criteria (Condensed)

### AC-1: Auto-Create Deviation on Monitoring Fail
```gherkin
Given CCP monitoring result = 'fail'
When monitoring record created (story 06.23)
Then deviation record auto-created with:
  - severity = determine_severity(deviation_amount)
  - corrective_action = from monitoring.corrective_action_taken
  - status = 'open'
And if severity='critical', NCR auto-created
```

### AC-2: Deviation Severity Classification
```gherkin
Given CCP with limits 0-4째C
When value = 10째C (150% over limit)
Then severity = 'critical'

When value = 5.5째C (37.5% over limit)
Then severity = 'major'

When value = 4.5째C (12.5% over limit)
Then severity = 'minor'
```

### AC-3: Deviation Resolution Workflow
```gherkin
Given deviation with status='open'
When QA Manager clicks [Investigate]
Then status = 'investigating'

When resolution_notes entered and [Resolve] clicked
Then status = 'resolved'
And resolved_by = current user
And resolved_at = now

When QA Director verifies
Then status = 'verified'
And verified_by = current user
```

### AC-4: Link to NCR on Critical Deviation
```gherkin
Given deviation severity='critical'
When deviation created
Then NCR auto-created with:
  - source = 'ccp_deviation'
  - source_id = deviation.id
  - severity = 'critical'
And ncr_id linked to deviation
```

---

## Deliverables

### Database
- [ ] Migration: `haccp_ccp_deviations` table
- [ ] Function: `determine_deviation_severity()`
- [ ] RLS policies

### API Routes
- [ ] GET /api/quality/haccp/ccp-deviations (list)
- [ ] GET /api/quality/haccp/ccp-deviations/:id (detail)
- [ ] POST /api/quality/haccp/ccp-deviations (create - called by monitoring hook)
- [ ] POST /api/quality/haccp/ccp-deviations/:id/investigate
- [ ] POST /api/quality/haccp/ccp-deviations/:id/resolve
- [ ] POST /api/quality/haccp/ccp-deviations/:id/verify

### Service Layer
- [ ] `CCPDeviationService.create()`
- [ ] `CCPDeviationService.determineSeverity()`
- [ ] `CCPDeviationService.investigate()`
- [ ] `CCPDeviationService.resolve()`
- [ ] `CCPDeviationService.verify()`

### Frontend
- [ ] Deviation list page
- [ ] Deviation detail page
- [ ] Severity badges (Critical=red, Major=orange, Minor=yellow)
- [ ] Resolution workflow UI

---

## Definition of Done

- [ ] Deviation table created
- [ ] Auto-create on monitoring fail works
- [ ] Severity classification logic works
- [ ] NCR auto-create on critical works
- [ ] Resolution workflow complete
- [ ] Tests passing (unit + integration + E2E)

---

**Document Status**: Ready for Implementation
**Created**: 2025-01-15
**Complexity**: M (Medium)
**Phase**: 3 (HACCP)
