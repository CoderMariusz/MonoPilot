# Epic 01a Clarifications - Settings Module (Phase 1A)

**Epic ID:** 01a
**Module:** Settings
**Phase:** 1A - MVP Core
**Status:** Draft
**Last Updated:** 2025-12-15

## Scope Reference

Phase 1A covers:
- Organization setup and profile (FR-SET-001 to FR-SET-004)
- User management with 10 roles (FR-SET-010 to FR-SET-014, FR-SET-017)
- Role and permission system (FR-SET-020 to FR-SET-031)
- Module toggles with dependencies (FR-SET-090 to FR-SET-097)
- Multi-language support (FR-SET-110 to FR-SET-116)
- 15-minute Onboarding Wizard (FR-SET-180 to FR-SET-188)

---

## Business Rules

### BR-001: Multi-Tenant Isolation
- All tables must have `org_id` column with NOT NULL constraint
- RLS policies filter by `auth.jwt() -> org_id` on every table
- Cross-tenant access returns HTTP 404 (not 403) to prevent existence leakage
- No cross-organization data joins permitted at database level
- API layer validates org_id matches session before any operation
- Admin creating users auto-sets org_id to admin's organization

### BR-002: Role Hierarchy and Constraints
- 10 predefined roles (system-defined, not editable by users)
- Roles: Super Admin, Admin, Production Manager, Quality Manager, Warehouse Manager, Production Operator, Quality Inspector, Warehouse Operator, Planner, Viewer
- Only Super Admin can assign Super Admin role to other users
- Admin can assign any role except Super Admin
- At least 1 Super Admin must exist per organization at all times
- Role changes take effect on next request (no cached permissions)

### BR-003: Onboarding Wizard Trigger
- Triggered automatically on first login for new organizations
- Only Admin or Super Admin roles can complete the wizard
- Non-admin users see "Setup in progress" message until wizard completes
- Progress saved per organization (not per user)
- Wizard can be skipped - creates demo data (1 warehouse, 1 location)
- Target completion time: less than 15 minutes

### BR-004: Module Dependencies
| Module | Requires | Notes |
|--------|----------|-------|
| Technical | None | Standalone, foundational |
| Planning | Technical | BOM/Routing definitions |
| Production | Technical, Planning | Work order execution |
| Quality | Production | QC during production |
| Warehouse | Technical | Inventory management |
| Shipping | Warehouse | Outbound logistics |

### BR-005: Session Management
- Default session timeout: 24 hours
- Password change invalidates ALL active sessions for that user
- Multi-device support enabled (concurrent sessions allowed)
- Session tracks: device type, IP address, user agent, created/last activity timestamps
- Session token invalidated on explicit logout

### BR-006: Password Policy (Default)
- Minimum length: 8 characters
- Must contain: 1 uppercase, 1 lowercase, 1 number, 1 special character
- Cannot reuse last 5 passwords
- Real-time validation feedback during password entry

### BR-007: User Invitation Lifecycle
- Invitations expire after 7 days
- Invitation can be resent (resets expiry to 7 days)
- Invitation can be cancelled by admin
- Email must be unique within organization
- Same email can exist in different organizations

### BR-008: Language Fallback Chain
1. User preference (if set)
2. Organization default
3. English (system fallback)
- Missing translation keys display as-is with console warning in dev mode

### BR-009: Module Toggle Behavior
- Disabled modules hidden from navigation
- Direct URL access to disabled module shows "Module not enabled" message
- API calls to disabled module return 403 with "Module not enabled for this organization"
- Disabling module with active data shows warning but does not block
- Enabling module with dependencies auto-enables required modules

---

## Edge Cases

### EC-001: Last Super Admin Protection
- Cannot delete the last Super Admin
- Cannot deactivate the last Super Admin
- Error message: "Cannot deactivate the only Super Admin"
- Must assign another Super Admin before removing current one

### EC-002: Self-Delete Prevention
- Users cannot delete their own account
- Error message: "Cannot delete your own account"
- Admin must request another admin to delete their account

### EC-003: Self-Deactivate Prevention
- Users cannot deactivate their own account
- Error message: "Cannot deactivate your own account"

### EC-004: Module Disable with Active Data
- Warning dialog shown: "Module has active data. Disable anyway?"
- Disabling is NOT blocked - data is preserved but inaccessible
- Re-enabling module restores access to existing data

### EC-005: Duplicate Email Handling
- Email unique constraint is per-organization
- Same email can exist in multiple organizations
- Error message for duplicate: "Email already exists"

### EC-006: Onboarding Resume
- If wizard incomplete, auto-resumes on next login
- Resumes at last incomplete step
- All previous step data preserved
- Browser refresh preserves current step and data

### EC-007: Onboarding for Non-Admin Users
- Non-admin users cannot start or complete wizard
- If org onboarding incomplete, non-admin sees: "Setup in progress. Please contact your administrator."
- Dashboard access blocked until onboarding completes or is skipped

### EC-008: Invitation to Existing User
- Cannot send invitation to email that already has active account
- Error message: "User already exists"
- Does not reveal which organization the user belongs to

### EC-009: Expired Invitation Click
- User clicking expired invitation link sees: "Invitation expired"
- "Request New Invitation" button displayed
- Does not auto-resend - requires admin action

### EC-010: Currency Change Warning
- Changing organization currency shows: "Existing data will not be converted"
- Historical financial data retains original currency values
- No automatic currency conversion performed

### EC-011: Timezone Change Impact
- All datetime displays convert to new timezone immediately
- Stored UTC timestamps unchanged (display-only change)
- KPI date boundaries (e.g., "Orders Today") use org timezone

### EC-012: User with Active Sessions Deactivated
- All sessions terminated immediately on deactivation
- User's next request returns 401 with redirect to login
- Login attempt shows: "Account is deactivated. Contact administrator."

### EC-013: Logo Upload Constraints
- Max file size: 2MB
- Allowed formats: PNG, JPG, GIF
- Oversized file: "Logo must be under 2MB"
- Invalid format: "Only PNG, JPG, or GIF formats allowed"

### EC-014: Wizard Skip Creates Demo Data
- Demo warehouse: code "DEMO-WH", name "Demo Warehouse"
- Default location: code "DEFAULT", name "Default Location"
- onboarding_skipped flag set to true
- Settings shows: "Setup: Skipped (Demo data created)"

### EC-015: Empty Organization Name
- Organization name is required (2-100 characters)
- Blank submission: "Organization name is required"
- Wizard cannot advance from Step 1 without valid name

---

## Assumptions

### Technical Assumptions
1. Supabase Auth configured and operational for email/password authentication
2. Browser supports ES2020+ JavaScript features
3. SMTP/email provider configured for invitation and notification emails
4. Redis available for session caching (optional, graceful fallback)

### UX Assumptions
1. Timezone auto-detected from browser on first use
2. Language auto-detected from browser Accept-Language header
3. All datetime displays use organization timezone (not user's local)
4. Number/date formats follow locale conventions

### Business Assumptions
1. Single currency per organization (no multi-currency support)
2. 10 fixed roles sufficient for MVP (no custom roles)
3. 4 languages sufficient for EU market (PL, EN, DE, FR)
4. 15-minute onboarding target achievable with guided wizard

### Data Assumptions
1. Email delivery within 5 seconds (SLA with email provider)
2. User list pagination needed beyond 100 users
3. Organization typically has 5-100 users (SMB target)

---

## Open Questions (Resolved)

| # | Question | Resolution | Date |
|---|----------|------------|------|
| 1 | SSO support in MVP? | No - Phase 3 (Enterprise) | 2025-12-10 |
| 2 | Custom roles allowed? | No - 10 fixed roles only | 2025-12-10 |
| 3 | Multi-currency per org? | No - Single currency per org | 2025-12-10 |
| 4 | MFA in Phase 1A? | No - Phase 1B (FR-SET-015) | 2025-12-10 |
| 5 | Can roles be created/edited? | No - system-defined only | 2025-12-10 |
| 6 | Invitation expiry period? | 7 days, resettable | 2025-12-10 |
| 7 | Password expiry enforcement? | Optional, 90 days if enabled (Phase 1B) | 2025-12-10 |
| 8 | Demo data deletable? | Yes - can be edited/deleted like normal data | 2025-12-10 |
| 9 | Wizard re-runnable after skip? | Yes - "Run Setup Wizard" button in Settings | 2025-12-10 |
| 10 | Session timeout configurable? | Phase 1B - default 24h in 1A | 2025-12-10 |

---

## Constraints

### Performance Constraints
- User list load: less than 500ms for up to 1000 users
- Settings page load: less than 300ms
- Wizard step transition: less than 200ms
- Industry template load: less than 300ms
- Search/filter response: less than 200ms

### Security Constraints
- All API endpoints require authentication
- All database queries scoped by org_id via RLS
- Password hashes never exposed (even in audit logs - show "[REDACTED]")
- API returns 404 for cross-tenant resources (not 403)

### Data Constraints
- Organization name: 2-100 characters
- Email: valid format, unique per org
- Warehouse code: unique per org
- Machine code: unique per org
- Production line code: unique per org

---

## Glossary

| Term | Definition |
|------|------------|
| **RLS** | Row-Level Security - PostgreSQL feature enforcing org_id filtering |
| **org_id** | Organization identifier, present on all tenant-scoped tables |
| **INVEST** | Independent, Negotiable, Valuable, Estimable, Small, Testable (story criteria) |
| **LP** | License Plate - atomic inventory tracking unit |
| **BOM** | Bill of Materials - component list for products |
| **Onboarding Wizard** | 6-step guided setup flow for new organizations |
| **Demo Data** | Pre-created warehouse/location when wizard is skipped |
| **Super Admin** | Highest privilege role with full system access |
| **Session Token** | JWT or similar token authenticating user requests |

---

## Related Documents

- PRD: `/workspaces/MonoPilot/docs/1-BASELINE/product/modules/settings.md`
- Epic Overview: `/workspaces/MonoPilot/docs/2-MANAGEMENT/epics/current/01-settings/01.0.epic-overview.md`
- UX Wireframes: `/workspaces/MonoPilot/docs/3-ARCHITECTURE/ux/wireframes/SET-001-*.md` through `SET-029-*.md`
- Database Schema: `/workspaces/MonoPilot/.claude/TABLES.md`
