# 01a.7 - Module Toggles

**State:** ready
**Type:** frontend + backend
**Estimate:** M
**Primary PRD:** `docs/1-BASELINE/product/modules/settings.md` (FR-SET-090-097)
**UX Wireframes:** SET-022
**Architecture:** ADR-011 (Module Toggle Schema)

## Goal
Implement module activation/deactivation with dependency validation. Disabled modules are hidden from navigation and inaccessible via direct URL or API.

## Scope

**In scope**
- GET /api/v1/settings/modules (list all modules with status)
- PATCH /api/v1/settings/modules/:id/toggle (enable/disable)
- Module toggles page at `/settings/modules`
- Dependency validation with warnings
- Navigation hiding for disabled modules
- Direct URL redirect for disabled modules
- API 403 response for disabled module endpoints

**Out of scope**
- Custom module creation
- Module-specific configuration (handled per module)
- Module data deletion on disable

**Note:** The `module_settings` table from the original architecture is deprecated. Use `modules` and `organization_modules` tables per ADR-011.

## Dependencies
- **01a.1** - Org context + RLS (required for org-scoped settings)
- **01a.2** - Settings shell with navigation guards
- **01a.6** - Role permissions (only Admin+ can toggle modules)

## Module Definitions

| Module | Code | Default | Dependencies |
|--------|------|---------|--------------|
| Technical | technical | ON | None (standalone) |
| Planning | planning | OFF | Technical |
| Production | production | OFF | Technical, Planning |
| Quality | quality | OFF | Production |
| Warehouse | warehouse | OFF | Technical |
| Shipping | shipping | OFF | Warehouse |
| Settings | settings | ON (always) | None (cannot disable) |

## Dependency Graph

```
Technical (standalone)
    |
    +---> Planning
    |       |
    |       +---> Production
    |               |
    |               +---> Quality
    |
    +---> Warehouse
            |
            +---> Shipping
```

## Acceptance Criteria (Given/When/Then)

### Module List Page
- GIVEN admin navigates to `/settings/modules`, WHEN page loads, THEN 6 toggleable modules display with current status.
- GIVEN Settings module, WHEN toggle page loads, THEN Settings has no toggle switch (always enabled, not toggleable).
- GIVEN module list displayed, WHEN toggle switch shown, THEN enabled modules show ON (green), disabled show OFF (gray).

### Enable Module
- GIVEN admin enables Warehouse module, WHEN toggle switched ON, THEN "Warehouse" appears in navigation within 1 second.
- GIVEN Production requires Technical and Planning, WHEN enabling Production while both ON, THEN Production enables successfully.

### Enable with Missing Dependencies
- GIVEN Technical is OFF, WHEN admin tries to enable Planning, THEN warning displays: "Planning requires Technical. Enable Technical first?".
- GIVEN warning shown with "Enable Both" button, WHEN clicked, THEN both Technical and Planning enabled.
- GIVEN warning shown, WHEN "Cancel" clicked, THEN no changes made.

### Disable Module
- GIVEN Production module is ON, WHEN admin toggles OFF, THEN Production hidden from navigation within 1 second.
- GIVEN admin disables Planning module with active work orders, WHEN toggle switched OFF, THEN warning "Module has active data. Disable anyway?" displays.

### Disable with Dependents
- GIVEN Quality depends on Production, WHEN admin disables Production while Quality is ON, THEN warning displays: "Quality depends on Production. Disable Quality also?".
- GIVEN warning shown with "Disable Both", WHEN clicked, THEN both Production and Quality disabled.
- GIVEN cascade warning shown, WHEN "Cancel" clicked, THEN no changes made.

### Navigation Enforcement
- GIVEN Production module disabled, WHEN user views navigation sidebar, THEN "Production" menu item hidden.
- GIVEN all modules disabled except Settings, WHEN user logs in, THEN only Settings accessible in navigation.

### Direct URL Enforcement
- GIVEN Production module disabled, WHEN user navigates to `/production/dashboard` directly, THEN redirect to dashboard with toast "Module not enabled for this organization".
- GIVEN Warehouse module disabled, WHEN user bookmarks `/warehouse/inventory`, THEN accessing bookmark shows redirect message.

### API Enforcement
- GIVEN Quality module disabled, WHEN API call to `/api/v1/quality/inspections` made, THEN 403 "Module not enabled for this organization" returns.
- GIVEN Technical module enabled, WHEN API call to `/api/v1/technical/products` made, THEN request proceeds normally.

### Permission Enforcement
- GIVEN user with VIEWER role, WHEN accessing `/settings/modules`, THEN page loads read-only (toggles disabled).
- GIVEN user with ADMIN role, WHEN accessing `/settings/modules`, THEN toggles are interactive.

## Implementation Notes

### API Endpoints

```typescript
// GET /api/v1/settings/modules
interface ModulesListResponse {
  modules: {
    id: string;
    code: string;
    name: string;
    enabled: boolean;
    dependencies: string[];
    dependents: string[];
    can_disable: boolean;
  }[];
}

// PATCH /api/v1/settings/modules/:id/toggle
interface ToggleModuleRequest {
  enabled: boolean;
  cascade?: boolean; // auto-enable/disable dependencies
}

interface ToggleModuleResponse {
  success: boolean;
  affected_modules: string[]; // modules that were also toggled
  warning?: string;
}
```

### Database Schema (ADR-011)

```sql
-- modules table (seeded, system data)
CREATE TABLE modules (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  code VARCHAR(50) UNIQUE NOT NULL,
  name VARCHAR(100) NOT NULL,
  dependencies TEXT[],  -- array of module codes
  can_disable BOOLEAN DEFAULT true,
  display_order INT
);

-- organization_modules table (org-specific state)
CREATE TABLE organization_modules (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id),
  module_id UUID NOT NULL REFERENCES modules(id),
  enabled BOOLEAN DEFAULT false,
  enabled_at TIMESTAMPTZ,
  enabled_by UUID REFERENCES users(id),
  UNIQUE(org_id, module_id)
);

-- Seed modules
INSERT INTO modules (code, name, dependencies, can_disable, display_order) VALUES
  ('settings', 'Settings', '{}', false, 0),
  ('technical', 'Technical', '{}', true, 1),
  ('planning', 'Planning', '{"technical"}', true, 2),
  ('production', 'Production', '{"technical","planning"}', true, 3),
  ('quality', 'Quality', '{"production"}', true, 4),
  ('warehouse', 'Warehouse', '{"technical"}', true, 5),
  ('shipping', 'Shipping', '{"warehouse"}', true, 6);
```

### Middleware for Module Check

```typescript
// middleware/module-guard.ts
export function requireModule(moduleCode: string): Middleware {
  return async (req, context) => {
    const orgId = getOrgId(req);
    const enabled = await isModuleEnabled(orgId, moduleCode);

    if (!enabled) {
      return Response.json(
        { error: "Module not enabled for this organization" },
        { status: 403 }
      );
    }

    return context.next();
  };
}
```

### Navigation Integration

```tsx
// Use in layout/navigation component
function NavigationSidebar() {
  const { enabledModules } = useModules();

  const navItems = ALL_NAV_ITEMS.filter(item =>
    item.module === 'settings' || enabledModules.includes(item.module)
  );

  return <SideNav items={navItems} />;
}
```

### Route Guard (App Router)

```tsx
// app/(authenticated)/[module]/layout.tsx
export default async function ModuleLayout({
  children,
  params
}: {
  children: React.ReactNode;
  params: { module: string };
}) {
  const enabled = await isModuleEnabled(params.module);

  if (!enabled) {
    redirect('/dashboard?error=module_disabled');
  }

  return <>{children}</>;
}
```

### Dependency Validation

```typescript
function validateModuleToggle(
  moduleCode: string,
  newState: boolean,
  currentStates: Record<string, boolean>
): {
  valid: boolean;
  warning?: string;
  requiredChanges?: { module: string; enable: boolean }[];
} {
  const module = MODULES[moduleCode];

  if (newState === true) {
    // Enabling: check dependencies are enabled
    const missingDeps = module.dependencies.filter(dep => !currentStates[dep]);
    if (missingDeps.length > 0) {
      return {
        valid: false,
        warning: `${module.name} requires ${missingDeps.join(', ')}. Enable them first?`,
        requiredChanges: missingDeps.map(dep => ({ module: dep, enable: true }))
      };
    }
  } else {
    // Disabling: check dependents are disabled
    const activeDependents = Object.entries(MODULES)
      .filter(([code, m]) => m.dependencies.includes(moduleCode) && currentStates[code])
      .map(([code]) => code);

    if (activeDependents.length > 0) {
      return {
        valid: false,
        warning: `${activeDependents.join(', ')} depend on ${module.name}. Disable them also?`,
        requiredChanges: activeDependents.map(dep => ({ module: dep, enable: false }))
      };
    }
  }

  return { valid: true };
}
```

## Deliverables
- `modules` table seeded with 7 modules (1 non-toggleable + 6 toggleable)
- `organization_modules` table for org-specific state
- `module-settings-service.ts` with toggle logic and dependency validation
- Module toggles page with switches and dependency warnings
- Navigation filtering based on enabled modules
- Route guard middleware for disabled module redirect
- API middleware for 403 on disabled module endpoints
- Integration tests for dependency scenarios
- Unit tests for module-settings-service

## Definition of Done
- [ ] 6 toggleable modules display on settings page
- [ ] Settings module always enabled, no toggle switch displayed
- [ ] Enable/disable updates navigation within 1 second
- [ ] Dependency validation shows warning before cascade
- [ ] Direct URL to disabled module redirects with message
- [ ] API returns 403 for disabled module endpoints
- [ ] Settings module cannot be disabled (can_disable=false)
- [ ] Admin+ required to toggle modules
- [ ] Integration tests cover all dependency scenarios
- [ ] Unit tests for module-settings-service (>80% coverage)
