# 01a.1 - Org Context + Base RLS Scaffolding

**State:** ready
**Type:** backend (foundation)
**Estimate:** M
**Primary PRD:** `docs/1-BASELINE/product/modules/settings.md` (FR-SET-002)
**Primary Architecture:** `docs/1-BASELINE/architecture/modules/settings.md`

## Goal
Establish a reliable tenant context (`org_id`) and baseline isolation so every subsequent Settings story can safely read/write org-scoped data.

## Scope

**In scope**
- Server-side "current org" resolution for authenticated requests.
- Baseline RLS and/or query enforcement for core Settings tables used early:
  - `organizations`
  - `users`
  - `roles` (per ADR-012)
  - `modules` + `organization_modules` (per ADR-011, replaces deprecated `module_settings`)
- Standardize cross-tenant access behavior for ID-based routes (return `404`).

**Out of scope**
- Implementing full CRUD for any Settings surface (handled by later stories).

## Dependencies
- None

## Acceptance Criteria (Given/When/Then)

- GIVEN an authenticated request, WHEN the backend resolves context, THEN it can derive `user_id` and `org_id` for the session.
- GIVEN a user from Org B, WHEN they request an Org A resource by ID, THEN the API returns `404` (not `403`) and does not leak existence.
- GIVEN user from Org B, WHEN requesting resource from Org A, THEN response is 404 Not Found (NOT 403 Forbidden) to prevent existence leak.
- GIVEN a query is executed without an explicit `org_id` filter, WHEN RLS/equivalent is applied, THEN cross-tenant rows are not returned.
- GIVEN query without explicit org_id filter, WHEN executed via Supabase client, THEN RLS automatically filters to user's org_id.
- GIVEN a user without admin privileges, WHEN they attempt admin-only writes (e.g., modify org profile), THEN the API rejects the request.
- GIVEN test fixtures with 2 orgs, WHEN integration tests run, THEN cross-tenant reads/writes are blocked consistently.

## Implementation Notes

### Database Schema (Complete Definitions)

**Reference:** ADR-011 (Module Toggles), ADR-012 (Role Permissions)

```sql
-- ORGANIZATIONS (core tenant table)
CREATE TABLE organizations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,
  slug TEXT UNIQUE NOT NULL,
  timezone TEXT DEFAULT 'UTC',
  locale TEXT DEFAULT 'en',
  currency TEXT DEFAULT 'PLN',
  logo_url TEXT,
  -- Onboarding state (Story 01a.3)
  onboarding_step INTEGER DEFAULT 0,
  onboarding_started_at TIMESTAMPTZ,
  onboarding_completed_at TIMESTAMPTZ,
  onboarding_skipped BOOLEAN DEFAULT false,
  -- Metadata
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- ROLES (seeded, immutable - ADR-012)
CREATE TABLE roles (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  code VARCHAR(50) UNIQUE NOT NULL,
  name VARCHAR(100) NOT NULL,
  description TEXT,
  permissions JSONB NOT NULL,
  is_system BOOLEAN DEFAULT true,
  display_order INT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- USERS (org-scoped)
CREATE TABLE users (
  id UUID PRIMARY KEY REFERENCES auth.users(id),
  org_id UUID NOT NULL REFERENCES organizations(id),
  email TEXT NOT NULL,
  first_name TEXT NOT NULL,
  last_name TEXT NOT NULL,
  role_id UUID NOT NULL REFERENCES roles(id),
  language TEXT DEFAULT 'en',
  is_active BOOLEAN DEFAULT true,
  last_login_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(org_id, email)
);

-- MODULES (seeded, immutable - ADR-011)
CREATE TABLE modules (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  code VARCHAR(50) UNIQUE NOT NULL,
  name VARCHAR(100) NOT NULL,
  dependencies TEXT[],
  can_disable BOOLEAN DEFAULT true,
  display_order INT
);

-- ORGANIZATION_MODULES (org-specific state - ADR-011)
-- NOTE: Replaces deprecated `module_settings` table
CREATE TABLE organization_modules (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id),
  module_id UUID NOT NULL REFERENCES modules(id),
  enabled BOOLEAN DEFAULT false,
  enabled_at TIMESTAMPTZ,
  enabled_by UUID REFERENCES users(id),
  UNIQUE(org_id, module_id)
);
```

### RLS Policies

**Standard RLS policy pattern:**
```sql
-- Organizations: Users can only see their own org
CREATE POLICY "org_select_own" ON organizations
FOR SELECT USING (id = (SELECT org_id FROM users WHERE id = auth.uid()));

-- Users: Same org only, admin for writes
CREATE POLICY "users_org_isolation" ON users
FOR SELECT USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

CREATE POLICY "users_admin_write" ON users
FOR ALL USING (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  AND (SELECT r.code FROM roles r JOIN users u ON u.role_id = r.id WHERE u.id = auth.uid()) IN ('SUPER_ADMIN', 'ADMIN')
);

-- Organization_modules: Org isolation + admin write
CREATE POLICY "org_modules_isolation" ON organization_modules
FOR SELECT USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

CREATE POLICY "org_modules_admin_write" ON organization_modules
FOR ALL USING (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  AND (SELECT r.code FROM roles r JOIN users u ON u.role_id = r.id WHERE u.id = auth.uid()) IN ('SUPER_ADMIN', 'ADMIN')
);
```

### Backend
- Add a single "source of truth" helper for org context resolution used by all Settings API handlers (e.g. `getOrgContext()`).
- Add a single "not found" helper for cross-tenant resources (ID-based routes return `404`).

### Tests (RED)
- Integration tests for:
  - org isolation (Org A cannot read Org B data)
  - role enforcement (non-admin cannot perform admin writes)
  - `404` behavior for cross-tenant ID access

## Deliverables
- Shared auth/org context helper(s) used by Settings endpoints (`getOrgContext()`).
- Baseline RLS policies for `organizations`, `users`, `roles`, `organization_modules`.
- Tests proving isolation + `404` behavior.
- API endpoint: `GET /api/v1/settings/context` - returns org_id, user_id, role, permissions.

## Definition of Done
- [ ] Cross-tenant access is blocked by policy and tests.
- [ ] All new/changed endpoints use the shared org context helper.
- [ ] Tests pass and failures are meaningful (no false positives).
- [ ] Unit test coverage ≥ 95% (security critical).
- [ ] Integration test coverage ≥ 80%.
- [ ] 404 (not 403) response verified for cross-tenant access.
