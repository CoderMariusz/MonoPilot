# 01a.6 - Role-Based Permissions (10 Roles)

**State:** ready
**Type:** backend + frontend
**Estimate:** M
**Primary PRD:** `docs/1-BASELINE/product/modules/settings.md` (FR-SET-011, FR-SET-020-029, FR-SET-030, FR-SET-031)
**UX Wireframes:** SET-011
**Architecture:** ADR-012 (Role-Based Permissions Schema)

## Goal
Implement the 10 predefined role system with RBAC enforcement. Roles are system-defined (not editable). Permissions control module access and CRUD operations across the application.

## Scope

**In scope**
- 10 predefined roles with fixed permissions
- Permission matrix (module x CRUD)
- `hasPermission()` helper function for backend/frontend
- `usePermissions()` React hook for UI
- Role enforcement on API endpoints (middleware)
- Role display in user modal dropdown
- Permission-based UI element visibility
- Role validation on assignment

**Out of scope**
- Custom role creation
- Role editing/modification
- Granular per-entity permissions
- Permission delegation

## Dependencies
- **01a.1** - Org context + RLS (required for user context)

## 10 Role Definitions

| Role Code | Role Name | Description |
|-----------|-----------|-------------|
| SUPER_ADMIN | Super Administrator | Full system access, can assign any role |
| ADMIN | Administrator | Organization-wide access, cannot assign Super Admin |
| PROD_MANAGER | Production Manager | Full Production, Planning, Quality access |
| QUAL_MANAGER | Quality Manager | Full Quality, read Production |
| WH_MANAGER | Warehouse Manager | Full Warehouse and Shipping access |
| PROD_OPERATOR | Production Operator | CRU Production, read Quality |
| QUAL_INSPECTOR | Quality Inspector | CRU Quality only |
| WH_OPERATOR | Warehouse Operator | CRU Warehouse and Shipping |
| PLANNER | Planner | Full Planning, read Production |
| VIEWER | Viewer | Read-only all modules |

## Permission Matrix

| Module | SUPER_ADMIN | ADMIN | PROD_MGR | QUAL_MGR | WH_MGR | PROD_OP | QUAL_INSP | WH_OP | PLANNER | VIEWER |
|--------|-------------|-------|----------|----------|--------|---------|-----------|-------|---------|--------|
| Settings | CRUD | CRUD | R | R | R | - | - | - | R | R |
| Users | CRUD | CRUD | R | R | R | - | - | - | - | R |
| Technical | CRUD | CRUD | CRUD | R | R | R | R | - | R | R |
| Planning | CRUD | CRUD | CRUD | R | R | R | - | - | CRUD | R |
| Production | CRUD | CRUD | CRUD | R | R | CRU | R | - | R | R |
| Quality | CRUD | CRUD | CRUD | CRUD | R | R | CRU | - | R | R |
| Warehouse | CRUD | CRUD | R | R | CRUD | - | - | CRU | R | R |
| Shipping | CRUD | CRUD | R | R | CRUD | - | - | CRU | R | R |

**Legend:** C=Create, R=Read, U=Update, D=Delete, -=No Access

## Acceptance Criteria (Given/When/Then)

### Role Assignment
- GIVEN role dropdown in user modal, WHEN opened, THEN exactly 10 roles display with names.
- GIVEN role dropdown in user modal, WHEN roles listed, THEN display name shown (not code): "Production Manager" not "PROD_MANAGER".
- GIVEN Super Admin assigning role to user, WHEN any of 10 roles selected, THEN role assignment succeeds.
- GIVEN non-Super Admin (e.g., ADMIN), WHEN attempting to assign SUPER_ADMIN role, THEN error "Only Super Admin can assign Super Admin role" displays.
- GIVEN role changed from VIEWER to ADMIN, WHEN user's next request made, THEN new permissions active immediately.

### Permission Enforcement - Module Level
- GIVEN user with SUPER_ADMIN role, WHEN accessing any module, THEN full CRUD access granted.
- GIVEN user with VIEWER role, WHEN attempting to create anything, THEN action blocked, create button hidden.
- GIVEN user with PROD_OPERATOR role, WHEN accessing Quality module, THEN read-only access (no create/update/delete).
- GIVEN user with QUAL_INSPECTOR role, WHEN accessing Warehouse module, THEN access denied (redirect).
- GIVEN user with WH_OPERATOR role, WHEN accessing Settings module, THEN access denied (redirect).

### Permission Enforcement - API Level
- GIVEN API request to `/api/v1/production/work-orders` by VIEWER, WHEN POST attempted, THEN 403 Forbidden returns.
- GIVEN API request to `/api/v1/quality/inspections` by PROD_OPERATOR, WHEN DELETE attempted, THEN 403 Forbidden returns.
- GIVEN API request to `/api/v1/warehouse/locations` by QUAL_INSPECTOR, WHEN GET attempted, THEN 403 Forbidden returns (no module access).

### UI Permission Rendering
- GIVEN user with CRU permission (no Delete), WHEN delete button rendered, THEN button hidden or disabled.
- GIVEN user with R permission only, WHEN page loads, THEN "Create" and "Edit" buttons hidden.
- GIVEN user with CRUD permission, WHEN page loads, THEN all action buttons visible.

### Permission Caching
- GIVEN user permissions cached, WHEN admin updates user's role, THEN user's next request uses updated permissions (no stale cache beyond 1 minute).

## Implementation Notes

### Permission Data Structure

```typescript
// Permission levels
type Permission = 'C' | 'R' | 'U' | 'D' | '-';
type PermissionSet = string; // e.g., "CRUD", "CRU", "R", "-"

// Module permissions for a role
interface RolePermissions {
  role_code: string;
  role_name: string;
  modules: {
    settings: PermissionSet;
    users: PermissionSet;
    technical: PermissionSet;
    planning: PermissionSet;
    production: PermissionSet;
    quality: PermissionSet;
    warehouse: PermissionSet;
    shipping: PermissionSet;
  };
}

// Permission matrix (static data, seeded in DB)
const ROLE_PERMISSIONS: Record<string, RolePermissions> = {
  SUPER_ADMIN: { ... },
  ADMIN: { ... },
  // ... etc
};
```

### Permission Helper Functions

```typescript
// Backend
function hasPermission(
  user: User,
  module: string,
  action: 'C' | 'R' | 'U' | 'D'
): boolean;

function requirePermission(
  module: string,
  action: 'C' | 'R' | 'U' | 'D'
): Middleware;

// Frontend
function usePermissions(): {
  can: (module: string, action: 'C' | 'R' | 'U' | 'D') => boolean;
  canAny: (module: string) => boolean;
  role: string;
};
```

### API Middleware

```typescript
// Usage in API routes
export async function POST(req: Request) {
  const user = await getAuthUser(req);
  if (!hasPermission(user, 'production', 'C')) {
    return Response.json(
      { error: "You don't have permission to perform this action" },
      { status: 403 }
    );
  }
  // ... proceed with creation
}
```

### Database Schema (ADR-012)

```sql
-- roles table (seeded, immutable)
CREATE TABLE roles (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  code VARCHAR(50) UNIQUE NOT NULL,
  name VARCHAR(100) NOT NULL,
  description TEXT,
  permissions JSONB NOT NULL,  -- module permission matrix
  is_system BOOLEAN DEFAULT true,
  display_order INT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Seed 10 roles
INSERT INTO roles (code, name, description, permissions, display_order) VALUES
  ('SUPER_ADMIN', 'Super Administrator', 'Full system access, can assign any role', '{"settings":"CRUD","users":"CRUD","technical":"CRUD","planning":"CRUD","production":"CRUD","quality":"CRUD","warehouse":"CRUD","shipping":"CRUD"}', 1),
  ('ADMIN', 'Administrator', 'Organization-wide access, cannot assign Super Admin', '{"settings":"CRUD","users":"CRUD","technical":"CRUD","planning":"CRUD","production":"CRUD","quality":"CRUD","warehouse":"CRUD","shipping":"CRUD"}', 2),
  ('PROD_MANAGER', 'Production Manager', 'Full Production, Planning, Quality access', '{"settings":"R","users":"R","technical":"CRUD","planning":"CRUD","production":"CRUD","quality":"CRUD","warehouse":"R","shipping":"R"}', 3),
  ('QUAL_MANAGER', 'Quality Manager', 'Full Quality, read Production', '{"settings":"R","users":"R","technical":"R","planning":"R","production":"R","quality":"CRUD","warehouse":"R","shipping":"R"}', 4),
  ('WH_MANAGER', 'Warehouse Manager', 'Full Warehouse and Shipping access', '{"settings":"R","users":"R","technical":"R","planning":"R","production":"R","quality":"R","warehouse":"CRUD","shipping":"CRUD"}', 5),
  ('PROD_OPERATOR', 'Production Operator', 'CRU Production, read Quality', '{"settings":"-","users":"-","technical":"R","planning":"R","production":"CRU","quality":"R","warehouse":"-","shipping":"-"}', 6),
  ('QUAL_INSPECTOR', 'Quality Inspector', 'CRU Quality only', '{"settings":"-","users":"-","technical":"R","planning":"-","production":"R","quality":"CRU","warehouse":"-","shipping":"-"}', 7),
  ('WH_OPERATOR', 'Warehouse Operator', 'CRU Warehouse and Shipping', '{"settings":"-","users":"-","technical":"-","planning":"-","production":"-","quality":"-","warehouse":"CRU","shipping":"CRU"}', 8),
  ('PLANNER', 'Planner', 'Full Planning, read Production', '{"settings":"R","users":"-","technical":"R","planning":"CRUD","production":"R","quality":"R","warehouse":"R","shipping":"R"}', 9),
  ('VIEWER', 'Viewer', 'Read-only all modules', '{"settings":"R","users":"R","technical":"R","planning":"R","production":"R","quality":"R","warehouse":"R","shipping":"R"}', 10);
```

### Frontend Hook Usage

```tsx
function UserActionsCell({ user }: { user: User }) {
  const { can } = usePermissions();

  return (
    <div>
      {can('users', 'U') && <EditButton user={user} />}
      {can('users', 'D') && <DeleteButton user={user} />}
    </div>
  );
}
```

## Deliverables
- `roles` table with 10 seeded roles and permission matrix
- `permission-service.ts` with hasPermission, requirePermission
- `usePermissions` React hook
- Permission middleware for API routes
- Role dropdown component for user forms
- Integration tests for permission enforcement
- Unit tests for permission-service

## Definition of Done
- [ ] 10 roles seeded in database with correct permissions
- [ ] hasPermission() correctly checks module + action
- [ ] API middleware enforces permissions, returns 403
- [ ] usePermissions hook works for UI conditional rendering
- [ ] Role dropdown displays names (not codes) in user modal
- [ ] Super Admin role assignment restricted to Super Admins
- [ ] Role changes take effect within 1 minute
- [ ] Integration tests cover all role x module x action combinations
- [ ] Unit tests for permission-service (>80% coverage)
