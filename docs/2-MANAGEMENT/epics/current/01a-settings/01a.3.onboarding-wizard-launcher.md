# 01a.3 - Onboarding Wizard Launcher

**State:** ready
**Type:** frontend + backend
**Estimate:** M
**Primary PRD:** `docs/1-BASELINE/product/modules/settings.md` (FR-SET-180, FR-SET-186, FR-SET-187)
**Primary Architecture:** `docs/1-BASELINE/architecture/modules/settings.md`

## Goal
Detect first-time login for new organizations and launch the onboarding wizard modal. Enable progress tracking and resumption across sessions, with an option to skip wizard and create demo data.

## Scope

**In scope**
- Check `onboarding_step` from organizations table on login/page load.
- Display wizard modal for incomplete onboarding (onboarding_step < 6).
- Store and resume progress via `onboarding_step` in organizations table.
- Skip wizard option that creates demo data (warehouse + location + product).
- Non-admin users see "Setup in progress" message instead of wizard.
- Progress indicator showing current step (e.g., "Step 1 of 6").

**Out of scope**
- Individual wizard step content/forms (handled by 01a.4 and subsequent stories).
- Full step implementation (steps 2-6 are separate stories or deferred to Epic 01).
- Email reminders for abandoned wizards.

## Dependencies
- 01a.1 (org context and RLS for organizations table)
- 01a.2 (settings shell for wizard modal mounting)

## Acceptance Criteria (Given/When/Then)

- GIVEN a new organization with `onboarding_step=0`, WHEN admin logs in, THEN the wizard modal appears automatically at step 1.
- GIVEN an organization with `onboarding_step=3`, WHEN admin logs in, THEN the wizard resumes at step 3 with steps 1-2 showing checkmarks.
- GIVEN an organization with `onboarding_completed_at` set (not null), WHEN any user logs in, THEN no wizard appears and user lands on dashboard.
- GIVEN a non-admin user (e.g., Viewer, Operator), WHEN organization onboarding is incomplete, THEN user sees "Organization setup in progress. Contact your administrator." message instead of wizard (no wizard access).
- GIVEN admin clicks "Skip Setup Wizard", WHEN skip confirmed, THEN demo data created:
  - 1 demo warehouse "Main Warehouse" (code: DEMO-WH)
  - 1 demo location "Default Location" (code: DEFAULT)
  - 1 demo product "Sample Product" (code: SAMPLE-001)
  - Module toggles: Technical=ON, others=OFF
- GIVEN an admin clicks "Skip Setup Wizard", WHEN confirmation dialog is cancelled, THEN wizard remains open at current step.
- GIVEN wizard is on any step (1-6), THEN a "Skip Setup Wizard" link is visible (styled as secondary action).
- GIVEN progress is saved after step completion, WHEN user refreshes page or logs out/in, THEN wizard resumes from saved step.

## Implementation Notes

### Database

The `organizations` table should have (verify/add if missing):
```sql
-- Add to organizations table
onboarding_step INTEGER DEFAULT 0,         -- 0=not started, 1-6=current step
onboarding_started_at TIMESTAMPTZ,         -- set when wizard first shown
onboarding_completed_at TIMESTAMPTZ,       -- set when wizard completed or skipped
onboarding_skipped BOOLEAN DEFAULT false   -- true if user skipped wizard
```

### Backend

API endpoints (or extend existing organization endpoint):
```
GET  /api/v1/settings/onboarding/status
     Returns: { step: number, started_at: string|null, completed_at: string|null, skipped: boolean }

POST /api/v1/settings/onboarding/skip
     Body: {}
     Action: Creates demo warehouse + default location + sample product, sets module toggles, sets onboarding_completed_at and onboarding_skipped
     Returns: { success: true, demo_data: { warehouse_id, location_id, product_id } }
```

Demo data creation (skip wizard):
```typescript
// Create demo warehouse
{ code: 'DEMO-WH', name: 'Main Warehouse', type: 'general', is_default: true }

// Create default location under demo warehouse
{ code: 'DEFAULT', name: 'Default Location', type: 'zone' }

// Create sample product
{ code: 'SAMPLE-001', name: 'Sample Product', uom: 'EA', status: 'active' }

// Set module toggles
{ technical: true, planning: false, production: false, warehouse: false, quality: false, shipping: false }
```

### Frontend

- Create `OnboardingWizardModal` component:
  - Full-screen modal overlay (cannot be dismissed by clicking outside).
  - Step indicator showing progress (1 of 6, with checkmarks for completed steps).
  - Navigation: Back (disabled on step 1), Next, Skip Setup Wizard link.
  - Each step renders a child component (step 1 = `OrganizationProfileStep`, etc.).

- Create `useOnboardingStatus` hook:
  ```typescript
  function useOnboardingStatus() {
    // Returns { step, isComplete, isSkipped, loading, error, refresh }
  }
  ```

- Create `OnboardingGuard` wrapper:
  - Wraps authenticated routes.
  - If `onboarding_completed_at` is null:
    - If user is admin: show wizard modal.
    - If user is non-admin: show "Setup in progress" banner/overlay.

- Skip confirmation dialog content:
  ```
  Skip Onboarding Wizard?

  We'll create a demo warehouse and default location so you can
  start exploring MonoPilot immediately.

  You can configure everything manually in Settings.

  [Skip Wizard] [Continue Setup]
  ```

### Tests (RED)

- Unit tests:
  - `useOnboardingStatus` hook returns correct state for various onboarding_step values.
  - Skip confirmation dialog shows/hides correctly.
  - Non-admin users see "Setup in progress" message.

- Integration tests:
  - Wizard auto-launches for new org (step=0).
  - Wizard resumes at correct step.
  - Skip creates demo data and closes wizard.
  - Completed orgs bypass wizard entirely.

## Deliverables

- `OnboardingWizardModal.tsx` component with step navigation framework.
- `useOnboardingStatus.ts` hook for fetching/caching onboarding state.
- `OnboardingGuard.tsx` wrapper component.
- API route: `GET /api/v1/settings/onboarding/status`.
- API route: `POST /api/v1/settings/onboarding/skip` (creates demo data).
- Skip confirmation dialog component.
- "Setup in progress" message for non-admin users.

## Definition of Done

- [ ] Wizard modal launches automatically for new organizations (onboarding_step=0).
- [ ] Wizard resumes at correct step for returning users.
- [ ] Completed organizations (onboarding_completed_at set) bypass wizard.
- [ ] Non-admin users see "Setup in progress" message.
- [ ] Skip wizard creates demo warehouse + default location + sample product.
- [ ] Unit and integration tests pass for all acceptance criteria.
