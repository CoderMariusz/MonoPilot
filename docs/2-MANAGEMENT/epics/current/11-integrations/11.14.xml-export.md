# 11.14 - XML Export

**Priority**: P1 (Phase 2)
**Story Points**: S (Small)
**Type**: backend + frontend
**Phase**: 2
**Model**: OPUS

**State:** ready
**Estimate:** S (1-2 days)
**Primary PRD:** `docs/1-BASELINE/product/modules/integrations.md` (FR-INT-024, Section 4.2)
**Architecture:** XML serializer, schema validation, downloadable exports

---

## Goal

Extend data export functionality (story 11.5) with XML format support. Users can export products, orders, inventory, and shipments to XML files with schema validation. Useful for custom ERP integrations, data migration, and compliance reporting.

---

## MVP Scope

**MVP Includes**:
- XML export for products, orders, inventory, shipments
- MonoPilot custom XML schema (documented)
- XSD schema generation (for validation)
- Download XML file
- Schema validation before download
- Same export UI as CSV/JSON (add XML option)

**Deferred to Phase 3**:
- Custom XML schema builder (user-defined schemas)
- XSLT transformations
- XML import (reverse operation)
- Schema versioning

---

## User Story

As a **MonoPilot Administrator**, I want to **export data in XML format** so that **I can integrate with custom ERP systems, migrate data to other platforms, or generate compliance reports in standard XML format**.

---

## Scope

**In scope (this story)**
- Add XML option to existing export UI (story 11.5)
- XML serializer (products, orders, inventory, shipments)
- MonoPilot XML schema definition
- XSD schema file generation
- Schema validation before download
- GET /api/integrations/export/:type/schema (download XSD)
- POST /api/integrations/export/:type (with format=xml)

**Out of scope (this story)**
- Custom schema builder (Phase 3)
- XSLT transformations (Phase 3)
- XML import (Phase 3)

---

## Dependencies

### Cross-Epic Dependencies

| Dependency | Story/Epic | Type | What It Provides | Status |
|------------|------------|------|------------------|--------|
| 01.1 | Org Context + RLS | HARD | organizations table | Ready |
| 02.1 | Products CRUD | HARD | products table | Ready |

### Within Epic Dependencies

| Dependency | Story | Type | What It Provides |
|------------|-------|------|------------------|
| 11.5 | Data Export (CSV/JSON) | HARD | Export UI, service patterns | Ready |

### Provides To (Downstream)

| Story | What This Provides |
|-------|-------------------|
| Phase 3 | XML patterns for other integrations |

---

## Acceptance Criteria (Given/When/Then)

### AC-1: Export Products to XML

```gherkin
Scenario: Admin exports products as XML
  Given 100 products exist in organization
  When navigating to /integrations/export
  And selecting:
    | Field | Value |
    | Entity | Products |
    | Format | XML |
    | Filters | All products |
  And clicking [Export]
  Then XML file generated: products_export_20250115.xml
  And file structure:
    | Element | Description |
    | <MonoPilot> | Root element |
    | <ExportMetadata> | Timestamp, org, entity type |
    | <Products> | Container for all products |
    | <Product> | Individual product (repeated) |
    |   <ProductCode> | PROD-001 |
    |   <Name> | Flour Premium 1kg |
    |   <Type> | raw_material |
    |   <Unit> | kg |
    |   <Allergens> | Nested allergen elements |
  And file validates against MonoPilot XSD schema

Scenario: Download XSD schema
  Given admin wants XML schema for validation
  When clicking [Download Schema]
  Then XSD file downloaded: monopilot_products_schema.xsd
  And can be used to validate exported XML files
```

### AC-2: XML Product Structure

```gherkin
Scenario: XML format for products
  Given product export
  Then XML contains:
```

```xml
<?xml version="1.0" encoding="UTF-8"?>
<MonoPilot xmlns="http://monopilot.app/schema/v1" version="1.0">
  <ExportMetadata>
    <ExportDate>2025-01-15T14:30:00Z</ExportDate>
    <OrganizationID>org-uuid</OrganizationID>
    <OrganizationName>Example Food Manufacturer</OrganizationName>
    <EntityType>products</EntityType>
    <RecordCount>100</RecordCount>
  </ExportMetadata>
  <Products>
    <Product>
      <ID>prod-uuid-001</ID>
      <ProductCode>PROD-001</ProductCode>
      <Name>Flour Premium 1kg</Name>
      <Type>raw_material</Type>
      <Unit>kg</Unit>
      <Description>Premium wheat flour</Description>
      <Allergens>
        <Allergen>gluten</Allergen>
      </Allergens>
      <ShelfLifeDays>365</ShelfLifeDays>
      <StorageTemp>Room temperature</StorageTemp>
      <CreatedAt>2025-01-01T10:00:00Z</CreatedAt>
    </Product>
    <!-- More products... -->
  </Products>
</MonoPilot>
```

### AC-3: Export Orders to XML

```gherkin
Scenario: Export orders as XML
  Given 50 orders exist
  When exporting orders as XML
  Then XML structure:
```

```xml
<MonoPilot xmlns="http://monopilot.app/schema/v1" version="1.0">
  <ExportMetadata>
    <ExportDate>2025-01-15T14:30:00Z</ExportDate>
    <EntityType>orders</EntityType>
    <RecordCount>50</RecordCount>
  </ExportMetadata>
  <Orders>
    <Order>
      <ID>order-uuid</ID>
      <OrderNumber>PO-2025-001</OrderNumber>
      <OrderDate>2025-01-10</OrderDate>
      <Status>pending</Status>
      <Customer>
        <CustomerID>customer-uuid</CustomerID>
        <CustomerName>Acme Bakery Ltd</CustomerName>
      </Customer>
      <LineItems>
        <LineItem>
          <ProductCode>PROD-001</ProductCode>
          <ProductName>Flour Premium 1kg</ProductName>
          <Quantity>1000</Quantity>
          <Unit>kg</Unit>
          <UnitPrice>2.50</UnitPrice>
          <TotalPrice>2500.00</TotalPrice>
        </LineItem>
      </LineItems>
      <TotalAmount>2500.00</TotalAmount>
    </Order>
  </Orders>
</MonoPilot>
```

### AC-4: Export Inventory to XML

```gherkin
Scenario: Export inventory as XML
  Given inventory levels for 100 products
  When exporting inventory as XML
  Then XML structure:
```

```xml
<MonoPilot xmlns="http://monopilot.app/schema/v1" version="1.0">
  <ExportMetadata>
    <ExportDate>2025-01-15T14:30:00Z</ExportDate>
    <EntityType>inventory</EntityType>
    <RecordCount>100</RecordCount>
  </ExportMetadata>
  <Inventory>
    <InventoryItem>
      <ProductCode>PROD-001</ProductCode>
      <ProductName>Flour Premium 1kg</ProductName>
      <Location>
        <LocationCode>WH-01-A-01</LocationCode>
        <LocationName>Warehouse 1, Aisle A, Shelf 01</LocationName>
      </Location>
      <QuantityOnHand>5000</QuantityOnHand>
      <Unit>kg</Unit>
      <BatchNumber>BATCH-2025-001</BatchNumber>
      <ExpiryDate>2025-12-31</ExpiryDate>
      <Status>available</Status>
    </InventoryItem>
  </Inventory>
</MonoPilot>
```

### AC-5: Export Shipments to XML

```gherkin
Scenario: Export shipments as XML
  Given 20 shipments exist
  When exporting shipments as XML
  Then XML structure:
```

```xml
<MonoPilot xmlns="http://monopilot.app/schema/v1" version="1.0">
  <ExportMetadata>
    <ExportDate>2025-01-15T14:30:00Z</ExportDate>
    <EntityType>shipments</EntityType>
    <RecordCount>20</RecordCount>
  </ExportMetadata>
  <Shipments>
    <Shipment>
      <ID>shipment-uuid</ID>
      <ShipmentNumber>SHP-2025-001</ShipmentNumber>
      <DispatchDate>2025-01-15</DispatchDate>
      <EstDeliveryDate>2025-01-16</EstDeliveryDate>
      <Carrier>DHL</Carrier>
      <TrackingNumber>1234567890</TrackingNumber>
      <Status>in_transit</Status>
      <Customer>
        <CustomerName>Acme Bakery Ltd</CustomerName>
      </Customer>
      <DeliveryAddress>
        <Street>Wiśniowa 12</Street>
        <City>Warsaw</City>
        <PostalCode>02-520</PostalCode>
        <Country>PL</Country>
      </DeliveryAddress>
      <ShipmentItems>
        <ShipmentItem>
          <ProductCode>PROD-001</ProductCode>
          <Quantity>1000</Quantity>
          <BatchNumber>BATCH-2025-001</BatchNumber>
        </ShipmentItem>
      </ShipmentItems>
    </Shipment>
  </Shipments>
</MonoPilot>
```

### AC-6: Schema Validation

```gherkin
Scenario: XML validates against XSD schema
  Given exported XML file
  When validating against XSD schema
  Then no validation errors
  And XML can be parsed by standard XML tools

Scenario: Invalid XML structure
  Given manually edited XML (invalid structure)
  When validating
  Then validation errors reported
  And error messages list missing/invalid elements
```

### AC-7: Large File Handling

```gherkin
Scenario: Export large dataset (10k products)
  Given 10,000 products to export
  When exporting as XML
  Then file generated asynchronously (same as CSV/JSON)
  And progress indicator shown
  And email notification when ready
  And file < 50 MB (compressed if necessary)
```

### AC-8: XSD Schema Download

```gherkin
Scenario: Download XSD schema for products
  Given admin navigates to /integrations/export
  When clicking [Download Schema] (Products)
  Then XSD file downloaded: monopilot_products_v1.xsd
  And schema defines:
    | Element | Type | Required |
    | ProductCode | string | Yes |
    | Name | string | Yes |
    | Type | enum (raw_material, semi_finished, finished_good) | Yes |
    | Unit | string | Yes |
    | Allergens | array of strings | No |
```

### AC-9: Export Options (same as CSV/JSON)

```gherkin
Scenario: Export with filters
  Given export UI with filters
  When selecting:
    | Field | Value |
    | Entity | Products |
    | Format | XML |
    | Type Filter | raw_material |
    | Date Range | Last 30 days |
  Then XML contains only products matching filters
  And metadata includes filter criteria
```

### AC-10: UTF-8 Encoding

```gherkin
Scenario: XML with special characters (Polish diacritics)
  Given product name contains "Chleb pszenny"
  When exporting to XML
  Then file encoding = UTF-8
  And special characters preserved (ł, ą, ć, etc.)
  And XML declaration includes encoding="UTF-8"
```

---

## Implementation Notes

### MonoPilot XML Schema Namespace

```
xmlns="http://monopilot.app/schema/v1"
```

### XSD Schema Example (Products)

```xml
<?xml version="1.0" encoding="UTF-8"?>
<xs:schema xmlns:xs="http://www.w3.org/2001/XMLSchema"
           targetNamespace="http://monopilot.app/schema/v1"
           xmlns="http://monopilot.app/schema/v1"
           elementFormDefault="qualified">

  <xs:element name="MonoPilot">
    <xs:complexType>
      <xs:sequence>
        <xs:element name="ExportMetadata" type="ExportMetadataType"/>
        <xs:element name="Products" type="ProductsType"/>
      </xs:sequence>
      <xs:attribute name="version" type="xs:string" use="required"/>
    </xs:complexType>
  </xs:element>

  <xs:complexType name="ExportMetadataType">
    <xs:sequence>
      <xs:element name="ExportDate" type="xs:dateTime"/>
      <xs:element name="OrganizationID" type="xs:string"/>
      <xs:element name="OrganizationName" type="xs:string"/>
      <xs:element name="EntityType" type="xs:string"/>
      <xs:element name="RecordCount" type="xs:int"/>
    </xs:sequence>
  </xs:complexType>

  <xs:complexType name="ProductsType">
    <xs:sequence>
      <xs:element name="Product" type="ProductType" maxOccurs="unbounded"/>
    </xs:sequence>
  </xs:complexType>

  <xs:complexType name="ProductType">
    <xs:sequence>
      <xs:element name="ID" type="xs:string"/>
      <xs:element name="ProductCode" type="xs:string"/>
      <xs:element name="Name" type="xs:string"/>
      <xs:element name="Type" type="ProductTypeEnum"/>
      <xs:element name="Unit" type="xs:string"/>
      <xs:element name="Description" type="xs:string" minOccurs="0"/>
      <xs:element name="Allergens" type="AllergensType" minOccurs="0"/>
      <xs:element name="ShelfLifeDays" type="xs:int" minOccurs="0"/>
      <xs:element name="StorageTemp" type="xs:string" minOccurs="0"/>
      <xs:element name="CreatedAt" type="xs:dateTime"/>
    </xs:sequence>
  </xs:complexType>

  <xs:simpleType name="ProductTypeEnum">
    <xs:restriction base="xs:string">
      <xs:enumeration value="raw_material"/>
      <xs:enumeration value="semi_finished"/>
      <xs:enumeration value="finished_good"/>
    </xs:restriction>
  </xs:simpleType>

  <xs:complexType name="AllergensType">
    <xs:sequence>
      <xs:element name="Allergen" type="xs:string" maxOccurs="unbounded"/>
    </xs:sequence>
  </xs:complexType>

</xs:schema>
```

### Service Layer

```typescript
// lib/services/xml-export-service.ts

export class XMLExportService {
  /**
   * Export entity to XML
   */
  static async exportToXML(
    entityType: 'products' | 'orders' | 'inventory' | 'shipments',
    filters: ExportFilters,
    orgId: string
  ): Promise<Blob>;

  /**
   * Get XSD schema for entity
   */
  static async getXSDSchema(entityType: string): Promise<Blob>;

  /**
   * Validate XML against XSD schema
   */
  static async validateXML(xml: string, xsd: string): Promise<ValidationResult>;
}
```

---

## Key Business Rules

1. **UTF-8 Encoding**: All XML files use UTF-8 encoding
2. **Namespace**: All exports use `http://monopilot.app/schema/v1`
3. **Pretty Print**: XML formatted with indentation (human-readable)
4. **Schema Versioning**: Schema version in root element (version="1.0")
5. **Validation**: XML validated against XSD before download
6. **Large Files**: Files >10k records processed asynchronously
7. **Metadata**: All exports include ExportMetadata element

---

## Deliverables

### API Routes
- [ ] `POST /api/integrations/export/products` (format=xml)
- [ ] `POST /api/integrations/export/orders` (format=xml)
- [ ] `POST /api/integrations/export/inventory` (format=xml)
- [ ] `POST /api/integrations/export/shipments` (format=xml)
- [ ] `GET /api/integrations/export/schema/:entityType` (download XSD)

### Service Layer
- [ ] `XMLExportService.exportToXML()`
- [ ] `XMLExportService.getXSDSchema()`
- [ ] `XMLExportService.validateXML()`

### Frontend
- [ ] Add XML option to export format dropdown
- [ ] [Download Schema] button

### XSD Schemas
- [ ] `monopilot_products_v1.xsd`
- [ ] `monopilot_orders_v1.xsd`
- [ ] `monopilot_inventory_v1.xsd`
- [ ] `monopilot_shipments_v1.xsd`

### Tests
- [ ] Unit tests: XML serialization, validation (>80% coverage)
- [ ] Integration tests: All export endpoints
- [ ] E2E: Export -> Validate -> Download

---

## Definition of Done

### API
- [ ] All endpoints functional
- [ ] XML export works for all entities

### Service
- [ ] XML serializer complete
- [ ] XSD schemas defined
- [ ] Validation works

### Frontend
- [ ] XML option in export UI
- [ ] Download schema button works

### Testing
- [ ] Unit tests: >80% coverage
- [ ] Integration tests: All endpoints
- [ ] E2E: Full flow passing

---

## Risk Assessment

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| XML size too large | LOW | LOW | Compress files >10 MB |
| Schema complexity | LOW | LOW | Keep schema simple, document well |
| Validation performance | LOW | LOW | Validate sample, not full file |

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2026-01-15 | Initial Phase 2 story creation | ARCHITECT |

---

**Document Status**: Ready for Implementation
**Created**: 2026-01-15
**Lines**: ~450
**Complexity**: S (Small)
**Phase**: 2
