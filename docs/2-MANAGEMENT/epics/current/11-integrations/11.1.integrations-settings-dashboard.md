# 11.1 - Integrations Settings & Dashboard

**Priority**: P0 (MVP)
**Story Points**: M (Medium)
**Type**: fullstack
**Phase**: 1 (MVP)
**Model**: OPUS

**State:** ready
**Estimate:** M (3-4 days)
**Primary PRD:** `docs/1-BASELINE/product/modules/integrations.md` (FR-INT-001)
**Architecture:** `docs/1-BASELINE/architecture/modules/integrations.md` (integration patterns)

---

## Goal

Implement the Integrations Dashboard - a central overview page showing health status of all integrations (Comarch, EDI, API Keys, Webhooks), recent activity feed, error summary, and integration settings navigation. This is the landing page for system administrators managing external system connections.

---

## Integration Context

This story establishes the **foundation for all integration features**:

- Central dashboard for monitoring integration health
- Activity feed showing last 20 integration events
- Error summary panel (failed syncs, pending retries, dead letter queue)
- Navigation shell for all integration management (API Keys, Webhooks, Comarch, EDI, Exports)
- Health status cards showing connection state of each integration type

**Business Value:** Admins can quickly assess integration health without navigating through individual settings pages. Real-time visibility into integration failures enables rapid troubleshooting.

---

## MVP Scope

This story implements Phase 1 (MVP) functionality. Dashboard displays read-only status from existing integration tables.

**MVP Includes**:
- Integrations dashboard page at `/integrations/dashboard`
- Health status cards (4 cards: Comarch, EDI, API Keys, Webhooks)
- Recent activity feed (last 20 events from `integration_logs`)
- Error summary panel (failed events count)
- Settings navigation shell (links to future stories)
- GET /api/integrations/dashboard (aggregated stats)
- GET /api/integrations/health (health check endpoint)
- Dashboard auto-refresh (every 30 seconds)

**Deferred to Phase 2:**
- Real-time WebSocket updates
- Advanced filtering on activity feed
- Custom dashboard widgets
- Export dashboard metrics
- Integration analytics graphs

---

## User Story

As a **System Administrator**, I want to **view a central dashboard showing the status of all integrations** so that **I can quickly identify connection issues, monitor recent activity, and troubleshoot errors without navigating through multiple pages**.

As an **IT Manager**, I want to **see health status cards for each integration type** so that **I can understand at a glance which external systems are connected and operating correctly**.

---

## Dependencies

### Cross-Epic Dependencies

| Dependency | Story/Epic | Type | What It Provides | Status |
|------------|------------|------|------------------|--------|
| 01.1 | Org Context + RLS | HARD | organizations, users, roles tables | Ready |

### Within Epic Dependencies

| Dependency | Story | Type | What It Provides |
|------------|-------|------|------------------|
| None | First story in Epic 11 | - | Foundation for integration module |

### Provides To (Downstream)

| Story | What This Provides |
|-------|-------------------|
| 11.2 | API Keys Management - health status integration |
| 11.3 | Integration Logs - activity feed pattern |
| 11.4 | Webhooks - health status integration |
| 11.5 | Data Export - navigation shell |
| 11.6 | Supplier Portal - navigation shell |

---

## Database Migration

### Migration: Create integration_health table

```sql
-- Migration: YYYYMMDDHHMMSS_create_integration_health.sql

-- Integration health status cache (for dashboard performance)
CREATE TABLE integration_health (
    id                      UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id                  UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    integration_type        TEXT NOT NULL CHECK (integration_type IN ('comarch', 'edi', 'api_keys', 'webhooks', 'export', 'import')),
    status                  TEXT NOT NULL CHECK (status IN ('connected', 'disconnected', 'error', 'not_configured')),
    last_sync_at            TIMESTAMPTZ,
    last_error_at           TIMESTAMPTZ,
    last_error_message      TEXT,
    success_count_24h       INTEGER DEFAULT 0,
    error_count_24h         INTEGER DEFAULT 0,
    metadata                JSONB DEFAULT '{}',
    updated_at              TIMESTAMPTZ NOT NULL DEFAULT now(),

    CONSTRAINT uq_integration_health UNIQUE (org_id, integration_type)
);

-- Indexes
CREATE INDEX idx_integration_health_org ON integration_health(org_id);
CREATE INDEX idx_integration_health_status ON integration_health(org_id, status);

-- RLS Policies
ALTER TABLE integration_health ENABLE ROW LEVEL SECURITY;

CREATE POLICY "integration_health_select" ON integration_health
    FOR SELECT USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

CREATE POLICY "integration_health_insert" ON integration_health
    FOR INSERT WITH CHECK (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

CREATE POLICY "integration_health_update" ON integration_health
    FOR UPDATE USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

-- Trigger for updated_at
CREATE TRIGGER update_integration_health_updated_at
    BEFORE UPDATE ON integration_health
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- =============================================================================
-- Function: Refresh integration health status
-- =============================================================================

CREATE OR REPLACE FUNCTION refresh_integration_health(p_org_id UUID, p_integration_type TEXT)
RETURNS VOID AS $$
DECLARE
    v_status TEXT;
    v_success_count INTEGER;
    v_error_count INTEGER;
    v_last_sync TIMESTAMPTZ;
    v_last_error TIMESTAMPTZ;
    v_last_error_msg TEXT;
BEGIN
    -- Calculate stats from integration_logs (last 24h)
    SELECT
        COUNT(*) FILTER (WHERE status = 'success'),
        COUNT(*) FILTER (WHERE status = 'error'),
        MAX(timestamp) FILTER (WHERE status = 'success'),
        MAX(timestamp) FILTER (WHERE status = 'error'),
        (SELECT error_message FROM integration_logs
         WHERE org_id = p_org_id
           AND integration_type = p_integration_type
           AND status = 'error'
         ORDER BY timestamp DESC LIMIT 1)
    INTO v_success_count, v_error_count, v_last_sync, v_last_error, v_last_error_msg
    FROM integration_logs
    WHERE org_id = p_org_id
      AND integration_type = p_integration_type
      AND timestamp > now() - INTERVAL '24 hours';

    -- Determine status
    IF v_last_sync IS NULL AND v_last_error IS NULL THEN
        v_status := 'not_configured';
    ELSIF v_last_error > v_last_sync OR v_last_sync IS NULL THEN
        v_status := 'error';
    ELSIF v_success_count > 0 THEN
        v_status := 'connected';
    ELSE
        v_status := 'disconnected';
    END IF;

    -- Upsert health record
    INSERT INTO integration_health (
        org_id,
        integration_type,
        status,
        last_sync_at,
        last_error_at,
        last_error_message,
        success_count_24h,
        error_count_24h,
        updated_at
    ) VALUES (
        p_org_id,
        p_integration_type,
        v_status,
        v_last_sync,
        v_last_error,
        v_last_error_msg,
        v_success_count,
        v_error_count,
        now()
    )
    ON CONFLICT (org_id, integration_type) DO UPDATE SET
        status = EXCLUDED.status,
        last_sync_at = EXCLUDED.last_sync_at,
        last_error_at = EXCLUDED.last_error_at,
        last_error_message = EXCLUDED.last_error_message,
        success_count_24h = EXCLUDED.success_count_24h,
        error_count_24h = EXCLUDED.error_count_24h,
        updated_at = now();
END;
$$ LANGUAGE plpgsql;
```

---

## Acceptance Criteria (Given/When/Then)

### AC-1: Dashboard Page Loads

```gherkin
Scenario: Admin navigates to integrations dashboard
  Given user has ADMIN role
  When navigating to /integrations/dashboard
  Then page loads within 2s
  And displays 4 health status cards
  And displays recent activity feed
  And displays error summary panel
  And displays navigation menu to integration settings

Scenario: Non-admin cannot access dashboard
  Given user has VIEWER role
  When attempting to navigate to /integrations/dashboard
  Then user sees 403 Forbidden error
  And is redirected to home page
```

### AC-2: Health Status Cards Display

```gherkin
Scenario: Comarch Optima status card - connected
  Given Comarch integration has successful sync in last 24h
  When dashboard loads
  Then Comarch status card shows:
    | Field | Value |
    | Status | Connected (green badge) |
    | Last Sync | "2 hours ago" |
    | Success Rate | "95% (38/40 syncs)" |
  And clicking card navigates to /integrations/comarch

Scenario: Comarch Optima status card - error
  Given Comarch integration has recent error
  When dashboard loads
  Then Comarch status card shows:
    | Field | Value |
    | Status | Error (red badge) |
    | Last Error | "Invalid credentials" |
    | Error Time | "5 minutes ago" |
  And error icon displayed prominently

Scenario: EDI status card - not configured
  Given EDI has never been configured
  When dashboard loads
  Then EDI status card shows:
    | Field | Value |
    | Status | Not Configured (gray badge) |
    | Message | "Set up EDI to enable order automation" |
  And [Configure] button shown

Scenario: API Keys status card - active count
  Given organization has 3 active API keys
  When dashboard loads
  Then API Keys status card shows:
    | Field | Value |
    | Status | Connected (green badge) |
    | Active Keys | 3 |
    | Total Requests (24h) | 1,247 |
    | Rate Limit Usage | "42%" |

Scenario: Webhooks status card - delivery status
  Given organization has 5 active webhooks
  And 2 webhooks have failed deliveries
  When dashboard loads
  Then Webhooks status card shows:
    | Field | Value |
    | Status | Warning (yellow badge) |
    | Active Webhooks | 5 |
    | Success Rate | "85% (340/400 deliveries)" |
    | Failed Deliveries | 2 |
```

### AC-3: Recent Activity Feed

```gherkin
Scenario: Activity feed shows recent events
  Given integration_logs has 50 events in last 24h
  When dashboard loads
  Then activity feed displays last 20 events
  And events sorted by timestamp DESC (newest first)
  And each event shows:
    | Field | Content |
    | Icon | Type-specific icon (API/webhook/sync) |
    | Timestamp | "5 minutes ago" (relative time) |
    | Type | "Webhook Delivery" |
    | Status | Badge (success/error/warning) |
    | Message | "order.created webhook to https://example.com" |
  And clicking event expands detail view

Scenario: Activity feed - no events
  Given no integration events in last 24h
  When dashboard loads
  Then activity feed shows:
    | Message | "No recent integration activity" |
  And empty state illustration displayed

Scenario: Activity feed - error event detail
  Given activity feed has error event
  When user clicks error event
  Then expanded view shows:
    | Field | Content |
    | Request Body | JSON payload (formatted) |
    | Response Body | Error response |
    | Error Message | "Connection timeout after 30s" |
    | Retry Count | 2 |
  And [Retry Now] button available

Scenario: Activity feed auto-refresh
  Given user viewing dashboard
  And new integration event occurs
  When 30 seconds elapsed
  Then activity feed auto-refreshes
  And new event appears at top
  And toast notification "1 new event" shown
```

### AC-4: Error Summary Panel

```gherkin
Scenario: Error summary shows counts
  Given 5 failed events in last 24h
  And 3 pending retries
  And 2 events in dead letter queue
  When dashboard loads
  Then error summary panel shows:
    | Metric | Value |
    | Failed Syncs (24h) | 5 |
    | Pending Retries | 3 |
    | Dead Letter Queue | 2 |
  And each metric is clickable link

Scenario: Clicking failed syncs navigates to logs
  Given error summary panel visible
  When clicking "Failed Syncs (24h)"
  Then navigates to /integrations/logs?status=error&date_range=24h
  And logs page opens with filters pre-applied

Scenario: Error summary - no errors
  Given no failed events in last 24h
  When dashboard loads
  Then error summary panel shows:
    | Message | "All integrations healthy" |
  And green checkmark icon displayed
```

### AC-5: Navigation Shell

```gherkin
Scenario: Navigation menu displays all sections
  Given dashboard loaded
  When viewing left sidebar
  Then navigation menu shows:
    | Section | Links |
    | Dashboard | (current) |
    | Connections | Comarch Optima, EDI Setup, API Keys, Webhooks |
    | Portals | Supplier Portal, Customer Portal |
    | Data Operations | Export, Import |
    | Logs & Monitoring | Integration Logs, Error Queue |

Scenario: Navigation links to future stories
  Given dashboard loaded
  When clicking "API Keys" in navigation
  Then navigates to /integrations/api-keys (Story 11.2)

Scenario: Active navigation highlight
  Given viewing /integrations/dashboard
  Then "Dashboard" menu item highlighted
  And other menu items not highlighted
```

### AC-6: Dashboard API Endpoint

```gherkin
Scenario: GET /api/integrations/dashboard returns stats
  Given user authenticated as admin
  When requesting GET /api/integrations/dashboard
  Then response is 200 OK
  And body contains:
    | Field | Type |
    | health_status | Object (comarch, edi, api_keys, webhooks) |
    | recent_activity | Array (last 20 events) |
    | error_summary | Object (failed_count, retry_count, dlq_count) |
    | success_rate_24h | Decimal (0-100%) |

Scenario: Dashboard API - RLS enforcement
  Given user from Org A requests dashboard
  When API called
  Then only Org A integration data returned
  And Org B data not visible

Scenario: Dashboard API - non-admin forbidden
  Given user with VIEWER role
  When requesting GET /api/integrations/dashboard
  Then response is 403 Forbidden
```

### AC-7: Health Check Endpoint

```gherkin
Scenario: GET /api/integrations/health checks all integrations
  Given Comarch enabled and connected
  And EDI not configured
  And API Keys active
  And Webhooks active
  When requesting GET /api/integrations/health
  Then response is 200 OK
  And body contains:
    | Integration | Status |
    | comarch | connected |
    | edi | not_configured |
    | api_keys | connected |
    | webhooks | connected |
  And overall_status = "healthy"

Scenario: Health check - integration error
  Given Comarch has authentication error
  When requesting GET /api/integrations/health
  Then overall_status = "degraded"
  And comarch.status = "error"
  And comarch.error_message = "Invalid API credentials"
```

### AC-8: Auto-Refresh Behavior

```gherkin
Scenario: Dashboard auto-refreshes every 30 seconds
  Given user viewing dashboard
  And page loaded at 10:00:00
  When clock reaches 10:00:30
  Then dashboard data re-fetched
  And health cards updated
  And activity feed updated
  And no full page reload

Scenario: Auto-refresh pauses when tab inactive
  Given dashboard loaded and auto-refreshing
  When user switches to different browser tab
  Then auto-refresh pauses
  When user switches back to dashboard tab
  Then auto-refresh resumes immediately
```

### AC-9: Permission Enforcement

```gherkin
Scenario: Admin has full access
  Given user with ADMIN role
  When viewing dashboard
  Then all sections visible
  And all actions available
  And can navigate to all integration settings

Scenario: IT Manager has read-only access
  Given user with IT_MANAGER role
  When viewing dashboard
  Then can view all data
  But cannot modify settings
  And edit buttons hidden

Scenario: Regular user cannot access
  Given user with USER role
  When attempting to access /integrations
  Then redirected to home page
  And toast shows "Insufficient permissions"
```

### AC-10: Mobile Responsiveness

```gherkin
Scenario: Dashboard on mobile screen
  Given user viewing dashboard on mobile (375px width)
  Then health cards stack vertically
  And navigation collapses to hamburger menu
  And activity feed items condensed
  And horizontal scrolling not required

Scenario: Dashboard on tablet
  Given user viewing on tablet (768px width)
  Then health cards display in 2x2 grid
  And activity feed displays alongside error summary
```

### AC-11: Performance Requirements

```gherkin
Scenario: Dashboard load performance
  Given organization has 1000 integration logs
  And 50 API keys
  And 20 webhooks
  When loading dashboard
  Then initial render < 2s
  And health stats load < 500ms
  And activity feed loads < 800ms
  And error summary loads < 300ms

Scenario: Dashboard query optimization
  Given dashboard API called
  Then database queries < 5 total
  And queries use indexes
  And no N+1 query issues
```

### AC-12: Error Handling

```gherkin
Scenario: Integration health unavailable
  Given integration_health table query fails
  When dashboard loads
  Then shows error message per card
  And activity feed still loads
  And error logged to monitoring

Scenario: Activity feed query timeout
  Given integration_logs query times out
  When dashboard loads
  Then shows "Activity feed temporarily unavailable"
  And health cards still display
  And retry button available
```

---

## Implementation Notes

### API Endpoints

```typescript
// =============================================================================
// Dashboard Endpoints
// =============================================================================

// GET /api/integrations/dashboard
interface DashboardResponse {
  health_status: {
    comarch: IntegrationHealth;
    edi: IntegrationHealth;
    api_keys: IntegrationHealth;
    webhooks: IntegrationHealth;
  };
  recent_activity: IntegrationEvent[];
  error_summary: {
    failed_count_24h: number;
    pending_retries: number;
    dead_letter_queue_count: number;
  };
  success_rate_24h: number;
}

interface IntegrationHealth {
  status: 'connected' | 'disconnected' | 'error' | 'not_configured';
  last_sync_at?: string;
  last_error_at?: string;
  last_error_message?: string;
  success_count_24h: number;
  error_count_24h: number;
  metadata?: Record<string, any>;
}

interface IntegrationEvent {
  id: string;
  timestamp: string;
  integration_type: string;
  event_type: string;
  status: 'success' | 'warning' | 'error';
  message: string;
  error_message?: string;
}

// GET /api/integrations/health
interface HealthCheckResponse {
  overall_status: 'healthy' | 'degraded' | 'down';
  integrations: {
    comarch: { status: string; message?: string };
    edi: { status: string; message?: string };
    api_keys: { status: string; active_count?: number };
    webhooks: { status: string; active_count?: number };
  };
  timestamp: string;
}
```

### Validation Schemas (Zod)

```typescript
import { z } from 'zod';

export const integrationTypeEnum = z.enum(['comarch', 'edi', 'api_keys', 'webhooks', 'export', 'import']);
export const healthStatusEnum = z.enum(['connected', 'disconnected', 'error', 'not_configured']);

export const dashboardQuerySchema = z.object({
  refresh: z.boolean().default(false),
});
```

### Service Layer

```typescript
// lib/services/integration-dashboard-service.ts

export class IntegrationDashboardService {
  /**
   * Get dashboard summary data
   */
  static async getDashboard(orgId: string): Promise<DashboardResponse>;

  /**
   * Get health status for all integration types
   */
  static async getHealthStatus(orgId: string): Promise<HealthCheckResponse>;

  /**
   * Refresh health status for specific integration
   */
  static async refreshHealth(orgId: string, integrationType: string): Promise<void>;

  /**
   * Get recent activity feed (last 20 events)
   */
  static async getRecentActivity(orgId: string, limit?: number): Promise<IntegrationEvent[]>;

  /**
   * Get error summary statistics
   */
  static async getErrorSummary(orgId: string): Promise<ErrorSummary>;
}
```

### Frontend Components

```
apps/frontend/app/(authenticated)/integrations/
  dashboard/
    page.tsx                       -- Dashboard page
  layout.tsx                       -- Integration module layout with nav

components/integrations/
  IntegrationsDashboard.tsx        -- Dashboard container
  HealthStatusCard.tsx             -- Status card component
  HealthStatusGrid.tsx             -- Grid of 4 health cards
  ActivityFeed.tsx                 -- Recent activity feed
  ActivityFeedItem.tsx             -- Single activity item (expandable)
  ErrorSummaryPanel.tsx            -- Error summary widget
  IntegrationsNav.tsx              -- Left sidebar navigation
  IntegrationIcon.tsx              -- Type-specific icons
  StatusBadge.tsx                  -- Status badge (connected/error/etc)
```

---

## Key Business Rules

1. **Admin-Only Access**: Only users with ADMIN or IT_MANAGER roles can access integrations module
2. **Health Status Calculation**: Status determined by comparing last_sync_at vs last_error_at timestamps
3. **24-Hour Window**: All metrics and counts calculated from last 24 hours of data
4. **Auto-Refresh**: Dashboard auto-refreshes every 30 seconds, pauses when tab inactive
5. **Activity Feed Limit**: Always show last 20 events (no pagination on dashboard)
6. **RLS Enforcement**: All integration data filtered by org_id
7. **Not Configured State**: Show helpful setup messages for unconfigured integrations
8. **Success Rate**: Calculated as (success_count / (success_count + error_count)) * 100

---

## Deliverables

### Database
- [ ] Migration: `integration_health` table with RLS
- [ ] Function: `refresh_integration_health(org_id, type)`
- [ ] Indexes for performance

### API Routes
- [ ] `GET /api/integrations/dashboard` - Dashboard summary
- [ ] `GET /api/integrations/health` - Health check endpoint

### Service Layer
- [ ] `IntegrationDashboardService.getDashboard()`
- [ ] `IntegrationDashboardService.getHealthStatus()`
- [ ] `IntegrationDashboardService.refreshHealth()`
- [ ] `IntegrationDashboardService.getRecentActivity()`
- [ ] `IntegrationDashboardService.getErrorSummary()`

### Validation
- [ ] `dashboardQuerySchema`

### Frontend
- [ ] Dashboard page (`/integrations/dashboard`)
- [ ] Health status cards (4 types)
- [ ] Activity feed component
- [ ] Error summary panel
- [ ] Navigation shell
- [ ] Auto-refresh logic
- [ ] Status badges
- [ ] Mobile responsive layout

### Tests
- [ ] Unit tests: IntegrationDashboardService methods (>80% coverage)
- [ ] Integration tests: Dashboard API endpoint
- [ ] Health check tests
- [ ] RLS tests: Multi-tenancy isolation
- [ ] E2E: Dashboard load and navigation

---

## Definition of Done

### Database
- [ ] `integration_health` table created with all columns
- [ ] RLS policies enforce org isolation
- [ ] Indexes created for performance
- [ ] Health refresh function works correctly

### API
- [ ] Dashboard endpoint returns correct data structure
- [ ] Health check endpoint validates all integrations
- [ ] Response times:
  - Dashboard: < 1s
  - Health check: < 500ms
- [ ] RLS enforced on all queries
- [ ] Non-admin users receive 403

### Service
- [ ] Dashboard aggregates data from multiple sources
- [ ] Health status calculated correctly
- [ ] Activity feed returns last 20 events
- [ ] Error summary counts accurate

### Frontend
- [ ] Dashboard loads within 2s
- [ ] Health cards display correct status
- [ ] Activity feed shows recent events
- [ ] Error summary panel functional
- [ ] Navigation works
- [ ] Auto-refresh every 30 seconds
- [ ] Mobile responsive
- [ ] Status badges color-coded correctly

### Testing
- [ ] Unit tests: >80% coverage on service
- [ ] Integration tests: All endpoints covered
- [ ] RLS tests: Multi-tenancy verified
- [ ] E2E tests: Dashboard workflow passing

---

## Risk Assessment

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Performance with many logs | MEDIUM | MEDIUM | Pagination, indexes, 24h window limit |
| Auto-refresh battery drain | LOW | LOW | Pause when tab inactive |
| Health status stale data | MEDIUM | LOW | 30s refresh interval, manual refresh button |
| Complex RLS queries | LOW | LOW | Proper indexes, query optimization |

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2026-01-15 | Initial story creation for Epic 11 MVP | ARCHITECT-AGENT |

---

**Document Status**: Ready for Implementation
**Created**: 2026-01-15
**Lines**: ~900
**Complexity**: M (Medium)
**Phase**: 1 (MVP)
