# 11.6 - Supplier Portal & Comarch Basic

**Priority**: P0 (MVP)
**Story Points**: M (Medium)
**Type**: fullstack
**Phase**: 1 (MVP)
**Model**: OPUS

**State:** ready
**Estimate:** M (3-4 days)
**Primary PRD:** `docs/1-BASELINE/product/modules/integrations.md` (FR-INT-009, FR-INT-010, FR-INT-011, FR-INT-012)
**Architecture:** `docs/1-BASELINE/architecture/modules/integrations.md` (portal patterns)

---

## Goal

Implement two critical external integrations: 1) Supplier Portal - public read-only interface for suppliers to view assigned POs and confirm deliveries, and 2) Comarch Optima Basic - push sales invoices to Polish accounting system with authentication configuration. Both reduce manual communication overhead and enable automated data exchange.

---

## User Story

As a **Supplier**, I want to **view my assigned purchase orders in a web portal** so that **I can see order details, delivery addresses, and confirm deliveries without email exchanges**.

As a **System Administrator**, I want to **push invoices from MonoPilot to Comarch Optima** so that **accounting records stay synchronized without manual data entry**.

---

## Dependencies

### Cross-Epic Dependencies

| Dependency | Story/Epic | Type | What It Provides | Status |
|------------|------------|------|------------------|--------|
| 01.1 | Org Context + RLS | HARD | organizations, users, roles tables | Ready |
| 03.x | Planning | HARD | purchase_orders, po_lines tables | Partial |
| 11.1 | Dashboard | SOFT | integration_health, nav shell | Ready |
| 11.3 | Integration Logs | HARD | Sync logging | Ready |

### Provides To (Downstream)

| Story | What This Provides |
|-------|-------------------|
| Suppliers | External portal access |
| Accounting | Comarch Optima invoice sync |

---

## Database Migration

### Migration: Create supplier portal and Comarch tables

```sql
-- Migration: YYYYMMDDHHMMSS_create_supplier_portal_comarch.sql

-- =============================================================================
-- Supplier Portal Users
-- =============================================================================

CREATE TABLE supplier_portal_users (
    id                  UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id              UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    supplier_id         UUID NOT NULL REFERENCES suppliers(id) ON DELETE CASCADE,

    -- Authentication (separate from MonoPilot users)
    email               VARCHAR(255) NOT NULL,
    password_hash       VARCHAR(255) NOT NULL, -- bcrypt
    token               VARCHAR(255) UNIQUE, -- Optional token-based access

    -- User details
    name                VARCHAR(255) NOT NULL,
    status              VARCHAR(20) NOT NULL DEFAULT 'active' CHECK (status IN ('active', 'suspended')),

    -- Usage tracking
    last_login_at       TIMESTAMPTZ,
    login_count         INTEGER DEFAULT 0,

    -- Audit
    created_by          UUID REFERENCES users(id),
    created_at          TIMESTAMPTZ NOT NULL DEFAULT now(),
    updated_at          TIMESTAMPTZ NOT NULL DEFAULT now(),

    CONSTRAINT uq_supplier_portal_email UNIQUE (org_id, email)
);

-- Indexes
CREATE INDEX idx_supplier_portal_users_org ON supplier_portal_users(org_id);
CREATE INDEX idx_supplier_portal_users_supplier ON supplier_portal_users(supplier_id);
CREATE INDEX idx_supplier_portal_users_email ON supplier_portal_users(email);
CREATE INDEX idx_supplier_portal_users_token ON supplier_portal_users(token) WHERE token IS NOT NULL;

-- RLS Policies (suppliers can only see own data)
ALTER TABLE supplier_portal_users ENABLE ROW LEVEL SECURITY;

-- Suppliers can view own profile
CREATE POLICY "supplier_portal_users_own_select" ON supplier_portal_users
    FOR SELECT USING (
        id = auth.uid() -- Special auth for portal users
    );

-- Admins can manage supplier users
CREATE POLICY "supplier_portal_users_admin_all" ON supplier_portal_users
    FOR ALL USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
        AND (SELECT r.code FROM roles r JOIN users u ON u.role_id = r.id WHERE u.id = auth.uid()) IN ('SUPER_ADMIN', 'ADMIN')
    );

-- Trigger for updated_at
CREATE TRIGGER update_supplier_portal_users_updated_at
    BEFORE UPDATE ON supplier_portal_users
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- =============================================================================
-- Delivery Confirmations (from supplier portal)
-- =============================================================================

CREATE TABLE supplier_delivery_confirmations (
    id                  UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id              UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    purchase_order_id   UUID NOT NULL REFERENCES purchase_orders(id) ON DELETE CASCADE,
    supplier_id         UUID NOT NULL REFERENCES suppliers(id) ON DELETE CASCADE,

    -- Confirmation details
    confirmed_by        UUID REFERENCES supplier_portal_users(id),
    confirmed_at        TIMESTAMPTZ NOT NULL DEFAULT now(),
    delivery_note_number VARCHAR(100),
    delivery_note_file  TEXT, -- S3 URL to uploaded PDF

    -- Line items confirmation (JSONB array)
    line_confirmations  JSONB NOT NULL, -- [{"po_line_id": "uuid", "qty_delivered": 100}]

    -- Status
    status              VARCHAR(20) NOT NULL DEFAULT 'pending_approval' CHECK (status IN ('pending_approval', 'approved', 'rejected')),
    approved_by         UUID REFERENCES users(id),
    approved_at         TIMESTAMPTZ,
    rejection_reason    TEXT,

    created_at          TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- Indexes
CREATE INDEX idx_delivery_confirmations_org ON supplier_delivery_confirmations(org_id);
CREATE INDEX idx_delivery_confirmations_po ON supplier_delivery_confirmations(purchase_order_id);
CREATE INDEX idx_delivery_confirmations_status ON supplier_delivery_confirmations(status, created_at);

-- RLS Policies
ALTER TABLE supplier_delivery_confirmations ENABLE ROW LEVEL SECURITY;

CREATE POLICY "delivery_confirmations_select" ON supplier_delivery_confirmations
    FOR SELECT USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
        OR supplier_id = (SELECT supplier_id FROM supplier_portal_users WHERE id = auth.uid())
    );

CREATE POLICY "delivery_confirmations_insert" ON supplier_delivery_confirmations
    FOR INSERT WITH CHECK (
        supplier_id = (SELECT supplier_id FROM supplier_portal_users WHERE id = auth.uid())
    );

-- =============================================================================
-- Comarch Optima Configuration
-- =============================================================================

CREATE TABLE comarch_optima_config (
    id                  UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id              UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,

    -- Connection settings
    enabled             BOOLEAN NOT NULL DEFAULT false,
    api_url             VARCHAR(500) NOT NULL,
    api_key             VARCHAR(255) NOT NULL,
    api_secret_encrypted TEXT NOT NULL, -- AES-256 encrypted
    company_code        VARCHAR(50),
    test_mode           BOOLEAN NOT NULL DEFAULT true,

    -- Sync settings
    auto_sync           BOOLEAN NOT NULL DEFAULT false, -- Phase 2

    -- Status
    last_sync_at        TIMESTAMPTZ,
    last_error_at       TIMESTAMPTZ,
    last_error_message  TEXT,

    -- Audit
    created_by          UUID REFERENCES users(id),
    created_at          TIMESTAMPTZ NOT NULL DEFAULT now(),
    updated_at          TIMESTAMPTZ NOT NULL DEFAULT now(),

    CONSTRAINT uq_comarch_config_org UNIQUE (org_id)
);

-- Indexes
CREATE INDEX idx_comarch_config_org ON comarch_optima_config(org_id);

-- RLS Policies
ALTER TABLE comarch_optima_config ENABLE ROW LEVEL SECURITY;

CREATE POLICY "comarch_config_admin_all" ON comarch_optima_config
    FOR ALL USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
        AND (SELECT r.code FROM roles r JOIN users u ON u.role_id = r.id WHERE u.id = auth.uid()) IN ('SUPER_ADMIN', 'ADMIN')
    );

-- Trigger for updated_at
CREATE TRIGGER update_comarch_config_updated_at
    BEFORE UPDATE ON comarch_optima_config
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- =============================================================================
-- Invoice Sync Status (track Comarch sync per invoice)
-- =============================================================================

CREATE TABLE comarch_invoice_sync (
    id                  UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id              UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    invoice_id          UUID NOT NULL, -- Future: REFERENCES invoices(id)

    -- Sync status
    sync_status         VARCHAR(20) NOT NULL DEFAULT 'pending' CHECK (sync_status IN ('pending', 'synced', 'failed')),
    comarch_invoice_id  VARCHAR(100), -- Comarch Optima invoice ID
    sync_attempted_at   TIMESTAMPTZ,
    synced_at           TIMESTAMPTZ,
    error_message       TEXT,

    created_at          TIMESTAMPTZ NOT NULL DEFAULT now(),
    updated_at          TIMESTAMPTZ NOT NULL DEFAULT now(),

    CONSTRAINT uq_comarch_invoice UNIQUE (org_id, invoice_id)
);

-- Indexes
CREATE INDEX idx_comarch_invoice_sync_org ON comarch_invoice_sync(org_id);
CREATE INDEX idx_comarch_invoice_sync_status ON comarch_invoice_sync(sync_status, sync_attempted_at);

-- RLS Policies
ALTER TABLE comarch_invoice_sync ENABLE ROW LEVEL SECURITY;

CREATE POLICY "comarch_invoice_sync_select" ON comarch_invoice_sync
    FOR SELECT USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

-- Trigger for updated_at
CREATE TRIGGER update_comarch_invoice_sync_updated_at
    BEFORE UPDATE ON comarch_invoice_sync
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();
```

---

## Acceptance Criteria (Given/When/Then)

### Part 1: Supplier Portal

#### AC-1: Supplier Portal Login

```gherkin
Scenario: Supplier logs in via portal
  Given supplier portal user exists
  When navigating to /portal/supplier
  And entering email + password
  And clicking [Login]
  Then session created
  And redirected to /portal/supplier/dashboard
  And last_login_at updated

Scenario: Invalid credentials
  Given incorrect email or password
  When attempting login
  Then error "Invalid email or password" shown
  And login_count not incremented
  And failed attempt logged

Scenario: Suspended user cannot login
  Given supplier user with status = "suspended"
  When attempting login
  Then error "Account suspended - contact your buyer"
  And login blocked
```

#### AC-2: View Purchase Orders List

```gherkin
Scenario: Supplier views assigned POs
  Given supplier logged in
  And supplier has 5 assigned POs
  When viewing PO list
  Then table displays:
    | Column | Content |
    | PO Number | "PO-2025-001" |
    | Date | "2025-01-15" |
    | Due Date | "2025-01-30" |
    | Total Lines | 3 |
    | Total Amount | "$1,250.00" |
    | Status | Badge (draft/sent/received) |
  And only own POs visible (filtered by supplier_id)

Scenario: Filter POs by status
  Given PO list displayed
  When filtering by status = "sent"
  Then only sent POs shown
  And draft/received POs hidden
```

#### AC-3: View PO Details

```gherkin
Scenario: Supplier views PO detail
  Given supplier clicks PO number
  When PO detail page loads
  Then displays:
    | Section | Data |
    | Header | PO number, date, delivery address, due date |
    | Line Items | Product code, description, qty ordered, unit, unit price, total |
    | Totals | Subtotal, tax, total amount |
    | Delivery Instructions | Notes from buyer |
    | Attachments | PDF files (if any) |
  And [Confirm Delivery] button shown (if status = "sent")

Scenario: Supplier cannot view other suppliers' POs
  Given Supplier A logged in
  When attempting to access Supplier B's PO (by ID)
  Then 404 Not Found
  And no data leaked
```

#### AC-4: Confirm Delivery

```gherkin
Scenario: Supplier confirms delivery
  Given PO with status = "sent"
  When clicking [Confirm Delivery]
  Then modal opens with:
    - Editable qty fields per line item
    - Delivery note number input
    - File upload for delivery note PDF
    - [Submit Confirmation] button

Scenario: Submit delivery confirmation
  Given delivery confirmation form
  When entering:
    - Line 1: qty_delivered = 100 (ordered: 100)
    - Line 2: qty_delivered = 95 (ordered: 100)
    - Delivery note number = "DN-2025-001"
  And uploading delivery note PDF
  And clicking [Submit]
  Then supplier_delivery_confirmations record created
  And status = "pending_approval"
  And file uploaded to S3
  And email sent to purchaser
  And success message "Delivery confirmed - pending buyer approval"

Scenario: Validation - delivered qty exceeds ordered
  Given line ordered qty = 100
  When entering qty_delivered = 120
  Then warning shown "Delivered quantity exceeds ordered (120 > 100)"
  And confirmation allowed with warning (not blocked)

Scenario: Validation - at least one line required
  Given delivery confirmation form
  When all qty_delivered = 0
  Then error "At least one line must have quantity > 0"
  And submission blocked
```

#### AC-5: Buyer Approves/Rejects Confirmation

```gherkin
Scenario: Buyer approves delivery confirmation
  Given delivery confirmation status = "pending_approval"
  When buyer clicks [Approve]
  Then status = "approved"
  And warehouse receipt created (pending receipt)
  And PO status updated to "partially_received" or "received"
  And approved_at = now()
  And approved_by = buyer user ID

Scenario: Buyer rejects confirmation
  Given delivery confirmation pending
  When buyer clicks [Reject]
  And entering rejection_reason = "Incorrect quantities"
  Then status = "rejected"
  And supplier notified via email
  And PO status unchanged
```

### Part 2: Comarch Optima Integration

#### AC-6: Configure Comarch Connection

```gherkin
Scenario: Admin configures Comarch Optima
  Given user has ADMIN role
  When navigating to /integrations/comarch
  Then configuration form displays:
    | Field | Type |
    | Enabled | Toggle |
    | API URL | Text input (default: https://api.comarch.pl) |
    | API Key | Password input |
    | API Secret | Password input (encrypted) |
    | Company Code | Text input |
    | Test Mode | Toggle |
  And [Test Connection] button
  And [Save Configuration] button

Scenario: Save Comarch configuration
  Given configuration form filled
  When clicking [Save]
  Then comarch_optima_config record upserted
  And api_secret encrypted with AES-256
  And success message "Configuration saved"
  And updated_at timestamp refreshed
```

#### AC-7: Test Comarch Connection

```gherkin
Scenario: Test connection - success
  Given Comarch config saved
  When clicking [Test Connection]
  Then API call to Comarch Optima /api/ping
  And credentials validated
  If success:
    - Success message "Connection successful"
    - Green checkmark icon shown
  And test result logged

Scenario: Test connection - failure
  Given invalid credentials
  When testing connection
  Then error message shown:
    - "Authentication failed - check API key/secret"
    - Or "Connection timeout - check URL"
  And red X icon shown
  And error logged to integration_logs
```

#### AC-8: Push Invoice to Comarch

```gherkin
Scenario: Manual invoice push
  Given invoice finalized
  And Comarch Optima enabled
  When clicking [Push to Optima] on invoice detail
  Then invoice data mapped to Comarch format:
    | MonoPilot Field | Comarch Field |
    | invoice_number | NumerDokumentu |
    | issue_date | DataWystawienia |
    | customer.name | Kontrahent.Nazwa |
    | customer.tax_id | Kontrahent.NIP |
    | line_items[].product_code | Pozycja.KodTowaru |
    | line_items[].qty | Pozycja.Ilosc |
    | line_items[].unit_price | Pozycja.CenaJedn |
    | line_items[].vat_rate | Pozycja.StawkaVAT |
    | total_net | WartoscNetto |
    | total_gross | WartoscBrutto |
  And POST /api/faktury to Comarch Optima
  And request logged to integration_logs

Scenario: Push success
  Given invoice push request sent
  When Comarch responds 200 OK
  Then comarch_invoice_sync created/updated:
    - sync_status = "synced"
    - comarch_invoice_id = response ID
    - synced_at = now()
  And invoice marked as "synced"
  And success toast "Invoice synced to Comarch Optima"

Scenario: Push failure
  Given invoice push request sent
  When Comarch responds 500 Internal Server Error
  Then comarch_invoice_sync updated:
    - sync_status = "failed"
    - error_message = response error
    - sync_attempted_at = now()
  And error toast shown
  And [Retry] button available
  And error logged
```

#### AC-9: Invoice Sync Status Indicator

```gherkin
Scenario: Invoice list shows sync status
  Given invoice list page
  Then each invoice shows sync badge:
    | Status | Badge |
    | Not synced | Gray "Not Synced" |
    | Synced | Green "Synced" |
    | Failed | Red "Sync Failed" |
  And clicking badge shows sync details

Scenario: Invoice detail sync section
  Given invoice detail page
  And Comarch Optima enabled
  Then sync status section displays:
    - Sync status badge
    - Last sync attempt
    - Comarch invoice ID (if synced)
    - Error message (if failed)
    - [Push to Optima] button (if not synced or failed)
```

#### AC-10: Comarch Integration Health

```gherkin
Scenario: Dashboard shows Comarch health
  Given Comarch Optima enabled
  And 38 successful syncs, 2 failed (last 24h)
  When viewing integrations dashboard
  Then Comarch health card shows:
    | Metric | Value |
    | Status | Connected (green) |
    | Last Sync | "10 minutes ago" |
    | Success Rate | "95% (38/40)" |
    | Failed Syncs | 2 |

Scenario: Comarch disabled or not configured
  Given Comarch enabled = false
  When viewing dashboard
  Then Comarch health card shows:
    | Status | Not Configured (gray) |
    | Message | "Configure Comarch Optima to sync invoices" |
  And [Configure] button shown
```

#### AC-11: Error Handling & Retry

```gherkin
Scenario: Retry failed invoice sync
  Given invoice with sync_status = "failed"
  When clicking [Retry]
  Then invoice push attempted again
  And sync_attempted_at updated
  If success: status = "synced"
  If failure: error_message updated

Scenario: Comarch API timeout
  Given invoice push in progress
  When Comarch API does not respond within 30s
  Then request cancelled
  And error_message = "Request timeout"
  And sync_status = "failed"
  And retry available
```

---

## Implementation Notes

### API Endpoints

```typescript
// =============================================================================
// Supplier Portal Endpoints (PUBLIC - no MonoPilot auth)
// =============================================================================

// POST /api/portal/supplier/login - Supplier login
interface SupplierLoginRequest {
  email: string;
  password: string;
}

interface SupplierLoginResponse {
  token: string; // JWT for portal session
  supplier: {
    id: string;
    name: string;
    email: string;
  };
}

// GET /api/portal/supplier/orders - List supplier's POs
interface SupplierPOListResponse {
  purchase_orders: SupplierPO[];
  total: number;
}

// GET /api/portal/supplier/orders/:id - PO details
interface SupplierPO {
  id: string;
  po_number: string;
  po_date: string;
  due_date: string;
  status: string;
  delivery_address: Address;
  line_items: POLineItem[];
  total_amount: number;
  notes: string;
  attachments?: Attachment[];
}

// POST /api/portal/supplier/orders/:id/confirm - Confirm delivery
interface ConfirmDeliveryRequest {
  line_confirmations: Array<{
    po_line_id: string;
    qty_delivered: number;
  }>;
  delivery_note_number?: string;
  delivery_note_file?: File; // Multipart upload
}

// =============================================================================
// Comarch Optima Endpoints (ADMIN ONLY)
// =============================================================================

// GET /api/integrations/comarch/config - Get config
// PUT /api/integrations/comarch/config - Save config
interface ComarchConfig {
  enabled: boolean;
  api_url: string;
  api_key: string;
  api_secret: string; // Never returned, only for update
  company_code: string;
  test_mode: boolean;
  auto_sync: boolean;
}

// POST /api/integrations/comarch/test - Test connection
interface ComarchTestResponse {
  success: boolean;
  message: string;
  response_time_ms?: number;
}

// POST /api/integrations/comarch/push-invoice - Push invoice
interface PushInvoiceRequest {
  invoice_id: string;
}

interface PushInvoiceResponse {
  success: boolean;
  comarch_invoice_id?: string;
  error?: string;
}
```

### Validation Schemas (Zod)

```typescript
import { z } from 'zod';

// Supplier Portal
export const supplierLoginSchema = z.object({
  email: z.string().email(),
  password: z.string().min(1),
});

export const confirmDeliverySchema = z.object({
  line_confirmations: z.array(
    z.object({
      po_line_id: z.string().uuid(),
      qty_delivered: z.number().min(0),
    })
  ).min(1, 'At least one line confirmation required'),
  delivery_note_number: z.string().max(100).optional(),
  delivery_note_file: z.any().optional(),
}).refine(
  (data) => data.line_confirmations.some(lc => lc.qty_delivered > 0),
  { message: 'At least one line must have qty_delivered > 0' }
);

// Comarch Optima
export const comarchConfigSchema = z.object({
  enabled: z.boolean().default(false),
  api_url: z.string().url(),
  api_key: z.string().min(1),
  api_secret: z.string().min(1).optional(), // Only on create/update
  company_code: z.string().max(50).optional(),
  test_mode: z.boolean().default(true),
  auto_sync: z.boolean().default(false),
});

export const pushInvoiceSchema = z.object({
  invoice_id: z.string().uuid(),
});
```

### Service Layer

```typescript
// lib/services/supplier-portal-service.ts

export class SupplierPortalService {
  static async authenticate(email: string, password: string): Promise<SupplierLoginResponse>;
  static async getPurchaseOrders(supplierId: string, filters?: Filters): Promise<SupplierPO[]>;
  static async getPurchaseOrder(supplierId: string, poId: string): Promise<SupplierPO | null>;
  static async confirmDelivery(supplierId: string, poId: string, data: ConfirmDeliveryRequest): Promise<void>;
  static async uploadDeliveryNote(file: File): Promise<string>; // Returns S3 URL
}

// lib/services/comarch-optima-service.ts

export class ComarchOptimaService {
  static async getConfig(orgId: string): Promise<ComarchConfig | null>;
  static async saveConfig(orgId: string, config: ComarchConfig, userId: string): Promise<void>;
  static async testConnection(orgId: string): Promise<ComarchTestResponse>;
  static async pushInvoice(invoiceId: string): Promise<PushInvoiceResponse>;
  static async mapInvoiceToComarch(invoice: Invoice): Promise<ComarchInvoice>;
  static encryptSecret(secret: string): Promise<string>;
  static decryptSecret(encrypted: string): Promise<string>;
}
```

### Frontend Components

```
apps/frontend/app/(unauthenticated)/portal/
  supplier/
    login/
      page.tsx                  -- Supplier login page
    dashboard/
      page.tsx                  -- Supplier PO list
    orders/
      [id]/
        page.tsx                -- PO detail page

components/supplier-portal/
  SupplierLogin.tsx             -- Login form
  SupplierPOList.tsx            -- PO table
  SupplierPODetail.tsx          -- PO detail view
  ConfirmDeliveryModal.tsx      -- Delivery confirmation form
  DeliveryNoteUpload.tsx        -- File upload component

apps/frontend/app/(authenticated)/integrations/
  comarch/
    page.tsx                    -- Comarch config page

components/integrations/comarch/
  ComarchConfigForm.tsx         -- Config form
  TestConnectionButton.tsx      -- Test button
  InvoiceSyncStatus.tsx         -- Sync status badge/panel
  PushInvoiceButton.tsx         -- Manual push button
```

---

## Key Business Rules

### Supplier Portal
1. **Separate Authentication**: Portal users separate from MonoPilot users
2. **Read-Only**: Suppliers can only view POs, not edit
3. **Supplier Isolation**: Each supplier sees only own POs (RLS by supplier_id)
4. **Delivery Confirmation**: Creates pending approval record, not auto-receipt
5. **File Upload**: Delivery note PDF optional, stored in S3
6. **Email Notifications**: Sent to purchaser on delivery confirmation

### Comarch Optima
7. **HTTPS Only**: API URL must use HTTPS
8. **Secret Encryption**: api_secret encrypted with AES-256 at rest
9. **Test Mode**: Test mode uses sandbox environment
10. **Manual Sync MVP**: Auto-sync deferred to Phase 2
11. **Invoice Mapping**: Standard Comarch Optima API v2 format
12. **Retry Logic**: Failed syncs can be manually retried
13. **Admin-Only**: Only ADMIN can configure Comarch settings

---

## Deliverables

### Database
- [ ] `supplier_portal_users` table with RLS
- [ ] `supplier_delivery_confirmations` table with RLS
- [ ] `comarch_optima_config` table with RLS
- [ ] `comarch_invoice_sync` table with RLS
- [ ] Indexes for performance

### API Routes
- [ ] POST /api/portal/supplier/login
- [ ] GET /api/portal/supplier/orders
- [ ] GET /api/portal/supplier/orders/:id
- [ ] POST /api/portal/supplier/orders/:id/confirm
- [ ] GET /api/integrations/comarch/config
- [ ] PUT /api/integrations/comarch/config
- [ ] POST /api/integrations/comarch/test
- [ ] POST /api/integrations/comarch/push-invoice

### Service Layer
- [ ] SupplierPortalService with all methods
- [ ] ComarchOptimaService with all methods
- [ ] Comarch invoice mapping logic
- [ ] AES-256 encryption/decryption

### Validation
- [ ] supplierLoginSchema
- [ ] confirmDeliverySchema
- [ ] comarchConfigSchema
- [ ] pushInvoiceSchema

### Frontend
- [ ] Supplier portal login page
- [ ] Supplier PO list page
- [ ] Supplier PO detail page
- [ ] Delivery confirmation modal
- [ ] Comarch config form
- [ ] Test connection button
- [ ] Invoice sync status indicator
- [ ] Push invoice button

### Tests
- [ ] Unit tests: Both services (>80% coverage)
- [ ] Integration tests: All endpoints
- [ ] Portal authentication tests
- [ ] Comarch connection tests
- [ ] Invoice mapping tests
- [ ] RLS tests: Supplier isolation
- [ ] E2E: Supplier confirm delivery flow
- [ ] E2E: Comarch invoice push flow

---

## Definition of Done

### Database
- [ ] All tables created with constraints
- [ ] RLS policies enforce isolation
- [ ] Indexes optimized
- [ ] Encryption for secrets

### API
- [ ] All endpoints functional
- [ ] Portal authentication works
- [ ] PO access filtered correctly
- [ ] Comarch test connection works
- [ ] Invoice push succeeds
- [ ] Response times acceptable

### Service
- [ ] Supplier login validates correctly
- [ ] Delivery confirmations create records
- [ ] Comarch config saves with encrypted secret
- [ ] Invoice mapping accurate
- [ ] Retry logic works

### Frontend
- [ ] Supplier portal login works
- [ ] PO list displays correctly
- [ ] Delivery confirmation submits
- [ ] Comarch config form saves
- [ ] Test connection displays results
- [ ] Invoice sync status visible
- [ ] Push invoice triggers sync

### Testing
- [ ] Unit tests: >80% coverage
- [ ] Integration tests passing
- [ ] Authentication tested
- [ ] RLS verified
- [ ] E2E workflows passing

---

## Risk Assessment

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Supplier credentials leak | HIGH | LOW | Bcrypt hashing, session management, audit logs |
| Comarch API changes | MEDIUM | LOW | Version API calls, monitor Comarch docs |
| Invoice mapping errors | HIGH | MEDIUM | Validation before push, test mode, error handling |
| Secret exposure in logs | CRITICAL | LOW | Never log decrypted secrets, encryption at rest |

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2026-01-15 | Initial story for Epic 11 Phase 1 | ARCHITECT-AGENT |

---

**Document Status**: Ready for Implementation
**Created**: 2026-01-15
**Lines**: ~600
**Complexity**: M (Medium)
**Phase**: 1 (MVP)
