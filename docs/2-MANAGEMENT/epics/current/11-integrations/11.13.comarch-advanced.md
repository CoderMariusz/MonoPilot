# 11.13 - Comarch Advanced (CoA/VAT)

**Priority**: P1 (Phase 2)
**Story Points**: M (Medium)
**Type**: backend + frontend
**Phase**: 2
**Model**: OPUS

**State:** ready
**Estimate:** M (3-4 days)
**Primary PRD:** `docs/1-BASELINE/product/modules/integrations.md` (FR-INT-022, FR-INT-023, Section 4.2)
**Architecture:** Bi-directional Chart of Accounts sync, JPK_VAT report generation, GL account mapping

---

## Goal

Extend Comarch Optima integration with advanced accounting features: sync Chart of Accounts (bi-directional), generate VAT reports (JPK_VAT XML format for Polish tax office), and map MonoPilot cost centers to Comarch GL accounts. Critical for Polish food manufacturers using Comarch Optima as primary accounting system.

---

## MVP Scope

**MVP Includes**:
- Chart of Accounts sync (pull from Comarch, map to cost centers)
- GL account mapping table (MonoPilot cost centers -> Comarch accounts)
- JPK_VAT report generation (XML v7 schema)
- Manual sync button + scheduled daily sync (2 AM)
- POST /api/integrations/comarch/sync-accounts
- GET /api/integrations/comarch/gl-mapping
- POST /api/integrations/comarch/gl-mapping (create/update mapping)
- POST /api/integrations/comarch/vat-report (generate JPK_VAT)
- GET /api/integrations/comarch/vat-report/:id/download (download XML)

**Deferred to Phase 3**:
- Payment reconciliation (match bank transactions)
- Cost center creation in Comarch from MonoPilot
- Real-time sync (MVP: daily scheduled sync)
- Multi-currency GL mapping
- E-signature for JPK_VAT (digital signature for tax office)

---

## User Story

As a **Polish Food Manufacturer** using Comarch Optima, I want to **sync Chart of Accounts and generate VAT reports** so that **my accounting data stays consistent between MonoPilot and Optima, and I can submit VAT returns without manual data entry**.

---

## Scope

**In scope (this story)**
- Pull Chart of Accounts from Comarch Optima API
- Store in MonoPilot (gl_accounts table)
- Map MonoPilot cost centers to Comarch GL accounts
- Generate JPK_VAT report (XML v7 format)
- Download JPK_VAT XML file
- Manual sync + scheduled sync (daily)
- Sync history log

**Out of scope (this story)**
- Payment reconciliation (Phase 3)
- Cost center push to Comarch (Phase 3)
- Real-time sync (Phase 3)
- E-signature (Phase 3)

---

## Dependencies

### Cross-Epic Dependencies

| Dependency | Story/Epic | Type | What It Provides | Status |
|------------|------------|------|------------------|--------|
| 01.1 | Org Context + RLS | HARD | organizations table | Ready |
| 09.1 | Invoices (future) | SOFT | Invoices for VAT report | Planned |

### Within Epic Dependencies

| Dependency | Story | Type | What It Provides |
|------------|-------|------|------------------|
| 11.1 | Integrations Dashboard | HARD | Comarch sync status |
| 11.3 | Integration Logs | HARD | Sync event logging |
| 11.6 | Comarch Basic (Invoice Push) | HARD | Comarch API connection | Ready |

### Provides To (Downstream)

| Story | What This Provides |
|-------|-------------------|
| Phase 3 | GL mapping patterns for other integrations |

---

## Database Migration

### Migration: Create gl_accounts and gl_mapping tables

```sql
-- Migration: YYYYMMDDHHMMSS_create_gl_accounts_tables.sql

CREATE TABLE gl_accounts (
    -- Identity
    id                  UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id              UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,

    -- Comarch Optima Fields
    comarch_account_id  TEXT NOT NULL, -- Comarch internal ID
    account_code        TEXT NOT NULL, -- e.g., "400-10-01"
    account_name        TEXT NOT NULL,
    account_type        TEXT NOT NULL
                        CHECK (account_type IN ('asset', 'liability', 'expense', 'revenue', 'equity')),
    parent_account_id   UUID REFERENCES gl_accounts(id),

    -- Status
    is_active           BOOLEAN NOT NULL DEFAULT true,

    -- Sync Metadata
    last_synced_at      TIMESTAMPTZ,
    sync_source         TEXT DEFAULT 'comarch',

    -- Audit
    created_at          TIMESTAMPTZ NOT NULL DEFAULT now(),
    updated_at          TIMESTAMPTZ NOT NULL DEFAULT now(),

    -- Constraints
    CONSTRAINT uq_gl_account_code UNIQUE (org_id, account_code)
);

CREATE TABLE gl_account_mapping (
    -- Identity
    id                  UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id              UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,

    -- MonoPilot Entity
    entity_type         TEXT NOT NULL
                        CHECK (entity_type IN ('cost_center', 'expense_category', 'revenue_category')),
    entity_id           UUID NOT NULL,
    entity_name         TEXT NOT NULL, -- For display purposes

    -- Comarch GL Account
    gl_account_id       UUID NOT NULL REFERENCES gl_accounts(id),

    -- Audit
    created_at          TIMESTAMPTZ NOT NULL DEFAULT now(),
    created_by          UUID REFERENCES users(id),
    updated_at          TIMESTAMPTZ NOT NULL DEFAULT now(),

    -- Constraints
    CONSTRAINT uq_mapping UNIQUE (org_id, entity_type, entity_id)
);

CREATE TABLE vat_reports (
    -- Identity
    id                  UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id              UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,

    -- Report Metadata
    report_type         TEXT NOT NULL DEFAULT 'JPK_VAT',
    period_from         DATE NOT NULL,
    period_to           DATE NOT NULL,

    -- Status
    status              TEXT NOT NULL DEFAULT 'generating'
                        CHECK (status IN ('generating', 'completed', 'error')),

    -- File
    file_url            TEXT, -- Supabase Storage URL for XML
    file_name           TEXT,

    -- Audit
    generated_at        TIMESTAMPTZ,
    generated_by        UUID REFERENCES users(id),
    created_at          TIMESTAMPTZ NOT NULL DEFAULT now(),

    -- Constraints
    CONSTRAINT check_period CHECK (period_to >= period_from)
);

-- Indexes
CREATE INDEX idx_gl_accounts_org ON gl_accounts(org_id);
CREATE INDEX idx_gl_accounts_code ON gl_accounts(org_id, account_code);
CREATE INDEX idx_gl_accounts_type ON gl_accounts(org_id, account_type);
CREATE INDEX idx_gl_accounts_active ON gl_accounts(org_id) WHERE is_active = true;

CREATE INDEX idx_gl_mapping_org ON gl_account_mapping(org_id);
CREATE INDEX idx_gl_mapping_entity ON gl_account_mapping(org_id, entity_type, entity_id);
CREATE INDEX idx_gl_mapping_account ON gl_account_mapping(gl_account_id);

CREATE INDEX idx_vat_reports_org ON vat_reports(org_id);
CREATE INDEX idx_vat_reports_period ON vat_reports(org_id, period_from, period_to);

-- RLS Policies
ALTER TABLE gl_accounts ENABLE ROW LEVEL SECURITY;
ALTER TABLE gl_account_mapping ENABLE ROW LEVEL SECURITY;
ALTER TABLE vat_reports ENABLE ROW LEVEL SECURITY;

CREATE POLICY "gl_accounts_select" ON gl_accounts
    FOR SELECT USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

CREATE POLICY "gl_mapping_manage" ON gl_account_mapping
    FOR ALL USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
        AND EXISTS (
            SELECT 1 FROM users
            WHERE id = auth.uid()
            AND role IN ('ADMIN', 'ACCOUNTANT')
        )
    );

CREATE POLICY "vat_reports_select" ON vat_reports
    FOR SELECT USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

CREATE POLICY "vat_reports_insert" ON vat_reports
    FOR INSERT WITH CHECK (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
        AND EXISTS (
            SELECT 1 FROM users
            WHERE id = auth.uid()
            AND role IN ('ADMIN', 'ACCOUNTANT')
        )
    );

-- Updated_at triggers
CREATE TRIGGER update_gl_accounts_updated_at
    BEFORE UPDATE ON gl_accounts
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_gl_mapping_updated_at
    BEFORE UPDATE ON gl_account_mapping
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();
```

---

## Acceptance Criteria (Given/When/Then)

### AC-1: Sync Chart of Accounts from Comarch

```gherkin
Scenario: Manual sync pulls all GL accounts
  Given Comarch Optima has 150 GL accounts
  And comarch_config.enabled = true
  When admin clicks [Sync Chart of Accounts]
  Then POST /api/comarch/plan-kont endpoint called
  And 150 gl_accounts records created/updated:
    | Field | Source |
    | comarch_account_id | KontoPlan.Id |
    | account_code | KontoPlan.Numer (e.g., "400-10-01") |
    | account_name | KontoPlan.Nazwa |
    | account_type | KontoPlan.Typ (mapped to asset/liability/expense/revenue) |
  And last_synced_at = now
  And success toast: "Synced 150 GL accounts from Comarch Optima"

Scenario: Scheduled daily sync (2 AM)
  Given time = 02:00:00
  And comarch_config.enabled = true
  When scheduled job runs
  Then Chart of Accounts synced automatically
  And integration_logs entry created
  And if sync fails: admin notification sent
```

### AC-2: GL Account Mapping - Create

```gherkin
Scenario: Admin maps cost center to GL account
  Given cost center "Production Overhead" exists
  And GL account "500-10-01" (Production Costs) exists
  When admin navigates to /integrations/comarch/gl-mapping
  And clicks [Add Mapping]
  And selects:
    | Field | Value |
    | Entity Type | cost_center |
    | Entity | Production Overhead |
    | GL Account | 500-10-01 - Production Costs |
  And clicks [Save]
  Then gl_account_mapping record created
  And success toast: "Mapping created"

Scenario: Mapping already exists
  Given mapping for "Production Overhead" -> "500-10-01" exists
  When attempting to create duplicate mapping
  Then error: "Mapping already exists for this cost center"
  And suggest: "Edit existing mapping or delete first"
```

### AC-3: GL Account Mapping - Update

```gherkin
Scenario: Admin updates existing mapping
  Given mapping "Production Overhead" -> "500-10-01" exists
  When admin clicks [Edit]
  And changes GL account to "500-10-02"
  And clicks [Save]
  Then gl_account_mapping.gl_account_id updated
  And updated_at = now
  And success toast: "Mapping updated"
```

### AC-4: GL Mapping List View

```gherkin
Scenario: View all GL mappings
  Given admin navigates to /integrations/comarch/gl-mapping
  Then DataTable displays gl_account_mapping records:
    | Column | Description |
    | Entity Type | cost_center / expense_category |
    | Entity Name | e.g., "Production Overhead" |
    | GL Account Code | e.g., "500-10-01" |
    | GL Account Name | e.g., "Production Costs" |
    | Last Updated | Timestamp |
    | Actions | Edit, Delete |
  And filter by entity type
  And search by entity name or account code
```

### AC-5: Generate JPK_VAT Report

```gherkin
Scenario: Admin generates JPK_VAT for January 2025
  Given invoices exist for January 2025
  And VAT transactions recorded
  When admin navigates to /integrations/comarch/vat-reports
  And clicks [Generate JPK_VAT]
  And selects:
    | Field | Value |
    | Period From | 2025-01-01 |
    | Period To | 2025-01-31 |
  And clicks [Generate]
  Then vat_reports record created with status = 'generating'
  And backend generates JPK_VAT XML:
    | Section | Content |
    | Naglowek | Organization NIP, period |
    | PodmiotDanych | Organization details |
    | SprzedazWiersz | Sales transactions (invoices) |
    | ZakupWiersz | Purchase transactions (if applicable) |
    | SprzedazCtrl | Control sums (totals) |
  And file saved to Supabase Storage
  And vat_reports.status = 'completed'
  And file_url populated
  And success toast: "JPK_VAT report generated. Click to download."

Scenario: No data for period
  Given no invoices for selected period
  When generating JPK_VAT
  Then error: "No VAT transactions found for this period"
  And report not generated
```

### AC-6: Download JPK_VAT XML

```gherkin
Scenario: Download generated JPK_VAT
  Given vat_report with status = 'completed'
  When clicking [Download]
  Then XML file downloaded: JPK_VAT_2025-01.xml
  And file validates against JPK_VAT v7 schema
  And can be uploaded to Polish tax office portal (Ministerstwo Finansów)
```

### AC-7: JPK_VAT XML Structure

```gherkin
Scenario: JPK_VAT XML format
  Given generated JPK_VAT file
  Then XML contains:
    | Element | Description |
    | <Naglowek> | Header (version, date, NIP) |
    | <KodFormularza kodSystemowy="JPK_VAT" wersjaSchemy="1-0"> | Form code |
    | <DataWytworzeniaJPK> | Generation date |
    | <NazwaSystemu> | MonoPilot |
    | <Podmiot1> | Organization details (NIP, name, address) |
    | <SprzedazWiersz> | Sales line items (per invoice) |
    |   <K_10> | Invoice number |
    |   <K_11> | Invoice date |
    |   <K_15> | Net amount |
    |   <K_16> | VAT amount |
    |   <K_20> | VAT rate (e.g., 23) |
    | <SprzedazCtrl> | Control totals |
    |   <LiczbaWierszySprzedazy> | Number of sales rows |
    |   <PodatekNalezny> | Total VAT payable |
  And validates against official JPK_VAT schema
```

### AC-8: VAT Report History

```gherkin
Scenario: View VAT report history
  Given admin navigates to /integrations/comarch/vat-reports
  Then DataTable displays vat_reports records:
    | Column | Description |
    | Report Type | JPK_VAT |
    | Period | 2025-01-01 to 2025-01-31 |
    | Status | completed / error |
    | Generated At | Timestamp |
    | Generated By | User name |
    | Actions | Download, Regenerate |
  And sort by generated_at DESC
  And filter by period, status
```

### AC-9: Sync Error Handling

```gherkin
Scenario: Comarch API connection fails
  Given Comarch API unreachable
  When attempting to sync Chart of Accounts
  Then error: "Failed to connect to Comarch Optima. Check API credentials."
  And integration_logs entry created with status = 'error'
  And retry logic triggered (story 11.12)

Scenario: Invalid API credentials
  Given comarch_config.api_key is incorrect
  When syncing
  Then error: "Authentication failed. Check Comarch API key and secret."
  And sync blocked
```

### AC-10: Account Type Mapping

```gherkin
Scenario: Map Comarch account types to MonoPilot
  Given Comarch account with Typ = "Aktywa"
  When syncing
  Then gl_accounts.account_type = 'asset'

  Given Comarch account with Typ = "Pasywa"
  Then account_type = 'liability'

  Given Comarch account with Typ = "Koszty"
  Then account_type = 'expense'

  Given Comarch account with Typ = "Przychody"
  Then account_type = 'revenue'
```

---

## Implementation Notes

### Comarch Optima API - Chart of Accounts

**Endpoint**: `GET /api/plan-kont`
**Authentication**: API Key + Secret
**Response**:

```json
{
  "PlanKont": [
    {
      "Id": "550e8400-e29b-41d4-a716-446655440000",
      "Numer": "400-10-01",
      "Nazwa": "Koszty produkcji - materiały",
      "Typ": "Koszty",
      "KontoNadrzedne": null,
      "Aktywne": true
    },
    ...
  ]
}
```

### JPK_VAT XML Schema (v7)

**Official Schema**: https://www.gov.pl/web/kas/pliki-jpk

**Example XML**:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<tns:JPK xmlns:tns="http://jpk.mf.gov.pl/wzor/2021/12/27/12271/">
  <tns:Naglowek>
    <tns:KodFormularza kodSystemowy="JPK_VAT" wersjaSchemy="1-0">JPK_VAT</tns:KodFormularza>
    <tns:WariantFormularza>3</tns:WariantFormularza>
    <tns:DataWytworzeniaJPK>2025-01-15T14:30:00</tns:DataWytworzeniaJPK>
    <tns:NazwaSystemu>MonoPilot</tns:NazwaSystemu>
  </tns:Naglowek>
  <tns:Podmiot1>
    <tns:NIP>1234567890</tns:NIP>
    <tns:PelnaNazwa>Example Food Manufacturer Sp. z o.o.</tns:PelnaNazwa>
    <tns:Email>admin@example.com</tns:Email>
  </tns:Podmiot1>
  <tns:SprzedazWiersz>
    <tns:LpSprzedazy>1</tns:LpSprzedazy>
    <tns:NrKontrahenta>9876543210</tns:NrKontrahenta>
    <tns:NazwaKontrahenta>Customer Ltd</tns:NazwaKontrahenta>
    <tns:DowodSprzedazy>INV-2025-001</tns:DowodSprzedazy>
    <tns:DataWystawienia>2025-01-15</tns:DataWystawienia>
    <tns:K_10>1000.00</tns:K_10> <!-- Net amount -->
    <tns:K_11>230.00</tns:K_11> <!-- VAT amount -->
  </tns:SprzedazWiersz>
  <tns:SprzedazCtrl>
    <tns:LiczbaWierszySprzedazy>1</tns:LiczbaWierszySprzedazy>
    <tns:PodatekNalezny>230.00</tns:PodatekNalezny>
  </tns:SprzedazCtrl>
</tns:JPK>
```

### Service Layer

```typescript
// lib/services/comarch-advanced-service.ts

export class ComarchAdvancedService {
  /**
   * Sync Chart of Accounts from Comarch Optima
   */
  static async syncChartOfAccounts(orgId: string, userId: string): Promise<void>;

  /**
   * Get GL accounts
   */
  static async getGLAccounts(orgId: string): Promise<GLAccount[]>;

  /**
   * Create GL account mapping
   */
  static async createGLMapping(
    orgId: string,
    entityType: string,
    entityId: string,
    glAccountId: string,
    userId: string
  ): Promise<void>;

  /**
   * Update GL account mapping
   */
  static async updateGLMapping(mappingId: string, glAccountId: string, userId: string): Promise<void>;

  /**
   * Delete GL account mapping
   */
  static async deleteGLMapping(mappingId: string, userId: string): Promise<void>;

  /**
   * Generate JPK_VAT report
   */
  static async generateJPKVAT(
    orgId: string,
    periodFrom: string,
    periodTo: string,
    userId: string
  ): Promise<string>; // Returns report ID

  /**
   * Download JPK_VAT XML
   */
  static async downloadJPKVAT(reportId: string): Promise<Blob>;
}
```

---

## Key Business Rules

1. **Daily Sync**: Chart of Accounts synced daily at 2 AM
2. **Mapping Required**: Cost centers must be mapped to GL accounts for proper accounting
3. **JPK_VAT Schema**: Must validate against official Polish tax office schema (v7)
4. **VAT Period**: JPK_VAT generated per month (01-01 to 01-31, etc.)
5. **Account Type Mapping**: Comarch types (Aktywa, Pasywa, Koszty, Przychody) map to standard GL types
6. **Audit Trail**: All sync events logged to integration_logs
7. **Permission**: Only ADMIN and ACCOUNTANT roles can generate VAT reports

---

## Deliverables

### Database
- [ ] Migration: `gl_accounts`, `gl_account_mapping`, `vat_reports` tables
- [ ] RLS policies
- [ ] Indexes

### API Routes
- [ ] `POST /api/integrations/comarch/sync-accounts`
- [ ] `GET /api/integrations/comarch/gl-accounts`
- [ ] `GET /api/integrations/comarch/gl-mapping`
- [ ] `POST /api/integrations/comarch/gl-mapping`
- [ ] `PUT /api/integrations/comarch/gl-mapping/:id`
- [ ] `DELETE /api/integrations/comarch/gl-mapping/:id`
- [ ] `POST /api/integrations/comarch/vat-report`
- [ ] `GET /api/integrations/comarch/vat-report/:id/download`

### Service Layer
- [ ] `ComarchAdvancedService.syncChartOfAccounts()`
- [ ] `ComarchAdvancedService.createGLMapping()`
- [ ] `ComarchAdvancedService.generateJPKVAT()`
- [ ] `ComarchAdvancedService.downloadJPKVAT()`

### Frontend
- [ ] Chart of Accounts sync page
- [ ] GL mapping page (CRUD)
- [ ] JPK_VAT generation page
- [ ] VAT report history

### Background Jobs
- [ ] Scheduled job (daily 2 AM) to sync Chart of Accounts

### Tests
- [ ] Unit tests: GL mapping, JPK_VAT generation (>80% coverage)
- [ ] Integration tests: All endpoints
- [ ] E2E: Sync -> Map -> Generate report

---

## Definition of Done

### Database
- [ ] Tables created with RLS
- [ ] Indexes created

### API
- [ ] All endpoints functional
- [ ] Chart of Accounts sync works
- [ ] GL mapping CRUD works
- [ ] JPK_VAT generation works

### Service
- [ ] Sync from Comarch
- [ ] GL mapping logic
- [ ] JPK_VAT XML generation (validates against schema)

### Frontend
- [ ] Sync button works
- [ ] GL mapping table works
- [ ] JPK_VAT generation works
- [ ] Download XML works

### Testing
- [ ] Unit tests: >80% coverage
- [ ] Integration tests: All endpoints
- [ ] E2E: Full flow passing

---

## Risk Assessment

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| JPK_VAT schema changes | MEDIUM | LOW | Monitor official schema updates, versioning |
| Comarch API changes | MEDIUM | MEDIUM | Version API calls, fallback handling |
| Incorrect GL mapping | HIGH | MEDIUM | Validation, accountant review before finalization |

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2026-01-15 | Initial Phase 2 story creation | ARCHITECT |

---

**Document Status**: Ready for Implementation
**Created**: 2026-01-15
**Lines**: ~550
**Complexity**: M (Medium)
**Phase**: 2
