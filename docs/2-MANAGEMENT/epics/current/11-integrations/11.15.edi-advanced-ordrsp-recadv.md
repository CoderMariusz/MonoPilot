# 11.15 - EDI Advanced (ORDRSP/RECADV)

**Priority**: P2 (Phase 3 Enterprise)
**Story Points**: M (Medium)
**Type**: backend
**Phase**: 3
**Model**: OPUS

**State:** ready
**Estimate:** M (3-4 days)
**Primary PRD:** `docs/1-BASELINE/product/modules/integrations.md` (FR-INT-025, FR-INT-026, Section 4.2)
**Architecture:** EDI message parsing, EDIFACT ORDRSP/RECADV, VAN API integration

---

## Goal

Extend EDI capabilities (stories 11.8-11.10) with advanced EDIFACT message types: ORDRSP (Order Response) for confirming/rejecting customer POs, and RECADV (Receiving Advice) for receiving supplier delivery notifications. Completes bi-directional EDI workflow for large retail/distributor partners.

---

## MVP Scope

**MVP Includes**:
- EDIFACT ORDRSP outbound (send order confirmation/rejection to customer)
- EDIFACT RECADV inbound (receive delivery advice from supplier)
- VAN API integration (send/receive via EDI provider)
- Order status update on ORDRSP sent
- GRN auto-creation from RECADV (optional)
- EDI message inbox/outbox UI updates
- ORDRSP/RECADV templates

**Deferred to Future**:
- Additional EDIFACT message types (PRICAT, SLSRPT, etc.)
- AS2 protocol support (currently VAN only)
- EDI trading partner management UI
- Message transformation builder

---

## User Story

As a **Supply Chain Manager**, I want to **send order confirmations (ORDRSP) to customers and receive delivery notifications (RECADV) from suppliers via EDI** so that **I can automate order acknowledgment and receiving processes with trading partners**.

As an **EDI Administrator**, I want to **configure ORDRSP/RECADV message templates and routing** so that **messages are sent/received correctly according to partner specifications**.

---

## Scope

**In scope (this story)**
- EDIFACT ORDRSP outbound message generation
- ORDRSP send via VAN API (POST to EDI provider)
- EDIFACT RECADV inbound parsing
- RECADV receive via VAN API (polling or webhook)
- Sales order status update on ORDRSP sent (confirmed/rejected)
- Optional GRN creation from RECADV
- POST /api/integrations/edi/send/ordrsp
- POST /api/integrations/edi/send/recadv (manual)
- GET /api/integrations/edi/inbox (RECADV messages)
- POST /api/integrations/edi/process/:id (process RECADV)
- EDI configuration for ORDRSP/RECADV templates
- Outbox UI for ORDRSP messages
- Inbox UI for RECADV messages

**Out of scope (this story)**
- Other EDIFACT types (PRICAT, SLSRPT)
- AS2 protocol (use VAN only)
- Partner management UI (manual config in Phase 3)
- Custom field mapping (use standard EDIFACT)

---

## Dependencies

### Cross-Epic Dependencies

| Dependency | Story/Epic | Type | What It Provides | Status |
|------------|------------|------|------------------|--------|
| 01.1 | Org Context + RLS | HARD | organizations, users | Ready |
| 03.1 | Sales Orders CRUD | HARD | sales_orders table | Planned |
| 03.3 | Purchase Orders | HARD | purchase_orders table | Ready |
| 05.11 | GRN from PO | HARD | grns table | Ready |

### Within Epic Dependencies

| Dependency | Story | Type | What It Provides |
|------------|-------|------|------------------|
| 11.3 | Integration Logs | HARD | integration_logs table | Ready |
| 11.8 | EDI ORDERS Inbound | HARD | edi_messages table, parser patterns | Ready |
| 11.9 | EDI INVOIC Outbound | HARD | EDI sender patterns | Ready |

### Provides To (Downstream)

| Story | What This Provides |
|-------|-------------------|
| Phase 3+ | Complete EDI bi-directional workflow |

---

## Acceptance Criteria (Given/When/Then)

### AC-1: ORDRSP Outbound - Order Confirmation

```gherkin
Scenario: Send ORDRSP confirming customer order
  Given customer with EDI enabled sends ORDERS message
  And sales order created from ORDERS (story 11.8)
  And order status = 'pending_confirmation'
  When admin clicks [Send Order Confirmation]
  Then EDIFACT ORDRSP message generated with:
    | Field | EDIFACT Segment | Value |
    | Document Type | BGM.C002.1001 | 231 (Order Response) |
    | Response Type | BGM.C002.1225 | 4 (Accepted) |
    | Order Number | RFF.C506.1154 | Customer order number |
    | Confirmation Date | DTM.2005 | Now |
    | Line Items | LIN segments | All lines with confirmed qty |
  And message sent to VAN API
  And sales_order.status updated to 'confirmed'
  And integration_logs entry created with message_content
  And ORDRSP appears in outbox

Scenario: Send ORDRSP rejecting customer order
  Given sales order cannot be fulfilled
  When admin selects [Reject Order]
  And provides rejection reason
  Then ORDRSP generated with:
    | Response Type | BGM.C002.1225 | 27 (Rejected) |
    | Rejection Reason | FTX.C108.4440 | Provided reason |
  And sales_order.status updated to 'rejected'

Scenario: Partial acceptance in ORDRSP
  Given customer ordered 1000 units but only 800 available
  When sending ORDRSP
  Then line items show:
    | Original Qty | QTY.C186.6060 (qualifier 21) | 1000 |
    | Confirmed Qty | QTY.C186.6060 (qualifier 12) | 800 |
  And sales_order lines updated with confirmed quantities
```

### AC-2: ORDRSP Mapping

```gherkin
Scenario: Map sales order to ORDRSP segments
  Given sales order with customer, lines, delivery date
  Then ORDRSP message includes:
    | MonoPilot Field | EDIFACT Segment | Example |
    | order_number | BGM.C002.1004 | SO-2025-001 |
    | customer.edi_id | NAD+BY.C082.3039 | 5412345000013 |
    | order_date | DTM.2005 | 20250115 |
    | delivery_date | DTM.2005 (qualifier 2) | 20250120 |
    | line[].product_code | LIN.C212.7140 | SKU-001 |
    | line[].qty_ordered | QTY.C186.6060 (21) | 1000 |
    | line[].qty_confirmed | QTY.C186.6060 (12) | 1000 |
    | line[].unit_price | PRI.C509.5118 | 25.50 |
```

### AC-3: RECADV Inbound - Receiving Advice

```gherkin
Scenario: Receive RECADV from supplier
  Given supplier sends RECADV via VAN
  When MonoPilot polls EDI inbox
  Then RECADV message parsed
  And edi_messages entry created with:
    | Field | Value |
    | direction | inbound |
    | message_type | RECADV |
    | status | pending |
    | partner_id | Supplier EDI ID |
  And message appears in inbox UI

Scenario: Process RECADV to create GRN
  Given RECADV message in inbox
  And settings.auto_create_grn_from_recadv = true
  When admin clicks [Process]
  Then system:
    1. Parses RECADV segments
    2. Extracts delivery note number, shipment date, line items
    3. Matches to existing PO (by PO number in RFF segment)
    4. Creates GRN with:
       | Field | Source |
       | grn_number | Auto-generated |
       | po_id | Matched PO |
       | supplier_delivery_note | RECADV RFF.C506.1154 |
       | received_date | RECADV DTM.2005 |
       | grn_items | RECADV LIN/QTY segments |
    5. Updates edi_messages.status to 'processed'
    6. Links edi_messages.reference_id to GRN ID

Scenario: RECADV without matching PO
  Given RECADV with unknown PO number
  When processing message
  Then error "No matching PO found for PO-UNKNOWN-123"
  And edi_messages.status = 'error'
  And edi_messages.error_message populated
  And manual review required
```

### AC-4: RECADV Mapping

```gherkin
Scenario: Parse RECADV to GRN fields
  Given RECADV message
  Then mapping extracts:
    | EDIFACT Segment | MonoPilot Field | Example |
    | BGM.C002.1004 | supplier_delivery_note | DN-2025-001 |
    | DTM.2005 (qualifier 50) | received_date | 2025-01-15 |
    | RFF.C506.1154 (qualifier ON) | po_number | PO-2025-001 |
    | NAD+SU.C082.3039 | supplier_edi_id | 5412345000020 |
    | LIN.1082 | line_sequence | 1 |
    | LIN.C212.7140 | product_code | SKU-001 |
    | QTY.C186.6060 (qualifier 46) | qty_delivered | 1000 |
    | RFF.C506.1154 (qualifier BT) | batch_number | LOT-20250115 |
    | DTM.2005 (qualifier 36) | expiry_date | 2026-01-15 |
```

### AC-5: VAN API Integration

```gherkin
Scenario: Send ORDRSP via VAN API
  Given VAN provider configured (e.g., Seeburger)
  And VAN API credentials set in edi_config
  When sending ORDRSP
  Then POST to VAN endpoint:
    | Field | Value |
    | URL | {van_api_url}/messages/send |
    | Method | POST |
    | Headers | Authorization: Bearer {api_key} |
    | Body | { messageType: "ORDRSP", recipient: "{partner_edi_id}", content: "{edifact_message}" } |
  And VAN returns message ID
  And integration_logs records VAN response

Scenario: Poll VAN for RECADV messages
  Given VAN inbox polling enabled
  When cron job runs every 5 minutes
  Then GET from VAN endpoint:
    | URL | {van_api_url}/messages/inbox |
    | Query | messageType=RECADV&since={last_poll_timestamp} |
  And for each new message:
    - Create edi_messages entry
    - Parse RECADV
    - Trigger processing workflow

Scenario: VAN API error handling
  Given VAN API returns 500 error
  When sending ORDRSP
  Then retry 3 times with exponential backoff
  And if still fails, log to integration_logs
  And mark edi_messages.status = 'send_failed'
  And alert admin
```

### AC-6: EDI Configuration Updates

```gherkin
Scenario: Configure ORDRSP template
  Given EDI config page
  When admin navigates to ORDRSP settings
  Then form shows:
    | Field | Description |
    | Enabled | Enable ORDRSP sending |
    | Auto-send | Auto-send on order confirmation |
    | Response Code Default | 4 (Accepted) or 27 (Rejected) |
    | Partner Mappings | Customer -> EDI ID mapping |
    | VAN Endpoint | ORDRSP send URL |
  And saving updates edi_config.message_types JSON

Scenario: Configure RECADV settings
  Given EDI config page
  When admin navigates to RECADV settings
  Then form shows:
    | Field | Description |
    | Enabled | Enable RECADV receiving |
    | Auto-create GRN | Create GRN on RECADV process |
    | Polling Interval | Minutes between VAN polls |
    | Partner Mappings | Supplier -> EDI ID mapping |
  And saving updates edi_config settings
```

### AC-7: UI - EDI Outbox for ORDRSP

```gherkin
Scenario: View ORDRSP messages in outbox
  Given 10 ORDRSP messages sent
  When navigating to /integrations/edi/outbox
  Then DataTable shows:
    | Column | Content |
    | Message # | edi_messages.id |
    | Type | ORDRSP |
    | Customer | NAD+BY partner name |
    | Order # | Reference order number |
    | Status | sent / send_failed |
    | Sent At | Timestamp |
    | Actions | View, Resend (if failed) |
  And filter by message_type = 'ORDRSP'

Scenario: View ORDRSP message detail
  Given ORDRSP message in outbox
  When clicking message row
  Then modal shows:
    | Section | Content |
    | Header | Message type, status, timestamp |
    | Order Info | Order number, customer, lines |
    | EDIFACT Content | Raw message with syntax highlighting |
    | VAN Response | API response from VAN |
    | Logs | Integration log entries |
```

### AC-8: UI - EDI Inbox for RECADV

```gherkin
Scenario: View RECADV messages in inbox
  Given 5 RECADV messages received
  When navigating to /integrations/edi/inbox
  Then DataTable shows:
    | Column | Content |
    | Message # | edi_messages.id |
    | Type | RECADV |
    | Supplier | NAD+SU partner name |
    | Delivery Note # | BGM document number |
    | Status | pending / processed / error |
    | Received At | Timestamp |
    | Actions | Process, View |
  And filter by message_type = 'RECADV'

Scenario: Process RECADV from inbox
  Given RECADV with status = 'pending'
  When clicking [Process]
  Then processing dialog shows:
    - Matched PO (if found)
    - Line items from RECADV
    - Validation status (all OK / errors)
    - [Create GRN] or [Manual Review] buttons
  And on [Create GRN], GRN created and status = 'processed'
```

### AC-9: Error Handling

```gherkin
Scenario: ORDRSP send failure
  Given VAN API unavailable
  When attempting to send ORDRSP
  Then message status = 'send_failed'
  And retry queue entry created
  And admin notification sent
  And manual resend available

Scenario: RECADV parse error
  Given malformed RECADV message
  When parsing
  Then error logged with specific segment causing issue
  And message status = 'error'
  And message available for manual correction

Scenario: RECADV duplicate detection
  Given RECADV with same delivery note number already processed
  When receiving duplicate
  Then warning "Delivery note DN-2025-001 already processed"
  And admin can choose: Skip / Process Anyway / Review
```

### AC-10: Audit Trail

```gherkin
Scenario: All EDI operations logged
  Given any ORDRSP/RECADV operation
  Then integration_logs entry created with:
    | Field | Value |
    | integration_type | edi |
    | event_type | ordrsp.sent / recadv.received |
    | direction | outbound / inbound |
    | status | success / error |
    | request_body | EDIFACT message content |
    | response_body | VAN API response |
    | duration_ms | Processing time |
```

---

## Implementation Notes

### EDIFACT ORDRSP Structure

```
UNA:+.? '
UNB+UNOC:3+MONOPILOT:14+CUSTOMER:14+20250115:1430+1234'
UNH+1+ORDRSP:D:96A:UN'
BGM+231+SO-2025-001+4'                    // Document type, order #, response code
DTM+137:20250115:102'                     // Message date
DTM+2:20250120:102'                       // Delivery date
RFF+ON:PO-CUSTOMER-001'                   // Customer PO reference
NAD+BY+5412345000013::9'                  // Buyer (customer)
NAD+SU+5412345000020::9'                  // Supplier (us)
LIN+1++SKU-001:SA'                        // Line 1, product code
QTY+21:1000'                              // Original ordered qty
QTY+12:1000'                              // Confirmed qty
PRI+AAA:25.50'                            // Unit price
LIN+2++SKU-002:SA'
QTY+21:500'
QTY+12:0'                                 // Rejected line (qty = 0)
FTX+AAO+++Out of stock'                   // Rejection reason
UNS+S'                                    // Summary section separator
UNT+15+1'                                 // End message
UNZ+1+1234'                               // End interchange
```

### EDIFACT RECADV Structure

```
UNA:+.? '
UNB+UNOC:3+SUPPLIER:14+MONOPILOT:14+20250115:0930+5678'
UNH+1+RECADV:D:96A:UN'
BGM+632+DN-2025-001+9'                    // Receiving advice, delivery note #
DTM+137:20250115:102'                     // Message date
DTM+50:20250115:102'                      // Goods receipt date
RFF+ON:PO-2025-001'                       // Our PO reference
NAD+SU+5412345000020::9'                  // Supplier
NAD+BY+5412345000013::9'                  // Buyer (us)
LIN+1++SKU-001:SA'                        // Line 1
QTY+46:1000'                              // Delivered qty
RFF+BT:LOT-20250115'                      // Batch number
DTM+36:20260115:102'                      // Expiry date
LIN+2++SKU-002:SA'
QTY+46:500'
UNS+S'
UNT+14+1'
UNZ+1+5678'
```

### Service Methods

```typescript
// lib/services/edi-advanced-service.ts

export class EDIAdvancedService {
  /**
   * Generate ORDRSP from sales order
   */
  static async generateORDRSP(
    orderId: string,
    responseType: 'accepted' | 'rejected' | 'partial'
  ): Promise<string>;

  /**
   * Send ORDRSP to customer via VAN
   */
  static async sendORDRSP(
    orderId: string,
    ordrspMessage: string
  ): Promise<{ success: boolean; vanMessageId?: string }>;

  /**
   * Parse RECADV message
   */
  static async parseRECADV(
    messageContent: string
  ): Promise<{
    deliveryNoteNumber: string;
    poNumber: string;
    receivedDate: string;
    supplierEdiId: string;
    lines: Array<{
      productCode: string;
      qtyDelivered: number;
      batchNumber?: string;
      expiryDate?: string;
    }>;
  }>;

  /**
   * Process RECADV to create GRN
   */
  static async processRECADV(
    messageId: string,
    createGrn: boolean
  ): Promise<{ grnId?: string; errors?: string[] }>;

  /**
   * Poll VAN inbox for new messages
   */
  static async pollVANInbox(): Promise<number>; // Returns count of new messages
}
```

### VAN API Client

```typescript
// lib/clients/van-api-client.ts

export class VANAPIClient {
  /**
   * Send EDI message to VAN
   */
  static async sendMessage(params: {
    messageType: string;
    recipientEdiId: string;
    content: string;
  }): Promise<{ messageId: string; status: string }>;

  /**
   * Fetch new messages from VAN inbox
   */
  static async fetchInbox(params: {
    messageType?: string;
    since?: Date;
  }): Promise<Array<{
    messageId: string;
    messageType: string;
    senderEdiId: string;
    content: string;
    receivedAt: Date;
  }>>;
}
```

---

## Deliverables

### Backend
- [ ] EDI Advanced Service (ORDRSP/RECADV logic)
- [ ] VAN API Client (send/receive)
- [ ] ORDRSP generator (sales order -> EDIFACT)
- [ ] RECADV parser (EDIFACT -> GRN data)
- [ ] POST /api/integrations/edi/send/ordrsp
- [ ] POST /api/integrations/edi/process/:id (RECADV)
- [ ] GET /api/integrations/edi/inbox (with RECADV filter)
- [ ] GET /api/integrations/edi/outbox (with ORDRSP filter)
- [ ] Cron job for VAN inbox polling

### Database
- [ ] edi_config updates (message_types JSON includes ORDRSP/RECADV)
- [ ] edi_messages table already exists (story 11.8)

### Frontend
- [ ] EDI Outbox with ORDRSP filter
- [ ] EDI Inbox with RECADV filter
- [ ] Process RECADV dialog
- [ ] ORDRSP message detail modal
- [ ] RECADV message detail modal
- [ ] EDI config updates (ORDRSP/RECADV settings)

### Tests
- [ ] Unit: ORDRSP generator
- [ ] Unit: RECADV parser
- [ ] Integration: Send ORDRSP via VAN mock
- [ ] Integration: Process RECADV to GRN
- [ ] E2E: Full ORDRSP workflow
- [ ] E2E: Full RECADV workflow

---

## Definition of Done

- [ ] ORDRSP generated from sales order with correct EDIFACT syntax
- [ ] ORDRSP sent to VAN API successfully
- [ ] RECADV parsed from VAN inbox
- [ ] GRN created from RECADV with line items
- [ ] EDI config supports ORDRSP/RECADV templates
- [ ] Outbox UI shows ORDRSP messages
- [ ] Inbox UI shows RECADV messages with process action
- [ ] All error scenarios handled (VAN failure, parse errors, duplicate detection)
- [ ] Integration logs capture all EDI operations
- [ ] Unit tests >80% coverage
- [ ] E2E tests pass for both message types

---

## Risk Assessment

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| VAN API unavailability | HIGH | MEDIUM | Retry queue, offline mode, manual resend |
| EDIFACT syntax variations | MEDIUM | HIGH | Configurable templates, validation, partner testing |
| PO matching failures | MEDIUM | MEDIUM | Manual review UI, fuzzy matching |
| GRN auto-creation errors | MEDIUM | LOW | Validation before GRN creation, rollback on error |
| Duplicate RECADV processing | LOW | MEDIUM | Duplicate detection by delivery note # |

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2026-01-15 | Initial Phase 3 story - EDI advanced (ORDRSP/RECADV) | ARCHITECT-AGENT |

---

**Document Status**: Ready for Implementation
**Created**: 2026-01-15
**Lines**: ~540
**Complexity**: M (Medium - 3-4 days)
**Phase**: 3 (Enterprise)
