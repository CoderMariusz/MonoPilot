# 11.7 - Customer Portal

**Priority**: P1 (Phase 2)
**Story Points**: M (Medium)
**Type**: fullstack
**Phase**: 2
**Model**: OPUS

**State:** ready
**Estimate:** M (3-4 days)
**Primary PRD:** `docs/1-BASELINE/product/modules/integrations.md` (FR-INT-013, FR-INT-014, Section 4.2)
**Architecture:** Multi-tenant portal with separate auth (no MonoPilot user access)

---

## Goal

Implement a public customer portal where external customers can track their orders, view production status, and monitor shipments in real-time. Customers access a branded interface isolated from MonoPilot's internal system, using unique credentials (email + password or magic link).

---

## Food Safety Compliance

This story supports **traceability and transparency**:

- [x] **Customer Access to Lot/Batch Info** - View batch numbers for purchased products
- [x] **Shipment Tracking** - Real-time delivery status for perishables
- [x] **Order Timeline** - Production status visibility
- [x] **Audit Trail** - Log all customer portal access

**Regulatory Context:**
- Customers may request batch/lot traceability for recalls
- Delivery proof (signature, timestamp) required for temperature-sensitive goods
- Portal access logs retained for compliance audits

---

## MVP Scope

**MVP Includes**:
- `customer_portal_users` table (separate from `users`)
- Customer login (email + password, magic link optional)
- Order list view (filtered by customer)
- Order detail page (line items, status, timeline)
- Shipment tracking (carrier, tracking number, status)
- Read-only access (no editing)
- Customer-branded header (logo, colors)
- Auto-refresh shipment status (every 5 minutes if in transit)

**Deferred to Phase 3**:
- Two-factor authentication
- White-labeling (custom domain per customer)
- PDF download (invoice, delivery note)
- Order cancellation requests
- Direct messaging with manufacturer

---

## User Story

As a **Customer**, I want to **track my orders and shipments in real-time via a dedicated portal** so that **I can plan receiving, monitor production progress, and verify delivery without contacting the manufacturer**.

As a **Manufacturer Administrator**, I want to **provide customers with self-service order tracking** so that **I can reduce inbound queries and improve customer satisfaction**.

---

## Scope

**In scope (this story)**
- Customer portal users table and authentication
- Public route: `/portal/customer` (login page)
- Customer dashboard: `/portal/customer/orders` (order list)
- Order detail: `/portal/customer/orders/:id`
- Shipment tracking: `/portal/customer/shipments/:id`
- GET /api/portal/customer/login (authentication)
- GET /api/portal/customer/orders (list)
- GET /api/portal/customer/orders/:id (detail)
- GET /api/portal/customer/shipments/:id (tracking)
- Auto-refresh mechanism (shipments in transit)
- Session management (JWT tokens)
- RLS policies (customer isolation)

**Out of scope (this story)**
- Supplier portal (story 11.6)
- Two-factor authentication (Phase 3)
- White-labeling (Phase 3)
- PDF downloads (Phase 3)
- Order cancellation (Phase 3)
- Direct messaging (Phase 3)
- Invoice payment portal (Phase 3)

---

## Dependencies

### Cross-Epic Dependencies

| Dependency | Story/Epic | Type | What It Provides | Status |
|------------|------------|------|------------------|--------|
| 01.1 | Org Context + RLS | HARD | organizations table | Ready |
| 03.8 | Sales Orders (future) | HARD | sales_orders table | Planned |
| 04.1 | Work Orders | HARD | work_orders for production status | Ready |
| 05.15 | Shipments | HARD | shipments, shipment_items tables | Ready |

### Within Epic Dependencies

| Dependency | Story | Type | What It Provides |
|------------|-------|------|------------------|
| 11.1 | Integrations Dashboard | HARD | Portal navigation pattern |
| 11.3 | Integration Logs | HARD | Access logs for portal activity |

### Provides To (Downstream)

| Story | What This Provides |
|-------|-------------------|
| 11.14 | Portal access patterns for future enhancements |

---

## Database Migration

### Migration: Create customer_portal_users table

```sql
-- Migration: YYYYMMDDHHMMSS_create_customer_portal_users.sql

CREATE TABLE customer_portal_users (
    -- Identity
    id                  UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id              UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    customer_id         UUID NOT NULL REFERENCES customers(id) ON DELETE CASCADE,

    -- Authentication
    email               TEXT NOT NULL,
    password_hash       TEXT NOT NULL,
    name                TEXT NOT NULL,

    -- Status
    status              TEXT NOT NULL DEFAULT 'active'
                        CHECK (status IN ('active', 'suspended', 'locked')),

    -- Access Tracking
    last_login_at       TIMESTAMPTZ,
    login_attempts      INTEGER DEFAULT 0,
    locked_until        TIMESTAMPTZ,

    -- Magic Link (Phase 3)
    magic_token         TEXT,
    magic_expires_at    TIMESTAMPTZ,

    -- Audit
    created_at          TIMESTAMPTZ NOT NULL DEFAULT now(),
    created_by          UUID REFERENCES users(id),
    updated_at          TIMESTAMPTZ NOT NULL DEFAULT now(),

    -- Constraints
    CONSTRAINT uq_customer_portal_email UNIQUE (org_id, email)
);

-- Indexes
CREATE INDEX idx_customer_portal_users_org ON customer_portal_users(org_id);
CREATE INDEX idx_customer_portal_users_customer ON customer_portal_users(customer_id);
CREATE INDEX idx_customer_portal_users_email ON customer_portal_users(org_id, email);
CREATE INDEX idx_customer_portal_users_status ON customer_portal_users(org_id, status);

-- RLS Policies
ALTER TABLE customer_portal_users ENABLE ROW LEVEL SECURITY;

-- Portal users authenticate via separate endpoint (not Supabase auth)
-- Service layer validates credentials and issues JWT tokens

-- MonoPilot admins can manage customer portal users
CREATE POLICY "customer_portal_users_admin_select" ON customer_portal_users
    FOR SELECT USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
        AND EXISTS (
            SELECT 1 FROM users
            WHERE id = auth.uid()
            AND role IN ('ADMIN', 'IT_MANAGER')
        )
    );

CREATE POLICY "customer_portal_users_admin_manage" ON customer_portal_users
    FOR ALL USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
        AND EXISTS (
            SELECT 1 FROM users
            WHERE id = auth.uid()
            AND role IN ('ADMIN', 'IT_MANAGER')
        )
    );

-- Updated_at trigger
CREATE TRIGGER update_customer_portal_users_updated_at
    BEFORE UPDATE ON customer_portal_users
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();
```

---

## Acceptance Criteria (Given/When/Then)

### AC-1: Customer Portal User Creation

```gherkin
Scenario: Admin creates customer portal user
  Given MonoPilot admin navigates to customer detail page
  When clicking [Create Portal Access]
  And entering:
    | Field | Value |
    | Email | john@acmebakery.com |
    | Name | John Smith |
    | Customer | Acme Bakery Ltd |
  And clicking [Create]
  Then customer_portal_users record created
  And password auto-generated and emailed to customer
  And success toast "Portal access created for john@acmebakery.com"

Scenario: Validation - duplicate email
  Given customer portal user exists for customer@example.com
  When attempting to create another user with same email
  Then error: "Email already in use for this customer"
```

### AC-2: Customer Login

```gherkin
Scenario: Customer logs in successfully
  Given customer portal user exists (email: john@acmebakery.com)
  And status = 'active'
  When navigating to /portal/customer
  And entering email + password
  And clicking [Login]
  Then JWT token issued (expires in 24h)
  And last_login_at updated
  And redirected to /portal/customer/orders

Scenario: Invalid credentials
  Given customer portal user exists
  When entering incorrect password
  Then error: "Invalid email or password"
  And login_attempts incremented
  And if login_attempts >= 5: status = 'locked', locked_until = now + 15 minutes

Scenario: Suspended account
  Given customer portal user with status = 'suspended'
  When attempting login
  Then error: "Account suspended. Contact manufacturer."
  And login blocked
```

### AC-3: Order List View

```gherkin
Scenario: Customer views their orders
  Given customer logged in (customer_id = C123)
  When navigating to /portal/customer/orders
  Then DataTable displays orders for customer_id = C123 only
  And columns:
    | Column | Description |
    | Order Number | Clickable link to detail |
    | Date | Order date |
    | Products | Product names (truncated) |
    | Qty | Total quantity |
    | Status | Badge (pending/in_production/shipped/delivered) |
    | Est. Delivery | Expected delivery date |
  And pagination (20 per page)
  And sort by date DESC (default)

Scenario: Filter by status
  Given customer has orders with various statuses
  When selecting status filter = 'in_production'
  Then only orders with work orders in progress displayed

Scenario: Search by order number or product
  Given customer has multiple orders
  When searching "Bread" or order number
  Then matching orders displayed
  And search debounced (300ms)
```

### AC-4: Order Detail View

```gherkin
Scenario: Customer views order detail
  Given customer logged in
  And order O-2025-001 belongs to customer
  When clicking order link
  Then order detail page shows:
    | Section | Content |
    | Header | Order number, date, customer PO reference |
    | Line Items | Product, Description, Qty Ordered, Qty Shipped, Status |
    | Production Status | Work order numbers, progress % |
    | Shipment Info | Shipment number, carrier, tracking (if dispatched) |
    | Timeline | Created -> In Production -> Shipped -> Delivered |
  And all fields read-only

Scenario: Order with multiple shipments
  Given order has partial shipments
  Then shipment section shows multiple entries
  And each with separate tracking link

Scenario: Order not started
  Given order with no work orders
  Then production status shows "Not Started"
  And estimated start date displayed
```

### AC-5: Shipment Tracking

```gherkin
Scenario: Customer views shipment tracking
  Given order has shipment with status = 'in_transit'
  When clicking [Track Shipment]
  Then shipment tracking page shows:
    | Field | Content |
    | Shipment Number | SHP-2025-001 |
    | Carrier | DHL, UPS, etc. |
    | Tracking Number | Clickable link to carrier site |
    | Dispatch Date | When shipped |
    | Est. Delivery | Expected delivery date |
    | Current Status | In Transit / Out for Delivery / Delivered |
    | Delivery Address | Where shipped to |
  And timeline with milestones (dispatched -> in transit -> delivered)

Scenario: Auto-refresh in-transit shipment
  Given shipment status = 'in_transit'
  When viewing tracking page
  Then page auto-refreshes every 5 minutes
  And refresh indicator shown

Scenario: Delivered shipment
  Given shipment status = 'delivered'
  Then timeline shows delivery timestamp
  And delivery proof (signature, photo) if available
  And no auto-refresh
```

### AC-6: Production Status Visibility

```gherkin
Scenario: Order with active work order
  Given order linked to work order WO-2025-001
  And WO status = 'in_progress'
  And qty_completed = 500 / qty_planned = 1000
  When viewing order detail
  Then production section shows:
    | Field | Value |
    | Work Order | WO-2025-001 |
    | Product | Bread Loaf White 500g |
    | Progress | 50% (500 / 1000 pcs) |
    | Status | In Progress |
    | Est. Completion | 2025-12-20 14:00 |

Scenario: Completed work order
  Given work order status = 'completed'
  Then production section shows "Completed" badge
  And actual completion date displayed
  And qty completed shown
```

### AC-7: Customer Isolation (RLS)

```gherkin
Scenario: Customer can only see own orders
  Given Customer A (ID: C123) logged in
  And Customer B (ID: C456) has orders
  When Customer A requests GET /api/portal/customer/orders
  Then only orders with customer_id = C123 returned
  And Customer B orders not visible

Scenario: Attempt to view another customer's order
  Given Customer A logged in
  And order O-2025-999 belongs to Customer B
  When Customer A navigates to /portal/customer/orders/O-2025-999
  Then 404 Not Found returned
  And error logged
```

### AC-8: Session Management

```gherkin
Scenario: JWT token expiration
  Given customer logged in (token expires in 24h)
  When 24h pass
  And customer attempts to access orders
  Then 401 Unauthorized response
  And redirected to login page
  And message: "Session expired. Please log in again."

Scenario: Refresh token (Phase 3)
  Given customer logged in
  When idle for <24h
  Then token auto-refreshes before expiration
  And session maintained

Scenario: Logout
  Given customer logged in
  When clicking [Logout]
  Then JWT token invalidated (blacklist)
  And redirected to login page
```

### AC-9: Customer Branding

```gherkin
Scenario: Portal displays customer-specific branding
  Given organization has logo uploaded
  When customer accesses portal
  Then portal header shows:
    | Element | Content |
    | Logo | Organization logo |
    | Title | "Order Portal - {Organization Name}" |
    | Colors | Configurable primary color (default: blue) |

Scenario: No logo uploaded
  Given organization has no logo
  Then portal shows organization name as text
  And default MonoPilot branding
```

### AC-10: Access Logging

```gherkin
Scenario: Log all customer portal access
  Given customer logs in
  When accessing any portal page
  Then integration_logs entry created:
    | Field | Value |
    | integration_type | customer_portal |
    | event_type | page_view |
    | external_system | customer email |
    | status | success |
  And last_login_at updated

Scenario: Failed login attempt
  Given invalid credentials entered
  Then integration_logs entry with status = 'error'
  And error_message = "Invalid credentials"
```

---

## Implementation Notes

### API Endpoints

```typescript
// =============================================================================
// Customer Portal Authentication
// =============================================================================

// POST /api/portal/customer/login
interface CustomerLoginRequest {
  email: string;
  password: string;
}

interface CustomerLoginResponse {
  token: string; // JWT
  expires_at: string;
  user: {
    id: string;
    name: string;
    email: string;
    customer_id: string;
    customer_name: string;
  };
}

// POST /api/portal/customer/logout
// Invalidates JWT token (add to blacklist)

// =============================================================================
// Customer Portal Orders
// =============================================================================

// GET /api/portal/customer/orders
interface CustomerOrdersListParams {
  status?: 'pending' | 'in_production' | 'shipped' | 'delivered';
  date_from?: string;
  date_to?: string;
  search?: string;
  page?: number;
  limit?: number;
}

interface CustomerOrdersListResponse {
  orders: CustomerOrder[];
  pagination: {
    total: number;
    page: number;
    limit: number;
    pages: number;
  };
}

interface CustomerOrder {
  id: string;
  order_number: string;
  order_date: string;
  customer_po_reference?: string;
  status: 'pending' | 'in_production' | 'shipped' | 'delivered';
  total_items: number;
  est_delivery_date?: string;
  products_summary: string; // "Bread Loaf White 500g, +2 more"
}

// GET /api/portal/customer/orders/:id
interface CustomerOrderDetailResponse {
  order: {
    id: string;
    order_number: string;
    order_date: string;
    customer_po_reference?: string;
    status: string;
    line_items: {
      product_code: string;
      product_name: string;
      description: string;
      qty_ordered: number;
      qty_shipped: number;
      unit: string;
      status: string;
    }[];
  };
  production_status: {
    work_orders: {
      wo_number: string;
      product_name: string;
      qty_planned: number;
      qty_completed: number;
      progress_percent: number;
      status: string;
      est_completion?: string;
    }[];
  };
  shipments: {
    shipment_number: string;
    carrier: string;
    tracking_number?: string;
    dispatch_date?: string;
    est_delivery_date?: string;
    status: string;
  }[];
  timeline: {
    event: string;
    timestamp: string;
    description: string;
  }[];
}

// =============================================================================
// Customer Portal Shipments
// =============================================================================

// GET /api/portal/customer/shipments/:id
interface CustomerShipmentTrackingResponse {
  shipment: {
    shipment_number: string;
    carrier: string;
    tracking_number?: string;
    tracking_url?: string;
    dispatch_date?: string;
    est_delivery_date?: string;
    actual_delivery_date?: string;
    status: 'pending' | 'in_transit' | 'out_for_delivery' | 'delivered' | 'exception';
    delivery_address: {
      name: string;
      street: string;
      city: string;
      postal_code: string;
      country: string;
    };
  };
  timeline: {
    status: string;
    timestamp: string;
    location?: string;
    description: string;
  }[];
  delivery_proof?: {
    signature?: string; // Base64 image
    photo?: string; // URL
    received_by?: string;
  };
}
```

### Validation Schemas (Zod)

```typescript
import { z } from 'zod';

export const customerLoginSchema = z.object({
  email: z.string().email('Invalid email address'),
  password: z.string().min(8, 'Password must be at least 8 characters'),
});

export const customerOrdersListQuerySchema = z.object({
  status: z.enum(['pending', 'in_production', 'shipped', 'delivered']).optional(),
  date_from: z.string().optional(),
  date_to: z.string().optional(),
  search: z.string().min(1).optional(),
  page: z.coerce.number().int().positive().default(1),
  limit: z.coerce.number().int().min(1).max(100).default(20),
});
```

### Service Layer

```typescript
// lib/services/customer-portal-service.ts

export class CustomerPortalService {
  /**
   * Authenticate customer portal user
   */
  static async login(email: string, password: string, orgId: string): Promise<{
    token: string;
    user: CustomerPortalUser;
  }>;

  /**
   * Validate JWT token
   */
  static async validateToken(token: string): Promise<CustomerPortalUser | null>;

  /**
   * List orders for customer
   */
  static async listOrders(
    customerId: string,
    params: CustomerOrdersListParams
  ): Promise<PaginatedResult<CustomerOrder>>;

  /**
   * Get order detail (with RLS check)
   */
  static async getOrderDetail(orderId: string, customerId: string): Promise<CustomerOrderDetail>;

  /**
   * Get shipment tracking
   */
  static async getShipmentTracking(
    shipmentId: string,
    customerId: string
  ): Promise<CustomerShipmentTracking>;

  /**
   * Log portal access
   */
  static async logAccess(
    userId: string,
    eventType: string,
    status: 'success' | 'error',
    errorMessage?: string
  ): Promise<void>;
}
```

### Frontend Components

```
apps/frontend/app/portal/customer/
  login/
    page.tsx                       -- Login form
  orders/
    page.tsx                       -- Order list
    [id]/
      page.tsx                     -- Order detail
  shipments/
    [id]/
      page.tsx                     -- Shipment tracking

components/portal/customer/
  CustomerPortalHeader.tsx         -- Branded header with logout
  CustomerOrdersTable.tsx          -- DataTable for orders
  CustomerOrderDetail.tsx          -- Order detail view
  CustomerShipmentTracking.tsx     -- Tracking timeline
  CustomerProductionStatus.tsx     -- WO progress display
  CustomerOrderTimeline.tsx        -- Order event timeline
  CustomerLoginForm.tsx            -- Login form
  CustomerPortalLayout.tsx         -- Layout wrapper with header
```

---

## Key Business Rules

1. **Customer Isolation**: Customers can ONLY see orders/shipments for their customer_id (enforced by RLS)
2. **Read-Only Access**: Customers cannot modify orders, work orders, or shipments
3. **Session Security**: JWT tokens expire after 24h, must be validated on every request
4. **Account Lockout**: 5 failed login attempts = 15-minute lockout
5. **Auto-Refresh**: Shipments with status = 'in_transit' auto-refresh every 5 minutes
6. **Production Visibility**: Customers see WO progress but NOT internal costing/BOM details
7. **Audit Trail**: All portal access logged to integration_logs
8. **Magic Link (Phase 3)**: Optional passwordless login via email token

---

## Deliverables

### Database
- [ ] Migration: `customer_portal_users` table with RLS
- [ ] Indexes for email, customer_id, org_id
- [ ] RLS policies for customer isolation

### API Routes
- [ ] `POST /api/portal/customer/login` - Customer authentication
- [ ] `POST /api/portal/customer/logout` - Token invalidation
- [ ] `GET /api/portal/customer/orders` - Order list
- [ ] `GET /api/portal/customer/orders/:id` - Order detail
- [ ] `GET /api/portal/customer/shipments/:id` - Shipment tracking

### Service Layer
- [ ] `CustomerPortalService.login()` - Authentication with password hash
- [ ] `CustomerPortalService.validateToken()` - JWT validation
- [ ] `CustomerPortalService.listOrders()` - Order list with RLS
- [ ] `CustomerPortalService.getOrderDetail()` - Order detail with production status
- [ ] `CustomerPortalService.getShipmentTracking()` - Shipment timeline

### Validation
- [ ] `customerLoginSchema`
- [ ] `customerOrdersListQuerySchema`

### Frontend
- [ ] Customer portal login page
- [ ] Order list page with filters
- [ ] Order detail page with production status
- [ ] Shipment tracking page with timeline
- [ ] Auto-refresh mechanism (5-minute interval)
- [ ] Branded header component
- [ ] Session expiration handling

### Tests
- [ ] Unit tests: CustomerPortalService methods (>80% coverage)
- [ ] Integration tests: All portal endpoints
- [ ] RLS tests: Customer isolation verified
- [ ] E2E: Login -> View orders -> Track shipment

---

## Test Strategy

### Unit Tests

```typescript
describe('CustomerPortalService', () => {
  describe('login', () => {
    it('authenticates with valid credentials', async () => {});
    it('returns 401 for invalid password', async () => {});
    it('locks account after 5 failed attempts', async () => {});
    it('blocks suspended accounts', async () => {});
  });

  describe('listOrders', () => {
    it('returns only orders for customer_id', async () => {});
    it('filters by status', async () => {});
    it('paginates correctly', async () => {});
  });

  describe('getOrderDetail', () => {
    it('returns order with production status', async () => {});
    it('returns 404 for different customer', async () => {});
  });
});
```

### Integration Tests

```typescript
describe('Customer Portal API', () => {
  describe('POST /api/portal/customer/login', () => {
    it('returns JWT token for valid credentials', async () => {});
    it('returns 401 for invalid credentials', async () => {});
  });

  describe('GET /api/portal/customer/orders', () => {
    it('enforces customer isolation', async () => {});
    it('filters and paginates', async () => {});
  });
});
```

### E2E Tests

```typescript
describe('Customer Portal Flow', () => {
  it('login -> view orders -> view order detail -> track shipment', async () => {});
  it('session expiration redirects to login', async () => {});
});
```

---

## Definition of Done

### Database
- [ ] `customer_portal_users` table created with RLS
- [ ] Indexes created for performance
- [ ] RLS policies enforce customer isolation

### API
- [ ] All endpoints return correct status codes
- [ ] JWT authentication works
- [ ] Customer isolation enforced (404 for other customers' data)
- [ ] Response times: <500ms

### Service
- [ ] Login with password hash validation
- [ ] JWT token generation and validation
- [ ] RLS checks enforced
- [ ] Access logging to integration_logs

### Frontend
- [ ] Login page functional
- [ ] Order list displays correctly
- [ ] Order detail shows production status
- [ ] Shipment tracking auto-refreshes
- [ ] Branded header with logout
- [ ] Session expiration handled gracefully

### Testing
- [ ] Unit tests: >80% coverage
- [ ] Integration tests: All endpoints covered
- [ ] RLS tests: Customer isolation verified
- [ ] E2E tests: Full flow passing

---

## Risk Assessment

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Customer data leak (wrong customer sees orders) | CRITICAL | LOW | RLS policies + comprehensive tests |
| JWT token compromise | HIGH | MEDIUM | Short expiration (24h), token blacklist |
| Auto-refresh performance impact | LOW | MEDIUM | Pause refresh when tab inactive |
| Production data exposure (BOM, costing) | MEDIUM | LOW | Service layer filters sensitive fields |
| Session management complexity | MEDIUM | MEDIUM | Use proven JWT library (jsonwebtoken) |

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2026-01-15 | Initial Phase 2 story creation | ARCHITECT |

---

**Document Status**: Ready for Implementation
**Created**: 2026-01-15
**Lines**: ~600
**Complexity**: M (Medium)
**Phase**: 2
