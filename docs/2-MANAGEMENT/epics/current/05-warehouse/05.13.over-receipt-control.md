# 05.13 - Over-Receipt Control

| Field | Value |
|-------|-------|
| **Story ID** | 05.13 |
| **Epic** | 05 - Warehouse |
| **Status** | Ready |
| **Phase** | Phase 1 (Goods Receipt) |
| **Priority** | P1 |
| **Complexity** | S (Small) |
| **Estimate** | 1-2 days |
| **Type** | Backend |
| **Model** | SONNET |

---

## PRD References

| FR ID | Requirement | Priority | Coverage |
|-------|-------------|----------|----------|
| WH-FR-029 | Over-Receipt Control (tolerance validation) | P1 | Full |

**Primary PRD:** `docs/1-BASELINE/product/modules/warehouse.md`
**Architecture:** `docs/1-BASELINE/architecture/modules/warehouse.md`

---

## CRITICAL DECISION: Story 05.13 is NOT "GRN from Production Output"

### Analysis Result: **REDUNDANT - No Separate Story Needed**

After analyzing the codebase and PRD requirements:

1. **Story 05.13 Correct Scope:** Over-Receipt Control (per the brief at line 65, 559, 720)
2. **Production Output:** Epic 04.7a (Output Registration Desktop) **directly creates LPs** without requiring a GRN wrapper
3. **GRN is NOT needed for production output** because:
   - Production output creates LPs with `source='production'` and `wo_id` set
   - GRN is specifically for external receipts: `source_type='po'` or `source_type='to'`
   - Production outputs are internally generated finished goods, not external receipts
   - LP genealogy directly links consumed materials to output LPs via `lp_genealogy.operation_type='output'`

### Evidence from Codebase

**From PRD (production.md FR-PROD-011 lines 527-536):**
```
- GIVEN output registered, WHEN LP created, THEN LP.source = "production" AND LP.wo_id = current WO ID
- GIVEN WO has consumed LP-001, LP-002, WHEN output registered creating LP-003,
  THEN lp_genealogy records for LP-001 and LP-002 have child_lp_id = LP-003 ID
```

**From Architecture (warehouse.md lines 49-54):**
```sql
grn_id              UUID REFERENCES grns(id)
wo_id               UUID REFERENCES work_orders(id)
source              TEXT NOT NULL -- receipt, production, return, adjustment
```

**LP Creation Sources:**
- `source='receipt'` → Created by GRN (Stories 05.10, 05.11)
- `source='production'` → Created by Epic 04.7a **directly** (no GRN)
- `source='return'` → Created by return workflow (future)
- `source='adjustment'` → Created by adjustment workflow (future)

### Recommendation: **OPTION A - No Separate Story**

Production output (Epic 04.7a) creates LPs directly. No GRN wrapper is needed because:
- GRN is a **receiving document** for external goods
- Production output is **internal generation** of finished goods
- Audit trail is maintained via:
  - `license_plates.wo_id` links LP to WO
  - `license_plates.source='production'` indicates origin
  - `lp_genealogy.operation_type='output'` links consumed → output
  - `production_outputs` table (in Epic 04) tracks output transactions

**Conclusion:** Story "05.13 GRN from Production Output" is **NOT NEEDED**. This story number (05.13) correctly refers to "Over-Receipt Control" per the brief.

---

## MVP Scope

### In Scope (This Story - Over-Receipt Control)

1. **Over-Receipt Validation Logic**
   - Check `warehouse_settings.allow_over_receipt` flag
   - Calculate over-receipt percentage: `(received_qty - ordered_qty) / ordered_qty * 100`
   - Enforce `warehouse_settings.over_receipt_tolerance_pct` threshold
   - Block receipt if tolerance exceeded

2. **Integration with GRN Service**
   - Extend `GRNService.validateReceipt()` from Story 05.11
   - Add `GRNService.calculateOverReceiptPercentage()` helper
   - Return clear error messages for over-receipt violations

3. **API Response Enhancement**
   - 400 error: "Over-receipt not allowed" (when `allow_over_receipt=false`)
   - 400 error: "Over-receipt exceeds tolerance (X% > Y%)" (when tolerance exceeded)
   - Warning message: "Over-receipt within tolerance (X% of Y%)" (when allowed)

4. **Audit Trail**
   - Record `over_receipt_flag` in `grn_items` table
   - Record `over_receipt_percentage` for reporting
   - Log user and timestamp of over-receipt acceptance

### Out of Scope (Other Stories)

| Feature | Deferred To | Reason |
|---------|-------------|--------|
| Manager approval workflow | Phase 2+ | Not MVP requirement |
| Over-receipt report | 05.15 Dashboard | Analytics feature |
| PO amendment on over-receipt | Epic 03 Planning | PO management |
| SMS/email alerts | Phase 3+ | Notifications system |

---

## Epic 04 Dependency Status

- [ ] NOT CRITICAL - Does not unblock Epic 04 Phase 1
- [x] Phase 1 Story - Validation enhancement for receiving

This story enhances GRN validation but Epic 04 (Production) does not depend on receiving workflows.

---

## Goal

Enable warehouse managers to control over-receipt of goods from Purchase Orders and Transfer Orders by enforcing configurable tolerance thresholds, preventing receiving errors and unauthorized inventory increases.

---

## User Story

As a **Warehouse Manager**, I want to **configure over-receipt tolerances and automatically block receipts that exceed these limits** so that **receiving operators cannot accept significantly more goods than ordered without proper authorization**.

---

## Dependencies

| Dependency | Story/Epic | Type | Status | Notes |
|------------|------------|------|--------|-------|
| 05.11 | GRN from PO | HARD | Ready | Extends GRN validation logic |
| 05.12 | GRN from TO | SOFT | Ready | Same validation applies to TO receipts |
| 05.0 | Warehouse Settings | HARD | Ready | Reads tolerance settings |

**Dependents (What This Unblocks):**
- 05.17 (Scanner Receive) - Uses same validation logic

---

## Acceptance Criteria (Given/When/Then)

### AC-1: Over-Receipt Disabled (Strict Mode)

```gherkin
Scenario: Block any over-receipt when setting is disabled
  Given warehouse_settings.allow_over_receipt = false
  And PO line has ordered_qty = 100
  And previously received_qty = 0
  When user attempts to receive qty = 101
  Then API returns 400 error with message "Over-receipt not allowed. Ordered: 100, Attempting: 101"
  And GRN creation is blocked
  And po_lines.received_qty remains unchanged
```

### AC-2: Over-Receipt Within Tolerance

```gherkin
Scenario: Allow over-receipt within configured tolerance
  Given warehouse_settings.allow_over_receipt = true
  And warehouse_settings.over_receipt_tolerance_pct = 10.0
  And PO line has ordered_qty = 100
  And previously received_qty = 0
  When user receives qty = 108
  Then over-receipt percentage calculated as 8.0%
  And validation passes (8.0% < 10.0%)
  And GRN is created successfully
  And grn_items.over_receipt_flag = true
  And grn_items.over_receipt_percentage = 8.0
  And po_lines.received_qty updated to 108
  And API returns success with warning "Over-receipt within tolerance (8.0% of 10.0%)"
```

### AC-3: Over-Receipt Exceeds Tolerance

```gherkin
Scenario: Block over-receipt exceeding configured tolerance
  Given warehouse_settings.allow_over_receipt = true
  And warehouse_settings.over_receipt_tolerance_pct = 5.0
  And PO line has ordered_qty = 100
  And previously received_qty = 0
  When user attempts to receive qty = 112
  Then over-receipt percentage calculated as 12.0%
  And validation fails (12.0% > 5.0%)
  And API returns 400 error with message "Over-receipt exceeds tolerance (12.0% > 5.0%). Reduce quantity to 105 or less."
  And GRN creation is blocked
  And po_lines.received_qty remains unchanged
```

### AC-4: Cumulative Over-Receipt Calculation

```gherkin
Scenario: Calculate over-receipt against original ordered quantity (cumulative)
  Given warehouse_settings.allow_over_receipt = true
  And warehouse_settings.over_receipt_tolerance_pct = 10.0
  And PO line has ordered_qty = 100
  And previously received_qty = 95
  When user attempts to receive qty = 16
  Then total received = 95 + 16 = 111
  And over-receipt percentage = (111 - 100) / 100 * 100 = 11.0%
  And validation fails (11.0% > 10.0%)
  And API returns 400 error with message "Cumulative over-receipt exceeds tolerance (11.0% > 10.0%). Maximum remaining: 10 units"
```

### AC-5: Exact Quantity Match (No Over-Receipt)

```gherkin
Scenario: Allow exact match without over-receipt flag
  Given warehouse_settings.allow_over_receipt = true
  And warehouse_settings.over_receipt_tolerance_pct = 5.0
  And PO line has ordered_qty = 100
  And previously received_qty = 0
  When user receives qty = 100
  Then over-receipt percentage = 0.0%
  And validation passes
  And GRN is created successfully
  And grn_items.over_receipt_flag = false
  And grn_items.over_receipt_percentage = 0.0
```

### AC-6: Under-Receipt (Always Allowed)

```gherkin
Scenario: Always allow under-receipt regardless of settings
  Given warehouse_settings.allow_over_receipt = false
  And PO line has ordered_qty = 100
  And previously received_qty = 0
  When user receives qty = 80
  Then over-receipt percentage = -20.0%
  And validation passes
  And GRN is created successfully
  And grn_items.over_receipt_flag = false
  And grn_items.over_receipt_percentage = -20.0
```

### AC-7: Zero Tolerance Setting

```gherkin
Scenario: Enforce exact quantity when tolerance is 0%
  Given warehouse_settings.allow_over_receipt = true
  And warehouse_settings.over_receipt_tolerance_pct = 0.0
  And PO line has ordered_qty = 100
  And previously received_qty = 0
  When user attempts to receive qty = 101
  Then over-receipt percentage = 1.0%
  And validation fails (1.0% > 0.0%)
  And API returns 400 error with message "Over-receipt exceeds tolerance (1.0% > 0.0%). Only exact quantity allowed."
```

### AC-8: Multi-Line Validation

```gherkin
Scenario: Validate each PO line independently
  Given warehouse_settings.allow_over_receipt = true
  And warehouse_settings.over_receipt_tolerance_pct = 5.0
  And PO has 3 lines:
    | Line | Ordered | Receiving |
    |------|---------|-----------|
    | 1    | 100     | 104       | # 4% over - OK
    | 2    | 200     | 220       | # 10% over - FAIL
    | 3    | 50      | 48        | # under - OK
  When user submits GRN with all 3 lines
  Then validation fails on Line 2
  And API returns 400 error with details:
    """
    Line 2 over-receipt exceeds tolerance (10.0% > 5.0%)
    """
  And GRN creation is blocked for ALL lines (atomic transaction)
```

---

## Implementation Notes

### API Endpoints

**Enhancement to Existing Endpoints:**

```typescript
// Extended from Story 05.11
POST /api/warehouse/grns/from-po/:poId
POST /api/warehouse/grns/from-to/:toId

// No new endpoints - this story enhances existing validation
```

### Database

**Schema Enhancement (Story 05.11 already created these columns):**

```sql
-- grn_items table (already exists from 05.11)
-- This story USES these columns:
ALTER TABLE grn_items
ADD COLUMN IF NOT EXISTS over_receipt_flag BOOLEAN DEFAULT false,
ADD COLUMN IF NOT EXISTS over_receipt_percentage DECIMAL(5,2);

-- warehouse_settings table (already exists from 05.0)
-- This story READS these columns:
-- allow_over_receipt BOOLEAN DEFAULT false
-- over_receipt_tolerance_pct DECIMAL(5,2) DEFAULT 0.0
```

### Service Layer

**File:** `lib/services/grn-service.ts`

```typescript
// Extend existing GRNService from Story 05.11

interface OverReceiptValidation {
  isValid: boolean;
  percentage: number;
  message: string;
  isOverReceipt: boolean;
}

export class GRNService {
  /**
   * Validate over-receipt against settings
   * @param orderedQty - Original ordered quantity
   * @param previouslyReceivedQty - Already received quantity
   * @param receivingQty - Current receiving quantity
   * @param settings - Warehouse settings
   * @returns Validation result with percentage and message
   */
  static validateOverReceipt(
    orderedQty: number,
    previouslyReceivedQty: number,
    receivingQty: number,
    settings: WarehouseSettings
  ): OverReceiptValidation {
    const totalReceived = previouslyReceivedQty + receivingQty;
    const overReceiptQty = totalReceived - orderedQty;
    const percentage = (overReceiptQty / orderedQty) * 100;

    // Under-receipt is always allowed
    if (overReceiptQty <= 0) {
      return {
        isValid: true,
        percentage: percentage,
        message: '',
        isOverReceipt: false
      };
    }

    // Check if over-receipt is disabled
    if (!settings.allow_over_receipt) {
      return {
        isValid: false,
        percentage: percentage,
        message: `Over-receipt not allowed. Ordered: ${orderedQty}, Attempting: ${totalReceived}`,
        isOverReceipt: true
      };
    }

    // Check tolerance
    const tolerance = settings.over_receipt_tolerance_pct || 0;
    if (percentage > tolerance) {
      const maxAllowed = orderedQty * (1 + tolerance / 100) - previouslyReceivedQty;
      return {
        isValid: false,
        percentage: percentage,
        message: `Over-receipt exceeds tolerance (${percentage.toFixed(1)}% > ${tolerance.toFixed(1)}%). Maximum remaining: ${Math.floor(maxAllowed)} units`,
        isOverReceipt: true
      };
    }

    // Within tolerance
    return {
      isValid: true,
      percentage: percentage,
      message: `Over-receipt within tolerance (${percentage.toFixed(1)}% of ${tolerance.toFixed(1)}%)`,
      isOverReceipt: true
    };
  }

  /**
   * Calculate over-receipt percentage
   */
  static calculateOverReceiptPercentage(
    orderedQty: number,
    totalReceivedQty: number
  ): number {
    if (orderedQty === 0) return 0;
    return ((totalReceivedQty - orderedQty) / orderedQty) * 100;
  }
}
```

### Validation (Zod)

**File:** `lib/validation/grn-validation.ts`

```typescript
import { z } from 'zod';

// Extend existing schemas from Story 05.11

export const warehouseSettingsSchema = z.object({
  allow_over_receipt: z.boolean().default(false),
  over_receipt_tolerance_pct: z.number().min(0).max(100).default(0)
});

export const grnItemSchema = z.object({
  po_line_id: z.string().uuid(),
  product_id: z.string().uuid(),
  received_qty: z.number().positive(),
  // ... other fields from 05.11
});

export const createGRNFromPOSchema = z.object({
  po_id: z.string().uuid(),
  items: z.array(grnItemSchema).min(1),
  received_date: z.string().datetime().optional(),
  notes: z.string().max(1000).optional()
});
```

### Key Business Rules

1. **Under-Receipt Always Allowed:** Systems must never block receiving less than ordered
2. **Cumulative Calculation:** Over-receipt percentage calculated against original ordered quantity, not remaining
3. **Atomic Validation:** All lines validated before ANY line is received (no partial commits)
4. **Zero Tolerance:** When `over_receipt_tolerance_pct = 0.0`, only exact quantity allowed
5. **Settings Hierarchy:** Org-level settings apply to all warehouses unless warehouse override exists (Phase 2)
6. **Audit Trail:** All over-receipts flagged and logged, even when within tolerance

---

## Deliverables

### Backend
- [ ] Enhanced `GRNService.validateOverReceipt()` method
- [ ] Enhanced `GRNService.calculateOverReceiptPercentage()` helper
- [ ] Integration with existing POST /api/warehouse/grns/from-po/:poId
- [ ] Integration with existing POST /api/warehouse/grns/from-to/:toId
- [ ] Error response formatting for over-receipt violations

### Testing
- [ ] Unit tests for validation logic (8+ test cases covering all ACs)
- [ ] Integration tests for GRN creation with over-receipt scenarios
- [ ] Edge case tests: zero ordered qty, negative values, rounding errors
- [ ] Multi-line validation tests (atomic transaction behavior)

### Documentation
- [ ] Update GRN API documentation with over-receipt validation rules
- [ ] Add troubleshooting guide for common over-receipt errors
- [ ] Update warehouse settings documentation

---

## Definition of Done

- [ ] All 8 Acceptance Criteria passing
- [ ] Unit tests >80% coverage for over-receipt validation logic
- [ ] Integration tests verify atomic transaction behavior (all-or-nothing)
- [ ] Error messages are clear and actionable (include max allowed qty)
- [ ] Existing GRN workflows from Story 05.11 not disrupted
- [ ] RLS policies verified (org_id isolation maintained)
- [ ] Performance validated: validation adds <50ms to GRN creation
- [ ] Documentation updated with validation rules
- [ ] Code review approved by BACKEND-DEV
- [ ] Tested with real PO/TO data from Epic 03

---

## Future Phases (Not in This Story)

### Phase 2 - Manager Override
- Manager approval workflow for over-receipt beyond tolerance
- Approval request notification system
- Override audit trail with approval reason
- Warehouse-specific tolerance overrides

### Phase 3 - Advanced Controls
- SMS/email alerts for over-receipt attempts
- Over-receipt report by supplier/product
- Auto-generate PO amendment on approved over-receipt
- Machine learning: predict acceptable tolerance by supplier reliability

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-12-16 | Initial story with redundancy analysis | ARCHITECT-AGENT |

---

## Appendix: Why GRN from Production is NOT Needed

### Production Output Flow (Epic 04.7a)

```
Work Order (In Progress)
    |
    | User clicks "Register Output"
    v
POST /api/production/outputs
    |
    +---> Create `production_outputs` record
    |
    +---> Create `license_plates` record
    |       - source = 'production'
    |       - wo_id = current_wo_id
    |       - status = 'available'
    |       - qa_status = from settings or WO
    |
    +---> Create `lp_genealogy` records
    |       - operation_type = 'output'
    |       - parent_lp_id = consumed LP IDs
    |       - child_lp_id = new output LP ID
    |       - wo_id = current_wo_id
    |
    +---> Update `work_orders.produced_quantity`
    |
    v
Output LP Created (No GRN Involved)
```

### GRN Flow (External Receipts Only)

```
Purchase Order (Approved)
    |
    | User clicks "Receive Goods"
    v
POST /api/warehouse/grns/from-po/:poId
    |
    +---> Create `grns` record
    |       - source_type = 'po'
    |       - po_id = purchase_order_id
    |
    +---> Create `grn_items` records
    |
    +---> Create `license_plates` records
    |       - source = 'receipt'
    |       - grn_id = new GRN ID
    |       - po_number = PO number
    |
    +---> Update `po_lines.received_qty`
    |
    v
Receipt LP Created (GRN Involved)
```

### Key Differences

| Aspect | Production Output (04.7a) | GRN Receipt (05.11) |
|--------|--------------------------|---------------------|
| **Origin** | Internal (WO) | External (Supplier) |
| **Document** | Production Output | Goods Receipt Note |
| **LP Source** | `source='production'` | `source='receipt'` |
| **LP Link** | `wo_id` | `grn_id` |
| **Validation** | BOM yield, QA status | Over-receipt, batch/expiry |
| **Genealogy** | Links consumed → output | No genealogy (first LP creation) |
| **Audit Table** | `production_outputs` | `grns` + `grn_items` |

**Conclusion:** Production outputs and external receipts are fundamentally different workflows with different validation rules, audit requirements, and data models. Forcing production output through a GRN would create unnecessary complexity and violate the separation of concerns.
