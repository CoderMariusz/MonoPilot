# 05.0 - Warehouse Settings (Module Configuration)

| Field | Value |
|-------|-------|
| **Story ID** | 05.0 |
| **Epic** | 05 - Warehouse |
| **Status** | Ready |
| **Phase** | Phase 0 (LP Foundation) |
| **Complexity** | M (Medium) |
| **Estimate** | 2-3 days |
| **Type** | Full-stack |
| **Priority** | P0 (Phase 0 - CRITICAL) |

---

## PRD References

| FR ID | Requirement | Phase | Covered |
|-------|-------------|-------|---------|
| WH-FR-001 | LP auto-generation settings | Phase 0 | YES |
| WH-FR-008 | QA status default settings | Phase 0 | YES |
| WH-FR-009 | Batch tracking settings | Phase 0 | YES |
| WH-FR-010 | Expiry tracking settings | Phase 0 | YES |
| WH-FR-019 | FIFO enforcement toggle | Phase 0 | YES |
| WH-FR-020 | FEFO enforcement toggle | Phase 0 | YES |
| WH-FR-015 | ASN enable toggle | Phase 1 | YES |
| WH-FR-029 | Over-receipt control | Phase 1 | YES |
| WH-FR-011-013 | Scanner settings | Phase 2 | YES |
| WH-FR-014 | Label printing settings | Phase 2 | YES |
| WH-FR-016 | Pallet enable toggle | Phase 3 | YES |
| WH-FR-017 | GS1 barcode toggle | Phase 3 | YES |
| WH-FR-021 | Catch weight toggle | Phase 3 | YES |
| WH-FR-025 | Location capacity toggle | Phase 3 | YES |
| WH-FR-026 | Zone management toggle | Phase 3 | YES |

**Primary PRD:** `docs/1-BASELINE/product/modules/warehouse.md`
**Architecture:** `docs/1-BASELINE/architecture/modules/warehouse.md`

---

## MVP Scope

This story delivers the **complete warehouse_settings table** with ALL fields organized by phase. It provides the configuration foundation for the entire Warehouse Module.

**Phase 0 (In Scope - Critical for Epic 04):**
- FIFO/FEFO enforcement toggles
- LP auto-generation settings (prefix, sequence length)
- Batch tracking (enable, require on receipt, supplier batch)
- Expiry tracking (enable, require on receipt, warning days)
- QA status defaults (require on receipt, default status)
- Split/merge enable toggle

**Phase 1 (In Scope - Settings Only):**
- ASN enable toggle
- Over-receipt control (allow, tolerance percentage)
- Transit location enable toggle

**Phase 2 (In Scope - Settings Only):**
- Scanner settings (idle timeout, sound feedback)
- Label printing (print on receipt, default copies)

**Phase 3 (In Scope - Settings Only):**
- Pallet management toggle
- GS1 barcode toggle
- Catch weight toggle
- Location zones toggle
- Location capacity toggle

**Out of Scope (This Story):**
- Actual warehouse operations (receipt, moves, etc.) - See Stories 05.1+
- License Plates CRUD - Story 05.5
- Scanner workflows - Stories 05.16-05.23
- Advanced features implementation - Phase 3 stories

---

## Epic 04 Dependency Status

- [x] **CRITICAL** - Unblocks Epic 04 Phase 1
- **Provides:** Settings infrastructure that Story 05.1 (LP Table + Service) depends on
- **Blocks:** Stories 05.1-05.7 cannot implement without settings infrastructure

---

## User Story

As a **Warehouse Manager or System Administrator**, I want to **configure warehouse module behavior through comprehensive settings organized by implementation phase** so that **the system enforces correct warehouse policies (FIFO/FEFO, batch tracking, QA requirements) and I can enable advanced features (pallets, GS1, catch weight) as my organization grows**.

---

## Dependencies

| Dependency | Story/Epic | Type | Reason |
|------------|------------|------|--------|
| 01.1 | Org Context + Base RLS | HARD | Requires org_id context and RLS patterns |
| 01.2 | Settings Shell Navigation | HARD | Requires settings navigation structure |
| 01.6 | Role Permissions | HARD | Permission enforcement for settings management |
| 01.14 | Wizard Steps Complete | SOFT | Settings accessible via onboarding wizard |

**Dependents (Hard Blockers):**
- 05.1 (LP Table + Service) - Requires auto_generate_lp_number, lp_number_prefix, default_qa_status
- 05.2 (LP Genealogy) - Requires enable_split_merge
- 05.4 (FIFO/FEFO Pick) - Requires enable_fifo, enable_fefo
- 05.6 (LP Split/Merge) - Requires enable_split_merge
- 05.7 (QA Status) - Requires require_qa_on_receipt, default_qa_status
- 05.8+ (Phase 1) - Requires enable_asn, allow_over_receipt settings
- 05.16+ (Phase 2) - Requires scanner settings
- 05.24+ (Phase 3) - Requires advanced feature toggles

---

## Acceptance Criteria (Gherkin)

### AC-1: Warehouse Settings Page Access (Phase 0)

```gherkin
Scenario: Navigate to warehouse settings
  Given user has ADMIN or WH_MANAGER role
  When user navigates to /settings/warehouse
  Then warehouse settings page displays within 300ms
  And page shows 4 collapsible sections: "Phase 0: Core Configuration", "Phase 1: Receipt & Inventory", "Phase 2: Scanner & Labels", "Phase 3: Advanced Features"

Scenario: Permission enforcement
  Given user has PROD_MANAGER role (not WH_MANAGER)
  When user navigates to /settings/warehouse
  Then page displays in read-only mode
  And all input fields are disabled
  And "Save Changes" button is hidden

Scenario: Viewer read-only access
  Given user has VIEWER role
  When user navigates to /settings/warehouse
  Then page displays settings in read-only mode
  And tooltip on hover displays "Contact your administrator to modify settings"
```

### AC-2: Phase 0 Settings - LP Configuration (WH-FR-001)

```gherkin
Scenario: LP auto-generation toggle
  Given warehouse settings page open
  When user views "License Plate Configuration" section
  Then auto_generate_lp_number toggle displays (default: ON)
  And tooltip explains "Automatically generate LP numbers on receipt"

Scenario: LP number prefix configuration
  Given auto_generate_lp_number is ON
  When user enters lp_number_prefix "LP-"
  Then input accepts alphanumeric with hyphens (max 10 chars)
  And preview displays "Example: LP-00000001"

Scenario: LP sequence length configuration
  Given auto_generate_lp_number is ON
  When user sets lp_number_sequence_length to 8
  Then slider shows value 4-12
  And preview updates to "Example: LP-00000001"

Scenario: Auto-generation disabled
  Given user turns OFF auto_generate_lp_number
  When toggle switches
  Then lp_number_prefix and lp_number_sequence_length inputs become disabled and grayed out
  And warning displays "Manual LP entry required on receipt"

Scenario: Validation - prefix required when auto-gen enabled
  Given auto_generate_lp_number is ON
  When user clears lp_number_prefix field
  Then inline error displays "Prefix required when auto-generation enabled"
  And "Save Changes" button disabled
```

### AC-3: Phase 0 Settings - FIFO/FEFO (WH-FR-019, WH-FR-020)

```gherkin
Scenario: FIFO toggle
  Given warehouse settings page open
  When user views "Pick Strategy" section
  Then enable_fifo toggle displays (default: ON)
  And tooltip explains "First-In-First-Out: Suggest oldest LPs for picking"

Scenario: FEFO toggle
  Given warehouse settings page open
  When user views "Pick Strategy" section
  Then enable_fefo toggle displays (default: OFF)
  And tooltip explains "First-Expired-First-Out: Suggest LPs by expiry date (overrides FIFO if both enabled)"

Scenario: FEFO precedence warning
  Given enable_fifo is ON and enable_fefo is ON
  When both toggles enabled
  Then info banner displays "FEFO takes precedence when both are enabled"
  And banner shows "Sort order: expiry_date ASC, then created_at ASC"

Scenario: Both disabled warning
  Given user turns OFF both enable_fifo and enable_fefo
  When saved
  Then warning modal displays "No pick enforcement enabled. Users can select any LP. Continue?"
  And requires confirmation to save
```

### AC-4: Phase 0 Settings - Batch Tracking (WH-FR-009)

```gherkin
Scenario: Batch tracking toggle
  Given warehouse settings page open
  When user views "Batch Tracking" section
  Then enable_batch_tracking toggle displays (default: ON)

Scenario: Require batch on receipt
  Given enable_batch_tracking is ON
  When user views require_batch_on_receipt toggle
  Then toggle displays (default: OFF)
  And tooltip explains "Block receipts without batch number"

Scenario: Require batch dependency
  Given enable_batch_tracking is OFF
  When user attempts to enable require_batch_on_receipt
  Then require_batch_on_receipt toggle is disabled
  And tooltip displays "Enable batch tracking first"

Scenario: Supplier batch toggle
  Given enable_batch_tracking is ON
  When user views enable_supplier_batch toggle
  Then toggle displays (default: ON)
  And tooltip explains "Track separate supplier batch number in addition to internal batch"
```

### AC-5: Phase 0 Settings - Expiry Tracking (WH-FR-010)

```gherkin
Scenario: Expiry tracking toggle
  Given warehouse settings page open
  When user views "Expiry Tracking" section
  Then enable_expiry_tracking toggle displays (default: ON)

Scenario: Require expiry on receipt
  Given enable_expiry_tracking is ON
  When user views require_expiry_on_receipt toggle
  Then toggle displays (default: OFF)
  And tooltip explains "Block receipts without expiry date"

Scenario: Expiry warning days
  Given enable_expiry_tracking is ON
  When user sets expiry_warning_days to 30
  Then number input accepts 1-365 (default: 30)
  And help text displays "LPs expiring within this period show yellow warning"

Scenario: Require expiry dependency
  Given enable_expiry_tracking is OFF
  When user views require_expiry_on_receipt and expiry_warning_days
  Then both fields are disabled and grayed out
  And tooltip displays "Enable expiry tracking first"
```

### AC-6: Phase 0 Settings - QA Status (WH-FR-008)

```gherkin
Scenario: QA requirement toggle
  Given warehouse settings page open
  When user views "Quality Assurance" section
  Then require_qa_on_receipt toggle displays (default: ON)
  And tooltip explains "Require QA approval before LP consumption"

Scenario: Default QA status dropdown
  Given require_qa_on_receipt is ON
  When user opens default_qa_status dropdown
  Then options display: pending, passed, failed, quarantine
  And default selection is "pending"
  And tooltip explains "Initial QA status for new LPs"

Scenario: QA disabled state
  Given user turns OFF require_qa_on_receipt
  When saved
  Then default_qa_status dropdown disabled
  And all LPs created with qa_status='passed' automatically
  And warning displays "LPs will be immediately available for consumption"
```

### AC-7: Phase 0 Settings - Split/Merge Toggle

```gherkin
Scenario: Split/merge toggle
  Given warehouse settings page open
  When user views "License Plate Operations" section
  Then enable_split_merge toggle displays (default: ON)
  And tooltip explains "Allow splitting LPs into smaller quantities or merging LPs with same product/batch"

Scenario: Disable with active LPs warning
  Given organization has 500+ active LPs
  When user turns OFF enable_split_merge
  Then warning modal displays "Disabling will prevent split/merge operations. Existing genealogy preserved. Continue?"
  And requires confirmation
```

### AC-8: Phase 1 Settings - ASN & Over-Receipt (WH-FR-015, WH-FR-029)

```gherkin
Scenario: ASN toggle (Phase 1)
  Given warehouse settings page open
  When user expands "Phase 1: Receipt & Inventory" section
  Then enable_asn toggle displays (default: OFF)
  And tooltip explains "Advanced Shipping Notices - Pre-notification from suppliers"
  And badge shows "Phase 1"

Scenario: Over-receipt control
  Given user views "Over-Receipt Control" subsection
  When allow_over_receipt toggle displays (default: OFF)
  Then tooltip explains "Allow receiving more than ordered quantity"

Scenario: Over-receipt tolerance
  Given allow_over_receipt is ON
  When user sets over_receipt_tolerance_pct to 10.5
  Then number input accepts 0-100 with 2 decimals (default: 0)
  And help text displays "Receipts up to 110.5% of ordered quantity allowed"

Scenario: Tolerance disabled when over-receipt off
  Given allow_over_receipt is OFF
  When user views over_receipt_tolerance_pct
  Then input is disabled
  And value shows 0
```

### AC-9: Phase 1 Settings - Transit Location

```gherkin
Scenario: Transit location toggle
  Given warehouse settings page open
  When user views "Transit Location" subsection (Phase 1)
  Then enable_transit_location toggle displays (default: ON)
  And tooltip explains "Create virtual transit location for in-flight transfer orders"
  And help text displays "Disabling requires manual location assignment for TO shipments"
```

### AC-10: Phase 2 Settings - Scanner Configuration (WH-FR-011-013)

```gherkin
Scenario: Scanner idle timeout
  Given warehouse settings page open
  When user expands "Phase 2: Scanner & Labels" section
  Then scanner_idle_timeout_sec input displays (default: 300)
  And accepts 60-3600 (1-60 minutes)
  And help text displays "Scanner session timeout after inactivity"

Scenario: Scanner sound feedback toggle
  Given user views "Scanner Settings" subsection
  When scanner_sound_feedback toggle displays (default: ON)
  Then tooltip explains "Play audio feedback on scan success/failure"
```

### AC-11: Phase 2 Settings - Label Printing (WH-FR-014)

```gherkin
Scenario: Print label on receipt
  Given user views "Label Printing" subsection (Phase 2)
  When print_label_on_receipt toggle displays (default: ON)
  Then tooltip explains "Automatically print LP label after GRN completion"

Scenario: Default label copies
  Given print_label_on_receipt is ON
  When user sets label_copies_default to 2
  Then number input accepts 1-10 (default: 1)
  And help text displays "Number of label copies per LP"

Scenario: Label copies disabled when printing off
  Given print_label_on_receipt is OFF
  When user views label_copies_default
  Then input is disabled and grayed out
```

### AC-12: Phase 3 Settings - Advanced Features (WH-FR-016-026)

```gherkin
Scenario: Pallet management toggle (WH-FR-016)
  Given warehouse settings page open
  When user expands "Phase 3: Advanced Features" section
  Then enable_pallets toggle displays (default: OFF)
  And tooltip explains "Enable pallet management with SSCC-18 codes"
  And badge shows "Phase 3"

Scenario: GS1 barcode toggle (WH-FR-017)
  Given user views "GS1 Compliance" subsection
  When enable_gs1_barcodes toggle displays (default: OFF)
  Then tooltip explains "Parse GS1 GTIN-14 and SSCC-18 barcodes"
  And help text displays "Requires GS1 company prefix configuration"

Scenario: Catch weight toggle (WH-FR-021)
  Given user views "Catch Weight" subsection
  When enable_catch_weight toggle displays (default: OFF)
  Then tooltip explains "Support variable weight products (e.g., meat, cheese)"

Scenario: Location zones toggle (WH-FR-026)
  Given user views "Location Management" subsection
  When enable_location_zones toggle displays (default: OFF)
  Then tooltip explains "Organize locations into zones (receiving, storage, shipping, quarantine)"

Scenario: Location capacity toggle (WH-FR-025)
  Given user views "Location Management" subsection
  When enable_location_capacity toggle displays (default: OFF)
  Then tooltip explains "Track and validate location capacity limits"
```

### AC-13: Settings Save & Validation

```gherkin
Scenario: Save settings successfully
  Given user modifies enable_fifo from ON to OFF
  When user clicks "Save Changes"
  Then API PUT /api/warehouse/settings called
  And settings saved within 500ms
  And toast displays "Warehouse settings saved successfully"
  And "Save Changes" button disabled until next edit

Scenario: Validation errors prevent save
  Given auto_generate_lp_number is ON
  And lp_number_prefix is empty
  When user clicks "Save Changes"
  Then inline error displays next to lp_number_prefix field
  And API call not made
  And "Save Changes" button remains enabled

Scenario: Concurrent update conflict
  Given User A opens settings at 10:00:00
  And User B saves settings at 10:00:30
  When User A clicks "Save Changes" at 10:01:00
  Then 409 Conflict error returned
  And modal displays "Settings were updated by another user. Refresh to see latest?"
  And "Refresh" button reloads settings
```

### AC-14: Settings Audit Trail

```gherkin
Scenario: Track settings changes
  Given user modifies enable_fifo from ON to OFF
  When settings saved
  Then warehouse_settings_audit record created with:
    | Field | Value |
    | setting_name | enable_fifo |
    | old_value | true |
    | new_value | false |
    | changed_by | user.id |
    | changed_at | timestamp |

Scenario: View settings history
  Given user clicks "View Change History" button
  When history modal opens
  Then displays last 50 changes with columns: Setting, Old Value, New Value, Changed By, Changed At
  And sorted by changed_at DESC
```

### AC-15: Multi-tenancy & Permissions

```gherkin
Scenario: Org isolation on settings fetch
  Given User A from Org A
  When requesting GET /api/warehouse/settings
  Then only Org A warehouse_settings returned
  And updated_at timestamp included

Scenario: Cross-tenant access blocked
  Given User A from Org A
  When attempting PUT /api/warehouse/settings with Org B settings ID
  Then 404 Not Found returned (not 403)

Scenario: Role-based write permission
  Given user has VIEWER role
  When attempting PUT /api/warehouse/settings
  Then 403 Forbidden returned
  And error message "Insufficient permissions to modify warehouse settings"
```

---

## Technical Specification

### Database Schema

```sql
CREATE TABLE warehouse_settings (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,

  -- Phase 0: Core Configuration (CRITICAL for Epic 04)
  auto_generate_lp_number BOOLEAN NOT NULL DEFAULT true,
  lp_number_prefix VARCHAR(10) NOT NULL DEFAULT 'LP',
  lp_number_sequence_length INTEGER NOT NULL DEFAULT 8 CHECK (lp_number_sequence_length BETWEEN 4 AND 12),
  enable_split_merge BOOLEAN NOT NULL DEFAULT true,
  require_qa_on_receipt BOOLEAN NOT NULL DEFAULT true,
  default_qa_status VARCHAR(20) NOT NULL DEFAULT 'pending' CHECK (default_qa_status IN ('pending', 'passed', 'failed', 'quarantine')),
  enable_expiry_tracking BOOLEAN NOT NULL DEFAULT true,
  require_expiry_on_receipt BOOLEAN NOT NULL DEFAULT false,
  expiry_warning_days INTEGER NOT NULL DEFAULT 30 CHECK (expiry_warning_days BETWEEN 1 AND 365),
  enable_batch_tracking BOOLEAN NOT NULL DEFAULT true,
  require_batch_on_receipt BOOLEAN NOT NULL DEFAULT false,
  enable_supplier_batch BOOLEAN NOT NULL DEFAULT true,
  enable_fifo BOOLEAN NOT NULL DEFAULT true,
  enable_fefo BOOLEAN NOT NULL DEFAULT false,

  -- Phase 1: Receipt & Inventory
  enable_asn BOOLEAN NOT NULL DEFAULT false,
  allow_over_receipt BOOLEAN NOT NULL DEFAULT false,
  over_receipt_tolerance_pct DECIMAL(5,2) NOT NULL DEFAULT 0.00 CHECK (over_receipt_tolerance_pct BETWEEN 0 AND 100),
  enable_transit_location BOOLEAN NOT NULL DEFAULT true,

  -- Phase 2: Scanner & Labels
  scanner_idle_timeout_sec INTEGER NOT NULL DEFAULT 300 CHECK (scanner_idle_timeout_sec BETWEEN 60 AND 3600),
  scanner_sound_feedback BOOLEAN NOT NULL DEFAULT true,
  print_label_on_receipt BOOLEAN NOT NULL DEFAULT true,
  label_copies_default INTEGER NOT NULL DEFAULT 1 CHECK (label_copies_default BETWEEN 1 AND 10),

  -- Phase 3: Advanced Features
  enable_pallets BOOLEAN NOT NULL DEFAULT false,
  enable_gs1_barcodes BOOLEAN NOT NULL DEFAULT false,
  enable_catch_weight BOOLEAN NOT NULL DEFAULT false,
  enable_location_zones BOOLEAN NOT NULL DEFAULT false,
  enable_location_capacity BOOLEAN NOT NULL DEFAULT false,

  -- Audit
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  created_by UUID REFERENCES users(id),
  updated_by UUID REFERENCES users(id),

  CONSTRAINT warehouse_settings_org_unique UNIQUE(org_id),
  CONSTRAINT warehouse_settings_prefix_format CHECK (lp_number_prefix ~ '^[A-Z0-9-]+$'),
  CONSTRAINT warehouse_settings_prefix_length CHECK (char_length(lp_number_prefix) BETWEEN 1 AND 10)
);

-- Index
CREATE INDEX idx_warehouse_settings_org_id ON warehouse_settings(org_id);

-- Trigger: Update updated_at timestamp
CREATE OR REPLACE FUNCTION update_warehouse_settings_timestamp()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER tr_warehouse_settings_updated_at
BEFORE UPDATE ON warehouse_settings
FOR EACH ROW
EXECUTE FUNCTION update_warehouse_settings_timestamp();

-- Trigger: Initialize settings on org creation
CREATE OR REPLACE FUNCTION init_warehouse_settings_for_org()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO warehouse_settings (org_id, created_by)
  VALUES (NEW.id, NEW.created_by)
  ON CONFLICT (org_id) DO NOTHING;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER tr_init_warehouse_settings
AFTER INSERT ON organizations
FOR EACH ROW
EXECUTE FUNCTION init_warehouse_settings_for_org();
```

### Audit Table (Optional)

```sql
CREATE TABLE warehouse_settings_audit (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id),
  settings_id UUID NOT NULL REFERENCES warehouse_settings(id),
  setting_name VARCHAR(100) NOT NULL,
  old_value TEXT,
  new_value TEXT,
  changed_by UUID NOT NULL REFERENCES users(id),
  changed_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_warehouse_settings_audit_org ON warehouse_settings_audit(org_id);
CREATE INDEX idx_warehouse_settings_audit_changed_at ON warehouse_settings_audit(changed_at DESC);
```

### RLS Policies

```sql
-- Enable RLS
ALTER TABLE warehouse_settings ENABLE ROW LEVEL SECURITY;

-- Select: Org isolation
CREATE POLICY "warehouse_settings_select" ON warehouse_settings
FOR SELECT TO authenticated
USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

-- Insert: Org isolation + admin only (usually via trigger)
CREATE POLICY "warehouse_settings_insert" ON warehouse_settings
FOR INSERT TO authenticated
WITH CHECK (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  AND (
    (SELECT r.code FROM roles r JOIN users u ON u.role_id = r.id WHERE u.id = auth.uid())
    IN ('SUPER_ADMIN', 'ADMIN')
  )
);

-- Update: Org isolation + permission check
CREATE POLICY "warehouse_settings_update" ON warehouse_settings
FOR UPDATE TO authenticated
USING (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  AND (
    (SELECT r.code FROM roles r JOIN users u ON u.role_id = r.id WHERE u.id = auth.uid())
    IN ('SUPER_ADMIN', 'ADMIN', 'WH_MANAGER')
  )
);

-- Delete: Disabled (settings should not be deleted, only reset to defaults)
-- No DELETE policy - prevents accidental deletion
```

### API Endpoints

```
GET    /api/v1/warehouse/settings              - Get org's warehouse settings
PUT    /api/v1/warehouse/settings              - Update warehouse settings (full replace)
PATCH  /api/v1/warehouse/settings              - Partial update of specific settings
POST   /api/v1/warehouse/settings/reset        - Reset to default values
GET    /api/v1/warehouse/settings/history      - Get change history (last 50)
```

**Response Example:**

```json
{
  "id": "uuid",
  "org_id": "uuid",
  "auto_generate_lp_number": true,
  "lp_number_prefix": "LP",
  "lp_number_sequence_length": 8,
  "enable_split_merge": true,
  "require_qa_on_receipt": true,
  "default_qa_status": "pending",
  "enable_expiry_tracking": true,
  "require_expiry_on_receipt": false,
  "expiry_warning_days": 30,
  "enable_batch_tracking": true,
  "require_batch_on_receipt": false,
  "enable_supplier_batch": true,
  "enable_fifo": true,
  "enable_fefo": false,
  "enable_asn": false,
  "allow_over_receipt": false,
  "over_receipt_tolerance_pct": 0.00,
  "enable_transit_location": true,
  "scanner_idle_timeout_sec": 300,
  "scanner_sound_feedback": true,
  "print_label_on_receipt": true,
  "label_copies_default": 1,
  "enable_pallets": false,
  "enable_gs1_barcodes": false,
  "enable_catch_weight": false,
  "enable_location_zones": false,
  "enable_location_capacity": false,
  "created_at": "2025-01-15T10:00:00Z",
  "updated_at": "2025-01-16T14:30:00Z",
  "created_by": "uuid",
  "updated_by": "uuid"
}
```

### Service Layer

```typescript
// lib/services/warehouse-settings-service.ts
export interface WarehouseSettingsService {
  get(): Promise<WarehouseSettings>;
  update(data: UpdateWarehouseSettingsInput): Promise<WarehouseSettings>;
  partialUpdate(data: Partial<UpdateWarehouseSettingsInput>): Promise<WarehouseSettings>;
  reset(): Promise<WarehouseSettings>;
  getHistory(limit?: number): Promise<WarehouseSettingsAudit[]>;
}

export interface WarehouseSettings {
  id: string;
  org_id: string;
  // Phase 0
  auto_generate_lp_number: boolean;
  lp_number_prefix: string;
  lp_number_sequence_length: number;
  enable_split_merge: boolean;
  require_qa_on_receipt: boolean;
  default_qa_status: 'pending' | 'passed' | 'failed' | 'quarantine';
  enable_expiry_tracking: boolean;
  require_expiry_on_receipt: boolean;
  expiry_warning_days: number;
  enable_batch_tracking: boolean;
  require_batch_on_receipt: boolean;
  enable_supplier_batch: boolean;
  enable_fifo: boolean;
  enable_fefo: boolean;
  // Phase 1
  enable_asn: boolean;
  allow_over_receipt: boolean;
  over_receipt_tolerance_pct: number;
  enable_transit_location: boolean;
  // Phase 2
  scanner_idle_timeout_sec: number;
  scanner_sound_feedback: boolean;
  print_label_on_receipt: boolean;
  label_copies_default: number;
  // Phase 3
  enable_pallets: boolean;
  enable_gs1_barcodes: boolean;
  enable_catch_weight: boolean;
  enable_location_zones: boolean;
  enable_location_capacity: boolean;
  // Audit
  created_at: string;
  updated_at: string;
  created_by: string;
  updated_by: string;
}

export interface WarehouseSettingsAudit {
  id: string;
  org_id: string;
  settings_id: string;
  setting_name: string;
  old_value: string | null;
  new_value: string | null;
  changed_by: string;
  changed_at: string;
}
```

### Validation Schema (Zod)

```typescript
// lib/validation/warehouse-settings.ts
import { z } from 'zod';

export const qaStatusEnum = z.enum(['pending', 'passed', 'failed', 'quarantine']);

export const warehouseSettingsSchema = z.object({
  // Phase 0
  auto_generate_lp_number: z.boolean(),
  lp_number_prefix: z.string()
    .min(1, "Prefix must be at least 1 character")
    .max(10, "Prefix must be at most 10 characters")
    .regex(/^[A-Z0-9-]+$/, "Prefix must be uppercase alphanumeric with hyphens only")
    .transform(val => val.toUpperCase()),
  lp_number_sequence_length: z.number()
    .int()
    .min(4, "Sequence length must be at least 4")
    .max(12, "Sequence length must be at most 12"),
  enable_split_merge: z.boolean(),
  require_qa_on_receipt: z.boolean(),
  default_qa_status: qaStatusEnum,
  enable_expiry_tracking: z.boolean(),
  require_expiry_on_receipt: z.boolean(),
  expiry_warning_days: z.number()
    .int()
    .min(1, "Warning days must be at least 1")
    .max(365, "Warning days must be at most 365"),
  enable_batch_tracking: z.boolean(),
  require_batch_on_receipt: z.boolean(),
  enable_supplier_batch: z.boolean(),
  enable_fifo: z.boolean(),
  enable_fefo: z.boolean(),
  // Phase 1
  enable_asn: z.boolean(),
  allow_over_receipt: z.boolean(),
  over_receipt_tolerance_pct: z.number()
    .min(0, "Tolerance must be at least 0%")
    .max(100, "Tolerance must be at most 100%"),
  enable_transit_location: z.boolean(),
  // Phase 2
  scanner_idle_timeout_sec: z.number()
    .int()
    .min(60, "Timeout must be at least 60 seconds")
    .max(3600, "Timeout must be at most 3600 seconds (60 minutes)"),
  scanner_sound_feedback: z.boolean(),
  print_label_on_receipt: z.boolean(),
  label_copies_default: z.number()
    .int()
    .min(1, "Must print at least 1 copy")
    .max(10, "Cannot print more than 10 copies"),
  // Phase 3
  enable_pallets: z.boolean(),
  enable_gs1_barcodes: z.boolean(),
  enable_catch_weight: z.boolean(),
  enable_location_zones: z.boolean(),
  enable_location_capacity: z.boolean(),
}).refine(data => {
  // Cross-field validation: require_batch_on_receipt requires enable_batch_tracking
  if (data.require_batch_on_receipt && !data.enable_batch_tracking) {
    return false;
  }
  return true;
}, {
  message: "require_batch_on_receipt requires enable_batch_tracking to be enabled",
  path: ["require_batch_on_receipt"]
}).refine(data => {
  // Cross-field validation: require_expiry_on_receipt requires enable_expiry_tracking
  if (data.require_expiry_on_receipt && !data.enable_expiry_tracking) {
    return false;
  }
  return true;
}, {
  message: "require_expiry_on_receipt requires enable_expiry_tracking to be enabled",
  path: ["require_expiry_on_receipt"]
}).refine(data => {
  // Cross-field validation: lp_number_prefix required when auto_generate_lp_number enabled
  if (data.auto_generate_lp_number && !data.lp_number_prefix) {
    return false;
  }
  return true;
}, {
  message: "lp_number_prefix required when auto_generate_lp_number is enabled",
  path: ["lp_number_prefix"]
});

export const updateWarehouseSettingsSchema = warehouseSettingsSchema.partial();

export type UpdateWarehouseSettingsInput = z.infer<typeof updateWarehouseSettingsSchema>;
export type WarehouseSettingsValidation = z.infer<typeof warehouseSettingsSchema>;
```

---

## UI Components

```
app/(authenticated)/settings/warehouse/
  page.tsx                          -- Warehouse settings page

components/settings/warehouse/
  WarehouseSettingsForm.tsx         -- Main form with 4 collapsible sections
  Phase0CoreSettings.tsx            -- LP, QA, Batch, Expiry, FIFO/FEFO
  Phase1ReceiptSettings.tsx         -- ASN, Over-receipt, Transit location
  Phase2ScannerSettings.tsx         -- Scanner, Label printing
  Phase3AdvancedSettings.tsx        -- Pallets, GS1, Catch weight, Zones, Capacity
  LPConfigurationSection.tsx        -- LP auto-gen, prefix, sequence
  PickStrategySection.tsx           -- FIFO/FEFO toggles with warning
  BatchTrackingSection.tsx          -- Batch toggles with dependencies
  ExpiryTrackingSection.tsx         -- Expiry toggles with warning days
  QAStatusSection.tsx               -- QA requirement and default status
  OverReceiptSection.tsx            -- Over-receipt toggles and tolerance
  ScannerConfigSection.tsx          -- Scanner timeout and sound
  LabelPrintingSection.tsx          -- Print toggles and copies
  SettingsHistoryModal.tsx          -- Audit trail viewer
  SettingsResetDialog.tsx           -- Confirm reset to defaults
  PhaseBadge.tsx                    -- "Phase 0", "Phase 1", etc.
```

### Badge Styles

| Phase | Badge Class | Display |
|-------|-------------|---------|
| Phase 0 | `bg-red-100 text-red-800` | Phase 0 - Critical |
| Phase 1 | `bg-blue-100 text-blue-800` | Phase 1 |
| Phase 2 | `bg-yellow-100 text-yellow-800` | Phase 2 |
| Phase 3 | `bg-purple-100 text-purple-800` | Phase 3 |

---

## Key Business Rules

1. **LP Prefix Validation**: Must be uppercase alphanumeric with hyphens only, 1-10 characters
2. **Sequence Length Range**: 4-12 digits (LP00000001 to LP000000000001)
3. **FEFO Precedence**: If both FIFO and FEFO enabled, FEFO takes precedence (expiry_date ASC, then created_at ASC)
4. **Cross-Field Dependencies**:
   - `require_batch_on_receipt` requires `enable_batch_tracking = true`
   - `require_expiry_on_receipt` requires `enable_expiry_tracking = true`
   - `lp_number_prefix` required when `auto_generate_lp_number = true`
   - `label_copies_default` disabled when `print_label_on_receipt = false`
   - `over_receipt_tolerance_pct` disabled when `allow_over_receipt = false`
5. **Default Values**: All settings have sensible defaults for Phase 0 immediate usability
6. **One Settings Record Per Org**: Enforced by `UNIQUE(org_id)` constraint
7. **Audit Trail**: All changes logged to `warehouse_settings_audit` table
8. **Concurrency**: `updated_at` timestamp used for optimistic locking
9. **Initialization**: Settings auto-created when organization created (via trigger)
10. **Reset**: Reset returns to table default values, preserves org_id

---

## Out of Scope (This Story)

| Feature | Reason | Future Story |
|---------|--------|--------------|
| License Plates CRUD operations | Separate concern | Story 05.5 |
| Actual FIFO/FEFO enforcement logic | Settings only | Story 05.4 |
| Scanner workflow implementation | Settings only | Stories 05.16-05.23 |
| Label printing (ZPL generation) | Settings only | Story 05.14 |
| Pallet management features | Settings only | Story 05.26 |
| GS1 barcode parsing | Settings only | Stories 05.24-05.25 |
| Catch weight calculations | Settings only | Story 05.27 |
| Location zones management | Settings only | Story 05.30 |
| Location capacity tracking | Settings only | Story 05.29 |

---

## Test Cases

### Unit Tests

**File:** `__tests__/unit/services/warehouse-settings-service.test.ts`

| Test Case | Description |
|-----------|-------------|
| `get()` returns org-scoped settings | Verify RLS filtering |
| `update()` validates all fields | Zod schema validation |
| `update()` enforces cross-field rules | require_batch requires enable_batch |
| `partialUpdate()` merges with existing | Only updates provided fields |
| `reset()` restores defaults | All fields back to table defaults |
| `getHistory()` returns audit trail | Last 50 changes |
| Concurrent update detection | updated_at optimistic locking |

### Integration Tests

**File:** `__tests__/integration/api/warehouse/settings.test.ts`

| Test Case | Description |
|-----------|-------------|
| GET `/warehouse/settings` returns settings | Current org settings |
| GET `/warehouse/settings` auto-creates if missing | Init on first access |
| PUT `/warehouse/settings` updates all fields | Full replace |
| PUT `/warehouse/settings` validation errors | 400 with field errors |
| PUT `/warehouse/settings` cross-field validation | require_batch dependency |
| PATCH `/warehouse/settings` partial update | Only changed fields |
| POST `/warehouse/settings/reset` restores defaults | All fields reset |
| GET `/warehouse/settings/history` returns audit | Last 50 changes |
| Cross-org access returns 404 | Multi-tenancy enforced |
| Permission denied returns 403 | Role enforcement |

### E2E Tests

**File:** `__tests__/e2e/settings/warehouse.spec.ts`

| Test Case | Description |
|-----------|-------------|
| Navigate to warehouse settings | Page loads, 4 sections display |
| Expand/collapse section | Phase 0 section toggles |
| Toggle FIFO on/off | Switch works, preview updates |
| Set LP prefix and sequence | Input validation, preview updates |
| Enable require_batch with batch disabled | Error displays, save blocked |
| Save settings successfully | Toast appears, button disabled |
| View change history | Modal opens, last 50 changes |
| Reset to defaults | Confirmation, settings restored |
| Permission-based UI | Viewer sees read-only |

---

## Definition of Done

- [ ] Database migration creates `warehouse_settings` table with all 25+ fields
- [ ] RLS policies enforce org isolation and role permissions
- [ ] Trigger auto-creates settings on org creation
- [ ] Trigger updates `updated_at` timestamp on every update
- [ ] All 3 API endpoints implemented (GET, PUT, PATCH, POST reset)
- [ ] Audit table `warehouse_settings_audit` created and populated
- [ ] Zod schema validates all fields with cross-field rules
- [ ] `warehouse-settings-service.ts` implements all methods
- [ ] Settings page renders with 4 collapsible sections organized by phase
- [ ] Phase badges display correctly (0-3)
- [ ] All Phase 0 toggles and inputs functional (LP, QA, Batch, Expiry, FIFO/FEFO)
- [ ] All Phase 1 toggles and inputs functional (ASN, Over-receipt, Transit)
- [ ] All Phase 2 toggles and inputs functional (Scanner, Label printing)
- [ ] All Phase 3 toggles and inputs functional (Pallets, GS1, Catch weight, Zones, Capacity)
- [ ] Cross-field dependencies enforced in UI (disable dependent fields)
- [ ] LP number prefix validation (uppercase, alphanumeric, hyphens)
- [ ] Sequence length slider (4-12) with live preview
- [ ] FEFO precedence warning displays when both FIFO and FEFO enabled
- [ ] Expiry warning days input (1-365)
- [ ] Over-receipt tolerance percentage (0-100, 2 decimals)
- [ ] Scanner timeout input (60-3600 seconds)
- [ ] Label copies input (1-10)
- [ ] Settings history modal displays last 50 changes
- [ ] Reset to defaults dialog with confirmation
- [ ] Save button disabled until changes made
- [ ] Validation errors display inline next to fields
- [ ] Toast notifications on success/error
- [ ] Concurrent update conflict handling (409 error)
- [ ] Multi-tenancy: cross-org returns 404
- [ ] Permission matrix implemented (admin, wh_manager read-only for others)
- [ ] Unit tests >= 80% coverage
- [ ] Integration tests for all endpoints
- [ ] E2E tests for critical flows (save, reset, history)
- [ ] Loading, empty, error states implemented
- [ ] Accessibility: keyboard nav, ARIA labels, screen reader support
- [ ] Mobile responsive (collapsible sections work on small screens)

---

## Future Phases (Not in This Story)

### Phase 1+ Features
- ASN workflow implementation (Story 05.10) - Settings only here
- GRN over-receipt enforcement (Story 05.13) - Settings only here

### Phase 2+ Features
- Scanner workflow implementation (Stories 05.16-05.23) - Settings only here
- Label printing ZPL generation (Story 05.14) - Settings only here

### Phase 3+ Features
- Pallet management (Story 05.26) - Settings toggle only here
- GS1 barcode parsing (Stories 05.24-05.25) - Settings toggle only here
- Catch weight calculations (Story 05.27) - Settings toggle only here
- Location zones CRUD (Story 05.30) - Settings toggle only here
- Location capacity tracking (Story 05.29) - Settings toggle only here

### Future Enhancements
- Settings import/export for multi-org deployment
- Settings templates (e.g., "Fresh Produce", "Dry Goods")
- Settings validation rules engine (custom business rules)
- Notification preferences for expiry alerts
- Advanced FIFO/FEFO rules (product-specific overrides)

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-12-16 | Initial story creation with complete warehouse_settings table (25+ fields organized by phase 0-3) | ARCHITECT-AGENT |
