# 05.9 - ASN Receive Workflow

| Field | Value |
|-------|-------|
| **Story ID** | 05.9 |
| **Epic** | 05 - Warehouse |
| **Status** | Ready |
| **Phase** | Phase 1 (Goods Receipt) |
| **Priority** | P1 (Phase 1) |
| **Complexity** | M (Medium) |
| **Estimate** | 3-4 days |
| **Type** | Backend + Frontend |
| **Model** | Sonnet |

---

## PRD References

| FR ID | Requirement | Priority | Coverage |
|-------|-------------|----------|----------|
| WH-FR-015 | ASN Processing (pre-receive notification, pre-fill GRN) | P1 | Full |
| WH-FR-003 | GRN from PO (receiving workflow) | P0 | Partial (ASN-based) |
| WH-FR-001 | LP Creation | P0 | Integration |
| WH-FR-029 | Over-Receipt Control | P1 | Full |

**Primary PRD:** `docs/1-BASELINE/product/modules/warehouse.md`
**Architecture:** `docs/1-BASELINE/architecture/modules/warehouse.md`

---

## MVP Scope

### In Scope (This Story)

1. **ASN Receive Workflow**
   - Initiate receive against ASN (GET `/api/warehouse/asns/:id/receive`)
   - Pre-populate GRN with ASN item details
   - Capture received quantities with variance tracking
   - Status transitions: pending → partial → received

2. **Variance Handling**
   - Calculate variance: received_qty vs expected_qty
   - Display variance indicators (over/under)
   - Variance reasons (damaged, short-shipped, over-shipped)
   - Auto-update ASN status based on completion

3. **API Endpoints**
   - `POST /api/warehouse/asns/:id/receive` - Start receive workflow
   - `GET /api/warehouse/asns/:id/receive` - Get receive preview
   - Variance tracking in asn_items table

4. **Desktop UI**
   - Receive modal from ASN detail page
   - Pre-filled product list with expected quantities
   - Variance indicators (badges, colors)
   - Variance reason dropdown
   - Completion summary with variance report

5. **Service Layer**
   - `receiveFromASN()` - Core receive logic
   - `calculateASNVariance()` - Variance calculation
   - `updateASNStatus()` - Status management
   - Integration with GRN creation

6. **Validation**
   - Zod schemas for ASN receive request
   - Variance validation (tolerance checks)
   - Over-receipt control integration

### Out of Scope (Other Stories)

| Feature | Deferred To | Reason |
|---------|-------------|--------|
| ASN CRUD operations | 05.8 | Prerequisite story |
| Scanner receive workflow | 05.17 | Phase 2 scanner |
| Label printing on receive | 05.14 | Separate feature |
| GS1 barcode parsing | 05.24 | Phase 3 |
| Pallet receive | 05.26 | Phase 3 |
| Catch weight entry | 05.27 | Phase 3 |

---

## Epic 04 Dependency Status

- [ ] NOT CRITICAL - Can defer

This story enhances receiving efficiency but is not required for Epic 04 Production Phase 1. Epic 04 can proceed with direct PO/TO receiving (05.8).

---

## Goal

Enable warehouse operators to receive goods efficiently against ASN (Advanced Shipping Notice), with automatic GRN pre-population, variance tracking (received vs expected), and status management.

---

## User Story

As a **Warehouse Operator**, I want to **receive goods against an ASN with variance tracking** so that **I can quickly process receipts with pre-filled data and identify discrepancies between expected and actual quantities**.

---

## Dependencies

| Dependency | Story/Epic | Type | Status | Notes |
|------------|------------|------|--------|-------|
| 05.8 | ASN Management (CRUD) | HARD | TO CREATE | Requires asns/asn_items tables |
| 05.1 | LP Table + Service | HARD | Ready | LP creation on receive |
| 03.2 | Purchase Orders | HARD | Done | PO linkage |
| 01.8 | Warehouses CRUD | HARD | Ready | FK to warehouses |
| 01.9 | Locations CRUD | HARD | Ready | FK to locations |

**Dependents (What This Unblocks):**
- 05.17 (Scanner Receive) - Can leverage ASN receive logic

---

## Acceptance Criteria (Given/When/Then)

### AC-1: ASN Receive Preview (WH-FR-015)

```gherkin
Scenario: Preview ASN receive with expected items
  Given ASN exists with status='pending'
  And ASN has 3 items with expected quantities
  When GET /api/warehouse/asns/:id/receive is called
  Then response contains:
    | Field | Value |
    | asn_number | ASN-2025-00001 |
    | status | pending |
    | expected_date | 2025-12-20 |
    | items[0].product_name | Product A |
    | items[0].expected_qty | 100 |
    | items[0].received_qty | 0 |
    | items[0].uom | units |
  And response time is < 300ms
```

### AC-2: Initiate ASN Receive (WH-FR-015)

```gherkin
Scenario: Start receiving against ASN
  Given ASN with id='asn-123' and status='pending'
  And ASN has items with expected quantities
  When POST /api/warehouse/asns/:id/receive with body:
    ```json
    {
      "warehouse_id": "wh-001",
      "location_id": "loc-001",
      "items": [
        {
          "asn_item_id": "item-1",
          "received_qty": 95,
          "batch_number": "B2025001",
          "expiry_date": "2026-12-20",
          "variance_reason": "damaged"
        }
      ]
    }
    ```
  Then GRN record created with source_type='asn'
  And GRN linked to ASN via grn.asn_id
  And LP created for each received item
  And response contains:
    | Field | Value |
    | grn_number | GRN-2025-00001 |
    | status | completed |
    | lps_created | 1 |
  And response time < 500ms
```

### AC-3: Variance Calculation (WH-FR-015)

```gherkin
Scenario: Calculate under-receipt variance
  Given ASN item with expected_qty = 100
  When received_qty = 95
  Then asn_item.received_qty updates to 95
  And variance = -5 (under-received by 5 units)
  And variance_percent = -5.0%
  And variance_indicator = "under"

Scenario: Calculate over-receipt variance
  Given ASN item with expected_qty = 100
  And warehouse_settings.allow_over_receipt = true
  And over_receipt_tolerance_pct = 10
  When received_qty = 105
  Then asn_item.received_qty updates to 105
  And variance = +5 (over-received by 5 units)
  And variance_percent = +5.0%
  And variance_indicator = "over"
  And receipt allowed (within tolerance)

Scenario: Block over-receipt beyond tolerance
  Given ASN item with expected_qty = 100
  And warehouse_settings.allow_over_receipt = true
  And over_receipt_tolerance_pct = 10
  When received_qty = 115
  Then system returns 400 error
  And error message = "Over-receipt exceeds tolerance (max: 110 units)"
  And receipt blocked
```

### AC-4: Partial ASN Receipt (WH-FR-015)

```gherkin
Scenario: Partially receive ASN items
  Given ASN with 3 items
  And item[0].expected_qty = 100
  And item[1].expected_qty = 50
  And item[2].expected_qty = 200
  When receive with:
    - item[0]: received_qty = 100 (full)
    - item[1]: received_qty = 30 (partial)
    - item[2]: not received
  Then asn.status updates to 'partial'
  And asn_item[0].received_qty = 100 (complete)
  And asn_item[1].received_qty = 30 (can receive more)
  And asn_item[2].received_qty = 0 (pending)
  And GRN created for 2 items
```

### AC-5: Full ASN Receipt (WH-FR-015)

```gherkin
Scenario: Fully receive all ASN items
  Given ASN with status='partial'
  And ASN has 3 items
  And all items previously received_qty >= expected_qty
  When final receive completes
  Then asn.status updates to 'received'
  And asn.actual_date set to current date
  And ASN marked complete in dashboard
```

### AC-6: Variance Reason Tracking (WH-FR-015)

```gherkin
Scenario: Record variance with reason
  Given ASN item with expected_qty = 100
  When received_qty = 95
  And variance_reason = "damaged"
  And variance_notes = "5 units damaged in transit"
  Then asn_item.variance_reason = "damaged"
  And asn_item.variance_notes = "5 units damaged in transit"
  And audit trail records variance details
```

### AC-7: ASN Receive Pre-Population (WH-FR-015)

```gherkin
Scenario: GRN pre-populated with ASN data
  Given ASN item with:
    | Field | Value |
    | product_id | prod-001 |
    | expected_qty | 100 |
    | supplier_batch_number | SB-2025-001 |
    | gtin | 01234567890128 |
    | expiry_date | 2026-12-31 |
  When receive workflow initiated
  Then GRN item pre-populated with:
    | Field | Source |
    | product_id | From ASN item |
    | received_qty | User input (defaults to expected_qty) |
    | batch_number | From supplier_batch_number |
    | gtin | From ASN item |
    | expiry_date | From ASN item |
  And operator can edit pre-filled values
```

### AC-8: ASN Status Transitions (WH-FR-015)

```gherkin
Scenario: ASN status lifecycle
  Given ASN created with status='pending'
  When first partial receive completed
  Then ASN status → 'partial'

  When more items received but not all
  Then ASN status remains 'partial'

  When all items fully received
  Then ASN status → 'received'
  And asn.actual_date = NOW()
```

### AC-9: Variance Indicators in UI (WH-FR-015)

```gherkin
Scenario: Display variance badges
  Given ASN receive modal open
  And item[0] has variance = -5 (under)
  And item[1] has variance = +3 (over)
  And item[2] has variance = 0 (exact)
  Then item[0] displays red badge "-5 units"
  And item[1] displays yellow badge "+3 units"
  And item[2] displays green checkmark "Exact match"
  And summary shows total variance count
```

### AC-10: Multiple Receive Sessions (WH-FR-015)

```gherkin
Scenario: Receive ASN in multiple sessions
  Given ASN with expected_qty = 100 for product A
  When Session 1: received_qty = 40
  Then asn_item.received_qty = 40
  And ASN status = 'partial'

  When Session 2: received_qty = 35
  Then asn_item.received_qty = 75 (cumulative)
  And ASN status = 'partial'

  When Session 3: received_qty = 25
  Then asn_item.received_qty = 100 (complete)
  And ASN status = 'received'
```

### AC-11: ASN Receive with Required Fields (WH-FR-003, WH-FR-009, WH-FR-010)

```gherkin
Scenario: Enforce required fields on receive
  Given warehouse_settings.require_batch_on_receipt = true
  And warehouse_settings.require_expiry_on_receipt = true
  When receive submitted without batch_number
  Then system returns 400 error "Batch number required"

  When receive submitted without expiry_date
  Then system returns 400 error "Expiry date required"

  When receive submitted with all required fields
  Then LP created with batch and expiry data
```

### AC-12: Performance Requirements (WH-NFR)

```gherkin
Scenario: ASN receive performance
  Given ASN with 50 items
  When receive workflow initiated
  Then preview loads in < 300ms

  When receive submitted with 50 items
  Then GRN + LPs created in < 2 seconds
  And response confirms completion
```

---

## Implementation Notes

### API Endpoints

```typescript
// Get ASN receive preview
GET /api/warehouse/asns/:id/receive
Response: {
  asn: {
    id: string;
    asn_number: string;
    status: 'pending' | 'partial' | 'received';
    po_number: string;
    supplier_name: string;
    expected_date: string;
  };
  items: Array<{
    id: string;
    product_id: string;
    product_name: string;
    product_sku: string;
    expected_qty: number;
    received_qty: number;
    remaining_qty: number;
    uom: string;
    supplier_batch_number?: string;
    gtin?: string;
    expiry_date?: string;
  }>;
}

// Receive against ASN
POST /api/warehouse/asns/:id/receive
Request: {
  warehouse_id: string;
  location_id: string;
  items: Array<{
    asn_item_id: string;
    received_qty: number;
    batch_number?: string;
    supplier_batch_number?: string;
    expiry_date?: string;
    manufacture_date?: string;
    variance_reason?: 'damaged' | 'short-shipped' | 'over-shipped' | 'other';
    variance_notes?: string;
  }>;
  notes?: string;
}
Response: {
  grn_id: string;
  grn_number: string;
  status: 'completed';
  lps_created: number;
  asn_status: 'partial' | 'received';
  variances: Array<{
    product_name: string;
    expected_qty: number;
    received_qty: number;
    variance: number;
    variance_percent: number;
    variance_indicator: 'under' | 'over' | 'exact';
  }>;
}
```

### Database Changes

**Add to `asn_items` table:**
```sql
ALTER TABLE asn_items
  ADD COLUMN variance_reason TEXT,  -- damaged, short-shipped, over-shipped, other
  ADD COLUMN variance_notes TEXT,
  ADD COLUMN last_received_at TIMESTAMPTZ;

-- Index for variance tracking
CREATE INDEX idx_asn_items_variance
  ON asn_items(asn_id)
  WHERE received_qty != expected_qty;
```

### Frontend Components

```
app/(authenticated)/warehouse/asns/
  [id]/
    components/
      ReceiveModal.tsx           - Main receive workflow modal
      ReceiveItemRow.tsx         - Individual item row with variance
      VarianceBadge.tsx          - Color-coded variance indicator
      ReceiveSummary.tsx         - Completion summary with variances
```

### Services

```typescript
// lib/services/asn-receive-service.ts

export async function getASNReceivePreview(
  asnId: string,
  orgId: string
): Promise<ASNReceivePreview> {
  // Fetch ASN with items, calculate remaining quantities
}

export async function receiveFromASN(
  asnId: string,
  request: ASNReceiveRequest,
  orgId: string,
  userId: string
): Promise<ASNReceiveResult> {
  // 1. Validate ASN status (must be pending/partial)
  // 2. Validate items and quantities
  // 3. Check over-receipt tolerance
  // 4. Create GRN record
  // 5. Create GRN items
  // 6. Create LPs for each item
  // 7. Update asn_items.received_qty (cumulative)
  // 8. Calculate variances
  // 9. Update ASN status (partial/received)
  // 10. Return result with variance summary
}

export async function calculateASNVariance(
  asnItemId: string,
  receivedQty: number
): Promise<VarianceResult> {
  // Calculate variance, variance_percent, indicator
}

export async function updateASNStatus(
  asnId: string,
  orgId: string
): Promise<void> {
  // Check if all items fully received
  // Update status: pending → partial → received
}
```

### Validation (Zod)

```typescript
// lib/validation/asn-receive.ts

export const asnReceiveItemSchema = z.object({
  asn_item_id: z.string().uuid(),
  received_qty: z.number().positive(),
  batch_number: z.string().optional(),
  supplier_batch_number: z.string().optional(),
  expiry_date: z.string().date().optional(),
  manufacture_date: z.string().date().optional(),
  variance_reason: z.enum(['damaged', 'short-shipped', 'over-shipped', 'other']).optional(),
  variance_notes: z.string().max(500).optional(),
});

export const asnReceiveRequestSchema = z.object({
  warehouse_id: z.string().uuid(),
  location_id: z.string().uuid(),
  items: z.array(asnReceiveItemSchema).min(1),
  notes: z.string().max(1000).optional(),
});

export type ASNReceiveRequest = z.infer<typeof asnReceiveRequestSchema>;
```

### Key Business Rules

1. **ASN Status Lifecycle:**
   - `pending` → `partial` (first receive with remaining items)
   - `partial` → `received` (all items fully received)
   - `pending` → `received` (full receive in one session)

2. **Cumulative Receiving:**
   - `asn_items.received_qty` accumulates across multiple sessions
   - remaining_qty = expected_qty - received_qty
   - Can receive until received_qty >= expected_qty

3. **Variance Calculation:**
   - variance = received_qty - expected_qty
   - variance_percent = (variance / expected_qty) * 100
   - variance_indicator:
     - `under`: variance < 0
     - `over`: variance > 0
     - `exact`: variance = 0

4. **Over-Receipt Control:**
   - If `allow_over_receipt = false`: Block if received > expected
   - If `allow_over_receipt = true`:
     - Check tolerance: (received / expected - 1) * 100 <= tolerance_pct
     - Block if exceeds tolerance

5. **GRN Integration:**
   - Each receive session creates ONE GRN
   - GRN links to ASN via `grn.asn_id`
   - GRN items link to ASN items via `grn_items.asn_item_id`
   - LPs created per GRN item

6. **Variance Tracking:**
   - Track variance reasons: damaged, short-shipped, over-shipped, other
   - Optional variance notes for details
   - Audit trail records all variances

7. **Required Fields:**
   - Respect warehouse settings for batch/expiry requirements
   - Pre-fill from ASN data if available
   - Allow operator to override/edit

---

## Deliverables

### Backend
- [ ] Migration: Add variance columns to `asn_items` table
- [ ] API Route: `GET /api/warehouse/asns/:id/receive` (preview)
- [ ] API Route: `POST /api/warehouse/asns/:id/receive` (execute)
- [ ] Service: `asn-receive-service.ts` (3 functions)
- [ ] Validation: `asn-receive.ts` (Zod schemas)
- [ ] Tests: Unit tests for variance calculation (>80% coverage)
- [ ] Tests: Integration tests for receive workflow
- [ ] Tests: Over-receipt tolerance validation

### Frontend
- [ ] Component: `ReceiveModal.tsx` (main workflow)
- [ ] Component: `ReceiveItemRow.tsx` (individual items)
- [ ] Component: `VarianceBadge.tsx` (visual indicators)
- [ ] Component: `ReceiveSummary.tsx` (completion report)
- [ ] Integration: Add "Receive" button to ASN detail page
- [ ] UI: Variance indicators (red/yellow/green badges)
- [ ] UI: Variance reason dropdown
- [ ] E2E Test: Full receive workflow with variances

### Documentation
- [ ] API documentation for receive endpoints
- [ ] Business rules for variance handling
- [ ] Operator guide for ASN receiving

---

## Definition of Done

- [ ] All 12 Acceptance Criteria passing
- [ ] API routes implemented with Zod validation
- [ ] Service layer methods tested (>80% coverage)
- [ ] Variance calculation accuracy verified
- [ ] Over-receipt control tested (allow/block scenarios)
- [ ] Desktop UI functional (receive modal, variance indicators)
- [ ] RLS policies verified for asn_items updates
- [ ] E2E smoke test: Receive ASN with under/over variances
- [ ] Performance: Receive 50-item ASN in < 2 seconds
- [ ] Error handling: Graceful failure with user messages
- [ ] Audit trail: All receives logged with user + timestamp
- [ ] Code review completed
- [ ] Documentation updated

---

## Future Phases (Not in This Story)

### Phase 2 (Scanner)
- **Scanner ASN Receive** (05.17) - Mobile receive workflow with barcode scanning
- Quick receive with audio feedback
- Visual variance indicators on mobile

### Phase 3 (Advanced)
- **GS1 Barcode Integration** (05.24) - Auto-populate from scanned GS1 barcodes
- Parse GTIN, batch, expiry from single scan
- **Pallet Receive** (05.26) - Receive entire pallets from ASN
- **Catch Weight** (05.27) - Capture actual weight vs expected

### Phase 4 (Reporting)
- **Variance Analytics** - Dashboard widget for variance trends
- Supplier performance by variance rates
- Variance reason distribution chart

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-12-16 | Initial story | TECH-WRITER |
