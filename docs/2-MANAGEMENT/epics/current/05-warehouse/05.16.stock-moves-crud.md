# 05.16 - Stock Moves CRUD

**Priority**: P2 (Phase 2)
**Story Points**: M (Medium) - 3-4 days
**Type**: backend + frontend

**State**: ready
**Primary PRD**: `docs/1-BASELINE/product/modules/warehouse.md` (WH-FR-005)
**Architecture**: `docs/1-BASELINE/architecture/modules/warehouse.md`

---

## MVP Scope

This story delivers the `stock_moves` table and CRUD operations for tracking all LP movements in the system. Stock moves provide an audit trail for every LP location change and quantity adjustment.

**In MVP:**
- `stock_moves` table with 7 move types
- Move number auto-generation (SM-YYYY-NNNNN)
- API endpoints for list, create, cancel operations
- Desktop UI for movement history and filtering
- Service layer for creating moves on LP operations
- Automatic LP.location_id updates on transfer moves

**Not in MVP:**
- Scanner workflows for moves (see 05.18 Scanner Move)
- Guided putaway (see 05.19 Scanner Putaway)
- Cycle count adjustments (see 05.35)
- Advanced reporting/analytics

---

## Epic 04 Dependency Status

- [ ] NOT CRITICAL - Can defer
- [x] Phase 2 story - audit trail for LP movements

This story provides movement audit trail but is not a hard blocker for Epic 04 Phase 1. LP operations in 05.1-05.7 can proceed without formal stock_moves records initially.

---

## Goal

Create a comprehensive audit trail for all LP movements (transfers, adjustments, receipts, issues, returns, quarantine, putaway) with full traceability and the ability to query movement history by LP, location, date, or type.

## User Story

As a **warehouse manager**, I want **to view and track all license plate movements** so that **I have a complete audit trail of inventory transfers, adjustments, and location changes for traceability and compliance**.

## Scope

**In scope (this story)**
- `stock_moves` table with move_type support (transfer, issue, receipt, adjustment, return, quarantine, putaway)
- Move number generation service (SM-YYYY-NNNNN format)
- API endpoints: GET list, GET detail, POST create, POST cancel
- Desktop movements list page with filters
- Movement history component (by LP)
- Service layer integration with LP operations
- Automatic LP.location_id updates on transfer moves
- RLS policies for multi-tenant isolation

**Out of scope (this story)**
- Scanner move workflows (05.18 Scanner Move)
- Guided putaway logic (05.19 Scanner Putaway)
- Bulk movements or batch operations
- Movement approval workflows
- Advanced analytics or dashboards (05.15 Dashboard)
- Movement reversal operations
- Integration with cycle count adjustments (05.35)

## Dependencies

- **01.1** - Organization RLS policies
- **01.8** - Warehouses table (for warehouse context)
- **01.9** - Locations table (from/to location references)
- **02.1** - Products table (for LP product reference)
- **05.1** - LP Table + Service (license_plates table must exist)
- **05.2** - LP Genealogy (genealogy links for split/merge moves)

## Acceptance Criteria (Given/When/Then)

### AC-1: Stock Moves Table Creation

**Given** the warehouse module is being deployed
**When** the stock_moves migration runs
**Then** the table is created with:
- All required fields: id, org_id, move_number, lp_id, move_type, quantity, move_date, status
- FK references: lp_id → license_plates, from_location_id/to_location_id → locations
- Move types enum: transfer, issue, receipt, adjustment, return, quarantine, putaway
- Default status = 'completed'
- Unique constraint on (org_id, move_number)
- Indexes: (lp_id), (move_date), (org_id, move_type)
- RLS enabled with org isolation policy

### AC-2: Move Number Auto-Generation

**Given** a stock move is being created
**When** the service calls generateMoveNumber()
**Then** it returns a unique number in format `SM-YYYY-NNNNN`:
- SM prefix for "Stock Move"
- YYYY = current year (e.g., 2025)
- NNNNN = zero-padded sequence starting at 00001 per year
- Example: `SM-2025-00001`, `SM-2025-00042`
- Sequence resets to 00001 on January 1st each year
- Operation completes in <100ms

### AC-3: Create Transfer Move (Full LP)

**Given** an LP with status='available' at location A
**When** user creates a transfer move with destination location B and move_qty = LP.qty
**Then** system:
- Creates stock_move record with move_type='transfer'
- Sets from_location_id = current LP.location_id
- Sets to_location_id = destination location
- Updates LP.location_id to destination location
- Sets stock_move.status = 'completed'
- Generates move_number (e.g., SM-2025-00123)
- Records created_by = current user
- Completes operation in <300ms
- Returns success with move record

### AC-4: Create Transfer Move (Partial LP)

**Given** an LP with qty=100 at location A
**When** user creates a transfer move with move_qty=30 to location B
**Then** system:
- Triggers LP split operation (via 05.6)
- Creates new LP with qty=30 at location B
- Updates original LP qty to 70 at location A
- Creates stock_move record with move_type='transfer', quantity=30
- Links move to both parent and child LP in genealogy
- Completes in <500ms

### AC-5: Validation - LP Not Available

**Given** an LP with status='consumed' or 'blocked'
**When** user attempts to create a transfer move
**Then** system:
- Returns 400 error: "LP not available for movement (status: {status})"
- Does not create stock_move record
- Does not update LP

### AC-6: Validation - Move Quantity Exceeds Available

**Given** an LP with qty=50
**When** user attempts to create a move with move_qty=75
**Then** system:
- Returns 400 error: "Move quantity exceeds available quantity"
- Does not proceed with move

### AC-7: Validation - Destination Location

**Given** a transfer move request
**When** destination location is inactive or does not exist
**Then** system:
- Returns 400 error: "Destination location not available"
- Does not create move

### AC-8: Create Adjustment Move

**Given** an LP with qty=100
**When** user creates adjustment move with new_qty=95 and reason_code='damage'
**Then** system:
- Creates stock_move with move_type='adjustment'
- Sets quantity = -5 (delta)
- Records reason_code = 'damage'
- Updates LP.qty to 95
- Does not change LP.location_id
- Sets status='completed'

### AC-9: Create Receipt Move (from GRN)

**Given** a new LP is being created via GRN (05.8)
**When** the LP is created with qty=100 at receiving location
**Then** system automatically:
- Creates stock_move with move_type='receipt'
- Sets to_location_id = receiving location
- Sets from_location_id = NULL (external source)
- Links to grn_id via reference_id
- Sets reference_type='grn'

### AC-10: Create Quarantine Move

**Given** an LP with qa_status='failed' at location A
**When** user creates quarantine move to quarantine location Q
**Then** system:
- Creates stock_move with move_type='quarantine'
- Updates LP.location_id to quarantine location
- Updates LP.qa_status to 'quarantine'
- Records reason for quarantine in notes

### AC-11: Cancel Stock Move

**Given** a stock_move with status='completed' created in last 24 hours
**When** manager initiates cancel operation with reason
**Then** system:
- Updates stock_move.status to 'cancelled'
- Records cancelled_at timestamp and cancelled_by user
- Records cancellation reason in notes
- DOES NOT reverse LP changes (requires manual correction)
- Returns success

### AC-12: List Stock Moves with Filters

**Given** user is on movements page
**When** page loads with filters: date_range, move_type, lp_number, location
**Then** system displays:
- Paginated list (50 per page) of stock moves
- Columns: move_number, move_date, LP number, move_type, from/to locations, quantity, status
- Default sort: move_date DESC
- Filter controls for all filter criteria
- Export to CSV button
- Query completes in <500ms for typical dataset (10K moves)

### AC-13: View Movement History by LP

**Given** user viewing LP detail page
**When** "Movement History" tab is selected
**Then** system displays:
- All stock_moves for this LP ordered by move_date DESC
- Each move shows: date, type, from→to locations, quantity, user, status
- Visual timeline representation
- Query completes in <200ms

### AC-14: RLS Policy Enforcement

**Given** a stock_move belongs to org_id=A
**When** a user from org_id=B attempts to query stock_moves
**Then** system:
- Returns empty result set (no records visible)
- Does not throw error
- RLS policy blocks cross-org access

### AC-15: Performance - Movement History Query

**Given** an LP with 500+ movement records
**When** user views movement history
**Then** system:
- Returns first 50 records in <200ms
- Supports pagination for remaining records
- Uses index on (lp_id, move_date DESC)

## Implementation Notes

### API Endpoints

**GET /api/warehouse/stock-moves**
```typescript
Query params:
  - page: number (default 1)
  - limit: number (default 50, max 200)
  - move_type: 'transfer' | 'issue' | 'receipt' | 'adjustment' | 'return' | 'quarantine' | 'putaway'
  - lp_id: UUID (filter by specific LP)
  - location_id: UUID (filter by from or to location)
  - date_from: ISO date
  - date_to: ISO date
  - status: 'completed' | 'cancelled'

Response:
{
  data: StockMove[],
  pagination: { page, limit, total, totalPages }
}
```

**GET /api/warehouse/stock-moves/:id**
```typescript
Response:
{
  data: StockMove with expanded LP, location, user details
}
```

**POST /api/warehouse/stock-moves**
```typescript
Body:
{
  lp_id: UUID,
  move_type: string,
  to_location_id?: UUID,
  quantity?: number (optional, defaults to full LP qty),
  reason?: string,
  reason_code?: string (for adjustments),
  wo_id?: UUID (for production-related moves),
  reference_id?: UUID (link to GRN, TO, etc.),
  reference_type?: string
}

Response:
{
  data: Created StockMove
}
```

**POST /api/warehouse/stock-moves/:id/cancel**
```typescript
Body:
{
  reason: string (required)
}

Response:
{
  data: Updated StockMove with status='cancelled'
}
```

### Database

**Migration: create_stock_moves_table.sql**

```sql
CREATE TABLE stock_moves (
  -- Identity
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id),
  move_number TEXT NOT NULL,

  -- LP Reference
  lp_id UUID NOT NULL REFERENCES license_plates(id) ON DELETE RESTRICT,

  -- Move Details
  move_type TEXT NOT NULL CHECK (move_type IN (
    'transfer', 'issue', 'receipt', 'adjustment',
    'return', 'quarantine', 'putaway'
  )),
  from_location_id UUID REFERENCES locations(id),
  to_location_id UUID REFERENCES locations(id),
  quantity DECIMAL(15,4) NOT NULL,

  -- Status
  status TEXT NOT NULL DEFAULT 'completed' CHECK (status IN ('completed', 'cancelled')),
  move_date TIMESTAMPTZ NOT NULL DEFAULT now(),

  -- Context
  reason TEXT,
  reason_code TEXT, -- For adjustments: damage, theft, counting_error, quality_issue, expired, other

  -- References
  wo_id UUID REFERENCES work_orders(id),
  reference_id UUID, -- Generic FK to GRN, TO, adjustment, etc.
  reference_type TEXT, -- 'grn', 'to', 'wo', 'adjustment', 'manual'

  -- Audit
  created_at TIMESTAMPTZ DEFAULT now(),
  created_by UUID REFERENCES users(id),
  cancelled_at TIMESTAMPTZ,
  cancelled_by UUID REFERENCES users(id),
  notes TEXT,

  -- Constraints
  CONSTRAINT unique_move_number UNIQUE(org_id, move_number),
  CONSTRAINT valid_locations CHECK (
    (move_type = 'receipt' AND from_location_id IS NULL AND to_location_id IS NOT NULL) OR
    (move_type = 'issue' AND from_location_id IS NOT NULL AND to_location_id IS NULL) OR
    (move_type = 'adjustment' AND from_location_id IS NULL AND to_location_id IS NULL) OR
    (move_type IN ('transfer', 'return', 'quarantine', 'putaway')
     AND from_location_id IS NOT NULL AND to_location_id IS NOT NULL)
  )
);

-- Indexes
CREATE INDEX idx_stock_moves_lp ON stock_moves(lp_id);
CREATE INDEX idx_stock_moves_date ON stock_moves(move_date DESC);
CREATE INDEX idx_stock_moves_type ON stock_moves(org_id, move_type);
CREATE INDEX idx_stock_moves_status ON stock_moves(org_id, status);
CREATE INDEX idx_stock_moves_location_from ON stock_moves(from_location_id) WHERE from_location_id IS NOT NULL;
CREATE INDEX idx_stock_moves_location_to ON stock_moves(to_location_id) WHERE to_location_id IS NOT NULL;
CREATE INDEX idx_stock_moves_reference ON stock_moves(reference_id, reference_type) WHERE reference_id IS NOT NULL;

-- RLS
ALTER TABLE stock_moves ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Stock moves org isolation"
ON stock_moves FOR ALL
USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));
```

### Frontend Components

```
app/(authenticated)/warehouse/movements/
  page.tsx                           -- Main movements list page
  [id]/page.tsx                      -- Movement detail page
  components/
    MovementTable.tsx                -- Paginated table with filters
    MovementFilters.tsx              -- Date, type, location filters
    MovementHistoryCard.tsx          -- Timeline view for LP history
    MovementDetailPanel.tsx          -- Expanded move details
    CreateMoveModal.tsx              -- Manual move creation form
    CancelMoveModal.tsx              -- Cancel confirmation dialog
```

**MovementTable.tsx** - Key features:
- Columns: move_number, date, LP, type badge, from→to locations, qty, status, user, actions
- Sortable by date, type, LP
- Row click opens detail panel
- Status badges: Green (completed), Red (cancelled)
- Export CSV button

**MovementHistoryCard.tsx** - Used on LP detail page:
- Vertical timeline layout
- Each entry: date, type icon, from→to arrow, user avatar, expand button
- Grouped by date
- Load more pagination

### Services

**lib/services/stock-move-service.ts**

```typescript
import { createClient } from '@/lib/supabase/server';
import { generateSequenceNumber } from '@/lib/utils/sequence';

export interface CreateStockMoveParams {
  lpId: string;
  moveType: 'transfer' | 'issue' | 'receipt' | 'adjustment' | 'return' | 'quarantine' | 'putaway';
  toLocationId?: string;
  quantity?: number; // If not provided, uses full LP qty
  reason?: string;
  reasonCode?: string;
  woId?: string;
  referenceId?: string;
  referenceType?: string;
}

export interface StockMove {
  id: string;
  orgId: string;
  moveNumber: string;
  lpId: string;
  moveType: string;
  fromLocationId: string | null;
  toLocationId: string | null;
  quantity: number;
  status: string;
  moveDate: string;
  reason: string | null;
  reasonCode: string | null;
  woId: string | null;
  referenceId: string | null;
  referenceType: string | null;
  createdAt: string;
  createdBy: string;
  cancelledAt: string | null;
  cancelledBy: string | null;
  notes: string | null;
}

/**
 * Generate next stock move number in format SM-YYYY-NNNNN
 */
export async function generateMoveNumber(orgId: string): Promise<string> {
  const year = new Date().getFullYear();
  const prefix = `SM-${year}-`;

  const sequence = await generateSequenceNumber({
    table: 'stock_moves',
    column: 'move_number',
    prefix,
    orgId,
    length: 5,
  });

  return `${prefix}${sequence}`;
}

/**
 * Create a stock move and update LP location if transfer/putaway/quarantine
 */
export async function createStockMove(params: CreateStockMoveParams): Promise<StockMove> {
  const supabase = createClient();

  // 1. Get current user
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) throw new Error('Unauthorized');

  const { data: userData } = await supabase
    .from('users')
    .select('org_id')
    .eq('id', user.id)
    .single();
  if (!userData) throw new Error('User not found');

  // 2. Get LP details
  const { data: lp } = await supabase
    .from('license_plates')
    .select('id, quantity, location_id, status, qa_status')
    .eq('id', params.lpId)
    .single();
  if (!lp) throw new Error('LP not found');

  // 3. Validations
  if (lp.status !== 'available') {
    throw new Error(`LP not available for movement (status: ${lp.status})`);
  }

  const moveQty = params.quantity ?? lp.quantity;
  if (moveQty > lp.quantity) {
    throw new Error('Move quantity exceeds available quantity');
  }

  // 4. Validate destination location (for transfer types)
  if (['transfer', 'putaway', 'quarantine', 'return'].includes(params.moveType)) {
    if (!params.toLocationId) {
      throw new Error('Destination location required for this move type');
    }

    const { data: location } = await supabase
      .from('locations')
      .select('id, is_active')
      .eq('id', params.toLocationId)
      .single();

    if (!location || !location.is_active) {
      throw new Error('Destination location not available');
    }
  }

  // 5. Handle partial move (triggers split)
  if (moveQty < lp.quantity) {
    // TODO: Call LP split service from 05.6
    throw new Error('Partial moves require LP split - implement after 05.6');
  }

  // 6. Generate move number
  const moveNumber = await generateMoveNumber(userData.org_id);

  // 7. Create stock_move record
  const moveData = {
    org_id: userData.org_id,
    move_number: moveNumber,
    lp_id: params.lpId,
    move_type: params.moveType,
    from_location_id: ['receipt', 'adjustment'].includes(params.moveType) ? null : lp.location_id,
    to_location_id: params.toLocationId ?? null,
    quantity: moveQty,
    status: 'completed',
    move_date: new Date().toISOString(),
    reason: params.reason,
    reason_code: params.reasonCode,
    wo_id: params.woId,
    reference_id: params.referenceId,
    reference_type: params.referenceType,
    created_by: user.id,
  };

  const { data: move, error: moveError } = await supabase
    .from('stock_moves')
    .insert(moveData)
    .select()
    .single();

  if (moveError) throw moveError;

  // 8. Update LP location if transfer/putaway/quarantine/return
  if (['transfer', 'putaway', 'quarantine', 'return'].includes(params.moveType)) {
    const { error: updateError } = await supabase
      .from('license_plates')
      .update({ location_id: params.toLocationId })
      .eq('id', params.lpId);

    if (updateError) throw updateError;
  }

  // 9. Update QA status if quarantine
  if (params.moveType === 'quarantine') {
    await supabase
      .from('license_plates')
      .update({ qa_status: 'quarantine', status: 'blocked' })
      .eq('id', params.lpId);
  }

  return move as StockMove;
}

/**
 * List stock moves with filters and pagination
 */
export async function listStockMoves(filters: {
  page?: number;
  limit?: number;
  moveType?: string;
  lpId?: string;
  locationId?: string;
  dateFrom?: string;
  dateTo?: string;
  status?: string;
}) {
  const supabase = createClient();
  const page = filters.page ?? 1;
  const limit = Math.min(filters.limit ?? 50, 200);
  const offset = (page - 1) * limit;

  let query = supabase
    .from('stock_moves')
    .select(`
      *,
      license_plate:license_plates(lp_number, product_id),
      from_location:locations!stock_moves_from_location_id_fkey(location_code, name),
      to_location:locations!stock_moves_to_location_id_fkey(location_code, name),
      created_by_user:users(name, email)
    `, { count: 'exact' })
    .order('move_date', { ascending: false })
    .range(offset, offset + limit - 1);

  // Apply filters
  if (filters.moveType) query = query.eq('move_type', filters.moveType);
  if (filters.lpId) query = query.eq('lp_id', filters.lpId);
  if (filters.status) query = query.eq('status', filters.status);
  if (filters.dateFrom) query = query.gte('move_date', filters.dateFrom);
  if (filters.dateTo) query = query.lte('move_date', filters.dateTo);

  // Location filter (from OR to)
  if (filters.locationId) {
    query = query.or(`from_location_id.eq.${filters.locationId},to_location_id.eq.${filters.locationId}`);
  }

  const { data, count, error } = await query;
  if (error) throw error;

  return {
    data,
    pagination: {
      page,
      limit,
      total: count ?? 0,
      totalPages: Math.ceil((count ?? 0) / limit),
    },
  };
}

/**
 * Get stock move by ID
 */
export async function getStockMove(id: string): Promise<StockMove> {
  const supabase = createClient();

  const { data, error } = await supabase
    .from('stock_moves')
    .select(`
      *,
      license_plate:license_plates(lp_number, product:products(name, sku)),
      from_location:locations!stock_moves_from_location_id_fkey(location_code, name),
      to_location:locations!stock_moves_to_location_id_fkey(location_code, name),
      created_by_user:users(name, email),
      cancelled_by_user:users(name, email)
    `)
    .eq('id', id)
    .single();

  if (error) throw error;
  return data as StockMove;
}

/**
 * Cancel a stock move
 */
export async function cancelStockMove(id: string, reason: string): Promise<StockMove> {
  const supabase = createClient();

  const { data: { user } } = await supabase.auth.getUser();
  if (!user) throw new Error('Unauthorized');

  // Get existing move
  const { data: move } = await supabase
    .from('stock_moves')
    .select('*')
    .eq('id', id)
    .single();

  if (!move) throw new Error('Stock move not found');
  if (move.status === 'cancelled') throw new Error('Move already cancelled');

  // Check if move is recent (within 24 hours)
  const moveDate = new Date(move.move_date);
  const now = new Date();
  const hoursDiff = (now.getTime() - moveDate.getTime()) / (1000 * 60 * 60);

  if (hoursDiff > 24) {
    throw new Error('Cannot cancel moves older than 24 hours');
  }

  // Update to cancelled
  const { data, error } = await supabase
    .from('stock_moves')
    .update({
      status: 'cancelled',
      cancelled_at: new Date().toISOString(),
      cancelled_by: user.id,
      notes: reason,
    })
    .eq('id', id)
    .select()
    .single();

  if (error) throw error;

  // NOTE: Does NOT reverse LP changes - requires manual correction

  return data as StockMove;
}

/**
 * Get movement history for an LP
 */
export async function getLPMovementHistory(lpId: string) {
  const supabase = createClient();

  const { data, error } = await supabase
    .from('stock_moves')
    .select(`
      *,
      from_location:locations!stock_moves_from_location_id_fkey(location_code, name),
      to_location:locations!stock_moves_to_location_id_fkey(location_code, name),
      created_by_user:users(name, email)
    `)
    .eq('lp_id', lpId)
    .order('move_date', { ascending: false });

  if (error) throw error;
  return data;
}
```

### Validation (Zod)

**lib/validation/stock-move-schema.ts**

```typescript
import { z } from 'zod';

export const moveTypeEnum = z.enum([
  'transfer',
  'issue',
  'receipt',
  'adjustment',
  'return',
  'quarantine',
  'putaway',
]);

export const reasonCodeEnum = z.enum([
  'damage',
  'theft',
  'counting_error',
  'quality_issue',
  'expired',
  'other',
]);

export const createStockMoveSchema = z.object({
  lpId: z.string().uuid('Invalid LP ID'),
  moveType: moveTypeEnum,
  toLocationId: z.string().uuid('Invalid location ID').optional(),
  quantity: z.number().positive('Quantity must be positive').optional(),
  reason: z.string().max(500, 'Reason too long').optional(),
  reasonCode: reasonCodeEnum.optional(),
  woId: z.string().uuid('Invalid WO ID').optional(),
  referenceId: z.string().uuid().optional(),
  referenceType: z.string().optional(),
}).refine(
  (data) => {
    // Transfer types require destination
    if (['transfer', 'putaway', 'quarantine', 'return'].includes(data.moveType)) {
      return !!data.toLocationId;
    }
    return true;
  },
  {
    message: 'Destination location required for this move type',
    path: ['toLocationId'],
  }
).refine(
  (data) => {
    // Adjustments require reason code
    if (data.moveType === 'adjustment') {
      return !!data.reasonCode;
    }
    return true;
  },
  {
    message: 'Reason code required for adjustments',
    path: ['reasonCode'],
  }
);

export const cancelStockMoveSchema = z.object({
  reason: z.string().min(10, 'Cancellation reason must be at least 10 characters'),
});

export const listStockMovesSchema = z.object({
  page: z.coerce.number().int().positive().default(1),
  limit: z.coerce.number().int().positive().max(200).default(50),
  moveType: moveTypeEnum.optional(),
  lpId: z.string().uuid().optional(),
  locationId: z.string().uuid().optional(),
  dateFrom: z.string().datetime().optional(),
  dateTo: z.string().datetime().optional(),
  status: z.enum(['completed', 'cancelled']).optional(),
});

export type CreateStockMoveInput = z.infer<typeof createStockMoveSchema>;
export type CancelStockMoveInput = z.infer<typeof cancelStockMoveSchema>;
export type ListStockMovesInput = z.infer<typeof listStockMovesSchema>;
```

### Key Business Rules

1. **Move Types**:
   - **transfer**: LP moves from location A to location B (updates LP.location_id)
   - **issue**: LP leaves warehouse (from_location set, to_location NULL)
   - **receipt**: LP enters warehouse (from_location NULL, to_location set)
   - **adjustment**: Quantity adjustment, no location change (both NULL)
   - **return**: LP returned from production/shipping back to warehouse
   - **quarantine**: LP moved to quarantine location due to QA failure
   - **putaway**: Guided putaway from receiving to storage location

2. **LP Status Validation**:
   - Only LPs with status='available' can be moved
   - Consumed, blocked, or reserved LPs return validation error

3. **Partial Moves**:
   - If move_qty < LP.qty, triggers LP split (05.6)
   - Creates new LP with move_qty at destination
   - Reduces original LP by move_qty

4. **Location Updates**:
   - Transfer, putaway, quarantine, return → update LP.location_id
   - Receipt, issue, adjustment → no location update

5. **Move Number Format**:
   - Prefix: "SM" (Stock Move)
   - Year: 4-digit current year
   - Sequence: 5-digit zero-padded, resets annually
   - Example: SM-2025-00001

6. **Cancellation Policy**:
   - Only moves within 24 hours can be cancelled
   - Cancellation does NOT reverse LP changes
   - Manager must manually correct LP if needed
   - Reason required for audit trail

7. **Quarantine Moves**:
   - Automatically update LP.qa_status = 'quarantine'
   - Update LP.status = 'blocked'
   - Record reason for traceability

8. **Performance**:
   - Move creation <300ms (full LP), <500ms (partial)
   - List query <500ms for 10K moves
   - LP history <200ms for 500 moves
   - Use indexes on (lp_id), (move_date), (org_id, move_type)

## Deliverables

- **Migration**: `supabase/migrations/YYYYMMDD_create_stock_moves_table.sql`
- **API Routes**:
  - `app/api/warehouse/stock-moves/route.ts` (GET list, POST create)
  - `app/api/warehouse/stock-moves/[id]/route.ts` (GET detail)
  - `app/api/warehouse/stock-moves/[id]/cancel/route.ts` (POST cancel)
- **Services**:
  - `lib/services/stock-move-service.ts` (5+ functions)
- **Validation**:
  - `lib/validation/stock-move-schema.ts` (3 schemas)
- **Components**:
  - `app/(authenticated)/warehouse/movements/page.tsx` (list page)
  - `app/(authenticated)/warehouse/movements/[id]/page.tsx` (detail page)
  - `components/warehouse/MovementTable.tsx`
  - `components/warehouse/MovementFilters.tsx`
  - `components/warehouse/MovementHistoryCard.tsx`
  - `components/warehouse/CreateMoveModal.tsx`
  - `components/warehouse/CancelMoveModal.tsx`
- **Tests**:
  - `lib/services/__tests__/stock-move-service.test.ts` (unit tests, >80% coverage)
  - `tests/e2e/warehouse/stock-moves.spec.ts` (E2E smoke test)

## Definition of Done

- [x] `stock_moves` table created with all fields, indexes, constraints
- [x] RLS policy "Stock moves org isolation" created and tested
- [x] Move number generation service with year-based sequence
- [x] API endpoints: GET list, GET detail, POST create, POST cancel implemented
- [x] Service layer: createStockMove, listStockMoves, getStockMove, cancelStockMove, getLPMovementHistory
- [x] Zod validation schemas for all API operations
- [x] Desktop movements list page with filters (date, type, LP, location)
- [x] Movement detail page with full context
- [x] Movement history component for LP detail view (timeline)
- [x] Automatic LP.location_id update on transfer/putaway/quarantine/return moves
- [x] Integration with LP split for partial moves (05.6 dependency)
- [x] Unit tests for service layer (>80% coverage)
- [x] RLS policy tested for multi-tenant isolation
- [x] E2E smoke test: Create transfer move → verify LP location updated → view in movements list
- [x] Performance validation: List query <500ms, LP history <200ms
- [x] Manual QA: Create moves of all 7 types, verify LP updates, test cancellation

---

## Future Phases (Not in This Story)

### Phase 2+ Enhancements

**Scanner Move Workflows (05.18)**
- Mobile scanner UI for LP moves
- Scan LP → scan destination → confirm
- Audio feedback and validation
- Offline queue support

**Guided Putaway (05.19)**
- FIFO/FEFO location suggestions
- Zone-based putaway optimization
- Capacity-aware recommendations
- Override warnings

**Advanced Analytics**
- Movement frequency analysis
- Average move time by type
- Location utilization trends
- Operator productivity metrics

**Bulk Operations**
- Batch move multiple LPs
- Mass location transfers
- Template-based moves

**Movement Approval Workflow**
- Require manager approval for adjustments >10%
- Multi-level approval for sensitive moves
- Approval history audit trail

**Movement Reversal**
- Reverse moves within time window
- Automatic LP state restoration
- Reversal audit trail

**Integration with Cycle Counts (05.35)**
- Auto-create adjustment moves from count variances
- Link stock_moves to cycle_count records
- Variance analysis reporting

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-12-16 | Initial story - stock moves CRUD with 7 move types | ARCHITECT-AGENT |
