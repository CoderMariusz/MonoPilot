# 05.6 - LP Detail & History View

**Priority**: P0 (Phase 0 - CRITICAL)
**Story Points**: S (1-2 days)
**Type:** frontend + backend

**State:** ready
**Primary PRD:** `docs/1-BASELINE/product/modules/warehouse.md` (WH-FR-002)
**Architecture:** `docs/1-BASELINE/architecture/modules/warehouse.md`

---

## MVP Scope

LP Detail & History provides operators and production users with complete visibility into License Plate information and its movement/consumption history. This is CRITICAL for Epic 04 Production operators to view LP details before consumption decisions.

**Phase 0 MVP includes:**
- Enhanced LP detail page with complete information display
- Movement history timeline (placeholder for Phase 2, shows "Coming in Phase 2")
- Consumption/output event history from genealogy service
- Status change audit trail
- API endpoints for detail view with history
- Desktop UI with tabbed interface (Overview, Genealogy, History)
- Quick actions panel (Block, Print Label placeholder, View History)
- Empty state handling for new LPs without history
- Performance: Detail view loads in <500ms

**Phase 0 EXCLUDES:**
- Full stock moves integration (Story 05.11 - Phase 1)
- Print Label functionality (Story 05.14 - Phase 1)
- Scanner detail view (Story 05.22 - Phase 2)
- Export detail to PDF (Phase 3)
- Real-time updates via WebSocket (Phase 3)
- LP adjustment history (Story 05.32 - Phase 3)

---

## Epic 04 Dependency Status

- [x] **Visibility for Epic 04 (operators can see LP details)**
- [ ] NOT CRITICAL - Can defer

**What Epic 04 Production Needs from 05.6:**

| Epic 04 Story | Feature Required | Why |
|---------------|------------------|-----|
| 04.6a-e (Consumption) | View LP detail before consumption | Verify batch, expiry, qty before consuming |
| 04.6a-e (Consumption) | View consumption history | See if LP was partially consumed |
| 04.7a-d (Output) | View output LP detail | Confirm output was registered correctly |
| All Production Stories | Quick access to LP info | Modal/panel from LP picker |

**Critical Integration:** Production operators need to view LP details inline during consumption workflows. This story provides the detail panel component that can be embedded in consumption flows.

---

## Goal

Create a comprehensive LP detail view that displays all License Plate information, genealogy history, and consumption/output events, enabling operators and managers to make informed inventory and production decisions.

## User Story

As a **production operator**, I want **to view complete details of any License Plate including its history, genealogy, and current status** so that **I can verify batch information, expiry dates, and consumption history before using the material in production**.

## Scope

**In scope (this story)**
- Enhanced LP detail page with full field display
- Tabbed interface:
  - **Overview Tab**: All LP fields formatted and grouped
  - **Genealogy Tab**: Integration with Story 05.2 (ancestors/descendants)
  - **History Tab**: Placeholder message for Phase 2 stock moves
- Consumption/output events from `lp_genealogy` table
- Status change display (current status with badges)
- Quick actions panel:
  - Block LP
  - Print Label (disabled with tooltip "Coming in Phase 1")
  - View History (active)
- Empty state handling for LPs without history
- API endpoint: `GET /api/warehouse/license-plates/:id/detail`
- Desktop UI components (responsive cards, timeline)
- Loading skeletons for async data
- Error handling (404, 403)
- Performance optimization (<500ms load)

**Out of scope (this story)**
- Full stock moves history - Story 05.11 (Phase 1)
- Print Label implementation - Story 05.14 (Phase 1)
- Scanner detail view - Story 05.22 (Phase 2)
- LP adjustment history - Story 05.32 (Phase 3)
- Export to PDF - Phase 3
- Real-time status updates - Phase 3
- Inline editing of LP fields - Future

## Dependencies

- **05.1** - LP Table + Basic Service (`license_plates` table, service methods)
- **05.2** - LP Genealogy (genealogy history display)
- **01.8, 01.9** - Warehouses, Locations (for location display with full path)
- **02.1** - Products (for product details display)

---

## Acceptance Criteria (Given/When/Then)

### AC-1: LP Detail Page Loads

**Given** LP-001 exists with all fields populated
**When** user navigates to `/warehouse/license-plates/[id]`
**Then**
- Page loads within 500ms
- All LP fields displayed in formatted sections
- Product name, warehouse, and location resolved and displayed
- Status and QA status badges display with correct colors
- Page title shows LP number (e.g., "LP-00000001")
- Breadcrumb navigation: "Warehouse > License Plates > LP-00000001"

### AC-2: Overview Tab - Identity Section

**Given** LP detail page is open
**When** user views Overview tab
**Then** Identity section displays:
- LP Number (large, prominent)
- Status badge (available/reserved/consumed/blocked with color)
- QA Status badge (pending/passed/failed/quarantine with color)
- Source type (manual/receipt/production/return/adjustment/split)
- Created date (formatted: "Dec 16, 2025 10:30 AM")
- Updated date (formatted: "Dec 16, 2025 11:45 AM")

### AC-3: Overview Tab - Product Section

**Given** LP detail page is open
**When** user views Overview tab
**Then** Product section displays:
- Product name (with link to product detail)
- Product code
- Quantity with UoM (e.g., "100.00 KG")
- Catch weight (if applicable, e.g., "47.5 kg")
- Visual quantity indicator (progress bar for reserved qty vs total)

### AC-4: Overview Tab - Location Section

**Given** LP is located in "WH-001 > Zone A > Bin 5"
**When** user views Overview tab
**Then** Location section displays:
- Warehouse name and code (with link)
- Full location path: "Zone A > Bin 5"
- Location type badge (if configured)
- Location capacity indicator (if available)

### AC-5: Overview Tab - Tracking Section

**Given** LP has batch and expiry data
**When** user views Overview tab
**Then** Tracking section displays:
- Batch number
- Supplier batch number (if present)
- Expiry date with warning indicator:
  - Red if expired or expiring within 7 days
  - Yellow if expiring within 30 days
  - Green otherwise
- Manufacture date
- Days until expiry (calculated, e.g., "45 days remaining")

### AC-6: Overview Tab - References Section

**Given** LP was created from production (WO-001)
**When** user views Overview tab
**Then** References section displays:
- Source type: "Production"
- Work Order: "WO-001" (link to WO detail)
- PO Number (if source was receipt)
- GRN ID (if source was receipt, link to GRN)
- Parent LP ID (if split, link to parent)
- Consumed by WO ID (if consumed, link to WO)
- Pallet ID (if on pallet, link to pallet - Phase 3 placeholder)

### AC-7: Overview Tab - GS1 Section (Phase 3 Placeholder)

**Given** LP detail page is open
**When** user views Overview tab
**Then** GS1 section displays:
- GTIN field (empty with note "Phase 3: GS1 GTIN Support")
- SSCC field (empty with note "Phase 3: GS1 SSCC Support")
- Section greyed out to indicate future feature

### AC-8: Genealogy Tab - Integration with Story 05.2

**Given** LP has genealogy history (consumed LPs as ancestors)
**When** user clicks "Genealogy" tab
**Then**
- Genealogy panel from Story 05.2 displays
- Ancestors section shows consumed LPs that created this LP
- Descendants section shows LPs created from this LP
- Each genealogy node is clickable (navigates to that LP)
- Tree structure displays with proper depth levels
- Empty state if no genealogy: "No genealogy history for this LP"

### AC-9: History Tab - Phase 2 Placeholder

**Given** LP detail page is open
**When** user clicks "History" tab
**Then**
- Placeholder message displays: "Movement History Coming in Phase 2"
- Description: "Stock movement history will show all location changes, adjustments, and transfers for this License Plate."
- Icon/illustration for "under construction"
- Link: "Learn more about Phase 2 features"

### AC-10: Quick Actions Panel - Block LP

**Given** LP status is "available"
**When** user clicks "Block" in quick actions
**Then**
- Block confirmation modal opens
- User enters block reason (required, max 500 chars)
- On confirm: API `PUT /api/warehouse/license-plates/:id/block` called
- LP status updates to "blocked"
- Status badge changes to red "Blocked"
- Success toast: "LP blocked successfully"
- Modal closes automatically

### AC-11: Quick Actions Panel - Unblock LP

**Given** LP status is "blocked"
**When** user clicks "Unblock" in quick actions
**Then**
- Unblock confirmation modal opens
- Displays original block reason
- On confirm: API `PUT /api/warehouse/license-plates/:id/unblock` called
- LP status updates to "available"
- Status badge changes to green "Available"
- Success toast: "LP unblocked successfully"

### AC-12: Quick Actions Panel - Print Label (Disabled)

**Given** LP detail page is open
**When** user hovers over "Print Label" button
**Then**
- Button is disabled (greyed out)
- Tooltip displays: "Print Label functionality coming in Phase 1 (Story 05.14)"
- Cursor shows "not-allowed" icon
- Clicking does nothing

### AC-13: API Endpoint - Get LP Detail

**Given** valid LP ID
**When** `GET /api/warehouse/license-plates/:id/detail` is called
**Then**
- Returns LP with all fields
- Includes joined fields:
  - `product`: { id, name, code }
  - `warehouse`: { id, name, code }
  - `location`: { id, full_path }
  - `created_by_user`: { name } (if present)
- Response time <200ms
- Status: 200 OK

### AC-14: API Endpoint - LP Not Found

**Given** invalid LP ID
**When** `GET /api/warehouse/license-plates/:id/detail` is called
**Then**
- Returns 404 Not Found
- Error message: "License Plate not found"
- Frontend displays 404 page with "Go Back" button

### AC-15: API Endpoint - Cross-Tenant Protection

**Given** LP belongs to Org B, user belongs to Org A
**When** user requests LP detail via API
**Then**
- RLS policy blocks access
- Returns 404 Not Found (not 403 to prevent org enumeration)
- Frontend displays 404 page

### AC-16: Empty State - New LP Without History

**Given** LP was just created, no genealogy or history
**When** user views LP detail
**Then**
- Overview tab shows all fields (most empty)
- Genealogy tab shows: "No genealogy history for this LP"
- History tab shows: "Movement History Coming in Phase 2"
- No errors displayed
- UI remains functional

### AC-17: Loading State

**Given** LP detail is loading
**When** page first renders
**Then**
- Skeleton loaders display for:
  - Page title
  - Status badges
  - Each section card
  - Quick actions panel
  - Tabs
- No flash of unstyled content
- Skeleton matches final layout
- Transition to loaded state is smooth

### AC-18: Error State - API Failure

**Given** API call fails (500 error)
**When** fetching LP detail
**Then**
- Error boundary catches error
- Error message displays: "Failed to load License Plate details"
- Retry button available
- Support contact info shown
- Error logged to monitoring system

---

## Technical Specification

### API Endpoints

```typescript
GET /api/warehouse/license-plates/:id/detail

Response 200:
{
  id: string;
  org_id: string;
  lp_number: string;
  product_id: string;
  quantity: number;
  uom: string;
  location_id: string;
  warehouse_id: string;
  status: 'available' | 'reserved' | 'consumed' | 'blocked';
  qa_status: 'pending' | 'passed' | 'failed' | 'quarantine';
  batch_number: string | null;
  supplier_batch_number: string | null;
  expiry_date: string | null;
  manufacture_date: string | null;
  source: string;
  po_number: string | null;
  grn_id: string | null;
  wo_id: string | null;
  consumed_by_wo_id: string | null;
  parent_lp_id: string | null;
  catch_weight_kg: number | null;
  gtin: string | null;
  sscc: string | null;
  pallet_id: string | null;
  created_at: string;
  created_by: string | null;
  updated_at: string;

  // Joined fields
  product: {
    id: string;
    name: string;
    code: string;
  };
  warehouse: {
    id: string;
    name: string;
    code: string;
  };
  location: {
    id: string;
    full_path: string;
  };
  created_by_user?: {
    name: string;
  };
}

Response 404:
{
  error: "License Plate not found"
}

Response 500:
{
  error: "Internal server error"
}
```

### Service Layer

```typescript
// lib/services/license-plate-service.ts

/**
 * Get LP detail with all joined relationships
 * Optimized query with single DB call
 */
export async function getLPDetail(id: string): Promise<LPDetailView | null> {
  const { data, error } = await supabase
    .from('license_plates')
    .select(`
      *,
      product:products(id, name, code),
      warehouse:warehouses(id, name, code),
      location:locations(id, full_path),
      created_by_user:users!created_by(name)
    `)
    .eq('id', id)
    .single();

  if (error) {
    if (error.code === 'PGRST116') return null; // Not found
    throw error;
  }

  return data as LPDetailView;
}

export interface LPDetailView extends LicensePlate {
  product: {
    id: string;
    name: string;
    code: string;
  };
  warehouse: {
    id: string;
    name: string;
    code: string;
  };
  location: {
    id: string;
    full_path: string;
  };
  created_by_user?: {
    name: string;
  };
}
```

### Frontend Components

```
app/(authenticated)/warehouse/license-plates/[id]/
  page.tsx                                -- LP detail page (server component)
  loading.tsx                             -- Loading skeleton
  error.tsx                               -- Error boundary
  not-found.tsx                           -- 404 page

  components/
    LPDetailHeader.tsx                    -- Page header with LP number and actions
    LPDetailTabs.tsx                      -- Tab navigation (Overview, Genealogy, History)

    // Overview Tab Components
    LPOverviewTab.tsx                     -- Overview tab container
    LPIdentityCard.tsx                    -- Identity section card
    LPProductCard.tsx                     -- Product section card
    LPLocationCard.tsx                    -- Location section card
    LPTrackingCard.tsx                    -- Tracking section card
    LPReferencesCard.tsx                  -- References section card
    LPGS1Card.tsx                         -- GS1 section (placeholder)

    // Genealogy Tab (from 05.2)
    LPGenealogyTab.tsx                    -- Genealogy tab (uses Story 05.2 components)

    // History Tab
    LPHistoryTab.tsx                      -- History tab (placeholder)
    LPHistoryPlaceholder.tsx              -- "Coming in Phase 2" message

    // Shared
    LPQuickActions.tsx                    -- Quick actions panel
    LPBlockModal.tsx                      -- Block LP modal
    LPUnblockModal.tsx                    -- Unblock LP modal
    LPExpiryIndicator.tsx                 -- Expiry warning indicator
    LPQuantityProgress.tsx                -- Quantity visual indicator
    LPFieldLabel.tsx                      -- Consistent field label component
    LPEmptyState.tsx                      -- Empty state message
```

### Component Design

#### LPDetailHeader.tsx
```typescript
interface LPDetailHeaderProps {
  lpNumber: string;
  status: LPStatus;
  qaStatus: QAStatus;
  onBack: () => void;
}

// Displays:
// - Back button
// - LP Number (large)
// - Status badges
// - Quick actions (Block, Print, History)
```

#### LPOverviewTab.tsx
```typescript
interface LPOverviewTabProps {
  lp: LPDetailView;
}

// Layout: 2-column grid (3 columns on xl screens)
// Cards:
// - Identity (1 col)
// - Product (1 col)
// - Location (1 col)
// - Tracking (1 col)
// - References (1 col)
// - GS1 (1 col, greyed out)
```

#### LPQuickActions.tsx
```typescript
interface LPQuickActionsProps {
  lpId: string;
  status: LPStatus;
  onBlock: () => void;
  onUnblock: () => void;
}

// Actions:
// - Block/Unblock (conditional based on status)
// - Print Label (disabled, tooltip)
// - View History (opens History tab)
```

#### LPBlockModal.tsx
```typescript
interface LPBlockModalProps {
  lpId: string;
  lpNumber: string;
  isOpen: boolean;
  onClose: () => void;
  onSuccess: () => void;
}

// Form:
// - Reason textarea (required, max 500 chars)
// - Cancel button
// - Block button (primary, destructive)
```

### Badge Colors

| Status | Class | Text Color |
|--------|-------|------------|
| available | `bg-green-100 border-green-300` | `text-green-800` |
| reserved | `bg-yellow-100 border-yellow-300` | `text-yellow-800` |
| consumed | `bg-gray-100 border-gray-300` | `text-gray-500` |
| blocked | `bg-red-100 border-red-300` | `text-red-800` |

| QA Status | Class | Text Color |
|-----------|-------|------------|
| pending | `bg-yellow-100 border-yellow-300` | `text-yellow-800` |
| passed | `bg-green-100 border-green-300` | `text-green-800` |
| failed | `bg-red-100 border-red-300` | `text-red-800` |
| quarantine | `bg-orange-100 border-orange-300` | `text-orange-800` |

### Expiry Indicator Colors

| Condition | Badge | Days Remaining |
|-----------|-------|----------------|
| Expired | Red badge "EXPIRED" | < 0 |
| Critical | Red text with warning icon | 0-7 |
| Warning | Yellow text with warning icon | 8-30 |
| Normal | Green text | > 30 |
| No Expiry | Gray text "N/A" | null |

### Key Business Rules

1. **Status Display Logic:**
   - Status badge color matches current status
   - Quick actions adapt to status (Block vs Unblock)
   - Consumed LPs show consumed_by_wo_id link

2. **Expiry Calculation:**
   - Days remaining = expiry_date - current_date
   - Color-coded warnings (Red <7 days, Yellow <30 days)
   - "N/A" if no expiry_date

3. **Reference Links:**
   - All reference IDs are clickable links
   - WO links go to `/production/work-orders/[id]`
   - Product links go to `/technical/products/[id]`
   - Location links go to `/settings/locations/[id]`
   - Parent LP links stay within LP detail (circular navigation)

4. **Empty Field Handling:**
   - Null fields display as "—" (em dash)
   - Optional sections hide if all fields empty
   - Empty state messages for genealogy/history

5. **Block/Unblock Rules:**
   - Only available LPs can be blocked
   - Only blocked LPs can be unblocked
   - Block reason required (validation)
   - Consumed/reserved LPs cannot be blocked

6. **Performance Requirements:**
   - Initial load: <500ms
   - Tab switching: <100ms (client-side)
   - Block/unblock action: <300ms

---

## Deliverables

### API Routes
- [ ] `GET /api/warehouse/license-plates/:id/detail` - Enhanced detail endpoint

### Frontend Components (17 components)
- [ ] `page.tsx` - LP detail page
- [ ] `loading.tsx` - Skeleton loader
- [ ] `error.tsx` - Error boundary
- [ ] `not-found.tsx` - 404 page
- [ ] `LPDetailHeader.tsx`
- [ ] `LPDetailTabs.tsx`
- [ ] `LPOverviewTab.tsx`
- [ ] `LPIdentityCard.tsx`
- [ ] `LPProductCard.tsx`
- [ ] `LPLocationCard.tsx`
- [ ] `LPTrackingCard.tsx`
- [ ] `LPReferencesCard.tsx`
- [ ] `LPGS1Card.tsx` (placeholder)
- [ ] `LPGenealogyTab.tsx`
- [ ] `LPHistoryTab.tsx` (placeholder)
- [ ] `LPQuickActions.tsx`
- [ ] `LPBlockModal.tsx`
- [ ] `LPUnblockModal.tsx`
- [ ] `LPExpiryIndicator.tsx`
- [ ] `LPQuantityProgress.tsx`

### Service Layer
- [ ] `getLPDetail()` - Enhanced detail query with joins

### Tests
- [ ] Unit tests: `getLPDetail()` service method
- [ ] Integration tests: Detail API endpoint (200, 404, 403)
- [ ] E2E tests: LP detail page navigation and interactions
- [ ] E2E tests: Block/unblock flow
- [ ] E2E tests: Tab navigation
- [ ] Component tests: All UI components

---

## Definition of Done

### API
- [ ] Detail endpoint returns LP with all joined fields
- [ ] Response time <200ms for detail query
- [ ] 404 returned for non-existent LP
- [ ] RLS enforces cross-tenant isolation (returns 404)

### UI
- [ ] LP detail page displays all sections correctly
- [ ] Status and QA status badges show correct colors
- [ ] Expiry indicator shows warnings appropriately
- [ ] All reference links are clickable and navigate correctly
- [ ] Empty fields display as "—"
- [ ] Genealogy tab integrates with Story 05.2 component
- [ ] History tab shows placeholder message
- [ ] Quick actions panel displays correct actions based on status
- [ ] Block modal validates reason (required)
- [ ] Unblock modal shows original block reason
- [ ] Print Label button disabled with tooltip
- [ ] Loading skeleton displays during initial load
- [ ] Error state displays on API failure with retry button
- [ ] 404 page displays for non-existent LP

### Performance
- [ ] Initial page load <500ms
- [ ] Tab switching <100ms (client-side)
- [ ] Block/unblock action <300ms
- [ ] Smooth transitions (no layout shift)

### Testing
- [ ] Unit tests passing (>80% coverage)
- [ ] E2E tests: Navigate to detail page
- [ ] E2E tests: View all tabs
- [ ] E2E tests: Block and unblock LP
- [ ] E2E tests: Navigate via reference links
- [ ] E2E tests: Empty state handling
- [ ] E2E tests: Error state handling

### Documentation
- [ ] Component props documented with JSDoc
- [ ] API endpoint documented
- [ ] Empty state messages are clear and helpful
- [ ] Tooltip messages for disabled features are informative

---

## Future Phases (Not in This Story)

### Story 05.11 - Stock Moves (Phase 1)
- Full movement history timeline
- Location change audit trail
- Adjustment history
- Transfer history

### Story 05.14 - Label Printing (Phase 1)
- Enable "Print Label" button
- ZPL template rendering
- Print to Zebra printers
- Label preview

### Story 05.22 - Scanner Detail View (Phase 2)
- Mobile-optimized LP detail view
- Scanner-friendly layout
- Quick actions for scanner workflows
- Barcode scan integration

### Story 05.32 - Stock Adjustments (Phase 3)
- Adjustment history in History tab
- Quantity adjustment audit trail
- Adjustment reason tracking

### Phase 3+
- Export LP detail to PDF
- Real-time status updates (WebSocket)
- Inline editing of LP fields (modal)
- LP comparison view (side-by-side)
- LP activity feed (all events)

---

## Risk Assessment

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Performance with large genealogy trees | MEDIUM | MEDIUM | Lazy load genealogy tab, paginate results |
| Slow API response time | MEDIUM | LOW | Optimize query with proper joins and indexes |
| Complex component hierarchy | LOW | MEDIUM | Use composition pattern, keep components small |
| Missing reference data (deleted products) | LOW | MEDIUM | Graceful fallback to IDs if names missing |
| User confusion about Phase 2 placeholders | LOW | LOW | Clear messaging with "Coming in Phase 2" |

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-12-16 | Initial story creation for LP detail and history view | Claude Sonnet 4.5 |
