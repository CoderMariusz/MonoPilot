# 05.14 - LP Label Printing (ZPL)

| Field | Value |
|-------|-------|
| **Story ID** | 05.14 |
| **Epic** | 05 - Warehouse |
| **Status** | Ready |
| **Phase** | Phase 1 (Goods Receipt) |
| **Priority** | P1 |
| **Complexity** | M (Medium) |
| **Estimate** | 2-3 days |
| **Type** | Backend + Frontend |
| **Model** | SONNET |

---

## PRD References

| FR ID | Requirement | Priority | Coverage |
|-------|-------------|----------|----------|
| WH-FR-014 | Label Print (ZPL labels for LP/pallet) | P1 | Full (LP only) |
| WH-FR-001 | LP CRUD operations | P0 | Print action |

**Primary PRD:** `docs/1-BASELINE/product/modules/warehouse.md`
**Architecture:** `docs/1-BASELINE/architecture/modules/warehouse.md`

---

## MVP Scope

### In Scope (This Story)

1. **ZPL Template Generation for LP Labels**
   - 4x6 inch label format
   - CODE128 barcode for LP number
   - QR code with JSON data
   - Product name, quantity, UoM, batch, expiry, location
   - Template service for variable substitution

2. **API Endpoint: POST /api/warehouse/lps/:id/print-label**
   - Retrieve LP details with product, location info
   - Generate ZPL from template
   - Support `copies` query parameter (default from settings)
   - Return ZPL string for client-side printing
   - Audit log for print requests

3. **Warehouse Settings for Label Printing**
   - `print_label_on_receipt` (BOOLEAN) - Auto-print on GRN completion
   - `label_copies_default` (INTEGER) - Default number of copies
   - `label_size` (TEXT) - Label dimensions (4x6, 4x3)
   - `printer_ip` (TEXT) - Zebra printer IP/hostname (optional)
   - `printer_port` (INTEGER) - Default 9100 for ZPL over TCP

4. **Desktop UI Components**
   - Print button on LP detail page
   - Print button on LP list (bulk actions)
   - Label preview modal (ZPL rendered as preview)
   - Copies input (override default)
   - Success confirmation with download option

5. **Service Layer**
   - `LabelPrintService.generateLPLabel()` - ZPL generation
   - `LabelPrintService.printToZebraPrinter()` - TCP socket printing (Phase 2)
   - Template substitution logic
   - Settings integration

6. **Zod Validation Schema**
   - Print label request schema
   - Label settings schema

### Out of Scope (Other Stories)

| Feature | Deferred To | Reason |
|---------|-------------|--------|
| Pallet Labels (SSCC-18) | 05.14b | Phase 3 - Pallet management |
| GRN Document Printing | 05.15 | Different template, Phase 2 |
| Direct TCP Socket Printing | 05.14b | Phase 2 - Network printer integration |
| Label Designer UI | Phase 3 | Custom template editing |
| Multiple Label Templates | Phase 3 | Template management system |
| Batch Print Jobs | Phase 2 | Queue management |
| Print History/Audit Report | Phase 3 | Reporting feature |

---

## Epic 04 Dependency Status

- [ ] NOT CRITICAL - Does not unblock Epic 04 Phase 1
- [x] Phase 1 Story - Supporting feature for warehouse operations

This story provides label printing capability but Epic 04 (Production) does not depend on label printing for core operations. Labels are printed for output LPs but printing can be deferred.

---

## Goal

Enable warehouse operators and production staff to print physical labels for License Plates using ZPL templates compatible with Zebra printers, with configurable settings for auto-printing and label copies.

---

## User Story

As a **Warehouse Operator**, I want to **print labels for License Plates with barcodes and product information** so that **physical inventory can be tracked and scanned throughout the warehouse and production floor**.

---

## Dependencies

| Dependency | Story/Epic | Type | Status | Notes |
|------------|------------|------|--------|-------|
| 05.1 | LP Table + CRUD | HARD | Ready | Retrieves LP data for label |
| 05.0 | Warehouse Settings | HARD | Ready | Label print settings |
| 01.9 | Locations CRUD | SOFT | Ready | Location name on label |
| 02.1 | Products CRUD | HARD | Ready | Product name on label |

**Dependents (What This Unblocks):**
- 05.17 (Scanner Receive) - Auto-print on receipt
- Phase 2 workflows - Label printing integration

---

## Acceptance Criteria (Given/When/Then)

### AC-1: ZPL Template Generation for LP Labels (WH-FR-014)

```gherkin
Scenario: Generate ZPL label with all required fields
  Given LP 'LP00000001' exists with:
    | Field | Value |
    | product_id | {product_uuid} |
    | product_name | Flour Type 00 |
    | quantity | 1000 |
    | uom | KG |
    | batch_number | FLOUR-2025-001 |
    | expiry_date | 2026-06-01 |
    | location_id | {location_uuid} |
    | location_name | WH-001/ZONE-A/RACK-01 |
  When POST /api/warehouse/lps/{lp_id}/print-label
  Then response status = 200 OK
  And response contains:
    | Field | Value |
    | zpl | (Valid ZPL string) |
    | lp_number | LP00000001 |
    | product_name | Flour Type 00 |
  And ZPL includes CODE128 barcode with 'LP00000001'
  And ZPL includes QR code with JSON: {"lp": "LP00000001", "product": "Flour Type 00", ...}
  And ZPL includes text fields:
    - Product: Flour Type 00
    - Qty: 1000 KG
    - Batch: FLOUR-2025-001
    - Expiry: 2026-06-01
    - Location: WH-001/ZONE-A/RACK-01

Scenario: ZPL template format for 4x6 inch label
  When ZPL generated
  Then ZPL starts with ^XA
  And ZPL ends with ^XZ
  And barcode positioned at ^FO50,50
  And barcode height = 100 dots
  And text fields positioned for readability
  And total ZPL length < 2KB
```

### AC-2: Print Label API Endpoint

```gherkin
Scenario: Print single LP label with default copies
  Given warehouse_settings.label_copies_default = 1
  When POST /api/warehouse/lps/{lp_id}/print-label
  Then ZPL generated for 1 copy
  And response time < 500ms
  And audit log records: action='label_printed', lp_id={uuid}, user_id={user}

Scenario: Print LP label with custom copies
  Given warehouse_settings.label_copies_default = 1
  When POST /api/warehouse/lps/{lp_id}/print-label?copies=3
  Then ZPL generated for 3 copies
  And response includes copies=3

Scenario: Print label for non-existent LP
  When POST /api/warehouse/lps/{invalid_uuid}/print-label
  Then response status = 404 Not Found
  And error message = "License Plate not found"

Scenario: Print label for LP in different org
  Given User A from Org A
  And LP belongs to Org B
  When User A requests POST /api/warehouse/lps/{orgB_lp_id}/print-label
  Then response status = 404 Not Found (RLS enforced)
```

### AC-3: Label with Missing Optional Fields

```gherkin
Scenario: LP without batch number
  Given LP exists with batch_number = NULL
  When print label requested
  Then ZPL generated successfully
  And batch field shows "--" or "N/A"

Scenario: LP without expiry date
  Given LP exists with expiry_date = NULL
  When print label requested
  Then ZPL generated successfully
  And expiry field shows "--" or "N/A"

Scenario: LP with long product name
  Given LP exists with product_name = "Premium Organic Wholemeal Bread Flour Type 00 Stone Ground"
  When print label requested
  Then ZPL truncates product name to fit label (max 40 characters)
  And full name available in QR code JSON
```

### AC-4: Warehouse Settings Integration

```gherkin
Scenario: Label settings exist in warehouse_settings
  When warehouse_settings table inspected
  Then columns exist:
    | Column | Type | Default |
    | print_label_on_receipt | BOOLEAN | true |
    | label_copies_default | INTEGER | 1 |
    | label_size | TEXT | '4x6' |
    | printer_ip | TEXT | NULL |
    | printer_port | INTEGER | 9100 |

Scenario: Get label settings via API
  When GET /api/settings/warehouse
  Then response includes label settings:
    - print_label_on_receipt
    - label_copies_default
    - label_size

Scenario: Update label settings
  When PUT /api/settings/warehouse with:
    {
      "print_label_on_receipt": false,
      "label_copies_default": 2
    }
  Then settings updated successfully
  And new values used for subsequent print requests
```

### AC-5: Desktop UI - Print Button on LP Detail Page

```gherkin
Scenario: LP detail page displays print button
  Given user viewing LP detail page for 'LP00000001'
  When page loads
  Then "Print Label" button visible in header actions
  And button has printer icon

Scenario: Click print button opens print modal
  Given user on LP detail page
  When user clicks "Print Label"
  Then print modal opens
  And modal displays:
    | Field | Content |
    | Title | Print Label for LP00000001 |
    | LP Info | Product, Qty, Batch, Expiry preview |
    | Copies Input | Number input, default from settings |
    | Preview | Visual representation of label layout |
    | Actions | Download ZPL, Print (if printer configured) |

Scenario: Download ZPL from modal
  Given print modal open
  When user clicks "Download ZPL"
  Then ZPL file downloaded as 'LP00000001.zpl'
  And file contains valid ZPL content
  And modal remains open

Scenario: Print label from modal (no printer configured)
  Given warehouse_settings.printer_ip = NULL
  And print modal open
  When user clicks "Print"
  Then info message displays "No printer configured. Download ZPL and send to printer manually."
  And download ZPL option highlighted
```

### AC-6: Desktop UI - Bulk Print from LP List

```gherkin
Scenario: Select multiple LPs for printing
  Given user on LP list page
  When user selects 3 LPs via checkboxes
  Then "Print Labels" button appears in bulk actions
  And button shows count "(3)"

Scenario: Bulk print LPs
  Given 3 LPs selected
  When user clicks "Print Labels"
  Then bulk print modal opens
  And modal shows list of selected LPs
  And copies input available (applies to all)
  And "Download All ZPL" button available

Scenario: Download bulk ZPL
  Given 3 LPs selected in bulk print modal
  When user clicks "Download All ZPL"
  Then ZIP file downloaded with 3 .zpl files
  And each file named by LP number (LP00000001.zpl, LP00000002.zpl, ...)
```

### AC-7: Label Preview Modal

```gherkin
Scenario: Preview label before printing
  Given print modal open
  When preview section displayed
  Then visual representation shows:
    - Barcode placeholder (rectangle with LP number below)
    - Product name text
    - Qty: X UoM
    - Batch: XXX
    - Expiry: YYYY-MM-DD
    - Location: Path
    - QR code placeholder
  And layout matches actual label dimensions

Scenario: Preview updates with copies input
  Given print modal open
  When user changes copies from 1 to 3
  Then preview shows "3 copies will be printed"
  And download button text updates to "Download ZPL (3 copies)"
```

### AC-8: ZPL Service Methods

```gherkin
Scenario: LabelPrintService.generateLPLabel() generates valid ZPL
  Given LP data object with all fields
  When LabelPrintService.generateLPLabel(lpData, options) called
  Then ZPL string returned
  And ZPL starts with ^XA and ends with ^XZ
  And ZPL includes barcode, text fields, QR code
  And ZPL validated for syntax errors

Scenario: Template substitution handles special characters
  Given product name includes "&" and quote characters
  When ZPL generated
  Then special characters escaped properly
  And ZPL remains valid

Scenario: Multiple copies in ZPL
  Given copies = 3
  When ZPL generated
  Then ZPL includes ^PQ3 command (print quantity)
  And only one label template defined
```

### AC-9: QR Code Data Structure

```gherkin
Scenario: QR code contains LP metadata
  Given LP with all fields populated
  When ZPL generated
  Then QR code data is JSON string:
    {
      "lp": "LP00000001",
      "product_id": "{uuid}",
      "product": "Flour Type 00",
      "qty": 1000,
      "uom": "KG",
      "batch": "FLOUR-2025-001",
      "expiry": "2026-06-01",
      "location": "WH-001/ZONE-A/RACK-01"
    }
  And QR code uses error correction level M (15%)
  And QR code size = 4 (appropriate for 4x6 label)
```

### AC-10: Auto-Print on Receipt (Integration Point)

```gherkin
Scenario: Auto-print setting controls GRN behavior
  Given warehouse_settings.print_label_on_receipt = true
  When GRN completed with 3 LPs created
  Then system queues 3 label print jobs
  And each LP gets label_copies_default copies
  And audit log records auto-print for each LP

Scenario: Auto-print disabled
  Given warehouse_settings.print_label_on_receipt = false
  When GRN completed
  Then no print jobs queued
  And user must manually print from LP list/detail

Note: Full GRN integration tested in 05.11 (GRN from PO) story
```

### AC-11: Validation

```gherkin
Scenario: Validate copies parameter
  When POST /api/warehouse/lps/{id}/print-label?copies=0
  Then response status = 400 Bad Request
  And error message = "Copies must be between 1 and 100"

Scenario: Validate copies parameter max
  When POST /api/warehouse/lps/{id}/print-label?copies=150
  Then response status = 400 Bad Request
  And error message = "Copies must be between 1 and 100"

Scenario: Validate label size setting
  When updating warehouse_settings.label_size = 'invalid'
  Then validation error "Label size must be one of: 4x6, 4x3, 3x2"
```

### AC-12: RLS Policy Enforcement

```gherkin
Scenario: Print label enforces org isolation
  Given User A from Org A
  And LP from Org B
  When User A attempts to print LP from Org B
  Then 404 Not Found returned (LP not visible via RLS)

Scenario: Audit log includes org_id
  When label printed
  Then audit log record includes:
    - org_id (from authenticated user)
    - lp_id
    - user_id
    - copies
    - timestamp
```

### AC-13: Performance Requirements

```gherkin
Scenario: ZPL generation performance
  When generating ZPL for single LP
  Then operation completes in < 100ms

Scenario: Bulk ZPL generation performance
  Given 50 LPs selected for bulk print
  When generating all ZPL files
  Then operation completes in < 3 seconds

Scenario: API response time
  When POST /api/warehouse/lps/{id}/print-label
  Then response time < 500ms
```

### AC-14: Error Handling

```gherkin
Scenario: Handle missing product data
  Given LP exists but product has been soft-deleted
  When print label requested
  Then response status = 200 OK
  And label shows product_id instead of name
  And warning logged

Scenario: Handle missing location data
  Given LP exists with location_id = NULL
  When print label requested
  Then label shows location = "Unassigned"
  And ZPL generated successfully

Scenario: Handle ZPL generation error
  Given LP data valid
  But template processing fails
  When print label requested
  Then response status = 500 Internal Server Error
  And error message = "Failed to generate label"
  And error logged with stack trace
```

---

## Technical Specification

### Database Schema Updates

```sql
-- Warehouse settings already include label printing fields
-- Verify columns exist in warehouse_settings table:
ALTER TABLE warehouse_settings
ADD COLUMN IF NOT EXISTS print_label_on_receipt BOOLEAN DEFAULT true,
ADD COLUMN IF NOT EXISTS label_copies_default INTEGER DEFAULT 1,
ADD COLUMN IF NOT EXISTS label_size TEXT DEFAULT '4x6'
  CHECK (label_size IN ('4x6', '4x3', '3x2')),
ADD COLUMN IF NOT EXISTS printer_ip TEXT,
ADD COLUMN IF NOT EXISTS printer_port INTEGER DEFAULT 9100;

-- Audit log for label prints (optional - can use existing audit_logs table)
CREATE TABLE IF NOT EXISTS label_print_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  lp_id UUID REFERENCES license_plates(id) ON DELETE SET NULL,
  pallet_id UUID REFERENCES pallets(id) ON DELETE SET NULL,
  label_type TEXT NOT NULL CHECK (label_type IN ('lp', 'pallet', 'grn')),
  copies INTEGER NOT NULL DEFAULT 1,
  printed_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  printed_by UUID REFERENCES users(id),
  auto_print BOOLEAN DEFAULT false,
  printer_ip TEXT,
  print_method TEXT DEFAULT 'download' CHECK (print_method IN ('download', 'tcp', 'queue'))
);

CREATE INDEX idx_label_print_logs_org ON label_print_logs(org_id);
CREATE INDEX idx_label_print_logs_lp ON label_print_logs(lp_id) WHERE lp_id IS NOT NULL;
CREATE INDEX idx_label_print_logs_date ON label_print_logs(printed_at);

ALTER TABLE label_print_logs ENABLE ROW LEVEL SECURITY;

CREATE POLICY "label_print_logs_org" ON label_print_logs
FOR ALL TO authenticated
USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));
```

### API Endpoints

```
# Label Printing Endpoints
POST   /api/warehouse/lps/:id/print-label              - Generate ZPL for LP label
POST   /api/warehouse/lps/print-bulk                   - Generate ZPL for multiple LPs
GET    /api/warehouse/print-logs                       - Get print history (Phase 3)

# Settings Integration
GET    /api/settings/warehouse                         - Includes label settings
PUT    /api/settings/warehouse                         - Update label settings
```

**POST /api/warehouse/lps/:id/print-label Query Parameters:**

```typescript
interface PrintLabelQueryParams {
  copies?: number;        // 1-100, default from settings
  format?: 'zpl' | 'pdf'; // Default 'zpl' (PDF in Phase 3)
}
```

**POST /api/warehouse/lps/:id/print-label Response:**

```typescript
interface PrintLabelResponse {
  zpl: string;              // ZPL content
  lp_number: string;
  product_name: string;
  copies: number;
  label_size: string;       // '4x6'
  generated_at: string;     // ISO timestamp
  download_filename: string; // 'LP00000001.zpl'
}
```

**POST /api/warehouse/lps/print-bulk Request Body:**

```typescript
interface PrintBulkLabelsRequest {
  lp_ids: string[];         // Array of LP UUIDs (max 100)
  copies?: number;          // Applies to all
  format?: 'zip' | 'concat'; // 'zip' = ZIP file, 'concat' = single ZPL with all labels
}
```

**POST /api/warehouse/lps/print-bulk Response:**

```typescript
interface PrintBulkLabelsResponse {
  format: 'zip' | 'concat';
  total_labels: number;
  total_copies: number;
  file_size_bytes: number;
  download_url?: string;    // Presigned URL for large files
  zpl?: string;             // If format='concat' and small
}
```

### Service Layer

```typescript
// lib/services/label-print-service.ts

export interface LPLabelData {
  lp_number: string;
  product_name: string;
  quantity: number;
  uom: string;
  batch_number?: string | null;
  expiry_date?: string | null;
  manufacture_date?: string | null;
  location_path?: string | null;
  qr_data?: string;           // JSON string for QR code
}

export interface LabelGenerationOptions {
  copies?: number;            // Default 1
  label_size?: '4x6' | '4x3' | '3x2'; // Default '4x6'
  include_qr?: boolean;       // Default true
}

export class LabelPrintService {
  /**
   * Generate ZPL label for License Plate
   * @param lpId - LP UUID
   * @param options - Generation options
   * @returns ZPL string
   */
  static async generateLPLabel(
    lpId: string,
    options?: LabelGenerationOptions
  ): Promise<string>;

  /**
   * Generate ZPL for multiple LPs
   * @param lpIds - Array of LP UUIDs
   * @param options - Generation options
   * @returns Array of ZPL strings or concatenated ZPL
   */
  static async generateBulkLabels(
    lpIds: string[],
    options?: LabelGenerationOptions
  ): Promise<string[] | string>;

  /**
   * Get LP data for label generation
   * @param lpId - LP UUID
   * @returns LP label data with product and location info
   */
  static async getLPLabelData(lpId: string): Promise<LPLabelData>;

  /**
   * Build ZPL from template and data
   * @param data - LP label data
   * @param options - Generation options
   * @returns ZPL string
   */
  static buildZPL(data: LPLabelData, options: LabelGenerationOptions): string;

  /**
   * Generate QR code data JSON
   * @param data - LP label data
   * @returns JSON string for QR code
   */
  static generateQRData(data: LPLabelData): string;

  /**
   * Escape special characters for ZPL
   * @param text - Raw text
   * @returns ZPL-safe text
   */
  static escapeZPL(text: string): string;

  /**
   * Log label print request
   * @param lpId - LP UUID
   * @param copies - Number of copies
   * @param autoPrint - Was this auto-triggered?
   */
  static async logPrint(
    lpId: string,
    copies: number,
    autoPrint: boolean
  ): Promise<void>;

  /**
   * Send ZPL to Zebra printer via TCP (Phase 2)
   * @param zpl - ZPL content
   * @param printerIp - Printer IP address
   * @param port - Printer port (default 9100)
   */
  static async printToZebraPrinter(
    zpl: string,
    printerIp: string,
    port?: number
  ): Promise<void>;
}
```

### ZPL Template

```typescript
// lib/templates/lp-label-template.ts

export const LP_LABEL_TEMPLATE_4x6 = `
^XA
^CF0,30
^FO50,30^FDLicense Plate^FS

~TA000
~JSN
^LT0
^MNW
^MTT
^PON
^PMN
^LH0,0
^JMA
^PR6,6
~SD15
^JUS
^LRN
^CI27
^PA0,1,1,0

^XZ

^XA
^MMT
^PW812
^LL406
^LS0

^FT50,50^BCN,100,Y,N,N
^FD{{LP_NUMBER}}^FS

^FT400,50^BQN,2,4
^FDQA,{{QR_DATA}}^FS

^FT50,180^A0N,28,28^FDProduct:^FS
^FT150,180^A0N,28,28^FD{{PRODUCT_NAME}}^FS

^FT50,220^A0N,28,28^FDQuantity:^FS
^FT150,220^A0N,28,28^FD{{QUANTITY}} {{UOM}}^FS

^FT50,260^A0N,28,28^FDBatch:^FS
^FT150,260^A0N,28,28^FD{{BATCH_NUMBER}}^FS

^FT50,300^A0N,28,28^FDExpiry:^FS
^FT150,300^A0N,28,28^FD{{EXPIRY_DATE}}^FS

^FT50,340^A0N,28,28^FDLocation:^FS
^FT150,340^A0N,24,24^FD{{LOCATION}}^FS

^PQ{{COPIES}},0,1,Y

^XZ
`;

export function buildLPLabelZPL(data: LPLabelData, copies: number = 1): string {
  let zpl = LP_LABEL_TEMPLATE_4x6;

  // Substitute variables
  zpl = zpl.replace('{{LP_NUMBER}}', data.lp_number);
  zpl = zpl.replace('{{PRODUCT_NAME}}', truncateText(data.product_name, 40));
  zpl = zpl.replace('{{QUANTITY}}', String(data.quantity));
  zpl = zpl.replace('{{UOM}}', data.uom);
  zpl = zpl.replace('{{BATCH_NUMBER}}', data.batch_number || '--');
  zpl = zpl.replace('{{EXPIRY_DATE}}', formatDate(data.expiry_date) || '--');
  zpl = zpl.replace('{{LOCATION}}', truncateText(data.location_path || 'Unassigned', 35));
  zpl = zpl.replace('{{QR_DATA}}', escapeZPL(data.qr_data || '{}'));
  zpl = zpl.replace('{{COPIES}}', String(copies));

  return zpl;
}

function truncateText(text: string, maxLength: number): string {
  if (text.length <= maxLength) return text;
  return text.substring(0, maxLength - 3) + '...';
}

function formatDate(dateStr: string | null): string | null {
  if (!dateStr) return null;
  // Format as YYYY-MM-DD or locale format
  return dateStr;
}

function escapeZPL(text: string): string {
  // Escape special ZPL characters
  return text
    .replace(/\\/g, '\\\\')
    .replace(/\^/g, '\\^')
    .replace(/~/g, '\\~');
}
```

### Validation Schema (Zod)

```typescript
// lib/validation/label-print.ts
import { z } from 'zod';

export const printLabelQuerySchema = z.object({
  copies: z.coerce.number()
    .int("Copies must be an integer")
    .min(1, "Copies must be at least 1")
    .max(100, "Copies must be at most 100")
    .default(1),
  format: z.enum(['zpl', 'pdf'])
    .default('zpl'),
});

export const printBulkLabelsSchema = z.object({
  lp_ids: z.array(z.string().uuid("Invalid LP ID"))
    .min(1, "At least one LP required")
    .max(100, "Maximum 100 LPs per bulk request"),
  copies: z.number()
    .int()
    .min(1)
    .max(100)
    .optional(),
  format: z.enum(['zip', 'concat'])
    .default('zip'),
});

export const labelSettingsSchema = z.object({
  print_label_on_receipt: z.boolean().default(true),
  label_copies_default: z.number().int().min(1).max(10).default(1),
  label_size: z.enum(['4x6', '4x3', '3x2']).default('4x6'),
  printer_ip: z.string().ip().nullable().optional(),
  printer_port: z.number().int().min(1).max(65535).default(9100),
});

export type PrintLabelQueryParams = z.infer<typeof printLabelQuerySchema>;
export type PrintBulkLabelsInput = z.infer<typeof printBulkLabelsSchema>;
export type LabelSettings = z.infer<typeof labelSettingsSchema>;
```

---

## UI Components

```
app/(authenticated)/warehouse/
  lps/
    [id]/
      page.tsx                           -- LP detail page (add print button)

components/warehouse/labels/
  PrintLabelButton.tsx                   -- Print button component
  PrintLabelModal.tsx                    -- Print modal with preview
  LabelPreview.tsx                       -- Visual label preview
  BulkPrintModal.tsx                     -- Bulk print modal
  CopiesInput.tsx                        -- Copies number input with +/- buttons
  DownloadZPLButton.tsx                  -- Download ZPL file button

components/settings/
  LabelPrintSettings.tsx                 -- Label print settings form
```

### Component Specifications

**PrintLabelButton.tsx**
```tsx
interface PrintLabelButtonProps {
  lpId: string;
  lpNumber: string;
  variant?: 'default' | 'icon';
  onPrintComplete?: () => void;
}

// Renders button, opens modal on click
```

**PrintLabelModal.tsx**
```tsx
interface PrintLabelModalProps {
  lpId: string;
  lpNumber: string;
  isOpen: boolean;
  onClose: () => void;
}

// Modal structure:
// - Header with LP number
// - LP info summary (product, qty, batch, expiry)
// - Copies input
// - Label preview
// - Actions: Download ZPL, Print (if configured), Cancel
```

**LabelPreview.tsx**
```tsx
interface LabelPreviewProps {
  lpData: LPLabelData;
}

// Visual representation of label:
// - Rectangle with 4:6 aspect ratio
// - Barcode placeholder
// - Text fields in correct positions
// - QR code placeholder
// - Not actual ZPL rendering (would need ZPL parser library)
```

**BulkPrintModal.tsx**
```tsx
interface BulkPrintModalProps {
  lpIds: string[];
  isOpen: boolean;
  onClose: () => void;
}

// Modal structure:
// - Header "Print Labels for X LPs"
// - List of selected LPs (scrollable)
// - Copies input (applies to all)
// - Format selector: ZIP or Concatenated
// - Actions: Download All, Cancel
```

---

## Key Business Rules

1. **Label Copies Range**: 1-100 copies per request (prevent abuse)
2. **Bulk Print Limit**: Maximum 100 LPs per bulk request
3. **Label Size**: Supports 4x6, 4x3, 3x2 inch labels (4x6 default)
4. **Auto-Print on Receipt**: Configurable via `print_label_on_receipt` setting
5. **QR Code Data**: Always includes LP metadata in JSON format
6. **Missing Data Handling**: Display "--" or "N/A" for null batch/expiry
7. **Product Name Truncation**: Max 40 characters on label (full name in QR)
8. **Location Path**: Full hierarchical path (e.g., WH-001/ZONE-A/RACK-01)
9. **ZPL Compatibility**: Generated ZPL compatible with Zebra ZPL II printers
10. **Audit Trail**: All print requests logged with timestamp and user

---

## Deliverables

### Database
- [ ] Update `warehouse_settings` with label print columns (if not exist)
- [ ] Create `label_print_logs` table for audit
- [ ] RLS policies for label_print_logs

### API Routes
- [ ] `POST /api/warehouse/lps/:id/print-label` - Generate LP label ZPL
- [ ] `POST /api/warehouse/lps/print-bulk` - Bulk label generation
- [ ] Update `GET /api/settings/warehouse` to include label settings
- [ ] Update `PUT /api/settings/warehouse` to update label settings

### Service Layer
- [ ] `LabelPrintService.generateLPLabel()` - Main generation method
- [ ] `LabelPrintService.generateBulkLabels()` - Bulk generation
- [ ] `LabelPrintService.getLPLabelData()` - Fetch LP data with joins
- [ ] `LabelPrintService.buildZPL()` - Template substitution
- [ ] `LabelPrintService.generateQRData()` - QR JSON generation
- [ ] `LabelPrintService.escapeZPL()` - Text escaping
- [ ] `LabelPrintService.logPrint()` - Audit logging

### Templates
- [ ] `LP_LABEL_TEMPLATE_4x6` - 4x6 inch ZPL template
- [ ] Template substitution logic
- [ ] Text truncation and formatting helpers

### Validation
- [ ] `printLabelQuerySchema` - Query params validation
- [ ] `printBulkLabelsSchema` - Bulk request validation
- [ ] `labelSettingsSchema` - Settings validation

### Frontend
- [ ] Print button on LP detail page
- [ ] Print button on LP list (bulk actions)
- [ ] Print label modal with preview
- [ ] Bulk print modal
- [ ] Label preview component
- [ ] Copies input component
- [ ] Download ZPL button
- [ ] Label settings form in warehouse settings

### Tests
- [ ] Unit tests: LabelPrintService methods (>80% coverage)
- [ ] Integration tests: Print API endpoints
- [ ] ZPL validation tests (syntax, structure)
- [ ] Template substitution tests (special characters, truncation)
- [ ] RLS tests: Multi-tenancy isolation
- [ ] E2E: Print label flow from LP detail

---

## Test Cases

### Unit Tests

**File:** `__tests__/unit/services/label-print-service.test.ts`

| Test Case | Description |
|-----------|-------------|
| `generateLPLabel()` returns valid ZPL | ZPL starts with ^XA, ends with ^XZ |
| `generateLPLabel()` substitutes all variables | All {{VAR}} replaced |
| `generateLPLabel()` handles null batch/expiry | Shows "--" |
| `generateLPLabel()` truncates long product name | Max 40 chars |
| `generateLPLabel()` escapes special characters | ^, ~, \ escaped |
| `generateLPLabel()` includes correct copies | ^PQ command with correct value |
| `generateQRData()` returns valid JSON | Valid JSON string |
| `buildZPL()` formats dates correctly | YYYY-MM-DD format |
| `getLPLabelData()` joins product and location | All fields populated |
| `getLPLabelData()` handles missing location | Returns null or default |

### Integration Tests

**File:** `__tests__/integration/api/warehouse/label-print.test.ts`

| Test Case | Description |
|-----------|-------------|
| `POST /lps/:id/print-label` returns 200 with ZPL | Valid response |
| `POST /lps/:id/print-label?copies=3` returns ZPL with 3 copies | Copies parameter works |
| `POST /lps/:id/print-label` with invalid LP returns 404 | Not found |
| `POST /lps/:id/print-label` enforces RLS | Cross-org access blocked |
| `POST /lps/:id/print-label?copies=0` returns 400 | Validation error |
| `POST /lps/:id/print-label?copies=150` returns 400 | Exceeds max |
| `POST /lps/print-bulk` with 5 LPs returns ZIP | Bulk works |
| `POST /lps/print-bulk` with 0 LPs returns 400 | Validation error |
| `POST /lps/print-bulk` with 101 LPs returns 400 | Exceeds max |
| Label print logged in label_print_logs | Audit trail |

### E2E Tests

**File:** `__tests__/e2e/warehouse/label-print.spec.ts`

| Test Case | Description |
|-----------|-------------|
| Print label from LP detail page | Modal opens, ZPL downloads |
| Change copies in modal | Copies input works |
| Preview label in modal | Preview displays |
| Download ZPL file | File downloaded with correct name |
| Bulk print from LP list | Select multiple, download ZIP |
| Update label settings | Settings form saves |

---

## Definition of Done

### Database
- [ ] `warehouse_settings` includes label print columns
- [ ] `label_print_logs` table created for audit
- [ ] RLS policies enforce org isolation

### API
- [ ] All endpoints return correct HTTP status codes
- [ ] ZPL generation works for all field combinations
- [ ] Validation errors return 400 with detailed messages
- [ ] Cross-tenant access returns 404
- [ ] Response times:
  - Single label: < 500ms
  - Bulk labels (50): < 3s

### Service
- [ ] `generateLPLabel()` produces valid ZPL
- [ ] Template substitution handles all edge cases
- [ ] QR code JSON is valid
- [ ] Special characters escaped properly
- [ ] Audit logging works

### Frontend
- [ ] Print button on LP detail page
- [ ] Print modal with preview
- [ ] Bulk print from LP list
- [ ] ZPL file downloads with correct name
- [ ] Copies input validation
- [ ] Settings form for label config

### Testing
- [ ] Unit tests: >80% coverage on service
- [ ] Integration tests: All endpoints covered
- [ ] ZPL validation tests passing
- [ ] E2E tests: Print flow passing

---

## Potential Split (05.14a / 05.14b)

### 05.14a: LP Labels (This Story)
- Basic ZPL generation
- Download ZPL files
- Settings integration
- Desktop UI
- Complexity: M (2-3 days)

### 05.14b: Pallet Labels + TCP Printing (Future - Phase 3)
- SSCC-18 pallet labels
- Direct TCP socket printing to Zebra printers
- Print queue management
- Network printer discovery
- Complexity: M (2-3 days)
- Dependencies: 05.26 (Pallet Management)

---

## Future Phases (Not in This Story)

### Story 05.14b - Pallet Labels (SSCC-18)
- Pallet label template with SSCC-18 barcode
- Pallet weight and LP count
- GS1 compliance

### Phase 2 - Direct Printer Integration
- TCP socket printing to Zebra printers
- Printer status monitoring
- Print queue management
- Retry logic for failed prints

### Phase 3 - Advanced Features
- Label designer UI (custom templates)
- Multiple label templates per org
- PDF label generation
- Print history report
- Batch print jobs

---

## Risk Assessment

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| ZPL syntax errors | MEDIUM | LOW | Comprehensive ZPL validation tests |
| Special characters breaking ZPL | MEDIUM | MEDIUM | Thorough escaping and test coverage |
| Large bulk requests timeout | LOW | MEDIUM | Limit to 100 LPs, async processing if needed |
| Label dimensions incorrect | MEDIUM | LOW | Test with physical printer early |
| QR code too large for label | LOW | LOW | Limit QR data size, use appropriate error correction |
| Printer compatibility issues | LOW | LOW | Use standard ZPL II commands |

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-12-16 | Initial story creation with ZPL label printing for LPs | SONNET |
