# 05.23 - GS1 SSCC Support

| Field | Value |
|-------|-------|
| **Story ID** | 05.23 |
| **Epic** | 05 - Warehouse |
| **Status** | Ready |
| **Phase** | Phase 2 (Advanced Features) |
| **Priority** | P2 |
| **Complexity** | M (Medium) |
| **Estimate** | 3-4 days |
| **Type** | Backend + Frontend |

---

## PRD References

| FR ID | Requirement | Priority | Covered |
|-------|-------------|----------|---------|
| WH-FR-018 | GS1 SSCC Support | P1 | YES |

**Primary PRD:** `docs/1-BASELINE/product/modules/warehouse.md` (WH-FR-018)
**Architecture:** `docs/1-BASELINE/architecture/modules/warehouse.md`
**UX Wireframes:** WH-SSCC-001 (Pallet with SSCC), WH-SSCC-002 (SSCC Settings)

---

## MVP Scope

This story implements SSCC-18 (Serial Shipping Container Code) generation and scanning for pallet management per GS1 standards. SSCC is an 18-digit code that uniquely identifies pallets/shipping units globally.

**MVP Includes:**
- SSCC-18 code generation with proper GS1 structure
- Check digit calculation (Modulo 10)
- Company prefix configuration in organization settings
- Extension digit assignment (0-9)
- Serial reference generation (unique sequence per org)
- SSCC barcode scanning and lookup
- SSCC validation on input
- GS1-128 barcode format support for labels
- Integration with pallet creation workflow
- SSCC uniqueness enforcement

**Deferred to Phase 3+:** EDI integration, external SSCC registry sync, SSCC history/audit report

---

## Goal

Implement GS1 SSCC-18 support to enable standard pallet identification codes that can be shared with trading partners, scanned throughout supply chain, and printed on labels using GS1-128 barcode format.

---

## User Story

As a **Warehouse Manager**, I want to **generate and scan GS1-compliant SSCC-18 codes for pallets** so that **pallets have globally unique identifiers recognized by trading partners and can be tracked through the supply chain using industry-standard barcodes**.

---

## Scope

**In scope (this story):**
- SSCC-18 generation algorithm with check digit
- GS1 Company Prefix configuration in organization settings
- Extension digit configuration (default 0)
- Serial reference sequence management (per org)
- SSCC field on pallets table
- SSCC lookup by scanning (00) barcode
- SSCC validation (18 digits, valid check digit)
- SSCC display on pallet detail page
- SSCC in pallet label ZPL template (GS1-128 format)
- Settings toggle (enable_gs1_barcodes)
- API endpoints for SSCC generation and lookup

**Out of scope (this story):**
- EDI SSCC transmission (Epic 11 - Integrations)
- External SSCC registry synchronization (Phase 3)
- SSCC QR code format (GS1 Digital Link - Phase 3)
- Mobile scanner SSCC workflows (Story 05.24 - Scanner enhancements)
- SSCC history/audit report (Phase 3)
- Multi-company prefix support (Phase 3)

---

## Dependencies

| Dependency | Story/Epic | Type | Status | Notes |
|------------|------------|------|--------|-------|
| 05.0 | Warehouse Settings | HARD | Complete | enable_gs1_barcodes toggle |
| 05.22 | Pallet Management | HARD | Required | Pallets table, pallet CRUD |
| 05.14 | LP Label Printing | SOFT | Complete | Label printing patterns |
| 01.1 | Org Context + Base RLS | HARD | Complete | Org-level SSCC configuration |

**Dependents (What This Unblocks):**
- 05.24 (Scanner Pallet workflows) - Scan SSCC to lookup pallet
- 07.x (Shipping) - SSCC on shipping labels
- 11.x (Integrations) - EDI SSCC transmission

---

## Acceptance Criteria (Given/When/Then)

### AC-1: SSCC-18 Generation (WH-FR-018)

```gherkin
Scenario: Generate valid 18-digit SSCC on pallet creation
  Given enable_gs1_barcodes is true
  And organization has company_prefix = '1234567' (7 digits)
  And extension_digit = 0
  When pallet created
  Then system generates valid 18-digit SSCC:
    | Position | Content | Example |
    | 1 | Extension Digit | 0 |
    | 2-8 | Company Prefix | 1234567 |
    | 9-17 | Serial Reference | 890123456 |
    | 18 | Check Digit | (calculated) |
  And SSCC stored in pallets.sscc
  And SSCC unique within organization

Scenario: SSCC check digit calculation (Modulo 10)
  Given SSCC without check digit = 012345678901234567
  When check digit calculated using GS1 Modulo 10 algorithm
  Then check digit = ((10 - ((sum of weighted digits) % 10)) % 10)
  And algorithm uses alternating weights 3-1-3-1...

Scenario: Serial reference auto-increment
  Given organization created 5 pallets with SSCC
  When 6th pallet created
  Then serial reference = previous max + 1
  And serial reference padded to fill remaining digits
  And overflow handling if serial exhausted (reset with new extension)
```

### AC-2: Company Prefix Configuration

```gherkin
Scenario: Configure GS1 company prefix in organization settings
  Given admin navigates to Organization Settings > GS1 Configuration
  When admin enters company_prefix = '5060012'
  Then company_prefix validated (6-12 digits per GS1 standards)
  And company_prefix saved to organizations table
  And success toast "GS1 settings updated"

Scenario: Validate company prefix length
  Given admin entering company prefix
  When prefix entered with < 6 digits
  Then error "Company prefix must be 6-12 digits"
  When prefix entered with > 12 digits
  Then error "Company prefix must be 6-12 digits"

Scenario: Company prefix required for SSCC generation
  Given enable_gs1_barcodes = true
  And company_prefix = NULL
  When pallet creation attempted
  Then error "GS1 Company Prefix required. Configure in Settings > GS1"
  And pallet creation blocked
```

### AC-3: SSCC Barcode Scanning and Lookup (WH-FR-018)

```gherkin
Scenario: Scan SSCC barcode to lookup pallet
  Given pallet exists with sscc = '012345678901234567' (with check digit 8)
  When barcode scanned starting with (00)
  Then system parses 18-digit SSCC after AI code
  And pallet looked up by sscc field in < 100ms
  And pallet details returned

Scenario: Parse SSCC from GS1-128 barcode
  Given barcode data = "(00)012345678901234568"
  When parseSSCCBarcode() called
  Then AI code '00' identified
  And SSCC '012345678901234568' extracted
  And check digit validated

Scenario: SSCC not found in system
  Given scanned SSCC = '098765432109876543'
  And no pallet with this SSCC exists
  When lookup attempted
  Then error "Pallet not found for SSCC: 098765432109876543"
  And user prompted to verify barcode

Scenario: Invalid SSCC format scanned
  Given scanned data = "(00)12345" (too short)
  When parseSSCCBarcode() called
  Then error "Invalid SSCC format. Expected 18 digits."
```

### AC-4: SSCC Validation

```gherkin
Scenario: Validate SSCC check digit
  Given SSCC = '012345678901234567' with check digit 8
  When validateSSCC() called
  Then check digit recalculated
  And if matches, validation passes
  And if mismatch, error "Invalid SSCC check digit"

Scenario: SSCC uniqueness enforcement
  Given pallet A has sscc = '012345678901234568'
  When pallet B creation attempted with same SSCC
  Then error "SSCC already exists in system"
  And pallet B creation blocked

Scenario: Manual SSCC entry validation
  Given enable_manual_sscc = true
  When user enters SSCC manually
  Then system validates:
    - Exactly 18 digits
    - All numeric characters
    - Valid check digit
  And errors displayed inline if invalid
```

### AC-5: Pallet Label with SSCC (GS1-128 Format)

```gherkin
Scenario: Pallet label includes SSCC barcode
  Given pallet created with SSCC
  When pallet label printed
  Then label includes GS1-128 barcode with (00) AI
  And barcode data = "(00)" + SSCC-18
  And human-readable text below barcode shows formatted SSCC

Scenario: SSCC barcode symbology
  Given SSCC-18 = '012345678901234568'
  When ZPL generated for pallet label
  Then barcode command uses Code 128 symbology
  And FNC1 character included for GS1-128 compliance
  And barcode scannable by standard GS1 scanners

Scenario: ZPL template for SSCC barcode
  When pallet label ZPL generated
  Then ZPL includes:
    ^BY3,3,150
    ^BCN,150,Y,N,Y
    ^FD>:00{{SSCC}}^FS
  And human-readable: (00) X XXXXXXX XXXXXXXXX C
```

### AC-6: Settings Toggle (enable_gs1_barcodes)

```gherkin
Scenario: SSCC generation when GS1 disabled
  Given warehouse_settings.enable_gs1_barcodes = false
  When pallet created
  Then SSCC not generated
  And pallet_number used as identifier (internal numbering)
  And SSCC field remains NULL

Scenario: SSCC generation when GS1 enabled
  Given warehouse_settings.enable_gs1_barcodes = true
  And valid company_prefix configured
  When pallet created
  Then SSCC generated automatically
  And SSCC stored in pallets.sscc
  And pallet_number may differ from SSCC (or equal if configured)
```

### AC-7: SSCC Display in UI

```gherkin
Scenario: Pallet detail page shows SSCC
  Given pallet with sscc = '012345678901234568'
  When user views pallet detail
  Then SSCC displayed in header
  And formatted as: (00) 0 1234567 890123456 8
  And copy-to-clipboard button available

Scenario: Pallet list shows SSCC column
  Given enable_gs1_barcodes = true
  When user views pallet list
  Then SSCC column visible (optional, configurable)
  And searchable by SSCC

Scenario: SSCC not displayed when GS1 disabled
  Given enable_gs1_barcodes = false
  When user views pallet detail
  Then SSCC field not displayed
  And SSCC column not in pallet list
```

### AC-8: API Endpoints

```gherkin
Scenario: Generate SSCC via API
  Given enable_gs1_barcodes = true
  And valid company_prefix configured
  When POST /api/warehouse/sscc/generate
  Then response contains:
    | Field | Value |
    | sscc | 012345678901234568 |
    | extension_digit | 0 |
    | company_prefix | 1234567 |
    | serial_reference | 890123456 |
    | check_digit | 8 |
    | formatted | (00) 0 1234567 890123456 8 |

Scenario: Validate SSCC via API
  When POST /api/warehouse/sscc/validate with body:
    { "sscc": "012345678901234568" }
  Then response contains:
    | Field | Value |
    | valid | true |
    | check_digit_valid | true |
    | parsed.extension_digit | 0 |
    | parsed.company_prefix | 1234567 |
    | parsed.serial_reference | 890123456 |
    | parsed.check_digit | 8 |

Scenario: Lookup pallet by SSCC
  When GET /api/warehouse/pallets/sscc/012345678901234568
  Then response returns pallet detail with 200 OK
  Or 404 if not found
  And response time < 100ms
```

### AC-9: GS1 Settings Management

```gherkin
Scenario: Get GS1 settings
  When GET /api/settings/organization/gs1
  Then response contains:
    | Field | Value |
    | company_prefix | 1234567 |
    | extension_digit | 0 |
    | serial_sequence_current | 890123456 |
    | enable_gs1_barcodes | true |

Scenario: Update GS1 settings
  When PUT /api/settings/organization/gs1 with:
    {
      "company_prefix": "5060012",
      "extension_digit": 1
    }
  Then settings updated
  And serial sequence NOT reset (continues from current)
  And future SSCCs use new prefix

Scenario: Reset serial sequence
  When POST /api/settings/organization/gs1/reset-sequence
  Then serial sequence reset to 0
  And confirmation required (destructive action)
  And audit log entry created
```

### AC-10: Multi-tenancy

```gherkin
Scenario: SSCC unique per organization
  Given Org A has sscc = '012345678901234568'
  And Org B has different company_prefix
  When Org B generates SSCC
  Then different SSCC generated (different prefix)
  And global uniqueness maintained

Scenario: SSCC lookup enforces org isolation
  Given User A from Org A
  And pallet with SSCC belongs to Org B
  When User A attempts lookup by SSCC
  Then 404 Not Found (RLS enforced)
  And pallet not exposed to wrong org
```

---

## Technical Specification

### Database Schema

```sql
-- Add GS1 settings to organizations table
ALTER TABLE organizations
ADD COLUMN IF NOT EXISTS gs1_company_prefix VARCHAR(12),
ADD COLUMN IF NOT EXISTS gs1_extension_digit INTEGER DEFAULT 0 CHECK (gs1_extension_digit >= 0 AND gs1_extension_digit <= 9),
ADD COLUMN IF NOT EXISTS gs1_serial_sequence BIGINT DEFAULT 0;

-- Constraint: company_prefix 6-12 digits when set
ALTER TABLE organizations
ADD CONSTRAINT chk_gs1_company_prefix_length
CHECK (gs1_company_prefix IS NULL OR (LENGTH(gs1_company_prefix) >= 6 AND LENGTH(gs1_company_prefix) <= 12));

-- Index for SSCC lookup on pallets
CREATE INDEX IF NOT EXISTS idx_pallets_sscc ON pallets(sscc) WHERE sscc IS NOT NULL;

-- Unique constraint on SSCC (globally unique per GS1 spec)
ALTER TABLE pallets
ADD CONSTRAINT pallets_sscc_unique UNIQUE (sscc);
```

### API Endpoints

```
# SSCC Generation & Validation
POST   /api/warehouse/sscc/generate           - Generate new SSCC
POST   /api/warehouse/sscc/validate           - Validate SSCC format and check digit
POST   /api/warehouse/sscc/parse              - Parse GS1 barcode with SSCC

# Pallet lookup by SSCC
GET    /api/warehouse/pallets/sscc/:sscc      - Get pallet by SSCC

# GS1 Settings
GET    /api/settings/organization/gs1         - Get GS1 configuration
PUT    /api/settings/organization/gs1         - Update GS1 configuration
POST   /api/settings/organization/gs1/reset-sequence - Reset serial sequence
```

### Service Layer

```typescript
// lib/services/sscc-service.ts

export interface SSCCComponents {
  extension_digit: number;      // 0-9
  company_prefix: string;       // 6-12 digits
  serial_reference: string;     // Remaining digits
  check_digit: number;          // 0-9 (calculated)
}

export interface SSCCGenerateResult {
  sscc: string;                 // Full 18-digit SSCC
  components: SSCCComponents;
  formatted: string;            // Human-readable format
}

export interface SSCCValidateResult {
  valid: boolean;
  check_digit_valid: boolean;
  error?: string;
  parsed?: SSCCComponents;
}

export class SSCCService {
  /**
   * Generate new SSCC-18 for organization
   * @param orgId - Organization UUID
   * @returns Generated SSCC with components
   */
  static async generateSSCC(orgId: string): Promise<SSCCGenerateResult>;

  /**
   * Validate SSCC format and check digit
   * @param sscc - 18-digit SSCC string
   * @returns Validation result
   */
  static validateSSCC(sscc: string): SSCCValidateResult;

  /**
   * Calculate Modulo 10 check digit per GS1 spec
   * @param digits - First 17 digits of SSCC
   * @returns Check digit (0-9)
   */
  static calculateCheckDigit(digits: string): number;

  /**
   * Parse SSCC into components
   * @param sscc - 18-digit SSCC string
   * @param companyPrefixLength - Length of company prefix (6-12)
   * @returns Parsed components
   */
  static parseSSCC(sscc: string, companyPrefixLength: number): SSCCComponents;

  /**
   * Format SSCC for human-readable display
   * @param sscc - 18-digit SSCC string
   * @returns Formatted string: (00) X XXXXXXX XXXXXXXXX C
   */
  static formatSSCC(sscc: string): string;

  /**
   * Parse GS1-128 barcode containing SSCC
   * @param barcodeData - Raw barcode data (e.g., "(00)012345678901234568")
   * @returns Extracted SSCC or error
   */
  static parseSSCCBarcode(barcodeData: string): { sscc: string } | { error: string };

  /**
   * Lookup pallet by SSCC
   * @param sscc - 18-digit SSCC string
   * @param orgId - Organization UUID (for RLS)
   * @returns Pallet or null
   */
  static async lookupPalletBySSCC(sscc: string, orgId: string): Promise<Pallet | null>;

  /**
   * Get next serial reference for organization
   * Increments sequence atomically
   * @param orgId - Organization UUID
   * @returns Next serial reference string
   */
  static async getNextSerialReference(orgId: string): Promise<string>;

  /**
   * Get organization's GS1 configuration
   * @param orgId - Organization UUID
   * @returns GS1 settings
   */
  static async getGS1Config(orgId: string): Promise<GS1Config>;
}

export interface GS1Config {
  company_prefix: string | null;
  extension_digit: number;
  serial_sequence_current: number;
  enable_gs1_barcodes: boolean;
}
```

### Check Digit Algorithm (GS1 Modulo 10)

```typescript
/**
 * GS1 Modulo 10 Check Digit Calculation
 *
 * Algorithm:
 * 1. Start from rightmost digit (position 1)
 * 2. Multiply odd positions by 3, even positions by 1
 * 3. Sum all weighted digits
 * 4. Check digit = (10 - (sum % 10)) % 10
 *
 * Example: SSCC first 17 digits = 01234567890123456
 * Position:  17 16 15 14 13 12 11 10  9  8  7  6  5  4  3  2  1
 * Digit:      0  1  2  3  4  5  6  7  8  9  0  1  2  3  4  5  6
 * Weight:     3  1  3  1  3  1  3  1  3  1  3  1  3  1  3  1  3
 * Product:    0  1  6  3 12  5 18  7 24  9  0  1  6  3 12  5 18
 * Sum = 130
 * Check digit = (10 - (130 % 10)) % 10 = (10 - 0) % 10 = 0
 */
function calculateGS1CheckDigit(digits: string): number {
  if (digits.length !== 17) {
    throw new Error('Expected 17 digits for check digit calculation');
  }

  let sum = 0;
  for (let i = 0; i < 17; i++) {
    const digit = parseInt(digits[16 - i], 10); // Start from rightmost
    const weight = (i % 2 === 0) ? 3 : 1;       // Odd positions (1,3,5...) get weight 3
    sum += digit * weight;
  }

  return (10 - (sum % 10)) % 10;
}
```

### Validation Schema (Zod)

```typescript
// lib/validation/sscc.ts
import { z } from 'zod';

export const ssccSchema = z.string()
  .length(18, "SSCC must be exactly 18 digits")
  .regex(/^\d{18}$/, "SSCC must contain only digits");

export const companyPrefixSchema = z.string()
  .min(6, "Company prefix must be 6-12 digits")
  .max(12, "Company prefix must be 6-12 digits")
  .regex(/^\d+$/, "Company prefix must contain only digits");

export const extensionDigitSchema = z.number()
  .int()
  .min(0, "Extension digit must be 0-9")
  .max(9, "Extension digit must be 0-9");

export const gs1SettingsSchema = z.object({
  company_prefix: companyPrefixSchema.nullable().optional(),
  extension_digit: extensionDigitSchema.default(0),
});

export const validateSSCCRequestSchema = z.object({
  sscc: ssccSchema,
});

export const parseSSCCBarcodeSchema = z.object({
  barcode_data: z.string().min(1, "Barcode data required"),
});

export type SSCC = z.infer<typeof ssccSchema>;
export type GS1Settings = z.infer<typeof gs1SettingsSchema>;
```

---

## UI Components

```
app/(authenticated)/settings/organization/
  gs1/
    page.tsx                              -- GS1 Settings page

components/warehouse/sscc/
  SSCCDisplay.tsx                         -- Formatted SSCC display with copy
  SSCCBadge.tsx                           -- SSCC badge for pallet cards
  SSCCInput.tsx                           -- Manual SSCC input with validation
  SSCCSettings.tsx                        -- GS1 configuration form

components/warehouse/pallets/
  PalletDetail.tsx                        -- (update) Add SSCC section
  PalletList.tsx                          -- (update) Add SSCC column
  PalletLabel.tsx                         -- (update) Add SSCC barcode
```

### Component Specifications

**SSCCDisplay.tsx**
```tsx
interface SSCCDisplayProps {
  sscc: string;                           // 18-digit SSCC
  showAI?: boolean;                       // Show (00) prefix
  showCopyButton?: boolean;
  size?: 'sm' | 'md' | 'lg';
}

// Renders formatted SSCC:
// (00) 0 1234567 890123456 8
// With optional copy-to-clipboard button
```

**SSCCSettings.tsx**
```tsx
interface SSCCSettingsProps {
  onSave: (settings: GS1Settings) => void;
}

// Form fields:
// - Company Prefix (text input, 6-12 digits)
// - Extension Digit (select 0-9)
// - Current Serial Sequence (read-only)
// - Reset Sequence button (with confirmation)
// - Test Generate button (preview next SSCC)
```

---

## Key Business Rules

1. **SSCC Structure**: Extension(1) + Company Prefix(6-12) + Serial Reference(variable) + Check Digit(1) = 18 digits total
2. **GS1 Compliance**: SSCC must follow GS1 General Specifications for serial shipping container codes
3. **Global Uniqueness**: Each SSCC must be globally unique (enforced via company prefix + serial)
4. **Company Prefix Required**: Cannot generate SSCC without valid company prefix configured
5. **Check Digit Mandatory**: All SSCCs validated using Modulo 10 algorithm
6. **One-Time Use**: SSCC should not be reused (even after pallet destroyed)
7. **Extension Digit**: Default 0, can be changed to expand serial number space
8. **Serial Sequence**: Atomic increment to prevent duplicates
9. **AI Code**: SSCC always prefixed with (00) in GS1-128 barcodes
10. **Barcode Symbology**: GS1-128 (Code 128 with FNC1 for GS1 compliance)

---

## Deliverables

### Database
- [ ] Add `gs1_company_prefix`, `gs1_extension_digit`, `gs1_serial_sequence` to organizations
- [ ] Add unique constraint on `pallets.sscc`
- [ ] Add index on `pallets.sscc`
- [ ] Migration for schema changes

### API Routes
- [ ] `POST /api/warehouse/sscc/generate` - Generate new SSCC
- [ ] `POST /api/warehouse/sscc/validate` - Validate SSCC
- [ ] `POST /api/warehouse/sscc/parse` - Parse barcode
- [ ] `GET /api/warehouse/pallets/sscc/:sscc` - Lookup by SSCC
- [ ] `GET /api/settings/organization/gs1` - Get GS1 config
- [ ] `PUT /api/settings/organization/gs1` - Update GS1 config
- [ ] `POST /api/settings/organization/gs1/reset-sequence` - Reset sequence

### Services
- [ ] `SSCCService.generateSSCC()` - Main generation
- [ ] `SSCCService.validateSSCC()` - Format + check digit validation
- [ ] `SSCCService.calculateCheckDigit()` - Modulo 10 algorithm
- [ ] `SSCCService.parseSSCC()` - Parse into components
- [ ] `SSCCService.formatSSCC()` - Human-readable format
- [ ] `SSCCService.parseSSCCBarcode()` - Extract from GS1-128
- [ ] `SSCCService.lookupPalletBySSCC()` - Database lookup
- [ ] `SSCCService.getNextSerialReference()` - Atomic increment

### Validation
- [ ] `ssccSchema` - 18-digit validation
- [ ] `companyPrefixSchema` - 6-12 digit validation
- [ ] `gs1SettingsSchema` - Settings validation
- [ ] `validateSSCCRequestSchema` - API request validation

### Frontend
- [ ] GS1 Settings page (`/settings/organization/gs1`)
- [ ] SSCCDisplay component (formatted display)
- [ ] SSCCSettings component (configuration form)
- [ ] Update PalletDetail to show SSCC
- [ ] Update PalletList to include SSCC column
- [ ] Update pallet label ZPL template for SSCC barcode

### Tests
- [ ] Unit tests: Check digit algorithm (edge cases)
- [ ] Unit tests: SSCC generation/validation
- [ ] Unit tests: Barcode parsing
- [ ] Integration tests: API endpoints
- [ ] Integration tests: Pallet creation with SSCC
- [ ] E2E test: Configure GS1 settings, create pallet, verify SSCC

---

## Test Cases

### Unit Tests

**File:** `__tests__/unit/services/sscc-service.test.ts`

| Test Case | Description |
|-----------|-------------|
| `calculateCheckDigit()` correct for known SSCC | Verify Modulo 10 |
| `calculateCheckDigit()` handles all zeros | Edge case |
| `calculateCheckDigit()` handles all nines | Edge case |
| `validateSSCC()` passes valid SSCC | Valid format + check digit |
| `validateSSCC()` fails wrong length | Not 18 digits |
| `validateSSCC()` fails wrong check digit | Check digit mismatch |
| `validateSSCC()` fails non-numeric | Contains letters |
| `parseSSCC()` extracts components correctly | Extension, prefix, serial, check |
| `formatSSCC()` returns human-readable format | Spaces in correct positions |
| `parseSSCCBarcode()` extracts SSCC from (00) prefix | GS1-128 parsing |
| `parseSSCCBarcode()` fails on invalid AI | Not (00) prefix |
| `generateSSCC()` returns unique SSCC | Uniqueness check |
| `generateSSCC()` requires company prefix | Error without prefix |

### Integration Tests

**File:** `__tests__/integration/api/warehouse/sscc.test.ts`

| Test Case | Description |
|-----------|-------------|
| `POST /sscc/generate` returns valid SSCC | Generation works |
| `POST /sscc/generate` fails without company prefix | Validation error |
| `POST /sscc/validate` validates correctly | Format + check digit |
| `POST /sscc/validate` fails invalid SSCC | Error response |
| `GET /pallets/sscc/:sscc` returns pallet | Lookup works |
| `GET /pallets/sscc/:sscc` returns 404 | Not found |
| `GET /pallets/sscc/:sscc` enforces RLS | Cross-org blocked |
| `PUT /settings/organization/gs1` updates settings | Settings saved |
| Pallet creation generates SSCC when enabled | Integration |
| SSCC uniqueness enforced on insert | Constraint works |

### E2E Tests

**File:** `__tests__/e2e/warehouse/sscc.spec.ts`

| Test Case | Description |
|-----------|-------------|
| Configure GS1 settings | Company prefix, extension digit |
| Create pallet with auto-generated SSCC | SSCC appears on detail |
| SSCC displayed correctly on pallet detail | Formatted display |
| SSCC column visible in pallet list | When GS1 enabled |
| Copy SSCC to clipboard | Copy button works |
| Search pallet by SSCC | Search functionality |

---

## Definition of Done

### Database
- [ ] `organizations` table has GS1 columns (prefix, extension, sequence)
- [ ] `pallets.sscc` has unique constraint
- [ ] Index on `pallets.sscc` for fast lookup
- [ ] RLS enforces org isolation on SSCC lookup

### API
- [ ] All endpoints return correct HTTP status codes
- [ ] SSCC generation returns valid 18-digit codes
- [ ] Check digit validation accurate (tested against known values)
- [ ] Lookup by SSCC returns pallet in < 100ms
- [ ] Settings CRUD working

### Service
- [ ] `calculateCheckDigit()` matches GS1 spec (test against examples)
- [ ] Serial sequence increments atomically (no duplicates under load)
- [ ] Company prefix required for generation
- [ ] Barcode parsing handles (00) AI code

### Frontend
- [ ] GS1 Settings page accessible from Organization Settings
- [ ] Company prefix input with validation
- [ ] SSCC displayed on pallet detail page
- [ ] SSCC column in pallet list (configurable)
- [ ] Copy SSCC button functional

### Testing
- [ ] Unit tests: >85% coverage on SSCCService
- [ ] Check digit algorithm tested with 10+ known examples
- [ ] Integration tests: All endpoints covered
- [ ] E2E tests: Configuration to pallet creation flow

---

## Risk Assessment

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Check digit calculation incorrect | HIGH | LOW | Test against GS1 examples, third-party validation |
| Serial sequence collision | HIGH | LOW | Atomic increment with database transaction |
| Performance on SSCC lookup | MEDIUM | LOW | Index on sscc column |
| Company prefix not configured | MEDIUM | MEDIUM | Clear error messaging, settings validation |
| SSCC barcode not scanning | MEDIUM | MEDIUM | Test with physical Zebra printer and scanner |
| Serial exhaustion (overflow) | LOW | LOW | Monitor sequence, alert at 90% capacity |

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-01-15 | Initial story creation | ARCHITECT-AGENT |
