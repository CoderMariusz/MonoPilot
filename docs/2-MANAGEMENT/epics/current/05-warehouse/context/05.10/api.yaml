# Story 05.10 - API Specification
# Purpose: Endpoints, request/response schemas, services, validation
# Agent: BACKEND-DEV (API focus)

# API Endpoints
endpoints:
  # GRN CRUD
  - method: "GET"
    path: "/api/warehouse/grns"
    description: "List GRNs with filtering, sorting, pagination"
    file: "apps/frontend/app/api/warehouse/grns/route.ts"
    auth: "required"
    roles: ["warehouse_manager", "warehouse_operator", "admin", "owner"]
    query_params:
      - { name: "search", type: "string", description: "GRN number prefix search" }
      - { name: "status", type: "enum", values: ["draft", "completed", "cancelled"] }
      - { name: "source_type", type: "enum", values: ["po", "to", "production", "return", "adjustment"] }
      - { name: "warehouse_id", type: "UUID" }
      - { name: "from_date", type: "date", description: "Filter receipt_date >= value" }
      - { name: "to_date", type: "date", description: "Filter receipt_date <= value" }
      - { name: "supplier_id", type: "UUID" }
      - { name: "sort", type: "enum", values: ["grn_number", "receipt_date", "created_at", "total_qty"], default: "created_at" }
      - { name: "order", type: "enum", values: ["asc", "desc"], default: "desc" }
      - { name: "page", type: "integer", default: 1 }
      - { name: "limit", type: "integer", default: 50, max: 100 }
    response:
      status: 200
      type: "PaginatedResult<GRN>"
    errors:
      - { status: 401, code: "UNAUTHORIZED" }

  - method: "GET"
    path: "/api/warehouse/grns/:id"
    description: "Get GRN detail with items and LP references"
    file: "apps/frontend/app/api/warehouse/grns/[id]/route.ts"
    auth: "required"
    roles: ["warehouse_manager", "warehouse_operator", "admin", "owner"]
    response:
      status: 200
      type: "GRN (with items)"
    errors:
      - { status: 401, code: "UNAUTHORIZED" }
      - { status: 404, code: "NOT_FOUND", when: "GRN not found or cross-tenant access" }

  - method: "POST"
    path: "/api/warehouse/grns"
    description: "Create GRN with items"
    file: "apps/frontend/app/api/warehouse/grns/route.ts"
    auth: "required"
    roles: ["warehouse_manager", "warehouse_operator", "admin", "owner"]
    request:
      type: "CreateGRNInput"
    response:
      status: 201
      type: "GRN"
    errors:
      - { status: 400, code: "VALIDATION_ERROR", when: "Invalid input data" }
      - { status: 401, code: "UNAUTHORIZED" }
      - { status: 409, code: "CONFLICT", when: "GRN number already exists" }

  - method: "PUT"
    path: "/api/warehouse/grns/:id"
    description: "Update GRN (draft only)"
    file: "apps/frontend/app/api/warehouse/grns/[id]/route.ts"
    auth: "required"
    roles: ["warehouse_manager", "admin", "owner"]
    request:
      type: "UpdateGRNInput"
    response:
      status: 200
      type: "GRN"
    errors:
      - { status: 400, code: "CANNOT_MODIFY", when: "GRN is not in draft status" }
      - { status: 401, code: "UNAUTHORIZED" }
      - { status: 404, code: "NOT_FOUND" }

  # GRN Item CRUD
  - method: "POST"
    path: "/api/warehouse/grns/:id/items"
    description: "Add item to GRN (draft only)"
    file: "apps/frontend/app/api/warehouse/grns/[id]/items/route.ts"
    auth: "required"
    roles: ["warehouse_manager", "warehouse_operator", "admin", "owner"]
    request:
      type: "CreateGRNItemInput"
    response:
      status: 201
      type: "GRNItem"
    errors:
      - { status: 400, code: "CANNOT_MODIFY", when: "GRN is not in draft status" }
      - { status: 400, code: "VALIDATION_ERROR" }
      - { status: 404, code: "NOT_FOUND" }

  - method: "PUT"
    path: "/api/warehouse/grns/:id/items/:itemId"
    description: "Update GRN item (draft only)"
    file: "apps/frontend/app/api/warehouse/grns/[id]/items/[itemId]/route.ts"
    auth: "required"
    roles: ["warehouse_manager", "warehouse_operator", "admin", "owner"]
    request:
      type: "UpdateGRNItemInput"
    response:
      status: 200
      type: "GRNItem"
    errors:
      - { status: 400, code: "CANNOT_MODIFY", when: "GRN is not in draft status" }
      - { status: 404, code: "NOT_FOUND" }

  - method: "DELETE"
    path: "/api/warehouse/grns/:id/items/:itemId"
    description: "Remove item from GRN (draft only)"
    file: "apps/frontend/app/api/warehouse/grns/[id]/items/[itemId]/route.ts"
    auth: "required"
    roles: ["warehouse_manager", "admin", "owner"]
    response:
      status: 204
    errors:
      - { status: 400, code: "CANNOT_MODIFY", when: "GRN is not in draft status" }
      - { status: 404, code: "NOT_FOUND" }

  # GRN Workflow Actions
  - method: "POST"
    path: "/api/warehouse/grns/:id/complete"
    description: "Complete GRN (creates LPs for all items)"
    file: "apps/frontend/app/api/warehouse/grns/[id]/complete/route.ts"
    auth: "required"
    roles: ["warehouse_manager", "admin", "owner"]
    response:
      status: 200
      type: "CompleteGRNResult"
    errors:
      - { status: 400, code: "NO_ITEMS", when: "GRN has no items" }
      - { status: 400, code: "BATCH_REQUIRED", when: "Batch number required for product" }
      - { status: 400, code: "EXPIRY_REQUIRED", when: "Expiry date required for product" }
      - { status: 400, code: "ALREADY_COMPLETED", when: "GRN is already completed" }
      - { status: 404, code: "NOT_FOUND" }

  - method: "POST"
    path: "/api/warehouse/grns/:id/cancel"
    description: "Cancel GRN (consumes LPs if completed)"
    file: "apps/frontend/app/api/warehouse/grns/[id]/cancel/route.ts"
    auth: "required"
    roles: ["warehouse_manager", "admin", "owner"]
    request:
      schema:
        reason: "string (required)"
    response:
      status: 200
      type: "GRN"
    errors:
      - { status: 400, code: "LP_IN_USE", when: "LP is reserved or consumed" }
      - { status: 400, code: "ALREADY_CANCELLED", when: "GRN is already cancelled" }
      - { status: 404, code: "NOT_FOUND" }

  - method: "POST"
    path: "/api/warehouse/grns/:id/print"
    description: "Print GRN summary"
    file: "apps/frontend/app/api/warehouse/grns/[id]/print/route.ts"
    auth: "required"
    roles: ["warehouse_manager", "warehouse_operator", "admin", "owner"]
    response:
      status: 200
      type: "PrintJob"

  # Utility
  - method: "GET"
    path: "/api/warehouse/grns/generate-number"
    description: "Generate next GRN number (preview, does not commit)"
    file: "apps/frontend/app/api/warehouse/grns/generate-number/route.ts"
    auth: "required"
    roles: ["warehouse_manager", "warehouse_operator", "admin", "owner"]
    response:
      status: 200
      schema:
        grn_number: "string"

# Services
services:
  - path: "apps/frontend/lib/services/grn-service.ts"
    description: "GRN business logic and data access"
    exports:
      # Types
      - name: "GRNStatus"
        type: "type"
        value: "'draft' | 'completed' | 'cancelled'"
      - name: "GRNSourceType"
        type: "type"
        value: "'po' | 'to' | 'production' | 'return' | 'adjustment'"
      - name: "QAStatus"
        type: "type"
        value: "'pending' | 'passed' | 'failed' | 'quarantine'"
      - name: "GRN"
        type: "interface"
      - name: "GRNItem"
        type: "interface"
      - name: "CreateGRNInput"
        type: "interface"
      - name: "UpdateGRNInput"
        type: "interface"
      - name: "CreateGRNItemInput"
        type: "interface"
      - name: "UpdateGRNItemInput"
        type: "interface"
      - name: "GRNListParams"
        type: "interface"
      - name: "CompleteGRNResult"
        type: "interface"
      # Methods
      - name: "GRNService.list"
        type: "async function"
        params: ["params: GRNListParams"]
        returns: "Promise<PaginatedResult<GRN>>"
      - name: "GRNService.getById"
        type: "async function"
        params: ["id: string"]
        returns: "Promise<GRN | null>"
      - name: "GRNService.create"
        type: "async function"
        params: ["data: CreateGRNInput"]
        returns: "Promise<GRN>"
      - name: "GRNService.update"
        type: "async function"
        params: ["id: string", "data: UpdateGRNInput"]
        returns: "Promise<GRN>"
      - name: "GRNService.addItem"
        type: "async function"
        params: ["grnId: string", "item: CreateGRNItemInput"]
        returns: "Promise<GRNItem>"
      - name: "GRNService.updateItem"
        type: "async function"
        params: ["grnId: string", "itemId: string", "data: UpdateGRNItemInput"]
        returns: "Promise<GRNItem>"
      - name: "GRNService.removeItem"
        type: "async function"
        params: ["grnId: string", "itemId: string"]
        returns: "Promise<void>"
      - name: "GRNService.complete"
        type: "async function"
        params: ["id: string"]
        returns: "Promise<CompleteGRNResult>"
        description: "Completes GRN and creates 1 LP per item"
      - name: "GRNService.cancel"
        type: "async function"
        params: ["id: string", "reason: string"]
        returns: "Promise<GRN>"
      - name: "GRNService.generateGRNNumber"
        type: "async function"
        params: []
        returns: "Promise<string>"
      - name: "GRNService.validateForCompletion"
        type: "async function"
        params: ["grn: GRN"]
        returns: "Promise<{ valid: boolean; errors: string[] }>"
      - name: "GRNService.validateForCancellation"
        type: "async function"
        params: ["grn: GRN"]
        returns: "Promise<{ valid: boolean; errors: string[] }>"

# Validation Schemas (Zod)
validation:
  path: "apps/frontend/lib/validation/grn.ts"
  schemas:
    - name: "grnSourceTypeEnum"
      type: "z.enum"
      values: ["po", "to", "production", "return", "adjustment"]

    - name: "grnStatusEnum"
      type: "z.enum"
      values: ["draft", "completed", "cancelled"]

    - name: "qaStatusEnum"
      type: "z.enum"
      values: ["pending", "passed", "failed", "quarantine"]

    - name: "createGRNItemSchema"
      fields:
        - { name: "product_id", type: "z.string().uuid()", required: true }
        - { name: "ordered_qty", type: "z.number().nonnegative()", default: 0 }
        - { name: "received_qty", type: "z.number().positive()", required: true }
        - { name: "uom", type: "z.string().min(1).max(20)", required: true }
        - { name: "po_line_id", type: "z.string().uuid().nullable()", optional: true }
        - { name: "to_line_id", type: "z.string().uuid().nullable()", optional: true }
        - { name: "batch_number", type: "z.string().max(100).nullable()", optional: true }
        - { name: "supplier_batch_number", type: "z.string().max(100).nullable()", optional: true }
        - { name: "gtin", type: "z.string().length(14).nullable()", optional: true }
        - { name: "catch_weight_kg", type: "z.number().positive().nullable()", optional: true }
        - { name: "expiry_date", type: "z.string().regex(/^\\d{4}-\\d{2}-\\d{2}$/).nullable()", optional: true }
        - { name: "manufacture_date", type: "z.string().regex(/^\\d{4}-\\d{2}-\\d{2}$/).nullable()", optional: true }
        - { name: "location_id", type: "z.string().uuid()", optional: true }
        - { name: "qa_status", type: "qaStatusEnum", default: "pending" }
        - { name: "notes", type: "z.string().max(500).nullable()", optional: true }

    - name: "createGRNSchema"
      fields:
        - { name: "source_type", type: "grnSourceTypeEnum", required: true }
        - { name: "warehouse_id", type: "z.string().uuid()", required: true }
        - { name: "location_id", type: "z.string().uuid()", required: true }
        - { name: "po_id", type: "z.string().uuid().nullable()", optional: true }
        - { name: "to_id", type: "z.string().uuid().nullable()", optional: true }
        - { name: "asn_id", type: "z.string().uuid().nullable()", optional: true }
        - { name: "supplier_id", type: "z.string().uuid().nullable()", optional: true }
        - { name: "receipt_date", type: "z.string().datetime()", optional: true }
        - { name: "notes", type: "z.string().max(1000).nullable()", optional: true }
        - { name: "items", type: "z.array(createGRNItemSchema).min(1)", required: true }
      refinements:
        - message: "PO ID required for PO source type"
          check: "(source_type === 'po' && po_id) || source_type !== 'po'"
        - message: "TO ID required for TO source type"
          check: "(source_type === 'to' && to_id) || source_type !== 'to'"

    - name: "updateGRNSchema"
      fields:
        - { name: "location_id", type: "z.string().uuid()", optional: true }
        - { name: "notes", type: "z.string().max(1000).nullable()", optional: true }

    - name: "updateGRNItemSchema"
      fields:
        - { name: "received_qty", type: "z.number().positive()", optional: true }
        - { name: "batch_number", type: "z.string().max(100).nullable()", optional: true }
        - { name: "supplier_batch_number", type: "z.string().max(100).nullable()", optional: true }
        - { name: "expiry_date", type: "z.string().regex(/^\\d{4}-\\d{2}-\\d{2}$/).nullable()", optional: true }
        - { name: "manufacture_date", type: "z.string().regex(/^\\d{4}-\\d{2}-\\d{2}$/).nullable()", optional: true }
        - { name: "location_id", type: "z.string().uuid()", optional: true }
        - { name: "qa_status", type: "qaStatusEnum", optional: true }
        - { name: "notes", type: "z.string().max(500).nullable()", optional: true }

    - name: "cancelGRNSchema"
      fields:
        - { name: "reason", type: "z.string().min(1).max(500)", required: true }

    - name: "grnQuerySchema"
      fields:
        - { name: "search", type: "z.string().min(1)", optional: true }
        - { name: "status", type: "grnStatusEnum", optional: true }
        - { name: "source_type", type: "grnSourceTypeEnum", optional: true }
        - { name: "warehouse_id", type: "z.string().uuid()", optional: true }
        - { name: "from_date", type: "z.string().regex(/^\\d{4}-\\d{2}-\\d{2}$/)", optional: true }
        - { name: "to_date", type: "z.string().regex(/^\\d{4}-\\d{2}-\\d{2}$/)", optional: true }
        - { name: "supplier_id", type: "z.string().uuid()", optional: true }
        - { name: "sort", type: "z.enum(['grn_number', 'receipt_date', 'created_at', 'total_qty'])", default: "created_at" }
        - { name: "order", type: "z.enum(['asc', 'desc'])", default: "desc" }
        - { name: "page", type: "z.coerce.number().int().positive()", default: 1 }
        - { name: "limit", type: "z.coerce.number().int().min(1).max(100)", default: 50 }

# Types
types:
  - path: "apps/frontend/lib/types/grn.ts"
    description: "GRN TypeScript interfaces"
    exports:
      - name: "GRN"
        fields:
          - "id: string"
          - "org_id: string"
          - "grn_number: string"
          - "source_type: GRNSourceType"
          - "po_id: string | null"
          - "to_id: string | null"
          - "asn_id: string | null"
          - "supplier_id: string | null"
          - "receipt_date: string"
          - "warehouse_id: string"
          - "location_id: string"
          - "status: GRNStatus"
          - "total_items: number"
          - "total_qty: number"
          - "notes: string | null"
          - "created_at: string"
          - "created_by: string | null"
          - "completed_at: string | null"
          - "completed_by: string | null"
          - "cancelled_at: string | null"
          - "cancelled_by: string | null"
          - "cancellation_reason: string | null"
          - "warehouse?: { name: string; code: string }"
          - "location?: { full_path: string }"
          - "supplier?: { name: string }"
          - "items?: GRNItem[]"

      - name: "GRNItem"
        fields:
          - "id: string"
          - "grn_id: string"
          - "product_id: string"
          - "po_line_id: string | null"
          - "to_line_id: string | null"
          - "ordered_qty: number"
          - "received_qty: number"
          - "uom: string"
          - "lp_id: string | null"
          - "batch_number: string | null"
          - "supplier_batch_number: string | null"
          - "gtin: string | null"
          - "catch_weight_kg: number | null"
          - "expiry_date: string | null"
          - "manufacture_date: string | null"
          - "location_id: string"
          - "qa_status: QAStatus"
          - "line_number: number"
          - "notes: string | null"
          - "product?: { name: string; code: string; uom: string }"
          - "location?: { full_path: string }"
          - "lp?: { lp_number: string }"

      - name: "CompleteGRNResult"
        fields:
          - "grn: GRN"
          - "created_lps: LicensePlate[]"

# Implementation patterns
patterns:
  api_route_list: |
    // apps/frontend/app/api/warehouse/grns/route.ts
    import { createRouteHandlerClient } from '@supabase/auth-helpers-nextjs';
    import { cookies } from 'next/headers';
    import { NextResponse } from 'next/server';
    import { grnQuerySchema } from '@/lib/validation/grn';
    import { GRNService } from '@/lib/services/grn-service';

    export async function GET(request: Request) {
      const supabase = createRouteHandlerClient({ cookies });
      const { data: { user }, error: authError } = await supabase.auth.getUser();

      if (authError || !user) {
        return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
      }

      const { searchParams } = new URL(request.url);
      const params = grnQuerySchema.safeParse(Object.fromEntries(searchParams));

      if (!params.success) {
        return NextResponse.json({ error: params.error.issues }, { status: 400 });
      }

      const result = await GRNService.list(params.data);
      return NextResponse.json(result);
    }

  complete_workflow: |
    // In GRNService.complete()
    // 1. Validate GRN is draft status
    // 2. Validate at least 1 item exists
    // 3. Validate required fields (batch, expiry) based on settings
    // 4. Start transaction
    // 5. For each GRN item:
    //    a. Create LP with data from item
    //    b. Update grn_item.lp_id with new LP id
    // 6. Update GRN status to 'completed'
    // 7. Set completed_at and completed_by
    // 8. Commit transaction
    // 9. Return GRN with created LPs
