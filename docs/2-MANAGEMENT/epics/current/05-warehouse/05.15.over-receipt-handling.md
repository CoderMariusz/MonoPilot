# 05.15 - Over-Receipt Handling (Advanced)

| Field | Value |
|-------|-------|
| **Story ID** | 05.15 |
| **Epic** | 05 - Warehouse |
| **Status** | Ready |
| **Phase** | Phase 1 (Goods Receipt) |
| **Priority** | P1 |
| **Complexity** | S (Small) |
| **Estimate** | 1-2 days |
| **Type** | Backend + Frontend |
| **Model** | SONNET |

---

## PRD References

| FR ID | Requirement | Priority | Coverage |
|-------|-------------|----------|----------|
| WH-FR-029 | Over-Receipt Control (tolerance, approval workflow) | P1 | Full |
| WH-FR-003 | GRN from PO (validation integration) | P0 | Partial |

**Primary PRD:** `docs/1-BASELINE/product/modules/warehouse.md`
**Architecture:** `docs/1-BASELINE/architecture/modules/warehouse.md`

---

## MVP Scope

### In Scope (This Story)

1. **Warehouse Settings for Over-Receipt**
   - `allow_over_receipt` boolean setting
   - `over_receipt_tolerance_pct` numeric setting (0-100)
   - Settings UI in warehouse configuration page
   - Validation of tolerance percentage range

2. **Over-Receipt Validation Logic**
   - Service method: `OverReceiptService.validateOverReceipt()`
   - Calculate over-receipt percentage
   - Check against tolerance setting
   - Return structured validation result

3. **Approval Workflow for Over-Tolerance Receipts**
   - `over_receipt_approvals` table
   - API endpoint: `POST /api/warehouse/over-receipt-approvals`
   - Approval states: pending, approved, rejected
   - Manager approval required when exceeding tolerance
   - Email/notification to approver

4. **Desktop UI: Over-Receipt Warning and Approval Modal**
   - Warning banner on GRN wizard when over-receipt detected
   - Inline over-receipt percentage display per line
   - Approval modal for manager override
   - Approval request form with reason field
   - Pending approval status display

5. **API Endpoints**
   - `POST /api/warehouse/grns/validate-over-receipt` - Pre-validation
   - `POST /api/warehouse/over-receipt-approvals` - Request approval
   - `GET /api/warehouse/over-receipt-approvals/:id` - Get approval status
   - `POST /api/warehouse/over-receipt-approvals/:id/approve` - Approve request
   - `POST /api/warehouse/over-receipt-approvals/:id/reject` - Reject request

6. **Service Layer**
   - `OverReceiptService.validateOverReceipt()` - Validation logic
   - `OverReceiptService.requestApproval()` - Create approval request
   - `OverReceiptService.approveRequest()` - Approve over-receipt
   - `OverReceiptService.rejectRequest()` - Reject over-receipt
   - Integration with `GRNService.createFromPO()`

7. **Zod Validation Schemas**
   - Over-receipt validation request schema
   - Approval request schema
   - Approval action schema

### Out of Scope (Other Stories)

| Feature | Deferred To | Reason |
|---------|-------------|--------|
| GRN from TO over-receipt | 05.12 | Different source workflow |
| Multi-level approval workflow | Phase 2+ | Advanced feature |
| Auto-approval rules | Phase 2+ | Business logic complexity |
| Over-receipt analytics/reporting | 05.15 (Dashboard) | Reporting feature |
| Scanner over-receipt handling | 05.17 | Mobile workflow |
| Supplier penalty tracking | Phase 3+ | Advanced feature |

---

## Epic 04 Dependency Status

- [ ] NOT CRITICAL - Does not unblock Epic 04 Phase 1
- [x] Phase 1 Story - Receiving workflow enhancement

This story enhances goods receipt but Epic 04 (Production) does not depend on receiving workflows.

---

## Goal

Enable warehouse managers to control over-receipt situations by configuring tolerance settings and requiring approval for receipts that exceed tolerance, ensuring proper oversight of inventory discrepancies.

---

## User Story

As a **Warehouse Manager**, I want to **configure over-receipt tolerance and approve receipts that exceed the tolerance** so that **I can control inventory accuracy while allowing flexibility for expected variances**.

---

## Dependencies

| Dependency | Story/Epic | Type | Status | Notes |
|------------|------------|------|--------|-------|
| 05.11 | GRN from PO | HARD | Ready | Integrates validation into GRN workflow |
| 05.0 | Warehouse Settings | HARD | Ready | Settings table and service |
| 01.1 | Org Context + RLS | HARD | Done | Multi-tenancy foundation |
| 01.2 | User Management | HARD | Done | Approver user reference |

**Dependents (What This Unblocks):**
- 05.12 (GRN from TO) - Same over-receipt logic for transfers
- 05.17 (Scanner Receive) - Mobile over-receipt handling

---

## Acceptance Criteria (Given/When/Then)

### AC-1: Warehouse Settings for Over-Receipt

```gherkin
Scenario: Settings table has over-receipt columns
  Given warehouse_settings table exists
  When schema is inspected
  Then table has columns:
    | Column | Type | Nullable | Default |
    | allow_over_receipt | BOOLEAN | NO | false |
    | over_receipt_tolerance_pct | NUMERIC(5,2) | NO | 0.00 |
  And over_receipt_tolerance_pct CHECK constraint exists: value >= 0 AND value <= 100

Scenario: Default settings prevent over-receipt
  Given new organization created
  When warehouse_settings initialized
  Then allow_over_receipt = false
  And over_receipt_tolerance_pct = 0.00
```

### AC-2: Settings UI for Over-Receipt Configuration (WH-FR-029)

```gherkin
Scenario: Manager configures over-receipt settings
  Given user with role 'warehouse_manager' navigates to /settings/warehouse
  When viewing Warehouse Settings page
  Then "Receiving Settings" section displays:
    | Field | Type | Help Text |
    | Allow Over-Receipt | Toggle | "Allow receiving more than ordered quantity" |
    | Over-Receipt Tolerance % | Number | "Maximum over-receipt percentage allowed (0-100)" |
  And tolerance input only enabled when allow_over_receipt = true

Scenario: Tolerance validation on save
  Given manager editing warehouse settings
  When entering tolerance = 150
  Then validation error displayed: "Tolerance must be between 0 and 100"

Scenario: Tolerance validation for negative values
  Given manager editing warehouse settings
  When entering tolerance = -5
  Then validation error displayed: "Tolerance must be between 0 and 100"

Scenario: Save settings successfully
  Given allow_over_receipt = true and tolerance = 10
  When clicking "Save Settings"
  Then settings saved successfully
  And success message displayed: "Warehouse settings updated"
```

### AC-3: Over-Receipt Validation Logic (WH-FR-029)

```gherkin
Scenario: Calculate over-receipt percentage
  Given PO line with ordered_qty = 100, received_qty = 0
  When receiving 110 units
  Then over_receipt_pct calculated as: ((110 + 0) / 100 - 1) * 100 = 10.0%

Scenario: Calculate over-receipt with partial receipt
  Given PO line with ordered_qty = 100, received_qty = 50
  When receiving 60 units (total = 110)
  Then over_receipt_pct calculated as: (110 / 100 - 1) * 100 = 10.0%

Scenario: Block over-receipt when not allowed
  Given warehouse_settings.allow_over_receipt = false
  And PO line with ordered_qty = 100, received_qty = 0
  When POST /api/warehouse/grns/validate-over-receipt with:
    {
      "po_line_id": "{line_uuid}",
      "receiving_qty": 110
    }
  Then response status = 200
  And response body:
    {
      "allowed": false,
      "requires_approval": false,
      "over_receipt_pct": 10.0,
      "error": "Over-receipt not allowed. Ordered: 100, Total after receipt: 110"
    }

Scenario: Allow over-receipt within tolerance
  Given warehouse_settings.allow_over_receipt = true
  And warehouse_settings.over_receipt_tolerance_pct = 10.00
  And PO line with ordered_qty = 100, received_qty = 0
  When receiving 108 units (8% over)
  Then validation returns:
    {
      "allowed": true,
      "requires_approval": false,
      "over_receipt_pct": 8.0,
      "warning": "Over-receipt: 8% (within tolerance)"
    }

Scenario: Require approval when exceeds tolerance
  Given warehouse_settings.allow_over_receipt = true
  And warehouse_settings.over_receipt_tolerance_pct = 10.00
  And PO line with ordered_qty = 100, received_qty = 0
  When receiving 115 units (15% over)
  Then validation returns:
    {
      "allowed": false,
      "requires_approval": true,
      "over_receipt_pct": 15.0,
      "max_allowed_qty": 110,
      "error": "Over-receipt exceeds tolerance. Max: 110 (10%), Attempting: 115 (15%)",
      "approval_required": true
    }
```

### AC-4: Over-Receipt Approval Table

```gherkin
Scenario: Approval table schema
  Given database migration runs
  When schema is inspected
  Then over_receipt_approvals table has columns:
    | Column | Type | Nullable | Default |
    | id | UUID | NO | gen_random_uuid() |
    | org_id | UUID | NO | - |
    | po_id | UUID | NO | - |
    | po_line_id | UUID | NO | - |
    | product_id | UUID | NO | - |
    | ordered_qty | DECIMAL(15,4) | NO | - |
    | already_received_qty | DECIMAL(15,4) | NO | - |
    | requesting_qty | DECIMAL(15,4) | NO | - |
    | total_after_receipt | DECIMAL(15,4) | NO | - |
    | over_receipt_pct | NUMERIC(5,2) | NO | - |
    | tolerance_pct | NUMERIC(5,2) | NO | - |
    | reason | TEXT | YES | - |
    | status | TEXT | NO | 'pending' |
    | requested_by | UUID | NO | - |
    | requested_at | TIMESTAMPTZ | NO | NOW() |
    | reviewed_by | UUID | YES | - |
    | reviewed_at | TIMESTAMPTZ | YES | - |
    | review_notes | TEXT | YES | - |
  And CHECK constraint exists: status IN ('pending', 'approved', 'rejected')
  And FK constraints exist to organizations, purchase_orders, po_lines, products, users
```

### AC-5: Request Over-Receipt Approval

```gherkin
Scenario: Create approval request
  Given warehouse operator receiving PO with 15% over-receipt
  When POST /api/warehouse/over-receipt-approvals with:
    {
      "po_id": "{po_uuid}",
      "po_line_id": "{line_uuid}",
      "requesting_qty": 115,
      "reason": "Supplier shipped extra units"
    }
  Then response status = 201 Created
  And approval record created with:
    | Field | Value |
    | status | pending |
    | requested_by | {current_user} |
    | over_receipt_pct | 15.0 |
  And notification sent to warehouse managers
  And response includes approval_id

Scenario: Cannot create duplicate pending approval
  Given pending approval exists for po_line_id
  When creating another approval for same po_line_id
  Then response status = 400 Bad Request
  And error = "Pending approval already exists for this PO line"

Scenario: Approval request requires reason
  Given creating approval request
  When reason field is empty or null
  Then response status = 400 Bad Request
  And error = "Reason is required for over-receipt approval"
```

### AC-6: Approve Over-Receipt

```gherkin
Scenario: Manager approves over-receipt
  Given user with role 'warehouse_manager'
  And pending approval exists with id = {approval_uuid}
  When POST /api/warehouse/over-receipt-approvals/{approval_uuid}/approve with:
    {
      "review_notes": "Accepted supplier overage"
    }
  Then approval status updated to 'approved'
  And reviewed_by = {current_user}
  And reviewed_at = NOW()
  And requester notified of approval
  And GRN can now proceed with over-receipt

Scenario: Non-manager cannot approve
  Given user with role 'warehouse_operator'
  And pending approval exists
  When attempting to approve
  Then response status = 403 Forbidden
  And error = "Only warehouse managers can approve over-receipts"

Scenario: Cannot approve already reviewed request
  Given approval with status = 'approved'
  When attempting to approve again
  Then response status = 400 Bad Request
  And error = "Approval request already reviewed"
```

### AC-7: Reject Over-Receipt

```gherkin
Scenario: Manager rejects over-receipt
  Given user with role 'warehouse_manager'
  And pending approval exists with id = {approval_uuid}
  When POST /api/warehouse/over-receipt-approvals/{approval_uuid}/reject with:
    {
      "review_notes": "Quantity discrepancy too large, return excess to supplier"
    }
  Then approval status updated to 'rejected'
  And reviewed_by = {current_user}
  And reviewed_at = NOW()
  And requester notified of rejection
  And GRN cannot proceed with current quantities

Scenario: Rejection requires review notes
  Given manager rejecting approval
  When review_notes is empty
  Then response status = 400 Bad Request
  And error = "Review notes required for rejection"
```

### AC-8: Desktop UI - Over-Receipt Warning (WH-FR-029)

```gherkin
Scenario: Display inline over-receipt warning
  Given user in GRN wizard Step 3 (Enter Details)
  And receiving 108 units on line with ordered_qty = 100 (8% over, within tolerance)
  Then inline warning displayed next to receive qty input:
    | Icon | Message |
    | Warning (yellow) | "Over-receipt: 8% (within 10% tolerance)" |
  And receive qty input border highlighted in yellow
  And user can proceed without approval

Scenario: Display over-tolerance error requiring approval
  Given user in GRN wizard Step 3
  And receiving 115 units on line with ordered_qty = 100 (15% over, exceeds 10% tolerance)
  Then inline error displayed:
    | Icon | Message |
    | Error (red) | "Over-receipt: 15% exceeds tolerance (10%). Max allowed: 110 units. Approval required." |
  And "Request Approval" button displayed next to line
  And "Confirm Receipt" button disabled

Scenario: Request approval from wizard
  Given over-tolerance error displayed on line
  When clicking "Request Approval" button
  Then approval modal opens with:
    | Field | Value |
    | PO Line | Product name, ordered qty, receiving qty |
    | Over-Receipt % | 15% |
    | Tolerance | 10% |
    | Reason | Text area (required) |
  And "Submit Approval Request" button

Scenario: Submit approval request from modal
  Given approval modal open
  When entering reason "Supplier shipped full pallet instead of partial"
  And clicking "Submit Approval Request"
  Then approval request created
  And modal shows pending status:
    "Approval request submitted. A warehouse manager will review shortly."
  And user can either:
    - Wait for approval (auto-refresh status)
    - Save as draft and return later
    - Cancel and reduce quantity
```

### AC-9: Desktop UI - Approval Management Page

```gherkin
Scenario: View pending approvals
  Given user with role 'warehouse_manager'
  When navigating to /warehouse/approvals
  Then DataTable displays pending approvals with columns:
    | Column | Description |
    | Request Date | Timestamp of request |
    | PO Number | Link to PO |
    | Product | Product name |
    | Ordered | Ordered quantity |
    | Receiving | Attempting quantity |
    | Over % | Over-receipt percentage |
    | Requested By | User name |
    | Reason | First 50 chars |
    | Actions | Approve / Reject buttons |
  And filters available: Status, Date Range, Requester

Scenario: Approve from approval list
  Given manager viewing pending approval
  When clicking "Approve" button
  Then approval modal opens with:
    | Field | Content |
    | Details | Full approval details |
    | Review Notes | Text area |
    | Actions | Approve / Cancel buttons |
  And clicking "Approve" updates status
  And row removed from pending list

Scenario: Reject from approval list
  Given manager viewing pending approval
  When clicking "Reject" button
  Then rejection modal opens
  And review notes required
  And clicking "Reject" updates status
```

### AC-10: Integration with GRN Workflow

```gherkin
Scenario: GRN validation checks for approved over-receipt
  Given over-receipt approval exists with status = 'approved' for po_line_id
  When creating GRN with over-tolerance quantity
  Then validation passes
  And GRN created successfully
  And grn_items.over_receipt_approval_id = {approval_uuid}

Scenario: GRN validation blocks unapproved over-receipt
  Given no approval exists for po_line_id
  When creating GRN with over-tolerance quantity
  Then response status = 400 Bad Request
  And error = "Over-receipt requires approval. Request approval first."

Scenario: GRN validation blocks rejected over-receipt
  Given over-receipt approval exists with status = 'rejected'
  When creating GRN with over-tolerance quantity
  Then response status = 400 Bad Request
  And error = "Over-receipt approval was rejected. Reduce quantity or create new approval."
```

### AC-11: Audit Trail for Over-Receipt (WH-FR-029)

```gherkin
Scenario: Log over-receipt within tolerance
  Given receiving with 8% over-receipt (within tolerance)
  When GRN completed
  Then audit log records:
    | Field | Value |
    | action | over_receipt_within_tolerance |
    | grn_id | {uuid} |
    | po_line_id | {uuid} |
    | over_receipt_pct | 8.0 |
    | tolerance_pct | 10.0 |
    | user_id | {current_user} |

Scenario: Log over-receipt approval requested
  When approval request created
  Then audit log records:
    | action | over_receipt_approval_requested |
    | approval_id | {uuid} |
    | requested_by | {user} |
    | over_receipt_pct | 15.0 |

Scenario: Log over-receipt approval decision
  When approval approved or rejected
  Then audit log records:
    | action | over_receipt_approval_{status} |
    | approval_id | {uuid} |
    | reviewed_by | {manager} |
    | status | approved/rejected |
```

### AC-12: RLS Policy Enforcement

```gherkin
Scenario: Org isolation on approval list
  Given User A from Org A and User B from Org B
  And approvals exist in both orgs
  When User A requests GET /api/warehouse/over-receipt-approvals
  Then only Org A approvals returned

Scenario: Cannot approve approval from different org
  Given User A from Org A
  And approval belongs to Org B
  When User A attempts to approve
  Then 404 Not Found returned
```

### AC-13: Performance Requirements

```gherkin
Scenario: Validation performance
  Given PO with 10 lines
  When validating over-receipt for all lines
  Then response time < 200ms

Scenario: Approval list performance
  Given 500 approval requests in org
  When loading approval list with pagination
  Then response time < 500ms
```

---

## Technical Specification

### Database Schema

```sql
-- =============================================================================
-- Over-Receipt Approvals Table
-- =============================================================================

CREATE TABLE over_receipt_approvals (
  -- Identity
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,

  -- PO Reference
  po_id UUID NOT NULL REFERENCES purchase_orders(id),
  po_line_id UUID NOT NULL REFERENCES purchase_order_lines(id),
  product_id UUID NOT NULL REFERENCES products(id),

  -- Quantities
  ordered_qty DECIMAL(15,4) NOT NULL,
  already_received_qty DECIMAL(15,4) NOT NULL DEFAULT 0,
  requesting_qty DECIMAL(15,4) NOT NULL,
  total_after_receipt DECIMAL(15,4) NOT NULL,  -- already_received + requesting

  -- Over-Receipt Calculation
  over_receipt_pct NUMERIC(5,2) NOT NULL,
  tolerance_pct NUMERIC(5,2) NOT NULL,           -- Tolerance at time of request

  -- Request Details
  reason TEXT NOT NULL,
  status TEXT NOT NULL DEFAULT 'pending'
    CHECK (status IN ('pending', 'approved', 'rejected')),

  -- Audit
  requested_by UUID NOT NULL REFERENCES users(id),
  requested_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  reviewed_by UUID REFERENCES users(id),
  reviewed_at TIMESTAMPTZ,
  review_notes TEXT,

  -- Constraints
  CONSTRAINT over_receipt_qty_positive CHECK (requesting_qty > 0),
  CONSTRAINT total_exceeds_ordered CHECK (total_after_receipt > ordered_qty)
);

-- =============================================================================
-- Add over_receipt_approval_id to grn_items
-- =============================================================================

ALTER TABLE grn_items
ADD COLUMN over_receipt_approval_id UUID REFERENCES over_receipt_approvals(id);

-- =============================================================================
-- Add settings columns to warehouse_settings
-- =============================================================================

ALTER TABLE warehouse_settings
ADD COLUMN allow_over_receipt BOOLEAN NOT NULL DEFAULT false,
ADD COLUMN over_receipt_tolerance_pct NUMERIC(5,2) NOT NULL DEFAULT 0.00
  CHECK (over_receipt_tolerance_pct >= 0 AND over_receipt_tolerance_pct <= 100);

-- =============================================================================
-- Indexes
-- =============================================================================

CREATE INDEX idx_over_receipt_org_status ON over_receipt_approvals(org_id, status);
CREATE INDEX idx_over_receipt_po_line ON over_receipt_approvals(po_line_id);
CREATE INDEX idx_over_receipt_requested_at ON over_receipt_approvals(requested_at DESC);
CREATE INDEX idx_over_receipt_requested_by ON over_receipt_approvals(requested_by);

-- =============================================================================
-- RLS Policies
-- =============================================================================

ALTER TABLE over_receipt_approvals ENABLE ROW LEVEL SECURITY;

CREATE POLICY "over_receipt_select_org" ON over_receipt_approvals
FOR SELECT TO authenticated
USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

CREATE POLICY "over_receipt_insert_org" ON over_receipt_approvals
FOR INSERT TO authenticated
WITH CHECK (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  AND requested_by = auth.uid()
);

CREATE POLICY "over_receipt_update_org" ON over_receipt_approvals
FOR UPDATE TO authenticated
USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()))
WITH CHECK (
  -- Only managers can update (approve/reject)
  EXISTS (
    SELECT 1 FROM user_roles
    WHERE user_id = auth.uid()
    AND role_name IN ('warehouse_manager', 'admin')
  )
);
```

### API Endpoints

```
# Over-Receipt Validation
POST   /api/warehouse/grns/validate-over-receipt   - Validate single line over-receipt

# Over-Receipt Approvals
GET    /api/warehouse/over-receipt-approvals       - List approvals (filterable)
POST   /api/warehouse/over-receipt-approvals       - Create approval request
GET    /api/warehouse/over-receipt-approvals/:id   - Get approval details
POST   /api/warehouse/over-receipt-approvals/:id/approve  - Approve request
POST   /api/warehouse/over-receipt-approvals/:id/reject   - Reject request
```

**POST /api/warehouse/grns/validate-over-receipt Request Body:**

```typescript
interface ValidateOverReceiptRequest {
  po_line_id: string;            // UUID
  receiving_qty: number;          // Quantity attempting to receive
}
```

**POST /api/warehouse/grns/validate-over-receipt Response:**

```typescript
interface ValidateOverReceiptResponse {
  allowed: boolean;               // Can proceed without approval
  requires_approval: boolean;     // Over tolerance, needs approval
  over_receipt_pct: number;       // Calculated percentage
  max_allowed_qty?: number;       // Max within tolerance
  error?: string;                 // Error message if not allowed
  warning?: string;               // Warning if within tolerance
  approval?: {
    id: string;                   // Existing approval ID if found
    status: string;               // approved/rejected/pending
  };
}
```

**POST /api/warehouse/over-receipt-approvals Request Body:**

```typescript
interface CreateOverReceiptApprovalRequest {
  po_id: string;
  po_line_id: string;
  requesting_qty: number;
  reason: string;                 // Required
}
```

**POST /api/warehouse/over-receipt-approvals/:id/approve Request Body:**

```typescript
interface ApproveOverReceiptRequest {
  review_notes?: string;
}
```

**POST /api/warehouse/over-receipt-approvals/:id/reject Request Body:**

```typescript
interface RejectOverReceiptRequest {
  review_notes: string;           // Required for rejection
}
```

### Service Layer

```typescript
// lib/services/over-receipt-service.ts

export interface OverReceiptValidationResult {
  allowed: boolean;
  requiresApproval: boolean;
  overReceiptPct: number;
  maxAllowedQty?: number;
  error?: string;
  warning?: string;
  existingApproval?: {
    id: string;
    status: 'pending' | 'approved' | 'rejected';
  };
}

export interface CreateApprovalInput {
  poId: string;
  poLineId: string;
  requestingQty: number;
  reason: string;
}

export interface ReviewApprovalInput {
  approvalId: string;
  reviewNotes?: string;
}

export class OverReceiptService {
  /**
   * Validate over-receipt for a PO line
   * - Calculates over-receipt percentage
   * - Checks against warehouse settings
   * - Checks for existing approvals
   */
  static async validateOverReceipt(
    poLineId: string,
    receivingQty: number
  ): Promise<OverReceiptValidationResult>;

  /**
   * Request approval for over-tolerance receipt
   * - Creates approval record
   * - Sends notification to managers
   * - Returns approval ID
   */
  static async requestApproval(
    input: CreateApprovalInput
  ): Promise<OverReceiptApproval>;

  /**
   * Approve over-receipt request (manager only)
   * - Updates status to 'approved'
   * - Records reviewer and timestamp
   * - Notifies requester
   */
  static async approveRequest(
    input: ReviewApprovalInput
  ): Promise<OverReceiptApproval>;

  /**
   * Reject over-receipt request (manager only)
   * - Updates status to 'rejected'
   * - Records reviewer and timestamp
   * - Notifies requester
   */
  static async rejectRequest(
    input: ReviewApprovalInput
  ): Promise<OverReceiptApproval>;

  /**
   * List approvals with filtering
   */
  static async list(
    params: ApprovalListParams
  ): Promise<PaginatedResult<OverReceiptApproval>>;

  /**
   * Get approval by ID
   */
  static async getById(id: string): Promise<OverReceiptApproval | null>;

  /**
   * Check if user can approve (is manager)
   */
  static async canApprove(userId: string): Promise<boolean>;

  /**
   * Get pending approval for PO line
   */
  static async getPendingApprovalForLine(
    poLineId: string
  ): Promise<OverReceiptApproval | null>;
}
```

### Validation Schema (Zod)

```typescript
// lib/validation/over-receipt.ts
import { z } from 'zod';

export const validateOverReceiptSchema = z.object({
  po_line_id: z.string().uuid("Invalid PO line ID"),
  receiving_qty: z.number()
    .positive("Receiving quantity must be positive")
    .max(999999999, "Quantity too large"),
});

export const createOverReceiptApprovalSchema = z.object({
  po_id: z.string().uuid("Invalid PO ID"),
  po_line_id: z.string().uuid("Invalid PO line ID"),
  requesting_qty: z.number()
    .positive("Requesting quantity must be positive")
    .max(999999999, "Quantity too large"),
  reason: z.string()
    .min(10, "Reason must be at least 10 characters")
    .max(1000, "Reason max 1000 characters"),
});

export const reviewOverReceiptApprovalSchema = z.object({
  review_notes: z.string()
    .max(1000, "Review notes max 1000 characters")
    .optional(),
});

export const rejectOverReceiptApprovalSchema = z.object({
  review_notes: z.string()
    .min(10, "Review notes required for rejection (min 10 characters)")
    .max(1000, "Review notes max 1000 characters"),
});

export const approvalListQuerySchema = z.object({
  status: z.enum(['pending', 'approved', 'rejected']).optional(),
  po_id: z.string().uuid().optional(),
  requested_by: z.string().uuid().optional(),
  date_from: z.string().optional(),
  date_to: z.string().optional(),
  sort: z.enum(['requested_at', 'over_receipt_pct']).default('requested_at'),
  order: z.enum(['asc', 'desc']).default('desc'),
  page: z.coerce.number().int().positive().default(1),
  limit: z.coerce.number().int().min(1).max(100).default(50),
});

export type ValidateOverReceiptInput = z.infer<typeof validateOverReceiptSchema>;
export type CreateOverReceiptApprovalInput = z.infer<typeof createOverReceiptApprovalSchema>;
export type ApprovalListQueryParams = z.infer<typeof approvalListQuerySchema>;
```

---

## UI Components

```
app/(authenticated)/warehouse/
  settings/
    page.tsx                                 -- Warehouse settings (add over-receipt section)
  approvals/
    page.tsx                                 -- Approval list page (managers)
    [id]/
      page.tsx                               -- Approval detail page

components/warehouse/over-receipt/
  OverReceiptWarning.tsx                     -- Inline warning banner (yellow)
  OverReceiptError.tsx                       -- Inline error banner (red)
  OverReceiptApprovalModal.tsx               -- Request approval modal
  OverReceiptApprovalForm.tsx                -- Approval request form
  PendingApprovalStatus.tsx                  -- Pending approval status display
  ApprovalDataTable.tsx                      -- Manager approval list table
  ApprovalReviewModal.tsx                    -- Approve/reject modal
  ApprovalDetailPanel.tsx                    -- Approval detail view

components/warehouse/settings/
  OverReceiptSettings.tsx                    -- Over-receipt settings section
```

---

## Key Business Rules

1. **Tolerance Range**: Over-receipt tolerance must be between 0-100%
2. **Validation Hierarchy**:
   - If `allow_over_receipt = false`: Block all over-receipt
   - If `allow_over_receipt = true` and within tolerance: Allow with warning
   - If `allow_over_receipt = true` and exceeds tolerance: Require approval
3. **Approval Requirement**: Only warehouse managers can approve/reject
4. **Single Pending Approval**: Only one pending approval per PO line at a time
5. **Approval Expiry**: Approvals valid for the specific PO line only
6. **GRN Integration**: GRN validation checks for approved over-receipt before creating
7. **Audit Trail**: All over-receipt events logged for compliance
8. **Notification**: Managers notified of pending approvals, requesters notified of decisions

---

## Deliverables

### Database
- [ ] Migration: Add `allow_over_receipt`, `over_receipt_tolerance_pct` to `warehouse_settings`
- [ ] Migration: Create `over_receipt_approvals` table
- [ ] Migration: Add `over_receipt_approval_id` to `grn_items`
- [ ] RLS policies for `over_receipt_approvals`
- [ ] Performance indexes on approvals table

### API Routes
- [ ] `POST /api/warehouse/grns/validate-over-receipt` - Validation endpoint
- [ ] `GET /api/warehouse/over-receipt-approvals` - List approvals
- [ ] `POST /api/warehouse/over-receipt-approvals` - Create approval
- [ ] `GET /api/warehouse/over-receipt-approvals/:id` - Get detail
- [ ] `POST /api/warehouse/over-receipt-approvals/:id/approve` - Approve
- [ ] `POST /api/warehouse/over-receipt-approvals/:id/reject` - Reject

### Service Layer
- [ ] `OverReceiptService.validateOverReceipt()` - Validation logic
- [ ] `OverReceiptService.requestApproval()` - Create approval
- [ ] `OverReceiptService.approveRequest()` - Approve
- [ ] `OverReceiptService.rejectRequest()` - Reject
- [ ] `OverReceiptService.list()` - List with filters
- [ ] `OverReceiptService.getById()` - Get detail
- [ ] `OverReceiptService.canApprove()` - Permission check
- [ ] `OverReceiptService.getPendingApprovalForLine()` - Check existing

### Validation
- [ ] `validateOverReceiptSchema`
- [ ] `createOverReceiptApprovalSchema`
- [ ] `reviewOverReceiptApprovalSchema`
- [ ] `rejectOverReceiptApprovalSchema`
- [ ] `approvalListQuerySchema`

### Frontend
- [ ] Warehouse settings UI for over-receipt configuration
- [ ] Over-receipt warning component (inline, yellow)
- [ ] Over-receipt error component (inline, red)
- [ ] Approval request modal
- [ ] Pending approval status display
- [ ] Manager approval list page
- [ ] Approval review modal (approve/reject)

### Integration
- [ ] Update `GRNService.createFromPO()` to check approvals
- [ ] Update GRN wizard to show warnings/errors
- [ ] Add "Request Approval" workflow to wizard

### Tests
- [ ] Unit tests: Over-receipt service methods (>80% coverage)
- [ ] Integration tests: All API endpoints
- [ ] Validation tests: Tolerance calculations
- [ ] Permission tests: Manager-only approval
- [ ] RLS tests: Multi-tenancy isolation
- [ ] E2E: Full approval workflow

---

## Test Cases

### Unit Tests

**File:** `__tests__/unit/services/over-receipt-service.test.ts`

| Test Case | Description |
|-----------|-------------|
| `validateOverReceipt()` blocks when not allowed | allow_over_receipt = false |
| `validateOverReceipt()` allows within tolerance | 8% over, 10% tolerance |
| `validateOverReceipt()` requires approval over tolerance | 15% over, 10% tolerance |
| `validateOverReceipt()` calculates percentage correctly | Math verified |
| `validateOverReceipt()` finds existing pending approval | Returns approval ID |
| `validateOverReceipt()` finds existing approved approval | Allows receipt |
| `requestApproval()` creates approval record | Record created |
| `requestApproval()` prevents duplicate pending | Error returned |
| `approveRequest()` updates status correctly | Status = approved |
| `approveRequest()` records reviewer and timestamp | Audit fields populated |
| `rejectRequest()` requires review notes | Validation enforced |
| `canApprove()` returns true for manager | Role check |
| `canApprove()` returns false for operator | Role check |

### Integration Tests

**File:** `__tests__/integration/api/warehouse/over-receipt-approvals.test.ts`

| Test Case | Description |
|-----------|-------------|
| `POST /validate-over-receipt` returns correct validation | All scenarios |
| `POST /over-receipt-approvals` creates approval | Success |
| `POST /over-receipt-approvals` prevents duplicate | 400 error |
| `POST /:id/approve` approves request | Manager only |
| `POST /:id/approve` blocks non-manager | 403 error |
| `POST /:id/reject` rejects request | Review notes required |
| `GET /over-receipt-approvals` returns paginated list | Filtering works |
| RLS enforces org isolation | Cross-tenant blocked |

### E2E Tests

**File:** `__tests__/e2e/warehouse/over-receipt-approval.spec.ts`

| Test Case | Description |
|-----------|-------------|
| Complete over-receipt approval workflow | Request -> Approve -> GRN |
| Manager approval list shows pending | List displays correctly |
| Approval request with reason | Modal works |
| Rejection workflow | Reject -> Error on GRN |

---

## Definition of Done

### Database
- [ ] `warehouse_settings` has over-receipt columns
- [ ] `over_receipt_approvals` table created with all columns
- [ ] `grn_items.over_receipt_approval_id` added
- [ ] RLS policies enforce org isolation and manager-only updates
- [ ] Indexes created for performance

### API
- [ ] All endpoints return correct HTTP status codes
- [ ] Validation errors return 400 with detailed messages
- [ ] Permission checks enforce manager-only approval
- [ ] Cross-tenant access returns 404
- [ ] Response times:
  - Validation: < 200ms
  - Approval list: < 500ms
  - Approve/reject: < 300ms

### Service
- [ ] `validateOverReceipt()` handles all scenarios correctly
- [ ] Approval workflow creates/updates records correctly
- [ ] Permission checks work for manager role
- [ ] Integration with GRN service verified

### Frontend
- [ ] Settings UI allows configuring tolerance
- [ ] Warnings displayed for within-tolerance over-receipt
- [ ] Errors displayed for over-tolerance
- [ ] Approval request modal works
- [ ] Manager approval page functional
- [ ] Approve/reject workflow works

### Testing
- [ ] Unit tests: >80% coverage on service
- [ ] Integration tests: All endpoints covered
- [ ] Permission tests: Manager-only verified
- [ ] RLS tests: Multi-tenancy verified
- [ ] E2E tests: Full workflow passing

---

## Future Phases (Not in This Story)

### Phase 2+
- **Multi-Level Approvals**: Senior manager approval for very high percentages
- **Auto-Approval Rules**: Trusted suppliers get higher tolerance
- **Supplier Scorecarding**: Track over/under receipt by supplier
- **Over-Receipt Analytics**: Dashboard showing over-receipt trends
- **Batch Approval**: Approve multiple requests at once
- **Email Notifications**: Email alerts for approval requests

---

## Risk Assessment

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Permission logic gaps | MEDIUM | LOW | Thorough role-based testing |
| Duplicate approval requests | LOW | MEDIUM | Unique constraint on pending approvals |
| Approval state race conditions | MEDIUM | LOW | Database-level locking |
| Manager notification delivery | MEDIUM | MEDIUM | Retry logic, audit trail |
| Complex tolerance calculations | LOW | LOW | Comprehensive test coverage |

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-12-16 | Initial story creation for over-receipt approval workflow | SONNET |
