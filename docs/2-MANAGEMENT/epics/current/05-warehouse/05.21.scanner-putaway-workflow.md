# 05.21 - Scanner Putaway Workflow

| Field | Value |
|-------|-------|
| **Story ID** | 05.21 |
| **Epic** | 05 - Warehouse |
| **Status** | Ready |
| **Phase** | Phase 2 (Scanner Workflows) |
| **Priority** | P0 |
| **Complexity** | M (Medium) |
| **Estimate** | 3-4 days |
| **Type** | Backend + Frontend (Mobile) |
| **Model** | OPUS |

---

## PRD References

| FR ID | Requirement | Priority | Coverage |
|-------|-------------|----------|----------|
| WH-FR-013 | Scanner Putaway (guided putaway to optimal location) | P0 | Full |
| WH-FR-019 | FIFO Enforcement (oldest stock first) | P1 | Full |
| WH-FR-020 | FEFO Enforcement (soonest expiry first) | P1 | Full |
| WH-FR-005 | Stock Moves (putaway move type) | P0 | Integrated |

**Primary PRD:** `docs/1-BASELINE/product/modules/warehouse.md`
**Architecture:** `docs/1-BASELINE/architecture/modules/warehouse.md`

---

## MVP Scope

### In Scope (This Story)

1. **Scanner Putaway Page (`/scanner/putaway`)**
   - Full-screen mobile-optimized layout
   - Step-by-step putaway workflow
   - Touch-optimized UI with large buttons (min 48x48dp)
   - Portrait and landscape orientation support

2. **Optimal Location Suggestion Algorithm**
   - FIFO zone logic (oldest stock together)
   - FEFO zone logic (soonest expiry together)
   - Product zone preference matching
   - Location capacity consideration
   - Suggestion with reason (e.g., "FIFO zone A", "Product zone: Cold Storage")

3. **Visual Feedback System**
   - Green checkmark when scanned location matches suggestion
   - Yellow warning when different location scanned with override option
   - Clear indication of suggested vs scanned location
   - Reason display for suggestion

4. **API Endpoints for Putaway Operations**
   - `POST /api/warehouse/scanner/putaway` - Complete putaway transaction
   - `GET /api/warehouse/scanner/putaway/suggest/:lpId` - Get optimal location suggestion
   - `POST /api/warehouse/scanner/putaway/validate` - Pre-validate putaway

5. **Audio/Visual Feedback Integration**
   - Success tone on matching location scan
   - Warning tone on different location scan (override allowed)
   - Confirmation chime on putaway completion
   - Haptic feedback on mobile devices

6. **Service Layer**
   - `ScannerPutawayService.suggestLocation()` - Calculate optimal putaway location
   - `ScannerPutawayService.processPutaway()` - Execute putaway transaction
   - `ScannerPutawayService.validatePutaway()` - Pre-validate putaway
   - Integration with `StockMoveService` (Story 05.16)
   - Integration with `FifoFefoService` (Story 05.3)

7. **Zod Validation Schemas**
   - Scanner putaway request schema
   - Location suggestion response schema
   - Putaway validation schema

### Out of Scope (Other Stories)

| Feature | Deferred To | Reason |
|---------|-------------|--------|
| Offline Queue Support | 05.21b (Phase 3) | Requires local storage, sync logic |
| Location Capacity Management | 05.34 | Advanced capacity tracking |
| Zone Management | 05.35 | Zone CRUD separate |
| Scanner Login/Session | 05.16 | Separate authentication story |
| Scanner Move | 05.20 | Different workflow |
| Scanner Receive | 05.19 | Different workflow |

---

## Dependencies

| Dependency | Story/Epic | Type | Status | Notes |
|------------|------------|------|--------|-------|
| 05.3 | FIFO/FEFO Logic | HARD | Ready | Uses picking algorithms for location suggestion |
| 05.16 | Stock Moves | HARD | Ready | Creates putaway move type records |
| 05.1 | LP Table + CRUD | HARD | Ready | Queries LP details |
| 05.0 | Warehouse Settings | HARD | Ready | Reads enable_fifo, enable_fefo settings |
| 01.8 | Warehouses CRUD | SOFT | Ready | Warehouse context |
| 01.9 | Locations CRUD | HARD | Ready | Location lookup, zone info |

**Dependents (What This Unblocks):**
- Scanner workflow polish stories
- Advanced putaway optimization (Phase 3)

---

## Goal

Enable warehouse operators to efficiently putaway LPs to optimal storage locations using guided suggestions based on FIFO/FEFO rules and product zones, with clear visual feedback for matching vs override scenarios.

---

## User Story

As a **Warehouse Operator using a handheld scanner**, I want to **receive guided putaway suggestions showing the optimal storage location based on FIFO/FEFO rules** so that **I can efficiently organize inventory while maintaining proper stock rotation and zone compliance**.

---

## Acceptance Criteria (Given/When/Then)

### AC-1: Scanner Putaway Page Layout (WH-FR-013)

```gherkin
Scenario: Scanner putaway page renders with mobile-optimized layout
  Given scanner user is authenticated
  When user navigates to /scanner/putaway
  Then full-screen layout displays without browser chrome
  And header shows "Putaway" title with back button
  And current step indicator shows progress (1 of 3)
  And main content area fills available space
  And action buttons anchored to bottom of screen
  And all touch targets are minimum 48x48 pixels

Scenario: Page adapts to device orientation
  Given user on /scanner/putaway
  When device rotates to landscape
  Then layout adjusts to horizontal orientation
  And barcode scan area remains easily accessible
```

### AC-2: Step 1 - Scan LP (WH-FR-013)

```gherkin
Scenario: Scan LP to start putaway
  Given user on Step 1 "Scan LP"
  When step loads
  Then "Scan LP Barcode" button prominently displayed
  And LP number input field available for manual entry
  And instruction text shows "Scan the License Plate to putaway"

Scenario: Valid LP barcode scanned
  Given camera scanner active
  When LP barcode "LP00000001" scanned
  Then system validates LP exists and is available in <200ms
  And success tone plays (200ms, high pitch)
  And green checkmark animation displays
  And LP details display: Product, Qty, Current Location, Expiry
  And workflow advances to Step 2

Scenario: Invalid LP barcode scanned
  Given camera scanner active
  When unrecognized barcode scanned
  Then error beep plays (300ms, low pitch)
  And red X animation displays
  And error message shows "LP not found: {barcode}"
  And scanner remains active for retry

Scenario: LP not available for putaway
  Given camera scanner active
  When LP barcode scanned for consumed/blocked LP
  Then error beep plays
  And message shows "LP not available for putaway (status: {status})"
  And scanner remains active for retry
```

### AC-3: Step 2 - View Suggestion and Scan Location (WH-FR-013)

```gherkin
Scenario: System suggests optimal location
  Given LP scanned with product_id and expiry_date
  And warehouse_settings.enable_fifo = true
  When Step 2 loads
  Then system calculates optimal putaway location in <300ms
  And suggested location displays prominently:
    - Location code (e.g., "A-01-02")
    - Aisle and rack position
    - Zone name (e.g., "Cold Storage")
    - Suggestion reason (e.g., "FIFO: Same product oldest first")
  And "Scan Location" button displayed

Scenario: FIFO suggestion logic
  Given warehouse_settings.enable_fifo = true
  And warehouse_settings.enable_fefo = false
  And existing LP-001 for Product A in Zone A (created 2025-12-01)
  When LP-002 for Product A being put away (created 2025-12-15)
  Then system suggests location in Zone A (same zone as oldest stock)
  And reason shows "FIFO: Place near oldest stock"

Scenario: FEFO suggestion logic
  Given warehouse_settings.enable_fefo = true
  And existing LP-001 for Product A with expiry 2026-03-01 in Zone B
  When LP-002 for Product A with expiry 2026-06-01 being put away
  Then system suggests location in Zone B (same zone as soonest expiry)
  And reason shows "FEFO: Place with similar expiry dates"

Scenario: Product zone preference
  Given product has preferred_zone_id = Zone C
  And no existing stock of same product
  When LP being put away
  Then system suggests location in Zone C
  And reason shows "Product zone: {zone_name}"

Scenario: Suggested location scanned - match
  Given suggested location is "A-01-02"
  When user scans location barcode "A-01-02"
  Then system recognizes match
  And green checkmark animation displays (large, prominent)
  And success tone plays (200ms)
  And text shows "Location matches suggestion"
  And workflow advances to Step 3 (Confirm)

Scenario: Different location scanned - override warning
  Given suggested location is "A-01-02"
  When user scans different location "B-03-05"
  Then system detects mismatch
  And yellow warning icon displays
  And warning tone plays (distinctive from error)
  And message shows "Different from suggested location"
  And warning details: "Suggested: A-01-02 (FIFO zone A)"
  And "Use This Location Anyway" button displays (yellow/amber)
  And "Scan Suggested Location" button displays (green)

Scenario: User overrides suggestion
  Given yellow warning displayed for different location
  When user taps "Use This Location Anyway"
  Then system accepts override
  And audit log records putaway_override = true
  And workflow advances to Step 3 (Confirm)
  And confirmation shows selected location with warning badge

Scenario: User returns to scan suggested
  Given yellow warning displayed
  When user taps "Scan Suggested Location"
  Then scanner reactivates
  And suggested location remains highlighted
```

### AC-4: Step 3 - Confirm Putaway (WH-FR-013)

```gherkin
Scenario: Confirm putaway summary displays
  Given location scanned (matching or override)
  When Step 3 loads
  Then confirmation summary displays:
    | Field | Value |
    | LP Number | LP00000001 |
    | Product | {product name} |
    | Quantity | 100 KG |
    | From Location | RECEIVING-01 |
    | To Location | A-01-02 |
    | Suggestion Match | Yes (green) / Override (yellow) |
  And large "Confirm Putaway" button at bottom (green)
  And "Cancel" button available

Scenario: Override confirmation includes warning
  Given user overrode suggested location
  When confirmation displays
  Then yellow warning banner shows:
    "You are placing LP in a different location than suggested"
  And original suggestion shown: "Suggested: A-01-02 (FIFO zone A)"
  And selected location shown: "Selected: B-03-05"
  And "Confirm Putaway" button shows (amber, not green)

Scenario: Successful putaway creates move record
  Given confirmation screen displayed
  When user taps "Confirm Putaway"
  Then POST /api/warehouse/scanner/putaway called
  And stock_move created with move_type='putaway'
  And LP.location_id updated to destination
  And confirmation chime plays (500ms)
  And success screen displays:
    - "Putaway Complete"
    - LP Number
    - New Location
    - Green checkmark animation
  And response time <500ms
```

### AC-5: Success Screen and Next Actions (WH-FR-013)

```gherkin
Scenario: Success screen displays
  Given putaway completed successfully
  When success screen shows
  Then displays:
    - Large green checkmark animation
    - "Putaway Complete" heading
    - LP Number: LP00000001
    - Location: A-01-02
    - Move Number: SM-2025-00042
  And action buttons available

Scenario: Continue putaway flow
  Given success screen displayed
  When user taps "Putaway Another"
  Then workflow returns to Step 1 (Scan LP)
  And scanner ready for next LP

Scenario: Return to scanner menu
  Given success screen displayed
  When user taps "Done"
  Then navigate to scanner dashboard
  And putaway logged in activity
```

### AC-6: Location Suggestion API (WH-FR-013)

```gherkin
Scenario: GET /api/warehouse/scanner/putaway/suggest/:lpId - Happy path
  Given LP exists with product_id and expiry_date
  And warehouse has enable_fifo = true
  When GET /api/warehouse/scanner/putaway/suggest/{lpId}
  Then response status = 200 OK
  And response includes:
    {
      "suggested_location": {
        "id": "uuid",
        "location_code": "A-01-02",
        "full_path": "Warehouse A / Zone Cold / A-01-02",
        "zone_name": "Cold Storage"
      },
      "reason": "FIFO: Place near oldest stock of same product",
      "reason_code": "fifo_zone",
      "alternatives": [
        { "location_code": "A-01-03", "reason": "Same zone, next available" }
      ],
      "strategy_used": "fifo"
    }
  And response time <300ms

Scenario: GET suggest - No available locations
  Given all locations in product zone at capacity
  When GET /api/warehouse/scanner/putaway/suggest/{lpId}
  Then response status = 200 OK
  And response includes:
    {
      "suggested_location": null,
      "reason": "No available locations in preferred zone",
      "alternatives": [
        { "location_code": "B-01-01", "reason": "Alternative zone" }
      ]
    }
  And UI displays "No available locations" with alternatives

Scenario: GET suggest - LP not found
  Given invalid LP ID
  When GET /api/warehouse/scanner/putaway/suggest/{invalidId}
  Then response status = 404 Not Found
  And error message = "LP not found"
```

### AC-7: Putaway API Endpoint (WH-FR-013)

```gherkin
Scenario: POST /api/warehouse/scanner/putaway - Happy path
  When POST /api/warehouse/scanner/putaway with:
    {
      "lp_id": "{lp_uuid}",
      "location_id": "{location_uuid}",
      "suggested_location_id": "{suggested_uuid}",
      "override": false
    }
  Then response status = 201 Created
  And response includes:
    {
      "stock_move": {
        "id": "uuid",
        "move_number": "SM-2025-00042",
        "move_type": "putaway"
      },
      "lp": {
        "id": "uuid",
        "lp_number": "LP00000001",
        "location_id": "{location_uuid}",
        "location_path": "Warehouse A / Zone Cold / A-01-02"
      },
      "override_applied": false
    }
  And response time <500ms

Scenario: POST /api/warehouse/scanner/putaway - With override
  When POST with override = true and different location
  Then response status = 201 Created
  And response includes override_applied = true
  And audit_log records putaway_override with reason

Scenario: POST /api/warehouse/scanner/putaway - LP not available
  When POST with LP.status = 'consumed'
  Then response status = 400 Bad Request
  And error message = "LP not available for putaway (status: consumed)"

Scenario: POST /api/warehouse/scanner/putaway - Location invalid
  When POST with inactive location
  Then response status = 400 Bad Request
  And error message = "Location not available"
```

### AC-8: Audio/Visual Feedback (WH-NFR)

```gherkin
Scenario: Match feedback
  Given user scans suggested location
  Then green checkmark animation (prominent, 80x80px)
  And success tone (880Hz, 200ms)
  And haptic success (short buzz 50ms)
  And background briefly flashes green

Scenario: Override warning feedback
  Given user scans different location
  Then yellow warning icon animation (prominent, 80x80px)
  And warning tone (440Hz, 300ms - distinctive)
  And haptic alert (double buzz)
  And background briefly flashes amber/yellow

Scenario: Error feedback
  Given invalid barcode scanned
  Then red X animation (64x64px)
  And error beep (220Hz, 300ms)
  And haptic error (triple short buzz)
  And background briefly flashes red
```

### AC-9: FIFO/FEFO Zone Logic (WH-FR-019, WH-FR-020)

```gherkin
Scenario: FIFO zone calculation
  Given enable_fifo = true, enable_fefo = false
  And existing LPs for Product A:
    - LP-001 in Zone A, created 2025-12-01 (oldest)
    - LP-002 in Zone B, created 2025-12-10
  When calculating suggestion for new LP of Product A
  Then suggest location in Zone A (where oldest stock is)
  And reason = "FIFO: Same zone as oldest stock"

Scenario: FEFO zone calculation
  Given enable_fefo = true
  And existing LPs for Product A:
    - LP-001 in Zone A, expiry 2026-03-01 (soonest)
    - LP-002 in Zone B, expiry 2026-06-01
  When calculating suggestion for new LP with expiry 2026-04-15
  Then suggest location in Zone A (where soonest expiry is)
  And reason = "FEFO: Same zone as soonest expiry"

Scenario: FEFO takes precedence over FIFO
  Given enable_fifo = true AND enable_fefo = true
  When calculating suggestion
  Then FEFO logic used (expiry-based)
  And reason includes "FEFO"

Scenario: No existing stock - use product zone
  Given no existing LPs for Product A in warehouse
  And product.preferred_zone_id = Zone C
  When calculating suggestion
  Then suggest location in Zone C
  And reason = "Product preferred zone"

Scenario: No preferred zone - use default receiving zone
  Given no existing stock and no preferred zone
  When calculating suggestion
  Then suggest location in default storage zone
  And reason = "Default storage zone"
```

### AC-10: Performance Requirements (WH-NFR)

```gherkin
Scenario: Page load performance
  Given user navigates to /scanner/putaway
  Then page renders within 1 second
  And interactive within 1.5 seconds

Scenario: LP scan response time
  Given camera scanner active
  When LP barcode decoded
  Then LP lookup completes within 200ms
  And feedback displays within 300ms total

Scenario: Location suggestion performance
  Given LP scanned
  When suggestion algorithm runs
  Then optimal location returned within 300ms
  And includes reason and alternatives

Scenario: Putaway submission performance
  Given user taps "Confirm Putaway"
  Then API call completes within 500ms
  And success feedback within 600ms total
```

### AC-11: RLS and Security (WH-NFR)

```gherkin
Scenario: Org isolation on LP lookup
  Given User A from Org A, User B from Org B
  And LP belongs to Org B
  When User A attempts to putaway LP
  Then 404 Not Found returned
  And no data exposed

Scenario: Location belongs to user's warehouse
  Given user assigned to Warehouse A
  And scanned location belongs to Warehouse B
  When validating putaway
  Then error "Location not in your assigned warehouse"
```

---

## Technical Specification

### Database

No new tables required. Uses existing tables:
- `license_plates` (from Story 05.1)
- `stock_moves` (from Story 05.16)
- `locations` (from Story 01.9)
- `warehouse_settings` (from Story 05.0)

### API Endpoints

```
# Scanner Putaway Endpoints
GET    /api/warehouse/scanner/putaway/suggest/:lpId   - Get optimal location suggestion
POST   /api/warehouse/scanner/putaway                 - Execute putaway
POST   /api/warehouse/scanner/putaway/validate        - Pre-validate putaway
```

**GET /api/warehouse/scanner/putaway/suggest/:lpId Response:**

```typescript
interface PutawaySuggestionResponse {
  suggested_location: {
    id: string;
    location_code: string;
    full_path: string;
    zone_id: string;
    zone_name: string;
    aisle: string | null;
    rack: string | null;
    level: string | null;
  } | null;
  reason: string;
  reason_code: 'fifo_zone' | 'fefo_zone' | 'product_zone' | 'default_zone' | 'no_preference';
  alternatives: {
    id: string;
    location_code: string;
    reason: string;
  }[];
  strategy_used: 'fifo' | 'fefo' | 'none';
  lp_details: {
    lp_number: string;
    product_name: string;
    quantity: number;
    uom: string;
    expiry_date: string | null;
    current_location: string;
  };
}
```

**POST /api/warehouse/scanner/putaway Request:**

```typescript
interface ScannerPutawayRequest {
  lp_id: string;                    // LP UUID
  location_id: string;              // Destination location UUID
  suggested_location_id?: string;   // Original suggestion UUID (for audit)
  override: boolean;                // True if different from suggestion
  override_reason?: string;         // Reason for override (optional)
}
```

**POST /api/warehouse/scanner/putaway Response:**

```typescript
interface ScannerPutawayResponse {
  stock_move: {
    id: string;
    move_number: string;
    move_type: 'putaway';
    from_location_id: string;
    to_location_id: string;
    quantity: number;
    status: 'completed';
  };
  lp: {
    id: string;
    lp_number: string;
    location_id: string;
    location_path: string;
  };
  override_applied: boolean;
  suggested_location_code?: string;
}
```

### Service Layer

```typescript
// lib/services/scanner-putaway-service.ts

export interface PutawaySuggestion {
  suggestedLocation: Location | null;
  reason: string;
  reasonCode: string;
  alternatives: Location[];
  strategyUsed: 'fifo' | 'fefo' | 'none';
}

export interface PutawayInput {
  lpId: string;
  locationId: string;
  suggestedLocationId?: string;
  override: boolean;
  overrideReason?: string;
}

export interface PutawayResult {
  stockMove: StockMove;
  lp: LicensePlate;
  overrideApplied: boolean;
}

export class ScannerPutawayService {
  /**
   * Calculate optimal putaway location for LP
   * Uses FIFO/FEFO zone logic and product zone preferences
   */
  static async suggestLocation(lpId: string): Promise<PutawaySuggestion>;

  /**
   * Execute putaway transaction
   * - Creates stock_move with move_type='putaway'
   * - Updates LP.location_id
   * - Records override in audit if applicable
   */
  static async processPutaway(input: PutawayInput): Promise<PutawayResult>;

  /**
   * Validate putaway before commit
   * Returns validation errors without creating records
   */
  static async validatePutaway(input: PutawayInput): Promise<{
    valid: boolean;
    errors: { field: string; message: string }[];
    warnings: { field: string; message: string }[];
  }>;

  /**
   * Get zone for existing product stock (FIFO/FEFO logic)
   * @internal
   */
  private static async getProductZone(
    productId: string,
    warehouseId: string,
    strategy: 'fifo' | 'fefo' | 'none'
  ): Promise<{ zoneId: string; reason: string } | null>;

  /**
   * Find available locations in zone
   * @internal
   */
  private static async findAvailableLocations(
    zoneId: string,
    warehouseId: string
  ): Promise<Location[]>;
}
```

### Validation Schema (Zod)

```typescript
// lib/validation/scanner-putaway.ts
import { z } from 'zod';

export const scannerPutawaySchema = z.object({
  lp_id: z.string().uuid("Invalid LP ID"),
  location_id: z.string().uuid("Invalid location ID"),
  suggested_location_id: z.string().uuid().optional().nullable(),
  override: z.boolean().default(false),
  override_reason: z.string()
    .max(500, "Override reason max 500 characters")
    .optional()
    .nullable(),
}).refine(
  (data) => {
    // If override is true and location differs from suggestion, reason is helpful
    return true; // Reason is optional but recommended
  }
);

export const putawaySuggestSchema = z.object({
  lp_id: z.string().uuid("Invalid LP ID"),
});

export const validatePutawaySchema = scannerPutawaySchema;

export type ScannerPutawayInput = z.infer<typeof scannerPutawaySchema>;
```

---

## UI Components

```
app/(authenticated)/scanner/
  putaway/
    page.tsx                              -- Scanner putaway main page

components/scanner/
  putaway/
    ScannerPutawayWizard.tsx              -- Step wizard container
    Step1ScanLP.tsx                       -- Step 1: Scan LP
    Step2ScanLocation.tsx                 -- Step 2: View suggestion, scan location
    Step3Confirm.tsx                      -- Step 3: Confirm putaway
    LocationSuggestion.tsx                -- Suggested location display
    LocationOverrideWarning.tsx           -- Yellow override warning
    PutawaySuccess.tsx                    -- Success screen

  shared/
    BarcodeScanner.tsx                    -- Camera barcode scanner (from 05.19)
    BarcodeScanButton.tsx                 -- Large scan trigger button (from 05.19)
    AudioFeedback.tsx                     -- Audio feedback manager (from 05.19)
    SuccessAnimation.tsx                  -- Green checkmark animation (from 05.19)
    WarningAnimation.tsx                  -- Yellow warning animation
    ErrorAnimation.tsx                    -- Red X animation (from 05.19)
    LargeTouchButton.tsx                  -- 48dp+ touch target button (from 05.19)
```

### Key Component: LocationSuggestion.tsx

```tsx
interface LocationSuggestionProps {
  suggestedLocation: {
    locationCode: string;
    fullPath: string;
    zoneName: string;
    aisle?: string;
    rack?: string;
  } | null;
  reason: string;
  alternatives: Array<{
    locationCode: string;
    reason: string;
  }>;
}

// Displays:
// +------------------------------------------+
// |    SUGGESTED LOCATION                    |
// |                                          |
// |    [ A-01-02 ]         (large, bold)     |
// |                                          |
// |    Cold Storage / Aisle A / Rack 01      |
// |                                          |
// |    Reason: FIFO - Same zone as oldest    |
// |            stock of this product         |
// |                                          |
// |    Alternatives:                         |
// |    - A-01-03 (next available in zone)    |
// |    - B-01-01 (alternative zone)          |
// +------------------------------------------+
```

### Key Component: LocationOverrideWarning.tsx

```tsx
interface LocationOverrideWarningProps {
  suggestedLocation: string;
  selectedLocation: string;
  reason: string;
  onUseSuggested: () => void;
  onOverride: () => void;
}

// Displays:
// +------------------------------------------+
// |  [!] DIFFERENT LOCATION SELECTED         |
// |                                          |
// |  Suggested: A-01-02 (FIFO zone A)        |
// |  Selected:  B-03-05                      |
// |                                          |
// |  [  Use This Location Anyway  ]  (amber) |
// |  [   Scan Suggested Location  ]  (green) |
// +------------------------------------------+
```

---

## Key Business Rules

1. **FIFO Zone Logic**: Place new LPs in same zone as oldest existing stock of same product
2. **FEFO Zone Logic**: Place new LPs in same zone as soonest-expiring existing stock
3. **FEFO Precedence**: When both enabled, FEFO takes precedence
4. **Product Zone**: If no existing stock, use product's preferred_zone_id
5. **Default Zone**: If no preference, use default storage zone
6. **Override Allowed**: User can override suggestion with warning (not blocking)
7. **Override Audit**: All overrides logged with suggested vs selected location
8. **LP Status**: Only LPs with status='available' can be put away
9. **Location Validation**: Destination must be active and in user's assigned warehouse
10. **Stock Move**: Creates stock_move with move_type='putaway'

---

## Deliverables

### API Routes
- [ ] `GET /api/warehouse/scanner/putaway/suggest/:lpId` - Location suggestion
- [ ] `POST /api/warehouse/scanner/putaway` - Execute putaway
- [ ] `POST /api/warehouse/scanner/putaway/validate` - Pre-validation

### Service Layer
- [ ] `ScannerPutawayService.suggestLocation()` - FIFO/FEFO zone logic
- [ ] `ScannerPutawayService.processPutaway()` - Transaction handler
- [ ] `ScannerPutawayService.validatePutaway()` - Pre-validation

### Validation
- [ ] `scannerPutawaySchema` - Putaway request validation
- [ ] `putawaySuggestSchema` - Suggestion request validation

### Frontend Components
- [ ] Scanner putaway page (`/scanner/putaway`)
- [ ] 3-step wizard component
- [ ] Location suggestion display
- [ ] Override warning component
- [ ] Success screen

### Audio/Visual Feedback
- [ ] Green checkmark for match (80x80px)
- [ ] Yellow warning for override (80x80px)
- [ ] Match tone (880Hz, 200ms)
- [ ] Warning tone (440Hz, 300ms)
- [ ] Haptic patterns for match/warning/error

### Tests
- [ ] Unit tests: Putaway service (>80% coverage)
- [ ] Unit tests: FIFO/FEFO zone logic
- [ ] Integration tests: All putaway API endpoints
- [ ] E2E: Full scanner putaway flow
- [ ] E2E: Override flow with warning
- [ ] RLS tests: Multi-tenancy isolation

---

## Test Cases

### Unit Tests

**File:** `__tests__/unit/services/scanner-putaway-service.test.ts`

| Test Case | Description |
|-----------|-------------|
| `suggestLocation()` FIFO - returns oldest stock zone | Zone matches oldest LP |
| `suggestLocation()` FEFO - returns soonest expiry zone | Zone matches soonest expiry |
| `suggestLocation()` FEFO precedence | FEFO overrides FIFO when both enabled |
| `suggestLocation()` product zone fallback | Uses preferred_zone when no existing stock |
| `suggestLocation()` default zone fallback | Uses default when no preference |
| `suggestLocation()` returns alternatives | At least 2 alternatives provided |
| `processPutaway()` creates stock move | Move type = 'putaway' |
| `processPutaway()` updates LP location | location_id updated correctly |
| `processPutaway()` records override | Audit includes override flag |
| `validatePutaway()` rejects unavailable LP | Status check works |
| `validatePutaway()` rejects inactive location | Location validation works |

### Integration Tests

**File:** `__tests__/integration/api/warehouse/scanner-putaway.test.ts`

| Test Case | Description |
|-----------|-------------|
| `GET suggest/:lpId` returns suggestion | 200 with location |
| `GET suggest/:lpId` includes reason | FIFO/FEFO reason present |
| `GET suggest/:lpId` includes alternatives | At least 1 alternative |
| `GET suggest/:lpId` LP not found returns 404 | Error handling |
| `POST putaway` creates stock move | 201 with move details |
| `POST putaway` updates LP location | LP reflects new location |
| `POST putaway` with override records audit | Override logged |
| `POST putaway` LP unavailable returns 400 | Validation error |
| `POST putaway` cross-org returns 404 | RLS enforced |
| Response times < 500ms | Performance check |

### E2E Tests

**File:** `__tests__/e2e/scanner/putaway.spec.ts`

| Test Case | Description |
|-----------|-------------|
| Full putaway flow - match | Steps 1-3, suggested location |
| Full putaway flow - override | Steps 1-3, different location with warning |
| Override warning displays correctly | Yellow banner, both buttons |
| Success screen with move number | Move created and shown |
| Continue flow after success | "Putaway Another" returns to Step 1 |
| Touch targets >= 48dp | Accessibility compliance |

---

## Definition of Done

### API
- [ ] All endpoints return correct HTTP status codes
- [ ] Validation errors return 400 with detailed messages
- [ ] Cross-tenant access returns 404 (RLS enforced)
- [ ] Response times:
  - Location suggestion: < 300ms
  - Putaway submission: < 500ms

### Service
- [ ] FIFO zone logic finds oldest stock zone correctly
- [ ] FEFO zone logic finds soonest expiry zone correctly
- [ ] FEFO takes precedence when both enabled
- [ ] Product zone fallback works
- [ ] Override flag recorded in audit
- [ ] Stock move created with move_type='putaway'

### Frontend
- [ ] Mobile-optimized full-screen layout
- [ ] All touch targets >= 48dp
- [ ] Location suggestion prominent display
- [ ] Override warning clear and actionable
- [ ] Green checkmark for match
- [ ] Yellow warning for override
- [ ] Audio feedback (match, warning, error)
- [ ] 3-step wizard navigation complete
- [ ] Error handling with retry

### Testing
- [ ] Unit tests: >80% coverage on service
- [ ] Integration tests: All endpoints covered
- [ ] E2E tests: Full flow passing
- [ ] Override flow tested
- [ ] FIFO/FEFO logic edge cases tested
- [ ] RLS tests: Multi-tenancy verified

---

## Future Phases (Not in This Story)

### Story 05.21b - Offline Queue Support (Phase 3)
- Local storage for offline putaways
- Queue management UI
- Background sync when online
- Conflict resolution

### Story 05.34 - Location Capacity
- Capacity-aware suggestions
- Block putaway to full locations
- Capacity warnings

### Story 05.35 - Zone Management
- Zone CRUD operations
- Zone-based putaway rules
- Zone capacity tracking

---

## Risk Assessment

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| FIFO/FEFO logic complexity | MEDIUM | MEDIUM | Reuse existing 05.3 algorithms |
| No existing stock for zone | LOW | MEDIUM | Product zone and default fallbacks |
| Override audit completeness | MEDIUM | LOW | Clear schema for override logging |
| Location capacity not checked | MEDIUM | HIGH | Defer to 05.34, allow all locations for now |
| Performance of zone query | MEDIUM | LOW | Index on (product_id, zone_id, created_at) |

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-01-15 | Initial story creation - guided putaway with FIFO/FEFO zone logic | ARCHITECT-AGENT |
