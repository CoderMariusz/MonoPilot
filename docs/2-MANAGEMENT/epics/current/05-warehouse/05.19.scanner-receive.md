# 05.19 - Scanner Receive (Mobile GRN)

| Field | Value |
|-------|-------|
| **Story ID** | 05.19 |
| **Epic** | 05 - Warehouse |
| **Status** | Ready |
| **Phase** | Phase 2 (Scanner Workflows) |
| **Priority** | P2 |
| **Complexity** | L (Large) |
| **Estimate** | 4-5 days |
| **Type** | Backend + Frontend (Mobile) |
| **Model** | OPUS |

---

## PRD References

| FR ID | Requirement | Priority | Coverage |
|-------|-------------|----------|----------|
| WH-FR-011 | Scanner Receive (mobile receive workflow) | P0 | Full |
| WH-FR-003 | GRN from PO (integrated mobile flow) | P0 | Full |
| WH-FR-001 | LP Creation (auto numbering on scan) | P0 | Integrated |
| WH-FR-009 | Batch Tracking (scanner entry) | P0 | Full |
| WH-FR-010 | Expiry Tracking (scanner entry) | P0 | Full |
| WH-FR-014 | Label Print (auto-print on receipt) | P1 | Integrated |

**Primary PRD:** `docs/1-BASELINE/product/modules/warehouse.md`
**Architecture:** `docs/1-BASELINE/architecture/modules/warehouse.md`

---

## MVP Scope

### In Scope (This Story)

1. **Scanner Receive Page (`/scanner/receive`)**
   - Full-screen mobile-optimized layout
   - Step-by-step receiving workflow
   - Touch-optimized UI with large buttons (min 48x48dp)
   - High contrast colors for warehouse lighting conditions
   - Portrait and landscape orientation support

2. **Barcode Scanning Integration**
   - PO/TO barcode scanning to select source
   - Product barcode scanning (GTIN or internal code)
   - Location barcode scanning for destination
   - Camera-based scanning using device camera
   - Manual barcode entry fallback

3. **Number Pad for Quantity Entry**
   - Large touch-friendly number pad
   - Decimal support for fractional quantities
   - Quick increment/decrement buttons (+1, +10, -1, -10)
   - Clear and backspace buttons
   - Keyboard dismissal handling

4. **Audio/Visual Feedback System**
   - Success tone on valid scan (200ms, high pitch)
   - Error beep on invalid scan (300ms, low pitch)
   - Confirmation chime on submission complete (500ms)
   - Alert tone on network error (400ms)
   - Visual indicators: green checkmarks, red X, yellow warnings
   - Haptic feedback on mobile devices (if supported)

5. **API Endpoints for Scanner Operations**
   - `POST /api/warehouse/scanner/receive` - Complete receive transaction
   - `GET /api/warehouse/scanner/pending-receipts` - List receivable POs/TOs
   - `GET /api/warehouse/scanner/lookup/po/:barcode` - Lookup PO by barcode
   - `GET /api/warehouse/scanner/lookup/product/:barcode` - Lookup product by barcode/GTIN
   - `GET /api/warehouse/scanner/lookup/location/:barcode` - Lookup location by barcode
   - `POST /api/warehouse/scanner/validate-receipt` - Pre-validate before commit

6. **Auto-Print LP Labels**
   - Automatic label print on receipt completion
   - Integration with `LabelPrintService` (Story 05.14)
   - Print queue for multiple labels
   - Configurable via `warehouse_settings.print_label_on_receipt`
   - Manual reprint option

7. **Service Layer**
   - `ScannerReceiveService.processReceipt()` - Main transaction handler
   - `ScannerReceiveService.validateBarcode()` - Barcode validation
   - `ScannerReceiveService.getPendingReceipts()` - Query pending POs/TOs
   - `ScannerReceiveService.lookupByBarcode()` - Universal barcode lookup
   - Integration with `GRNService` (Story 05.11)
   - Integration with `LicensePlateService` (Story 05.1)

8. **Zod Validation Schemas**
   - Scanner receive request schema
   - Barcode lookup schema
   - Receipt validation schema

### Out of Scope (Other Stories)

| Feature | Deferred To | Reason |
|---------|-------------|--------|
| Offline Queue Support | 05.19b (Phase 3) | Requires local storage, sync logic |
| GS1 Barcode Parsing (AI codes) | 05.24 | Advanced GS1 feature |
| ASN Pre-fill | 05.10 | ASN workflow separate |
| Catch Weight Entry | 05.27 | Phase 3 feature |
| Scanner Login/Session | 05.16 | Separate authentication story |
| Scanner Move | 05.18 | Different workflow |
| Scanner Putaway | 05.19 (different) | Different workflow |

---

## Epic 04 Dependency Status

- [ ] NOT CRITICAL - Does not unblock Epic 04 Phase 1
- [x] Phase 2 Story - Mobile receiving workflow enhancement

This story provides mobile receiving capability. Epic 04 (Production) does not depend on scanner workflows as desktop receiving (05.11) suffices for core operations.

---

## Goal

Enable warehouse operators to receive goods from Purchase Orders using handheld scanner devices with a mobile-optimized, step-by-step workflow that includes barcode scanning, large touch targets, audio feedback, and automatic LP label printing.

---

## User Story

As a **Warehouse Operator using a handheld scanner**, I want to **receive goods by scanning PO barcodes, product barcodes, and location barcodes with large touch-friendly buttons and audio confirmation** so that **I can efficiently receive inventory on the warehouse floor without needing to use a desktop computer**.

---

## Dependencies

| Dependency | Story/Epic | Type | Status | Notes |
|------------|------------|------|--------|-------|
| 05.11 | GRN from PO | HARD | Ready | Uses GRN service for receipt creation |
| 05.14 | Label Printing | HARD | Ready | Auto-print LP labels on receipt |
| 05.1 | LP Table + CRUD | HARD | Ready | Creates LPs via LP service |
| 05.0 | Warehouse Settings | HARD | Ready | Scanner settings, print settings |
| 01.8 | Warehouses CRUD | SOFT | Ready | Warehouse context |
| 01.9 | Locations CRUD | HARD | Ready | Location barcode lookup |
| 02.1 | Products CRUD | HARD | Ready | Product barcode lookup |
| 03.3 | PO CRUD | HARD | Ready | PO barcode lookup, line items |

**Dependents (What This Unblocks):**
- 05.19b (Offline Queue Support) - Phase 3 enhancement
- Scanner workflow polish stories

---

## Acceptance Criteria (Given/When/Then)

### AC-1: Scanner Receive Page Layout (WH-FR-011)

```gherkin
Scenario: Scanner receive page renders with mobile-optimized layout
  Given scanner user is authenticated
  When user navigates to /scanner/receive
  Then full-screen layout displays without browser chrome
  And header shows "Receive Goods" title with back button
  And current step indicator shows progress (1 of 5)
  And main content area fills available space
  And action buttons anchored to bottom of screen
  And all touch targets are minimum 48x48 pixels

Scenario: Page adapts to device orientation
  Given user on /scanner/receive
  When device rotates to landscape
  Then layout adjusts to horizontal orientation
  And barcode scan area remains easily accessible
  And number pad remains usable

Scenario: Page handles safe area insets
  Given user on device with notch/rounded corners
  Then content respects safe area insets
  And no UI elements obscured by device hardware
```

### AC-2: Step 1 - Select PO/TO Source (WH-FR-011)

```gherkin
Scenario: Display pending POs for receiving
  Given user on Step 1 "Select Source"
  When step loads
  Then list of receivable POs displayed
  And each PO shows: PO Number, Supplier, Expected Date, Lines pending
  And POs filtered to user's assigned warehouse
  And list sorted by expected_date ASC (soonest first)
  And "Scan PO Barcode" button prominently displayed

Scenario: Scan PO barcode to select
  Given user on Step 1
  When user taps "Scan PO Barcode" button
  Then camera barcode scanner activates
  And scan frame displays with guide overlay
  And scanning instruction text shows "Scan PO barcode"

Scenario: Valid PO barcode scanned
  Given camera scanner active
  When PO barcode "PO-2025-00001" scanned
  Then system validates barcode against pending POs in < 500ms
  And success tone plays (200ms, high pitch)
  And green checkmark animation displays
  And workflow advances to Step 2

Scenario: Invalid PO barcode scanned
  Given camera scanner active
  When unrecognized barcode scanned
  Then error beep plays (300ms, low pitch)
  And red X animation displays
  And error message shows "PO not found: {barcode}"
  And scanner remains active for retry

Scenario: PO not receivable (wrong status)
  Given camera scanner active
  When PO barcode scanned for cancelled PO
  Then error beep plays
  And message shows "PO cannot be received (status: cancelled)"
  And scanner remains active for retry

Scenario: Manual PO selection from list
  Given pending POs displayed in list
  When user taps PO row
  Then PO selected with visual highlight
  And workflow advances to Step 2
```

### AC-3: Step 2 - Review PO Lines (WH-FR-011)

```gherkin
Scenario: Display PO lines for selected PO
  Given PO "PO-2025-00001" selected
  When Step 2 loads
  Then PO header displays: PO Number, Supplier name
  And line items table shows:
    | Column | Description |
    | Product | Product name (first 30 chars) |
    | Ordered | Original qty |
    | Received | Previously received qty |
    | Remaining | Ordered - Received |
    | UoM | Unit of measure |
  And lines with remaining > 0 highlighted
  And fully received lines shown greyed/dimmed

Scenario: Select line for receiving
  Given PO lines displayed
  When user taps line with remaining qty > 0
  Then line selected with visual highlight
  And "Receive This Item" button appears at bottom
  And workflow ready to advance to Step 3

Scenario: Scan product barcode to select line
  Given Step 2 displayed
  When user scans product barcode
  Then system matches barcode to PO line product
  And matching line auto-selected
  And success tone plays
  And workflow advances to Step 3

Scenario: Product barcode not on PO
  Given Step 2 displayed
  When product barcode scanned not matching any PO line
  Then error beep plays
  And message shows "Product not found on this PO"
  And scanner remains active

Scenario: Receive all remaining
  Given PO with 3 lines with remaining qty
  When user taps "Receive All Remaining"
  Then all lines selected
  And bulk receive mode activated
  And workflow advances to Step 3 (first item)
```

### AC-4: Step 3 - Enter Receipt Details (WH-FR-011)

```gherkin
Scenario: Receipt details form displays
  Given product line selected
  When Step 3 loads
  Then form displays:
    | Field | Type | Notes |
    | Product | Display only | Name and code |
    | Ordered Qty | Display only | With UoM |
    | Remaining Qty | Display only | With UoM |
    | Receive Qty | Number input | Defaults to remaining |
    | Batch Number | Text input | If batch tracking enabled |
    | Expiry Date | Date picker | If expiry tracking enabled |
    | Location | Scanner/Select | Defaults from settings |
  And number pad anchored at bottom
  And "Receive Qty" input is focused

Scenario: Number pad for quantity entry
  Given receipt details form displayed
  When user interacts with number pad
  Then number pad shows digits 0-9
  And decimal point button available
  And backspace button available
  And clear button available
  And +1, +10, -1, -10 quick buttons available
  And all buttons minimum 48x48 pixels
  And number pad dismissible by tapping outside

Scenario: Quick quantity adjustment
  Given Receive Qty = 100
  When user taps "+10" button
  Then Receive Qty = 110
  When user taps "-1" button
  Then Receive Qty = 109

Scenario: Quantity exceeds remaining (over-receipt)
  Given remaining qty = 100
  And warehouse_settings.allow_over_receipt = false
  When user enters qty = 120
  Then inline warning displays "Exceeds remaining by 20"
  And field highlighted in yellow
  And continue allowed (validation on submit)

Scenario: Batch number entry (required)
  Given warehouse_settings.require_batch_on_receipt = true
  And Batch Number field displayed
  Then field shows "Required" indicator
  And field border highlighted
  When user enters batch "BATCH-2025-001"
  Then field validates as complete
  And green checkmark shows

Scenario: Expiry date entry via date picker
  Given warehouse_settings.require_expiry_on_receipt = true
  When user taps Expiry Date field
  Then date picker modal opens
  And date picker uses large touch-friendly calendar
  And quick buttons: "Today", "+30 days", "+90 days", "+1 year"
  When user selects date
  Then date populated in field
  And picker closes

Scenario: Scan destination location
  Given Location field displayed
  When user taps location scan button
  Then camera scanner activates for location barcode
  When valid location barcode scanned
  Then location populated
  And success tone plays
  And scanner closes

Scenario: Manual location selection
  Given location scan not available
  When user taps location dropdown
  Then location picker displays
  And locations grouped by zone
  And search/filter available
  When user selects location
  Then location populated
```

### AC-5: Step 4 - Review and Confirm (WH-FR-011)

```gherkin
Scenario: Review summary displays
  Given all receipt details entered
  When user advances to Step 4
  Then summary displays:
    | Field | Value |
    | PO Number | PO-2025-00001 |
    | Product | {product name} |
    | Receive Qty | 100 KG |
    | Batch | BATCH-2025-001 |
    | Expiry | 2026-06-01 |
    | Location | WH-001/ZONE-A |
  And "Edit" buttons for each section
  And large "Confirm Receipt" button at bottom

Scenario: Edit from review
  Given review summary displayed
  When user taps "Edit" on Receive Qty
  Then workflow returns to Step 3
  And quantity field focused

Scenario: Validation before confirm
  Given review summary displayed
  When user taps "Confirm Receipt"
  Then system validates:
    - Qty > 0
    - Batch provided (if required)
    - Expiry provided (if required)
    - Location valid
    - Over-receipt within tolerance
  And if validation fails, specific error shown
  And workflow remains on Step 4

Scenario: Pre-submit validation API call
  Given all fields valid
  When user taps "Confirm Receipt"
  Then POST /api/warehouse/scanner/validate-receipt called
  And response returns within 500ms
  And if pre-validation fails, error displayed
  And user can fix and retry
```

### AC-6: Step 5 - Success and Print (WH-FR-011, WH-FR-014)

```gherkin
Scenario: Successful receipt creates GRN and LP
  Given validation passes
  When "Confirm Receipt" tapped
  Then POST /api/warehouse/scanner/receive called
  And GRN created with LP
  And PO line received_qty updated
  And confirmation chime plays (500ms)
  And success screen displays:
    | Field | Value |
    | GRN Number | GRN-2025-00001 |
    | LP Number | LP00000001 |
    | Product | {product name} |
    | Qty Received | 100 KG |
  And green success animation displays
  And response time < 500ms

Scenario: Auto-print label on receipt
  Given warehouse_settings.print_label_on_receipt = true
  When receipt completes successfully
  Then LP label print job queued automatically
  And "Label printing..." indicator shows
  And print status displays (success/failure)
  And copies = warehouse_settings.label_copies_default

Scenario: Manual reprint label
  Given success screen displayed
  When user taps "Reprint Label"
  Then label print job queued
  And print confirmation displays

Scenario: Continue receiving same PO
  Given success screen displayed
  When user taps "Receive More Items"
  Then workflow returns to Step 2 (PO lines)
  And PO lines refresh showing updated received_qty
  And previously received line marked as partial/complete

Scenario: Receive from different PO
  Given success screen displayed
  When user taps "New PO"
  Then workflow returns to Step 1 (Select Source)
  And scanner ready for new PO

Scenario: Return to dashboard
  Given success screen displayed
  When user taps "Done"
  Then navigate to scanner dashboard
  And receipt logged in activity
```

### AC-7: Audio Feedback System (WH-NFR)

```gherkin
Scenario: Audio feedback settings
  Given warehouse_settings.scanner_sound_feedback = true
  Then all audio feedback enabled
  When warehouse_settings.scanner_sound_feedback = false
  Then audio muted (visual only)

Scenario: Success tone plays on valid scan
  Given audio enabled
  When valid barcode scanned (PO, product, location)
  Then success tone plays:
    - Frequency: 880Hz (high pitch)
    - Duration: 200ms
    - Volume: Device volume level

Scenario: Error beep plays on invalid scan
  Given audio enabled
  When invalid barcode scanned
  Then error beep plays:
    - Frequency: 220Hz (low pitch)
    - Duration: 300ms
    - Volume: Device volume level

Scenario: Confirmation chime on submission
  Given audio enabled
  When receipt submitted successfully
  Then confirmation chime plays:
    - Dual tone: 660Hz + 880Hz
    - Duration: 500ms
    - Volume: Device volume level

Scenario: Alert tone on network error
  Given audio enabled
  When network request fails
  Then alert tone plays:
    - Frequency: 440Hz (mid pitch, repeating)
    - Duration: 400ms
    - Volume: Device volume level

Scenario: Haptic feedback on mobile
  Given device supports haptic feedback
  When action completed (scan, submit)
  Then haptic vibration triggers
  And vibration pattern matches feedback type:
    - Success: short buzz (50ms)
    - Error: double buzz (50ms, 50ms gap, 50ms)
    - Confirm: long buzz (100ms)
```

### AC-8: Visual Feedback System (WH-NFR)

```gherkin
Scenario: Success visual indicator
  When valid action completed
  Then green checkmark animation displays
  And animation duration = 500ms
  And checkmark size = 64x64 pixels minimum
  And background flashes green briefly

Scenario: Error visual indicator
  When invalid action occurs
  Then red X animation displays
  And animation duration = 500ms
  And X size = 64x64 pixels minimum
  And background flashes red briefly

Scenario: Warning visual indicator
  When warning condition detected (over-receipt, expiry soon)
  Then yellow warning icon displays
  And warning message in yellow banner
  And field border highlighted yellow

Scenario: Loading indicator during API calls
  When API request in progress
  Then loading spinner displays
  And spinner size = 48x48 pixels
  And UI interaction disabled during load
  And timeout after 10 seconds with error

Scenario: High contrast colors for warehouse lighting
  Given warehouse lighting conditions may be poor
  Then UI uses high contrast color scheme:
    - Primary actions: #22C55E (bright green)
    - Errors: #EF4444 (bright red)
    - Warnings: #F59E0B (bright orange)
    - Text: #111827 (near black) on #FFFFFF (white)
    - Backgrounds: High contrast for readability
```

### AC-9: API Endpoint - Scanner Receive (WH-FR-011)

```gherkin
Scenario: POST /api/warehouse/scanner/receive - Happy path
  When POST /api/warehouse/scanner/receive with:
    {
      "po_id": "{po_uuid}",
      "po_line_id": "{line_uuid}",
      "received_qty": 100,
      "batch_number": "BATCH-001",
      "expiry_date": "2026-06-01",
      "location_id": "{location_uuid}",
      "warehouse_id": "{warehouse_uuid}"
    }
  Then response status = 201 Created
  And response includes:
    {
      "grn": { "id": "...", "grn_number": "GRN-2025-00001" },
      "lp": { "id": "...", "lp_number": "LP00000001" },
      "po_line_status": "partial" | "complete",
      "po_status": "partial" | "closed",
      "print_job_id": "..." | null
    }
  And response time < 500ms

Scenario: POST /api/warehouse/scanner/receive - Validation failure
  When POST with missing required batch_number
  And warehouse_settings.require_batch_on_receipt = true
  Then response status = 400 Bad Request
  And error message = "Batch number required for receipt"

Scenario: POST /api/warehouse/scanner/receive - Over-receipt blocked
  When POST with qty exceeding ordered + tolerance
  Then response status = 400 Bad Request
  And error includes max_allowed and tolerance_pct

Scenario: POST /api/warehouse/scanner/receive - PO not found
  When POST with invalid po_id
  Then response status = 404 Not Found
  And error message = "Purchase Order not found"
```

### AC-10: API Endpoint - Pending Receipts (WH-FR-011)

```gherkin
Scenario: GET /api/warehouse/scanner/pending-receipts
  Given user authenticated with warehouse_id in context
  When GET /api/warehouse/scanner/pending-receipts
  Then response status = 200 OK
  And response includes POs with status in [approved, confirmed, partial]
  And each PO includes:
    - id, po_number, supplier_name
    - expected_date
    - lines_total, lines_pending
    - total_qty_ordered, total_qty_received
  And results filtered by user's assigned warehouse
  And sorted by expected_date ASC
  And response time < 500ms

Scenario: GET /api/warehouse/scanner/pending-receipts - No pending POs
  Given all POs fully received or cancelled
  When GET /api/warehouse/scanner/pending-receipts
  Then response status = 200 OK
  And response = { "data": [], "total": 0 }
  And UI shows "No pending receipts" message
```

### AC-11: API Endpoint - Barcode Lookup (WH-FR-011)

```gherkin
Scenario: GET /api/warehouse/scanner/lookup/po/:barcode - Found
  When GET /api/warehouse/scanner/lookup/po/PO-2025-00001
  Then response status = 200 OK
  And response includes PO details with lines
  And response time < 200ms

Scenario: GET /api/warehouse/scanner/lookup/po/:barcode - Not Found
  When GET /api/warehouse/scanner/lookup/po/INVALID
  Then response status = 404 Not Found
  And error message = "PO not found"

Scenario: GET /api/warehouse/scanner/lookup/product/:barcode - By internal code
  Given product with code "FLOUR-001"
  When GET /api/warehouse/scanner/lookup/product/FLOUR-001
  Then response status = 200 OK
  And response includes product details

Scenario: GET /api/warehouse/scanner/lookup/product/:barcode - By GTIN
  Given product with gtin "12345678901234"
  When GET /api/warehouse/scanner/lookup/product/12345678901234
  Then response status = 200 OK
  And response includes product details

Scenario: GET /api/warehouse/scanner/lookup/location/:barcode - Found
  Given location with barcode "LOC-A01-01"
  When GET /api/warehouse/scanner/lookup/location/LOC-A01-01
  Then response status = 200 OK
  And response includes location details with full_path
  And response time < 100ms
```

### AC-12: Touch Target Requirements (WH-NFR)

```gherkin
Scenario: All buttons meet minimum touch target
  Given scanner receive page rendered
  When measuring all interactive elements
  Then all buttons >= 48x48 pixels (48dp)
  And all tappable areas >= 48x48 pixels
  And spacing between targets >= 8 pixels

Scenario: Primary action buttons larger
  Given action buttons at bottom of screen
  Then primary action buttons >= 56x56 pixels
  And full-width buttons = 100% width, 56px height

Scenario: Number pad keys appropriately sized
  Given number pad displayed
  Then each number key >= 48x48 pixels
  And operation keys (+, -, clear) >= 48x48 pixels
  And key spacing = 4-8 pixels

Scenario: List items tappable
  Given PO or product list displayed
  Then each list row height >= 56 pixels
  And entire row is tappable area
  And visual feedback on tap (ripple/highlight)
```

### AC-13: Error Handling and Recovery (WH-NFR)

```gherkin
Scenario: Network error during receipt
  Given user submitting receipt
  When network request fails (timeout/offline)
  Then alert tone plays
  And error modal displays:
    - "Network error. Please try again."
    - "Retry" button
    - "Cancel" button
  And user data preserved for retry

Scenario: Retry after network error
  Given network error modal displayed
  When user taps "Retry"
  Then request resubmitted
  And loading indicator shows
  And on success, normal flow continues

Scenario: Server error during receipt
  Given user submitting receipt
  When server returns 500 error
  Then error modal displays
  And error logged for debugging
  And "Contact Support" option available

Scenario: Session timeout
  Given warehouse_settings.scanner_idle_timeout_sec = 300
  And user idle for 300+ seconds
  Then session timeout warning displays at 4:30
  And at 5:00, session expires
  And user redirected to login
  And unsaved data preserved (if possible)

Scenario: Camera permission denied
  Given user attempts barcode scan
  When camera permission denied by device
  Then error message "Camera permission required for scanning"
  And "Open Settings" button to enable
  And "Manual Entry" fallback option
```

### AC-14: Performance Requirements (WH-NFR)

```gherkin
Scenario: Page load performance
  Given user navigates to /scanner/receive
  Then page renders within 1 second
  And interactive within 1.5 seconds
  And pending PO list loads within 500ms

Scenario: Barcode scan response time
  Given camera scanner active
  When barcode decoded from camera feed
  Then barcode value available within 100ms
  And lookup API called within 50ms
  And total feedback within 500ms

Scenario: Receipt submission performance
  Given user taps "Confirm Receipt"
  Then API call completes within 500ms
  And success feedback within 600ms total
  And label print job queued within 200ms

Scenario: Number pad responsiveness
  Given number pad displayed
  When user taps number key
  Then visual feedback within 50ms
  And value updated within 100ms
  And no perceptible lag
```

### AC-15: RLS and Security (WH-NFR)

```gherkin
Scenario: Org isolation on pending receipts
  Given User A from Org A, User B from Org B
  And POs exist in both orgs
  When User A requests /api/warehouse/scanner/pending-receipts
  Then only Org A POs returned

Scenario: Cannot receive PO from different org
  Given User A from Org A
  And PO belongs to Org B
  When User A attempts POST /api/warehouse/scanner/receive with orgB PO
  Then 404 Not Found returned
  And no GRN/LP created

Scenario: Warehouse access control
  Given user assigned to Warehouse A only
  And PO for Warehouse B exists
  When user views pending receipts
  Then Warehouse B POs not visible
  And attempts to receive to Warehouse B blocked
```

### AC-16: Offline Queue Support - Phase 3 Placeholder

```gherkin
Scenario: Offline mode indicator (Phase 3)
  Given device loses network connectivity
  Then offline indicator displays in header
  And "Offline Mode" banner shows
  And "X items pending sync" counter displays

Note: Full offline queue implementation deferred to Story 05.19b (Phase 3)
Current implementation requires network connectivity for all operations
```

---

## Scanner UI Requirements

### Touch Targets

| Element | Minimum Size | Recommended Size |
|---------|-------------|------------------|
| Number pad keys | 48x48 dp | 56x56 dp |
| Primary action buttons | 48x48 dp | Full-width, 56dp height |
| List row items | 56dp height | 64dp height |
| Barcode scan button | 64x64 dp | 80x80 dp |
| Back/Cancel buttons | 48x48 dp | 48x48 dp |
| Icon buttons | 44x44 dp | 48x48 dp |

### Layout Structure

```
+------------------------------------------+
| <- Back    Receive Goods     [?] Help    |  Header (56dp)
+------------------------------------------+
| Step 1 of 5: Select PO                   |  Progress (32dp)
+------------------------------------------+
|                                          |
|                                          |
|             Main Content                 |  Scrollable content
|         (lists, forms, summary)          |
|                                          |
|                                          |
+------------------------------------------+
|                                          |
|         [  SCAN PO BARCODE  ]            |  Primary Action (56dp)
|                                          |
|         [ Select from List  ]            |  Secondary Action (48dp)
|                                          |
+------------------------------------------+
```

### Number Pad Layout

```
+------------------------------------------+
|   [ 1 ]    [ 2 ]    [ 3 ]    [ +1 ]     |
|   [ 4 ]    [ 5 ]    [ 6 ]    [ +10 ]    |
|   [ 7 ]    [ 8 ]    [ 9 ]    [ -1 ]     |
|   [ . ]    [ 0 ]    [ <- ]   [ -10 ]    |
|                                          |
|            [ CLEAR ]                     |
+------------------------------------------+
```

### Audio Feedback Specification

| Event | Frequency | Duration | Pattern | Web Audio API |
|-------|-----------|----------|---------|---------------|
| Valid scan | 880Hz | 200ms | Single tone | OscillatorNode |
| Invalid scan | 220Hz | 300ms | Single tone | OscillatorNode |
| Submission complete | 660Hz+880Hz | 500ms | Dual tone chord | 2x OscillatorNode |
| Network error | 440Hz | 400ms | Repeating (3x) | OscillatorNode |

### Color Scheme (High Contrast)

| Purpose | Light Mode | Notes |
|---------|------------|-------|
| Success | #22C55E (green-500) | High visibility |
| Error | #EF4444 (red-500) | High visibility |
| Warning | #F59E0B (amber-500) | High visibility |
| Primary Action | #2563EB (blue-600) | Standard primary |
| Text Primary | #111827 (gray-900) | Near black |
| Text Secondary | #4B5563 (gray-600) | Medium gray |
| Background | #FFFFFF (white) | Maximum contrast |
| Surface | #F9FAFB (gray-50) | Cards, modals |
| Border | #D1D5DB (gray-300) | Visible borders |

---

## Technical Specification

### Database

No new tables required. Uses existing tables:
- `grns`, `grn_items` (from Story 05.11)
- `license_plates` (from Story 05.1)
- `warehouse_settings` (from Story 05.0)

### API Endpoints

```
# Scanner Receive Endpoints
POST   /api/warehouse/scanner/receive                    - Process receipt
GET    /api/warehouse/scanner/pending-receipts           - List receivable POs/TOs
POST   /api/warehouse/scanner/validate-receipt           - Pre-validate receipt
GET    /api/warehouse/scanner/lookup/po/:barcode         - Lookup PO by barcode
GET    /api/warehouse/scanner/lookup/product/:barcode    - Lookup product by barcode/GTIN
GET    /api/warehouse/scanner/lookup/location/:barcode   - Lookup location by barcode
```

**POST /api/warehouse/scanner/receive Request:**

```typescript
interface ScannerReceiveRequest {
  po_id: string;                     // PO UUID
  po_line_id: string;                // PO line UUID
  warehouse_id: string;              // Receiving warehouse UUID
  location_id: string;               // Destination location UUID
  received_qty: number;              // Quantity to receive
  batch_number?: string;             // Batch number (if required)
  supplier_batch_number?: string;    // Supplier batch (if enabled)
  expiry_date?: string;              // YYYY-MM-DD (if required)
  manufacture_date?: string;         // YYYY-MM-DD (optional)
  notes?: string;                    // Receipt notes
}
```

**POST /api/warehouse/scanner/receive Response:**

```typescript
interface ScannerReceiveResponse {
  grn: {
    id: string;
    grn_number: string;
    receipt_date: string;
    status: 'completed';
  };
  lp: {
    id: string;
    lp_number: string;
    product_name: string;
    quantity: number;
    uom: string;
    batch_number: string | null;
    expiry_date: string | null;
    location_path: string;
  };
  po_line_status: 'partial' | 'complete';
  po_status: 'partial' | 'closed';
  print_job_id: string | null;
  over_receipt?: {
    ordered_qty: number;
    total_received: number;
    over_receipt_pct: number;
  };
}
```

### Service Layer

```typescript
// lib/services/scanner-receive-service.ts

export interface ScannerReceiveInput {
  poId: string;
  poLineId: string;
  warehouseId: string;
  locationId: string;
  receivedQty: number;
  batchNumber?: string;
  supplierBatchNumber?: string;
  expiryDate?: string;
  manufactureDate?: string;
  notes?: string;
}

export interface ScannerReceiveResult {
  grn: GRN;
  lp: LicensePlate;
  poLineStatus: 'partial' | 'complete';
  poStatus: 'partial' | 'closed';
  printJobId: string | null;
}

export interface BarcodeLookupResult {
  type: 'po' | 'product' | 'location';
  found: boolean;
  data?: PurchaseOrder | Product | Location;
  error?: string;
}

export interface PendingReceiptSummary {
  id: string;
  po_number: string;
  supplier_name: string;
  expected_date: string;
  lines_total: number;
  lines_pending: number;
  total_qty_ordered: number;
  total_qty_received: number;
}

export class ScannerReceiveService {
  /**
   * Process scanner receipt - main transaction handler
   * - Validates all inputs
   * - Creates GRN via GRNService
   * - Creates LP via LicensePlateService
   * - Updates PO line and status
   * - Queues label print job
   * - All in single transaction
   */
  static async processReceipt(input: ScannerReceiveInput): Promise<ScannerReceiveResult>;

  /**
   * Validate receipt data before commit
   * Returns validation errors without creating records
   */
  static async validateReceipt(input: ScannerReceiveInput): Promise<{
    valid: boolean;
    errors: { field: string; message: string }[];
    warnings: { field: string; message: string }[];
  }>;

  /**
   * Get pending receipts for user's warehouse
   * Returns POs with status in [approved, confirmed, partial]
   */
  static async getPendingReceipts(warehouseId?: string): Promise<PendingReceiptSummary[]>;

  /**
   * Lookup PO by barcode (PO number)
   */
  static async lookupPO(barcode: string): Promise<PurchaseOrder | null>;

  /**
   * Lookup product by barcode (internal code or GTIN)
   */
  static async lookupProduct(barcode: string): Promise<Product | null>;

  /**
   * Lookup location by barcode
   */
  static async lookupLocation(barcode: string): Promise<Location | null>;

  /**
   * Universal barcode lookup - determines type and looks up
   */
  static async lookupBarcode(barcode: string): Promise<BarcodeLookupResult>;

  /**
   * Queue label print job for LP
   */
  static async queueLabelPrint(lpId: string, copies?: number): Promise<string | null>;
}
```

### Validation Schema (Zod)

```typescript
// lib/validation/scanner-receive.ts
import { z } from 'zod';

export const scannerReceiveSchema = z.object({
  po_id: z.string().uuid("Invalid PO ID"),
  po_line_id: z.string().uuid("Invalid PO line ID"),
  warehouse_id: z.string().uuid("Invalid warehouse ID"),
  location_id: z.string().uuid("Invalid location ID"),
  received_qty: z.number()
    .positive("Quantity must be positive")
    .max(999999999, "Quantity too large"),
  batch_number: z.string()
    .max(100, "Batch number max 100 characters")
    .optional()
    .nullable(),
  supplier_batch_number: z.string()
    .max(100, "Supplier batch max 100 characters")
    .optional()
    .nullable(),
  expiry_date: z.string()
    .regex(/^\d{4}-\d{2}-\d{2}$/, "Invalid date format (YYYY-MM-DD)")
    .optional()
    .nullable(),
  manufacture_date: z.string()
    .regex(/^\d{4}-\d{2}-\d{2}$/, "Invalid date format (YYYY-MM-DD)")
    .optional()
    .nullable(),
  notes: z.string()
    .max(500, "Notes max 500 characters")
    .optional()
    .nullable(),
});

export const validateReceiptSchema = scannerReceiveSchema;

export const barcodeLookupSchema = z.object({
  barcode: z.string()
    .min(1, "Barcode required")
    .max(100, "Barcode too long"),
  type: z.enum(['po', 'product', 'location']).optional(),
});

export const pendingReceiptsQuerySchema = z.object({
  warehouse_id: z.string().uuid().optional(),
  search: z.string().optional(),
  limit: z.coerce.number().int().min(1).max(100).default(50),
});

export type ScannerReceiveInput = z.infer<typeof scannerReceiveSchema>;
export type BarcodeLookupInput = z.infer<typeof barcodeLookupSchema>;
```

---

## UI Components

```
app/(authenticated)/scanner/
  receive/
    page.tsx                              -- Scanner receive main page

components/scanner/
  receive/
    ScannerReceiveWizard.tsx              -- Step wizard container
    Step1SelectPO.tsx                     -- Step 1: Select PO source
    Step2ReviewLines.tsx                  -- Step 2: Review PO lines
    Step3EnterDetails.tsx                 -- Step 3: Enter receipt details
    Step4ReviewConfirm.tsx                -- Step 4: Review and confirm
    Step5Success.tsx                      -- Step 5: Success with print
    PendingPOList.tsx                     -- List of receivable POs
    POLinesList.tsx                       -- List of PO lines
    ReceiptDetailsForm.tsx                -- Receipt form with inputs

  shared/
    BarcodeScanner.tsx                    -- Camera barcode scanner
    BarcodeScanButton.tsx                 -- Large scan trigger button
    NumberPad.tsx                         -- Touch-friendly number pad
    DatePickerMobile.tsx                  -- Mobile date picker
    AudioFeedback.tsx                     -- Audio feedback manager
    HapticFeedback.tsx                    -- Haptic feedback utility
    SuccessAnimation.tsx                  -- Green checkmark animation
    ErrorAnimation.tsx                    -- Red X animation
    LoadingOverlay.tsx                    -- Full-screen loading
    ScannerHeader.tsx                     -- Scanner page header
    StepProgress.tsx                      -- Step progress indicator
    HighContrastBadge.tsx                 -- High visibility status badge
    LargeTouchButton.tsx                  -- 48dp+ touch target button
    NetworkStatus.tsx                     -- Online/offline indicator
```

### Key Component Implementations

**NumberPad.tsx**
```tsx
interface NumberPadProps {
  value: string;
  onChange: (value: string) => void;
  allowDecimal?: boolean;
  maxValue?: number;
  onQuickAdjust?: (delta: number) => void;
}

// Features:
// - Minimum 48x48dp keys
// - Quick increment buttons (+1, +10, -1, -10)
// - Clear and backspace
// - Decimal support
// - Visual feedback on tap
```

**AudioFeedback.tsx**
```tsx
export const AudioFeedback = {
  playSuccess: () => void;      // 880Hz, 200ms
  playError: () => void;        // 220Hz, 300ms
  playConfirm: () => void;      // 660Hz+880Hz, 500ms
  playAlert: () => void;        // 440Hz, 400ms repeating
  setEnabled: (enabled: boolean) => void;
};

// Uses Web Audio API OscillatorNode
// Respects warehouse_settings.scanner_sound_feedback
```

**BarcodeScanner.tsx**
```tsx
interface BarcodeScannerProps {
  onScan: (barcode: string) => void;
  onError: (error: string) => void;
  scanTypes?: ('po' | 'product' | 'location')[];
  active?: boolean;
}

// Features:
// - Camera access with permission handling
// - Guide overlay for scan area
// - Continuous scanning mode
// - Manual entry fallback
// - Torch/flashlight toggle
```

---

## Key Business Rules

1. **Scanner Authentication**: User must be authenticated with scanner session (Story 05.16)
2. **Warehouse Context**: User must have assigned warehouse; operations limited to assigned warehouse
3. **PO Status for Receiving**: Only POs with status in ['approved', 'confirmed', 'partial'] can be received
4. **Over-Receipt Control**: Same rules as desktop (05.11) - blocked or allowed with tolerance
5. **Batch/Expiry Requirements**: Same validation as desktop - configurable via settings
6. **Auto-Print Labels**: If `print_label_on_receipt = true`, label printed automatically
7. **One LP Per Scan**: Each scanner receive creates exactly one LP (no batch splitting)
8. **Audio Feedback**: Enabled by default via `scanner_sound_feedback` setting
9. **Touch Targets**: All interactive elements minimum 48x48 pixels
10. **Response Times**: All operations < 500ms for snappy user experience

---

## Deliverables

### API Routes
- [ ] `POST /api/warehouse/scanner/receive` - Process receipt
- [ ] `GET /api/warehouse/scanner/pending-receipts` - List pending POs
- [ ] `POST /api/warehouse/scanner/validate-receipt` - Pre-validation
- [ ] `GET /api/warehouse/scanner/lookup/po/:barcode` - PO lookup
- [ ] `GET /api/warehouse/scanner/lookup/product/:barcode` - Product lookup
- [ ] `GET /api/warehouse/scanner/lookup/location/:barcode` - Location lookup

### Service Layer
- [ ] `ScannerReceiveService.processReceipt()` - Main transaction
- [ ] `ScannerReceiveService.validateReceipt()` - Pre-validation
- [ ] `ScannerReceiveService.getPendingReceipts()` - Query pending
- [ ] `ScannerReceiveService.lookupPO()` - PO lookup
- [ ] `ScannerReceiveService.lookupProduct()` - Product lookup
- [ ] `ScannerReceiveService.lookupLocation()` - Location lookup
- [ ] `ScannerReceiveService.queueLabelPrint()` - Print integration

### Validation
- [ ] `scannerReceiveSchema` - Receipt request validation
- [ ] `validateReceiptSchema` - Pre-validation schema
- [ ] `barcodeLookupSchema` - Barcode lookup validation
- [ ] `pendingReceiptsQuerySchema` - Query params validation

### Frontend Components
- [ ] Scanner receive page (`/scanner/receive`)
- [ ] 5-step wizard component
- [ ] Pending PO list component
- [ ] PO lines list component
- [ ] Receipt details form
- [ ] Number pad component (48dp+ keys)
- [ ] Barcode scanner component
- [ ] Audio feedback system
- [ ] Success/Error animations
- [ ] Mobile date picker

### Audio/Visual Feedback
- [ ] Success tone (880Hz, 200ms)
- [ ] Error beep (220Hz, 300ms)
- [ ] Confirmation chime (660Hz+880Hz, 500ms)
- [ ] Alert tone (440Hz, 400ms)
- [ ] Green checkmark animation
- [ ] Red X animation
- [ ] Loading spinner
- [ ] Haptic feedback (if supported)

### Tests
- [ ] Unit tests: Scanner receive service (>80% coverage)
- [ ] Integration tests: All scanner API endpoints
- [ ] Validation tests: Input validation scenarios
- [ ] Touch target tests: All elements >= 48dp
- [ ] Audio tests: Feedback plays correctly
- [ ] E2E: Full scanner receive flow
- [ ] RLS tests: Multi-tenancy isolation

---

## Test Cases

### Unit Tests

**File:** `__tests__/unit/services/scanner-receive-service.test.ts`

| Test Case | Description |
|-----------|-------------|
| `processReceipt()` creates GRN and LP | Success flow |
| `processReceipt()` updates PO line received_qty | Qty accumulation |
| `processReceipt()` queues label print | Print integration |
| `processReceipt()` blocks over-receipt | Tolerance check |
| `processReceipt()` validates batch required | Setting enforcement |
| `processReceipt()` validates expiry required | Setting enforcement |
| `validateReceipt()` returns errors for invalid data | Pre-validation |
| `validateReceipt()` returns warnings for over-receipt | Warning generation |
| `getPendingReceipts()` filters by warehouse | Warehouse context |
| `getPendingReceipts()` excludes cancelled POs | Status filter |
| `lookupPO()` finds PO by number | Barcode match |
| `lookupProduct()` finds by internal code | Code lookup |
| `lookupProduct()` finds by GTIN | GTIN lookup |
| `lookupLocation()` finds by barcode | Location lookup |

### Integration Tests

**File:** `__tests__/integration/api/warehouse/scanner-receive.test.ts`

| Test Case | Description |
|-----------|-------------|
| `POST /scanner/receive` creates GRN and LP | Success response |
| `POST /scanner/receive` updates PO | PO line/status updated |
| `POST /scanner/receive` queues print | Print job created |
| `POST /scanner/receive` with missing batch returns 400 | Validation |
| `POST /scanner/receive` with over-receipt returns 400 | Blocked |
| `POST /scanner/receive` with invalid PO returns 404 | Not found |
| `POST /scanner/receive` cross-org returns 404 | RLS enforced |
| `GET /scanner/pending-receipts` returns list | Success |
| `GET /scanner/pending-receipts` filters by warehouse | Warehouse filter |
| `GET /scanner/lookup/po/:barcode` finds PO | Lookup success |
| `GET /scanner/lookup/product/:barcode` finds product | Lookup success |
| `GET /scanner/lookup/location/:barcode` finds location | Lookup success |
| Response times < 500ms | Performance |

### E2E Tests

**File:** `__tests__/e2e/scanner/receive.spec.ts`

| Test Case | Description |
|-----------|-------------|
| Full scanner receive flow | Steps 1-5 complete |
| Select PO from list | Manual selection works |
| Select PO by scan (simulated) | Barcode entry works |
| Enter receipt details | Number pad, date picker |
| Over-receipt warning shown | Warning displays |
| Success screen with LP number | LP created and shown |
| Print button triggers print | Print job queued |
| Back navigation works | Step navigation |
| Error recovery works | Retry after failure |
| Touch targets >= 48dp | Accessibility compliance |

---

## Definition of Done

### API
- [ ] All endpoints return correct HTTP status codes
- [ ] Validation errors return 400 with detailed messages
- [ ] Cross-tenant access returns 404 (RLS enforced)
- [ ] Response times:
  - Receipt submission: < 500ms
  - Pending receipts list: < 500ms
  - Barcode lookups: < 200ms

### Service
- [ ] `processReceipt()` creates GRN and LP atomically
- [ ] Over-receipt validation matches desktop (05.11)
- [ ] Batch/expiry validation matches desktop
- [ ] Label print integration works
- [ ] All barcode lookups functional

### Frontend
- [ ] Mobile-optimized full-screen layout
- [ ] All touch targets >= 48dp
- [ ] Number pad with quick adjust buttons
- [ ] Barcode scanner with camera access
- [ ] Audio feedback (success, error, confirm, alert)
- [ ] Visual feedback (animations, badges)
- [ ] High contrast color scheme
- [ ] Step wizard navigation complete
- [ ] Error handling with retry

### Testing
- [ ] Unit tests: >80% coverage on service
- [ ] Integration tests: All endpoints covered
- [ ] E2E tests: Full flow passing
- [ ] Touch target tests: All compliant
- [ ] Audio tests: All feedback working
- [ ] RLS tests: Multi-tenancy verified

---

## Future Phases (Not in This Story)

### Story 05.19b - Offline Queue Support (Phase 3)
- Local storage for offline transactions
- Queue management UI
- Background sync when online
- Conflict resolution
- Pending count indicator

### Story 05.24 - GS1 Barcode Parsing
- Parse GS1 AI codes (01, 10, 17, 21)
- Auto-fill batch/expiry from scan
- GTIN-14 product lookup

### Story 05.27 - Catch Weight Entry
- Weight input field
- Tolerance validation
- Scale integration (future)

---

## Risk Assessment

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Camera permission issues | HIGH | MEDIUM | Clear permission prompts, manual entry fallback |
| Barcode scanning reliability | MEDIUM | MEDIUM | Multiple barcode libraries tested, manual fallback |
| Audio feedback not playing | LOW | MEDIUM | Visual feedback primary, audio secondary |
| Touch targets too small on devices | MEDIUM | LOW | Test on multiple devices, minimum 48dp enforced |
| Network latency on warehouse floor | HIGH | MEDIUM | Loading indicators, retry logic, future offline support |
| Device performance issues | MEDIUM | LOW | Optimized rendering, lightweight animations |
| Integration with GRN service | MEDIUM | LOW | GRN service well-tested in 05.11 |

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-12-16 | Initial story creation with comprehensive mobile scanner workflow | OPUS |
