# 05.18 - LP Merge Workflow

| Field | Value |
|-------|-------|
| **Story ID** | 05.18 |
| **Epic** | 05 - Warehouse |
| **Status** | Ready |
| **Phase** | Phase 2 (Scanner Workflows) |
| **Priority** | P2 (Phase 2) |
| **Complexity** | M (Medium) |
| **Estimate** | 3-4 days |
| **Type** | Backend + Frontend (Desktop) |
| **Model** | SONNET |

---

## PRD References

| FR ID | Requirement | Priority | Coverage |
|-------|-------------|----------|----------|
| WH-FR-007 | LP Merge (combine multiple LPs into one) | P2 | Full |
| WH-FR-002 | LP Tracking (status updates after merge) | P0 | Partial |
| WH-FR-028 | LP Genealogy (merge operation tracking) | P0 | Partial |

**Primary PRD:** `docs/1-BASELINE/product/modules/warehouse.md`
**Architecture:** `docs/1-BASELINE/architecture/modules/warehouse.md`

---

## MVP Scope

### In Scope (This Story)

1. **Backend API**
   - `POST /api/warehouse/license-plates/merge` - Merge multiple LPs
   - Validation service for merge eligibility
   - Transaction handling for atomic merge operation

2. **Merge Validation Rules**
   - Same product (product_id must match)
   - Same batch number (if batched)
   - Same expiry date (if tracked)
   - Same QA status (all must be 'passed' or all 'pending', etc.)
   - All LPs must be status='available' (not reserved/consumed/blocked)
   - All LPs must be in same warehouse
   - All LPs must have same UoM

3. **Merge Operation**
   - Create new LP with combined quantity
   - Mark source LPs as status='consumed'
   - Set source LPs' `consumed_by_wo_id` to NULL (warehouse operation, not production)
   - Set new LP's `parent_lp_id` to first source LP (primary)
   - Set new LP's source='merge'
   - Create genealogy links for all source LPs -> new LP

4. **Desktop UI**
   - Merge modal with multi-select LP picker
   - Validation display (shows eligibility checks)
   - Summary view (product, total qty, batch, expiry)
   - Confirmation step before merge
   - Success notification with new LP number

5. **Service Layer**
   - `LicensePlateService.merge()` - Main merge method
   - `LicensePlateService.validateMerge()` - Pre-merge validation
   - Transaction wrapper for atomicity

6. **Genealogy Integration**
   - Call `LPGenealogyService.linkMerge()` for all source LPs
   - Record operation_type='merge' in genealogy table

### Out of Scope (Other Stories)

| Feature | Deferred To | Reason |
|---------|-------------|--------|
| Scanner merge workflow | 05.21 | Separate scanner story |
| Batch merge across warehouses | Phase 3 | Complex transfer logic |
| Merge with UoM conversion | Phase 3 | Requires conversion service |
| Merge undo/reversal | Phase 3 | Complex reversal logic |
| Merge of LPs with different QA status | Phase 3 | Requires QA approval workflow |
| Merge audit reporting | Phase 4 | Reporting feature |

---

## Epic 04 Dependency Status

- [ ] **CRITICAL - Unblocks Epic 04 Phase 1**
- [x] **NOT CRITICAL - Can defer**

**Note:** LP merge is a Phase 2 warehouse operation. Epic 04 Production does not depend on merge functionality for MVP. Merge is useful for warehouse consolidation and cleanup operations.

---

## Goal

Implement LP merge workflow allowing warehouse operators to combine multiple License Plates of the same product, batch, and expiry into a single consolidated LP with full validation, genealogy tracking, and desktop UI.

---

## User Story

As a **warehouse operator**, I want **to merge multiple License Plates of the same product and batch into a single LP** so that **I can consolidate small quantities into larger units for easier handling and reduce the number of LPs to manage**.

---

## Scope

**In scope (this story)**
- API endpoint for LP merge with validation
- Desktop UI: Merge modal with multi-select and validation display
- Service layer with transaction handling
- Genealogy link creation for merge operations
- Validation rules enforcement
- Zod validation schemas
- Unit tests for merge service and validation
- Integration tests for API
- E2E test for desktop merge workflow

**Out of scope (this story)**
- Scanner merge interface (Story 05.21)
- Cross-warehouse merge
- UoM conversion during merge
- Merge reversal functionality
- Merge of mixed QA statuses
- Batch merge operations (merge 10+ LPs at once)

---

## Dependencies

- **05.0** - Warehouse Settings (warehouse and org_id configuration)
- **05.1** - LP Table + Basic Service (`license_plates` table and CRUD)
- **05.2** - LP Genealogy (genealogy table and `linkMerge()` service)
- **01.1** - Multi-tenancy (RLS, org_id filtering)
- **01.8** - Warehouses CRUD (warehouse reference)
- **01.9** - Locations CRUD (location reference)
- **02.1** - Products CRUD (product reference for validation)

---

## Acceptance Criteria (Given/When/Then)

### AC-1: Merge Validation - Same Product Required

**Given** LP-001 is product A and LP-002 is product B
**When** user attempts to merge [LP-001, LP-002]
**Then**
- API returns 400 Bad Request
- Error message: "All LPs must be the same product for merge"
- No LPs modified
- No genealogy records created

### AC-2: Merge Validation - Same Batch Required

**Given** LP-001 batch='BATCH-001' and LP-002 batch='BATCH-002' (same product)
**When** user attempts to merge [LP-001, LP-002]
**Then**
- API returns 400 Bad Request
- Error message: "All LPs must have the same batch number for merge"
- No merge performed

### AC-3: Merge Validation - Same Expiry Required

**Given** LP-001 expiry='2026-01-01' and LP-002 expiry='2026-02-01' (same product, same batch)
**When** user attempts to merge [LP-001, LP-002]
**Then**
- API returns 400 Bad Request
- Error message: "All LPs must have the same expiry date for merge"
- No merge performed

### AC-4: Merge Validation - Same QA Status Required

**Given** LP-001 qa_status='passed' and LP-002 qa_status='pending' (same product, batch, expiry)
**When** user attempts to merge [LP-001, LP-002]
**Then**
- API returns 400 Bad Request
- Error message: "All LPs must have the same QA status for merge"
- No merge performed

### AC-5: Merge Validation - All LPs Must Be Available

**Given** LP-001 status='available' and LP-002 status='reserved' (same product, batch, expiry, QA)
**When** user attempts to merge [LP-001, LP-002]
**Then**
- API returns 400 Bad Request
- Error message: "All LPs must have status='available' for merge. LP-002 is 'reserved'"
- No merge performed

### AC-6: Merge Validation - Same Warehouse Required

**Given** LP-001 in WH-001 and LP-002 in WH-002 (same product, batch, expiry, QA, status)
**When** user attempts to merge [LP-001, LP-002]
**Then**
- API returns 400 Bad Request
- Error message: "All LPs must be in the same warehouse for merge"
- No merge performed

### AC-7: Merge Validation - Same UoM Required

**Given** LP-001 uom='KG' and LP-002 uom='LB' (same product, batch, expiry, QA, status, warehouse)
**When** user attempts to merge [LP-001, LP-002]
**Then**
- API returns 400 Bad Request
- Error message: "All LPs must have the same UoM for merge"
- No merge performed

### AC-8: Merge Validation - Minimum 2 LPs Required

**Given** user selects only LP-001 (single LP)
**When** user attempts to merge [LP-001]
**Then**
- API returns 400 Bad Request
- Error message: "At least 2 LPs required for merge operation"
- No merge performed

### AC-9: Successful Merge - Two LPs

**Given** LP-001 (product A, batch='BATCH-001', expiry='2026-01-01', qty=50, status='available', qa_status='passed')
**And** LP-002 (product A, batch='BATCH-001', expiry='2026-01-01', qty=30, status='available', qa_status='passed')
**When** `POST /api/warehouse/license-plates/merge` with `{ sourceLpIds: ['LP-001', 'LP-002'], targetLocationId: 'loc-1' }`
**Then**
- New LP created (LP-003) with:
  - product_id = product A
  - quantity = 80 (50 + 30)
  - batch_number = 'BATCH-001'
  - expiry_date = '2026-01-01'
  - status = 'available'
  - qa_status = 'passed'
  - source = 'merge'
  - parent_lp_id = LP-001 (first source LP)
  - location_id = target location
  - lp_number auto-generated (e.g., LP00000003)
- LP-001 updated: status='consumed', consumed_by_wo_id=NULL
- LP-002 updated: status='consumed', consumed_by_wo_id=NULL
- Two genealogy records created:
  - LP-001 -> LP-003 (merge, qty=50)
  - LP-002 -> LP-003 (merge, qty=30)
- Operation completes in <500ms
- Response includes new LP ID and LP number

### AC-10: Successful Merge - Three+ LPs

**Given** LP-001 (qty=50), LP-002 (qty=30), LP-003 (qty=20) - all matching product/batch/expiry/QA/status
**When** merge [LP-001, LP-002, LP-003] is called
**Then**
- New LP created (LP-004) with quantity = 100 (50+30+20)
- All three source LPs marked as consumed
- Three genealogy records created (LP-001 -> LP-004, LP-002 -> LP-004, LP-003 -> LP-004)
- Operation completes in <600ms

### AC-11: Merge with NULL Batch/Expiry

**Given** LP-001 and LP-002 both have batch_number=NULL and expiry_date=NULL (same product)
**When** merge [LP-001, LP-002] is called
**Then**
- Merge succeeds (NULL values match)
- New LP has batch_number=NULL and expiry_date=NULL
- All other merge rules enforced

### AC-12: Merge Location Handling

**Given** LP-001 at location A, LP-002 at location B (different locations, same warehouse)
**When** merge [LP-001, LP-002] with targetLocationId = location C
**Then**
- New LP created at location C
- Location C must be in the same warehouse as source LPs
- If targetLocationId not provided, defaults to location of first source LP (LP-001)

### AC-13: Validate Merge API Endpoint

**Given** valid request payload
**When** `POST /api/warehouse/license-plates/validate-merge` with `{ sourceLpIds: ['LP-001', 'LP-002'] }`
**Then**
- API returns validation result:
  ```json
  {
    "valid": true,
    "errors": [],
    "summary": {
      "productName": "Product A",
      "totalQuantity": 80,
      "uom": "KG",
      "batchNumber": "BATCH-001",
      "expiryDate": "2026-01-01",
      "qaStatus": "passed",
      "lpCount": 2
    }
  }
  ```
- Response time <200ms

### AC-14: Validate Merge - Invalid LPs

**Given** LP-001 and LP-002 have different products
**When** `POST /api/warehouse/license-plates/validate-merge` with mismatched LPs
**Then**
- API returns:
  ```json
  {
    "valid": false,
    "errors": [
      "All LPs must be the same product for merge"
    ],
    "summary": null
  }
  ```

### AC-15: Desktop UI - Merge Modal Opens

**Given** user is on LP list page
**When** user selects 2+ LPs and clicks "Merge" action
**Then**
- Merge modal opens
- Selected LPs displayed in table (LP number, product, qty, batch, expiry)
- "Validate" button visible
- Modal title: "Merge License Plates"

### AC-16: Desktop UI - Validation Display

**Given** merge modal is open with selected LPs
**When** user clicks "Validate" button
**Then**
- Validation runs in background
- Loading spinner displayed during validation
- Validation results appear:
  - Green checkmark if valid: "LPs are eligible for merge"
  - Red X if invalid: List of errors (e.g., "Different products detected")
- Summary section shows:
  - Product name
  - Total quantity (sum)
  - Batch number
  - Expiry date
  - QA status
  - LP count

### AC-17: Desktop UI - Merge Confirmation

**Given** validation passed
**When** user clicks "Merge LPs" button
**Then**
- Confirmation dialog appears:
  - "Are you sure you want to merge these X LPs?"
  - "This will create 1 new LP and mark source LPs as consumed. This action cannot be undone."
  - "Cancel" and "Confirm Merge" buttons

### AC-18: Desktop UI - Merge Success

**Given** user confirms merge
**When** merge API call succeeds
**Then**
- Success toast notification: "LPs merged successfully. New LP: LP00000123"
- Modal closes
- LP list refreshes to show new LP
- Source LPs removed from list (status='consumed', hidden by default filter)
- Clicking "View New LP" link navigates to new LP detail page

### AC-19: Desktop UI - Merge Error Handling

**Given** user confirms merge
**When** merge API call fails (e.g., 409 Conflict - one LP was reserved during operation)
**Then**
- Error toast notification: "Merge failed: LP-002 is no longer available (status changed to 'reserved')"
- Modal stays open with error message
- User can close modal or retry
- No LPs modified

### AC-20: Desktop UI - Location Selection

**Given** merge modal is open and validation passed
**When** user selects target location from dropdown (locations in same warehouse)
**Then**
- Target location ID saved
- Summary updates: "New LP will be created at: [Location Name]"
- If not selected, defaults to first source LP's location

### AC-21: Transaction Atomicity

**Given** merge operation in progress
**When** any step fails (e.g., LP update, genealogy creation)
**Then**
- Entire transaction rolled back
- No new LP created
- Source LPs unchanged (status='available')
- No genealogy records created
- Error returned to client with details

### AC-22: Merge Audit Trail

**Given** successful merge operation
**When** merge completes
**Then**
- New LP has `created_at` timestamp
- New LP has `created_by` = current user ID
- Source LPs have `updated_at` timestamp refreshed
- Genealogy records have `created_at` timestamp
- All changes logged for audit

### AC-23: RLS Enforcement - Cross-Tenant Protection

**Given** user from Org A attempts to merge LPs from Org B
**When** API call made with Org B LP IDs
**Then**
- API returns 404 Not Found (RLS blocks access)
- No merge performed
- Audit log records unauthorized attempt

### AC-24: Performance - Merge Multiple LPs

**Given** merge of 5 LPs (large merge)
**When** merge operation executes
**Then**
- Operation completes in <800ms
- Transaction overhead minimal
- Database locks held briefly
- No deadlocks occur

### AC-25: Genealogy Integration - Merge Links

**Given** successful merge of LP-001 and LP-002 into LP-003
**When** viewing LP-003 genealogy panel
**Then**
- Backward trace shows:
  - LP-001 (depth 1, operation_type='merge', quantity=50)
  - LP-002 (depth 1, operation_type='merge', quantity=30)
- Forward trace empty (no descendants yet)
- Genealogy operation_date = merge timestamp

---

## Implementation Notes

### API Endpoints

```typescript
// Validate merge eligibility
POST /api/warehouse/license-plates/validate-merge
Body: {
  sourceLpIds: string[];  // UUIDs of LPs to merge
}
Response: {
  valid: boolean;
  errors: string[];  // Validation error messages
  summary?: {
    productName: string;
    productCode: string;
    totalQuantity: number;
    uom: string;
    batchNumber: string | null;
    expiryDate: string | null;
    qaStatus: QAStatus;
    warehouse: string;
    lpCount: number;
  };
}

// Perform merge
POST /api/warehouse/license-plates/merge
Body: {
  sourceLpIds: string[];      // UUIDs of LPs to merge (min 2)
  targetLocationId?: string;  // Optional target location (defaults to first LP's location)
}
Response: {
  newLpId: string;
  newLpNumber: string;
  mergedQuantity: number;
  sourceLpIds: string[];
}
```

### Service Layer

```typescript
// lib/services/license-plate-service.ts

export interface MergeValidationResult {
  valid: boolean;
  errors: string[];
  summary?: {
    productId: string;
    productName: string;
    productCode: string;
    totalQuantity: number;
    uom: string;
    batchNumber: string | null;
    expiryDate: string | null;
    qaStatus: QAStatus;
    warehouseId: string;
    warehouseName: string;
    lpCount: number;
  };
}

export interface MergeInput {
  sourceLpIds: string[];
  targetLocationId?: string;
}

export interface MergeResult {
  newLpId: string;
  newLpNumber: string;
  mergedQuantity: number;
  sourceLpIds: string[];
}

export class LicensePlateService {
  /**
   * Validate if LPs are eligible for merge
   * Returns validation result with errors or summary
   */
  static async validateMerge(sourceLpIds: string[]): Promise<MergeValidationResult> {
    // 1. Check minimum 2 LPs
    if (sourceLpIds.length < 2) {
      return {
        valid: false,
        errors: ['At least 2 LPs required for merge operation'],
      };
    }

    // 2. Fetch all LPs with product/warehouse info
    const lps = await this.getByIds(sourceLpIds);

    // Check all LPs found
    const missingIds = sourceLpIds.filter(
      id => !lps.find(lp => lp.id === id)
    );
    if (missingIds.length > 0) {
      return {
        valid: false,
        errors: [`LPs not found: ${missingIds.join(', ')}`],
      };
    }

    const errors: string[] = [];

    // 3. Validate same product
    const productIds = [...new Set(lps.map(lp => lp.product_id))];
    if (productIds.length > 1) {
      errors.push('All LPs must be the same product for merge');
    }

    // 4. Validate same batch (NULL counts as a value)
    const batches = [...new Set(lps.map(lp => lp.batch_number ?? 'NULL'))];
    if (batches.length > 1) {
      errors.push('All LPs must have the same batch number for merge');
    }

    // 5. Validate same expiry (NULL counts as a value)
    const expiries = [...new Set(lps.map(lp => lp.expiry_date ?? 'NULL'))];
    if (expiries.length > 1) {
      errors.push('All LPs must have the same expiry date for merge');
    }

    // 6. Validate same QA status
    const qaStatuses = [...new Set(lps.map(lp => lp.qa_status))];
    if (qaStatuses.length > 1) {
      errors.push('All LPs must have the same QA status for merge');
    }

    // 7. Validate all available
    const nonAvailable = lps.filter(lp => lp.status !== 'available');
    if (nonAvailable.length > 0) {
      const lpNumbers = nonAvailable.map(lp => lp.lp_number).join(', ');
      errors.push(`All LPs must have status='available'. Non-available: ${lpNumbers}`);
    }

    // 8. Validate same warehouse
    const warehouseIds = [...new Set(lps.map(lp => lp.warehouse_id))];
    if (warehouseIds.length > 1) {
      errors.push('All LPs must be in the same warehouse for merge');
    }

    // 9. Validate same UoM
    const uoms = [...new Set(lps.map(lp => lp.uom))];
    if (uoms.length > 1) {
      errors.push('All LPs must have the same UoM for merge');
    }

    if (errors.length > 0) {
      return { valid: false, errors };
    }

    // Build summary
    const firstLP = lps[0];
    const totalQuantity = lps.reduce((sum, lp) => sum + lp.quantity, 0);

    return {
      valid: true,
      errors: [],
      summary: {
        productId: firstLP.product_id,
        productName: firstLP.product?.name || '',
        productCode: firstLP.product?.code || '',
        totalQuantity,
        uom: firstLP.uom,
        batchNumber: firstLP.batch_number,
        expiryDate: firstLP.expiry_date,
        qaStatus: firstLP.qa_status,
        warehouseId: firstLP.warehouse_id,
        warehouseName: firstLP.warehouse?.name || '',
        lpCount: lps.length,
      },
    };
  }

  /**
   * Merge multiple LPs into one
   * Transaction ensures atomicity
   */
  static async merge(input: MergeInput): Promise<MergeResult> {
    const { sourceLpIds, targetLocationId } = input;

    // 1. Validate merge
    const validation = await this.validateMerge(sourceLpIds);
    if (!validation.valid) {
      throw new ValidationError(`Merge validation failed: ${validation.errors.join('; ')}`);
    }

    const { summary } = validation;
    if (!summary) {
      throw new Error('Validation summary missing');
    }

    // 2. Fetch source LPs
    const sourceLPs = await this.getByIds(sourceLpIds);

    // 3. Determine target location
    const locationId = targetLocationId || sourceLPs[0].location_id;

    // Validate target location is in same warehouse
    const location = await getLocation(locationId);
    if (location.warehouse_id !== summary.warehouseId) {
      throw new ValidationError('Target location must be in the same warehouse as source LPs');
    }

    // 4. Begin transaction
    return await supabase.transaction(async (txn) => {
      // 4a. Create new merged LP
      const newLP = await txn
        .from('license_plates')
        .insert({
          org_id: sourceLPs[0].org_id,
          product_id: summary.productId,
          quantity: summary.totalQuantity,
          uom: summary.uom,
          location_id: locationId,
          warehouse_id: summary.warehouseId,
          status: 'available',
          qa_status: summary.qaStatus,
          batch_number: summary.batchNumber,
          expiry_date: summary.expiryDate,
          source: 'merge',
          parent_lp_id: sourceLPs[0].id,  // First source LP
          manufacture_date: sourceLPs[0].manufacture_date,  // Copy from first
          created_by: await getUserId(),
        })
        .select()
        .single();

      if (!newLP.data) {
        throw new Error('Failed to create merged LP');
      }

      // 4b. Mark source LPs as consumed
      for (const sourceLP of sourceLPs) {
        await txn
          .from('license_plates')
          .update({
            status: 'consumed',
            consumed_by_wo_id: null,  // NULL = warehouse operation, not production
            updated_at: new Date().toISOString(),
          })
          .eq('id', sourceLP.id);
      }

      // 4c. Create genealogy links (use Story 05.2 service)
      await LPGenealogyService.linkMerge(
        sourceLpIds,
        newLP.data.id,
        { txn }  // Pass transaction context
      );

      return {
        newLpId: newLP.data.id,
        newLpNumber: newLP.data.lp_number,
        mergedQuantity: summary.totalQuantity,
        sourceLpIds,
      };
    });
  }

  /**
   * Get multiple LPs by IDs
   */
  static async getByIds(ids: string[]): Promise<LicensePlate[]> {
    const { data, error } = await supabase
      .from('license_plates')
      .select(`
        *,
        product:products(name, code),
        warehouse:warehouses(name, code)
      `)
      .in('id', ids);

    if (error) throw error;
    return data || [];
  }
}
```

### Validation Schema (Zod)

```typescript
// lib/validation/license-plate.ts

export const validateMergeSchema = z.object({
  sourceLpIds: z.array(z.string().uuid('Invalid LP ID'))
    .min(2, 'At least 2 LPs required for merge')
    .max(20, 'Maximum 20 LPs can be merged at once'),
});

export const mergeLPSchema = z.object({
  sourceLpIds: z.array(z.string().uuid('Invalid LP ID'))
    .min(2, 'At least 2 LPs required for merge')
    .max(20, 'Maximum 20 LPs can be merged at once'),
  targetLocationId: z.string().uuid('Invalid location ID').optional(),
});

export type ValidateMergeInput = z.infer<typeof validateMergeSchema>;
export type MergeLPInput = z.infer<typeof mergeLPSchema>;
```

---

## UI Components

```
app/(authenticated)/warehouse/license-plates/
  components/
    LPMergeModal.tsx                   -- Main merge modal
    LPMergeValidation.tsx              -- Validation display section
    LPMergeSummary.tsx                 -- Summary card (product, qty, batch, expiry)
    LPMergeSelectedList.tsx            -- Table of selected LPs
    LPMergeLocationPicker.tsx          -- Location dropdown (filtered by warehouse)
    LPMergeConfirmDialog.tsx           -- Confirmation dialog
```

### Badge Colors (TailwindCSS)

| Validation Status | Badge Class |
|-------------------|-------------|
| Valid | `bg-green-100 text-green-800` |
| Invalid | `bg-red-100 text-red-800` |
| Checking | `bg-yellow-100 text-yellow-800` |

---

## Key Business Rules

1. **Same Product Requirement**: All LPs must have the same `product_id` for merge
2. **Same Batch Requirement**: All LPs must have the same `batch_number` (NULL counts as a value)
3. **Same Expiry Requirement**: All LPs must have the same `expiry_date` (NULL counts as a value)
4. **Same QA Status Requirement**: All LPs must have the same `qa_status`
5. **Available Status Requirement**: All LPs must have `status='available'` (not reserved/consumed/blocked)
6. **Same Warehouse Requirement**: All LPs must be in the same `warehouse_id`
7. **Same UoM Requirement**: All LPs must have the same `uom` (no UoM conversion in MVP)
8. **Minimum 2 LPs**: At least 2 LPs required for merge operation
9. **Atomicity**: Merge is a transaction - all steps succeed or all fail (no partial merge)
10. **Genealogy Tracking**: All source LPs linked to new LP via `lp_genealogy` with operation_type='merge'
11. **Source LP Consumed**: Source LPs marked as `status='consumed'` with `consumed_by_wo_id=NULL` (warehouse operation)
12. **New LP Source**: New LP has `source='merge'` and `parent_lp_id` set to first source LP
13. **Location Handling**: New LP created at target location (or defaults to first source LP's location)
14. **Audit Trail**: All operations logged with timestamps and user IDs

---

## Deliverables

### API Routes
- [ ] `POST /api/warehouse/license-plates/validate-merge` - Validate merge eligibility
- [ ] `POST /api/warehouse/license-plates/merge` - Perform merge operation

### Service Layer
- [ ] `LicensePlateService.validateMerge()` - Pre-merge validation with detailed errors
- [ ] `LicensePlateService.merge()` - Main merge method with transaction
- [ ] `LicensePlateService.getByIds()` - Fetch multiple LPs

### Validation
- [ ] `validateMergeSchema` - Validation input schema
- [ ] `mergeLPSchema` - Merge input schema

### Frontend
- [ ] `LPMergeModal.tsx` - Main merge modal
- [ ] `LPMergeValidation.tsx` - Validation display
- [ ] `LPMergeSummary.tsx` - Summary card
- [ ] `LPMergeSelectedList.tsx` - Selected LPs table
- [ ] `LPMergeLocationPicker.tsx` - Location selector
- [ ] `LPMergeConfirmDialog.tsx` - Confirmation dialog

### Tests
- [ ] Unit tests: Merge validation (all rules)
- [ ] Unit tests: Merge operation (success cases)
- [ ] Unit tests: Merge transaction rollback (failure cases)
- [ ] Integration tests: Merge API endpoints
- [ ] Integration tests: RLS enforcement
- [ ] E2E test: Desktop merge workflow (select, validate, merge)

---

## Test Cases

### Unit Tests

**File:** `__tests__/unit/services/license-plate-merge.test.ts`

| Test Case | Description |
|-----------|-------------|
| `validateMerge()` requires minimum 2 LPs | Error if less than 2 |
| `validateMerge()` requires same product | Error if different products |
| `validateMerge()` requires same batch | Error if different batches |
| `validateMerge()` requires same expiry | Error if different expiries |
| `validateMerge()` requires same QA status | Error if different QA statuses |
| `validateMerge()` requires all available | Error if any LP not available |
| `validateMerge()` requires same warehouse | Error if different warehouses |
| `validateMerge()` requires same UoM | Error if different UoMs |
| `validateMerge()` allows NULL batch/expiry match | NULL == NULL passes |
| `validateMerge()` returns summary on success | Summary includes total qty |
| `merge()` creates new LP with combined quantity | Qty sum correct |
| `merge()` marks source LPs as consumed | Status updated |
| `merge()` creates genealogy links | Genealogy records exist |
| `merge()` rolls back on failure | Transaction atomicity |
| `merge()` defaults to first LP location | Location inheritance |
| `merge()` respects target location | Target location used |
| `merge()` throws if target location in different warehouse | Validation error |

### Integration Tests

**File:** `__tests__/integration/api/warehouse/license-plates-merge.test.ts`

| Test Case | Description |
|-----------|-------------|
| POST `/validate-merge` returns validation result | Valid/invalid detection |
| POST `/validate-merge` with invalid LPs returns errors | Error messages |
| POST `/validate-merge` with valid LPs returns summary | Summary correct |
| POST `/merge` with valid LPs creates merged LP | Merge succeeds |
| POST `/merge` with invalid LPs returns 400 | Validation failure |
| POST `/merge` creates genealogy records | Genealogy links exist |
| POST `/merge` marks source LPs as consumed | Status=consumed |
| POST `/merge` with cross-org LPs returns 404 | RLS enforced |
| POST `/merge` response time <800ms | Performance acceptable |

### E2E Tests

**File:** `__tests__/e2e/warehouse/lp-merge.spec.ts`

| Test Case | Description |
|-----------|-------------|
| Select 2 LPs and open merge modal | Modal opens |
| Click validate and see results | Validation display |
| Confirm merge and see success | Merge completes |
| New LP appears in list | List refresh |
| Source LPs hidden (consumed) | Filter applied |
| Error handling on merge failure | Error toast |

---

## Definition of Done

### API
- [ ] `POST /api/warehouse/license-plates/validate-merge` endpoint implemented
- [ ] `POST /api/warehouse/license-plates/merge` endpoint implemented
- [ ] All validation rules enforced
- [ ] Transaction atomicity verified
- [ ] Error messages clear and actionable
- [ ] Response times meet requirements:
  - Validate merge: < 200ms
  - Merge operation: < 800ms (5 LPs)

### Service
- [ ] `validateMerge()` method working with all rules
- [ ] `merge()` method working with transaction
- [ ] Genealogy integration working (`linkMerge()` called)
- [ ] Location handling correct (default and explicit)
- [ ] RLS enforcement verified

### Frontend
- [ ] Merge modal implemented
- [ ] Multi-select LP picker working
- [ ] Validation display showing errors/summary
- [ ] Location picker filtered by warehouse
- [ ] Confirmation dialog before merge
- [ ] Success/error notifications
- [ ] LP list refresh after merge
- [ ] Loading states during validation/merge

### Testing
- [ ] Unit tests: >80% coverage on merge service
- [ ] Integration tests: All merge API scenarios
- [ ] E2E test: Full merge workflow
- [ ] RLS tests: Cross-tenant protection

### Documentation
- [ ] API endpoints documented
- [ ] Service methods have JSDoc
- [ ] Business rules documented
- [ ] Validation rules clear

---

## Future Phases (Not in This Story)

### Story 05.21 - Scanner LP Merge
- Scanner interface for merge operation
- Barcode scan to select source LPs
- Simplified mobile UI for merge

### Phase 3 - Advanced Merge Features
- Cross-warehouse merge (with transfer logic)
- UoM conversion during merge (e.g., merge KG + LB LPs)
- Merge of mixed QA statuses (with approval workflow)
- Batch merge (merge 20+ LPs at once)
- Merge undo/reversal (complex genealogy reversal)

### Phase 4 - Merge Analytics
- Merge operation audit report
- Most merged products
- Merge frequency by warehouse
- Average merge size (LP count, quantity)

---

## Risk Assessment

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Transaction deadlock (concurrent merges) | MEDIUM | LOW | Use row-level locks, retry logic |
| Validation race condition (LP status changes during operation) | MEDIUM | MEDIUM | Re-validate in transaction, return clear error |
| Genealogy link failure | HIGH | LOW | Transaction rollback ensures atomicity |
| UoM confusion (users expect conversion) | LOW | MEDIUM | Clear error message, document limitation |
| Performance with 10+ LPs | LOW | LOW | Batch operations optimized, transaction kept short |

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-12-16 | Initial story creation - LP merge workflow | Claude Sonnet 4.5 |
