# 05.12 - GRN from TO (Transfer Order Receipt)

| Field | Value |
|-------|-------|
| **Story ID** | 05.12 |
| **Epic** | 05 - Warehouse |
| **Status** | Ready |
| **Phase** | Phase 1 (Goods Receipt) |
| **Priority** | P1 |
| **Complexity** | M (Medium) |
| **Estimate** | 3-4 days |
| **Type** | Backend + Frontend |
| **Model** | SONNET |

---

## PRD References

| FR ID | Requirement | Priority | Coverage |
|-------|-------------|----------|----------|
| WH-FR-004 | GRN from TO (receive goods from TO, update TO status) | P0 | Full |
| WH-FR-001 | LP Creation (auto/manual numbering) | P0 | Integrated |
| WH-FR-009 | Batch Tracking (entry per line) | P0 | Full |
| WH-FR-010 | Expiry Tracking (entry per line) | P0 | Full |

**Primary PRD:** `docs/1-BASELINE/product/modules/warehouse.md`
**Architecture:** `docs/1-BASELINE/architecture/modules/warehouse.md`
**Planning PRD:** `docs/1-BASELINE/product/modules/planning.md` (TO structure)

---

## MVP Scope

### In Scope (This Story)

1. **API Endpoint: POST /api/warehouse/grns/from-to/:toId**
   - Validate TO exists and is receivable (status = shipped/partial)
   - Accept array of line items with quantities, batch, expiry
   - Create GRN header record with source_type='to'
   - Create GRN item records with LP links
   - Create License Plates (one per line received)
   - Update `to_lines.received_qty` atomically
   - Update TO status (partial -> partial/received based on completion)
   - Handle variance between shipped_qty and received_qty
   - Return created GRN with LP details

2. **Transit Location Handling**
   - If `enable_transit_location=true`, move existing LP from transit to destination
   - If false, create new LP at destination warehouse
   - Update LP.location_id and LP.warehouse_id

3. **Partial Receipt Support**
   - Allow receiving less than shipped_qty (variance tracking)
   - Allow multiple receipts until all lines fully received
   - TO status: shipped -> partial -> received

4. **Desktop UI: Receive TO Wizard (Multi-Step)**
   - Step 1: Select TO from pending list (status=shipped/partial)
   - Step 2: Review TO lines with shipped_qty and previously received_qty
   - Step 3: Enter receipt details per line (qty, variance reason if differs)
   - Step 4: Review and confirm
   - Step 5: Success with LP numbers

5. **Service Layer**
   - `GRNService.createFromTO()` - TO receipt transaction orchestration
   - `GRNService.validateTOReceipt()` - Pre-validation
   - `GRNService.handleTransitLP()` - Transit location logic
   - Integration with `LicensePlateService.create()`

6. **Zod Validation Schemas**
   - Create GRN from TO schema
   - TO receipt line item schema
   - Variance reason validation

### Out of Scope (Other Stories)

| Feature | Deferred To | Reason |
|---------|-------------|--------|
| GRN from PO | 05.11 | Different source, already implemented |
| ASN Management | 05.8, 05.9 | Pre-receipt workflow |
| GRN Cancellation | 05.14 | Reversal workflow |
| Scanner Receive | 05.17 | Mobile workflow |
| GS1 Barcode Parsing | 05.24 | Advanced feature |
| Catch Weight Entry | 05.27 | Phase 2 feature |
| Label Printing | 05.14 | Separate story |
| Multiple LPs per line | 05.12b | Advanced split story |

---

## Epic 04 Dependency Status

- [ ] NOT CRITICAL - Does not unblock Epic 04 Phase 1
- [x] Phase 1 Story - Normal priority receiving workflow

This story provides inter-warehouse transfer receipt capability but Epic 04 (Production) does not depend on TO receiving workflows.

---

## Goal

Enable warehouse operators to receive goods from Transfer Orders at the destination warehouse, creating Goods Receipt Notes (GRN) and License Plates (LP) for each received line item, with variance tracking between shipped and received quantities.

---

## User Story

As a **Warehouse Operator at the destination warehouse**, I want to **receive goods from a Transfer Order and create License Plates with batch and expiry information** so that **inventory transferred between warehouses is properly tracked and available for consumption**.

---

## Dependencies

| Dependency | Story/Epic | Type | Status | Notes |
|------------|------------|------|--------|-------|
| 05.10 | GRN CRUD + Items | HARD | Ready | Uses grns/grn_items tables |
| 05.1 | LP Table + CRUD | HARD | Ready | Creates LPs via LP service |
| 05.0 | Warehouse Settings | HARD | Ready | Transit location settings |
| 03.8 | TO CRUD | HARD | Ready | FK to transfer_orders, to_lines |
| 01.8 | Warehouses CRUD | HARD | Ready | FK to warehouses |
| 01.9 | Locations CRUD | HARD | Ready | FK to locations |
| 02.1 | Products CRUD | HARD | Ready | FK to products |

**Dependents (What This Unblocks):**
- 05.17 (Scanner Receive) - Scanner can receive TOs
- 05.14 (GRN Cancellation) - Can cancel TO receipts

---

## Acceptance Criteria (Given/When/Then)

### AC-1: Create GRN from TO - Happy Path (WH-FR-004)

```gherkin
Scenario: Full receipt of TO creates GRN and LPs
  Given TO 'TO-2025-00001' exists with status = 'shipped'
  And TO has 3 lines:
    | Line | Product | Shipped Qty | UoM | Already Received |
    | 1 | Flour | 1000 | KG | 0 |
    | 2 | Sugar | 500 | KG | 0 |
    | 3 | Salt | 100 | KG | 0 |
  And TO destination warehouse = Warehouse B
  When POST /api/warehouse/grns/from-to/TO-2025-00001 with:
    {
      "warehouse_id": "{warehouse_b_uuid}",
      "location_id": "{location_uuid}",
      "items": [
        { "to_line_id": "{line1}", "received_qty": 1000, "batch_number": "FLOUR-2025-001", "expiry_date": "2026-06-01" },
        { "to_line_id": "{line2}", "received_qty": 500, "batch_number": "SUGAR-2025-001", "expiry_date": "2026-12-31" },
        { "to_line_id": "{line3}", "received_qty": 100, "batch_number": "SALT-2025-001" }
      ]
    }
  Then response status = 201 Created
  And GRN created with:
    | Field | Value |
    | grn_number | GRN-2025-XXXXX |
    | source_type | to |
    | to_id | {to_uuid} |
    | status | completed |
  And 3 GRN items created, each with lp_id populated
  And 3 License Plates created at Warehouse B with:
    | LP | Product | Qty | Batch | Expiry | Source |
    | LP00000001 | Flour | 1000 | FLOUR-2025-001 | 2026-06-01 | receipt |
    | LP00000002 | Sugar | 500 | SUGAR-2025-001 | 2026-12-31 | receipt |
    | LP00000003 | Salt | 100 | SALT-2025-001 | NULL | receipt |
  And TO lines updated: received_qty = shipped_qty for each
  And TO status updated to 'received' (all lines fully received)
  And response time < 500ms
```

### AC-2: Partial Receipt of TO (WH-FR-004)

```gherkin
Scenario: Partial receipt updates TO to 'partial' status
  Given TO 'TO-2025-00002' with status = 'shipped'
  And TO has line: Product=Flour, Shipped=1000 KG, Received=0
  When POST /api/warehouse/grns/from-to/TO-2025-00002 with:
    {
      "warehouse_id": "{warehouse_uuid}",
      "location_id": "{location_uuid}",
      "items": [
        { "to_line_id": "{line1}", "received_qty": 400, "batch_number": "FL-001" }
      ]
    }
  Then GRN created with status = 'completed'
  And 1 LP created with qty = 400
  And TO line.received_qty updated to 400
  And TO status updated to 'partial'

Scenario: Multiple partial receipts accumulate
  Given TO line with shipped_qty=1000, received_qty=400
  When receiving additional 300
  Then TO line.received_qty = 700
  And TO status remains 'partial'

Scenario: Final partial receipt completes TO
  Given TO line with shipped_qty=1000, received_qty=700
  When receiving remaining 300
  Then TO line.received_qty = 1000
  And TO status = 'received'
```

### AC-3: TO Status Validation (WH-FR-004)

```gherkin
Scenario: Cannot receive from draft TO
  Given TO with status = 'draft'
  When POST /api/warehouse/grns/from-to/{toId}
  Then response status = 400 Bad Request
  And error message = "Cannot receive from TO with status 'draft'. TO must be shipped or partial."

Scenario: Cannot receive from cancelled TO
  Given TO with status = 'cancelled'
  When POST /api/warehouse/grns/from-to/{toId}
  Then response status = 400 Bad Request
  And error message = "Cannot receive from cancelled TO"

Scenario: Can receive from shipped TO
  Given TO with status = 'shipped'
  When POST /api/warehouse/grns/from-to/{toId} with valid items
  Then GRN created successfully

Scenario: Can receive from partial TO
  Given TO with status = 'partial'
  When POST /api/warehouse/grns/from-to/{toId} with valid items
  Then GRN created successfully
```

### AC-4: Variance Tracking (WH-FR-004)

```gherkin
Scenario: Received qty differs from shipped qty (shortage)
  Given TO line with shipped_qty = 100
  When receiving 95 units with variance_reason = "Box damaged in transit"
  Then GRN created successfully
  And grn_items.received_qty = 95
  And grn_items.notes contains variance_reason
  And variance log records: shipped=100, received=95, variance=-5
  And TO line.received_qty = 95

Scenario: Received qty differs from shipped qty (overage)
  Given TO line with shipped_qty = 100
  When receiving 105 units with variance_reason = "Extra units found"
  Then GRN created successfully
  And grn_items.received_qty = 105
  And variance log records: shipped=100, received=105, variance=+5

Scenario: Cannot receive more than remaining quantity
  Given TO line with shipped_qty = 100, received_qty = 80
  When attempting to receive 30 units (total would be 110)
  Then response status = 400 Bad Request
  And error message = "Cannot receive more than shipped quantity. Shipped: 100, Already received: 80, Attempting: 30"
```

### AC-5: Transit Location Handling (WH-FR-004)

```gherkin
Scenario: Move LP from transit location to destination
  Given warehouse_settings.enable_transit_location = true
  And TO line has transit LP 'LP00000050' at transit location 'TRANSIT-A'
  And TO destination warehouse = Warehouse B, location = 'ZONE-A'
  When receiving TO line
  Then existing LP 'LP00000050' moved to 'ZONE-A'
  And LP.warehouse_id updated to Warehouse B
  And LP.location_id updated to 'ZONE-A'
  And no new LP created (reuse existing transit LP)

Scenario: Create new LP when transit location disabled
  Given warehouse_settings.enable_transit_location = false
  When receiving TO line
  Then new LP created at destination warehouse
  And LP.source = 'receipt'
  And LP.warehouse_id = destination warehouse
```

### AC-6: Warehouse Destination Validation

```gherkin
Scenario: Must receive at TO destination warehouse
  Given TO with from_warehouse_id = Warehouse A, to_warehouse_id = Warehouse B
  When POST /api/warehouse/grns/from-to/{toId} with warehouse_id = Warehouse A
  Then response status = 400 Bad Request
  And error message = "Receipt must occur at destination warehouse (Warehouse B)"

Scenario: Receipt warehouse matches TO destination
  Given TO with to_warehouse_id = Warehouse B
  When POST /api/warehouse/grns/from-to/{toId} with warehouse_id = Warehouse B
  Then GRN created successfully at Warehouse B
```

### AC-7: Batch Required Validation (WH-FR-009)

```gherkin
Scenario: Batch required when setting enabled
  Given warehouse_settings.require_batch_on_receipt = true
  When receiving without batch_number
  Then response status = 400 Bad Request
  And error message = "Batch number required for receipt"

Scenario: Batch optional when setting disabled
  Given warehouse_settings.require_batch_on_receipt = false
  When receiving without batch_number
  Then GRN and LP created with batch_number = NULL
```

### AC-8: Expiry Required Validation (WH-FR-010)

```gherkin
Scenario: Expiry required when setting enabled
  Given warehouse_settings.require_expiry_on_receipt = true
  When receiving without expiry_date
  Then response status = 400 Bad Request
  And error message = "Expiry date required for receipt"

Scenario: Expiry optional when setting disabled
  Given warehouse_settings.require_expiry_on_receipt = false
  When receiving without expiry_date
  Then GRN and LP created with expiry_date = NULL

Scenario: Expiry auto-calculated from manufacture date
  Given product.shelf_life_days = 90
  And receiving with manufacture_date = '2025-12-16' and no expiry_date
  Then LP.expiry_date = '2026-03-16'
```

### AC-9: LP Creation Details (WH-FR-001)

```gherkin
Scenario: LP inherits correct values from TO receipt
  Given TO receipt with:
    | Field | Value |
    | product_id | {product_uuid} |
    | received_qty | 500 |
    | batch_number | BATCH-001 |
    | expiry_date | 2026-06-01 |
    | location_id | {location_uuid} |
  When GRN completed
  Then LP created with:
    | Field | Value |
    | product_id | {product_uuid} |
    | quantity | 500 |
    | uom | (from product) |
    | location_id | {location_uuid} |
    | warehouse_id | (destination warehouse) |
    | status | available |
    | qa_status | (from warehouse_settings.default_qa_status) |
    | batch_number | BATCH-001 |
    | expiry_date | 2026-06-01 |
    | source | receipt |
    | grn_id | {grn_uuid} |

Scenario: LP auto-generates number
  Given warehouse_settings.auto_generate_lp_number = true
  When LP created via TO receipt
  Then LP.lp_number follows configured format (e.g., LP00000001)
```

### AC-10: Desktop UI - Receive TO Wizard

```gherkin
Scenario: Step 1 - Select TO
  Given user navigates to /warehouse/receiving
  When page loads
  Then list of receivable TOs displayed (status in [shipped, partial])
  And columns show: TO Number, From Warehouse, To Warehouse, Shipped Date, Lines, Status
  And user can search by TO number or warehouse
  And user can click TO to start receiving

Scenario: Step 2 - Review TO Lines
  Given user selected TO 'TO-2025-00001'
  Then TO header info displayed (from warehouse, to warehouse, shipped date)
  And TO lines table shows:
    | Column | Description |
    | Product | Product name/code |
    | Shipped Qty | Quantity shipped from source |
    | Already Received | Sum of previous GRN receipts |
    | Remaining | Shipped - Already Received |
    | UoM | Unit of measure |
  And "Receive All" button available to auto-fill remaining qty

Scenario: Step 3 - Enter Receipt Details
  Given user reviewing TO lines
  When user enters receipt details for each line:
    | Field | Required | Notes |
    | Receive Qty | Yes | Editable, default = Remaining |
    | Variance Reason | If differs from shipped | Text field appears if qty != remaining |
    | Batch Number | If setting enabled | Manual entry |
    | Expiry Date | If setting enabled | Date picker |
    | Manufacture Date | No | Date picker |
    | Location | No | Override default, dropdown |
    | Notes | No | Free text |
  Then validation runs in real-time
  And variance warnings displayed inline if received_qty != shipped_qty
  And batch/expiry required indicators shown

Scenario: Step 4 - Review and Confirm
  Given all line details entered
  When user clicks "Review Receipt"
  Then summary modal shows:
    | Section | Content |
    | TO Info | TO number, from/to warehouses |
    | Lines | List of items being received |
    | LPs to Create | Preview of LP numbers (if auto-generate) |
    | Variances | Warning if any qty differs from shipped |
    | Totals | Total items, total quantity |
  And user can go back to edit
  And "Confirm Receipt" button enabled if validation passes

Scenario: Step 5 - Success
  Given user confirmed receipt
  When GRN created successfully
  Then success modal displays:
    | Field | Value |
    | GRN Number | GRN-2025-00001 |
    | Items Received | 3 |
    | LPs Created | LP00000001, LP00000002, LP00000003 |
  And "Print Labels" button available (disabled if label printing not configured)
  And "Receive Another" button available
  And "View GRN" button navigates to GRN detail

Scenario: Wizard handles validation errors
  Given user enters invalid data (e.g., missing required batch)
  When attempting to proceed
  Then inline error messages displayed
  And user cannot proceed until errors fixed
```

### AC-11: RLS Policy Enforcement

```gherkin
Scenario: Org isolation on TO receipt
  Given User A from Org A and User B from Org B
  And TOs exist in both orgs
  When User A requests /api/warehouse/grns/from-to/{toId}
  Then only Org A TOs can be received
  And Org B TO returns 404 Not Found

Scenario: Cannot receive TO from different org
  Given User A from Org A
  And TO belongs to Org B
  When User A attempts POST /api/warehouse/grns/from-to/{orgB_to_id}
  Then 404 Not Found returned

Scenario: GRN inherits org_id from authenticated user
  Given User A from Org A
  When creating GRN from TO
  Then GRN.org_id = Org A (automatic)
```

### AC-12: Transaction Atomicity

```gherkin
Scenario: Failed LP creation rolls back GRN
  Given valid TO and receipt data
  And LP creation fails (e.g., database error)
  When attempting to create GRN from TO
  Then entire transaction rolled back
  And no GRN created
  And no GRN items created
  And TO lines not updated
  And error message returned

Scenario: Failed TO line update rolls back everything
  Given valid TO and receipt data
  And TO line update fails
  When attempting to create GRN
  Then entire transaction rolled back
  And LPs not created (or deleted if created)
  And GRN not created
```

### AC-13: Performance Requirements

```gherkin
Scenario: GRN creation performance
  Given TO with 10 lines
  When creating GRN for all 10 lines
  Then operation completes in < 500ms

Scenario: TO line lookup performance
  Given TO with 50 lines
  When loading for receive wizard
  Then response time < 300ms
```

### AC-14: Audit Trail

```gherkin
Scenario: GRN creation audit
  When GRN from TO created
  Then audit log records:
    | Field | Value |
    | action | grn_created |
    | grn_id | {uuid} |
    | to_id | {uuid} |
    | user_id | {current_user} |
    | timestamp | NOW() |
    | items_count | N |

Scenario: Variance audit
  When receiving with variance
  Then audit log records:
    | Field | Value |
    | action | to_receipt_variance |
    | grn_id | {uuid} |
    | to_line_id | {uuid} |
    | shipped_qty | 100 |
    | received_qty | 95 |
    | variance_qty | -5 |
    | variance_reason | "Box damaged" |
```

### AC-15: QA Status on Receipt

```gherkin
Scenario: LP QA status from settings
  Given warehouse_settings.require_qa_on_receipt = true
  And warehouse_settings.default_qa_status = 'pending'
  When LP created via TO receipt
  Then LP.qa_status = 'pending'

Scenario: LP QA status when QA not required
  Given warehouse_settings.require_qa_on_receipt = false
  When LP created via TO receipt
  Then LP.qa_status = 'passed' (auto-approved)
```

---

## Technical Specification

### Database Schema

The `grns` and `grn_items` tables already exist from Story 05.10 and 05.11. This story uses the same tables with `source_type='to'` and `to_id` populated.

```sql
-- No new tables required, reusing existing GRN infrastructure

-- Key fields used in this story:
-- grns.source_type = 'to'
-- grns.to_id = {transfer_order_uuid}
-- grn_items.to_line_id = {to_line_uuid}
```

### API Endpoints

```
# TO Receipt Endpoints
POST   /api/warehouse/grns/from-to/:toId                - Create GRN from TO

# Supporting Endpoints
GET    /api/warehouse/receiving/pending-tos            - List receivable TOs
GET    /api/warehouse/receiving/to/:toId/lines         - Get TO lines for receive wizard
```

**POST /api/warehouse/grns/from-to/:toId Request Body:**

```typescript
interface CreateGRNFromTORequest {
  warehouse_id: string;           // UUID - receiving warehouse (must match TO.to_warehouse_id)
  location_id: string;            // UUID - default receiving location
  notes?: string;                 // Optional GRN notes
  items: {
    to_line_id: string;           // UUID - which TO line
    received_qty: number;         // Quantity being received
    variance_reason?: string;     // Required if received_qty != shipped_qty
    batch_number?: string;        // Internal batch
    supplier_batch_number?: string; // Source warehouse batch (if different)
    expiry_date?: string;         // YYYY-MM-DD
    manufacture_date?: string;    // YYYY-MM-DD
    location_id?: string;         // UUID - override default location
    notes?: string;               // Line notes
  }[];
}
```

**POST /api/warehouse/grns/from-to/:toId Response:**

```typescript
interface CreateGRNFromTOResponse {
  grn: {
    id: string;
    grn_number: string;
    source_type: 'to';
    to_id: string;
    from_warehouse_id: string;
    to_warehouse_id: string;
    receipt_date: string;
    warehouse_id: string;
    location_id: string;
    status: 'completed';
    notes: string | null;
    created_at: string;
    received_by: string;
  };
  items: {
    id: string;
    product_id: string;
    product_name: string;
    shipped_qty: number;
    received_qty: number;
    variance_qty: number;          // shipped_qty - received_qty
    variance_reason: string | null;
    uom: string;
    lp_id: string;
    lp_number: string;
    batch_number: string | null;
    expiry_date: string | null;
    location_id: string;
    qa_status: string;
  }[];
  to_status: string;              // Updated TO status
  variances: {
    to_line_id: string;
    product_name: string;
    shipped_qty: number;
    received_qty: number;
    variance_qty: number;
    variance_pct: number;
  }[];
}
```

### Service Layer

```typescript
// lib/services/grn-service.ts (extend existing)

export interface CreateGRNFromTOInput {
  toId: string;
  warehouseId: string;
  locationId: string;
  notes?: string;
  items: {
    toLineId: string;
    receivedQty: number;
    varianceReason?: string;
    batchNumber?: string;
    supplierBatchNumber?: string;
    expiryDate?: string;
    manufactureDate?: string;
    locationId?: string;
    notes?: string;
  }[];
}

export interface TOVariance {
  toLineId: string;
  productName: string;
  shippedQty: number;
  receivedQty: number;
  varianceQty: number;
  variancePct: number;
}

export class GRNService {
  // ==========================================================================
  // TO Receipt Operations (NEW)
  // ==========================================================================

  /**
   * Create GRN from Transfer Order
   * - Validates TO status and destination warehouse
   * - Creates GRN header and items with source_type='to'
   * - Creates License Plates via LP service (or moves transit LPs)
   * - Updates TO line received quantities
   * - Updates TO status
   * - Tracks variances between shipped and received quantities
   * - All within single transaction
   */
  static async createFromTO(input: CreateGRNFromTOInput): Promise<GRN>;

  /**
   * Validate TO receipt data before committing
   * Returns validation errors and warnings (e.g., variance without reason)
   */
  static async validateTOReceipt(input: CreateGRNFromTOInput): Promise<GRNValidationResult>;

  /**
   * Handle transit location logic
   * If enable_transit_location=true, move existing transit LP
   * If false, create new LP at destination
   */
  static async handleTransitLP(
    toLineId: string,
    warehouseId: string,
    locationId: string
  ): Promise<string>; // Returns LP ID

  /**
   * Calculate variance for a TO line
   */
  static async calculateTOVariance(
    toLineId: string,
    receivedQty: number
  ): Promise<TOVariance>;

  // ==========================================================================
  // Support Operations (NEW)
  // ==========================================================================

  /**
   * Get receivable TOs (status in shipped, partial)
   * Filtered by destination warehouse if provided
   */
  static async getReceivableTOs(warehouseId?: string): Promise<TransferOrder[]>;

  /**
   * Get TO lines with current received quantities
   */
  static async getTOLinesForReceipt(toId: string): Promise<TOLineWithReceived[]>;

  /**
   * Check if TO is fully received
   */
  static async isTOFullyReceived(toId: string): Promise<boolean>;

  /**
   * Update TO status based on receipt status
   */
  static async updateTOStatus(toId: string): Promise<void>;
}
```

### Validation Schema (Zod)

```typescript
// lib/validation/grn.ts (extend existing)

export const createGRNItemFromTOSchema = z.object({
  to_line_id: z.string().uuid("Invalid TO line ID"),
  received_qty: z.number()
    .positive("Received quantity must be positive")
    .max(999999999, "Quantity too large"),
  variance_reason: z.string()
    .max(500, "Variance reason max 500 characters")
    .nullable()
    .optional(),
  batch_number: z.string()
    .max(100, "Batch number max 100 characters")
    .nullable()
    .optional(),
  supplier_batch_number: z.string()
    .max(100, "Supplier batch number max 100 characters")
    .nullable()
    .optional(),
  expiry_date: z.string()
    .regex(/^\d{4}-\d{2}-\d{2}$/, "Invalid date format (YYYY-MM-DD)")
    .nullable()
    .optional(),
  manufacture_date: z.string()
    .regex(/^\d{4}-\d{2}-\d{2}$/, "Invalid date format (YYYY-MM-DD)")
    .nullable()
    .optional(),
  location_id: z.string().uuid("Invalid location ID").optional(),
  notes: z.string().max(500).nullable().optional(),
});

export const createGRNFromTOSchema = z.object({
  warehouse_id: z.string().uuid("Invalid warehouse ID"),
  location_id: z.string().uuid("Invalid location ID"),
  notes: z.string().max(2000).optional(),
  items: z.array(createGRNItemFromTOSchema)
    .min(1, "At least one item required")
    .max(100, "Maximum 100 items per GRN"),
});

export type CreateGRNFromTOInput = z.infer<typeof createGRNFromTOSchema>;
```

---

## UI Components

```
app/(authenticated)/warehouse/
  receiving/
    page.tsx                           -- Receive TO wizard / pending TOs list (extend existing)
    [toId]/
      page.tsx                         -- Receive specific TO (wizard)

components/warehouse/receiving/
  ReceiveTOWizard.tsx                  -- Multi-step wizard for TO receipt
  ReceivingStep1SelectTO.tsx           -- Step 1: Select TO (new)
  ReceivingStep2ReviewTOLines.tsx      -- Step 2: Review TO lines (new)
  ReceivingStep3EnterTODetails.tsx     -- Step 3: Enter receipt details (new)
  ReceivingStep4ConfirmTO.tsx          -- Step 4: Review and confirm (new)
  ReceivingStep5Success.tsx            -- Step 5: Success (reuse existing)
  PendingTOsTable.tsx                  -- List of receivable TOs (new)
  TOLinesTable.tsx                     -- TO lines with receive inputs (new)
  ReceiveTOLineForm.tsx                -- Single line receipt form (new)
  VarianceInputs.tsx                   -- Variance reason input (new)
  BatchExpiryInputs.tsx                -- Batch/expiry form fields (reuse existing)
```

---

## Key Business Rules

1. **TO Status for Receiving**: Only TOs with status in ['shipped', 'partial'] can be received
2. **Destination Warehouse**: Receipt must occur at TO.to_warehouse_id (destination)
3. **Variance Tracking**:
   - Allow receiving different qty than shipped
   - Variance reason required if received_qty != remaining_qty
   - Cannot receive more than shipped_qty total
4. **Batch/Expiry Requirements**: Configurable via warehouse_settings (same as PO receipt)
5. **One LP Per Line**: Each TO receipt line creates exactly one LP (or moves transit LP)
6. **QA Status**: LP qa_status set from `warehouse_settings.default_qa_status`
7. **TO Status Updates**:
   - First receipt on TO: Status -> 'partial' (if not all lines complete)
   - All lines fully received: Status -> 'received'
8. **Transit Location**:
   - If enabled: Move existing transit LP to destination
   - If disabled: Create new LP at destination
9. **Atomicity**: GRN creation, LP creation/move, TO updates all in single transaction
10. **Audit Trail**: All receipts logged with variance tracking

---

## Deliverables

### Database
- [ ] No new migrations required (reuse existing grns/grn_items tables)
- [ ] Verify RLS policies cover TO receipts

### API Routes
- [ ] `POST /api/warehouse/grns/from-to/:toId` - Create from TO
- [ ] `GET /api/warehouse/receiving/pending-tos` - Receivable TOs
- [ ] `GET /api/warehouse/receiving/to/:toId/lines` - TO lines for wizard

### Service Layer
- [ ] `GRNService.createFromTO()` - Main creation method
- [ ] `GRNService.validateTOReceipt()` - Validation method
- [ ] `GRNService.handleTransitLP()` - Transit LP logic
- [ ] `GRNService.calculateTOVariance()` - Variance calculation
- [ ] `GRNService.getReceivableTOs()` - Pending TO list
- [ ] `GRNService.getTOLinesForReceipt()` - TO lines query
- [ ] `GRNService.updateTOStatus()` - TO status update

### Validation
- [ ] `createGRNFromTOSchema`
- [ ] `createGRNItemFromTOSchema`

### Frontend
- [ ] Receive TO wizard (5 steps)
- [ ] Pending TOs table
- [ ] TO lines table with receive inputs
- [ ] Variance reason input component
- [ ] Extend existing receive wizard to handle both PO and TO

### Tests
- [ ] Unit tests: GRN service TO methods (>80% coverage)
- [ ] Integration tests: All TO receipt endpoints
- [ ] Variance tests: All scenarios
- [ ] Transit location tests: Move vs create new LP
- [ ] Transaction rollback tests
- [ ] RLS tests: Multi-tenancy isolation
- [ ] E2E: Full TO receive wizard flow

---

## Test Cases

### Unit Tests

**File:** `__tests__/unit/services/grn-service-to.test.ts`

| Test Case | Description |
|-----------|-------------|
| `createFromTO()` creates GRN with correct fields | All fields populated correctly |
| `createFromTO()` creates LP for each item | LP count = item count |
| `createFromTO()` updates TO line received_qty | Accumulative update |
| `createFromTO()` updates TO status to partial | When not fully received |
| `createFromTO()` updates TO status to received | When fully received |
| `createFromTO()` blocks draft TO | Error returned |
| `createFromTO()` blocks cancelled TO | Error returned |
| `createFromTO()` validates destination warehouse | Must match TO.to_warehouse_id |
| `createFromTO()` rolls back on LP failure | No partial creates |
| `validateTOReceipt()` returns batch required error | When setting enabled |
| `validateTOReceipt()` returns expiry required error | When setting enabled |
| `validateTOReceipt()` returns variance reason required | When qty differs |
| `calculateTOVariance()` returns correct values | Math verified |
| `handleTransitLP()` moves LP when enabled | Transit LP moved |
| `handleTransitLP()` creates new LP when disabled | New LP created |

### Integration Tests

**File:** `__tests__/integration/api/warehouse/grns-to.test.ts`

| Test Case | Description |
|-----------|-------------|
| `POST /grns/from-to/:toId` creates GRN | Success response |
| `POST /grns/from-to/:toId` creates LPs | LP records exist |
| `POST /grns/from-to/:toId` updates TO | Received qty updated |
| `POST /grns/from-to/:toId` with invalid TO returns 404 | Not found |
| `POST /grns/from-to/:toId` with wrong org returns 404 | RLS enforced |
| `POST /grns/from-to/:toId` with wrong warehouse returns 400 | Must be destination |
| `POST /grns/from-to/:toId` with variance tracked | Variance logged |
| `GET /receiving/pending-tos` returns list | Pagination works |
| Response times meet requirements | < 500ms |

### E2E Tests

**File:** `__tests__/e2e/warehouse/receive-to.spec.ts`

| Test Case | Description |
|-----------|-------------|
| Complete receive TO wizard flow | All steps work |
| Partial receipt flow | TO shows partial status |
| Variance entry flow | Reason captured |
| Validation errors shown | Inline errors work |
| Success shows LP numbers | LPs listed |

---

## Definition of Done

### API
- [ ] All endpoints return correct HTTP status codes
- [ ] Validation errors return 400 with detailed messages
- [ ] Variance tracking works correctly
- [ ] Destination warehouse validation enforced
- [ ] Cross-tenant access returns 404
- [ ] Transaction atomicity verified
- [ ] Response times:
  - GRN creation: < 500ms
  - TO lines query: < 300ms

### Service
- [ ] `createFromTO()` creates GRN, items, LPs atomically
- [ ] LP creation uses `LicensePlateService.create()`
- [ ] Transit LP logic works correctly (move vs create)
- [ ] TO line updates are atomic
- [ ] Variance calculation accurate
- [ ] Rollback on any failure

### Frontend
- [ ] Receive TO wizard navigates through all 5 steps
- [ ] Validation errors displayed inline
- [ ] Variance warnings shown clearly
- [ ] Success page shows LP numbers
- [ ] Pending TOs list with filtering
- [ ] TO lines show shipped/received/remaining

### Testing
- [ ] Unit tests: >80% coverage on TO receipt methods
- [ ] Integration tests: All TO endpoints covered
- [ ] Variance tests: All scenarios
- [ ] Transit location tests: Both modes
- [ ] RLS tests: Multi-tenancy verified
- [ ] E2E tests: Wizard flow passing

---

## Future Phases (Not in This Story)

### Story 05.13 - ASN Management
- ASN CRUD
- Pre-fill GRN from ASN
- Expected vs actual variance

### Story 05.14 - GRN Cancellation
- Cancel completed GRN
- Reverse LP creation
- Restore TO line quantities

### Story 05.17 - Scanner Receive
- Mobile workflow for TO receipt
- Barcode scanning
- Audio feedback

### Story 05.24 - GS1 Barcode Integration
- Parse GS1-128 barcodes on receipt
- Auto-fill batch, expiry from barcode

---

## Risk Assessment

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Transit location logic complexity | MEDIUM | MEDIUM | Thorough testing of both modes, clear documentation |
| TO vs PO workflow confusion | MEDIUM | LOW | Clear UI distinction, consistent patterns |
| Variance tracking gaps | MEDIUM | MEDIUM | Comprehensive test coverage, required reason field |
| LP service integration | LOW | LOW | LP service already tested in 05.1 and 05.11 |
| TO status race conditions | HIGH | LOW | Database-level locking on TO updates |
| Wizard state management | MEDIUM | LOW | Reuse existing PO wizard patterns |

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-12-16 | Initial story creation for TO receipt with LP creation and variance tracking | SONNET |
