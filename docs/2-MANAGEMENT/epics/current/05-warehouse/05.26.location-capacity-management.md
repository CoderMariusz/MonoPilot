# 05.26 - Location Capacity Management

| Field | Value |
|-------|-------|
| **Story ID** | 05.26 |
| **Epic** | 05 - Warehouse |
| **Status** | Ready |
| **Phase** | 2 |
| **Complexity** | M (Medium) |
| **Estimate** | 3-4 days |
| **Type** | Full-stack |
| **Priority** | P2 |

---

## PRD References

| FR ID | Requirement | Priority | Coverage |
|-------|-------------|----------|----------|
| WH-FR-025 | Location Capacity - Track/validate location capacity | P2 | Full |

**Primary PRD:** `docs/1-BASELINE/product/modules/warehouse.md`
**Related Stories:**
- 01.9 (Locations CRUD) - provides base location structure with `max_pallets`, `max_weight_kg`
- 05.0 (Warehouse Settings) - provides `enable_location_capacity` toggle

---

## User Story

**As a** Warehouse Manager,
**I want to** configure maximum capacity per location and see real-time occupancy with visual indicators,
**So that** I can prevent overfilling locations and optimize warehouse space utilization.

**As a** Warehouse Operator,
**I want to** be blocked from moving inventory to full locations,
**So that** I avoid physical space constraints and maintain safe storage practices.

---

## Goal

Implement comprehensive location capacity management that:
1. Allows max capacity configuration per location (pallets, weight, LP count)
2. Calculates current occupancy from LP data in real-time
3. Blocks moves/receipts when capacity would be exceeded
4. Provides visual indicators (90%+ yellow warning, 100% red full)
5. Respects `enable_location_capacity` warehouse setting toggle

---

## Scope

**In Scope:**
- Max capacity fields on locations (max_pallets, max_weight_kg, max_lp_count)
- Current occupancy calculation from license_plates table
- Capacity validation on LP move, receipt, putaway operations
- Visual capacity indicators in location UI (progress bars, color coding)
- Capacity dashboard widget showing locations at/near capacity
- Location capacity API endpoint for quick queries
- Warning thresholds (configurable: default 90% yellow, 100% red)
- Blocking behavior when capacity exceeded
- Override capability for managers (with reason logging)

**Out of Scope:**
- Zone-level aggregate capacity (separate story 05.27)
- Capacity forecasting/prediction
- Capacity reservation for planned receipts
- Historical capacity utilization reports
- Automated rebalancing suggestions

---

## Dependencies

| Dependency | Story | Type | Status | Provides |
|------------|-------|------|--------|----------|
| Locations CRUD | 01.9 | Hard | Done | `locations` table with `max_pallets`, `max_weight_kg`, `current_pallets`, `current_weight_kg` fields |
| Warehouse Settings | 05.0 | Hard | Done | `enable_location_capacity` toggle in `warehouse_settings` |
| LP Table CRUD | 05.1 | Hard | Done | `license_plates` table with `location_id`, `quantity`, `catch_weight_kg` |
| Stock Moves | 05.16 | Soft | Done | Move validation hooks |

---

## Acceptance Criteria (Gherkin)

### AC-1: Enable Location Capacity Feature (WH-FR-025)

```gherkin
Scenario: Feature disabled by default
  Given warehouse_settings.enable_location_capacity is false (default)
  When user attempts to move LP to location
  Then no capacity validation performed
  And move proceeds regardless of location occupancy

Scenario: Feature enabled activates validation
  Given warehouse_settings.enable_location_capacity is true
  When user attempts to move LP to location
  Then system calculates current occupancy
  And validates against location.max_pallets and location.max_weight_kg

Scenario: Toggle in settings UI
  Given user has WH_MANAGER role
  When user navigates to /settings/warehouse
  And expands "Phase 3: Advanced Features" section
  Then enable_location_capacity toggle is visible
  And tooltip explains "Track and validate location capacity limits"
```

### AC-2: Configure Max Capacity Per Location

```gherkin
Scenario: Set pallet capacity on location creation
  Given user creates new location "BIN-001"
  When user enters max_pallets = 4
  Then location saved with max_pallets = 4
  And capacity indicator shows "0/4 pallets (0%)"

Scenario: Set weight capacity on location
  Given user edits location "RACK-A01"
  When user enters max_weight_kg = 2000
  Then location saved with max_weight_kg = 2000
  And capacity indicator shows "0/2000 kg (0%)"

Scenario: Set LP count capacity
  Given user creates bin location
  When user enters max_lp_count = 10
  Then location saved with max_lp_count = 10
  And capacity indicator shows "0/10 LPs (0%)"

Scenario: No capacity limit (unlimited)
  Given location created without max_pallets, max_weight_kg, max_lp_count
  When location viewed
  Then capacity shows "Unlimited" or no indicator
  And no capacity validation performed for this location

Scenario: Capacity validation on save
  Given user enters max_pallets = -5
  When form submitted
  Then validation error "Capacity must be positive or empty (unlimited)"
  And save blocked
```

### AC-3: Calculate Current Occupancy

```gherkin
Scenario: Calculate pallet count from LPs
  Given location "BIN-001" has max_pallets = 4
  And 3 license_plates exist at location with pallet_qty = 1 each
  When capacity queried
  Then current_pallets = 3
  And capacity_pct = 75%

Scenario: Calculate weight from LP catch weights
  Given location "RACK-A01" has max_weight_kg = 2000
  And 5 license_plates exist with catch_weight_kg totaling 1500.5 kg
  When capacity queried
  Then current_weight_kg = 1500.5
  And capacity_pct = 75.03%

Scenario: Calculate LP count
  Given location "BIN-002" has max_lp_count = 10
  And 7 license_plates exist at location
  When capacity queried
  Then current_lp_count = 7
  And capacity_pct = 70%

Scenario: Real-time calculation
  Given location capacity displayed at 60%
  When new LP moved to location
  Then capacity recalculated within 200ms
  And indicator updates to new percentage

Scenario: Exclude consumed LPs
  Given location has 5 LPs, 2 with status='consumed'
  When capacity calculated
  Then only 3 active LPs counted
  And consumed LPs excluded from occupancy
```

### AC-4: Capacity Exceeded Blocking

```gherkin
Scenario: Block move when pallet capacity exceeded
  Given location "BIN-001" has max_pallets = 4, current_pallets = 4
  And enable_location_capacity = true
  When user attempts to move LP (pallet_qty = 1) to BIN-001
  Then error "Location capacity exceeded (current: 4/4 pallets)"
  And move blocked (400 error)
  And LP remains at original location

Scenario: Block move when weight capacity exceeded
  Given location has max_weight_kg = 2000, current = 1800
  When user attempts to move LP with catch_weight_kg = 300
  Then error "Location capacity exceeded (would be: 2100/2000 kg)"
  And move blocked

Scenario: Block receipt to full location
  Given GRN receipt targets location "BIN-001" at 100% capacity
  When user attempts to complete receipt
  Then error "Target location at capacity. Select different location."
  And GRN completion blocked
  And user prompted to select alternate location

Scenario: Allow move when capacity not exceeded
  Given location has max_pallets = 10, current = 7
  When user moves LP (pallet_qty = 1)
  Then move succeeds
  And current_pallets updates to 8
  And capacity indicator updates to 80%

Scenario: Partial quantity check
  Given location has max_pallets = 4, current = 3
  When LP with pallet_qty = 2 attempted
  Then error "Location capacity exceeded (would be: 5/4 pallets)"
  And move blocked
```

### AC-5: Manager Override

```gherkin
Scenario: Manager can override capacity block
  Given move blocked due to capacity exceeded
  And user has WH_MANAGER or ADMIN role
  When user clicks "Override" button
  Then override reason dialog appears
  And required fields: reason (dropdown + text)

Scenario: Override reason options
  Given override dialog open
  When user clicks reason dropdown
  Then options display:
    | emergency_receipt |
    | temporary_storage |
    | manager_approval |
    | other |

Scenario: Override logged to audit
  Given manager provides override reason "emergency_receipt"
  When override confirmed
  Then move proceeds despite capacity
  And capacity_override_log entry created with:
    | location_id | LP_id | exceeded_by | reason | overridden_by | timestamp |

Scenario: Override not available for operators
  Given move blocked due to capacity
  And user has OPERATOR role
  When block displayed
  Then "Override" button is not visible
  And message shows "Contact manager to override"

Scenario: Override with mandatory notes
  Given user selects reason "other"
  When notes field empty
  Then "Confirm Override" button disabled
  And hint "Notes required for 'Other' reason"
```

### AC-6: Visual Capacity Indicators

```gherkin
Scenario: Green indicator (0-69%)
  Given location at 50% capacity
  When location displayed in list or tree
  Then capacity bar shows green color
  And percentage shows "50%"

Scenario: Yellow warning indicator (70-89%)
  Given location at 85% capacity
  When location displayed
  Then capacity bar shows yellow/amber color
  And warning icon appears
  And tooltip shows "Location approaching capacity"

Scenario: Red full indicator (90-100%)
  Given location at 95% capacity
  When location displayed
  Then capacity bar shows red color
  And full warning icon appears
  And tooltip shows "Location near/at capacity"

Scenario: At capacity indicator (100%)
  Given location at exactly 100% capacity
  When location displayed
  Then capacity bar shows solid red
  And "FULL" badge displays
  And location highlighted in list

Scenario: Over capacity indicator (>100%)
  Given location at 110% (override occurred)
  When location displayed
  Then capacity bar shows overflow style (striped red)
  And "OVER" badge displays in red
  And priority alert in dashboard widget

Scenario: Capacity bar in location tree
  Given locations tree view open
  When viewing location nodes
  Then each node shows mini capacity bar (if capacity configured)
  And color coding matches capacity level
```

### AC-7: Capacity Dashboard Widget

```gherkin
Scenario: Dashboard shows at-capacity locations
  Given 3 locations at >90% capacity
  When warehouse dashboard loads
  Then "Locations Near Capacity" widget displays
  And lists top 10 locations by capacity_pct DESC

Scenario: Widget shows location details
  Given "Locations Near Capacity" widget visible
  When viewing entries
  Then each shows: location code, capacity_pct, current/max, type (pallets/kg/LPs)

Scenario: Click to navigate
  Given widget shows location "BIN-001" at 95%
  When user clicks entry
  Then navigates to location detail page
  And location highlighted in tree

Scenario: Empty state
  Given no locations at >80% capacity
  When widget loads
  Then shows "All locations under 80% capacity"
  And green checkmark icon

Scenario: Real-time updates
  Given widget showing locations
  When LP moved causing capacity change
  Then widget updates within 5 seconds
  And reflects new capacity percentages
```

### AC-8: Capacity Query API

```gherkin
Scenario: Query single location capacity
  Given location "BIN-001" exists
  When GET /api/warehouse/locations/BIN-001/capacity called
  Then response includes:
    | current_pallets | max_pallets | current_weight_kg | max_weight_kg |
    | current_lp_count | max_lp_count | capacity_pct | status |
  And response time < 200ms

Scenario: Query warehouse capacity summary
  Given warehouse "WH-001" has 50 locations
  When GET /api/warehouse/warehouses/WH-001/capacity called
  Then response includes:
    | total_locations | at_capacity_count | warning_count | available_count |
    | avg_capacity_pct | top_10_fullest |

Scenario: Query available locations for product
  Given product requires pallet storage
  When GET /api/warehouse/locations/available?type=pallet&min_capacity=2 called
  Then returns locations with >= 2 pallets available
  And sorted by available capacity DESC

Scenario: Capacity query performance
  Given warehouse has 1000 locations
  When capacity summary queried
  Then response returned in < 500ms
  And uses optimized aggregation query
```

### AC-9: Multi-tenancy & Permissions

```gherkin
Scenario: Org isolation on capacity data
  Given User A from Org A
  When requesting location capacity
  Then only Org A location data returned

Scenario: Cross-tenant access blocked
  Given User A from Org A
  When attempting to query Org B location capacity
  Then 404 Not Found returned (not 403)

Scenario: Role-based capacity config
  Given user has VIEWER role
  When attempting to modify location max_pallets
  Then 403 Forbidden returned
  And error "Insufficient permissions to modify location capacity"

Scenario: Override permission check
  Given user has OPERATOR role
  When attempting to POST override
  Then 403 Forbidden returned
  And error "Manager role required for capacity override"
```

---

## Technical Specification

### Database Schema

#### locations table extension

```sql
-- Add max_lp_count field to existing locations table
ALTER TABLE locations ADD COLUMN IF NOT EXISTS
  max_lp_count INTEGER CHECK (max_lp_count IS NULL OR max_lp_count > 0);

-- Add current_lp_count for denormalized tracking
ALTER TABLE locations ADD COLUMN IF NOT EXISTS
  current_lp_count INTEGER NOT NULL DEFAULT 0 CHECK (current_lp_count >= 0);
```

#### capacity_override_logs table

```sql
CREATE TABLE capacity_override_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  location_id UUID NOT NULL REFERENCES locations(id) ON DELETE CASCADE,
  lp_id UUID NOT NULL REFERENCES license_plates(id) ON DELETE CASCADE,

  -- Override details
  operation_type VARCHAR(20) NOT NULL, -- 'move', 'receipt', 'putaway'
  exceeded_metric VARCHAR(20) NOT NULL, -- 'pallets', 'weight_kg', 'lp_count'
  limit_value NUMERIC(15,4) NOT NULL,
  attempted_value NUMERIC(15,4) NOT NULL,
  exceeded_by NUMERIC(15,4) NOT NULL,

  -- Reason
  reason_code VARCHAR(50) NOT NULL, -- 'emergency_receipt', 'temporary_storage', 'manager_approval', 'other'
  reason_notes TEXT,

  -- Audit
  overridden_by UUID NOT NULL REFERENCES users(id),
  overridden_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),

  -- Indexes
  CONSTRAINT capacity_override_reason_notes CHECK (
    reason_code != 'other' OR reason_notes IS NOT NULL
  )
);

CREATE INDEX idx_capacity_override_org ON capacity_override_logs(org_id);
CREATE INDEX idx_capacity_override_location ON capacity_override_logs(location_id);
CREATE INDEX idx_capacity_override_timestamp ON capacity_override_logs(overridden_at DESC);
```

#### Capacity calculation trigger

```sql
-- Function to recalculate location capacity on LP changes
CREATE OR REPLACE FUNCTION recalculate_location_capacity()
RETURNS TRIGGER AS $$
DECLARE
  old_location_id UUID;
  new_location_id UUID;
BEGIN
  -- Determine affected locations
  IF TG_OP = 'DELETE' THEN
    old_location_id := OLD.location_id;
    new_location_id := NULL;
  ELSIF TG_OP = 'INSERT' THEN
    old_location_id := NULL;
    new_location_id := NEW.location_id;
  ELSIF TG_OP = 'UPDATE' THEN
    old_location_id := OLD.location_id;
    new_location_id := NEW.location_id;
  END IF;

  -- Update old location stats (if LP moved away)
  IF old_location_id IS NOT NULL THEN
    UPDATE locations SET
      current_pallets = COALESCE((
        SELECT COUNT(*) FROM license_plates
        WHERE location_id = old_location_id
        AND status NOT IN ('consumed', 'cancelled')
        AND pallet_qty > 0
      ), 0),
      current_weight_kg = COALESCE((
        SELECT SUM(catch_weight_kg) FROM license_plates
        WHERE location_id = old_location_id
        AND status NOT IN ('consumed', 'cancelled')
      ), 0),
      current_lp_count = COALESCE((
        SELECT COUNT(*) FROM license_plates
        WHERE location_id = old_location_id
        AND status NOT IN ('consumed', 'cancelled')
      ), 0),
      updated_at = NOW()
    WHERE id = old_location_id;
  END IF;

  -- Update new location stats (if LP moved here)
  IF new_location_id IS NOT NULL AND new_location_id != COALESCE(old_location_id, '00000000-0000-0000-0000-000000000000') THEN
    UPDATE locations SET
      current_pallets = COALESCE((
        SELECT COUNT(*) FROM license_plates
        WHERE location_id = new_location_id
        AND status NOT IN ('consumed', 'cancelled')
        AND pallet_qty > 0
      ), 0),
      current_weight_kg = COALESCE((
        SELECT SUM(catch_weight_kg) FROM license_plates
        WHERE location_id = new_location_id
        AND status NOT IN ('consumed', 'cancelled')
      ), 0),
      current_lp_count = COALESCE((
        SELECT COUNT(*) FROM license_plates
        WHERE location_id = new_location_id
        AND status NOT IN ('consumed', 'cancelled')
      ), 0),
      updated_at = NOW()
    WHERE id = new_location_id;
  END IF;

  RETURN COALESCE(NEW, OLD);
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_recalculate_capacity
AFTER INSERT OR UPDATE OR DELETE ON license_plates
FOR EACH ROW
EXECUTE FUNCTION recalculate_location_capacity();
```

### RLS Policies

```sql
-- capacity_override_logs RLS
ALTER TABLE capacity_override_logs ENABLE ROW LEVEL SECURITY;

CREATE POLICY "capacity_override_select" ON capacity_override_logs
FOR SELECT TO authenticated
USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

CREATE POLICY "capacity_override_insert" ON capacity_override_logs
FOR INSERT TO authenticated
WITH CHECK (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  AND (
    (SELECT r.code FROM roles r JOIN users u ON u.role_id = r.id WHERE u.id = auth.uid())
    IN ('SUPER_ADMIN', 'ADMIN', 'WH_MANAGER')
  )
);
```

### API Endpoints

```
# Location Capacity
GET    /api/warehouse/locations/:id/capacity          - Get location capacity details
GET    /api/warehouse/warehouses/:id/capacity         - Get warehouse capacity summary
GET    /api/warehouse/locations/available             - Find locations with available capacity
POST   /api/warehouse/locations/:id/capacity/override - Log capacity override

# Query Parameters for /locations/available
?type=pallet|weight|lp_count       - Capacity type to check
&min_capacity=N                     - Minimum available capacity
&warehouse_id=uuid                  - Filter by warehouse
&zone_id=uuid                       - Filter by zone
```

**Response: GET /locations/:id/capacity**

```json
{
  "location_id": "uuid",
  "location_code": "BIN-001",
  "warehouse_id": "uuid",
  "warehouse_code": "WH-001",
  "capacity": {
    "pallets": {
      "current": 3,
      "max": 4,
      "available": 1,
      "percentage": 75.0
    },
    "weight_kg": {
      "current": 1500.5,
      "max": 2000.0,
      "available": 499.5,
      "percentage": 75.03
    },
    "lp_count": {
      "current": 7,
      "max": 10,
      "available": 3,
      "percentage": 70.0
    }
  },
  "status": "warning", // "available" | "warning" | "full" | "over"
  "is_unlimited": false,
  "updated_at": "2025-01-15T14:30:00Z"
}
```

**Response: GET /warehouses/:id/capacity**

```json
{
  "warehouse_id": "uuid",
  "warehouse_code": "WH-001",
  "summary": {
    "total_locations": 150,
    "with_capacity_limits": 120,
    "unlimited": 30,
    "at_capacity": 5,
    "warning": 12,
    "available": 103
  },
  "averages": {
    "pallet_capacity_pct": 62.5,
    "weight_capacity_pct": 55.3,
    "lp_capacity_pct": 48.7
  },
  "top_10_fullest": [
    {
      "location_id": "uuid",
      "location_code": "BIN-001",
      "capacity_pct": 95.0,
      "status": "full"
    }
  ],
  "updated_at": "2025-01-15T14:30:00Z"
}
```

### Service Layer

```typescript
// lib/services/location-capacity-service.ts

export interface LocationCapacityService {
  // Capacity queries
  getLocationCapacity(locationId: string): Promise<LocationCapacity>;
  getWarehouseCapacitySummary(warehouseId: string): Promise<WarehouseCapacitySummary>;
  findAvailableLocations(params: AvailableLocationParams): Promise<LocationWithCapacity[]>;

  // Validation
  validateCapacity(locationId: string, incomingQty: CapacityDelta): Promise<CapacityValidation>;
  canAccommodate(locationId: string, pallets?: number, weightKg?: number, lpCount?: number): Promise<boolean>;

  // Override
  logCapacityOverride(data: CapacityOverrideInput): Promise<CapacityOverrideLog>;

  // Recalculation
  recalculateLocationCapacity(locationId: string): Promise<void>;
  recalculateWarehouseCapacity(warehouseId: string): Promise<void>;
}

export interface LocationCapacity {
  location_id: string;
  location_code: string;
  warehouse_id: string;
  warehouse_code: string;
  capacity: {
    pallets: CapacityMetric;
    weight_kg: CapacityMetric;
    lp_count: CapacityMetric;
  };
  status: 'available' | 'warning' | 'full' | 'over';
  is_unlimited: boolean;
  updated_at: string;
}

export interface CapacityMetric {
  current: number;
  max: number | null;
  available: number | null;
  percentage: number | null;
}

export interface CapacityValidation {
  valid: boolean;
  exceeded: {
    pallets?: { current: number; max: number; incoming: number };
    weight_kg?: { current: number; max: number; incoming: number };
    lp_count?: { current: number; max: number; incoming: number };
  };
  errors: string[];
  can_override: boolean;
}

export interface CapacityOverrideInput {
  location_id: string;
  lp_id: string;
  operation_type: 'move' | 'receipt' | 'putaway';
  exceeded_metric: 'pallets' | 'weight_kg' | 'lp_count';
  limit_value: number;
  attempted_value: number;
  reason_code: 'emergency_receipt' | 'temporary_storage' | 'manager_approval' | 'other';
  reason_notes?: string;
}
```

### Zod Validation Schemas

```typescript
// lib/validation/location-capacity.ts
import { z } from 'zod';

export const capacityMetricSchema = z.object({
  current: z.number().nonnegative(),
  max: z.number().positive().nullable(),
  available: z.number().nullable(),
  percentage: z.number().min(0).nullable(),
});

export const locationCapacitySchema = z.object({
  location_id: z.string().uuid(),
  location_code: z.string(),
  warehouse_id: z.string().uuid(),
  warehouse_code: z.string(),
  capacity: z.object({
    pallets: capacityMetricSchema,
    weight_kg: capacityMetricSchema,
    lp_count: capacityMetricSchema,
  }),
  status: z.enum(['available', 'warning', 'full', 'over']),
  is_unlimited: z.boolean(),
  updated_at: z.string().datetime(),
});

export const capacityOverrideInputSchema = z.object({
  location_id: z.string().uuid(),
  lp_id: z.string().uuid(),
  operation_type: z.enum(['move', 'receipt', 'putaway']),
  exceeded_metric: z.enum(['pallets', 'weight_kg', 'lp_count']),
  limit_value: z.number().positive(),
  attempted_value: z.number().positive(),
  reason_code: z.enum(['emergency_receipt', 'temporary_storage', 'manager_approval', 'other']),
  reason_notes: z.string().max(500).optional(),
}).refine(data => {
  if (data.reason_code === 'other' && !data.reason_notes) {
    return false;
  }
  return true;
}, {
  message: 'Notes required when reason is "other"',
  path: ['reason_notes'],
});

export const availableLocationQuerySchema = z.object({
  type: z.enum(['pallet', 'weight', 'lp_count']).optional(),
  min_capacity: z.coerce.number().positive().optional(),
  warehouse_id: z.string().uuid().optional(),
  zone_id: z.string().uuid().optional(),
  limit: z.coerce.number().int().min(1).max(100).default(50),
});

export type LocationCapacity = z.infer<typeof locationCapacitySchema>;
export type CapacityOverrideInput = z.infer<typeof capacityOverrideInputSchema>;
```

---

## UI Components

### Pages

- `app/(authenticated)/warehouse/locations/[id]/capacity/page.tsx` - Location capacity detail

### Components

```
components/warehouse/capacity/
  LocationCapacityIndicator.tsx    - Capacity bar with color coding
  LocationCapacityCard.tsx         - Full capacity details card
  CapacityOverrideDialog.tsx       - Override reason dialog
  CapacityDashboardWidget.tsx      - Dashboard widget for full locations
  AvailableLocationsPicker.tsx     - Select location with capacity preview
  CapacityBadge.tsx                - Status badge (FULL, OVER, etc.)
  CapacityProgressBar.tsx          - Visual progress bar component
```

### Component Details

**LocationCapacityIndicator.tsx**

```tsx
interface LocationCapacityIndicatorProps {
  current: number;
  max: number | null;
  unit: 'pallets' | 'kg' | 'LPs';
  size?: 'sm' | 'md' | 'lg';
  showLabel?: boolean;
}

// Renders: [========  ] 80% (3/4 pallets)
// Colors:  green (0-69%), yellow (70-89%), red (90-100%), striped-red (>100%)
```

**CapacityOverrideDialog.tsx**

```tsx
interface CapacityOverrideDialogProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  locationCode: string;
  exceededBy: { metric: string; current: number; max: number; incoming: number };
  onConfirm: (reason: CapacityOverrideInput) => void;
  isLoading: boolean;
}
```

**CapacityDashboardWidget.tsx**

```tsx
interface CapacityDashboardWidgetProps {
  warehouseId?: string; // Filter by warehouse, or all
  threshold?: number;   // Default 80%
  limit?: number;       // Default 10
}
```

---

## Test Cases

### Unit Tests

**location-capacity-service.test.ts**

| Test Case | Description |
|-----------|-------------|
| `getLocationCapacity` returns correct metrics | Verify calculation from LP data |
| `validateCapacity` blocks when exceeded | Returns valid=false with errors |
| `validateCapacity` passes when available | Returns valid=true |
| `canAccommodate` checks all metric types | Pallets, weight, LP count |
| `logCapacityOverride` requires manager role | Permission check |
| `recalculateLocationCapacity` updates denormalized fields | Trigger simulation |

### Integration Tests

**location-capacity-api.test.ts**

| Test Case | Description |
|-----------|-------------|
| GET `/locations/:id/capacity` returns capacity | Current metrics |
| GET `/warehouses/:id/capacity` returns summary | Aggregated data |
| GET `/locations/available` returns filtered list | Available capacity filter |
| POST `/locations/:id/capacity/override` logs override | With valid reason |
| POST `/locations/:id/capacity/override` rejects invalid reason | Validation |
| Capacity validation on LP move | Blocks when exceeded |
| Cross-org access returns 404 | Multi-tenancy |
| Non-manager override returns 403 | Permission check |

### E2E Tests

**location-capacity.spec.ts**

| Test Case | Description |
|-----------|-------------|
| View location capacity in detail | Shows bars and metrics |
| Capacity indicator color coding | Green/yellow/red states |
| Attempt move to full location | Error displayed, blocked |
| Manager override flow | Dialog, reason, success |
| Dashboard widget shows full locations | Top 10 by capacity |
| Click widget navigates to location | Deep link works |

---

## Definition of Done

- [ ] Database migration adds `max_lp_count`, `current_lp_count` to locations
- [ ] Database migration creates `capacity_override_logs` table
- [ ] Trigger `recalculate_location_capacity` created and tested
- [ ] RLS policies for capacity_override_logs
- [ ] API endpoints implemented (GET capacity, POST override)
- [ ] `location-capacity-service.ts` with all methods
- [ ] Zod schemas for capacity validation
- [ ] Capacity validation integrated into stock move flow
- [ ] Capacity validation integrated into GRN receipt flow
- [ ] `LocationCapacityIndicator` component with color coding
- [ ] `CapacityOverrideDialog` with reason selection
- [ ] `CapacityDashboardWidget` showing near-capacity locations
- [ ] Location detail page shows capacity metrics
- [ ] Location tree shows mini capacity bars
- [ ] Override logs audit trail functional
- [ ] Feature respects `enable_location_capacity` toggle
- [ ] Performance: capacity query < 200ms single, < 500ms summary
- [ ] Multi-tenancy: cross-org returns 404
- [ ] Permission: only managers can override
- [ ] Unit tests >= 80% coverage
- [ ] Integration tests for all endpoints
- [ ] E2E tests for critical flows

---

## Version History

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| 1.0 | 2025-01-15 | ARCHITECT-AGENT | Initial story creation |
