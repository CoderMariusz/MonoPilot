# 02.2 - Product Versioning + History

**State:** ready
**Type:** backend + frontend
**Estimate:** S
**Primary PRD:** `docs/1-BASELINE/product/modules/technical.md` (FR-2.2, FR-2.3)
**UX Wireframes:** TEC-001, TEC-002 (version indicator), PANEL-version-history

## Goal

Implement automatic product version increment on every edit and maintain a complete audit log of all changes. Users should be able to view version history and understand what changed between versions.

## Scope

**In scope**
- Auto-increment version number on any product edit (1 -> 2 -> 3)
- Version history stored in `product_version_history` table
- Track changed fields as JSONB: `{field: {old: value, new: value}}`
- GET /api/technical/products/:id/versions - List all versions
- GET /api/technical/products/:id/history - Get detailed change log
- Version badge displayed in product header (TEC-001 list, TEC-002 modal)
- Version history side panel accessible from edit modal
- Version comparison showing field-level diffs

**Out of scope**
- Restore to previous version functionality (future feature)
- Side-by-side version comparison page (P1 future)
- Version branching (always linear)
- BOM/Routing version correlation (separate story)
- Bulk version import/export

## Dependencies

- **02.1** - Products CRUD (required for product entity and base endpoints)

## Acceptance Criteria (Given/When/Then)

### Version Auto-Increment

- GIVEN product "SKU-001" exists with version 1, WHEN admin updates product name from "Bread" to "White Bread", THEN version increments to 2 and history record is created.
- GIVEN product "SKU-002" has version 5, WHEN any field is edited (name, description, shelf_life_days, etc.), THEN version becomes 6.
- GIVEN product is being created, WHEN product is saved successfully, THEN version is set to 1 (initial version).
- GIVEN product version is 10, WHEN user attempts to set version to 5 manually, THEN operation is rejected (version is system-managed, never decreases).

### Version History Records

- GIVEN product edit saves successfully, WHEN history record is created, THEN it contains: product_id, version, changed_fields (JSONB), changed_by (user_id), changed_at (timestamp).
- GIVEN admin changes product name from "Bread" to "White Bread" and shelf_life_days from 5 to 7, WHEN history record is created, THEN changed_fields contains: `{"name": {"old": "Bread", "new": "White Bread"}, "shelf_life_days": {"old": 5, "new": 7}}`.
- GIVEN no fields actually changed (user opens edit, makes no changes, clicks save), WHEN save is attempted, THEN no version increment occurs and no history record is created.

### Version List API

- GIVEN product "SKU-001" with 5 versions, WHEN GET /api/technical/products/:id/versions is called, THEN returns list of versions: `[{version: 5, changed_at: "..."}, {version: 4, changed_at: "..."}, ...]` in descending order.
- GIVEN product has 100 versions, WHEN versions endpoint is called with pagination (page=1, limit=20), THEN returns first 20 versions with total count.

### History Detail API

- GIVEN product "SKU-001" with history records, WHEN GET /api/technical/products/:id/history is called, THEN returns detailed change log with version, changed_fields, changed_by (user name), changed_at.
- GIVEN history request with filters (from_date, to_date), WHEN endpoint is called, THEN returns only history records within date range.

### Version Badge Display (TEC-001)

- GIVEN product list is displayed, WHEN version column renders, THEN shows "v{N}" format (e.g., "v1", "v5", "v12").
- GIVEN product with version 15, WHEN row is rendered in product list, THEN version badge displays "v15".

### Version Indicator in Edit Modal (TEC-002)

- GIVEN admin opens product edit modal for product with version 4, WHEN modal header renders, THEN shows "Edit Product - SKU-001 (Product Name) Version: v4".
- GIVEN admin is editing product (version 4), WHEN save button is rendered, THEN shows "Save Changes (v4 -> v5)" to indicate version will increment.
- GIVEN product has been edited, WHEN warning banner renders, THEN displays "Editing this product will create version v{N+1}. Changes will not affect existing BOMs or Work Orders."

### Version History Panel (PANEL-version-history)

- GIVEN admin clicks "View Version History" link in edit modal, WHEN panel opens, THEN slides in from right (400px width) showing version timeline.
- GIVEN version history panel is open, WHEN panel content renders, THEN shows list of versions with: version number, timestamp, user name, summary of changed fields.
- GIVEN version history displays changed fields, WHEN a field change is shown, THEN displays format: "field_name: old_value -> new_value".
- GIVEN version 1 (initial creation), WHEN displayed in history panel, THEN shows "Initial creation" instead of field changes.
- GIVEN user clicks "View Details" on a version, WHEN expanded, THEN shows full JSONB diff with all field changes.

### Permission Enforcement

- GIVEN user with VIEWER role, WHEN attempting to access version history, THEN read-only access is allowed (can view, cannot edit).
- GIVEN user with OPERATOR role, WHEN product is edited by admin, THEN history record shows admin's user_id as changed_by.

### Data Integrity

- GIVEN history record is created, WHEN attempting to modify or delete it, THEN operation is blocked (history is immutable).
- GIVEN concurrent edits to same product, WHEN both saves complete, THEN each creates separate history record with correct version sequence.

## Implementation Notes

### API Endpoints

```typescript
// GET /api/technical/products/:id/versions
// Query params: page, limit
interface VersionsListResponse {
  versions: {
    version: number;
    changed_at: string;
    changed_by: string; // user name
  }[];
  total: number;
  page: number;
  limit: number;
}

// GET /api/technical/products/:id/history
// Query params: page, limit, from_date, to_date
interface HistoryResponse {
  history: {
    id: UUID;
    version: number;
    changed_fields: Record<string, { old: any; new: any }>;
    changed_by: {
      id: UUID;
      name: string;
    };
    changed_at: string;
  }[];
  total: number;
  page: number;
  limit: number;
}
```

### Database

Existing table from PRD:
```sql
-- product_version_history (already defined in PRD)
CREATE TABLE product_version_history (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  product_id UUID NOT NULL REFERENCES products(id) ON DELETE CASCADE,
  version INTEGER NOT NULL,
  changed_fields JSONB NOT NULL DEFAULT '{}',
  changed_by UUID NOT NULL REFERENCES users(id),
  changed_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),

  CONSTRAINT pk_product_version_history UNIQUE (product_id, version)
);

-- RLS policy
CREATE POLICY product_version_history_org_policy ON product_version_history
  FOR ALL USING (
    product_id IN (SELECT id FROM products WHERE org_id = current_org_id())
  );

-- Index for fast lookups
CREATE INDEX idx_product_version_history_product_id
  ON product_version_history(product_id, version DESC);
```

### Frontend Components

- `VersionBadge` - Displays "v{N}" in table rows and modal headers
- `VersionHistoryPanel` - Slide-in panel (400px) showing version timeline
- `VersionHistoryItem` - Single history entry with expandable details
- `VersionDiff` - Renders field changes (old -> new format)
- `VersionWarningBanner` - Yellow alert showing version increment notice

### Services

- `product-service.ts` - Extend with version increment logic
- `product-history-service.ts` - New service for history operations
  - `createHistoryRecord(productId, version, changedFields, userId)`
  - `getVersionHistory(productId, pagination, filters)`
  - `getVersionsList(productId, pagination)`
  - `detectChangedFields(oldProduct, newProduct)` - Computes field diff

### Validation (Zod)

```typescript
const historyQuerySchema = z.object({
  page: z.coerce.number().int().min(1).default(1),
  limit: z.coerce.number().int().min(1).max(100).default(20),
  from_date: z.string().datetime().optional(),
  to_date: z.string().datetime().optional(),
});

const changedFieldsSchema = z.record(
  z.string(),
  z.object({
    old: z.any(),
    new: z.any(),
  })
);
```

### Business Logic

```typescript
// In product-service.ts updateProduct method
async function updateProduct(id: UUID, updates: ProductUpdate, userId: UUID) {
  // 1. Fetch current product
  const currentProduct = await getProduct(id);

  // 2. Detect changed fields
  const changedFields = detectChangedFields(currentProduct, updates);

  // 3. If no changes, return early (no version bump)
  if (Object.keys(changedFields).length === 0) {
    return currentProduct;
  }

  // 4. Increment version
  const newVersion = currentProduct.version + 1;

  // 5. Update product with new version
  const updatedProduct = await db.products.update({
    where: { id },
    data: { ...updates, version: newVersion, updated_by: userId }
  });

  // 6. Create history record
  await createHistoryRecord(id, newVersion, changedFields, userId);

  return updatedProduct;
}
```

## Deliverables

- Version auto-increment on product update (backend)
- History record creation with changed_fields JSONB (backend)
- GET /api/technical/products/:id/versions endpoint
- GET /api/technical/products/:id/history endpoint
- VersionBadge component for list and modal
- VersionHistoryPanel slide-in component
- VersionWarningBanner for edit modal
- product-history-service.ts with diff detection
- Zod validation schemas for history endpoints
- Integration tests for version increment logic
- Unit tests for changed field detection
- Unit tests for history service functions

## Definition of Done

- [ ] Product version auto-increments on any field change
- [ ] Version never decreases (system-managed)
- [ ] No version increment if no fields actually changed
- [ ] History record captures all changed fields as JSONB
- [ ] changed_fields format: `{field: {old, new}}`
- [ ] History records are immutable (no update/delete)
- [ ] Versions list endpoint returns descending order
- [ ] History endpoint supports date range filters
- [ ] Version badge shows "v{N}" format in product list
- [ ] Edit modal header shows current version
- [ ] Save button shows "v{N} -> v{N+1}" text
- [ ] Version history panel slides in from right
- [ ] Panel shows timeline with user, timestamp, changes
- [ ] "View Details" expands to show full diff
- [ ] Initial creation (v1) shows "Initial creation" text
- [ ] RLS policy enforces org_id filtering on history
- [ ] Integration tests cover version increment scenarios
- [ ] Unit tests cover detectChangedFields function
- [ ] Performance: History query < 500ms for 100 versions
