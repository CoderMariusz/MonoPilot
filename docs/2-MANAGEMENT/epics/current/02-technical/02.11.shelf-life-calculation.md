# 02.11 - Shelf Life Calculation + Expiry Management

**State:** ready
**Type:** backend + frontend
**Estimate:** M
**Primary PRD:** `docs/1-BASELINE/product/modules/technical.md` (FR-2.90, FR-2.91, FR-2.92, FR-2.93)
**UX Wireframes:** TEC-014 (Shelf Life Configuration), TEC-015 (Cost History - shelf life impact)

## Goal

Implement shelf life management system including automatic calculation from BOM ingredients (minimum shelf life rule), manual override capability with audit trail, storage condition configuration, FEFO (First Expiry First Out) picking rules, expiry warning thresholds, and quarantine automation for expired items. Enable production date to expiry date calculation across all product lifecycle.

## Scope

**In scope**
- Shelf life days configuration per product (calculated, manual override, final value)
- Automatic calculation from BOM ingredients (minimum ingredient shelf life rule)
- Processing impact reduction (heat treatment, mixing reduces shelf life)
- Safety buffer percentage (default 20% of shortest ingredient)
- Manual override with required reason and audit trail
- Storage condition configuration (temperature, humidity, special conditions)
- Best Before date calculation (production date + shelf life days)
- Shelf life mode selection (fixed days vs rolling from ingredients)
- Label format configuration (Best Before DD/MM/YYYY, Best Before End MM/YYYY, Use By)
- FEFO picking strategy configuration per product
- Minimum remaining shelf life for shipment threshold
- Enforcement level selection (Suggest, Warn, Block)
- Expiry warning threshold configuration
- Recalculation trigger on BOM/ingredient changes
- Shelf life configuration modal UI
- Ingredient shelf life reference table in configuration modal

**Out of scope**
- Storage condition impact calculator (advanced feature - wireframe exists but defer)
- Override approval workflow (defer to quality module)
- Real-time temperature monitoring integration (IoT phase)
- Quarantine location automation (Warehouse module Story 05.x)
- Actual expiry date assignment during production (Production module Story 04.x)
- FEFO pick list generation (Warehouse module Story 05.x)
- Customer notification for expiring shipments (Shipping module)
- Shelf life study management (Quality module)
- Multi-temperature zone shelf life adjustment (Future)

## Dependencies

- **01a.1** - Org Context + Base RLS (for multi-tenant isolation)
- **02.1** - Products CRUD (required for product_id, shelf_life_days field)
- **02.4** - BOMs CRUD (required for BOM ingredient lookup)
- **02.10** - Traceability (expiry_calculation_method field, lot tracking integration)

## Acceptance Criteria (Given/When/Then)

### Shelf Life Calculation from Ingredients

- GIVEN a product with active BOM containing ingredients [Flour 180 days, Yeast 14 days, Butter 60 days], WHEN shelf life is calculated, THEN calculated_days = 14 (minimum ingredient shelf life).
- GIVEN calculated_days = 14 and safety_buffer_percent = 20, WHEN final calculation runs, THEN safety_buffer_days = 2.8 (rounded to 3) and final_days = 11.
- GIVEN processing_impact_days = -2 (heat treatment), WHEN calculation runs, THEN final_days = 14 - 2 - 3 = 9 days.
- GIVEN a product has no active BOM, WHEN calculation is attempted, THEN error "No active BOM found. Set shelf life manually or create BOM first." is displayed.
- GIVEN an ingredient has no shelf_life_days configured, WHEN calculation runs, THEN warning "Missing shelf life for ingredient: {name}. Cannot calculate." with link to configure ingredient.

### Manual Override

- GIVEN calculated_days = 10, WHEN user enables manual override and enters 7 days, THEN override_days = 7 and final_days = 7.
- GIVEN manual override selected, WHEN override_reason is empty, THEN validation error "Override reason is required for audit trail."
- GIVEN override_days > calculated_days, WHEN save attempted, THEN warning "Override (12 days) exceeds calculated shelf life (10 days). Ensure this is backed by testing."
- GIVEN override saved successfully, WHEN audit log is checked, THEN entry includes: user, timestamp, old_value, new_value, reason.

### Best Before Date Calculation

- GIVEN shelf_life_mode = 'fixed' and final_days = 7, WHEN lot is produced on 2025-12-11, THEN best_before_date = 2025-12-18.
- GIVEN shelf_life_mode = 'rolling' and processing_buffer_days = 2, WHEN lot is produced with earliest ingredient expiry = 2025-12-20, THEN best_before_date = 2025-12-18 (2025-12-20 - 2 days).
- GIVEN label_format = 'best_before_day', WHEN label is generated, THEN format is "Best Before: DD/MM/YYYY" (e.g., "Best Before: 18/12/2025").
- GIVEN label_format = 'use_by', WHEN label is generated, THEN format is "Use By: DD/MM/YYYY" (for perishable/high-risk foods).

### Storage Conditions

- GIVEN user configures storage temp_min = 18, temp_max = 25, WHEN temp_min > temp_max (e.g., temp_min = 35), THEN validation error "Minimum cannot exceed maximum temperature."
- GIVEN storage conditions configured, WHEN product detail is viewed, THEN storage instructions text appears (e.g., "Store in a cool, dry place. Keep away from sunlight.").
- GIVEN special conditions [refrigeration_required = true], WHEN warehouse receives product, THEN location validation suggests refrigerated zones only.

### FEFO Settings

- GIVEN picking_strategy = 'FEFO', WHEN pick list is generated, THEN lots are sorted by expiry_date ascending (first to expire picked first).
- GIVEN min_remaining_for_shipment = 5 days, WHEN lot has 3 days remaining, THEN warning "Lot LP-001 has only 3 days remaining (minimum: 5 days). Cannot ship."
- GIVEN enforcement_level = 'suggest', WHEN lot fails minimum check, THEN warning shown but shipment can proceed with confirmation.
- GIVEN enforcement_level = 'warn', WHEN lot fails minimum check, THEN supervisor confirmation required to proceed.
- GIVEN enforcement_level = 'block', WHEN lot fails minimum check, THEN shipment prevented entirely with error message.

### Recalculation Triggers

- GIVEN ingredient Yeast shelf_life_days changes from 14 to 10, WHEN change is saved, THEN all products using Yeast in their BOM are flagged for shelf life recalculation.
- GIVEN BOM ingredient is added/removed, WHEN BOM is saved, THEN product shelf life marked as "recalculation needed" with badge.
- GIVEN user clicks "Recalculate from Ingredients" button, WHEN calculation completes, THEN calculated_days updates and change is highlighted.
- GIVEN bulk recalculation runs (5 products affected), WHEN complete, THEN toast "Shelf life recalculated for 5 products. Review changes."

### Expiry Warning Thresholds

- GIVEN expiry_warning_days = 7, WHEN lot expiry is within 7 days, THEN inventory list shows yellow warning indicator.
- GIVEN expiry_warning_days = 3 (critical threshold), WHEN lot expiry is within 3 days, THEN inventory list shows red critical indicator.
- GIVEN lot is expired (expiry_date < today), WHEN inventory is viewed, THEN lot shows "EXPIRED" status with quarantine recommendation.

### Multi-tenancy

- GIVEN User A from Org A, WHEN they configure shelf life for Product X, THEN only Org A can view/edit this configuration.
- GIVEN User A attempts to access Org B product shelf life config, WHEN API is called, THEN 404 Not Found is returned.

## Implementation Notes

### API Endpoints

```
# Shelf Life Configuration
GET    /api/technical/shelf-life/products/:id            - Get shelf life config for product
POST   /api/technical/shelf-life/products/:id/calculate  - Calculate shelf life from BOM ingredients
PUT    /api/technical/shelf-life/products/:id            - Update shelf life config (override)

# Ingredient Shelf Life
GET    /api/technical/shelf-life/ingredients/:id         - Get ingredient shelf life
POST   /api/technical/shelf-life/ingredients/:id         - Update ingredient shelf life

# Bulk Operations
POST   /api/technical/shelf-life/bulk-recalculate        - Recalculate for multiple products
GET    /api/technical/shelf-life/recalculation-queue     - Products needing recalculation
```

**Request/Response Schemas:**

```typescript
// GET /api/technical/shelf-life/products/:id
interface ShelfLifeConfigResponse {
  product_id: string;
  product_code: string;
  product_name: string;
  bom_version: string | null;
  bom_effective_date: string | null;

  // Calculation
  calculated_days: number | null;
  calculation_method: 'min_ingredient' | 'manual_testing' | 'regulatory';
  shortest_ingredient_id: string | null;
  shortest_ingredient_name: string | null;
  shortest_ingredient_days: number | null;
  processing_impact_days: number;
  safety_buffer_percent: number;
  safety_buffer_days: number;

  // Override
  override_days: number | null;
  override_reason: string | null;
  final_days: number;

  // Storage Conditions
  storage_temp_min: number;
  storage_temp_max: number;
  storage_humidity_min: number | null;
  storage_humidity_max: number | null;
  storage_conditions: string[];  // ['original_packaging', 'protect_sunlight', etc.]
  storage_instructions: string | null;

  // Best Before Settings
  shelf_life_mode: 'fixed' | 'rolling';
  label_format: 'best_before_day' | 'best_before_month' | 'use_by';

  // FEFO Settings
  picking_strategy: 'FIFO' | 'FEFO';
  min_remaining_for_shipment: number | null;
  enforcement_level: 'suggest' | 'warn' | 'block';

  // Warnings
  expiry_warning_days: number;
  expiry_critical_days: number;

  // Metadata
  calculated_at: string | null;
  updated_at: string;
  updated_by: string;

  // Ingredient Reference (for display)
  ingredients: IngredientShelfLife[];
}

interface IngredientShelfLife {
  ingredient_id: string;
  ingredient_code: string;
  ingredient_name: string;
  shelf_life_days: number | null;
  storage_temp_min: number | null;
  storage_temp_max: number | null;
  notes: string | null;
}

// POST /api/technical/shelf-life/products/:id/calculate
interface CalculateShelfLifeRequest {
  force_recalculate?: boolean;  // Ignore cached calculation
}

interface CalculateShelfLifeResponse {
  calculated_days: number;
  shortest_ingredient_id: string;
  shortest_ingredient_name: string;
  shortest_ingredient_days: number;
  processing_impact_days: number;
  safety_buffer_percent: number;
  safety_buffer_days: number;
  ingredients_analyzed: number;
  missing_shelf_life: string[];  // Ingredient names with no shelf life configured
  calculation_timestamp: string;
}

// PUT /api/technical/shelf-life/products/:id
interface UpdateShelfLifeRequest {
  // Override
  use_override: boolean;
  override_days?: number;
  override_reason?: string;

  // Processing Impact
  processing_impact_days?: number;
  safety_buffer_percent?: number;

  // Storage Conditions
  storage_temp_min?: number;
  storage_temp_max?: number;
  storage_humidity_min?: number | null;
  storage_humidity_max?: number | null;
  storage_conditions?: string[];
  storage_instructions?: string | null;

  // Best Before Settings
  shelf_life_mode?: 'fixed' | 'rolling';
  label_format?: 'best_before_day' | 'best_before_month' | 'use_by';

  // FEFO Settings
  picking_strategy?: 'FIFO' | 'FEFO';
  min_remaining_for_shipment?: number | null;
  enforcement_level?: 'suggest' | 'warn' | 'block';

  // Warnings
  expiry_warning_days?: number;
  expiry_critical_days?: number;
}

// POST /api/technical/shelf-life/ingredients/:id
interface UpdateIngredientShelfLifeRequest {
  shelf_life_days: number;
  shelf_life_source: 'supplier' | 'internal_testing' | 'regulatory' | 'industry_standard';
  supplier_name?: string | null;
  specification_reference?: string | null;
  storage_temp_min: number;
  storage_temp_max: number;
  storage_humidity_min?: number | null;
  storage_humidity_max?: number | null;
  storage_conditions?: string[];
  min_acceptable_on_receipt?: number;
  quarantine_required?: boolean;
  quarantine_duration_days?: number;
}
```

### Database

**Tables Used:**
- `products` - Product table with shelf_life_days, expiry_policy fields
- `product_shelf_life` - Extended shelf life configuration (existing - migration 047)
- `boms` - BOM table for ingredient lookup
- `bom_items` - BOM ingredients with quantities
- `shelf_life_audit_log` - Audit trail for shelf life changes (new table)

**Existing Table: product_shelf_life (migration 047)**
```sql
-- Already exists from migration 047
CREATE TABLE product_shelf_life (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES orgs(id),
  product_id UUID NOT NULL REFERENCES products(id) UNIQUE,
  calculated_days INTEGER,
  override_days INTEGER,
  final_days INTEGER NOT NULL,
  calculation_method TEXT DEFAULT 'manual' CHECK (calculation_method IN ('manual', 'auto_min_ingredients')),
  shortest_ingredient_id UUID REFERENCES products(id),
  storage_conditions TEXT,
  calculated_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  created_by UUID REFERENCES users(id),
  CONSTRAINT calculated_days_positive CHECK (calculated_days IS NULL OR calculated_days > 0),
  CONSTRAINT override_days_positive CHECK (override_days IS NULL OR override_days > 0),
  CONSTRAINT final_days_positive CHECK (final_days > 0)
);
```

**New Table: product_shelf_life_extended (additional fields)**
```sql
-- Migration: Add extended shelf life fields
ALTER TABLE product_shelf_life
ADD COLUMN IF NOT EXISTS override_reason TEXT,
ADD COLUMN IF NOT EXISTS processing_impact_days INTEGER DEFAULT 0,
ADD COLUMN IF NOT EXISTS safety_buffer_percent DECIMAL(5,2) DEFAULT 20.00,
ADD COLUMN IF NOT EXISTS storage_temp_min DECIMAL(5,2),
ADD COLUMN IF NOT EXISTS storage_temp_max DECIMAL(5,2),
ADD COLUMN IF NOT EXISTS storage_humidity_min DECIMAL(5,2),
ADD COLUMN IF NOT EXISTS storage_humidity_max DECIMAL(5,2),
ADD COLUMN IF NOT EXISTS storage_conditions_json JSONB DEFAULT '[]',
ADD COLUMN IF NOT EXISTS storage_instructions TEXT,
ADD COLUMN IF NOT EXISTS shelf_life_mode TEXT DEFAULT 'fixed' CHECK (shelf_life_mode IN ('fixed', 'rolling')),
ADD COLUMN IF NOT EXISTS label_format TEXT DEFAULT 'best_before_day' CHECK (label_format IN ('best_before_day', 'best_before_month', 'use_by')),
ADD COLUMN IF NOT EXISTS picking_strategy TEXT DEFAULT 'FEFO' CHECK (picking_strategy IN ('FIFO', 'FEFO')),
ADD COLUMN IF NOT EXISTS min_remaining_for_shipment INTEGER,
ADD COLUMN IF NOT EXISTS enforcement_level TEXT DEFAULT 'warn' CHECK (enforcement_level IN ('suggest', 'warn', 'block')),
ADD COLUMN IF NOT EXISTS expiry_warning_days INTEGER DEFAULT 7,
ADD COLUMN IF NOT EXISTS expiry_critical_days INTEGER DEFAULT 3,
ADD COLUMN IF NOT EXISTS needs_recalculation BOOLEAN DEFAULT false,
ADD COLUMN IF NOT EXISTS updated_by UUID REFERENCES users(id);

-- Index for recalculation queue
CREATE INDEX IF NOT EXISTS idx_product_shelf_life_needs_recalc
ON product_shelf_life(org_id, needs_recalculation) WHERE needs_recalculation = true;

-- RLS Policy (if not exists)
CREATE POLICY IF NOT EXISTS "product_shelf_life_org_isolation" ON product_shelf_life
FOR ALL USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));
```

**New Table: shelf_life_audit_log**
```sql
CREATE TABLE shelf_life_audit_log (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES orgs(id),
  product_id UUID NOT NULL REFERENCES products(id),
  action_type TEXT NOT NULL CHECK (action_type IN ('calculate', 'override', 'update_config', 'recalculate')),
  old_value JSONB,
  new_value JSONB,
  change_reason TEXT,
  changed_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  changed_by UUID NOT NULL REFERENCES users(id)
);

CREATE INDEX idx_shelf_life_audit_product ON shelf_life_audit_log(product_id, changed_at DESC);

-- RLS Policy
CREATE POLICY "shelf_life_audit_org_isolation" ON shelf_life_audit_log
FOR ALL USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));
```

**Trigger: Flag products for recalculation on ingredient change**
```sql
CREATE OR REPLACE FUNCTION flag_products_for_shelf_life_recalc()
RETURNS TRIGGER AS $$
BEGIN
  -- When an ingredient's shelf_life_days changes, flag all products using it
  UPDATE product_shelf_life psl
  SET needs_recalculation = true
  WHERE psl.product_id IN (
    SELECT DISTINCT b.product_id
    FROM boms b
    JOIN bom_items bi ON bi.bom_id = b.id
    WHERE bi.component_id = NEW.id
      AND b.status = 'active'
      AND b.org_id = NEW.org_id
  );
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_shelf_life_recalc_on_ingredient_change
AFTER UPDATE OF shelf_life_days ON products
FOR EACH ROW
WHEN (OLD.shelf_life_days IS DISTINCT FROM NEW.shelf_life_days)
EXECUTE FUNCTION flag_products_for_shelf_life_recalc();
```

### Calculation Logic

```typescript
// shelf-life-service.ts

/**
 * Calculate product shelf life from BOM ingredients
 * Rule: Minimum ingredient shelf life - processing impact - safety buffer
 */
async function calculateShelfLife(productId: string): Promise<ShelfLifeCalculation> {
  // 1. Get active BOM for product
  const activeBom = await getBomForProduct(productId, { status: 'active' });
  if (!activeBom) {
    throw new Error('No active BOM found. Set shelf life manually or create BOM first.');
  }

  // 2. Get all BOM ingredients (flatten multi-level if needed)
  const ingredients = await getBomIngredients(activeBom.id, { includeNestedBoms: true });

  // 3. Get shelf life for each ingredient
  const ingredientShelfLives = await Promise.all(
    ingredients.map(async (ing) => ({
      ingredient_id: ing.component_id,
      ingredient_name: ing.component_name,
      shelf_life_days: await getProductShelfLifeDays(ing.component_id),
    }))
  );

  // 4. Find ingredients with missing shelf life
  const missingShelfLife = ingredientShelfLives
    .filter(i => i.shelf_life_days === null)
    .map(i => i.ingredient_name);

  if (missingShelfLife.length > 0) {
    throw new Error(`Missing shelf life for: ${missingShelfLife.join(', ')}`);
  }

  // 5. Find shortest shelf life (minimum rule)
  const validIngredients = ingredientShelfLives.filter(i => i.shelf_life_days !== null);
  const shortestIngredient = validIngredients.reduce((min, ing) =>
    ing.shelf_life_days! < min.shelf_life_days! ? ing : min
  );

  // 6. Get processing impact and safety buffer from config
  const config = await getShelfLifeConfig(productId);
  const processingImpactDays = config?.processing_impact_days ?? 0;
  const safetyBufferPercent = config?.safety_buffer_percent ?? 20;

  // 7. Calculate final shelf life
  const shortestDays = shortestIngredient.shelf_life_days!;
  const safetyBufferDays = Math.ceil(shortestDays * (safetyBufferPercent / 100));
  const calculatedDays = Math.max(1, shortestDays - processingImpactDays - safetyBufferDays);

  return {
    calculated_days: calculatedDays,
    shortest_ingredient_id: shortestIngredient.ingredient_id,
    shortest_ingredient_name: shortestIngredient.ingredient_name,
    shortest_ingredient_days: shortestDays,
    processing_impact_days: processingImpactDays,
    safety_buffer_percent: safetyBufferPercent,
    safety_buffer_days: safetyBufferDays,
    ingredients_analyzed: validIngredients.length,
    missing_shelf_life: missingShelfLife,
    calculation_timestamp: new Date().toISOString(),
  };
}

/**
 * Calculate best before date for a lot
 */
function calculateBestBeforeDate(
  productionDate: Date,
  shelfLifeDays: number,
  mode: 'fixed' | 'rolling',
  earliestIngredientExpiry?: Date,
  processingBufferDays?: number
): Date {
  if (mode === 'fixed') {
    const bestBefore = new Date(productionDate);
    bestBefore.setDate(bestBefore.getDate() + shelfLifeDays);
    return bestBefore;
  } else if (mode === 'rolling' && earliestIngredientExpiry) {
    const bestBefore = new Date(earliestIngredientExpiry);
    bestBefore.setDate(bestBefore.getDate() - (processingBufferDays ?? 0));
    return bestBefore;
  }

  // Fallback to fixed mode
  const bestBefore = new Date(productionDate);
  bestBefore.setDate(bestBefore.getDate() + shelfLifeDays);
  return bestBefore;
}

/**
 * Check if lot can be shipped based on remaining shelf life
 */
function checkShipmentEligibility(
  expiryDate: Date,
  minRemainingDays: number,
  enforcementLevel: 'suggest' | 'warn' | 'block'
): ShipmentEligibility {
  const today = new Date();
  const remainingDays = Math.floor((expiryDate.getTime() - today.getTime()) / (1000 * 60 * 60 * 24));
  const canShip = remainingDays >= minRemainingDays;

  return {
    eligible: canShip || enforcementLevel === 'suggest',
    remaining_days: remainingDays,
    min_required_days: minRemainingDays,
    enforcement_level: enforcementLevel,
    message: canShip
      ? null
      : `Lot has ${remainingDays} days remaining (minimum: ${minRemainingDays} days)`,
    requires_confirmation: !canShip && enforcementLevel === 'warn',
    blocked: !canShip && enforcementLevel === 'block',
  };
}
```

### Frontend Components

**Pages:**
- None (modal-based configuration from Product detail page)

**Components:**
- `components/technical/shelf-life/ShelfLifeConfigModal.tsx` - Main configuration modal
- `components/technical/shelf-life/CalculatedShelfLifeSection.tsx` - Calculation display
- `components/technical/shelf-life/OverrideSection.tsx` - Manual override form
- `components/technical/shelf-life/StorageConditionsSection.tsx` - Storage config form
- `components/technical/shelf-life/FEFOSettingsSection.tsx` - FEFO picking config
- `components/technical/shelf-life/IngredientShelfLifeTable.tsx` - Reference table
- `components/technical/products/ShelfLifeSummaryCard.tsx` - Product detail summary

### Services

**Shelf Life Service:** `lib/services/shelf-life-service.ts`
```typescript
interface ShelfLifeService {
  // Configuration
  getConfig(productId: string): Promise<ShelfLifeConfig | null>;
  updateConfig(productId: string, config: UpdateShelfLifeRequest): Promise<ShelfLifeConfig>;

  // Calculation
  calculate(productId: string, force?: boolean): Promise<ShelfLifeCalculation>;
  bulkRecalculate(productIds: string[]): Promise<BulkRecalculationResult>;
  getRecalculationQueue(): Promise<ProductNeedsRecalculation[]>;

  // Best Before Date
  calculateBestBeforeDate(
    productionDate: Date,
    productId: string,
    ingredientExpiries?: Date[]
  ): Promise<Date>;

  // Shipment Eligibility
  checkShipmentEligibility(
    lotId: string,
    shipDate?: Date
  ): Promise<ShipmentEligibility>;

  // Ingredient Shelf Life
  getIngredientShelfLife(ingredientId: string): Promise<IngredientShelfLife | null>;
  updateIngredientShelfLife(
    ingredientId: string,
    data: UpdateIngredientShelfLifeRequest
  ): Promise<IngredientShelfLife>;

  // Audit
  getAuditLog(productId: string): Promise<ShelfLifeAuditEntry[]>;
}
```

### Validation Schemas

**Location:** `lib/validation/shelf-life.ts`

```typescript
import { z } from 'zod';

export const shelfLifeConfigSchema = z.object({
  // Override
  use_override: z.boolean(),
  override_days: z.number().int().positive().max(3650).optional()
    .describe("Override shelf life in days (max 10 years)"),
  override_reason: z.string().min(10).max(500).optional()
    .describe("Required when override is enabled"),

  // Processing Impact
  processing_impact_days: z.number().int().min(-30).max(30).default(0)
    .describe("Negative values reduce shelf life"),
  safety_buffer_percent: z.number().min(0).max(50).default(20)
    .describe("Safety margin percentage"),

  // Storage Conditions
  storage_temp_min: z.number().min(-40).max(100).optional(),
  storage_temp_max: z.number().min(-40).max(100).optional(),
  storage_humidity_min: z.number().min(0).max(100).optional().nullable(),
  storage_humidity_max: z.number().min(0).max(100).optional().nullable(),
  storage_conditions: z.array(z.enum([
    'original_packaging',
    'protect_sunlight',
    'refrigeration_required',
    'freezing_allowed',
    'controlled_atmosphere',
  ])).default([]),
  storage_instructions: z.string().max(500).optional().nullable(),

  // Best Before Settings
  shelf_life_mode: z.enum(['fixed', 'rolling']).default('fixed'),
  label_format: z.enum(['best_before_day', 'best_before_month', 'use_by']).default('best_before_day'),

  // FEFO Settings
  picking_strategy: z.enum(['FIFO', 'FEFO']).default('FEFO'),
  min_remaining_for_shipment: z.number().int().positive().max(365).optional().nullable(),
  enforcement_level: z.enum(['suggest', 'warn', 'block']).default('warn'),

  // Warnings
  expiry_warning_days: z.number().int().positive().max(90).default(7),
  expiry_critical_days: z.number().int().positive().max(30).default(3),
}).refine(data => {
  // Override reason required when override is enabled
  if (data.use_override && data.override_days && !data.override_reason) {
    return false;
  }
  return true;
}, { message: "Override reason is required when using manual override", path: ['override_reason'] })
.refine(data => {
  // Temperature validation
  if (data.storage_temp_min !== undefined && data.storage_temp_max !== undefined) {
    return data.storage_temp_min <= data.storage_temp_max;
  }
  return true;
}, { message: "Minimum temperature cannot exceed maximum", path: ['storage_temp_min'] })
.refine(data => {
  // Humidity validation
  if (data.storage_humidity_min !== undefined && data.storage_humidity_max !== undefined) {
    return data.storage_humidity_min <= data.storage_humidity_max;
  }
  return true;
}, { message: "Minimum humidity cannot exceed maximum", path: ['storage_humidity_min'] })
.refine(data => {
  // Critical days must be <= warning days
  return data.expiry_critical_days <= data.expiry_warning_days;
}, { message: "Critical threshold must be less than or equal to warning threshold", path: ['expiry_critical_days'] });

export const ingredientShelfLifeSchema = z.object({
  shelf_life_days: z.number().int().positive().max(3650)
    .describe("Shelf life in days"),
  shelf_life_source: z.enum(['supplier', 'internal_testing', 'regulatory', 'industry_standard']),
  supplier_name: z.string().max(100).optional().nullable(),
  specification_reference: z.string().max(100).optional().nullable(),
  storage_temp_min: z.number().min(-40).max(100),
  storage_temp_max: z.number().min(-40).max(100),
  storage_humidity_min: z.number().min(0).max(100).optional().nullable(),
  storage_humidity_max: z.number().min(0).max(100).optional().nullable(),
  storage_conditions: z.array(z.string()).default([]),
  min_acceptable_on_receipt: z.number().int().positive().optional()
    .describe("Minimum remaining shelf life required when receiving"),
  quarantine_required: z.boolean().default(false),
  quarantine_duration_days: z.number().int().positive().max(30).optional()
    .describe("Required if quarantine_required is true"),
}).refine(data => {
  return data.storage_temp_min <= data.storage_temp_max;
}, { message: "Minimum temperature cannot exceed maximum", path: ['storage_temp_min'] })
.refine(data => {
  if (data.quarantine_required && !data.quarantine_duration_days) {
    return false;
  }
  return true;
}, { message: "Quarantine duration required when quarantine is enabled", path: ['quarantine_duration_days'] });
```

## Deliverables

- [ ] Database migration to extend product_shelf_life table with new fields
- [ ] Database migration for shelf_life_audit_log table
- [ ] Database trigger for flagging products needing recalculation
- [ ] Shelf life configuration API endpoints (GET/PUT)
- [ ] Shelf life calculation API endpoint (POST /calculate)
- [ ] Ingredient shelf life API endpoints (GET/POST)
- [ ] Bulk recalculation API endpoint
- [ ] Shelf life service (`lib/services/shelf-life-service.ts`)
- [ ] Zod validation schemas (`lib/validation/shelf-life.ts`)
- [ ] ShelfLifeConfigModal component (main modal)
- [ ] CalculatedShelfLifeSection component
- [ ] OverrideSection component with reason field
- [ ] StorageConditionsSection component
- [ ] FEFOSettingsSection component
- [ ] IngredientShelfLifeTable component (read-only reference)
- [ ] ShelfLifeSummaryCard for product detail page
- [ ] Toast notifications for calculation and save actions
- [ ] Audit logging for all shelf life changes
- [ ] RLS policies for new tables
- [ ] Unit tests for shelf-life-service (coverage >= 80%)
- [ ] Integration tests for calculation and config APIs
- [ ] E2E tests for configuration modal workflow

## Definition of Done

- [ ] Shelf life calculated correctly using minimum ingredient rule
- [ ] Processing impact and safety buffer applied correctly
- [ ] Manual override saves with required reason
- [ ] Override reason required validation works
- [ ] Storage condition temperature validation (min <= max)
- [ ] Best Before date calculated correctly (fixed and rolling modes)
- [ ] FEFO settings saved and retrievable
- [ ] Shipment eligibility check works for all enforcement levels
- [ ] Recalculation trigger fires on ingredient shelf life change
- [ ] "Needs recalculation" badge appears on affected products
- [ ] Recalculate button updates calculated_days and highlights change
- [ ] Bulk recalculation completes with summary toast
- [ ] Ingredient reference table displays correct data
- [ ] Missing ingredient shelf life shows warning with link
- [ ] Audit log captures all changes with user, timestamp, old/new values
- [ ] RLS enforces org isolation on all queries
- [ ] Cross-tenant access returns 404
- [ ] API response times <500ms for single product operations
- [ ] Bulk recalculation <5s for 50 products
- [ ] Loading states displayed during operations
- [ ] Error states handled with meaningful messages
- [ ] Toast notifications on success/error
- [ ] Accessibility: keyboard navigation, ARIA labels, form error announcements
- [ ] Unit tests pass with >= 80% coverage
- [ ] Integration tests cover all API endpoints
- [ ] E2E test covers full configuration flow
