# Story 02.12 - Test Specification
# Purpose: Acceptance criteria, test cases, coverage requirements
# Agent: QA-AGENT / TEST-WRITER

# Test files to create
test_files:
  - path: "apps/frontend/lib/services/__tests__/dashboard-service.test.ts"
    type: "unit"
    description: "Unit tests for dashboard data fetching and transformation"
  - path: "apps/frontend/app/(authenticated)/technical/components/__tests__/DashboardStatsCard.test.tsx"
    type: "unit"
    description: "Unit tests for stats card component"
  - path: "apps/frontend/app/(authenticated)/technical/components/__tests__/AllergenMatrixPanel.test.tsx"
    type: "unit"
    description: "Unit tests for allergen matrix component"
  - path: "apps/frontend/app/(authenticated)/technical/components/__tests__/CostTrendsChart.test.tsx"
    type: "unit"
    description: "Unit tests for cost trends chart component"
  - path: "apps/frontend/app/api/technical/dashboard/__tests__/integration.test.ts"
    type: "integration"
    description: "Integration tests for dashboard API endpoints"
  - path: "e2e/technical-dashboard.spec.ts"
    type: "e2e"
    description: "End-to-end tests for dashboard workflows"

# Acceptance Criteria - Stats Cards (FR-2.100)
acceptance_criteria:
  # Stats Cards
  - id: "AC-12.01"
    fr: "FR-2.100"
    given: "user navigates to /technical"
    when: "page loads"
    then: "4 stats cards display (Products, BOMs, Routings, Avg Cost) within 500ms"
    test_type: "e2e"
    priority: "P0"
    performance: true

  - id: "AC-12.02"
    fr: "FR-2.100"
    given: "stats cards displayed"
    when: "Products card shows 247 total"
    then: "breakdown shows 'Active: 215, Inactive: 32'"
    test_type: "e2e"
    priority: "P0"

  - id: "AC-12.03"
    fr: "FR-2.100"
    given: "stats cards displayed"
    when: "user clicks Products card"
    then: "navigation to /technical/products occurs"
    test_type: "e2e"
    priority: "P0"

  - id: "AC-12.04"
    fr: "FR-2.100"
    given: "stats cards displayed"
    when: "Avg Cost card shows '125.50 PLN'"
    then: "trend indicator shows '+5.2%' with up arrow"
    test_type: "e2e"
    priority: "P1"

  - id: "AC-12.05"
    fr: "FR-2.100"
    given: "stats cards displayed"
    when: "user clicks Avg Cost card"
    then: "navigation to /technical/costing/history occurs"
    test_type: "e2e"
    priority: "P1"

  # Allergen Matrix (FR-2.101)
  - id: "AC-12.06"
    fr: "FR-2.101"
    given: "dashboard loaded"
    when: "allergen matrix renders"
    then: "products appear as rows and allergens as columns"
    test_type: "e2e"
    priority: "P0"

  - id: "AC-12.07"
    fr: "FR-2.101"
    given: "allergen matrix displayed"
    when: "product contains Gluten"
    then: "cell shows red indicator (contains)"
    test_type: "e2e"
    priority: "P0"

  - id: "AC-12.08"
    fr: "FR-2.101"
    given: "allergen matrix displayed"
    when: "product may contain Dairy"
    then: "cell shows yellow indicator (may contain)"
    test_type: "e2e"
    priority: "P0"

  - id: "AC-12.09"
    fr: "FR-2.101"
    given: "allergen matrix displayed"
    when: "product is free from Nuts"
    then: "cell shows green indicator (free from)"
    test_type: "e2e"
    priority: "P0"

  - id: "AC-12.10"
    fr: "FR-2.101"
    given: "allergen matrix displayed"
    when: "user clicks cell for SKU-001/Gluten"
    then: "navigation to allergen management for that product occurs"
    test_type: "e2e"
    priority: "P1"

  - id: "AC-12.11"
    fr: "FR-2.101"
    given: "allergen matrix displayed"
    when: "user clicks 'Export PDF'"
    then: "allergen matrix downloads as PDF with legend"
    test_type: "e2e"
    priority: "P1"

  - id: "AC-12.12"
    fr: "FR-2.101"
    given: "allergen matrix with 50+ products"
    when: "filtering by product type 'Finished Goods'"
    then: "only finished goods products display"
    test_type: "e2e"
    priority: "P1"

  # BOM Version Timeline (FR-2.102)
  - id: "AC-12.13"
    fr: "FR-2.102"
    given: "dashboard loaded"
    when: "BOM timeline renders"
    then: "dots represent BOM version changes for last 6 months"
    test_type: "e2e"
    priority: "P0"

  - id: "AC-12.14"
    fr: "FR-2.102"
    given: "BOM timeline displayed"
    when: "user hovers over dot"
    then: "tooltip shows product name, version, date, changed_by"
    test_type: "e2e"
    priority: "P0"

  - id: "AC-12.15"
    fr: "FR-2.102"
    given: "BOM timeline displayed"
    when: "user clicks dot for 'Wheat Bread v5'"
    then: "navigation to BOM detail page occurs"
    test_type: "e2e"
    priority: "P1"

  - id: "AC-12.16"
    fr: "FR-2.102"
    given: "BOM timeline displayed"
    when: "filtering by product 'Wheat Bread'"
    then: "only that product's versions display"
    test_type: "e2e"
    priority: "P1"

  # Recent Activity
  - id: "AC-12.17"
    given: "dashboard loaded"
    when: "recent activity loads"
    then: "last 10 activity events display with icon, description, user, timestamp"
    test_type: "e2e"
    priority: "P0"

  - id: "AC-12.18"
    given: "recent activity displayed"
    when: "event shows 'Product SKU-015 created'"
    then: "icon is product icon and relative time shows '2 hours ago'"
    test_type: "e2e"
    priority: "P1"

  - id: "AC-12.19"
    given: "recent activity displayed"
    when: "user clicks activity row"
    then: "navigation to detail page (product/BOM/routing) occurs"
    test_type: "e2e"
    priority: "P1"

  # Cost Trends Chart
  - id: "AC-12.20"
    given: "dashboard loaded"
    when: "cost trends chart renders"
    then: "line chart shows last 6 months of cost data"
    test_type: "e2e"
    priority: "P0"

  - id: "AC-12.21"
    given: "cost trends chart displayed"
    when: "toggle buttons show"
    then: "user can toggle Material/Labor/Overhead/Total lines"
    test_type: "e2e"
    priority: "P1"

  - id: "AC-12.22"
    given: "cost trends chart displayed"
    when: "user hovers over data point"
    then: "tooltip shows cost breakdown for that month"
    test_type: "e2e"
    priority: "P1"

  # Quick Actions
  - id: "AC-12.23"
    given: "dashboard loaded"
    when: "quick actions display"
    then: "buttons for New Product, New BOM, New Routing appear"
    test_type: "e2e"
    priority: "P0"

  - id: "AC-12.24"
    given: "user clicks 'New Product'"
    when: "modal opens"
    then: "product creation modal displays"
    test_type: "e2e"
    priority: "P0"

  # Loading/Empty/Error States
  - id: "AC-12.25"
    given: "dashboard loads"
    when: "data is fetching"
    then: "skeleton loaders display for all cards and panels"
    test_type: "e2e"
    priority: "P0"

  - id: "AC-12.26"
    given: "no products exist"
    when: "dashboard loads"
    then: "empty state displays with 'Welcome to Technical Module' and onboarding CTAs"
    test_type: "e2e"
    priority: "P0"

  - id: "AC-12.27"
    given: "API fails"
    when: "dashboard loads"
    then: "error state displays with 'Failed to Load Dashboard Data' and Retry button"
    test_type: "e2e"
    priority: "P0"

  # Responsive Behavior
  - id: "AC-12.28"
    given: "desktop viewport (>1024px)"
    when: "dashboard renders"
    then: "4 cards in row, 2-column panel layout"
    test_type: "e2e"
    priority: "P1"
    responsive: true

  - id: "AC-12.29"
    given: "tablet viewport (768-1024px)"
    when: "dashboard renders"
    then: "2x2 card grid, panels stack vertically"
    test_type: "e2e"
    priority: "P1"
    responsive: true

  - id: "AC-12.30"
    given: "mobile viewport (<768px)"
    when: "dashboard renders"
    then: "single column layout, all elements stack"
    test_type: "e2e"
    priority: "P1"
    responsive: true

# Unit Test Cases
unit_tests:
  dashboard_service:
    - name: "fetchDashboardStats returns correct structure"
      setup: "Mock successful API response"
      expected: "Returns DashboardStatsResponse with products, boms, routings, avg_cost"

    - name: "fetchDashboardStats returns null on 401"
      setup: "Mock 401 response"
      expected: "Throws unauthorized error"

    - name: "fetchAllergenMatrix transforms relations correctly"
      setup: "Mock matrix response with various relations"
      expected: "Products have allergen_relations Record with correct values"

    - name: "fetchBomTimeline respects month filter"
      setup: "Call with months=3"
      expected: "Request includes months=3 query param"

    - name: "formatRelativeTime returns correct strings"
      setup: "Various timestamps"
      cases:
        - input: "5 minutes ago"
          expected: "'5 minutes ago'"
        - input: "3 hours ago"
          expected: "'3 hours ago'"
        - input: "2 days ago"
          expected: "'2 days ago'"
        - input: "10 days ago"
          expected: "Date string"

  dashboard_stats_card:
    - name: "renders with loading state"
      setup: "loading=true"
      expected: "Skeleton loader displays"

    - name: "renders value and breakdown"
      setup: "value=247, breakdown=[{active: 215}, {inactive: 32}]"
      expected: "247 displays, breakdown items display"

    - name: "shows trend indicator when provided"
      setup: "trend={percent: 5.2, direction: 'up'}"
      expected: "Up arrow and +5.2% display"

    - name: "calls onClick when clicked"
      setup: "onClick mock"
      action: "Click card"
      expected: "onClick called once"

  allergen_matrix_panel:
    - name: "renders products as rows"
      setup: "2 products in data"
      expected: "2 product rows render"

    - name: "renders allergens as columns"
      setup: "3 allergens in data"
      expected: "3 allergen columns render"

    - name: "applies correct color for contains"
      setup: "relation_type='contains'"
      expected: "Cell has red background (#EF4444)"

    - name: "applies correct color for may_contain"
      setup: "relation_type='may_contain'"
      expected: "Cell has yellow background (#FBBF24)"

    - name: "applies correct color for free_from"
      setup: "relation_type=null"
      expected: "Cell has green background (#10B981)"

    - name: "calls onCellClick with correct params"
      setup: "onCellClick mock"
      action: "Click cell at [product1, allergen2]"
      expected: "onCellClick(product1.id, allergen2.id)"

  cost_trends_chart:
    - name: "renders Recharts LineChart"
      setup: "Valid cost trends data"
      expected: "LineChart component renders"

    - name: "shows all toggle buttons"
      setup: "Valid cost trends data"
      expected: "Material, Labor, Overhead, Total toggles visible"

    - name: "toggles line visibility"
      setup: "Total toggle initially active"
      action: "Click Material toggle"
      expected: "Material line becomes visible"

# Integration Test Cases
integration_tests:
  api_endpoints:
    - name: "GET /api/technical/dashboard/stats returns correct data"
      setup: "Create test products, boms, routings"
      expected: "Response matches expected counts"

    - name: "GET /api/technical/dashboard/stats enforces RLS"
      setup: "Create data in Org A and Org B"
      action: "Request from Org A user"
      expected: "Only Org A data returned"

    - name: "GET /api/technical/dashboard/allergen-matrix filters by product_type"
      setup: "Create products with different types"
      action: "Request with product_type filter"
      expected: "Only matching products returned"

    - name: "GET /api/technical/dashboard/bom-timeline respects months param"
      setup: "Create BOMs over 12 months"
      action: "Request with months=3"
      expected: "Only last 3 months data returned"

    - name: "GET /api/technical/dashboard/recent-activity returns last 10"
      setup: "Create 20 activities"
      action: "Request with limit=10"
      expected: "Exactly 10 most recent returned"

    - name: "GET /api/technical/dashboard/cost-trends returns monthly averages"
      setup: "Create product costs across months"
      expected: "Data grouped by month with averages"

  rls_isolation:
    - name: "Dashboard stats isolated by org"
      setup: "Create products in Org A and Org B"
      action: "Org A user fetches stats"
      expected: "Only Org A products counted"

    - name: "Allergen matrix isolated by org"
      setup: "Create allergen relations in Org A and Org B"
      action: "Org A user fetches matrix"
      expected: "Only Org A products and allergens returned"

# E2E Test Cases
e2e_tests:
  - name: "Dashboard loads with data"
    steps:
      - "Navigate to /technical"
      - "Wait for stats cards to load"
      - "Verify 4 stats cards visible"
      - "Verify allergen matrix visible"
      - "Verify BOM timeline visible"
      - "Verify recent activity visible"
      - "Verify cost trends chart visible"
    expected: "All widgets display with data"

  - name: "Dashboard empty state"
    setup: "New org with no data"
    steps:
      - "Navigate to /technical"
      - "Wait for load"
    expected: "Empty state with onboarding CTAs displays"

  - name: "Stats card navigation"
    steps:
      - "Navigate to /technical"
      - "Click Products card"
    expected: "Navigates to /technical/products"

  - name: "Allergen matrix PDF export"
    steps:
      - "Navigate to /technical"
      - "Click Export PDF button"
    expected: "PDF file downloads"

  - name: "BOM timeline dot navigation"
    steps:
      - "Navigate to /technical"
      - "Click BOM timeline dot"
    expected: "Navigates to BOM detail page"

  - name: "Quick action - New Product"
    steps:
      - "Navigate to /technical"
      - "Click '+ New Product' button"
    expected: "Product creation modal opens"

  - name: "Responsive - Mobile layout"
    setup: "Set viewport to 375x667"
    steps:
      - "Navigate to /technical"
    expected: "Single column layout, cards stacked"

# Definition of Done
definition_of_done:
  - "Dashboard page loads within 500ms for stats cards"
  - "All 4 stats cards display correct counts and trends"
  - "Allergen matrix renders with correct color coding"
  - "Allergen matrix PDF export works with legend"
  - "BOM timeline shows last 6 months of version changes"
  - "Recent activity shows last 10 events with relative timestamps"
  - "Cost trends chart renders with toggleable lines"
  - "Quick action buttons open correct modals"
  - "Click navigation works for all cards and panels"
  - "Empty state displays correctly for new organizations"
  - "Error state with retry button works"
  - "Responsive design works at all breakpoints"
  - "All API endpoints have integration tests"
  - "Dashboard service has >80% unit test coverage"
  - "Caching strategy implemented with correct TTLs"

# Coverage Requirements
coverage:
  unit:
    target: 80
    reason: "Dashboard is read-only aggregation, moderate coverage sufficient"
  integration:
    target: 80
    reason: "API endpoints and RLS must be tested"
  files:
    - "lib/services/dashboard-service.ts: 80%"
    - "components/DashboardStatsCard.tsx: 80%"
    - "components/AllergenMatrixPanel.tsx: 75%"
    - "components/CostTrendsChart.tsx: 75%"
    - "API routes: 80%"

# Performance Requirements
performance:
  targets:
    - endpoint: "/api/technical/dashboard/stats"
      max_latency: 500
      description: "Stats cards load"
    - endpoint: "/api/technical/dashboard/allergen-matrix"
      max_latency: 1000
      description: "50 products x 10 allergens"
    - endpoint: "/api/technical/dashboard/bom-timeline"
      max_latency: 800
      description: "50 changes"
    - endpoint: "/api/technical/dashboard/recent-activity"
      max_latency: 300
      description: "10 items"
    - endpoint: "/api/technical/dashboard/cost-trends"
      max_latency: 500
      description: "6 months, pre-aggregated"

# Risks
risks:
  - id: "RISK-01"
    description: "Performance degradation with large datasets"
    mitigation: "Implement caching with appropriate TTLs, add pagination for allergen matrix"
    severity: "medium"

  - id: "RISK-02"
    description: "PDF export fails for large matrices"
    mitigation: "Limit export to 50 products, add pagination or split into multiple pages"
    severity: "low"

  - id: "RISK-03"
    description: "Recent activity query slow without materialized view"
    mitigation: "Start with UNION query, monitor performance, add activity_log table if needed"
    severity: "medium"
