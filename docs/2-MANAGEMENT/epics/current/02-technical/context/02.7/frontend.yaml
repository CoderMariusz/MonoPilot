# Story 02.7 - Frontend Specification
# Purpose: Pages, components, hooks, services
# Agent: FRONTEND-DEV

# Story Type
is_full_stack: true

# Pages
pages:
  - path: "apps/frontend/app/(authenticated)/technical/routings/page.tsx"
    name: "RoutingsListPage"
    description: "Main routings list with search, filters, CRUD actions"
    wireframe: "TEC-007"
    features:
      - "DataTable with sorting and pagination"
      - "Client-side search by name/description (300ms debounce)"
      - "Server-side filter by status (Active/Inactive/All)"
      - "Add, Edit, Clone, Delete actions"
      - "Empty state with CTA"
      - "Loading skeleton"
      - "Error state with retry"
    state:
      - "routings: Routing[]"
      - "isLoading: boolean"
      - "error: Error | null"
      - "searchTerm: string"
      - "statusFilter: 'all' | 'true' | 'false'"
      - "createModalOpen: boolean"
      - "editModalOpen: boolean"
      - "editRoutingId: string | null"
      - "cloneModalOpen: boolean"
      - "cloneSourceRouting: Routing | null"
      - "deleteDialogOpen: boolean"
      - "deleteRouting: Routing | null"
      - "deleteUsage: BOMUsage | null"

  - path: "apps/frontend/app/(authenticated)/technical/routings/[id]/page.tsx"
    name: "RoutingDetailPage"
    description: "Routing detail with header info and BOM usage"
    wireframe: "TEC-008a"
    features:
      - "Header with code, name, status badge, version"
      - "Description section"
      - "Cost configuration display (ADR-009)"
      - "Reusability indicator"
      - "BOM usage count and list"
      - "Edit button (opens modal)"
      - "Back to list navigation"
    state:
      - "routing: RoutingDetail | null"
      - "isLoading: boolean"
      - "error: Error | null"
      - "editModalOpen: boolean"

# Components
components:
  - path: "apps/frontend/components/technical/routings/routings-data-table.tsx"
    name: "RoutingsDataTable"
    description: "ShadCN DataTable for routings list"
    props:
      - "routings: Routing[]"
      - "onView: (id: string) => void"
      - "onEdit: (routing: Routing) => void"
      - "onClone: (routing: Routing) => void"
      - "onDelete: (routing: Routing) => void"
    columns:
      - { id: "name", header: "Name", sortable: true }
      - { id: "description", header: "Description", truncate: 50 }
      - { id: "is_active", header: "Status", badge: true }
      - { id: "operations_count", header: "Ops.", badge: true }
      - { id: "actions", header: "", icons: ["view", "edit", "clone", "delete"] }

  - path: "apps/frontend/components/technical/routings/create-routing-modal.tsx"
    name: "CreateRoutingModal"
    description: "Create/Edit routing modal with cost configuration"
    wireframe: "TEC-008"
    props:
      - "open: boolean"
      - "onOpenChange: (open: boolean) => void"
      - "routingId?: string (for edit mode)"
      - "onSuccess: () => void"
    form_fields:
      - { name: "code", type: "text", required: true, transform: "uppercase" }
      - { name: "name", type: "text", required: true }
      - { name: "description", type: "textarea", required: false }
      - { name: "is_active", type: "select", options: ["Active", "Inactive"] }
      - { name: "is_reusable", type: "checkbox", default: true }
      - { name: "setup_cost", type: "number", decimal: 2, default: 0 }
      - { name: "working_cost_per_unit", type: "number", decimal: 4, default: 0 }
      - { name: "overhead_percent", type: "number", decimal: 2, default: 0, max: 100 }
      - { name: "currency", type: "select", options: ["PLN", "EUR", "USD", "GBP"] }
    features:
      - "Create mode: empty form with defaults"
      - "Edit mode: pre-filled form with version display"
      - "Code auto-uppercase transform"
      - "Inline validation errors"
      - "Usage warning banner (edit mode when deactivating)"
      - "Unsaved changes confirmation"
      - "Navigate to detail page on create success"

  - path: "apps/frontend/components/technical/routings/clone-routing-modal.tsx"
    name: "CloneRoutingModal"
    description: "Clone routing with source info display"
    wireframe: "TEC-007 (Clone Action)"
    props:
      - "open: boolean"
      - "onOpenChange: (open: boolean) => void"
      - "sourceRouting: Routing | null"
      - "onSuccess: () => void"
    sections:
      - name: "Source Routing Info"
        readonly: true
        fields: ["name", "operations_count", "description"]
      - name: "New Routing Details"
        fields:
          - { name: "name", default: "{source.name} - Copy" }
          - { name: "code", default: "{source.code}-COPY" }
          - { name: "description", default: "{source.description}" }
          - { name: "is_active", type: "checkbox", default: true }
    features:
      - "Info banner explaining clone behavior"
      - "Operation copy summary"
      - "Name uniqueness validation"

  - path: "apps/frontend/components/technical/routings/delete-routing-dialog.tsx"
    name: "DeleteRoutingDialog"
    description: "Enhanced delete confirmation with usage warning"
    wireframe: "TEC-007 (Delete Action)"
    props:
      - "open: boolean"
      - "onOpenChange: (open: boolean) => void"
      - "routing: Routing | null"
      - "bomUsage: BOMUsage | null"
      - "onConfirm: () => void"
      - "onMakeInactive: () => void"
    variants:
      with_usage:
        - "Warning banner"
        - "BOM list (first 5)"
        - "Impact statement"
        - "Make Inactive alternative button"
      without_usage:
        - "Success indicator"
        - "Standard confirmation"
    features:
      - "Loading state during usage check"
      - "Three buttons: Cancel, Make Inactive, Delete"

  - path: "apps/frontend/components/technical/routings/routing-status-badge.tsx"
    name: "RoutingStatusBadge"
    description: "Status indicator badge"
    props:
      - "isActive: boolean"
    variants:
      active: { text: "Active", color: "green", icon: "circle-filled" }
      inactive: { text: "Inactive", color: "gray", icon: "circle-outline" }

  - path: "apps/frontend/components/technical/routings/cost-config-section.tsx"
    name: "CostConfigSection"
    description: "Cost configuration display/form section (ADR-009)"
    props:
      - "setupCost: number"
      - "workingCostPerUnit: number"
      - "overheadPercent: number"
      - "currency: string"
      - "editable?: boolean"
      - "onChange?: (field: string, value: number) => void"
    features:
      - "Display mode: read-only values with currency suffix"
      - "Edit mode: number inputs with validation"
      - "Info tooltip explaining each field"

# Services
services:
  - path: "apps/frontend/lib/services/routing-service.ts"
    description: "Routing CRUD operations"
    exports:
      - name: "listRoutings"
        signature: "(filters: RoutingFilters) => Promise<RoutingsListResponse>"

      - name: "getRouting"
        signature: "(id: string) => Promise<RoutingDetailResponse>"

      - name: "createRouting"
        signature: "(data: CreateRoutingInput) => Promise<Routing>"

      - name: "updateRouting"
        signature: "(id: string, data: UpdateRoutingInput) => Promise<Routing>"

      - name: "deleteRouting"
        signature: "(id: string) => Promise<{ success: boolean, affected_boms: number }>"

      - name: "cloneRouting"
        signature: "(id: string, data: CloneRoutingInput) => Promise<{ routing: Routing, operationsCount: number }>"

      - name: "checkCodeUnique"
        signature: "(code: string, excludeId?: string) => Promise<boolean>"

      - name: "getRoutingBOMUsage"
        signature: "(id: string) => Promise<{ boms: BOM[], count: number }>"

    implementation: |
      // apps/frontend/lib/services/routing-service.ts
      import { Routing, RoutingFilters, CreateRoutingInput } from '@/lib/types/routing';

      const BASE_URL = '/api/v1/technical/routings';

      export async function listRoutings(filters: RoutingFilters = {}): Promise<RoutingsListResponse> {
        const params = new URLSearchParams();
        if (filters.search) params.set('search', filters.search);
        if (filters.is_active !== undefined) params.set('is_active', filters.is_active);
        if (filters.page) params.set('page', String(filters.page));
        if (filters.limit) params.set('limit', String(filters.limit));

        const response = await fetch(`${BASE_URL}?${params}`);
        if (!response.ok) throw new Error('Failed to fetch routings');
        return response.json();
      }

      export async function getRouting(id: string): Promise<RoutingDetailResponse> {
        const response = await fetch(`${BASE_URL}/${id}`);
        if (!response.ok) {
          if (response.status === 404) throw new Error('Routing not found');
          throw new Error('Failed to fetch routing');
        }
        return response.json();
      }

      export async function createRouting(data: CreateRoutingInput): Promise<Routing> {
        const response = await fetch(BASE_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        });

        if (!response.ok) {
          const error = await response.json();
          if (response.status === 409) {
            throw new Error(error.error || 'Code already exists');
          }
          throw new Error(error.error || 'Failed to create routing');
        }

        const result = await response.json();
        return result.routing;
      }

      export async function cloneRouting(
        id: string,
        data: CloneRoutingInput
      ): Promise<{ routing: Routing; operationsCount: number }> {
        const response = await fetch(`${BASE_URL}/${id}/clone`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Failed to clone routing');
        }

        return response.json();
      }

      export async function getRoutingBOMUsage(id: string): Promise<{ boms: BOM[]; count: number }> {
        const response = await fetch(`${BASE_URL}/${id}/boms`);
        if (!response.ok) throw new Error('Failed to check routing usage');
        return response.json();
      }

# Hooks
hooks:
  - path: "apps/frontend/lib/hooks/use-routings.ts"
    name: "useRoutings"
    description: "React Query hook for fetching routings list"
    returns: "UseQueryResult<RoutingsListResponse>"
    pattern: |
      import { useQuery } from '@tanstack/react-query';
      import { listRoutings, RoutingFilters } from '@/lib/services/routing-service';

      export function useRoutings(filters: RoutingFilters = {}) {
        return useQuery({
          queryKey: ['routings', filters],
          queryFn: () => listRoutings(filters),
          staleTime: 5 * 60 * 1000, // 5 minutes
        });
      }

  - path: "apps/frontend/lib/hooks/use-routing.ts"
    name: "useRouting"
    description: "React Query hook for fetching single routing"
    returns: "UseQueryResult<RoutingDetailResponse>"
    pattern: |
      import { useQuery } from '@tanstack/react-query';
      import { getRouting } from '@/lib/services/routing-service';

      export function useRouting(id: string) {
        return useQuery({
          queryKey: ['routing', id],
          queryFn: () => getRouting(id),
          enabled: !!id,
        });
      }

# UX Patterns
ux:
  wireframes:
    - id: "TEC-007"
      path: "docs/3-ARCHITECTURE/ux/wireframes/TEC-007-routings-list.md"
      components:
        - "RoutingsDataTable"
        - "SearchInput"
        - "StatusFilter"
        - "CloneRoutingModal"
        - "DeleteRoutingDialog"
    - id: "TEC-008"
      path: "docs/3-ARCHITECTURE/ux/wireframes/TEC-008-routing-modal.md"
      components:
        - "CreateRoutingModal"
        - "CostConfigSection"
    - id: "TEC-008a"
      path: "docs/3-ARCHITECTURE/ux/wireframes/TEC-008a-routing-detail.md"
      components:
        - "RoutingDetailPage"
        - "RoutingStatusBadge"
        - "CostConfigSection"

  patterns:
    table: "ShadCN DataTable with sorting, client-side search"
    modal: "ShadCN Dialog with react-hook-form + Zod"
    toast: "ShadCN Toast via useToast hook"
    badge: "ShadCN Badge with color variants"
    loading: "Skeleton loader for table rows"
    empty: "Empty state with icon, message, and CTA button"
    error: "Error banner with retry button"

  states:
    loading: "Skeleton table rows while fetching"
    empty: "No Routings Found with Create CTA"
    error: "Error banner with Try Again and Contact Support"
    success: "Data table with rows"

  interactions:
    search:
      - "Type in search input"
      - "Debounce 300ms"
      - "Client-side filter by name/description"
    status_filter:
      - "Select from dropdown"
      - "Server-side filter (re-fetch)"
    create:
      - "Click [+ Add Routing]"
      - "Modal opens with empty form"
      - "Fill form, click Create"
      - "Navigate to detail page on success"
    edit:
      - "Click edit icon in row"
      - "Modal opens with pre-filled data"
      - "Edit, click Save Changes"
      - "Refresh list on success"
    clone:
      - "Click clone icon in row"
      - "Clone modal opens with source info"
      - "Edit name, click Clone Routing"
      - "Toast: 'Routing cloned with X operations'"
      - "Refresh list"
    delete:
      - "Click delete icon in row"
      - "Loading: check BOM usage"
      - "Dialog shows usage warning if used"
      - "Confirm or Make Inactive"
      - "Toast on success"

# Accessibility
accessibility:
  wcag_level: "AA"
  requirements:
    - "All buttons >= 48x48dp touch target"
    - "Color contrast >= 4.5:1 for text"
    - "Focus indicators on all interactive elements"
    - "Keyboard navigation (Tab, Enter, Escape)"
    - "Screen reader labels for icon buttons"
    - "Modal focus trap"
    - "Error announcements via aria-live"
  keyboard:
    tab: "Navigate through filters, table, buttons"
    enter: "Activate button, submit form"
    escape: "Close modal/dialog"
    arrow_keys: "Navigate dropdown options"

# Performance
performance:
  initial_load: "< 500ms for 100 routings"
  search_filter: "< 300ms client-side"
  create_routing: "< 1s"
  clone_routing: "< 2s (depends on operations count)"
  caching:
    stale_time: "5 minutes"
    refetch_on_focus: true
