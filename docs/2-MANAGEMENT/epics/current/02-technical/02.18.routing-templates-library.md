# 02.18 - Routing Templates Library

**Story ID:** 02.18
**Epic:** 02 - Technical
**Phase:** Phase 2
**Complexity:** S (Small)
**Estimate:** 2-3 days
**Type:** Backend + Frontend
**State:** ready
**Priority:** P2

**Primary PRD:** `docs/1-BASELINE/product/modules/TECHNICAL.md` (FR-2.47)
**Dependencies:** 02.7 (Routings CRUD), 02.8 (Routing Operations)

## PRD References

| FR ID | Requirement | Priority | Phase | Covered |
|-------|-------------|----------|-------|---------|
| FR-2.47 | Routing templates | P2 | Future | Yes |

## User Story

**As a** production manager,
**I want** to save routings as reusable templates and create new routings from templates,
**So that** I can quickly standardize production processes across similar products without recreating operations from scratch.

**As an** organization administrator,
**I want** to organize templates by category and control sharing visibility,
**So that** teams can find relevant templates easily and maintain process consistency.

## Goal

Implement a routing templates library that allows users to save existing routings as templates, browse/search templates by category, and create new routings from templates with all operations copied. Templates support organization-private and public (marketplace) sharing options.

## Scope

**In scope:**
- Routing template CRUD (name, description, category, tags)
- Save existing routing as template (copies operations)
- Create routing from template (clones template with operations)
- Template library page with search and category filters
- Template categories (mixing, baking, packaging, fermentation, etc.)
- Template visibility (org-private vs public marketplace)
- Template preview modal with operations list
- Template usage counter

**Out of scope:**
- Public marketplace moderation/approval workflow
- Template versioning/history
- Template comments/ratings
- Template import/export files
- Cross-organization template purchase

## Dependencies

| Story | Requirement | Status |
|-------|-------------|--------|
| 02.7 | Routings CRUD | Required - template source routing |
| 02.8 | Routing Operations | Required - operations to copy |
| 01.1 | Org Context + Base RLS | Required - org isolation |

## Acceptance Criteria (Given/When/Then)

### Template Library Page

- GIVEN user navigates to `/technical/routing-templates`, WHEN page loads, THEN template library displays within 500ms for up to 100 templates.
- GIVEN template library displayed, WHEN user searches "bread", THEN filtered results show templates containing "bread" in name or description within 300ms.
- GIVEN template library displayed, WHEN user filters by category "Baking", THEN only baking templates appear.
- GIVEN template library displayed, WHEN user toggles "My Org Only", THEN only org-private templates display.
- GIVEN template card rendered, WHEN viewed, THEN shows: name, category badge, description (truncated), operations count, usage count, visibility badge.
- GIVEN empty template library, WHEN page loads, THEN empty state displays with "No Templates Found" message and "[+ Create Your First Template]" CTA.

### Save Routing as Template

- GIVEN user on routing detail page `/technical/routings/:id`, WHEN clicks "[Save as Template]", THEN template modal opens.
- GIVEN template modal open, WHEN form displays, THEN pre-fills name with "{routing.name} Template", shows source routing info read-only, and category dropdown.
- GIVEN user enters valid template data (name, description, category), WHEN "[Create Template]" clicked, THEN template created with all operations copied.
- GIVEN template name already exists in org, WHEN save attempted, THEN error "Template name already exists" displays inline.
- GIVEN user selects visibility "Public", WHEN save completes, THEN template visible to all organizations in marketplace.
- GIVEN user selects visibility "Private", WHEN save completes, THEN template visible only to own organization.
- GIVEN successful template creation, WHEN complete, THEN toast "Template created successfully" displays and modal closes.

### Create Routing from Template

- GIVEN user clicks "[Use Template]" on template card, WHEN modal opens, THEN shows template preview with operations list.
- GIVEN template preview modal, WHEN user clicks "[Create Routing from Template]", THEN routing creation form opens.
- GIVEN routing creation form, WHEN form pre-fills, THEN name defaults to "{template.name} - New", code empty (user must enter), operations preview shown.
- GIVEN user enters valid routing data (code, name), WHEN "[Create Routing]" clicked, THEN new routing created with all template operations copied.
- GIVEN routing created from template, WHEN creation completes, THEN navigates to new routing detail page.
- GIVEN routing created from template, WHEN viewing operations, THEN all template operations copied with same sequences, times, instructions.
- GIVEN template usage, WHEN template used, THEN template `usage_count` increments.

### Template Categories

- GIVEN template modal category dropdown, WHEN dropdown opens, THEN shows predefined categories: Mixing, Baking, Packaging, Fermentation, Cooking, Cooling, Quality Check, Assembly, Cleaning.
- GIVEN category filter on library page, WHEN rendered, THEN shows all categories with template counts per category.
- GIVEN category selected, WHEN filtering, THEN only templates in that category display.
- GIVEN template created with category "Baking", WHEN displayed, THEN category badge shows "Baking" in appropriate color.

### Template Preview

- GIVEN user clicks template card, WHEN preview modal opens, THEN shows: name, description, category, visibility, operations list, usage count, created date.
- GIVEN preview modal operations list, WHEN rendered, THEN shows: sequence, name, duration, setup/cleanup times for each operation.
- GIVEN preview modal, WHEN "[Use Template]" clicked, THEN routing creation flow starts.
- GIVEN preview modal, WHEN close clicked, THEN modal closes without action.

### Edit/Delete Template

- GIVEN user owns template (created by or org match), WHEN template card rendered, THEN edit/delete actions visible.
- GIVEN user clicks "[Edit Template]", WHEN modal opens, THEN current template data pre-populates (name, description, category, visibility).
- GIVEN user updates template name, WHEN save completes, THEN updated name displays immediately.
- GIVEN user clicks "[Delete Template]" on unused template, WHEN confirmation dialog shows, THEN "Delete Template" button available.
- GIVEN user confirms delete, WHEN deletion completes, THEN template removed from library.
- GIVEN template has usage_count > 0, WHEN delete attempted, THEN warning "This template has been used X times. Delete anyway?" displays.

### Visibility & Permissions

- GIVEN public template from another org, WHEN viewing, THEN "[Use Template]" available but edit/delete hidden.
- GIVEN private template from own org, WHEN viewing, THEN "[Use Template]", edit, and delete all available.
- GIVEN user without technical write permission, WHEN library loaded, THEN "[Create Template]" hidden.
- GIVEN private template from another org, WHEN library loaded, THEN template NOT visible.

### Template Operations Copy

- GIVEN template has 5 operations, WHEN routing created from template, THEN all 5 operations copied with same data.
- GIVEN template operation has machine_id assigned, WHEN copied, THEN machine_id preserved (if machine exists in target org) OR set to NULL (if not).
- GIVEN template operation has instructions, WHEN copied, THEN instructions copied verbatim.
- GIVEN template operation has attachments, WHEN copied, THEN attachments NOT copied (user must re-upload).

## Technical Specification

### Database Schema

#### routing_templates table

```sql
CREATE TABLE routing_templates (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,

  -- Template metadata
  name VARCHAR(100) NOT NULL,
  description TEXT,
  category VARCHAR(50) NOT NULL,

  -- Visibility
  visibility VARCHAR(20) NOT NULL DEFAULT 'private' CHECK (visibility IN ('private', 'public')),

  -- Usage tracking
  usage_count INTEGER DEFAULT 0,

  -- Source routing (for reference, not FK - routing may be deleted)
  source_routing_id UUID,
  source_routing_code VARCHAR(50),

  -- Timestamps
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  created_by UUID REFERENCES users(id),

  -- Constraints
  UNIQUE(org_id, name)
);

-- Indexes
CREATE INDEX idx_routing_templates_org_id ON routing_templates(org_id);
CREATE INDEX idx_routing_templates_category ON routing_templates(category);
CREATE INDEX idx_routing_templates_visibility ON routing_templates(visibility);
CREATE INDEX idx_routing_templates_name ON routing_templates(name);

-- RLS Policy: See own org + public templates
ALTER TABLE routing_templates ENABLE ROW LEVEL SECURITY;

CREATE POLICY "routing_templates_select"
ON routing_templates FOR SELECT
USING (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  OR visibility = 'public'
);

CREATE POLICY "routing_templates_insert"
ON routing_templates FOR INSERT
WITH CHECK (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

CREATE POLICY "routing_templates_update"
ON routing_templates FOR UPDATE
USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

CREATE POLICY "routing_templates_delete"
ON routing_templates FOR DELETE
USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));
```

#### template_operations table

```sql
CREATE TABLE template_operations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  template_id UUID NOT NULL REFERENCES routing_templates(id) ON DELETE CASCADE,

  -- Operation data (copied from routing_operations)
  sequence INTEGER NOT NULL,
  name TEXT NOT NULL,
  description TEXT,
  machine_id UUID, -- Nullable, may not exist in target org
  setup_time INTEGER DEFAULT 0,
  duration INTEGER NOT NULL,
  cleanup_time INTEGER DEFAULT 0,
  labor_cost_per_hour DECIMAL(15,4) DEFAULT 0,
  instructions TEXT,

  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Index
CREATE INDEX idx_template_operations_template ON template_operations(template_id);

-- RLS: Inherit from parent template
ALTER TABLE template_operations ENABLE ROW LEVEL SECURITY;

CREATE POLICY "template_operations_select"
ON template_operations FOR SELECT
USING (
  EXISTS (
    SELECT 1 FROM routing_templates t
    WHERE t.id = template_id
    AND (t.org_id = (SELECT org_id FROM users WHERE id = auth.uid()) OR t.visibility = 'public')
  )
);

CREATE POLICY "template_operations_insert"
ON template_operations FOR INSERT
WITH CHECK (
  EXISTS (
    SELECT 1 FROM routing_templates t
    WHERE t.id = template_id
    AND t.org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  )
);

CREATE POLICY "template_operations_delete"
ON template_operations FOR DELETE
USING (
  EXISTS (
    SELECT 1 FROM routing_templates t
    WHERE t.id = template_id
    AND t.org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  )
);
```

### API Endpoints

```typescript
// GET /api/technical/routing-templates
// Query params: search, category, visibility (all|private|public), page, limit
interface TemplatesListResponse {
  templates: RoutingTemplate[];
  total: number;
  page: number;
  limit: number;
  categories: CategoryCount[]; // { category: string, count: number }[]
}

interface RoutingTemplate {
  id: string;
  org_id: string;
  name: string;
  description: string | null;
  category: string;
  visibility: 'private' | 'public';
  usage_count: number;
  operations_count: number; // Aggregated count
  source_routing_code: string | null;
  created_at: string;
  created_by: string;
  is_own: boolean; // org_id matches current user
}

// GET /api/technical/routing-templates/:id
interface TemplateDetailResponse {
  template: RoutingTemplate;
  operations: TemplateOperation[];
}

interface TemplateOperation {
  id: string;
  sequence: number;
  name: string;
  description: string | null;
  machine_id: string | null;
  setup_time: number;
  duration: number;
  cleanup_time: number;
  labor_cost_per_hour: number;
  instructions: string | null;
}

// POST /api/technical/routing-templates
interface CreateTemplateRequest {
  name: string; // Required, 3-100 chars
  description?: string | null; // Optional, max 500 chars
  category: string; // Required, from predefined list
  visibility: 'private' | 'public'; // Default: 'private'
  source_routing_id: string; // Required, UUID of routing to copy
}

// PUT /api/technical/routing-templates/:id
interface UpdateTemplateRequest {
  name?: string;
  description?: string | null;
  category?: string;
  visibility?: 'private' | 'public';
}

// DELETE /api/technical/routing-templates/:id
// Returns: { success: true }

// POST /api/technical/routing-templates/:id/create-routing
interface CreateRoutingFromTemplateRequest {
  code: string; // Required, unique routing code
  name: string; // Required, 3-100 chars
  description?: string | null;
  is_active?: boolean; // Default: true
}

interface CreateRoutingFromTemplateResponse {
  routing: {
    id: string;
    code: string;
    name: string;
    operations_count: number;
  };
}

// GET /api/technical/routing-templates/categories
interface CategoriesResponse {
  categories: string[];
}
```

### Predefined Categories

```typescript
const TEMPLATE_CATEGORIES = [
  'Mixing',
  'Baking',
  'Packaging',
  'Fermentation',
  'Cooking',
  'Cooling',
  'Quality Check',
  'Assembly',
  'Cleaning',
  'Other'
] as const;

type TemplateCategory = typeof TEMPLATE_CATEGORIES[number];
```

### Services

**Location:** `lib/services/routing-template-service.ts`

```typescript
interface RoutingTemplateService {
  // Template CRUD
  listTemplates(filters: TemplateFilters): Promise<TemplatesListResponse>;
  getTemplate(id: string): Promise<TemplateDetailResponse>;
  createTemplate(data: CreateTemplateRequest): Promise<RoutingTemplate>;
  updateTemplate(id: string, data: UpdateTemplateRequest): Promise<RoutingTemplate>;
  deleteTemplate(id: string): Promise<void>;

  // Template usage
  createRoutingFromTemplate(templateId: string, data: CreateRoutingFromTemplateRequest): Promise<Routing>;
  incrementUsageCount(templateId: string): Promise<void>;

  // Helpers
  getCategories(): Promise<string[]>;
  checkNameUnique(name: string, excludeId?: string): Promise<boolean>;
  copyOperationsToTemplate(routingId: string, templateId: string): Promise<void>;
  copyOperationsFromTemplate(templateId: string, routingId: string): Promise<void>;
}

interface TemplateFilters {
  search?: string;
  category?: string;
  visibility?: 'all' | 'private' | 'public';
  page?: number;
  limit?: number;
}
```

### Validation (Zod)

**Location:** `lib/validation/routing-template.ts`

```typescript
import { z } from 'zod';

const TEMPLATE_CATEGORIES = [
  'Mixing', 'Baking', 'Packaging', 'Fermentation',
  'Cooking', 'Cooling', 'Quality Check', 'Assembly',
  'Cleaning', 'Other'
] as const;

export const createTemplateSchema = z.object({
  name: z.string()
    .min(3, 'Name must be at least 3 characters')
    .max(100, 'Name must be less than 100 characters'),
  description: z.string()
    .max(500, 'Description must be less than 500 characters')
    .nullable()
    .optional(),
  category: z.enum(TEMPLATE_CATEGORIES, {
    errorMap: () => ({ message: 'Please select a valid category' })
  }),
  visibility: z.enum(['private', 'public']).default('private'),
  source_routing_id: z.string().uuid('Invalid routing ID'),
});

export const updateTemplateSchema = z.object({
  name: z.string()
    .min(3, 'Name must be at least 3 characters')
    .max(100, 'Name must be less than 100 characters')
    .optional(),
  description: z.string()
    .max(500, 'Description must be less than 500 characters')
    .nullable()
    .optional(),
  category: z.enum(TEMPLATE_CATEGORIES).optional(),
  visibility: z.enum(['private', 'public']).optional(),
});

export const createRoutingFromTemplateSchema = z.object({
  code: z.string()
    .min(2, 'Code must be at least 2 characters')
    .max(50, 'Code must be less than 50 characters')
    .regex(/^[A-Z0-9-]+$/, 'Code can only contain uppercase letters, numbers, and hyphens')
    .transform(val => val.toUpperCase()),
  name: z.string()
    .min(3, 'Name must be at least 3 characters')
    .max(100, 'Name must be less than 100 characters'),
  description: z.string()
    .max(500, 'Description must be less than 500 characters')
    .nullable()
    .optional(),
  is_active: z.boolean().default(true),
});
```

### Frontend Components

```
app/(authenticated)/technical/routing-templates/page.tsx  -- Template library page
components/technical/templates/
  TemplateLibraryPage.tsx        -- Main library page
  TemplateCard.tsx               -- Template card in grid
  TemplateFilters.tsx            -- Search + category filters
  TemplatePreviewModal.tsx       -- Template preview with operations
  CreateTemplateModal.tsx        -- Save routing as template modal
  CreateRoutingFromTemplateModal.tsx -- Create routing from template
  CategoryBadge.tsx              -- Category badge with color
  VisibilityBadge.tsx            -- Private/Public badge
  TemplatesEmptyState.tsx        -- Empty state
```

### UI Patterns

**Template Card Layout:**
```
+------------------------------------------+
| [Baking]                    [Private]    |
| Standard Bread Line Template             |
| Mix, proof, bake workflow for artisan... |
|                                          |
| 5 operations | Used 12 times             |
|                                          |
| [Preview]  [Use Template]  [Edit] [Del]  |
+------------------------------------------+
```

**Template Preview Modal:**
```
+------------------------------------------------+
| Standard Bread Line Template          [X Close]|
+------------------------------------------------+
| Category: Baking                               |
| Visibility: Private                            |
| Created: Jan 10, 2026                          |
| Used: 12 times                                 |
|                                                |
| Operations (5):                                |
| +--------------------------------------------+ |
| | # | Name     | Duration | Setup | Cleanup | |
| |---|----------|----------|-------|---------|  |
| | 1 | Mixing   | 15 min   | 5 min | 2 min  |  |
| | 2 | Proofing | 45 min   | 0 min | 0 min  |  |
| | 3 | Shaping  | 10 min   | 2 min | 1 min  |  |
| | 4 | Baking   | 30 min   | 5 min | 3 min  |  |
| | 5 | Cooling  | 20 min   | 0 min | 0 min  |  |
| +--------------------------------------------+ |
|                                                |
| Total: 120 min (2h 0m) | Setup: 12 min        |
|                                                |
| [Cancel]              [Create Routing from Template]|
+------------------------------------------------+
```

## Test Cases

### Unit Tests

**routing-template-service.test.ts**
```typescript
describe('RoutingTemplateService', () => {
  describe('createTemplate', () => {
    it('creates template with operations copied from source routing');
    it('validates name uniqueness within organization');
    it('rejects invalid category');
  });

  describe('createRoutingFromTemplate', () => {
    it('creates routing with all operations copied');
    it('increments template usage_count');
    it('handles machine_id for non-existent machines');
  });

  describe('listTemplates', () => {
    it('returns only own org and public templates');
    it('filters by category correctly');
    it('searches in name and description');
  });
});
```

### Integration Tests

**routing-templates-api.test.ts**
```typescript
describe('Routing Templates API', () => {
  describe('GET /api/technical/routing-templates', () => {
    it('returns own org templates');
    it('returns public templates from other orgs');
    it('excludes private templates from other orgs');
    it('filters by category');
    it('searches by name/description');
  });

  describe('POST /api/technical/routing-templates', () => {
    it('creates template with operations');
    it('rejects duplicate name in org');
    it('requires valid source_routing_id');
  });

  describe('POST /api/technical/routing-templates/:id/create-routing', () => {
    it('creates routing with copied operations');
    it('increments usage_count');
    it('validates routing code uniqueness');
  });

  describe('DELETE /api/technical/routing-templates/:id', () => {
    it('deletes own org template');
    it('rejects delete of other org template');
    it('cascades to template_operations');
  });
});
```

### E2E Tests

**routing-templates.spec.ts**
```typescript
describe('Routing Templates', () => {
  it('saves routing as template from routing detail page');
  it('browses template library with filters');
  it('creates routing from template');
  it('previews template operations before use');
  it('edits own template metadata');
  it('deletes own template');
});
```

## Deliverables

- [ ] Database migration for `routing_templates` table
- [ ] Database migration for `template_operations` table
- [ ] RLS policies for templates (own org + public visibility)
- [ ] API route: `GET /api/technical/routing-templates`
- [ ] API route: `GET /api/technical/routing-templates/:id`
- [ ] API route: `POST /api/technical/routing-templates`
- [ ] API route: `PUT /api/technical/routing-templates/:id`
- [ ] API route: `DELETE /api/technical/routing-templates/:id`
- [ ] API route: `POST /api/technical/routing-templates/:id/create-routing`
- [ ] API route: `GET /api/technical/routing-templates/categories`
- [ ] Template library page (`/technical/routing-templates/page.tsx`)
- [ ] TemplateCard component
- [ ] TemplateFilters component
- [ ] TemplatePreviewModal component
- [ ] CreateTemplateModal component
- [ ] CreateRoutingFromTemplateModal component
- [ ] CategoryBadge component
- [ ] VisibilityBadge component
- [ ] routing-template-service.ts
- [ ] Zod validation schemas
- [ ] "[Save as Template]" button on routing detail page
- [ ] Unit tests (>80% coverage)
- [ ] Integration tests for API endpoints
- [ ] E2E tests for template workflow

## Definition of Done

- [ ] Template library page loads within 500ms for 100 templates
- [ ] Search filters templates by name/description within 300ms
- [ ] Category filter shows only matching templates
- [ ] Visibility filter works (all/private/public)
- [ ] Save routing as template copies all operations
- [ ] Create routing from template copies all operations
- [ ] Template usage_count increments on routing creation
- [ ] Private templates visible only to own organization
- [ ] Public templates visible to all organizations
- [ ] Template name unique within organization
- [ ] Edit/delete actions available only for own templates
- [ ] Category badges display with appropriate colors
- [ ] Template preview shows all operations with times
- [ ] Empty state displays when no templates found
- [ ] Permission checks hide unauthorized actions
- [ ] All API endpoints have integration tests
- [ ] Unit tests cover routing-template-service (>80% coverage)
- [ ] E2E tests pass for full template workflow
