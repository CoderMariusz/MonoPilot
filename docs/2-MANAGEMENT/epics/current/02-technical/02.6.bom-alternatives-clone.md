# 02.6 - BOM Alternatives + Clone Functionality

**Priority**: P0 (MVP)
**Story Points**: M (Medium)
**Type:** backend + frontend

**State:** ready
**Primary PRD:** `docs/1-BASELINE/product/modules/technical.md` (FR-2.24, FR-2.30)
**UX Wireframes:** TEC-006 (BOM Modal), TEC-006a (BOM Items Detail)

---

## MVP Scope

This story implements Phase 0 (MVP) functionality only. Features listed in "Future Phases" are deferred and should be handled per Epic 02.0 "Future Feature Handling" guidance.

---

## Goal

Implement BOM clone functionality for creating new BOM versions with all items copied, and alternative ingredients system with preference ordering, substitution rules validation, and circular reference prevention.

## User Story

As a **Production Manager**, I want to **clone an existing BOM to create a new version and define alternative ingredients for substitutions** so that **I can quickly iterate on recipes and handle ingredient shortages gracefully**.

## Scope

**In scope (MVP)**
- POST /api/technical/boms/:id/clone (clone BOM to new product or new version)
- BOM clone modal with target product selection and version options
- Clone copies: all BOM items, notes (routing assignment cloned if exists)
- Version auto-increment when cloning to same product
- Alternative ingredient CRUD (bom_alternatives table)
- Alternative ingredient preference ordering (priority 1=primary, 2+=fallbacks)
- Alternative ingredient substitution rules validation (same type required)
- Circular reference prevention (cannot add BOM product as its own component)
- Clone action button in BOM list row actions and BOM detail header
- Alternative ingredients display in BOM items view

**Out of scope (this story)**
- BOM version comparison/diff view (FR-2.25 - covered in 02.14)
- BOM scaling/batch size adjustment (FR-2.35 - covered in 02.14)
- Multi-level BOM explosion (FR-2.29 - covered in 02.14)
- BOM cost calculation (covered in 02.9)
- Import/export BOM to CSV (deferred)

## Dependencies
- **01.1** - Org Context + Base RLS (for multi-tenant isolation)
- **02.4** - BOMs CRUD (required for BOM header exists)
- **02.5a** - BOM Items Core (required for items to clone)

## Acceptance Criteria (Given/When/Then)

### AC-1: Clone to New Version (Same Product)

**Given** user clicks "Clone" on BOM v1 for FG-001
**When** clone modal opens with "Same Product" selected
**Then** version field shows "v2" (auto-increment)

**Given** BOM v1 has 5 items
**When** clone completed
**Then** new BOM v2 created with all 5 items copied

**Given** BOM v1 has routing_id assigned to RTG-BREAD-01
**When** clone completed
**Then** new BOM v2 has same routing_id

**Given** clone to same product
**When** new BOM created
**Then** status defaults to "draft" regardless of source status

**Given** BOM v1 effective_from is "2024-01-01"
**When** clone completed
**Then** new BOM effective_from defaults to today's date

### AC-2: Clone to Different Product

**Given** user clicks "Clone" on BOM for FG-001
**When** user selects "Different Product" and picks FG-002
**Then** target product changes

**Given** user clones to FG-002 which has no existing BOMs
**When** clone completed
**Then** new BOM version is v1

**Given** user clones to FG-002 which has BOM v1, v2
**When** clone completed
**Then** new BOM version is v3

### AC-3: Clone Validation

**Given** user attempts clone without selecting target (for different product mode)
**When** "Clone" clicked
**Then** error "Select target product" displays

**Given** user attempts clone and target product has overlapping date range
**When** "Clone" clicked
**Then** error "Effective date overlaps with existing BOM for target product"

**Given** clone in progress
**When** server error occurs
**Then** error toast "Clone failed: {reason}" displays and modal stays open

### AC-4: Clone Success Flow

**Given** successful clone
**When** operation completes
**Then** success toast "BOM cloned successfully" displays

**Given** successful clone
**When** operation completes
**Then** user redirected to new BOM detail page

**Given** clone modal open
**When** "Cancel" clicked
**Then** modal closes without changes

### AC-5: Alternative Ingredients CRUD (FR-2.30)

**Given** user clicks "+ Add Alternative" on BOM item row
**When** modal opens
**Then** form shows primary item info (code, name, qty, uom) and empty alternative form

**Given** valid alternative data entered (same type, different product)
**When** "Add Alternative" clicked
**Then** alternative saved and appears in item sub-row

**Given** user clicks "Edit" on existing alternative
**When** modal opens
**Then** form pre-populated with alternative data

**Given** user changes alternative quantity from 48 to 50
**When** save completes
**Then** updated quantity displays in sub-row

**Given** user clicks "Delete" on alternative
**When** confirmation dialog accepted
**Then** alternative removed from item

### AC-6: Preference Ordering

**Given** item has 3 alternatives
**When** adding new alternative
**Then** preference_order defaults to max(existing) + 1

**Given** alternatives with orders 2, 3, 4
**When** item selected in production
**Then** system suggests alternatives in order: primary (1), then 2, 3, 4

**Given** user edits alternative preference from 3 to 2
**When** save completes
**Then** alternatives reorder by new preference

**Given** preference_order 1 entered for alternative
**When** save attempted
**Then** error "Preference must be 2 or higher (1 is reserved for primary)"

### AC-7: Substitution Rules Validation

**Given** primary item is type "RM" (Raw Material)
**When** adding alternative of type "ING" (Ingredient)
**Then** error "Alternative must be same product type as primary (Raw Material)"

**Given** primary item has base_uom "kg"
**When** adding alternative with base_uom "L"
**Then** warning "UoM class mismatch. Manual conversion may be required." (warning, not error)

**Given** primary item is RM-001
**When** adding RM-001 as its own alternative
**Then** error "Alternative cannot be same as primary component"

**Given** item already has RM-005 as alternative
**When** adding RM-005 again
**Then** error "Alternative already exists for this item"

### AC-8: Circular Reference Prevention

**Given** BOM is for product FG-001
**When** user attempts to add FG-001 as a BOM item component
**Then** error "Cannot add BOM product as its own component (circular reference)"

**Given** BOM item is WIP-001
**When** user attempts to add WIP-001 as its own alternative
**Then** error "Cannot add same product as alternative"

### AC-9: Alternatives Display

**Given** BOM item has 2 alternatives
**When** items table renders
**Then** sub-row shows:
  - "ALT: RM-005 Whole Wheat (48 kg) - Priority 2"
  - "ALT: RM-006 Rye Flour (52 kg) - Priority 3"

**Given** user clicks "Manage Alternatives" on item
**When** modal opens
**Then** all alternatives displayed with edit/delete actions

**Given** alternative has notes
**When** alternative row rendered
**Then** notes displayed in tooltip or expandable section

### AC-10: Permission Enforcement

**Given** user with read-only permission
**When** BOM detail page loaded
**Then** "Clone" button hidden

**Given** user with read-only permission
**When** items table loaded
**Then** "+ Add Alternative" links hidden

**Given** user with write permission
**When** clone modal opened
**Then** can proceed with clone operation

### AC-11: Future Features (Phase 1+)

Features deferred to Phase 1+:
- **Clone with alternatives** - Alternatives are NOT copied in MVP clone (simple item copy only)
- **Clone byproducts** - Byproducts are NOT copied in MVP clone (after 02.5b)
- **Substitution ratio** - Alternative may need different quantity (1:1 assumed in MVP)

**Developer**: Choose hiding strategy per Epic 02.0 "Future Feature Handling".

## Implementation Notes

### API Endpoints

```typescript
// POST /api/technical/boms/:id/clone
interface CloneBOMRequest {
  target_product_id: string;      // Same as source or different product
  effective_from: string;         // ISO date, defaults to today
  effective_to?: string | null;   // Optional
  status?: 'draft' | 'active';    // Default: 'draft'
  notes?: string;                 // Optional, can override
}

interface CloneBOMResponse {
  bom: {
    id: string;
    product_id: string;
    version: number;
    status: string;
    effective_from: string;
    effective_to: string | null;
    items_count: number;
  };
  message: string;
}

// GET /api/technical/boms/:id/items/:itemId/alternatives
interface AlternativesListResponse {
  alternatives: BOMAlternative[];
  primary_item: {
    id: string;
    product_code: string;
    product_name: string;
    product_type: string;
    quantity: number;
    uom: string;
  };
}

// POST /api/technical/boms/:id/items/:itemId/alternatives
interface CreateAlternativeRequest {
  alternative_product_id: string;
  quantity: number;
  uom: string;
  preference_order?: number;  // Auto-increment if not provided
  notes?: string | null;
}

// PUT /api/technical/boms/:id/items/:itemId/alternatives/:altId
interface UpdateAlternativeRequest {
  quantity?: number;
  uom?: string;
  preference_order?: number;
  notes?: string | null;
}

// DELETE /api/technical/boms/:id/items/:itemId/alternatives/:altId
// Returns success/error
```

### Database

```sql
-- Clone Operation (Transaction)
BEGIN;

-- 1. Create new BOM header
INSERT INTO boms (org_id, product_id, version, status, routing_id,
                  effective_from, effective_to, output_qty, output_uom,
                  notes, created_by)
SELECT org_id,
       :target_product_id,
       (SELECT COALESCE(MAX(version), 0) + 1 FROM boms WHERE product_id = :target_product_id AND org_id = :org_id),
       'draft',
       routing_id,
       :effective_from,
       :effective_to,
       output_qty,
       output_uom,
       :notes,
       :user_id
FROM boms WHERE id = :source_bom_id
RETURNING id AS new_bom_id;

-- 2. Clone BOM items (MVP: basic items only, no alternatives/byproducts)
INSERT INTO bom_items (bom_id, product_id, quantity, uom, sequence,
                        operation_seq, scrap_percent, notes)
SELECT :new_bom_id, product_id, quantity, uom, sequence,
       operation_seq, scrap_percent, notes
FROM bom_items
WHERE bom_id = :source_bom_id
  AND is_by_product = false;  -- MVP: skip byproducts

COMMIT;

-- bom_alternatives table constraints
ALTER TABLE bom_alternatives
ADD CONSTRAINT bom_alt_preference_order_check
CHECK (preference_order >= 2);

ALTER TABLE bom_alternatives
ADD CONSTRAINT bom_alt_unique_per_item
UNIQUE (bom_item_id, alternative_product_id);
```

### Frontend Components

```
components/technical/bom/
  BOMCloneModal.tsx          -- Clone BOM modal with target selection
  BOMAlternativeModal.tsx    -- Add/Edit alternative modal
  BOMAlternativesManager.tsx -- Manage all alternatives for an item
  AlternativeRow.tsx         -- Single alternative sub-row display
```

### Services

```typescript
// lib/services/bom-clone-service.ts
export async function cloneBOM(
  sourceBomId: string,
  options: CloneBOMRequest
): Promise<CloneBOMResponse>

export async function getNextVersion(productId: string): Promise<number>

export async function validateCloneTarget(
  productId: string,
  effectiveFrom: string,
  effectiveTo: string | null
): Promise<{ valid: boolean; error?: string }>

// lib/services/bom-alternatives-service.ts
export async function getAlternatives(bomItemId: string): Promise<BOMAlternative[]>

export async function createAlternative(
  bomItemId: string,
  data: CreateAlternativeRequest
): Promise<BOMAlternative>

export async function updateAlternative(
  altId: string,
  data: UpdateAlternativeRequest
): Promise<BOMAlternative>

export async function deleteAlternative(altId: string): Promise<void>

export async function getNextPreferenceOrder(bomItemId: string): Promise<number>

export async function validateAlternativeRules(
  primaryItem: BOMItem,
  alternativeProductId: string,
  excludeAltId?: string
): Promise<{ valid: boolean; error?: string; warning?: string }>
```

### Validation (Zod)

```typescript
const cloneBOMSchema = z.object({
  target_product_id: z.string().uuid("Select target product"),
  effective_from: z.string()
    .refine((val) => !isNaN(Date.parse(val)), "Invalid date")
    .refine((val) => new Date(val) >= new Date(new Date().toDateString()),
            "Effective date cannot be in the past"),
  effective_to: z.string()
    .refine((val) => !val || !isNaN(Date.parse(val)), "Invalid date")
    .nullable()
    .optional(),
  status: z.enum(['draft', 'active']).default('draft'),
  notes: z.string().max(2000).optional(),
}).refine((data) => {
  if (data.effective_to && data.effective_from) {
    return new Date(data.effective_to) >= new Date(data.effective_from);
  }
  return true;
}, {
  message: "Effective To must be after Effective From",
  path: ["effective_to"],
});

const createAlternativeSchema = z.object({
  alternative_product_id: z.string().uuid("Alternative component is required"),
  quantity: z.number()
    .positive("Quantity must be greater than 0")
    .refine(val => {
      const decimals = (val.toString().split('.')[1] || '').length;
      return decimals <= 6;
    }, "Maximum 6 decimal places allowed"),
  uom: z.string().min(1, "Unit of measure is required"),
  preference_order: z.number()
    .int("Preference must be a whole number")
    .min(2, "Preference must be 2 or higher (1 is reserved for primary)")
    .optional(),
  notes: z.string().max(500).nullable().optional(),
});
```

### Key Business Rules

1. **Clone creates draft**: New BOM always starts as draft regardless of source status
2. **Clone date default**: effective_from defaults to today
3. **Version auto-increment**: Next available version for target product
4. **MVP clone scope**: Items only, no alternatives or byproducts copied
5. **Alternative same type**: Must match primary item product type
6. **Preference >= 2**: Primary item is always preference 1
7. **No duplicates**: Same alternative cannot be added twice to an item
8. **Circular prevention**: BOM product cannot be its own component

## Deliverables

- API route: POST /api/technical/boms/:id/clone
- API routes: CRUD /api/technical/boms/:id/items/:itemId/alternatives
- BOMCloneModal component with target product selector
- BOMAlternativeModal with validation feedback
- AlternativeRow component for sub-row display
- bom-clone-service.ts with transaction handling
- bom-alternatives-service.ts with validation rules
- Circular reference validation in BOM items creation
- Alternative substitution rules validation
- Zod validation schemas
- Integration tests for clone and alternatives APIs
- Unit tests for services (>80% coverage)

## Definition of Done

- [ ] Clone BOM to same product creates new version with items copied
- [ ] Clone BOM to different product creates v1 for new product
- [ ] Clone copies: items, routing_id, notes
- [ ] Clone modal shows version preview (next available)
- [ ] Clone validates target date overlap before creating
- [ ] Circular reference prevented (BOM product cannot be its own component)
- [ ] Alternative preference_order enforced >= 2
- [ ] Alternative same-type validation enforced
- [ ] Duplicate alternative prevented per item
- [ ] UoM class mismatch shows warning (not error)
- [ ] Alternatives display in sub-row with preference order
- [ ] Clone button visible in list row actions and detail header
- [ ] Permission checks hide clone/alternative actions for read-only users
- [ ] All API endpoints have integration tests
- [ ] Unit tests cover services (>80% coverage)
- [ ] Success/error toasts display for all operations

---

## Future Phases (Not in MVP)

### Phase 1 (After 02.5b)
- **Clone with alternatives** - Copy all alternatives when cloning BOM
- **Clone with byproducts** - Copy byproducts when cloning BOM
- **Substitution ratio** - Different quantity for alternative (not 1:1)

### Phase 2
- **Bulk alternative import** - CSV import of alternatives
- **Alternative suggestion** - Auto-suggest alternatives based on product attributes

**Implementation**: See Epic 02.0 "Future Feature Handling" section.

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | Original | BOM Alternatives + Clone | - |
| 2.0 | 2025-12-16 | Added Priority header, MVP Scope section, Future Phases section, AC-11 placeholder guidance, clarified MVP clone scope (no alternatives/byproducts) | ARCHITECT-AGENT |
