# 02.6 - BOM Alternatives + Clone Functionality

**State:** ready
**Type:** backend + frontend
**Estimate:** M
**Primary PRD:** `docs/1-BASELINE/product/modules/technical.md` (FR-2.24, FR-2.30)
**UX Wireframes:** TEC-006 (BOM Modal), TEC-006a (BOM Items Detail)

## Goal

Implement BOM clone functionality for creating new BOM versions with all items, routing, and settings copied, and enhance the alternative ingredients system with preference ordering, substitution rules validation, and circular reference prevention.

## Scope

**In scope**
- POST /api/technical/boms/:id/clone (clone BOM to new product or new version)
- BOM clone modal with target product selection and version options
- Clone copies: all BOM items, alternatives, byproducts, routing assignment, notes
- Version auto-increment when cloning to same product
- Alternative ingredient preference ordering (priority 1=primary, 2+=fallbacks)
- Alternative ingredient substitution rules validation (same type, same UoM class)
- Circular reference prevention (cannot add BOM product as its own component)
- Clone action button in BOM list row actions and BOM detail header
- Alternative ingredients summary in BOM items view

**Out of scope**
- BOM version comparison/diff view (FR-2.25 - separate story)
- BOM scaling/batch size adjustment (deferred to FR-2.35)
- Multi-level BOM explosion (FR-2.29 - separate story)
- BOM cost calculation (covered separately)
- Import/export BOM to CSV (deferred)

## Dependencies
- **01.1** - Org Context + Base RLS (for multi-tenant isolation)
- **02.4** - BOMs CRUD (required for BOM header exists)
- **02.5** - BOM Items Management (required for items to clone)
- **02.7** - Routings CRUD (required for routing_id reference)

## Acceptance Criteria (Given/When/Then)

### BOM Clone Functionality (FR-2.24)

#### Clone to New Version (Same Product)
- GIVEN user clicks "Clone" on BOM v1 for FG-001, WHEN clone modal opens with "Same Product" selected, THEN version field shows "v2" (auto-increment).
- GIVEN BOM v1 has 5 items with alternatives, WHEN clone completed, THEN new BOM v2 created with all 5 items and their alternatives copied.
- GIVEN BOM v1 has routing_id assigned to RTG-BREAD-01, WHEN clone completed, THEN new BOM v2 has same routing_id.
- GIVEN BOM v1 has byproducts, WHEN clone completed, THEN byproducts copied to new BOM.
- GIVEN clone to same product, WHEN new BOM created, THEN status defaults to "draft" regardless of source status.
- GIVEN BOM v1 effective_from is "2024-01-01", WHEN clone completed, THEN new BOM effective_from defaults to today's date.

#### Clone to Different Product
- GIVEN user clicks "Clone" on BOM for FG-001, WHEN user selects "Different Product" and picks FG-002, THEN target product changes.
- GIVEN user clones to FG-002 which has no existing BOMs, WHEN clone completed, THEN new BOM version is v1.
- GIVEN user clones to FG-002 which has BOM v1, v2, WHEN clone completed, THEN new BOM version is v3.
- GIVEN source BOM has line_ids specific to Line 1, WHEN cloning to different product, THEN line_ids preserved (user may need to adjust).

#### Clone Validation
- GIVEN user attempts clone without selecting target (for different product mode), WHEN "Clone" clicked, THEN error "Select target product" displays.
- GIVEN user attempts clone and target product has overlapping date range, WHEN "Clone" clicked, THEN error "Effective date overlaps with existing BOM for target product".
- GIVEN clone in progress, WHEN server error occurs, THEN error toast "Clone failed: {reason}" displays and modal stays open.

#### Clone Success Flow
- GIVEN successful clone, WHEN operation completes, THEN success toast "BOM cloned successfully" displays.
- GIVEN successful clone, WHEN operation completes, THEN user redirected to new BOM detail page.
- GIVEN clone modal open, WHEN "Cancel" clicked, THEN modal closes without changes.

### Alternative Ingredients Enhancement (FR-2.30)

#### Preference Ordering
- GIVEN item has 3 alternatives, WHEN adding new alternative, THEN preference_order defaults to max(existing) + 1.
- GIVEN alternatives with orders 2, 3, 4, WHEN item selected in production, THEN system suggests alternatives in order: primary (1), then 2, 3, 4.
- GIVEN user edits alternative preference from 3 to 2, WHEN save completes, THEN alternatives reorder by new preference.
- GIVEN preference_order 1 entered for alternative, WHEN save attempted, THEN error "Preference must be 2 or higher (1 is reserved for primary)".

#### Substitution Rules Validation
- GIVEN primary item is type "RM" (Raw Material), WHEN adding alternative of type "ING" (Ingredient), THEN error "Alternative must be same product type as primary (Raw Material)".
- GIVEN primary item has base_uom "kg", WHEN adding alternative with base_uom "L", THEN warning "UoM class mismatch. Manual conversion may be required." (warning, not error).
- GIVEN primary item is RM-001, WHEN adding RM-001 as its own alternative, THEN error "Alternative cannot be same as primary component".
- GIVEN item already has RM-005 as alternative, WHEN adding RM-005 again, THEN error "Alternative already exists for this item".

#### Circular Reference Prevention
- GIVEN BOM is for product FG-001, WHEN user attempts to add FG-001 as a BOM item component, THEN error "Cannot add BOM product as its own component (circular reference)".
- GIVEN BOM item is WIP-001, WHEN user attempts to add WIP-001 as its own alternative, THEN error "Cannot add same product as alternative".
- GIVEN multi-level BOM where FG-001 uses WIP-001, WHEN creating BOM for WIP-001, THEN system allows (not circular at single level).

#### Alternatives Display
- GIVEN BOM item has 2 alternatives, WHEN items table renders, THEN sub-row shows "ALT: RM-005 Whole Wheat (48 kg) - Priority 2" and "ALT: RM-006 Rye Flour (52 kg) - Priority 3".
- GIVEN user clicks "Manage Alternatives" on item, WHEN modal opens, THEN all alternatives displayed with edit/delete actions.
- GIVEN alternative has notes, WHEN alternative row rendered, THEN notes displayed in tooltip or expandable section.

### Alternative CRUD Operations

#### Create Alternative
- GIVEN user clicks "+ Add Alternative" on BOM item, WHEN modal opens, THEN shows primary item info (code, name, qty, uom) and empty alternative form.
- GIVEN valid alternative data entered, WHEN "Add Alternative" clicked, THEN alternative saved and appears in item sub-row.
- GIVEN invalid alternative data (same product as primary), WHEN save attempted, THEN inline error displays without closing modal.

#### Edit Alternative
- GIVEN user clicks "Edit" on existing alternative, WHEN modal opens, THEN form pre-populated with alternative data.
- GIVEN user changes alternative quantity from 48 to 50, WHEN save completes, THEN updated quantity displays in sub-row.
- GIVEN user changes preference_order from 3 to 2, WHEN save completes, THEN alternatives reorder.

#### Delete Alternative
- GIVEN user clicks "Delete" on alternative, WHEN confirmation dialog accepted, THEN alternative removed from item.
- GIVEN alternative deleted, WHEN items table renders, THEN sub-row no longer shows that alternative.
- GIVEN primary item has 1 alternative and user deletes it, WHEN deletion completes, THEN item remains with no alternatives shown.

### UI Actions

#### Clone Button Locations
- GIVEN user viewing BOM list, WHEN row actions menu opened, THEN "Clone" action visible.
- GIVEN user viewing BOM detail page, WHEN header actions displayed, THEN "Clone" button visible next to "Edit".
- GIVEN user without write permission, WHEN actions displayed, THEN "Clone" button hidden.

#### Alternatives Button Location
- GIVEN BOM item displayed in items table, WHEN viewing item row, THEN "+ Add Alternative" link visible in sub-row area.
- GIVEN item has alternatives, WHEN viewing sub-row, THEN each alternative has "Edit" and "Delete" actions.

### Permission Enforcement
- GIVEN user with read-only permission, WHEN BOM detail page loaded, THEN "Clone" button hidden.
- GIVEN user with read-only permission, WHEN items table loaded, THEN "+ Add Alternative" links hidden.
- GIVEN user with write permission, WHEN clone modal opened, THEN can proceed with clone operation.

## Implementation Notes

### API Endpoints

```typescript
// POST /api/technical/boms/:id/clone
interface CloneBOMRequest {
  target_product_id: string;      // Same as source or different product
  effective_from: string;         // ISO date, defaults to today
  effective_to?: string | null;   // Optional
  status?: 'draft' | 'active';    // Default: 'draft'
  notes?: string;                 // Optional, can override
}

interface CloneBOMResponse {
  bom: {
    id: string;
    product_id: string;
    version: number;
    status: string;
    effective_from: string;
    effective_to: string | null;
    items_count: number;
    alternatives_count: number;
    byproducts_count: number;
  };
  message: string;
}

// GET /api/technical/boms/:id/items/:itemId/alternatives
interface AlternativesListResponse {
  alternatives: BOMAlternative[];
  primary_item: {
    id: string;
    product_code: string;
    product_name: string;
    product_type: string;
    quantity: number;
    uom: string;
  };
}

// POST /api/technical/boms/:id/items/:itemId/alternatives
interface CreateAlternativeRequest {
  alternative_product_id: string;
  quantity: number;
  uom: string;
  preference_order?: number;  // Auto-increment if not provided
  notes?: string | null;
}

// PUT /api/technical/boms/:id/items/:itemId/alternatives/:altId
interface UpdateAlternativeRequest {
  quantity?: number;
  uom?: string;
  preference_order?: number;
  notes?: string | null;
}

// DELETE /api/technical/boms/:id/items/:itemId/alternatives/:altId
// Returns success/error
```

### Database

#### Clone Operation (Transaction)
```sql
-- Clone BOM in a transaction
BEGIN;

-- 1. Create new BOM header
INSERT INTO boms (org_id, product_id, version, status, routing_id,
                  effective_from, effective_to, output_qty, output_uom,
                  units_per_box, boxes_per_pallet, notes, created_by)
SELECT org_id,
       :target_product_id,
       (SELECT COALESCE(MAX(version), 0) + 1 FROM boms WHERE product_id = :target_product_id AND org_id = :org_id),
       'draft',
       routing_id,
       :effective_from,
       :effective_to,
       output_qty,
       output_uom,
       units_per_box,
       boxes_per_pallet,
       :notes,
       :user_id
FROM boms WHERE id = :source_bom_id
RETURNING id AS new_bom_id;

-- 2. Clone BOM items
INSERT INTO bom_items (bom_id, product_id, quantity, uom, sequence,
                        operation_seq, scrap_percent, consume_whole_lp,
                        is_by_product, yield_percent, line_ids,
                        condition_flags, notes)
SELECT :new_bom_id, product_id, quantity, uom, sequence,
       operation_seq, scrap_percent, consume_whole_lp,
       is_by_product, yield_percent, line_ids,
       condition_flags, notes
FROM bom_items WHERE bom_id = :source_bom_id
RETURNING id AS new_item_id, (SELECT id FROM bom_items WHERE bom_id = :source_bom_id AND sequence = bom_items.sequence) AS old_item_id;

-- 3. Clone alternatives (map old item IDs to new item IDs)
INSERT INTO bom_alternatives (bom_item_id, org_id, alternative_product_id,
                               quantity, uom, preference_order, notes)
SELECT item_mapping.new_item_id, org_id, alternative_product_id,
       quantity, uom, preference_order, notes
FROM bom_alternatives ba
JOIN item_mapping ON item_mapping.old_item_id = ba.bom_item_id;

COMMIT;
```

#### bom_alternatives Table Constraints
```sql
-- Existing table, ensure constraints
ALTER TABLE bom_alternatives
ADD CONSTRAINT bom_alt_preference_order_check
CHECK (preference_order >= 2);

-- Unique alternative per item
ALTER TABLE bom_alternatives
ADD CONSTRAINT bom_alt_unique_per_item
UNIQUE (bom_item_id, alternative_product_id);
```

#### Circular Reference Check (Application Level)
```typescript
// In bom-items-service.ts
async function validateNoCircularReference(bomId: string, componentProductId: string): Promise<void> {
  const bom = await getBOM(bomId);
  if (bom.product_id === componentProductId) {
    throw new ValidationError("Cannot add BOM product as its own component (circular reference)");
  }
}

async function validateAlternativeRules(
  primaryItem: BOMItem,
  alternativeProductId: string
): Promise<void> {
  // Check not same as primary
  if (primaryItem.product_id === alternativeProductId) {
    throw new ValidationError("Alternative cannot be same as primary component");
  }

  // Check same product type
  const altProduct = await getProduct(alternativeProductId);
  if (altProduct.product_type !== primaryItem.product_type) {
    throw new ValidationError(
      `Alternative must be same product type as primary (${primaryItem.product_type})`
    );
  }

  // Check not duplicate
  const existingAlts = await getAlternatives(primaryItem.id);
  if (existingAlts.some(a => a.alternative_product_id === alternativeProductId)) {
    throw new ValidationError("Alternative already exists for this item");
  }
}
```

### Frontend Components

```
components/technical/bom/
  BOMCloneModal.tsx          -- Clone BOM modal with target selection
  BOMAlternativeModal.tsx    -- Add/Edit alternative modal (enhanced)
  BOMAlternativesManager.tsx -- Manage all alternatives for an item
  AlternativeRow.tsx         -- Single alternative sub-row display
```

### Services

```typescript
// lib/services/bom-clone-service.ts
export async function cloneBOM(
  sourceBomId: string,
  options: CloneBOMRequest
): Promise<CloneBOMResponse>

export async function getNextVersion(productId: string): Promise<number>

export async function validateCloneTarget(
  productId: string,
  effectiveFrom: string,
  effectiveTo: string | null
): Promise<{ valid: boolean; error?: string }>

// lib/services/bom-alternatives-service.ts
export async function getAlternatives(bomItemId: string): Promise<BOMAlternative[]>

export async function createAlternative(
  bomItemId: string,
  data: CreateAlternativeRequest
): Promise<BOMAlternative>

export async function updateAlternative(
  altId: string,
  data: UpdateAlternativeRequest
): Promise<BOMAlternative>

export async function deleteAlternative(altId: string): Promise<void>

export async function getNextPreferenceOrder(bomItemId: string): Promise<number>

export async function validateAlternativeRules(
  primaryItem: BOMItem,
  alternativeProductId: string,
  excludeAltId?: string
): Promise<{ valid: boolean; error?: string; warning?: string }>
```

### Validation (Zod)

```typescript
const cloneBOMSchema = z.object({
  target_product_id: z.string().uuid("Select target product"),
  effective_from: z.string()
    .refine((val) => !isNaN(Date.parse(val)), "Invalid date")
    .refine((val) => new Date(val) >= new Date(new Date().toDateString()),
            "Effective date cannot be in the past"),
  effective_to: z.string()
    .refine((val) => !val || !isNaN(Date.parse(val)), "Invalid date")
    .nullable()
    .optional(),
  status: z.enum(['draft', 'active']).default('draft'),
  notes: z.string().max(2000).optional(),
}).refine((data) => {
  if (data.effective_to && data.effective_from) {
    return new Date(data.effective_to) >= new Date(data.effective_from);
  }
  return true;
}, {
  message: "Effective To must be after Effective From",
  path: ["effective_to"],
});

const createAlternativeSchema = z.object({
  alternative_product_id: z.string().uuid("Alternative component is required"),
  quantity: z.number()
    .positive("Quantity must be greater than 0")
    .refine(val => {
      const decimals = (val.toString().split('.')[1] || '').length;
      return decimals <= 6;
    }, "Maximum 6 decimal places allowed"),
  uom: z.string().min(1, "Unit of measure is required"),
  preference_order: z.number()
    .int("Preference must be a whole number")
    .min(2, "Preference must be 2 or higher (1 is reserved for primary)")
    .optional(),
  notes: z.string().max(500).nullable().optional(),
});

const updateAlternativeSchema = createAlternativeSchema.partial();
```

## Deliverables
- API route: POST /api/technical/boms/:id/clone
- API routes: CRUD /api/technical/boms/:id/items/:itemId/alternatives
- BOMCloneModal component with target product selector
- Enhanced BOMAlternativeModal with validation feedback
- AlternativeRow component for sub-row display
- bom-clone-service.ts with transaction handling
- bom-alternatives-service.ts with validation rules
- Circular reference validation in BOM items creation
- Alternative substitution rules validation
- Zod validation schemas
- Integration tests for clone and alternatives APIs
- Unit tests for services (>80% coverage)

## Definition of Done
- [ ] Clone BOM to same product creates new version with all items copied
- [ ] Clone BOM to different product creates v1 for new product
- [ ] Clone copies: items, alternatives, byproducts, routing_id, notes
- [ ] Clone modal shows version preview (next available)
- [ ] Clone validates target date overlap before creating
- [ ] Circular reference prevented (BOM product cannot be its own component)
- [ ] Alternative preference_order enforced >= 2
- [ ] Alternative same-type validation enforced
- [ ] Duplicate alternative prevented per item
- [ ] UoM class mismatch shows warning (not error)
- [ ] Alternatives display in sub-row with preference order
- [ ] Clone button visible in list row actions and detail header
- [ ] Permission checks hide clone/alternative actions for read-only users
- [ ] All API endpoints have integration tests
- [ ] Unit tests cover services (>80% coverage)
- [ ] Success/error toasts display for all operations
