# 02.10 - Traceability + Lot Tracking Setup

**State:** ready
**Type:** backend + frontend
**Estimate:** M
**Primary PRD:** `docs/1-BASELINE/product/modules/technical.md` (FR-2.60, FR-2.61, FR-2.62, FR-2.63, FR-2.64, FR-2.65)
**UX Wireframes:** TEC-016 (Traceability Search), TEC-014 (Shelf Life Config - lot tracking aspects)

## Goal
Implement traceability configuration for products including lot number format setup per product, batch size defaults, traceability level selection (lot/batch/serial), expiry date rules, and GS1 compliance settings for lot encoding. Enable forward/backward traceability queries and recall simulation capabilities.

## Scope

**In scope**
- Lot number format configuration per product (prefix, pattern, auto-increment)
- Batch size defaults per product (standard batch, minimum batch, maximum batch)
- Traceability level selection: lot, batch, or serial per product
- Expiry date calculation rules (fixed days, rolling from ingredients, manual)
- GS1-128 lot encoding settings (AI 10 for lot, AI 17 for expiry)
- Forward traceability API (where-used query)
- Backward traceability API (what-consumed query)
- Recall simulation API with impact assessment
- Genealogy tree data structure for lot relationships
- Traceability matrix report generation
- Traceability search page with list/tree/matrix views
- Lot configuration modal for product-level settings

**Out of scope**
- Actual lot creation during production (Production module Story 04.x)
- Inventory lot management (Warehouse module Story 05.x)
- Real-time genealogy tree D3.js visualization (frontend enhancement phase)
- Customer notification generation (Shipping module)
- FDA report XML export (regulatory compliance phase)
- Cross-contamination tracking (FR-2.67 - Future)
- Ingredient origin tracking (FR-2.66 - Future)

## Dependencies
- **01.1** - Org Context + Base RLS (for multi-tenant isolation)
- **02.1** - Products CRUD (required for product_id references and product-level config)
- **05.x** - License Plate structure (Warehouse module - required for lot genealogy tables)

## Acceptance Criteria (Given/When/Then)

### Lot Number Format Configuration
- GIVEN a user editing product lot settings, WHEN they configure lot format as "LOT-{YYYY}-{SEQ:6}", THEN the pattern is saved and validated for correct placeholders.
- GIVEN a product with lot format configured, WHEN a new lot is created, THEN the system generates a lot number matching the format (e.g., LOT-2025-000001).
- GIVEN a user configuring lot format, WHEN they enter an invalid placeholder (e.g., {INVALID}), THEN validation error is displayed.
- GIVEN multiple products, WHEN each has a unique lot format prefix, THEN lot numbers remain unique within the organization.

### Batch Size Defaults
- GIVEN a user setting batch defaults, WHEN they enter standard_batch_size=1000, min_batch=500, max_batch=2000, THEN values are validated (min <= standard <= max).
- GIVEN batch defaults configured, WHEN a work order is created for that product, THEN batch size defaults are pre-populated.
- GIVEN min_batch > max_batch, WHEN user attempts to save, THEN validation error prevents save.

### Traceability Level Selection
- GIVEN a user configuring traceability, WHEN they select "lot" level, THEN product tracks at lot granularity (multiple units per lot).
- GIVEN a user configuring traceability, WHEN they select "batch" level, THEN product tracks at batch granularity (production run based).
- GIVEN a user configuring traceability, WHEN they select "serial" level, THEN product tracks at unit level (1 unit = 1 serial number).
- GIVEN product type is "FG" (finished goods), WHEN traceability is not configured, THEN default to "lot" level with warning.

### Expiry Date Rules
- GIVEN expiry_calculation_method = "fixed_days", WHEN a lot is created, THEN expiry_date = production_date + shelf_life_days.
- GIVEN expiry_calculation_method = "rolling", WHEN a lot is created, THEN expiry_date = earliest_ingredient_expiry - processing_buffer_days.
- GIVEN expiry_calculation_method = "manual", WHEN a lot is created, THEN user must manually enter expiry date.
- GIVEN a product with shelf_life_days = 30, WHEN a lot is produced on 2025-01-15, THEN expiry_date = 2025-02-14.

### GS1 Compliance Settings
- GIVEN GS1 lot encoding enabled, WHEN lot label is generated, THEN Application Identifier 10 (lot number) is included in GS1-128 barcode.
- GIVEN GS1 expiry encoding enabled, WHEN label is generated, THEN Application Identifier 17 (expiry date YYMMDD format) is included.
- GIVEN lot number exceeds 20 characters, WHEN GS1 encoding is attempted, THEN warning is displayed (GS1 AI 10 max length).
- GIVEN expiry date format mismatch, WHEN GS1 barcode is generated, THEN date is converted to YYMMDD format automatically.

### Forward Traceability (Where-Used)
- GIVEN lot LP-001 was consumed in WO-100 which produced LP-002, WHEN forward trace is run on LP-001, THEN LP-002 appears as descendant at depth 1.
- GIVEN LP-002 was then consumed in WO-200 producing LP-003, WHEN forward trace on LP-001 with max_depth=5, THEN LP-002 (depth 1) and LP-003 (depth 2) are returned.
- GIVEN a lot was shipped to customer ABC, WHEN forward trace runs, THEN shipment info (SO number, customer, ship date) appears as leaf node.
- GIVEN max_depth=2, WHEN tree has 5 levels, THEN only levels 0-2 are returned (performance optimization).

### Backward Traceability (What-Consumed)
- GIVEN finished lot LP-100 was produced from RM lots LP-001, LP-002, LP-003, WHEN backward trace runs on LP-100, THEN all three RM lots appear as ancestors.
- GIVEN LP-001 came from PO-500 (supplier lot), WHEN backward trace runs with max_depth=3, THEN supplier lot info is included.
- GIVEN multi-level BOM, WHEN backward trace runs, THEN all ingredient lots from all BOM levels are traced.

### Recall Simulation
- GIVEN lot LP-001 has 50 descendants across 3 levels, WHEN recall simulation runs, THEN summary shows: 50 affected LPs, total quantity, estimated value.
- GIVEN some descendants are shipped to customers, WHEN recall runs, THEN affected customers list includes: customer name, shipped qty, ship date.
- GIVEN affected inventory in warehouse, WHEN recall runs, THEN location analysis shows: warehouse, zone, LP count, quantity.
- GIVEN recall simulation completes, WHEN financial impact calculated, THEN shows: product value, retrieval cost (estimate), disposal cost (estimate), total impact.
- GIVEN recall simulation runs, WHEN executed, THEN execution_time_ms is logged and displayed (performance metric).

### Genealogy Tree
- GIVEN parent-child relationships exist, WHEN genealogy tree is requested, THEN hierarchical structure is returned with: lp_id, product_code, product_name, quantity, status, depth, children[].
- GIVEN a lot has multiple parents (combined lots), WHEN tree is generated, THEN relationship_type = "combine" is indicated.
- GIVEN a lot was split into multiple children, WHEN tree is generated, THEN relationship_type = "split" is indicated.

### Traceability Matrix Report
- GIVEN a traceability search completed, WHEN matrix view selected, THEN tabular format shows: Lot ID, Product, Batch, Mfg Date, Consumed In, Produced From.
- GIVEN matrix data exists, WHEN CSV export clicked, THEN CSV file downloads with all columns and rows.
- GIVEN large dataset (1000+ rows), WHEN matrix is displayed, THEN virtual scrolling is used for performance.

### Multi-tenancy
- GIVEN User A from Org A, WHEN they search traceability, THEN only Org A lots are included in results.
- GIVEN User A attempts to trace Lot X from Org B, WHEN API is called, THEN 404 Not Found is returned.

## Implementation Notes

### API Endpoints

```
# Traceability Configuration
GET    /api/technical/traceability/products/:id/config    - Get lot/batch config for product
PUT    /api/technical/traceability/products/:id/config    - Update lot/batch config

# Traceability Queries
POST   /api/technical/tracing/forward                      - Forward trace (where used)
POST   /api/technical/tracing/backward                     - Backward trace (what consumed)
POST   /api/technical/tracing/recall                       - Recall simulation
GET    /api/technical/tracing/genealogy/:lotId             - Get genealogy tree for lot
GET    /api/technical/tracing/recall/:id/export            - Export recall simulation report
GET    /api/technical/tracing/matrix/:lotId/export         - Export traceability matrix
```

**Request/Response Schemas:**

```typescript
// Traceability Config
interface TraceabilityConfig {
  product_id: string;
  lot_number_format: string;           // e.g., "LOT-{YYYY}-{SEQ:6}"
  lot_number_prefix: string;           // e.g., "LOT-"
  lot_number_sequence_length: number;  // e.g., 6
  traceability_level: 'lot' | 'batch' | 'serial';
  standard_batch_size: number;
  min_batch_size: number;
  max_batch_size: number;
  expiry_calculation_method: 'fixed_days' | 'rolling' | 'manual';
  processing_buffer_days: number;      // for rolling expiry
  gs1_lot_encoding_enabled: boolean;
  gs1_expiry_encoding_enabled: boolean;
  gs1_sscc_enabled: boolean;
  updated_at: Date;
  updated_by: string;
}

// Forward/Backward Trace Request
interface TraceRequest {
  lp_id?: string;
  batch_number?: string;
  max_depth?: number;        // default 20
  include_shipped?: boolean; // default true
  include_consumed?: boolean;// default true
}

// Trace Result
interface TraceResult {
  root_lp: LicensePlate;
  trace_tree: TraceNode[];
  summary: TraceSummary;
}

interface TraceNode {
  lp: LicensePlate;
  product_code: string;
  product_name: string;
  quantity: number;
  uom: string;
  status: 'available' | 'in_production' | 'shipped' | 'consumed' | 'quarantine';
  relationship_type: 'split' | 'combine' | 'transform' | null;
  work_order_id: string | null;
  children: TraceNode[];
  depth: number;
}

interface TraceSummary {
  total_descendants?: number;
  total_ancestors?: number;
  total_work_orders: number;
  total_customers?: number;
  max_depth: number;
}

// Recall Simulation
interface RecallSimulationResult {
  simulation_id: string;
  root_lp: LicensePlate;
  forward_trace: TraceNode[];
  backward_trace: TraceNode[];
  summary: {
    total_affected_lps: number;
    total_quantity: number;
    total_estimated_value: number;
    status_breakdown: Record<string, number>;
    affected_warehouses: number;
    affected_customers: number;
  };
  locations: {
    warehouse_id: string;
    warehouse_name: string;
    affected_lps: number;
    total_quantity: number;
    zones: string[];
  }[];
  customers: {
    customer_id: string;
    customer_name: string;
    contact_email: string | null;
    shipped_quantity: number;
    ship_date: string;
  }[];
  financial: {
    product_value: number;
    retrieval_cost: number;
    disposal_cost: number;
    total_estimated_cost: number;
  };
  execution_time_ms: number;
  created_at: string;
}
```

### Database

**Tables Used:**
- `products` - Product table with traceability config fields
- `product_traceability_config` - Extended traceability configuration (new table)
- `license_plates` - Lot/batch/serial tracking (Warehouse module)
- `lp_genealogy` - Parent-child lot relationships (existing)
- `traceability_links` - Consumption records with quantities
- `recall_simulations` - Stored recall simulation results

**New Table: product_traceability_config**
```sql
CREATE TABLE product_traceability_config (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES orgs(id),
  product_id UUID NOT NULL REFERENCES products(id) UNIQUE,
  lot_number_format TEXT NOT NULL DEFAULT 'LOT-{YYYY}-{SEQ:6}',
  lot_number_prefix TEXT NOT NULL DEFAULT 'LOT-',
  lot_number_sequence_length INTEGER NOT NULL DEFAULT 6,
  traceability_level TEXT NOT NULL DEFAULT 'lot' CHECK (traceability_level IN ('lot', 'batch', 'serial')),
  standard_batch_size DECIMAL(15,4),
  min_batch_size DECIMAL(15,4),
  max_batch_size DECIMAL(15,4),
  expiry_calculation_method TEXT NOT NULL DEFAULT 'fixed_days' CHECK (expiry_calculation_method IN ('fixed_days', 'rolling', 'manual')),
  processing_buffer_days INTEGER DEFAULT 0,
  gs1_lot_encoding_enabled BOOLEAN NOT NULL DEFAULT true,
  gs1_expiry_encoding_enabled BOOLEAN NOT NULL DEFAULT true,
  gs1_sscc_enabled BOOLEAN NOT NULL DEFAULT false,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  created_by UUID REFERENCES users(id),
  updated_by UUID REFERENCES users(id),
  CONSTRAINT batch_size_check CHECK (
    min_batch_size IS NULL OR max_batch_size IS NULL OR min_batch_size <= max_batch_size
  ),
  CONSTRAINT standard_batch_check CHECK (
    standard_batch_size IS NULL OR
    (min_batch_size IS NULL OR standard_batch_size >= min_batch_size) AND
    (max_batch_size IS NULL OR standard_batch_size <= max_batch_size)
  )
);

-- RLS Policy
CREATE POLICY "product_traceability_config_org_isolation" ON product_traceability_config
FOR ALL USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));
```

**Recursive CTE for Forward Trace:**
```sql
-- Forward trace: Find all descendants of a lot
WITH RECURSIVE trace AS (
  -- Base case: root LP
  SELECT
    id, lp_number, product_id, quantity, uom, status,
    0 AS depth, ARRAY[id] AS path
  FROM license_plates
  WHERE id = p_lp_id AND org_id = p_org_id

  UNION ALL

  -- Recursive case: children
  SELECT
    lp.id, lp.lp_number, lp.product_id, lp.quantity, lp.uom, lp.status,
    t.depth + 1, t.path || lp.id
  FROM license_plates lp
  JOIN lp_genealogy g ON g.child_lp_id = lp.id
  JOIN trace t ON t.id = g.parent_lp_id
  WHERE t.depth < p_max_depth
    AND NOT lp.id = ANY(t.path)  -- Prevent cycles
)
SELECT * FROM trace ORDER BY depth, lp_number;
```

### Frontend Components

**Pages:**
- `app/(authenticated)/technical/traceability/page.tsx` - Traceability search page

**Components:**
- `components/technical/traceability/TraceabilitySearch.tsx` - Search form with direction toggle
- `components/technical/traceability/TraceResultsList.tsx` - List view of trace results
- `components/technical/traceability/TraceResultsTree.tsx` - Tree view (D3.js or React Flow)
- `components/technical/traceability/TraceResultsMatrix.tsx` - Matrix/table view
- `components/technical/traceability/RecallSimulationPanel.tsx` - Recall results display
- `components/technical/traceability/LotConfigModal.tsx` - Product lot configuration modal
- `components/technical/traceability/GenealogyTree.tsx` - Tree visualization component
- `components/technical/products/TraceabilityConfigSection.tsx` - Product form section

### Services

**Traceability Service:** `lib/services/traceability-service.ts`
```typescript
interface TraceabilityService {
  getProductConfig(productId: string): Promise<TraceabilityConfig | null>;
  updateProductConfig(productId: string, config: Partial<TraceabilityConfig>): Promise<TraceabilityConfig>;

  // Trace operations
  traceForward(request: TraceRequest): Promise<TraceResult>;
  traceBackward(request: TraceRequest): Promise<TraceResult>;
  runRecallSimulation(request: TraceRequest): Promise<RecallSimulationResult>;

  // Genealogy
  getGenealogyTree(lotId: string, maxDepth?: number): Promise<TraceNode[]>;

  // Lot number generation
  generateLotNumber(productId: string): Promise<string>;
  validateLotFormat(format: string): boolean;

  // Export
  exportMatrix(lotId: string, format: 'csv' | 'excel' | 'pdf'): Promise<Blob>;
  exportRecallReport(simulationId: string, format: 'pdf' | 'json' | 'xml'): Promise<Blob>;
}
```

**GS1 Service:** `lib/services/gs1-service.ts`
```typescript
interface GS1Service {
  encodeLotNumber(lotNumber: string): string;         // AI 10
  encodeExpiryDate(expiryDate: Date): string;         // AI 17 (YYMMDD)
  encodeSSCC(sscc: string): string;                   // AI 00
  generateGS1128Barcode(data: GS1Data): string;       // Full GS1-128 barcode
  validateGTIN14(gtin: string): boolean;
  calculateCheckDigit(gtin: string): number;
}
```

### Validation Schemas

**Location:** `lib/validation/traceability.ts`

```typescript
const traceabilityConfigSchema = z.object({
  lot_number_format: z.string()
    .min(5)
    .max(50)
    .regex(/^[A-Z0-9\-{}\:]+$/, "Invalid format. Use uppercase, numbers, hyphens, and placeholders like {YYYY}, {SEQ:6}"),
  lot_number_prefix: z.string().min(1).max(20),
  lot_number_sequence_length: z.number().int().min(4).max(10),
  traceability_level: z.enum(['lot', 'batch', 'serial']),
  standard_batch_size: z.number().positive().optional().nullable(),
  min_batch_size: z.number().positive().optional().nullable(),
  max_batch_size: z.number().positive().optional().nullable(),
  expiry_calculation_method: z.enum(['fixed_days', 'rolling', 'manual']),
  processing_buffer_days: z.number().int().min(0).max(365).default(0),
  gs1_lot_encoding_enabled: z.boolean().default(true),
  gs1_expiry_encoding_enabled: z.boolean().default(true),
  gs1_sscc_enabled: z.boolean().default(false),
}).refine(data => {
  if (data.min_batch_size && data.max_batch_size) {
    return data.min_batch_size <= data.max_batch_size;
  }
  return true;
}, { message: "Minimum batch size cannot exceed maximum batch size" })
.refine(data => {
  if (data.standard_batch_size && data.min_batch_size) {
    return data.standard_batch_size >= data.min_batch_size;
  }
  return true;
}, { message: "Standard batch size must be >= minimum" })
.refine(data => {
  if (data.standard_batch_size && data.max_batch_size) {
    return data.standard_batch_size <= data.max_batch_size;
  }
  return true;
}, { message: "Standard batch size must be <= maximum" });

const traceSearchSchema = z.object({
  lp_id: z.string().uuid().optional(),
  batch_number: z.string().min(3).optional(),
  max_depth: z.number().int().min(1).max(50).default(20),
  include_shipped: z.boolean().default(true),
  include_consumed: z.boolean().default(true),
}).refine(data => data.lp_id || data.batch_number, {
  message: "Either lp_id or batch_number must be provided"
});
```

### Lot Number Format Placeholders

| Placeholder | Description | Example |
|-------------|-------------|---------|
| `{YYYY}` | 4-digit year | 2025 |
| `{YY}` | 2-digit year | 25 |
| `{MM}` | 2-digit month | 01-12 |
| `{DD}` | 2-digit day | 01-31 |
| `{SEQ:N}` | N-digit sequence | 000001 |
| `{JULIAN}` | Julian day (001-366) | 015 |
| `{PROD}` | Product code prefix | BRD |
| `{LINE}` | Production line code | L01 |

**Example Formats:**
- `LOT-{YYYY}-{SEQ:6}` -> LOT-2025-000001
- `{PROD}-{YYMMDD}-{SEQ:4}` -> BRD-250115-0001
- `{JULIAN}{YY}-{SEQ:5}` -> 01525-00001 (Julian day 15, year 25)

## Deliverables

- [ ] Database migration for product_traceability_config table
- [ ] Traceability config API endpoints (GET/PUT)
- [ ] Forward trace API endpoint with recursive CTE
- [ ] Backward trace API endpoint with recursive CTE
- [ ] Recall simulation API endpoint
- [ ] Genealogy tree API endpoint
- [ ] Traceability service (`lib/services/traceability-service.ts`)
- [ ] GS1 encoding service (`lib/services/gs1-service.ts`)
- [ ] Zod validation schemas (`lib/validation/traceability.ts`)
- [ ] Traceability search page (`/technical/traceability`)
- [ ] TraceabilitySearch component with direction toggle
- [ ] TraceResultsList component (list view)
- [ ] TraceResultsMatrix component (matrix view)
- [ ] RecallSimulationPanel component
- [ ] LotConfigModal component for product settings
- [ ] CSV/Excel export for traceability matrix
- [ ] PDF export for recall simulation report
- [ ] RLS policies for all traceability tables
- [ ] Unit tests for traceability service (coverage >= 80%)
- [ ] Integration tests for trace APIs
- [ ] Performance tests for large genealogy trees (1000+ nodes)

## Definition of Done

- [ ] Lot number format configuration saves and validates correctly
- [ ] Batch size constraints enforced (min <= standard <= max)
- [ ] Traceability level selection persists per product
- [ ] Expiry calculation methods work correctly (fixed, rolling, manual)
- [ ] GS1-128 AI 10 (lot) encoding generates valid barcodes
- [ ] GS1-128 AI 17 (expiry) encoding uses YYMMDD format
- [ ] Forward trace returns correct descendants with depth levels
- [ ] Backward trace returns correct ancestors
- [ ] Recall simulation calculates affected inventory, customers, financial impact
- [ ] Genealogy tree prevents cycles (path tracking)
- [ ] Max depth parameter limits recursion (performance)
- [ ] List view displays trace results with pagination
- [ ] Matrix view displays tabular format with export
- [ ] CSV export downloads with all columns
- [ ] RLS enforces org isolation on all queries
- [ ] Cross-tenant trace attempts return 404
- [ ] Trace query completes in <3s for 100 levels/1000 nodes
- [ ] Recall simulation completes in <5s for typical datasets
- [ ] Unit tests pass with >= 80% coverage
- [ ] Integration tests cover all trace scenarios
- [ ] Loading states displayed during trace operations
- [ ] Error states handled with retry option
- [ ] Empty state shown when no trace results
- [ ] Toast notifications on success/error
- [ ] Accessibility: keyboard navigation, ARIA labels for tree view
