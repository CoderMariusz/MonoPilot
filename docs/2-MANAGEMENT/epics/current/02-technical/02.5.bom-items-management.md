# 02.5 - BOM Items Management

**State:** ready
**Type:** full-stack
**Estimate:** L (largest story)
**Primary PRD:** `docs/1-BASELINE/product/modules/technical.md` (FR-2.21, FR-2.26, FR-2.27, FR-2.29, FR-2.31, FR-2.38, FR-2.39)
**UX Wireframes:** TEC-006 (BOM Modal), TEC-006a (BOM Items Detail), TEC-006c (BOM Explosion View)

## Goal

Implement complete BOM line items management including ingredients, quantities, operation assignment, conditional items, by-products, alternative ingredients, and multi-level BOM explosion. This is the core recipe definition functionality that determines what components make a finished product.

## Scope

**In scope**
- GET /api/technical/boms/:id/items (list all items for a BOM)
- POST /api/technical/boms/:id/items (add item to BOM)
- PUT /api/technical/boms/:id/items/:itemId (update item)
- DELETE /api/technical/boms/:id/items/:itemId (remove item)
- POST /api/technical/boms/:id/items/bulk (bulk add from CSV/import)
- **POST /api/technical/boms/:id/explode (multi-level BOM explosion - FR-2.29)**
- BOM items table with inline sub-row display (alternatives, scrap%, flags)
- Add/Edit BOM item modal with validation
- Item fields: product_id, quantity, uom, sequence, operation_seq, scrap_percent
- Operation assignment dropdown (from assigned routing)
- Conditional items with flags (condition_flags JSONB)
- By-products management (is_output=true, yield_percent)
- Line-specific items (line_ids array - NULL = all lines)
- UoM validation trigger (warning if UoM doesn't match component base UoM)
- Quantity validation (must be > 0)
- Alternative ingredients CRUD (bom_alternatives table)
- **Multi-level BOM explosion with recursive traversal (FR-2.29)**

**Out of scope**
- BOM header CRUD (covered in 02.4)
- BOM cost calculation (covered in 02.6)
- BOM scaling/batch size adjustment (deferred)
- Drag-drop reordering of items (deferred - nice to have)

## Dependencies
- **01.1** - Org Context + Base RLS (for multi-tenant isolation)
- **02.4** - BOMs CRUD (required for BOM header exists)
- **02.1** - Products CRUD (required for product_id lookup)
- **02.7** - Routings CRUD (required for operation_seq assignment)
- **Migration 049** - UoM validation trigger and quantity check constraint (deployed)

## Acceptance Criteria (Given/When/Then)

### BOM Items List
- GIVEN user navigates to BOM detail `/technical/boms/:id`, WHEN items section loads, THEN BOM items display in sequence order within 500ms for up to 100 items.
- GIVEN BOM has 50 items, WHEN items table renders, THEN each row shows: sequence, component code+name, type badge (RM/ING/PKG), quantity, UoM, operation assignment, actions menu.
- GIVEN BOM item has alternatives, WHEN row renders, THEN sub-row displays alternatives with "ALT: {code} ({qty} {uom}) - Priority {order}".
- GIVEN BOM item has condition_flags, WHEN row renders, THEN sub-row displays "Flags: organic, vegan" etc.
- GIVEN BOM item has scrap_percent > 0, WHEN row renders, THEN sub-row displays "Scrap: 2.0%".

### Add BOM Item
- GIVEN user clicks "[+ Add Item]", WHEN modal opens, THEN form displays: component selector, quantity, sequence (auto-filled with max+10), scrap%, LP mode, operation assignment, line selection, conditional flags, notes.
- GIVEN user selects component RM-001 (base_uom: kg), WHEN quantity 50 entered with uom "kg", THEN validation passes.
- GIVEN user enters quantity 0 or negative, WHEN save attempted, THEN error "Quantity must be greater than 0" displays inline.
- GIVEN user selects component with base_uom "kg" but enters uom "L", WHEN save attempted, THEN warning "UoM does not match component base UoM (kg). Unit conversion required." displays but save proceeds (warning, not error).
- GIVEN valid item data with operation_seq=10, WHEN "Save Item" clicked, THEN item created, modal closes, items table refreshes, success toast shows.
- GIVEN user clicks "Save & Add Another", WHEN save completes, THEN modal stays open with cleared form (except sequence incremented).

### Edit BOM Item
- GIVEN user clicks "Edit" on existing item, WHEN modal opens, THEN form pre-populates with current item data.
- GIVEN user changes quantity from 50 to 75, WHEN save completes, THEN updated quantity displays immediately in items table.
- GIVEN user assigns operation_seq from "None" to "Op 1: Mixing", WHEN save completes, THEN operation column shows "Op 1: Mixing".

### Delete BOM Item
- GIVEN user clicks "Delete" on item, WHEN confirmation dialog accepted, THEN item removed from table within 500ms.
- GIVEN item has alternatives, WHEN item deleted, THEN all alternatives also deleted (cascade).
- GIVEN user cancels delete confirmation, WHEN dialog dismissed, THEN item remains unchanged.

### Operation Assignment (FR-2.31)
- GIVEN BOM has routing_id assigned, WHEN adding/editing item, THEN operation dropdown shows all operations from routing ("Op 1: Mixing", "Op 2: Proofing", etc.).
- GIVEN BOM has no routing assigned, WHEN adding/editing item, THEN operation dropdown disabled with message "Assign routing to BOM first".
- GIVEN item assigned to operation_seq=10, WHEN that operation displays, THEN operation name shows (e.g., "Op 10: Mixing").
- GIVEN operation assigned, WHEN item saved, THEN BOM item linked to that routing operation for production consumption tracking.

### Conditional Items (FR-2.26)
- GIVEN user opens item modal, WHEN conditional flags section shown, THEN multi-select dropdown displays available flags (organic, vegan, gluten-free, kosher, halal).
- GIVEN user selects flags [organic, vegan] for item, WHEN save completes, THEN condition_flags JSONB stores {"organic": true, "vegan": true}.
- GIVEN item has conditional flags, WHEN BOM used in WO for organic product, THEN conditional item included.
- GIVEN item has conditional flags, WHEN BOM used in WO for non-organic product, THEN conditional item excluded (business logic in production module).

### By-products (FR-2.27)
- GIVEN user clicks "[+ Add Byproduct]", WHEN modal opens, THEN byproduct form displays: product selector (BP type only), quantity, uom, yield_percent (auto-calculated), notes.
- GIVEN user enters byproduct quantity 2 kg for BOM output 100 kg, WHEN yield_percent calculated, THEN displays "2.0% (2 kg / 100 kg)".
- GIVEN byproduct saved, WHEN items table renders, THEN byproduct appears in separate "Byproducts" section with is_output=true.
- GIVEN byproduct deleted, WHEN confirmation accepted, THEN byproduct removed from table.

### Line-Specific Items (FR-2.33)
- GIVEN user opens item modal, WHEN production lines section shown, THEN checkbox group displays all production lines.
- GIVEN user selects no lines (empty), WHEN save completes, THEN line_ids = NULL (available on all lines).
- GIVEN user selects "Line 2 - Pastry Production" only, WHEN save completes, THEN line_ids = ["line-2-uuid"].
- GIVEN item has line_ids = ["line-2-uuid"], WHEN WO created for Line 1, THEN item NOT included in WO BOM snapshot.

### Alternative Ingredients (FR-2.30)
- GIVEN user clicks "[+ Add Alternative]" on item row, WHEN modal opens, THEN form shows primary item info and alternative fields.
- GIVEN user selects alternative component, WHEN alternative type doesn't match primary type (e.g., RM vs ING), THEN error "Alternative must be same product type".
- GIVEN valid alternative (same type, different product), WHEN preference_order=2 entered, THEN alternative saved and displays in sub-row.
- GIVEN item has multiple alternatives, WHEN alternatives rendered, THEN sorted by preference_order (2, 3, 4...).
- GIVEN user deletes alternative, WHEN confirmation accepted, THEN alternative removed but primary item unchanged.

### UoM Validation (FR-2.38)
- GIVEN component RM-001 has base_uom "kg", WHEN user enters "kg" for item UoM, THEN no warning shown.
- GIVEN component RM-001 has base_uom "kg", WHEN user enters "L" for item UoM, THEN warning banner shows "UoM mismatch: component base UoM is 'kg', you entered 'L'. Server will validate."
- GIVEN UoM mismatch warning shown, WHEN user proceeds with save, THEN server trigger logs WARNING (not error) and save succeeds.

### Quantity Validation (FR-2.39)
- GIVEN user enters quantity "50.123456", WHEN validation runs, THEN passes (6 decimal places allowed).
- GIVEN user enters quantity "50.1234567", WHEN validation runs, THEN error "Maximum 6 decimal places allowed".
- GIVEN user enters quantity "0", WHEN save attempted, THEN error "Quantity must be greater than 0".
- GIVEN user enters quantity "-5", WHEN save attempted, THEN error "Quantity must be greater than 0".

### Multi-Level BOM Explosion (FR-2.29)
- GIVEN BOM for FG-001 contains WIP-001 (which has its own BOM), WHEN user clicks "[Explode BOM]", THEN explosion view displays all levels with proper indentation.
- GIVEN BOM with 3 levels deep (FG -> WIP -> RM), WHEN explosion requested, THEN all 3 levels display with correct parent-child relationships.
- GIVEN exploded view displayed, WHEN viewing Level 1 item WIP-001, THEN its sub-items (Level 2) appear indented below with tree connector lines.
- GIVEN explosion view, WHEN hovering over a sub-BOM item, THEN tooltip shows: "From BOM: WIP-001 v2 (Active)".
- GIVEN BOM with circular reference attempt (FG-001 contains WIP-001 which contains FG-001), WHEN explosion runs, THEN error "Circular reference detected: FG-001 -> WIP-001 -> FG-001" displayed and explosion stops.
- GIVEN explosion for 5-level deep BOM, WHEN performance measured, THEN completes within 2 seconds for up to 500 total items.
- GIVEN exploded view, WHEN user clicks "[Collapse All]", THEN only Level 0 (direct items) display.
- GIVEN exploded view, WHEN user clicks "[Expand All]", THEN all levels expand and display.
- GIVEN exploded view, WHEN viewing aggregated quantities, THEN items appearing multiple times show total aggregated quantity (e.g., "Flour: 50kg total (30kg in Dough + 20kg in Coating)").
- GIVEN explosion API called, WHEN max_depth parameter is 3, THEN explosion stops at level 3 even if deeper BOMs exist (with indicator "... deeper levels truncated").

### Sequence Management
- GIVEN BOM has items with sequences 10, 20, 30, WHEN new item added, THEN sequence defaults to 40 (max + 10).
- GIVEN user edits item sequence from 20 to 15, WHEN save completes, THEN items reorder in table by sequence.
- GIVEN duplicate sequence entered, WHEN save attempted, THEN warning "Duplicate sequence. Items may appear in unexpected order." (warning, not error).

### Permission Enforcement
- GIVEN user without technical write permission, WHEN BOM items page loaded, THEN "[+ Add Item]" button hidden, Edit/Delete actions hidden.
- GIVEN user with technical read-only permission, WHEN items displayed, THEN view-only mode (no edit controls).

## Implementation Notes

### API Endpoints

```typescript
// GET /api/technical/boms/:id/items
interface BOMItemsListResponse {
  items: BOMItem[];
  alternatives: BOMAlternative[];
  byproducts: BOMItem[]; // is_output=true items
}

// POST /api/technical/boms/:id/items
interface CreateBOMItemRequest {
  product_id: string;           // Required: FK to products
  quantity: number;             // Required: > 0, max 6 decimals
  uom: string;                  // Required: should match product base_uom
  sequence?: number;            // Optional: default max+10
  scrap_percent?: number;       // Optional: default 0, range 0-100
  consume_whole_lp?: boolean;   // Optional: default false
  operation_seq?: number | null;// Optional: FK to routing_operations.sequence
  line_ids?: string[] | null;   // Optional: null = all lines
  is_by_product?: boolean;      // Optional: default false
  yield_percent?: number;       // Required if is_by_product=true
  condition_flags?: object | null; // Optional: JSONB
  notes?: string | null;        // Optional: max 500 chars
}

// PUT /api/technical/boms/:id/items/:itemId
interface UpdateBOMItemRequest {
  // Same fields as create, all optional except id
}

// DELETE /api/technical/boms/:id/items/:itemId
// Cascades to delete alternatives

// POST /api/technical/boms/:id/items/:itemId/alternatives
interface CreateAlternativeRequest {
  alternative_product_id: string;
  quantity: number;
  uom: string;
  preference_order: number;  // >= 2 (1 is primary)
  notes?: string | null;
}

// DELETE /api/technical/boms/:id/items/:itemId/alternatives/:altId

// POST /api/technical/boms/:id/explode (FR-2.29)
interface BOMExplosionRequest {
  max_depth?: number;           // Optional: default 10, max 10
  include_inactive?: boolean;   // Optional: default false
  aggregate_quantities?: boolean; // Optional: default true
}

interface BOMExplosionResponse {
  bom: {
    id: string;
    product_code: string;
    product_name: string;
    version: number;
    output_qty: number;
    output_uom: string;
  };
  items: ExplodedBOMItem[];
  total_items: number;
  max_depth_reached: number;
  truncated: boolean;           // true if max_depth caused truncation
  circular_refs: string[];      // List of circular references detected
  aggregated_quantities?: AggregatedItem[]; // If aggregate_quantities=true
}

interface ExplodedBOMItem {
  id: string;
  level: number;                // 0 = direct item, 1 = sub-BOM item, etc.
  parent_item_id: string | null; // null for level 0
  path: string;                 // e.g., "FG-001 > WIP-001 > RM-001"
  product_id: string;
  product_code: string;
  product_name: string;
  product_type: string;
  quantity: number;             // Quantity at this level
  scaled_quantity: number;      // Quantity scaled to top-level BOM output
  uom: string;
  has_sub_bom: boolean;         // true if this item has its own BOM
  sub_bom_id: string | null;    // ID of sub-BOM if has_sub_bom
  sub_bom_version: number | null;
  sub_bom_status: string | null;
  is_truncated: boolean;        // true if this item's sub-BOM was truncated due to max_depth
}

interface AggregatedItem {
  product_id: string;
  product_code: string;
  product_name: string;
  total_quantity: number;
  uom: string;
  occurrences: number;          // How many times this item appears
  sources: string[];            // e.g., ["Dough (30kg)", "Coating (20kg)"]
}
```

### Database

#### bom_items table (existing)
```sql
bom_items: id, bom_id, product_id, operation_seq, is_output,
           quantity, uom, sequence, line_ids, scrap_percent,
           consume_whole_lp, is_by_product, yield_percent,
           condition_flags, notes, created_at, updated_at

-- Constraints (migration 049):
-- CHECK (quantity > 0) - enforced
-- Trigger: validate_bom_item_uom() - warns on mismatch
```

#### bom_alternatives table (existing)
```sql
bom_alternatives: id, bom_item_id, org_id, alternative_product_id,
                  quantity, uom, preference_order, notes, created_at
```

### BOM Explosion Query (FR-2.29)

```sql
-- Recursive CTE for multi-level BOM explosion
WITH RECURSIVE bom_explosion AS (
  -- Base case: direct items from the target BOM
  SELECT
    bi.id,
    0 AS level,
    NULL::uuid AS parent_item_id,
    p.code AS path,
    bi.product_id,
    p.code AS product_code,
    p.name AS product_name,
    pt.code AS product_type,
    bi.quantity,
    bi.quantity AS scaled_quantity,
    bi.uom,
    EXISTS (
      SELECT 1 FROM boms b2
      WHERE b2.product_id = bi.product_id
        AND b2.status = 'active'
        AND CURRENT_DATE BETWEEN b2.effective_from AND COALESCE(b2.effective_to, '9999-12-31')
    ) AS has_sub_bom,
    (
      SELECT b2.id FROM boms b2
      WHERE b2.product_id = bi.product_id
        AND b2.status = 'active'
        AND CURRENT_DATE BETWEEN b2.effective_from AND COALESCE(b2.effective_to, '9999-12-31')
      LIMIT 1
    ) AS sub_bom_id
  FROM bom_items bi
  JOIN products p ON p.id = bi.product_id
  JOIN product_types pt ON pt.id = p.product_type_id
  WHERE bi.bom_id = $1  -- Target BOM ID
    AND bi.is_output = false

  UNION ALL

  -- Recursive case: items from sub-BOMs
  SELECT
    bi.id,
    be.level + 1,
    be.id AS parent_item_id,
    be.path || ' > ' || p.code,
    bi.product_id,
    p.code,
    p.name,
    pt.code,
    bi.quantity,
    (be.scaled_quantity * bi.quantity / parent_bom.output_qty) AS scaled_quantity,
    bi.uom,
    EXISTS (...) AS has_sub_bom,
    (...) AS sub_bom_id
  FROM bom_explosion be
  JOIN boms parent_bom ON parent_bom.id = be.sub_bom_id
  JOIN bom_items bi ON bi.bom_id = parent_bom.id AND bi.is_output = false
  JOIN products p ON p.id = bi.product_id
  JOIN product_types pt ON pt.id = p.product_type_id
  WHERE be.has_sub_bom
    AND be.level < $2  -- max_depth parameter
    AND be.path NOT LIKE '%' || p.code || '%'  -- Circular reference prevention
)
SELECT * FROM bom_explosion ORDER BY level, path;
```

### Frontend Components

```
app/(authenticated)/technical/boms/[id]/page.tsx  -- BOM detail (uses existing)
components/technical/bom/
  BOMItemsTable.tsx        -- Items table with sub-rows
  BOMItemModal.tsx         -- Add/Edit item modal
  BOMByproductsSection.tsx -- Byproducts table
  BOMAlternativeModal.tsx  -- Add alternative modal
  BOMItemRow.tsx           -- Single item row with expandable sub-row
  BOMExplosionView.tsx     -- Multi-level explosion tree view (FR-2.29)
  BOMExplosionTree.tsx     -- Tree component with expand/collapse (FR-2.29)
  BOMExplosionItem.tsx     -- Individual item in explosion tree (FR-2.29)
  BOMExplosionAggregated.tsx -- Aggregated quantities summary (FR-2.29)
```

### Services

```typescript
// lib/services/bom-items-service.ts
export async function getBOMItems(bomId: string): Promise<BOMItemsListResponse>
export async function createBOMItem(bomId: string, data: CreateBOMItemRequest): Promise<BOMItem>
export async function updateBOMItem(bomId: string, itemId: string, data: UpdateBOMItemRequest): Promise<BOMItem>
export async function deleteBOMItem(bomId: string, itemId: string): Promise<void>
export async function bulkCreateBOMItems(bomId: string, items: CreateBOMItemRequest[]): Promise<BOMItem[]>
export async function createAlternative(bomId: string, itemId: string, data: CreateAlternativeRequest): Promise<BOMAlternative>
export async function deleteAlternative(bomId: string, itemId: string, altId: string): Promise<void>
export async function getNextSequence(bomId: string): Promise<number>

// FR-2.29: Multi-level explosion
export async function explodeBOM(bomId: string, options?: BOMExplosionRequest): Promise<BOMExplosionResponse>
export function detectCircularReferences(items: ExplodedBOMItem[]): string[]
export function aggregateQuantities(items: ExplodedBOMItem[]): AggregatedItem[]
```

### Validation (Zod)

```typescript
const bomItemSchema = z.object({
  product_id: z.string().uuid("Component is required"),
  quantity: z.number()
    .positive("Quantity must be greater than 0")
    .refine(val => {
      const decimals = (val.toString().split('.')[1] || '').length;
      return decimals <= 6;
    }, "Maximum 6 decimal places allowed"),
  uom: z.string().min(1, "Unit of measure is required"),
  sequence: z.number().int().min(0).optional().default(0),
  scrap_percent: z.number().min(0).max(100).optional().default(0),
  consume_whole_lp: z.boolean().optional().default(false),
  operation_seq: z.number().int().nullable().optional(),
  line_ids: z.array(z.string().uuid()).nullable().optional(),
  is_by_product: z.boolean().optional().default(false),
  yield_percent: z.number().min(0).max(100).nullable().optional(),
  condition_flags: z.record(z.boolean()).nullable().optional(),
  notes: z.string().max(500).nullable().optional(),
});

const bomAlternativeSchema = z.object({
  alternative_product_id: z.string().uuid("Alternative component is required"),
  quantity: z.number().positive("Quantity must be greater than 0"),
  uom: z.string().min(1, "Unit of measure is required"),
  preference_order: z.number().int().min(2, "Preference must be 2 or higher"),
  notes: z.string().nullable().optional(),
});

const bomExplosionRequestSchema = z.object({
  max_depth: z.number().int().min(1).max(10).optional().default(10),
  include_inactive: z.boolean().optional().default(false),
  aggregate_quantities: z.boolean().optional().default(true),
});
```

### Key Business Rules

1. **Quantity > 0**: Enforced by database constraint (migration 049)
2. **UoM match**: Trigger warns on mismatch but allows save (migration 049)
3. **Operation assignment**: operation_seq must exist in BOM's routing
4. **Byproducts**: is_output=true, yield_percent auto-calculated
5. **Line-specific**: NULL line_ids = all lines; specific IDs = restricted
6. **Alternatives**: Must be same product type as primary
7. **Sequence**: Auto-increment by 10, warn on duplicates
8. **Explosion depth**: Maximum 10 levels to prevent infinite recursion (FR-2.29)
9. **Circular reference**: Detect and prevent A -> B -> A patterns (FR-2.29)
10. **Scaled quantities**: Calculate quantities relative to top-level output (FR-2.29)

### Explosion Performance Optimization (FR-2.29)

```typescript
// Performance considerations for large BOMs
const EXPLOSION_LIMITS = {
  MAX_DEPTH: 10,
  MAX_ITEMS: 1000,
  TIMEOUT_MS: 5000,
};

// Use batch fetching for sub-BOMs
async function fetchSubBOMs(productIds: string[]): Promise<Map<string, BOM>> {
  const boms = await supabase
    .from('boms')
    .select('*')
    .in('product_id', productIds)
    .eq('status', 'active')
    .lte('effective_from', 'now()')
    .or('effective_to.is.null,effective_to.gte.now()');

  return new Map(boms.map(b => [b.product_id, b]));
}
```

## Deliverables

- API routes: `/api/technical/boms/:id/items/*`
- API routes: `/api/technical/boms/:id/items/:itemId/alternatives/*`
- **API route: `/api/technical/boms/:id/explode` (FR-2.29)**
- BOMItemsTable component with sub-row expansion
- BOMItemModal component (create/edit)
- BOMAlternativeModal component
- BOMByproductsSection component
- **BOMExplosionView component (FR-2.29)**
- **BOMExplosionTree component with expand/collapse (FR-2.29)**
- bom-items-service.ts
- Zod validation schemas
- Integration tests for all API endpoints
- Unit tests for bom-items-service (>80% coverage)

## Definition of Done

- [ ] BOM items table displays within 500ms for 100 items
- [ ] Add item with all fields works end-to-end
- [ ] Edit item updates immediately in UI
- [ ] Delete item with confirmation works
- [ ] Operation assignment dropdown populates from routing
- [ ] Conditional flags save as JSONB correctly
- [ ] Byproducts section displays separately with yield%
- [ ] Line-specific items save line_ids array
- [ ] Alternative ingredients CRUD works
- [ ] UoM mismatch shows warning (not blocking error)
- [ ] Quantity validation enforces > 0 and 6 decimal limit
- [ ] Sequence auto-increments by 10
- [ ] **Multi-level BOM explosion displays all levels with indentation (FR-2.29)**
- [ ] **Explosion detects and reports circular references (FR-2.29)**
- [ ] **Explosion respects max_depth parameter (FR-2.29)**
- [ ] **Explosion aggregates duplicate items with source breakdown (FR-2.29)**
- [ ] **Explosion completes within 2 seconds for 500 items (FR-2.29)**
- [ ] **Explosion tree has expand/collapse controls (FR-2.29)**
- [ ] Permission checks hide unauthorized actions
- [ ] All API endpoints have integration tests
- [ ] Unit tests cover bom-items-service (>80% coverage)
- [ ] TEC-006a wireframe fully implemented
- [ ] TEC-006c wireframe fully implemented (FR-2.29)
