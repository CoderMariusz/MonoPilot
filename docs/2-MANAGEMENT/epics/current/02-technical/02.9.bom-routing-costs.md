# 02.9 - BOM-Routing Link + Cost Calculation

**State:** ready
**Type:** backend + frontend
**Estimate:** M
**Primary PRD:** `docs/1-BASELINE/product/modules/technical.md` (FR-2.36, FR-2.37, FR-2.50, FR-2.51, FR-2.52, FR-2.53, FR-2.70, FR-2.72, FR-2.73, FR-2.74, FR-2.77)
**UX Wireframes:** TEC-013 (Recipe Costing View), TEC-015 (Cost History)

## Goal

Implement the complete product cost calculation system that links BOM material costs with routing labor/overhead costs. This enables manufacturers to understand their true product cost including materials, labor from operations, routing overhead, and factory overhead allocation.

## Scope

**In scope**
- BOM-to-routing linkage (boms.routing_id foreign key)
- Material cost calculation: SUM(ingredient cost x quantity)
- Operation labor cost: SUM(operation duration x labor rate)
- Setup/cleanup time cost calculation
- Routing-level setup cost (fixed per run)
- Routing-level working cost per unit
- Overhead allocation (routing.overhead_percent)
- Total product cost calculation and storage
- GET /api/technical/boms/:id/cost (get calculated costs)
- POST /api/technical/boms/:id/recalculate-cost (trigger recalculation)
- GET /api/technical/routings/:id/cost (routing-only cost)
- Cost breakdown view on BOM detail page
- Cost recalculation triggers (ingredient cost change, BOM change, routing change)
- costing-service.ts implementation

**Out of scope**
- Cost variance analysis (standard vs actual) - separate story
- Cost history tracking/trends (TEC-015) - separate story
- Multi-currency support (deferred)
- Cost scenario modeling (future)
- Nutrition calculation (separate story)
- Work order actual cost capture (production module)

## Dependencies
- **01a.1** - Org Context + Base RLS (for multi-tenant isolation)
- **02.5** - BOM Items with costs (required for material cost inputs)
- **02.8** - Routing Operations with times (required for labor cost inputs)
- **Migration 043** - Routing cost fields (setup_cost, working_cost_per_unit, overhead_percent, currency)
- **Migration 045** - boms.routing_id FK to routings table
- **ingredient_costs table** - Must have cost data for BOM ingredients

## Acceptance Criteria (Given/When/Then)

### BOM-Routing Link
- GIVEN user creates/edits BOM, WHEN routing dropdown shown, THEN all active routings display for selection.
- GIVEN BOM has routing_id assigned, WHEN BOM detail loads, THEN routing name displays with link to routing detail.
- GIVEN BOM has no routing assigned, WHEN cost calculation attempted, THEN error "Assign routing to BOM to calculate labor costs" displays.
- GIVEN BOM has routing assigned, WHEN routing is deleted, THEN error prevents deletion "Routing in use by {N} BOMs".

### Material Cost Calculation (FR-2.36)
- GIVEN BOM with 10 ingredients, WHEN cost calculation runs, THEN material cost = SUM(ingredient.cost_per_unit x bom_item.quantity) within 500ms.
- GIVEN ingredient has scrap_percent = 2%, WHEN cost calculation runs, THEN scrap cost added: material_cost x (scrap_percent / 100).
- GIVEN ingredient RM-001 has no cost data, WHEN cost calculation runs, THEN error "Missing cost data for: RM-001 (Flour)" displays.
- GIVEN ingredient cost has effective_from = yesterday, WHEN cost calculation runs, THEN current effective cost used (not expired).
- GIVEN ingredient has multiple cost records, WHEN calculation runs, THEN most recent effective cost used (effective_from <= today).

### Operation Labor Cost (FR-2.50, FR-2.73)
- GIVEN routing with 5 operations, WHEN cost calculation runs, THEN operation labor cost = SUM((duration/60) x labor_cost_per_hour).
- GIVEN operation has setup_time = 15 min, labor_rate = $45/hr, WHEN calculated, THEN setup cost = (15/60) x 45 = $11.25.
- GIVEN operation has cleanup_time = 10 min, labor_rate = $35/hr, WHEN calculated, THEN cleanup cost = (10/60) x 35 = $5.83.
- GIVEN operation has no labor_cost_per_hour, WHEN calculation runs, THEN org default labor rate used (or error if none).
- GIVEN BOM has production line override (bom_production_lines.labor_cost_per_hour), WHEN calculation runs, THEN line override takes precedence over routing operation rate.

### Routing-Level Costs (FR-2.51, FR-2.52, FR-2.53, FR-2.77)
- GIVEN routing has setup_cost = $50, WHEN cost calculation runs, THEN fixed setup cost of $50 added to total.
- GIVEN routing has working_cost_per_unit = $0.15, batch size = 100 kg, WHEN calculated, THEN routing working cost = 100 x 0.15 = $15.
- GIVEN routing has overhead_percent = 12%, subtotal = $200, WHEN calculated, THEN overhead = 200 x 0.12 = $24.
- GIVEN routing has no cost fields (defaults to 0), WHEN calculation runs, THEN cost calculation succeeds with routing costs = $0.

### Total Cost Calculation (FR-2.72)
- GIVEN all cost components calculated, WHEN total computed, THEN:
  ```
  Total = Material Cost
        + Operation Labor Cost (setup + run + cleanup)
        + Routing Setup Cost
        + Routing Working Cost
        + Overhead
  ```
- GIVEN total cost = $245.50, batch size = 100 kg, WHEN cost per unit calculated, THEN cost_per_kg = $2.46 (rounded to 2 decimals).
- GIVEN calculation completes successfully, WHEN result stored, THEN product_costs record created with effective_from = today.

### Cost Breakdown Display
- GIVEN BOM detail page loaded, WHEN Cost Summary section renders, THEN displays:
  - Total batch cost
  - Cost per unit (kg)
  - Material cost total + percentage
  - Labor cost total + percentage
  - Overhead cost total + percentage
  - Last calculated timestamp
- GIVEN user clicks [Recalculate], WHEN calculation completes, THEN cost breakdown updates immediately.
- GIVEN margin analysis enabled, WHEN std_price set on product, THEN actual margin displayed with warning if below target (30%).

### API Endpoints
- GIVEN GET /api/technical/boms/:id/cost called, WHEN BOM has cost data, THEN returns full breakdown (material, labor, overhead, total).
- GIVEN POST /api/technical/boms/:id/recalculate-cost called, WHEN all prerequisites met, THEN new cost record created and returned within 2 seconds.
- GIVEN GET /api/technical/routings/:id/cost called, WHEN routing has operations, THEN returns routing-only cost (labor + routing costs, no materials).

### Cost Recalculation Triggers
- GIVEN ingredient_costs record updated for RM-001, WHEN product uses RM-001, THEN cost marked as "stale" (needs recalculation).
- GIVEN BOM item quantity changed, WHEN BOM saved, THEN auto-recalculate cost if auto_recalc setting enabled.
- GIVEN routing operation duration changed, WHEN routing saved, THEN mark affected BOM costs as stale.
- GIVEN user views stale cost, WHEN Cost Summary renders, THEN warning "Cost data outdated. Click Recalculate for latest."

### Permission Enforcement
- GIVEN user without technical read permission, WHEN cost API called, THEN 403 Forbidden returned.
- GIVEN user with read-only permission, WHEN [Recalculate] button rendered, THEN button hidden.

## Implementation Notes

### API Endpoints

```typescript
// GET /api/technical/boms/:id/cost
interface BOMCostResponse {
  bom_id: string;
  product_id: string;
  cost_type: 'standard';
  batch_size: number;
  batch_uom: string;
  material_cost: number;
  labor_cost: number;
  overhead_cost: number;
  total_cost: number;
  cost_per_unit: number;
  currency: string;
  calculated_at: Date;
  calculated_by: string;
  is_stale: boolean;
  breakdown: {
    materials: MaterialCostBreakdown[];
    operations: OperationCostBreakdown[];
    routing: RoutingCostBreakdown;
    overhead: OverheadBreakdown;
  };
  margin_analysis?: {
    std_price: number;
    target_margin_percent: number;
    actual_margin_percent: number;
    below_target: boolean;
  };
}

interface MaterialCostBreakdown {
  ingredient_id: string;
  ingredient_code: string;
  ingredient_name: string;
  quantity: number;
  uom: string;
  unit_cost: number;
  scrap_percent: number;
  scrap_cost: number;
  total_cost: number;
  percentage: number;
}

interface OperationCostBreakdown {
  operation_seq: number;
  operation_name: string;
  machine_name: string | null;
  setup_time_min: number;
  duration_min: number;
  cleanup_time_min: number;
  labor_rate: number;
  setup_cost: number;
  run_cost: number;
  cleanup_cost: number;
  total_cost: number;
  percentage: number;
}

interface RoutingCostBreakdown {
  routing_id: string;
  routing_code: string;
  setup_cost: number;
  working_cost_per_unit: number;
  total_working_cost: number; // working_cost_per_unit x batch_size
  total_routing_cost: number;
}

interface OverheadBreakdown {
  allocation_method: 'labor_hours' | 'percentage';
  overhead_percent: number;
  subtotal_before_overhead: number;
  overhead_cost: number;
}

// POST /api/technical/boms/:id/recalculate-cost
// No request body - uses current BOM/routing/ingredient data
// Returns: BOMCostResponse

// GET /api/technical/routings/:id/cost
interface RoutingCostResponse {
  routing_id: string;
  routing_code: string;
  total_operation_cost: number;
  total_routing_cost: number;
  total_cost: number;
  breakdown: {
    operations: OperationCostBreakdown[];
    routing: RoutingCostBreakdown;
  };
}
```

### Database

#### product_costs table (existing)
```sql
product_costs: id, org_id, product_id, cost_type, material_cost, labor_cost,
               overhead_cost, total_cost, effective_from, effective_to,
               calculation_method, created_by, created_at

-- cost_type: 'standard' | 'actual' | 'planned'
-- calculation_method: 'bom_routing' | 'actual_production' | 'manual'
```

#### boms table (migration 045)
```sql
ALTER TABLE boms ADD COLUMN routing_id UUID REFERENCES routings(id);
```

#### routings table (migration 043)
```sql
setup_cost DECIMAL(10,2) DEFAULT 0,
working_cost_per_unit DECIMAL(10,4) DEFAULT 0,
overhead_percent DECIMAL(5,2) DEFAULT 0,
currency TEXT DEFAULT 'PLN'
```

### Frontend Components

```
app/(authenticated)/technical/boms/[id]/page.tsx  -- Add CostSummary section
components/technical/bom/
  CostSummary.tsx         -- Cost breakdown card
  CostBreakdownTable.tsx  -- Material/labor detail tables
  RecalculateButton.tsx   -- Recalculate with loading state
  MarginAnalysis.tsx      -- Margin calculation display
  StaleCostWarning.tsx    -- Warning banner for outdated costs
```

### Services

```typescript
// lib/services/costing-service.ts

export async function calculateBOMCost(bomId: string): Promise<BOMCostResponse>;
export async function getStoredBOMCost(bomId: string): Promise<BOMCostResponse | null>;
export async function calculateRoutingCost(routingId: string, batchSize: number): Promise<RoutingCostResponse>;
export async function markCostStale(productId: string): Promise<void>;
export async function getEffectiveIngredientCost(ingredientId: string, effectiveDate: Date): Promise<number>;

// Internal helpers
function calculateMaterialCost(bomItems: BOMItem[]): MaterialCostResult;
function calculateOperationCost(operations: RoutingOperation[], laborRateOverride?: number): OperationCostResult;
function calculateRoutingCost(routing: Routing, batchSize: number): RoutingCostResult;
function calculateOverhead(subtotal: number, overheadPercent: number): number;
```

### Cost Calculation Formula

```typescript
// Material Cost
const materialCost = bomItems.reduce((sum, item) => {
  const baseCost = item.quantity * getEffectiveCost(item.ingredient_id);
  const scrapCost = baseCost * (item.scrap_percent / 100);
  return sum + baseCost + scrapCost;
}, 0);

// Operation Labor Cost
const operationCost = operations.reduce((sum, op) => {
  const rate = laborRateOverride || op.labor_cost_per_hour;
  const setupCost = (op.setup_time / 60) * rate;
  const runCost = (op.duration / 60) * rate;
  const cleanupCost = (op.cleanup_time / 60) * rate;
  return sum + setupCost + runCost + cleanupCost;
}, 0);

// Routing Costs
const routingSetupCost = routing.setup_cost;
const routingWorkingCost = routing.working_cost_per_unit * batchSize;
const totalRoutingCost = routingSetupCost + routingWorkingCost;

// Overhead
const subtotal = materialCost + operationCost + totalRoutingCost;
const overheadCost = subtotal * (routing.overhead_percent / 100);

// Total
const totalCost = subtotal + overheadCost;
const costPerUnit = totalCost / batchSize;
```

### Validation (Zod)

```typescript
const bomCostRequestSchema = z.object({
  bom_id: z.string().uuid("Invalid BOM ID"),
});

const recalculateCostResponseSchema = z.object({
  success: z.boolean(),
  cost: z.object({
    material_cost: z.number().min(0),
    labor_cost: z.number().min(0),
    overhead_cost: z.number().min(0),
    total_cost: z.number().min(0),
    cost_per_unit: z.number().min(0),
  }),
  calculated_at: z.string().datetime(),
  warnings: z.array(z.string()).optional(),
});
```

### Business Rules

1. **Ingredient Cost Lookup**: Use most recent effective cost where effective_from <= today AND (effective_to IS NULL OR effective_to >= today)
2. **Labor Rate Hierarchy**: BOM line override > Routing operation default > Org default rate
3. **Stale Detection**: Mark cost stale when: ingredient cost changes, BOM items change, routing operations change
4. **Rounding**: All currency values rounded to 2 decimal places, percentages to 1 decimal
5. **Missing Data**: If any required cost data missing, calculation fails with specific error message
6. **Performance**: Cost calculation must complete within 2 seconds for BOMs with up to 50 items

## Deliverables

- API routes: `/api/technical/boms/:id/cost`, `/api/technical/boms/:id/recalculate-cost`, `/api/technical/routings/:id/cost`
- costing-service.ts with all calculation functions
- CostSummary component for BOM detail page
- CostBreakdownTable components (material, labor, overhead)
- RecalculateButton with loading state
- MarginAnalysis component
- StaleCostWarning banner
- Zod validation schemas
- Integration tests for cost calculation API
- Unit tests for costing-service (>80% coverage)

## Definition of Done

- [ ] BOM-routing linkage works (routing_id FK enforced)
- [ ] Material cost calculation accurate within $0.01
- [ ] Operation labor cost includes setup + run + cleanup time
- [ ] Routing-level costs (setup, working, overhead) applied correctly
- [ ] Total cost formula matches PRD specification
- [ ] Cost per unit calculated correctly (total / batch_size)
- [ ] GET /api/technical/boms/:id/cost returns full breakdown
- [ ] POST recalculate-cost creates new product_costs record
- [ ] Cost breakdown displays on BOM detail page
- [ ] Stale cost warning displays when costs outdated
- [ ] Margin analysis shows actual vs target margin
- [ ] Performance: calculation completes in <2 seconds
- [ ] Missing ingredient cost shows specific error message
- [ ] All API endpoints have integration tests
- [ ] Unit tests cover costing-service (>80% coverage)
- [ ] TEC-013 wireframe core features implemented
