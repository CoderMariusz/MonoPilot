# 02.21 - Storage Conditions Impact Calculator

**Story ID:** 02.21
**Epic:** 02 - Technical
**Phase:** Phase 2
**Complexity:** S (Small)
**Estimate:** 2-3 days
**Type:** Backend + Frontend
**State:** ready
**Priority:** P2

**Primary PRD:** `docs/1-BASELINE/product/modules/TECHNICAL.md` (FR-2.93)
**UX Wireframes:** TEC-016 (Storage Conditions Calculator - new)

## PRD References

| FR ID | Requirement | Priority | Phase | Covered |
|-------|-------------|----------|-------|---------|
| FR-2.93 | Storage conditions impact | P2 | Future | Yes |

## User Story

**As a** Quality Manager,
**I want** to calculate how different storage conditions affect product shelf life,
**So that** I can set accurate expiry dates based on actual storage environment and reduce waste.

**As a** Production Manager,
**I want** to see real-time shelf life adjustments when storage conditions change,
**So that** I can make informed decisions about inventory rotation and shipment priorities.

## Goal

Implement a storage conditions impact calculator that adjusts product shelf life based on actual storage environment (ambient, refrigerated, frozen). Uses simplified Arrhenius model for temperature-based adjustments and provides storage condition profiles with shelf life multipliers.

## Scope

**In scope:**
- Storage condition types (ambient, refrigerated, frozen, custom)
- Shelf life multiplier per condition type
- Temperature impact calculation (simplified Q10 model)
- Product-specific storage profiles
- Condition history tracking with timestamps
- Alert when storage condition violates product requirements
- Automatic shelf life recalculation on condition change
- Storage condition calculator UI component
- Integration with existing shelf life configuration (02.11)

**Out of scope:**
- Real-time IoT temperature monitoring integration (Phase 3)
- Humidity impact calculation (simplified to temp-only for MVP)
- Multi-zone temperature tracking (single zone per lot)
- Continuous temperature logging (point-in-time tracking only)
- AI-powered shelf life prediction
- Supplier notification automation

## Dependencies

| Story | Requirement | Status |
|-------|-------------|--------|
| 02.11 | Shelf Life Calculation | Required - provides base shelf life, product_shelf_life table |
| 01.1 | Org Context + Base RLS | Required - provides auth context |
| 02.1 | Products CRUD | Required - product_id reference |

## Acceptance Criteria (Given/When/Then)

### Storage Condition Profiles

#### AC-21.1: Storage Condition Types
- GIVEN a product requires refrigerated storage, WHEN storage profile is configured, THEN condition type is one of: 'ambient', 'refrigerated', 'frozen', 'custom'.
- GIVEN condition type 'ambient', WHEN default values set, THEN temp_min = 15C, temp_max = 25C, shelf_life_multiplier = 1.0.
- GIVEN condition type 'refrigerated', WHEN default values set, THEN temp_min = 2C, temp_max = 8C, shelf_life_multiplier = 2.0.
- GIVEN condition type 'frozen', WHEN default values set, THEN temp_min = -25C, temp_max = -18C, shelf_life_multiplier = 3.0.
- GIVEN condition type 'custom', WHEN user configures temp range, THEN custom multiplier calculated based on Q10 formula.

#### AC-21.2: Temperature-Based Shelf Life Adjustment
- GIVEN base shelf life = 7 days at ambient (20C), WHEN product stored at refrigerated (4C), THEN adjusted shelf life = 14 days (multiplier 2.0).
- GIVEN base shelf life = 7 days at ambient, WHEN product stored at frozen (-20C), THEN adjusted shelf life = 21 days (multiplier 3.0).
- GIVEN Q10 value = 2.0 (typical for food), WHEN temperature drops by 10C, THEN shelf life approximately doubles.
- GIVEN custom temperature 10C (between ambient and refrigerated), WHEN Q10 formula applied, THEN interpolated multiplier calculated.

#### AC-21.3: Q10 Temperature Coefficient Formula
- GIVEN reference temp = 20C with shelf_life_days = 7, WHEN actual temp = 10C and Q10 = 2.0, THEN adjusted_days = 7 * Q10^((20-10)/10) = 14.
- GIVEN reference temp = 20C with shelf_life_days = 7, WHEN actual temp = 30C and Q10 = 2.0, THEN adjusted_days = 7 / Q10^((30-20)/10) = 3.5 (rounded to 4).
- GIVEN Q10 slider range 1.5-3.0, WHEN user adjusts Q10, THEN impact preview updates in real-time.
- GIVEN negative adjusted_days result, WHEN calculation completes, THEN minimum 1 day enforced.

### Storage Condition History

#### AC-21.4: Condition Change Tracking
- GIVEN lot LP-001 stored at ambient, WHEN moved to refrigerated, THEN condition_history entry created with: lot_id, from_condition, to_condition, changed_at, changed_by.
- GIVEN condition history has 3 entries, WHEN history viewed, THEN entries sorted by changed_at descending (most recent first).
- GIVEN lot moved between conditions 5 times, WHEN history queried, THEN all 5 transitions displayed with timestamps.

#### AC-21.5: Effective Shelf Life Calculation with History
- GIVEN lot stored 3 days ambient + 4 days refrigerated, WHEN effective shelf life calculated, THEN weighted calculation: (3 * 1.0) + (4 * 0.5) = 5 days "consumed" of base shelf life.
- GIVEN complex condition history, WHEN remaining days calculated, THEN formula: base_days - SUM(days_in_condition * (1 / multiplier)).

### Storage Condition Alerts

#### AC-21.6: Temperature Violation Alerts
- GIVEN product requires refrigerated (2-8C), WHEN actual temp is 12C, THEN warning alert "Temperature exceeds maximum. Shelf life may be reduced."
- GIVEN product requires frozen (-25 to -18C), WHEN temp is -15C, THEN critical alert "Temperature above frozen threshold. Product integrity at risk."
- GIVEN temperature violation duration > 2 hours, WHEN alert generated, THEN severity escalates to 'critical'.
- GIVEN alert generated, WHEN user acknowledges, THEN audit log entry created with acknowledgment_at, acknowledged_by.

#### AC-21.7: Violation Impact Calculation
- GIVEN 4-hour violation at 15C (should be 4C), WHEN impact calculated, THEN shelf_life_penalty_hours = 4 * (impact_factor based on temp delta).
- GIVEN shelf_life_penalty calculated, WHEN applied, THEN remaining_shelf_life reduced accordingly with reason logged.

### Real-Time Recalculation

#### AC-21.8: Automatic Shelf Life Update
- GIVEN lot with base shelf life 10 days, WHEN storage condition changes from ambient to refrigerated, THEN adjusted_shelf_life recalculates to 20 days.
- GIVEN adjusted shelf life changes, WHEN expiry_date recalculated, THEN new expiry_date = production_date + adjusted_days.
- GIVEN bulk condition change (10 lots moved to freezer), WHEN change saved, THEN all 10 lots recalculated within 2 seconds.

### Product Storage Profiles

#### AC-21.9: Storage Profile CRUD
- GIVEN user creates storage profile "Dairy Products", WHEN saved, THEN profile includes: name, default_condition, temp_range, humidity_range, Q10_value.
- GIVEN profile linked to product, WHEN product shelf life displayed, THEN profile settings applied.
- GIVEN profile updated, WHEN products using profile viewed, THEN updated settings reflected.

### API Endpoints

#### AC-21.10: Calculate Impact Endpoint
- GIVEN valid product_id, WHEN POST /api/technical/storage-conditions/:productId/calculate called with { current_temp: 10 }, THEN adjusted shelf life returned.
- GIVEN invalid temperature (e.g., 100C), WHEN API called, THEN validation error "Temperature outside valid range (-40 to 60C)".

#### AC-21.11: Condition History Endpoints
- GIVEN lot_id, WHEN GET /api/technical/storage-conditions/lots/:lotId/history called, THEN array of condition changes returned.
- GIVEN new condition entry, WHEN POST /api/technical/storage-conditions/lots/:lotId/history called, THEN entry created and shelf life recalculated.

### Multi-tenancy

#### AC-21.12: Organization Isolation
- GIVEN User A from Org A, WHEN they configure storage profile, THEN only Org A can view/edit this profile.
- GIVEN User A attempts to access Org B storage profile, WHEN API called, THEN 404 Not Found returned.

## Technical Specification

### Database Schema

#### storage_condition_profiles table (NEW)

```sql
CREATE TABLE storage_condition_profiles (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,

  -- Profile identification
  code VARCHAR(50) NOT NULL,
  name VARCHAR(100) NOT NULL,
  description TEXT,

  -- Condition type
  condition_type VARCHAR(20) NOT NULL DEFAULT 'ambient'
    CHECK (condition_type IN ('ambient', 'refrigerated', 'frozen', 'custom')),

  -- Temperature range (Celsius)
  temp_min DECIMAL(5,2) NOT NULL,
  temp_max DECIMAL(5,2) NOT NULL,
  temp_optimal DECIMAL(5,2), -- Target temperature

  -- Humidity range (optional)
  humidity_min DECIMAL(5,2),
  humidity_max DECIMAL(5,2),

  -- Shelf life impact
  shelf_life_multiplier DECIMAL(5,2) NOT NULL DEFAULT 1.00,
  q10_coefficient DECIMAL(3,1) NOT NULL DEFAULT 2.0
    CHECK (q10_coefficient >= 1.5 AND q10_coefficient <= 3.0),
  reference_temp DECIMAL(5,2) NOT NULL DEFAULT 20.00, -- Base temperature for Q10

  -- Status
  is_default BOOLEAN DEFAULT false,
  is_active BOOLEAN DEFAULT true,

  -- Audit
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  created_by UUID REFERENCES auth.users(id),
  updated_by UUID REFERENCES auth.users(id),

  -- Constraints
  CONSTRAINT storage_profile_org_code_unique UNIQUE(org_id, code),
  CONSTRAINT temp_range_valid CHECK (temp_min <= temp_max),
  CONSTRAINT humidity_range_valid CHECK (humidity_min IS NULL OR humidity_max IS NULL OR humidity_min <= humidity_max)
);

-- Indexes
CREATE INDEX idx_storage_profiles_org_id ON storage_condition_profiles(org_id);
CREATE INDEX idx_storage_profiles_condition_type ON storage_condition_profiles(org_id, condition_type);
CREATE INDEX idx_storage_profiles_active ON storage_condition_profiles(org_id, is_active) WHERE is_active = true;
```

#### product_storage_profile table (NEW - link product to profile)

```sql
CREATE TABLE product_storage_profile (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  product_id UUID NOT NULL REFERENCES products(id) ON DELETE CASCADE,
  profile_id UUID NOT NULL REFERENCES storage_condition_profiles(id) ON DELETE RESTRICT,

  -- Override Q10 for specific product
  custom_q10 DECIMAL(3,1),
  custom_multiplier DECIMAL(5,2),

  -- Audit
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  created_by UUID REFERENCES auth.users(id),

  CONSTRAINT product_storage_profile_unique UNIQUE(org_id, product_id)
);

CREATE INDEX idx_product_storage_profile_product ON product_storage_profile(product_id);
CREATE INDEX idx_product_storage_profile_profile ON product_storage_profile(profile_id);
```

#### lot_storage_history table (NEW - condition change tracking)

```sql
CREATE TABLE lot_storage_history (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  lot_id UUID NOT NULL REFERENCES lots(id) ON DELETE CASCADE,

  -- Condition change
  from_condition_type VARCHAR(20),
  from_profile_id UUID REFERENCES storage_condition_profiles(id),
  from_temp DECIMAL(5,2),

  to_condition_type VARCHAR(20) NOT NULL,
  to_profile_id UUID REFERENCES storage_condition_profiles(id),
  to_temp DECIMAL(5,2) NOT NULL,

  -- Duration tracking (filled on next condition change)
  started_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  ended_at TIMESTAMPTZ,
  duration_hours DECIMAL(10,2), -- Calculated on end

  -- Shelf life impact at time of change
  shelf_life_consumed_hours DECIMAL(10,2),
  adjusted_remaining_days DECIMAL(10,2),

  -- Violation tracking
  is_violation BOOLEAN DEFAULT false,
  violation_severity VARCHAR(20) CHECK (violation_severity IN ('warning', 'critical')),
  violation_acknowledged_at TIMESTAMPTZ,
  violation_acknowledged_by UUID REFERENCES auth.users(id),

  -- Audit
  changed_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  changed_by UUID REFERENCES auth.users(id),
  notes TEXT
);

-- Indexes
CREATE INDEX idx_lot_storage_history_lot ON lot_storage_history(lot_id, changed_at DESC);
CREATE INDEX idx_lot_storage_history_org ON lot_storage_history(org_id);
CREATE INDEX idx_lot_storage_history_violations ON lot_storage_history(org_id, is_violation) WHERE is_violation = true;
```

#### storage_condition_alerts table (NEW)

```sql
CREATE TABLE storage_condition_alerts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  lot_id UUID NOT NULL REFERENCES lots(id) ON DELETE CASCADE,
  history_entry_id UUID REFERENCES lot_storage_history(id),

  -- Alert details
  alert_type VARCHAR(50) NOT NULL CHECK (alert_type IN ('temp_violation', 'humidity_violation', 'duration_exceeded', 'shelf_life_critical')),
  severity VARCHAR(20) NOT NULL DEFAULT 'warning' CHECK (severity IN ('info', 'warning', 'critical')),

  -- Measured values
  expected_temp_min DECIMAL(5,2),
  expected_temp_max DECIMAL(5,2),
  actual_temp DECIMAL(5,2),

  -- Impact
  shelf_life_penalty_hours DECIMAL(10,2),
  message TEXT NOT NULL,

  -- Status
  status VARCHAR(20) NOT NULL DEFAULT 'active' CHECK (status IN ('active', 'acknowledged', 'resolved', 'ignored')),
  acknowledged_at TIMESTAMPTZ,
  acknowledged_by UUID REFERENCES auth.users(id),
  resolved_at TIMESTAMPTZ,
  resolved_by UUID REFERENCES auth.users(id),
  resolution_notes TEXT,

  -- Audit
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- Indexes
CREATE INDEX idx_storage_alerts_lot ON storage_condition_alerts(lot_id);
CREATE INDEX idx_storage_alerts_org_status ON storage_condition_alerts(org_id, status);
CREATE INDEX idx_storage_alerts_active ON storage_condition_alerts(org_id, status) WHERE status = 'active';
```

### RLS Policies

```sql
-- storage_condition_profiles
CREATE POLICY "storage_profiles_select_own" ON storage_condition_profiles
  FOR SELECT USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

CREATE POLICY "storage_profiles_insert_own" ON storage_condition_profiles
  FOR INSERT WITH CHECK (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

CREATE POLICY "storage_profiles_update_own" ON storage_condition_profiles
  FOR UPDATE USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

CREATE POLICY "storage_profiles_delete_own" ON storage_condition_profiles
  FOR DELETE USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

-- Similar policies for other tables (product_storage_profile, lot_storage_history, storage_condition_alerts)
```

### API Endpoints

```
# Storage Condition Profiles
GET    /api/technical/storage-conditions/profiles           - List all profiles
POST   /api/technical/storage-conditions/profiles           - Create profile
GET    /api/technical/storage-conditions/profiles/:id       - Get profile details
PUT    /api/technical/storage-conditions/profiles/:id       - Update profile
DELETE /api/technical/storage-conditions/profiles/:id       - Delete profile (if not in use)

# Product Storage Profile Assignment
GET    /api/technical/storage-conditions/products/:productId       - Get product storage config
PUT    /api/technical/storage-conditions/products/:productId       - Assign/update profile

# Impact Calculator
POST   /api/technical/storage-conditions/calculate                  - Calculate impact for temp
POST   /api/technical/storage-conditions/products/:productId/calculate - Calculate for product at temp

# Lot Storage History
GET    /api/technical/storage-conditions/lots/:lotId/history       - Get condition history
POST   /api/technical/storage-conditions/lots/:lotId/history       - Log condition change
GET    /api/technical/storage-conditions/lots/:lotId/effective-life - Get remaining shelf life

# Alerts
GET    /api/technical/storage-conditions/alerts                     - List active alerts
PUT    /api/technical/storage-conditions/alerts/:id/acknowledge     - Acknowledge alert
PUT    /api/technical/storage-conditions/alerts/:id/resolve         - Resolve alert
```

### Request/Response Schemas

```typescript
// POST /api/technical/storage-conditions/calculate
interface CalculateImpactRequest {
  base_shelf_life_days: number;
  reference_temp: number;          // Temp at which base_shelf_life was determined
  current_temp: number;            // Actual storage temperature
  q10_coefficient?: number;        // Default 2.0
}

interface CalculateImpactResponse {
  base_shelf_life_days: number;
  reference_temp: number;
  current_temp: number;
  q10_coefficient: number;
  temperature_delta: number;
  multiplier: number;              // Calculated from Q10 formula
  adjusted_shelf_life_days: number;
  formula_explanation: string;     // e.g., "7 * 2.0^((20-10)/10) = 14 days"
}

// POST /api/technical/storage-conditions/lots/:lotId/history
interface LogConditionChangeRequest {
  to_condition_type: 'ambient' | 'refrigerated' | 'frozen' | 'custom';
  to_profile_id?: string;          // If using preset profile
  to_temp: number;                 // Actual temperature
  notes?: string;
}

interface LogConditionChangeResponse {
  id: string;
  lot_id: string;
  from_condition_type: string | null;
  to_condition_type: string;
  to_temp: number;
  changed_at: string;

  // Impact calculation
  previous_adjusted_remaining_days: number;
  new_adjusted_remaining_days: number;
  shelf_life_consumed_hours: number;

  // Violation detection
  is_violation: boolean;
  violation_severity: 'warning' | 'critical' | null;
  alert_id: string | null;         // If violation created alert
}

// GET /api/technical/storage-conditions/lots/:lotId/effective-life
interface EffectiveShelfLifeResponse {
  lot_id: string;
  lot_number: string;
  product_id: string;
  product_name: string;

  // Base shelf life from product config
  base_shelf_life_days: number;
  production_date: string;
  original_expiry_date: string;

  // Adjusted based on condition history
  total_shelf_life_consumed_days: number;
  adjusted_remaining_days: number;
  adjusted_expiry_date: string;

  // Current status
  current_condition_type: string;
  current_temp: number;
  time_in_current_condition_hours: number;

  // History summary
  condition_changes_count: number;
  violations_count: number;

  // Status indicators
  status: 'normal' | 'warning' | 'critical' | 'expired';
  status_message: string;
}
```

### Calculation Logic

```typescript
// storage-conditions-service.ts

/**
 * Q10 Temperature Coefficient Model
 * Q10 = rate increase for every 10C increase in temperature
 * Typical food Q10 values: 1.5-3.0 (default 2.0)
 *
 * Formula: adjusted_days = base_days * Q10^((reference_temp - actual_temp) / 10)
 *
 * When temp decreases: shelf life increases
 * When temp increases: shelf life decreases
 */
function calculateTemperatureImpact(
  baseDays: number,
  referenceTemp: number,
  actualTemp: number,
  q10: number = 2.0
): { adjustedDays: number; multiplier: number } {
  const tempDelta = referenceTemp - actualTemp;
  const multiplier = Math.pow(q10, tempDelta / 10);
  const adjustedDays = Math.max(1, Math.round(baseDays * multiplier));

  return { adjustedDays, multiplier };
}

/**
 * Calculate effective remaining shelf life based on condition history
 * Each period in different conditions "consumes" shelf life at different rates
 */
function calculateEffectiveShelfLife(
  baseDays: number,
  productionDate: Date,
  conditionHistory: ConditionHistoryEntry[]
): { consumedDays: number; remainingDays: number } {
  let consumedDays = 0;

  for (const entry of conditionHistory) {
    const hoursInCondition = entry.duration_hours ??
      ((new Date().getTime() - new Date(entry.started_at).getTime()) / (1000 * 60 * 60));
    const daysInCondition = hoursInCondition / 24;

    // Consumption rate = 1 / multiplier
    // If multiplier = 2.0 (refrigerated), consumption rate = 0.5
    // Meaning 1 day in refrigerated consumes 0.5 days of base shelf life
    const consumptionRate = 1 / entry.multiplier;
    consumedDays += daysInCondition * consumptionRate;
  }

  const remainingDays = Math.max(0, baseDays - consumedDays);
  return { consumedDays, remainingDays };
}

/**
 * Check for temperature violations
 */
function checkViolation(
  actualTemp: number,
  expectedMin: number,
  expectedMax: number,
  durationHours: number = 0
): { isViolation: boolean; severity: 'warning' | 'critical' | null } {
  if (actualTemp >= expectedMin && actualTemp <= expectedMax) {
    return { isViolation: false, severity: null };
  }

  // Temperature violation detected
  const tempDelta = actualTemp > expectedMax
    ? actualTemp - expectedMax
    : expectedMin - actualTemp;

  // Critical if: >5C deviation OR >2 hours duration
  const isCritical = tempDelta > 5 || durationHours > 2;

  return {
    isViolation: true,
    severity: isCritical ? 'critical' : 'warning'
  };
}
```

### Services

**Location:** `lib/services/storage-conditions-service.ts`

```typescript
interface StorageConditionsService {
  // Profile CRUD
  getProfiles(orgId: string): Promise<StorageProfile[]>;
  createProfile(data: CreateProfileRequest): Promise<StorageProfile>;
  updateProfile(id: string, data: UpdateProfileRequest): Promise<StorageProfile>;
  deleteProfile(id: string): Promise<void>;

  // Product assignment
  getProductStorageConfig(productId: string): Promise<ProductStorageConfig>;
  assignProfileToProduct(productId: string, profileId: string): Promise<void>;

  // Impact calculation
  calculateImpact(request: CalculateImpactRequest): CalculateImpactResponse;
  calculateProductImpact(productId: string, currentTemp: number): Promise<CalculateImpactResponse>;

  // Lot history
  getConditionHistory(lotId: string): Promise<ConditionHistoryEntry[]>;
  logConditionChange(lotId: string, data: LogConditionChangeRequest): Promise<LogConditionChangeResponse>;
  getEffectiveShelfLife(lotId: string): Promise<EffectiveShelfLifeResponse>;

  // Alerts
  getActiveAlerts(orgId: string): Promise<StorageAlert[]>;
  acknowledgeAlert(alertId: string): Promise<void>;
  resolveAlert(alertId: string, notes: string): Promise<void>;
}
```

### Zod Validation Schemas

**Location:** `lib/validation/storage-conditions.ts`

```typescript
import { z } from 'zod';

export const storageConditionTypeSchema = z.enum(['ambient', 'refrigerated', 'frozen', 'custom']);

export const storageProfileSchema = z.object({
  code: z.string().min(1).max(50).regex(/^[A-Z0-9-]+$/, 'Code must be uppercase alphanumeric with hyphens'),
  name: z.string().min(1).max(100),
  description: z.string().max(500).optional().nullable(),
  condition_type: storageConditionTypeSchema,
  temp_min: z.number().min(-50).max(60),
  temp_max: z.number().min(-50).max(60),
  temp_optimal: z.number().min(-50).max(60).optional().nullable(),
  humidity_min: z.number().min(0).max(100).optional().nullable(),
  humidity_max: z.number().min(0).max(100).optional().nullable(),
  shelf_life_multiplier: z.number().min(0.1).max(10).default(1.0),
  q10_coefficient: z.number().min(1.5).max(3.0).default(2.0),
  reference_temp: z.number().min(-40).max(60).default(20),
  is_default: z.boolean().default(false),
  is_active: z.boolean().default(true),
}).refine(data => data.temp_min <= data.temp_max, {
  message: 'Minimum temperature cannot exceed maximum',
  path: ['temp_min']
}).refine(data => {
  if (data.humidity_min !== null && data.humidity_max !== null) {
    return data.humidity_min <= data.humidity_max;
  }
  return true;
}, {
  message: 'Minimum humidity cannot exceed maximum',
  path: ['humidity_min']
});

export const calculateImpactSchema = z.object({
  base_shelf_life_days: z.number().int().positive().max(3650),
  reference_temp: z.number().min(-50).max(60),
  current_temp: z.number().min(-50).max(60),
  q10_coefficient: z.number().min(1.5).max(3.0).default(2.0),
});

export const logConditionChangeSchema = z.object({
  to_condition_type: storageConditionTypeSchema,
  to_profile_id: z.string().uuid().optional(),
  to_temp: z.number().min(-50).max(60),
  notes: z.string().max(500).optional().nullable(),
});

export const alertAcknowledgeSchema = z.object({
  notes: z.string().max(500).optional().nullable(),
});

export const alertResolveSchema = z.object({
  resolution_notes: z.string().min(1).max(500),
});
```

## UI Components

### Pages

None (modal-based configuration and calculator widget)

### Components

**Location:** `components/technical/storage-conditions/`

```
StorageConditionsCalculator.tsx   - Main calculator widget (Q10 formula)
StorageProfilesModal.tsx          - CRUD modal for storage profiles
StorageProfileForm.tsx            - Profile create/edit form
StorageProfileCard.tsx            - Individual profile display
ProductStorageConfig.tsx          - Assign profile to product
LotStorageHistoryTable.tsx        - Condition change history for lot
ConditionChangeDialog.tsx         - Log new condition change
StorageAlertsBadge.tsx            - Alert count indicator
StorageAlertsPanel.tsx            - Active alerts list with actions
TemperatureImpactPreview.tsx      - Real-time impact visualization
Q10SliderInput.tsx                - Q10 coefficient adjustment slider
```

### Component Details

**StorageConditionsCalculator.tsx**
```tsx
interface StorageConditionsCalculatorProps {
  productId?: string;
  baseDays?: number;
  referenceTemp?: number;
  onCalculate?: (result: CalculateImpactResponse) => void;
}

// Features:
// - Temperature input slider (-40 to 60C)
// - Q10 coefficient slider (1.5 to 3.0)
// - Real-time preview of adjusted shelf life
// - Formula explanation display
// - Condition type quick-select (ambient/refrigerated/frozen)
```

**LotStorageHistoryTable.tsx**
```tsx
interface LotStorageHistoryTableProps {
  lotId: string;
  onConditionChange?: () => void;
}

// Columns:
// - From Condition | To Condition
// - Temperature
// - Duration
// - Shelf Life Impact
// - Violation?
// - Changed At
// - Changed By
// - Actions (view details)
```

### UI Patterns

**Calculator Widget Layout:**
```
+--------------------------------------------+
| Storage Conditions Impact Calculator       |
+--------------------------------------------+
| Reference Temperature: [20] C              |
| Current Temperature:   [----|----] C       |
|                           4                |
+--------------------------------------------+
| Condition Type: (o) Ambient                |
|                 ( ) Refrigerated           |
|                 ( ) Frozen                 |
|                 ( ) Custom                 |
+--------------------------------------------+
| Q10 Coefficient: [----|----] 2.0           |
|                                            |
| Base Shelf Life:       7 days              |
| Adjusted Shelf Life:  14 days              |
| Multiplier:           2.0x                 |
|                                            |
| Formula: 7 * 2.0^((20-4)/10) = 14 days     |
+--------------------------------------------+
|                           [Calculate]      |
+--------------------------------------------+
```

**Alert Badge:**
```
[!] 3 Active Alerts
```

## Test Cases

### Unit Tests

**storage-conditions-service.test.ts**
```typescript
describe('StorageConditionsService', () => {
  describe('calculateTemperatureImpact', () => {
    it('doubles shelf life when temp drops by 10C with Q10=2.0');
    it('halves shelf life when temp increases by 10C with Q10=2.0');
    it('returns minimum 1 day for extreme temperature');
    it('handles Q10 values between 1.5 and 3.0');
    it('calculates correctly for frozen storage');
    it('interpolates for intermediate temperatures');
  });

  describe('calculateEffectiveShelfLife', () => {
    it('calculates consumed days based on condition history');
    it('handles mixed conditions (ambient + refrigerated)');
    it('returns 0 remaining when fully consumed');
    it('handles empty condition history');
  });

  describe('checkViolation', () => {
    it('returns no violation when temp in range');
    it('returns warning for minor violation');
    it('returns critical for >5C deviation');
    it('escalates to critical after 2 hours');
  });
});
```

### Integration Tests

**storage-conditions-api.test.ts**
```typescript
describe('Storage Conditions API', () => {
  describe('POST /api/technical/storage-conditions/calculate', () => {
    it('calculates impact with default Q10');
    it('calculates impact with custom Q10');
    it('validates temperature range');
    it('returns formula explanation');
  });

  describe('POST /api/technical/storage-conditions/lots/:lotId/history', () => {
    it('logs condition change successfully');
    it('calculates shelf life impact');
    it('creates alert on violation');
    it('ends previous condition period');
  });

  describe('GET /api/technical/storage-conditions/lots/:lotId/effective-life', () => {
    it('returns correct remaining days');
    it('accounts for all condition changes');
    it('shows current status correctly');
  });
});
```

### E2E Tests

**storage-conditions.spec.ts**
```typescript
describe('Storage Conditions Calculator', () => {
  it('displays calculator widget on product page');
  it('updates preview when temperature slider moved');
  it('shows correct multiplier for condition types');
  it('logs condition change for lot');
  it('displays violation alert when temp exceeded');
  it('allows acknowledging and resolving alerts');
});
```

## Deliverables

- [ ] `storage_condition_profiles` table migration
- [ ] `product_storage_profile` table migration
- [ ] `lot_storage_history` table migration
- [ ] `storage_condition_alerts` table migration
- [ ] RLS policies for all new tables
- [ ] Seed data for default profiles (Ambient, Refrigerated, Frozen)
- [ ] Storage conditions service (`lib/services/storage-conditions-service.ts`)
- [ ] Zod validation schemas (`lib/validation/storage-conditions.ts`)
- [ ] Storage Profiles API endpoints (CRUD)
- [ ] Calculate Impact API endpoint
- [ ] Lot History API endpoints
- [ ] Alerts API endpoints
- [ ] StorageConditionsCalculator component
- [ ] StorageProfilesModal component
- [ ] LotStorageHistoryTable component
- [ ] StorageAlertsPanel component
- [ ] Q10SliderInput component
- [ ] Integration with product detail page (02.11)
- [ ] Unit tests for calculation logic (>= 80% coverage)
- [ ] Integration tests for all API endpoints
- [ ] E2E test for calculator workflow

## Definition of Done

- [ ] Storage condition profiles can be created, edited, and deleted
- [ ] Default profiles (Ambient, Refrigerated, Frozen) seeded correctly
- [ ] Q10 formula calculates shelf life impact correctly
- [ ] Temperature slider updates impact preview in real-time
- [ ] Product can be assigned to storage profile
- [ ] Lot condition changes are logged with timestamps
- [ ] Previous condition period ends when new condition logged
- [ ] Effective shelf life calculated from condition history
- [ ] Temperature violations detected and alerts created
- [ ] Alerts can be acknowledged and resolved
- [ ] Violation escalates to critical after 2 hours or >5C
- [ ] Multi-tenancy enforced (RLS on all tables)
- [ ] Cross-tenant access returns 404
- [ ] API response times <500ms for calculations
- [ ] Bulk operations complete within 2 seconds
- [ ] Loading states displayed during operations
- [ ] Error states handled with meaningful messages
- [ ] Accessibility: keyboard navigation, ARIA labels
- [ ] Unit tests pass with >= 80% coverage
- [ ] Integration tests cover all API endpoints
- [ ] E2E test covers calculator and history workflow
