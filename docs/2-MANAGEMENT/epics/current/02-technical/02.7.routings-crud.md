# 02.7 - Routings CRUD + Header Management

**State:** ready
**Type:** frontend + backend
**Estimate:** M
**Primary PRD:** `docs/1-BASELINE/product/modules/technical.md` (FR-2.40, FR-2.46, FR-2.54, FR-2.55)
**UX Wireframes:** TEC-007 (Routings List), TEC-008 (Routing Modal), TEC-008a (Routing Detail)

## Goal
Implement complete Routing header CRUD operations including routing list page with search/filters, create/edit modal for routing header fields (code, name, description, status, reusability, version, cost configuration), routing detail page, status lifecycle management (draft/active/obsolete), and routing versioning system.

## Scope

**In scope**
- GET /api/technical/routings (list with pagination, search, filters by status)
- POST /api/technical/routings (create new routing)
- GET /api/technical/routings/:id (get routing detail with operations count and BOM usage)
- PUT /api/technical/routings/:id (update existing routing header)
- DELETE /api/technical/routings/:id (delete routing if not used by BOMs, or unassign from BOMs)
- POST /api/technical/routings/:id/clone (clone routing with all operations)
- GET /api/technical/routings/:id/boms (check BOM usage for routing)
- Routings list page at `/technical/routings` with DataTable
- Create/Edit routing modal with form validation
- Routing detail page at `/technical/routings/:id` with header info display
- Routing header fields: code, name, description, status (Active/Inactive), is_reusable, version
- Cost configuration fields: setup_cost, working_cost_per_unit, overhead_percent, currency (ADR-009)
- Routing code: unique identifier, uppercase alphanumeric + hyphens (e.g., RTG-BREAD-01)
- Status lifecycle: Active (can be assigned to BOMs), Inactive (cannot be assigned to new BOMs)
- Version auto-increment on edit
- Clone routing functionality with operations copy
- Delete with BOM usage check and warning dialog

**Out of scope**
- Routing operations CRUD (covered in separate story 02.8)
- Operation reordering/sequencing (covered in 02.8)
- Routing templates (FR-2.47 - future)
- Routing cost calculation API (depends on operations - covered in 02.9)
- Quality checkpoints (moved to Epic 6 - Quality Module)

## Dependencies
- **02.1** - Products CRUD (routings can be linked to products via BOMs)
- **01a.1** - Org context + RLS (required for tenant isolation)
- **01a.3** - Machines (for future operation assignments in 02.8)

## Acceptance Criteria (Given/When/Then)

### Routings List Page
- GIVEN user navigates to `/technical/routings`, WHEN page loads, THEN routing list displays within 500ms for up to 100 routings.
- GIVEN routing list displayed, WHEN user searches "BREAD", THEN filtered results show only routings containing "BREAD" in code or name within 300ms.
- GIVEN routing list displayed, WHEN user filters by status "Active", THEN only Active routings appear.
- GIVEN routing list displayed, WHEN user filters by status "Inactive", THEN only Inactive routings appear.
- GIVEN routing table rendered, WHEN viewing routing row, THEN shows: Name, Description (truncated), Status badge, Operations count, Actions.
- GIVEN empty routing list, WHEN page loads, THEN empty state displays with "No Routings Found" message and "[+ Create Your First Routing]" CTA.

### Create Routing
- GIVEN user clicks "[+ Add Routing]", WHEN modal opens, THEN create form displays with empty fields, status defaulting to "Active", is_reusable defaulting to checked, and cost fields defaulting to 0.
- GIVEN valid routing data (code: "RTG-BREAD-01", name: "Standard Bread Line"), WHEN "[Create Routing]" clicked, THEN routing created with version 1 and navigates to routing detail page.
- GIVEN duplicate code "RTG-BREAD-01" already exists, WHEN save attempted, THEN error "Code 'RTG-BREAD-01' already exists in your organization" displays inline on code field.
- GIVEN invalid code format "bread line 01" (lowercase, spaces), WHEN save attempted, THEN error "Code can only contain uppercase letters, numbers, and hyphens" displays inline.
- GIVEN code field is less than 2 characters, WHEN save attempted, THEN error "Code must be at least 2 characters" displays inline.
- GIVEN name field is empty, WHEN save attempted, THEN error "Routing name is required" displays inline.
- GIVEN successful create, WHEN routing saved, THEN toast "Routing created. Now add production operations." displays and redirects to detail page.

### Edit Routing
- GIVEN user clicks "[Edit]" on existing routing "RTG-BREAD-01", WHEN modal opens, THEN current routing data pre-populates form with version displayed in header.
- GIVEN user updates name from "Standard Bread Line" to "Standard Bread Production", WHEN save completes, THEN updated name displays immediately in list and version increments.
- GIVEN user changes status from Active to Inactive on routing used by 3 BOMs, WHEN save attempted, THEN warning banner displays "This routing is used by 3 BOM(s). Marking it inactive will prevent assignment to new BOMs but won't affect existing ones."
- GIVEN user changes is_reusable from true to false, WHEN save completes, THEN routing updated (existing BOM assignments preserved).
- GIVEN routing code already exists for different routing, WHEN user changes code to duplicate, THEN error "Code already exists" displays inline.

### Routing Detail Page
- GIVEN user views routing detail at `/technical/routings/:id`, WHEN page loads, THEN header displays: Code (prominent), Name, Status badge, Version, Reusable flag, Description, Usage count ("Used by X BOMs" or "Not used yet").
- GIVEN routing detail page, WHEN "[Edit Routing]" clicked, THEN modal opens with current data.
- GIVEN routing detail page, WHEN "<- Back to Routings" clicked, THEN navigates to list page.

### Cost Configuration (ADR-009)
- GIVEN create routing modal, WHEN Cost Configuration section visible, THEN fields display: Setup Cost (default 0), Working Cost per Unit (default 0), Overhead Percentage (default 0), Currency (default PLN).
- GIVEN user enters setup_cost = 50.00, working_cost_per_unit = 0.25, overhead_percent = 15, WHEN save completes, THEN cost values stored correctly.
- GIVEN user enters overhead_percent = 150 (invalid), WHEN save attempted, THEN error "Overhead percentage cannot exceed 100%" displays inline.
- GIVEN user enters negative setup_cost = -10, WHEN save attempted, THEN error "Setup cost cannot be negative" displays inline.

### Clone Routing
- GIVEN user clicks "[Clone]" icon on routing "Standard Bread Line", WHEN clone modal opens, THEN source routing info displays (read-only) and name pre-fills with "Standard Bread Line - Copy".
- GIVEN user enters unique name and clicks "[Clone Routing]", WHEN clone completes, THEN new routing created with all operations copied and toast "Routing cloned successfully with X operations" displays.
- GIVEN clone modal, WHEN user enters name that already exists, THEN error "Name must be unique" displays.
- GIVEN clone completes, WHEN viewing cloned routing, THEN operations count matches source routing operations.

### Delete Routing
- GIVEN routing not used by any BOMs, WHEN user clicks "[Delete]", THEN confirmation dialog shows "No BOMs are using this routing" and "[Delete Routing]" button.
- GIVEN routing used by 8 BOMs, WHEN user clicks "[Delete]", THEN warning dialog shows usage count, lists affected BOMs (first 5), offers "[Make Inactive]" alternative, and "[Delete Routing]" button.
- GIVEN user confirms delete on routing with BOM usage, WHEN delete completes, THEN routing deleted, BOMs have routing_id set to NULL, toast "Routing deleted. X BOM(s) unassigned." displays.
- GIVEN user clicks "[Make Inactive]" in delete dialog, WHEN action completes, THEN routing status updated to Inactive, dialog closes, list refreshes.
- GIVEN user confirms delete on unused routing, WHEN delete completes, THEN routing deleted and removed from list, toast "Routing deleted successfully" displays.

### Version Control
- GIVEN routing "RTG-BREAD-01" version 1, WHEN user edits and saves any field, THEN version increments to 2.
- GIVEN routing detail page, WHEN viewing header, THEN version displays as "Version: v2".
- GIVEN edit modal, WHEN modal opens, THEN header shows "Edit Routing - RTG-BREAD-01" with "Version: v2" badge.

### Permission Enforcement
- GIVEN user has role VIEWER (read-only), WHEN `/technical/routings` loaded, THEN "[+ Add Routing]" button hidden, edit/delete/clone actions hidden.
- GIVEN user has role PROD_MANAGER, WHEN `/technical/routings` loaded, THEN create/edit/clone actions available.
- GIVEN user has role ADMIN, WHEN delete action clicked, THEN delete proceeds.

## Implementation Notes

### API Endpoints

```typescript
// GET /api/technical/routings
// Query params: page, limit, search, is_active (true|false|all), sortBy, sortOrder
interface RoutingsListResponse {
  routings: RoutingWithCount[];
  total: number;
  page: number;
  limit: number;
}

interface RoutingWithCount {
  id: string;
  org_id: string;
  code: string;
  name: string;
  description: string | null;
  is_active: boolean;
  is_reusable: boolean;
  version: number;
  setup_cost: number;
  working_cost_per_unit: number;
  overhead_percent: number;
  currency: string;
  operations_count: number; // Count of routing_operations
  created_at: string;
  updated_at: string;
  created_by: string;
}

// POST /api/technical/routings
interface CreateRoutingRequest {
  code: string; // Required, unique, uppercase alphanumeric + hyphens
  name: string; // Required, 3-100 chars
  description?: string | null; // Optional, max 500 chars
  is_active?: boolean; // Default: true (Active)
  is_reusable?: boolean; // Default: true
  setup_cost?: number; // Default: 0, DECIMAL(10,2)
  working_cost_per_unit?: number; // Default: 0, DECIMAL(10,4)
  overhead_percent?: number; // Default: 0, 0-100, DECIMAL(5,2)
  currency?: string; // Default: 'PLN'
  cloneFrom?: string; // Optional: Source routing ID for clone
}

// GET /api/technical/routings/:id
interface RoutingDetailResponse {
  routing: RoutingWithCount;
  boms_count: number;
  related_boms: {
    id: string;
    product_code: string;
    product_name: string;
    version: string;
  }[];
}

// PUT /api/technical/routings/:id
interface UpdateRoutingRequest {
  code?: string;
  name?: string;
  description?: string | null;
  is_active?: boolean;
  is_reusable?: boolean;
  setup_cost?: number;
  working_cost_per_unit?: number;
  overhead_percent?: number;
  currency?: string;
}

// GET /api/technical/routings/:id/boms
// Check BOM usage before delete
interface RoutingBOMUsageResponse {
  boms: {
    id: string;
    code: string;
    product_name: string;
    status: string;
  }[];
  count: number;
}

// DELETE /api/technical/routings/:id
// If routing used by BOMs, sets bom.routing_id to NULL
interface DeleteRoutingResponse {
  success: true;
  affected_boms: number;
}

// PATCH /api/technical/routings/:id (for Make Inactive action)
interface PatchRoutingRequest {
  is_active: boolean;
}
```

### Database

Uses existing `routings` table with RLS policies:

```sql
-- routings table (already exists - migrations 043, 044)
id UUID PRIMARY KEY,
org_id UUID NOT NULL REFERENCES organizations(id),
code VARCHAR(50) NOT NULL, -- Unique routing identifier (e.g., RTG-BREAD-01)
name TEXT NOT NULL,
description TEXT,
version INTEGER NOT NULL DEFAULT 1, -- Auto-increment on edit
is_active BOOLEAN NOT NULL DEFAULT true,
is_reusable BOOLEAN NOT NULL DEFAULT true, -- Can be shared across multiple products
setup_cost DECIMAL(10,2) DEFAULT 0, -- Fixed cost per routing run (ADR-009)
working_cost_per_unit DECIMAL(10,4) DEFAULT 0, -- Variable cost per output unit (ADR-009)
overhead_percent DECIMAL(5,2) DEFAULT 0, -- Factory overhead % (ADR-009)
currency TEXT DEFAULT 'PLN', -- Currency for cost fields (ADR-009)
created_at TIMESTAMPTZ DEFAULT NOW(),
updated_at TIMESTAMPTZ DEFAULT NOW(),
created_by UUID REFERENCES users(id),
UNIQUE(org_id, code),
UNIQUE(org_id, name, version)

-- RLS Policy
CREATE POLICY "Routings org isolation"
ON routings FOR ALL
USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

-- Version increment trigger
CREATE OR REPLACE FUNCTION increment_routing_version()
RETURNS TRIGGER AS $$
BEGIN
  IF OLD.name != NEW.name
     OR OLD.description != NEW.description
     OR OLD.is_active != NEW.is_active
     OR OLD.is_reusable != NEW.is_reusable
     OR OLD.setup_cost != NEW.setup_cost
     OR OLD.working_cost_per_unit != NEW.working_cost_per_unit
     OR OLD.overhead_percent != NEW.overhead_percent
  THEN
    NEW.version = OLD.version + 1;
  END IF;
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER routing_version_increment
BEFORE UPDATE ON routings
FOR EACH ROW EXECUTE FUNCTION increment_routing_version();
```

### Frontend Components
- `RoutingsListPage` - Main list page component (`/technical/routings/page.tsx`)
- `RoutingsDataTable` - Table with sorting, filtering, client-side search
- `CreateRoutingModal` - Create/Edit routing modal (ShadCN Dialog)
- `CloneRoutingModal` - Clone routing modal with source info display
- `DeleteRoutingDialog` - Enhanced delete confirmation with usage warning
- `RoutingStatusBadge` - Active (green) / Inactive (gray) indicator
- `RoutingDetailPage` - Detail page with header info (`/technical/routings/[id]/page.tsx`)

### Services
- `routing-service.ts` - Routing CRUD operations
  - `listRoutings(filters)` - Get paginated list with operations count
  - `getRouting(id)` - Get single routing with BOM count
  - `createRouting(data)` - Create with code uniqueness check
  - `updateRouting(id, data)` - Update header fields (version auto-increments)
  - `deleteRouting(id)` - Delete with BOM unassignment
  - `cloneRouting(id, newData)` - Clone routing with all operations
  - `checkCodeUnique(code, excludeId?)` - Validate code uniqueness
  - `getRoutingBOMUsage(id)` - Get BOMs using this routing

### Validation (Zod)

```typescript
const createRoutingSchema = z.object({
  code: z.string()
    .min(2, "Code must be at least 2 characters")
    .max(50, "Code must be less than 50 characters")
    .regex(/^[A-Z0-9-]+$/, "Code can only contain uppercase letters, numbers, and hyphens")
    .transform(val => val.toUpperCase()),
  name: z.string()
    .min(3, "Name must be at least 3 characters")
    .max(100, "Name must be less than 100 characters"),
  description: z.string()
    .max(500, "Description must be less than 500 characters")
    .nullable()
    .optional(),
  is_active: z.boolean().default(true),
  is_reusable: z.boolean().default(true),
  setup_cost: z.number()
    .min(0, "Setup cost cannot be negative")
    .default(0),
  working_cost_per_unit: z.number()
    .min(0, "Working cost per unit cannot be negative")
    .default(0),
  overhead_percent: z.number()
    .min(0, "Overhead percentage cannot be negative")
    .max(100, "Overhead percentage cannot exceed 100%")
    .default(0),
  currency: z.enum(['PLN', 'EUR', 'USD', 'GBP']).default('PLN'),
  cloneFrom: z.string().uuid().optional(),
});

const updateRoutingSchema = createRoutingSchema.partial();

const cloneRoutingSchema = z.object({
  name: z.string()
    .min(3, "Name must be at least 3 characters")
    .max(100, "Name must be less than 100 characters"),
  description: z.string()
    .max(500, "Description must be less than 500 characters")
    .nullable()
    .optional(),
  is_active: z.boolean().default(true),
});
```

## Deliverables
- API routes for Routing header CRUD operations
- Routings list page with DataTable, search, status filter
- Create/Edit routing modal with all header fields including cost configuration
- Clone routing modal with operations copy
- Enhanced delete dialog with BOM usage warning and "Make Inactive" alternative
- Routing detail page with header display and BOM usage count
- Code uniqueness validation (server-side)
- Version auto-increment on edit (database trigger)
- Permission-based UI rendering
- Zod validation schemas
- Integration tests for API endpoints
- Unit tests for routing-service

## Definition of Done
- [ ] Routings list page loads within 500ms for 100 routings
- [ ] Create routing with code uniqueness validation works end-to-end
- [ ] Edit routing updates immediately in UI, version increments
- [ ] Routing detail page displays all header fields with BOM usage count
- [ ] Code validation enforces uppercase alphanumeric + hyphens format
- [ ] Clone routing copies all operations successfully
- [ ] Delete with BOM usage shows warning dialog with "Make Inactive" option
- [ ] Delete unassigns routing from BOMs (sets routing_id to NULL)
- [ ] Cost configuration fields save correctly (ADR-009)
- [ ] Status filter works (Active/Inactive/All)
- [ ] Client-side search filters by name/description within 300ms
- [ ] Permission checks hide unauthorized actions (create/edit/delete/clone)
- [ ] All API endpoints have integration tests
- [ ] Unit tests cover routing-service (>80% coverage)
- [ ] Zod schemas validate all input fields
- [ ] Empty state shows "No Routings Found" with CTA
- [ ] Error states display clear messages
