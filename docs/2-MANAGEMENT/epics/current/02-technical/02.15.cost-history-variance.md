# 02.15 - Cost History & Variance Analysis

**State:** ready
**Type:** frontend + backend
**Estimate:** M (medium complexity - reporting and analysis)
**Primary PRD:** `docs/1-BASELINE/product/modules/technical.md` (FR-2.71, FR-2.75)
**UX Wireframe:** TEC-015-cost-history.md

## Goal
Implement cost history tracking for products with variance analysis comparing standard costs to actual production costs. Includes trend visualization, cost driver identification, and export functionality.

## Scope

**In scope**
- GET /api/technical/costing/products/:id/history (historical cost data)
- GET /api/technical/costing/variance/report (variance analysis report)
- POST /api/technical/costing/products/:id/history/export (export cost history)
- Cost history page at `/technical/costing/products/:id/history`
- Cost trend chart (Recharts) with toggleable cost components
- Interactive chart with hover tooltips and clickable data points
- Cost component breakdown table (material/labor/overhead)
- Top cost drivers analysis (ingredient-level breakdown)
- Standard vs actual variance analysis
- Date range filtering
- Export functionality (CSV, PDF, PNG, Excel)
- Cost history table with pagination
- Variance threshold warnings
- 30/90/YTD trend calculations

**Out of scope**
- Real-time cost updates via WebSocket
- Cost forecasting/prediction
- What-if cost scenarios
- Multi-product comparison
- Currency conversion for multi-currency

## Dependencies
- **02.1** - Products CRUD (required for product lookup)
- **02.9** - BOM-Routing costs (required for standard cost calculation)
- **04.x** - Production module (for actual costs from work orders - integration point)

## Acceptance Criteria (Given/When/Then)

### Cost History Display
- GIVEN product "Bread Loaf White" has 47 cost records, WHEN user navigates to cost history page, THEN history displays within 1 second.
- GIVEN cost history page loaded, WHEN current cost summary shows, THEN current cost $2.46/kg, previous cost $2.38/kg, change +$0.08 (+3.4%) displayed.
- GIVEN cost history page loaded, WHEN trends display, THEN 30-day (+2.1%), 90-day (+5.8%), YTD (+12.3%) trends shown with arrows.
- GIVEN cost history page loaded, WHEN "View Latest Costing" clicked, THEN navigation to TEC-013 recipe costing detail occurs.

### Cost Trend Chart
- GIVEN cost history with 12 months data, WHEN chart renders, THEN line chart shows cost trend over time.
- GIVEN chart displayed, WHEN toggle buttons shown, THEN user can enable/disable Material, Labor, Overhead, Total lines.
- GIVEN chart displayed with all toggles on, WHEN displayed, THEN 4 different colored lines show stacked data.
- GIVEN chart displayed, WHEN user hovers over data point for March 2025, THEN tooltip shows: Material $161.60 (74.1%), Labor $40.00 (18.3%), Overhead $16.50 (7.6%), Total $218.10 (100%), Cost per Unit $2.18/kg.
- GIVEN chart displayed, WHEN user clicks data point, THEN navigation to specific cost calculation detail occurs.
- GIVEN chart displayed, WHEN user clicks zoom in/out, THEN chart resolution adjusts (monthly/weekly/daily).

### Cost Component Breakdown
- GIVEN cost history loaded, WHEN component breakdown table displays, THEN Material, Labor, Overhead, Total rows show.
- GIVEN component breakdown displayed, WHEN current vs 3mo ago compared, THEN change column shows +$7.30 (+4.1%) for materials.
- GIVEN component breakdown displayed, WHEN % of Total column shows, THEN Material 75.6%, Labor 17.1%, Overhead 7.3%.
- GIVEN component with >5% increase, WHEN row displays, THEN red highlight indicates cost increase.
- GIVEN component with decrease, WHEN row displays, THEN green highlight indicates cost decrease.

### Top Cost Drivers
- GIVEN cost history loaded, WHEN top cost drivers section displays, THEN top 5 ingredients by cost impact shown.
- GIVEN cost drivers displayed, WHEN "Butter" shows +$4.00 (+8.3%), THEN impact shows "+1.6%" contribution to total increase.
- GIVEN cost drivers displayed, WHEN "Biggest Driver" summary shows, THEN text says "Butter (+$4.00, accounts for 50% of total increase)".
- GIVEN cost drivers analyzed, WHEN ingredient decreased (Yeast -$0.50), THEN negative impact -0.2% displayed.

### Variance Analysis (FR-2.71)
- GIVEN variance analysis section displayed, WHEN period is "Last 30 Days", THEN work orders analyzed count shows (e.g., 12).
- GIVEN variance displayed for material cost, WHEN standard=$185.50, actual=$188.20, THEN variance shows +$2.70 (+1.5%).
- GIVEN variance displayed for labor cost, WHEN standard=$42.00, actual=$45.30, THEN variance shows +$3.30 (+7.9%).
- GIVEN labor variance >5%, WHEN displayed, THEN warning indicator shows "Significant variance in Labor Cost (+7.9%)".
- GIVEN variance section displayed, WHEN user clicks "View Detailed Variance Report", THEN navigation to full variance analysis page occurs.
- GIVEN no production data exists, WHEN variance section displays, THEN message shows "No variance data available yet. Run production to compare."

### Date Range Filtering
- GIVEN cost history page loaded, WHEN date range filter shows, THEN start and end date pickers display.
- GIVEN user sets date range 2024-01-01 to 2025-12-11, WHEN filters applied, THEN chart and table update to show only that range.
- GIVEN user selects Cost Type "Standard" only, WHEN filter applied, THEN only standard costs display (not actual).
- GIVEN user clicks "Reset Filters", WHEN applied, THEN default last 12 months with all types display.

### Export Functionality
- GIVEN cost history displayed, WHEN user clicks "Export to CSV", THEN export modal opens with options.
- GIVEN export modal open, WHEN CSV format selected, THEN data inclusion checkboxes show (History Table, Component Breakdown, Cost Drivers, Variance).
- GIVEN export options configured, WHEN preview shows, THEN first 5 rows of data display.
- GIVEN export confirmed with CSV, WHEN download completes, THEN file `cost-history-BREAD-001-2025-12-14.csv` downloads.
- GIVEN user clicks "Export Chart as PNG", WHEN export completes, THEN chart image downloads at 1200x600px.
- GIVEN user clicks "Download Full Report (PDF)", WHEN export completes, THEN multi-page PDF with charts and tables downloads.
- GIVEN user selects Excel format, WHEN export completes, THEN XLSX with multiple sheets (Summary, History, Breakdown) downloads.

### Loading/Empty/Error States
- GIVEN user navigates to cost history, WHEN data loading, THEN spinner with "Loading Cost History..." and progress bar displays.
- GIVEN product has no cost calculations, WHEN page loads, THEN empty state shows "No Cost History Available" with "Go to Recipe Costing" CTA.
- GIVEN API fails, WHEN error occurs, THEN error state shows "Unable to Load Cost History" with Retry button.

### Cost History Table
- GIVEN cost history table displayed, WHEN columns show, THEN Date, Type, Material, Labor, Overhead, Total, Change columns visible.
- GIVEN 47 records exist, WHEN table paginated at 10 per page, THEN pagination shows "Showing 10 of 47 records" with page navigation.
- GIVEN user clicks column header "Date", WHEN clicked, THEN table sorts by date (ascending/descending toggle).
- GIVEN user searches for "2025-10", WHEN search applied, THEN only October 2025 records display.
- GIVEN user clicks row for 2025-11-15, WHEN clicked, THEN navigation to that specific cost calculation detail occurs.

## Implementation Notes

### API Endpoints

```typescript
// GET /api/technical/costing/products/:id/history
// Query params: from, to, type (standard|actual|planned), page, limit
interface CostHistoryResponse {
  product: {
    id: string;
    code: string;
    name: string;
  };
  summary: {
    current_cost: number;
    current_cost_per_unit: number;
    previous_cost: number | null;
    change_amount: number;
    change_percentage: number;
    trend_30d: number;
    trend_90d: number;
    trend_ytd: number;
  };
  history: Array<{
    id: string;
    cost_type: 'standard' | 'actual' | 'planned';
    material_cost: number;
    labor_cost: number;
    overhead_cost: number;
    total_cost: number;
    cost_per_unit: number;
    effective_from: string;
    effective_to: string | null;
    created_at: string;
    created_by: string;
    bom_version?: number;
  }>;
  pagination: {
    total: number;
    page: number;
    limit: number;
    total_pages: number;
  };
  component_breakdown: {
    current: ComponentBreakdown;
    historical: ComponentBreakdown; // 3 months ago
    changes: ComponentChanges;
  };
  cost_drivers: Array<{
    ingredient_id: string;
    ingredient_name: string;
    ingredient_code: string;
    current_cost: number;
    historical_cost: number;
    change_amount: number;
    change_percent: number;
    impact_percent: number; // Contribution to total change
  }>;
}

interface ComponentBreakdown {
  material: number;
  labor: number;
  overhead: number;
  total: number;
}

interface ComponentChanges {
  material: { amount: number; percent: number };
  labor: { amount: number; percent: number };
  overhead: { amount: number; percent: number };
  total: { amount: number; percent: number };
}

// GET /api/technical/costing/variance/report
// Query params: productId, period (7|30|90|365)
interface VarianceReportResponse {
  product_id: string;
  period_days: number;
  work_orders_analyzed: number;
  components: {
    material: VarianceComponent;
    labor: VarianceComponent;
    overhead: VarianceComponent;
    total: VarianceComponent;
  };
  significant_variances: Array<{
    component: string;
    variance_percent: number;
    threshold: number;
    direction: 'over' | 'under';
  }>;
  work_order_details?: Array<{
    work_order_id: string;
    work_order_code: string;
    standard_cost: number;
    actual_cost: number;
    variance: number;
    variance_percent: number;
    completed_at: string;
  }>;
}

interface VarianceComponent {
  standard: number;
  actual: number;
  variance: number;
  variance_percent: number;
}

// POST /api/technical/costing/products/:id/history/export
interface ExportCostHistoryRequest {
  format: 'csv' | 'pdf' | 'png' | 'xlsx';
  date_range: {
    from: string;
    to: string;
  };
  data_inclusions: {
    history_table: boolean;
    component_breakdown: boolean;
    cost_drivers: boolean;
    variance_analysis: boolean;
    chart_data_points: boolean;
  };
  options?: {
    delimiter?: ',' | ';' | '\t';
    encoding?: 'utf-8' | 'ascii';
    filename?: string;
  };
}

interface ExportCostHistoryResponse {
  download_url: string; // Pre-signed URL for download
  filename: string;
  file_size_bytes: number;
  record_count: number;
  expires_at: string;
}

// GET /api/technical/dashboard/cost-trends
// Query params: months (default 6)
interface CostTrendsResponse {
  months: string[]; // ['2025-07', '2025-08', ...]
  data: Array<{
    month: string;
    material_cost: number;
    labor_cost: number;
    overhead_cost: number;
    total_cost: number;
  }>;
  currency: string;
}
```

### Trend Calculation

```typescript
const calculateTrends = (
  costHistory: ProductCost[]
): TrendSummary => {
  const now = new Date();

  const calculatePeriodTrend = (days: number): number => {
    const cutoff = new Date(now);
    cutoff.setDate(cutoff.getDate() - days);

    const periodCosts = costHistory
      .filter(c => new Date(c.created_at) >= cutoff)
      .sort((a, b) => new Date(a.created_at).getTime() - new Date(b.created_at).getTime());

    if (periodCosts.length < 2) return 0;

    const oldest = periodCosts[0].total_cost;
    const newest = periodCosts[periodCosts.length - 1].total_cost;

    return ((newest - oldest) / oldest) * 100;
  };

  const calculateYtdTrend = (): number => {
    const startOfYear = new Date(now.getFullYear(), 0, 1);
    const ytdCosts = costHistory
      .filter(c => new Date(c.created_at) >= startOfYear)
      .sort((a, b) => new Date(a.created_at).getTime() - new Date(b.created_at).getTime());

    if (ytdCosts.length < 2) return 0;

    const first = ytdCosts[0].total_cost;
    const last = ytdCosts[ytdCosts.length - 1].total_cost;

    return ((last - first) / first) * 100;
  };

  return {
    trend_30d: calculatePeriodTrend(30),
    trend_90d: calculatePeriodTrend(90),
    trend_ytd: calculateYtdTrend(),
  };
};
```

### Variance Calculation

```typescript
const calculateVariance = (
  standardCosts: ProductCost,
  actualCosts: WorkOrderCost[]
): VarianceReport => {
  // Aggregate actual costs from work orders
  const totalActual = actualCosts.reduce(
    (acc, wo) => ({
      material: acc.material + wo.material_cost,
      labor: acc.labor + wo.labor_cost,
      overhead: acc.overhead + wo.overhead_cost,
    }),
    { material: 0, labor: 0, overhead: 0 }
  );

  // Average per work order
  const count = actualCosts.length;
  const avgActual = {
    material: totalActual.material / count,
    labor: totalActual.labor / count,
    overhead: totalActual.overhead / count,
    total: (totalActual.material + totalActual.labor + totalActual.overhead) / count,
  };

  // Calculate variance for each component
  const calculateComponentVariance = (
    standard: number,
    actual: number
  ): VarianceComponent => ({
    standard,
    actual,
    variance: actual - standard,
    variance_percent: ((actual - standard) / standard) * 100,
  });

  const components = {
    material: calculateComponentVariance(standardCosts.material_cost, avgActual.material),
    labor: calculateComponentVariance(standardCosts.labor_cost, avgActual.labor),
    overhead: calculateComponentVariance(standardCosts.overhead_cost, avgActual.overhead),
    total: calculateComponentVariance(standardCosts.total_cost, avgActual.total),
  };

  // Identify significant variances (>5% threshold)
  const threshold = 5;
  const significant_variances = Object.entries(components)
    .filter(([_, v]) => Math.abs(v.variance_percent) > threshold)
    .map(([component, v]) => ({
      component,
      variance_percent: v.variance_percent,
      threshold,
      direction: v.variance_percent > 0 ? 'over' : 'under' as const,
    }));

  return {
    components,
    significant_variances,
    work_orders_analyzed: count,
  };
};
```

### Database Schema Extensions

```sql
-- Ensure product_costs table has history tracking
CREATE TABLE IF NOT EXISTS product_costs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id),
  product_id UUID NOT NULL REFERENCES products(id),
  cost_type TEXT NOT NULL CHECK (cost_type IN ('standard', 'actual', 'planned')),
  material_cost DECIMAL(15,4) NOT NULL,
  labor_cost DECIMAL(15,4) NOT NULL,
  overhead_cost DECIMAL(15,4) NOT NULL,
  total_cost DECIMAL(15,4) NOT NULL,
  cost_per_unit DECIMAL(15,4),
  currency TEXT DEFAULT 'PLN',
  effective_from DATE NOT NULL,
  effective_to DATE,
  bom_id UUID REFERENCES boms(id),
  bom_version INTEGER,
  routing_id UUID REFERENCES routings(id),
  calculation_method TEXT, -- 'auto', 'manual', 'import'
  notes TEXT,
  created_at TIMESTAMPTZ DEFAULT now(),
  created_by UUID REFERENCES users(id),
  updated_at TIMESTAMPTZ DEFAULT now()
);

-- Index for history queries
CREATE INDEX idx_product_costs_history ON product_costs(
  org_id, product_id, effective_from DESC
);

-- Cost variance records (from production)
CREATE TABLE IF NOT EXISTS cost_variances (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id),
  work_order_id UUID NOT NULL REFERENCES work_orders(id),
  product_id UUID NOT NULL REFERENCES products(id),
  standard_material DECIMAL(15,4),
  actual_material DECIMAL(15,4),
  standard_labor DECIMAL(15,4),
  actual_labor DECIMAL(15,4),
  standard_overhead DECIMAL(15,4),
  actual_overhead DECIMAL(15,4),
  standard_total DECIMAL(15,4),
  actual_total DECIMAL(15,4),
  variance_total DECIMAL(15,4),
  variance_percent DECIMAL(5,2),
  analyzed_at TIMESTAMPTZ DEFAULT now(),
  notes TEXT,
  created_at TIMESTAMPTZ DEFAULT now()
);

CREATE INDEX idx_cost_variances_product ON cost_variances(
  org_id, product_id, analyzed_at DESC
);
```

### Frontend Components
- `CostHistoryPage` - Main page at `/technical/costing/products/:id/history`
- `CostSummaryCard` - Current cost, previous cost, change, trends
- `CostTrendChart` - Recharts line chart with toggles
- `CostChartTooltip` - Custom tooltip with detailed breakdown
- `ComponentBreakdownTable` - Material/Labor/Overhead breakdown
- `CostDriversPanel` - Top ingredient cost contributors
- `VarianceAnalysisSection` - Standard vs Actual comparison
- `CostHistoryTable` - Paginated history with sort/filter
- `ExportModal` - Format selection and options
- `DateRangeFilter` - Start/end date pickers

### Services
- `cost-history-service.ts` - History retrieval and trend calculation
- `variance-analysis-service.ts` - Standard vs Actual comparison
- `cost-export-service.ts` - CSV, PDF, PNG, Excel generation

### Caching Strategy

```typescript
// Redis keys with TTL
'org:{orgId}:product:{productId}:cost-history'      // 5 min TTL
'org:{orgId}:product:{productId}:cost-trends'       // 5 min TTL
'org:{orgId}:product:{productId}:variance-report'   // 5 min TTL
```

### Performance Targets
- Cost history page load: <1s for 100 records
- Chart render: <500ms for 12 months data
- Export CSV: <2s for 1000 records
- Export PDF: <5s for full report with charts

## Deliverables
- Cost history page with trend visualization
- Cost trend chart (Recharts) with interactive tooltips
- Variance analysis section with warnings
- Export functionality (CSV, PDF, PNG, Excel)
- Cost history table with pagination and sorting
- Date range and cost type filtering
- 3 API endpoints for cost history and variance
- Integration with Production module for actual costs
- Zod validation schemas
- Integration tests for variance calculations
- Unit tests for trend calculations (>80% coverage)

## Definition of Done
- [ ] Cost history page loads within 1 second
- [ ] Current cost summary shows with accurate trends
- [ ] Chart displays correctly with all cost component lines
- [ ] Chart tooltips show detailed breakdown on hover
- [ ] Chart data points are clickable (navigate to detail)
- [ ] Component breakdown shows current vs historical with changes
- [ ] Top 5 cost drivers display with impact percentages
- [ ] Variance analysis shows Standard vs Actual with warnings
- [ ] Significant variances (>5%) are highlighted
- [ ] Date range filtering updates chart and table
- [ ] CSV export includes all selected data
- [ ] PDF export includes charts and tables
- [ ] PNG export renders chart at correct resolution
- [ ] Excel export creates multi-sheet workbook
- [ ] Pagination works for >100 history records
- [ ] Column sorting works in history table
- [ ] Empty state displays for products without cost history
- [ ] All API endpoints have integration tests
- [ ] Cost calculation services have >80% unit test coverage
