# 02.4 - BOMs CRUD + Date Validity

**State:** ready
**Type:** frontend + backend
**Estimate:** M
**Primary PRD:** `docs/1-BASELINE/product/modules/technical.md` (FR-2.20, FR-2.21, FR-2.22, FR-2.23)
**UX Wireframes:** TEC-005 (BOMs List), TEC-006 (BOM Modal), TEC-006b (BOM Version Timeline)

## Goal
Implement complete Bill of Materials CRUD operations including BOM list page with search/filters, create/edit page with date validation, version control system, and date-based validity (effective_from/effective_to) with overlap prevention.

## Scope

**In scope**
- GET /api/technical/boms (list with pagination, search, filters by product/status/date)
- POST /api/technical/boms (create new BOM)
- PUT /api/technical/boms/:id (update existing BOM header)
- DELETE /api/technical/boms/:id (delete BOM if not used in Work Orders)
- BOM list page at `/technical/boms` with DataTable
- Create/Edit BOM page with form validation
- BOM header fields: product_id, version, effective_from, effective_to, status, output_qty, output_uom
- Date validity: effective_from required, effective_to optional (NULL = no end)
- Date overlap prevention (database trigger enforces no overlaps for same product)
- BOM status management: draft, active, phased_out, inactive
- Version auto-increment within product scope (v1, v2, v3...)
- **Version timeline visualization (FR-2.23) - show all BOM versions for a product on a timeline**

**Out of scope**
- BOM items management (covered in separate story 02.5)
- BOM clone/copy functionality (FR-2.24 - separate story)
- BOM comparison/diff view (FR-2.25 - separate story)
- Conditional BOM items (FR-2.26 - separate story)
- Byproducts management (FR-2.27 - separate story)
- Advanced settings: routing assignment, packaging fields
- Cost summary panel (depends on BOM items + costing service)

## Dependencies
- **02.1** - Products CRUD (required for product_id foreign key and product selector)
- **01.1** - Org context + RLS (required for tenant isolation)

## Acceptance Criteria (Given/When/Then)

### BOM List Page
- GIVEN user navigates to `/technical/boms`, WHEN page loads, THEN BOM list displays within 500ms for up to 500 BOMs.
- GIVEN BOM list displayed, WHEN user searches "BREAD", THEN filtered results show only BOMs for products containing "BREAD" in code or name within 300ms.
- GIVEN BOM list displayed, WHEN user filters by status "Active", THEN only Active BOMs appear.
- GIVEN BOM list displayed, WHEN user filters by product type "Finished Good", THEN only BOMs for FG products appear.
- GIVEN BOM list displayed, WHEN user filters by date "Currently Effective", THEN only BOMs where current date is between effective_from and effective_to (or effective_to is NULL) appear.
- GIVEN BOM list has pagination, WHEN page 2 clicked, THEN next 50 BOMs display.
- GIVEN BOM table rendered, WHEN viewing BOM row, THEN shows: Product (code + name), Version (v1), Status (badge), Eff. From (date), Eff. To (date or "-"), Output (qty + uom).

### Create BOM
- GIVEN user clicks "[+ Create BOM]", WHEN page loads, THEN create form displays with empty fields and version set to "v1".
- GIVEN user selects product "FG-001 Honey Bread", WHEN form updates, THEN version auto-calculates to next available (v1 if first, v2 if v1 exists).
- GIVEN valid BOM data (product: FG-001, effective_from: today, output_qty: 100, output_uom: kg), WHEN "[Save BOM]" clicked, THEN BOM created with status "draft" and redirects to BOM detail page.
- GIVEN product already has BOM with effective_from=2024-01-01, effective_to=NULL (no end), WHEN user creates new BOM with effective_from=2024-06-01 (overlaps), THEN error "Date range overlaps with existing BOM v1 (2024-01-01 to ongoing)" displays.
- GIVEN product has no existing BOMs, WHEN BOM created with status "active", THEN BOM saved as active (no overlap check needed).
- GIVEN effective_to date set before effective_from, WHEN save attempted, THEN error "Effective To must be after Effective From" displays inline.
- GIVEN output_qty is 0 or negative, WHEN save attempted, THEN error "Output quantity must be greater than 0" displays inline.

### Edit BOM
- GIVEN user clicks edit on existing BOM v2 (Active), WHEN page loads, THEN current BOM data pre-populates form with product field locked.
- GIVEN user updates effective_to from NULL to "2024-12-31", WHEN save completes, THEN updated date displays in list.
- GIVEN user attempts to change product_id on existing BOM, THEN product field is disabled with tooltip "Product cannot be changed after BOM creation".
- GIVEN BOM is Active and user changes status to "Inactive", WHEN save completes, THEN BOM status updates and warning toast "BOM deactivated - no longer available for production" displays.

### Date Overlap Prevention
- GIVEN product FG-001 has BOM v1 (2024-01-01 to 2024-06-30) and BOM v2 (2024-07-01 to NULL), WHEN user creates BOM v3 with effective_from=2024-04-01, THEN error "Date range overlaps with BOM v1".
- GIVEN product FG-001 has BOM v1 (2024-01-01 to 2024-06-30), WHEN user creates BOM v2 with effective_from=2024-07-01, THEN BOM v2 created successfully (no overlap).
- GIVEN user creates BOM with effective_to=NULL, WHEN another BOM exists with effective_to=NULL for same product, THEN error "Only one BOM can have no end date per product".

### Version Control
- GIVEN product FG-001 has BOMs v1, v2, WHEN user creates new BOM for FG-001, THEN version auto-set to v3.
- GIVEN BOM list for product FG-001, WHEN viewing version column, THEN versions display chronologically (v1, v2, v3) with newest at top by effective_from.
- GIVEN BOM detail page, WHEN viewing header, THEN shows "BOM v2 - FG-001 Honey Bread" with status badge.

### Version Timeline Visualization (FR-2.23)
- GIVEN user clicks "[View Timeline]" or "[Timeline]" icon on BOM list row, WHEN timeline modal/panel opens, THEN all BOM versions for that product display on a horizontal timeline.
- GIVEN timeline displayed, WHEN viewing timeline bars, THEN each version shows: version number (v1, v2, v3), effective date range, status (color-coded), and is clickable.
- GIVEN timeline displayed for product with 3 versions, WHEN user hovers over version bar, THEN tooltip shows: version, status, effective dates, output qty, notes preview.
- GIVEN timeline displayed, WHEN user clicks on a version bar, THEN navigates to that BOM detail page.
- GIVEN product has overlapping draft BOMs, WHEN timeline renders, THEN overlapping regions are highlighted with warning color.
- GIVEN timeline displayed, WHEN current date is within a version's effective range, THEN that version is highlighted as "Currently Active".
- GIVEN timeline displayed, WHEN versions have gaps between effective dates, THEN gaps are visually indicated (no coverage period).

### Delete BOM
- GIVEN user clicks delete on BOM v1 (Draft), WHEN confirmation dialog accepted, THEN BOM deleted and removed from list.
- GIVEN BOM v2 is referenced by Work Order WO-001, WHEN delete attempted, THEN error "Cannot delete BOM used in Work Orders: WO-001".
- GIVEN user clicks delete on BOM, THEN confirmation dialog shows "Delete BOM v2 for FG-001 Honey Bread? This will also delete all BOM items. This action cannot be undone."

### Permission Enforcement
- GIVEN user has role VIEWER (read-only), WHEN `/technical/boms` loaded, THEN "[+ Create BOM]" button hidden, edit/delete actions hidden.
- GIVEN user has role PROD_MANAGER, WHEN `/technical/boms` loaded, THEN create/edit/delete actions available.
- GIVEN user has role ADMIN, WHEN delete action clicked, THEN delete proceeds (only Admin can delete).

## Implementation Notes

### API Endpoints

```typescript
// GET /api/technical/boms
// Query params: page, limit, search, product_id, status, product_type, effective_date, sortBy, sortOrder
interface BOMsListResponse {
  boms: BOMWithProduct[];
  total: number;
  page: number;
  limit: number;
}

interface BOMWithProduct {
  id: string;
  org_id: string;
  product_id: string;
  product: {
    id: string;
    code: string;
    name: string;
    type: string;
    uom: string;
  };
  version: number;
  status: 'draft' | 'active' | 'phased_out' | 'inactive';
  effective_from: string; // ISO date
  effective_to: string | null;
  output_qty: number;
  output_uom: string;
  routing_id: string | null;
  units_per_box: number | null;
  boxes_per_pallet: number | null;
  notes: string | null;
  created_at: string;
  updated_at: string;
}

// POST /api/technical/boms
interface CreateBOMRequest {
  product_id: string;
  effective_from: string; // ISO date, required
  effective_to?: string | null; // ISO date, optional
  status?: 'draft' | 'active'; // default: 'draft'
  output_qty: number; // required, > 0
  output_uom: string; // required
  notes?: string;
}

// PUT /api/technical/boms/:id
interface UpdateBOMRequest {
  effective_from?: string;
  effective_to?: string | null;
  status?: 'draft' | 'active' | 'phased_out' | 'inactive';
  output_qty?: number;
  output_uom?: string;
  notes?: string;
}

// DELETE /api/technical/boms/:id
// Returns 400 if BOM is used in Work Orders

// GET /api/technical/boms/timeline/:productId (FR-2.23)
// Returns all BOM versions for a product formatted for timeline display
interface BOMTimelineResponse {
  product: {
    id: string;
    code: string;
    name: string;
  };
  versions: BOMTimelineVersion[];
  current_date: string; // ISO date for "today" indicator
}

interface BOMTimelineVersion {
  id: string;
  version: number;
  status: 'draft' | 'active' | 'phased_out' | 'inactive';
  effective_from: string;
  effective_to: string | null;
  output_qty: number;
  output_uom: string;
  notes: string | null;
  is_currently_active: boolean; // true if current date falls within range
  has_overlap: boolean; // true if overlaps with another version
}
```

### Database

Uses existing `boms` table with RLS policies:

```sql
-- boms table (already exists)
id UUID PRIMARY KEY,
org_id UUID NOT NULL REFERENCES organizations(id),
product_id UUID NOT NULL REFERENCES products(id),
version INTEGER NOT NULL DEFAULT 1,
bom_type TEXT DEFAULT 'standard',
routing_id UUID REFERENCES routings(id), -- migration 045
effective_from DATE NOT NULL,
effective_to DATE, -- NULL = no end date
status TEXT NOT NULL DEFAULT 'draft' CHECK (status IN ('draft', 'active', 'phased_out', 'inactive')),
output_qty DECIMAL(15,6) NOT NULL CHECK (output_qty > 0),
output_uom TEXT NOT NULL,
units_per_box INTEGER,
boxes_per_pallet INTEGER,
notes TEXT,
created_at TIMESTAMPTZ DEFAULT NOW(),
updated_at TIMESTAMPTZ DEFAULT NOW(),
created_by UUID REFERENCES users(id),
updated_by UUID REFERENCES users(id),
UNIQUE(org_id, product_id, version)

-- Date overlap prevention trigger (already exists)
CREATE OR REPLACE FUNCTION check_bom_date_overlap()
RETURNS TRIGGER AS $$
BEGIN
  IF EXISTS (
    SELECT 1 FROM boms
    WHERE org_id = NEW.org_id
      AND product_id = NEW.product_id
      AND id != COALESCE(NEW.id, '00000000-0000-0000-0000-000000000000'::uuid)
      AND daterange(effective_from, effective_to, '[]') &&
          daterange(NEW.effective_from, NEW.effective_to, '[]')
  ) THEN
    RAISE EXCEPTION 'Date range overlaps with existing BOM for this product';
  END IF;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER bom_date_overlap_check
BEFORE INSERT OR UPDATE ON boms
FOR EACH ROW EXECUTE FUNCTION check_bom_date_overlap();

-- RLS Policy
CREATE POLICY "BOMs org isolation"
ON boms FOR ALL
USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));
```

### Frontend Components
- `BOMsListPage` - Main list page component (`/technical/boms/page.tsx`)
- `BOMsDataTable` - Table with sorting, filtering, pagination
- `BOMCreatePage` - Create BOM page (`/technical/boms/new/page.tsx`)
- `BOMEditPage` - Edit BOM page (`/technical/boms/[id]/edit/page.tsx`)
- `BOMHeaderForm` - Reusable form for BOM header fields
- `ProductSelector` - Combobox for product search/select (only FG/WIP)
- `BOMStatusBadge` - Status indicator (Draft: gray, Active: green, Phased: yellow, Inactive: gray outline)
- `DeleteBOMDialog` - Confirmation dialog for delete
- **`BOMVersionTimeline` - Timeline visualization component (FR-2.23)**
- **`BOMTimelineModal` - Modal wrapper for timeline view (FR-2.23)**
- **`BOMTimelineBar` - Individual version bar on timeline (FR-2.23)**

### Version Timeline Component (FR-2.23)

```typescript
// components/technical/bom/BOMVersionTimeline.tsx
interface BOMVersionTimelineProps {
  productId: string;
  onVersionClick?: (bomId: string) => void;
}

// Timeline bar component
interface TimelineBarProps {
  version: BOMTimelineVersion;
  totalTimespan: { start: Date; end: Date };
  onClick: () => void;
}

// Status colors for timeline bars
const statusColors = {
  draft: 'bg-gray-200 border-gray-400',
  active: 'bg-green-200 border-green-500',
  phased_out: 'bg-yellow-200 border-yellow-500',
  inactive: 'bg-gray-100 border-gray-300',
};

// Currently active indicator
const currentActiveHighlight = 'ring-2 ring-blue-500 ring-offset-2';
```

### Services
- `bom-service.ts` - BOM CRUD operations
  - `listBOMs(filters)` - Get paginated list
  - `getBOM(id)` - Get single BOM with product
  - `createBOM(data)` - Create with version auto-increment
  - `updateBOM(id, data)` - Update header fields
  - `deleteBOM(id)` - Delete with Work Order check
  - `getNextVersion(productId)` - Calculate next version number
  - `checkDateOverlap(productId, from, to, excludeId?)` - Pre-check overlap
  - **`getBOMTimeline(productId)` - Get all versions for timeline display (FR-2.23)**

### Validation (Zod)

```typescript
const createBOMSchema = z.object({
  product_id: z.string().uuid("Invalid product"),
  effective_from: z.string().refine((val) => !isNaN(Date.parse(val)), "Invalid date"),
  effective_to: z.string().refine((val) => !val || !isNaN(Date.parse(val)), "Invalid date").nullable().optional(),
  status: z.enum(['draft', 'active']).default('draft'),
  output_qty: z.number().positive("Output quantity must be greater than 0").max(999999999, "Output quantity too large"),
  output_uom: z.string().min(1, "Unit of measure is required").max(20),
  notes: z.string().max(2000).optional(),
}).refine((data) => {
  if (data.effective_to && data.effective_from) {
    return new Date(data.effective_to) >= new Date(data.effective_from);
  }
  return true;
}, {
  message: "Effective To must be after Effective From",
  path: ["effective_to"],
});

const updateBOMSchema = createBOMSchema.partial().omit({ product_id: true });
```

### Timeline Calculation Logic (FR-2.23)

```typescript
// Calculate timeline display parameters
function calculateTimelineParams(versions: BOMTimelineVersion[]) {
  // Find earliest start date and latest end date
  const allDates = versions.flatMap(v => [
    new Date(v.effective_from),
    v.effective_to ? new Date(v.effective_to) : new Date(Date.now() + 365 * 24 * 60 * 60 * 1000) // +1 year if no end
  ]);

  const minDate = new Date(Math.min(...allDates.map(d => d.getTime())));
  const maxDate = new Date(Math.max(...allDates.map(d => d.getTime())));

  // Add padding (10% on each side)
  const timespan = maxDate.getTime() - minDate.getTime();
  const padding = timespan * 0.1;

  return {
    start: new Date(minDate.getTime() - padding),
    end: new Date(maxDate.getTime() + padding),
    totalDays: Math.ceil(timespan / (24 * 60 * 60 * 1000)),
  };
}

// Calculate bar position and width
function calculateBarPosition(
  version: BOMTimelineVersion,
  timelineParams: { start: Date; end: Date }
) {
  const totalMs = timelineParams.end.getTime() - timelineParams.start.getTime();
  const startMs = new Date(version.effective_from).getTime() - timelineParams.start.getTime();
  const endMs = (version.effective_to
    ? new Date(version.effective_to).getTime()
    : timelineParams.end.getTime()) - timelineParams.start.getTime();

  return {
    left: `${(startMs / totalMs) * 100}%`,
    width: `${((endMs - startMs) / totalMs) * 100}%`,
  };
}
```

## Deliverables
- API routes for BOM CRUD operations
- **API route for BOM timeline: GET /api/technical/boms/timeline/:productId (FR-2.23)**
- BOMs list page with DataTable, search, filters
- Create BOM page with validation
- Edit BOM page with product field locked
- Date overlap prevention (server-side validation + database trigger)
- Version auto-increment logic
- Delete with Work Order reference check
- Permission-based UI rendering
- **BOMVersionTimeline component (FR-2.23)**
- **BOMTimelineModal component (FR-2.23)**
- Zod validation schemas
- Integration tests for API endpoints
- Unit tests for bom-service

## Definition of Done
- [ ] BOM list page loads within 500ms for 500 BOMs
- [ ] Create BOM with auto-versioning works end-to-end
- [ ] Edit BOM updates immediately in UI (product field locked)
- [ ] Date overlap prevented by database trigger with clear error message
- [ ] Delete blocked if BOM used in Work Orders
- [ ] Status badge displays correct colors (Draft/Active/Phased/Inactive)
- [ ] Filters work: status, product type, date range, search
- [ ] Version numbers display correctly (v1, v2, v3)
- [ ] **Version timeline displays all versions with correct date ranges (FR-2.23)**
- [ ] **Timeline highlights currently active version (FR-2.23)**
- [ ] **Timeline shows overlap warnings visually (FR-2.23)**
- [ ] **Timeline bars are clickable and navigate to BOM detail (FR-2.23)**
- [ ] **Timeline tooltip shows version details on hover (FR-2.23)**
- [ ] Permission checks hide unauthorized actions (create/edit/delete)
- [ ] All API endpoints have integration tests
- [ ] Unit tests cover bom-service (>80% coverage)
- [ ] Zod schemas validate all input fields
- [ ] Empty state shows "Create Your First BOM" CTA
- [ ] Error states display clear messages with retry option
