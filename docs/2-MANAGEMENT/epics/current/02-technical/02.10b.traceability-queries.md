# 02.10b - Traceability Queries & Genealogy

**State:** DEFERRED
**Type:** backend + frontend
**Estimate:** L (8 story points)
**Priority:** P1 (Deferred to Epic 05 completion)
**Primary PRD:** `docs/1-BASELINE/product/modules/technical.md` (FR-2.60, FR-2.61, FR-2.62, FR-2.63, FR-2.65)
**UX Wireframes:** TEC-016 (Traceability Search - Full Implementation)

## Story Description

Implement forward/backward traceability queries, recall simulation, and genealogy tree visualization. This story completes the traceability functionality started in 02.10a.

**Prerequisites**:
- Story 02.10a (Traceability Configuration) completed
- Epic 05 (Warehouse) completed - provides `license_plates` and `lp_genealogy` tables

## Dependencies

### Cross-Epic Dependencies
- **02.10a** - Traceability Configuration (GS1 service, product config)
- **Epic 05** - Warehouse Module (License Plate structure)
  - `license_plates` table with lot, expiry, serial
  - `lp_genealogy` table for parent/child relationships
  - Genealogy recording during consumption/output

### Why Deferred?

Traceability queries require the `license_plates` and `lp_genealogy` tables which are created in Epic 05 (Warehouse). These tables capture:

1. **license_plates**: Actual inventory with lot numbers, quantities, locations
2. **lp_genealogy**: Parent-child relationships between LPs (what was consumed to make what)
3. **Consumption records**: Links between work orders and consumed/produced LPs

Without these tables, traceability queries have no data to query.

## Functional Requirements

### FR-2.60: Forward Traceability (Where-Used)
- From ingredient lot -> all finished goods lots produced using it
- Uses `lp_genealogy.parent_lp_id` -> `child_lp_id` relationships
- Shows full chain: RM -> WIP -> FG -> Shipped

### FR-2.61: Backward Traceability (What-Consumed)
- From finished goods lot -> all ingredient lots used to make it
- Reverse genealogy query
- Multi-level BOM support (FG -> WIP -> RM)

### FR-2.62: Recall Simulation
- "What if we need to recall lot X?"
- Shows all affected downstream lots
- Financial impact assessment
- Affected customers list

### FR-2.63: Genealogy Tree Visualization
- Interactive tree diagram showing lot relationships
- Expand/collapse nodes
- Relationship type indicators (split, combine, transform)

### FR-2.65: Traceability Matrix Report
- Tabular format: Lot ID, Product, Batch, Mfg Date, Consumed In, Produced From
- CSV/Excel export
- Virtual scrolling for large datasets

## Acceptance Criteria (Deferred)

### Forward Traceability
- GIVEN lot LP-001 was consumed in WO-100 which produced LP-002, WHEN forward trace is run on LP-001, THEN LP-002 appears as descendant at depth 1.
- GIVEN LP-002 was then consumed in WO-200 producing LP-003, WHEN forward trace on LP-001 with max_depth=5, THEN LP-002 (depth 1) and LP-003 (depth 2) are returned.
- GIVEN a lot was shipped to customer ABC, WHEN forward trace runs, THEN shipment info (SO number, customer, ship date) appears as leaf node.
- GIVEN max_depth=2, WHEN tree has 5 levels, THEN only levels 0-2 are returned (performance optimization).

### Backward Traceability
- GIVEN finished lot LP-100 was produced from RM lots LP-001, LP-002, LP-003, WHEN backward trace runs on LP-100, THEN all three RM lots appear as ancestors.
- GIVEN LP-001 came from PO-500 (supplier lot), WHEN backward trace runs with max_depth=3, THEN supplier lot info is included.
- GIVEN multi-level BOM, WHEN backward trace runs, THEN all ingredient lots from all BOM levels are traced.

### Recall Simulation
- GIVEN lot LP-001 has 50 descendants across 3 levels, WHEN recall simulation runs, THEN summary shows: 50 affected LPs, total quantity, estimated value.
- GIVEN some descendants are shipped to customers, WHEN recall runs, THEN affected customers list includes: customer name, shipped qty, ship date.
- GIVEN affected inventory in warehouse, WHEN recall runs, THEN location analysis shows: warehouse, zone, LP count, quantity.
- GIVEN recall simulation completes, WHEN financial impact calculated, THEN shows: product value, retrieval cost (estimate), disposal cost (estimate), total impact.
- GIVEN recall simulation runs, WHEN executed, THEN execution_time_ms is logged and displayed (performance metric).

### Genealogy Tree
- GIVEN parent-child relationships exist, WHEN genealogy tree is requested, THEN hierarchical structure is returned with: lp_id, product_code, product_name, quantity, status, depth, children[].
- GIVEN a lot has multiple parents (combined lots), WHEN tree is generated, THEN relationship_type = "combine" is indicated.
- GIVEN a lot was split into multiple children, WHEN tree is generated, THEN relationship_type = "split" is indicated.

### Traceability Matrix Report
- GIVEN a traceability search completed, WHEN matrix view selected, THEN tabular format shows: Lot ID, Product, Batch, Mfg Date, Consumed In, Produced From.
- GIVEN matrix data exists, WHEN CSV export clicked, THEN CSV file downloads with all columns and rows.
- GIVEN large dataset (1000+ rows), WHEN matrix is displayed, THEN virtual scrolling is used for performance.

### Multi-tenancy
- GIVEN User A from Org A, WHEN they search traceability, THEN only Org A lots are included in results.
- GIVEN User A attempts to trace Lot X from Org B, WHEN API is called, THEN 404 Not Found is returned.

## Implementation Notes (Deferred)

### API Endpoints

```
# Traceability Queries (requires Epic 05 tables)
POST   /api/technical/tracing/forward                      - Forward trace (where used)
POST   /api/technical/tracing/backward                     - Backward trace (what consumed)
POST   /api/technical/tracing/recall                       - Recall simulation
GET    /api/technical/tracing/genealogy/:lpId              - Get genealogy tree for lot
GET    /api/technical/tracing/recall/:id/export            - Export recall simulation report
GET    /api/technical/tracing/matrix/:lpId/export          - Export traceability matrix
```

### Database Dependencies (From Epic 05)

```sql
-- Required from Epic 05:
license_plates (id, org_id, lp_number, product_id, lot_number, quantity, status, ...)
lp_genealogy (id, parent_lp_id, child_lp_id, relationship_type, work_order_id, ...)
traceability_links (id, source_lp_id, target_lp_id, link_type, quantity, ...)
```

### Recursive CTE for Forward Trace

```sql
-- Forward trace: Find all descendants of a lot
WITH RECURSIVE trace AS (
  -- Base case: root LP
  SELECT
    id, lp_number, product_id, quantity, uom, status,
    0 AS depth, ARRAY[id] AS path
  FROM license_plates
  WHERE id = p_lp_id AND org_id = p_org_id

  UNION ALL

  -- Recursive case: children
  SELECT
    lp.id, lp.lp_number, lp.product_id, lp.quantity, lp.uom, lp.status,
    t.depth + 1, t.path || lp.id
  FROM license_plates lp
  JOIN lp_genealogy g ON g.child_lp_id = lp.id
  JOIN trace t ON t.id = g.parent_lp_id
  WHERE t.depth < p_max_depth
    AND NOT lp.id = ANY(t.path)  -- Prevent cycles
)
SELECT * FROM trace ORDER BY depth, lp_number;
```

### Frontend Components (Deferred)

- `components/technical/traceability/TraceResultsList.tsx` - List view of trace results
- `components/technical/traceability/TraceResultsTree.tsx` - Tree view (D3.js or React Flow)
- `components/technical/traceability/TraceResultsMatrix.tsx` - Matrix/table view
- `components/technical/traceability/RecallSimulationPanel.tsx` - Recall results display
- `components/technical/traceability/GenealogyTree.tsx` - Tree visualization component

### Services (Deferred)

```typescript
// Additions to traceability-service.ts
interface TraceabilityService {
  // Config methods from 02.10a
  getProductConfig(productId: string): Promise<TraceabilityConfig | null>;
  updateProductConfig(productId: string, config: Partial<TraceabilityConfig>): Promise<TraceabilityConfig>;

  // Query methods (02.10b - requires Epic 05)
  traceForward(request: TraceRequest): Promise<TraceResult>;
  traceBackward(request: TraceRequest): Promise<TraceResult>;
  runRecallSimulation(request: TraceRequest): Promise<RecallSimulationResult>;

  // Genealogy (02.10b - requires Epic 05)
  getGenealogyTree(lpId: string, maxDepth?: number): Promise<TraceNode[]>;

  // Export (02.10b)
  exportMatrix(lpId: string, format: 'csv' | 'excel' | 'pdf'): Promise<Blob>;
  exportRecallReport(simulationId: string, format: 'pdf' | 'json' | 'xml'): Promise<Blob>;
}
```

## Deliverables (Deferred)

- [ ] Forward trace API endpoint with recursive CTE
- [ ] Backward trace API endpoint with recursive CTE
- [ ] Recall simulation API endpoint
- [ ] Genealogy tree API endpoint
- [ ] TraceResultsList component (list view)
- [ ] TraceResultsTree component (tree view - D3.js)
- [ ] TraceResultsMatrix component (matrix view)
- [ ] RecallSimulationPanel component
- [ ] GenealogyTree component
- [ ] CSV/Excel export for traceability matrix
- [ ] PDF export for recall simulation report
- [ ] Performance tests for large genealogy trees (1000+ nodes)

## Definition of Done (Deferred)

- [ ] Forward trace returns correct descendants with depth levels
- [ ] Backward trace returns correct ancestors
- [ ] Recall simulation calculates affected inventory, customers, financial impact
- [ ] Genealogy tree prevents cycles (path tracking)
- [ ] Max depth parameter limits recursion (performance)
- [ ] List view displays trace results with pagination
- [ ] Tree view displays interactive genealogy visualization
- [ ] Matrix view displays tabular format with export
- [ ] CSV export downloads with all columns
- [ ] RLS enforces org isolation on all queries
- [ ] Cross-tenant trace attempts return 404
- [ ] Trace query completes in <3s for 100 levels/1000 nodes
- [ ] Recall simulation completes in <5s for typical datasets
- [ ] Loading states displayed during trace operations
- [ ] Error states handled with retry option
- [ ] Accessibility: keyboard navigation, ARIA labels for tree view

---

## Implementation Timeline

**Estimated Start**: After Epic 05 completion (Q2 2025)

**Blocking Dependencies**:
1. Story 02.10a must be complete (config foundation)
2. Epic 05 Story 5.1 - LP Creation (license_plates table)
3. Epic 05 Story 5.7 - LP Genealogy (lp_genealogy table)
4. Epic 05 Story 4.18 - Consumption with genealogy recording

---

## Relationship to Story 02.10a

```
Story 02.10a (Config)           Story 02.10b (Queries)
---------------------           ----------------------
Status: READY                   Status: DEFERRED

Deliverables:                   Deliverables:
- product_traceability_config   - Forward/backward trace APIs
- GS1 encoding service          - Recall simulation API
- Lot format validation         - Genealogy tree API
- Search page framework         - Tree/matrix visualizations
- Config modal                  - Export functionality

No LP dependency                Requires:
                                - license_plates table
                                - lp_genealogy table
                                - Consumption records
```

## Risk Notes

| Risk | Mitigation |
|------|------------|
| Epic 05 delayed | 02.10a provides value independently (config, GS1 encoding) |
| Genealogy performance | Use materialized paths, indexed queries |
| Complex tree visualization | Start with list view, add tree view incrementally |
| Large recall simulations | Add pagination, background processing for >10K LPs |
