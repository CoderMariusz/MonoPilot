# Epic 02 - Technical Module (Products, BOMs, Routings)

**Epic ID:** 02
**Module:** Technical
**Status:** READY (Stories Defined)
**Type:** Core Module (Foundation for Production)
**Primary References:**
- PRD: `docs/1-BASELINE/product/modules/technical.md`
- Architecture: `docs/1-BASELINE/architecture/modules/technical.md`
- UX Wireframes: `docs/3-ARCHITECTURE/ux/wireframes/TEC-001` to `TEC-017`

---

## Goal

Deliver the **Technical Module** providing complete product lifecycle management from formulation to production routing. This module establishes:
- Product master data with versioning and allergen tracking
- Bill of Materials (BOM) with date validity, conditional items, and alternatives
- Routing operations with cost calculation (ADR-009)
- Forward/backward traceability and recall simulation
- Recipe costing, nutrition calculation, and shelf life management

This epic provides the **product and recipe foundation** required by Planning, Production, and Warehouse modules.

---

## Non-Goals (Explicit)

**Out of Scope for Epic 02:**
- Product image upload (FR-2.9) - Phase 2E-1
- Product barcode generation (FR-2.11) - Future
- Product categories and tags (FR-2.12) - Future
- Routing templates (FR-2.47) - Future
- Ingredient origin tracking (FR-2.66) - Future
- Cross-contamination tracking (FR-2.67) - Future
- Cost scenario modeling (FR-2.76) - Future
- AI-powered BOM optimization - Future
- GraphQL API for traceability - Future

These features are planned for later phases or future releases.

---

## Story Index

| Story | Name | PRD FRs | UX | Dependencies | Complexity | Status |
|------:|------|---------|-----|--------------|------------|--------|
| 02.1 | Products CRUD + Types | FR-2.1, FR-2.5, FR-2.6, FR-2.7, FR-2.8 | TEC-001, TEC-002 | 01a.1 | M | Ready |
| 02.2 | Product Versioning + History | FR-2.2, FR-2.3 | TEC-001, TEC-002 | 02.1 | S | Ready |
| 02.3 | Product Allergens | FR-2.4, FR-2.28 | TEC-010, TEC-012 | 02.1, 01a.x | M | Ready |
| 02.4 | BOMs CRUD + Date Validity | FR-2.20, FR-2.22, FR-2.23 | TEC-005, TEC-006 | 02.1, 01a.1 | M | Ready |
| 02.5 | BOM Items Management | FR-2.21, FR-2.26, FR-2.27, FR-2.31, FR-2.38, FR-2.39 | TEC-006, TEC-006a | 02.4, 02.7 | L | Ready |
| 02.6 | BOM Alternatives + Clone | FR-2.24, FR-2.30 | TEC-005, TEC-006a | 02.4, 02.5 | M | Ready |
| 02.7 | Routings CRUD | FR-2.40, FR-2.46, FR-2.54, FR-2.55 | TEC-007, TEC-008 | 01a.1 | M | Ready |
| 02.8 | Routing Operations | FR-2.41, FR-2.43, FR-2.44, FR-2.45, FR-2.48 | TEC-008a | 02.7, 01a.7 | L | Ready |
| 02.9 | BOM-Routing Costs | FR-2.36, FR-2.37, FR-2.50-FR-2.53, FR-2.70, FR-2.72, FR-2.73, FR-2.74, FR-2.77 | TEC-013 | 02.5, 02.8 | M | Ready |
| 02.10 | Traceability | FR-2.60, FR-2.61, FR-2.62, FR-2.63, FR-2.64, FR-2.65 | TEC-016, TEC-014 | 02.1 | M | Ready |
| 02.11 | Shelf Life Calculation | FR-2.90, FR-2.91, FR-2.92 | TEC-014 | 02.1, 02.4, 02.10 | M | Ready |
| 02.12 | Technical Dashboard | FR-2.100, FR-2.101, FR-2.102 | TEC-017 | 02.1, 02.4 | M | NEW |
| 02.13 | Nutrition Calculation | FR-2.80, FR-2.81, FR-2.82, FR-2.84 | TEC-009, TEC-011 | 02.5 | L | NEW |
| 02.14 | BOM Advanced Features | FR-2.25, FR-2.29, FR-2.34, FR-2.35 | TEC-005, TEC-006 | 02.6 | M | NEW |
| 02.15 | Cost History + Variance | FR-2.71, FR-2.75 | TEC-015 | 02.9 | S | NEW |

**Total Stories:** 15
**Existing:** 11 (02.1-02.11)
**New:** 4 (02.12-02.15)
**Estimated Effort:** 12-15 days (1 developer)

---

## Story Dependency Graph

```
Epic 01a (Settings)
  |
  +---> 02.1 (Products CRUD + Types)
  |       |
  |       +---> 02.2 (Versioning + History)
  |       |
  |       +---> 02.3 (Allergens) <---- 01a.x (Allergens Master)
  |       |
  |       +---> 02.4 (BOMs CRUD)
  |       |       |
  |       |       +---> 02.5 (BOM Items) <---- 02.7 (Routings)
  |       |       |       |
  |       |       |       +---> 02.6 (Alternatives + Clone)
  |       |       |       |       |
  |       |       |       |       +---> 02.14 (BOM Advanced)
  |       |       |       |
  |       |       |       +---> 02.9 (BOM-Routing Costs) <---- 02.8 (Routing Ops)
  |       |       |       |       |
  |       |       |       |       +---> 02.15 (Cost History)
  |       |       |       |
  |       |       |       +---> 02.13 (Nutrition)
  |       |       |
  |       |       +---> 02.12 (Dashboard)
  |       |
  |       +---> 02.10 (Traceability)
  |       |
  |       +---> 02.11 (Shelf Life) <---- 02.4, 02.10
  |
  +---> 02.7 (Routings CRUD)
          |
          +---> 02.8 (Routing Operations) <---- 01a.7 (Machines)
```

**Critical Paths:**
1. **Products -> BOMs -> Costs:** 02.1 -> 02.4 -> 02.5 -> 02.9 -> 02.15
2. **Routings -> Operations -> Costs:** 02.7 -> 02.8 -> 02.9
3. **Products -> Traceability -> Shelf Life:** 02.1 -> 02.10 -> 02.11

---

## PRD Requirements Coverage

### Products (FR-2.1 to FR-2.15)

| Req ID | Requirement | Story | Status |
|--------|-------------|-------|--------|
| FR-2.1 | Product CRUD | 02.1 | Ready |
| FR-2.2 | Product versioning | 02.2 | Ready |
| FR-2.3 | Product history audit log | 02.2 | Ready |
| FR-2.4 | Allergen declaration | 02.3 | Ready |
| FR-2.5 | Product types | 02.1 | Ready |
| FR-2.6 | Product status | 02.1 | Ready |
| FR-2.7 | Product search and filters | 02.1 | Ready |
| FR-2.8 | Technical settings | 02.1 | Ready |
| FR-2.9 | Product image upload | -- | Phase 2E-1 |
| FR-2.10 | Product clone/duplicate | -- | Phase 2E-1 |
| FR-2.13 | Product standard price | 02.1 | Ready |
| FR-2.14 | Product expiry policy | 02.1 | Ready |
| FR-2.15 | Product cost validation | 02.1 | Ready |

### BOMs (FR-2.20 to FR-2.39)

| Req ID | Requirement | Story | Status |
|--------|-------------|-------|--------|
| FR-2.20 | BOM CRUD | 02.4 | Ready |
| FR-2.21 | BOM items | 02.5 | Ready |
| FR-2.22 | BOM date validity | 02.4 | Ready |
| FR-2.23 | BOM version timeline | 02.4 | Ready |
| FR-2.24 | BOM clone | 02.6 | Ready |
| FR-2.25 | BOM version comparison | 02.14 | NEW |
| FR-2.26 | Conditional items | 02.5 | Ready |
| FR-2.27 | Byproducts | 02.5 | Ready |
| FR-2.28 | Allergen inheritance | 02.3 | Ready |
| FR-2.29 | Multi-level explosion | 02.14 | NEW |
| FR-2.30 | Alternative ingredients | 02.6 | Ready |
| FR-2.31 | Operation assignment | 02.5 | Ready |
| FR-2.32 | Packaging fields | 02.4 | Ready |
| FR-2.33 | Production line assignment | 02.5 | Ready |
| FR-2.34 | BOM yield calculation | 02.14 | NEW |
| FR-2.35 | BOM scaling | 02.14 | NEW |
| FR-2.36 | BOM cost rollup | 02.9 | Ready |
| FR-2.37 | BOM routing reference | 02.9 | Ready |
| FR-2.38 | BOM item UoM validation | 02.5 | Ready |
| FR-2.39 | BOM item quantity validation | 02.5 | Ready |

### Routings (FR-2.40 to FR-2.55)

| Req ID | Requirement | Story | Status |
|--------|-------------|-------|--------|
| FR-2.40 | Routing CRUD | 02.7 | Ready |
| FR-2.41 | Routing operations | 02.8 | Ready |
| FR-2.42 | BOM-routing assignment | 02.9 | Ready |
| FR-2.43 | Operation time tracking | 02.8 | Ready |
| FR-2.44 | Machine assignment | 02.8 | Ready |
| FR-2.45 | Operation instructions | 02.8 | Ready |
| FR-2.46 | Routing versioning | 02.7 | Ready |
| FR-2.47 | Routing templates | -- | Future |
| FR-2.48 | Parallel operations | 02.8 | Ready |
| FR-2.50 | Operation labor cost | 02.9 | Ready |
| FR-2.51 | Routing setup cost | 02.9 | Ready |
| FR-2.52 | Routing working cost | 02.9 | Ready |
| FR-2.53 | Routing overhead | 02.9 | Ready |
| FR-2.54 | Routing unique code | 02.7 | Ready |
| FR-2.55 | Routing reusability flag | 02.7 | Ready |

### Traceability (FR-2.60 to FR-2.67)

| Req ID | Requirement | Story | Status |
|--------|-------------|-------|--------|
| FR-2.60 | Forward traceability | 02.10 | Ready |
| FR-2.61 | Backward traceability | 02.10 | Ready |
| FR-2.62 | Recall simulation | 02.10 | Ready |
| FR-2.63 | Genealogy tree | 02.10 | Ready |
| FR-2.64 | Lot/batch tracking | 02.10 | Ready |
| FR-2.65 | Traceability matrix | 02.10 | Ready |
| FR-2.66 | Ingredient origin | -- | Future |
| FR-2.67 | Cross-contamination | -- | Future |

### Costing (FR-2.70 to FR-2.77)

| Req ID | Requirement | Story | Status |
|--------|-------------|-------|--------|
| FR-2.70 | Recipe costing | 02.9 | Ready |
| FR-2.71 | Cost variance analysis | 02.15 | NEW |
| FR-2.72 | Cost rollup | 02.9 | Ready |
| FR-2.73 | Labor cost per operation | 02.9 | Ready |
| FR-2.74 | Overhead allocation | 02.9 | Ready |
| FR-2.75 | Historical cost tracking | 02.15 | NEW |
| FR-2.76 | Cost scenario modeling | -- | Future |
| FR-2.77 | Routing-level cost calc | 02.9 | Ready |

### Nutrition (FR-2.80 to FR-2.84)

| Req ID | Requirement | Story | Status |
|--------|-------------|-------|--------|
| FR-2.80 | Nutrition calculation | 02.13 | NEW |
| FR-2.81 | Nutrition label (FDA) | 02.13 | NEW |
| FR-2.82 | Nutrition per serving | 02.13 | NEW |
| FR-2.83 | Nutrition claims | -- | Future |
| FR-2.84 | Allergen label generation | 02.13 | NEW |

### Shelf Life (FR-2.90 to FR-2.93)

| Req ID | Requirement | Story | Status |
|--------|-------------|-------|--------|
| FR-2.90 | Shelf life calculation | 02.11 | Ready |
| FR-2.91 | Minimum shelf life rule | 02.11 | Ready |
| FR-2.92 | Shelf life override | 02.11 | Ready |
| FR-2.93 | Storage conditions | -- | Future |

### Dashboard (FR-2.100 to FR-2.103)

| Req ID | Requirement | Story | Status |
|--------|-------------|-------|--------|
| FR-2.100 | Product dashboard | 02.12 | NEW |
| FR-2.101 | Allergen matrix | 02.12 | NEW |
| FR-2.102 | BOM version timeline | 02.12 | NEW |
| FR-2.103 | Cost trend analysis | -- | Future |

---

## UX Wireframes

| ID | Screen | Story | Type |
|----|--------|-------|------|
| TEC-001 | Products List | 02.1 | Page |
| TEC-002 | Product Modal | 02.1, 02.2 | Modal |
| TEC-005 | BOMs List | 02.4, 02.6 | Page |
| TEC-006 | BOM Modal | 02.4 | Modal |
| TEC-006a | BOM Items Detail | 02.5, 02.6 | Page |
| TEC-007 | Routings List | 02.7 | Page |
| TEC-008 | Routing Modal | 02.7 | Modal |
| TEC-008a | Routing Detail | 02.8 | Page |
| TEC-009 | Nutrition Panel | 02.13 | Component |
| TEC-010 | Allergen Management | 02.3 | Page |
| TEC-011 | Nutrition Calculator | 02.13 | Page |
| TEC-012 | Allergen Warnings | 02.3 | Component |
| TEC-013 | Recipe Costing | 02.9 | Page |
| TEC-014 | Shelf Life Config | 02.10, 02.11 | Page |
| TEC-015 | Cost History | 02.15 | Page |
| TEC-016 | Traceability Search | 02.10 | Page |
| TEC-017 | Dashboard | 02.12 | Page |

**Total Wireframes:** 17

---

## External Dependencies (Cross-Epic)

### Requires from Epic 01 (Settings)

| Dependency | Usage | Status |
|------------|-------|--------|
| `organizations` | org_id for multi-tenancy | Required |
| `users` | created_by, updated_by audit | Required |
| `allergens` | Master allergen data | Required |
| `machines` | Machine assignment in operations | Required |
| `production_lines` | Line assignment in BOMs | Required |
| `locations` | Storage locations | Required |

### Provides to Other Epics

| Consumer | What | Notes |
|----------|------|-------|
| Planning (Epic 3) | Products, BOMs for WO creation | BOM snapshot at WO creation |
| Production (Epic 4) | Routing operations, BOM items | Consumption creates traceability |
| Warehouse (Epic 5) | Product data, lot tracking | LP genealogy |
| Quality (Epic 6) | Product specs, allergen data | Quality checkpoints |
| Shipping (Epic 7) | Product info, allergen labels | FEFO picking |

---

## Technical Notes

### Database Tables (Created in Epic 02)

| Table | Action | Notes |
|-------|--------|-------|
| `products` | Create | Core product data + versioning |
| `product_types` | Create | Product type classification |
| `product_allergens` | Create | Allergen declarations |
| `product_version_history` | Create | Audit log |
| `product_shelf_life` | Create | Shelf life tracking (migration 047) |
| `boms` | Create | BOM headers with routing_id (migration 045) |
| `bom_items` | Create | BOM line items with validation (migration 049) |
| `bom_alternatives` | Create | Ingredient substitutions |
| `bom_production_lines` | Create | M:N BOM to lines |
| `routings` | Create | Routing headers with cost fields (migration 043, 044) |
| `routing_operations` | Create | Operation steps |
| `conditional_flags` | Create | Conditional item flags |
| `traceability_links` | Create | Lot genealogy links |
| `lot_genealogy` | Create | Materialized genealogy paths |
| `product_costs` | Create | Cost history |
| `product_nutrition` | Create | Nutrition data |
| `ingredient_nutrition` | Create | Ingredient nutrition |
| `product_traceability_config` | Create | Traceability configuration |

### Key Services

- `product-service.ts` - Product CRUD, versioning
- `product-type-service.ts` - Product type management
- `bom-service.ts` - BOM CRUD, items, allergen inheritance
- `bom-items-service.ts` - BOM items CRUD
- `bom-alternatives-service.ts` - Alternative ingredients
- `bom-clone-service.ts` - BOM cloning
- `routing-service.ts` - Routing header CRUD
- `routing-operations-service.ts` - Routing operations CRUD
- `costing-service.ts` - BOM cost calculation (implemented)
- `traceability-service.ts` - Forward/backward trace, genealogy
- `shelf-life-service.ts` - Shelf life calculation
- `nutrition-service.ts` - Nutrition calculation
- `gs1-service.ts` - GS1 encoding

### Migrations Applied

| Migration | Description |
|-----------|-------------|
| 043 | Add routing cost fields (setup_cost, working_cost_per_unit, overhead_percent, currency) |
| 044 | Add routing.code, routing.is_reusable, routing_operations.cleanup_time, instructions |
| 045 | Add boms.routing_id FK to routings |
| 046 | Add products.std_price, products.expiry_policy |
| 047 | Create product_shelf_life table |
| 048 | Add cost_per_unit validation trigger |
| 049 | Add BOM item UoM validation trigger, quantity check |
| 050 | Remove unique sequence constraint (allows parallel operations) |

### ADRs Referenced

| ADR | Topic | Impact |
|-----|-------|--------|
| ADR-002 | BOM Snapshot Pattern | WO captures BOM at creation |
| ADR-009 | Routing-Level Costs | setup_cost, working_cost_per_unit, overhead_percent |
| ADR-010 | Product Lead Time/MOQ | Moved from suppliers to products |

---

## Delivery Order Recommendation

**Sprint 1 (Stories 02.1-02.3): Products Foundation**
- 02.1: Products CRUD + Types (M)
- 02.2: Product Versioning + History (S)
- 02.3: Product Allergens (M)

**Sprint 2 (Stories 02.4-02.6): BOMs Core**
- 02.4: BOMs CRUD + Date Validity (M)
- 02.5: BOM Items Management (L)
- 02.6: BOM Alternatives + Clone (M)

**Sprint 3 (Stories 02.7-02.9): Routings + Costing**
- 02.7: Routings CRUD (M)
- 02.8: Routing Operations (L)
- 02.9: BOM-Routing Costs (M)

**Sprint 4 (Stories 02.10-02.12): Traceability + Dashboard**
- 02.10: Traceability (M)
- 02.11: Shelf Life Calculation (M)
- 02.12: Technical Dashboard (M)

**Sprint 5 (Stories 02.13-02.15): Nutrition + Advanced**
- 02.13: Nutrition Calculation (L)
- 02.14: BOM Advanced Features (M)
- 02.15: Cost History + Variance (S)

---

## Definition of Done (Epic 02)

- [ ] Products: CRUD with versioning, types, allergens
- [ ] BOMs: CRUD with items, date validity, alternatives, clone
- [ ] Routings: CRUD with operations, cost configuration
- [ ] Traceability: Forward/backward queries, recall simulation
- [ ] Shelf Life: Calculation from ingredients, manual override
- [ ] Dashboard: Stats, allergen matrix, version timeline
- [ ] Costing: BOM cost rollup with routing costs
- [ ] Nutrition: Calculation from ingredients, FDA label
- [ ] All RLS policies enforced (org_id isolation)
- [ ] All stories have unit tests (>80% coverage)
- [ ] Integration tests for API endpoints
- [ ] E2E smoke tests for critical flows
- [ ] Performance: Product list <1s, BOM explosion <2s

---

## Risk Assessment

| Risk | Impact | Mitigation |
|------|--------|------------|
| BOM date overlap bugs | High | Database trigger enforcement + integration tests |
| Cost calculation errors | High | Comprehensive unit tests for costing-service.ts |
| Traceability performance | Medium | Indexed queries, materialized genealogy paths |
| RLS policy gaps | High | Security review, multi-tenant integration tests |
| Allergen inheritance bugs | Medium | Test allergen rollup on BOM changes |
| Routing cost versioning | Medium | Snapshot captured at WO creation per ADR-002 |
| Multi-level BOM explosion | Medium | Depth limit (10 levels), caching |

---

## Success Metrics

- [ ] Demo: Create product, BOM, routing, calculate cost
- [ ] BOM date validity enforced (no overlaps)
- [ ] Allergen inheritance automatic from BOM items
- [ ] Traceability query <3s for 100k lots
- [ ] Cost calculation <500ms for 5-level BOM
- [ ] 80% of products have active BOMs
- [ ] 70% of products have routings assigned

---

## Handoff to DEV Agents

```yaml
epic: "02-technical"
epic_folder: docs/2-MANAGEMENT/epics/current/02-technical/
stories_count: 15
stories_existing: 11 (02.1-02.11)
stories_new: 4 (02.12-02.15)
start_story: "02.1.products-crud-types"
adrs:
  - docs/1-BASELINE/architecture/decisions/ADR-002-bom-snapshot-pattern.md
  - docs/1-BASELINE/architecture/decisions/ADR-009-routing-level-costs.md
technical_notes: |
  - Foundation for Production module
  - ADR-009 routing costs fully integrated
  - BOM snapshot pattern at WO creation
  - Migrations 043-050 already applied
  - costing-service.ts implemented
dependencies:
  - Epic 01 (Settings): organizations, users, allergens, machines, production_lines
```

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-12-15 | Initial epic overview | ARCHITECT-AGENT |
| 2.0 | 2025-12-15 | Rewritten to match actual story files (02.1-02.11), added 4 new stories (02.12-02.15) | ARCHITECT-AGENT |
