# 02.3 - Product Allergens Declaration

**State:** ready
**Type:** frontend + backend
**Estimate:** M (medium story)
**Primary PRD:** `docs/1-BASELINE/product/modules/technical.md` (FR-2.4, FR-2.28)
**UX Wireframes:** TEC-010 (Allergen Management), TEC-012 (Allergen Warnings)

## Goal
Implement allergen declaration management for products with "Contains" and "May Contain" relation types, automatic inheritance from BOM ingredients, and allergen badge display in product list.

## Scope

**In scope**
- GET /api/technical/products/:id/allergens (list allergens for product)
- POST /api/technical/products/:id/allergens (add allergen declaration)
- DELETE /api/technical/products/:id/allergens/:allergenId (remove declaration)
- POST /api/technical/boms/:id/allergens (recalculate inheritance from BOM)
- Allergen tab section in Product Detail page
- Add Allergen modal with relation type selector (Contains/May Contain)
- Auto-inheritance: allergens propagate from BOM ingredients to parent product
- Manual override: user can add allergens not derived from BOM
- Allergen badges/icons in Product List (TEC-001)
- 14 EU allergens + custom allergens from Settings

**Out of scope**
- Full risk assessment form for "May Contain" (deferred to 02.4)
- Allergen label generation (TEC-012 - deferred to 02.5)
- Allergen history/audit trail UI (deferred)
- Evidence file upload for "May Contain" declarations
- Review date reminders (90-day cycle)
- Free From section management

## Dependencies
- **02.1** - Products CRUD (required for product detail page)
- **01a.x** - Settings allergens master data (allergens table seeded with EU 14)
- **02.4** - BOMs CRUD (required for inheritance calculation from BOM ingredients)

## Acceptance Criteria (Given/When/Then)

### Allergen List Display
- GIVEN user navigates to Product Detail and clicks "Allergens" tab, WHEN tab loads, THEN allergen declarations display within 500ms showing relation type (Contains/May Contain), allergen name, and source (AUTO/MANUAL).
- GIVEN product has BOM with ingredients declaring allergens, WHEN Allergens tab loads, THEN auto-inherited allergens display with "AUTO" badge and source ingredient names.
- GIVEN product has manually added allergens, WHEN Allergens tab loads, THEN manual allergens display with "MANUAL" badge.
- GIVEN product has no allergens declared, WHEN Allergens tab loads, THEN empty state shows "No Allergens Declared" with [+ Add Allergen] CTA.

### Add Allergen (Manual)
- GIVEN user clicks [+ Add Allergen], WHEN modal opens, THEN dropdown shows EU 14 allergens + custom allergens from Settings.
- GIVEN user selects allergen "Gluten" and relation type "Contains", WHEN [Add] clicked, THEN allergen saved with relation_type='contains' and source='manual'.
- GIVEN user selects allergen "Peanuts" and relation type "May Contain", WHEN modal displays, THEN reason field appears (required for may_contain).
- GIVEN user adds "May Contain" allergen without reason, WHEN [Add] clicked, THEN validation error "Reason is required for May Contain declarations" displays.
- GIVEN allergen already declared with same relation type, WHEN user tries to add duplicate, THEN error "Allergen already declared as Contains/May Contain" displays.

### Remove Allergen
- GIVEN user clicks [Remove] on manually added allergen, WHEN confirmation accepted, THEN allergen removed from product_allergens table.
- GIVEN user clicks [Remove] on auto-inherited allergen, WHEN action triggered, THEN warning "This allergen is inherited from BOM ingredient {name}. It will reappear on next recalculation unless removed from the ingredient." displays.
- GIVEN auto-inherited allergen removed, WHEN [Confirm] clicked, THEN allergen hidden (soft-delete or override flag) until BOM recalculation.

### Allergen Inheritance from BOM
- GIVEN product has active BOM with 3 ingredients, WHEN [Recalculate] button clicked, THEN system fetches allergens from all BOM ingredients.
- GIVEN ingredient "Wheat Flour" has allergen "Gluten" (contains), WHEN inheritance runs, THEN parent product inherits "Gluten" (contains) with source='auto'.
- GIVEN BOM ingredient added/updated, WHEN user returns to product Allergens tab, THEN notification banner shows "BOM changed. Allergens may need recalculation. [Recalculate]".
- GIVEN product has manual "May Contain" declarations, WHEN [Recalculate] runs, THEN manual declarations are preserved (not overwritten).
- GIVEN multi-level BOM (FG -> WIP -> RM), WHEN inheritance runs, THEN allergens from all levels aggregate to top-level product.

### Allergen Badges in Product List
- GIVEN product has allergens declared, WHEN Product List (TEC-001) renders, THEN allergen badges display next to product name.
- GIVEN product has "Contains" allergens, WHEN badge renders, THEN red badge with count shows (e.g., "3 allergens").
- GIVEN product has only "May Contain" allergens, WHEN badge renders, THEN orange badge displays.
- GIVEN product has no allergens, WHEN list renders, THEN no allergen badge displays.

### Permission Enforcement
- GIVEN user with VIEWER role, WHEN Allergens tab loads, THEN [+ Add Allergen] and [Remove] buttons hidden.
- GIVEN user without TECH_MANAGER permission, WHEN attempting to modify allergens, THEN API returns 403 Forbidden.

## Implementation Notes

### API Endpoints

```typescript
// GET /api/technical/products/:id/allergens
// Returns all allergen declarations for a product
interface ProductAllergensResponse {
  allergens: ProductAllergen[];
  inheritance_status: {
    last_calculated: string | null;
    bom_version: string | null;
    ingredients_count: number;
    needs_recalculation: boolean;
  };
}

interface ProductAllergen {
  id: string;
  allergen_id: string;
  allergen_code: string;
  allergen_name: string;
  relation_type: 'contains' | 'may_contain';
  source: 'auto' | 'manual';
  source_products?: { id: string; code: string; name: string }[]; // For auto-inherited
  reason?: string; // For may_contain
  created_at: string;
  created_by: string;
}

// POST /api/technical/products/:id/allergens
interface AddAllergenRequest {
  allergen_id: string;
  relation_type: 'contains' | 'may_contain';
  reason?: string; // Required if may_contain
}

// DELETE /api/technical/products/:id/allergens/:allergenId
// Query param: ?relation_type=contains|may_contain

// POST /api/technical/boms/:id/allergens
// Recalculates allergen inheritance from BOM
interface RecalculateAllergensResponse {
  inherited_allergens: ProductAllergen[];
  manual_allergens: ProductAllergen[]; // Preserved
  removed_count: number; // Auto allergens no longer valid
}
```

### Database
- Uses existing `product_allergens` table (migration 024)
- Schema: `product_id, allergen_id, relation_type, created_at, created_by, org_id`
- Primary key: `(product_id, allergen_id, relation_type)` - allows same allergen with different relation types
- Add `source` column: `source TEXT NOT NULL DEFAULT 'manual' CHECK (source IN ('auto', 'manual'))`
- Add `reason` column: `reason TEXT` (for may_contain)
- Add `source_product_ids` column: `source_product_ids UUID[]` (for auto-inherited tracking)

### Inheritance Algorithm
```typescript
async function calculateAllergenInheritance(productId: string, bomId: string): Promise<void> {
  // 1. Get active BOM for product
  const bom = await getBomWithItems(bomId);

  // 2. For each BOM item, fetch ingredient allergens (relation_type = 'contains')
  const inheritedAllergens = new Map<string, { allergenId: string; sourceProducts: string[] }>();

  for (const item of bom.items) {
    const ingredientAllergens = await getProductAllergens(item.component_id, 'contains');

    for (const allergen of ingredientAllergens) {
      if (inheritedAllergens.has(allergen.allergen_id)) {
        inheritedAllergens.get(allergen.allergen_id)!.sourceProducts.push(item.component_id);
      } else {
        inheritedAllergens.set(allergen.allergen_id, {
          allergenId: allergen.allergen_id,
          sourceProducts: [item.component_id],
        });
      }
    }
  }

  // 3. Upsert auto-inherited allergens (source = 'auto')
  // 4. Remove stale auto-inherited allergens not in current BOM
  // 5. Preserve manual allergens (source = 'manual')
}
```

### Frontend Components
- `ProductAllergenSection` - Main allergen tab content
- `AllergenList` - List of declared allergens with badges
- `AddAllergenModal` - Modal with allergen dropdown and relation type selector
- `AllergenBadge` - Badge component for product list (count + color)
- `InheritanceBanner` - Banner showing BOM inheritance status

### Services
- `allergen-service.ts` - Extended with product allergen operations
- `product-allergen-service.ts` - New service for inheritance calculation

### Validation (Zod)
```typescript
const addProductAllergenSchema = z.object({
  allergen_id: z.string().uuid('Invalid allergen'),
  relation_type: z.enum(['contains', 'may_contain']),
  reason: z.string().min(10, 'Reason must be at least 10 characters').max(500).optional(),
}).refine(
  (data) => data.relation_type !== 'may_contain' || (data.reason && data.reason.length >= 10),
  { message: 'Reason is required for May Contain declarations', path: ['reason'] }
);
```

### EU 14 Allergens Reference
| Code | Name | Icon |
|------|------|------|
| WHEAT | Gluten (Cereals) | wheat |
| SHELLFISH | Crustaceans | shrimp |
| EGGS | Eggs | egg |
| FISH | Fish | fish |
| PEANUTS | Peanuts | peanut |
| SOYBEANS | Soybeans | bean |
| MILK | Milk | milk |
| TREENUTS | Tree Nuts | nut |
| CELERY | Celery | leaf |
| MUSTARD | Mustard | seed |
| SESAME | Sesame | seed |
| SULPHITES | Sulphites | grape |
| LUPIN | Lupin | flower |
| MOLLUSCS | Molluscs | shell |

## Deliverables
- Migration to add `source`, `reason`, `source_product_ids` columns to `product_allergens`
- API routes for product allergen CRUD
- Allergen inheritance calculation function
- Product Allergen Section component with list/add/remove
- Add Allergen modal with validation
- Allergen badges in Product List
- Zod validation schemas
- Unit tests for inheritance algorithm
- Integration tests for API endpoints

## Definition of Done
- [ ] Allergen tab displays within 500ms for products with 20+ allergens
- [ ] Manual allergen add/remove works end-to-end
- [ ] Reason field required for "May Contain" declarations
- [ ] Auto-inheritance calculates correctly from multi-level BOM
- [ ] Manual allergens preserved during recalculation
- [ ] Allergen badges display correctly in Product List
- [ ] Duplicate allergen prevention works (same relation type)
- [ ] Permission checks hide/show UI elements correctly
- [ ] API returns 403 for unauthorized users
- [ ] All 14 EU allergens selectable in dropdown
- [ ] Unit tests cover inheritance algorithm (>90% coverage)
- [ ] Integration tests cover all API endpoints
