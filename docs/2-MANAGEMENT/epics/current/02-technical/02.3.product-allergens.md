# 02.3 - Product Allergens Declaration

**Priority**: P0 (MVP)
**Story Points**: M (Medium)
**Type**: backend + frontend

**State:** ready
**Estimate:** M (medium story)
**Primary PRD:** `docs/1-BASELINE/product/modules/technical.md` (FR-2.4, FR-2.28)
**UX Wireframes:** TEC-010 (Allergen Management), TEC-012 (Allergen Warnings)

## Goal
Implement allergen declaration management for products with "Contains" and "May Contain" relation types, automatic inheritance from BOM ingredients, and allergen badge display in product list.

## MVP Scope

This story implements Phase 0 (MVP) functionality only. Features listed in "Future Phases" are deferred to Phase 1+ and should be handled per Epic 02.0 "Future Feature Handling" guidance.

**MVP Includes**:
- Allergen master data (EU 14 allergens) - created in this story (migrations 052/053)
- Product allergen declaration (multi-select allergens)
- Allergen display on product details
- Allergen filtering in product list
- Basic "Contains" vs "May contain" declaration

**Deferred to Phase 1+**: See "Future Phases" section below.

## Scope

**In scope**
- GET /api/technical/products/:id/allergens (list allergens for product)
- POST /api/technical/products/:id/allergens (add allergen declaration)
- DELETE /api/technical/products/:id/allergens/:allergenId (remove declaration)
- POST /api/technical/boms/:id/allergens (recalculate inheritance from BOM)
- Allergen tab section in Product Detail page
- Add Allergen modal with relation type selector (Contains/May Contain)
- Auto-inheritance: allergens propagate from BOM ingredients to parent product
- Manual override: user can add allergens not derived from BOM
- Allergen badges/icons in Product List (TEC-001)
- 14 EU allergens (EU 14) seeded in this story; custom allergens UI deferred to Settings Phase 2
- **Create `allergens` table with EU 14 seed data (self-contained in this story)**
- **GET /api/v1/allergens (read-only allergen list for dropdowns)**

## Future Phases (Not in MVP)

### Phase 1
- **Custom allergens** - Organization-specific allergens beyond EU 14
- **Allergen thresholds** - Quantitative allergen levels (ppm/mg)
- **Cross-contamination tracking** - "Produced in facility that also processes..." declarations
- **Allergen icons/symbols** - Visual allergen indicators beyond text
- **Allergen audit trail** - Track when allergen declarations were added/changed

### Phase 2
- **Multi-region allergen standards** - US FDA allergens, Canada allergens, Australia/NZ, Japan
- **Allergen matrix reports** - Exportable allergen matrix for all products
- **Allergen label generation** - Auto-generate allergen labels for packaging
- **Allergen risk assessment** - Scoring system for allergen risk
- **Supplier allergen verification** - Track supplier CoA allergen declarations

### Deferred to Other Modules
- **BOM allergen inheritance** - Technical module story 02.5b (BOM Items Advanced)
- **Allergen label printing** - Shipping module (Epic 07)
- **Allergen testing results** - Quality module (Epic 06)

**Implementation**: See Epic 02.0 "Future Feature Handling" for how to handle Phase 1+ features in UI/API.

## Dependencies

### Cross-Epic Dependencies
- **02.1** - Products CRUD (products table must exist)
- **01.1** - Org Context + Base RLS (organizations, users tables)

### Master Data Created in This Story
This story creates the `allergens` table and seeds EU 14 allergens (previously deferred from Settings module). This makes Epic 02 self-sufficient for allergen functionality without waiting for full Settings implementation.

## Database Migration

### Migration 1: Create Allergens Table

**File**: `supabase/migrations/052_create_allergens_table.sql`

```sql
-- Create allergens table (EU 14 regulatory data)
CREATE TABLE allergens (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  code TEXT NOT NULL, -- A01-A14 (EU standard codes)
  name_en TEXT NOT NULL,
  name_pl TEXT,
  name_de TEXT,
  name_fr TEXT,
  icon TEXT, -- Optional icon identifier (e.g., 'wheat', 'milk')
  description TEXT,
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  created_by UUID REFERENCES users(id),
  updated_by UUID REFERENCES users(id),
  UNIQUE(org_id, code)
);

-- RLS Policies
ALTER TABLE allergens ENABLE ROW LEVEL SECURITY;

CREATE POLICY "allergens_org_isolation"
  ON allergens
  FOR ALL
  USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

-- Indexes
CREATE INDEX idx_allergens_org_id ON allergens(org_id);
CREATE INDEX idx_allergens_code ON allergens(code);

-- Updated timestamp trigger
-- NOTE: Uses set_updated_at_timestamp() created in the same migration.
CREATE TRIGGER set_allergens_updated_at
  BEFORE UPDATE ON allergens
  FOR EACH ROW
  EXECUTE FUNCTION set_updated_at_timestamp();
```

### Migration 2: Seed EU 14 Allergens

**File**: `supabase/migrations/053_seed_eu14_allergens.sql`

```sql
-- Seed EU 14 allergens for all existing organizations
-- This seed data runs per-organization via a function

CREATE OR REPLACE FUNCTION seed_allergens_for_org(target_org_id UUID, seed_user_id UUID)
RETURNS VOID AS $$
BEGIN
  INSERT INTO allergens (org_id, code, name_en, name_pl, icon, created_by, updated_by)
  VALUES
    (target_org_id, 'A01', 'Cereals containing gluten', 'Zboza zawierajace gluten', 'wheat', seed_user_id, seed_user_id),
    (target_org_id, 'A02', 'Crustaceans', 'Skorupiaki', 'shrimp', seed_user_id, seed_user_id),
    (target_org_id, 'A03', 'Eggs', 'Jaja', 'egg', seed_user_id, seed_user_id),
    (target_org_id, 'A04', 'Fish', 'Ryby', 'fish', seed_user_id, seed_user_id),
    (target_org_id, 'A05', 'Peanuts', 'Orzeszki ziemne', 'peanut', seed_user_id, seed_user_id),
    (target_org_id, 'A06', 'Soybeans', 'Soja', 'soy', seed_user_id, seed_user_id),
    (target_org_id, 'A07', 'Milk', 'Mleko', 'milk', seed_user_id, seed_user_id),
    (target_org_id, 'A08', 'Nuts', 'Orzechy', 'tree-nut', seed_user_id, seed_user_id),
    (target_org_id, 'A09', 'Celery', 'Seler', 'celery', seed_user_id, seed_user_id),
    (target_org_id, 'A10', 'Mustard', 'Gorczyca', 'mustard', seed_user_id, seed_user_id),
    (target_org_id, 'A11', 'Sesame seeds', 'Nasiona sezamu', 'sesame', seed_user_id, seed_user_id),
    (target_org_id, 'A12', 'Sulphur dioxide and sulphites', 'Dwutlenek siarki i siarczyny', 'sulfite', seed_user_id, seed_user_id),
    (target_org_id, 'A13', 'Lupin', 'Lubin', 'lupin', seed_user_id, seed_user_id),
    (target_org_id, 'A14', 'Molluscs', 'Mieczaki', 'mollusk', seed_user_id, seed_user_id)
  ON CONFLICT (org_id, code) DO NOTHING;
END;
$$ LANGUAGE plpgsql;

-- Seed for all existing orgs (run once during migration)
DO $$
DECLARE
  org RECORD;
  admin_user_id UUID;
BEGIN
  FOR org IN SELECT id FROM organizations LOOP
    -- Get first admin/owner user for this org
    SELECT id INTO admin_user_id
    FROM users
    WHERE org_id = org.id
    ORDER BY created_at ASC
    LIMIT 1;

    IF admin_user_id IS NOT NULL THEN
      PERFORM seed_allergens_for_org(org.id, admin_user_id);
    END IF;
  END LOOP;
END $$;

-- Note: For new orgs created after this migration, call seed_allergens_for_org()
-- in the organization creation trigger or onboarding flow
```

**Rationale**:
- Allergens are static EU regulatory data (14 mandatory allergens)
- No Settings UI needed initially - just the table with seed data
- Each organization gets their own copy (multi-tenant pattern)
- Future Settings UI (Epic 01 Phase 2) can manage custom allergens

## Acceptance Criteria (Given/When/Then)

### Allergen List Display
- GIVEN user navigates to Product Detail and clicks "Allergens" tab, WHEN tab loads, THEN allergen declarations display within 500ms showing relation type (Contains/May Contain), allergen name, and source (AUTO/MANUAL).
- GIVEN product has BOM with ingredients declaring allergens, WHEN Allergens tab loads, THEN auto-inherited allergens display with "AUTO" badge and source ingredient names.
- GIVEN product has manually added allergens, WHEN Allergens tab loads, THEN manual allergens display with "MANUAL" badge.
- GIVEN product has no allergens declared, WHEN Allergens tab loads, THEN empty state shows "No Allergens Declared" with [+ Add Allergen] CTA.

### Add Allergen (Manual)
- GIVEN user clicks [+ Add Allergen], WHEN modal opens, THEN dropdown shows EU 14 allergens + custom allergens from Settings.
- GIVEN user selects allergen "Gluten" and relation type "Contains", WHEN [Add] clicked, THEN allergen saved with relation_type='contains' and source='manual'.
- GIVEN user selects allergen "Peanuts" and relation type "May Contain", WHEN modal displays, THEN reason field appears (required for may_contain).
- GIVEN user adds "May Contain" allergen without reason, WHEN [Add] clicked, THEN validation error "Reason is required for May Contain declarations" displays.
- GIVEN allergen already declared with same relation type, WHEN user tries to add duplicate, THEN error "Allergen already declared as Contains/May Contain" displays.

### Remove Allergen
- GIVEN user clicks [Remove] on manually added allergen, WHEN confirmation accepted, THEN allergen removed from product_allergens table.
- GIVEN user clicks [Remove] on auto-inherited allergen, WHEN action triggered, THEN warning "This allergen is inherited from BOM ingredient {name}. It will reappear on next recalculation unless removed from the ingredient." displays.
- GIVEN auto-inherited allergen removed, WHEN [Confirm] clicked, THEN allergen hidden (soft-delete or override flag) until BOM recalculation.

### Allergen Inheritance from BOM
- GIVEN product has active BOM with 3 ingredients, WHEN [Recalculate] button clicked, THEN system fetches allergens from all BOM ingredients.
- GIVEN ingredient "Wheat Flour" has allergen "Gluten" (contains), WHEN inheritance runs, THEN parent product inherits "Gluten" (contains) with source='auto'.
- GIVEN BOM ingredient added/updated, WHEN user returns to product Allergens tab, THEN notification banner shows "BOM changed. Allergens may need recalculation. [Recalculate]".
- GIVEN product has manual "May Contain" declarations, WHEN [Recalculate] runs, THEN manual declarations are preserved (not overwritten).
- GIVEN multi-level BOM (FG -> WIP -> RM), WHEN inheritance runs, THEN allergens from all levels aggregate to top-level product.

### Allergen Badges in Product List
- GIVEN product has allergens declared, WHEN Product List (TEC-001) renders, THEN allergen badges display next to product name.
- GIVEN product has "Contains" allergens, WHEN badge renders, THEN red badge with count shows (e.g., "3 allergens").
- GIVEN product has only "May Contain" allergens, WHEN badge renders, THEN orange badge displays.
- GIVEN product has no allergens, WHEN list renders, THEN no allergen badge displays.

### Allergens Seed Data
- GIVEN new organization created, WHEN allergens migration runs, THEN 14 allergens (A01-A14) exist for that org.
- GIVEN allergens seeded, WHEN checking unique constraint, THEN allergens.code are unique per org.
- GIVEN User A from Org A, WHEN they request allergens list, THEN RLS prevents cross-org access.

### Permission Enforcement
- GIVEN user with VIEWER role, WHEN Allergens tab loads, THEN [+ Add Allergen] and [Remove] buttons hidden.
- GIVEN user without Technical write permission (e.g., VIEWER), WHEN attempting to modify allergens, THEN API returns 403 Forbidden.

### AC-3.X: Future Features Handling (Phase 1+)

**GIVEN** user is editing product allergens
**WHEN** MVP is active (Phase 0)
**THEN** the following Phase 1+ features are HIDDEN:
  - "Add Custom Allergen" button
  - "Allergen Threshold" input fields (ppm/mg)
  - "Cross-Contamination" section
  - "Allergen Risk Score" indicator
  - "Generate Label" button

**Developer Implementation** (per Epic 02.0 guidance):

**Hide completely** (Recommended):
```typescript
{/* Phase 1: Custom Allergens
<Button onClick={handleAddCustomAllergen}>
  <Plus className="w-4 h-4 mr-2" />
  Add Custom Allergen
</Button>
*/}

{/* Phase 1: Allergen Thresholds
<div className="space-y-2">
  <Label>Allergen Threshold (ppm)</Label>
  <Input type="number" placeholder="Enter threshold" />
</div>
*/}

{/* Phase 2: Multi-Region Standards
<Select>
  <SelectTrigger>
    <SelectValue placeholder="Select allergen standard" />
  </SelectTrigger>
  <SelectContent>
    <SelectItem value="EU-14">EU 14 Allergens</SelectItem>
    <SelectItem value="US-FDA">US FDA Allergens (Coming Soon)</SelectItem>
    <SelectItem value="CA">Canada Allergens (Coming Soon)</SelectItem>
  </SelectContent>
</Select>
*/}
```

**Show as Coming Soon** (Alternative):
```typescript
<Tooltip content="Custom allergens available in Phase 1">
  <Button disabled className="opacity-50">
    <Lock className="w-4 h-4 mr-2" />
    Add Custom Allergen (Phase 1)
  </Button>
</Tooltip>
```

**API Endpoints** (Phase 1 - return 501 in MVP):
```typescript
// Phase 1 - Not implemented in MVP
router.post('/api/v1/allergens', (req, res) => {
  res.status(501).json({
    error: 'Not Implemented',
    message: 'Custom allergen creation available in Phase 1',
    availableIn: 'v1.1 (Q2 2025)'
  });
});
```

**Validation**:
- Product allergen form shows only EU 14 allergens (from migrations 052/053)
- No threshold/ppm fields visible
- Clean multi-select dropdown without custom allergen option

## Implementation Notes

### API Endpoints

```typescript
// GET /api/v1/allergens
// Returns: List of allergens for current org (read-only for dropdowns)
interface AllergensListResponse {
  allergens: Allergen[];
}

interface Allergen {
  id: string;
  code: string;      // A01-A14
  name_en: string;
  name_pl: string;
  icon: string;
  is_active: boolean;
}

// GET /api/technical/products/:id/allergens
// Returns all allergen declarations for a product
interface ProductAllergensResponse {
  allergens: ProductAllergen[];
  inheritance_status: {
    last_calculated: string | null;
    bom_version: string | null;
    ingredients_count: number;
    needs_recalculation: boolean;
  };
}

interface ProductAllergen {
  id: string;
  allergen_id: string;
  allergen_code: string;
  allergen_name: string;
  relation_type: 'contains' | 'may_contain';
  source: 'auto' | 'manual';
  source_products?: { id: string; code: string; name: string }[]; // For auto-inherited
  reason?: string; // For may_contain
  created_at: string;
  created_by: string;
}

// POST /api/technical/products/:id/allergens
interface AddAllergenRequest {
  allergen_id: string;
  relation_type: 'contains' | 'may_contain';
  reason?: string; // Required if may_contain
}

// DELETE /api/technical/products/:id/allergens/:allergenId
// Query param: ?relation_type=contains|may_contain

// POST /api/technical/boms/:id/allergens
// Recalculates allergen inheritance from BOM
interface RecalculateAllergensResponse {
  inherited_allergens: ProductAllergen[];
  manual_allergens: ProductAllergen[]; // Preserved
  removed_count: number; // Auto allergens no longer valid
}
```

### Database
- Uses existing `product_allergens` table (migration 024)
- Schema: `product_id, allergen_id, relation_type, created_at, created_by, org_id`
- Primary key: `(product_id, allergen_id, relation_type)` - allows same allergen with different relation types
- Add `source` column: `source TEXT NOT NULL DEFAULT 'manual' CHECK (source IN ('auto', 'manual'))`
- Add `reason` column: `reason TEXT` (for may_contain)
- Add `source_product_ids` column: `source_product_ids UUID[]` (for auto-inherited tracking)
- **New `allergens` table** (created in migrations 052, 053)

### Inheritance Algorithm
```typescript
async function calculateAllergenInheritance(productId: string, bomId: string): Promise<void> {
  // 1. Get active BOM for product
  const bom = await getBomWithItems(bomId);

  // 2. For each BOM item, fetch ingredient allergens (relation_type = 'contains')
  const inheritedAllergens = new Map<string, { allergenId: string; sourceProducts: string[] }>();

  for (const item of bom.items) {
    const ingredientAllergens = await getProductAllergens(item.component_id, 'contains');

    for (const allergen of ingredientAllergens) {
      if (inheritedAllergens.has(allergen.allergen_id)) {
        inheritedAllergens.get(allergen.allergen_id)!.sourceProducts.push(item.component_id);
      } else {
        inheritedAllergens.set(allergen.allergen_id, {
          allergenId: allergen.allergen_id,
          sourceProducts: [item.component_id],
        });
      }
    }
  }

  // 3. Upsert auto-inherited allergens (source = 'auto')
  // 4. Remove stale auto-inherited allergens not in current BOM
  // 5. Preserve manual allergens (source = 'manual')
}
```

### Frontend Components
- `ProductAllergenSection` - Main allergen tab content
- `AllergenList` - List of declared allergens with badges
- `AddAllergenModal` - Modal with allergen dropdown and relation type selector
- `AllergenBadge` - Badge component for product list (count + color)
- `InheritanceBanner` - Banner showing BOM inheritance status

### Services
- `allergen-service.ts` - Extended with product allergen operations
- `product-allergen-service.ts` - New service for inheritance calculation

### Validation (Zod)
```typescript
const addProductAllergenSchema = z.object({
  allergen_id: z.string().uuid('Invalid allergen'),
  relation_type: z.enum(['contains', 'may_contain']),
  reason: z.string().min(10, 'Reason must be at least 10 characters').max(500).optional(),
}).refine(
  (data) => data.relation_type !== 'may_contain' || (data.reason && data.reason.length >= 10),
  { message: 'Reason is required for May Contain declarations', path: ['reason'] }
);
```

### EU 14 Allergens Reference
| Code | Name | Icon |
|------|------|------|
| A01 | Gluten (Cereals) | wheat |
| A02 | Crustaceans | shrimp |
| A03 | Eggs | egg |
| A04 | Fish | fish |
| A05 | Peanuts | peanut |
| A06 | Soybeans | soy |
| A07 | Milk | milk |
| A08 | Tree Nuts | tree-nut |
| A09 | Celery | celery |
| A10 | Mustard | mustard |
| A11 | Sesame | sesame |
| A12 | Sulphites | sulfite |
| A13 | Lupin | lupin |
| A14 | Molluscs | mollusk |

## Deliverables
- **Migration 052: Create `allergens` table**
- **Migration 053: Seed EU 14 allergens function**
- **GET /api/v1/allergens endpoint (read-only)**
- Migration to add `source`, `reason`, `source_product_ids` columns to `product_allergens`
- API routes for product allergen CRUD
- Allergen inheritance calculation function
- Product Allergen Section component with list/add/remove
- Add Allergen modal with validation
- Allergen badges in Product List
- Zod validation schemas
- Unit tests for inheritance algorithm
- Integration tests for API endpoints

## Test Strategy

### Test: Allergens Seeded
- GIVEN new organization created
- WHEN allergens migration runs
- THEN 14 allergens (A01-A14) exist for that org
- AND allergens.code are unique per org
- AND RLS prevents cross-org access

### Test: Allergen Dropdown Population
- GIVEN allergens table seeded for org
- WHEN Add Allergen modal opens
- THEN dropdown shows all 14 EU allergens sorted by code
- AND each allergen shows code, name_en, and icon

## Definition of Done
- [ ] Allergens table created with RLS policy
- [ ] EU 14 allergens seeded for all organizations
- [ ] GET /api/v1/allergens returns allergen list
- [ ] Allergen tab displays within 500ms for products with 20+ allergens
- [ ] Manual allergen add/remove works end-to-end
- [ ] Reason field required for "May Contain" declarations
- [ ] Auto-inheritance calculates correctly from multi-level BOM
- [ ] Manual allergens preserved during recalculation
- [ ] Allergen badges display correctly in Product List
- [ ] Duplicate allergen prevention works (same relation type)
- [ ] Permission checks hide/show UI elements correctly
- [ ] API returns 403 for unauthorized users
- [ ] All 14 EU allergens selectable in dropdown
- [ ] Phase 1+ features (custom allergens, thresholds, multi-region) hidden per Epic 02.0 guidance
- [ ] Unit tests cover inheritance algorithm (>90% coverage)
- [ ] Integration tests cover all API endpoints
