# 02.1 - Products CRUD + Types

**State:** ready
**Type:** frontend + backend
**Estimate:** M
**Primary PRD:** `docs/1-BASELINE/product/modules/technical.md` (FR-2.1, FR-2.5, FR-2.6, FR-2.7, FR-2.8, FR-2.13, FR-2.15)
**UX Wireframes:** TEC-001 (Products List), TEC-002 (Product Modal)

## Goal
Implement basic product CRUD operations with product types (raw material, WIP, finished goods, packaging, byproduct), status management (active/inactive/discontinued), and technical settings for manufacturing.

## Scope

**In scope**
- Product list page with DataTable, filters, search, and pagination
- Create/Edit product modal with full validation
- Product types dropdown (RM, WIP, FG, PKG, BP)
- Product status management (active/inactive/discontinued)
- SKU (code) immutability enforcement after creation
- Technical settings: base UoM, shelf life, expiry policy, storage conditions
- Procurement fields: lead time days, MOQ (per ADR-010)
- Stock control fields: min stock, max stock
- **Standard price field (std_price) for costing baseline (FR-2.13)**
- **Cost per unit validation for RM/PKG products with warning (FR-2.15)**
- API endpoints: GET/POST/PUT/DELETE /api/technical/products
- Zod validation schemas for create/update operations
- Product service layer with business logic

**Out of scope**
- Product versioning and version history (Story 02.2)
- Allergen declaration and management (Story 02.3)
- Product image upload (Phase 2E-1)
- Product clone/duplicate (Phase 2E-1)
- Barcode generation (Future)
- Categories and tags (Future)
- Supplier assignment (handled in Planning module)
- BOM management (Story 02.5+)

## Dependencies
- Story 01.1 (Org Context + Base RLS) - Required for org_id context and RLS patterns

## Acceptance Criteria (Given/When/Then)

### Product Creation
- GIVEN a user with create permissions, WHEN they submit a valid product form, THEN a new product is created with version 1 and status "active".
- GIVEN a user creating a product, WHEN they enter an SKU that already exists in their org, THEN an error "SKU already exists" is displayed and form submission is blocked.
- GIVEN a user creating a product, WHEN they select a product type (RM/WIP/FG/PKG/BP), THEN the product is saved with that type which becomes immutable.
- GIVEN required fields (code, name, product_type_id, base_uom), WHEN any is missing, THEN validation errors are shown and form cannot be submitted.

### Product Editing
- GIVEN an existing product, WHEN a user opens the edit modal, THEN the SKU field is locked and cannot be modified.
- GIVEN an existing product, WHEN a user opens the edit modal, THEN the product type field is locked and cannot be modified.
- GIVEN a user updating a product, WHEN they save changes, THEN the updated_at timestamp is updated.
- GIVEN a user updating a product, WHEN they change the status to "inactive", THEN the product status is updated (warning shown if active BOMs exist).

### Product Listing
- GIVEN products exist in the organization, WHEN a user visits /technical/products, THEN products are displayed in a paginated DataTable (20 per page).
- GIVEN a user on the products list, WHEN they enter a search term, THEN products are filtered by SKU (code) or name (real-time, min 2 chars).
- GIVEN a user on the products list, WHEN they select a product type filter, THEN only products of that type are displayed.
- GIVEN a user on the products list, WHEN they select a status filter, THEN only products with that status are displayed.
- GIVEN a user on the products list, WHEN they click column headers, THEN products are sorted by that column (asc/desc toggle).

### Product Deletion
- GIVEN a product with no BOMs, work orders, or inventory, WHEN a user deletes it, THEN the product is soft-deleted and removed from the list.
- GIVEN a product referenced by BOMs or inventory, WHEN a user attempts to delete it, THEN an error is displayed and deletion is blocked.

### Product Types
- GIVEN the system is initialized, WHEN product types are queried, THEN default types (RM, WIP, FG, PKG, BP) are available.
- GIVEN a user creating a product, WHEN they select a product type, THEN the type badge is displayed correctly with color coding.

### Technical Settings
- GIVEN a product with expiry_policy set to "fixed" or "rolling", WHEN shelf_life_days is empty, THEN validation requires shelf_life_days to be filled.
- GIVEN a product with min_stock and max_stock, WHEN min_stock > max_stock, THEN validation error is displayed on both fields.

### Standard Price (FR-2.13)
- GIVEN a user creating or editing a product, WHEN the form loads, THEN the std_price field is displayed in the Costing section.
- GIVEN a user enters std_price, WHEN the value is negative, THEN validation error "Standard price cannot be negative" is displayed.
- GIVEN a user enters std_price, WHEN the value has more than 4 decimal places, THEN validation error "Maximum 4 decimal places allowed" is displayed.
- GIVEN a product with std_price set, WHEN viewing the product list, THEN the standard price is visible in the table (optional column).

### Cost Validation for RM/PKG (FR-2.15)
- GIVEN a user creating a product with type RM (Raw Material), WHEN cost_per_unit is left empty, THEN a warning "Cost per unit recommended for raw materials" is displayed (non-blocking).
- GIVEN a user creating a product with type PKG (Packaging), WHEN cost_per_unit is left empty, THEN a warning "Cost per unit recommended for packaging materials" is displayed (non-blocking).
- GIVEN a user creating a product with type FG or WIP, WHEN cost_per_unit is empty, THEN no warning is displayed (cost calculated from BOM).
- GIVEN a product of type RM/PKG with missing cost_per_unit, WHEN the product is used in a BOM cost calculation, THEN the BOM cost calculation shows a warning indicating missing ingredient costs.

### Obsolete Product Warning (FR-2.15 Extended)
- GIVEN a product with active BOMs, WHEN the user attempts to mark it as "discontinued" or "obsolete", THEN a warning dialog displays listing the affected BOMs.
- GIVEN the warning dialog is shown, WHEN the user confirms the action, THEN the product status is updated and the dialog closes.
- GIVEN the warning dialog is shown, WHEN the user cancels the action, THEN the product status remains unchanged.

### API Validation
- GIVEN an API request with invalid GTIN-14, WHEN submitted, THEN a 400 error with validation message is returned.
- GIVEN an API request with lead_time_days < 0, WHEN submitted, THEN a 400 error is returned.
- GIVEN an API request with moq <= 0, WHEN submitted, THEN a 400 error is returned.

### Multi-tenancy
- GIVEN User A from Org A, WHEN they request products, THEN only Org A products are returned.
- GIVEN User A from Org A, WHEN they request Product X from Org B by ID, THEN 404 Not Found is returned (not 403).

## Implementation Notes

### API Endpoints

```
GET    /api/technical/products                 - List products (paginated, filtered)
POST   /api/technical/products                 - Create product
GET    /api/technical/products/:id             - Get product by ID
PUT    /api/technical/products/:id             - Update product
DELETE /api/technical/products/:id             - Soft delete product
GET    /api/technical/product-types            - List product types
```

**Query Parameters (List):**
- `search` - Filter by code or name (min 2 chars)
- `type` - Filter by product_type_id
- `status` - Filter by status (active/inactive/discontinued)
- `sort` - Sort field (code, name, type, version, created_at)
- `order` - Sort order (asc/desc)
- `page` - Page number (default 1)
- `limit` - Items per page (default 20, max 100)

### Database

**Tables Used:**
- `products` - Main product table with all fields
- `product_types` - Product type reference (seeded)

**Key Constraints:**
- UNIQUE(org_id, code) - SKU unique per organization
- CHECK(expiry_policy IN ('fixed', 'rolling', 'none'))
- CHECK(status IN ('active', 'inactive', 'discontinued'))
- CHECK(lead_time_days IS NULL OR lead_time_days >= 0)
- CHECK(moq IS NULL OR moq > 0)
- CHECK(min_stock IS NULL OR min_stock >= 0)
- CHECK(max_stock IS NULL OR max_stock >= 0)
- CHECK(std_price IS NULL OR std_price >= 0)
- CHECK(cost_per_unit IS NULL OR cost_per_unit >= 0)

**Cost Validation Trigger (migration 048):**
```sql
-- Trigger to warn when RM/PKG products have no cost_per_unit
CREATE OR REPLACE FUNCTION warn_missing_cost_per_unit()
RETURNS TRIGGER AS $$
BEGIN
  -- Log warning for RM/PKG without cost_per_unit
  IF (SELECT code FROM product_types WHERE id = NEW.product_type_id) IN ('RM', 'PKG')
     AND NEW.cost_per_unit IS NULL THEN
    RAISE WARNING 'Product % (%) has no cost_per_unit defined', NEW.code,
      (SELECT code FROM product_types WHERE id = NEW.product_type_id);
  END IF;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;
```

**RLS Policies:**
```sql
-- Products: Org isolation
CREATE POLICY "products_org_isolation" ON products
FOR SELECT USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

CREATE POLICY "products_write" ON products
FOR ALL USING (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
);
```

### Frontend Components

**Pages:**
- `app/(authenticated)/technical/products/page.tsx` - Products list page

**Components:**
- `components/technical/products/ProductsDataTable.tsx` - Main data table with filtering
- `components/technical/products/ProductModal.tsx` - Create/Edit modal (TEC-002)
- `components/technical/products/ProductTypeSelect.tsx` - Type dropdown with badges
- `components/technical/products/ProductStatusBadge.tsx` - Status badge component
- `components/technical/products/ProductTypeBadge.tsx` - Type badge component (color-coded)
- `components/technical/products/ProductFilters.tsx` - Search and filter bar
- `components/technical/products/ProductActions.tsx` - Row actions menu
- `components/technical/products/ProductPriceInput.tsx` - Currency input for std_price
- `components/technical/products/CostWarningBanner.tsx` - Warning banner for RM/PKG without cost

**Shared Components Used:**
- `DataTable` (ShadCN)
- `Dialog/DialogContent` (ShadCN) - for modal
- `Select` (ShadCN) - for dropdowns
- `Input` (ShadCN) - for form fields
- `Badge` (ShadCN) - for status/type badges
- `Button` (ShadCN)
- `Form` (React Hook Form + Zod)
- `Alert` (ShadCN) - for cost warnings

### Services

**Product Service:** `lib/services/product-service.ts`
```typescript
interface ProductService {
  list(params: ProductListParams): Promise<PaginatedResult<Product>>;
  getById(id: string): Promise<Product | null>;
  create(data: CreateProductInput): Promise<Product>;
  update(id: string, data: UpdateProductInput): Promise<Product>;
  delete(id: string): Promise<void>;
  checkSkuExists(sku: string): Promise<boolean>;
  getActiveBOMsForProduct(productId: string): Promise<BOM[]>; // For obsolete warning
}
```

**Product Types Service:** `lib/services/product-type-service.ts`
```typescript
interface ProductTypeService {
  list(): Promise<ProductType[]>;
  getById(id: string): Promise<ProductType | null>;
}
```

### Validation Schemas

**Location:** `lib/validation/product.ts`

```typescript
// Create schema
const createProductSchema = z.object({
  code: z.string().min(2).max(50).regex(/^[A-Z0-9-]+$/),
  name: z.string().min(2).max(255),
  description: z.string().max(1000).nullable().optional(),
  product_type_id: z.string().uuid(),
  base_uom: z.string().min(1),
  barcode: z.string().max(100).nullable().optional(),
  gtin: z.string().length(14).nullable().optional(), // GTIN-14 validation
  category_id: z.string().uuid().nullable().optional(),
  lead_time_days: z.number().int().min(0).max(365).default(7),
  moq: z.number().positive().nullable().optional(),
  min_stock: z.number().min(0).nullable().optional(),
  max_stock: z.number().min(0).nullable().optional(),
  expiry_policy: z.enum(['fixed', 'rolling', 'none']).default('none'),
  shelf_life_days: z.number().int().min(1).max(3650).nullable().optional(),
  storage_conditions: z.string().max(500).nullable().optional(),
  status: z.enum(['active', 'inactive', 'discontinued']).default('active'),
  // FR-2.13: Standard price
  std_price: z.number()
    .min(0, "Standard price cannot be negative")
    .refine(val => {
      if (val === null || val === undefined) return true;
      const decimals = (val.toString().split('.')[1] || '').length;
      return decimals <= 4;
    }, "Maximum 4 decimal places allowed")
    .nullable()
    .optional(),
  // FR-2.15: Cost per unit for RM/PKG
  cost_per_unit: z.number()
    .min(0, "Cost per unit cannot be negative")
    .refine(val => {
      if (val === null || val === undefined) return true;
      const decimals = (val.toString().split('.')[1] || '').length;
      return decimals <= 4;
    }, "Maximum 4 decimal places allowed")
    .nullable()
    .optional(),
}).refine(data => {
  // If expiry policy is set, shelf_life_days is required
  if (data.expiry_policy !== 'none' && !data.shelf_life_days) {
    return false;
  }
  return true;
}, { message: "Shelf life is required when expiry policy is set" })
.refine(data => {
  // min_stock <= max_stock
  if (data.min_stock && data.max_stock && data.min_stock > data.max_stock) {
    return false;
  }
  return true;
}, { message: "Minimum stock cannot exceed maximum stock" });

// Update schema (code and product_type_id are readonly)
const updateProductSchema = createProductSchema.omit({
  code: true,
  product_type_id: true
}).partial();
```

### Type Definitions

**Location:** `lib/types/product.ts`

```typescript
type ProductType = 'RM' | 'WIP' | 'FG' | 'PKG' | 'BP';
type ProductStatus = 'active' | 'inactive' | 'discontinued';
type ExpiryPolicy = 'fixed' | 'rolling' | 'none';

interface Product {
  id: string;
  org_id: string;
  code: string;
  name: string;
  description: string | null;
  product_type_id: string;
  product_type?: ProductTypeRef;
  base_uom: string;
  barcode: string | null;
  gtin: string | null;
  category_id: string | null;
  lead_time_days: number;
  moq: number | null;
  min_stock: number | null;
  max_stock: number | null;
  expiry_policy: ExpiryPolicy;
  shelf_life_days: number | null;
  storage_conditions: string | null;
  status: ProductStatus;
  version: number;
  std_price: number | null;       // FR-2.13
  cost_per_unit: number | null;   // FR-2.15
  created_at: string;
  updated_at: string;
  created_by: string;
  updated_by: string;
}

interface ProductTypeRef {
  id: string;
  code: string;
  name: string;
  is_default: boolean;
  is_active: boolean;
}
```

### Product Type Badge Colors

| Type | Code | Color | TailwindCSS |
|------|------|-------|-------------|
| Raw Material | RM | Blue | `bg-blue-100 text-blue-800` |
| Work in Progress | WIP | Yellow | `bg-yellow-100 text-yellow-800` |
| Finished Goods | FG | Green | `bg-green-100 text-green-800` |
| Packaging | PKG | Purple | `bg-purple-100 text-purple-800` |
| Byproduct | BP | Orange | `bg-orange-100 text-orange-800` |

### Product Status Badge Colors

| Status | Color | TailwindCSS |
|--------|-------|-------------|
| Active | Green | `bg-green-100 text-green-800` |
| Inactive | Gray | `bg-gray-100 text-gray-800` |
| Discontinued | Red | `bg-red-100 text-red-800` |

### Cost Warning UI Pattern

When creating/editing RM or PKG products without cost_per_unit:

```tsx
{/* FR-2.15: Cost warning for RM/PKG */}
{(productType === 'RM' || productType === 'PKG') && !costPerUnit && (
  <Alert variant="warning" className="mt-4">
    <AlertTriangle className="h-4 w-4" />
    <AlertDescription>
      Cost per unit is recommended for {productType === 'RM' ? 'raw materials' : 'packaging'}.
      BOM cost calculations will be incomplete without this value.
    </AlertDescription>
  </Alert>
)}
```

## Deliverables

- [ ] Products list page at `/technical/products`
- [ ] ProductsDataTable component with sorting, filtering, pagination
- [ ] ProductModal component (create/edit modes)
- [ ] ProductTypeSelect component with badge colors
- [ ] ProductStatusBadge and ProductTypeBadge components
- [ ] ProductFilters component (search + dropdowns)
- [ ] ProductPriceInput component for std_price field (FR-2.13)
- [ ] CostWarningBanner component for RM/PKG without cost (FR-2.15)
- [ ] Product service (`lib/services/product-service.ts`)
- [ ] Product type service (`lib/services/product-type-service.ts`)
- [ ] Zod validation schemas (`lib/validation/product.ts`)
- [ ] Type definitions (`lib/types/product.ts`)
- [ ] API routes: GET/POST /api/technical/products
- [ ] API routes: GET/PUT/DELETE /api/technical/products/[id]
- [ ] API route: GET /api/technical/product-types
- [ ] RLS policies for products table
- [ ] Seed data for product_types table

## Definition of Done

- [ ] All CRUD operations work correctly (create, read, update, delete)
- [ ] SKU uniqueness enforced at API and database level
- [ ] SKU and product type immutable after creation
- [ ] Product type badges display with correct colors
- [ ] Status badges display with correct colors
- [ ] Search filters products by code/name (real-time, debounced)
- [ ] Type and status filters work correctly
- [ ] Pagination works (20 items per page default)
- [ ] Sorting works on all sortable columns
- [ ] Form validation displays inline errors
- [ ] GTIN-14 validation with check digit algorithm
- [ ] Lead time and MOQ validation (per ADR-010)
- [ ] Min/max stock validation (min <= max)
- [ ] Shelf life required when expiry policy is set
- [ ] **std_price field displayed and validates correctly (FR-2.13)**
- [ ] **cost_per_unit warning shown for RM/PKG products (FR-2.15)**
- [ ] **Obsolete product warning shows affected BOMs (FR-2.15)**
- [ ] RLS enforces org isolation
- [ ] Cross-tenant access returns 404 (not 403)
- [ ] Unit tests for product service (coverage >= 80%)
- [ ] Integration tests for API endpoints
- [ ] E2E tests for product CRUD flow
- [ ] Loading states displayed during API calls
- [ ] Error states handled gracefully with retry option
- [ ] Empty state shown when no products exist
- [ ] Toast notifications on success/error
- [ ] Accessibility: keyboard navigation, ARIA labels, focus management
