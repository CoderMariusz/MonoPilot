# Epic 02 Test Strategy - Technical Module

**Epic ID:** 02
**Module:** Technical (Products, BOMs, Routings)
**Status:** Draft
**Last Updated:** 2025-12-15
**PRD Reference:** `docs/1-BASELINE/product/modules/technical.md`
**Architecture Reference:** `docs/1-BASELINE/architecture/modules/technical.md`

---

## Overview

Test strategy for Epic 02 - Technical Module covering product lifecycle management, Bill of Materials, routing operations, traceability, costing, and nutrition. This module is foundational for Production and Warehouse modules.

**Key Testing Principles:**
- **Data Integrity First**: BOM date overlap prevention, allergen inheritance accuracy
- **Cost Calculation Accuracy**: Material + labor + routing costs must be precise
- **Traceability Completeness**: Forward/backward traces must be exhaustive
- **Security**: RLS enforcement on all 17+ tables
- **TDD Workflow**: RED (failing tests) -> GREEN (pass) -> REFACTOR

---

## Prerequisites

### External Dependencies

**IMPORTANT**: All integration tests in Epic 02 require **Epic 01.1 (Org Context + Base RLS)** to be implemented first. This story provides:
- Organization context setup (org_id injection)
- Base RLS policies for multi-tenant isolation
- Auth helper utilities for test user setup

Without 01.1, RLS isolation tests will not function correctly, and multi-tenant assertions will fail.

**Test Setup Requirements:**
1. Ensure 01.1 is deployed to test environment
2. Use test helpers from 01.1 for org/user context switching
3. All fixtures must include valid org_id values

---

## Test Scope

### In Scope (P0 - 20 Stories)

| Story | Feature | Coverage Target |
|-------|---------|-----------------|
| 02.1 | Product CRUD + versioning | 85% |
| 02.2 | Product allergen declaration | 85% |
| 02.3 | Product types + technical settings | 80% |
| 02.4 | Materials list and modal | 80% |
| 02.5 | BOM CRUD + date validity | 90% |
| 02.6 | BOM items + operation assignment | 90% |
| 02.7 | BOM clone and compare | 80% |
| 02.8 | BOM alternatives + conditionals | 85% |
| 02.9 | Routing CRUD + code | 85% |
| 02.10 | Routing operations | 85% |
| 02.11 | Routing cost configuration | 90% |
| 02.12 | BOM cost rollup | 95% |
| 02.13 | Forward/backward traceability | 90% |
| 02.14 | Recall simulation | 85% |
| 02.15 | Genealogy tree | 80% |
| 02.16 | Technical dashboard | 70% |
| 02.17 | Allergen matrix | 75% |
| 02.18 | Nutrition panel/calculator | 85% |
| 02.19 | Shelf life configuration | 85% |
| 02.20 | Cost history tracking | 75% |

### Out of Scope (Future Phases)

- Product image upload
- Product barcode generation
- Routing templates
- Ingredient origin tracking
- Cross-contamination tracking
- Cost scenario modeling
- GraphQL traceability API

---

## Test Levels

### Unit Tests

- **Coverage Target:** 80% overall, 95% for costing-service.ts
- **Tools:** Vitest
- **Focus:** Services, validators, cost calculations, allergen inheritance

### Integration Tests

- **Coverage Target:** 70%
- **Tools:** Vitest + Supabase test client
- **Focus:** API endpoints, RLS policies, database triggers
- **Prerequisite:** Epic 01.1 (Org Context + Base RLS) must be deployed

### E2E Tests

- **Coverage Target:** Critical paths only (10-15 tests)
- **Tools:** Playwright
- **Focus:** Product creation, BOM management, traceability queries

---

## Critical Test Scenarios

### 1. Product Versioning (02.1) - Priority: HIGH

```typescript
describe('02.1 Product Versioning', () => {
  it('should auto-increment version on product edit', async () => {
    // GIVEN product with version 1
    // WHEN updating name or any field
    // THEN version becomes 2
    // AND version_history record created
  });

  it('should create audit log entry on edit', async () => {
    // GIVEN product
    // WHEN updating multiple fields
    // THEN product_version_history shows changed_fields JSONB
  });

  it('should keep SKU immutable after creation', async () => {
    // GIVEN product with SKU "SKU-001"
    // WHEN attempting to change SKU
    // THEN error 400 "SKU cannot be changed"
  });
});
```

**Coverage:** 85%
**Test Count:** 10-12 tests

### 2. BOM Date Validity (02.5) - Priority: CRITICAL

```typescript
describe('02.5 BOM Date Overlap Prevention', () => {
  it('should reject overlapping BOM dates for same product', async () => {
    // GIVEN BOM for SKU-001 effective 2025-01-01 to 2025-06-30
    // WHEN creating BOM effective 2025-03-01 to 2025-12-31
    // THEN error "Date range overlaps with existing BOM"
  });

  it('should allow adjacent BOM dates', async () => {
    // GIVEN BOM effective 2025-01-01 to 2025-06-30
    // WHEN creating BOM effective 2025-07-01 to NULL
    // THEN success
  });

  it('should handle NULL effective_to (no end date)', async () => {
    // GIVEN BOM with effective_to = NULL
    // WHEN creating another BOM starting after effective_from
    // THEN should check against current date for active status
  });

  it('should enforce date overlap via database trigger', async () => {
    // Direct SQL test to verify trigger fires
    // GIVEN overlapping dates
    // WHEN INSERT via SQL
    // THEN trigger raises exception
  });
});
```

**Coverage:** 90%
**Test Count:** 12-15 tests

### 3. BOM Item Validation (02.6) - Priority: HIGH

```typescript
describe('02.6 BOM Item Validation', () => {
  it('should reject BOM item with quantity <= 0', async () => {
    // GIVEN BOM
    // WHEN adding item with quantity = 0
    // THEN error "Quantity must be greater than 0"
  });

  it('should warn when UoM mismatches component base UoM', async () => {
    // GIVEN component with base_uom = 'kg'
    // WHEN adding BOM item with uom = 'L'
    // THEN warning (not error) "UoM mismatch"
  });

  it('should validate operation_seq exists in routing', async () => {
    // GIVEN BOM with routing having operations 1, 2, 3
    // WHEN assigning item to operation_seq = 5
    // THEN error "Operation sequence not found in routing"
  });

  it('should enforce alternative ingredient same UoM class', async () => {
    // GIVEN BOM item with uom = 'kg' (mass)
    // WHEN adding alternative with uom = 'L' (volume)
    // THEN error "Alternative must be same UoM class"
  });
});
```

**Coverage:** 90%
**Test Count:** 15-18 tests

### 4. Routing Cost Calculation (02.11) - Priority: CRITICAL

```typescript
describe('02.11 Routing Cost Calculation (ADR-009)', () => {
  it('should calculate operation labor cost correctly', async () => {
    // GIVEN operation: duration=60min, labor_cost_per_hour=50 PLN
    // WHEN calculating
    // THEN operation_labor_cost = 50 PLN
  });

  it('should include cleanup_time in cost', async () => {
    // GIVEN operation: duration=60, setup_time=15, cleanup_time=10
    // AND labor_cost_per_hour=60 PLN
    // WHEN calculating
    // THEN total = (60+15+10)/60 * 60 = 85 PLN
  });

  it('should calculate routing-level costs', async () => {
    // GIVEN routing: setup_cost=100, working_cost_per_unit=2, overhead_percent=10
    // AND output_quantity=50
    // WHEN calculating
    // THEN routing_setup_cost = 100
    // AND routing_working_cost = 100 (50*2)
    // AND subtotal = 200
    // AND overhead = 20 (200*0.1)
    // AND total = 220
  });

  it('should use default labor rate when not specified', async () => {
    // GIVEN operation without labor_cost_per_hour
    // WHEN calculating
    // THEN use default rate (50 PLN)
  });
});
```

**Coverage:** 90%
**Test Count:** 15-20 tests

### 5. BOM Cost Rollup (02.12) - Priority: CRITICAL

```typescript
describe('02.12 BOM Cost Rollup', () => {
  it('should calculate material cost from BOM items', async () => {
    // GIVEN BOM items:
    //   - Flour: 10kg @ 5 PLN/kg
    //   - Sugar: 2kg @ 8 PLN/kg
    // WHEN calculating
    // THEN material_cost = 66 PLN
  });

  it('should include scrap_percent in material cost', async () => {
    // GIVEN BOM item: 10kg @ 5 PLN/kg, scrap_percent=5%
    // WHEN calculating
    // THEN material_cost = 10 * 1.05 * 5 = 52.50 PLN
  });

  it('should calculate total product cost', async () => {
    // GIVEN material_cost=100, routing_cost=50
    // WHEN calculating
    // THEN total_cost = 150
    // AND cost_per_unit = 150 / output_qty
  });

  it('should handle multi-level BOM explosion', async () => {
    // GIVEN BOM A uses BOM B (WIP component)
    // AND BOM B has its own cost
    // WHEN calculating BOM A cost
    // THEN includes rolled-up cost of BOM B
  });

  it('should warn when ingredient missing cost_per_unit', async () => {
    // GIVEN BOM item referencing RM without cost_per_unit
    // WHEN calculating
    // THEN warning "Ingredient X missing cost" + uses 0
  });
});
```

**Coverage:** 95%
**Test Count:** 20-25 tests

### 6. Forward/Backward Traceability (02.13) - Priority: HIGH

```typescript
describe('02.13 Traceability Queries', () => {
  it('should trace forward: lot -> produced lots', async () => {
    // GIVEN lot LOT-RM-001 consumed in WO-001, WO-002
    // AND WO-001 produced LOT-FG-001
    // AND WO-002 produced LOT-FG-002
    // WHEN forward trace LOT-RM-001
    // THEN returns [LOT-FG-001, LOT-FG-002]
  });

  it('should trace backward: lot <- consumed lots', async () => {
    // GIVEN LOT-FG-001 made from LOT-RM-001, LOT-RM-002
    // WHEN backward trace LOT-FG-001
    // THEN returns [LOT-RM-001, LOT-RM-002]
  });

  it('should handle multi-level traceability', async () => {
    // GIVEN LOT-RM -> LOT-WIP -> LOT-FG
    // WHEN forward trace LOT-RM with depth=2
    // THEN returns [LOT-WIP, LOT-FG]
  });

  it('should respect depth limit', async () => {
    // GIVEN 15-level genealogy
    // WHEN tracing with max_depth=10
    // THEN stops at level 10
  });
});
```

**Coverage:** 90%
**Test Count:** 15-18 tests

### 7. Recall Simulation (02.14) - Priority: HIGH

```typescript
describe('02.14 Recall Simulation', () => {
  it('should identify all affected downstream lots', async () => {
    // GIVEN contaminated lot LOT-RM-001
    // WHEN running recall simulation
    // THEN returns all lots containing LOT-RM-001
  });

  it('should include shipped lots in recall scope', async () => {
    // GIVEN lot used in shipped sales orders
    // WHEN simulating recall
    // THEN includes customer/SO information
  });

  it('should calculate financial impact', async () => {
    // GIVEN affected inventory with values
    // WHEN simulating recall
    // THEN returns total_value_at_risk
  });

  it('should generate traceability matrix report', async () => {
    // GIVEN recall simulation
    // WHEN exporting
    // THEN PDF/Excel with lot genealogy
  });
});
```

**Coverage:** 85%
**Test Count:** 10-12 tests

### 8. RLS Multi-Tenant Isolation (All Stories) - Priority: CRITICAL

**Prerequisite:** Epic 01.1 must be implemented for these tests to function.

```typescript
describe('Technical Module Multi-Tenant Isolation', () => {
  // Setup: Uses auth helpers from 01.1 for org context switching

  it.each([
    ['products', 'org-a', 'org-b'],
    ['boms', 'org-a', 'org-b'],
    ['routings', 'org-a', 'org-b'],
    ['traceability_links', 'org-a', 'org-b'],
  ])('should isolate %s between %s and %s', async (table, orgA, orgB) => {
    // GIVEN user from Org A
    // WHEN querying table
    // THEN only Org A rows returned
  });

  it('should return 404 (not 403) for cross-tenant access', async () => {
    // GIVEN product from Org A
    // WHEN Org B user accesses by ID
    // THEN 404 Not Found (not 403 Forbidden)
  });

  it('should block cross-tenant BOM creation', async () => {
    // GIVEN product from Org A
    // WHEN Org B tries to create BOM for that product
    // THEN error (product not found in their org)
  });
});
```

**Coverage:** 95%
**Test Count:** 20+ tests across all tables

### 9. Allergen Inheritance (02.2, 02.8) - Priority: HIGH

```typescript
describe('Allergen Inheritance', () => {
  it('should auto-calculate product allergens from BOM', async () => {
    // GIVEN BOM with flour (gluten) and milk (dairy)
    // WHEN BOM activated
    // THEN parent product has gluten:contains, dairy:contains
  });

  it('should handle may_contain correctly', async () => {
    // GIVEN ingredient with may_contain:nuts
    // WHEN calculating inheritance
    // THEN parent has may_contain:nuts
  });

  it('should update allergens when BOM items change', async () => {
    // GIVEN BOM with gluten ingredient
    // WHEN removing gluten ingredient
    // THEN parent product loses gluten (if no other source)
  });

  it('should merge allergens from all BOM items', async () => {
    // GIVEN item A: gluten:contains
    // AND item B: gluten:may_contain
    // WHEN merging
    // THEN result: gluten:contains (higher severity wins)
  });
});
```

**Coverage:** 85%
**Test Count:** 12-15 tests

### 10. Routing Code Uniqueness (02.9) - Priority: MEDIUM

```typescript
describe('02.9 Routing Code', () => {
  it('should enforce unique routing code per org', async () => {
    // GIVEN routing with code "RTG-BREAD-01" in Org A
    // WHEN creating another with same code in Org A
    // THEN error "Routing code already exists"
  });

  it('should allow same code in different orgs', async () => {
    // GIVEN "RTG-BREAD-01" in Org A
    // WHEN creating "RTG-BREAD-01" in Org B
    // THEN success (different orgs)
  });

  it('should append "-COPY" suffix on clone', async () => {
    // GIVEN routing "RTG-BREAD-01"
    // WHEN cloning
    // THEN new routing code = "RTG-BREAD-01-COPY"
  });

  it('should validate code format (uppercase alphanumeric + hyphens)', async () => {
    // GIVEN code "rtg-bread-01" (lowercase)
    // WHEN creating
    // THEN auto-uppercase or error
  });
});
```

**Coverage:** 85%
**Test Count:** 8-10 tests

---

## Test Data Requirements

### Fixtures

```typescript
// tests/02-technical/fixtures/

export const fixtures = {
  organizations: [
    { id: 'org-a', name: 'Bakery A' },
    { id: 'org-b', name: 'Bakery B' },
  ],

  productTypes: [
    { org_id: 'org-a', code: 'RAW', name: 'Raw Material' },
    { org_id: 'org-a', code: 'WIP', name: 'Work in Progress' },
    { org_id: 'org-a', code: 'FG', name: 'Finished Good' },
    { org_id: 'org-a', code: 'PKG', name: 'Packaging' },
  ],

  products: [
    // Raw Materials
    { id: 'prod-flour', org_id: 'org-a', code: 'RM-FLOUR-01', name: 'Wheat Flour', product_type: 'RAW', uom: 'kg', cost_per_unit: 5.00 },
    { id: 'prod-sugar', org_id: 'org-a', code: 'RM-SUGAR-01', name: 'White Sugar', product_type: 'RAW', uom: 'kg', cost_per_unit: 8.00 },
    { id: 'prod-butter', org_id: 'org-a', code: 'RM-BUTTER-01', name: 'Butter', product_type: 'RAW', uom: 'kg', cost_per_unit: 20.00 },
    { id: 'prod-milk', org_id: 'org-a', code: 'RM-MILK-01', name: 'Whole Milk', product_type: 'RAW', uom: 'L', cost_per_unit: 4.00 },
    // Finished Goods
    { id: 'prod-bread', org_id: 'org-a', code: 'FG-BREAD-01', name: 'White Bread Loaf', product_type: 'FG', uom: 'pcs' },
    { id: 'prod-cookies', org_id: 'org-a', code: 'FG-COOKIES-01', name: 'Chocolate Cookies', product_type: 'FG', uom: 'pcs' },
    // Cross-tenant product
    { id: 'prod-b-flour', org_id: 'org-b', code: 'RM-FLOUR-01', name: 'Wheat Flour', product_type: 'RAW', uom: 'kg' },
  ],

  allergens: [
    { id: 'alg-gluten', org_id: 'org-a', code: 'GLUTEN', name: 'Gluten' },
    { id: 'alg-dairy', org_id: 'org-a', code: 'DAIRY', name: 'Milk/Dairy' },
    { id: 'alg-nuts', org_id: 'org-a', code: 'TREE_NUTS', name: 'Tree Nuts' },
    { id: 'alg-soy', org_id: 'org-a', code: 'SOY', name: 'Soy' },
    { id: 'alg-eggs', org_id: 'org-a', code: 'EGGS', name: 'Eggs' },
  ],

  productAllergens: [
    { product_id: 'prod-flour', allergen_id: 'alg-gluten', relation_type: 'contains' },
    { product_id: 'prod-butter', allergen_id: 'alg-dairy', relation_type: 'contains' },
    { product_id: 'prod-milk', allergen_id: 'alg-dairy', relation_type: 'contains' },
  ],

  routings: [
    {
      id: 'rtg-bread',
      org_id: 'org-a',
      code: 'RTG-BREAD-01',
      name: 'White Bread Production',
      version: 1,
      is_active: true,
      is_reusable: true,
      setup_cost: 50.00,
      working_cost_per_unit: 2.00,
      overhead_percent: 10.00,
      currency: 'PLN',
    },
    {
      id: 'rtg-cookies',
      org_id: 'org-a',
      code: 'RTG-COOKIES-01',
      name: 'Cookie Production',
      version: 1,
      is_active: true,
      is_reusable: false,
      setup_cost: 30.00,
      working_cost_per_unit: 1.50,
      overhead_percent: 15.00,
      currency: 'PLN',
    },
  ],

  routingOperations: [
    // Bread routing
    { id: 'op-bread-1', routing_id: 'rtg-bread', sequence: 1, name: 'Mixing', duration: 30, setup_time: 10, cleanup_time: 5, labor_cost_per_hour: 50 },
    { id: 'op-bread-2', routing_id: 'rtg-bread', sequence: 2, name: 'Proofing', duration: 60, setup_time: 0, cleanup_time: 0, labor_cost_per_hour: 40 },
    { id: 'op-bread-3', routing_id: 'rtg-bread', sequence: 3, name: 'Baking', duration: 45, setup_time: 15, cleanup_time: 10, labor_cost_per_hour: 60 },
    // Cookie routing
    { id: 'op-cookies-1', routing_id: 'rtg-cookies', sequence: 1, name: 'Mix Dough', duration: 20, setup_time: 5, cleanup_time: 5, labor_cost_per_hour: 50 },
    { id: 'op-cookies-2', routing_id: 'rtg-cookies', sequence: 2, name: 'Shape', duration: 30, setup_time: 0, cleanup_time: 0, labor_cost_per_hour: 45 },
    { id: 'op-cookies-3', routing_id: 'rtg-cookies', sequence: 3, name: 'Bake', duration: 25, setup_time: 10, cleanup_time: 10, labor_cost_per_hour: 55 },
  ],

  boms: [
    {
      id: 'bom-bread',
      org_id: 'org-a',
      product_id: 'prod-bread',
      version: 1,
      routing_id: 'rtg-bread',
      effective_from: '2025-01-01',
      effective_to: null,
      status: 'active',
      output_qty: 10,
      output_uom: 'pcs',
    },
    {
      id: 'bom-cookies',
      org_id: 'org-a',
      product_id: 'prod-cookies',
      version: 1,
      routing_id: 'rtg-cookies',
      effective_from: '2025-01-01',
      effective_to: null,
      status: 'active',
      output_qty: 50,
      output_uom: 'pcs',
    },
  ],

  bomItems: [
    // Bread BOM
    { bom_id: 'bom-bread', product_id: 'prod-flour', quantity: 5, uom: 'kg', sequence: 1, operation_seq: 1 },
    { bom_id: 'bom-bread', product_id: 'prod-sugar', quantity: 0.2, uom: 'kg', sequence: 2, operation_seq: 1 },
    { bom_id: 'bom-bread', product_id: 'prod-butter', quantity: 0.5, uom: 'kg', sequence: 3, operation_seq: 1 },
    { bom_id: 'bom-bread', product_id: 'prod-milk', quantity: 2, uom: 'L', sequence: 4, operation_seq: 1 },
    // Cookies BOM
    { bom_id: 'bom-cookies', product_id: 'prod-flour', quantity: 3, uom: 'kg', sequence: 1, operation_seq: 1 },
    { bom_id: 'bom-cookies', product_id: 'prod-sugar', quantity: 1.5, uom: 'kg', sequence: 2, operation_seq: 1 },
    { bom_id: 'bom-cookies', product_id: 'prod-butter', quantity: 1, uom: 'kg', sequence: 3, operation_seq: 1 },
  ],

  traceabilityLinks: [
    // Lot genealogy for traceability tests
    { org_id: 'org-a', parent_lot_id: 'lot-flour-001', child_lot_id: 'lot-bread-001', work_order_id: 'wo-001', quantity_consumed: 5 },
    { org_id: 'org-a', parent_lot_id: 'lot-flour-001', child_lot_id: 'lot-bread-002', work_order_id: 'wo-002', quantity_consumed: 5 },
    { org_id: 'org-a', parent_lot_id: 'lot-sugar-001', child_lot_id: 'lot-bread-001', work_order_id: 'wo-001', quantity_consumed: 0.2 },
  ],
};
```

### Test Data Seed Script

```typescript
// tests/02-technical/helpers/seed.ts

import { supabase } from '@/lib/supabase';
import { fixtures } from '../fixtures';

export async function seedTechnicalTestData() {
  // Insert in dependency order
  await supabase.from('product_types').insert(fixtures.productTypes);
  await supabase.from('products').insert(fixtures.products);
  await supabase.from('allergens').insert(fixtures.allergens);
  await supabase.from('product_allergens').insert(fixtures.productAllergens);
  await supabase.from('routings').insert(fixtures.routings);
  await supabase.from('routing_operations').insert(fixtures.routingOperations);
  await supabase.from('boms').insert(fixtures.boms);
  await supabase.from('bom_items').insert(fixtures.bomItems);
  await supabase.from('traceability_links').insert(fixtures.traceabilityLinks);
}

export async function cleanupTechnicalTestData() {
  // Delete in reverse dependency order
  await supabase.from('traceability_links').delete().in('org_id', ['org-a', 'org-b']);
  await supabase.from('bom_items').delete().in('bom_id', fixtures.boms.map(b => b.id));
  await supabase.from('boms').delete().in('org_id', ['org-a', 'org-b']);
  await supabase.from('routing_operations').delete().in('routing_id', fixtures.routings.map(r => r.id));
  await supabase.from('routings').delete().in('org_id', ['org-a', 'org-b']);
  await supabase.from('product_allergens').delete().in('product_id', fixtures.products.map(p => p.id));
  await supabase.from('products').delete().in('org_id', ['org-a', 'org-b']);
  await supabase.from('product_types').delete().in('org_id', ['org-a', 'org-b']);
  await supabase.from('allergens').delete().in('org_id', ['org-a', 'org-b']);
}
```

---

## File Structure

```
tests/02-technical/
  fixtures/
    organizations.ts
    products.ts
    product-types.ts
    allergens.ts
    boms.ts
    routings.ts
    traceability.ts
    index.ts
  helpers/
    seed.ts
    assertions.ts
    mocks.ts
  02.1.product-crud-versioning.test.ts
  02.1.product-crud-versioning.integration.test.ts
  02.2.product-allergen-declaration.test.ts
  02.3.product-types-settings.test.ts
  02.4.materials-list.test.ts
  02.5.bom-crud-date-validity.test.ts
  02.5.bom-crud-date-validity.integration.test.ts
  02.6.bom-items-operation-assignment.test.ts
  02.6.bom-items-validation.integration.test.ts
  02.7.bom-clone-compare.test.ts
  02.8.bom-alternatives-conditionals.test.ts
  02.9.routing-crud-code.test.ts
  02.9.routing-code-uniqueness.integration.test.ts
  02.10.routing-operations.test.ts
  02.11.routing-cost-configuration.test.ts
  02.11.routing-cost-configuration.integration.test.ts
  02.12.bom-cost-rollup.test.ts
  02.12.bom-cost-rollup.integration.test.ts
  02.13.traceability-forward-backward.test.ts
  02.13.traceability-forward-backward.integration.test.ts
  02.14.recall-simulation.test.ts
  02.15.genealogy-tree.test.ts
  02.16.technical-dashboard.test.ts
  02.17.allergen-matrix.test.ts
  02.18.nutrition-calculator.test.ts
  02.19.shelf-life-configuration.test.ts
  02.20.cost-history.test.ts
  rls-isolation.integration.test.ts
e2e/
  technical-product-flow.spec.ts
  technical-bom-flow.spec.ts
  technical-routing-flow.spec.ts
  technical-traceability-flow.spec.ts
```

---

## E2E Test Scenarios

### Critical User Flows

```typescript
// e2e/technical-product-flow.spec.ts
describe('Product Management E2E', () => {
  test('Create product with allergens', async ({ page }) => {
    // Navigate to /technical/products
    // Click "New Product"
    // Fill form (SKU, name, type, allergens)
    // Save
    // Verify product in list
    // Verify allergens assigned
  });

  test('Edit product triggers versioning', async ({ page }) => {
    // Open existing product
    // Change name
    // Save
    // Verify version incremented
    // Verify history entry created
  });
});

// e2e/technical-bom-flow.spec.ts
describe('BOM Management E2E', () => {
  test('Create BOM with items and routing', async ({ page }) => {
    // Navigate to /technical/boms
    // Click "New BOM"
    // Select product
    // Set dates
    // Assign routing
    // Save header
    // Navigate to items
    // Add 3 ingredients
    // Verify cost calculated
  });

  test('Clone BOM creates new version', async ({ page }) => {
    // Select existing BOM
    // Click "Clone"
    // Select target product
    // Verify items copied
    // Verify routing copied
  });
});

// e2e/technical-traceability-flow.spec.ts
describe('Traceability E2E', () => {
  test('Forward trace lot to produced goods', async ({ page }) => {
    // Navigate to /technical/traceability
    // Enter lot number
    // Select "Forward Trace"
    // Execute
    // Verify results show downstream lots
    // Verify tree visualization loads
  });

  test('Recall simulation', async ({ page }) => {
    // Navigate to /technical/traceability
    // Enter contaminated lot
    // Click "Recall Simulation"
    // Verify affected lots listed
    // Verify financial impact shown
    // Export report
  });
});
```

---

## Integration Test Scenarios

### API Endpoint Tests

```typescript
// 02.5.bom-crud-date-validity.integration.test.ts
describe('POST /api/technical/boms', () => {
  it('should create BOM with valid date range', async () => {
    const response = await request(app)
      .post('/api/technical/boms')
      .set('Authorization', `Bearer ${token}`)
      .send({
        product_id: 'prod-bread',
        effective_from: '2025-07-01',
        effective_to: null,
        routing_id: 'rtg-bread',
        output_qty: 10,
        output_uom: 'pcs',
      });

    expect(response.status).toBe(201);
    expect(response.body.id).toBeDefined();
  });

  it('should reject overlapping date range', async () => {
    const response = await request(app)
      .post('/api/technical/boms')
      .send({
        product_id: 'prod-bread',
        effective_from: '2025-03-01', // Overlaps with existing
        effective_to: '2025-12-31',
        // ...
      });

    expect(response.status).toBe(400);
    expect(response.body.error).toContain('overlap');
  });
});

// 02.12.bom-cost-rollup.integration.test.ts
describe('GET /api/technical/boms/:id/cost', () => {
  it('should return complete cost breakdown', async () => {
    const response = await request(app)
      .get('/api/technical/boms/bom-bread/cost')
      .set('Authorization', `Bearer ${token}`);

    expect(response.status).toBe(200);
    expect(response.body).toMatchObject({
      material_cost: expect.any(Number),
      routing_cost: {
        operation_labor_cost: expect.any(Number),
        operation_setup_cost: expect.any(Number),
        operation_cleanup_cost: expect.any(Number),
        routing_setup_cost: expect.any(Number),
        routing_working_cost: expect.any(Number),
        overhead_cost: expect.any(Number),
        total_routing_cost: expect.any(Number),
      },
      total_cost: expect.any(Number),
      cost_per_unit: expect.any(Number),
    });
  });
});
```

### Database Trigger Tests

```typescript
// 02.5.bom-crud-date-validity.integration.test.ts
describe('BOM Date Overlap Trigger', () => {
  it('should block overlapping dates via SQL', async () => {
    // First BOM
    await supabase.from('boms').insert({
      org_id: 'org-a',
      product_id: 'prod-bread',
      effective_from: '2025-01-01',
      effective_to: '2025-06-30',
      status: 'active',
    });

    // Overlapping BOM - should fail
    const { error } = await supabase.from('boms').insert({
      org_id: 'org-a',
      product_id: 'prod-bread',
      effective_from: '2025-03-01',
      effective_to: '2025-12-31',
      status: 'active',
    });

    expect(error).toBeDefined();
    expect(error.message).toContain('overlap');
  });
});
```

---

## Quality Gates

| Gate | Criteria | Enforcer |
|------|----------|----------|
| RED Complete | All tests written, all failing | TEST-WRITER |
| GREEN Complete | All tests passing | DEV |
| Coverage Met | Unit 80%, Integration 70%, Costing 95% | CI |
| Security Met | RLS tests 95%+ | CODE-REVIEWER |
| Performance Met | BOM explosion <2s, trace <3s | CI |

---

## Performance Test Criteria

| Scenario | Target | Test |
|----------|--------|------|
| Product list (10k products) | <1s | Load test |
| BOM explosion (5-level) | <2s | Unit test with timer |
| Traceability query (100k lots) | <3s | Integration test with timer |
| Cost calculation (multi-level) | <500ms | Unit test with timer |
| Routing cost (10 operations) | <100ms | Unit test with timer |

---

## Execution Commands

```bash
# Run all 02 tests
npm test -- tests/02-technical/

# Run specific story tests
npm test -- tests/02-technical/02.5

# Run with coverage
npm test -- tests/02-technical/ --coverage

# Run integration tests only
npm test -- tests/02-technical/*.integration.test.ts

# Run E2E
npx playwright test tests/02-technical/e2e/

# Run cost calculation tests specifically
npm test -- tests/02-technical/02.11 tests/02-technical/02.12

# Run RLS isolation tests
npm test -- tests/02-technical/rls-isolation
```

---

## Notes for TEST-WRITER

1. **Start with 02.1** - products are foundation for all other stories
2. **Cost tests are critical** - costing-service.ts must have 95%+ coverage
3. **Use Given/When/Then** format from story ACs
4. **Test isolation** - each test independent, clean fixtures
5. **Security focus** - 404 not 403 for cross-tenant
6. **Database triggers** - test overlap prevention at SQL level
7. **Performance assertions** - add timing checks for slow operations
8. **ADR-009 compliance** - verify all routing cost fields used correctly
9. **01.1 Prerequisite** - Ensure Epic 01.1 is deployed before running integration tests

---

## Version History

| Version | Date | Changes |
|---------|------|---------|
| 1.0 | 2025-12-15 | Initial test strategy for Epic 02 |
| 1.1 | 2025-12-15 | Added 01.1 prerequisite note for integration tests |
