# 02.12 - Technical Dashboard: Stats, Charts & Allergen Matrix

**Priority**: P0 (MVP)
**Story Points**: 8 (Large)
**Type**: frontend + backend

**State:** ready
**Estimate:** L (complex dashboard with multiple widgets)
**Primary PRD:** `docs/1-BASELINE/product/modules/technical.md` (FR-2.100, FR-2.101, FR-2.102, FR-2.103)
**UX Wireframe:** TEC-017-dashboard.md

---

## MVP Scope

This story implements Phase 0 (MVP) functionality only. Features listed in "Future Phases" are deferred to Phase 1+ and should be handled per Epic 02.0 "Future Feature Handling" guidance.

---

## Goal
Implement the Technical Module dashboard page with summary statistics cards, allergen matrix visualization, BOM version timeline, recent activity feed, cost trends chart, and quick action buttons.

## Scope

**In scope (MVP)**
- GET /api/technical/dashboard/stats (product, BOM, routing counts, avg cost with trend)
- GET /api/technical/dashboard/allergen-matrix (products x allergens heatmap data)
- GET /api/technical/dashboard/bom-timeline (BOM version changes over time)
- GET /api/technical/dashboard/recent-activity (last 10 activity events)
- GET /api/technical/dashboard/cost-trends (monthly cost averages for charts)
- Dashboard page at `/technical` with responsive layout
- 4 stats cards (Products, BOMs, Routings, Avg Cost) with click navigation
- Allergen matrix heatmap (products x allergens) with color coding
- BOM version timeline (horizontal dot timeline)
- Recent activity feed (last 10 changes)
- Cost trends line chart (Recharts)
- Quick action buttons (New Product, New BOM, New Routing)
- PDF export for allergen matrix
- All components follow responsive breakpoints (desktop/tablet/mobile)

## Future Phases (Not in MVP)

### Phase 1
- Custom date range selection for trends (default 6 months is MVP)
- Dashboard widget customization/reordering
- Saved dashboard configurations per user
- Excel/CSV export for all widgets
- Additional chart types (bar, pie for product distribution)

### Phase 2
- Real-time WebSocket updates (live data refresh)
- AI-powered anomaly detection on cost trends
- Predictive analytics for cost forecasting
- Scheduled dashboard email reports
- Custom widget creation

**Implementation**: See Epic 02.0 "Future Feature Handling" for UI/API handling.

---

## Dependencies
- **01.1** - Org context + RLS (required for tenant isolation)
- **02.1** - Products CRUD (required for product stats)
- **02.3** - Product allergens (required for allergen matrix)
- **02.4** - BOMs CRUD (required for BOM stats and timeline)
- **02.7** - Routings CRUD (required for routing stats)
- **02.9** - BOM-Routing costs (required for cost trends)

## Acceptance Criteria (Given/When/Then)

### Stats Cards
- GIVEN user navigates to `/technical`, WHEN page loads, THEN 4 stats cards display (Products, BOMs, Routings, Avg Cost) within 500ms.
- GIVEN stats cards displayed, WHEN Products card shows 247 total, THEN breakdown shows "Active: 215, Inactive: 32".
- GIVEN stats cards displayed, WHEN user clicks Products card, THEN navigation to `/technical/products` occurs.
- GIVEN stats cards displayed, WHEN Avg Cost card shows "$125.50", THEN trend indicator shows "+5.2%" with up arrow.
- GIVEN stats cards displayed, WHEN user clicks Avg Cost card, THEN navigation to `/technical/costing/history` occurs.

### Allergen Matrix
- GIVEN dashboard loaded, WHEN allergen matrix renders, THEN products appear as rows and allergens as columns.
- GIVEN allergen matrix displayed, WHEN product contains Gluten, THEN cell shows red indicator (contains).
- GIVEN allergen matrix displayed, WHEN product may contain Dairy, THEN cell shows yellow indicator (may contain).
- GIVEN allergen matrix displayed, WHEN product is free from Nuts, THEN cell shows green indicator (free from).
- GIVEN allergen matrix displayed, WHEN user clicks cell for SKU-001/Gluten, THEN navigation to allergen management for that product occurs.
- GIVEN allergen matrix displayed, WHEN user clicks "Export PDF", THEN allergen matrix downloads as PDF with legend.
- GIVEN allergen matrix with 50+ products, WHEN filtering by product type "Finished Goods", THEN only finished goods products display.

### BOM Version Timeline
- GIVEN dashboard loaded, WHEN BOM timeline renders, THEN dots represent BOM version changes for last 6 months.
- GIVEN BOM timeline displayed, WHEN user hovers over dot, THEN tooltip shows product name, version, date, changed_by.
- GIVEN BOM timeline displayed, WHEN user clicks dot for "Wheat Bread v5", THEN navigation to BOM detail page occurs.
- GIVEN BOM timeline displayed, WHEN filtering by product "Wheat Bread", THEN only that product's versions display.

### Recent Activity
- GIVEN dashboard loaded, WHEN recent activity loads, THEN last 10 activity events display with icon, description, user, timestamp.
- GIVEN recent activity displayed, WHEN event shows "Product SKU-015 created", THEN icon is product icon and relative time shows "2 hours ago".
- GIVEN recent activity displayed, WHEN user clicks activity row, THEN navigation to detail page (product/BOM/routing) occurs.
- GIVEN recent activity displayed, WHEN user clicks "View All Activity", THEN navigation to activity log page occurs.

### Cost Trends Chart
- GIVEN dashboard loaded, WHEN cost trends chart renders, THEN line chart shows last 6 months of cost data.
- GIVEN cost trends chart displayed, WHEN toggle buttons show, THEN user can toggle Material/Labor/Overhead/Total lines.
- GIVEN cost trends chart displayed, WHEN user hovers over data point, THEN tooltip shows cost breakdown for that month.
- GIVEN cost trends chart displayed, WHEN user clicks chart area, THEN navigation to cost history page occurs.

### Quick Actions
- GIVEN dashboard loaded, WHEN quick actions display, THEN buttons for New Product, New BOM, New Routing appear.
- GIVEN user clicks "New Product", WHEN modal opens, THEN product creation modal (TEC-002) displays.
- GIVEN user clicks "New BOM", WHEN modal opens, THEN BOM creation modal (TEC-006) displays.
- GIVEN user clicks "New Routing", WHEN modal opens, THEN routing creation modal (TEC-008) displays.

### Loading/Empty/Error States
- GIVEN dashboard loads, WHEN data is fetching, THEN skeleton loaders display for all cards and panels.
- GIVEN no products exist, WHEN dashboard loads, THEN empty state displays with "Welcome to Technical Module" and onboarding CTAs.
- GIVEN API fails, WHEN dashboard loads, THEN error state displays with "Failed to Load Dashboard Data" and Retry button.

### Responsive Behavior
- GIVEN desktop viewport (>1024px), WHEN dashboard renders, THEN 4 cards in row, 2-column panel layout.
- GIVEN tablet viewport (768-1024px), WHEN dashboard renders, THEN 2x2 card grid, panels stack vertically.
- GIVEN mobile viewport (<768px), WHEN dashboard renders, THEN single column layout, all elements stack.

### AC-12.10: Future Features (Phase 1+)

Features deferred to future phases (not in MVP):
- Custom date range selection for trends - Phase 1
- Dashboard widget customization/reordering - Phase 1
- Saved dashboard configurations - Phase 1
- Real-time WebSocket updates - Phase 2
- AI-powered anomaly detection - Phase 2

**Implementation Options** (per Epic 02.0 guidance):
1. Hide completely (recommended for MVP)
2. Show as "Coming Soon" with disabled state

**Code Pattern**:
```typescript
{/* Phase 1: Custom Date Range
<Button disabled>Custom Range (Coming Soon)</Button>
*/}

{/* Phase 1: Dashboard Customization
<Button disabled title="Coming in Phase 1">
  <Settings className="h-4 w-4" />
</Button>
*/}
```

## Implementation Notes

### API Endpoints

```typescript
// GET /api/technical/dashboard/stats
interface DashboardStatsResponse {
  products: {
    total: number;
    active: number;
    inactive: number;
  };
  boms: {
    total: number;
    active: number;
    phased: number;
  };
  routings: {
    total: number;
    reusable: number;
  };
  avg_cost: {
    value: number;
    currency: string;
    trend_percent: number;
    trend_direction: 'up' | 'down' | 'neutral';
  };
}

// GET /api/technical/dashboard/allergen-matrix
// Query params: product_type (optional)
interface AllergenMatrixResponse {
  allergens: Array<{ id: string; code: string; name: string }>;
  products: Array<{
    id: string;
    code: string;
    name: string;
    allergen_relations: Record<string, 'contains' | 'may_contain' | null>;
  }>;
}

// GET /api/technical/dashboard/bom-timeline
// Query params: product_id (optional), months (default 6), limit (default 50)
interface BomTimelineResponse {
  timeline: Array<{
    bom_id: string;
    product_id: string;
    product_code: string;
    product_name: string;
    version: number;
    effective_from: string;
    changed_by: string;
    changed_by_name: string;
    changed_at: string;
  }>;
  limit_reached: boolean;
}

// GET /api/technical/dashboard/recent-activity
// Query params: limit (default 10)
interface RecentActivityResponse {
  activities: Array<{
    id: string;
    type: 'product_created' | 'product_updated' | 'bom_created' | 'bom_activated' | 'routing_created' | 'routing_updated';
    entity_type: 'product' | 'bom' | 'routing';
    entity_id: string;
    description: string;
    user_id: string;
    user_name: string;
    timestamp: string;
    relative_time: string;
    link: string;
  }>;
}

// GET /api/technical/dashboard/cost-trends
// Query params: months (default 6)
interface CostTrendsResponse {
  months: string[]; // ['2025-07', '2025-08', ...]
  data: Array<{
    month: string;
    material_cost: number;
    labor_cost: number;
    overhead_cost: number;
    total_cost: number;
  }>;
  currency: string;
}
```

### Database Queries

```sql
-- Stats: Products count
SELECT
  COUNT(*) as total,
  COUNT(*) FILTER (WHERE status = 'active') as active,
  COUNT(*) FILTER (WHERE status = 'inactive') as inactive
FROM products WHERE org_id = $1;

-- Stats: Average cost with trend
WITH current_month AS (
  SELECT AVG(total_cost) as avg_cost
  FROM product_costs
  WHERE org_id = $1 AND cost_type = 'standard'
    AND effective_from >= date_trunc('month', CURRENT_DATE)
),
previous_month AS (
  SELECT AVG(total_cost) as avg_cost
  FROM product_costs
  WHERE org_id = $1 AND cost_type = 'standard'
    AND effective_from >= date_trunc('month', CURRENT_DATE - INTERVAL '1 month')
    AND effective_from < date_trunc('month', CURRENT_DATE)
)
SELECT
  current_month.avg_cost,
  ((current_month.avg_cost - previous_month.avg_cost) / previous_month.avg_cost * 100) as trend_percent
FROM current_month, previous_month;

-- Allergen matrix
SELECT p.id, p.code, p.name,
  json_object_agg(
    pa.allergen_id,
    pa.relation_type
  ) as allergen_relations
FROM products p
LEFT JOIN product_allergens pa ON p.id = pa.product_id
WHERE p.org_id = $1
GROUP BY p.id, p.code, p.name;
```

### Frontend Components
- `TechnicalDashboardPage` - Main page component at `/technical`
- `DashboardStatsCard` - Reusable stats card with icon, value, breakdown, click action
- `AllergenMatrixPanel` - Heatmap grid with filter and export
- `BomTimelinePanel` - Horizontal timeline with dots and tooltips
- `RecentActivityPanel` - Activity feed list with icons and timestamps
- `CostTrendsChart` - Recharts line chart with toggle buttons
- `QuickActionsBar` - Floating action buttons

### Services
- `dashboard-service.ts` - Dashboard data aggregation
- Reuse existing `product-service.ts`, `bom-service.ts`, `routing-service.ts`, `costing-service.ts`

### Caching Strategy
```typescript
// Redis keys with TTL
'org:{orgId}:dashboard:stats'           // 1 min TTL
'org:{orgId}:dashboard:allergen-matrix' // 10 min TTL
'org:{orgId}:dashboard:bom-timeline'    // 5 min TTL
'org:{orgId}:dashboard:recent-activity' // 30 sec TTL
'org:{orgId}:dashboard:cost-trends'     // 5 min TTL
```

### Performance Targets
- Stats cards load: <500ms
- Allergen matrix load: <1s (50 products x 10 allergens)
- BOM timeline load: <800ms (50 changes)
- Recent activity load: <300ms (10 items)
- Cost trends load: <500ms (6 months, pre-aggregated)

## Deliverables
- Dashboard page at `/technical` with all panels
- 5 API endpoints for dashboard data
- Dashboard service with caching
- Allergen matrix PDF export
- Recharts cost trends chart
- Responsive layout (desktop/tablet/mobile)
- Loading, empty, and error states
- Integration tests for all endpoints
- Unit tests for dashboard service

## Definition of Done
- [ ] Dashboard page loads within 500ms for stats cards
- [ ] All 4 stats cards display correct counts and trends
- [ ] Allergen matrix renders with correct color coding
- [ ] Allergen matrix PDF export works with legend
- [ ] BOM timeline shows last 6 months of version changes
- [ ] Recent activity shows last 10 events with relative timestamps
- [ ] Cost trends chart renders with toggleable lines
- [ ] Quick action buttons open correct modals
- [ ] Click navigation works for all cards and panels
- [ ] Empty state displays correctly for new organizations
- [ ] Error state with retry button works
- [ ] Responsive design works at all breakpoints
- [ ] All API endpoints have integration tests
- [ ] Dashboard service has >80% unit test coverage
- [ ] Caching strategy implemented with correct TTLs
