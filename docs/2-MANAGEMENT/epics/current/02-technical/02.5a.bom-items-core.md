# 02.5a - BOM Items Core (MVP)

**Priority**: P0 (MVP)
**Story Points**: M (Medium)
**Type:** backend + frontend

**State:** ready
**Primary PRD:** `docs/1-BASELINE/product/modules/technical.md` (FR-2.21, FR-2.31, FR-2.38, FR-2.39)
**UX Wireframes:** TEC-006 (BOM Modal), TEC-006a (BOM Items Detail)

---

## MVP Scope

This story implements Phase 0 (MVP) functionality only. Features listed in "Future Phases" are deferred and should be handled per Epic 02.0 "Future Feature Handling" guidance.

---

## Goal

Implement core BOM line items management including basic CRUD operations, component selection, quantities, UoM validation, operation assignment, scrap tracking, and sequence management. This is the essential recipe definition functionality for MVP.

## User Story

As a **Production Manager**, I want to **add ingredients and components to a Bill of Materials with quantities and operation assignments** so that **I can define what materials are needed for production**.

## Scope

**In scope (MVP)**
- GET /api/technical/boms/:id/items (list all items for a BOM)
- POST /api/technical/boms/:id/items (add item to BOM)
- PUT /api/technical/boms/:id/items/:itemId (update item)
- DELETE /api/technical/boms/:id/items/:itemId (remove item)
- BOM items table with basic display (sequence, component, qty, uom, operation)
- Add/Edit BOM item modal with validation
- Core item fields: product_id, quantity, uom, sequence, operation_seq, scrap_percent, notes
- Operation assignment dropdown (from assigned routing)
- UoM validation trigger (warning if UoM doesn't match component base UoM)
- Quantity validation (must be > 0, max 6 decimal places)
- Sequence auto-increment and management
- Permission enforcement (read-only vs edit)

**Out of scope (this story)**
- BOM header CRUD (covered in 02.4)
- Conditional items with flags (covered in 02.5b)
- By-products management (covered in 02.5b)
- Line-specific items (covered in 02.5b)
- Alternative ingredients CRUD (covered in 02.6)
- Multi-level BOM explosion (covered in 02.14)
- Bulk import from CSV (deferred)
- Drag-drop reordering (deferred)
- BOM cost calculation (covered in 02.9)

## Dependencies
- **01.1** - Org Context + Base RLS (for multi-tenant isolation)
- **02.4** - BOMs CRUD (required for BOM header exists)
- **02.1** - Products CRUD (required for product_id lookup)
- **02.7** - Routings CRUD (required for operation_seq assignment)
- **Migration 049** - UoM validation trigger and quantity check constraint (deployed)

## Acceptance Criteria (Given/When/Then)

### AC-1: BOM Items List

**Given** user navigates to BOM detail `/technical/boms/:id`
**When** items section loads
**Then** BOM items display in sequence order within 500ms for up to 100 items

**Given** BOM has 50 items
**When** items table renders
**Then** each row shows: sequence, component code+name, type badge (RM/ING/PKG), quantity, UoM, operation assignment, scrap%, actions menu

**Given** BOM item has scrap_percent > 0
**When** row renders
**Then** scrap percentage displays (e.g., "Scrap: 2.0%")

### AC-2: Add BOM Item

**Given** user clicks "[+ Add Item]"
**When** modal opens
**Then** form displays: component selector, quantity, UoM, sequence (auto-filled with max+10), scrap%, operation assignment, notes

**Given** user selects component RM-001 (base_uom: kg), enters quantity 50 with uom "kg"
**When** save attempted
**Then** validation passes and item created

**Given** user enters quantity 0 or negative
**When** save attempted
**Then** error "Quantity must be greater than 0" displays inline

**Given** valid item data with operation_seq=10
**When** "Save Item" clicked
**Then** item created, modal closes, items table refreshes, success toast shows

**Given** user clicks "Save & Add Another"
**When** save completes
**Then** modal stays open with cleared form (except sequence incremented)

### AC-3: Edit BOM Item

**Given** user clicks "Edit" on existing item
**When** modal opens
**Then** form pre-populates with current item data

**Given** user changes quantity from 50 to 75
**When** save completes
**Then** updated quantity displays immediately in items table

**Given** user assigns operation_seq from "None" to "Op 1: Mixing"
**When** save completes
**Then** operation column shows "Op 1: Mixing"

### AC-4: Delete BOM Item

**Given** user clicks "Delete" on item
**When** confirmation dialog accepted
**Then** item removed from table within 500ms

**Given** user cancels delete confirmation
**When** dialog dismissed
**Then** item remains unchanged

### AC-5: Operation Assignment (FR-2.31)

**Given** BOM has routing_id assigned
**When** adding/editing item
**Then** operation dropdown shows all operations from routing ("Op 1: Mixing", "Op 2: Proofing", etc.)

**Given** BOM has no routing assigned
**When** adding/editing item
**Then** operation dropdown disabled with message "Assign routing to BOM first"

**Given** item assigned to operation_seq=10
**When** that operation displays
**Then** operation name shows (e.g., "Op 10: Mixing")

### AC-6: UoM Validation (FR-2.38)

**Given** component RM-001 has base_uom "kg"
**When** user enters "kg" for item UoM
**Then** no warning shown

**Given** component RM-001 has base_uom "kg"
**When** user enters "L" for item UoM
**Then** warning banner shows "UoM mismatch: component base UoM is 'kg', you entered 'L'. Unit conversion may be required."

**Given** UoM mismatch warning shown
**When** user proceeds with save
**Then** server trigger logs WARNING (not error) and save succeeds

### AC-7: Quantity Validation (FR-2.39)

**Given** user enters quantity "50.123456"
**When** validation runs
**Then** passes (6 decimal places allowed)

**Given** user enters quantity "50.1234567"
**When** validation runs
**Then** error "Maximum 6 decimal places allowed"

**Given** user enters quantity "0" or "-5"
**When** save attempted
**Then** error "Quantity must be greater than 0"

### AC-8: Sequence Management

**Given** BOM has items with sequences 10, 20, 30
**When** new item added
**Then** sequence defaults to 40 (max + 10)

**Given** user edits item sequence from 20 to 15
**When** save completes
**Then** items reorder in table by sequence

**Given** duplicate sequence entered
**When** save attempted
**Then** warning "Duplicate sequence. Items may appear in unexpected order." (warning, not error)

### AC-9: Permission Enforcement

**Given** user without technical write permission
**When** BOM items page loaded
**Then** "[+ Add Item]" button hidden, Edit/Delete actions hidden

**Given** user with technical read-only permission
**When** items displayed
**Then** view-only mode (no edit controls)

### AC-10: Future Features (Phase 1+)

Features deferred to Phase 1+:
- **Conditional items** (FR-2.26) - Hidden in MVP, no UI elements shown
- **By-products** (FR-2.27) - Hidden in MVP, no "Add Byproduct" button
- **Line-specific items** (FR-2.33) - line_ids field hidden in modal
- **Alternative ingredients** - "Add Alternative" link hidden (see 02.6)

**Developer**: Choose hiding strategy per Epic 02.0 "Future Feature Handling" (recommended: hide completely, no Coming Soon placeholders for MVP fields).

## Implementation Notes

### API Endpoints

```typescript
// GET /api/technical/boms/:id/items
interface BOMItemsListResponse {
  items: BOMItem[];
  total: number;
}

// POST /api/technical/boms/:id/items
interface CreateBOMItemRequest {
  product_id: string;           // Required: FK to products
  quantity: number;             // Required: > 0, max 6 decimals
  uom: string;                  // Required: should match product base_uom
  sequence?: number;            // Optional: default max+10
  scrap_percent?: number;       // Optional: default 0, range 0-100
  operation_seq?: number | null;// Optional: FK to routing_operations.sequence
  notes?: string | null;        // Optional: max 500 chars
}

// PUT /api/technical/boms/:id/items/:itemId
interface UpdateBOMItemRequest {
  // Same fields as create, all optional except id
}

// DELETE /api/technical/boms/:id/items/:itemId
// Returns success/error
```

### Database

```sql
-- bom_items table (existing)
bom_items: id, bom_id, product_id, operation_seq, is_output,
           quantity, uom, sequence, line_ids, scrap_percent,
           consume_whole_lp, is_by_product, yield_percent,
           condition_flags, notes, created_at, updated_at

-- Constraints (migration 049):
-- CHECK (quantity > 0) - enforced
-- Trigger: validate_bom_item_uom() - warns on mismatch
```

### Frontend Components

```
app/(authenticated)/technical/boms/[id]/page.tsx  -- BOM detail page
components/technical/bom/
  BOMItemsTable.tsx        -- Items table (MVP version)
  BOMItemModal.tsx         -- Add/Edit item modal (MVP fields only)
  BOMItemRow.tsx           -- Single item row
```

### Services

```typescript
// lib/services/bom-items-service.ts
export async function getBOMItems(bomId: string): Promise<BOMItemsListResponse>
export async function createBOMItem(bomId: string, data: CreateBOMItemRequest): Promise<BOMItem>
export async function updateBOMItem(bomId: string, itemId: string, data: UpdateBOMItemRequest): Promise<BOMItem>
export async function deleteBOMItem(bomId: string, itemId: string): Promise<void>
export async function getNextSequence(bomId: string): Promise<number>
```

### Validation (Zod)

```typescript
const bomItemSchema = z.object({
  product_id: z.string().uuid("Component is required"),
  quantity: z.number()
    .positive("Quantity must be greater than 0")
    .refine(val => {
      const decimals = (val.toString().split('.')[1] || '').length;
      return decimals <= 6;
    }, "Maximum 6 decimal places allowed"),
  uom: z.string().min(1, "Unit of measure is required"),
  sequence: z.number().int().min(0).optional().default(0),
  scrap_percent: z.number().min(0).max(100).optional().default(0),
  operation_seq: z.number().int().nullable().optional(),
  notes: z.string().max(500).nullable().optional(),
});
```

### Key Business Rules

1. **Quantity > 0**: Enforced by database constraint (migration 049)
2. **UoM match**: Trigger warns on mismatch but allows save (migration 049)
3. **Operation assignment**: operation_seq must exist in BOM's routing
4. **Sequence**: Auto-increment by 10, warn on duplicates
5. **Component lookup**: Only active products with type RM, ING, PKG, WIP allowed

## Deliverables

- API routes: GET/POST/PUT/DELETE `/api/technical/boms/:id/items/*`
- BOMItemsTable component (MVP version)
- BOMItemModal component (MVP fields only)
- bom-items-service.ts
- Zod validation schemas
- Integration tests for all API endpoints
- Unit tests for bom-items-service (>80% coverage)

## Definition of Done

- [ ] BOM items table displays within 500ms for 100 items
- [ ] Add item with MVP fields works end-to-end
- [ ] Edit item updates immediately in UI
- [ ] Delete item with confirmation works
- [ ] Operation assignment dropdown populates from routing
- [ ] UoM mismatch shows warning (not blocking error)
- [ ] Quantity validation enforces > 0 and 6 decimal limit
- [ ] Sequence auto-increments by 10
- [ ] Permission checks hide unauthorized actions
- [ ] All API endpoints have integration tests
- [ ] Unit tests cover bom-items-service (>80% coverage)
- [ ] TEC-006a wireframe implemented (MVP subset)

---

## Future Phases (Not in MVP)

### Phase 1 (Story 02.5b)
- Conditional items with flags (organic, vegan, etc.) - FR-2.26
- By-products management (is_output=true, yield_percent) - FR-2.27
- Line-specific items (line_ids array) - FR-2.33
- Bulk import from CSV

### Phase 2 (Story 02.14)
- Multi-level BOM explosion (FR-2.29)
- BOM scaling/batch size adjustment (FR-2.35)
- Drag-drop reordering

**Implementation**: See Epic 02.0 "Future Feature Handling" section.

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-12-16 | Split from 02.5, MVP scope only | ARCHITECT-AGENT |
