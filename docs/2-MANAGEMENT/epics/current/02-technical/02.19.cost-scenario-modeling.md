# 02.19 - Cost Scenario Modeling

**Story ID:** 02.19
**Epic:** 02 - Technical
**Phase:** Phase 2
**Complexity:** M (Medium)
**Estimate:** 3-4 days
**Type:** Backend + Frontend
**State:** ready
**Priority:** P2

**Primary PRD:** `docs/1-BASELINE/product/modules/TECHNICAL.md` (FR-2.76)
**UX Wireframes:** TEC-019 (Scenario List), TEC-020 (Scenario Compare)

## PRD References

| FR ID | Requirement | Priority | Phase | Covered |
|-------|-------------|----------|-------|---------|
| FR-2.76 | Cost scenario modeling | P2 | Future | Yes |

## User Story

**As a** production planner,
**I want** to create what-if cost scenarios with different ingredient costs and labor rates,
**So that** I can analyze the impact of cost changes before they happen and make informed decisions about supplier changes, pricing, and production planning.

**As a** finance manager,
**I want** to compare multiple cost scenarios side-by-side,
**So that** I can evaluate best-case, worst-case, and most likely cost projections for budgeting and margin analysis.

## Goal

Implement cost scenario modeling that allows users to create hypothetical cost scenarios with overridden ingredient costs, labor rates, and overhead percentages. Users can compare scenarios against baseline (current) costs and export comparison reports for decision-making.

## Scope

**In scope:**
- Scenario CRUD (name, description, status: active/archived)
- Scenario types: Baseline, Optimistic, Pessimistic, Custom
- Ingredient cost overrides per scenario
- Labor rate adjustments per scenario
- Overhead percentage adjustments per scenario
- Scenario versioning (automatic on edit)
- Side-by-side comparison of 2-3 scenarios
- Visual comparison with bar/column charts
- Scenario delta (% change vs baseline)
- Export comparison report (CSV/PDF)
- Scenario copy/duplicate
- Mark scenario as "baseline" (reference point)

**Out of scope:**
- AI-powered scenario suggestions (Future)
- Automatic scenario generation from supplier quotes (Future)
- Integration with external market price feeds (Future)
- Multi-currency scenarios (Phase 3)
- Time-series scenario projections (Phase 3)

## Dependencies

| Story | Requirement | Status |
|-------|-------------|--------|
| 02.9 | BOM-Routing Costs | Required - provides base costing calculation |
| 02.5 | BOM Items | Required - provides ingredient data |
| 02.8 | Routing Operations | Required - provides labor data |

## Acceptance Criteria (Given/When/Then)

### Scenario CRUD

#### Create Scenario
- GIVEN user clicks "New Scenario" button, WHEN modal opens, THEN form displays: name, description, type (dropdown), product/BOM selector.
- GIVEN user selects BOM for scenario, WHEN scenario created, THEN baseline costs loaded from current BOM calculation.
- GIVEN scenario name "Q2 2026 Forecast", WHEN saved, THEN scenario created with version 1 and status "active".
- GIVEN scenario with duplicate name for same BOM, WHEN save attempted, THEN error "Scenario name must be unique for this product" displays.

#### Edit Scenario
- GIVEN user edits scenario, WHEN changes saved, THEN version increments (1 -> 2) and updated_at timestamp refreshed.
- GIVEN scenario has cost overrides, WHEN editing, THEN all existing overrides pre-populated in form.
- GIVEN scenario is archived, WHEN edit attempted, THEN error "Cannot edit archived scenarios. Create a copy instead." displays.

#### Archive/Delete Scenario
- GIVEN user archives scenario, WHEN confirmed, THEN status changes to "archived" and scenario hidden from active list.
- GIVEN archived scenario, WHEN user clicks "Restore", THEN status changes to "active".
- GIVEN scenario with comparison reports, WHEN delete attempted, THEN error "Cannot delete scenario used in reports. Archive instead." displays.
- GIVEN scenario with no dependencies, WHEN delete confirmed, THEN scenario and all overrides removed permanently.

### Cost Overrides

#### Ingredient Cost Overrides
- GIVEN scenario edit mode, WHEN user expands "Ingredient Costs" section, THEN all BOM ingredients display with: current cost, override input, % change indicator.
- GIVEN ingredient RM-001 (Flour) costs $2.50/kg, WHEN user enters override $2.75, THEN delta shows "+10.0%" in red.
- GIVEN ingredient override set to $2.25, WHEN baseline is $2.50, THEN delta shows "-10.0%" in green.
- GIVEN user clears override value, WHEN saved, THEN baseline cost used (no override stored).
- GIVEN multiple ingredient overrides, WHEN scenario calculated, THEN each override applied to material cost calculation.

#### Labor Rate Overrides
- GIVEN scenario edit mode, WHEN user expands "Labor Rates" section, THEN all routing operations display with: current rate, override input, % change indicator.
- GIVEN operation "Mixing" has rate $45/hr, WHEN user enters $50/hr override, THEN delta shows "+11.1%".
- GIVEN operation with no labor rate (null), WHEN scenario created, THEN inherited from org default with "inherited" badge.
- GIVEN labor rate override, WHEN scenario calculated, THEN operation labor cost uses override rate.

#### Overhead/Routing Overrides
- GIVEN scenario edit mode, WHEN user expands "Routing Costs" section, THEN displays: setup_cost, working_cost_per_unit, overhead_percent with override inputs.
- GIVEN routing overhead_percent is 12%, WHEN user overrides to 15%, THEN delta shows "+3 pts" (percentage points).
- GIVEN setup_cost override of $75 (baseline $50), WHEN calculated, THEN scenario uses $75 for fixed setup cost.

### Scenario Calculation

#### Calculate Scenario Cost
- GIVEN scenario with overrides applied, WHEN "Calculate" button clicked, THEN total cost calculated using formula:
  ```
  Total = Material (with overrides)
        + Labor (with rate overrides)
        + Routing Setup (with override)
        + Routing Working (with override)
        + Overhead (with % override)
  ```
- GIVEN scenario calculated, WHEN result displayed, THEN shows: total cost, cost per unit, breakdown by category, comparison to baseline.
- GIVEN calculation errors (missing data), WHEN attempted, THEN error message specifies which ingredient/operation is missing required data.
- GIVEN scenario calculation completes in >2 seconds, WHEN loading, THEN spinner displays with "Calculating scenario costs..." message.

#### Scenario Cost Breakdown
- GIVEN calculated scenario, WHEN cost breakdown shown, THEN displays:
  - Material cost total + delta vs baseline
  - Labor cost total + delta vs baseline
  - Overhead cost total + delta vs baseline
  - Total cost + delta vs baseline
  - Cost per unit + delta vs baseline

### Scenario Comparison

#### Compare 2-3 Scenarios
- GIVEN user selects 2 scenarios to compare, WHEN "Compare" button clicked, THEN side-by-side comparison view opens.
- GIVEN comparison view, WHEN rendered, THEN table shows: Cost Category | Scenario A | Scenario B | Difference.
- GIVEN 3 scenarios selected, WHEN comparison rendered, THEN all 3 columns display with pairwise differences.
- GIVEN no scenarios selected, WHEN "Compare" clicked, THEN error "Select at least 2 scenarios to compare" displays.

#### Visual Comparison Charts
- GIVEN comparison view, WHEN chart tab selected, THEN horizontal bar chart shows each scenario's total cost.
- GIVEN comparison with 3 scenarios, WHEN breakdown chart selected, THEN stacked bar chart shows material/labor/overhead breakdown for each.
- GIVEN significant variance (>20% delta), WHEN chart rendered, THEN divergent colors highlight the variance.

#### Comparison Metrics
- GIVEN scenarios compared, WHEN metrics displayed, THEN shows:
  - Absolute difference (Scenario B - Scenario A)
  - Percentage difference ((B - A) / A * 100)
  - Variance per unit
  - Break-even analysis (units to offset cost increase)

### Scenario Management

#### Scenario List
- GIVEN user navigates to /technical/costing/scenarios, WHEN page loads, THEN DataTable shows: Name, Product, Type, Status, Version, Updated, Actions.
- GIVEN 15+ scenarios exist, WHEN list rendered, THEN pagination shows 10 per page.
- GIVEN filter by product selected, WHEN applied, THEN only scenarios for that product display.
- GIVEN filter by status "Active", WHEN applied, THEN archived scenarios hidden.

#### Scenario Copy
- GIVEN user clicks "Copy" on scenario, WHEN confirmed, THEN new scenario created with name "{Original} (Copy)" and version 1.
- GIVEN copied scenario, WHEN editing, THEN all overrides from original pre-populated.
- GIVEN scenario copy, WHEN saved, THEN independent from original (changes don't affect original).

#### Mark as Baseline
- GIVEN user clicks "Set as Baseline" on scenario, WHEN confirmed, THEN scenario marked with "Baseline" badge.
- GIVEN product has existing baseline scenario, WHEN new baseline set, THEN previous baseline loses badge.
- GIVEN baseline scenario, WHEN comparison done, THEN baseline automatically included as reference.

### Export & Reporting

#### Export Comparison
- GIVEN comparison view with 2+ scenarios, WHEN "Export CSV" clicked, THEN CSV file downloads with all comparison data.
- GIVEN comparison exported, WHEN CSV opened, THEN columns show: Category, Scenario A, Scenario B, Difference, % Change.
- GIVEN "Export PDF" clicked, WHEN PDF generated, THEN includes: comparison table, charts, timestamp, user who generated.

#### Scenario Report
- GIVEN single scenario, WHEN "Export" clicked, THEN full cost breakdown exports with all overrides listed.
- GIVEN scenario report, WHEN generated, THEN includes: scenario metadata, all overrides, calculated costs, comparison to baseline.

### Permission Enforcement

- GIVEN user without technical read permission, WHEN scenario list accessed, THEN 403 Forbidden returned.
- GIVEN user with read-only permission, WHEN "New Scenario" button rendered, THEN button hidden or disabled.
- GIVEN user with write permission, WHEN creating scenario, THEN operation succeeds.
- GIVEN admin user, WHEN deleting any scenario, THEN operation succeeds (admin override).

### Multi-tenancy

- GIVEN User A from Org A, WHEN listing scenarios, THEN only Org A scenarios returned.
- GIVEN User A from Org A, WHEN accessing Org B scenario by ID, THEN 404 Not Found returned (not 403).
- GIVEN scenario created, WHEN org_id stored, THEN automatically set from authenticated user context.

## Technical Specification

### Database Schema

#### cost_scenarios table

```sql
CREATE TABLE cost_scenarios (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  bom_id UUID NOT NULL REFERENCES boms(id) ON DELETE CASCADE,
  product_id UUID NOT NULL REFERENCES products(id),

  -- Scenario identification
  name VARCHAR(100) NOT NULL,
  description TEXT,
  scenario_type VARCHAR(20) NOT NULL DEFAULT 'custom', -- 'baseline', 'optimistic', 'pessimistic', 'custom'
  version INTEGER NOT NULL DEFAULT 1,
  status VARCHAR(20) NOT NULL DEFAULT 'active', -- 'active', 'archived'
  is_baseline BOOLEAN DEFAULT false,

  -- Routing-level overrides
  setup_cost_override DECIMAL(10,2),
  working_cost_per_unit_override DECIMAL(10,4),
  overhead_percent_override DECIMAL(5,2),

  -- Calculated results (cached)
  calculated_material_cost DECIMAL(15,4),
  calculated_labor_cost DECIMAL(15,4),
  calculated_overhead_cost DECIMAL(15,4),
  calculated_total_cost DECIMAL(15,4),
  calculated_cost_per_unit DECIMAL(15,4),
  calculated_at TIMESTAMPTZ,

  -- Comparison to baseline
  baseline_total_cost DECIMAL(15,4),
  delta_amount DECIMAL(15,4),
  delta_percent DECIMAL(5,2),

  -- Audit
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  created_by UUID REFERENCES users(id),
  updated_by UUID REFERENCES users(id),

  -- Constraints
  CONSTRAINT cost_scenarios_name_unique UNIQUE (org_id, bom_id, name),
  CONSTRAINT cost_scenarios_type_check CHECK (scenario_type IN ('baseline', 'optimistic', 'pessimistic', 'custom')),
  CONSTRAINT cost_scenarios_status_check CHECK (status IN ('active', 'archived'))
);

-- Indexes
CREATE INDEX idx_cost_scenarios_org_id ON cost_scenarios(org_id);
CREATE INDEX idx_cost_scenarios_bom_id ON cost_scenarios(bom_id);
CREATE INDEX idx_cost_scenarios_product_id ON cost_scenarios(product_id);
CREATE INDEX idx_cost_scenarios_status ON cost_scenarios(status);
CREATE INDEX idx_cost_scenarios_baseline ON cost_scenarios(org_id, product_id) WHERE is_baseline = true;
```

#### cost_scenario_ingredient_overrides table

```sql
CREATE TABLE cost_scenario_ingredient_overrides (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  scenario_id UUID NOT NULL REFERENCES cost_scenarios(id) ON DELETE CASCADE,
  product_id UUID NOT NULL REFERENCES products(id), -- The ingredient

  -- Override values
  cost_per_unit_override DECIMAL(15,4) NOT NULL,
  baseline_cost_per_unit DECIMAL(15,4), -- Stored for reference

  -- Metadata
  notes TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),

  -- Constraints
  CONSTRAINT scenario_ingredient_unique UNIQUE (scenario_id, product_id)
);

CREATE INDEX idx_scenario_ingredients_scenario ON cost_scenario_ingredient_overrides(scenario_id);
```

#### cost_scenario_labor_overrides table

```sql
CREATE TABLE cost_scenario_labor_overrides (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  scenario_id UUID NOT NULL REFERENCES cost_scenarios(id) ON DELETE CASCADE,
  operation_id UUID NOT NULL REFERENCES routing_operations(id),

  -- Override values
  labor_cost_per_hour_override DECIMAL(15,4) NOT NULL,
  baseline_labor_cost_per_hour DECIMAL(15,4), -- Stored for reference

  -- Metadata
  notes TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),

  -- Constraints
  CONSTRAINT scenario_labor_unique UNIQUE (scenario_id, operation_id)
);

CREATE INDEX idx_scenario_labor_scenario ON cost_scenario_labor_overrides(scenario_id);
```

### RLS Policies

```sql
-- cost_scenarios: Users can see their org's scenarios
CREATE POLICY "scenarios_org_read" ON cost_scenarios
FOR SELECT USING (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
);

CREATE POLICY "scenarios_org_insert" ON cost_scenarios
FOR INSERT WITH CHECK (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
);

CREATE POLICY "scenarios_org_update" ON cost_scenarios
FOR UPDATE USING (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
);

CREATE POLICY "scenarios_org_delete" ON cost_scenarios
FOR DELETE USING (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
);

-- cost_scenario_ingredient_overrides: Inherit from parent scenario
CREATE POLICY "scenario_ingredients_read" ON cost_scenario_ingredient_overrides
FOR SELECT USING (
  EXISTS (
    SELECT 1 FROM cost_scenarios s
    WHERE s.id = scenario_id
    AND s.org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  )
);

CREATE POLICY "scenario_ingredients_write" ON cost_scenario_ingredient_overrides
FOR ALL USING (
  EXISTS (
    SELECT 1 FROM cost_scenarios s
    WHERE s.id = scenario_id
    AND s.org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  )
);

-- cost_scenario_labor_overrides: Inherit from parent scenario
CREATE POLICY "scenario_labor_read" ON cost_scenario_labor_overrides
FOR SELECT USING (
  EXISTS (
    SELECT 1 FROM cost_scenarios s
    WHERE s.id = scenario_id
    AND s.org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  )
);

CREATE POLICY "scenario_labor_write" ON cost_scenario_labor_overrides
FOR ALL USING (
  EXISTS (
    SELECT 1 FROM cost_scenarios s
    WHERE s.id = scenario_id
    AND s.org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  )
);
```

### API Endpoints

```
# Scenarios CRUD
GET    /api/technical/costing/scenarios                      - List scenarios (with filters)
POST   /api/technical/costing/scenarios                      - Create scenario
GET    /api/technical/costing/scenarios/:id                  - Get scenario with overrides
PUT    /api/technical/costing/scenarios/:id                  - Update scenario
DELETE /api/technical/costing/scenarios/:id                  - Delete scenario

# Scenario Actions
POST   /api/technical/costing/scenarios/:id/calculate        - Calculate scenario costs
POST   /api/technical/costing/scenarios/:id/copy             - Copy scenario
POST   /api/technical/costing/scenarios/:id/archive          - Archive scenario
POST   /api/technical/costing/scenarios/:id/restore          - Restore archived scenario
PUT    /api/technical/costing/scenarios/:id/set-baseline     - Mark as baseline

# Overrides Management
GET    /api/technical/costing/scenarios/:id/overrides        - Get all overrides
PUT    /api/technical/costing/scenarios/:id/overrides        - Bulk update overrides

# Comparison
POST   /api/technical/costing/scenarios/compare              - Compare 2-3 scenarios
GET    /api/technical/costing/scenarios/compare/export       - Export comparison (CSV/PDF)

# By Product
GET    /api/technical/costing/products/:productId/scenarios  - List scenarios for product
```

### Service Methods

**Location:** `lib/services/cost-scenario-service.ts`

```typescript
interface CostScenarioService {
  // CRUD
  createScenario(data: CreateScenarioInput): Promise<CostScenario>;
  getScenario(id: string): Promise<CostScenarioWithOverrides | null>;
  listScenarios(filters: ScenarioFilters): Promise<CostScenario[]>;
  updateScenario(id: string, data: UpdateScenarioInput): Promise<CostScenario>;
  deleteScenario(id: string): Promise<void>;

  // Actions
  calculateScenario(id: string): Promise<ScenarioCalculationResult>;
  copyScenario(id: string, newName?: string): Promise<CostScenario>;
  archiveScenario(id: string): Promise<void>;
  restoreScenario(id: string): Promise<void>;
  setAsBaseline(id: string): Promise<void>;

  // Overrides
  getOverrides(scenarioId: string): Promise<ScenarioOverrides>;
  updateOverrides(scenarioId: string, overrides: ScenarioOverridesInput): Promise<void>;

  // Comparison
  compareScenarios(scenarioIds: string[]): Promise<ScenarioComparison>;
  exportComparison(scenarioIds: string[], format: 'csv' | 'pdf'): Promise<Buffer>;

  // Helpers
  getBaselineScenario(productId: string): Promise<CostScenario | null>;
  calculateDelta(scenarioId: string, baselineId?: string): Promise<ScenarioDelta>;
}

interface CostScenario {
  id: string;
  org_id: string;
  bom_id: string;
  product_id: string;
  name: string;
  description: string | null;
  scenario_type: 'baseline' | 'optimistic' | 'pessimistic' | 'custom';
  version: number;
  status: 'active' | 'archived';
  is_baseline: boolean;
  setup_cost_override: number | null;
  working_cost_per_unit_override: number | null;
  overhead_percent_override: number | null;
  calculated_material_cost: number | null;
  calculated_labor_cost: number | null;
  calculated_overhead_cost: number | null;
  calculated_total_cost: number | null;
  calculated_cost_per_unit: number | null;
  calculated_at: Date | null;
  baseline_total_cost: number | null;
  delta_amount: number | null;
  delta_percent: number | null;
  created_at: Date;
  updated_at: Date;
}

interface ScenarioOverrides {
  ingredients: IngredientOverride[];
  labor: LaborOverride[];
  routing: RoutingOverrides;
}

interface IngredientOverride {
  product_id: string;
  product_code: string;
  product_name: string;
  baseline_cost: number;
  override_cost: number | null;
  delta_percent: number | null;
}

interface LaborOverride {
  operation_id: string;
  operation_name: string;
  sequence: number;
  baseline_rate: number;
  override_rate: number | null;
  delta_percent: number | null;
}

interface RoutingOverrides {
  setup_cost: { baseline: number; override: number | null };
  working_cost_per_unit: { baseline: number; override: number | null };
  overhead_percent: { baseline: number; override: number | null };
}

interface ScenarioComparison {
  scenarios: CostScenarioWithOverrides[];
  comparison: {
    category: string;
    values: { [scenarioId: string]: number };
    differences: { [pair: string]: { amount: number; percent: number } };
  }[];
  summary: {
    lowest_cost_scenario: string;
    highest_cost_scenario: string;
    max_variance_amount: number;
    max_variance_percent: number;
  };
}

interface ScenarioCalculationResult {
  success: boolean;
  scenario_id: string;
  material_cost: number;
  labor_cost: number;
  overhead_cost: number;
  total_cost: number;
  cost_per_unit: number;
  delta_vs_baseline: {
    amount: number;
    percent: number;
  } | null;
  breakdown: {
    materials: MaterialCostLine[];
    operations: OperationCostLine[];
  };
  warnings: string[];
  calculated_at: Date;
}
```

### Zod Validation Schemas

**Location:** `lib/validation/cost-scenario.ts`

```typescript
import { z } from 'zod';

export const scenarioTypeSchema = z.enum(['baseline', 'optimistic', 'pessimistic', 'custom']);
export const scenarioStatusSchema = z.enum(['active', 'archived']);

export const createScenarioSchema = z.object({
  bom_id: z.string().uuid('Invalid BOM ID'),
  name: z.string()
    .min(1, 'Name is required')
    .max(100, 'Name must be 100 characters or less'),
  description: z.string().max(500, 'Description must be 500 characters or less').optional(),
  scenario_type: scenarioTypeSchema.default('custom'),
});

export const updateScenarioSchema = z.object({
  name: z.string()
    .min(1, 'Name is required')
    .max(100, 'Name must be 100 characters or less')
    .optional(),
  description: z.string().max(500).nullable().optional(),
  scenario_type: scenarioTypeSchema.optional(),
  setup_cost_override: z.number().min(0).nullable().optional(),
  working_cost_per_unit_override: z.number().min(0).nullable().optional(),
  overhead_percent_override: z.number().min(0).max(100).nullable().optional(),
});

export const ingredientOverrideSchema = z.object({
  product_id: z.string().uuid(),
  cost_per_unit_override: z.number().min(0),
  notes: z.string().max(200).optional(),
});

export const laborOverrideSchema = z.object({
  operation_id: z.string().uuid(),
  labor_cost_per_hour_override: z.number().min(0),
  notes: z.string().max(200).optional(),
});

export const updateOverridesSchema = z.object({
  ingredients: z.array(ingredientOverrideSchema).optional(),
  labor: z.array(laborOverrideSchema).optional(),
  routing: z.object({
    setup_cost_override: z.number().min(0).nullable().optional(),
    working_cost_per_unit_override: z.number().min(0).nullable().optional(),
    overhead_percent_override: z.number().min(0).max(100).nullable().optional(),
  }).optional(),
});

export const compareScenarioSchema = z.object({
  scenario_ids: z.array(z.string().uuid())
    .min(2, 'Select at least 2 scenarios to compare')
    .max(3, 'Maximum 3 scenarios can be compared at once'),
});

export const scenarioFiltersSchema = z.object({
  product_id: z.string().uuid().optional(),
  bom_id: z.string().uuid().optional(),
  status: scenarioStatusSchema.optional(),
  scenario_type: scenarioTypeSchema.optional(),
  is_baseline: z.boolean().optional(),
  page: z.number().min(1).default(1),
  limit: z.number().min(1).max(100).default(10),
  sort_by: z.enum(['name', 'created_at', 'updated_at', 'calculated_total_cost']).default('updated_at'),
  sort_order: z.enum(['asc', 'desc']).default('desc'),
});
```

## UI Components

### Pages

- `app/(authenticated)/technical/costing/scenarios/page.tsx` - Scenario list page
- `app/(authenticated)/technical/costing/scenarios/[id]/page.tsx` - Scenario detail/edit page
- `app/(authenticated)/technical/costing/scenarios/compare/page.tsx` - Comparison view

### Components

**Location:** `components/technical/costing/scenarios/`

```
ScenarioDataTable.tsx         - Scenarios list with filters and actions
ScenarioCreateModal.tsx       - Create new scenario modal
ScenarioEditForm.tsx          - Edit scenario form with override sections
IngredientOverridesTable.tsx  - Ingredient cost overrides management
LaborOverridesTable.tsx       - Labor rate overrides management
RoutingOverridesForm.tsx      - Routing cost overrides form
ScenarioCalculateButton.tsx   - Calculate button with loading state
ScenarioCostBreakdown.tsx     - Cost breakdown display with deltas
ScenarioComparisonTable.tsx   - Side-by-side comparison table
ScenarioComparisonChart.tsx   - Visual comparison charts (bar/stacked)
ScenarioTypeSelect.tsx        - Scenario type dropdown
ScenarioStatusBadge.tsx       - Status badge (active/archived/baseline)
DeltaIndicator.tsx            - +/-% change indicator with colors
ExportComparisonDialog.tsx    - Export format selection dialog
```

### Component Details

**ScenarioDataTable.tsx**
```tsx
interface ScenarioDataTableProps {
  scenarios: CostScenario[];
  isLoading: boolean;
  onEdit: (id: string) => void;
  onCopy: (id: string) => void;
  onArchive: (id: string) => void;
  onDelete: (id: string) => void;
  onSetBaseline: (id: string) => void;
  onCompareSelected: (ids: string[]) => void;
}
```

**ScenarioEditForm.tsx**
```tsx
interface ScenarioEditFormProps {
  scenario: CostScenarioWithOverrides;
  onSave: (data: UpdateScenarioInput) => void;
  onCalculate: () => void;
  isCalculating: boolean;
}
```

**ScenarioComparisonChart.tsx**
```tsx
interface ScenarioComparisonChartProps {
  scenarios: CostScenarioWithOverrides[];
  chartType: 'bar' | 'stacked' | 'grouped';
  showBreakdown: boolean;
}
```

**DeltaIndicator.tsx**
```tsx
interface DeltaIndicatorProps {
  value: number;       // Percentage change
  showAbsolute?: number; // Absolute amount
  size?: 'sm' | 'md' | 'lg';
  reverseColors?: boolean; // For costs, negative is good
}
// Positive: red arrow up "+10.0%"
// Negative: green arrow down "-10.0%"
// Zero: gray "No change"
```

### UI Patterns

**Scenario List View:**
```
+----------------------------------------------------------+
| Cost Scenarios                           [+ New Scenario] |
+----------------------------------------------------------+
| Filters: [Product v] [Status v] [Type v]    [Compare (2)] |
+----------------------------------------------------------+
| [ ] | Name              | Product | Type     | Status   | |
+----------------------------------------------------------+
| [x] | Q2 2026 Baseline  | Bread   | Baseline | Active   |*|
| [x] | Q2 2026 Optimistic| Bread   | Optimistic| Active  | |
| [ ] | Q2 2026 Worst Case| Bread   | Pessimistic| Active | |
| [ ] | Q1 2026 Analysis  | Bread   | Custom   | Archived | |
+----------------------------------------------------------+
| Page 1 of 2                              [<] [1] [2] [>] |
+----------------------------------------------------------+
* = Baseline badge
```

**Scenario Edit - Overrides View:**
```
+----------------------------------------------------------+
| Edit Scenario: Q2 2026 Optimistic        [Calculate] [Save]|
+----------------------------------------------------------+
| Name: [Q2 2026 Optimistic                  ]              |
| Type: [Optimistic v]  Description: [Optional notes...    ]|
+----------------------------------------------------------+
| Ingredient Cost Overrides                          [v]    |
+----------------------------------------------------------+
| Ingredient       | Baseline | Override  | Delta          |
+----------------------------------------------------------+
| RM-001 Flour     | $2.50/kg | [$2.30  ] | -8.0% (green)  |
| RM-002 Sugar     | $1.80/kg | [$1.80  ] | No change      |
| RM-003 Butter    | $5.20/kg | [$4.95  ] | -4.8% (green)  |
+----------------------------------------------------------+
| Labor Rate Overrides                               [v]    |
+----------------------------------------------------------+
| Operation        | Baseline | Override  | Delta          |
+----------------------------------------------------------+
| Mixing           | $45/hr   | [$45    ] | No change      |
| Baking           | $40/hr   | [$38    ] | -5.0% (green)  |
+----------------------------------------------------------+
| Routing Overrides                                  [v]    |
+----------------------------------------------------------+
| Setup Cost:      | $50      | [$45    ] | -10.0% (green) |
| Working $/unit:  | $0.15    | [$0.14  ] | -6.7% (green)  |
| Overhead %:      | 12%      | [11%    ] | -1 pts (green) |
+----------------------------------------------------------+
```

**Comparison View:**
```
+----------------------------------------------------------+
| Compare Scenarios                          [Export CSV/PDF]|
+----------------------------------------------------------+
| Cost Category    | Baseline     | Optimistic | Difference |
+----------------------------------------------------------+
| Material Cost    | $125.00      | $118.50    | -$6.50 -5.2%|
| Labor Cost       | $45.00       | $42.75     | -$2.25 -5.0%|
| Routing Cost     | $22.50       | $20.90     | -$1.60 -7.1%|
| Overhead         | $23.10       | $21.86     | -$1.24 -5.4%|
+----------------------------------------------------------+
| TOTAL COST       | $215.60      | $204.01    | -$11.59-5.4%|
| Cost per Unit    | $2.16        | $2.04      | -$0.12 -5.4%|
+----------------------------------------------------------+
| [Chart Tab] [Table Tab]                                   |
|  +-------------------------------------------------+      |
|  |  Baseline        =================== $215.60    |      |
|  |  Optimistic      ================= $204.01      |      |
|  +-------------------------------------------------+      |
+----------------------------------------------------------+
```

## Test Cases

### Unit Tests

**cost-scenario-service.test.ts**
```typescript
describe('CostScenarioService', () => {
  describe('createScenario', () => {
    it('creates scenario with default values');
    it('loads baseline costs from BOM calculation');
    it('rejects duplicate name for same BOM');
  });

  describe('calculateScenario', () => {
    it('uses ingredient overrides for material cost');
    it('uses labor overrides for operation costs');
    it('uses routing overrides for setup/working/overhead');
    it('calculates delta vs baseline correctly');
    it('returns warnings for missing cost data');
  });

  describe('copyScenario', () => {
    it('creates copy with incremented name');
    it('copies all overrides to new scenario');
    it('sets version to 1 for new copy');
  });

  describe('compareScenarios', () => {
    it('calculates differences between 2 scenarios');
    it('handles 3-way comparison');
    it('identifies lowest/highest cost scenarios');
  });

  describe('setAsBaseline', () => {
    it('marks scenario as baseline');
    it('removes baseline from previous scenario for same product');
  });
});
```

### Integration Tests

**scenario-api.test.ts**
```typescript
describe('Scenario API', () => {
  describe('GET /api/technical/costing/scenarios', () => {
    it('returns only org scenarios (RLS)');
    it('filters by product_id');
    it('filters by status');
    it('paginates correctly');
  });

  describe('POST /api/technical/costing/scenarios', () => {
    it('creates scenario with valid data');
    it('rejects invalid BOM ID');
    it('rejects duplicate name');
  });

  describe('POST /api/technical/costing/scenarios/:id/calculate', () => {
    it('calculates with overrides applied');
    it('stores calculation results');
    it('calculates delta vs baseline');
  });

  describe('POST /api/technical/costing/scenarios/compare', () => {
    it('compares 2 scenarios');
    it('compares 3 scenarios');
    it('rejects less than 2 scenarios');
    it('rejects more than 3 scenarios');
  });
});
```

### E2E Tests

**scenario-management.spec.ts**
```typescript
describe('Cost Scenario Management', () => {
  it('creates new scenario for product');
  it('edits ingredient cost overrides');
  it('edits labor rate overrides');
  it('calculates scenario cost');
  it('displays delta indicators correctly');
  it('copies scenario with all overrides');
  it('archives and restores scenario');
});
```

**scenario-comparison.spec.ts**
```typescript
describe('Cost Scenario Comparison', () => {
  it('selects multiple scenarios for comparison');
  it('displays side-by-side comparison table');
  it('shows comparison chart');
  it('exports comparison to CSV');
  it('exports comparison to PDF');
});
```

## Business Rules

1. **Scenario Naming**: Name must be unique per BOM within organization.
2. **Baseline Scenario**: Only one scenario per product can be marked as baseline.
3. **Archived Scenarios**: Cannot be edited, must be copied to modify.
4. **Version Increment**: Version auto-increments on any update.
5. **Calculation Caching**: Calculated costs stored in scenario table to avoid recalculation on list views.
6. **Override Clearing**: Setting override to null removes it (uses baseline value).
7. **Delta Calculation**: Always compared to baseline if exists, otherwise to BOM current cost.
8. **Maximum Comparison**: Limited to 3 scenarios for clarity.
9. **Export Audit**: PDF exports include timestamp and generating user.

## Deliverables

- [ ] `cost_scenarios` table migration
- [ ] `cost_scenario_ingredient_overrides` table migration
- [ ] `cost_scenario_labor_overrides` table migration
- [ ] RLS policies for all scenario tables
- [ ] Scenario service (`lib/services/cost-scenario-service.ts`)
- [ ] Zod schemas (`lib/validation/cost-scenario.ts`)
- [ ] API routes for scenario CRUD
- [ ] API routes for scenario actions (calculate, copy, archive, compare)
- [ ] ScenarioDataTable component
- [ ] ScenarioCreateModal component
- [ ] ScenarioEditForm component with override sections
- [ ] IngredientOverridesTable component
- [ ] LaborOverridesTable component
- [ ] ScenarioCostBreakdown component
- [ ] ScenarioComparisonTable component
- [ ] ScenarioComparisonChart component
- [ ] DeltaIndicator component
- [ ] ExportComparisonDialog component
- [ ] Scenario list page
- [ ] Scenario detail/edit page
- [ ] Comparison view page
- [ ] Unit tests (>80% coverage)
- [ ] Integration tests
- [ ] E2E tests

## Definition of Done

- [ ] Scenario CRUD operations work correctly
- [ ] Ingredient cost overrides applied in calculation
- [ ] Labor rate overrides applied in calculation
- [ ] Routing overrides (setup, working, overhead) applied
- [ ] Scenario calculation within 2 seconds
- [ ] Delta indicators show correct % change
- [ ] Baseline scenario can be set per product
- [ ] Archived scenarios cannot be edited
- [ ] Scenario copy includes all overrides
- [ ] 2-3 scenario comparison displays correctly
- [ ] Comparison chart renders with correct data
- [ ] CSV export includes all comparison data
- [ ] PDF export includes charts and metadata
- [ ] RLS enforces org_id isolation
- [ ] Version increments on update
- [ ] All API endpoints have integration tests
- [ ] Unit tests cover scenario service (>80%)
- [ ] E2E tests cover main user flows
