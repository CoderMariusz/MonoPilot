# 02.14 - BOM Advanced Features: Version Comparison, Yield & Scaling

**State:** ready
**Type:** frontend + backend
**Estimate:** M (medium complexity - extending existing BOM features)
**Primary PRD:** `docs/1-BASELINE/product/modules/technical.md` (FR-2.25, FR-2.34, FR-2.35)
**UX Wireframes:** TEC-006-bom-modal.md, TEC-006a-bom-items-detail.md

## Goal
Implement advanced BOM features including version comparison (diff view), yield calculation with tracking, and batch size scaling to adjust ingredient quantities proportionally.

## Scope

**In scope**
- GET /api/technical/boms/:id/compare/:compareId (compare two BOM versions)
- POST /api/technical/boms/:id/scale (scale BOM to new batch size)
- GET /api/technical/boms/:id/yield (get yield analysis)
- PUT /api/technical/boms/:id/yield (update yield settings)
- BOM version comparison modal (side-by-side diff view)
- Yield calculation display on BOM detail
- Batch size scaling tool with preview
- Ingredient quantity recalculation based on new batch size
- Yield tracking (theoretical vs actual)
- Yield loss factor configuration
- Diff highlighting for changed ingredients (added/removed/modified)

**Out of scope**
- Historical yield tracking from production (links to Production module)
- Yield optimization recommendations
- Multi-BOM comparison (compare more than 2 versions)
- Scaling with alternative ingredient substitution

## Dependencies
- **02.4** - BOMs CRUD (required for BOM access)
- **02.5** - BOM items management (required for item comparison)
- **02.6** - BOM alternatives and clone (related BOM operations)

## Acceptance Criteria (Given/When/Then)

### BOM Version Comparison (FR-2.25)
- GIVEN BOM "Wheat Bread" has versions v2 and v3, WHEN user clicks "Compare Versions", THEN version selector dropdowns appear.
- GIVEN user selects v2 and v3 for comparison, WHEN comparison loads, THEN side-by-side view shows both versions.
- GIVEN comparison view displayed, WHEN ingredient "Butter" is in v2 at 8kg and v3 at 6kg, THEN difference shows "-2kg (-25%)" highlighted in red.
- GIVEN comparison view displayed, WHEN ingredient "Whole Wheat Flour" is in v3 but not v2, THEN row shows as "Added" with green highlight.
- GIVEN comparison view displayed, WHEN ingredient "Regular Sugar" is in v2 but not v3, THEN row shows as "Removed" with red highlight.
- GIVEN comparison view displayed, WHEN totals calculated, THEN summary shows "v3 has 2 fewer ingredients, 5kg less total weight".
- GIVEN comparison view displayed, WHEN user clicks "View Ingredient Changes", THEN detailed breakdown shows each change with explanation.
- GIVEN comparison view displayed, WHEN user clicks "Export Comparison", THEN PDF/CSV download with diff report.
- GIVEN comparison shows significant changes, WHEN summary displayed, THEN impact analysis shows "Lower fat content, Higher fiber" type insights.

### BOM Yield Calculation (FR-2.34)
- GIVEN BOM detail page open, WHEN yield section displays, THEN theoretical yield shows (output qty / total input qty * 100)%.
- GIVEN BOM has 500kg input and 475kg output_qty, WHEN yield calculated, THEN theoretical yield shows 95%.
- GIVEN BOM yield section displayed, WHEN user clicks "Configure Yield", THEN yield configuration modal opens.
- GIVEN yield config modal open, WHEN user enters expected yield=95%, loss factors (Moisture 4%, Trim 1%), THEN configuration saves.
- GIVEN yield configured, WHEN BOM detail displays, THEN yield breakdown shows "Expected: 95%, Moisture Loss: 4%, Trim Loss: 1%".
- GIVEN actual production data exists, WHEN yield section displays, THEN "Actual vs Expected" comparison shows (actual linked from Production module).
- GIVEN yield variance >5%, WHEN displayed, THEN warning indicator shows "Yield variance exceeds threshold".

### BOM Scaling (FR-2.35)
- GIVEN BOM detail page open, WHEN user clicks "Scale Batch", THEN scaling modal opens with current batch size.
- GIVEN scaling modal open with current batch 100kg, WHEN user enters new batch size 150kg, THEN preview shows all ingredients scaled by 1.5x.
- GIVEN scaling preview displayed, WHEN ingredient "Flour" is 60kg at 100kg batch, THEN scaled quantity shows 90kg at 150kg batch.
- GIVEN scaling preview displayed, WHEN user clicks "Apply Scaling", THEN all ingredient quantities update proportionally.
- GIVEN scaling applied, WHEN confirmation shows, THEN message says "Batch scaled from 100kg to 150kg. All ingredients updated."
- GIVEN user enters scale factor instead of target size, WHEN factor=2.0 entered, THEN all quantities double.
- GIVEN scaling modal open, WHEN user clicks "Preview Only", THEN scaled values display without saving changes.
- GIVEN BOM has conditional items (line-specific), WHEN scaling applied, THEN conditional quantities also scale proportionally.
- GIVEN scaling would result in fractional quantities <0.001, WHEN displayed, THEN values round to 3 decimal places with warning.

### Validation & Edge Cases
- GIVEN comparison requested for same version, WHEN submitted, THEN error shows "Cannot compare version to itself".
- GIVEN comparison requested for versions from different products, WHEN submitted, THEN error shows "Versions must be from same product".
- GIVEN scaling to 0 or negative batch size, WHEN submitted, THEN validation error shows "Batch size must be positive".
- GIVEN scaling would exceed ingredient max quantities, WHEN preview shows, THEN warning displays for affected items.
- GIVEN yield configured with losses totaling >100%, WHEN submitted, THEN error shows "Total loss cannot exceed 100%".

### UI Integration
- GIVEN BOM detail page, WHEN header actions display, THEN "Compare Versions" and "Scale Batch" buttons appear.
- GIVEN comparison modal open, WHEN user switches versions in dropdown, THEN comparison auto-refreshes.
- GIVEN scaling applied, WHEN BOM items table refreshes, THEN updated quantities display immediately.
- GIVEN yield configuration saved, WHEN BOM detail loads, THEN yield analysis section displays with breakdown.

## Implementation Notes

### API Endpoints

```typescript
// GET /api/technical/boms/:id/compare/:compareId
interface BomComparisonResponse {
  bom_1: {
    id: string;
    version: number;
    effective_from: string;
    output_qty: number;
    items: BomItemSummary[];
  };
  bom_2: {
    id: string;
    version: number;
    effective_from: string;
    output_qty: number;
    items: BomItemSummary[];
  };
  differences: {
    added: BomItemSummary[];      // In bom_2, not in bom_1
    removed: BomItemSummary[];    // In bom_1, not in bom_2
    modified: Array<{
      item_id: string;
      ingredient_name: string;
      ingredient_code: string;
      field: string;              // 'quantity' | 'uom' | 'operation_seq'
      old_value: string | number;
      new_value: string | number;
      change_percent?: number;
    }>;
  };
  summary: {
    total_items_v1: number;
    total_items_v2: number;
    total_added: number;
    total_removed: number;
    total_modified: number;
    weight_change_kg: number;
    weight_change_percent: number;
  };
  impact_analysis?: {
    nutrition_changes?: string[];  // e.g., "Lower fat content"
    cost_impact?: string;          // e.g., "+5% material cost"
    allergen_changes?: string[];   // e.g., "Removed: Tree Nuts"
  };
}

interface BomItemSummary {
  id: string;
  component_id: string;
  component_name: string;
  component_code: string;
  quantity: number;
  uom: string;
  operation_seq?: number;
  is_output: boolean;
}

// POST /api/technical/boms/:id/scale
interface ScaleBomRequest {
  target_batch_size: number;      // New batch size in output UoM
  target_uom: string;
  scale_factor?: number;          // Alternative: provide factor directly
  preview_only?: boolean;         // If true, don't save changes
  round_decimals?: number;        // Default 3
}
interface ScaleBomResponse {
  original_batch_size: number;
  new_batch_size: number;
  scale_factor: number;
  items: Array<{
    id: string;
    ingredient_name: string;
    original_quantity: number;
    new_quantity: number;
    uom: string;
    rounded: boolean;             // If rounding was applied
  }>;
  warnings: string[];             // e.g., "Yeast quantity rounded from 0.0003 to 0.001"
  applied: boolean;               // True if changes were saved
}

// GET /api/technical/boms/:id/yield
interface BomYieldResponse {
  bom_id: string;
  theoretical_yield_percent: number;  // (output_qty / input_qty) * 100
  expected_yield_percent?: number;    // User-configured
  input_total_kg: number;
  output_qty_kg: number;
  loss_factors: Array<{
    type: string;                     // 'moisture' | 'trim' | 'process' | 'custom'
    description: string;
    loss_percent: number;
  }>;
  actual_yield_avg?: number;          // From production data (if available)
  variance_from_expected?: number;
  variance_warning?: boolean;         // True if variance > threshold
}

// PUT /api/technical/boms/:id/yield
interface UpdateBomYieldRequest {
  expected_yield_percent: number;
  loss_factors: Array<{
    type: string;
    description: string;
    loss_percent: number;
  }>;
  variance_threshold_percent?: number;  // Default 5%
}
```

### Comparison Algorithm

```typescript
const compareBomVersions = async (
  bomId1: string,
  bomId2: string
): Promise<BomComparisonResponse> => {
  // Fetch both BOMs with items
  const [bom1, bom2] = await Promise.all([
    bomService.getBomWithItems(bomId1),
    bomService.getBomWithItems(bomId2),
  ]);

  // Validate same product
  if (bom1.product_id !== bom2.product_id) {
    throw new Error('Versions must be from same product');
  }

  // Build maps for comparison (key = component_id)
  const items1Map = new Map(bom1.items.map(i => [i.component_id, i]));
  const items2Map = new Map(bom2.items.map(i => [i.component_id, i]));

  const added: BomItemSummary[] = [];
  const removed: BomItemSummary[] = [];
  const modified: ModifiedItem[] = [];

  // Find added (in bom2 not in bom1)
  for (const [componentId, item] of items2Map) {
    if (!items1Map.has(componentId)) {
      added.push(mapToSummary(item));
    }
  }

  // Find removed (in bom1 not in bom2)
  for (const [componentId, item] of items1Map) {
    if (!items2Map.has(componentId)) {
      removed.push(mapToSummary(item));
    }
  }

  // Find modified (in both but different)
  for (const [componentId, item1] of items1Map) {
    const item2 = items2Map.get(componentId);
    if (!item2) continue;

    if (item1.quantity !== item2.quantity) {
      modified.push({
        item_id: item1.id,
        ingredient_name: item1.component_name,
        ingredient_code: item1.component_code,
        field: 'quantity',
        old_value: item1.quantity,
        new_value: item2.quantity,
        change_percent: ((item2.quantity - item1.quantity) / item1.quantity) * 100,
      });
    }
    // Check UoM, operation_seq, etc.
  }

  return {
    bom_1: { ...bom1, items: bom1.items.map(mapToSummary) },
    bom_2: { ...bom2, items: bom2.items.map(mapToSummary) },
    differences: { added, removed, modified },
    summary: calculateSummary(bom1, bom2, added, removed, modified),
    impact_analysis: await analyzeImpact(bom1, bom2, modified),
  };
};
```

### Scaling Algorithm

```typescript
const scaleBom = async (
  bomId: string,
  request: ScaleBomRequest
): Promise<ScaleBomResponse> => {
  const bom = await bomService.getBomWithItems(bomId);

  // Calculate scale factor
  const scaleFactor = request.scale_factor ??
    (request.target_batch_size / bom.output_qty);

  if (scaleFactor <= 0) {
    throw new Error('Scale factor must be positive');
  }

  const warnings: string[] = [];
  const scaledItems = bom.items.map(item => {
    const newQuantity = item.quantity * scaleFactor;
    const roundedQuantity = roundToDecimals(newQuantity, request.round_decimals ?? 3);
    const wasRounded = newQuantity !== roundedQuantity;

    if (wasRounded && newQuantity < 0.001) {
      warnings.push(
        `${item.component_name} quantity rounded from ${newQuantity.toFixed(6)} to ${roundedQuantity}`
      );
    }

    return {
      id: item.id,
      ingredient_name: item.component_name,
      original_quantity: item.quantity,
      new_quantity: roundedQuantity,
      uom: item.uom,
      rounded: wasRounded,
    };
  });

  // Apply changes if not preview-only
  if (!request.preview_only) {
    await Promise.all(
      scaledItems.map(item =>
        bomItemService.updateQuantity(item.id, item.new_quantity)
      )
    );
    // Update BOM output_qty
    await bomService.updateOutputQty(bomId, request.target_batch_size);
  }

  return {
    original_batch_size: bom.output_qty,
    new_batch_size: request.target_batch_size,
    scale_factor: scaleFactor,
    items: scaledItems,
    warnings,
    applied: !request.preview_only,
  };
};
```

### Database Schema Extensions

```sql
-- Add yield configuration to boms table
ALTER TABLE boms ADD COLUMN expected_yield_percent DECIMAL(5,2);
ALTER TABLE boms ADD COLUMN yield_variance_threshold DECIMAL(5,2) DEFAULT 5.0;

-- Yield loss factors table
CREATE TABLE bom_yield_factors (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  bom_id UUID NOT NULL REFERENCES boms(id) ON DELETE CASCADE,
  loss_type TEXT NOT NULL, -- 'moisture', 'trim', 'process', 'custom'
  description TEXT NOT NULL,
  loss_percent DECIMAL(5,2) NOT NULL CHECK (loss_percent >= 0 AND loss_percent <= 100),
  sequence INTEGER DEFAULT 1,
  created_at TIMESTAMPTZ DEFAULT now(),
  UNIQUE(bom_id, loss_type, description)
);

-- Add RLS policy
ALTER TABLE bom_yield_factors ENABLE ROW LEVEL SECURITY;
CREATE POLICY "bom_yield_factors_org_isolation" ON bom_yield_factors
  USING (bom_id IN (SELECT id FROM boms WHERE org_id = auth.org_id()));
```

### Frontend Components
- `BomComparisonModal` - Side-by-side version comparison view
- `BomVersionSelector` - Dropdown to select versions for comparison
- `DiffHighlighter` - Highlights added/removed/modified rows
- `ScaleBomModal` - Batch size scaling tool with preview
- `ScalePreviewTable` - Shows scaled quantities before applying
- `YieldConfigPanel` - Yield settings and loss factors configuration
- `YieldAnalysisCard` - Displays yield metrics on BOM detail

### Services
- `bom-comparison-service.ts` - BOM diff algorithm and impact analysis
- `bom-scaling-service.ts` - Scaling calculations and application
- `bom-yield-service.ts` - Yield tracking and configuration

## Deliverables
- BOM comparison modal with diff view
- Batch scaling tool with preview
- Yield configuration panel
- 4 API endpoints for advanced BOM operations
- Comparison export (PDF/CSV)
- Impact analysis for version changes
- Zod validation schemas
- Integration tests for comparison accuracy
- Unit tests for scaling calculations

## Definition of Done
- [ ] BOM comparison shows side-by-side view with diff highlighting
- [ ] Added/removed/modified ingredients clearly identified with colors
- [ ] Comparison summary shows total changes and weight difference
- [ ] Impact analysis shows nutrition/cost/allergen changes when available
- [ ] Comparison export generates PDF/CSV with full diff report
- [ ] Scaling tool correctly scales all ingredient quantities
- [ ] Scaling preview shows changes before applying
- [ ] Rounding warnings display for small quantities
- [ ] Yield configuration saves expected yield and loss factors
- [ ] Yield analysis displays theoretical vs expected yield
- [ ] Validation prevents invalid comparisons (same version, different products)
- [ ] Validation prevents invalid scaling (zero/negative batch size)
- [ ] All API endpoints have integration tests
- [ ] Scaling and comparison services have >80% unit test coverage
