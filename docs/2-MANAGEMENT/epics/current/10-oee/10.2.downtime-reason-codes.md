# 10.2 - Downtime Reason Codes & Categories

**Priority**: P0 (MVP)
**Story Points**: M (Medium)
**Type**: full-stack
**Phase**: 1A (Core OEE)
**Model**: SONNET

**State:** ready
**Estimate:** M (2-3 days)
**Primary PRD:** `docs/1-BASELINE/product/modules/oee.md` (FR-OEE-004, FR-OEE-005)
**Architecture:** `docs/1-BASELINE/architecture/modules/oee.md` (oee_downtime_reasons table)

---

## Goal

Implement downtime reason code management system with predefined categories. This enables production teams to classify and categorize all downtime events consistently, supporting root cause analysis and Pareto reporting. Reason codes are the foundation for downtime tracking (story 10.3).

---

## User Story

As a **Production Manager**, I want to **define downtime reason codes and organize them into categories** so that **my team can consistently log downtime causes and I can analyze patterns**.

As a **Maintenance Manager**, I want to **categorize downtime as planned (maintenance) or unplanned (breakdowns)** so that **I can measure MTBF/MTTR and track reliability**.

---

## Scope

**In scope (this story)**
- `oee_downtime_reasons` table with code, category, description
- Predefined categories: Mechanical, Electrical, Material, Changeover, Break, Quality
- Planned vs Unplanned flag
- Color coding for visual distinction
- Sort order for dropdown presentation
- CRUD operations for reason codes
- GET /api/oee/downtime/reasons (list codes)
- POST /api/oee/downtime/reasons (create code)
- PATCH /api/oee/downtime/reasons/:id (update code)
- DELETE /api/oee/downtime/reasons/:id (delete/deactivate code)
- Reason codes management page
- Form modal for create/edit
- Category filter and grouping

**Out of scope (this story)**
- Downtime event logging (story 10.3)
- Pareto analysis (Phase 2)
- MTBF/MTTR calculation (Phase 3)
- Auto-detection of downtime (Phase 3)

---

## Dependencies

### Cross-Epic Dependencies

| Dependency | Story/Epic | Type | What It Provides | Status |
|------------|------------|------|------------------|--------|
| 01.1 | Org Context + RLS | HARD | organizations, users, roles tables | Ready |

### Within Epic Dependencies

| Dependency | Story | Type | What It Provides |
|------------|-------|------|------------------|
| 10.1 | OEE Settings & Targets | SOFT | OEE module enabled | Ready |

### Provides To (Downstream)

| Story | What This Provides |
|-------|-------------------|
| 10.3 | Downtime Event Tracking - reason_code_id reference |
| Phase 2 | Downtime Pareto Analysis - category grouping |
| Phase 3 | MTBF/MTTR - planned vs unplanned classification |

---

## Database Migration

### Migration: Create oee_downtime_reasons table

```sql
-- Migration: YYYYMMDDHHMMSS_create_oee_downtime_reasons.sql

CREATE TABLE oee_downtime_reasons (
    -- Identity
    id                      UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id                  UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,

    -- Code and Description
    code                    TEXT NOT NULL,
    description             TEXT NOT NULL,

    -- Category Classification
    category                TEXT NOT NULL
                            CHECK (category IN (
                                'mechanical',
                                'electrical',
                                'material',
                                'changeover',
                                'break',
                                'quality',
                                'operator',
                                'utility',
                                'other'
                            )),

    -- Planned vs Unplanned
    is_planned              BOOLEAN NOT NULL DEFAULT false,

    -- Visual Customization
    color_code              TEXT DEFAULT '#6B7280', -- Gray default
    icon_name               TEXT, -- Optional icon reference

    -- Display Order
    sort_order              INTEGER DEFAULT 100,

    -- Status
    is_active               BOOLEAN DEFAULT true,

    -- Audit
    created_at              TIMESTAMPTZ NOT NULL DEFAULT now(),
    created_by              UUID REFERENCES users(id),
    updated_at              TIMESTAMPTZ NOT NULL DEFAULT now(),
    updated_by              UUID REFERENCES users(id),

    -- Constraints
    CONSTRAINT uq_reason_code UNIQUE (org_id, code)
);

-- =============================================================================
-- Indexes for Performance
-- =============================================================================

CREATE INDEX idx_reasons_org ON oee_downtime_reasons(org_id);
CREATE INDEX idx_reasons_org_active ON oee_downtime_reasons(org_id, is_active) WHERE is_active = true;
CREATE INDEX idx_reasons_category ON oee_downtime_reasons(category);
CREATE INDEX idx_reasons_planned ON oee_downtime_reasons(is_planned);
CREATE INDEX idx_reasons_sort ON oee_downtime_reasons(org_id, sort_order, code);

-- =============================================================================
-- RLS Policies
-- =============================================================================

ALTER TABLE oee_downtime_reasons ENABLE ROW LEVEL SECURITY;

CREATE POLICY "reasons_select" ON oee_downtime_reasons
    FOR SELECT USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

CREATE POLICY "reasons_insert" ON oee_downtime_reasons
    FOR INSERT WITH CHECK (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

CREATE POLICY "reasons_update" ON oee_downtime_reasons
    FOR UPDATE USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

CREATE POLICY "reasons_delete" ON oee_downtime_reasons
    FOR DELETE USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

-- =============================================================================
-- Trigger for updated_at
-- =============================================================================

CREATE TRIGGER update_oee_downtime_reasons_updated_at
    BEFORE UPDATE ON oee_downtime_reasons
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- =============================================================================
-- Seed Data: Default Reason Codes (optional, per org on setup)
-- =============================================================================

-- Function to create default reason codes for new organization
CREATE OR REPLACE FUNCTION seed_default_downtime_reasons(p_org_id UUID)
RETURNS VOID AS $$
BEGIN
    INSERT INTO oee_downtime_reasons (org_id, code, description, category, is_planned, color_code, sort_order)
    VALUES
        -- Mechanical Issues
        (p_org_id, 'MECH-JAM', 'Product Jam', 'mechanical', false, '#EF4444', 10),
        (p_org_id, 'MECH-BREAKDOWN', 'Machine Breakdown', 'mechanical', false, '#DC2626', 20),
        (p_org_id, 'MECH-MINOR', 'Minor Mechanical Stop', 'mechanical', false, '#F87171', 30),

        -- Electrical Issues
        (p_org_id, 'ELEC-SENSOR', 'Sensor Fault', 'electrical', false, '#F59E0B', 40),
        (p_org_id, 'ELEC-MOTOR', 'Motor Failure', 'electrical', false, '#D97706', 50),
        (p_org_id, 'ELEC-POWER', 'Power Outage', 'electrical', false, '#B45309', 60),

        -- Material Issues
        (p_org_id, 'MAT-SHORTAGE', 'Material Shortage', 'material', false, '#8B5CF6', 70),
        (p_org_id, 'MAT-QUALITY', 'Material Quality Issue', 'material', false, '#7C3AED', 80),
        (p_org_id, 'MAT-HANDLING', 'Material Handling Delay', 'material', false, '#6D28D9', 90),

        -- Changeover
        (p_org_id, 'CHG-PLANNED', 'Planned Changeover', 'changeover', true, '#3B82F6', 100),
        (p_org_id, 'CHG-SETUP', 'Setup/Adjustment', 'changeover', false, '#2563EB', 110),

        -- Break/Scheduled
        (p_org_id, 'BRK-LUNCH', 'Lunch Break', 'break', true, '#10B981', 120),
        (p_org_id, 'BRK-REST', 'Rest Break', 'break', true, '#059669', 130),
        (p_org_id, 'BRK-SHIFT', 'Shift Changeover', 'break', true, '#047857', 140),

        -- Quality Issues
        (p_org_id, 'QA-HOLD', 'Quality Hold', 'quality', false, '#EC4899', 150),
        (p_org_id, 'QA-REWORK', 'Rework Required', 'quality', false, '#DB2777', 160),

        -- Operator Issues
        (p_org_id, 'OPR-ABSENT', 'Operator Absent', 'operator', false, '#6B7280', 170),
        (p_org_id, 'OPR-TRAINING', 'Operator Training', 'operator', true, '#9CA3AF', 180),

        -- Utility Issues
        (p_org_id, 'UTL-AIR', 'Compressed Air Failure', 'utility', false, '#14B8A6', 190),
        (p_org_id, 'UTL-WATER', 'Water Supply Issue', 'utility', false, '#0D9488', 200),

        -- Other
        (p_org_id, 'OTH-MAINT', 'Scheduled Maintenance', 'other', true, '#64748B', 210),
        (p_org_id, 'OTH-CLEAN', 'Cleaning', 'other', true, '#475569', 220),
        (p_org_id, 'OTH-UNKNOWN', 'Unknown/Other', 'other', false, '#94A3B8', 230);
END;
$$ LANGUAGE plpgsql;

COMMENT ON FUNCTION seed_default_downtime_reasons IS 'Creates default downtime reason codes for new organization';
```

---

## Acceptance Criteria (Given/When/Then)

### AC-1: Reason Codes Table Creation

```gherkin
Scenario: oee_downtime_reasons table exists
  Given database migration runs
  When schema is inspected
  Then oee_downtime_reasons table has all columns
  And UNIQUE constraint on (org_id, code)
  And CHECK constraint enforces valid categories
  And RLS policies enforce org isolation
```

### AC-2: Create Reason Code

```gherkin
Scenario: Create mechanical breakdown reason
  Given user is production manager
  When creating reason code:
    | Field | Value |
    | code | MECH-BEARING |
    | description | Bearing Failure |
    | category | mechanical |
    | is_planned | false |
    | color_code | #DC2626 |
    | sort_order | 25 |
  Then reason code created
  And appears in dropdown for downtime logging

Scenario: Code uniqueness validation
  Given reason code "MECH-JAM" exists in Org A
  When creating another with code "MECH-JAM"
  Then error: "Reason code already exists"
```

### AC-3: Category Classification

```gherkin
Scenario: Valid categories enforced
  Given creating reason code
  When category = "invalid_category"
  Then validation error: "Invalid category"

  When category = "mechanical"
  Then code created successfully

Scenario: Category grouping
  Given reason codes exist:
    | Code | Category |
    | MECH-JAM | mechanical |
    | ELEC-SENSOR | electrical |
    | MAT-SHORTAGE | material |
  When listing codes grouped by category
  Then codes grouped as:
    | Category | Count |
    | Mechanical | 1 |
    | Electrical | 1 |
    | Material | 1 |
```

### AC-4: Planned vs Unplanned Classification

```gherkin
Scenario: Planned downtime codes
  Given creating reason codes:
    | Code | Description | Planned |
    | BRK-LUNCH | Lunch Break | true |
    | CHG-PLANNED | Planned Changeover | true |
    | OTH-MAINT | Scheduled Maintenance | true |
  When filtering by is_planned = true
  Then only planned codes returned
  And used for planned downtime calculation

Scenario: Unplanned downtime codes
  Given creating reason codes:
    | Code | Description | Planned |
    | MECH-BREAKDOWN | Machine Breakdown | false |
    | ELEC-POWER | Power Outage | false |
  When filtering by is_planned = false
  Then only unplanned codes returned
  And used for OEE availability calculation
```

### AC-5: Color Coding

```gherkin
Scenario: Custom color for visual distinction
  Given creating reason codes with colors:
    | Code | Color | Usage |
    | MECH-BREAKDOWN | #DC2626 | Red for critical |
    | CHG-PLANNED | #3B82F6 | Blue for planned |
    | BRK-LUNCH | #10B981 | Green for breaks |
  When displaying downtime events
  Then events colored by reason code color
  And visual patterns emerge (red clusters = issues)
```

### AC-6: Sort Order

```gherkin
Scenario: Dropdown ordering
  Given reason codes with sort orders:
    | Code | Sort Order |
    | MECH-JAM | 10 |
    | MECH-BREAKDOWN | 20 |
    | MECH-MINOR | 30 |
  When displaying reason code dropdown
  Then codes ordered by sort_order ASC
  And most common codes appear first

Scenario: Category then sort order
  Given multiple categories
  When displaying grouped dropdown
  Then grouped by category
  And within each group, sorted by sort_order
```

### AC-7: Update Reason Code

```gherkin
Scenario: Update code description
  Given reason code "MECH-JAM" exists
  When updating:
    | Field | New Value |
    | description | Product Jam - Updated |
    | color_code | #EF4444 |
  Then code updated
  And audit log records change

Scenario: Cannot change code after use
  Given reason code used in 50 downtime events
  When attempting to change code value
  Then warning: "Code in use. Changes affect existing data."
  And allow but require confirmation
```

### AC-8: Deactivate Reason Code

```gherkin
Scenario: Deactivate instead of delete
  Given reason code in use
  When user clicks [Delete]
  Then confirmation: "Deactivate instead of delete?"
  And user confirms
  Then is_active = false
  And code hidden from dropdowns
  And historical data preserved

Scenario: Delete unused code
  Given reason code with no usage
  When user deletes
  Then code permanently deleted
```

### AC-9: Default Seed Data

```gherkin
Scenario: Seed default codes on org setup
  Given new organization created
  When calling seed_default_downtime_reasons(org_id)
  Then 23 default reason codes created
  And categories populated:
    | Category | Count |
    | Mechanical | 3 |
    | Electrical | 3 |
    | Material | 3 |
    | Changeover | 2 |
    | Break | 3 |
    | Quality | 2 |
    | Operator | 2 |
    | Utility | 2 |
    | Other | 3 |
```

### AC-10: Reason Codes List Page

```gherkin
Scenario: View reason codes list
  Given user navigates to /oee/settings/downtime-reasons
  When page loads
  Then DataTable displays codes with columns:
    | Column | Description |
    | Code | Unique identifier |
    | Description | Full description |
    | Category | Badge with color |
    | Type | Planned/Unplanned badge |
    | Color | Color swatch |
    | Status | Active/Inactive |
    | Actions | Edit, Delete |
  And list loads within 500ms

Scenario: Filter by category
  Given codes exist in all categories
  When user filters by "Mechanical"
  Then only mechanical codes display
```

### AC-11: Create Reason Code Form

```gherkin
Scenario: Create via modal
  Given user clicks [+ New Reason Code]
  When modal opens
  Then form displays:
    | Field | Type | Required |
    | Code | Text (uppercase) | Yes |
    | Description | Text | Yes |
    | Category | Dropdown | Yes |
    | Planned Downtime | Checkbox | No (default: false) |
    | Color | Color picker | No (default: gray) |
    | Sort Order | Number | No (default: 100) |
  And user fills values
  And clicks [Create]
  Then code created and appears in list
```

### AC-12: Permission Enforcement

```gherkin
Scenario: Admin can manage codes
  Given user has ADMIN or PRODUCTION_MANAGER role
  Then [+ New Reason Code] visible
  And [Edit], [Delete] enabled

Scenario: Viewer cannot modify
  Given user has VIEWER role
  Then [+ New Reason Code] hidden
  And [Edit], [Delete] disabled
```

### AC-13: RLS Policy Enforcement

```gherkin
Scenario: Org isolation
  Given Org A has reason codes
  And Org B has different reason codes
  When User A requests GET /api/oee/downtime/reasons
  Then only Org A codes returned

Scenario: Cross-tenant access denied
  Given code belongs to Org B
  When User A requests GET /api/oee/downtime/reasons/:id
  Then 404 Not Found returned
```

---

## Implementation Notes

### API Endpoints

```typescript
// GET /api/oee/downtime/reasons
interface ReasonsListParams {
  category?: string;
  is_planned?: boolean;
  is_active?: boolean;
  search?: string;
  sort_by?: 'code' | 'category' | 'sort_order';
  sort_order?: 'asc' | 'desc';
}

interface ReasonsListResponse {
  reasons: DowntimeReason[];
  grouped?: { [category: string]: DowntimeReason[] };
}

interface DowntimeReason {
  id: string;
  org_id: string;
  code: string;
  description: string;
  category: string;
  is_planned: boolean;
  color_code: string;
  icon_name?: string;
  sort_order: number;
  is_active: boolean;
  usage_count?: number; // Number of events using this code
  created_at: string;
}

// POST /api/oee/downtime/reasons
interface CreateReasonRequest {
  code: string; // Uppercase, no spaces
  description: string;
  category: string;
  is_planned?: boolean;
  color_code?: string;
  icon_name?: string;
  sort_order?: number;
}

// PATCH /api/oee/downtime/reasons/:id
interface UpdateReasonRequest {
  description?: string;
  category?: string;
  is_planned?: boolean;
  color_code?: string;
  sort_order?: number;
  is_active?: boolean;
}
```

### Validation Schemas

```typescript
import { z } from 'zod';

export const categoryEnum = z.enum([
  'mechanical', 'electrical', 'material', 'changeover',
  'break', 'quality', 'operator', 'utility', 'other'
]);

export const createReasonSchema = z.object({
  code: z.string()
    .min(3, 'Code must be at least 3 characters')
    .max(50, 'Code must be at most 50 characters')
    .regex(/^[A-Z0-9-_]+$/, 'Code must be uppercase alphanumeric with hyphens/underscores'),
  description: z.string()
    .min(3, 'Description required')
    .max(200, 'Description too long'),
  category: categoryEnum,
  is_planned: z.boolean().default(false),
  color_code: z.string().regex(/^#[0-9A-Fa-f]{6}$/).default('#6B7280'),
  icon_name: z.string().max(50).optional(),
  sort_order: z.number().int().min(0).default(100),
});

export const updateReasonSchema = createReasonSchema.partial().omit({ code: true });
```

---

## Deliverables

### Database
- [ ] Migration: `oee_downtime_reasons` table with RLS
- [ ] Function: `seed_default_downtime_reasons(org_id)`
- [ ] All indexes for performance

### API Routes
- [ ] `GET /api/oee/downtime/reasons` - List codes
- [ ] `POST /api/oee/downtime/reasons` - Create code
- [ ] `PATCH /api/oee/downtime/reasons/:id` - Update code
- [ ] `DELETE /api/oee/downtime/reasons/:id` - Delete code
- [ ] `POST /api/oee/downtime/reasons/seed` - Seed defaults

### Service Layer
- [ ] `DowntimeReasonService.list()` - List with grouping
- [ ] `DowntimeReasonService.create()` - Create code
- [ ] `DowntimeReasonService.update()` - Update code
- [ ] `DowntimeReasonService.delete()` - Soft/hard delete

### Validation
- [ ] `createReasonSchema`
- [ ] `updateReasonSchema`

### Frontend
- [ ] Reason codes list page
- [ ] Create/edit modal
- [ ] Category badge component
- [ ] Color picker component

### Tests
- [ ] Unit tests: DowntimeReasonService (>80% coverage)
- [ ] Integration tests: All endpoints
- [ ] RLS tests: Org isolation
- [ ] E2E: CRUD workflow

---

## Definition of Done

- [ ] Database table created with constraints
- [ ] Default seed function works
- [ ] All API endpoints functional
- [ ] Validation enforced
- [ ] Frontend CRUD complete
- [ ] Tests passing (>80% coverage)

---

**Document Status**: Ready for Implementation
**Created**: 2025-01-15
**Complexity**: M (Medium)
**Phase**: 1A (Core OEE)
