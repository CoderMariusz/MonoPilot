# 10.14 - Email Alerts & Shift Handover

**Priority**: P1
**Story Points**: M (Medium)
**Type**: backend
**Phase**: 2
**Model**: OPUS

**State:** ready
**Estimate:** M (3-4 days)
**Primary PRD:** `docs/1-BASELINE/product/modules/oee.md` (FR-OEE-020, OEE-021)

---

## Goal

Extend alert system with email notifications and implement shift handover notes CRUD for supervisor-to-supervisor communication. Enable structured handoff of issues, action items, and critical information between shifts.

---

## User Story

As a **Supervisor**, I want to **leave handover notes for the next shift and receive email alerts for critical issues** so that **shift transitions are smooth and urgent problems get immediate attention**.

---

## Scope

**Email Notifications**
- Email templates for all alert types
- Email delivery via Supabase Edge Functions or SendGrid
- Configurable recipients per alert rule
- Email delivery tracking and retry logic

**Shift Handover Notes**
- `shift_handover_notes` table
- Note types: Issue, Action Item, Information
- Priority levels
- Acknowledgment workflow
- GET /api/oee/handover-notes
- POST /api/oee/handover-notes
- Handover notes UI

---

## Database Migration

```sql
CREATE TABLE shift_handover_notes (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id UUID NOT NULL REFERENCES organizations(id),
    shift_report_id UUID REFERENCES shift_reports(id),
    from_shift_id UUID REFERENCES shifts(id),
    to_shift_id UUID REFERENCES shifts(id),
    note_type TEXT CHECK (note_type IN ('issue', 'action_item', 'information')),
    priority TEXT CHECK (priority IN ('low', 'normal', 'high', 'urgent')),
    subject TEXT NOT NULL,
    message TEXT NOT NULL,
    machine_id UUID REFERENCES machines(id),
    line_id UUID REFERENCES production_lines(id),
    created_by UUID REFERENCES users(id),
    created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
    acknowledged_by UUID REFERENCES users(id),
    acknowledged_at TIMESTAMPTZ,
    acknowledgment_notes TEXT
);

CREATE INDEX idx_handover_notes_org ON shift_handover_notes(org_id);
CREATE INDEX idx_handover_notes_to_shift ON shift_handover_notes(to_shift_id);

ALTER TABLE shift_handover_notes ENABLE ROW LEVEL SECURITY;
CREATE POLICY "handover_notes_select" ON shift_handover_notes
    FOR SELECT USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));
```

---

## Acceptance Criteria

### AC-1: Email Alert Delivery

```gherkin
Scenario: Send email on critical alert
  Given alert triggered with severity = critical
  And alert rule has notify_email = true
  And email_recipients = ['manager@example.com']
  When alert created
  Then email sent within 1 minute with:
    | Subject | [CRITICAL] OEE Alert: Machine-01 |
    | Body | Alert details, metrics, dashboard link |
  And email delivery tracked
```

### AC-2: Shift Handover Note Creation

```gherkin
Scenario: Create handover note
  Given shift ending soon
  When supervisor clicks [Add Handover Note]
  And enters:
    | Type | Action Item |
    | Priority | High |
    | Subject | Mixer-01 bearing noise |
    | Message | Check bearing, may need replacement |
  Then note created
  And next shift supervisor notified
  And note appears in incoming shift's handover list
```

### AC-3: Acknowledge Handover Note

```gherkin
Scenario: Incoming shift acknowledges note
  Given handover note from previous shift
  When incoming supervisor views note
  And clicks [Acknowledge]
  And adds note "Maintenance scheduled for tomorrow"
  Then acknowledged_by = current user
  And acknowledged_at = now
  And originating supervisor notified
```

---

## Deliverables

- [ ] Email notification service
- [ ] Email templates (HTML)
- [ ] shift_handover_notes table
- [ ] Handover notes API endpoints
- [ ] Handover notes UI (list, create, acknowledge)

---

**Lines**: ~250
**Phase**: 2
