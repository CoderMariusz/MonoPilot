# 10.8 - Energy Consumption Tracking

**Priority**: P1
**Story Points**: M (Medium)
**Type**: fullstack
**Phase**: 1B
**Model**: OPUS

**State:** ready
**Estimate:** M (3-4 days)
**Primary PRD:** `docs/1-BASELINE/product/modules/oee.md` (FR-OEE-012, OEE-013)

---

## Goal

Track energy consumption at machine and batch level, calculate energy per unit produced, establish baselines, and monitor energy costs. Enable identification of high-consumption machines and products for energy efficiency improvements.

---

## User Story

As a **Production Manager**, I want to **track energy consumption by machine and batch with cost calculations** so that **I can identify energy-intensive operations and reduce production costs**.

---

## Scope

**In scope**
- `energy_readings` table (manual entry + auto-import ready)
- `energy_baselines` table (expected kWh per unit/hour)
- `energy_costs` table (rate configuration)
- Energy per batch calculation
- Energy per product calculation
- Baseline comparison and deviation alerts
- GET /api/oee/energy/readings, POST readings
- GET /api/oee/energy/baselines, POST baselines
- Energy dashboard page
- Energy cost analysis

**Out of scope**
- IoT meter integration (Phase 3)
- Time-of-day rates (Phase 2)
- Energy optimization recommendations (Phase 3)

---

## Database Migration

```sql
CREATE TABLE energy_readings (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id UUID NOT NULL REFERENCES organizations(id),
    machine_id UUID REFERENCES machines(id),
    line_id UUID REFERENCES production_lines(id),
    reading_time TIMESTAMPTZ NOT NULL,
    kwh_consumed NUMERIC(10, 2) NOT NULL,
    meter_reading NUMERIC(12, 2),
    work_order_id UUID REFERENCES work_orders(id),
    batch_id UUID,
    reading_type TEXT CHECK (reading_type IN ('manual', 'auto', 'calculated')),
    source TEXT,
    notes TEXT,
    created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
    created_by UUID REFERENCES users(id)
);

CREATE TABLE energy_baselines (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id UUID NOT NULL REFERENCES organizations(id),
    machine_id UUID REFERENCES machines(id),
    product_id UUID REFERENCES products(id),
    baseline_kwh_per_unit NUMERIC(10, 4),
    baseline_kwh_per_hour NUMERIC(10, 2),
    effective_date DATE NOT NULL,
    expiry_date DATE,
    notes TEXT,
    created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
    created_by UUID REFERENCES users(id)
);

CREATE TABLE energy_costs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id UUID NOT NULL REFERENCES organizations(id),
    rate_per_kwh NUMERIC(10, 4) NOT NULL,
    effective_date DATE NOT NULL,
    expiry_date DATE,
    rate_type TEXT DEFAULT 'standard',
    time_of_day_rate JSONB,
    notes TEXT,
    created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- Indexes
CREATE INDEX idx_energy_readings_org ON energy_readings(org_id, reading_time);
CREATE INDEX idx_energy_readings_machine ON energy_readings(machine_id) WHERE machine_id IS NOT NULL;
CREATE INDEX idx_energy_readings_wo ON energy_readings(work_order_id) WHERE work_order_id IS NOT NULL;
CREATE INDEX idx_energy_baselines_org ON energy_baselines(org_id);
CREATE INDEX idx_energy_costs_org ON energy_costs(org_id, effective_date);

-- RLS
ALTER TABLE energy_readings ENABLE ROW LEVEL SECURITY;
ALTER TABLE energy_baselines ENABLE ROW LEVEL SECURITY;
ALTER TABLE energy_costs ENABLE ROW LEVEL SECURITY;

CREATE POLICY "energy_readings_select" ON energy_readings
    FOR SELECT USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));
CREATE POLICY "energy_baselines_select" ON energy_baselines
    FOR SELECT USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));
CREATE POLICY "energy_costs_select" ON energy_costs
    FOR SELECT USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));
```

---

## Acceptance Criteria

### AC-1: Manual Energy Reading Entry

```gherkin
Scenario: Log manual meter reading
  Given user on /oee/energy
  When clicks [+ Log Reading]
  And enters:
    | Field | Value |
    | Machine | Mixer-01 |
    | Meter Reading | 45,678.50 kWh |
    | Time | 14:00 |
  Then reading saved
  And kWh consumed calculated from previous reading
  And reading appears in table
```

### AC-2: Energy Per Batch Calculation

```gherkin
Scenario: Calculate energy for work order
  Given WO-2451 started at 08:00
  And WO-2451 completed at 14:00 (6 hours)
  And energy readings:
    | Time | Meter | kWh |
    | 08:00 | 45,000 | - |
    | 14:00 | 45,450 | 450 |
  When viewing WO-2451 energy metrics
  Then total energy = 450 kWh
  And energy per unit = 450 / 2000 = 0.225 kWh/unit
```

### AC-3: Baseline Management

```gherkin
Scenario: Create energy baseline
  Given product "Cookie Dough"
  When user creates baseline:
    | Machine | Product | kWh/Unit | kWh/Hour |
    | Mixer-01 | Cookie Dough | 0.20 | 75 |
  Then baseline saved
  And future batches compared to baseline

Scenario: Deviation alert
  Given baseline kWh/unit = 0.20
  And actual kWh/unit = 0.25 (25% higher)
  Then deviation flagged
  And alert triggered if > 10% deviation
```

### AC-4: Energy Cost Calculation

```gherkin
Scenario: Calculate energy cost for batch
  Given energy consumed = 450 kWh
  And rate = $0.10/kWh
  When calculating cost
  Then energy_cost = 450 Ã— 0.10 = $45.00
  And cost per unit = $45 / 2000 = $0.0225/unit
```

### AC-5: Energy Dashboard

```gherkin
Scenario: Energy overview dashboard
  Given user on /oee/energy
  Then page shows:
    | Widget | Content |
    | Today's Consumption | 1,245 kWh, $124.50 |
    | By Machine | Bar chart of kWh per machine |
    | Efficiency Trend | kWh/unit over 30 days |
    | Cost Breakdown | Table by machine |
  And filters: Date range, Machine, Product
```

---

## Deliverables

- [ ] Energy tables and RLS
- [ ] Energy API endpoints
- [ ] EnergyService
- [ ] Energy dashboard page
- [ ] Manual reading entry form
- [ ] Baseline configuration UI
- [ ] Cost analysis charts

---

**Document Status**: Ready
**Lines**: ~350
**Phase**: 1B
