# Story 10.1 - API Specification
# Purpose: Endpoints, request/response schemas, error handling, services
# Agent: BACKEND-DEV (API focus)

endpoints:
  # GET Targets List
  - method: "GET"
    path: "/api/oee/targets"
    description: "List performance targets with filtering and pagination"
    file: "apps/frontend/app/api/oee/targets/route.ts"
    auth: "required"
    roles: ["*"]

    request:
      query_params:
        target_type: "string (optional) - 'organization' | 'line' | 'machine'"
        is_active: "boolean (optional)"
        reference_id: "string (optional) - UUID of line/machine"
        effective_on: "string (optional) - Date filter (YYYY-MM-DD)"
        sort_by: "string (optional) - 'created_at' | 'effective_date' | 'target_type'"
        sort_order: "string (optional) - 'asc' | 'desc'"
        page: "number (optional) - default: 1"
        limit: "number (optional) - default: 20"

    response:
      status: 200
      type: "TargetsListResponse"
      schema:
        targets:
          - id: "string (UUID)"
            org_id: "string (UUID)"
            target_type: "string"
            reference_id: "string | null"
            reference_name: "string | null (joined from lines/machines)"
            oee_target: "number"
            availability_target: "number | null"
            performance_target: "number | null"
            quality_target: "number | null"
            warning_threshold: "number"
            critical_threshold: "number"
            effective_date: "string (YYYY-MM-DD)"
            expiry_date: "string | null"
            is_active: "boolean"
            notes: "string | null"
            created_at: "string (ISO 8601)"
            updated_at: "string (ISO 8601)"
        pagination:
          total: "number"
          page: "number"
          limit: "number"
          pages: "number"

    errors:
      - status: 401
        code: "UNAUTHORIZED"
        message: "Unauthorized"
      - status: 400
        code: "INVALID_QUERY"
        message: "Invalid query parameters"

    performance:
      target_ms: 500

  # GET Target Detail
  - method: "GET"
    path: "/api/oee/targets/:id"
    description: "Get target by ID with usage stats"
    file: "apps/frontend/app/api/oee/targets/[id]/route.ts"
    auth: "required"
    roles: ["*"]

    response:
      status: 200
      schema:
        target: "PerformanceTarget (same as list)"
        usage_count: "number | undefined (count of OEE calculations using this target)"

    errors:
      - status: 404
        code: "NOT_FOUND"
        message: "Target not found"

  # POST Create Target
  - method: "POST"
    path: "/api/oee/targets"
    description: "Create new performance target"
    file: "apps/frontend/app/api/oee/targets/route.ts"
    auth: "required"
    roles: ["admin", "production_manager"]

    request:
      body:
        target_type: "string (required) - 'organization' | 'line' | 'machine'"
        reference_id: "string (optional) - UUID (required if type=line/machine)"
        oee_target: "number (required) - 0-100"
        availability_target: "number (optional) - 0-100"
        performance_target: "number (optional) - 0-100"
        quality_target: "number (optional) - 0-100"
        warning_threshold: "number (optional) - default: 85.0"
        critical_threshold: "number (optional) - default: 75.0"
        effective_date: "string (optional) - YYYY-MM-DD, default: today"
        expiry_date: "string (optional) - YYYY-MM-DD"
        notes: "string (optional)"

    response:
      status: 201
      schema:
        target: "PerformanceTarget"

    errors:
      - status: 400
        code: "VALIDATION_ERROR"
        message: "Invalid target data: {details}"
      - status: 400
        code: "REFERENCE_MISMATCH"
        message: "Organization targets must not have reference_id"
      - status: 404
        code: "REFERENCE_NOT_FOUND"
        message: "Line/machine not found"

    performance:
      target_ms: 300

  # PATCH Update Target
  - method: "PATCH"
    path: "/api/oee/targets/:id"
    description: "Update existing target"
    file: "apps/frontend/app/api/oee/targets/[id]/route.ts"
    auth: "required"
    roles: ["admin", "production_manager"]

    request:
      body:
        oee_target: "number (optional)"
        availability_target: "number (optional)"
        performance_target: "number (optional)"
        quality_target: "number (optional)"
        warning_threshold: "number (optional)"
        critical_threshold: "number (optional)"
        expiry_date: "string (optional)"
        is_active: "boolean (optional)"
        notes: "string (optional)"

    response:
      status: 200
      schema:
        target: "PerformanceTarget"

    errors:
      - status: 404
        code: "NOT_FOUND"
        message: "Target not found"
      - status: 400
        code: "VALIDATION_ERROR"
        message: "Invalid update data"

  # DELETE Target
  - method: "DELETE"
    path: "/api/oee/targets/:id"
    description: "Delete target (soft delete if in use)"
    file: "apps/frontend/app/api/oee/targets/[id]/route.ts"
    auth: "required"
    roles: ["admin", "production_manager"]

    response:
      status: 204

    errors:
      - status: 404
        code: "NOT_FOUND"
        message: "Target not found"
      - status: 409
        code: "IN_USE"
        message: "Target is in use. Set expiry date instead of deleting."

  # GET Resolve Target
  - method: "GET"
    path: "/api/oee/targets/resolve"
    description: "Resolve effective target for machine/line (follows hierarchy)"
    file: "apps/frontend/app/api/oee/targets/resolve/route.ts"
    auth: "required"
    roles: ["*"]

    request:
      query_params:
        type: "string (required) - 'machine' | 'line'"
        id: "string (required) - UUID of machine/line"
        date: "string (optional) - YYYY-MM-DD, default: today"

    response:
      status: 200
      schema:
        effective_target: "PerformanceTarget"
        source: "string - 'machine' | 'line' | 'organization' | 'default'"
        hierarchy:
          machine: "PerformanceTarget | undefined"
          line: "PerformanceTarget | undefined"
          organization: "PerformanceTarget | undefined"

    errors:
      - status: 400
        code: "INVALID_TYPE"
        message: "Type must be 'machine' or 'line'"
      - status: 404
        code: "NOT_FOUND"
        message: "Machine/line not found"

# Services
services:
  - path: "apps/frontend/lib/services/oee-target-service.ts"
    description: "Performance target management service"
    exports:
      - name: "OEETargetService"
        type: "class"
        methods:
          - name: "list"
            type: "static async"
            params: ["params: TargetsListParams"]
            returns: "Promise<PaginatedResult<PerformanceTarget>>"
            description: "List targets with filtering and pagination"

          - name: "getById"
            type: "static async"
            params: ["id: string"]
            returns: "Promise<PerformanceTarget | null>"
            description: "Get target by ID"

          - name: "create"
            type: "static async"
            params: ["input: CreateTargetInput"]
            returns: "Promise<PerformanceTarget>"
            description: "Create new performance target"

          - name: "update"
            type: "static async"
            params: ["id: string", "input: UpdateTargetInput"]
            returns: "Promise<PerformanceTarget>"
            description: "Update existing target"

          - name: "delete"
            type: "static async"
            params: ["id: string"]
            returns: "Promise<void>"
            description: "Delete target (soft delete if in use)"

          - name: "resolveTarget"
            type: "static async"
            params: ["type: 'machine' | 'line'", "referenceId: string", "date?: Date"]
            returns: "Promise<{ effective: PerformanceTarget; source: string }>"
            description: "Resolve effective target following hierarchy"

          - name: "getActiveTarget"
            type: "static async"
            params: ["type: string", "referenceId: string | null", "date: Date"]
            returns: "Promise<PerformanceTarget | null>"
            description: "Get active target for specific date"

          - name: "isInUse"
            type: "static async"
            params: ["targetId: string"]
            returns: "Promise<boolean>"
            description: "Check if target is referenced by OEE calculations"

          - name: "getDefaultTarget"
            type: "static async"
            params: ["orgId: string"]
            returns: "Promise<number>"
            description: "Get default target from settings"

# Types
types:
  - path: "apps/frontend/lib/types/oee-target.ts"
    description: "OEE target TypeScript interfaces"
    exports:
      - "TargetType"
      - "PerformanceTarget"
      - "CreateTargetInput"
      - "UpdateTargetInput"
      - "TargetsListParams"
      - "TargetsListResponse"
      - "ResolveTargetResponse"

# Validation
validation:
  - path: "apps/frontend/lib/validation/oee-target-validation.ts"
    schemas:
      - name: "createTargetSchema"
        validates: "CreateTargetInput"
        rules:
          - "target_type: enum(['organization', 'line', 'machine'])"
          - "reference_id: uuid().optional()"
          - "oee_target: number().min(0).max(100)"
          - "availability_target: number().min(0).max(100).optional()"
          - "performance_target: number().min(0).max(100).optional()"
          - "quality_target: number().min(0).max(100).optional()"
          - "warning_threshold: number().min(0).max(100).default(85.0)"
          - "critical_threshold: number().min(0).max(100).default(75.0)"
          - "effective_date: string().regex(/^\\d{4}-\\d{2}-\\d{2}$/).optional()"
          - "expiry_date: string().regex(/^\\d{4}-\\d{2}-\\d{2}$/).optional()"
          - "notes: string().max(1000).optional()"
        refinements:
          - "Organization targets must not have reference_id"
          - "Line/machine targets require reference_id"
          - "critical_threshold <= warning_threshold"

      - name: "updateTargetSchema"
        validates: "UpdateTargetInput"
        rules:
          - "All fields optional"
          - "Same validation as create for provided fields"
