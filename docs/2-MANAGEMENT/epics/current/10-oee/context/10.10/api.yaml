# Story 10.10 - API Specification
# Purpose: Endpoints, request/response schemas, error handling, services
# Agent: BACKEND-DEV (API focus)

endpoints:
  # GET Utilization Heatmap Data
  - method: "GET"
    path: "/api/oee/analytics/utilization"
    description: "Get machine utilization data for heatmap visualization"
    file: "apps/frontend/app/api/oee/analytics/utilization/route.ts"
    auth: "required"
    roles: ["*"]

    request:
      query_params:
        granularity: "string (required) - 'hourly' | 'daily' | 'weekly'"
        date_from: "string (required) - YYYY-MM-DD"
        date_to: "string (required) - YYYY-MM-DD"
        line_id: "string (optional) - UUID of production line"
        machine_ids: "string (optional) - comma-separated UUIDs"

    response:
      status: 200
      type: "UtilizationHeatmapResponse"
      schema:
        machines:
          - id: "string (UUID)"
            name: "string"
            code: "string"
            line_id: "string | null"
            line_name: "string | null"
        time_slots:
          - slot: "string (ISO 8601 or date)"
            label: "string (display label)"
        data:
          - machine_id: "string (UUID)"
            slot: "string"
            utilization_pct: "number (0-100)"
            actual_time: "number (minutes)"
            planned_time: "number (minutes)"
            status: "string - 'low' | 'medium' | 'high'"
        summary:
          avg_utilization: "number"
          min_utilization: "number"
          max_utilization: "number"
          machines_below_50: "number (count)"

    errors:
      - status: 401
        code: "UNAUTHORIZED"
        message: "Unauthorized"
      - status: 400
        code: "INVALID_GRANULARITY"
        message: "Granularity must be 'hourly', 'daily', or 'weekly'"
      - status: 400
        code: "INVALID_DATE_RANGE"
        message: "date_from must be before date_to"
      - status: 400
        code: "DATE_RANGE_TOO_LARGE"
        message: "Date range exceeds maximum (31 days for hourly, 90 days for daily)"

    performance:
      target_ms: 500

# Services
services:
  - path: "apps/frontend/lib/services/utilization-analytics-service.ts"
    description: "Utilization heatmap analytics service"
    exports:
      - name: "UtilizationAnalyticsService"
        type: "class"
        methods:
          - name: "getHeatmapData"
            type: "static async"
            params: ["params: UtilizationHeatmapParams"]
            returns: "Promise<UtilizationHeatmapResponse>"
            description: "Get aggregated utilization data for heatmap"

          - name: "calculateUtilization"
            type: "static"
            params: ["actualTime: number", "plannedTime: number"]
            returns: "number"
            description: "Calculate utilization percentage"

          - name: "getUtilizationStatus"
            type: "static"
            params: ["utilizationPct: number"]
            returns: "'low' | 'medium' | 'high'"
            description: "Get status based on utilization thresholds"

          - name: "aggregateByGranularity"
            type: "static async"
            params: ["data: OEESnapshot[]", "granularity: string"]
            returns: "AggregatedUtilization[]"
            description: "Aggregate snapshots by time granularity"

          - name: "getSummaryStats"
            type: "static"
            params: ["data: AggregatedUtilization[]"]
            returns: "UtilizationSummary"
            description: "Calculate summary statistics"

# Types
types:
  - path: "apps/frontend/lib/types/utilization-analytics.ts"
    description: "Utilization heatmap TypeScript interfaces"
    exports:
      - "Granularity"
      - "UtilizationHeatmapParams"
      - "UtilizationHeatmapResponse"
      - "UtilizationDataPoint"
      - "UtilizationSummary"
      - "UtilizationStatus"

# Validation
validation:
  - path: "apps/frontend/lib/validation/utilization-analytics-validation.ts"
    schemas:
      - name: "utilizationHeatmapParamsSchema"
        validates: "UtilizationHeatmapParams"
        rules:
          - "granularity: enum(['hourly', 'daily', 'weekly'])"
          - "date_from: string().regex(/^\\d{4}-\\d{2}-\\d{2}$/)"
          - "date_to: string().regex(/^\\d{4}-\\d{2}-\\d{2}$/)"
          - "line_id: uuid().optional()"
          - "machine_ids: string().optional()"
        refinements:
          - "date_to >= date_from"
          - "date range <= 31 days for hourly, <= 90 days for daily/weekly"

# Color Thresholds
color_thresholds:
  low:
    range: "0-50%"
    color: "#ef4444"  # red-500
    status: "low"
  medium:
    range: "50-80%"
    color: "#eab308"  # yellow-500
    status: "medium"
  high:
    range: "80-100%"
    color: "#22c55e"  # green-500
    status: "high"
