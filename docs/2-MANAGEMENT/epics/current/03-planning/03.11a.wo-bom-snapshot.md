# 03.11a - WO BOM Snapshot (Materials Copy)

**Priority**: P0 (MVP)
**Story Points**: L (Large - 5-7 days)
**Type:** backend + frontend

**State:** ready
**Primary PRD:** `docs/1-BASELINE/product/modules/planning.md` (FR-PLAN-019)
**Architecture:** `docs/1-BASELINE/architecture/modules/planning.md`
**ADR Reference:** `docs/1-BASELINE/architecture/decisions/ADR-002-bom-snapshot-pattern.md`
**UX Wireframes:** PLA-XXX (pending)

---

## MVP Scope

This story implements the immutable BOM snapshot pattern: when a Work Order is created, all BOM items are copied to `wo_materials` with quantity scaling. The snapshot becomes the source of truth for production, ensuring that subsequent BOM changes do not affect existing WOs.

**MVP includes:**
- `wo_materials` table creation and schema
- BOM snapshot service (copy bom_items to wo_materials)
- Quantity scaling formula with scrap percentage
- BOM version tracking
- API endpoint to trigger/refresh snapshot
- Read-only materials list UI on WO detail page
- Validation schemas
- Comprehensive tests

**Deferred to 03.11b (Post Epic 05):**
- Material reservation (requires LP table from Epic 05)
- LP selection for materials
- Reserved quantity management

---

## Goal

Implement the BOM snapshot pattern to copy BOM items into `wo_materials` at Work Order creation, applying quantity scaling and scrap percentage, ensuring immutability after WO release.

## User Story

As a **Production Planner**, I want **the BOM items to be automatically copied to the Work Order with scaled quantities** so that **production always uses the correct material requirements regardless of future BOM changes**.

## Scope

**In scope (this story)**
- Database migration for `wo_materials` table
- BOM snapshot copy logic on WO creation
- Quantity scaling formula: `(wo_qty / bom.output_qty) * item_qty * (1 + scrap_percent/100)`
- BOM version tracking (bom_version, bom_item_id fields)
- API endpoint: POST `/api/planning/work-orders/:id/snapshot` (re-trigger before release)
- GET `/api/planning/work-orders/:id/materials` endpoint
- WOMaterialsTable component (read-only display on WO detail page)
- Service layer for snapshot creation and scaling
- Zod validation schemas
- Unit tests for scaling calculations and edge cases
- Integration tests for snapshot immutability

**Out of scope (this story)**
- WO CRUD (covered in 03.10)
- WO Operations copy (covered in 03.12)
- Material reservation (deferred to 03.11b after Epic 05)
- Material availability check (deferred to 03.13 after Epic 05)
- Material consumption tracking (Epic 04)
- By-product output handling (Epic 04)

## Dependencies

- **01.1** - Org Context + Base RLS (for multi-tenant isolation)
- **03.10** - WO CRUD + BOM Auto-Select (provides work_orders table, bom_id)
- **02.4** - BOMs CRUD (provides boms table with output_qty)
- **02.5a** - BOM Items Core (provides bom_items table)

## Acceptance Criteria (Given/When/Then)

### AC-1: BOM Snapshot Created on WO Creation

**Given** a Work Order is created with product_id and planned_quantity
**When** the WO creation API completes
**Then** all bom_items from the selected BOM are copied to wo_materials with scaled quantities

**Given** BOM has 10 items
**When** WO is created
**Then** 10 wo_materials records are created with wo_id set

### AC-2: Quantity Scaling Formula

**Given** BOM has output_qty = 100 kg, bom_item flour with quantity = 50 kg
**When** WO is created with planned_quantity = 250 kg
**Then** wo_material.required_qty = 50 * (250/100) = 125 kg

**Given** BOM item has scrap_percent = 5%
**When** WO is created
**Then** required_qty includes scrap: 125 * (1 + 5/100) = 131.25 kg

**Given** BOM item has quantity = 0.001234 (6 decimal precision)
**When** scaled for WO
**Then** required_qty maintains precision up to 6 decimal places

### AC-3: BOM Version Tracking

**Given** BOM has version = 3
**When** WO snapshot created
**Then** each wo_material record has bom_version = 3

**Given** bom_item.id = "abc-123"
**When** copied to wo_material
**Then** wo_material.bom_item_id = "abc-123" for audit reference

### AC-4: Snapshot Immutability After Release

**Given** WO status = 'draft' or 'planned'
**When** POST `/api/planning/work-orders/:id/snapshot` called
**Then** wo_materials are deleted and re-created from current BOM

**Given** WO status = 'released' or 'in_progress' or 'completed'
**When** POST `/api/planning/work-orders/:id/snapshot` called
**Then** API returns 409 Conflict: "Cannot modify materials after WO is released"

**Given** source BOM is updated after WO is released
**When** user views WO materials
**Then** WO materials remain unchanged (original snapshot preserved)

### AC-5: Materials List Display

**Given** WO detail page `/planning/work-orders/:id`
**When** materials section loads
**Then** wo_materials display in sequence order within 500ms

**Given** wo_materials table rendered
**When** viewing row
**Then** each row shows: sequence, material code, material name, required_qty, uom, scrap%, consumed_qty (0), reserved_qty (0)

**Given** WO status = 'draft'
**When** materials section displayed
**Then** "Refresh from BOM" button is visible and enabled

**Given** WO status = 'released'
**When** materials section displayed
**Then** "Refresh from BOM" button is hidden or disabled with tooltip "Materials locked after release"

### AC-6: Empty BOM Handling

**Given** WO created with BOM that has zero items
**When** snapshot created
**Then** wo_materials table is empty (0 records), warning logged

**Given** WO created without bom_id (no BOM selected)
**When** WO creation attempted
**Then** API returns 400 Bad Request if wo_require_bom = true in settings
**Or** WO created with empty wo_materials if wo_require_bom = false

### AC-7: Conditional Items (Phase 1 Prep)

**Given** bom_item has condition_flags = {"organic": true}
**When** BOM snapshot created
**Then** condition_flags copied to wo_material.condition_flags for future use

**Note:** Conditional filtering logic is Phase 1; MVP copies flags without filtering.

### AC-8: By-Products Included

**Given** bom_item has is_by_product = true, yield_percent = 5
**When** BOM snapshot created
**Then** wo_material created with is_by_product = true, yield_percent = 5, required_qty = 0

**Given** by-product in wo_materials
**When** displayed in table
**Then** row shows with "By-product" badge, required_qty = 0

### AC-9: Material Name Denormalization

**Given** bom_item references product_id with name = "All-Purpose Flour"
**When** snapshot created
**Then** wo_material.material_name = "All-Purpose Flour" (denormalized for display)

**Given** product name changes after WO creation
**When** WO materials viewed
**Then** original material_name preserved (part of snapshot)

### AC-10: API Validation

**Given** invalid wo_id in POST `/api/planning/work-orders/:id/snapshot`
**When** API called
**Then** returns 404 Not Found

**Given** WO belongs to different org_id
**When** snapshot API called
**Then** returns 403 Forbidden (RLS enforced)

### AC-11: Performance Requirements

**Given** BOM has 100 items
**When** snapshot created
**Then** all wo_materials inserted in single transaction within 2 seconds

**Given** WO detail page loaded
**When** materials section queried
**Then** response within 500ms for up to 200 materials

### AC-12: Future Features (Phase 1+)

Features deferred to Phase 1+:
- **Material Reservation (03.11b)** - reserved_qty column exists but defaults to 0
- **Material Availability Check (03.13)** - availability panel hidden in MVP
- **LP Assignment** - consume_whole_lp flag copied but not actionable until Epic 05

**Implementation**: Per Epic 03.0 guidance, reservation UI elements hidden in MVP.

---

## Implementation Notes

### API Endpoints

```typescript
// GET /api/planning/work-orders/:id/materials
// Returns all wo_materials for a WO
interface WOMaterialsListResponse {
  materials: WOMaterial[];
  total: number;
  bom_version: number | null;
  snapshot_at: string | null;  // ISO timestamp
}

// POST /api/planning/work-orders/:id/snapshot
// Triggers BOM snapshot (creates/refreshes wo_materials)
// Only allowed when WO status in ['draft', 'planned']
interface CreateSnapshotResponse {
  success: boolean;
  materials_count: number;
  message: string;
}

// Response codes:
// 200 - Snapshot created/refreshed successfully
// 400 - Bad request (missing BOM, validation error)
// 403 - Forbidden (RLS violation)
// 404 - WO not found
// 409 - Conflict (WO already released, cannot modify)
```

### Database

```sql
-- wo_materials table (new)
CREATE TABLE wo_materials (
  id                  UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  wo_id               UUID NOT NULL REFERENCES work_orders(id) ON DELETE CASCADE,
  organization_id     UUID NOT NULL REFERENCES organizations(id),
  product_id          UUID NOT NULL REFERENCES products(id),
  material_name       TEXT NOT NULL,           -- Denormalized for snapshot
  required_qty        DECIMAL(15,6) NOT NULL,  -- Scaled from BOM
  consumed_qty        DECIMAL(15,6) DEFAULT 0, -- Updated during production (Epic 04)
  reserved_qty        DECIMAL(15,6) DEFAULT 0, -- Reservation (03.11b)
  uom                 TEXT NOT NULL,
  sequence            INTEGER DEFAULT 0,
  consume_whole_lp    BOOLEAN DEFAULT false,
  is_by_product       BOOLEAN DEFAULT false,
  yield_percent       DECIMAL(5,2),            -- By-product yield
  scrap_percent       DECIMAL(5,2) DEFAULT 0,
  condition_flags     JSONB,                   -- Conditional item flags
  bom_item_id         UUID,                    -- Reference to source bom_item
  bom_version         INTEGER,                 -- BOM version at snapshot
  notes               TEXT,
  created_at          TIMESTAMPTZ DEFAULT now(),

  CONSTRAINT chk_required_qty CHECK (required_qty >= 0),
  CONSTRAINT chk_consumed_qty CHECK (consumed_qty >= 0),
  CONSTRAINT chk_reserved_qty CHECK (reserved_qty >= 0),
  CONSTRAINT chk_scrap_percent CHECK (scrap_percent >= 0 AND scrap_percent <= 100)
);

-- Indexes
CREATE INDEX idx_wo_materials_wo ON wo_materials(wo_id);
CREATE INDEX idx_wo_materials_product ON wo_materials(product_id);
CREATE INDEX idx_wo_materials_org ON wo_materials(organization_id);

-- RLS Policy
ALTER TABLE wo_materials ENABLE ROW LEVEL SECURITY;

CREATE POLICY "wo_materials org isolation" ON wo_materials
FOR ALL USING (
  organization_id = (SELECT org_id FROM users WHERE id = auth.uid())
);
```

### Frontend Components

```
app/(authenticated)/planning/work-orders/[id]/page.tsx  -- WO detail page (update)
components/planning/work-orders/
  WOMaterialsTable.tsx        -- Materials list table (new)
  WOMaterialRow.tsx           -- Single material row (new)
  RefreshSnapshotButton.tsx   -- Trigger snapshot refresh (new)
```

### Services

```typescript
// lib/services/wo-snapshot-service.ts (new)

/**
 * Creates BOM snapshot for a Work Order.
 * Copies all bom_items to wo_materials with quantity scaling.
 */
export async function createBOMSnapshot(
  woId: string,
  bomId: string,
  woPlannedQty: number
): Promise<WOMaterial[]>

/**
 * Scales BOM item quantity for WO.
 * Formula: (wo_qty / bom_output_qty) * item_qty * (1 + scrap_percent/100)
 */
export function scaleQuantity(
  itemQty: number,
  woQty: number,
  bomOutputQty: number,
  scrapPercent: number = 0
): number

/**
 * Checks if WO snapshot can be modified (status not released/in_progress/completed)
 */
export function canModifySnapshot(woStatus: string): boolean

/**
 * Deletes existing wo_materials and recreates from current BOM
 */
export async function refreshSnapshot(woId: string): Promise<WOMaterial[]>

/**
 * Gets all wo_materials for a WO
 */
export async function getWOMaterials(woId: string): Promise<WOMaterial[]>
```

### Validation (Zod)

```typescript
// lib/validation/wo-materials.ts

const woMaterialSchema = z.object({
  wo_id: z.string().uuid("Work Order ID is required"),
  product_id: z.string().uuid("Product ID is required"),
  material_name: z.string().min(1, "Material name is required").max(255),
  required_qty: z.number()
    .nonnegative("Required quantity must be >= 0")
    .refine(val => {
      const decimals = (val.toString().split('.')[1] || '').length;
      return decimals <= 6;
    }, "Maximum 6 decimal places allowed"),
  consumed_qty: z.number().nonnegative().default(0),
  reserved_qty: z.number().nonnegative().default(0),
  uom: z.string().min(1, "Unit of measure is required"),
  sequence: z.number().int().min(0).default(0),
  consume_whole_lp: z.boolean().default(false),
  is_by_product: z.boolean().default(false),
  yield_percent: z.number().min(0).max(100).nullable().optional(),
  scrap_percent: z.number().min(0).max(100).default(0),
  condition_flags: z.record(z.boolean()).nullable().optional(),
  bom_item_id: z.string().uuid().nullable().optional(),
  bom_version: z.number().int().nullable().optional(),
  notes: z.string().max(500).nullable().optional(),
});

const createSnapshotRequestSchema = z.object({
  // No body required - uses WO's existing bom_id
});
```

### Key Business Rules

1. **Scaling Formula**: `required_qty = (wo_qty / bom.output_qty) * bom_item.quantity * (1 + scrap_percent/100)`
2. **Immutability**: Once WO status = 'released', wo_materials cannot be modified
3. **Version Tracking**: bom_version captures BOM.version at snapshot time for audit
4. **By-Products**: Copied with is_by_product = true, required_qty = 0
5. **Name Denormalization**: material_name copied from product.name at snapshot time
6. **RLS**: All queries filtered by organization_id
7. **Cascade Delete**: wo_materials deleted when parent WO deleted

---

## Deliverables

- Migration: Create `wo_materials` table with indexes and RLS
- API routes:
  - GET `/api/planning/work-orders/:id/materials`
  - POST `/api/planning/work-orders/:id/snapshot`
- WOMaterialsTable component
- RefreshSnapshotButton component
- wo-snapshot-service.ts
- wo-materials validation schemas
- Unit tests for scaleQuantity function (edge cases)
- Unit tests for wo-snapshot-service (>80% coverage)
- Integration tests for snapshot API endpoints
- Integration tests for immutability enforcement

---

## Definition of Done

- [ ] Migration creates wo_materials table with all fields
- [ ] RLS policy enforces org isolation
- [ ] BOM snapshot created automatically on WO creation (03.10 integration)
- [ ] Quantity scaling formula correctly applied
- [ ] Scrap percentage included in calculation
- [ ] BOM version and bom_item_id tracked for audit
- [ ] Snapshot refresh works for draft/planned WOs
- [ ] Snapshot refresh blocked for released WOs (409 response)
- [ ] WOMaterialsTable displays materials within 500ms
- [ ] By-products displayed with badge
- [ ] Refresh button conditionally shown based on status
- [ ] All API endpoints have integration tests
- [ ] Unit tests cover scaleQuantity edge cases:
  - [ ] Standard scaling (output_qty > 1)
  - [ ] Unit BOM (output_qty = 1)
  - [ ] Scrap percentage applied
  - [ ] Zero scrap percentage
  - [ ] 6 decimal precision maintained
  - [ ] Large batch scaling (1000x)
- [ ] Immutability tests pass (cannot modify after release)
- [ ] Performance: <2s for 100-item BOM snapshot creation

---

## Test Cases

### Unit Tests: scaleQuantity Function

```typescript
describe('scaleQuantity', () => {
  it('scales correctly for standard BOM', () => {
    // BOM: 100kg output, 50kg flour
    // WO: 250kg planned
    expect(scaleQuantity(50, 250, 100, 0)).toBe(125);
  });

  it('applies scrap percentage', () => {
    // 125kg + 5% scrap = 131.25kg
    expect(scaleQuantity(50, 250, 100, 5)).toBeCloseTo(131.25, 2);
  });

  it('handles unit BOM (output_qty = 1)', () => {
    // BOM: 1 unit output, 0.5kg ingredient
    // WO: 10 units planned
    expect(scaleQuantity(0.5, 10, 1, 0)).toBe(5);
  });

  it('maintains 6 decimal precision', () => {
    const result = scaleQuantity(0.000001, 100, 1, 0);
    expect(result).toBe(0.0001);
  });

  it('handles large batch scaling', () => {
    // 1000x scaling
    expect(scaleQuantity(1, 1000, 1, 0)).toBe(1000);
  });

  it('handles fractional output_qty', () => {
    // BOM: 0.5kg output, 0.25kg ingredient
    // WO: 2kg planned
    expect(scaleQuantity(0.25, 2, 0.5, 0)).toBe(1);
  });

  it('handles 100% scrap (doubles quantity)', () => {
    expect(scaleQuantity(10, 100, 100, 100)).toBe(20);
  });
});
```

### Integration Tests: Snapshot API

```typescript
describe('POST /api/planning/work-orders/:id/snapshot', () => {
  it('creates snapshot for draft WO', async () => {
    const wo = await createDraftWO({ bom_id: bomWithItems.id });
    const res = await request.post(`/api/planning/work-orders/${wo.id}/snapshot`);
    expect(res.status).toBe(200);
    expect(res.body.materials_count).toBeGreaterThan(0);
  });

  it('refuses snapshot for released WO', async () => {
    const wo = await createReleasedWO();
    const res = await request.post(`/api/planning/work-orders/${wo.id}/snapshot`);
    expect(res.status).toBe(409);
  });

  it('refreshes snapshot (replaces existing)', async () => {
    const wo = await createDraftWO({ bom_id: bom1.id });
    await request.post(`/api/planning/work-orders/${wo.id}/snapshot`);

    // Update WO to use different BOM
    await updateWO(wo.id, { bom_id: bom2.id });

    const res = await request.post(`/api/planning/work-orders/${wo.id}/snapshot`);
    expect(res.status).toBe(200);

    const materials = await getWOMaterials(wo.id);
    expect(materials[0].bom_item_id).toBe(bom2.items[0].id);
  });
});
```

---

## Future Phases (Not in MVP)

### Phase 1 (Story 03.11b - After Epic 05)
- Material reservation against License Plates
- Reserved quantity tracking and display
- Reservation release on WO cancel
- LP selection modal for materials

### Phase 1 (Story 03.13 - After Epic 05)
- Material availability check
- Green/Yellow/Red availability indicators
- Availability panel on WO form

### Phase 2
- Conditional item filtering based on flags
- Alternative material selection
- Material substitution during production

**Implementation**: See Epic 03.0 "Future Feature Handling" section.

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-12-16 | Initial story - BOM snapshot pattern | ARCHITECT-AGENT |
