# Epic 03 Planning Module - Story Creation Brief

**Date:** 2025-12-16
**Author:** ARCHITECT-AGENT
**Status:** READY FOR STORY CREATION
**Target Audience:** Story-writing agents (DEV-AGENT, TECH-WRITER)

---

## Executive Summary

This brief provides comprehensive guidance for creating Epic 03 (Planning Module) stories. The Planning Module is the operational backbone of MonoPilot, handling suppliers, purchase orders, transfer orders, work orders, and (Phase 2+) demand planning.

**Key Statistics:**
- PRD Lines: ~2,800
- Functional Requirements: 72 total (FR-PLAN-001 to FR-PLAN-072)
- Phase 1 (MVP): FR-PLAN-001 to FR-PLAN-025 (25 requirements)
- Phase 2: FR-PLAN-030 to FR-PLAN-042 (13 requirements)
- Phase 3: FR-PLAN-050 to FR-PLAN-072 (15+ requirements)
- Architecture: `/docs/1-BASELINE/architecture/modules/planning.md`
- PRD: `/docs/1-BASELINE/product/modules/planning.md`

---

## 1. Story Breakdown Strategy

### 1.1 Major Feature Areas

| Area | PRD Section | FRs | MVP Stories | Phase 1 Stories | Phase 2 Stories |
|------|-------------|-----|-------------|-----------------|-----------------|
| **Suppliers** | Section 4 | FR-001 to 004 | 03.1, 03.2 | - | - |
| **Purchase Orders** | Section 5 | FR-005 to 011 | 03.3, 03.4, 03.5a | 03.5b, 03.6 | 03.7 (Templates) |
| **Transfer Orders** | Section 6 | FR-012 to 016 | 03.8, 03.9a | 03.9b | - |
| **Work Orders** | Section 7 | FR-017 to 025 | 03.10, 03.11a, 03.12 | 03.11b, 03.13 | 03.14 (Gantt) |
| **Planning Dashboard** | Section 8 | - | 03.15 | - | - |
| **Planning Settings** | Section 9 | - | 03.16 | - | - |
| **Demand Planning** | Section 10-12 | FR-030 to 042 | - | - | Epic 03b (Phase 2) |

### 1.2 Stories Requiring Phase Split (.Xa/.Xb/.Xc)

Apply phase split pattern from `PHASE-SPLIT-PROPOSAL.md` when:
1. Feature has MVP core + advanced capabilities
2. Clear technical boundary exists
3. Separate can be developed without conflicts

| Story | Split Recommendation | Rationale |
|-------|---------------------|-----------|
| **03.5 PO Approval** | 03.5a (Basic CRUD), 03.5b (Approval Workflow) | Approval is Should Have, can defer |
| **03.9 TO LP Selection** | 03.9a (Basic TO), 03.9b (LP Pre-selection) | LP selection requires Epic 05 integration |
| **03.11 WO Materials** | 03.11a (BOM Snapshot), 03.11b (Material Reservation) | Reservation requires LP table |
| **03.14 WO Gantt** | DEFER to Phase 1 | Could Have, complex visualization |

### 1.3 Stories NOT Requiring Split

| Story | Reason | Complexity |
|-------|--------|------------|
| 03.1 | Suppliers CRUD - focused scope | M |
| 03.2 | Supplier-Product Assignment - focused | M |
| 03.3 | PO CRUD + Lines - must be together | L |
| 03.4 | Bulk PO Creation - standalone feature | M |
| 03.8 | TO CRUD + Lines - must be together | L |
| 03.10 | WO CRUD + BOM Auto-Select - must be together | L |
| 03.12 | WO Operations Copy - focused scope | M |
| 03.15 | Planning Dashboard - focused MVP | M |
| 03.16 | Planning Settings - configuration only | M |

---

## 2. MVP Scope Definition

### 2.1 What Must Be in MVP (for Epic 04/05 to Work)

Epic 04 (Production) and Epic 05 (Warehouse) depend on:

| Planning Entity | Why Required | Used By |
|-----------------|--------------|---------|
| **Work Orders** | Production execution starts from WO | Epic 04 |
| **wo_materials** | Material consumption tracking | Epic 04, 05 |
| **wo_operations** | Production step tracking | Epic 04 |
| **Purchase Orders** | PO Receiving creates LPs | Epic 05 |
| **Transfer Orders** | TO Ship/Receive moves LPs | Epic 05 |
| **Suppliers** | Required FK for POs | Epic 03 (internal) |

### 2.2 MVP Stories (P0 - Must Have)

| Story | Name | FRs | Enables |
|-------|------|-----|---------|
| 03.1 | Suppliers CRUD | FR-001, FR-004 | 03.2, 03.3 |
| 03.2 | Supplier-Product Assignment | FR-002, FR-003 | 03.3, 03.4 |
| 03.3 | PO CRUD + Lines | FR-005, FR-006, FR-007, FR-010 | Epic 05 Receiving |
| 03.4 | Bulk PO Creation | FR-008 | Efficiency |
| 03.8 | TO CRUD + Lines | FR-012, FR-013, FR-014 | Epic 05 Transfer |
| 03.10 | WO CRUD + BOM Auto-Select | FR-017, FR-018 | 03.11, Epic 04 |
| 03.11a | WO Materials (BOM Snapshot) | FR-019 | Epic 04 |
| 03.12 | WO Operations Copy | FR-020 | Epic 04 |
| 03.15 | Planning Dashboard | - | Visibility |
| 03.16 | Planning Settings | - | Configuration |

**Total MVP Stories: 10**

### 2.3 Phase 1 Stories (P1 - Should Have)

| Story | Name | FRs | Notes |
|-------|------|-----|-------|
| 03.5a | PO Approval Setup | FR-009 (partial) | Settings only |
| 03.5b | PO Approval Workflow | FR-009 | Full workflow |
| 03.6 | Configurable PO Statuses | FR-011 | Status editor |
| 03.9a | TO Partial Shipments | FR-015 | Shipping flexibility |
| 03.9b | TO LP Pre-Selection | FR-016 | Requires Epic 05 |
| 03.11b | WO Material Reservation | FR-025 | Requires LP table |
| 03.13 | WO Material Availability Check | FR-021 | Requires LP table |

**Total Phase 1 Stories: 7**

### 2.4 Phase 2 Stories (P2 - Could Have / Deferred)

| Story | Name | FRs | Notes |
|-------|------|-----|-------|
| 03.7 | PO Templates + Blanket POs | FR-041, FR-042 | Advanced procurement |
| 03.14 | WO Gantt Chart View | FR-024 | Complex visualization |
| 03.17 | Configurable WO Statuses | FR-023 | Status editor |

**Note:** Demand Planning (FR-030 to FR-040) deferred to separate Epic 03b (Phase 2 release)

### 2.5 Dependencies on Epic 01 (Settings) and Epic 02 (Technical)

| From Epic | What | Used By (Epic 03) |
|-----------|------|-------------------|
| 01.1 | Org Context + RLS | ALL stories (multi-tenancy) |
| 01.X | Warehouses | PO (warehouse_id), TO (from/to warehouse) |
| 01.X | Production Lines | WO (line_id assignment) |
| 01.X | Machines | WO (machine_id assignment) |
| 01.X | Tax Codes | Suppliers (tax_code_id), PO |
| 02.1 | Products | Suppliers, PO Lines, TO Lines, WO |
| 02.4 | BOMs | WO (bom_id, BOM snapshot) |
| 02.7 | Routings | WO (routing_id, operations copy) |

**Critical Path:**
```
Epic 01.1 (Org + RLS) --> Epic 02.1 (Products) --> Epic 03.1 (Suppliers)
                                                --> Epic 03.10 (WO)
Epic 02.4 (BOMs) + 02.7 (Routings) --> Epic 03.10 (WO with BOM/Routing)
Epic 01.X (Warehouses) --> Epic 03.3 (PO), Epic 03.8 (TO)
```

---

## 3. Story Template

### 3.1 Standard Story Structure

All Epic 03 stories should follow this template:

```markdown
# 03.X - [Story Title]

**Priority**: P0 (MVP) | P1 (Phase 1) | P2 (Phase 2)
**Story Points**: S (1-2 days) | M (3-4 days) | L (5-7 days)
**Type:** backend | frontend | backend + frontend

**State:** ready
**Primary PRD:** `docs/1-BASELINE/product/modules/planning.md` (FR-PLAN-XXX)
**Architecture:** `docs/1-BASELINE/architecture/modules/planning.md`
**UX Wireframes:** PLA-XXX (if available)

---

## MVP Scope

[Describe what is in this story's MVP scope]

---

## Goal

[1-2 sentences describing the objective]

## User Story

As a **[role]**, I want **[action]** so that **[benefit]**.

## Scope

**In scope (this story)**
- [Specific features]

**Out of scope (this story)**
- [What's NOT included, reference other stories]

## Dependencies
- **01.X** - [Description]
- **02.X** - [Description]
- **03.X** - [Description if internal dependency]

## Acceptance Criteria (Given/When/Then)

### AC-1: [Feature Name]

**Given** [precondition]
**When** [action]
**Then** [expected result]

[Repeat for all ACs - aim for 5-10 ACs per story]

### AC-X: Future Features (Phase 1+)

Features deferred to Phase 1+:
- [Feature A] - Brief description
- [Feature B] - Brief description

**Implementation**: Per Epic 03.0 guidance, hide or show as "Coming Soon".

## Implementation Notes

### API Endpoints

```typescript
// List endpoints with request/response types
GET /api/planning/[resource]
POST /api/planning/[resource]
PUT /api/planning/[resource]/:id
DELETE /api/planning/[resource]/:id
```

### Database

```sql
-- Reference tables from architecture doc
-- Include any migration notes
```

### Frontend Components

```
app/(authenticated)/planning/[route]/
components/planning/
  [ComponentName].tsx
```

### Services

```typescript
// lib/services/[resource]-service.ts
export async function [operation](): Promise<[Type]>
```

### Validation (Zod)

```typescript
const [schema]Schema = z.object({
  // Fields
});
```

### Key Business Rules

1. [Rule 1]
2. [Rule 2]

## Deliverables

- API routes: [list endpoints]
- Components: [list components]
- Services: [list services]
- Tests: [describe test coverage]

## Definition of Done

- [ ] [Checkbox items]
- [ ] API tests passing (>80% coverage)
- [ ] E2E smoke test for critical path
- [ ] Performance: [specific targets]

---

## Future Phases (Not in MVP)

### Phase 1
- [Feature] - Brief description

### Phase 2
- [Feature] - Brief description

**Implementation**: See Epic 03.0 "Future Feature Handling" section.

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | YYYY-MM-DD | Initial story | [Agent] |
```

### 3.2 Required Sections

Every story MUST have:
1. **MVP Scope** - Clear boundaries
2. **User Story** - As a / I want / So that
3. **Scope** - In/Out scope lists
4. **Dependencies** - Cross-story references
5. **Acceptance Criteria** - Given/When/Then format
6. **Implementation Notes** - API, DB, Frontend, Services
7. **Definition of Done** - Checkboxes
8. **Future Phases** - Deferred features

### 3.3 Complexity Guidelines

| Complexity | Days | When to Use | Model |
|------------|------|-------------|-------|
| S (Small) | 1-2 | Single entity CRUD, simple UI | sonnet |
| M (Medium) | 3-4 | Entity + relationships, moderate UI | sonnet |
| L (Large) | 5-7 | Complex logic, multiple entities, rich UI | opus |

---

## 4. Dependency Map

### 4.1 Story Dependencies Within Epic 03

```
                    ┌─────────────────┐
                    │ 03.16 Settings  │
                    └────────┬────────┘
                             │ (configures all)
         ┌───────────────────┼───────────────────┐
         │                   │                   │
         v                   v                   v
┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐
│ 03.1 Suppliers  │ │ 03.8 TO CRUD    │ │ 03.10 WO CRUD   │
└────────┬────────┘ └────────┬────────┘ └────────┬────────┘
         │                   │                   │
         v                   v                   v
┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐
│ 03.2 Supplier-  │ │ 03.9a Partial   │ │ 03.11a WO Mats  │
│    Products     │ │   Shipments     │ │  (BOM Snapshot) │
└────────┬────────┘ └────────┬────────┘ └────────┬────────┘
         │                   │                   │
         v                   │                   v
┌─────────────────┐          │          ┌─────────────────┐
│ 03.3 PO CRUD    │          │          │ 03.12 WO Ops    │
└────────┬────────┘          │          │  (Routing Copy) │
         │                   │          └────────┬────────┘
         v                   │                   │
┌─────────────────┐          │                   v
│ 03.4 Bulk PO    │          │          ┌─────────────────┐
└────────┬────────┘          │          │ 03.13 Material  │
         │                   │          │   Availability  │
         v                   │          └─────────────────┘
┌─────────────────┐          │                   │
│ 03.5a Approval  │          │                   v
│   Setup         │          │          ┌─────────────────┐
└────────┬────────┘          │          │ 03.11b Material │
         │                   │          │   Reservation   │
         v                   │          └─────────────────┘
┌─────────────────┐          │                   │
│ 03.5b Approval  │          │                   v
│   Workflow      │          │          ┌─────────────────┐
└─────────────────┘          │          │ 03.14 Gantt     │
                             │          │   Chart View    │
                             v          └─────────────────┘
                    ┌─────────────────┐
                    │ 03.9b TO LP     │
                    │  Pre-Selection  │
                    │ (needs Epic 05) │
                    └─────────────────┘
```

### 4.2 External Dependencies (from Epic 01 + 02)

| Epic 03 Story | Requires From Epic 01 | Requires From Epic 02 |
|---------------|----------------------|----------------------|
| 03.1 Suppliers | 01.1 (Org+RLS), 01.X (Tax Codes) | - |
| 03.2 Supplier-Products | 01.1 | 02.1 (Products) |
| 03.3 PO CRUD | 01.1, 01.X (Warehouses, Tax Codes) | 02.1 (Products) |
| 03.8 TO CRUD | 01.1, 01.X (Warehouses) | 02.1 (Products) |
| 03.10 WO CRUD | 01.1, 01.X (Lines, Machines) | 02.1, 02.4 (BOMs), 02.7 (Routings) |
| 03.11a WO Materials | - | 02.4 (BOMs), 02.5a (BOM Items) |
| 03.12 WO Operations | 01.X (Machines, Lines) | 02.7, 02.8 (Routings, Operations) |

### 4.3 Optional Dependencies (Nullable FKs)

These dependencies are OPTIONAL - stories should handle gracefully if absent:

| Field | Table | Behavior if NULL |
|-------|-------|------------------|
| `line_id` | work_orders | WO works without line assignment |
| `machine_id` | work_orders, wo_operations | Dropdown shows empty state |
| `routing_id` | work_orders | WO works with BOM only |

---

## 5. Agent Assignment Strategy

### 5.1 Parallel Development Waves

**Wave 1 (Foundation) - Days 1-3**
Can run in parallel, no internal dependencies:

| Story | Agent | Model | Days |
|-------|-------|-------|------|
| 03.1 Suppliers CRUD | BACKEND-DEV | sonnet | 2 |
| 03.16 Planning Settings | BACKEND-DEV | sonnet | 2 |

**Wave 2 (Relationships) - Days 3-6**
Depends on Wave 1:

| Story | Agent | Model | Days | Depends On |
|-------|-------|-------|------|------------|
| 03.2 Supplier-Products | BACKEND-DEV | sonnet | 2 | 03.1 |
| 03.8 TO CRUD + Lines | FULLSTACK-DEV | sonnet | 4 | 03.16 |
| 03.10 WO CRUD + BOM Auto | FULLSTACK-DEV | opus | 5 | 03.16 |

**Wave 3 (Core Features) - Days 6-10**
Depends on Wave 2:

| Story | Agent | Model | Days | Depends On |
|-------|-------|-------|------|------------|
| 03.3 PO CRUD + Lines | FULLSTACK-DEV | opus | 5 | 03.1, 03.2 |
| 03.11a WO Materials | BACKEND-DEV | opus | 4 | 03.10 |
| 03.12 WO Operations | BACKEND-DEV | sonnet | 3 | 03.10 |

**Wave 4 (Advanced) - Days 10-14**
Depends on Wave 3:

| Story | Agent | Model | Days | Depends On |
|-------|-------|-------|------|------------|
| 03.4 Bulk PO Creation | FULLSTACK-DEV | sonnet | 3 | 03.3 |
| 03.15 Planning Dashboard | FRONTEND-DEV | sonnet | 3 | 03.3, 03.8, 03.10 |
| 03.9a TO Partial Ship | BACKEND-DEV | sonnet | 2 | 03.8 |

**Wave 5 (Phase 1) - Days 14-18**

| Story | Agent | Model | Days | Depends On |
|-------|-------|-------|------|------------|
| 03.5a PO Approval Setup | BACKEND-DEV | sonnet | 2 | 03.3, 03.16 |
| 03.5b PO Approval Workflow | FULLSTACK-DEV | sonnet | 3 | 03.5a |
| 03.6 Configurable Statuses | FULLSTACK-DEV | sonnet | 2 | 03.16 |

**Wave 6 (After Epic 05) - Deferred**

| Story | Agent | Model | Days | Depends On |
|-------|-------|-------|------|------------|
| 03.9b TO LP Pre-Selection | FULLSTACK-DEV | sonnet | 3 | Epic 05 (LPs) |
| 03.11b WO Material Reservation | BACKEND-DEV | opus | 4 | Epic 05 (LPs) |
| 03.13 Material Availability | FULLSTACK-DEV | opus | 4 | Epic 05 (LPs) |
| 03.14 WO Gantt Chart | FRONTEND-DEV | opus | 5 | 03.10, 03.12 |

### 5.2 Model Selection Guidelines

| Criterion | Use Opus | Use Sonnet |
|-----------|----------|------------|
| Complexity | L (5+ days) | S/M (1-4 days) |
| Multiple entities | 3+ tables | 1-2 tables |
| Complex business logic | BOM snapshot, MRP | Simple CRUD |
| Rich UI interactions | Gantt, drag-drop | Tables, forms |
| Integration complexity | Multiple modules | Single module |

**Opus-Required Stories:**
- 03.3 PO CRUD + Lines (pricing, status, lines)
- 03.10 WO CRUD + BOM Auto-Select (BOM date logic)
- 03.11a WO Materials BOM Snapshot (scaling, immutability)
- 03.11b Material Reservation (LP integration)
- 03.13 Material Availability Check (inventory queries)
- 03.14 Gantt Chart View (complex visualization)

**Sonnet-Suitable Stories:**
- 03.1 Suppliers CRUD (standard master data)
- 03.2 Supplier-Products (junction table)
- 03.4 Bulk PO Creation (grouping logic)
- 03.5a/b Approval (workflow patterns)
- 03.6 Configurable Statuses (settings UI)
- 03.8 TO CRUD (similar to PO but simpler)
- 03.9a Partial Shipments (status updates)
- 03.12 WO Operations Copy (copy logic)
- 03.15 Dashboard (aggregation queries)
- 03.16 Settings (configuration CRUD)

---

## 6. Quality Checklist

Before submitting a story for review:

### 6.1 PRD Coverage
- [ ] All referenced FRs have ACs mapped
- [ ] No PRD requirements orphaned
- [ ] Phase 1+ features documented in "Future Phases"

### 6.2 Technical Completeness
- [ ] API endpoints fully specified
- [ ] Database schema referenced from architecture doc
- [ ] Service methods listed
- [ ] Zod validation schemas defined
- [ ] RLS policies mentioned

### 6.3 Story Quality (INVEST)
- [ ] **I**ndependent: Can be developed standalone
- [ ] **N**egotiable: Scope can adjust if needed
- [ ] **V**aluable: Delivers user value
- [ ] **E**stimable: Complexity is clear (S/M/L)
- [ ] **S**mall: Can complete in 1 sprint
- [ ] **T**estable: ACs are verifiable

### 6.4 Definition of Done
- [ ] Has API test coverage target (>80%)
- [ ] Has E2E smoke test for critical path
- [ ] Has performance targets where applicable

---

## 7. Story Index (To Be Created)

| Story ID | Name | Complexity | Priority | Status | Agent |
|----------|------|------------|----------|--------|-------|
| 03.0 | Epic Overview | - | - | READY | - |
| 03.1 | Suppliers CRUD | M | P0 | TO CREATE | - |
| 03.2 | Supplier-Product Assignment | M | P0 | TO CREATE | - |
| 03.3 | PO CRUD + Lines | L | P0 | TO CREATE | - |
| 03.4 | Bulk PO Creation | M | P0 | TO CREATE | - |
| 03.5a | PO Approval Setup | S | P1 | TO CREATE | - |
| 03.5b | PO Approval Workflow | M | P1 | TO CREATE | - |
| 03.6 | Configurable PO Statuses | M | P1 | TO CREATE | - |
| 03.8 | TO CRUD + Lines | L | P0 | TO CREATE | - |
| 03.9a | TO Partial Shipments | S | P1 | TO CREATE | - |
| 03.9b | TO LP Pre-Selection | M | P1 | DEFERRED | - |
| 03.10 | WO CRUD + BOM Auto-Select | L | P0 | TO CREATE | - |
| 03.11a | WO Materials (BOM Snapshot) | L | P0 | TO CREATE | - |
| 03.11b | WO Material Reservation | M | P1 | DEFERRED | - |
| 03.12 | WO Operations Copy | M | P0 | TO CREATE | - |
| 03.13 | WO Material Availability | M | P1 | DEFERRED | - |
| 03.14 | WO Gantt Chart View | L | P2 | DEFERRED | - |
| 03.15 | Planning Dashboard | M | P0 | TO CREATE | - |
| 03.16 | Planning Settings | M | P0 | TO CREATE | - |

**MVP Stories: 10** (03.1, 03.2, 03.3, 03.4, 03.8, 03.10, 03.11a, 03.12, 03.15, 03.16)
**Phase 1 Stories: 5** (03.5a, 03.5b, 03.6, 03.9a, 03.17)
**Deferred Stories: 4** (03.9b, 03.11b, 03.13, 03.14)
**Total: 19 stories**

---

## 8. Handoff to Story Writers

### 8.1 Instructions for Story Creation

1. **Read PRD Section** - Each story maps to PRD section
2. **Use Template** - Follow template in Section 3
3. **Reference Architecture** - Use schema from planning.md
4. **Map FRs to ACs** - Every FR must have acceptance criteria
5. **Document Future Features** - No silent omissions
6. **Check Dependencies** - Ensure prerequisites are correct

### 8.2 File Naming Convention

```
docs/2-MANAGEMENT/epics/current/03-planning/
  03.0.epic-overview.md
  03.0.story-creation-brief.md (this file)
  03.1.suppliers-crud.md
  03.2.supplier-products.md
  03.3.po-crud-lines.md
  03.4.bulk-po-creation.md
  03.5a.po-approval-setup.md
  03.5b.po-approval-workflow.md
  ...
```

### 8.3 Parallel Work Assignment

**Team 1 (Suppliers + PO):**
- 03.1 -> 03.2 -> 03.3 -> 03.4 -> 03.5a -> 03.5b

**Team 2 (TO):**
- 03.8 -> 03.9a

**Team 3 (WO):**
- 03.10 -> 03.11a -> 03.12

**Team 4 (Dashboard + Settings):**
- 03.15, 03.16 (can start early, update after entities)

---

## 9. Risk Assessment

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| BOM snapshot complexity | High | Medium | Clear ACs, opus model for 03.11a |
| LP dependency blocks stories | Medium | High | Defer 03.9b, 03.11b, 03.13 to Epic 05+ |
| PO/TO similar structure | Low | High | Reuse patterns, parallel development |
| Gantt chart complexity | Medium | Medium | Defer 03.14 to Phase 2 |
| Status lifecycle bugs | Medium | Medium | State machine tests, integration tests |
| Multi-warehouse TO validation | Low | Medium | ACs cover same-warehouse check |

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-12-16 | Initial story creation brief | ARCHITECT-AGENT |
