# 03.20 - Master Production Schedule (MPS)

**Story ID:** 03.20
**Epic:** 03 - Planning
**Phase:** Phase 2
**Complexity:** M (Medium)
**Estimate:** 4-5 days
**Type:** Full-stack
**State:** ready
**Priority:** P1

**Primary PRD:** `docs/1-BASELINE/product/modules/PLANNING.md` (FR-PLAN-034, Section 11.2)
**Architecture:** `docs/1-BASELINE/architecture/modules/planning.md`
**UX Wireframes:** PLAN-030 (MPS Calendar), PLAN-031 (MPS Entry Modal)

---

## PRD References

| FR ID | Requirement | Priority | Phase | Covered |
|-------|-------------|----------|-------|---------|
| FR-PLAN-034 | Master Production Schedule | Should Have | Phase 2 | YES |

---

## User Story

**As a** Production Planner,
**I want** a calendar-based view of planned production quantities per product across weekly/monthly time buckets,
**So that** I can visualize and manage my production schedule, compare planned vs actual quantities, and control schedule changes through freeze zones.

**As a** Production Manager,
**I want** MPS entries that integrate with Work Order generation,
**So that** I can translate high-level production plans into actionable work orders while respecting planning time fences.

---

## Goal

Implement Master Production Schedule (MPS) functionality enabling planners to define and manage production schedules for finished goods across configurable time periods. MPS provides the bridge between demand forecasting/sales orders and work order execution, with time fence controls (firm/slushy/liquid zones) to manage schedule stability.

---

## Scope

**In scope (this story):**
- MPS calendar view (weekly/monthly time buckets)
- MPS entry CRUD (create, read, update, delete)
- Planned production quantities per product per period
- MPS vs actual production comparison display
- Time fence zones (firm/slushy/liquid) with visual indicators
- MPS source tracking (manual, forecast, customer_order)
- MPS-to-WO integration (generate WO suggestions from MPS)
- Product/product group filtering
- Period aggregation (roll-up to weekly/monthly views)
- MPS settings in planning_settings table
- Multi-tenancy and RLS enforcement

**Out of scope (this story):**
- MRP calculation engine (FR-PLAN-035) - Story 03.21
- Suggested order generation from MRP (FR-PLAN-036) - Story 03.22
- Demand forecasting (FR-PLAN-031) - Story 03.19
- Auto-WO generation from MPS - Story 03.22
- Capacity planning integration - Phase 3
- What-if scenario modeling - Phase 3

---

## Dependencies

| Dependency | Story/Epic | Type | Status |
|------------|------------|------|--------|
| 03.10 | WO CRUD | REQUIRED | Provides work_orders table, WO creation |
| 03.19 | Demand Forecasting | RECOMMENDED | Provides forecast data as MPS source |
| 02.1 | Products CRUD | REQUIRED | Provides products table |
| 01.1 | Org Context + RLS | REQUIRED | Multi-tenancy foundation |
| 03.17 | Planning Settings | SOFT | MPS settings fields |

**Dependents:**
- 03.21 (MRP Calculation Engine) - Uses MPS as gross requirements source
- 03.22 (Suggested Order Generation) - Uses MPS to generate WO suggestions
- Epic 04 (Production) - Executes WOs generated from MPS

---

## Acceptance Criteria (Gherkin)

### AC-1: MPS Calendar View (Weekly Buckets)

```gherkin
Scenario: View MPS calendar in weekly mode
  Given planner navigates to `/planning/mps`
  When page loads
  Then MPS calendar displays within 500ms
  And default view shows weekly time buckets
  And columns display weeks (Mon-Sun) for the planning horizon
  And rows display products with MPS entries
  And header shows "Master Production Schedule" title

Scenario: Weekly bucket display
  Given MPS calendar in weekly view
  When viewing week of Jan 13-19, 2025
  Then column header shows "W03 (Jan 13-19)"
  And cells show planned_qty for each product in that week
  And cells are color-coded by time fence zone (firm=blue, slushy=yellow, liquid=green)

Scenario: Current week indicator
  Given MPS calendar displayed
  When today is Jan 15, 2025
  Then week W03 column has "Current" indicator
  And current week column highlighted with subtle border

Scenario: Navigation between periods
  Given MPS calendar displayed
  When planner clicks "Next" arrow
  Then calendar shifts forward by 4 weeks
  And data loads for new period

  When planner clicks "Previous" arrow
  Then calendar shifts backward by 4 weeks

  When planner clicks "Today" button
  Then calendar centers on current week
```

### AC-2: MPS Calendar View (Monthly Buckets)

```gherkin
Scenario: Switch to monthly view
  Given MPS calendar in weekly view
  When planner clicks "Monthly" toggle
  Then view switches to monthly time buckets
  And columns display months (Jan 2025, Feb 2025, etc.)
  And quantities aggregated from weekly MPS entries

Scenario: Monthly aggregation
  Given product FG-BREAD-001 has weekly MPS entries:
    | Week | Planned Qty |
    | W01  | 1000        |
    | W02  | 1200        |
    | W03  | 1100        |
    | W04  | 1150        |
  When viewing monthly view for January 2025
  Then January column shows 4450 (sum of weeks in January)

Scenario: Drill-down from monthly to weekly
  Given MPS calendar in monthly view
  When planner clicks on January cell for product FG-BREAD-001
  Then view switches to weekly view
  And calendar centers on January weeks
  And product row expanded to show weekly breakdown
```

### AC-3: MPS Entry Creation (FR-PLAN-034)

```gherkin
Scenario: Create MPS entry manually
  Given planner clicks on empty cell (product FG-BREAD-001, week W05)
  When MPS entry modal opens
  Then form displays:
    - Product: FG-BREAD-001 (read-only)
    - Period Start: 2025-01-27 (read-only)
    - Period End: 2025-02-02 (read-only)
    - Planned Quantity: (input)
    - Source: dropdown (manual, forecast, customer_order)
    - Notes: (textarea)

Scenario: Save MPS entry
  Given planner enters planned_qty = 1500
  And selects source = "manual"
  When planner clicks "Save"
  Then MPS entry created successfully
  And toast "MPS entry created" displays
  And calendar cell updates to show 1500
  And entry has status = 'planned'

Scenario: MPS entry validation - quantity required
  Given MPS entry modal open
  When planner leaves planned_qty empty
  And clicks "Save"
  Then error "Planned quantity is required" displays
  And save blocked

Scenario: MPS entry validation - quantity positive
  Given planner enters planned_qty = -100
  When clicks "Save"
  Then error "Planned quantity must be greater than 0" displays
```

### AC-4: MPS Entry Update (FR-PLAN-034)

```gherkin
Scenario: Edit MPS entry in liquid zone
  Given MPS entry exists for week W10 (liquid zone, 6+ weeks out)
  When planner clicks on cell
  Then edit modal opens
  And all fields are editable
  And planner can change planned_qty, source, notes

Scenario: Edit MPS entry in slushy zone
  Given MPS entry exists for week W04 (slushy zone, 2-5 weeks out)
  When planner clicks on cell
  Then edit modal opens with warning:
    "This period is in the slushy zone. Changes may impact planned work orders."
  And planner can edit after acknowledging warning

Scenario: Restrict edit in firm zone
  Given MPS entry exists for week W02 (firm zone, current + next week)
  When planner clicks on cell
  Then view-only modal opens
  And planned_qty field is read-only
  And message displays: "This period is in the firm zone. Changes require manager approval."
  And "Request Change" button visible for change request workflow

Scenario: Manager override in firm zone
  Given user has PROD_MANAGER or SUPER_ADMIN role
  And MPS entry is in firm zone
  When clicking on cell
  Then edit modal opens with warning
  And "Override Lock" checkbox available
  And upon checking override, fields become editable
  And override logged to MPS history
```

### AC-5: Time Fence Zones (Firm/Slushy/Liquid)

```gherkin
Scenario: Time fence zone calculation
  Given today is 2025-01-15 (Wednesday of W03)
  And MPS settings: firm_fence_weeks = 2, slushy_fence_weeks = 4
  When viewing MPS calendar
  Then time fence zones are:
    - Firm: W03 (current) + W04 (next week) = 2 weeks
    - Slushy: W05, W06, W07, W08 = 4 weeks
    - Liquid: W09+ = beyond slushy

Scenario: Visual indicators for zones
  Given MPS calendar displayed
  Then firm zone columns have blue background (#EFF6FF)
  And slushy zone columns have yellow background (#FEFCE8)
  And liquid zone columns have green background (#F0FDF4)
  And zone legend displayed at top of calendar

Scenario: Time fence settings configuration
  Given admin navigates to /settings/planning
  Then MPS Settings section displays:
    - Firm Fence (weeks): default 2
    - Slushy Fence (weeks): default 4
    - Planning Horizon (weeks): default 12
  And settings saved to planning_settings table
```

### AC-6: MPS vs Actual Production Comparison

```gherkin
Scenario: Display actual vs planned
  Given MPS entry for FG-BREAD-001, week W02:
    - planned_qty = 1000
    - confirmed_qty = 1000
    - actual_qty = 950 (from completed WOs)
  When viewing cell
  Then cell displays:
    - Planned: 1000
    - Actual: 950
    - Variance: -50 (5% under)

Scenario: Variance color coding
  Given MPS entries with different variances
  Then variance displays:
    - Green text for actual >= planned
    - Yellow text for actual 90-99% of planned
    - Red text for actual < 90% of planned

Scenario: Actual qty calculation
  Given MPS period is week W02 (Jan 6-12, 2025)
  And completed WOs for FG-BREAD-001 in that week:
    | WO Number | Produced Qty | Completed At |
    | WO-001    | 500          | 2025-01-07   |
    | WO-002    | 450          | 2025-01-10   |
  Then MPS actual_qty = 950 (sum of completed WOs)

Scenario: View detailed breakdown
  Given cell shows variance
  When planner clicks "Details" icon
  Then breakdown modal shows:
    - List of contributing WOs
    - WO number, planned qty, produced qty, completed date
    - Sum totals match cell values
```

### AC-7: MPS-to-WO Integration

```gherkin
Scenario: Generate WO from MPS
  Given MPS entry for FG-BREAD-001, week W05:
    - planned_qty = 1000
    - confirmed_qty = 1000
    - No WOs exist for this period
  When planner clicks "Generate WO" button
  Then WO creation modal opens with:
    - Product: FG-BREAD-001 (pre-filled)
    - Quantity: 1000 (from MPS confirmed_qty)
    - Scheduled Date: 2025-01-27 (week start)
    - Source: MPS (auto-set)
    - MPS Reference: mps_id linked

Scenario: Multiple WO generation
  Given MPS entry with planned_qty = 5000
  When planner clicks "Generate WOs"
  Then options displayed:
    - Single WO (5000 qty)
    - Split into multiple WOs (specify batch size)
  When planner selects "Split" with batch size 1000
  Then 5 draft WOs created, each with qty 1000

Scenario: Track MPS coverage
  Given MPS entry with confirmed_qty = 1000
  And WOs generated totaling planned_qty = 800
  When viewing MPS cell
  Then "WO Coverage" indicator shows: 80% (800/1000)
  And warning icon if coverage < 100%

Scenario: Link WO to MPS
  Given WO created from MPS
  Then WO has:
    - source_of_demand = 'mps'
    - source_reference = MPS entry ID
    - mps_id foreign key populated
  And MPS entry has WO count displayed
```

### AC-8: Product Filtering

```gherkin
Scenario: Filter by product
  Given MPS calendar displayed
  When planner types "FG-BREAD" in product search
  Then only products matching "FG-BREAD" display in rows
  And results update with 200ms debounce

Scenario: Filter by product group
  Given products have product_group assignments
  When planner selects group "Bakery Products"
  Then only products in "Bakery Products" group display

Scenario: Filter by MPS status
  Given MPS entries with different statuses
  When planner selects filter "Has Entries"
  Then only products with MPS entries display

Scenario: Show all products toggle
  Given filter "Show All Products" is OFF (default)
  Then only products with MPS entries or recent WOs display
  When toggled ON
  Then all finished goods products display in rows
```

### AC-9: MPS Source Tracking

```gherkin
Scenario: Manual entry source
  Given planner creates MPS entry manually
  Then source = 'manual'
  And source_reference = null
  And source icon shows manual entry indicator

Scenario: Forecast-generated MPS
  Given demand forecast exists for product FG-BREAD-001
  When planner clicks "Import from Forecast"
  Then MPS entries created with:
    - source = 'forecast'
    - source_reference = forecast_id
    - planned_qty = forecast_qty

Scenario: Customer order source
  Given customer order for 500 units due week W06
  When generating MPS from sales orders
  Then MPS entry created with:
    - source = 'customer_order'
    - source_reference = order_id
    - planned_qty = order_qty

Scenario: Source indicator display
  Given MPS cell with source = 'forecast'
  Then cell shows forecast icon (chart icon)
  And tooltip shows "Source: Demand Forecast - F-2025-001"
```

### AC-10: Confirmed Quantity Management

```gherkin
Scenario: Confirm MPS entry
  Given MPS entry with:
    - planned_qty = 1000
    - confirmed_qty = 0
  When planner clicks "Confirm"
  Then confirmation dialog shows
  And upon confirm, confirmed_qty = 1000 (matches planned)
  And status changes to 'confirmed'

Scenario: Partial confirmation
  Given MPS entry with planned_qty = 1000
  When planner confirms with qty = 800
  Then confirmed_qty = 800
  And remaining 200 shown as "unconfirmed"

Scenario: Confirmed qty drives WO generation
  Given MPS entry with:
    - planned_qty = 1000
    - confirmed_qty = 800
  When generating WOs from MPS
  Then WO quantity defaults to confirmed_qty (800)
  And warning if generating more than confirmed
```

### AC-11: Permission Enforcement

```gherkin
Scenario: Planner full MPS access
  Given user has PLANNER role
  When accessing /planning/mps
  Then can view, create, edit MPS entries in slushy/liquid zones
  And can view firm zone entries (read-only)

Scenario: Production Manager override access
  Given user has PROD_MANAGER role
  When accessing firm zone MPS entry
  Then can override and edit with reason logged

Scenario: Operator view only
  Given user has OPERATOR role
  When accessing /planning/mps
  Then can view MPS calendar
  But create/edit buttons hidden
  And clicking cells shows view-only modal

Scenario: Admin full access
  Given user has SUPER_ADMIN or ADMIN role
  Then all MPS operations available
  And can modify MPS settings
```

### AC-12: Multi-tenancy

```gherkin
Scenario: Org isolation on MPS
  Given User A from Org A
  When requesting /api/planning/mps
  Then only Org A MPS entries returned

Scenario: Cross-tenant access returns 404
  Given User A from Org A
  When requesting MPS entry ID from Org B
  Then 404 Not Found returned (not 403)

Scenario: Product filter respects org
  Given User A from Org A views MPS
  When product list loads
  Then only Org A products shown in filter
```

---

## Technical Specification

### Database Schema

```sql
-- Master Production Schedule
CREATE TABLE master_production_schedule (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  product_id UUID NOT NULL REFERENCES products(id),

  -- Period definition
  period_start DATE NOT NULL,  -- Always Monday of the week
  period_end DATE NOT NULL,    -- Always Sunday of the week
  period_type VARCHAR(10) DEFAULT 'weekly', -- 'weekly' or 'monthly'

  -- Quantities
  planned_qty NUMERIC(15,4) NOT NULL DEFAULT 0,
  confirmed_qty NUMERIC(15,4) DEFAULT 0,
  actual_qty NUMERIC(15,4) DEFAULT 0,  -- Calculated from completed WOs

  -- Source tracking
  source VARCHAR(20) DEFAULT 'manual', -- 'manual', 'forecast', 'customer_order'
  source_reference VARCHAR(100),       -- Reference ID (forecast_id, order_id)

  -- Status
  status VARCHAR(20) DEFAULT 'planned', -- 'planned', 'confirmed', 'completed', 'cancelled'

  -- Time fence zone (calculated, not stored)
  -- Zone determined by comparing period_start to current date + fence settings

  -- Notes
  notes TEXT,

  -- Audit
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  created_by UUID REFERENCES users(id),
  updated_by UUID REFERENCES users(id),

  CONSTRAINT mps_org_product_period_unique UNIQUE(org_id, product_id, period_start),
  CONSTRAINT mps_qty_positive CHECK (planned_qty >= 0),
  CONSTRAINT mps_confirmed_qty_check CHECK (confirmed_qty >= 0),
  CONSTRAINT mps_actual_qty_check CHECK (actual_qty >= 0),
  CONSTRAINT mps_status_check CHECK (status IN ('planned', 'confirmed', 'completed', 'cancelled')),
  CONSTRAINT mps_source_check CHECK (source IN ('manual', 'forecast', 'customer_order')),
  CONSTRAINT mps_period_type_check CHECK (period_type IN ('weekly', 'monthly'))
);

-- MPS Change History (for firm zone overrides and audit)
CREATE TABLE mps_change_history (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  mps_id UUID NOT NULL REFERENCES master_production_schedule(id) ON DELETE CASCADE,
  changed_by UUID REFERENCES users(id),
  changed_at TIMESTAMPTZ DEFAULT NOW(),
  change_type VARCHAR(20) NOT NULL, -- 'create', 'update', 'confirm', 'override', 'cancel'
  zone_at_change VARCHAR(10), -- 'firm', 'slushy', 'liquid'
  override_reason TEXT,
  previous_values JSONB,
  new_values JSONB
);

-- Indexes for performance
CREATE INDEX idx_mps_org_product ON master_production_schedule(org_id, product_id);
CREATE INDEX idx_mps_org_period ON master_production_schedule(org_id, period_start);
CREATE INDEX idx_mps_period_range ON master_production_schedule(period_start, period_end);
CREATE INDEX idx_mps_status ON master_production_schedule(org_id, status);
CREATE INDEX idx_mps_source ON master_production_schedule(source);
CREATE INDEX idx_mps_history_mps ON mps_change_history(mps_id);

-- Function: Get time fence zone for a date
CREATE OR REPLACE FUNCTION get_mps_zone(
  p_period_start DATE,
  p_firm_fence_weeks INTEGER DEFAULT 2,
  p_slushy_fence_weeks INTEGER DEFAULT 4
)
RETURNS TEXT AS $$
DECLARE
  v_today DATE := CURRENT_DATE;
  v_firm_end DATE;
  v_slushy_end DATE;
BEGIN
  -- Calculate zone boundaries
  v_firm_end := v_today + (p_firm_fence_weeks * 7);
  v_slushy_end := v_firm_end + (p_slushy_fence_weeks * 7);

  IF p_period_start <= v_firm_end THEN
    RETURN 'firm';
  ELSIF p_period_start <= v_slushy_end THEN
    RETURN 'slushy';
  ELSE
    RETURN 'liquid';
  END IF;
END;
$$ LANGUAGE plpgsql STABLE;

-- Function: Calculate actual_qty from completed WOs
CREATE OR REPLACE FUNCTION calculate_mps_actual_qty(
  p_mps_id UUID
)
RETURNS NUMERIC AS $$
DECLARE
  v_mps master_production_schedule;
  v_actual NUMERIC;
BEGIN
  SELECT * INTO v_mps FROM master_production_schedule WHERE id = p_mps_id;

  SELECT COALESCE(SUM(wo.produced_quantity), 0)
  INTO v_actual
  FROM work_orders wo
  WHERE wo.product_id = v_mps.product_id
    AND wo.org_id = v_mps.org_id
    AND wo.status = 'completed'
    AND wo.completed_at >= v_mps.period_start
    AND wo.completed_at < (v_mps.period_end + INTERVAL '1 day');

  RETURN v_actual;
END;
$$ LANGUAGE plpgsql;

-- Function: Get period boundaries (normalize to week start Monday)
CREATE OR REPLACE FUNCTION get_week_boundaries(p_date DATE)
RETURNS TABLE(week_start DATE, week_end DATE) AS $$
BEGIN
  -- Monday as week start
  week_start := p_date - EXTRACT(ISODOW FROM p_date)::INTEGER + 1;
  week_end := week_start + 6;
  RETURN NEXT;
END;
$$ LANGUAGE plpgsql STABLE;

-- Trigger: Record MPS changes
CREATE OR REPLACE FUNCTION record_mps_change()
RETURNS TRIGGER AS $$
BEGIN
  IF TG_OP = 'UPDATE' THEN
    INSERT INTO mps_change_history (
      mps_id, changed_by, change_type, zone_at_change,
      previous_values, new_values
    )
    VALUES (
      NEW.id,
      NEW.updated_by,
      CASE
        WHEN OLD.status = 'planned' AND NEW.status = 'confirmed' THEN 'confirm'
        WHEN OLD.status != 'cancelled' AND NEW.status = 'cancelled' THEN 'cancel'
        ELSE 'update'
      END,
      get_mps_zone(NEW.period_start),
      jsonb_build_object(
        'planned_qty', OLD.planned_qty,
        'confirmed_qty', OLD.confirmed_qty,
        'status', OLD.status
      ),
      jsonb_build_object(
        'planned_qty', NEW.planned_qty,
        'confirmed_qty', NEW.confirmed_qty,
        'status', NEW.status
      )
    );
  END IF;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER tr_mps_change_history
AFTER UPDATE ON master_production_schedule
FOR EACH ROW
EXECUTE FUNCTION record_mps_change();

-- Trigger: Update timestamp
CREATE TRIGGER tr_mps_updated_at
BEFORE UPDATE ON master_production_schedule
FOR EACH ROW
EXECUTE FUNCTION update_timestamp();
```

### Planning Settings Extension

```sql
-- Add MPS settings to planning_settings table
ALTER TABLE planning_settings ADD COLUMN IF NOT EXISTS
  mps_firm_fence_weeks INTEGER DEFAULT 2 CHECK (mps_firm_fence_weeks >= 0 AND mps_firm_fence_weeks <= 8);

ALTER TABLE planning_settings ADD COLUMN IF NOT EXISTS
  mps_slushy_fence_weeks INTEGER DEFAULT 4 CHECK (mps_slushy_fence_weeks >= 0 AND mps_slushy_fence_weeks <= 12);

ALTER TABLE planning_settings ADD COLUMN IF NOT EXISTS
  mps_planning_horizon_weeks INTEGER DEFAULT 12 CHECK (mps_planning_horizon_weeks >= 4 AND mps_planning_horizon_weeks <= 52);

ALTER TABLE planning_settings ADD COLUMN IF NOT EXISTS
  mps_default_view VARCHAR(10) DEFAULT 'weekly' CHECK (mps_default_view IN ('weekly', 'monthly'));
```

### RLS Policies

```sql
-- Enable RLS
ALTER TABLE master_production_schedule ENABLE ROW LEVEL SECURITY;
ALTER TABLE mps_change_history ENABLE ROW LEVEL SECURITY;

-- MPS: Org isolation
CREATE POLICY "mps_select" ON master_production_schedule
FOR SELECT TO authenticated
USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

CREATE POLICY "mps_insert" ON master_production_schedule
FOR INSERT TO authenticated
WITH CHECK (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  AND (
    (SELECT r.code FROM roles r JOIN users u ON u.role_id = r.id WHERE u.id = auth.uid())
    IN ('SUPER_ADMIN', 'ADMIN', 'PLANNER', 'PROD_MANAGER')
  )
);

CREATE POLICY "mps_update" ON master_production_schedule
FOR UPDATE TO authenticated
USING (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  AND (
    (SELECT r.code FROM roles r JOIN users u ON u.role_id = r.id WHERE u.id = auth.uid())
    IN ('SUPER_ADMIN', 'ADMIN', 'PLANNER', 'PROD_MANAGER')
  )
);

CREATE POLICY "mps_delete" ON master_production_schedule
FOR DELETE TO authenticated
USING (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  AND status IN ('planned', 'cancelled')
  AND (
    (SELECT r.code FROM roles r JOIN users u ON u.role_id = r.id WHERE u.id = auth.uid())
    IN ('SUPER_ADMIN', 'ADMIN', 'PLANNER')
  )
);

-- MPS History: Read through MPS
CREATE POLICY "mps_history_select" ON mps_change_history
FOR SELECT TO authenticated
USING (
  EXISTS (
    SELECT 1 FROM master_production_schedule mps
    WHERE mps.id = mps_change_history.mps_id
      AND mps.org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  )
);
```

### API Endpoints

```
# MPS Calendar Data
GET    /api/v1/planning/mps                     - Get MPS entries for period (paginated)
GET    /api/v1/planning/mps/calendar            - Get calendar view data (optimized)
GET    /api/v1/planning/mps/:id                 - Get single MPS entry

# MPS CRUD
POST   /api/v1/planning/mps                     - Create MPS entry
PUT    /api/v1/planning/mps/:id                 - Update MPS entry
DELETE /api/v1/planning/mps/:id                 - Delete MPS entry (planned/cancelled only)

# MPS Actions
POST   /api/v1/planning/mps/:id/confirm         - Confirm MPS entry
POST   /api/v1/planning/mps/:id/cancel          - Cancel MPS entry
POST   /api/v1/planning/mps/:id/override        - Override firm zone lock (manager only)

# MPS-WO Integration
POST   /api/v1/planning/mps/:id/generate-wo     - Generate WO from MPS entry
GET    /api/v1/planning/mps/:id/work-orders     - Get WOs linked to MPS entry

# MPS Bulk Operations
POST   /api/v1/planning/mps/import-forecast     - Import from demand forecasts
POST   /api/v1/planning/mps/import-orders       - Import from customer orders

# MPS History
GET    /api/v1/planning/mps/:id/history         - Get change history for entry

# Utilities
GET    /api/v1/planning/mps/products            - Get products with MPS summary
GET    /api/v1/planning/mps/zones               - Get current zone boundaries
```

**Query Parameters (Calendar):**
- `start_date` - Period start (required)
- `end_date` - Period end (required)
- `view` - View type: weekly, monthly
- `product_id` - Filter by single product
- `product_ids` - Filter by multiple products (comma-separated)
- `product_group_id` - Filter by product group
- `status` - Filter by status
- `show_all_products` - Include products without MPS entries

### Service Layer

```typescript
// lib/services/mps-service.ts

export interface MPSService {
  // Calendar operations
  getCalendarData(params: MPSCalendarParams): Promise<MPSCalendarData>;
  getById(id: string): Promise<MPSEntryWithRelations | null>;

  // CRUD operations
  create(data: CreateMPSInput): Promise<MPSEntry>;
  update(id: string, data: UpdateMPSInput): Promise<MPSEntry>;
  delete(id: string): Promise<void>;

  // Status operations
  confirm(id: string, qty?: number): Promise<MPSEntry>;
  cancel(id: string, reason?: string): Promise<MPSEntry>;
  override(id: string, data: OverrideMPSInput): Promise<MPSEntry>;

  // Zone calculations
  getZone(periodStart: Date): MPSZone;
  getZoneBoundaries(): MPSZoneBoundaries;
  canEdit(entry: MPSEntry, userRole: string): MPSEditPermission;

  // WO integration
  generateWorkOrder(mpsId: string, params: GenerateWOParams): Promise<WorkOrder>;
  getLinkedWorkOrders(mpsId: string): Promise<WorkOrder[]>;
  calculateWOCoverage(mpsId: string): Promise<number>;

  // Actual qty calculation
  calculateActualQty(mpsId: string): Promise<number>;
  refreshActualQuantities(orgId: string, periodStart: Date, periodEnd: Date): Promise<void>;

  // Bulk operations
  importFromForecasts(params: ImportForecastParams): Promise<MPSEntry[]>;
  importFromOrders(params: ImportOrdersParams): Promise<MPSEntry[]>;

  // History
  getHistory(mpsId: string): Promise<MPSChangeHistory[]>;
}

// Type definitions
export type MPSZone = 'firm' | 'slushy' | 'liquid';
export type MPSStatus = 'planned' | 'confirmed' | 'completed' | 'cancelled';
export type MPSSource = 'manual' | 'forecast' | 'customer_order';

export interface MPSEntry {
  id: string;
  org_id: string;
  product_id: string;
  period_start: string;
  period_end: string;
  period_type: 'weekly' | 'monthly';
  planned_qty: number;
  confirmed_qty: number;
  actual_qty: number;
  source: MPSSource;
  source_reference: string | null;
  status: MPSStatus;
  notes: string | null;
  created_at: string;
  updated_at: string;
  created_by: string;
  updated_by: string | null;
}

export interface MPSEntryWithRelations extends MPSEntry {
  product?: {
    id: string;
    code: string;
    name: string;
    base_uom: string;
  };
  zone?: MPSZone;
  variance?: number;
  variance_percent?: number;
  wo_count?: number;
  wo_coverage_percent?: number;
}

export interface MPSCalendarData {
  entries: MPSEntryWithRelations[];
  products: ProductSummary[];
  periods: PeriodInfo[];
  zone_boundaries: MPSZoneBoundaries;
  settings: MPSSettings;
}

export interface MPSZoneBoundaries {
  firm_end: string;
  slushy_end: string;
  firm_fence_weeks: number;
  slushy_fence_weeks: number;
}

export interface MPSSettings {
  firm_fence_weeks: number;
  slushy_fence_weeks: number;
  planning_horizon_weeks: number;
  default_view: 'weekly' | 'monthly';
}

export interface MPSCalendarParams {
  start_date: string;
  end_date: string;
  view?: 'weekly' | 'monthly';
  product_id?: string;
  product_ids?: string[];
  product_group_id?: string;
  status?: MPSStatus;
  show_all_products?: boolean;
}

export interface CreateMPSInput {
  product_id: string;
  period_start: string;
  planned_qty: number;
  source?: MPSSource;
  source_reference?: string;
  notes?: string;
}

export interface UpdateMPSInput {
  planned_qty?: number;
  confirmed_qty?: number;
  source?: MPSSource;
  source_reference?: string;
  notes?: string;
}

export interface OverrideMPSInput {
  reason: string;
  planned_qty?: number;
  confirmed_qty?: number;
}

export interface GenerateWOParams {
  quantity?: number;  // Defaults to confirmed_qty
  split_batch_size?: number;  // For multiple WO generation
  scheduled_date?: string;  // Defaults to period_start
  production_line_id?: string;
}

export interface MPSChangeHistory {
  id: string;
  mps_id: string;
  changed_by: string;
  changed_at: string;
  change_type: 'create' | 'update' | 'confirm' | 'override' | 'cancel';
  zone_at_change: MPSZone;
  override_reason: string | null;
  previous_values: Record<string, any>;
  new_values: Record<string, any>;
  changed_by_user?: { name: string };
}

export interface MPSEditPermission {
  can_edit: boolean;
  reason?: string;
  requires_override?: boolean;
}
```

### Validation Schema (Zod)

```typescript
// lib/validation/mps.ts
import { z } from 'zod';

export const mpsStatusEnum = z.enum(['planned', 'confirmed', 'completed', 'cancelled']);
export const mpsSourceEnum = z.enum(['manual', 'forecast', 'customer_order']);
export const mpsViewEnum = z.enum(['weekly', 'monthly']);

// Create MPS entry
export const createMPSSchema = z.object({
  product_id: z.string().uuid('Invalid product ID'),
  period_start: z.string().date('Invalid date format'),
  planned_qty: z.number()
    .positive('Quantity must be greater than 0')
    .max(999999999, 'Quantity too large'),
  source: mpsSourceEnum.default('manual'),
  source_reference: z.string().max(100).optional().nullable(),
  notes: z.string().max(2000).optional().nullable(),
});

// Update MPS entry
export const updateMPSSchema = z.object({
  planned_qty: z.number()
    .positive('Quantity must be greater than 0')
    .max(999999999, 'Quantity too large')
    .optional(),
  confirmed_qty: z.number()
    .min(0, 'Confirmed quantity cannot be negative')
    .max(999999999, 'Quantity too large')
    .optional(),
  source: mpsSourceEnum.optional(),
  source_reference: z.string().max(100).optional().nullable(),
  notes: z.string().max(2000).optional().nullable(),
});

// Confirm MPS entry
export const confirmMPSSchema = z.object({
  qty: z.number()
    .min(0, 'Confirm quantity cannot be negative')
    .optional(),  // Defaults to planned_qty
});

// Override MPS entry (firm zone)
export const overrideMPSSchema = z.object({
  reason: z.string()
    .min(10, 'Override reason must be at least 10 characters')
    .max(500, 'Override reason too long'),
  planned_qty: z.number().positive().optional(),
  confirmed_qty: z.number().min(0).optional(),
});

// Generate WO from MPS
export const generateWOFromMPSSchema = z.object({
  quantity: z.number().positive().optional(),
  split_batch_size: z.number().positive().optional(),
  scheduled_date: z.string().date().optional(),
  production_line_id: z.string().uuid().optional().nullable(),
});

// Calendar query params
export const mpsCalendarQuerySchema = z.object({
  start_date: z.string().date('Invalid start date'),
  end_date: z.string().date('Invalid end date'),
  view: mpsViewEnum.default('weekly'),
  product_id: z.string().uuid().optional(),
  product_ids: z.string().optional(),  // comma-separated UUIDs
  product_group_id: z.string().uuid().optional(),
  status: mpsStatusEnum.optional(),
  show_all_products: z.coerce.boolean().default(false),
}).refine(
  (data) => new Date(data.end_date) >= new Date(data.start_date),
  { message: 'End date must be on or after start date', path: ['end_date'] }
);

// Type exports
export type CreateMPSInput = z.infer<typeof createMPSSchema>;
export type UpdateMPSInput = z.infer<typeof updateMPSSchema>;
export type ConfirmMPSInput = z.infer<typeof confirmMPSSchema>;
export type OverrideMPSInput = z.infer<typeof overrideMPSSchema>;
export type GenerateWOFromMPSInput = z.infer<typeof generateWOFromMPSSchema>;
export type MPSCalendarQuery = z.infer<typeof mpsCalendarQuerySchema>;
```

---

## UI Components

```
app/(authenticated)/planning/mps/
  page.tsx                              -- MPS calendar page

components/planning/mps/
  MPSCalendar.tsx                       -- Main calendar component
  MPSCalendarHeader.tsx                 -- Header with navigation, view toggle
  MPSCalendarGrid.tsx                   -- Calendar grid layout
  MPSCalendarRow.tsx                    -- Product row in calendar
  MPSCalendarCell.tsx                   -- Individual cell (period x product)

  MPSZoneLegend.tsx                     -- Time fence zone legend
  MPSZoneIndicator.tsx                  -- Zone column background

  MPSEntryModal.tsx                     -- Create/edit MPS entry modal
  MPSViewModal.tsx                      -- View-only modal (firm zone)
  MPSOverrideDialog.tsx                 -- Override confirmation with reason
  MPSConfirmDialog.tsx                  -- Confirm qty dialog

  MPSCellContent.tsx                    -- Cell content (qty, variance)
  MPSVarianceDisplay.tsx                -- Variance indicator with color
  MPSSourceBadge.tsx                    -- Source indicator badge
  MPSCoverageIndicator.tsx              -- WO coverage percentage

  MPSProductFilter.tsx                  -- Product search and filters
  MPSProductGroupFilter.tsx             -- Product group dropdown
  MPSStatusFilter.tsx                   -- Status filter dropdown

  MPSGenerateWOModal.tsx                -- Generate WO from MPS modal
  MPSBreakdownModal.tsx                 -- Detailed breakdown (WO list)
  MPSHistoryPanel.tsx                   -- Change history timeline

  MPSSettingsSection.tsx                -- MPS settings (for planning settings page)
```

### Calendar Layout

```
+------------------------------------------------------------------+
|  Master Production Schedule                    [Weekly] [Monthly] |
|  [< Prev]  W01 - W12, 2025  [Next >]  [Today]                    |
+------------------------------------------------------------------+
|  Zone Legend: [Firm] [Slushy] [Liquid]                           |
+------------------------------------------------------------------+
|  Product      | W01 | W02 | W03 | W04 | W05 | W06 | ... | W12    |
|               | Firm| Firm|Slush|Slush|Slush|Slush| Liq | Liquid |
+---------------+-----+-----+-----+-----+-----+-----+-----+--------+
| FG-BREAD-001  | 1000| 1200| 1100|  -  |  -  |  -  |  -  |   -    |
| White Loaf    | 950 |     |     |     |     |     |     |        |
|               | -5% |     |     |     |     |     |     |        |
+---------------+-----+-----+-----+-----+-----+-----+-----+--------+
| FG-ROLL-002   |  500|  600|     |  -  |  -  |  -  |  -  |   -    |
| Dinner Rolls  |  480|     |     |     |     |     |     |        |
|               | -4% |     |     |     |     |     |     |        |
+---------------+-----+-----+-----+-----+-----+-----+-----+--------+
```

### Cell Layout

```
+------------------+
|      1000        | <- Planned qty (large)
|       950        | <- Actual qty (smaller)
|     -5% [!]      | <- Variance with indicator
+------------------+
```

### Zone Color Coding (TailwindCSS)

| Zone | Background | Text | Border |
|------|------------|------|--------|
| Firm | `bg-blue-50` | `text-blue-800` | `border-blue-200` |
| Slushy | `bg-yellow-50` | `text-yellow-800` | `border-yellow-200` |
| Liquid | `bg-green-50` | `text-green-800` | `border-green-200` |

### Variance Color Coding

| Variance | Class |
|----------|-------|
| >= 100% | `text-green-600` |
| 90-99% | `text-yellow-600` |
| < 90% | `text-red-600` |

---

## Test Cases

### Unit Tests

**File:** `__tests__/unit/services/mps-service.test.ts`

| Test Case | Description |
|-----------|-------------|
| `getZone()` returns correct zone for date | Test firm/slushy/liquid boundaries |
| `getZone()` handles edge cases | Same day, boundary dates |
| `create()` validates required fields | Product, period_start, planned_qty |
| `create()` normalizes period_start to Monday | Any date normalized to week start |
| `create()` prevents duplicate entries | Same org/product/period returns error |
| `update()` respects zone restrictions | Firm zone requires override |
| `confirm()` sets confirmed_qty | Defaults to planned_qty if not specified |
| `confirm()` partial confirmation | Allows qty < planned_qty |
| `calculateActualQty()` sums WO produced | Only completed WOs in period |
| `canEdit()` returns correct permission | Based on zone and user role |
| `generateWorkOrder()` creates WO from MPS | Correct qty, source, reference |
| `generateWorkOrder()` splits by batch size | Multiple WOs created |

### Integration Tests

**File:** `__tests__/integration/api/planning/mps.test.ts`

| Test Case | Description |
|-----------|-------------|
| GET `/mps/calendar` returns entries | Correct period filtering |
| GET `/mps/calendar` includes zone info | Zone boundaries calculated |
| GET `/mps/calendar` filters by product | Single and multiple products |
| POST `/mps` creates entry | All fields saved correctly |
| POST `/mps` normalizes period | Any date becomes week Monday |
| PUT `/mps/:id` updates liquid zone | No restrictions |
| PUT `/mps/:id` blocks firm zone | 403 without override permission |
| PUT `/mps/:id` with override | Manager can edit firm |
| POST `/mps/:id/confirm` updates status | Status changes to confirmed |
| POST `/mps/:id/generate-wo` creates WO | WO linked to MPS |
| Cross-org access returns 404 | Multi-tenancy |

### E2E Tests

**File:** `__tests__/e2e/planning/mps.spec.ts`

| Test Case | Description |
|-----------|-------------|
| MPS calendar loads | Page displays within 500ms |
| Navigate between periods | Forward/back navigation |
| Weekly to monthly toggle | View switches, data aggregates |
| Create MPS entry | Click cell, fill form, save |
| Edit entry in liquid zone | All fields editable |
| View entry in firm zone | Read-only modal |
| Confirm MPS entry | Status updates |
| Generate WO from MPS | WO created with link |
| Filter by product | Results update |
| Zone colors display | Correct background colors |
| Variance display | Color coding works |

---

## Key Business Rules

1. **Period Normalization**: All MPS entries use week start (Monday) as period_start
2. **Time Fence Zones**:
   - Firm = current week + firm_fence_weeks (default 2)
   - Slushy = firm end + slushy_fence_weeks (default 4)
   - Liquid = beyond slushy fence
3. **Edit Restrictions**:
   - Liquid zone: All users can edit
   - Slushy zone: Editable with warning
   - Firm zone: Read-only, managers can override with reason
4. **Actual Qty Calculation**: Sum of produced_quantity from completed WOs within period
5. **Confirmed Qty**: Drives WO generation quantity
6. **WO Coverage**: (Sum of linked WO planned_qty) / confirmed_qty * 100
7. **Source Tracking**: Every entry tracks origin (manual, forecast, customer_order)
8. **Unique Constraint**: One entry per org/product/period_start
9. **Monthly Aggregation**: Monthly view sums weekly entries in that month
10. **Variance Calculation**: (actual_qty - planned_qty) / planned_qty * 100

---

## Performance Requirements

| Metric | Target |
|--------|--------|
| MPS Calendar load | < 500ms |
| Calendar navigation | < 300ms |
| Create/update MPS entry | < 500ms |
| WO generation from MPS | < 1s |
| Actual qty calculation | < 200ms per entry |
| Product filter response | < 200ms |

---

## Definition of Done

- [ ] Database migration creates `master_production_schedule` and `mps_change_history` tables
- [ ] MPS settings fields added to `planning_settings` table
- [ ] All constraints and indexes created
- [ ] RLS policies enforce org isolation
- [ ] Zone calculation function working correctly
- [ ] Actual qty calculation from WOs working
- [ ] MPS calendar page at `/planning/mps`
- [ ] Weekly and monthly view toggles working
- [ ] Period navigation (prev/next/today) working
- [ ] Zone color coding displays correctly
- [ ] MPS entry create modal working
- [ ] MPS entry edit with zone restrictions
- [ ] Firm zone override for managers
- [ ] MPS confirmation workflow
- [ ] Variance display with color coding
- [ ] WO generation from MPS working
- [ ] Product filtering working
- [ ] Monthly aggregation correct
- [ ] Change history recorded
- [ ] Multi-tenancy tested
- [ ] Unit tests >= 80% coverage
- [ ] Integration tests for all endpoints
- [ ] E2E tests for critical flows
- [ ] Performance targets met

---

## Future Phases (Not in This Story)

### Phase 2 (Story 03.21, 03.22)
- **MRP Calculation Engine** - Use MPS as gross requirements for MRP
- **Suggested Order Generation** - Auto-generate PO/WO suggestions from MRP
- **Auto-WO from MPS** - Automatic WO creation when MPS confirmed

### Phase 3
- **Capacity Planning Integration** - Validate MPS against capacity constraints
- **What-if Scenario Modeling** - Multiple MPS scenarios for comparison
- **MPS Templates** - Recurring production patterns
- **MPS Import/Export** - Excel/CSV import for bulk MPS creation
- **MPS Notifications** - Alerts for variance thresholds

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-01-14 | Initial story creation | ARCHITECT-AGENT |
