# 03.27 - EDI Integration Core

**Story ID:** 03.27
**Epic:** 03 - Planning
**Phase:** Phase 3
**Complexity:** XL (Extra Large)
**Estimate:** 10-14 days
**Type:** Backend + Frontend
**State:** ready
**Priority:** P2

**Primary PRD:** `docs/1-BASELINE/product/modules/PLANNING.md` (FR-PLAN-070, FR-PLAN-071)
**Architecture:** Section 15 - EDI Integration (Phase 3)

## PRD References

| FR ID | Requirement | Priority | Phase | Covered |
|-------|-------------|----------|-------|---------|
| FR-PLAN-070 | EDI Order Import | Could Have | Phase 3 | Yes |
| FR-PLAN-071 | EDI Dispatch Advice | Could Have | Phase 3 | Yes |

## User Story

**As a** Supply Chain Manager,
**I want** to exchange orders and dispatch notices with trading partners via EDI,
**So that** I can automate order processing with retail chains and large customers, reducing manual data entry and errors.

**As an** Administrator,
**I want** to configure EDI trading partners with their connection details and message mappings,
**So that** I can enable automated document exchange with each customer's specific requirements.

## Goal

Implement core EDI (Electronic Data Interchange) functionality supporting X12 850 (Purchase Order) inbound and X12 856 (ASN/Dispatch Advice) outbound message processing. Enable trading partner configuration, message parsing/generation, validation, error handling, and integration with existing PO and ASN workflows.

## Scope

**In scope:**
- EDI trading partner management (CRUD)
- X12 850 (PO) message import and parsing
- X12 856 (ASN/DESADV) message generation and export
- EDIFACT ORDERS/DESADV support (basic structure)
- Message validation and error handling
- Trading partner field mapping configuration
- Message queue and retry logic
- EDI message log and audit trail
- Integration with Sales Orders (from 850)
- Integration with ASN export (856 from shipments)
- Manual file upload/download interface
- API endpoints for EDI gateway integration
- EDI settings page (enable/disable, defaults)

**Out of scope:**
- Real-time EDI gateway connections (Phase 4 - use webhook/API for gateway)
- INVOIC (Invoice) message type (deferred)
- RECADV (Receiving Advice) message type (deferred)
- ORDRSP (Order Response) message type (deferred)
- VMI Supplier Portal (FR-PLAN-072, Phase 4+)
- GS1 XML format (Phase 4)
- Automated scheduling/polling (manual trigger for MVP)
- AS2/SFTP transport protocols (gateway handles transport)

## Dependencies

| Story | Requirement | Status |
|-------|-------------|--------|
| 03.3 | PO CRUD + Lines | Required - EDI creates Sales Orders (customer POs) |
| 03.8 | Transfer Orders CRUD | Soft - TO for internal transfers |
| 05.8 | ASN CRUD + Items | Required - EDI generates ASN for dispatch |
| 05.9 | ASN Receive Workflow | Soft - Integration for inbound RECADV |

**Dependents:**
- Future EDI enhancements (Invoice, Receiving Advice)
- Integration Module (Epic 11) - Advanced gateway connections

## Acceptance Criteria (Given/When/Then)

### Trading Partner Management

#### Trading Partner CRUD
- GIVEN admin navigates to Settings > EDI Trading Partners, WHEN page loads, THEN list of configured trading partners displays.
- GIVEN admin clicks "Add Trading Partner", WHEN form opens, THEN fields for partner code, name, EDI format, identifiers shown.
- GIVEN admin fills valid trading partner data, WHEN form submitted, THEN partner created with unique code.
- GIVEN existing trading partner, WHEN admin edits and saves, THEN partner data updated.
- GIVEN trading partner without active messages, WHEN admin clicks delete, THEN partner removed after confirmation.
- GIVEN trading partner with message history, WHEN admin clicks delete, THEN soft-delete (deactivate) performed.

#### Trading Partner Configuration
- GIVEN trading partner form, WHEN selecting EDI format, THEN options include: X12, EDIFACT.
- GIVEN trading partner form, WHEN configuring identifiers, THEN ISA ID (X12) or UNB ID (EDIFACT) captured.
- GIVEN trading partner form, WHEN configuring message types, THEN checkboxes for: 850/ORDERS (In), 856/DESADV (Out).
- GIVEN trading partner, WHEN setting field mappings, THEN custom field mapping rules can be defined (JSON).
- GIVEN trading partner, WHEN setting validation rules, THEN tolerance thresholds and required fields configurable.

### EDI Order Import (FR-PLAN-070 - X12 850)

#### File Upload
- GIVEN EDI import page, WHEN admin uploads X12 850 file, THEN file parsed and validated within 5 seconds.
- GIVEN uploaded 850 file, WHEN parsing succeeds, THEN preview shows: trading partner, PO number, date, line items.
- GIVEN uploaded 850 file, WHEN trading partner not found, THEN error "Unknown trading partner ISA ID" displays.
- GIVEN uploaded 850 file, WHEN required segments missing, THEN validation errors listed with segment details.

#### Order Creation
- GIVEN valid 850 preview, WHEN admin clicks "Import", THEN Sales Order created with correct header data.
- GIVEN 850 import, WHEN lines processed, THEN each PO1 segment creates SO line with product mapping.
- GIVEN 850 import with unknown product, WHEN buyer part number has no mapping, THEN error logged with unmapped items list.
- GIVEN 850 import success, WHEN SO created, THEN EDI message status set to "processed" with SO reference.
- GIVEN 850 import, WHEN duplicate PO number detected, THEN warning shown with option to skip or create new version.

#### Product Mapping
- GIVEN trading partner config, WHEN buyer part numbers defined, THEN 850 line maps to internal product_id.
- GIVEN 850 line with GTIN, WHEN GTIN matches product, THEN automatic product mapping applied.
- GIVEN unmapped product in 850, WHEN import attempted, THEN line flagged for manual resolution.
- GIVEN product mapping UI, WHEN admin assigns mapping, THEN future imports auto-resolve.

### EDI Dispatch Advice Export (FR-PLAN-071 - X12 856)

#### ASN to 856 Generation
- GIVEN shipment with ASN, WHEN user clicks "Generate EDI", THEN 856 message generated for trading partner format.
- GIVEN 856 generation, WHEN ASN has multiple LPs, THEN HL segments created for each LP with SSCC-18.
- GIVEN 856 generation, WHEN ASN items have lot/expiry, THEN LIN/SN1 segments include batch data.
- GIVEN 856 generation, WHEN complete, THEN message downloadable as .edi file.

#### 856 Content Validation
- GIVEN generated 856, WHEN SSCC missing on LP, THEN validation error "LP {barcode} missing SSCC".
- GIVEN generated 856, WHEN lot/expiry required by partner, THEN validation ensures all items have batch data.
- GIVEN 856 with validation errors, WHEN viewed, THEN specific segment errors highlighted.

#### Export Workflow
- GIVEN 856 generated successfully, WHEN admin clicks "Export", THEN message status set to "sent".
- GIVEN 856 for gateway integration, WHEN API called, THEN message returned as base64 or raw text.
- GIVEN multiple shipments selected, WHEN bulk export triggered, THEN 856 generated for each with separate files.

### Message Queue and Status

#### Message Logging
- GIVEN any EDI message processed, WHEN complete, THEN log entry created with: direction, type, partner, status, timestamp.
- GIVEN EDI message log, WHEN admin views list, THEN columns show: ID, Direction, Type, Partner, Status, Date, Reference.
- GIVEN EDI message, WHEN admin clicks row, THEN detail view shows raw message and parsed content.
- GIVEN failed message, WHEN viewing detail, THEN error details and stack trace available.

#### Status Tracking
- GIVEN 850 import, WHEN statuses change, THEN valid states: pending, validating, processed, failed, duplicate.
- GIVEN 856 export, WHEN statuses change, THEN valid states: pending, generated, sent, acknowledged, failed.
- GIVEN message with "failed" status, WHEN admin clicks "Retry", THEN message reprocessed.
- GIVEN message history, WHEN filtered by status, THEN only matching messages display.

### Error Handling and Reconciliation

#### Validation Errors
- GIVEN 850 with invalid ISA segment, WHEN parsing fails, THEN specific error "Invalid ISA segment at position X".
- GIVEN 850 with missing required field, WHEN validation runs, THEN error lists field name and segment.
- GIVEN 856 generation with invalid data, WHEN validation fails, THEN descriptive error prevents export.

#### Reconciliation
- GIVEN imported 850, WHEN SO status changes to shipped, THEN 856 generation prompted.
- GIVEN message mismatch, WHEN PO number in 850 doesn't match existing, THEN reconciliation workflow triggered.
- GIVEN EDI dashboard, WHEN viewing pending items, THEN count of unprocessed messages shown.

### Multi-tenancy
- GIVEN Org A trading partners, WHEN Org B admin queries, THEN zero results returned.
- GIVEN EDI message from Org A, WHEN Org B attempts access, THEN 404 Not Found returns.
- GIVEN EDI settings, WHEN org toggles feature off, THEN EDI menu items hidden.

## Technical Specification

### Database Schema

#### edi_trading_partners table

```sql
CREATE TABLE edi_trading_partners (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,

  -- Partner identification
  code VARCHAR(50) NOT NULL,
  name VARCHAR(255) NOT NULL,
  is_active BOOLEAN DEFAULT true,

  -- EDI format and identifiers
  edi_format VARCHAR(20) NOT NULL DEFAULT 'X12', -- 'X12', 'EDIFACT'
  isa_id VARCHAR(15), -- X12 ISA sender/receiver ID
  isa_qualifier VARCHAR(2) DEFAULT 'ZZ', -- X12 ISA qualifier
  unb_id VARCHAR(35), -- EDIFACT UNB sender/receiver ID
  unb_qualifier VARCHAR(4), -- EDIFACT UNB qualifier

  -- Message type configuration
  supports_850 BOOLEAN DEFAULT false, -- Inbound PO
  supports_856 BOOLEAN DEFAULT false, -- Outbound ASN
  supports_810 BOOLEAN DEFAULT false, -- Outbound Invoice (future)
  supports_997 BOOLEAN DEFAULT false, -- Functional Ack (future)

  -- Field mappings (JSON)
  product_mappings JSONB DEFAULT '{}', -- buyer_part_number -> product_id
  field_mappings JSONB DEFAULT '{}', -- custom field transformations

  -- Validation settings
  require_lot_tracking BOOLEAN DEFAULT true,
  require_expiry_date BOOLEAN DEFAULT true,
  allow_over_ship BOOLEAN DEFAULT false,
  over_ship_tolerance DECIMAL(5,2) DEFAULT 0,

  -- Contact information
  contact_name VARCHAR(255),
  contact_email VARCHAR(255),
  contact_phone VARCHAR(50),

  -- Metadata
  notes TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  created_by UUID REFERENCES users(id),
  updated_by UUID REFERENCES users(id),

  CONSTRAINT edi_partner_org_code_unique UNIQUE (org_id, code)
);

-- Indexes
CREATE INDEX idx_edi_partners_org_id ON edi_trading_partners(org_id);
CREATE INDEX idx_edi_partners_isa_id ON edi_trading_partners(isa_id);
CREATE INDEX idx_edi_partners_unb_id ON edi_trading_partners(unb_id);
CREATE INDEX idx_edi_partners_active ON edi_trading_partners(org_id, is_active);
```

#### edi_messages table

```sql
CREATE TABLE edi_messages (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  trading_partner_id UUID REFERENCES edi_trading_partners(id) ON DELETE SET NULL,

  -- Message identification
  direction VARCHAR(10) NOT NULL, -- 'inbound', 'outbound'
  message_type VARCHAR(10) NOT NULL, -- '850', '856', 'ORDERS', 'DESADV'
  edi_format VARCHAR(20) NOT NULL, -- 'X12', 'EDIFACT'

  -- Control numbers
  interchange_control_number VARCHAR(20),
  group_control_number VARCHAR(20),
  transaction_control_number VARCHAR(20),

  -- External references
  external_reference VARCHAR(100), -- Trading partner's PO/ASN number
  internal_reference VARCHAR(100), -- Our SO/ASN number

  -- Status tracking
  status VARCHAR(20) NOT NULL DEFAULT 'pending',
  -- Inbound: pending, validating, processed, failed, duplicate
  -- Outbound: pending, generated, sent, acknowledged, failed

  -- Content
  raw_content TEXT NOT NULL, -- Original EDI message
  parsed_content JSONB, -- Parsed JSON representation

  -- Error handling
  error_code VARCHAR(50),
  error_message TEXT,
  error_details JSONB,

  -- Processing info
  processed_at TIMESTAMPTZ,
  retry_count INTEGER DEFAULT 0,
  last_retry_at TIMESTAMPTZ,

  -- Related entities
  sales_order_id UUID REFERENCES sales_orders(id) ON DELETE SET NULL,
  asn_id UUID REFERENCES asns(id) ON DELETE SET NULL,

  -- Metadata
  file_name VARCHAR(255),
  file_size INTEGER,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  created_by UUID REFERENCES users(id),

  CONSTRAINT edi_messages_direction_check CHECK (direction IN ('inbound', 'outbound')),
  CONSTRAINT edi_messages_status_check CHECK (status IN ('pending', 'validating', 'processed', 'generated', 'sent', 'acknowledged', 'failed', 'duplicate'))
);

-- Indexes
CREATE INDEX idx_edi_messages_org_id ON edi_messages(org_id);
CREATE INDEX idx_edi_messages_partner_id ON edi_messages(trading_partner_id);
CREATE INDEX idx_edi_messages_status ON edi_messages(org_id, status);
CREATE INDEX idx_edi_messages_type ON edi_messages(org_id, message_type);
CREATE INDEX idx_edi_messages_direction ON edi_messages(org_id, direction);
CREATE INDEX idx_edi_messages_created ON edi_messages(org_id, created_at DESC);
CREATE INDEX idx_edi_messages_external_ref ON edi_messages(org_id, external_reference);
CREATE INDEX idx_edi_messages_internal_ref ON edi_messages(org_id, internal_reference);
```

#### edi_product_mappings table

```sql
CREATE TABLE edi_product_mappings (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  trading_partner_id UUID NOT NULL REFERENCES edi_trading_partners(id) ON DELETE CASCADE,

  -- Product reference
  product_id UUID NOT NULL REFERENCES products(id) ON DELETE CASCADE,

  -- External identifiers (buyer's catalog)
  buyer_part_number VARCHAR(100),
  buyer_description VARCHAR(255),
  upc_code VARCHAR(14), -- GTIN-12/13/14

  -- Unit of measure mapping
  buyer_uom VARCHAR(10), -- EA, CS, PK
  internal_uom VARCHAR(10), -- Maps to UOM in MonoPilot
  uom_conversion_factor DECIMAL(10,4) DEFAULT 1,

  -- Pricing (optional)
  buyer_unit_price DECIMAL(12,4),
  currency_code VARCHAR(3) DEFAULT 'USD',

  -- Metadata
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),

  CONSTRAINT edi_product_mapping_unique UNIQUE (trading_partner_id, buyer_part_number)
);

-- Indexes
CREATE INDEX idx_edi_product_mappings_partner ON edi_product_mappings(trading_partner_id);
CREATE INDEX idx_edi_product_mappings_product ON edi_product_mappings(product_id);
CREATE INDEX idx_edi_product_mappings_buyer_pn ON edi_product_mappings(trading_partner_id, buyer_part_number);
CREATE INDEX idx_edi_product_mappings_upc ON edi_product_mappings(trading_partner_id, upc_code);
```

#### organization_settings extension

```sql
-- Add EDI settings to organization
ALTER TABLE organizations ADD COLUMN IF NOT EXISTS
  edi_enabled BOOLEAN DEFAULT false;

ALTER TABLE organizations ADD COLUMN IF NOT EXISTS
  edi_default_format VARCHAR(20) DEFAULT 'X12';

ALTER TABLE organizations ADD COLUMN IF NOT EXISTS
  edi_isa_id VARCHAR(15); -- Organization's ISA ID for X12

ALTER TABLE organizations ADD COLUMN IF NOT EXISTS
  edi_isa_qualifier VARCHAR(2) DEFAULT 'ZZ';

ALTER TABLE organizations ADD COLUMN IF NOT EXISTS
  edi_unb_id VARCHAR(35); -- Organization's UNB ID for EDIFACT
```

### RLS Policies

```sql
-- edi_trading_partners: Org-scoped access
CREATE POLICY "edi_partners_org_read" ON edi_trading_partners
FOR SELECT USING (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
);

CREATE POLICY "edi_partners_org_insert" ON edi_trading_partners
FOR INSERT WITH CHECK (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
);

CREATE POLICY "edi_partners_org_update" ON edi_trading_partners
FOR UPDATE USING (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
);

CREATE POLICY "edi_partners_org_delete" ON edi_trading_partners
FOR DELETE USING (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
);

-- edi_messages: Org-scoped access
CREATE POLICY "edi_messages_org_read" ON edi_messages
FOR SELECT USING (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
);

CREATE POLICY "edi_messages_org_insert" ON edi_messages
FOR INSERT WITH CHECK (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
);

CREATE POLICY "edi_messages_org_update" ON edi_messages
FOR UPDATE USING (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
);

-- edi_product_mappings: Org-scoped access
CREATE POLICY "edi_product_mappings_org_read" ON edi_product_mappings
FOR SELECT USING (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
);

CREATE POLICY "edi_product_mappings_org_insert" ON edi_product_mappings
FOR INSERT WITH CHECK (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
);

CREATE POLICY "edi_product_mappings_org_update" ON edi_product_mappings
FOR UPDATE USING (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
);

CREATE POLICY "edi_product_mappings_org_delete" ON edi_product_mappings
FOR DELETE USING (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
);
```

### API Endpoints

```
# Trading Partner Management
GET    /api/v1/planning/edi/partners                    - List trading partners
GET    /api/v1/planning/edi/partners/:id                - Get trading partner details
POST   /api/v1/planning/edi/partners                    - Create trading partner
PUT    /api/v1/planning/edi/partners/:id                - Update trading partner
DELETE /api/v1/planning/edi/partners/:id                - Delete/deactivate partner

# Product Mappings
GET    /api/v1/planning/edi/partners/:id/mappings       - List product mappings for partner
POST   /api/v1/planning/edi/partners/:id/mappings       - Create product mapping
PUT    /api/v1/planning/edi/partners/:id/mappings/:mapId - Update mapping
DELETE /api/v1/planning/edi/partners/:id/mappings/:mapId - Delete mapping

# EDI Message Operations
GET    /api/v1/planning/edi/messages                    - List EDI messages (with filters)
GET    /api/v1/planning/edi/messages/:id                - Get message detail
POST   /api/v1/planning/edi/messages/:id/retry          - Retry failed message

# 850 Import (Inbound PO)
POST   /api/v1/planning/edi/import/850                  - Upload and parse 850 file
POST   /api/v1/planning/edi/import/850/:id/process      - Process parsed 850 into SO
GET    /api/v1/planning/edi/import/850/:id/preview      - Preview parsed 850 content

# 856 Export (Outbound ASN)
POST   /api/v1/planning/edi/export/856                  - Generate 856 from ASN
GET    /api/v1/planning/edi/export/856/:id/download     - Download 856 file
POST   /api/v1/planning/edi/export/856/bulk             - Bulk generate 856 for multiple ASNs

# EDI Settings
GET    /api/v1/settings/edi                             - Get org EDI settings
PUT    /api/v1/settings/edi                             - Update org EDI settings

# Gateway Integration (webhook endpoints)
POST   /api/v1/planning/edi/webhook/inbound             - Receive EDI from gateway
GET    /api/v1/planning/edi/webhook/outbound/:id        - Gateway fetches outbound message
```

### Service Methods

**Location:** `lib/services/edi-service.ts`

```typescript
interface EDIService {
  // Trading Partner CRUD
  listTradingPartners(orgId: string, filters?: PartnerFilters): Promise<TradingPartner[]>;
  getTradingPartner(id: string): Promise<TradingPartner>;
  createTradingPartner(data: CreatePartnerInput): Promise<TradingPartner>;
  updateTradingPartner(id: string, data: UpdatePartnerInput): Promise<TradingPartner>;
  deleteTradingPartner(id: string): Promise<void>;

  // Product Mapping
  listProductMappings(partnerId: string): Promise<ProductMapping[]>;
  createProductMapping(partnerId: string, data: CreateMappingInput): Promise<ProductMapping>;
  updateProductMapping(mappingId: string, data: UpdateMappingInput): Promise<ProductMapping>;
  deleteProductMapping(mappingId: string): Promise<void>;
  resolveProduct(partnerId: string, buyerPartNumber: string): Promise<Product | null>;

  // Message Management
  listMessages(orgId: string, filters?: MessageFilters): Promise<EDIMessage[]>;
  getMessage(id: string): Promise<EDIMessage>;
  createMessage(data: CreateMessageInput): Promise<EDIMessage>;
  updateMessageStatus(id: string, status: MessageStatus, error?: ErrorInfo): Promise<void>;
  retryMessage(id: string): Promise<EDIMessage>;

  // Helpers
  identifyTradingPartner(isaId: string, format: string): Promise<TradingPartner | null>;
  generateControlNumber(type: 'interchange' | 'group' | 'transaction'): string;
}
```

**Location:** `lib/services/edi-x12-parser.ts`

```typescript
interface X12ParserService {
  // 850 Parsing
  parse850(rawContent: string): Promise<Parsed850>;
  validate850(parsed: Parsed850): ValidationResult;
  extract850Header(parsed: Parsed850): PurchaseOrderHeader;
  extract850Lines(parsed: Parsed850): PurchaseOrderLine[];

  // 856 Generation
  generate856(asn: ASNWithItems, partner: TradingPartner): string;
  buildHierarchy(asn: ASNWithItems): HierarchyLevel[];
  formatSegment(segmentId: string, elements: string[]): string;

  // Common utilities
  parseISA(segment: string): ISASegment;
  parseGS(segment: string): GSSegment;
  parseST(segment: string): STSegment;
  splitSegments(rawContent: string): string[];
  getElementDelimiter(rawContent: string): string;
  getSegmentDelimiter(rawContent: string): string;
}

interface Parsed850 {
  isa: ISASegment;
  gs: GSSegment;
  st: STSegment;
  beg: BEGSegment; // Beginning segment for PO
  n1_loops: N1Loop[]; // Name loops (ship-to, bill-to)
  po1_loops: PO1Loop[]; // Line item loops
  ctt: CTTSegment; // Transaction totals
  se: SESegment;
  ge: GESegment;
  iea: IEASegment;
}

interface BEGSegment {
  transaction_type: string; // '00' = Original
  po_type: string; // 'NE' = New Order
  po_number: string;
  po_date: string;
}

interface PO1Loop {
  line_number: string;
  quantity_ordered: number;
  uom: string;
  unit_price: number;
  product_id_qualifier: string; // 'BP' = Buyer Part, 'UP' = UPC
  product_id: string;
  pid?: PIDSegment; // Product description
  sac?: SACSegment[]; // Allowances/charges
}
```

**Location:** `lib/services/edi-import-service.ts`

```typescript
interface EDIImportService {
  // 850 Import workflow
  uploadAndParse850(orgId: string, file: File): Promise<ParsedImportResult>;
  previewImport(messageId: string): Promise<ImportPreview>;
  processImport(messageId: string): Promise<ProcessResult>;

  // Mapping resolution
  resolveProductMappings(partnerId: string, lines: PO1Loop[]): Promise<MappingResult[]>;
  createSalesOrderFromImport(messageId: string, preview: ImportPreview): Promise<SalesOrder>;

  // Duplicate detection
  checkDuplicate(partnerId: string, externalRef: string): Promise<DuplicateCheck>;
}

interface ImportPreview {
  message_id: string;
  trading_partner: TradingPartner;
  po_number: string;
  po_date: string;
  ship_to?: AddressInfo;
  bill_to?: AddressInfo;
  lines: ImportLinePreview[];
  unmapped_products: UnmappedProduct[];
  validation_errors: ValidationError[];
  can_process: boolean;
}

interface ImportLinePreview {
  line_number: string;
  buyer_part_number: string;
  product?: Product;
  quantity: number;
  uom: string;
  unit_price: number;
  is_mapped: boolean;
}
```

**Location:** `lib/services/edi-export-service.ts`

```typescript
interface EDIExportService {
  // 856 Export workflow
  generate856FromASN(asnId: string): Promise<EDIMessage>;
  bulkGenerate856(asnIds: string[]): Promise<BulkGenerateResult>;
  downloadMessage(messageId: string): Promise<FileDownload>;

  // Validation
  validate856Content(asn: ASNWithItems, partner: TradingPartner): ValidationResult;

  // Status management
  markAsSent(messageId: string): Promise<void>;
  markAsAcknowledged(messageId: string, ackDetails?: AckInfo): Promise<void>;
}

interface BulkGenerateResult {
  successful: EDIMessage[];
  failed: FailedGeneration[];
  total: number;
}
```

### Zod Validation Schemas

**Location:** `lib/validation/edi.ts`

```typescript
import { z } from 'zod';

// Trading Partner schemas
export const tradingPartnerSchema = z.object({
  id: z.string().uuid(),
  org_id: z.string().uuid(),
  code: z.string().min(1).max(50),
  name: z.string().min(1).max(255),
  is_active: z.boolean(),
  edi_format: z.enum(['X12', 'EDIFACT']),
  isa_id: z.string().max(15).nullable(),
  isa_qualifier: z.string().max(2).default('ZZ'),
  unb_id: z.string().max(35).nullable(),
  supports_850: z.boolean(),
  supports_856: z.boolean(),
  require_lot_tracking: z.boolean(),
  require_expiry_date: z.boolean(),
  allow_over_ship: z.boolean(),
  over_ship_tolerance: z.number().min(0).max(100),
  created_at: z.string().datetime(),
  updated_at: z.string().datetime(),
});

export const createTradingPartnerSchema = z.object({
  code: z.string().min(1).max(50),
  name: z.string().min(1).max(255),
  edi_format: z.enum(['X12', 'EDIFACT']),
  isa_id: z.string().max(15).optional(),
  isa_qualifier: z.string().max(2).default('ZZ'),
  unb_id: z.string().max(35).optional(),
  supports_850: z.boolean().default(false),
  supports_856: z.boolean().default(false),
  require_lot_tracking: z.boolean().default(true),
  require_expiry_date: z.boolean().default(true),
  allow_over_ship: z.boolean().default(false),
  over_ship_tolerance: z.number().min(0).max(100).default(0),
  contact_name: z.string().max(255).optional(),
  contact_email: z.string().email().optional(),
  notes: z.string().optional(),
});

export const updateTradingPartnerSchema = createTradingPartnerSchema.partial();

// Product Mapping schemas
export const productMappingSchema = z.object({
  id: z.string().uuid(),
  trading_partner_id: z.string().uuid(),
  product_id: z.string().uuid(),
  buyer_part_number: z.string().max(100),
  buyer_description: z.string().max(255).nullable(),
  upc_code: z.string().max(14).nullable(),
  buyer_uom: z.string().max(10).nullable(),
  internal_uom: z.string().max(10).nullable(),
  uom_conversion_factor: z.number().positive().default(1),
  is_active: z.boolean(),
});

export const createProductMappingSchema = z.object({
  product_id: z.string().uuid(),
  buyer_part_number: z.string().min(1).max(100),
  buyer_description: z.string().max(255).optional(),
  upc_code: z.string().max(14).optional(),
  buyer_uom: z.string().max(10).optional(),
  internal_uom: z.string().max(10).optional(),
  uom_conversion_factor: z.number().positive().default(1),
});

// EDI Message schemas
export const ediMessageSchema = z.object({
  id: z.string().uuid(),
  org_id: z.string().uuid(),
  trading_partner_id: z.string().uuid().nullable(),
  direction: z.enum(['inbound', 'outbound']),
  message_type: z.string(),
  edi_format: z.enum(['X12', 'EDIFACT']),
  interchange_control_number: z.string().nullable(),
  external_reference: z.string().nullable(),
  internal_reference: z.string().nullable(),
  status: z.enum(['pending', 'validating', 'processed', 'generated', 'sent', 'acknowledged', 'failed', 'duplicate']),
  error_message: z.string().nullable(),
  processed_at: z.string().datetime().nullable(),
  created_at: z.string().datetime(),
});

// Import/Export schemas
export const import850Schema = z.object({
  file: z.instanceof(File).refine(
    (file) => file.size <= 10 * 1024 * 1024,
    'File size must be less than 10MB'
  ),
});

export const export856Schema = z.object({
  asn_id: z.string().uuid(),
});

export const bulkExport856Schema = z.object({
  asn_ids: z.array(z.string().uuid()).min(1).max(100),
});

// Settings schema
export const ediSettingsSchema = z.object({
  edi_enabled: z.boolean(),
  edi_default_format: z.enum(['X12', 'EDIFACT']),
  edi_isa_id: z.string().max(15).optional(),
  edi_isa_qualifier: z.string().max(2).default('ZZ'),
  edi_unb_id: z.string().max(35).optional(),
});
```

## UI Components

### Pages

- `app/(authenticated)/settings/edi/page.tsx` - EDI settings page
- `app/(authenticated)/settings/edi/partners/page.tsx` - Trading partners list
- `app/(authenticated)/settings/edi/partners/[id]/page.tsx` - Trading partner detail
- `app/(authenticated)/planning/edi/page.tsx` - EDI dashboard/message list
- `app/(authenticated)/planning/edi/import/page.tsx` - Import 850 page
- `app/(authenticated)/planning/edi/messages/[id]/page.tsx` - Message detail

### Components

**Location:** `components/planning/edi/`

```
TradingPartnersList.tsx       - DataTable of trading partners
TradingPartnerForm.tsx        - Create/edit trading partner form
TradingPartnerCard.tsx        - Summary card for partner
ProductMappingsTable.tsx      - DataTable of product mappings
ProductMappingDialog.tsx      - Add/edit product mapping modal
EDIMessagesList.tsx           - DataTable of EDI messages
EDIMessageDetail.tsx          - Message detail view with raw/parsed
EDIMessageStatusBadge.tsx     - Status badge with colors
Import850Upload.tsx           - File upload dropzone for 850
Import850Preview.tsx          - Preview parsed 850 before import
Import850LineTable.tsx        - Line items table with mapping status
Export856Button.tsx           - Generate 856 action button
Export856Dialog.tsx           - Confirmation dialog for export
UnmappedProductsAlert.tsx     - Alert showing unmapped products
EDIDashboardWidget.tsx        - Dashboard widget for pending messages
EDISettingsForm.tsx           - Organization EDI settings form
```

### Component Details

**TradingPartnerForm.tsx**
```tsx
interface TradingPartnerFormProps {
  partner?: TradingPartner;
  onSuccess: () => void;
  onCancel: () => void;
}

// Form sections:
// - Basic Info: code, name, format (X12/EDIFACT)
// - Identifiers: ISA ID, qualifier (X12) or UNB ID (EDIFACT)
// - Message Types: checkboxes for 850, 856
// - Validation: lot tracking, expiry required, over-ship tolerance
// - Contact: name, email, phone
// - Notes: free text
```

**Import850Preview.tsx**
```tsx
interface Import850PreviewProps {
  preview: ImportPreview;
  onProcess: () => void;
  onCancel: () => void;
  isProcessing: boolean;
}

// Displays:
// - Trading partner info
// - PO header (number, date, ship-to)
// - Line items table with mapping status
// - Validation errors/warnings
// - Unmapped products alert
// - Process/Cancel buttons
```

**EDIMessageDetail.tsx**
```tsx
interface EDIMessageDetailProps {
  message: EDIMessage;
  onRetry?: () => void;
}

// Tabs:
// - Summary: header info, status, timestamps
// - Parsed Content: JSON tree view
// - Raw Message: code block with EDI content
// - Errors: if failed, show error details
// - Related: links to SO/ASN if processed
```

### UI Patterns

**Trading Partner List Layout:**
```
+------------------------------------------------------------------+
| Trading Partners                              [+ Add Partner]    |
+------------------------------------------------------------------+
| Search: [________________]  Format: [All v]  Status: [Active v]  |
+------------------------------------------------------------------+
| Code     | Name           | Format  | 850 | 856 | Status | Actions|
|----------|----------------|---------|-----|-----|--------|--------|
| TESCO    | Tesco PLC      | EDIFACT | Yes | Yes | Active | [Edit] |
| WALMART  | Walmart Inc    | X12     | Yes | Yes | Active | [Edit] |
| KROGER   | Kroger Co      | X12     | Yes | No  | Active | [Edit] |
+------------------------------------------------------------------+
```

**850 Import Preview Layout:**
```
+------------------------------------------------------------------+
| Import EDI 850 - Purchase Order                                  |
+------------------------------------------------------------------+
| Partner: WALMART (Walmart Inc)                                    |
| PO Number: 4500123456                                            |
| PO Date: 2024-03-15                                              |
| Ship To: Distribution Center #42                                 |
+------------------------------------------------------------------+
| Line | Buyer Part # | Our Product      | Qty   | UOM | Price    |
|------|--------------|------------------|-------|-----|----------|
| 1    | WAL-001      | Flour 25lb [OK]  | 100   | CS  | $45.00   |
| 2    | WAL-002      | Sugar 10lb [OK]  | 50    | CS  | $32.00   |
| 3    | WAL-003      | [UNMAPPED]       | 25    | CS  | $28.00   |
+------------------------------------------------------------------+
| [!] 1 product requires mapping before import                     |
|                                                                  |
|                              [Cancel]  [Map Products]  [Import]  |
+------------------------------------------------------------------+
```

**EDI Message Status Badges:**
```
Status badges with colors:
- pending: gray/default
- validating: blue
- processed: green
- generated: blue
- sent: green
- acknowledged: green with check
- failed: red
- duplicate: yellow/warning
```

## Test Cases

### Unit Tests

**edi-service.test.ts**
```typescript
describe('EDIService', () => {
  describe('createTradingPartner', () => {
    it('creates partner with valid X12 config');
    it('creates partner with valid EDIFACT config');
    it('rejects duplicate partner code');
    it('validates ISA ID format for X12');
  });

  describe('resolveProduct', () => {
    it('resolves product by buyer part number');
    it('resolves product by UPC code');
    it('returns null for unmapped product');
  });

  describe('identifyTradingPartner', () => {
    it('identifies partner by ISA ID');
    it('identifies partner by UNB ID');
    it('returns null for unknown ID');
  });
});
```

**edi-x12-parser.test.ts**
```typescript
describe('X12ParserService', () => {
  describe('parse850', () => {
    it('parses valid 850 message');
    it('extracts ISA/GS/ST segments correctly');
    it('parses BEG segment for PO header');
    it('parses PO1 loops for line items');
    it('handles multiple N1 loops (ship-to, bill-to)');
    it('throws on invalid segment structure');
    it('handles different element delimiters');
  });

  describe('generate856', () => {
    it('generates valid 856 structure');
    it('creates HL hierarchy for shipment/order/pack/item');
    it('includes SSCC-18 in REF segment');
    it('includes lot/expiry in LIN/SN1 segments');
    it('calculates correct segment counts');
  });

  describe('validate850', () => {
    it('validates required segments present');
    it('validates segment counts match CTT');
    it('validates control numbers match');
  });
});
```

**edi-import-service.test.ts**
```typescript
describe('EDIImportService', () => {
  describe('uploadAndParse850', () => {
    it('parses uploaded file and creates message');
    it('identifies trading partner from ISA');
    it('sets status to validating');
    it('rejects file exceeding size limit');
  });

  describe('previewImport', () => {
    it('returns preview with mapped products');
    it('flags unmapped products');
    it('includes validation errors');
    it('calculates can_process correctly');
  });

  describe('processImport', () => {
    it('creates Sales Order from import');
    it('links SO to EDI message');
    it('sets message status to processed');
    it('rejects if unmapped products exist');
  });

  describe('checkDuplicate', () => {
    it('detects duplicate PO number');
    it('returns existing SO reference');
    it('allows re-import with different version');
  });
});
```

**edi-export-service.test.ts**
```typescript
describe('EDIExportService', () => {
  describe('generate856FromASN', () => {
    it('generates 856 for valid ASN');
    it('validates all LPs have SSCC');
    it('validates lot/expiry if required by partner');
    it('creates EDI message record');
  });

  describe('bulkGenerate856', () => {
    it('generates 856 for multiple ASNs');
    it('returns partial results on some failures');
    it('handles empty ASN list');
  });

  describe('validate856Content', () => {
    it('validates required fields present');
    it('validates SSCC format');
    it('validates quantities match');
  });
});
```

### Integration Tests

**edi-api.test.ts**
```typescript
describe('EDI API', () => {
  describe('GET /api/v1/planning/edi/partners', () => {
    it('returns org trading partners');
    it('filters by format');
    it('filters by active status');
    it('returns 401 for unauthenticated');
  });

  describe('POST /api/v1/planning/edi/import/850', () => {
    it('parses uploaded 850 file');
    it('returns preview with line items');
    it('returns validation errors for invalid file');
    it('identifies trading partner');
  });

  describe('POST /api/v1/planning/edi/import/850/:id/process', () => {
    it('creates SO from parsed 850');
    it('links EDI message to SO');
    it('returns 400 if unmapped products');
    it('returns 409 on duplicate detection');
  });

  describe('POST /api/v1/planning/edi/export/856', () => {
    it('generates 856 from ASN');
    it('returns file content');
    it('validates ASN has required data');
  });

  describe('Multi-tenancy', () => {
    it('isolates partners between orgs');
    it('isolates messages between orgs');
    it('returns 404 for cross-org access');
  });
});
```

### E2E Tests

**edi-import.spec.ts**
```typescript
describe('EDI 850 Import', () => {
  it('uploads 850 file and shows preview');
  it('displays trading partner information');
  it('shows product mapping status per line');
  it('allows mapping unmapped products');
  it('processes import and creates SO');
  it('shows success message with SO link');
  it('handles duplicate PO warning');
});
```

**edi-export.spec.ts**
```typescript
describe('EDI 856 Export', () => {
  it('navigates to ASN and clicks Export EDI');
  it('generates 856 and shows download link');
  it('downloads .edi file');
  it('shows validation error if SSCC missing');
  it('bulk exports multiple ASNs');
});
```

**trading-partner-management.spec.ts**
```typescript
describe('Trading Partner Management', () => {
  it('lists existing trading partners');
  it('creates new X12 trading partner');
  it('creates new EDIFACT trading partner');
  it('edits trading partner configuration');
  it('manages product mappings');
  it('deactivates trading partner');
});
```

## X12 Message Format Reference

### 850 Purchase Order Structure

```
ISA*00*          *00*          *ZZ*SENDER         *ZZ*RECEIVER       *240315*1200*U*00401*000000001*0*P*>~
GS*PO*SENDER*RECEIVER*20240315*1200*1*X*004010~
ST*850*0001~
BEG*00*NE*4500123456**20240315~
REF*DP*001~
N1*ST*Distribution Center 42*92*DC42~
N3*123 Warehouse Lane~
N4*Chicago*IL*60601*US~
N1*BT*Walmart Inc*92*WALMART~
PO1*1*100*CS*45.00**BP*WAL-001*UP*012345678901~
PID*F****All Purpose Flour 25lb~
PO1*2*50*CS*32.00**BP*WAL-002*UP*012345678902~
PID*F****Granulated Sugar 10lb~
CTT*2~
SE*14*0001~
GE*1*1~
IEA*1*000000001~
```

### 856 ASN Structure

```
ISA*00*          *00*          *ZZ*SENDER         *ZZ*RECEIVER       *240320*1000*U*00401*000000002*0*P*>~
GS*SH*SENDER*RECEIVER*20240320*1000*2*X*004010~
ST*856*0001~
BSN*00*ASN123456*20240320*1000*0001~
HL*1**S~
TD1*CTN*10~
TD5**2*FEDX**FedEx Ground~
REF*BM*ASN123456~
DTM*011*20240321~
N1*ST*Distribution Center 42*92*DC42~
HL*2*1*O~
PRF*4500123456~
HL*3*2*P~
MAN*GM*00012345678901234567~
HL*4*3*I~
LIN**BP*WAL-001*UP*012345678901~
SN1**100*CS~
HL*5*2*P~
MAN*GM*00012345678901234568~
HL*6*5*I~
LIN**BP*WAL-002*UP*012345678902~
SN1**50*CS~
CTT*6~
SE*20*0001~
GE*1*2~
IEA*1*000000002~
```

## Security Considerations

1. **File Upload Security**
   - Validate file type and size
   - Scan for malicious content
   - Store in secure temp location
   - Clean up after processing

2. **Partner Identification**
   - Validate ISA/UNB IDs against configured partners
   - Reject messages from unknown senders
   - Log all identification attempts

3. **Data Validation**
   - Validate all EDI segment structures
   - Sanitize parsed data before database insert
   - Prevent SQL injection via product mappings

4. **Audit Trail**
   - Log all EDI message processing
   - Track who processed/exported messages
   - Retain raw message content for compliance

5. **API Security**
   - Webhook endpoints require authentication
   - Rate limit import/export operations
   - Validate org ownership on all operations

## Deliverables

- [ ] `edi_trading_partners` table migration
- [ ] `edi_messages` table migration
- [ ] `edi_product_mappings` table migration
- [ ] Organizations table extension (EDI settings)
- [ ] RLS policies for all EDI tables
- [ ] EDI service (`lib/services/edi-service.ts`)
- [ ] X12 parser service (`lib/services/edi-x12-parser.ts`)
- [ ] EDI import service (`lib/services/edi-import-service.ts`)
- [ ] EDI export service (`lib/services/edi-export-service.ts`)
- [ ] Zod schemas (`lib/validation/edi.ts`)
- [ ] API routes for trading partners
- [ ] API routes for product mappings
- [ ] API routes for message operations
- [ ] API routes for 850 import
- [ ] API routes for 856 export
- [ ] Trading partner list page
- [ ] Trading partner form component
- [ ] Product mappings table component
- [ ] EDI messages list page
- [ ] EDI message detail component
- [ ] 850 import upload component
- [ ] 850 import preview component
- [ ] 856 export dialog component
- [ ] EDI settings page
- [ ] Unit tests (>80% coverage)
- [ ] Integration tests
- [ ] E2E tests

## Definition of Done

- [ ] Trading partners can be created, edited, and deactivated
- [ ] Product mappings link buyer part numbers to internal products
- [ ] X12 850 files can be uploaded and parsed
- [ ] 850 preview shows all line items with mapping status
- [ ] Unmapped products are flagged and can be mapped inline
- [ ] Processed 850 creates Sales Order with correct data
- [ ] X12 856 can be generated from ASN
- [ ] 856 includes SSCC-18, lot, and expiry data
- [ ] 856 validates required data before generation
- [ ] EDI message log tracks all inbound/outbound messages
- [ ] Failed messages can be retried
- [ ] Duplicate PO detection works correctly
- [ ] Multi-tenancy isolation verified
- [ ] All API endpoints return correct error codes
- [ ] Unit test coverage >= 80%
- [ ] Integration tests pass
- [ ] E2E tests pass
- [ ] EDI format documentation reviewed

## Future Phases

### Phase 4 - Advanced EDI

| Feature | Priority | Description |
|---------|----------|-------------|
| EDIFACT full support | P2 | Complete ORDERS/DESADV parsing |
| GS1 XML format | P3 | Modern XML-based EDI alternative |
| 810 Invoice | P2 | Outbound invoice generation |
| 997 Functional Ack | P2 | Auto-generate acknowledgments |
| RECADV support | P3 | Inbound receiving advice |
| Gateway polling | P3 | Automated message retrieval |
| AS2 transport | P3 | Direct AS2 communication |
| SFTP integration | P3 | File-based exchange |
| EDI analytics | P3 | Message volume, error rates |
