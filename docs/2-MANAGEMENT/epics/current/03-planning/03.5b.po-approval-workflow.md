# 03.5b - PO Approval Workflow (Submit/Approve/Reject)

| Field | Value |
|-------|-------|
| **Story ID** | 03.5b |
| **Epic** | 03 - Planning |
| **Status** | Ready |
| **Phase** | Phase 1 (P1) |
| **Complexity** | M (Medium) |
| **Estimate** | 3-4 days |
| **Type** | Full-stack |

---

## PRD References

| FR ID | Requirement | Priority | Covered |
|-------|-------------|----------|---------|
| FR-PLAN-009 | PO Approval Workflow | Should Have | YES |
| FR-PLAN-007 | PO Status Lifecycle | Must Have | PARTIAL (approval states) |

**Primary PRD:** `docs/1-BASELINE/product/modules/planning.md` (Section 5.5)
**Architecture:** `docs/1-BASELINE/architecture/modules/planning.md`
**UX Wireframes:** PLA-020 (Approval Modal), PLA-021 (Status Badges), PLA-022 (Approval History)

---

## MVP Scope

This story implements Phase 1 PO approval workflow functionality. The configuration (Story 03.5a) must be completed first. This story focuses on the runtime workflow execution.

**MVP Includes**:
- PO status transitions for approval flow (draft → pending_approval → approved/rejected)
- Submit for approval action (with threshold and role validation)
- Approve PO action (with notes and user tracking)
- Reject PO action (with required rejection reason)
- Approval history tracking (po_approval_history table)
- Email notifications via notification service
- Approval modal UI component
- Status badge component with visual states
- Service layer methods for workflow state machine
- API endpoints: `/submit`, `/approve`, `/reject`
- Validation schemas for approval actions
- Comprehensive tests for state machine logic

**Deferred to Phase 1+**: Multi-level approval chains, approval delegation, approval reminders/escalation, custom approval rules engine.

---

## User Story

As a **Planner or Purchaser**, I want **to submit purchase orders for approval and have designated approvers review and approve/reject them** so that **purchase orders above a threshold amount are properly authorized before being sent to suppliers, ensuring financial controls and budget compliance**.

---

## Dependencies

| Dependency | Story/Epic | Type | Reason |
|------------|------------|------|--------|
| 01.1 | Org Context + Base RLS | HARD | Requires org_id context and RLS patterns |
| 01.X | User Roles | HARD | Approval permissions based on roles |
| 03.3 | PO CRUD + Lines | HARD | Extends PO status lifecycle |
| 03.5a | PO Approval Setup | HARD | Requires approval configuration settings |
| Notification Service | SendGrid/Email | HARD | Email notifications for approvers |

**Dependents:**
- Epic 05 (Warehouse - PO Receiving) - PO must be approved before receiving

---

## Acceptance Criteria (Gherkin)

### AC-1: Submit PO for Approval (FR-PLAN-009)

```gherkin
Scenario: Submit PO below threshold (no approval required)
  Given approval is enabled with threshold $10,000
  And PO total is $5,000
  And PO status is "draft"
  When planner clicks "Submit PO"
  Then PO status changes to "submitted" (skips approval)
  And no approval notification is sent
  And success message displays: "Purchase order submitted successfully"

Scenario: Submit PO above threshold (approval required)
  Given approval is enabled with threshold $10,000
  And PO total is $15,000
  And PO status is "draft"
  And approval roles are ['admin', 'manager']
  When planner clicks "Submit for Approval"
  Then PO status changes to "pending_approval"
  And approval_status field set to "pending"
  And email notification sent to all users with admin or manager roles
  And success message displays: "Purchase order submitted for approval. Approvers have been notified."
  And approval history record created with action "submitted"

Scenario: Submit PO when approval disabled
  Given approval is disabled in settings
  And PO total is $15,000
  And PO status is "draft"
  When planner clicks "Submit PO"
  Then PO status changes to "submitted" (skips approval)
  And approval_status remains null
  And no approval notification is sent

Scenario: Cannot submit PO with validation errors
  Given PO has no lines added
  When planner clicks "Submit for Approval"
  Then error message displays: "Cannot submit PO: Purchase order must have at least one line item"
  And PO status remains "draft"

Scenario: Cannot submit PO that is not in draft status
  Given PO status is "submitted"
  When planner attempts to submit
  Then error message displays: "Cannot submit: PO must be in draft status"
  And PO status remains "submitted"
```

### AC-2: Approve PO (FR-PLAN-009)

```gherkin
Scenario: Manager approves PO successfully
  Given PO status is "pending_approval"
  And current user has role "manager"
  And manager opens approval modal
  When manager enters approval notes "Budget approved by finance team"
  And clicks "Approve"
  Then PO status changes to "approved"
  And approval_status set to "approved"
  And approved_by set to current user ID
  And approved_at set to current timestamp
  And approval_notes saved
  And approval history record created with action "approved"
  And email notification sent to PO creator
  And success message displays: "Purchase order approved successfully"
  And PO can now transition to "confirmed" status

Scenario: Non-approver cannot approve PO
  Given PO status is "pending_approval"
  And current user has role "planner" (not in approval roles)
  When user attempts to approve
  Then error message displays: "Access denied: You do not have permission to approve purchase orders"
  And PO status remains "pending_approval"

Scenario: Cannot approve PO not in pending_approval status
  Given PO status is "draft"
  When manager attempts to approve
  Then error message displays: "Cannot approve: PO must be in pending approval status"
  And PO status remains "draft"
```

### AC-3: Reject PO (FR-PLAN-009)

```gherkin
Scenario: Manager rejects PO with reason
  Given PO status is "pending_approval"
  And current user has role "admin"
  And admin opens approval modal
  When admin enters rejection reason "Exceeds quarterly budget. Please reduce quantity or defer to Q2."
  And clicks "Reject"
  Then PO status changes to "rejected"
  And approval_status set to "rejected"
  And approved_by set to current user ID (rejecter)
  And approved_at set to current timestamp
  And approval_notes saved with rejection reason
  And approval history record created with action "rejected"
  And email notification sent to PO creator
  And success message displays: "Purchase order rejected. Creator has been notified."
  And PO returns to "draft" status for editing

Scenario: Rejection reason is required
  Given PO status is "pending_approval"
  And manager opens approval modal
  When manager leaves rejection reason empty
  And clicks "Reject"
  Then error message displays: "Rejection reason is required"
  And form submission is blocked

Scenario: Non-approver cannot reject PO
  Given PO status is "pending_approval"
  And current user has role "planner"
  When user attempts to reject
  Then error message displays: "Access denied: You do not have permission to reject purchase orders"
  And PO status remains "pending_approval"
```

### AC-4: Approval History Tracking (FR-PLAN-009)

```gherkin
Scenario: View approval history timeline
  Given PO has been submitted, rejected, resubmitted, and approved
  When planner views PO detail page
  Then approval history panel displays with entries:
    - [Timestamp] John Smith (Admin) approved PO - "Budget confirmed by finance"
    - [Timestamp] John Smith (Admin) rejected PO - "Exceeds budget. Reduce quantity."
    - [Timestamp] Jane Doe (Planner) submitted PO for approval
    - [Timestamp] Jane Doe (Planner) submitted PO for approval (initial)
  And entries are sorted by timestamp descending (newest first)
  And each entry shows: timestamp, user name, user role, action, notes

Scenario: Approval history persisted across status changes
  Given PO has approval history with 3 entries
  When PO transitions from "approved" to "confirmed"
  Then all 3 approval history entries remain unchanged
  And are visible in PO detail view

Scenario: Export PO with approval history
  Given PO has approval history
  When planner exports PO to PDF
  Then approval history section included in export
  And shows all approval actions with timestamps and users
```

### AC-5: Email Notifications (FR-PLAN-009)

```gherkin
Scenario: Notification sent to approvers on submission
  Given approval roles are ['admin', 'manager']
  And organization has 2 admins and 3 managers (5 total)
  When planner submits PO for approval (total $15,000)
  Then 5 email notifications sent
  And email subject is "Purchase Order PO-2024-00123 requires your approval"
  And email body includes:
    - PO number with link to PO detail page
    - PO total amount
    - Supplier name
    - Submitted by (user name)
    - Call-to-action buttons: "Approve" and "Reject"
    - Link to approval page

Scenario: Notification sent to creator on approval
  Given PO status is "pending_approval"
  And PO was created by Jane Doe
  When manager approves PO
  Then email notification sent to Jane Doe
  And email subject is "Purchase Order PO-2024-00123 has been approved"
  And email body includes:
    - PO number with link
    - Approved by (user name)
    - Approval notes
    - Next steps: "You can now confirm this PO to send to the supplier"

Scenario: Notification sent to creator on rejection
  Given PO status is "pending_approval"
  And PO was created by Jane Doe
  When manager rejects PO with reason
  Then email notification sent to Jane Doe
  And email subject is "Purchase Order PO-2024-00123 has been rejected"
  And email body includes:
    - PO number with link
    - Rejected by (user name)
    - Rejection reason
    - Call-to-action: "Edit and resubmit PO"

Scenario: No notification sent if approval disabled
  Given approval is disabled in settings
  When planner submits PO
  Then no email notifications sent
```

### AC-6: UI Components - Approval Modal (FR-PLAN-009)

```gherkin
Scenario: Open approval modal for pending PO
  Given PO status is "pending_approval"
  And current user is an approver
  When user clicks "Review" button on PO row
  Then approval modal opens displaying:
    - PO header summary (number, supplier, total, created by)
    - PO lines table (readonly)
    - Action buttons: "Approve" and "Reject"
    - Notes textarea (optional for approval, required for rejection)
    - "Cancel" button

Scenario: Approve from modal
  Given approval modal is open
  When user enters notes "Approved by finance committee"
  And clicks "Approve"
  Then modal closes
  And PO status changes to "approved"
  And success toast displays

Scenario: Reject from modal requires reason
  Given approval modal is open
  When user clicks "Reject" without entering notes
  Then inline error displays: "Please provide a reason for rejection"
  And modal remains open

Scenario: Reject from modal with reason
  Given approval modal is open
  When user enters rejection reason
  And clicks "Reject"
  Then modal closes
  And PO status changes to "rejected"
  And rejection toast displays
```

### AC-7: Status Badge Component (FR-PLAN-009)

```gherkin
Scenario: Display status badges with correct colors
  Given PO list page displays multiple POs
  Then status badges show with correct styling:
    - "draft" → Gray badge
    - "pending_approval" → Yellow/amber badge with clock icon
    - "approved" → Green badge with checkmark icon
    - "rejected" → Red badge with X icon
    - "submitted" → Blue badge
    - "confirmed" → Dark blue badge
    - "cancelled" → Gray strikethrough badge

Scenario: Pending approval badge shows waiting indicator
  Given PO status is "pending_approval"
  When displayed in PO list
  Then badge shows "Pending Approval" text
  And pulsing animation applied
  And tooltip on hover: "Awaiting approval from [role names]"

Scenario: Rejected badge shows rejection metadata
  Given PO status is "rejected"
  When displayed in PO detail
  Then status badge shows "Rejected"
  And tooltip on hover displays: "Rejected by [user name] on [date]: [first 50 chars of reason]..."
```

### AC-8: State Machine Validation (FR-PLAN-007, FR-PLAN-009)

```gherkin
Scenario: Valid state transitions with approval enabled
  Given approval is enabled
  Then only these transitions are allowed:
    - draft → pending_approval (if total >= threshold)
    - draft → submitted (if total < threshold)
    - pending_approval → approved
    - pending_approval → rejected
    - rejected → draft (for editing)
    - approved → confirmed
  And all other transitions throw validation error

Scenario: Invalid transition blocked
  Given PO status is "pending_approval"
  When system attempts to transition to "receiving"
  Then error thrown: "Invalid status transition: pending_approval → receiving"
  And PO status remains "pending_approval"

Scenario: Valid state transitions with approval disabled
  Given approval is disabled
  Then these transitions are allowed:
    - draft → submitted
    - submitted → confirmed
  And pending_approval, approved, rejected states are skipped
```

### AC-9: Performance Requirements (FR-PLAN-009)

```gherkin
Scenario: Approval action completes quickly
  Given PO is in "pending_approval" status
  When approver clicks "Approve"
  Then approval action completes within 500ms
  And notification queued for async sending
  And optimistic UI update shows "approved" immediately

Scenario: Approval history loads efficiently
  Given PO has 20 approval history entries
  When user views PO detail page
  Then approval history panel loads within 200ms
  And entries are paginated (10 per page)

Scenario: Approval notification sent asynchronously
  Given 10 users have approval roles
  When PO submitted for approval
  Then API returns success within 300ms
  And 10 emails queued for background processing
  And email sending does not block API response
```

### AC-10: Future Features (Phase 1+)

Features deferred to Phase 1+:
- **Multi-level approval chains** - Sequential approvals (e.g., Manager → Director → CFO)
- **Approval delegation** - Delegate approval authority to another user
- **Approval reminders** - Auto-email reminder if PO pending for >48 hours
- **Approval escalation** - Auto-escalate to higher role if not approved in X days
- **Custom approval rules** - Approval rules based on supplier, product category, or custom fields
- **Bulk approval** - Approve multiple POs at once
- **Conditional approval** - Approve with conditions (e.g., "Approved pending 10% price reduction")
- **Approval analytics** - Dashboard showing approval bottlenecks, average approval time

**Implementation**: Per Epic 03.0 guidance, hide or show as "Coming Soon" in approval settings.

---

## Implementation Notes

### API Endpoints

```typescript
// Submit PO for approval (or direct submit if no approval needed)
POST /api/planning/purchase-orders/:id/submit
Request: {}
Response: {
  status: 'pending_approval' | 'submitted',
  approval_required: boolean,
  notification_sent: boolean
}

// Approve PO (restricted to approval roles)
POST /api/planning/purchase-orders/:id/approve
Request: {
  notes?: string  // Optional approval notes
}
Response: {
  status: 'approved',
  approved_by: uuid,
  approved_at: timestamp,
  approval_notes: string | null
}

// Reject PO (restricted to approval roles)
POST /api/planning/purchase-orders/:id/reject
Request: {
  rejection_reason: string  // Required
}
Response: {
  status: 'rejected',
  rejected_by: uuid,
  rejected_at: timestamp,
  rejection_reason: string
}

// Get approval history for PO
GET /api/planning/purchase-orders/:id/approval-history
Response: {
  history: Array<{
    id: uuid,
    po_id: uuid,
    action: 'submitted' | 'approved' | 'rejected',
    user_id: uuid,
    user_name: string,
    user_role: string,
    notes: string | null,
    created_at: timestamp
  }>
}
```

### Database

```sql
-- Approval history tracking table (NEW)
CREATE TABLE po_approval_history (
  id                UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id            UUID NOT NULL REFERENCES organizations(id),
  po_id             UUID NOT NULL REFERENCES purchase_orders(id) ON DELETE CASCADE,
  action            TEXT NOT NULL CHECK (action IN ('submitted', 'approved', 'rejected')),
  user_id           UUID NOT NULL REFERENCES users(id),
  user_name         TEXT NOT NULL,  -- Denormalized for historical accuracy
  user_role         TEXT NOT NULL,  -- Denormalized for historical accuracy
  notes             TEXT,
  created_at        TIMESTAMPTZ DEFAULT now(),

  UNIQUE(org_id, id)
);

CREATE INDEX idx_po_approval_history_po ON po_approval_history(po_id);
CREATE INDEX idx_po_approval_history_created ON po_approval_history(created_at DESC);

-- Update purchase_orders table (fields already exist in schema)
-- approval_status: pending | approved | rejected
-- approved_by: UUID REFERENCES users(id)
-- approved_at: TIMESTAMPTZ
-- approval_notes: TEXT

-- RLS Policy for approval history
CREATE POLICY "PO approval history org isolation"
ON po_approval_history FOR ALL
USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));
```

### Frontend Components

```
app/(authenticated)/planning/purchase-orders/
├── [id]/page.tsx                     -- PO detail with approval history
└── components/
    ├── POApprovalModal.tsx           -- NEW: Approve/Reject modal
    ├── POApprovalHistory.tsx         -- NEW: Approval timeline panel
    ├── POStatusBadge.tsx             -- UPDATED: Add approval states
    └── POActionsDropdown.tsx         -- UPDATED: Add approval actions

components/planning/
├── ApprovalStatusBadge.tsx           -- NEW: Reusable status badge
└── ApprovalHistoryTimeline.tsx       -- NEW: Generic timeline component
```

### Services

```typescript
// lib/services/purchase-order-service.ts (EXTEND)

/**
 * Submit PO for approval or direct submission based on settings
 * @throws Error if PO not in draft status or has validation errors
 */
export async function submitPO(
  poId: string,
  orgId: string,
  userId: string
): Promise<{
  status: 'pending_approval' | 'submitted';
  approvalRequired: boolean;
  notificationSent: boolean;
}>;

/**
 * Approve a pending PO (restricted to approval roles)
 * @throws Error if user lacks permission or PO not in pending_approval status
 */
export async function approvePO(
  poId: string,
  orgId: string,
  userId: string,
  userRole: string,
  notes?: string
): Promise<void>;

/**
 * Reject a pending PO (restricted to approval roles)
 * @throws Error if user lacks permission, PO not in pending_approval status, or missing rejection reason
 */
export async function rejectPO(
  poId: string,
  orgId: string,
  userId: string,
  userRole: string,
  rejectionReason: string
): Promise<void>;

/**
 * Get approval history for a PO
 */
export async function getPOApprovalHistory(
  poId: string,
  orgId: string
): Promise<POApprovalHistory[]>;

/**
 * Check if user has approval permission
 */
export async function canUserApprove(
  userId: string,
  orgId: string
): Promise<boolean>;

/**
 * Validate PO status transition (state machine)
 * @throws Error if transition is invalid
 */
export function validateStatusTransition(
  currentStatus: POStatus,
  nextStatus: POStatus,
  approvalEnabled: boolean
): void;
```

### Validation (Zod)

```typescript
// lib/validation/purchase-order-validation.ts (EXTEND)

export const approvePoSchema = z.object({
  notes: z.string().max(1000).optional(),
});

export const rejectPoSchema = z.object({
  rejection_reason: z.string()
    .min(10, 'Rejection reason must be at least 10 characters')
    .max(1000, 'Rejection reason must not exceed 1000 characters'),
});

export const submitPoSchema = z.object({
  // No body needed - action is idempotent
});

// Type exports
export type ApprovePoInput = z.infer<typeof approvePoSchema>;
export type RejectPoInput = z.infer<typeof rejectPoSchema>;
```

### Notification Service Integration

```typescript
// lib/services/notification-service.ts (NEW or EXTEND)

/**
 * Send approval request notification to all approvers
 */
export async function notifyApprovers(
  poId: string,
  poNumber: string,
  poTotal: number,
  supplierName: string,
  submittedBy: string,
  orgId: string
): Promise<void> {
  // 1. Get all users with approval roles from settings
  // 2. For each approver:
  //    - Build email with PO details and CTA links
  //    - Queue SendGrid email
  // 3. Log notification activity
}

/**
 * Send approval decision notification to PO creator
 */
export async function notifyPOCreator(
  poId: string,
  poNumber: string,
  action: 'approved' | 'rejected',
  approverName: string,
  notes: string,
  creatorUserId: string
): Promise<void> {
  // 1. Build email with approval/rejection details
  // 2. Include next steps CTA
  // 3. Queue SendGrid email
  // 4. Log notification activity
}
```

### Key Business Rules

1. **Approval Threshold Logic**:
   - If `po_require_approval = false`: Always submit directly to "submitted" status
   - If `po_require_approval = true` AND `po_approval_threshold = null`: All POs require approval
   - If `po_require_approval = true` AND `po_approval_threshold = $X`: POs >= $X require approval
   - PO total includes subtotal + tax (discount applied)

2. **Role-Based Permissions**:
   - Only users with roles in `po_approval_roles` can approve/reject
   - PO creator cannot approve their own PO (future enhancement)
   - Approval permission checked on every approve/reject API call

3. **State Machine**:
   - `draft` → `pending_approval` (submit with approval required)
   - `draft` → `submitted` (submit without approval required)
   - `pending_approval` → `approved` (approve action)
   - `pending_approval` → `rejected` (reject action)
   - `rejected` → `draft` (automatic on rejection for re-editing)
   - `approved` → `confirmed` (manual confirmation to send to supplier)

4. **Approval History Immutability**:
   - History records are append-only (never updated or deleted)
   - User name and role denormalized at write time for historical accuracy
   - History persists even if PO is deleted (via ON DELETE CASCADE = false consideration)

5. **Notification Rules**:
   - Notifications queued asynchronously (do not block API response)
   - Email delivery failures logged but do not block workflow
   - Notification preferences respected (future: user can opt out)
   - Include direct action links with temporary auth tokens

6. **Validation Rules**:
   - Cannot submit PO with zero lines
   - Cannot submit PO with zero total
   - Cannot approve/reject PO not in `pending_approval` status
   - Rejection reason minimum 10 characters (meaningful explanation required)
   - Approval notes optional but recommended

---

## Deliverables

- API routes:
  - `POST /api/planning/purchase-orders/:id/submit`
  - `POST /api/planning/purchase-orders/:id/approve`
  - `POST /api/planning/purchase-orders/:id/reject`
  - `GET /api/planning/purchase-orders/:id/approval-history`

- Database migration:
  - `supabase/migrations/YYYYMMDDHHMMSS_create_po_approval_history.sql`

- Components:
  - `POApprovalModal.tsx` - Approve/Reject modal with form validation
  - `POApprovalHistory.tsx` - Timeline display of approval history
  - `POStatusBadge.tsx` (updated) - Status badges with approval states
  - `ApprovalStatusBadge.tsx` - Reusable status badge component

- Services:
  - `lib/services/purchase-order-service.ts` (extended) - Workflow methods
  - `lib/services/notification-service.ts` (new/extended) - Email notifications

- Validation:
  - `lib/validation/purchase-order-validation.ts` (extended) - Approval schemas

- Tests:
  - Unit tests: Workflow state machine (20+ test cases)
  - Unit tests: Approval permission checks (10+ test cases)
  - Unit tests: Notification service (15+ test cases)
  - Integration tests: API endpoints (12+ test cases)
  - E2E tests: Full approval workflow (5+ scenarios)

---

## Definition of Done

- [ ] Database migration created for `po_approval_history` table with RLS policies
- [ ] API endpoints implemented: submit, approve, reject, approval-history
- [ ] Service layer methods implemented with state machine validation
- [ ] Zod validation schemas defined for approve/reject actions
- [ ] Notification service integrated with SendGrid for approval emails
- [ ] Approval modal component with form validation and loading states
- [ ] Approval history timeline component with timestamp formatting
- [ ] Status badge component updated with approval state styling
- [ ] Role-based permission checks enforced in API and UI
- [ ] Unit tests passing with >80% coverage for workflow logic
- [ ] Integration tests passing for all API endpoints
- [ ] E2E smoke test for critical path: submit → approve → confirm
- [ ] Performance: Approval action completes in <500ms (P95)
- [ ] Email notifications send asynchronously without blocking API
- [ ] Error handling graceful for notification failures
- [ ] Documentation updated with approval workflow diagrams
- [ ] Code review completed with focus on state machine correctness
- [ ] QA testing completed with approval edge cases

---

## Future Phases (Not in MVP)

### Phase 1 Enhancements
- **Multi-level approval chains** - Sequential approval (Manager → Director → CFO)
- **Approval delegation** - Temporary delegation of approval authority
- **Approval reminders** - Auto-email after 48 hours if still pending
- **Approval analytics** - Dashboard showing approval bottlenecks and metrics

### Phase 2 Advanced Features
- **Approval escalation** - Auto-escalate to higher role after X days
- **Custom approval rules** - Rules based on supplier, category, product type
- **Bulk approval** - Approve multiple POs in one action
- **Conditional approval** - Approve with conditions/notes requiring changes
- **Approval templates** - Pre-defined approval note templates
- **Approval SLA tracking** - Track time-to-approval against targets

### Phase 3 Enterprise Features
- **Offline approval** - Mobile app with offline approval capability
- **Approval audit trail export** - Export approval history for compliance audits
- **Approval workflow designer** - Visual workflow builder for custom approval paths
- **Integration with external approval systems** - SAP, Oracle approval sync

**Implementation**: See Epic 03.0 "Future Feature Handling" section.

---

## Testing Strategy

### Unit Tests

```typescript
// purchase-order-service.test.ts

describe('PO Approval Workflow', () => {
  describe('submitPO', () => {
    it('should submit directly if approval disabled');
    it('should submit directly if total below threshold');
    it('should require approval if total >= threshold');
    it('should throw error if PO not in draft status');
    it('should throw error if PO has no lines');
    it('should create approval history record on submission');
    it('should send notifications to approvers');
  });

  describe('approvePO', () => {
    it('should approve PO and update status to approved');
    it('should save approval notes');
    it('should set approved_by and approved_at timestamps');
    it('should create approval history record');
    it('should send notification to PO creator');
    it('should throw error if user lacks approval permission');
    it('should throw error if PO not in pending_approval status');
  });

  describe('rejectPO', () => {
    it('should reject PO and update status to rejected');
    it('should require rejection reason');
    it('should save rejection reason in approval_notes');
    it('should create approval history record');
    it('should send notification to PO creator');
    it('should throw error if rejection reason missing');
    it('should throw error if user lacks approval permission');
    it('should throw error if PO not in pending_approval status');
  });

  describe('validateStatusTransition', () => {
    it('should allow draft → pending_approval when approval enabled');
    it('should allow draft → submitted when approval disabled');
    it('should allow pending_approval → approved');
    it('should allow pending_approval → rejected');
    it('should allow rejected → draft');
    it('should allow approved → confirmed');
    it('should block invalid transitions with descriptive error');
    it('should validate threshold logic correctly');
  });

  describe('canUserApprove', () => {
    it('should return true if user role in approval_roles');
    it('should return false if user role not in approval_roles');
    it('should handle multiple roles correctly');
    it('should respect org_id isolation');
  });
});

describe('Notification Service', () => {
  describe('notifyApprovers', () => {
    it('should send email to all users with approval roles');
    it('should include PO details and CTA links in email');
    it('should queue emails asynchronously');
    it('should log notification activity');
    it('should handle SendGrid failures gracefully');
  });

  describe('notifyPOCreator', () => {
    it('should send approval notification to creator');
    it('should send rejection notification to creator');
    it('should include approver name and notes in email');
    it('should include next steps CTA');
  });
});
```

### Integration Tests

```typescript
// purchase-orders.api.test.ts

describe('POST /api/planning/purchase-orders/:id/submit', () => {
  it('should submit PO below threshold directly');
  it('should submit PO above threshold to pending_approval');
  it('should return 400 if PO not in draft status');
  it('should return 400 if PO has no lines');
  it('should return 403 if user lacks permission');
  it('should queue approval notifications');
});

describe('POST /api/planning/purchase-orders/:id/approve', () => {
  it('should approve PO successfully with notes');
  it('should return 403 if user lacks approval permission');
  it('should return 400 if PO not in pending_approval status');
  it('should return 404 if PO not found');
});

describe('POST /api/planning/purchase-orders/:id/reject', () => {
  it('should reject PO successfully with reason');
  it('should return 400 if rejection reason missing');
  it('should return 403 if user lacks approval permission');
  it('should return 400 if PO not in pending_approval status');
});

describe('GET /api/planning/purchase-orders/:id/approval-history', () => {
  it('should return approval history sorted by timestamp desc');
  it('should return empty array if no history');
  it('should enforce org_id RLS isolation');
});
```

### E2E Tests (Playwright)

```typescript
// po-approval-workflow.e2e.test.ts

test('Full approval workflow: submit → approve → confirm', async ({ page }) => {
  // 1. Create PO as planner (total > threshold)
  // 2. Submit PO for approval
  // 3. Verify status changed to pending_approval
  // 4. Log in as manager
  // 5. Open approval modal
  // 6. Approve PO with notes
  // 7. Verify status changed to approved
  // 8. Log back in as planner
  // 9. Verify approval notification received
  // 10. Confirm PO
  // 11. Verify status changed to confirmed
});

test('Rejection workflow: submit → reject → edit → resubmit', async ({ page }) => {
  // 1. Create and submit PO as planner
  // 2. Log in as manager
  // 3. Reject PO with reason
  // 4. Log back in as planner
  // 5. Verify rejection notification
  // 6. Edit PO (status auto-returned to draft)
  // 7. Resubmit for approval
  // 8. Verify new approval request sent
});

test('Below threshold: submit without approval', async ({ page }) => {
  // 1. Create PO with total < threshold
  // 2. Submit PO
  // 3. Verify status changed to submitted (not pending_approval)
  // 4. Verify no approval notifications sent
});

test('Permission denied: non-approver cannot approve', async ({ page }) => {
  // 1. PO in pending_approval status
  // 2. Log in as planner (not approver)
  // 3. Attempt to approve
  // 4. Verify error message displays
  // 5. Verify PO status unchanged
});

test('Approval history displays correctly', async ({ page }) => {
  // 1. PO with multiple approval actions
  // 2. Open PO detail page
  // 3. Verify approval history timeline displays
  // 4. Verify entries sorted correctly
  // 5. Verify user names, roles, and timestamps display
});
```

---

## Performance Targets

| Metric | Target | Measurement |
|--------|--------|-------------|
| Submit PO API response time | <300ms (P95) | Load testing with 50 concurrent requests |
| Approve PO API response time | <500ms (P95) | Load testing with 20 concurrent requests |
| Approval history load time | <200ms | Page load with 20 history entries |
| Email notification queuing | <100ms | Time to queue email (not send) |
| State machine validation | <10ms | Unit test execution time |
| Permission check | <50ms | Database query with RLS |

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-12-16 | Initial story creation | ARCHITECT-AGENT |
