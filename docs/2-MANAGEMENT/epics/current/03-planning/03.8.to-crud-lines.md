# 03.8 - Transfer Orders CRUD + Lines

**Priority**: P0 (MVP)
**Story Points**: M (Medium - 3-4 days)
**Type:** backend + frontend

**State:** ready
**Primary PRD:** `docs/1-BASELINE/product/modules/planning.md` (FR-PLAN-012, FR-PLAN-013, FR-PLAN-014)
**Architecture:** `docs/1-BASELINE/architecture/modules/planning.md`
**UX Wireframes:** PLA-008 (TO List), PLA-009 (TO Form), PLA-010 (TO Detail)

---

## MVP Scope

This story implements the core Transfer Order (TO) functionality for managing internal inventory movements between warehouses. Includes TO headers, line management, and status lifecycle. **Excludes** partial shipments (03.9a) and LP pre-selection (03.9b) which are Phase 1+ features.

**In MVP:**
- TO CRUD operations (create, read, update, delete)
- TO line item management (add, edit, remove lines)
- Master-detail pattern (header + lines in transaction)
- TO status lifecycle (draft → planned → shipped → received → closed)
- Warehouse validation (from ≠ to)
- Basic TO list with search/filter
- TO detail page with lines table

**Not in MVP (deferred to Phase 1):**
- Partial shipments (03.9a)
- LP pre-selection (03.9b)
- Shipping execution integration with warehouse (Epic 05)
- Receiving execution integration with warehouse (Epic 05)

---

## Goal

Enable warehouse managers and planners to plan and track internal inventory transfers between warehouses with full traceability and status lifecycle management.

## User Story

As a **Warehouse Manager or Planner**, I want to **create transfer orders with line items to move inventory between warehouses** so that **I can track planned and actual inventory movements across locations and ensure materials are available where needed**.

## Scope

**In scope (this story)**
- TO header CRUD (number, from/to warehouse, dates, priority, status)
- TO line management (product, quantity, UOM, shipped/received qty)
- Warehouse dropdown populated from Epic 01.8
- Product dropdown populated from Epic 02.1
- Status lifecycle enforcement (draft → planned → shipped → received → closed)
- Business rule: from_warehouse_id ≠ to_warehouse_id
- Multi-tenancy (org_id RLS on all queries)
- Permission enforcement (ADMIN, WH_MANAGER can create/edit)
- TO number auto-generation (TO-YYYY-NNNNN)
- Calculated fields (shipped/received status by line)
- TO list page with DataTable (search, filter, sort, pagination)
- TO detail page (header + lines in tabs or sections)
- Create/Edit modal (header fields only, lines managed in detail page)

**Out of scope (this story)**
- Partial shipments (shipped_qty < quantity) - Deferred to 03.9a
- LP pre-selection for transfer - Deferred to 03.9b (requires Epic 05)
- Ship TO action (warehouse picking) - Epic 05
- Receive TO action (warehouse receiving) - Epic 05
- TO approval workflow - Not in roadmap (simpler than PO)
- Bulk TO creation - Not in roadmap
- TO templates - Not in roadmap

## Dependencies

- **01.1** - Org Context + Base RLS (HARD)
- **01.8** - Warehouses CRUD (HARD) - Required for from/to warehouse dropdowns
- **02.1** - Products CRUD (HARD) - Required for TO lines
- **03.16** - Planning Settings (SOFT) - Optional settings for TO number format

**Note:** Epic 05 (Warehouse Module) will consume TOs for shipping/receiving execution.

## Acceptance Criteria (Given/When/Then)

### AC-1: TO List Page (FR-PLAN-012)

**Given** planner navigates to `/planning/transfer-orders`
**When** page loads
**Then** TO list displays within 300ms
**And** table shows columns: TO Number, From Warehouse, To Warehouse, Planned Ship Date, Status, Priority, Created Date
**And** search box filters by TO number
**And** filter dropdowns for: Status, From Warehouse, To Warehouse, Priority
**And** sort works on all columns
**And** pagination shows 20 TOs per page

### AC-2: Create TO Header (FR-PLAN-012)

**Given** planner clicks "+ New Transfer Order"
**When** modal opens
**Then** form displays fields:
  - From Warehouse (dropdown, required)
  - To Warehouse (dropdown, required)
  - Planned Ship Date (date picker, required)
  - Planned Receive Date (date picker, required, must be >= ship date)
  - Priority (dropdown: Normal, Low, High, Urgent, default Normal)
  - Notes (textarea, optional)

**And** TO number is auto-generated on save (TO-YYYY-NNNNN format)
**And** status defaults to 'draft'
**And** on save, redirects to TO detail page `/planning/transfer-orders/:id`

### AC-3: Warehouse Validation (FR-PLAN-012)

**Given** user selects same warehouse in From and To fields
**When** save attempted
**Then** error displays: "From Warehouse and To Warehouse must be different"
**And** form submission blocked

### AC-4: Planned Receive Date Validation (FR-PLAN-012)

**Given** user selects Planned Receive Date earlier than Planned Ship Date
**When** save attempted
**Then** error displays: "Planned Receive Date must be on or after Planned Ship Date"
**And** form submission blocked

### AC-5: Add TO Lines (FR-PLAN-013)

**Given** TO detail page open with status = 'draft' or 'planned'
**When** planner clicks "+ Add Line"
**Then** inline row appears with:
  - Line Number (auto-incremented, readonly)
  - Product (dropdown with search, required)
  - Quantity (decimal input, required, min 0.01)
  - UOM (auto-filled from product, readonly)
  - Notes (text input, optional)

**And** on save, line added to TO
**And** line appears in lines table immediately

### AC-6: Edit TO Line (FR-PLAN-013)

**Given** TO line exists with shipped_qty = 0
**When** planner clicks "Edit" on line
**Then** inline edit mode activates
**And** can modify: Quantity, Notes
**And** cannot modify: Product, UOM, Line Number
**And** on save, changes persist and table refreshes

### AC-7: Delete TO Line (FR-PLAN-013)

**Given** TO line exists with shipped_qty = 0
**When** planner clicks "Delete" on line
**Then** confirmation dialog displays: "Delete line X - [Product Name]?"
**And** on confirm, line removed
**And** subsequent lines renumbered (line_number adjusted)

**Given** TO line has shipped_qty > 0
**When** planner attempts to delete
**Then** error displays: "Cannot delete line that has been partially or fully shipped"
**And** delete action disabled or hidden

### AC-8: Duplicate Product Prevention (FR-PLAN-013)

**Given** TO already has line with Product A
**When** planner adds another line with Product A
**Then** error displays: "Product already exists on this TO. Update the existing line instead."
**And** line save blocked

### AC-9: TO Status Lifecycle - Draft to Planned (FR-PLAN-014)

**Given** TO with status = 'draft' and lines.length > 0
**When** planner clicks "Release TO" button
**Then** confirmation dialog displays: "Release TO-YYYY-NNNNN for shipping?"
**And** on confirm, status changes to 'planned'
**And** toast displays: "Transfer Order released successfully"
**And** status badge updates to "Planned"

**Given** TO with status = 'draft' and lines.length = 0
**When** planner clicks "Release TO"
**Then** error displays: "Cannot release TO with no lines. Add at least one line."
**And** status remains 'draft'

### AC-10: TO Status Lifecycle - Planned to Shipped (FR-PLAN-014)

**Given** TO with status = 'planned'
**When** warehouse staff clicks "Mark as Shipped" (future Epic 05 integration)
**Then** status changes to 'shipped'
**And** actual_ship_date set to current date
**And** shipped_by set to current user
**And** all line shipped_qty = quantity (full shipment in MVP)

**Note:** Full implementation in Epic 05. MVP provides status transition API endpoint for future use.

### AC-11: TO Status Lifecycle - Shipped to Received (FR-PLAN-014)

**Given** TO with status = 'shipped'
**When** warehouse staff clicks "Mark as Received" (future Epic 05 integration)
**Then** status changes to 'received'
**And** actual_receive_date set to current date
**And** received_by set to current user
**And** all line received_qty = quantity (full receipt in MVP)

**Note:** Full implementation in Epic 05. MVP provides status transition API endpoint for future use.

### AC-12: TO Status Lifecycle - Received to Closed (FR-PLAN-014)

**Given** TO with status = 'received'
**When** system checks all lines fully received (received_qty = quantity)
**Then** status auto-changes to 'closed'
**And** TO becomes read-only (no further edits allowed)

### AC-13: Cancel TO (FR-PLAN-012)

**Given** TO with status = 'draft' or 'planned'
**When** planner clicks "Cancel TO"
**Then** confirmation dialog displays: "Cancel TO-YYYY-NNNNN? This cannot be undone."
**And** on confirm, status changes to 'cancelled'
**And** TO becomes read-only

**Given** TO with status = 'shipped' or 'received'
**When** planner attempts to cancel
**Then** error displays: "Cannot cancel TO that has been shipped or received"
**And** cancel action disabled or hidden

### AC-14: Edit TO Header (FR-PLAN-012)

**Given** TO with status = 'draft' or 'planned'
**When** planner edits TO header (warehouses, dates, priority, notes)
**And** saves changes
**Then** changes persist
**And** updated_at timestamp updated
**And** updated_by set to current user

**Given** TO with status = 'shipped', 'received', or 'closed'
**When** planner attempts to edit header
**Then** form fields disabled with tooltip: "Cannot edit TO after shipment"

### AC-15: Permission Enforcement

**Given** user has ADMIN or WH_MANAGER role
**When** accessing /planning/transfer-orders
**Then** can create, edit, delete, release TOs

**Given** user has PROD_MANAGER or VIEWER role
**When** accessing /planning/transfer-orders
**Then** can view TO list and detail
**And** "New Transfer Order" button hidden
**And** edit/delete/release actions hidden

### AC-16: Multi-tenancy (RLS)

**Given** User A from Org A
**When** requesting /api/planning/transfer-orders
**Then** only Org A TOs returned

**Given** User A from Org A
**When** requesting TO ID from Org B
**Then** 404 Not Found returned (not 403 to avoid leaking existence)

### AC-X: Future Features (Phase 1+)

Features deferred to Phase 1+:
- **Partial Shipments (03.9a)** - Ship lines in multiple shipments, track shipped_qty < quantity
- **LP Pre-Selection (03.9b)** - Assign specific LPs to TO lines before shipping
- **Ship TO Action (Epic 05)** - Warehouse picking workflow with LP selection
- **Receive TO Action (Epic 05)** - Warehouse receiving workflow with LP receiving

**Implementation**: Per Epic 03.0 guidance, show "Coming Soon" badges or hide features in UI.

---

## Implementation Notes

### API Endpoints

```typescript
// Transfer Orders
GET    /api/planning/transfer-orders              // List TOs (paginated, filtered)
POST   /api/planning/transfer-orders              // Create TO + lines (transaction)
GET    /api/planning/transfer-orders/:id          // Get TO with lines
PUT    /api/planning/transfer-orders/:id          // Update TO header
DELETE /api/planning/transfer-orders/:id          // Cancel TO (soft delete via status)

// TO Lines
POST   /api/planning/transfer-orders/:id/lines    // Add line
PUT    /api/planning/transfer-orders/:id/lines/:lineId  // Update line
DELETE /api/planning/transfer-orders/:id/lines/:lineId  // Delete line

// TO Actions
POST   /api/planning/transfer-orders/:id/release  // Draft → Planned
POST   /api/planning/transfer-orders/:id/ship     // Planned → Shipped (Epic 05)
POST   /api/planning/transfer-orders/:id/receive  // Shipped → Received (Epic 05)
POST   /api/planning/transfer-orders/:id/cancel   // Cancel TO

// Validation
GET    /api/planning/transfer-orders/validate-warehouses  // Check from ≠ to
```

**Query Parameters (List):**
- `search` - Filter by TO number (min 2 chars)
- `status` - Filter by status (draft, planned, shipped, received, closed, cancelled)
- `from_warehouse_id` - Filter by source warehouse
- `to_warehouse_id` - Filter by destination warehouse
- `priority` - Filter by priority (low, normal, high, urgent)
- `sort` - Sort field (to_number, planned_ship_date, status, created_at)
- `order` - Sort order (asc, desc)
- `page` - Page number (default 1)
- `limit` - Items per page (default 20, max 100)

### Database

```sql
-- Transfer Orders Header (from planning.md architecture)
CREATE TABLE transfer_orders (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  to_number TEXT NOT NULL,                          -- Auto: TO-YYYY-NNNNN
  from_warehouse_id UUID NOT NULL REFERENCES warehouses(id),
  to_warehouse_id UUID NOT NULL REFERENCES warehouses(id),
  planned_ship_date DATE NOT NULL,
  planned_receive_date DATE NOT NULL,
  actual_ship_date DATE,
  actual_receive_date DATE,
  status TEXT DEFAULT 'draft' NOT NULL,             -- draft, planned, shipped, received, closed, cancelled
  priority TEXT DEFAULT 'normal',                   -- low, normal, high, urgent
  notes TEXT,
  shipped_by UUID REFERENCES users(id),
  received_by UUID REFERENCES users(id),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  created_by UUID REFERENCES users(id),
  updated_by UUID REFERENCES users(id),

  CONSTRAINT transfer_orders_org_number_unique UNIQUE(org_id, to_number),
  CONSTRAINT transfer_orders_warehouses_different CHECK (from_warehouse_id != to_warehouse_id),
  CONSTRAINT transfer_orders_dates_valid CHECK (planned_receive_date >= planned_ship_date),
  CONSTRAINT transfer_orders_status_check CHECK (status IN ('draft', 'planned', 'shipped', 'received', 'closed', 'cancelled')),
  CONSTRAINT transfer_orders_priority_check CHECK (priority IN ('low', 'normal', 'high', 'urgent'))
);

-- Transfer Order Lines
CREATE TABLE transfer_order_lines (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  to_id UUID NOT NULL REFERENCES transfer_orders(id) ON DELETE CASCADE,
  line_number INTEGER NOT NULL,
  product_id UUID NOT NULL REFERENCES products(id),
  quantity DECIMAL(15,4) NOT NULL CHECK (quantity > 0),
  uom TEXT NOT NULL,
  shipped_qty DECIMAL(15,4) DEFAULT 0 CHECK (shipped_qty >= 0 AND shipped_qty <= quantity),
  received_qty DECIMAL(15,4) DEFAULT 0 CHECK (received_qty >= 0 AND received_qty <= quantity),
  notes TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),

  CONSTRAINT transfer_order_lines_to_line_unique UNIQUE(to_id, line_number),
  CONSTRAINT transfer_order_lines_to_product_unique UNIQUE(to_id, product_id)  -- No duplicate products
);

-- Indexes
CREATE INDEX idx_transfer_orders_org_id ON transfer_orders(org_id);
CREATE INDEX idx_transfer_orders_org_status ON transfer_orders(org_id, status);
CREATE INDEX idx_transfer_orders_from_warehouse ON transfer_orders(from_warehouse_id);
CREATE INDEX idx_transfer_orders_to_warehouse ON transfer_orders(to_warehouse_id);
CREATE INDEX idx_transfer_orders_ship_date ON transfer_orders(planned_ship_date);
CREATE INDEX idx_transfer_orders_created_at ON transfer_orders(org_id, created_at DESC);
CREATE INDEX idx_transfer_order_lines_to_id ON transfer_order_lines(to_id);
CREATE INDEX idx_transfer_order_lines_product_id ON transfer_order_lines(product_id);

-- Trigger: Auto-increment TO number
CREATE OR REPLACE FUNCTION generate_to_number()
RETURNS TRIGGER AS $$
DECLARE
  next_num INTEGER;
  year_prefix TEXT;
BEGIN
  year_prefix := TO_CHAR(CURRENT_DATE, 'YYYY');

  SELECT COALESCE(MAX(
    CAST(SUBSTRING(to_number FROM 'TO-' || year_prefix || '-(.*)') AS INTEGER)
  ), 0) + 1
  INTO next_num
  FROM transfer_orders
  WHERE org_id = NEW.org_id
    AND to_number LIKE 'TO-' || year_prefix || '-%';

  NEW.to_number := 'TO-' || year_prefix || '-' || LPAD(next_num::TEXT, 5, '0');
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER tr_transfer_orders_auto_number
BEFORE INSERT ON transfer_orders
FOR EACH ROW
WHEN (NEW.to_number IS NULL)
EXECUTE FUNCTION generate_to_number();

-- Trigger: Update updated_at on TO header
CREATE TRIGGER tr_transfer_orders_updated_at
BEFORE UPDATE ON transfer_orders
FOR EACH ROW
EXECUTE FUNCTION update_updated_at_column();

-- Trigger: Update updated_at on TO lines
CREATE TRIGGER tr_transfer_order_lines_updated_at
BEFORE UPDATE ON transfer_order_lines
FOR EACH ROW
EXECUTE FUNCTION update_updated_at_column();
```

### RLS Policies

```sql
-- Enable RLS
ALTER TABLE transfer_orders ENABLE ROW LEVEL SECURITY;
ALTER TABLE transfer_order_lines ENABLE ROW LEVEL SECURITY;

-- Transfer Orders Policies
CREATE POLICY "transfer_orders_select" ON transfer_orders
FOR SELECT TO authenticated
USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

CREATE POLICY "transfer_orders_insert" ON transfer_orders
FOR INSERT TO authenticated
WITH CHECK (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  AND (
    (SELECT r.code FROM roles r JOIN users u ON u.role_id = r.id WHERE u.id = auth.uid())
    IN ('SUPER_ADMIN', 'ADMIN', 'WH_MANAGER')
  )
);

CREATE POLICY "transfer_orders_update" ON transfer_orders
FOR UPDATE TO authenticated
USING (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  AND (
    (SELECT r.code FROM roles r JOIN users u ON u.role_id = r.id WHERE u.id = auth.uid())
    IN ('SUPER_ADMIN', 'ADMIN', 'WH_MANAGER')
  )
);

CREATE POLICY "transfer_orders_delete" ON transfer_orders
FOR DELETE TO authenticated
USING (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  AND (
    (SELECT r.code FROM roles r JOIN users u ON u.role_id = r.id WHERE u.id = auth.uid())
    IN ('SUPER_ADMIN', 'ADMIN')
  )
);

-- Transfer Order Lines Policies (inherit from parent TO via JOIN)
CREATE POLICY "transfer_order_lines_select" ON transfer_order_lines
FOR SELECT TO authenticated
USING (
  EXISTS (
    SELECT 1 FROM transfer_orders
    WHERE id = transfer_order_lines.to_id
      AND org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  )
);

CREATE POLICY "transfer_order_lines_insert" ON transfer_order_lines
FOR INSERT TO authenticated
WITH CHECK (
  EXISTS (
    SELECT 1 FROM transfer_orders
    WHERE id = transfer_order_lines.to_id
      AND org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  )
  AND (
    (SELECT r.code FROM roles r JOIN users u ON u.role_id = r.id WHERE u.id = auth.uid())
    IN ('SUPER_ADMIN', 'ADMIN', 'WH_MANAGER')
  )
);

CREATE POLICY "transfer_order_lines_update" ON transfer_order_lines
FOR UPDATE TO authenticated
USING (
  EXISTS (
    SELECT 1 FROM transfer_orders
    WHERE id = transfer_order_lines.to_id
      AND org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  )
  AND (
    (SELECT r.code FROM roles r JOIN users u ON u.role_id = r.id WHERE u.id = auth.uid())
    IN ('SUPER_ADMIN', 'ADMIN', 'WH_MANAGER')
  )
);

CREATE POLICY "transfer_order_lines_delete" ON transfer_order_lines
FOR DELETE TO authenticated
USING (
  EXISTS (
    SELECT 1 FROM transfer_orders
    WHERE id = transfer_order_lines.to_id
      AND org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  )
  AND (
    (SELECT r.code FROM roles r JOIN users u ON u.role_id = r.id WHERE u.id = auth.uid())
    IN ('SUPER_ADMIN', 'ADMIN', 'WH_MANAGER')
  )
);
```

### Frontend Components

```
app/(authenticated)/planning/transfer-orders/
  page.tsx                              -- TO list page (DataTable)
  [id]/
    page.tsx                            -- TO detail page (header + lines)

components/planning/transfer-orders/
  TransferOrdersDataTable.tsx           -- Table with sorting, filtering, pagination
  TransferOrderModal.tsx                -- Create/Edit TO header modal (PLA-009)
  TransferOrderRow.tsx                  -- Single TO row with status badge
  TransferOrderDetail.tsx               -- TO detail layout (header + lines tabs)
  TransferOrderHeader.tsx               -- TO header summary card
  TransferOrderLinesTable.tsx           -- Editable lines table
  TransferOrderLineRow.tsx              -- Single line row with inline edit
  AddLineModal.tsx                      -- Add line to TO
  TransferOrderStatusBadge.tsx          -- Status badge with color coding
  TransferOrderPriorityBadge.tsx        -- Priority badge
  TransferOrderActions.tsx              -- Actions dropdown (release, cancel, ship, receive)
  ReleaseConfirmDialog.tsx              -- Confirm release to planned
  CancelConfirmDialog.tsx               -- Confirm cancellation
  WarehouseSelect.tsx                   -- Warehouse dropdown (from Epic 01.8)
  ProductSelect.tsx                     -- Product dropdown with search (from Epic 02.1)
```

### Services

```typescript
// lib/services/transfer-order-service.ts
export interface TransferOrderService {
  list(params: TOListParams): Promise<PaginatedResult<TransferOrder>>;
  getById(id: string): Promise<TransferOrderWithLines | null>;
  create(data: CreateTOInput): Promise<TransferOrder>;
  update(id: string, data: UpdateTOInput): Promise<TransferOrder>;
  cancel(id: string): Promise<TransferOrder>;

  // Lines
  addLine(toId: string, line: CreateTOLineInput): Promise<TransferOrderLine>;
  updateLine(toId: string, lineId: string, data: UpdateTOLineInput): Promise<TransferOrderLine>;
  deleteLine(toId: string, lineId: string): Promise<void>;

  // Actions
  release(id: string): Promise<TransferOrder>;  // draft → planned
  ship(id: string): Promise<TransferOrder>;     // planned → shipped (Epic 05)
  receive(id: string): Promise<TransferOrder>;  // shipped → received (Epic 05)

  // Validation
  validateWarehouses(fromId: string, toId: string): Promise<{ valid: boolean; error?: string }>;
  canEditTO(id: string): Promise<{ allowed: boolean; reason?: string }>;
  canDeleteLine(lineId: string): Promise<{ allowed: boolean; reason?: string }>;
}

// Type definitions
export type TOStatus = 'draft' | 'planned' | 'shipped' | 'received' | 'closed' | 'cancelled';
export type TOPriority = 'low' | 'normal' | 'high' | 'urgent';

export interface TransferOrder {
  id: string;
  org_id: string;
  to_number: string;
  from_warehouse_id: string;
  to_warehouse_id: string;
  planned_ship_date: string;
  planned_receive_date: string;
  actual_ship_date: string | null;
  actual_receive_date: string | null;
  status: TOStatus;
  priority: TOPriority;
  notes: string | null;
  shipped_by: string | null;
  received_by: string | null;
  created_at: string;
  updated_at: string;
  created_by: string;
  updated_by: string | null;
}

export interface TransferOrderLine {
  id: string;
  to_id: string;
  line_number: number;
  product_id: string;
  quantity: number;
  uom: string;
  shipped_qty: number;
  received_qty: number;
  notes: string | null;
  created_at: string;
  updated_at: string;
}

export interface TransferOrderWithLines extends TransferOrder {
  lines: TransferOrderLine[];
  from_warehouse: Warehouse;  // Joined from warehouses table
  to_warehouse: Warehouse;
  created_by_user: User;
}
```

### Validation (Zod)

```typescript
// lib/validation/transfer-order.ts
import { z } from 'zod';

export const toStatusEnum = z.enum(['draft', 'planned', 'shipped', 'received', 'closed', 'cancelled']);
export const toPriorityEnum = z.enum(['low', 'normal', 'high', 'urgent']);

export const createTransferOrderSchema = z.object({
  from_warehouse_id: z.string().uuid("Invalid warehouse ID"),
  to_warehouse_id: z.string().uuid("Invalid warehouse ID"),
  planned_ship_date: z.string().refine(
    (val) => !isNaN(Date.parse(val)),
    "Invalid date format"
  ),
  planned_receive_date: z.string().refine(
    (val) => !isNaN(Date.parse(val)),
    "Invalid date format"
  ),
  priority: toPriorityEnum.default('normal'),
  notes: z.string().max(1000, "Notes must be at most 1000 characters").nullable().optional(),
}).refine(
  (data) => data.from_warehouse_id !== data.to_warehouse_id,
  {
    message: "From Warehouse and To Warehouse must be different",
    path: ["to_warehouse_id"]
  }
).refine(
  (data) => new Date(data.planned_receive_date) >= new Date(data.planned_ship_date),
  {
    message: "Planned Receive Date must be on or after Planned Ship Date",
    path: ["planned_receive_date"]
  }
);

export const updateTransferOrderSchema = createTransferOrderSchema.partial();

export const createTOLineSchema = z.object({
  product_id: z.string().uuid("Invalid product ID"),
  quantity: z.number().positive("Quantity must be greater than 0"),
  notes: z.string().max(500, "Notes must be at most 500 characters").nullable().optional(),
});

export const updateTOLineSchema = z.object({
  quantity: z.number().positive("Quantity must be greater than 0").optional(),
  notes: z.string().max(500, "Notes must be at most 500 characters").nullable().optional(),
});

export type CreateTOInput = z.infer<typeof createTransferOrderSchema>;
export type UpdateTOInput = z.infer<typeof updateTransferOrderSchema>;
export type CreateTOLineInput = z.infer<typeof createTOLineSchema>;
export type UpdateTOLineInput = z.infer<typeof updateTOLineSchema>;
```

### Key Business Rules

1. **Warehouse Validation**: `from_warehouse_id ≠ to_warehouse_id` (enforced in DB constraint + Zod)
2. **Date Validation**: `planned_receive_date >= planned_ship_date` (enforced in DB constraint + Zod)
3. **Status Transitions**:
   - Draft → Planned (requires lines.length > 0)
   - Planned → Shipped (Epic 05 integration)
   - Shipped → Received (Epic 05 integration)
   - Received → Closed (auto when all lines received)
   - Draft/Planned → Cancelled (user action)
4. **Edit Restrictions**:
   - Header editable only in Draft/Planned status
   - Lines editable only if shipped_qty = 0
   - Lines deletable only if shipped_qty = 0
5. **Duplicate Product Prevention**: Only one line per product per TO (DB constraint)
6. **Line Renumbering**: When line deleted, subsequent lines renumbered (line_number updated)
7. **Multi-tenancy**: All queries filtered by org_id via RLS
8. **Permission Matrix**:
   - ADMIN, WH_MANAGER: Full CRUD
   - PROD_MANAGER, VIEWER: Read-only

---

## Deliverables

- **Migration**: `supabase/migrations/XXX_create_transfer_orders.sql`
  - transfer_orders table with constraints
  - transfer_order_lines table with constraints
  - Indexes for performance
  - RLS policies for multi-tenancy
  - Triggers for auto-numbering and timestamps

- **API Routes**:
  - `app/api/planning/transfer-orders/route.ts` (GET list, POST create)
  - `app/api/planning/transfer-orders/[id]/route.ts` (GET detail, PUT update, DELETE cancel)
  - `app/api/planning/transfer-orders/[id]/lines/route.ts` (POST add line)
  - `app/api/planning/transfer-orders/[id]/lines/[lineId]/route.ts` (PUT update, DELETE delete)
  - `app/api/planning/transfer-orders/[id]/release/route.ts` (POST release)
  - `app/api/planning/transfer-orders/[id]/ship/route.ts` (POST ship - Epic 05)
  - `app/api/planning/transfer-orders/[id]/receive/route.ts` (POST receive - Epic 05)
  - `app/api/planning/transfer-orders/[id]/cancel/route.ts` (POST cancel)

- **Services**:
  - `lib/services/transfer-order-service.ts` (business logic layer)

- **Validation**:
  - `lib/validation/transfer-order.ts` (Zod schemas)

- **Components**:
  - TO List page (DataTable with search, filter, sort, pagination)
  - TO Detail page (header summary + lines table)
  - Create/Edit TO modal (header fields)
  - Add/Edit line inline form
  - Status badges, priority badges
  - Action dialogs (release, cancel)

- **Tests**:
  - Unit tests for transfer-order-service.ts (>=80% coverage)
  - Integration tests for all API endpoints
  - E2E tests for critical flows (create TO, add lines, release, cancel)

---

## Definition of Done

- [ ] Database migration creates transfer_orders and transfer_order_lines tables
- [ ] All DB constraints enforced (warehouses_different, dates_valid, no duplicate products)
- [ ] RLS policies enforce org isolation and role permissions
- [ ] TO number auto-generation trigger works (TO-YYYY-NNNNN format)
- [ ] All 8+ API endpoints implemented and documented
- [ ] Zod schemas validate all inputs (warehouses, dates, quantity)
- [ ] transfer-order-service.ts implements all methods
- [ ] TO list page renders with DataTable (search, filter, sort, pagination)
- [ ] Create/Edit modal with warehouse dropdowns (from Epic 01.8)
- [ ] TO detail page shows header + lines table
- [ ] Add/Edit/Delete line functionality works with inline editing
- [ ] Line renumbering on delete works correctly
- [ ] Duplicate product prevention enforced
- [ ] Status lifecycle (draft → planned → cancelled) works
- [ ] Release TO validates lines.length > 0
- [ ] Cancel TO validates status in (draft, planned)
- [ ] Edit restrictions by status enforced
- [ ] Permission matrix implemented (admin, wh_manager, viewer)
- [ ] Multi-tenancy: cross-org returns 404
- [ ] Unit tests >= 80% coverage
- [ ] Integration tests for all endpoints (CRUD, actions, validations)
- [ ] E2E tests for create → add lines → release → cancel flow
- [ ] Loading, empty, error states implemented
- [ ] Toast notifications on success/error
- [ ] Accessibility: keyboard nav, ARIA labels, screen reader support
- [ ] Performance: List loads in <300ms with 100 TOs
- [ ] Performance: Detail page loads in <200ms

---

## Future Phases (Not in MVP)

### Phase 1 (03.9a, 03.9b)

- **Partial Shipments (03.9a)**: Ship TO lines in multiple shipments
  - Track shipped_qty < quantity per line
  - Multiple ship actions with partial quantities
  - Status: partially_shipped, partially_received
  - Ship history table (to_shipments)

- **LP Pre-Selection (03.9b)**: Assign specific LPs to TO lines before shipping
  - to_line_lps junction table
  - LP picker component
  - Validation: LP must be in from_warehouse
  - Validation: LP quantity available

### Phase 2

- **Ship TO Action (Epic 05)**: Full warehouse picking workflow
  - Pick suggestions (FIFO/FEFO)
  - LP scanning and selection
  - Create outbound shipment documents
  - Update inventory on ship

- **Receive TO Action (Epic 05)**: Full warehouse receiving workflow
  - Create inbound receipt documents
  - LP receiving and location assignment
  - Update inventory on receive
  - Quality hold on receipt (optional)

- **TO Templates**: Reusable TO configurations for recurring transfers
- **Bulk TO Creation**: Create multiple TOs at once
- **TO Gantt View**: Visual timeline of planned/actual ship/receive dates

**Implementation**: See Epic 03.0 "Future Feature Handling" section.

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-12-16 | Initial story creation | ARCHITECT-AGENT |
