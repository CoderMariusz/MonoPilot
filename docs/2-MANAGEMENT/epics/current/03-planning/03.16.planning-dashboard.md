# 03.16 - Planning Dashboard

**Priority**: P1 (Phase 1)
**Story Points**: M (3-4 days)
**Type:** backend + frontend
**Complexity:** M (Medium)

**State:** ready
**Primary PRD:** `docs/1-BASELINE/product/modules/planning.md` (Section 8)
**Architecture:** `docs/1-BASELINE/architecture/modules/planning.md`
**UX Wireframes:** PLA-DASH-001 (if available)

---

## MVP Scope

The Planning Dashboard provides real-time visibility into planning activities across Purchase Orders, Transfer Orders, and Work Orders. This MVP includes:

1. **KPI Cards** - 6 key metrics showing planning health
2. **Alert Panels** - Overdue orders and critical issues
3. **Recent Activity Feed** - Last 20 planning actions
4. **Quick Actions** - Fast creation of PO/TO/WO
5. **Dashboard Service** - Aggregation and caching layer
6. **API Endpoints** - RESTful endpoints for widgets
7. **Tests** - Unit and E2E coverage

**Note:** This story focuses on visibility and navigation. Advanced features like inventory alerts (low stock), material availability checks, and calendar views are deferred to Phase 2.

---

## Goal

Provide planners and operations staff with a single-page view of all planning activities, highlighting urgent issues and enabling quick access to common actions.

## User Story

As a **Planner**, I want **a centralized dashboard showing all planning KPIs, alerts, and recent activity** so that **I can quickly identify problems and take action without navigating through multiple pages**.

## Scope

**In scope (this story)**
- Dashboard page at `/planning` route
- KPI cards: PO pending approval, PO this month, TO in transit, WO scheduled today, WO overdue
- Alert widget: Overdue POs, low inventory warnings (future placeholder), WO material shortages (future placeholder)
- Recent activity feed (last 20 PO/TO/WO actions)
- Quick action buttons: Create PO, Create TO, Create WO
- Service layer for dashboard data aggregation
- API endpoints: `/api/planning/dashboard/kpis`, `/api/planning/dashboard/alerts`, `/api/planning/dashboard/activity`
- Zod validation schemas for dashboard queries
- Caching strategy (Redis, 2-minute TTL)
- Unit tests (service layer, API routes)
- E2E smoke test (dashboard loads, KPIs render)

**Out of scope (this story)**
- Calendar widget (PO deliveries, WO schedule) - Phase 2
- Inventory alerts (below reorder point, expiring stock) - Requires Epic 05 (Warehouse)
- Material availability checks - Requires Story 03.13
- Gantt chart view - Story 03.14 (Phase 2)
- Advanced filtering (date range, supplier, product) - Phase 2
- Export functionality - Phase 2
- Customizable dashboard widgets - Phase 3

## Dependencies

- **01.1** - Organization Context + RLS (for org_id filtering)
- **01.X** - Warehouses (for TO location names)
- **01.X** - Production Lines (for WO line names)
- **02.1** - Products (for product names in activity feed)
- **03.3** - Purchase Orders CRUD (PO data)
- **03.8** - Transfer Orders CRUD (TO data)
- **03.10** - Work Orders CRUD (WO data)

**Note:** Dashboard will gracefully handle missing dependencies by showing zero states or placeholder text.

---

## Acceptance Criteria (Given/When/Then)

### AC-1: Dashboard Page Loads

**Given** I am authenticated as a user with planning permissions
**When** I navigate to `/planning`
**Then** the dashboard page loads within 2 seconds
**And** I see the page header "Planning Dashboard"
**And** I see 6 KPI cards displayed in a grid
**And** I see the alert panel and recent activity feed below KPIs
**And** I see quick action buttons in the header

### AC-2: KPI Cards Display Correctly

**Given** I am on the Planning Dashboard
**When** the page loads
**Then** I see the following KPI cards with correct data:

| KPI Card | Label | Calculation | Icon |
|----------|-------|-------------|------|
| KPI-1 | PO Pending Approval | COUNT(purchase_orders) WHERE approval_status = 'pending' | Clock icon |
| KPI-2 | PO This Month | COUNT(purchase_orders) WHERE created_at >= month_start | ShoppingCart icon |
| KPI-3 | TO In Transit | COUNT(transfer_orders) WHERE status IN ('partially_shipped', 'shipped') | TruckIcon |
| KPI-4 | WO Scheduled Today | COUNT(work_orders) WHERE scheduled_date = TODAY | Calendar icon |
| KPI-5 | WO Overdue | COUNT(work_orders) WHERE scheduled_date < TODAY AND status NOT IN ('completed', 'closed', 'cancelled') | AlertTriangle icon |
| KPI-6 | Open Orders | COUNT(purchase_orders) WHERE status NOT IN ('closed', 'cancelled') | FileText icon |

**And** each KPI card shows:
- Title
- Value (number)
- Icon
- Optional trend indicator (up/down arrow) - Phase 2
- Optional comparison ("vs last month: +5") - Phase 2

### AC-3: KPI Card Click Navigation

**Given** I am on the Planning Dashboard
**When** I click on a KPI card
**Then** I am navigated to the corresponding list page with filters applied:

| KPI Card | Navigation | Applied Filter |
|----------|------------|---------------|
| PO Pending Approval | `/planning/purchase-orders` | `approval_status=pending` |
| PO This Month | `/planning/purchase-orders` | `created_this_month=true` |
| TO In Transit | `/planning/transfer-orders` | `status=in_transit` |
| WO Scheduled Today | `/planning/work-orders` | `scheduled_date=today` |
| WO Overdue | `/planning/work-orders` | `overdue=true` |
| Open Orders | `/planning/purchase-orders` | `status=open` |

### AC-4: Alert Panel Shows Critical Issues

**Given** I am on the Planning Dashboard
**When** the alert panel loads
**Then** I see alerts grouped by type:

**Alert Types (MVP):**
- **Overdue POs** - POs where `expected_delivery_date < TODAY` AND status NOT IN ('closed', 'cancelled')
  - Shows: PO number, supplier name, days overdue, expected date
  - Severity: Warning (orange) if 1-3 days overdue, Critical (red) if 4+ days

- **POs Pending Approval > 2 days** - POs where `approval_status = 'pending'` AND `created_at < TODAY - 2 days`
  - Shows: PO number, supplier name, created date, amount
  - Severity: Warning (orange)

**Alert Types (Future - Placeholders):**
- **Low Inventory** - Products below reorder point (Epic 05 required)
  - Shows: "Coming Soon - Requires Warehouse Module"

- **WO Material Shortages** - WOs with insufficient materials (Story 03.13 required)
  - Shows: "Coming Soon - Material Availability Check"

**And** alerts are sorted by severity (Critical â†’ Warning)
**And** clicking an alert navigates to the related entity (PO detail, WO detail)
**And** if no alerts exist, I see "No alerts - all clear!" message

### AC-5: Recent Activity Feed Shows Last 20 Actions

**Given** I am on the Planning Dashboard
**When** the activity feed loads
**Then** I see the last 20 planning actions sorted by timestamp (newest first)
**And** each activity item shows:
- Entity type icon (PO/TO/WO)
- Entity number (e.g., "PO-2024-00123")
- Action type (created, updated, approved, cancelled, completed)
- User who performed action (or "System")
- Timestamp (relative: "2 hours ago", "Yesterday")

**Activity Types:**
- **PO Created** - `purchase_orders` created
- **PO Approved** - `purchase_orders` approval_status changed to 'approved'
- **PO Cancelled** - `purchase_orders` status changed to 'cancelled'
- **TO Created** - `transfer_orders` created
- **TO Shipped** - `transfer_orders` status changed to 'shipped'
- **WO Created** - `work_orders` created
- **WO Completed** - `work_orders` status changed to 'completed'

**And** clicking an activity item navigates to the entity detail page
**And** if no activity exists, I see "No recent activity" message

### AC-6: Quick Actions Create Entities

**Given** I am on the Planning Dashboard
**When** I click a quick action button
**Then** the corresponding modal or page opens:

| Button | Label | Action |
|--------|-------|--------|
| Quick Action 1 | Create PO | Opens PO creation modal or navigates to `/planning/purchase-orders/new` |
| Quick Action 2 | Create TO | Opens TO creation modal or navigates to `/planning/transfer-orders/new` |
| Quick Action 3 | Create WO | Opens WO creation modal or navigates to `/planning/work-orders/new` |

**And** after entity creation, the dashboard refreshes to show updated KPIs
**And** the new entity appears in the recent activity feed

### AC-7: Dashboard Data Caching

**Given** dashboard data is requested
**When** the API endpoints are called
**Then** responses are cached in Redis with 2-minute TTL
**And** subsequent requests within 2 minutes return cached data
**And** cache keys are namespaced by `org_id`:
- `planning:dashboard:kpis:{org_id}`
- `planning:dashboard:alerts:{org_id}`
- `planning:dashboard:activity:{org_id}`

**And** cache is invalidated when:
- A PO/TO/WO is created, updated, or deleted
- An approval action occurs
- A status change occurs

### AC-8: Dashboard Handles Zero State

**Given** the organization has no POs, TOs, or WOs
**When** I load the Planning Dashboard
**Then** all KPI cards show "0"
**And** alert panel shows "No alerts - all clear!"
**And** activity feed shows "No recent activity"
**And** quick action buttons are still visible and functional
**And** I see a help message: "Get started by creating your first Purchase Order, Transfer Order, or Work Order using the buttons above."

### AC-9: Dashboard Performance

**Given** the organization has 1000+ POs, TOs, and WOs
**When** I load the Planning Dashboard
**Then** the page loads in < 2 seconds
**And** KPI calculations are optimized with COUNT queries (no full table scans)
**And** activity feed uses LIMIT 20 with index on `created_at` DESC
**And** alerts use indexed filters on `status` and `expected_delivery_date`

### AC-10: RLS and Multi-Tenancy

**Given** I am a user in organization A
**When** I load the Planning Dashboard
**Then** I only see data for organization A
**And** all queries filter by `org_id = current_user.org_id`
**And** RLS policies prevent cross-org data leakage
**And** if I switch organizations (via org selector), dashboard updates to new org's data

### AC-11: Future Features (Phase 2+)

Features deferred to Phase 2+:
- **Calendar Widget** - Visual calendar showing PO deliveries and WO schedules
- **Inventory Alerts** - Products below safety stock or reorder point
- **Material Availability** - WOs blocked by missing materials
- **Trend Indicators** - "vs last month: +15%" on KPI cards
- **Date Range Filter** - Custom date range for activity feed
- **Export to Excel** - Export dashboard data
- **Customizable Widgets** - Drag-and-drop dashboard layout

**Implementation**: Per Epic 03.0 guidance, show "Coming Soon" placeholders or hide these features.

---

## Implementation Notes

### API Endpoints

```typescript
// Get dashboard KPIs
GET /api/planning/dashboard/kpis
Query Params: org_id (from session)
Response: {
  po_pending_approval: number
  po_this_month: number
  to_in_transit: number
  wo_scheduled_today: number
  wo_overdue: number
  open_orders: number
}

// Get dashboard alerts
GET /api/planning/dashboard/alerts
Query Params: org_id, limit (default: 10)
Response: {
  alerts: Alert[]
  total: number
}

type Alert = {
  id: string
  type: 'overdue_po' | 'pending_approval' | 'low_inventory' | 'material_shortage'
  severity: 'warning' | 'critical'
  entity_type: 'purchase_order' | 'transfer_order' | 'work_order'
  entity_id: string
  entity_number: string
  description: string
  days_overdue?: number
  created_at: string
}

// Get recent activity
GET /api/planning/dashboard/activity
Query Params: org_id, limit (default: 20)
Response: {
  activities: Activity[]
  total: number
}

type Activity = {
  id: string
  entity_type: 'purchase_order' | 'transfer_order' | 'work_order'
  entity_id: string
  entity_number: string
  action: 'created' | 'updated' | 'approved' | 'cancelled' | 'completed'
  user_id: string
  user_name: string
  timestamp: string
}
```

### Database

Reference tables from architecture doc:

```sql
-- Tables used for dashboard
purchase_orders (id, org_id, po_number, supplier_id, status, approval_status, expected_delivery_date, created_at)
transfer_orders (id, org_id, to_number, status, planned_ship_date, actual_ship_date, created_at)
work_orders (id, org_id, wo_number, product_id, status, scheduled_date, created_at, completed_at)
suppliers (id, name)
products (id, name)
users (id, name)

-- Indexes for performance
CREATE INDEX idx_po_org_status ON purchase_orders(org_id, status);
CREATE INDEX idx_po_org_approval ON purchase_orders(org_id, approval_status);
CREATE INDEX idx_po_org_created ON purchase_orders(org_id, created_at DESC);
CREATE INDEX idx_po_expected_date ON purchase_orders(expected_delivery_date);

CREATE INDEX idx_to_org_status ON transfer_orders(org_id, status);
CREATE INDEX idx_to_org_created ON transfer_orders(org_id, created_at DESC);

CREATE INDEX idx_wo_org_status ON work_orders(org_id, status);
CREATE INDEX idx_wo_org_scheduled ON work_orders(org_id, scheduled_date);
CREATE INDEX idx_wo_org_created ON work_orders(org_id, created_at DESC);
```

### Frontend Components

```
app/(authenticated)/planning/
  page.tsx                              -> Dashboard page (server component)

components/planning/dashboard/
  DashboardKPICards.tsx                 -> KPI grid (6 cards)
  KPICard.tsx                           -> Single KPI card component
  DashboardAlerts.tsx                   -> Alert panel
  AlertItem.tsx                         -> Single alert component
  DashboardActivity.tsx                 -> Activity feed
  ActivityItem.tsx                      -> Single activity item
  DashboardQuickActions.tsx             -> Quick action buttons
  DashboardEmptyState.tsx               -> Zero state UI
```

### Services

```typescript
// lib/services/planning-dashboard-service.ts
export async function getKPIs(orgId: string): Promise<KPIData>
export async function getAlerts(orgId: string, limit?: number): Promise<AlertsResponse>
export async function getRecentActivity(orgId: string, limit?: number): Promise<ActivityResponse>
export async function invalidateDashboardCache(orgId: string): Promise<void>

interface KPIData {
  po_pending_approval: number
  po_this_month: number
  to_in_transit: number
  wo_scheduled_today: number
  wo_overdue: number
  open_orders: number
}

interface AlertsResponse {
  alerts: Alert[]
  total: number
}

interface ActivityResponse {
  activities: Activity[]
  total: number
}
```

### Validation (Zod)

```typescript
// lib/validation/planning-dashboard-schemas.ts
import { z } from 'zod'

export const dashboardKPIQuerySchema = z.object({
  org_id: z.string().uuid()
})

export const dashboardAlertsQuerySchema = z.object({
  org_id: z.string().uuid(),
  limit: z.number().int().min(1).max(50).optional().default(10)
})

export const dashboardActivityQuerySchema = z.object({
  org_id: z.string().uuid(),
  limit: z.number().int().min(1).max(100).optional().default(20)
})

export type DashboardKPIQuery = z.infer<typeof dashboardKPIQuerySchema>
export type DashboardAlertsQuery = z.infer<typeof dashboardAlertsQuerySchema>
export type DashboardActivityQuery = z.infer<typeof dashboardActivityQuerySchema>
```

### Key Business Rules

1. **KPI Calculations** - All KPIs use COUNT queries with indexed filters for performance
2. **Date Filtering** - "Today" uses `CURRENT_DATE` in timezone-aware queries
3. **Alert Severity** - Overdue 1-3 days = Warning, 4+ days = Critical
4. **Activity Limit** - Maximum 20 activities to prevent UI bloat
5. **Cache TTL** - 2-minute cache prevents stale data while reducing DB load
6. **Cache Invalidation** - Triggered on create/update/delete of PO/TO/WO
7. **Zero State** - Always show quick actions even when no data exists
8. **RLS Enforcement** - All queries filtered by `org_id` from session

### Caching Strategy

```typescript
// Cache keys
const CACHE_PREFIX = 'planning:dashboard'
const TTL = 120 // 2 minutes

// Cache key patterns
`${CACHE_PREFIX}:kpis:${orgId}`
`${CACHE_PREFIX}:alerts:${orgId}`
`${CACHE_PREFIX}:activity:${orgId}`

// Invalidation triggers
- On PO create/update/delete
- On TO create/update/delete
- On WO create/update/delete
- On approval action
- On status change
```

---

## Deliverables

### API Routes
- `GET /api/planning/dashboard/kpis` - KPI calculations
- `GET /api/planning/dashboard/alerts` - Alert aggregation
- `GET /api/planning/dashboard/activity` - Recent activity feed

### Components
- `DashboardKPICards.tsx` - KPI grid with 6 cards
- `KPICard.tsx` - Reusable KPI card component
- `DashboardAlerts.tsx` - Alert panel with severity grouping
- `AlertItem.tsx` - Single alert component
- `DashboardActivity.tsx` - Activity feed
- `ActivityItem.tsx` - Single activity item
- `DashboardQuickActions.tsx` - Quick action button bar
- `DashboardEmptyState.tsx` - Zero state UI

### Services
- `planning-dashboard-service.ts` - KPI, alert, activity aggregation
- Cache invalidation helpers

### Validation Schemas
- `planning-dashboard-schemas.ts` - Zod schemas for dashboard queries

### Tests
- **Unit Tests**:
  - `planning-dashboard-service.test.ts` - Service layer tests
  - `dashboard-kpis.test.ts` - KPI calculation tests
  - `dashboard-alerts.test.ts` - Alert aggregation tests
  - `dashboard-activity.test.ts` - Activity feed tests
- **E2E Tests**:
  - `planning-dashboard.spec.ts` - Dashboard loads, KPIs render, alerts show, activity feed works

---

## Definition of Done

- [ ] Dashboard page renders at `/planning` route
- [ ] All 6 KPI cards display correct data
- [ ] KPI cards are clickable and navigate to filtered lists
- [ ] Alert panel shows overdue POs and pending approvals
- [ ] Alert panel shows placeholders for future alerts (low inventory, material shortages)
- [ ] Recent activity feed shows last 20 actions
- [ ] Quick action buttons open PO/TO/WO creation flows
- [ ] Zero state displays when no data exists
- [ ] RLS policies enforce org_id filtering on all queries
- [ ] Dashboard data cached in Redis with 2-minute TTL
- [ ] Cache invalidated on PO/TO/WO create/update/delete
- [ ] API routes have >80% test coverage
- [ ] Service layer has >80% test coverage
- [ ] E2E smoke test passes (dashboard loads within 2 seconds)
- [ ] Performance tested with 1000+ entities (< 2 second load time)
- [ ] Mobile responsive (dashboard stacks vertically on small screens)
- [ ] Error handling for missing dependencies (Epic 01/02 tables)

---

## Future Phases (Not in MVP)

### Phase 1
- **Trend Indicators** - Show "vs last month: +15%" on KPI cards
- **Calendar Widget** - Visual calendar showing PO deliveries, WO schedules
- **Inventory Alerts** - Products below safety stock or reorder point (Epic 05 integration)
- **Material Availability** - WOs blocked by missing materials (Story 03.13 integration)

### Phase 2
- **Date Range Filter** - Custom date range for activity feed and KPIs
- **Export to Excel** - Export dashboard data and reports
- **Advanced Filters** - Filter by supplier, product, status, priority
- **Gantt Chart View** - Integrated WO schedule visualization (Story 03.14)
- **Supplier Performance** - Avg lead time, on-time delivery rate
- **Demand Planning Widgets** - MRP suggestions, forecast accuracy (Epic 03b)

### Phase 3
- **Customizable Dashboard** - Drag-and-drop widget layout
- **Saved Filters** - Save and name custom dashboard views
- **Scheduled Reports** - Email dashboard reports daily/weekly
- **Real-time Updates** - WebSocket/SSE for live dashboard updates
- **Drill-down Analytics** - Click KPIs to see charts and breakdowns

**Implementation**: See Epic 03.0 "Future Feature Handling" section.

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-12-16 | Initial story creation | ARCHITECT-AGENT |
