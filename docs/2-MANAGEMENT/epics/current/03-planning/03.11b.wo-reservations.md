# 03.11b - WO Material Reservations (LP Allocation)

**Priority**: P1 (Phase 1) - AFTER Epic 05
**Story Points**: M (Medium - 3-4 days)
**Type:** backend + frontend

**State:** deferred
**Primary PRD:** `docs/1-BASELINE/product/modules/planning.md` (FR-PLAN-025)
**Architecture:** `docs/1-BASELINE/architecture/modules/planning.md`
**Warehouse Architecture:** `docs/1-BASELINE/architecture/modules/warehouse.md` (lp_reservations)

---

## DEFERRED - Requires Epic 05 (License Plates + Genealogy)

This story is **DEFERRED** until Epic 05 (Warehouse Module) is complete.

**Blocking Dependencies:**
- Epic 05 - `license_plates` table with LP lifecycle management
- Epic 05 - `lp_reservations` table for soft reservation tracking
- Epic 05 - LP status management (available, reserved, consumed, blocked)
- Epic 05 - FIFO/FEFO picking algorithm infrastructure
- Story 03.11a - `wo_materials` table with `reserved_qty` column

**Why Deferred:**
Material reservation requires physical inventory tracking via License Plates (LPs). Without the LP infrastructure from Epic 05, there is nothing to reserve against. This story builds on top of the warehouse module's inventory management capabilities.

---

## MVP Scope

This story implements soft material reservations for Work Orders. When a WO is released for production, the system allocates specific License Plates (LPs) to each material requirement using FIFO/FEFO picking algorithms. Reservations are "soft" - they provide visibility and guidance but don't hard-block other WOs from using the same LPs.

**MVP includes:**
- `wo_material_reservations` table (junction: wo_materials <-> license_plates)
- FIFO/FEFO picking algorithm for LP selection
- Auto-reserve materials on WO release
- Manual reservation adjustment (add/remove LPs)
- LP availability real-time check
- Reserved LPs display per material
- Reservation release on WO cancel
- Over-reservation prevention validation
- API endpoints for reservation management
- Service layer with reservation/release/reallocation logic
- Comprehensive tests for complex scenarios

**Prerequisites (must be complete):**
- Story 03.11a - WO BOM Snapshot (wo_materials table)
- Epic 05 - License Plates + LP Reservations infrastructure

---

## Goal

Implement soft material reservations to allocate specific License Plates to Work Order materials upon WO release, using FIFO/FEFO algorithms, providing visibility into reserved inventory while maintaining flexibility for production.

## User Story

As a **Production Planner**, I want **specific inventory LPs reserved for my Work Order materials** so that **I have visibility into material allocation, picking is streamlined, and production can proceed with confidence that materials are available**.

## Scope

**In scope (this story)**
- Database migration for `wo_material_reservations` table
- FIFO picking algorithm (First In, First Out by receipt date)
- FEFO picking algorithm (First Expiry, First Out by expiry date)
- Algorithm selection based on warehouse settings (enable_fifo, enable_fefo)
- Auto-reservation trigger on WO release status transition
- Manual LP reservation/un-reservation per material
- LP availability real-time query
- Over-reservation validation (cannot reserve more than LP.quantity)
- `reserved_qty` updates on `wo_materials` table
- Reservation status tracking (active, released, consumed)
- Auto-release reservations on WO cancellation
- API endpoints: reserve, release, realloc, list reservations
- ReservedLPsList component on WO materials view
- ReserveLPModal for manual LP selection
- Service layer for all reservation business logic
- Zod validation schemas
- Unit tests for FIFO/FEFO algorithms
- Integration tests for complex scenarios (partial allocation, expiry priority)

**Out of scope (this story)**
- Hard reservation (blocking other WOs) - soft reservation only
- Material consumption tracking (Epic 04 - Production)
- Reservation-to-consumption conversion (Epic 04)
- Automatic re-allocation when LP becomes unavailable
- Multi-warehouse reservation (single warehouse per WO)
- Batch number matching/filtering
- QA status-based filtering (uses LP.qa_status = 'passed' filter)

## Dependencies

- **03.11a** - WO BOM Snapshot (provides `wo_materials` table with `reserved_qty` column)
- **03.10** - WO CRUD (provides `work_orders` table with status lifecycle)
- **Epic 05** - License Plates (provides `license_plates` table)
- **Epic 05** - LP Reservations (provides `lp_reservations` table infrastructure)
- **01.X** - Warehouses (warehouse_id for LP filtering)
- **01.1** - Org Context + RLS (multi-tenant isolation)

## Acceptance Criteria (Given/When/Then)

### AC-1: Auto-Reserve Materials on WO Release

**Given** a Work Order with status = 'planned' and wo_materials defined
**When** user changes WO status to 'released'
**Then** system automatically reserves LPs for each wo_material using FIFO/FEFO

**Given** wo_material requires 100 kg of "Flour"
**When** LPs available: LP-001 (50kg), LP-002 (60kg), LP-003 (40kg)
**Then** LP-001 and LP-002 are reserved (50+60=110kg covers 100kg requirement)

**Given** insufficient inventory for a material
**When** WO release attempted
**Then** WO is released with warning, partial reservation created

### AC-2: FIFO Picking Algorithm

**Given** warehouse_settings.enable_fifo = true AND enable_fefo = false
**When** reserving LPs for material
**Then** LPs selected by oldest `created_at` (receipt date) first

**Given** three LPs for same product:
  - LP-001: created_at = 2025-01-01
  - LP-002: created_at = 2025-01-05
  - LP-003: created_at = 2025-01-03
**When** FIFO reservation for 50 kg
**Then** LP-001 reserved first, then LP-003, then LP-002

### AC-3: FEFO Picking Algorithm

**Given** warehouse_settings.enable_fefo = true
**When** reserving LPs for material
**Then** LPs selected by soonest `expiry_date` first (FEFO overrides FIFO)

**Given** three LPs for same product:
  - LP-001: expiry_date = 2025-03-01
  - LP-002: expiry_date = 2025-02-15
  - LP-003: expiry_date = 2025-02-28
**When** FEFO reservation for 50 kg
**Then** LP-002 reserved first (soonest expiry), then LP-003, then LP-001

**Given** LPs with NULL expiry_date
**When** FEFO reservation
**Then** NULL expiry LPs sorted last (never expire = lowest priority)

### AC-4: Reservation Record Creation

**Given** LP-001 reserved for wo_material "Flour" with qty 50 kg
**When** reservation created
**Then** `wo_material_reservations` record created with:
  - wo_material_id = [wo_material.id]
  - lp_id = LP-001.id
  - reserved_qty = 50
  - status = 'active'
  - reserved_at = now()
  - reserved_by = current_user.id

**Given** reservation created
**When** wo_materials queried
**Then** wo_material.reserved_qty = SUM(reservations.reserved_qty)

### AC-5: LP Availability Filter

**Given** license_plates query for reservation
**When** selecting LPs
**Then** only LPs with:
  - status = 'available'
  - qa_status = 'passed'
  - warehouse_id = work_order.warehouse_id (or default)
  - quantity > 0

**Given** LP-001 with status = 'blocked' or 'consumed'
**When** reservation algorithm runs
**Then** LP-001 is excluded from selection

### AC-6: Over-Reservation Prevention

**Given** LP-001 has quantity = 100 kg
**When** WO-A reserves 80 kg, WO-B attempts to reserve 50 kg
**Then** WO-B can reserve remaining 20 kg (soft reservation allows overlap warning)

**Given** manual reservation attempt for 150 kg from LP with 100 kg
**When** API called
**Then** returns 400 Bad Request: "Reserved quantity (150) exceeds LP available (100)"

**Given** LP already 100% reserved by other WOs
**When** new reservation attempted
**Then** warning shown, reservation allowed (soft reservation flexibility)

### AC-7: Manual LP Reservation

**Given** WO detail page with materials list
**When** user clicks "Reserve LPs" on a material row
**Then** ReserveLPModal opens showing available LPs for that product

**Given** ReserveLPModal open
**When** user selects LP-001 and enters quantity 50 kg
**Then** reservation created via POST `/api/planning/work-orders/:id/materials/:materialId/reservations`

**Given** user selects multiple LPs
**When** confirming reservation
**Then** multiple reservation records created in single transaction

### AC-8: Manual LP Release (Un-Reserve)

**Given** WO material with reserved LP-001 (50 kg)
**When** user clicks "Release" on LP-001 reservation
**Then** DELETE `/api/planning/work-orders/:id/reservations/:reservationId` called

**Given** reservation released
**When** operation completes
**Then** wo_material.reserved_qty decremented by released amount

### AC-9: Reserved LPs Display

**Given** WO detail page -> materials section
**When** expanding a material row
**Then** ReservedLPsList shows all reserved LPs with: LP number, location, quantity, expiry_date

**Given** material with no reservations
**When** expanded
**Then** shows "No LPs reserved" with "Reserve LPs" button

**Given** material with partial coverage (reserved < required)
**When** displayed
**Then** shows warning badge "Partially Reserved (80/100 kg)"

### AC-10: Auto-Release on WO Cancel

**Given** WO-001 with 5 material reservations
**When** WO status changed to 'cancelled'
**Then** all reservations set to status = 'released', released_at = now()

**Given** reservations released
**When** wo_materials queried
**Then** all reserved_qty = 0

### AC-11: LP Visibility in Warehouse Views

**Given** LP-001 has active reservation for WO-001
**When** LP displayed in warehouse LP list
**Then** shows reservation indicator: "Reserved for WO-001"

**Given** LP with multiple soft reservations (WO-001: 50kg, WO-002: 30kg)
**When** LP detail viewed
**Then** shows all reservations with quantities and WO references

### AC-12: Partial Allocation Handling

**Given** wo_material requires 200 kg, total available LPs = 150 kg
**When** auto-reservation runs
**Then** 150 kg reserved, warning logged, WO proceeds

**Given** partial allocation
**When** material displayed
**Then** shows "Short 50 kg" warning with red indicator

### AC-13: API Validation

**Given** reservation request for non-existent wo_material_id
**When** API called
**Then** returns 404 Not Found

**Given** reservation for WO belonging to different org_id
**When** API called
**Then** returns 403 Forbidden (RLS enforced)

**Given** reservation after WO completed/closed
**When** API called
**Then** returns 409 Conflict: "Cannot modify reservations after WO completion"

### AC-14: Performance Requirements

**Given** WO with 50 materials
**When** auto-reservation triggered
**Then** all reservations completed within 5 seconds

**Given** ReservedLPsList for material
**When** queried
**Then** response within 500ms for up to 50 reserved LPs

---

## Implementation Notes

### API Endpoints

```typescript
// GET /api/planning/work-orders/:id/materials/:materialId/reservations
// Returns all LP reservations for a specific wo_material
interface ReservationsListResponse {
  reservations: WOMaterialReservation[];
  total_reserved: number;
  required_qty: number;
  coverage_percent: number;
}

// POST /api/planning/work-orders/:id/materials/:materialId/reservations
// Create manual LP reservation
interface CreateReservationRequest {
  lp_id: string;
  quantity: number;
}

interface CreateReservationResponse {
  reservation: WOMaterialReservation;
  message: string;
}

// DELETE /api/planning/work-orders/:id/reservations/:reservationId
// Release (un-reserve) a specific LP reservation
interface ReleaseReservationResponse {
  success: boolean;
  released_qty: number;
  message: string;
}

// POST /api/planning/work-orders/:id/reserve-all
// Trigger auto-reservation for all materials
interface ReserveAllResponse {
  success: boolean;
  materials_processed: number;
  fully_reserved: number;
  partially_reserved: number;
  shortages: Array<{
    material_name: string;
    required_qty: number;
    reserved_qty: number;
    shortage: number;
  }>;
}

// GET /api/planning/work-orders/:id/materials/:materialId/available-lps
// Get available LPs for manual reservation selection
interface AvailableLPsResponse {
  lps: Array<{
    id: string;
    lp_number: string;
    quantity: number;
    available_qty: number;  // quantity minus existing reservations
    location: string;
    expiry_date: string | null;
    created_at: string;
  }>;
  total_available: number;
}

// Response codes:
// 200 - Success
// 400 - Bad request (over-reservation, validation error)
// 403 - Forbidden (RLS violation)
// 404 - WO/Material/LP not found
// 409 - Conflict (WO status doesn't allow modification)
```

### Database

```sql
-- wo_material_reservations table (new)
CREATE TABLE wo_material_reservations (
  id                  UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id              UUID NOT NULL REFERENCES organizations(id),
  wo_material_id      UUID NOT NULL REFERENCES wo_materials(id) ON DELETE CASCADE,
  lp_id               UUID NOT NULL REFERENCES license_plates(id),
  reserved_qty        DECIMAL(15,6) NOT NULL,
  status              TEXT NOT NULL DEFAULT 'active',  -- active, released, consumed
  reserved_at         TIMESTAMPTZ NOT NULL DEFAULT now(),
  released_at         TIMESTAMPTZ,
  consumed_at         TIMESTAMPTZ,
  reserved_by         UUID REFERENCES users(id),
  released_by         UUID REFERENCES users(id),
  notes               TEXT,
  created_at          TIMESTAMPTZ DEFAULT now(),

  CONSTRAINT chk_reserved_qty CHECK (reserved_qty > 0),
  CONSTRAINT chk_status CHECK (status IN ('active', 'released', 'consumed'))
);

-- Indexes
CREATE INDEX idx_wo_mat_reservations_material ON wo_material_reservations(wo_material_id);
CREATE INDEX idx_wo_mat_reservations_lp ON wo_material_reservations(lp_id);
CREATE INDEX idx_wo_mat_reservations_org_status ON wo_material_reservations(org_id, status);

-- Composite unique (soft constraint - same LP can be reserved by multiple WOs)
-- No unique constraint on (wo_material_id, lp_id) to allow soft reservations

-- RLS Policy
ALTER TABLE wo_material_reservations ENABLE ROW LEVEL SECURITY;

CREATE POLICY "wo_material_reservations org isolation" ON wo_material_reservations
FOR ALL USING (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
);

-- Update wo_materials.reserved_qty via trigger or application logic
CREATE OR REPLACE FUNCTION update_wo_material_reserved_qty()
RETURNS TRIGGER AS $$
BEGIN
  IF TG_OP = 'INSERT' OR TG_OP = 'UPDATE' THEN
    UPDATE wo_materials
    SET reserved_qty = COALESCE((
      SELECT SUM(reserved_qty)
      FROM wo_material_reservations
      WHERE wo_material_id = NEW.wo_material_id
        AND status = 'active'
    ), 0)
    WHERE id = NEW.wo_material_id;
    RETURN NEW;
  ELSIF TG_OP = 'DELETE' THEN
    UPDATE wo_materials
    SET reserved_qty = COALESCE((
      SELECT SUM(reserved_qty)
      FROM wo_material_reservations
      WHERE wo_material_id = OLD.wo_material_id
        AND status = 'active'
    ), 0)
    WHERE id = OLD.wo_material_id;
    RETURN OLD;
  END IF;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_wo_material_reservation_qty
AFTER INSERT OR UPDATE OR DELETE ON wo_material_reservations
FOR EACH ROW EXECUTE FUNCTION update_wo_material_reserved_qty();
```

### FIFO/FEFO Picking Query

```sql
-- FIFO Query (by receipt date)
SELECT
  lp.id,
  lp.lp_number,
  lp.quantity,
  lp.quantity - COALESCE(SUM(r.reserved_qty), 0) AS available_qty,
  lp.location_id,
  loc.name AS location_name,
  lp.expiry_date,
  lp.created_at
FROM license_plates lp
LEFT JOIN wo_material_reservations r
  ON r.lp_id = lp.id AND r.status = 'active'
LEFT JOIN locations loc ON loc.id = lp.location_id
WHERE lp.product_id = :product_id
  AND lp.org_id = :org_id
  AND lp.status = 'available'
  AND lp.qa_status = 'passed'
  AND lp.warehouse_id = :warehouse_id
GROUP BY lp.id, lp.lp_number, lp.quantity, lp.location_id, loc.name, lp.expiry_date, lp.created_at
HAVING lp.quantity - COALESCE(SUM(r.reserved_qty), 0) > 0
ORDER BY lp.created_at ASC;  -- FIFO: oldest first

-- FEFO Query (by expiry date)
ORDER BY
  CASE WHEN lp.expiry_date IS NULL THEN 1 ELSE 0 END,  -- NULL expiry last
  lp.expiry_date ASC,  -- Soonest expiry first
  lp.created_at ASC;   -- Tie-breaker: FIFO
```

### Frontend Components

```
app/(authenticated)/planning/work-orders/[id]/page.tsx  -- WO detail page (update)
components/planning/work-orders/
  WOMaterialsTable.tsx          -- Update to show reserved qty
  WOMaterialRow.tsx             -- Update with expand/collapse
  ReservedLPsList.tsx           -- List of reserved LPs per material (new)
  ReservedLPRow.tsx             -- Single LP reservation row (new)
  ReserveLPModal.tsx            -- Manual LP selection modal (new)
  AvailableLPsTable.tsx         -- LPs available for selection (new)
  ReservationStatusBadge.tsx    -- Coverage indicator badge (new)
```

### Services

```typescript
// lib/services/wo-reservation-service.ts (new)

/**
 * Auto-reserve LPs for all materials in a WO using FIFO/FEFO.
 * Called on WO release.
 */
export async function autoReserveWOMaterials(
  woId: string
): Promise<ReservationResult>

/**
 * Reserve specific LP for a WO material.
 * Manual reservation.
 */
export async function reserveLP(
  woMaterialId: string,
  lpId: string,
  quantity: number,
  userId: string
): Promise<WOMaterialReservation>

/**
 * Release (un-reserve) a reservation.
 */
export async function releaseReservation(
  reservationId: string,
  userId: string
): Promise<void>

/**
 * Release all reservations for a WO.
 * Called on WO cancellation.
 */
export async function releaseAllWOReservations(woId: string): Promise<number>

/**
 * Get available LPs for a product using FIFO/FEFO ordering.
 */
export async function getAvailableLPs(
  productId: string,
  warehouseId: string,
  algorithm: 'fifo' | 'fefo'
): Promise<AvailableLP[]>

/**
 * Check if WO reservations can be modified.
 */
export function canModifyReservations(woStatus: string): boolean

/**
 * Calculate reservation coverage for a material.
 */
export function calculateCoverage(
  requiredQty: number,
  reservedQty: number
): { percent: number; shortage: number; status: 'full' | 'partial' | 'none' }
```

### Validation (Zod)

```typescript
// lib/validation/wo-reservations.ts

const createReservationSchema = z.object({
  lp_id: z.string().uuid("LP ID is required"),
  quantity: z.number()
    .positive("Quantity must be greater than 0")
    .refine(val => {
      const decimals = (val.toString().split('.')[1] || '').length;
      return decimals <= 6;
    }, "Maximum 6 decimal places allowed"),
});

const reservationResponseSchema = z.object({
  id: z.string().uuid(),
  wo_material_id: z.string().uuid(),
  lp_id: z.string().uuid(),
  reserved_qty: z.number().positive(),
  status: z.enum(['active', 'released', 'consumed']),
  reserved_at: z.string().datetime(),
  lp_number: z.string(),
  location_name: z.string().nullable(),
  expiry_date: z.string().nullable(),
});

const reserveAllResponseSchema = z.object({
  success: z.boolean(),
  materials_processed: z.number().int().nonnegative(),
  fully_reserved: z.number().int().nonnegative(),
  partially_reserved: z.number().int().nonnegative(),
  shortages: z.array(z.object({
    material_name: z.string(),
    required_qty: z.number(),
    reserved_qty: z.number(),
    shortage: z.number(),
  })),
});
```

### Key Business Rules

1. **Soft Reservations**: Reservations are advisory; same LP can be "reserved" by multiple WOs (with warnings)
2. **FIFO Default**: Use oldest LPs first by receipt date (created_at)
3. **FEFO Override**: If warehouse has expiry-sensitive products, soonest expiry takes priority
4. **NULL Expiry Last**: LPs without expiry dates sorted last in FEFO mode
5. **Auto-Reserve on Release**: When WO transitions to 'released', auto-reservation triggers
6. **Auto-Release on Cancel**: When WO cancelled, all reservations released
7. **LP Filters**: Only reserve from status='available', qa_status='passed' LPs
8. **Over-Reserve Warning**: Allow reserving more than LP available, but show warning
9. **Partial OK**: Partial reservations allowed; production can proceed with warnings
10. **Immutability After Complete**: Cannot modify reservations after WO completed/closed

---

## Deliverables

- Migration: Create `wo_material_reservations` table with indexes, trigger, RLS
- API routes:
  - GET `/api/planning/work-orders/:id/materials/:materialId/reservations`
  - POST `/api/planning/work-orders/:id/materials/:materialId/reservations`
  - DELETE `/api/planning/work-orders/:id/reservations/:reservationId`
  - POST `/api/planning/work-orders/:id/reserve-all`
  - GET `/api/planning/work-orders/:id/materials/:materialId/available-lps`
- ReservedLPsList component
- ReserveLPModal component
- AvailableLPsTable component
- ReservationStatusBadge component
- wo-reservation-service.ts
- wo-reservations validation schemas
- Update WOMaterialsTable to show reserved_qty and expand for reservations
- Update WO release flow to trigger auto-reservation
- Update WO cancel flow to release reservations
- Unit tests for FIFO/FEFO algorithms
- Unit tests for coverage calculation
- Integration tests for reservation CRUD
- Integration tests for complex scenarios

---

## Definition of Done

- [ ] Migration creates wo_material_reservations table with all fields
- [ ] Trigger updates wo_materials.reserved_qty on reservation changes
- [ ] RLS policy enforces org isolation
- [ ] FIFO algorithm selects oldest LPs first
- [ ] FEFO algorithm selects soonest-expiry LPs first
- [ ] Auto-reservation triggered on WO release
- [ ] Auto-release triggered on WO cancel
- [ ] Manual reservation via modal works
- [ ] Manual release via button works
- [ ] Over-reservation shows warning (soft block only)
- [ ] Partial allocation shows warning with shortage amount
- [ ] ReservedLPsList displays in <500ms for 50 LPs
- [ ] All API endpoints have integration tests
- [ ] Unit tests cover algorithm edge cases:
  - [ ] FIFO ordering by created_at
  - [ ] FEFO ordering by expiry_date
  - [ ] NULL expiry handled (sorted last)
  - [ ] Partial allocation when insufficient inventory
  - [ ] Multiple LPs to fulfill single material
  - [ ] LP already fully reserved by other WOs
- [ ] Performance: Auto-reserve 50 materials in <5 seconds

---

## Test Cases

### Unit Tests: FIFO Algorithm

```typescript
describe('FIFO Picking Algorithm', () => {
  it('selects oldest LP first', () => {
    const lps = [
      { id: '1', created_at: '2025-01-05', quantity: 50 },
      { id: '2', created_at: '2025-01-01', quantity: 50 },
      { id: '3', created_at: '2025-01-03', quantity: 50 },
    ];
    const result = selectLPsFIFO(lps, 80);
    expect(result[0].id).toBe('2'); // oldest
    expect(result[1].id).toBe('3'); // second oldest
  });

  it('allocates partial quantity from last LP', () => {
    const lps = [
      { id: '1', created_at: '2025-01-01', quantity: 50 },
      { id: '2', created_at: '2025-01-02', quantity: 50 },
    ];
    const result = selectLPsFIFO(lps, 70);
    expect(result[0]).toEqual({ id: '1', quantity: 50 });
    expect(result[1]).toEqual({ id: '2', quantity: 20 }); // partial
  });

  it('handles insufficient inventory', () => {
    const lps = [{ id: '1', created_at: '2025-01-01', quantity: 50 }];
    const result = selectLPsFIFO(lps, 100);
    expect(result[0]).toEqual({ id: '1', quantity: 50 });
    expect(result.totalReserved).toBe(50);
    expect(result.shortage).toBe(50);
  });
});
```

### Unit Tests: FEFO Algorithm

```typescript
describe('FEFO Picking Algorithm', () => {
  it('selects soonest expiry first', () => {
    const lps = [
      { id: '1', expiry_date: '2025-03-01', quantity: 50 },
      { id: '2', expiry_date: '2025-02-15', quantity: 50 },
      { id: '3', expiry_date: '2025-02-28', quantity: 50 },
    ];
    const result = selectLPsFEFO(lps, 80);
    expect(result[0].id).toBe('2'); // soonest expiry
    expect(result[1].id).toBe('3'); // second soonest
  });

  it('sorts NULL expiry dates last', () => {
    const lps = [
      { id: '1', expiry_date: null, quantity: 50 },
      { id: '2', expiry_date: '2025-02-15', quantity: 50 },
    ];
    const result = selectLPsFEFO(lps, 80);
    expect(result[0].id).toBe('2'); // has expiry
    expect(result[1].id).toBe('1'); // NULL expiry last
  });

  it('uses FIFO as tiebreaker for same expiry', () => {
    const lps = [
      { id: '1', expiry_date: '2025-02-15', created_at: '2025-01-05', quantity: 50 },
      { id: '2', expiry_date: '2025-02-15', created_at: '2025-01-01', quantity: 50 },
    ];
    const result = selectLPsFEFO(lps, 80);
    expect(result[0].id).toBe('2'); // older created_at wins tie
  });
});
```

### Integration Tests: Reservation API

```typescript
describe('POST /api/planning/work-orders/:id/materials/:materialId/reservations', () => {
  it('creates reservation for released WO', async () => {
    const wo = await createReleasedWO();
    const material = wo.materials[0];
    const lp = await createAvailableLP({ product_id: material.product_id });

    const res = await request.post(
      `/api/planning/work-orders/${wo.id}/materials/${material.id}/reservations`,
      { lp_id: lp.id, quantity: 50 }
    );

    expect(res.status).toBe(200);
    expect(res.body.reservation.reserved_qty).toBe(50);

    const updatedMaterial = await getWOMaterial(material.id);
    expect(updatedMaterial.reserved_qty).toBe(50);
  });

  it('rejects reservation for completed WO', async () => {
    const wo = await createCompletedWO();
    const material = wo.materials[0];

    const res = await request.post(
      `/api/planning/work-orders/${wo.id}/materials/${material.id}/reservations`,
      { lp_id: 'some-lp', quantity: 50 }
    );

    expect(res.status).toBe(409);
    expect(res.body.error).toContain('Cannot modify reservations');
  });

  it('warns but allows over-reservation', async () => {
    const lp = await createAvailableLP({ quantity: 100 });

    // WO-A reserves 80 kg
    await createReservation({ lp_id: lp.id, quantity: 80 });

    // WO-B reserves 50 kg (overlapping)
    const res = await request.post(
      `/api/planning/work-orders/${woB.id}/materials/${materialB.id}/reservations`,
      { lp_id: lp.id, quantity: 50 }
    );

    expect(res.status).toBe(200);
    expect(res.body.warnings).toContain('LP over-reserved');
  });
});

describe('POST /api/planning/work-orders/:id/reserve-all', () => {
  it('auto-reserves all materials using FIFO', async () => {
    const wo = await createReleasedWOWithMaterials([
      { product_id: flourId, required_qty: 100 },
      { product_id: sugarId, required_qty: 50 },
    ]);

    await createAvailableLP({ product_id: flourId, quantity: 120 });
    await createAvailableLP({ product_id: sugarId, quantity: 60 });

    const res = await request.post(`/api/planning/work-orders/${wo.id}/reserve-all`);

    expect(res.status).toBe(200);
    expect(res.body.materials_processed).toBe(2);
    expect(res.body.fully_reserved).toBe(2);
    expect(res.body.shortages).toHaveLength(0);
  });

  it('reports shortages for partial allocation', async () => {
    const wo = await createReleasedWOWithMaterials([
      { product_id: flourId, required_qty: 200 },
    ]);

    await createAvailableLP({ product_id: flourId, quantity: 150 });

    const res = await request.post(`/api/planning/work-orders/${wo.id}/reserve-all`);

    expect(res.status).toBe(200);
    expect(res.body.partially_reserved).toBe(1);
    expect(res.body.shortages[0].shortage).toBe(50);
  });
});
```

---

## Future Phases (Not in This Story)

### Epic 04 - Production
- Reservation-to-consumption conversion
- Consumed LP tracking via lp_genealogy
- Material backflush automation

### Phase 2
- Hard reservations (blocking mode)
- Multi-warehouse reservation
- Batch number matching rules
- Alternative material substitution

**Implementation**: See Epic 03.0 "Future Feature Handling" section.

---

## Risk Assessment

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Epic 05 delays block this story | High | Medium | Clear dependency documentation, parallel planning |
| Soft reservation conflicts | Medium | High | Clear UI warnings, audit logging |
| FEFO edge cases (same expiry) | Low | Medium | FIFO tiebreaker, comprehensive tests |
| Performance on large WOs | Medium | Low | Query optimization, async processing |
| Over-reservation confusion | Medium | Medium | Clear visual indicators, warnings |

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-12-16 | Initial story - WO Material Reservations (DEFERRED) | ARCHITECT-AGENT |
