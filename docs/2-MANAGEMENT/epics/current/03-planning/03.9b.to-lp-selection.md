# 03.9b - TO License Plate Pre-selection

**Priority**: P1 (Phase 1) - DEFERRED
**Story Points**: M (Medium - 3-4 days)
**Type:** backend + frontend

**State:** deferred
**Primary PRD:** `docs/1-BASELINE/product/modules/planning.md` (FR-PLAN-016)
**Architecture:** `docs/1-BASELINE/architecture/modules/planning.md`
**UX Wireframes:** PLAN-011 (LP Picker Modal), PLAN-012 (TO Line with LP Assignments)

**DEFERRED**: This story requires Epic 05 (Warehouse Module) license_plates table and inventory tracking system. Cannot be implemented until Epic 05 is complete.

---

## MVP Scope

This story implements **optional** License Plate (LP) pre-selection for Transfer Orders, allowing users to specify exact inventory units to transfer BEFORE shipping execution. This is a Phase 1 enhancement that provides:

- LP picker modal at TO creation/editing
- LP assignment to TO lines via junction table
- LP availability validation (warehouse, product, qty checks)
- Visual display of assigned LPs on TO Detail page
- Auto-picking of pre-selected LPs during shipping (Epic 05 integration)
- Settings toggle to make LP selection mandatory or optional

**In MVP:**
- `to_line_lps` junction table creation
- LP picker component with filters (product, warehouse, expiry, lot)
- LP assignment API endpoints
- Quantity validation (sum of LP quantities = TO line quantity)
- LP availability checks (correct warehouse, sufficient quantity)
- Integration with Epic 05 license_plates table
- Settings toggle: "Require LP Selection for Transfer Orders"

**Not in MVP:**
- FIFO/FEFO auto-suggestion (uses Epic 05 picking service)
- LP splitting during transfer (must use full LP or partial qty)
- LP consolidation across multiple TOs
- Barcode scanning for LP selection (Phase 2)

---

## Goal

Enable planners to pre-select specific License Plates when creating Transfer Orders, ensuring precise inventory control and reducing picking errors during shipping execution.

## User Story

As a **Warehouse Planner**, I want to **pre-select specific License Plates when creating a Transfer Order** so that **I can guarantee the correct inventory (by lot, expiry, or location) is transferred and warehouse staff pick exactly what I planned**.

## Scope

**In scope (this story)**
- `to_line_lps` junction table (to_line_id, lp_id, quantity)
- LP Picker modal component with filters:
  - Filter by warehouse (from_warehouse_id)
  - Filter by product (from selected TO line)
  - Filter by expiry date range
  - Filter by lot number
  - Show available quantity per LP
  - Multi-select interface for assigning multiple LPs to one TO line
- API endpoints:
  - POST `/api/planning/transfer-orders/:id/lines/:lineId/assign-lps`
  - DELETE `/api/planning/transfer-orders/:id/lines/:lineId/lps/:lpId`
  - GET `/api/planning/transfer-orders/:id/lines/:lineId/lps`
- Service layer methods:
  - `assignLPsToTOLine()` - Validate and assign LPs
  - `validateLPAvailability()` - Check warehouse, product, quantity
  - `getAvailableLPsForTOLine()` - Filter LPs by TO line criteria
  - `removeLPFromTOLine()` - Remove LP assignment
- Validation:
  - LP must exist in from_warehouse
  - LP product_id must match TO line product_id
  - Sum of LP quantities must equal TO line quantity (if setting requires)
  - LP must not be already allocated to another TO
  - LP available_qty >= assigned quantity
- UI updates:
  - "Assign LPs" button on TO Detail page (per line)
  - LP assignments display on TO line (badges or table)
  - Warning if LP quantities don't match TO line quantity
  - Settings toggle: "Require LP Selection for Transfer Orders"
- Integration with Epic 05:
  - Query `license_plates` table for available LPs
  - Check `lp_inventory` for available quantities
  - Update LP status during shipping (handled by Epic 05 ship action)

**Out of scope (this story)**
- Automatic FIFO/FEFO LP suggestion (use Epic 05 picking service)
- LP splitting (moving partial qty from LP to new LP) - Epic 05 feature
- Barcode scanning for LP selection - Phase 2
- Cross-warehouse LP visibility (only show from_warehouse LPs)
- LP reservation/allocation table (deferred to WO Material Reservation 03.11b)
- Shipping execution (handled by Epic 05 TO Ship action)

## Dependencies

- **01.1** - Org Context + RLS (HARD) - org_id filtering
- **02.1** - Products CRUD (HARD) - product_id FK validation
- **03.8** - TO CRUD + Lines (HARD) - TO and TO line entities
- **03.9a** - TO Partial Shipments (SOFT) - Ship/Receive actions that consume LP assignments
- **Epic 05** - Warehouse Module (HARD - BLOCKING) - `license_plates` table, `lp_inventory` table, LP availability logic

**CRITICAL DEPENDENCY**: This story CANNOT be implemented until Epic 05 creates the `license_plates` and `lp_inventory` tables.

## Acceptance Criteria (Given/When/Then)

### AC-1: Create to_line_lps Junction Table (Migration)

**Given** Epic 05 has created the `license_plates` table
**When** migration is applied
**Then** new table `to_line_lps` exists with schema:
```sql
id                  UUID PRIMARY KEY DEFAULT gen_random_uuid()
to_line_id          UUID NOT NULL REFERENCES transfer_order_lines(id) ON DELETE CASCADE
lp_id               UUID NOT NULL REFERENCES license_plates(id)
quantity            DECIMAL(15,4) NOT NULL CHECK (quantity > 0)
created_at          TIMESTAMPTZ DEFAULT now()
created_by          UUID REFERENCES users(id)

UNIQUE(to_line_id, lp_id)  -- Same LP cannot be assigned twice to same line
INDEX ON (to_line_id)
INDEX ON (lp_id)
```

**And** RLS policy `to_line_lps_org_isolation` enforces org_id via TO line → TO → org_id chain

### AC-2: LP Picker Modal - Open and Display Available LPs

**Given** I am on the TO Detail page with TO status = DRAFT or PLANNED
**And** TO line exists: Product A, qty = 100 units, from_warehouse = "WH-001"
**When** I click "Assign LPs" button next to the TO line
**Then** LP Picker modal opens showing:
- Modal title: "Assign License Plates - Product A (100 units needed)"
- Filter panel:
  - Warehouse: "WH-001" (readonly, pre-filled from TO from_warehouse_id)
  - Product: "Product A" (readonly, pre-filled from TO line)
  - Lot Number (text input, optional filter)
  - Expiry Date From/To (date range, optional filter)
  - Search (LP number search)
- LP list table with columns:
  - [ ] Checkbox (multi-select)
  - LP Number (e.g., "LP-2024-00123")
  - Lot Number
  - Expiry Date
  - Location
  - Available Qty (e.g., "50 units")
  - UOM
- "Assign Qty" input field per row (numeric, defaulted to available qty)
- Total Selected: "0 / 100 units" progress indicator
- "Assign LPs" and "Cancel" buttons

**And** only LPs matching criteria are shown:
  - LP.warehouse_id = TO.from_warehouse_id
  - LP.product_id = TO line.product_id
  - LP.available_qty > 0
  - LP not already assigned to another TO (check `to_line_lps` table)

### AC-3: LP Picker Modal - Assign Single LP (Full Quantity)

**Given** LP Picker modal is open for TO line with qty = 100
**And** LP-2024-00123 is available with available_qty = 100
**When** I check the checkbox for LP-2024-00123
**And** I leave "Assign Qty" = 100 (default)
**And** I click "Assign LPs"
**Then**:
- API POST to `/api/planning/transfer-orders/:toId/lines/:lineId/assign-lps` with body:
  ```json
  {
    "lps": [
      { "lp_id": "uuid-123", "quantity": 100 }
    ]
  }
  ```
- New row inserted into `to_line_lps`:
  - to_line_id = TO line UUID
  - lp_id = "uuid-123"
  - quantity = 100
- Modal closes
- Success toast: "1 License Plate assigned successfully"
- TO Detail page refreshes, TO line shows:
  - Badge: "1 LP Assigned" (green)
  - Expandable section showing:
    - LP-2024-00123 | Lot: ABC-001 | Expiry: 2025-06-01 | Qty: 100 units
    - Remove button (X icon) next to each LP

### AC-4: LP Picker Modal - Assign Multiple LPs (Partial Quantities)

**Given** LP Picker modal is open for TO line with qty = 100
**And** available LPs:
  - LP-001: available_qty = 50
  - LP-002: available_qty = 30
  - LP-003: available_qty = 20
**When** I select:
  - LP-001, Assign Qty = 50
  - LP-002, Assign Qty = 30
  - LP-003, Assign Qty = 20
**And** Total Selected shows: "100 / 100 units" (green checkmark)
**And** I click "Assign LPs"
**Then**:
- 3 rows inserted into `to_line_lps` table
- TO line shows:
  - Badge: "3 LPs Assigned" (green)
  - Expandable section with all 3 LPs listed
- Success toast: "3 License Plates assigned successfully"

### AC-5: LP Picker Modal - Validation: Quantity Mismatch

**Given** LP Picker modal is open for TO line with qty = 100
**And** setting "Require Exact LP Quantity Match" = true
**When** I select LPs with total = 80 (less than required)
**And** I click "Assign LPs"
**Then**:
- API returns 400 error: "Total LP quantity (80) does not match TO line quantity (100). Assign exactly 100 units or disable exact match requirement in settings."
- Error toast displayed
- Modal remains open with error message

**Given** setting "Require Exact LP Quantity Match" = false
**When** I select LPs with total = 80
**And** I click "Assign LPs"
**Then**:
- Assignment succeeds
- Warning badge on TO line: "80 / 100 units assigned" (yellow)
- TO Detail page shows warning: "Some lines have incomplete LP assignments"

### AC-6: LP Picker Modal - Validation: LP Not in Source Warehouse

**Given** LP Picker modal is open for TO with from_warehouse = "WH-001"
**When** API receives assignment request with lp_id pointing to LP in "WH-002"
**Then**:
- API returns 400 error: "LP-2024-00456 is not located in source warehouse WH-001"
- Error toast displayed

### AC-7: LP Picker Modal - Validation: Product Mismatch

**Given** LP Picker modal is open for TO line with product = "Product A"
**When** API receives assignment request with lp_id pointing to LP containing "Product B"
**Then**:
- API returns 400 error: "LP-2024-00456 contains Product B, but TO line requires Product A"
- Error toast displayed

### AC-8: LP Picker Modal - Validation: Insufficient LP Quantity

**Given** LP-001 has available_qty = 50
**When** I assign LP-001 with Assign Qty = 60
**And** I click "Assign LPs"
**Then**:
- API returns 400 error: "LP-001 has only 50 units available, cannot assign 60 units"
- Error toast displayed

### AC-9: LP Picker Modal - Validation: LP Already Assigned to Another TO

**Given** LP-001 is already assigned to TO-2024-00001 (different TO)
**When** LP Picker modal loads for TO-2024-00002
**Then**:
- LP-001 does NOT appear in available LPs list
- Filter info message: "LPs already assigned to other TOs are hidden"

**Alternative behavior (if business rule allows partial allocation):**
- LP-001 appears but shows "Available Qty: 30 (70 allocated to TO-2024-00001)"
- Can assign up to 30 units from this LP

### AC-10: Remove LP Assignment

**Given** TO line has 2 LPs assigned:
  - LP-001: qty = 50
  - LP-002: qty = 50
**When** I click the Remove (X) button next to LP-001
**Then** confirmation dialog appears: "Remove LP-001 from this Transfer Order line?"
**And** on confirm:
- API DELETE to `/api/planning/transfer-orders/:toId/lines/:lineId/lps/:lpId`
- Row deleted from `to_line_lps` table
- TO line badge updates: "1 LP Assigned"
- TO line shows warning: "50 / 100 units assigned" (yellow badge)
- Success toast: "LP-001 removed successfully"

### AC-11: Settings Toggle - Require LP Selection

**Given** I am on Planning Settings page (Story 03.17)
**Then** I should see toggle:
- Label: "Require License Plate Selection for Transfer Orders"
- Description: "When enabled, Transfer Orders cannot be shipped without pre-assigned License Plates"
- Default: Disabled (false)
- Sub-setting (visible when enabled):
  - Checkbox: "Require Exact Quantity Match"
  - Description: "Sum of assigned LP quantities must equal TO line quantity"

**Given** the toggle is ENABLED
**When** I create a TO and try to change status to PLANNED without assigning LPs
**Then**:
- Status transition blocked
- Error message: "All TO lines must have assigned License Plates before status can be changed to PLANNED"

**Given** the toggle is DISABLED (default)
**When** I create a TO without assigning LPs
**Then**:
- TO can be saved and status changed normally
- At shipping time (Epic 05), warehouse staff will pick LPs using FIFO/FEFO rules

### AC-12: TO Detail Page - Display LP Assignments

**Given** TO line has 2 LPs assigned:
  - LP-001: Lot ABC-001, Expiry 2025-06-01, Qty 50
  - LP-002: Lot ABC-002, Expiry 2025-07-01, Qty 50
**When** I view TO Detail page
**Then** TO lines table shows:
- Column: "LP Assignments"
  - Badge: "2 LPs Assigned" (green) if total qty matches TO line qty
  - Badge: "Partial Assignment" (yellow) if total qty < TO line qty
  - Expandable row showing:
    - Table with columns: LP Number, Lot, Expiry, Location, Assigned Qty, Actions
    - Each LP has a Remove (X) button
- "Assign LPs" button visible if status = DRAFT or PLANNED

### AC-13: Integration with Ship TO Action (Epic 05)

**Given** TO has LPs pre-assigned
**When** warehouse staff executes Ship TO action (Story 03.9a + Epic 05)
**Then**:
- Ship TO modal pre-populates with assigned LPs
- LPs are auto-selected for picking
- Warehouse staff can override LP selection if needed (configurable in settings)
- After shipment:
  - LP status updated in `license_plates` table (handled by Epic 05)
  - LP inventory moved from source to in-transit location (Epic 05)
  - `to_line_lps` records remain for audit trail

**Note:** Shipping execution details are handled by Epic 05 Warehouse Ship TO action. This story only handles LP pre-selection.

### AC-14: Future Features (Phase 2+)

Features deferred to future phases:
- **FIFO/FEFO Auto-Suggestion** (Phase 2)
  - "Suggest LPs" button in LP Picker modal
  - Calls Epic 05 picking service to suggest optimal LPs
  - Auto-selects LPs based on FIFO, FEFO, or custom rules
- **Barcode Scanning for LP Selection** (Phase 2)
  - Scan LP barcode to assign to TO line
  - Mobile-friendly interface for warehouse floor
  - Validate LP in real-time during scanning
- **LP Splitting During Transfer** (Phase 2)
  - Split LP into multiple smaller LPs during TO creation
  - Useful when transferring partial quantities from large LPs
  - Requires LP splitting service in Epic 05
- **Cross-Warehouse LP Visibility** (Phase 3)
  - View LPs in all warehouses (not just source warehouse)
  - Enable cross-dock transfers (receive at WH-A, ship from WH-B)
  - Complex allocation logic
- **LP Reservation Table** (Phase 3)
  - New table: `lp_reservations` (lp_id, reserved_qty, reservation_type, reference_id)
  - Prevent double-allocation of LPs across TOs, WOs, SOs
  - Reservation release on TO cancellation

**Implementation**: Per Epic 03.0 guidance, hide future features. Show "Coming Soon" badge for FIFO/FEFO suggestion button.

## Implementation Notes

### API Endpoints

```typescript
// Assign License Plates to TO Line
POST /api/planning/transfer-orders/:id/lines/:lineId/assign-lps
Request Body:
{
  lps: Array<{
    lp_id: string (UUID)
    quantity: number
  }>
}
Response: 200 OK
{
  success: true
  assignments: Array<TOLineLPAssignment>
  message: "3 License Plates assigned successfully"
}

// Get LP Assignments for TO Line
GET /api/planning/transfer-orders/:id/lines/:lineId/lps
Response: 200 OK
{
  assignments: Array<{
    id: string
    lp_id: string
    lp_number: string
    lot_number: string
    expiry_date: string
    location: string
    quantity: number
    product: { id, code, name }
  }>
  total_assigned: number
  total_required: number
  is_complete: boolean
}

// Remove LP Assignment
DELETE /api/planning/transfer-orders/:id/lines/:lineId/lps/:lpId
Response: 200 OK
{
  success: true
  message: "LP-2024-00123 removed successfully"
}

// Get Available LPs for TO Line (used by LP Picker)
GET /api/planning/transfer-orders/:id/lines/:lineId/available-lps
Query Params:
  ?lot_number=ABC-001
  &expiry_from=2025-01-01
  &expiry_to=2025-12-31
  &search=LP-2024
Response: 200 OK
{
  lps: Array<{
    id: string
    lp_number: string
    lot_number: string
    expiry_date: string
    location: string
    available_qty: number
    uom: string
    warehouse: { id, code, name }
    product: { id, code, name }
  }>
  total_count: number
}
```

### Database

**Migration: Create to_line_lps Table**

```sql
-- Migration: YYYYMMDDHHMMSS_create_to_line_lps.sql

CREATE TABLE to_line_lps (
  id                  UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  to_line_id          UUID NOT NULL REFERENCES transfer_order_lines(id) ON DELETE CASCADE,
  lp_id               UUID NOT NULL REFERENCES license_plates(id),
  quantity            DECIMAL(15,4) NOT NULL CHECK (quantity > 0),
  created_at          TIMESTAMPTZ DEFAULT now(),
  created_by          UUID REFERENCES users(id),

  UNIQUE(to_line_id, lp_id)
);

-- Indexes
CREATE INDEX idx_to_line_lps_to_line_id ON to_line_lps(to_line_id);
CREATE INDEX idx_to_line_lps_lp_id ON to_line_lps(lp_id);

-- RLS Policy: Org isolation via TO line → TO → org_id
ALTER TABLE to_line_lps ENABLE ROW LEVEL SECURITY;

CREATE POLICY to_line_lps_org_isolation ON to_line_lps
  USING (
    EXISTS (
      SELECT 1 FROM transfer_order_lines tol
      JOIN transfer_orders to ON tol.to_id = to.id
      WHERE tol.id = to_line_lps.to_line_id
        AND to.org_id = auth.org_id()
    )
  );

-- Comment
COMMENT ON TABLE to_line_lps IS 'License Plate assignments to Transfer Order lines for pre-selection';
```

**Schema Notes:**
- `UNIQUE(to_line_id, lp_id)` prevents assigning the same LP twice to the same TO line
- `ON DELETE CASCADE` ensures LP assignments are removed when TO line is deleted
- RLS policy chains through TO line → TO → org_id for proper multi-tenancy
- No `org_id` column on `to_line_lps` itself (normalized via foreign key)

### Frontend Components

```
app/(authenticated)/planning/transfer-orders/
  [id]/
    page.tsx                              -- TO Detail page (update)
    components/
      TOLineLPAssignments.tsx             -- NEW: Display LP assignments per line
      LPPickerModal.tsx                   -- NEW: LP picker modal
      LPAssignmentBadge.tsx               -- NEW: Badge showing LP assignment status
      TOLineActionsMenu.tsx               -- UPDATE: Add "Assign LPs" action
```

**Component Structure:**

```typescript
// LPPickerModal.tsx
interface LPPickerModalProps {
  toId: string;
  toLine: TransferOrderLine;
  fromWarehouse: Warehouse;
  onClose: () => void;
  onSuccess: () => void;
}

interface AvailableLP {
  id: string;
  lp_number: string;
  lot_number: string;
  expiry_date: string;
  location: string;
  available_qty: number;
  uom: string;
}

interface LPSelection {
  lp_id: string;
  quantity: number;
}

// TOLineLPAssignments.tsx
interface TOLineLPAssignmentsProps {
  toLineId: string;
  assignments: Array<{
    id: string;
    lp_number: string;
    lot_number: string;
    expiry_date: string;
    location: string;
    quantity: number;
  }>;
  totalRequired: number;
  canEdit: boolean; // based on TO status
  onRemove: (lpId: string) => void;
}

// LPAssignmentBadge.tsx
interface LPAssignmentBadgeProps {
  assignedQty: number;
  requiredQty: number;
  lpCount: number;
}
// Displays: "3 LPs Assigned (100/100)" in green
// Or: "Partial Assignment (80/100)" in yellow
```

### Services

```typescript
// lib/services/to-lp-service.ts

export async function assignLPsToTOLine(
  toId: string,
  toLineId: string,
  lps: Array<{ lp_id: string; quantity: number }>
): Promise<{
  success: boolean;
  assignments?: TOLineLPAssignment[];
  error?: string;
}> {
  // 1. Validate TO exists and belongs to org
  // 2. Validate TO line exists and belongs to TO
  // 3. Validate TO status is DRAFT or PLANNED
  // 4. For each LP:
  //    a. Validate LP exists in license_plates table (Epic 05)
  //    b. Validate LP.warehouse_id = TO.from_warehouse_id
  //    c. Validate LP.product_id = TO line.product_id
  //    d. Validate LP.available_qty >= requested quantity
  //    e. Check LP not already assigned to another TO (unless partial allocation allowed)
  // 5. Validate total quantity (if settings require exact match):
  //    - Sum(lp quantities) == TO line.quantity
  // 6. Insert rows into to_line_lps table (batch insert)
  // 7. Return assignments with full LP details
}

export async function getAvailableLPsForTOLine(
  toId: string,
  toLineId: string,
  filters?: {
    lot_number?: string;
    expiry_from?: string;
    expiry_to?: string;
    search?: string;
  }
): Promise<AvailableLP[]> {
  // 1. Get TO and TO line details
  // 2. Query license_plates table (Epic 05) with filters:
  //    - warehouse_id = TO.from_warehouse_id
  //    - product_id = TO line.product_id
  //    - available_qty > 0
  //    - NOT IN (SELECT lp_id FROM to_line_lps WHERE to_line_id != current line)
  //    - Optional filters: lot_number, expiry_date range, lp_number search
  // 3. Join with lp_inventory to get available quantities (Epic 05)
  // 4. Return list of available LPs
}

export async function removeLPFromTOLine(
  toId: string,
  toLineId: string,
  lpId: string
): Promise<{ success: boolean; error?: string }> {
  // 1. Validate TO exists and belongs to org
  // 2. Validate TO status is DRAFT or PLANNED
  // 3. Validate assignment exists in to_line_lps
  // 4. Delete row from to_line_lps
  // 5. Return success
}

export async function getLPAssignmentsForTOLine(
  toId: string,
  toLineId: string
): Promise<{
  assignments: Array<TOLineLPAssignment>;
  total_assigned: number;
  total_required: number;
  is_complete: boolean;
}> {
  // 1. Query to_line_lps for this TO line
  // 2. Join with license_plates to get LP details
  // 3. Calculate total assigned qty
  // 4. Get TO line required qty
  // 5. Return assignments with completion status
}

export function validateLPAssignment(
  lp: LicensePlate,
  toLine: TransferOrderLine,
  fromWarehouse: Warehouse,
  requestedQty: number
): { valid: boolean; error?: string } {
  // Validation rules:
  // - LP.warehouse_id == fromWarehouse.id
  // - LP.product_id == toLine.product_id
  // - LP.available_qty >= requestedQty
  // - LP status is not blocked/quarantined (Epic 05)
  // Return { valid: true } or { valid: false, error: "..." }
}
```

### Validation (Zod)

```typescript
// lib/validation/to-lp-validation.ts

const LPAssignmentSchema = z.object({
  lp_id: z.string().uuid("Invalid LP ID"),
  quantity: z.number()
    .positive("Quantity must be greater than 0")
    .max(99999.9999, "Quantity too large"),
});

export const AssignLPsRequestSchema = z.object({
  lps: z.array(LPAssignmentSchema)
    .min(1, "At least one License Plate must be assigned")
    .max(100, "Cannot assign more than 100 License Plates at once"),
});

export const AvailableLPsQuerySchema = z.object({
  lot_number: z.string().max(50).optional(),
  expiry_from: z.string()
    .regex(/^\d{4}-\d{2}-\d{2}$/, "Invalid date format (YYYY-MM-DD)")
    .optional(),
  expiry_to: z.string()
    .regex(/^\d{4}-\d{2}-\d{2}$/, "Invalid date format (YYYY-MM-DD)")
    .optional(),
  search: z.string().max(100).optional(),
});
```

### Key Business Rules

1. **LP Warehouse Validation**: LP.warehouse_id must equal TO.from_warehouse_id
2. **LP Product Validation**: LP.product_id must equal TO line.product_id
3. **LP Availability**: LP.available_qty must be >= assigned quantity
4. **Exact Quantity Match (configurable)**: If setting enabled, sum(LP quantities) must equal TO line.quantity
5. **Status Enforcement**: LP assignment only allowed when TO status is DRAFT or PLANNED
6. **Unique Assignment**: Same LP cannot be assigned twice to the same TO line
7. **LP Allocation (optional business rule)**: LP can be partially allocated across multiple TOs if business allows, or fully reserved for one TO
8. **Removal Allowed**: LP assignments can be removed before TO is shipped
9. **Shipping Integration**: Pre-assigned LPs are auto-selected during Ship TO action (Epic 05)
10. **Audit Trail**: LP assignments are preserved after shipping for traceability

## Deliverables

- Migration:
  - `YYYYMMDDHHMMSS_create_to_line_lps.sql` - Create junction table
- API routes:
  - POST `/api/planning/transfer-orders/:id/lines/:lineId/assign-lps`
  - GET `/api/planning/transfer-orders/:id/lines/:lineId/lps`
  - DELETE `/api/planning/transfer-orders/:id/lines/:lineId/lps/:lpId`
  - GET `/api/planning/transfer-orders/:id/lines/:lineId/available-lps`
- Components:
  - `LPPickerModal.tsx` - LP selection interface with filters
  - `TOLineLPAssignments.tsx` - Display LP assignments per line
  - `LPAssignmentBadge.tsx` - Badge showing assignment status
  - Update `TOLineActionsMenu.tsx` - Add "Assign LPs" action
  - Update TO Detail page - Integrate LP assignment display
- Services:
  - `to-lp-service.ts` - All LP assignment business logic
    - `assignLPsToTOLine()`
    - `getAvailableLPsForTOLine()`
    - `removeLPFromTOLine()`
    - `getLPAssignmentsForTOLine()`
    - `validateLPAssignment()`
- Validation:
  - `to-lp-validation.ts` - Zod schemas for LP assignment requests
- Tests:
  - Unit tests for service methods (LP validation, assignment logic)
  - Unit tests for validation schemas
  - Integration tests for API endpoints
  - E2E smoke test: Create TO → Assign LPs → Validate totals → Ship (Epic 05 integration)

## Definition of Done

- [ ] Migration applied successfully creating `to_line_lps` table
- [ ] RLS policy enforces org isolation for LP assignments
- [ ] LP Picker modal implemented with all filters (warehouse, product, lot, expiry)
- [ ] LP assignment API endpoint validates all business rules
- [ ] Available LPs endpoint queries Epic 05 license_plates table correctly
- [ ] LP assignments display on TO Detail page with badges
- [ ] Remove LP functionality works correctly
- [ ] Settings toggle "Require LP Selection" functional
- [ ] Settings sub-toggle "Require Exact Quantity Match" functional
- [ ] Validation prevents:
  - Assigning LP from wrong warehouse
  - Assigning LP with wrong product
  - Assigning more quantity than LP has available
  - Duplicate LP assignments to same line
- [ ] LP assignments block/warn based on settings (exact match requirement)
- [ ] Service methods implement all business rules correctly
- [ ] Zod schemas validate all edge cases
- [ ] Unit tests passing (>80% coverage for service methods)
- [ ] Integration tests passing for all API endpoints
- [ ] E2E smoke test passing (TO with LP assignment full cycle)
- [ ] Integration with Epic 05 verified:
  - Can query license_plates table
  - Can query lp_inventory for available quantities
  - Ship TO action (Epic 05) consumes LP assignments correctly
- [ ] Manual QA completed:
  - Test LP picker filters (lot, expiry, search)
  - Test multi-LP assignment with partial quantities
  - Test exact quantity match validation
  - Test LP removal
  - Test settings toggles (require LP selection, exact match)
  - Test integration with Ship TO action (Epic 05)
- [ ] Performance: LP picker loads available LPs in <500ms
- [ ] Accessibility: Modals keyboard-navigable, ARIA labels present
- [ ] Documentation updated in PRD/Architecture docs
- [ ] Code review approved
- [ ] Merged to main branch

---

## Future Phases (Not in MVP)

### Phase 2
- **FIFO/FEFO Auto-Suggestion**
  - "Suggest LPs" button in LP Picker modal
  - Calls Epic 05 picking service to suggest optimal LPs based on:
    - FIFO: First In First Out (oldest receipt date)
    - FEFO: First Expiry First Out (earliest expiry date)
    - Custom rules (location proximity, lot preference, etc.)
  - Auto-selects and populates LP list
  - User can accept suggestions or override
- **Barcode Scanning for LP Selection**
  - Scan LP barcode using mobile device camera or USB scanner
  - Validate LP in real-time (warehouse, product, availability)
  - Add scanned LP to TO line assignment
  - Mobile-friendly UI for warehouse floor use
- **LP Splitting During Transfer**
  - Split large LP into smaller LPs when transferring partial quantities
  - Example: LP-001 has 1000 units, split into LP-001 (700) and LP-002 (300)
  - Requires LP splitting service in Epic 05
  - Useful for breaking down bulk inventory

### Phase 3
- **Cross-Warehouse LP Visibility**
  - View LPs in all warehouses (not just source warehouse)
  - Enable cross-dock transfers (receive at WH-A, ship from WH-B)
  - Complex allocation logic with multi-hop transfers
  - "Smart Transfer" suggesting optimal path
- **LP Reservation Table**
  - New table: `lp_reservations`
    - lp_id, reserved_qty, reservation_type (TO, WO, SO), reference_id, expires_at
  - Prevent double-allocation of LPs across TOs, WOs, Sales Orders
  - Auto-release reservations on cancellation or expiry
  - Reservation priority rules (SO > WO > TO)
- **LP Allocation Optimization**
  - AI-driven LP selection based on:
    - Expiry optimization (minimize waste)
    - Location optimization (minimize travel distance)
    - Batch consolidation (group same lots)
  - "Optimize LP Selection" button runs algorithm
  - User can review and approve suggested allocation

**Implementation**: Per Epic 03.0 guidance, hide future features. Show "Coming Soon" badge for FIFO/FEFO suggestion and barcode scanning buttons.

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-12-16 | Initial story creation | ARCHITECT-AGENT |
