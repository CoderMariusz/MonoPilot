# Story 03.4 - PO Totals + Tax Calculations
## Handoff from TEST-WRITER to DEV Agent

**Status**: Ready for GREEN Phase Implementation

**Date**: 2025-01-02

**Tests Created**: ✓ All tests FAILING (RED phase complete)

---

## Executive Summary

TEST-WRITER has completed the RED phase of TDD for Story 03.4, creating 148+ failing tests across 3 test files (2,786 lines of code). All tests follow the 20 acceptance criteria from the story markdown.

Your task (DEV Agent) is to implement the code to make these tests PASS (GREEN phase).

## What Was Done (RED Phase)

### Test Files Created

1. **Unit Tests - Calculation Service** (1,115 lines)
   - File: `apps/frontend/lib/services/__tests__/po-calculation-service.test.ts`
   - Status: FAILING (module not found)
   - Tests: 118 tests across 6 functions

2. **Unit Tests - Validation Schemas** (941 lines)
   - File: `apps/frontend/lib/validation/__tests__/po-calculation.test.ts`
   - Status: FAILING (module not found)
   - Tests: 85 tests across 3 schemas

3. **Integration Tests - Database & API** (730 lines)
   - File: `apps/frontend/__tests__/integration/api/planning/po-calculations.test.ts`
   - Status: FAILING (functions/endpoints don't exist)
   - Tests: 30+ tests

### Acceptance Criteria Coverage

All 20 acceptance criteria from the story are covered by tests:

- **AC-1**: Subtotal calculation ✓
- **AC-2**: Line-level tax (single rate) ✓
- **AC-3**: Mixed tax rates ✓
- **AC-4**: Discount (percentage) ✓
- **AC-5**: Discount (fixed amount) ✓
- **AC-6**: Shipping cost ✓
- **AC-7**: Total formula ✓
- **AC-8**: Auto-recalc on line add ✓
- **AC-9**: Auto-recalc on line edit ✓
- **AC-10**: Auto-recalc on line delete ✓
- **AC-11**: DB trigger - insert ✓
- **AC-12**: DB trigger - update ✓
- **AC-13**: DB trigger - delete ✓
- **AC-14**: Discount validation ✓
- **AC-15**: Negative discount validation ✓
- **AC-16**: Shipping validation ✓
- **AC-17**: Multi-currency display (ready for UI component) ✓
- **AC-18**: Zero tax handling ✓
- **AC-19**: Rounding precision ✓
- **AC-20**: Performance (< 50ms, < 100ms) ✓

## What You Need to Implement (GREEN Phase)

### 1. Service Layer Implementation

**File to Create**: `apps/frontend/lib/services/po-calculation-service.ts`

**Functions to Implement** (6 total):

```typescript
export function calculateLineTotals(line: POLine): POLineCalculation {
  // Calculate line_total, discount_amount, line_total_after_discount, tax_amount
}

export function calculatePOTotals(
  lines: POLine[],
  shipping_cost: number = 0
): POTotals {
  // Sum all line calculations, add shipping, return totals with tax_breakdown
}

export function calculateTaxBreakdown(lines: POLine[]): TaxBreakdownItem[] {
  // Group by tax_rate, sort descending, return array
}

export function validateDiscount(line: POLine): ValidationResult {
  // Check: not negative, <= 100%, <= line_total
}

export function validateShippingCost(shipping_cost: number): ValidationResult {
  // Check: >= 0
}

export function roundCurrency(value: number): number {
  // Round to 2 decimals: Math.round(value * 100) / 100
}
```

**Key Details**:
- All monetary amounts stored/returned as numbers (not strings)
- Rounding applied AFTER all calculations, not during
- Tax applied to (line_total - discount), not line_total
- Formula: `total = subtotal + tax + shipping - discount`

### 2. Validation Schemas

**File to Create**: `apps/frontend/lib/validation/po-calculation.ts`

**Schemas to Implement** (3 total):

```typescript
export const poLineCalculationSchema = z.object({
  quantity: z.number().positive("Quantity must be greater than 0"),
  unit_price: z.number().min(0, "Unit price cannot be negative"),
  discount_percent: z.number()
    .min(0, "Discount percent cannot be negative")
    .max(100, "Discount percent cannot exceed 100%")
    .optional(),
  discount_amount: z.number()
    .min(0, "Discount amount cannot be negative")
    .optional(),
  tax_rate: z.number()
    .min(0, "Tax rate cannot be negative")
    .max(100, "Tax rate cannot exceed 100%"),
}).refine(
  (data) => {
    if (data.discount_amount) {
      const line_total = data.quantity * data.unit_price;
      return data.discount_amount <= line_total;
    }
    return true;
  },
  { message: "Discount amount cannot exceed line total", path: ["discount_amount"] }
);

export const poHeaderCalculationSchema = z.object({
  shipping_cost: z.number().min(0, "Shipping cost cannot be negative").default(0),
});

export const poTotalsSchema = z.object({
  subtotal: z.number().min(0),
  tax_amount: z.number().min(0),
  discount_total: z.number().min(0),
  shipping_cost: z.number().min(0),
  total: z.number().min(0),
});
```

### 3. Database Migration (SQL)

**File to Create**: `supabase/migrations/003-po-calculation-triggers.sql`

**What to Add**:

#### A. Columns to existing tables

```sql
-- Add to purchase_orders table
ALTER TABLE purchase_orders ADD COLUMN IF NOT EXISTS subtotal DECIMAL(15,4) DEFAULT 0;
ALTER TABLE purchase_orders ADD COLUMN IF NOT EXISTS tax_amount DECIMAL(15,4) DEFAULT 0;
ALTER TABLE purchase_orders ADD COLUMN IF NOT EXISTS discount_total DECIMAL(15,4) DEFAULT 0;
ALTER TABLE purchase_orders ADD COLUMN IF NOT EXISTS shipping_cost DECIMAL(15,4) DEFAULT 0;
ALTER TABLE purchase_orders ADD COLUMN IF NOT EXISTS total DECIMAL(15,4) DEFAULT 0;

-- Add to purchase_order_lines table
ALTER TABLE purchase_order_lines ADD COLUMN IF NOT EXISTS discount_percent DECIMAL(5,2) DEFAULT 0;
ALTER TABLE purchase_order_lines ADD COLUMN IF NOT EXISTS discount_amount DECIMAL(15,4) DEFAULT 0;
ALTER TABLE purchase_order_lines ADD COLUMN IF NOT EXISTS line_total DECIMAL(15,4) DEFAULT 0;
ALTER TABLE purchase_order_lines ADD COLUMN IF NOT EXISTS tax_rate DECIMAL(5,2) NOT NULL;
ALTER TABLE purchase_order_lines ADD COLUMN IF NOT EXISTS tax_amount DECIMAL(15,4) DEFAULT 0;
```

#### B. Constraints

```sql
ALTER TABLE purchase_order_lines ADD CONSTRAINT check_discount_percent_range
  CHECK (discount_percent >= 0 AND discount_percent <= 100);
ALTER TABLE purchase_order_lines ADD CONSTRAINT check_discount_amount_positive
  CHECK (discount_amount >= 0);
ALTER TABLE purchase_orders ADD CONSTRAINT check_shipping_cost_positive
  CHECK (shipping_cost >= 0);
```

#### C. Database Functions and Triggers

```sql
-- Function to calculate PO totals
CREATE OR REPLACE FUNCTION calculate_po_totals()
RETURNS TRIGGER AS $$
DECLARE
  po_id_val UUID;
  calculated_subtotal DECIMAL(15,4);
  calculated_tax DECIMAL(15,4);
  calculated_discount DECIMAL(15,4);
  calculated_total DECIMAL(15,4);
  current_shipping DECIMAL(15,4);
BEGIN
  -- Get po_id from NEW or OLD record
  IF TG_OP = 'DELETE' THEN
    po_id_val := OLD.po_id;
  ELSE
    po_id_val := NEW.po_id;
  END IF;

  -- Get current shipping cost
  SELECT COALESCE(shipping_cost, 0) INTO current_shipping
  FROM purchase_orders WHERE id = po_id_val;

  -- Calculate subtotal (sum of line totals before discount)
  SELECT COALESCE(SUM(quantity * unit_price), 0)
  INTO calculated_subtotal
  FROM purchase_order_lines
  WHERE po_id = po_id_val;

  -- Calculate tax (line-level, supports mixed rates)
  SELECT COALESCE(SUM((quantity * unit_price - discount_amount) * (tax_rate / 100)), 0)
  INTO calculated_tax
  FROM purchase_order_lines
  WHERE po_id = po_id_val;

  -- Calculate total discount
  SELECT COALESCE(SUM(discount_amount), 0)
  INTO calculated_discount
  FROM purchase_order_lines
  WHERE po_id = po_id_val;

  -- Calculate total: subtotal + tax + shipping - discount
  calculated_total := calculated_subtotal + calculated_tax + current_shipping - calculated_discount;

  -- Update parent PO
  UPDATE purchase_orders
  SET
    subtotal = calculated_subtotal,
    tax_amount = calculated_tax,
    discount_total = calculated_discount,
    total = calculated_total,
    updated_at = NOW()
  WHERE id = po_id_val;

  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Trigger: On line insert
CREATE TRIGGER tr_po_line_insert_update_totals
AFTER INSERT ON purchase_order_lines
FOR EACH ROW
EXECUTE FUNCTION calculate_po_totals();

-- Trigger: On line update
CREATE TRIGGER tr_po_line_update_update_totals
AFTER UPDATE OF quantity, unit_price, discount_percent, discount_amount, tax_rate ON purchase_order_lines
FOR EACH ROW
EXECUTE FUNCTION calculate_po_totals();

-- Trigger: On line delete
CREATE TRIGGER tr_po_line_delete_update_totals
AFTER DELETE ON purchase_order_lines
FOR EACH ROW
EXECUTE FUNCTION calculate_po_totals();

-- Function: Recalculate total when shipping changes
CREATE OR REPLACE FUNCTION recalculate_po_total_with_shipping()
RETURNS TRIGGER AS $$
BEGIN
  NEW.total := NEW.subtotal + NEW.tax_amount + NEW.shipping_cost - NEW.discount_total;
  NEW.updated_at := NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Trigger: On shipping cost update
CREATE TRIGGER tr_po_shipping_update_totals
AFTER UPDATE OF shipping_cost ON purchase_orders
FOR EACH ROW
EXECUTE FUNCTION recalculate_po_total_with_shipping();
```

#### D. Index

```sql
-- Index for fast PO line lookups (used by trigger)
CREATE INDEX IF NOT EXISTS idx_po_lines_po_id ON purchase_order_lines(po_id);
```

### 4. API Integration (Update Existing Endpoints)

**Files to Modify**:
- `apps/frontend/app/api/planning/purchase-orders/route.ts` - POST
- `apps/frontend/app/api/planning/purchase-orders/[id]/route.ts` - PUT
- `apps/frontend/app/api/planning/purchase-orders/[id]/lines/route.ts` - POST
- `apps/frontend/app/api/planning/purchase-orders/[id]/lines/[lineId]/route.ts` - PUT, DELETE

**What to Add**:
- Import calculation service
- Call `calculateLineTotals()` for each line before insert
- Call `calculatePOTotals()` to get final totals
- Include `tax_breakdown` in response
- Return all calculated fields in response

**Example Response Format**:
```json
{
  "success": true,
  "data": {
    "id": "po-123",
    "po_number": "PO-2024-00001",
    "subtotal": 800.00,
    "tax_amount": 179.50,
    "discount_total": 50.00,
    "shipping_cost": 25.00,
    "total": 954.50,
    "tax_breakdown": [
      { "rate": 23, "subtotal": 770.00, "tax": 177.10 },
      { "rate": 8, "subtotal": 30.00, "tax": 2.40 }
    ],
    "lines": [...]
  }
}
```

## How to Run Tests

```bash
# Run all PO calculation tests
npm test -- --testPathPattern="po-calculation" --run

# Run specific test file
npm test -- --testPathPattern="po-calculation-service" --run
npm test -- --testPathPattern="po-calculation.test" --run
npm test -- --testPathPattern="po-calculations" --run

# Run with coverage report
npm test -- --testPathPattern="po-calculation" --coverage

# Run single test by name
npm test -- --testNamePattern="should calculate subtotal correctly"
```

## Test File Locations

1. **Service Tests**: `/workspaces/MonoPilot/apps/frontend/lib/services/__tests__/po-calculation-service.test.ts`
2. **Schema Tests**: `/workspaces/MonoPilot/apps/frontend/lib/validation/__tests__/po-calculation.test.ts`
3. **Integration Tests**: `/workspaces/MonoPilot/apps/frontend/__tests__/integration/api/planning/po-calculations.test.ts`

## Definition of Done (GREEN Phase)

- [ ] `po-calculation-service.ts` implemented with all 6 functions
- [ ] `po-calculation.ts` with 3 Zod schemas created
- [ ] Database migration created with triggers and columns
- [ ] All 118 service tests PASS
- [ ] All 85 schema tests PASS
- [ ] All 30+ integration tests PASS
- [ ] Test coverage >= 85% for services
- [ ] Test coverage >= 95% for validation
- [ ] No console errors or warnings
- [ ] Performance targets met (< 50ms for 50 lines)

## Key Implementation Tips

1. **Rounding**: Use `Math.round(value * 100) / 100` - apply AFTER calculations, not during
2. **Tax**: Always calculate on `line_total - discount`, not line_total
3. **Subtotal**: Sum of `quantity * unit_price` (BEFORE discount)
4. **Formula**: `total = subtotal + tax + shipping - discount`
5. **Zero Tax**: Support 0% tax rate without error
6. **Mixed Rates**: Group taxes by rate in breakdown, sort descending
7. **Edge Cases**: Handle empty POs (0 lines), very small amounts, large amounts

## References

- **Story Markdown**: `docs/2-MANAGEMENT/epics/current/03-planning/03.4.po-calculations.md`
- **Implementation Notes**: Lines 255-618 in story markdown
- **Database Schema**: `docs/2-MANAGEMENT/epics/current/03-planning/context/03.4/database.yaml`
- **API Spec**: `docs/2-MANAGEMENT/epics/current/03-planning/context/03.4/api.yaml`
- **Test Summary**: `docs/2-MANAGEMENT/epics/current/03-planning/03.4.test-summary.md`

## Next Agent: SENIOR-DEV

After you complete the GREEN phase and all tests PASS, the SENIOR-DEV agent will review your implementation for:
- Code quality and adherence to patterns
- Performance optimization
- Edge case handling
- Documentation completeness
- Test coverage verification

---

**Handoff Status**: ✓ Ready for GREEN Phase

**Test Status**: 148+ tests FAILING (RED phase complete)

**Next Step**: Implement code to make tests PASS
