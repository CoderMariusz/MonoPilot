# 03.9a - TO Partial Shipments (Ship/Receive Actions)

**Priority**: P1 (Phase 1)
**Story Points**: S (1-2 days)
**Type:** backend + frontend

**State:** ready
**Primary PRD:** `docs/1-BASELINE/product/modules/planning.md` (FR-PLAN-015)
**Architecture:** `docs/1-BASELINE/architecture/modules/planning.md`
**UX Wireframes:** PLAN-008 (Ship Modal), PLAN-009 (Receive Modal)

---

## MVP Scope

This story implements partial shipment and receiving capabilities for Transfer Orders WITHOUT License Plate (LP) pre-selection. The MVP includes:
- Ship TO action with partial quantity support
- Receive TO action with partial quantity support
- Partial shipment tracking (shipped_qty, received_qty per line)
- Status transitions (draft → planned → shipped/partially_shipped → received/partially_received)
- Ship/Receive modals with progress indicators
- Quantity validation (cannot ship/receive more than ordered)
- Service layer methods for ship/receive operations
- Audit trail (shipped_by, received_by, timestamps)

**Out of MVP:** License Plate pre-selection (deferred to Story 03.9b, requires Epic 05 warehouse LP integration).

---

## Goal

Enable warehouse staff to ship and receive Transfer Orders in multiple shipments, tracking quantities shipped/received per line without requiring License Plate selection.

## User Story

As a **Warehouse Manager**, I want **to ship and receive Transfer Orders in partial quantities** so that **I can handle split shipments when full quantities are not available, improving operational flexibility**.

## Scope

**In scope (this story)**
- Ship TO action (button on TO Detail page)
- Receive TO action (button on TO Detail page)
- Ship TO modal with line-by-line quantity input
- Receive TO modal with line-by-line quantity input
- Partial shipment tracking (shipped_qty, received_qty on transfer_order_lines)
- Status transitions based on quantities:
  - PLANNED → SHIPPED (if all lines fully shipped)
  - PLANNED → PARTIALLY_SHIPPED (if some lines not fully shipped)
  - SHIPPED → RECEIVED (if all lines fully received)
  - SHIPPED → PARTIALLY_RECEIVED (if some lines not fully received)
  - PARTIALLY_SHIPPED → SHIPPED (after additional shipments)
  - PARTIALLY_RECEIVED → RECEIVED (after additional receipts)
- Progress indicators on TO Detail page (e.g., "5/10 units shipped")
- Validation rules:
  - Cannot ship more than ordered quantity
  - Cannot receive more than shipped quantity
  - Cannot ship if status is RECEIVED or CLOSED
  - Cannot receive if status is DRAFT or PLANNED
- Audit fields (shipped_by, received_by, actual_ship_date, actual_receive_date)
- Service methods: `shipTransferOrder()`, `receiveTransferOrder()`
- Zod validation schemas for ship/receive requests
- Tests (unit + integration for ship/receive logic)

**Out of scope (this story)**
- License Plate (LP) pre-selection at TO creation (Story 03.9b - deferred to Epic 05)
- LP picking at shipping (Story 03.9b - requires Epic 05 LP table)
- LP creation at receiving (handled by Epic 05 Warehouse Receiving)
- FIFO/FEFO picking logic (Epic 05)
- Multiple shipments tracking table (future enhancement)
- Shipment documents/packing slips (future enhancement)
- Integration with shipping carriers (future enhancement)

## Dependencies

- **01.1** - Organization context + RLS (required for org_id filtering)
- **01.X** - Warehouses CRUD (required for from/to warehouse validation)
- **02.1** - Products CRUD (required for product_id FK on TO lines)
- **03.8** - TO CRUD + Lines (prerequisite - this story extends TO functionality)

## Acceptance Criteria (Given/When/Then)

### AC-1: Ship TO Modal - Full Shipment

**Given** I am on the TO Detail page with status = PLANNED
**And** the TO has 3 lines:
  - Line 1: Product A, qty = 10, shipped_qty = 0
  - Line 2: Product B, qty = 5, shipped_qty = 0
  - Line 3: Product C, qty = 20, shipped_qty = 0
**When** I click "Ship TO" button
**Then** I should see the Ship TO modal with:
- Modal title: "Ship Transfer Order TO-2024-00001"
- Table showing all lines with columns: Product, Ordered Qty, Previously Shipped, Remaining, Ship Now
- "Ship Now" column with numeric inputs, defaulted to remaining quantities
- "Shipment Date" date picker (defaulted to today)
- "Notes" textarea (optional)
- "Ship All" and "Cancel" buttons

**When** I click "Ship All"
**Then**:
- API POST to `/api/planning/transfer-orders/:id/ship` with body:
  ```json
  {
    "shipment_date": "2024-12-16",
    "lines": [
      { "line_id": "uuid-1", "ship_qty": 10 },
      { "line_id": "uuid-2", "ship_qty": 5 },
      { "line_id": "uuid-3", "ship_qty": 20 }
    ],
    "notes": ""
  }
  ```
- Transfer Order status changes to SHIPPED
- Each line's `shipped_qty` updated:
  - Line 1: shipped_qty = 10
  - Line 2: shipped_qty = 5
  - Line 3: shipped_qty = 20
- TO `actual_ship_date` = "2024-12-16"
- TO `shipped_by` = current user UUID
- Modal closes
- Success toast: "Transfer Order TO-2024-00001 shipped successfully"
- TO Detail page refreshes, showing status badge as SHIPPED

### AC-2: Ship TO Modal - Partial Shipment

**Given** I am on the TO Detail page with status = PLANNED
**And** the TO has 2 lines:
  - Line 1: Product A, qty = 10, shipped_qty = 0
  - Line 2: Product B, qty = 5, shipped_qty = 0
**When** I open the Ship TO modal
**And** I edit "Ship Now" quantities:
  - Line 1: Ship Now = 5 (partial)
  - Line 2: Ship Now = 5 (full)
**And** I click "Ship All"
**Then**:
- Transfer Order status changes to PARTIALLY_SHIPPED
- Line 1: shipped_qty = 5 (remaining = 5)
- Line 2: shipped_qty = 5 (remaining = 0)
- TO Detail page shows:
  - Status badge: PARTIALLY_SHIPPED (orange)
  - Line 1 progress: "5 / 10 shipped" with progress bar
  - Line 2 progress: "5 / 5 shipped" with green checkmark
- "Ship TO" button remains enabled for additional shipments

### AC-3: Ship TO Modal - Second Partial Shipment

**Given** I am on the TO Detail page with status = PARTIALLY_SHIPPED
**And** the TO has 2 lines:
  - Line 1: Product A, qty = 10, shipped_qty = 5, remaining = 5
  - Line 2: Product B, qty = 5, shipped_qty = 5, remaining = 0
**When** I open the Ship TO modal
**Then** I should see:
- Line 1: Ordered = 10, Previously Shipped = 5, Remaining = 5, Ship Now = 5 (defaulted)
- Line 2: Ordered = 5, Previously Shipped = 5, Remaining = 0, Ship Now = 0 (disabled)

**When** I click "Ship All"
**Then**:
- Line 1: shipped_qty = 10 (5 + 5)
- Transfer Order status changes to SHIPPED (all lines fully shipped)
- Success toast: "Transfer Order TO-2024-00001 shipped successfully"

### AC-4: Ship TO Modal - Validation

**Given** I am on the Ship TO modal
**And** Line 1 has qty = 10, shipped_qty = 0
**When** I enter "Ship Now" = 11 (exceeds ordered quantity)
**And** I click "Ship All"
**Then**:
- API returns 400 error: "Line 1: Cannot ship 11 units, only 10 ordered"
- Error toast displayed
- Modal remains open with validation error shown below input field

**Given** Line 1 has qty = 10, shipped_qty = 5
**When** I enter "Ship Now" = 6 (exceeds remaining quantity)
**Then**:
- API returns 400 error: "Line 1: Cannot ship 6 units, only 5 remaining"

**Given** all "Ship Now" quantities are 0
**When** I click "Ship All"
**Then**:
- API returns 400 error: "At least one line must have quantity > 0"

### AC-5: Receive TO Modal - Full Receipt

**Given** I am on the TO Detail page with status = SHIPPED
**And** the TO has 2 lines:
  - Line 1: Product A, qty = 10, shipped_qty = 10, received_qty = 0
  - Line 2: Product B, qty = 5, shipped_qty = 5, received_qty = 0
**When** I click "Receive TO" button
**Then** I should see the Receive TO modal with:
- Modal title: "Receive Transfer Order TO-2024-00001"
- Table showing all lines with columns: Product, Shipped Qty, Previously Received, Remaining, Receive Now
- "Receive Now" column with numeric inputs, defaulted to remaining quantities
- "Receipt Date" date picker (defaulted to today)
- "Notes" textarea (optional)
- "Receive All" and "Cancel" buttons

**When** I click "Receive All"
**Then**:
- API POST to `/api/planning/transfer-orders/:id/receive` with body:
  ```json
  {
    "receipt_date": "2024-12-16",
    "lines": [
      { "line_id": "uuid-1", "receive_qty": 10 },
      { "line_id": "uuid-2", "receive_qty": 5 }
    ],
    "notes": ""
  }
  ```
- Transfer Order status changes to RECEIVED
- Each line's `received_qty` updated:
  - Line 1: received_qty = 10
  - Line 2: received_qty = 5
- TO `actual_receive_date` = "2024-12-16"
- TO `received_by` = current user UUID
- Modal closes
- Success toast: "Transfer Order TO-2024-00001 received successfully"

### AC-6: Receive TO Modal - Partial Receipt

**Given** I am on the TO Detail page with status = SHIPPED
**And** the TO has 2 lines:
  - Line 1: Product A, shipped_qty = 10, received_qty = 0
  - Line 2: Product B, shipped_qty = 5, received_qty = 0
**When** I open the Receive TO modal
**And** I edit "Receive Now" quantities:
  - Line 1: Receive Now = 5 (partial)
  - Line 2: Receive Now = 5 (full)
**And** I click "Receive All"
**Then**:
- Transfer Order status changes to PARTIALLY_RECEIVED
- Line 1: received_qty = 5 (remaining = 5)
- Line 2: received_qty = 5 (remaining = 0)
- TO Detail page shows:
  - Status badge: PARTIALLY_RECEIVED (blue)
  - Line 1 progress: "5 / 10 received" with progress bar
  - Line 2 progress: "5 / 5 received" with green checkmark
- "Receive TO" button remains enabled for additional receipts

### AC-7: Receive TO Modal - Validation

**Given** I am on the Receive TO modal
**And** Line 1 has shipped_qty = 10, received_qty = 0
**When** I enter "Receive Now" = 11 (exceeds shipped quantity)
**And** I click "Receive All"
**Then**:
- API returns 400 error: "Line 1: Cannot receive 11 units, only 10 shipped"
- Error toast displayed

**Given** Line 1 has shipped_qty = 10, received_qty = 5
**When** I enter "Receive Now" = 6 (exceeds remaining quantity)
**Then**:
- API returns 400 error: "Line 1: Cannot receive 6 units, only 5 remaining"

**Given** all "Receive Now" quantities are 0
**When** I click "Receive All"
**Then**:
- API returns 400 error: "At least one line must have quantity > 0"

### AC-8: Status-Based Action Visibility

**Given** I am on the TO Detail page
**Then** I should see action buttons based on status:

| Status | Ship TO Button | Receive TO Button |
|--------|----------------|-------------------|
| DRAFT | Hidden | Hidden |
| PLANNED | Visible | Hidden |
| PARTIALLY_SHIPPED | Visible | Visible (if any shipped qty > received qty) |
| SHIPPED | Hidden | Visible |
| PARTIALLY_RECEIVED | Hidden | Visible |
| RECEIVED | Hidden | Hidden |
| CLOSED | Hidden | Hidden |
| CANCELLED | Hidden | Hidden |

### AC-9: Progress Indicators on TO Detail Page

**Given** I am viewing a TO with status = PARTIALLY_SHIPPED
**And** Line 1: qty = 10, shipped_qty = 5, received_qty = 0
**Then** I should see on the TO Lines table:
- Column "Shipped" with value: "5 / 10" and progress bar at 50%
- Column "Received" with value: "0 / 5" (shows received vs shipped, not vs ordered)

**Given** status = PARTIALLY_RECEIVED
**And** Line 1: qty = 10, shipped_qty = 10, received_qty = 5
**Then** I should see:
- Column "Shipped" with value: "10 / 10" and green checkmark
- Column "Received" with value: "5 / 10" and progress bar at 50%

### AC-10: Settings Toggle for Partial Shipments

**Given** I am on Planning Settings page
**Then** I should see toggle:
- Label: "Allow Partial Shipments"
- Description: "Enable shipping and receiving Transfer Orders in multiple batches"
- Default: Enabled (true)

**Given** the toggle is DISABLED
**When** I open the Ship TO modal
**Then**:
- All "Ship Now" fields are locked to ordered quantities (cannot be edited)
- Modal shows message: "Partial shipments disabled. All lines must be shipped in full."
- Only full shipment is allowed

### AC-11: Future Features (Phase 2+)

Features deferred to future phases:
- **License Plate Pre-Selection** (Story 03.9b - Phase 1, after Epic 05)
  - Select specific LPs at TO creation
  - System validates LP availability
  - LPs auto-selected at shipping
- **Shipment Documents** (Phase 2)
  - Generate packing slips
  - Print shipping labels
  - Track shipment numbers
- **Multiple Shipments Tracking Table** (Phase 2)
  - New table: `to_shipments` with shipment_number, shipment_date, lines
  - Track each shipment as separate entity
  - Shipment history timeline
- **Carrier Integration** (Phase 3)
  - Integration with UPS, FedEx, DHL APIs
  - Real-time tracking updates
  - Auto-update TO status from carrier events

**Implementation**: Per Epic 03.0 guidance, hide future features. LP Pre-selection UI can show "Coming Soon" badge.

## Implementation Notes

### API Endpoints

```typescript
// Ship Transfer Order
POST /api/planning/transfer-orders/:id/ship
Request Body:
{
  shipment_date: string (ISO date)
  lines: Array<{
    line_id: string (UUID)
    ship_qty: number
  }>
  notes?: string
}
Response: 200 OK
{
  success: true
  transfer_order: TransferOrder
  message: "Transfer Order TO-2024-00001 shipped successfully"
}

// Receive Transfer Order
POST /api/planning/transfer-orders/:id/receive
Request Body:
{
  receipt_date: string (ISO date)
  lines: Array<{
    line_id: string (UUID)
    receive_qty: number
  }>
  notes?: string
}
Response: 200 OK
{
  success: true
  transfer_order: TransferOrder
  message: "Transfer Order TO-2024-00001 received successfully"
}

// Validation errors return 400 with error details
Response: 400 Bad Request
{
  success: false
  error: string
  validation_errors?: Array<{
    line_id: string
    field: string
    message: string
  }>
}
```

### Database

**Tables used (from architecture doc):**

```sql
-- transfer_orders table (existing, no changes needed)
-- Columns used for ship/receive:
--   actual_ship_date    DATE
--   actual_receive_date DATE
--   status              TEXT
--   shipped_by          UUID REFERENCES users(id)
--   received_by         UUID REFERENCES users(id)

-- transfer_order_lines table (existing, no changes needed)
-- Columns used for partial tracking:
--   shipped_qty         DECIMAL(15,4) DEFAULT 0
--   received_qty        DECIMAL(15,4) DEFAULT 0
--   quantity            DECIMAL(15,4) NOT NULL

-- planning_settings table (existing, no changes needed)
-- Column used:
--   to_allow_partial_shipments  BOOLEAN DEFAULT true
```

**No new migrations needed** - all required fields already exist in schema.

**Status Transition Logic:**

```typescript
// After ship operation, determine new status
function determineStatusAfterShip(lines: TOLine[]): TOStatus {
  const allLinesFullyShipped = lines.every(line =>
    line.shipped_qty >= line.quantity
  );

  if (allLinesFullyShipped) {
    return 'shipped';
  } else {
    return 'partially_shipped';
  }
}

// After receive operation, determine new status
function determineStatusAfterReceive(lines: TOLine[]): TOStatus {
  const allLinesFullyReceived = lines.every(line =>
    line.received_qty >= line.shipped_qty
  );

  if (allLinesFullyReceived) {
    return 'received';
  } else {
    return 'partially_received';
  }
}
```

### Frontend Components

```
app/(authenticated)/planning/transfer-orders/
  [id]/
    page.tsx                        -- TO Detail page (extends 03.8)
    components/
      ShipTOModal.tsx               -- NEW: Ship TO modal
      ReceiveTOModal.tsx            -- NEW: Receive TO modal
      TOLineProgressBar.tsx         -- NEW: Progress indicator component
      TOActionsMenu.tsx             -- UPDATE: Add ship/receive actions
```

**Component Structure:**

```typescript
// ShipTOModal.tsx
interface ShipTOModalProps {
  transferOrder: TransferOrder;
  lines: TransferOrderLine[];
  onClose: () => void;
  onSuccess: () => void;
}

interface ShipLineInput {
  line_id: string;
  ship_qty: number;
  remaining_qty: number; // quantity - shipped_qty
}

// ReceiveTOModal.tsx
interface ReceiveTOModalProps {
  transferOrder: TransferOrder;
  lines: TransferOrderLine[];
  onClose: () => void;
  onSuccess: () => void;
}

interface ReceiveLineInput {
  line_id: string;
  receive_qty: number;
  remaining_qty: number; // shipped_qty - received_qty
}
```

### Services

```typescript
// lib/services/transfer-order-service.ts

export async function shipTransferOrder(
  toId: string,
  shipmentData: {
    shipment_date: string;
    lines: Array<{ line_id: string; ship_qty: number }>;
    notes?: string;
  }
): Promise<{ success: boolean; transfer_order?: TransferOrder; error?: string }> {
  // 1. Validate TO exists and belongs to org
  // 2. Validate TO status is PLANNED or PARTIALLY_SHIPPED
  // 3. Validate each line:
  //    - line_id exists in TO
  //    - ship_qty > 0
  //    - shipped_qty + ship_qty <= quantity
  // 4. Check settings: to_allow_partial_shipments
  //    - If false, validate all lines are fully shipped
  // 5. Update transfer_order_lines.shipped_qty (increment)
  // 6. Update transfer_orders:
  //    - actual_ship_date (if first shipment)
  //    - shipped_by (current user)
  //    - status (call determineStatusAfterShip)
  //    - updated_at
  // 7. Return updated TO
}

export async function receiveTransferOrder(
  toId: string,
  receiptData: {
    receipt_date: string;
    lines: Array<{ line_id: string; receive_qty: number }>;
    notes?: string;
  }
): Promise<{ success: boolean; transfer_order?: TransferOrder; error?: string }> {
  // 1. Validate TO exists and belongs to org
  // 2. Validate TO status is SHIPPED, PARTIALLY_SHIPPED, or PARTIALLY_RECEIVED
  // 3. Validate each line:
  //    - line_id exists in TO
  //    - receive_qty > 0
  //    - received_qty + receive_qty <= shipped_qty
  // 4. Check settings: to_allow_partial_shipments
  //    - If false, validate all lines are fully received
  // 5. Update transfer_order_lines.received_qty (increment)
  // 6. Update transfer_orders:
  //    - actual_receive_date (if first receipt)
  //    - received_by (current user)
  //    - status (call determineStatusAfterReceive)
  //    - updated_at
  // 7. Return updated TO
}

export function calculateLineShipProgress(line: TransferOrderLine): {
  shipped: number;
  total: number;
  percent: number;
  remaining: number;
} {
  return {
    shipped: line.shipped_qty,
    total: line.quantity,
    percent: (line.shipped_qty / line.quantity) * 100,
    remaining: line.quantity - line.shipped_qty,
  };
}

export function calculateLineReceiveProgress(line: TransferOrderLine): {
  received: number;
  total: number; // shipped_qty, not quantity
  percent: number;
  remaining: number;
} {
  return {
    received: line.received_qty,
    total: line.shipped_qty,
    percent: line.shipped_qty > 0
      ? (line.received_qty / line.shipped_qty) * 100
      : 0,
    remaining: line.shipped_qty - line.received_qty,
  };
}
```

### Validation (Zod)

```typescript
// lib/validation/transfer-order-validation.ts

const ShipLineSchema = z.object({
  line_id: z.string().uuid(),
  ship_qty: z.number()
    .positive("Ship quantity must be greater than 0")
    .max(99999.9999, "Ship quantity too large"),
});

export const ShipTORequestSchema = z.object({
  shipment_date: z.string()
    .regex(/^\d{4}-\d{2}-\d{2}$/, "Invalid date format (YYYY-MM-DD)")
    .refine(date => new Date(date) <= new Date(), {
      message: "Shipment date cannot be in the future",
    }),
  lines: z.array(ShipLineSchema)
    .min(1, "At least one line must be shipped")
    .refine(lines => lines.some(l => l.ship_qty > 0), {
      message: "At least one line must have quantity > 0",
    }),
  notes: z.string().max(1000).optional(),
});

const ReceiveLineSchema = z.object({
  line_id: z.string().uuid(),
  receive_qty: z.number()
    .positive("Receive quantity must be greater than 0")
    .max(99999.9999, "Receive quantity too large"),
});

export const ReceiveTORequestSchema = z.object({
  receipt_date: z.string()
    .regex(/^\d{4}-\d{2}-\d{2}$/, "Invalid date format (YYYY-MM-DD)")
    .refine(date => new Date(date) <= new Date(), {
      message: "Receipt date cannot be in the future",
    }),
  lines: z.array(ReceiveLineSchema)
    .min(1, "At least one line must be received")
    .refine(lines => lines.some(l => l.receive_qty > 0), {
      message: "At least one line must have quantity > 0",
    }),
  notes: z.string().max(1000).optional(),
});
```

### Key Business Rules

1. **Ship Quantity Validation**: `shipped_qty + ship_qty <= quantity`
2. **Receive Quantity Validation**: `received_qty + receive_qty <= shipped_qty`
3. **Status Transitions**:
   - PLANNED → PARTIALLY_SHIPPED (if any line not fully shipped)
   - PLANNED → SHIPPED (if all lines fully shipped)
   - PARTIALLY_SHIPPED → SHIPPED (after additional shipments complete all lines)
   - SHIPPED → PARTIALLY_RECEIVED (if any line not fully received)
   - SHIPPED → RECEIVED (if all lines fully received)
   - PARTIALLY_RECEIVED → RECEIVED (after additional receipts complete all lines)
4. **Action Availability**:
   - Ship action: available when status = PLANNED or PARTIALLY_SHIPPED
   - Receive action: available when status = SHIPPED, PARTIALLY_SHIPPED (if any line has shipped_qty > 0), or PARTIALLY_RECEIVED
5. **Settings Override**: If `to_allow_partial_shipments = false`, all lines must be shipped/received in full
6. **Audit Trail**: Track shipped_by, received_by, actual_ship_date, actual_receive_date
7. **Idempotency**: Multiple ship/receive operations accumulate quantities (increment, not replace)

## Deliverables

- API routes:
  - POST `/api/planning/transfer-orders/:id/ship`
  - POST `/api/planning/transfer-orders/:id/receive`
- Components:
  - `ShipTOModal.tsx` - Ship TO modal with line qty inputs
  - `ReceiveTOModal.tsx` - Receive TO modal with line qty inputs
  - `TOLineProgressBar.tsx` - Progress indicator component
  - Update `TOActionsMenu.tsx` - Add ship/receive actions
  - Update TO Detail page - Show progress indicators
- Services:
  - `shipTransferOrder()` - Ship TO service method
  - `receiveTransferOrder()` - Receive TO service method
  - `calculateLineShipProgress()` - Calculate ship progress
  - `calculateLineReceiveProgress()` - Calculate receive progress
- Validation:
  - `ShipTORequestSchema` - Zod schema for ship request
  - `ReceiveTORequestSchema` - Zod schema for receive request
- Tests:
  - Unit tests for service methods (ship/receive logic)
  - Unit tests for validation schemas
  - Integration tests for API endpoints
  - E2E smoke test: Create TO → Ship partial → Ship remaining → Receive partial → Receive remaining

## Definition of Done

- [ ] API endpoints implemented with proper validation
- [ ] Ship TO modal component created with line qty inputs
- [ ] Receive TO modal component created with line qty inputs
- [ ] Progress indicators displayed on TO Detail page
- [ ] Status transitions working correctly based on quantities
- [ ] Service methods implement all business rules
- [ ] Zod schemas validate all edge cases
- [ ] Settings toggle for partial shipments functional
- [ ] Action buttons show/hide based on TO status
- [ ] Audit fields (shipped_by, received_by, timestamps) populated correctly
- [ ] Unit tests passing (>80% coverage for service methods)
- [ ] Integration tests passing for ship/receive endpoints
- [ ] E2E smoke test passing (full TO lifecycle)
- [ ] Manual QA completed:
  - Test full shipment → full receipt
  - Test partial shipment → complete shipment → partial receipt → complete receipt
  - Test validation errors (exceed quantity, zero quantity, etc.)
  - Test settings toggle (disable partial shipments)
  - Test status badge colors and progress bars
- [ ] Performance: Ship/receive operations complete in <500ms
- [ ] Accessibility: Modals keyboard-navigable, ARIA labels present
- [ ] Documentation updated in PRD (if needed)
- [ ] Code review approved
- [ ] Merged to main branch

---

## Future Phases (Not in MVP)

### Phase 1 (After Epic 05)
- **Story 03.9b: TO LP Pre-Selection**
  - Select specific License Plates at TO creation
  - LP availability validation
  - Auto-pick selected LPs at shipping
  - Update `to_line_lps` junction table
  - Integration with Epic 05 Warehouse LP table

### Phase 2
- **Multiple Shipments Tracking**
  - New table: `to_shipments` (id, to_id, shipment_number, shipment_date, notes)
  - New table: `to_shipment_lines` (id, shipment_id, to_line_id, shipped_qty)
  - Shipment history timeline on TO Detail page
  - Print/export shipment documents
- **Packing Slips and Labels**
  - Generate packing slip PDF
  - Print shipping labels with GS1-128 barcodes
  - Attach documents to TO record
- **Over/Under Receipt Handling**
  - Allow receiving more or less than shipped
  - Variance tracking and approval workflow
  - Automatic TO adjustment or new TO creation

### Phase 3
- **Carrier Integration**
  - Integration with UPS, FedEx, DHL APIs
  - Generate shipping labels via API
  - Track shipments in real-time
  - Auto-update TO status from carrier webhooks
  - Estimated delivery date calculation
- **Advanced Routing**
  - Multi-stop shipments (Warehouse A → B → C)
  - Consolidation of multiple TOs into single shipment
  - Route optimization
- **Shipment Costing**
  - Track shipping costs per TO
  - Allocate costs to products/departments
  - Freight billing integration

**Implementation**: See Epic 03.0 "Future Feature Handling" section. Show "Coming Soon" badges for LP Pre-selection in Phase 1.

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-12-16 | Initial story creation | TECH-WRITER |
