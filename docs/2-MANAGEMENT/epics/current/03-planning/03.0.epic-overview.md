# Epic 03 - Planning Module (Suppliers, POs, TOs, WOs)

**Epic ID:** 03
**Module:** Planning
**Status:** STORIES IN DEVELOPMENT
**Type:** Core Module (Operational Backbone)
**Primary References:**
- PRD: `docs/1-BASELINE/product/modules/planning.md`
- Architecture: `docs/1-BASELINE/architecture/modules/planning.md`
- Story Brief: `docs/2-MANAGEMENT/epics/current/03-planning/03.0.story-creation-brief.md`

---

## Goal

Deliver the **Planning Module** providing complete procurement, production scheduling, and inventory transfer management. This module establishes:

- **Suppliers** - Vendor master data with product assignments
- **Purchase Orders (PO)** - Procurement lifecycle with optional approval workflow
- **Transfer Orders (TO)** - Inter-warehouse inventory movements
- **Work Orders (WO)** - Production scheduling with BOM snapshots and routing operations
- **Planning Dashboard** - Real-time visibility into orders and alerts
- **Planning Settings** - Configurable statuses, approval rules, and module behavior

This epic provides the **operational foundation** connecting Technical (Epic 02) to Production (Epic 04) and Warehouse (Epic 05).

---

## Module Scope

### Phase 1 - MVP (This Epic)

| Feature Area | FRs | Stories | Enables |
|--------------|-----|---------|---------|
| Suppliers | FR-001 to FR-004 | 03.1, 03.2 | PO supplier selection |
| Purchase Orders | FR-005 to FR-010 | 03.3, 03.4 | Epic 05 PO Receiving |
| Transfer Orders | FR-012 to FR-014 | 03.8 | Epic 05 TO Ship/Receive |
| Work Orders | FR-017 to FR-020 | 03.10, 03.11a, 03.12 | Epic 04 Production |
| Dashboard | - | 03.15 | Operations visibility |
| Settings | - | 03.16 | Module configuration |

### Phase 1 - Post-MVP

| Feature Area | FRs | Stories | Notes |
|--------------|-----|---------|-------|
| PO Approval Workflow | FR-009, FR-011 | 03.5a, 03.5b, 03.6 | Should Have |
| TO Partial Shipments | FR-015 | 03.9a | Should Have |
| WO Configurable Statuses | FR-023 | 03.17 | Should Have |

### Phase 2 - After Epic 05

| Feature Area | FRs | Stories | Notes |
|--------------|-----|---------|-------|
| TO LP Pre-Selection | FR-016 | 03.9b | Requires LP table |
| WO Material Reservation | FR-025 | 03.11b | Requires LP table |
| WO Material Availability | FR-021 | 03.13 | Requires LP table |
| WO Gantt Chart | FR-024 | 03.14 | Complex visualization |

### Out of Scope (Epic 03b - Phase 2)

| Feature Area | FRs | Notes |
|--------------|-----|-------|
| Demand Forecasting | FR-030 to FR-033 | Phase 2 |
| MRP/MPS | FR-034 to FR-037 | Phase 2 |
| Auto-Replenishment | FR-038 to FR-040 | Phase 2 |
| PO Templates | FR-041, FR-042 | Phase 2 |

### Out of Scope (Phase 3)

| Feature Area | FRs | Notes |
|--------------|-----|-------|
| Supplier Quality Management | FR-050 to FR-052 | Phase 3 |
| Capacity Planning | FR-060 to FR-062 | Phase 3 |
| EDI Integration | FR-070 to FR-072 | Phase 3 |

---

## External Dependencies (Cross-Epic)

### Required from Epic 01 (Settings)

| Dependency | Story | What It Provides | Status |
|------------|-------|------------------|--------|
| `organizations` table | 01.1 | Multi-tenancy foundation | **REQUIRED** |
| `users` table | 01.1 | Audit fields, approvers | **REQUIRED** |
| `roles` table | 01.1 | RBAC for approval workflow | **REQUIRED** |
| Base RLS policies | 01.1 | org_id isolation | **REQUIRED** |
| `warehouses` table | 01.X | PO receiving, TO source/dest | **REQUIRED** |
| `tax_codes` table | 01.X | Supplier/PO tax calculation | **REQUIRED** |
| `production_lines` table | 01.X | WO line assignment | OPTIONAL |
| `machines` table | 01.X | WO/operation machine assignment | OPTIONAL |

### Required from Epic 02 (Technical)

| Dependency | Story | What It Provides | Status |
|------------|-------|------------------|--------|
| `products` table | 02.1 | Supplier-products, PO lines, TO lines, WO | **REQUIRED** |
| `boms` table | 02.4 | WO BOM selection | **REQUIRED** |
| `bom_items` table | 02.5a | WO materials snapshot | **REQUIRED** |
| `routings` table | 02.7 | WO routing selection | OPTIONAL |
| `routing_operations` table | 02.8 | WO operations copy | OPTIONAL |

### Planning Required By (Downstream)

| Module | What Planning Provides |
|--------|------------------------|
| **Production (Epic 04)** | Work Orders for execution, wo_materials, wo_operations |
| **Warehouse (Epic 05)** | PO for receiving, TO for ship/receive |
| **Quality (Epic 06)** | Supplier data for inspections |
| **Finance (Epic 09)** | PO data for invoice matching |

---

## Future Feature Handling

This section provides standard guidance for handling Phase 1+ features across all Epic 03 stories.

### General Principles

1. **MVP First**: Each story implements P0 (MVP) scope only
2. **No Silent Omissions**: Future features are documented, not forgotten
3. **Developer Clarity**: Clear code patterns for deferred features
4. **User Communication**: Appropriate UI feedback for unavailable features

### UI Pattern Options

Choose based on feature visibility:

#### Option A: Hide Completely (Recommended for MVP)
```typescript
// Feature not visible to users - cleanest MVP experience
{/* Phase 1: PO Approval Workflow
<Button onClick={handleApprove}>Approve PO</Button>
*/}
```

#### Option B: Show as "Coming Soon"
```typescript
// For visible but unavailable features
<Button disabled variant="outline">
  Material Reservation
  <Badge variant="secondary" className="ml-2">Coming Soon</Badge>
</Button>
```

### Backend Pattern

```typescript
// API endpoint stub for future feature
// POST /api/planning/work-orders/:id/reserve-materials
export async function POST(req: Request) {
  return NextResponse.json(
    {
      error: 'FEATURE_NOT_AVAILABLE',
      message: 'Material reservation will be available in Phase 2',
      phase: 2
    },
    { status: 501 } // Not Implemented
  );
}
```

---

## Story Index

### MVP Stories (P0 - Must Have)

| Story | Name | PRD FRs | Complexity | Status |
|------:|------|---------|------------|--------|
| 03.1 | Suppliers CRUD | FR-001, FR-004 | M | TO CREATE |
| 03.2 | Supplier-Product Assignment | FR-002, FR-003 | M | TO CREATE |
| 03.3 | PO CRUD + Lines | FR-005, FR-006, FR-007, FR-010 | L | TO CREATE |
| 03.4 | Bulk PO Creation | FR-008 | M | TO CREATE |
| 03.8 | TO CRUD + Lines | FR-012, FR-013, FR-014 | L | TO CREATE |
| 03.10 | WO CRUD + BOM Auto-Select | FR-017, FR-018 | L | TO CREATE |
| 03.11a | WO Materials (BOM Snapshot) | FR-019 | L | TO CREATE |
| 03.12 | WO Operations Copy | FR-020 | M | TO CREATE |
| 03.15 | Planning Dashboard | - | M | TO CREATE |
| 03.16 | Planning Settings | - | M | TO CREATE |

**Total MVP Stories:** 10
**Estimated Effort:** 14-18 days (1 developer)

### Phase 1 Stories (P1 - Should Have)

| Story | Name | PRD FRs | Complexity | Status |
|------:|------|---------|------------|--------|
| 03.5a | PO Approval Setup | FR-009 (partial) | S | TO CREATE |
| 03.5b | PO Approval Workflow | FR-009 | M | TO CREATE |
| 03.6 | Configurable PO Statuses | FR-011 | M | TO CREATE |
| 03.9a | TO Partial Shipments | FR-015 | S | TO CREATE |
| 03.17 | Configurable WO Statuses | FR-023 | M | TO CREATE |

**Total Phase 1 Stories:** 5
**Estimated Effort:** 6-8 days (1 developer)

### Deferred Stories (Requires Epic 05)

| Story | Name | PRD FRs | Complexity | Status |
|------:|------|---------|------------|--------|
| 03.9b | TO LP Pre-Selection | FR-016 | M | DEFERRED |
| 03.11b | WO Material Reservation | FR-025 | M | DEFERRED |
| 03.13 | WO Material Availability Check | FR-021 | M | DEFERRED |
| 03.14 | WO Gantt Chart View | FR-024 | L | DEFERRED |

**Total Deferred Stories:** 4
**Estimated Effort:** 10-14 days (1 developer)

---

## Story Dependency Graph

```
Epic 01.1 (Org Context + RLS)
    |
    +---> Epic 01.X (Warehouses, Tax Codes)
    |           |
    |           v
    +---> 03.16 (Planning Settings)
    |           |
    |           +---> 03.1 (Suppliers CRUD)
    |           |       |
    |           |       +---> 03.2 (Supplier-Products) <---- 02.1 (Products)
    |           |       |       |
    |           |       |       +---> 03.3 (PO CRUD + Lines)
    |           |       |       |       |
    |           |       |       |       +---> 03.4 (Bulk PO Creation)
    |           |       |       |       |
    |           |       |       |       +---> 03.5a (PO Approval Setup)
    |           |       |       |               |
    |           |       |       |               +---> 03.5b (PO Approval Workflow)
    |           |       |       |
    |           |       |       +---> 03.6 (Configurable Statuses)
    |           |       |
    |           +---> 03.8 (TO CRUD + Lines) <---- 02.1 (Products)
    |           |       |
    |           |       +---> 03.9a (Partial Shipments)
    |           |       |
    |           |       +---> 03.9b (LP Pre-Selection) [DEFERRED - needs Epic 05]
    |           |
    +---> 03.10 (WO CRUD + BOM Auto) <---- 02.4 (BOMs), 02.7 (Routings)
    |           |
    |           +---> 03.11a (WO Materials - BOM Snapshot) <---- 02.5a (BOM Items)
    |           |       |
    |           |       +---> 03.11b (Material Reservation) [DEFERRED - needs Epic 05]
    |           |       |
    |           |       +---> 03.13 (Material Availability) [DEFERRED - needs Epic 05]
    |           |
    |           +---> 03.12 (WO Operations Copy) <---- 02.8 (Routing Operations)
    |           |
    |           +---> 03.14 (Gantt Chart) [DEFERRED - Phase 2]
    |           |
    |           +---> 03.17 (Configurable WO Statuses)
    |
    +---> 03.15 (Planning Dashboard) <---- 03.3, 03.8, 03.10
```

---

## PRD Requirements Coverage

### Suppliers (FR-PLAN-001 to FR-PLAN-004)

| FR ID | Requirement | Story | Status |
|-------|-------------|-------|--------|
| FR-PLAN-001 | Supplier CRUD | 03.1 | TO CREATE |
| FR-PLAN-002 | Supplier-Product Assignment | 03.2 | TO CREATE |
| FR-PLAN-003 | Default Supplier per Product | 03.2 | TO CREATE |
| FR-PLAN-004 | Product Lead Time Management | 03.2 | TO CREATE |

### Purchase Orders (FR-PLAN-005 to FR-PLAN-011)

| FR ID | Requirement | Story | Status |
|-------|-------------|-------|--------|
| FR-PLAN-005 | PO CRUD | 03.3 | TO CREATE |
| FR-PLAN-006 | PO Line Management | 03.3 | TO CREATE |
| FR-PLAN-007 | PO Status Lifecycle | 03.3 | TO CREATE |
| FR-PLAN-008 | Bulk PO Creation | 03.4 | TO CREATE |
| FR-PLAN-009 | PO Approval Workflow | 03.5a, 03.5b | TO CREATE |
| FR-PLAN-010 | PO Totals Calculation | 03.3 | TO CREATE |
| FR-PLAN-011 | Configurable PO Statuses | 03.6 | TO CREATE |

### Transfer Orders (FR-PLAN-012 to FR-PLAN-016)

| FR ID | Requirement | Story | Status |
|-------|-------------|-------|--------|
| FR-PLAN-012 | TO CRUD | 03.8 | TO CREATE |
| FR-PLAN-013 | TO Line Management | 03.8 | TO CREATE |
| FR-PLAN-014 | TO Status Lifecycle | 03.8 | TO CREATE |
| FR-PLAN-015 | Partial Shipments | 03.9a | TO CREATE |
| FR-PLAN-016 | LP Selection for TO | 03.9b | **DEFERRED** |

### Work Orders (FR-PLAN-017 to FR-PLAN-025)

| FR ID | Requirement | Story | Status |
|-------|-------------|-------|--------|
| FR-PLAN-017 | WO CRUD | 03.10 | TO CREATE |
| FR-PLAN-018 | BOM Auto-Selection | 03.10 | TO CREATE |
| FR-PLAN-019 | BOM Snapshot (wo_materials) | 03.11a | TO CREATE |
| FR-PLAN-020 | Routing Copy (wo_operations) | 03.12 | TO CREATE |
| FR-PLAN-021 | Material Availability Check | 03.13 | **DEFERRED** |
| FR-PLAN-022 | WO Status Lifecycle | 03.10 | TO CREATE |
| FR-PLAN-023 | Configurable WO Statuses | 03.17 | TO CREATE |
| FR-PLAN-024 | WO Gantt Chart View | 03.14 | **DEFERRED** |
| FR-PLAN-025 | Material Reservation | 03.11b | **DEFERRED** |

---

## Database Tables (Created in Epic 03)

| Table | Action | Story | Notes |
|-------|--------|-------|-------|
| `suppliers` | Create | 03.1 | Vendor master data |
| `supplier_products` | Create | 03.2 | Supplier-product assignments |
| `purchase_orders` | Create | 03.3 | PO headers |
| `purchase_order_lines` | Create | 03.3 | PO line items |
| `transfer_orders` | Create | 03.8 | TO headers |
| `transfer_order_lines` | Create | 03.8 | TO line items |
| `to_line_lps` | Create | 03.9b | TO line LP assignments (deferred) |
| `work_orders` | Create | 03.10 | WO headers |
| `wo_materials` | Create | 03.11a | WO material snapshot |
| `wo_operations` | Create | 03.12 | WO operation snapshot |
| `wo_pauses` | Create | 03.10 | WO pause history |
| `planning_settings` | Create | 03.16 | Module configuration |

---

## Key Services

| Service | Story | Purpose |
|---------|-------|---------|
| `supplier-service.ts` | 03.1 | Supplier CRUD |
| `supplier-product-service.ts` | 03.2 | Supplier-product assignments |
| `purchase-order-service.ts` | 03.3 | PO CRUD + lines |
| `po-bulk-service.ts` | 03.4 | Bulk PO creation |
| `po-approval-service.ts` | 03.5b | Approval workflow |
| `transfer-order-service.ts` | 03.8 | TO CRUD + lines |
| `work-order-service.ts` | 03.10 | WO CRUD + BOM selection |
| `wo-materials-service.ts` | 03.11a | BOM snapshot |
| `wo-operations-service.ts` | 03.12 | Routing copy |
| `planning-dashboard-service.ts` | 03.15 | Dashboard KPIs |
| `planning-settings-service.ts` | 03.16 | Module settings |

---

## Delivery Order Recommendation

### Sprint 1 (Stories 03.1, 03.2, 03.16): Foundation
- 03.16: Planning Settings (M) - Configure module first
- 03.1: Suppliers CRUD (M) - Supplier master data
- 03.2: Supplier-Product Assignment (M) - Product sourcing

### Sprint 2 (Stories 03.3, 03.4): Purchase Orders
- 03.3: PO CRUD + Lines (L) - Core procurement
- 03.4: Bulk PO Creation (M) - Efficiency feature

### Sprint 3 (Stories 03.8, 03.9a): Transfer Orders
- 03.8: TO CRUD + Lines (L) - Internal transfers
- 03.9a: TO Partial Shipments (S) - Flexibility

### Sprint 4 (Stories 03.10, 03.11a, 03.12): Work Orders
- 03.10: WO CRUD + BOM Auto-Select (L) - Production planning
- 03.11a: WO Materials BOM Snapshot (L) - Material requirements
- 03.12: WO Operations Copy (M) - Process tracking

### Sprint 5 (Stories 03.15, 03.5a, 03.5b): Dashboard + Approval
- 03.15: Planning Dashboard (M) - Visibility
- 03.5a: PO Approval Setup (S) - Configuration
- 03.5b: PO Approval Workflow (M) - Process control

### Post-MVP (After Epic 05)
- 03.9b: TO LP Pre-Selection (M)
- 03.11b: WO Material Reservation (M)
- 03.13: WO Material Availability (M)
- 03.14: WO Gantt Chart (L)
- 03.6, 03.17: Configurable Statuses (M each)

---

## Definition of Done (Epic 03)

### MVP
- [ ] Suppliers: CRUD with product assignments
- [ ] PO: CRUD with lines, status lifecycle, totals
- [ ] PO Bulk: Import/create multiple POs
- [ ] TO: CRUD with lines, status lifecycle
- [ ] WO: CRUD with BOM auto-select, materials, operations
- [ ] Dashboard: KPIs, alerts, upcoming orders
- [ ] Settings: PO/TO/WO configuration
- [ ] All RLS policies enforced (org_id isolation)
- [ ] All stories have unit tests (>80% coverage)
- [ ] Integration tests for API endpoints
- [ ] E2E smoke tests for critical flows
- [ ] Performance: List pages <1s, BOM snapshot <2s

### Phase 1
- [ ] PO Approval: Workflow with notifications
- [ ] TO Partial: Ship in multiple batches
- [ ] Configurable: PO and WO status editors

---

## Risk Assessment

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| BOM snapshot complexity | High | Medium | Clear ACs, opus model |
| LP dependency blocks stories | Medium | High | Defer 03.9b, 03.11b, 03.13 |
| Status lifecycle bugs | Medium | Medium | State machine tests |
| Multi-warehouse validation | Low | Medium | ACs cover same-warehouse check |
| Approval workflow edge cases | Medium | Medium | Comprehensive test scenarios |
| Bulk PO grouping logic | Low | Low | Unit tests for grouping |

---

## Success Metrics

- [ ] Demo: Create supplier, PO, TO, WO end-to-end
- [ ] PO status transitions follow lifecycle rules
- [ ] TO prevents same-warehouse transfers
- [ ] WO auto-selects correct BOM for date
- [ ] wo_materials scaled correctly from BOM
- [ ] wo_operations copied from routing
- [ ] Dashboard shows real-time KPIs
- [ ] Bulk PO groups by supplier correctly

---

## Handoff to DEV Agents

```yaml
epic: "03-planning"
epic_folder: docs/2-MANAGEMENT/epics/current/03-planning/
stories_count: 19
stories_ready: 0 (to be created)
stories_deferred: 4 (03.9b, 03.11b, 03.13, 03.14)
start_story: "03.1.suppliers-crud"
brief: docs/2-MANAGEMENT/epics/current/03-planning/03.0.story-creation-brief.md
technical_notes: |
  - Operational backbone connecting Technical -> Production/Warehouse
  - BOM snapshot pattern from ADR-002
  - Status lifecycles configurable per org
  - LP dependencies deferred to Epic 05+
dependencies:
  - Epic 01 / Story 01.1: organizations, users, roles, RLS
  - Epic 01 / 01.X: warehouses, tax_codes, production_lines, machines
  - Epic 02 / 02.1: products
  - Epic 02 / 02.4: boms
  - Epic 02 / 02.7, 02.8: routings, routing_operations
```

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-12-16 | Initial epic overview | ARCHITECT-AGENT |
