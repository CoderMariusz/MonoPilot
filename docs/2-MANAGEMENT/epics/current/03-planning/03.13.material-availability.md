# 03.13 - WO Material Availability Check

**Priority**: P1 (Phase 1 - AFTER Epic 05)
**Story Points**: M (Medium - 3-4 days)
**Type:** backend + frontend

**State:** deferred
**Primary PRD:** `docs/1-BASELINE/product/modules/planning.md` (FR-PLAN-021)
**Architecture:** `docs/1-BASELINE/architecture/modules/planning.md`
**UX Wireframes:** PLA-XXX (pending)

---

## DEFERRED - Requires Epic 05 (License Plates + Inventory)

> **This story is DEFERRED until Epic 05 (Warehouse Module) is complete.**
>
> The material availability check requires the `license_plates` table and inventory management functionality from Epic 05. The availability algorithm sums LP quantities by product and subtracts reservations, which cannot be implemented without the LP schema.
>
> **Unblock Condition:** Epic 05 License Plates table and core inventory queries implemented.

---

## MVP Scope

This story implements real-time material availability checking for Work Orders. When a user creates or views a WO, the system queries current inventory (License Plates) to determine if sufficient materials are available for production. Results are displayed with traffic light indicators (green/yellow/red) to give planners immediate visibility into material feasibility.

**MVP includes:**
- Material availability algorithm (sum LP qty - reservations)
- API endpoint for availability check (`GET /api/planning/work-orders/:id/availability`)
- Availability panel UI component with traffic light indicators
- Shortage calculation per material
- Expiry-aware availability (filter out expired LPs)
- Service layer with Redis caching (30 sec TTL)
- Validation schemas
- Comprehensive tests including edge cases
- Setting toggle (`wo_material_check`) to enable/disable feature

**Out of scope (this story):**
- Material reservation (covered in 03.11b)
- LP selection/assignment to WO materials
- Auto-suggest alternative materials
- FIFO/FEFO pick suggestion ordering (Epic 05)

---

## Goal

Implement real-time material availability checking for Work Orders, providing planners with visual indicators of material sufficiency before releasing WOs for production.

## User Story

As a **Production Planner**, I want **to see material availability status when creating or viewing a Work Order** so that **I can make informed decisions about production scheduling and identify material shortages early**.

## Scope

**In scope (this story)**
- Material availability algorithm:
  - Sum available LP quantities per product
  - Subtract existing reservations
  - Filter expired LPs from available count
- API endpoint: `GET /api/planning/work-orders/:id/availability`
- Availability called on WO form (create/edit modes)
- Traffic light indicator component:
  - Green (>=100%): Sufficient stock
  - Yellow (50-99%): Partial availability
  - Red (<50%): Critical shortage
- Shortage calculation: `shortage = required - available` (when negative = surplus)
- Availability panel displaying:
  - Material name and code
  - Required quantity (from wo_materials)
  - Available quantity (from LP sum)
  - Shortage/surplus quantity
  - Coverage percentage
  - Traffic light indicator
- Expiry-aware filtering: LPs where `expiry_date < today` excluded
- Service layer with caching (30 sec TTL per WO)
- Respect `wo_material_check` setting toggle
- Zod validation schemas
- Unit and integration tests

**Out of scope (this story)**
- Material reservation logic (03.11b)
- LP selection for materials
- Alternative material suggestions
- Purchase order suggestions for shortages
- BOM snapshot creation (03.11a)
- WO CRUD (03.10)

## Dependencies

- **03.10** - WO CRUD + BOM Auto-Select (provides work_orders table)
- **03.11a** - WO BOM Snapshot (provides wo_materials table)
- **03.16** - Planning Settings (provides wo_material_check setting)
- **Epic 05** - License Plates + Inventory (provides license_plates table, LP status)
- **01.X** - Warehouses (warehouse_id for filtering LPs)

---

## Acceptance Criteria (Given/When/Then)

### AC-1: Availability Calculation Algorithm

**Given** WO has wo_materials with required quantities
**When** availability endpoint is called
**Then** system calculates availability per material using:
```
available_qty = SUM(lp.quantity) WHERE
  - lp.product_id = wo_material.product_id
  - lp.status = 'available'
  - lp.warehouse_id IN (org warehouses)
  - (lp.expiry_date IS NULL OR lp.expiry_date >= today)
  MINUS SUM(reservations.quantity) for other WOs
```

**Given** material with required_qty = 100 kg and available_qty = 150 kg
**When** availability calculated
**Then** coverage = 150%, shortage = -50 (surplus), indicator = green

**Given** material with required_qty = 100 kg and available_qty = 75 kg
**When** availability calculated
**Then** coverage = 75%, shortage = 25, indicator = yellow

**Given** material with required_qty = 100 kg and available_qty = 30 kg
**When** availability calculated
**Then** coverage = 30%, shortage = 70, indicator = red

### AC-2: Expiry-Aware Filtering

**Given** LP with expiry_date = yesterday (expired)
**When** availability calculated
**Then** expired LP quantity is NOT included in available_qty

**Given** LP with expiry_date = NULL (no expiry)
**When** availability calculated
**Then** LP quantity IS included in available_qty

**Given** LP with expiry_date = tomorrow (not expired)
**When** availability calculated
**Then** LP quantity IS included in available_qty

### AC-3: Reservation Deduction

**Given** product has 100 kg available across LPs
**And** 30 kg reserved for WO-001 (different WO)
**When** availability calculated for WO-002
**Then** available_qty = 70 kg (100 - 30 reserved)

**Given** product has 100 kg available across LPs
**And** 20 kg reserved for THIS WO (wo_materials.reserved_qty)
**When** availability calculated
**Then** available_qty includes the 20 kg reserved for this WO (not double-counted as unavailable)

### AC-4: Traffic Light Indicators

**Given** coverage >= 100%
**When** indicator rendered
**Then** shows GREEN with "Sufficient" text/tooltip

**Given** 50% <= coverage < 100%
**When** indicator rendered
**Then** shows YELLOW with "Low Stock" text/tooltip

**Given** coverage < 50%
**When** indicator rendered
**Then** shows RED with "Shortage" text/tooltip

**Given** coverage = 0% (no stock)
**When** indicator rendered
**Then** shows RED with "No Stock" text/tooltip

### AC-5: Availability Panel Display

**Given** WO detail page `/planning/work-orders/:id`
**When** availability section loads (wo_material_check = true)
**Then** availability panel displays within 500ms

**Given** availability panel rendered
**When** viewing material row
**Then** each row shows:
- Material code and name
- Required qty with UOM
- Available qty with UOM
- Shortage/surplus qty (color-coded: red for shortage, green for surplus)
- Coverage percentage
- Traffic light indicator (colored circle or icon)

**Given** availability panel header
**When** rendered
**Then** shows overall WO availability summary:
- Total materials count
- Materials with shortages count
- Overall status indicator (worst case: if any red, show red)

### AC-6: API Response Format

**Given** valid GET `/api/planning/work-orders/:id/availability`
**When** API responds successfully
**Then** response contains:
```json
{
  "wo_id": "uuid",
  "checked_at": "ISO timestamp",
  "overall_status": "sufficient|low_stock|shortage|no_stock",
  "materials": [
    {
      "wo_material_id": "uuid",
      "product_id": "uuid",
      "product_code": "string",
      "product_name": "string",
      "required_qty": 100.00,
      "available_qty": 75.00,
      "reserved_qty": 0.00,
      "shortage_qty": 25.00,
      "coverage_percent": 75.00,
      "status": "low_stock",
      "uom": "kg",
      "expired_excluded_qty": 10.00
    }
  ],
  "summary": {
    "total_materials": 10,
    "sufficient_count": 6,
    "low_stock_count": 3,
    "shortage_count": 1
  }
}
```

### AC-7: Setting Toggle Behavior

**Given** `wo_material_check = false` in planning_settings
**When** WO form loaded
**Then** availability panel is hidden (not just disabled)

**Given** `wo_material_check = true` in planning_settings
**When** WO form loaded
**Then** availability panel is visible and loads data

**Given** `wo_material_check = false`
**When** GET `/api/planning/work-orders/:id/availability` called
**Then** API returns 200 with `{"enabled": false, "message": "Material check disabled"}`

### AC-8: Edge Cases - No LPs

**Given** material has zero available LPs
**When** availability calculated
**Then** available_qty = 0, coverage = 0%, status = "no_stock"

**Given** WO has zero wo_materials (empty BOM snapshot)
**When** availability endpoint called
**Then** returns empty materials array with success message

### AC-9: Edge Cases - Partial Availability

**Given** 5 materials: 3 sufficient, 1 low_stock, 1 shortage
**When** overall status calculated
**Then** overall_status = "shortage" (worst case)

**Given** 5 materials: 4 sufficient, 1 low_stock
**When** overall status calculated
**Then** overall_status = "low_stock" (worst case)

**Given** all materials sufficient
**When** overall status calculated
**Then** overall_status = "sufficient"

### AC-10: Caching Behavior

**Given** availability checked for WO-001
**When** same WO availability requested within 30 seconds
**Then** cached result returned (no DB query)

**Given** cached availability for WO-001 is 30+ seconds old
**When** availability requested
**Then** fresh calculation performed and cache updated

**Given** LP inventory changes (new LP created)
**When** availability rechecked
**Then** new LP included in calculation (after cache expires)

### AC-11: Performance Requirements

**Given** WO with 50 materials
**When** availability calculated
**Then** API responds within 1 second

**Given** WO with 200 materials
**When** availability calculated
**Then** API responds within 2 seconds

**Given** availability panel rendered
**When** materials list displayed
**Then** renders within 500ms with virtualization if >50 items

### AC-12: RLS and Authorization

**Given** WO belongs to org_id = A
**And** user belongs to org_id = B
**When** availability API called
**Then** returns 403 Forbidden

**Given** LP belongs to org_id = A
**And** WO belongs to org_id = B
**When** availability calculated
**Then** LP NOT included (RLS prevents cross-org leakage)

### AC-13: User Can Proceed with Warnings

**Given** WO has material shortages (red indicators)
**When** user clicks "Release" or "Save" button
**Then** warning modal shown: "Some materials have shortages. Proceed anyway?"
**And** user can click "Proceed" to continue or "Cancel" to stay

**Given** WO has all materials sufficient
**When** user saves/releases
**Then** no warning modal shown

---

## Implementation Notes

### API Endpoints

```typescript
// GET /api/planning/work-orders/:id/availability
// Check material availability for a WO
interface AvailabilityResponse {
  wo_id: string;
  checked_at: string;
  overall_status: 'sufficient' | 'low_stock' | 'shortage' | 'no_stock';
  materials: MaterialAvailability[];
  summary: AvailabilitySummary;
  enabled: boolean;
  cached: boolean;
  cache_expires_at?: string;
}

interface MaterialAvailability {
  wo_material_id: string;
  product_id: string;
  product_code: string;
  product_name: string;
  required_qty: number;
  available_qty: number;
  reserved_qty: number;
  shortage_qty: number;  // positive = shortage, negative = surplus
  coverage_percent: number;
  status: 'sufficient' | 'low_stock' | 'shortage' | 'no_stock';
  uom: string;
  expired_excluded_qty: number;
}

interface AvailabilitySummary {
  total_materials: number;
  sufficient_count: number;
  low_stock_count: number;
  shortage_count: number;
}

// Response codes:
// 200 - Success (with availability data or disabled message)
// 403 - Forbidden (RLS violation)
// 404 - WO not found
```

### Database Queries

```sql
-- Main availability query (per material)
-- Note: Requires license_plates table from Epic 05
SELECT
  wm.id as wo_material_id,
  wm.product_id,
  p.code as product_code,
  p.name as product_name,
  wm.required_qty,
  wm.uom,
  COALESCE(available.qty, 0) as available_qty,
  COALESCE(reserved.qty, 0) as reserved_by_others,
  wm.reserved_qty as reserved_for_this_wo
FROM wo_materials wm
JOIN products p ON p.id = wm.product_id
LEFT JOIN (
  -- Sum available LPs (not expired)
  SELECT
    lp.product_id,
    SUM(lp.quantity) as qty
  FROM license_plates lp
  WHERE lp.organization_id = :org_id
    AND lp.status = 'available'
    AND (lp.expiry_date IS NULL OR lp.expiry_date >= CURRENT_DATE)
  GROUP BY lp.product_id
) available ON available.product_id = wm.product_id
LEFT JOIN (
  -- Sum reservations for OTHER work orders
  SELECT
    wm2.product_id,
    SUM(wm2.reserved_qty) as qty
  FROM wo_materials wm2
  JOIN work_orders wo2 ON wo2.id = wm2.wo_id
  WHERE wo2.organization_id = :org_id
    AND wo2.id != :this_wo_id
    AND wo2.status NOT IN ('completed', 'closed', 'cancelled')
    AND wm2.reserved_qty > 0
  GROUP BY wm2.product_id
) reserved ON reserved.product_id = wm.product_id
WHERE wm.wo_id = :wo_id
ORDER BY wm.sequence;
```

### Frontend Components

```
app/(authenticated)/planning/work-orders/[id]/page.tsx  -- WO detail page (update)
app/(authenticated)/planning/work-orders/new/page.tsx   -- WO create page (update)
components/planning/work-orders/
  WOAvailabilityPanel.tsx           -- Main availability panel (new)
  AvailabilityMaterialRow.tsx       -- Single material availability row (new)
  AvailabilityTrafficLight.tsx      -- Traffic light indicator (new)
  AvailabilitySummaryCard.tsx       -- Overall availability summary (new)
  AvailabilityWarningModal.tsx      -- Warning modal for proceed despite shortages (new)
```

### Services

```typescript
// lib/services/material-availability-service.ts (new)

/**
 * Checks material availability for a Work Order.
 * Queries license_plates, sums available quantities, subtracts reservations.
 */
export async function checkWOAvailability(
  woId: string,
  orgId: string
): Promise<AvailabilityResult>

/**
 * Calculates availability status based on coverage percentage.
 * >= 100% = sufficient, 50-99% = low_stock, < 50% = shortage, 0% = no_stock
 */
export function calculateAvailabilityStatus(
  coveragePercent: number
): AvailabilityStatus

/**
 * Calculates coverage percentage: (available / required) * 100
 * Handles edge cases: required = 0 returns 100%, available < 0 returns 0%
 */
export function calculateCoveragePercent(
  availableQty: number,
  requiredQty: number
): number

/**
 * Gets available LP quantity for a product (with expiry filtering).
 */
export async function getAvailableLPQuantity(
  productId: string,
  orgId: string,
  excludeExpired: boolean = true
): Promise<number>

/**
 * Gets total reservations for a product from other active WOs.
 */
export async function getReservedQuantity(
  productId: string,
  orgId: string,
  excludeWoId?: string
): Promise<number>

/**
 * Calculates overall status from individual material statuses.
 * Returns worst case (shortage > low_stock > sufficient).
 */
export function calculateOverallStatus(
  materialStatuses: AvailabilityStatus[]
): AvailabilityStatus
```

### Validation (Zod)

```typescript
// lib/validation/material-availability.ts

const availabilityStatusEnum = z.enum([
  'sufficient',
  'low_stock',
  'shortage',
  'no_stock'
]);

const materialAvailabilitySchema = z.object({
  wo_material_id: z.string().uuid(),
  product_id: z.string().uuid(),
  product_code: z.string(),
  product_name: z.string(),
  required_qty: z.number().nonnegative(),
  available_qty: z.number().nonnegative(),
  reserved_qty: z.number().nonnegative(),
  shortage_qty: z.number(), // Can be negative (surplus)
  coverage_percent: z.number().min(0),
  status: availabilityStatusEnum,
  uom: z.string(),
  expired_excluded_qty: z.number().nonnegative(),
});

const availabilitySummarySchema = z.object({
  total_materials: z.number().int().nonnegative(),
  sufficient_count: z.number().int().nonnegative(),
  low_stock_count: z.number().int().nonnegative(),
  shortage_count: z.number().int().nonnegative(),
});

const availabilityResponseSchema = z.object({
  wo_id: z.string().uuid(),
  checked_at: z.string().datetime(),
  overall_status: availabilityStatusEnum,
  materials: z.array(materialAvailabilitySchema),
  summary: availabilitySummarySchema,
  enabled: z.boolean(),
  cached: z.boolean(),
  cache_expires_at: z.string().datetime().optional(),
});
```

### Caching Strategy

```typescript
// Redis cache key pattern
// 'org:{orgId}:wo:{woId}:availability' - 30 sec TTL

const AVAILABILITY_CACHE_TTL = 30; // seconds

async function getCachedAvailability(
  orgId: string,
  woId: string
): Promise<AvailabilityResult | null> {
  const key = `org:${orgId}:wo:${woId}:availability`;
  const cached = await redis.get(key);
  return cached ? JSON.parse(cached) : null;
}

async function cacheAvailability(
  orgId: string,
  woId: string,
  result: AvailabilityResult
): Promise<void> {
  const key = `org:${orgId}:wo:${woId}:availability`;
  await redis.setex(key, AVAILABILITY_CACHE_TTL, JSON.stringify(result));
}
```

### Key Business Rules

1. **Traffic Light Thresholds:**
   - Green (sufficient): coverage >= 100%
   - Yellow (low_stock): 50% <= coverage < 100%
   - Red (shortage): coverage < 50%
   - Red (no_stock): coverage = 0% (special case)

2. **Shortage Calculation:** `shortage_qty = required_qty - available_qty`
   - Positive = shortage (need more)
   - Negative = surplus (have extra)

3. **Available Quantity Calculation:**
   ```
   available = SUM(LP.quantity for available, non-expired LPs)
             - SUM(reserved_qty for other active WOs)
             + this_wo.reserved_qty (don't double-count own reservations)
   ```

4. **Expiry Filtering:** LPs with `expiry_date < today` excluded from available count

5. **Overall Status:** Worst case wins (if any material is "shortage", overall is "shortage")

6. **RLS:** All queries filtered by organization_id

7. **Feature Toggle:** Respects `wo_material_check` setting - when false, panel hidden

8. **Non-Blocking:** Availability check is advisory only; users can proceed with shortages

---

## Deliverables

- API route: GET `/api/planning/work-orders/:id/availability`
- Components:
  - WOAvailabilityPanel.tsx
  - AvailabilityMaterialRow.tsx
  - AvailabilityTrafficLight.tsx
  - AvailabilitySummaryCard.tsx
  - AvailabilityWarningModal.tsx
- material-availability-service.ts
- material-availability validation schemas
- Redis caching implementation
- Unit tests for availability calculations
- Unit tests for edge cases (no LPs, partial availability)
- Integration tests for API endpoint
- Integration tests for RLS enforcement

---

## Definition of Done

- [ ] API endpoint returns correct availability data
- [ ] Availability algorithm correctly sums LP quantities
- [ ] Expired LPs filtered from available count
- [ ] Reservations from other WOs deducted
- [ ] Traffic light indicators display correctly (green/yellow/red)
- [ ] Coverage percentage calculated correctly
- [ ] Shortage/surplus quantities calculated correctly
- [ ] Overall status reflects worst-case material
- [ ] Availability panel displays all materials within 500ms
- [ ] Setting toggle `wo_material_check` respected
- [ ] Warning modal shown when proceeding with shortages
- [ ] Redis caching implemented (30 sec TTL)
- [ ] RLS enforces org isolation
- [ ] Unit tests cover:
  - [ ] Coverage calculation edge cases
  - [ ] Status determination thresholds
  - [ ] Shortage calculation (positive and negative)
  - [ ] Overall status calculation
- [ ] Integration tests cover:
  - [ ] No LPs scenario
  - [ ] Partial availability scenario
  - [ ] All sufficient scenario
  - [ ] Mixed scenarios (some shortage, some sufficient)
  - [ ] Expired LP exclusion
  - [ ] Reservation deduction
- [ ] Performance: <1s for 50 materials, <2s for 200 materials

---

## Test Cases

### Unit Tests: Coverage Calculation

```typescript
describe('calculateCoveragePercent', () => {
  it('returns 100% when available >= required', () => {
    expect(calculateCoveragePercent(150, 100)).toBe(150);
  });

  it('returns correct percentage for partial', () => {
    expect(calculateCoveragePercent(75, 100)).toBe(75);
  });

  it('returns 0% when no stock', () => {
    expect(calculateCoveragePercent(0, 100)).toBe(0);
  });

  it('returns 100% when required is 0', () => {
    expect(calculateCoveragePercent(50, 0)).toBe(100);
  });

  it('handles decimal quantities', () => {
    expect(calculateCoveragePercent(7.5, 10)).toBe(75);
  });
});

describe('calculateAvailabilityStatus', () => {
  it('returns sufficient for >= 100%', () => {
    expect(calculateAvailabilityStatus(100)).toBe('sufficient');
    expect(calculateAvailabilityStatus(150)).toBe('sufficient');
  });

  it('returns low_stock for 50-99%', () => {
    expect(calculateAvailabilityStatus(50)).toBe('low_stock');
    expect(calculateAvailabilityStatus(99.9)).toBe('low_stock');
  });

  it('returns shortage for 1-49%', () => {
    expect(calculateAvailabilityStatus(49)).toBe('shortage');
    expect(calculateAvailabilityStatus(1)).toBe('shortage');
  });

  it('returns no_stock for 0%', () => {
    expect(calculateAvailabilityStatus(0)).toBe('no_stock');
  });
});

describe('calculateOverallStatus', () => {
  it('returns sufficient when all sufficient', () => {
    expect(calculateOverallStatus(['sufficient', 'sufficient'])).toBe('sufficient');
  });

  it('returns low_stock when worst is low_stock', () => {
    expect(calculateOverallStatus(['sufficient', 'low_stock'])).toBe('low_stock');
  });

  it('returns shortage when any shortage', () => {
    expect(calculateOverallStatus(['sufficient', 'low_stock', 'shortage'])).toBe('shortage');
  });

  it('returns no_stock when any no_stock', () => {
    expect(calculateOverallStatus(['sufficient', 'no_stock'])).toBe('no_stock');
  });
});
```

### Integration Tests: Availability API

```typescript
describe('GET /api/planning/work-orders/:id/availability', () => {
  it('returns availability for WO with materials', async () => {
    const wo = await createWOWithMaterials();
    await createLPsForMaterials(wo.materials);

    const res = await request.get(`/api/planning/work-orders/${wo.id}/availability`);

    expect(res.status).toBe(200);
    expect(res.body.overall_status).toBeDefined();
    expect(res.body.materials).toHaveLength(wo.materials.length);
  });

  it('excludes expired LPs from available quantity', async () => {
    const wo = await createWOWithMaterials([{ product_id: 'p1', required_qty: 100 }]);
    await createLP({ product_id: 'p1', quantity: 50, expiry_date: yesterday });
    await createLP({ product_id: 'p1', quantity: 30, expiry_date: tomorrow });

    const res = await request.get(`/api/planning/work-orders/${wo.id}/availability`);

    expect(res.body.materials[0].available_qty).toBe(30); // Expired excluded
    expect(res.body.materials[0].expired_excluded_qty).toBe(50);
  });

  it('deducts reservations from other WOs', async () => {
    await createLP({ product_id: 'p1', quantity: 100 });
    const otherWO = await createWOWithMaterials([{ product_id: 'p1', reserved_qty: 30 }]);

    const wo = await createWOWithMaterials([{ product_id: 'p1', required_qty: 100 }]);
    const res = await request.get(`/api/planning/work-orders/${wo.id}/availability`);

    expect(res.body.materials[0].available_qty).toBe(70); // 100 - 30 reserved
  });

  it('handles no LPs scenario', async () => {
    const wo = await createWOWithMaterials([{ product_id: 'p1', required_qty: 100 }]);
    // No LPs created

    const res = await request.get(`/api/planning/work-orders/${wo.id}/availability`);

    expect(res.body.materials[0].available_qty).toBe(0);
    expect(res.body.materials[0].status).toBe('no_stock');
  });

  it('returns disabled message when setting off', async () => {
    await updatePlanningSettings({ wo_material_check: false });
    const wo = await createWOWithMaterials();

    const res = await request.get(`/api/planning/work-orders/${wo.id}/availability`);

    expect(res.status).toBe(200);
    expect(res.body.enabled).toBe(false);
  });

  it('uses cached result within TTL', async () => {
    const wo = await createWOWithMaterials();
    await createLP({ product_id: 'p1', quantity: 100 });

    const res1 = await request.get(`/api/planning/work-orders/${wo.id}/availability`);
    await createLP({ product_id: 'p1', quantity: 50 }); // Add more inventory
    const res2 = await request.get(`/api/planning/work-orders/${wo.id}/availability`);

    expect(res1.body.materials[0].available_qty).toBe(res2.body.materials[0].available_qty); // Cached
    expect(res2.body.cached).toBe(true);
  });

  it('enforces RLS - 403 for wrong org', async () => {
    const wo = await createWOInOrgA();
    const res = await requestAsOrgB.get(`/api/planning/work-orders/${wo.id}/availability`);

    expect(res.status).toBe(403);
  });
});
```

---

## Future Phases (Not in MVP)

### Phase 1 (Story 03.11b)
- Material reservation against specific LPs
- Reserve/release reservation actions
- Reserved indicator in availability panel

### Phase 2
- Alternative material suggestions when primary unavailable
- Auto-generate PO suggestions for shortages
- Link to supplier lead times for reorder timing
- Batch availability check for multiple WOs (schedule view)

### Phase 3
- Integration with MRP for projected availability
- Forecast-based availability (include incoming POs)
- ATP (Available-to-Promise) calculations

**Implementation**: See Epic 03.0 "Future Feature Handling" section.

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-12-16 | Initial story - Material availability check | ARCHITECT-AGENT |
