# 03.10 - Work Orders CRUD (Foundation)

| Field | Value |
|-------|-------|
| **Story ID** | 03.10 |
| **Epic** | 03 - Planning |
| **Status** | Ready |
| **Phase** | MVP (P0) |
| **Complexity** | L (Large) |
| **Estimate** | 5-7 days |
| **Type** | Full-stack |

---

## PRD References

| FR ID | Requirement | Priority | Covered |
|-------|-------------|----------|---------|
| FR-PLAN-017 | WO CRUD | Must Have | YES |
| FR-PLAN-018 | BOM Auto-Selection | Must Have | YES |
| FR-PLAN-022 | WO Status Lifecycle | Must Have | YES (draft -> planned -> released only) |
| FR-PLAN-019 | BOM Snapshot (wo_materials) | Must Have | NO - Story 03.11a |
| FR-PLAN-020 | Routing Copy (wo_operations) | Should Have | NO - Story 03.12 |
| FR-PLAN-021 | Material Availability Check | Should Have | NO - Story 03.13 |
| FR-PLAN-023 | Configurable WO Statuses | Should Have | NO - Story 03.17 |
| FR-PLAN-024 | WO Gantt Chart View | Could Have | NO - Story 03.14 |
| FR-PLAN-025 | Material Reservation | Should Have | NO - Story 03.11b |

**Primary PRD:** `docs/1-BASELINE/product/modules/planning.md` (Section 7)
**Architecture:** `docs/1-BASELINE/architecture/modules/planning.md`
**UX Wireframes:** PLA-010 (WO List), PLA-011 (WO Detail/Form), PLA-012 (BOM Preview)

---

## MVP Scope

This story implements Phase 0 (MVP) functionality for Work Order management foundation. BOM snapshot creation, routing operations copy, material availability checks, and advanced features are deferred to subsequent stories.

**MVP Includes**:
- Complete WO header CRUD (create, read, update, delete)
- WO number auto-generation (WO-YYYYMMDD-NNNN format with daily reset)
- BOM auto-selection based on scheduled date and effective dates
- BOM validation (product must have active BOM to create WO)
- BOM preview before WO creation
- Manual BOM override capability
- Basic status lifecycle (draft -> planned -> released)
- Production line and machine assignment (optional)
- Priority levels (low, normal, high, critical)
- Source of demand tracking (manual, PO, customer_order, forecast)
- Product + BOM FK references stored on WO header

**Deferred to Phase 1+**: See "Future Phases" section below.

---

## User Story

As a **Planner or Production Manager**, I want to **create, view, edit, and manage work orders with automatic BOM selection** so that **I can schedule production jobs efficiently with the correct bill of materials for the scheduled date, ensuring production uses the right recipe/formula**.

---

## Dependencies

| Dependency | Story/Epic | Type | Reason |
|------------|------------|------|--------|
| 01.1 | Org Context + Base RLS | HARD | Requires org_id context and RLS patterns |
| 01.9 | Production Lines CRUD | SOFT | WO can reference production_line_id |
| 01.10 | Machines CRUD | SOFT | WO can reference machine_id |
| 02.1 | Products CRUD | HARD | WO requires product_id for finished good |
| 02.4 | BOMs CRUD | HARD | WO requires bom_id and BOM auto-selection |
| 03.16 | Planning Settings | SOFT | Settings control WO behaviors |

**Dependents:**
- 03.11a (WO Materials BOM Snapshot) - Creates wo_materials from BOM
- 03.12 (WO Operations Copy) - Creates wo_operations from Routing
- 03.13 (Material Availability Check) - Checks inventory against wo_materials
- 03.14 (WO Gantt Chart) - Visualizes WO schedule
- Epic 04 (Production) - Executes work orders

---

## Acceptance Criteria (Gherkin)

### AC-1: WO List Page (FR-PLAN-017)

```gherkin
Scenario: View work orders list
  Given planner navigates to `/planning/work-orders`
  When page loads
  Then WO list displays within 300ms
  And table shows columns: WO Number, Product, Quantity, Status, Scheduled Date, Line, Priority, Created

Scenario: Search WOs by number or product
  Given WO list with 20+ orders
  When planner enters search "WO-20241216"
  Then only WOs matching number or product name/code display within 200ms

Scenario: Filter by status
  Given WO list displayed
  When planner selects filter "Draft"
  Then only draft WOs appear

Scenario: Filter by product
  Given WO list displayed
  When planner selects product "FG-BREAD-001"
  Then only WOs for that product appear

Scenario: Filter by production line
  Given WO list displayed
  When planner selects line "Line 1"
  Then only WOs assigned to that line appear

Scenario: Filter by date range
  Given WO list displayed
  When planner sets date range for scheduled date
  Then only WOs within date range appear

Scenario: Filter by priority
  Given WO list displayed
  When planner selects priority "High"
  Then only high-priority WOs appear

Scenario: Sort WO list
  Given WO list displayed
  When planner clicks "Scheduled Date" column header
  Then list sorts by date (toggle asc/desc)

Scenario: Pagination
  Given 100 WOs exist
  When planner views WO list
  Then 20 WOs display per page with pagination controls
```

### AC-2: Create WO Header (FR-PLAN-017)

```gherkin
Scenario: Open create WO page
  Given planner clicks "+ New Work Order"
  When page loads
  Then form displays: product dropdown, scheduled date, quantity, UoM, priority, line, machine, notes

Scenario: Product selection triggers BOM lookup
  Given planner selects product "FG-BREAD-001"
  And scheduled date is "2024-12-20"
  When product selected
  Then system queries active BOMs for product
  And BOM auto-selected based on effective dates
  And BOM preview panel shows selected BOM details

Scenario: WO number auto-generated with daily reset
  Given planner saves a new WO on 2024-12-16
  And 5 WOs already exist for that day
  When WO is created
  Then WO number generated as "WO-20241216-0006"
  And WO number is immutable after creation

Scenario: Required field validation
  Given planner leaves product empty
  When save attempted
  Then error "Product is required" displays inline
  And form submission blocked

Scenario: Quantity validation
  Given planner enters quantity 0
  When save attempted
  Then error "Quantity must be greater than 0" displays

Scenario: Scheduled date validation
  Given planner enters past date (more than 1 day ago)
  When save attempted
  Then error "Scheduled date cannot be in the past" displays

Scenario: UoM defaults from product
  Given planner selects product with base UoM "kg"
  When product selected
  Then UoM field auto-fills "kg"
  And field is editable to override

Scenario: Priority defaults to Normal
  Given planner opens new WO form
  When form loads
  Then priority defaults to "Normal"
  And can be changed to Low, High, or Critical

Scenario: Line and machine optional
  Given planner fills required fields without selecting line or machine
  When save clicked
  Then WO created successfully with null line_id and machine_id
```

### AC-3: BOM Auto-Selection (FR-PLAN-018)

```gherkin
Scenario: Auto-select BOM based on scheduled date
  Given product "FG-BREAD-001" has active BOM v2 (effective 2024-01-01 to null)
  And product has active BOM v3 (effective 2024-06-01 to null)
  And scheduled date is "2024-12-20"
  When planner selects product
  Then system selects BOM v3 (most recent effective_from <= scheduled_date)
  And BOM preview shows v3 details

Scenario: Auto-select with effective_to date
  Given product has BOM v1 (effective 2024-01-01 to 2024-05-31)
  And product has BOM v2 (effective 2024-06-01 to null)
  And scheduled date is "2024-04-15"
  When planner selects product
  Then system selects BOM v1 (scheduled_date within effective range)

Scenario: No active BOM found - warning
  Given product "FG-NEW-001" has no active BOMs
  And wo_require_bom setting is true
  When planner selects product
  Then warning "No active BOM found for this product on the scheduled date" displays
  And BOM dropdown shows empty state
  And save button disabled until BOM selected

Scenario: Multiple BOMs with same effective_from
  Given product has two BOMs both effective 2024-06-01
  When planner selects product
  Then system selects BOM with most recent created_at
  And user can override selection

Scenario: Manual BOM override
  Given BOM v3 is auto-selected
  When planner clicks "Change BOM" button
  Then BOM selection modal opens
  And shows all active BOMs for product
  And planner can select different BOM

Scenario: BOM preview displays
  Given BOM is selected (auto or manual)
  When viewing BOM preview panel
  Then shows: BOM code, version, output qty, effective dates, item count

Scenario: Date change triggers BOM re-selection
  Given WO with BOM v2 auto-selected for date 2024-03-15
  When planner changes scheduled date to 2024-07-20
  Then system re-evaluates BOM selection
  And if different BOM applies, confirmation dialog shows
  And user can accept new BOM or keep current
```

### AC-4: BOM Validation (FR-PLAN-018)

```gherkin
Scenario: Product must have active BOM
  Given setting wo_require_bom = true
  And product has no active BOMs
  When planner attempts to create WO
  Then error "Selected product has no active BOM" displays
  And WO creation blocked

Scenario: Product with draft-only BOMs
  Given product has only draft status BOMs
  When planner selects product
  Then warning "No active BOM available. Product has only draft BOMs." displays
  And BOM dropdown empty

Scenario: BOM must be for selected product
  Given WO form with product "FG-BREAD-001"
  When validating BOM selection
  Then system verifies bom.product_id matches wo.product_id
  And mismatched BOM selection blocked

Scenario: Optional BOM mode (wo_require_bom = false)
  Given setting wo_require_bom = false
  And product has no active BOMs
  When planner creates WO
  Then WO created successfully with bom_id = null
  And warning "WO created without BOM - materials must be added manually" displays
```

### AC-5: WO Status Lifecycle (FR-PLAN-022)

```gherkin
Scenario: Draft status capabilities
  Given WO is in "draft" status
  When planner views available actions
  Then can: edit all fields, plan, cancel

Scenario: Plan WO (draft -> planned)
  Given WO is in "draft" status
  And WO has valid BOM selected
  When planner clicks "Plan"
  Then status changes to "planned"
  And status history records transition
  And planned_at timestamp recorded

Scenario: Release WO (planned -> released)
  Given WO is in "planned" status
  When planner clicks "Release"
  Then status changes to "released"
  And status history records transition
  And BOM snapshot creation triggered (Story 03.11a)

Scenario: Released WO restrictions
  Given WO is "released"
  When planner views available actions
  Then cannot change: product_id, bom_id, quantity
  And can only update: scheduled date/time, line, machine, priority, notes
  And can cancel (with confirmation)

Scenario: Cancel WO
  Given WO in any pre-production status (draft, planned, released)
  And WO has no production activity
  When planner clicks "Cancel"
  Then confirmation dialog displays
  And upon confirm, status changes to "cancelled"

Scenario: Cannot cancel WO with production
  Given WO status is "in_progress" or has production records
  When planner attempts to cancel
  Then error "Cannot cancel WO with production activity" displays

Scenario: Status history tracking
  Given WO transitions through statuses
  When viewing WO detail
  Then status history timeline shows all transitions
  And each entry shows: from_status, to_status, changed_by, changed_at, notes
```

### AC-6: Edit WO (FR-PLAN-017)

```gherkin
Scenario: Open WO detail page
  Given planner clicks on WO-20241216-0001
  When page loads
  Then header fields display in read/edit mode (based on status)
  And BOM preview panel shows
  And summary panel shows key info

Scenario: Edit header fields in draft
  Given WO is "draft"
  When planner changes quantity
  Then change saved immediately (auto-save or explicit save)

Scenario: WO number immutable
  Given WO exists with number WO-20241216-0001
  When planner views edit form
  Then WO number field is disabled/read-only

Scenario: Product change resets BOM
  Given WO has product "FG-BREAD-001" with BOM v3
  When planner changes product to "FG-CAKE-001"
  Then BOM cleared and re-selected for new product
  And confirmation dialog warns "Changing product will reset BOM selection"
```

### AC-7: Delete WO (FR-PLAN-017)

```gherkin
Scenario: Delete draft WO
  Given WO is "draft"
  When planner clicks "Delete"
  Then confirmation "Delete this draft WO?" displays
  And upon confirm, WO permanently deleted

Scenario: Cannot delete non-draft WO
  Given WO status is "planned" or later
  When planner views available actions
  Then delete action is hidden (only cancel available)

Scenario: Cannot delete WO with materials/operations
  Given WO has wo_materials records
  When planner attempts to delete
  Then error "Cannot delete WO with materials or operations" displays
```

### AC-8: Source of Demand Tracking

```gherkin
Scenario: Manual creation source
  Given planner creates WO manually
  When WO is saved
  Then source_of_demand = 'manual'
  And source_reference = null

Scenario: Source reference display
  Given WO has source_of_demand = 'customer_order' and source_reference = 'ORD-123'
  When viewing WO detail
  Then shows "Source: Customer Order (ORD-123)"
  And source_reference is clickable link (if order exists)

Scenario: Source is read-only after creation
  Given WO exists with source_of_demand = 'forecast'
  When planner views edit form
  Then source_of_demand and source_reference are read-only
```

### AC-9: Permission Enforcement

```gherkin
Scenario: Planner full access
  Given user has PLANNER role
  When accessing /planning/work-orders
  Then all CRUD actions available

Scenario: Production Manager create/view
  Given user has PROD_MANAGER role
  When accessing /planning/work-orders
  Then can create, view, edit, release WOs
  But cannot delete WOs

Scenario: Operator view only
  Given user has OPERATOR role
  When accessing /planning/work-orders
  Then can view list and detail
  But create/edit/delete buttons hidden
```

### AC-10: Multi-tenancy

```gherkin
Scenario: Org isolation on list
  Given User A from Org A
  When requesting /api/planning/work-orders
  Then only Org A WOs returned

Scenario: Cross-tenant access returns 404
  Given User A from Org A
  When requesting WO ID from Org B
  Then 404 Not Found returned (not 403)

Scenario: BOM selection respects org
  Given User A from Org A selects product
  When BOM auto-selection runs
  Then only BOMs from Org A considered
```

---

## Technical Specification

### Database Schema

```sql
-- Work Orders Header
CREATE TABLE work_orders (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  wo_number VARCHAR(20) NOT NULL,
  product_id UUID NOT NULL REFERENCES products(id),
  bom_id UUID REFERENCES boms(id),
  routing_id UUID REFERENCES routings(id),
  planned_quantity DECIMAL(15,4) NOT NULL,
  produced_quantity DECIMAL(15,4) DEFAULT 0,
  uom VARCHAR(20) NOT NULL,
  status VARCHAR(20) NOT NULL DEFAULT 'draft',

  -- Scheduling
  planned_start_date DATE,
  planned_end_date DATE,
  scheduled_start_time TIME,
  scheduled_end_time TIME,

  -- Assignments
  production_line_id UUID REFERENCES production_lines(id),
  machine_id UUID REFERENCES machines(id),

  -- Priority & Source
  priority VARCHAR(20) DEFAULT 'normal',
  source_of_demand VARCHAR(30),
  source_reference VARCHAR(50),

  -- Execution tracking (updated by Production module)
  started_at TIMESTAMPTZ,
  completed_at TIMESTAMPTZ,
  paused_at TIMESTAMPTZ,
  pause_reason TEXT,
  actual_qty DECIMAL(15,4),
  yield_percent DECIMAL(5,2),

  -- WO expiry
  expiry_date DATE,

  -- Notes
  notes TEXT,

  -- Audit fields
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  created_by UUID REFERENCES users(id),
  updated_by UUID REFERENCES users(id),

  CONSTRAINT wo_org_number_unique UNIQUE(org_id, wo_number),
  CONSTRAINT wo_status_check CHECK (status IN ('draft', 'planned', 'released', 'in_progress', 'on_hold', 'completed', 'closed', 'cancelled')),
  CONSTRAINT wo_priority_check CHECK (priority IN ('low', 'normal', 'high', 'critical')),
  CONSTRAINT wo_source_check CHECK (source_of_demand IS NULL OR source_of_demand IN ('manual', 'po', 'customer_order', 'forecast')),
  CONSTRAINT wo_qty_positive CHECK (planned_quantity > 0),
  CONSTRAINT wo_produced_qty_check CHECK (produced_quantity >= 0)
);

-- WO Status History (audit trail)
CREATE TABLE wo_status_history (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  wo_id UUID NOT NULL REFERENCES work_orders(id) ON DELETE CASCADE,
  from_status VARCHAR(20),
  to_status VARCHAR(20) NOT NULL,
  changed_by UUID REFERENCES users(id),
  changed_at TIMESTAMPTZ DEFAULT NOW(),
  notes TEXT
);

-- Daily WO Number Sequence (for WO-YYYYMMDD-NNNN format)
CREATE TABLE wo_daily_sequence (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id),
  sequence_date DATE NOT NULL,
  last_sequence INTEGER NOT NULL DEFAULT 0,
  updated_at TIMESTAMPTZ DEFAULT NOW(),

  CONSTRAINT wo_seq_org_date_unique UNIQUE(org_id, sequence_date)
);

-- Indexes for performance
CREATE INDEX idx_wo_org_status ON work_orders(org_id, status);
CREATE INDEX idx_wo_org_date ON work_orders(org_id, planned_start_date);
CREATE INDEX idx_wo_product ON work_orders(product_id);
CREATE INDEX idx_wo_bom ON work_orders(bom_id);
CREATE INDEX idx_wo_line ON work_orders(production_line_id);
CREATE INDEX idx_wo_machine ON work_orders(machine_id);
CREATE INDEX idx_wo_priority ON work_orders(org_id, priority);
CREATE INDEX idx_wo_created_at ON work_orders(created_at DESC);
CREATE INDEX idx_wo_number ON work_orders(wo_number);
CREATE INDEX idx_wo_history_wo ON wo_status_history(wo_id);

-- Function: Generate next WO number with daily reset
CREATE OR REPLACE FUNCTION generate_wo_number(p_org_id UUID, p_date DATE DEFAULT CURRENT_DATE)
RETURNS TEXT AS $$
DECLARE
  v_date_str TEXT;
  v_next_seq INTEGER;
BEGIN
  v_date_str := TO_CHAR(p_date, 'YYYYMMDD');

  -- Insert or update sequence for this org/date
  INSERT INTO wo_daily_sequence (org_id, sequence_date, last_sequence)
  VALUES (p_org_id, p_date, 1)
  ON CONFLICT (org_id, sequence_date)
  DO UPDATE SET
    last_sequence = wo_daily_sequence.last_sequence + 1,
    updated_at = NOW()
  RETURNING last_sequence INTO v_next_seq;

  RETURN 'WO-' || v_date_str || '-' || LPAD(v_next_seq::TEXT, 4, '0');
END;
$$ LANGUAGE plpgsql;

-- Function: Get active BOM for product on date
CREATE OR REPLACE FUNCTION get_active_bom_for_date(
  p_product_id UUID,
  p_org_id UUID,
  p_scheduled_date DATE
)
RETURNS TABLE (
  bom_id UUID,
  bom_code VARCHAR,
  bom_version INTEGER,
  output_qty DECIMAL,
  effective_from DATE,
  effective_to DATE,
  routing_id UUID,
  item_count BIGINT
) AS $$
BEGIN
  RETURN QUERY
  SELECT
    b.id AS bom_id,
    b.code AS bom_code,
    b.version AS bom_version,
    b.output_qty,
    b.effective_from,
    b.effective_to,
    b.routing_id,
    (SELECT COUNT(*) FROM bom_items bi WHERE bi.bom_id = b.id) AS item_count
  FROM boms b
  WHERE b.product_id = p_product_id
    AND b.org_id = p_org_id
    AND b.status = 'active'
    AND b.effective_from <= p_scheduled_date
    AND (b.effective_to IS NULL OR b.effective_to >= p_scheduled_date)
  ORDER BY b.effective_from DESC, b.created_at DESC
  LIMIT 1;
END;
$$ LANGUAGE plpgsql;

-- Function: Get all active BOMs for product (for manual selection)
CREATE OR REPLACE FUNCTION get_all_active_boms_for_product(
  p_product_id UUID,
  p_org_id UUID
)
RETURNS TABLE (
  bom_id UUID,
  bom_code VARCHAR,
  bom_version INTEGER,
  output_qty DECIMAL,
  effective_from DATE,
  effective_to DATE,
  routing_id UUID,
  item_count BIGINT,
  is_current BOOLEAN
) AS $$
BEGIN
  RETURN QUERY
  SELECT
    b.id AS bom_id,
    b.code AS bom_code,
    b.version AS bom_version,
    b.output_qty,
    b.effective_from,
    b.effective_to,
    b.routing_id,
    (SELECT COUNT(*) FROM bom_items bi WHERE bi.bom_id = b.id) AS item_count,
    (b.effective_from <= CURRENT_DATE
      AND (b.effective_to IS NULL OR b.effective_to >= CURRENT_DATE)) AS is_current
  FROM boms b
  WHERE b.product_id = p_product_id
    AND b.org_id = p_org_id
    AND b.status = 'active'
  ORDER BY b.effective_from DESC, b.created_at DESC;
END;
$$ LANGUAGE plpgsql;

-- Trigger: Record status history on status change
CREATE OR REPLACE FUNCTION record_wo_status_change()
RETURNS TRIGGER AS $$
BEGIN
  IF OLD.status IS DISTINCT FROM NEW.status THEN
    INSERT INTO wo_status_history (wo_id, from_status, to_status, changed_by)
    VALUES (NEW.id, OLD.status, NEW.status, NEW.updated_by);
  END IF;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER tr_wo_status_history
AFTER UPDATE OF status ON work_orders
FOR EACH ROW
EXECUTE FUNCTION record_wo_status_change();

-- Trigger: Update timestamp on modification
CREATE OR REPLACE FUNCTION update_wo_timestamp()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at := NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER tr_wo_update_timestamp
BEFORE UPDATE ON work_orders
FOR EACH ROW
EXECUTE FUNCTION update_wo_timestamp();
```

### RLS Policies

```sql
-- Enable RLS
ALTER TABLE work_orders ENABLE ROW LEVEL SECURITY;
ALTER TABLE wo_status_history ENABLE ROW LEVEL SECURITY;
ALTER TABLE wo_daily_sequence ENABLE ROW LEVEL SECURITY;

-- Work Orders: Org isolation
CREATE POLICY "wo_select" ON work_orders
FOR SELECT TO authenticated
USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

CREATE POLICY "wo_insert" ON work_orders
FOR INSERT TO authenticated
WITH CHECK (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  AND (
    (SELECT r.code FROM roles r JOIN users u ON u.role_id = r.id WHERE u.id = auth.uid())
    IN ('SUPER_ADMIN', 'ADMIN', 'PLANNER', 'PROD_MANAGER')
  )
);

CREATE POLICY "wo_update" ON work_orders
FOR UPDATE TO authenticated
USING (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  AND (
    (SELECT r.code FROM roles r JOIN users u ON u.role_id = r.id WHERE u.id = auth.uid())
    IN ('SUPER_ADMIN', 'ADMIN', 'PLANNER', 'PROD_MANAGER')
  )
);

CREATE POLICY "wo_delete" ON work_orders
FOR DELETE TO authenticated
USING (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  AND status = 'draft'
  AND NOT EXISTS (SELECT 1 FROM wo_materials WHERE wo_id = work_orders.id)
  AND (
    (SELECT r.code FROM roles r JOIN users u ON u.role_id = r.id WHERE u.id = auth.uid())
    IN ('SUPER_ADMIN', 'ADMIN', 'PLANNER')
  )
);

-- Status History: Read through WO
CREATE POLICY "wo_history_select" ON wo_status_history
FOR SELECT TO authenticated
USING (
  EXISTS (
    SELECT 1 FROM work_orders wo
    WHERE wo.id = wo_status_history.wo_id
      AND wo.org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  )
);

CREATE POLICY "wo_history_insert" ON wo_status_history
FOR INSERT TO authenticated
WITH CHECK (
  EXISTS (
    SELECT 1 FROM work_orders wo
    WHERE wo.id = wo_status_history.wo_id
      AND wo.org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  )
);

-- Daily Sequence: Access by org
CREATE POLICY "wo_seq_all" ON wo_daily_sequence
FOR ALL TO authenticated
USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));
```

### API Endpoints

```
# Work Orders
GET    /api/v1/planning/work-orders                    - List WOs (paginated, filtered)
POST   /api/v1/planning/work-orders                    - Create WO
GET    /api/v1/planning/work-orders/:id                - Get WO detail
PUT    /api/v1/planning/work-orders/:id                - Update WO
DELETE /api/v1/planning/work-orders/:id                - Delete draft WO

# WO Status Actions
POST   /api/v1/planning/work-orders/:id/plan           - Plan WO (draft -> planned)
POST   /api/v1/planning/work-orders/:id/release        - Release WO (planned -> released)
POST   /api/v1/planning/work-orders/:id/cancel         - Cancel WO

# BOM Selection
GET    /api/v1/planning/work-orders/bom-for-date       - Get auto-selected BOM for product/date
GET    /api/v1/planning/work-orders/available-boms     - Get all active BOMs for product

# Utilities
GET    /api/v1/planning/work-orders/:id/history        - Get status history
GET    /api/v1/planning/work-orders/next-number        - Preview next WO number
GET    /api/v1/planning/work-orders/validate-product   - Validate product has active BOM
```

**Query Parameters (List):**
- `search` - Filter by WO number or product name/code (min 2 chars)
- `product_id` - Filter by product UUID
- `status` - Filter by status (comma-separated for multiple)
- `line_id` - Filter by production line
- `machine_id` - Filter by machine
- `priority` - Filter by priority
- `date_from` - Scheduled date from
- `date_to` - Scheduled date to
- `sort` - Sort field (wo_number, planned_start_date, planned_quantity, status, created_at)
- `order` - Sort order (asc, desc)
- `page` - Page number (default 1)
- `limit` - Items per page (default 20, max 100)

**BOM Selection Query Parameters:**
- `product_id` - Product UUID (required)
- `scheduled_date` - Date for BOM selection (required)

### Service Layer

```typescript
// lib/services/work-order-service.ts

export interface WOService {
  // List operations
  list(params: WOListParams): Promise<PaginatedResult<WOListItem>>;
  getById(id: string): Promise<WorkOrderWithRelations | null>;

  // CRUD operations
  create(data: CreateWOInput): Promise<WorkOrder>;
  update(id: string, data: UpdateWOInput): Promise<WorkOrder>;
  delete(id: string): Promise<void>;

  // Status transitions
  plan(id: string, notes?: string): Promise<WorkOrder>;
  release(id: string, notes?: string): Promise<WorkOrder>;
  cancel(id: string, reason?: string): Promise<WorkOrder>;

  // BOM Selection
  getActiveBomForDate(productId: string, scheduledDate: Date): Promise<BomPreview | null>;
  getAvailableBoms(productId: string): Promise<BomPreview[]>;
  validateProductHasActiveBom(productId: string, scheduledDate: Date): Promise<BomValidationResult>;

  // Utilities
  generateNextNumber(orgId: string, date?: Date): Promise<string>;
  getStatusHistory(woId: string): Promise<WOStatusHistory[]>;
  validateStatusTransition(currentStatus: WOStatus, newStatus: WOStatus): boolean;
  canEdit(status: WOStatus, field: string): boolean;
}

// Type definitions
export type WOStatus = 'draft' | 'planned' | 'released' | 'in_progress' | 'on_hold' | 'completed' | 'closed' | 'cancelled';
export type WOPriority = 'low' | 'normal' | 'high' | 'critical';
export type SourceOfDemand = 'manual' | 'po' | 'customer_order' | 'forecast';

export interface WorkOrder {
  id: string;
  org_id: string;
  wo_number: string;
  product_id: string;
  bom_id: string | null;
  routing_id: string | null;
  planned_quantity: number;
  produced_quantity: number;
  uom: string;
  status: WOStatus;
  planned_start_date: string | null;
  planned_end_date: string | null;
  scheduled_start_time: string | null;
  scheduled_end_time: string | null;
  production_line_id: string | null;
  machine_id: string | null;
  priority: WOPriority;
  source_of_demand: SourceOfDemand | null;
  source_reference: string | null;
  expiry_date: string | null;
  notes: string | null;
  started_at: string | null;
  completed_at: string | null;
  paused_at: string | null;
  pause_reason: string | null;
  actual_qty: number | null;
  yield_percent: number | null;
  created_at: string;
  updated_at: string;
  created_by: string;
  updated_by: string | null;
}

export interface WorkOrderWithRelations extends WorkOrder {
  product?: {
    id: string;
    code: string;
    name: string;
    base_uom: string;
  };
  bom?: {
    id: string;
    code: string;
    version: number;
    output_qty: number;
    effective_from: string;
    effective_to: string | null;
    item_count: number;
  };
  routing?: {
    id: string;
    code: string;
    name: string;
  };
  production_line?: {
    id: string;
    code: string;
    name: string;
  };
  machine?: {
    id: string;
    code: string;
    name: string;
  };
  created_by_user?: {
    name: string;
  };
}

export interface WOListItem {
  id: string;
  wo_number: string;
  product_code: string;
  product_name: string;
  planned_quantity: number;
  uom: string;
  status: WOStatus;
  planned_start_date: string | null;
  production_line_name: string | null;
  priority: WOPriority;
  created_at: string;
}

export interface BomPreview {
  bom_id: string;
  bom_code: string;
  bom_version: number;
  output_qty: number;
  effective_from: string;
  effective_to: string | null;
  routing_id: string | null;
  item_count: number;
  is_current?: boolean;
}

export interface BomValidationResult {
  valid: boolean;
  bom?: BomPreview;
  error?: string;
  warning?: string;
}

export interface WOStatusHistory {
  id: string;
  wo_id: string;
  from_status: WOStatus | null;
  to_status: WOStatus;
  changed_by: string;
  changed_at: string;
  notes: string | null;
  changed_by_user?: {
    name: string;
  };
}

export interface CreateWOInput {
  product_id: string;
  bom_id?: string;  // Optional - will be auto-selected if not provided
  planned_quantity: number;
  uom?: string;  // Defaults to product base_uom
  planned_start_date: string;
  planned_end_date?: string;
  scheduled_start_time?: string;
  scheduled_end_time?: string;
  production_line_id?: string;
  machine_id?: string;
  priority?: WOPriority;
  source_of_demand?: SourceOfDemand;
  source_reference?: string;
  expiry_date?: string;
  notes?: string;
}

export interface UpdateWOInput {
  planned_quantity?: number;
  uom?: string;
  planned_start_date?: string;
  planned_end_date?: string;
  scheduled_start_time?: string;
  scheduled_end_time?: string;
  production_line_id?: string | null;
  machine_id?: string | null;
  priority?: WOPriority;
  expiry_date?: string | null;
  notes?: string | null;
  // bom_id can only be changed in draft status
  bom_id?: string;
  // product_id can only be changed in draft status
  product_id?: string;
}
```

### Validation Schema (Zod)

```typescript
// lib/validation/work-order.ts
import { z } from 'zod';

export const woStatusEnum = z.enum([
  'draft',
  'planned',
  'released',
  'in_progress',
  'on_hold',
  'completed',
  'closed',
  'cancelled'
]);

export const woPriorityEnum = z.enum(['low', 'normal', 'high', 'critical']);

export const sourceOfDemandEnum = z.enum(['manual', 'po', 'customer_order', 'forecast']);

// Time string validation (HH:mm or HH:mm:ss format)
const timeString = z.string().regex(/^([0-1]?[0-9]|2[0-3]):[0-5][0-9](:[0-5][0-9])?$/, 'Invalid time format');

// Create WO validation
export const createWOSchema = z.object({
  product_id: z.string().uuid('Invalid product ID'),
  bom_id: z.string().uuid('Invalid BOM ID').optional().nullable(),
  planned_quantity: z.number()
    .positive('Quantity must be greater than 0')
    .max(999999999, 'Quantity too large'),
  uom: z.string()
    .min(1, 'UoM is required')
    .max(20, 'UoM too long')
    .optional(),
  planned_start_date: z.string().date('Invalid date format')
    .refine(
      (date) => {
        const inputDate = new Date(date);
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);
        yesterday.setHours(0, 0, 0, 0);
        return inputDate >= yesterday;
      },
      'Scheduled date cannot be more than 1 day in the past'
    ),
  planned_end_date: z.string().date('Invalid date format').optional().nullable(),
  scheduled_start_time: timeString.optional().nullable(),
  scheduled_end_time: timeString.optional().nullable(),
  production_line_id: z.string().uuid('Invalid line ID').optional().nullable(),
  machine_id: z.string().uuid('Invalid machine ID').optional().nullable(),
  priority: woPriorityEnum.default('normal'),
  source_of_demand: sourceOfDemandEnum.optional().nullable(),
  source_reference: z.string().max(50, 'Source reference too long').optional().nullable(),
  expiry_date: z.string().date('Invalid date format').optional().nullable(),
  notes: z.string().max(2000, 'Notes too long').optional().nullable(),
}).refine(
  (data) => {
    if (data.planned_end_date && data.planned_start_date) {
      return new Date(data.planned_end_date) >= new Date(data.planned_start_date);
    }
    return true;
  },
  { message: 'End date must be on or after start date', path: ['planned_end_date'] }
).refine(
  (data) => {
    if (data.scheduled_end_time && data.scheduled_start_time) {
      // Only validate times if both are provided and dates are same
      if (!data.planned_end_date || data.planned_start_date === data.planned_end_date) {
        return data.scheduled_end_time > data.scheduled_start_time;
      }
    }
    return true;
  },
  { message: 'End time must be after start time', path: ['scheduled_end_time'] }
);

// Update WO validation
export const updateWOSchema = z.object({
  product_id: z.string().uuid('Invalid product ID').optional(),
  bom_id: z.string().uuid('Invalid BOM ID').optional().nullable(),
  planned_quantity: z.number()
    .positive('Quantity must be greater than 0')
    .max(999999999, 'Quantity too large')
    .optional(),
  uom: z.string()
    .min(1, 'UoM is required')
    .max(20, 'UoM too long')
    .optional(),
  planned_start_date: z.string().date('Invalid date format').optional(),
  planned_end_date: z.string().date('Invalid date format').optional().nullable(),
  scheduled_start_time: timeString.optional().nullable(),
  scheduled_end_time: timeString.optional().nullable(),
  production_line_id: z.string().uuid('Invalid line ID').optional().nullable(),
  machine_id: z.string().uuid('Invalid machine ID').optional().nullable(),
  priority: woPriorityEnum.optional(),
  expiry_date: z.string().date('Invalid date format').optional().nullable(),
  notes: z.string().max(2000, 'Notes too long').optional().nullable(),
});

// BOM selection query validation
export const bomForDateSchema = z.object({
  product_id: z.string().uuid('Invalid product ID'),
  scheduled_date: z.string().date('Invalid date format'),
});

// Status transition validation
export const statusTransitionSchema = z.object({
  id: z.string().uuid(),
  notes: z.string().max(500, 'Notes too long').optional(),
});

// Type exports
export type CreateWOInput = z.infer<typeof createWOSchema>;
export type UpdateWOInput = z.infer<typeof updateWOSchema>;
export type WOStatus = z.infer<typeof woStatusEnum>;
export type WOPriority = z.infer<typeof woPriorityEnum>;
export type SourceOfDemand = z.infer<typeof sourceOfDemandEnum>;
```

---

## UI Components

```
app/(authenticated)/planning/work-orders/
  page.tsx                              -- WO list page
  [id]/page.tsx                         -- WO detail/edit page
  new/page.tsx                          -- Create new WO page

components/planning/work-orders/
  WODataTable.tsx                       -- List table with sorting, filtering
  WOFilters.tsx                         -- Search + status/product/line/date filters
  WOStatusBadge.tsx                     -- Status badge with color coding
  WOPriorityBadge.tsx                   -- Priority badge (Low, Normal, High, Critical)
  WOStatusTimeline.tsx                  -- Status history timeline

  WOForm.tsx                            -- Main form container
  WOHeaderForm.tsx                      -- Header fields section
  WOProductSelect.tsx                   -- Product dropdown with BOM lookup trigger
  WOBomSelect.tsx                       -- BOM selection dropdown (manual override)
  WOLineSelect.tsx                      -- Production line dropdown
  WOMachineSelect.tsx                   -- Machine dropdown

  WOBomPreview.tsx                      -- BOM preview panel (shows selected BOM info)
  WOBomSelectionModal.tsx               -- Modal to select from available BOMs
  WOBomComparePanel.tsx                 -- Side-by-side BOM comparison (optional)

  WOSummaryPanel.tsx                    -- Summary info display
  WOSourceDisplay.tsx                   -- Source of demand display

  WOActionsBar.tsx                      -- Action buttons (save, plan, release, cancel)
  WODeleteConfirmDialog.tsx             -- Delete confirmation
  WOCancelConfirmDialog.tsx             -- Cancel confirmation with reason
  WOStatusTransitionDialog.tsx          -- Status change confirmation

  WOQuickCreate.tsx                     -- Quick create mini-form (for dashboard)
  WOPrintView.tsx                       -- Print-friendly layout
```

### Status Badge Colors (TailwindCSS)

| Status | Badge Class |
|--------|-------------|
| draft | `bg-gray-100 text-gray-800` |
| planned | `bg-blue-100 text-blue-800` |
| released | `bg-indigo-100 text-indigo-800` |
| in_progress | `bg-yellow-100 text-yellow-800` |
| on_hold | `bg-orange-100 text-orange-800` |
| completed | `bg-green-100 text-green-800` |
| closed | `bg-emerald-100 text-emerald-800` |
| cancelled | `bg-red-100 text-red-800` |

### Priority Badge Colors

| Priority | Badge Class |
|----------|-------------|
| low | `bg-slate-100 text-slate-600` |
| normal | `bg-blue-100 text-blue-700` |
| high | `bg-amber-100 text-amber-700` |
| critical | `bg-red-100 text-red-700 font-bold` |

---

## Wireframe References

- **PLA-010**: Work Order List - `/docs/3-ARCHITECTURE/ux/wireframes/PLA-010-wo-list.md`
- **PLA-011**: Work Order Detail/Form - `/docs/3-ARCHITECTURE/ux/wireframes/PLA-011-wo-detail.md`
- **PLA-012**: BOM Preview Panel - `/docs/3-ARCHITECTURE/ux/wireframes/PLA-012-bom-preview.md`

---

## Out of Scope

| Feature | Reason | Future Story |
|---------|--------|--------------|
| BOM Snapshot (wo_materials) | Separate complexity | Story 03.11a |
| Routing Operations Copy | Separate complexity | Story 03.12 |
| Material Availability Check | Requires LP table | Story 03.13 |
| Material Reservation | Requires LP table | Story 03.11b |
| Gantt Chart View | Complex visualization | Story 03.14 |
| Configurable WO Statuses | Settings feature | Story 03.17 |
| Production Execution | Production module | Epic 04 |
| Auto-WO from Forecast | MRP feature | Epic 03b (Phase 2) |

---

## Test Cases

### Unit Tests

**File:** `__tests__/unit/services/work-order-service.test.ts`

| Test Case | Description |
|-----------|-------------|
| `generateNextNumber()` generates daily sequence | Verify WO-YYYYMMDD-NNNN format |
| `generateNextNumber()` resets on new day | Sequence resets to 0001 on date change |
| `generateNextNumber()` handles concurrent requests | Sequence increments correctly |
| `create()` validates required fields | Product, quantity, date required |
| `create()` auto-selects BOM | BOM selected based on scheduled date |
| `create()` validates product has active BOM | Error when no active BOM (if required) |
| `create()` allows null BOM | When wo_require_bom = false |
| `create()` sets default priority | Priority defaults to 'normal' |
| `create()` sets source_of_demand | Manual source on direct creation |
| `update()` validates status restrictions | Cannot change product/bom after release |
| `update()` re-validates BOM on date change | BOM re-evaluated when date changes |
| `delete()` only allows draft | Non-draft returns error |
| `delete()` blocked with materials | Error when wo_materials exist |
| `plan()` validates BOM required | Cannot plan without BOM (if required) |
| `release()` validates status | Must be in 'planned' status |
| `cancel()` validates no production | Cannot cancel with production activity |
| `getActiveBomForDate()` selects correctly | Most recent effective_from <= date |
| `getActiveBomForDate()` respects effective_to | Excludes expired BOMs |
| `validateStatusTransition()` enforces rules | Valid transitions only |

### Integration Tests

**File:** `__tests__/integration/api/planning/work-orders.test.ts`

| Test Case | Description |
|-----------|-------------|
| GET `/work-orders` returns paginated list | Pagination, filters, sort |
| GET `/work-orders?status=draft` filters | Status filter |
| GET `/work-orders?product_id=X` filters | Product filter |
| GET `/work-orders?line_id=X` filters | Production line filter |
| GET `/work-orders?date_from=X&date_to=Y` filters | Date range filter |
| GET `/work-orders?priority=high` filters | Priority filter |
| POST `/work-orders` creates with auto-BOM | BOM auto-selected |
| POST `/work-orders` creates with manual BOM | Override BOM selection |
| POST `/work-orders` validates required | Missing fields return 400 |
| POST `/work-orders` validates BOM exists | Invalid bom_id returns 400 |
| POST `/work-orders` validates product has BOM | No active BOM returns 400 |
| PUT `/work-orders/:id` updates draft | All fields updatable |
| PUT `/work-orders/:id` restricts released | Product/BOM locked |
| DELETE `/work-orders/:id` draft only | Non-draft returns 400 |
| DELETE `/work-orders/:id` blocked with materials | Returns 400 |
| POST `/work-orders/:id/plan` validates | Requires valid BOM |
| POST `/work-orders/:id/release` validates | Must be planned |
| POST `/work-orders/:id/cancel` validates | No production activity |
| GET `/work-orders/bom-for-date` returns BOM | Correct BOM selected |
| GET `/work-orders/available-boms` returns all | All active BOMs listed |
| Cross-org access returns 404 | Multi-tenancy |
| Permission denied returns 403 | Role enforcement |

### E2E Tests

**File:** `__tests__/e2e/planning/work-orders.spec.ts`

| Test Case | Description |
|-----------|-------------|
| Create WO flow | Form > product > auto-BOM > qty > save |
| Create WO with BOM override | Form > product > manual BOM select > save |
| Edit WO flow | Detail > edit > modify > save |
| Plan WO flow | Draft > plan > status changes |
| Release WO flow | Planned > release > status changes |
| Cancel WO flow | Any > cancel > confirm > status |
| Delete draft WO | Draft > delete > confirm |
| Filter and search | List > filters > results |
| Sort by columns | Column headers toggle |
| Pagination | Page navigation |
| BOM auto-selection display | Select product > BOM preview shows |
| Date change BOM re-evaluation | Change date > BOM confirmation |
| Status history timeline | Detail > shows transitions |
| Permission-based UI | Different roles see different actions |
| Validation errors display | Invalid input > error messages |

---

## Key Business Rules

1. **WO Number Format**: `WO-YYYYMMDD-NNNN` (date + 4-digit sequence per org/day, resets daily)
2. **BOM Auto-Selection**: Select BOM where `effective_from <= scheduled_date` AND (`effective_to IS NULL` OR `effective_to >= scheduled_date`), ordered by `effective_from DESC`
3. **BOM Required**: By default (wo_require_bom = true), product must have active BOM for scheduled date
4. **BOM Immutability**: bom_id locked after WO status = released
5. **Product Immutability**: product_id locked after WO status = released
6. **Status Transitions**: draft -> planned -> released (execution statuses handled by Production module)
7. **Cancel Rules**: Can cancel draft/planned/released only if no production activity exists
8. **Delete Rules**: Can only delete draft WO with no wo_materials records
9. **UoM Default**: Defaults to product.base_uom if not specified
10. **Priority Default**: Defaults to 'normal' if not specified
11. **Source Tracking**: Manual creation sets source_of_demand = 'manual'

---

## Performance Requirements

| Metric | Target |
|--------|--------|
| WO List load | < 300ms |
| WO Detail load | < 500ms |
| Create WO | < 1s |
| BOM auto-selection query | < 100ms |
| Search debounce | 200ms |

---

## Definition of Done

- [ ] Database migration creates `work_orders`, `wo_status_history`, `wo_daily_sequence` tables
- [ ] All constraints and indexes created
- [ ] WO number generation function working (daily reset sequence)
- [ ] BOM auto-selection function working
- [ ] Status history trigger working
- [ ] RLS policies enforce org isolation and role permissions
- [ ] All API endpoints implemented (list, CRUD, status actions, BOM selection)
- [ ] Zod schemas validate all inputs
- [ ] `work-order-service.ts` implements all methods
- [ ] BOM auto-selection logic tested thoroughly
- [ ] WO list page with DataTable (PLA-010)
- [ ] WO detail/form page with BOM preview (PLA-011)
- [ ] Product selection triggers BOM lookup
- [ ] BOM preview panel displays correctly
- [ ] Manual BOM override modal working
- [ ] Status badges with correct colors
- [ ] Priority badges with correct colors
- [ ] Status transitions enforced with validation
- [ ] Plan/Release/Cancel actions with proper checks
- [ ] Permission matrix implemented
- [ ] Multi-tenancy: cross-org returns 404
- [ ] Unit tests >= 80% coverage
- [ ] Integration tests for all endpoints
- [ ] E2E tests for critical flows
- [ ] BOM selection edge cases tested (multiple BOMs, expired BOMs, no BOMs)
- [ ] Loading, empty, error states implemented
- [ ] Toast notifications on success/error
- [ ] Accessibility: keyboard nav, ARIA labels

---

## Future Phases (Not in MVP)

### Phase 1
- **BOM Snapshot** (Story 03.11a) - Copy BOM items to wo_materials on release
- **Routing Operations Copy** (Story 03.12) - Copy routing operations to wo_operations
- **Material Availability Check** (Story 03.13) - Check inventory against required materials
- **Material Reservation** (Story 03.11b) - Reserve LPs for WO materials

### Phase 2
- **Gantt Chart View** (Story 03.14) - Visual schedule by line/machine
- **Configurable Statuses** (Story 03.17) - Customizable status list per org
- **WO Templates** - Reusable WO configurations
- **Bulk WO Creation** - Create multiple WOs at once

### Phase 3
- **Capacity Planning Integration** - Check line capacity before scheduling
- **MRP Integration** - Auto-generate WOs from MRP suggestions
- **Production Optimization** - Sequencing and batching algorithms

**Implementation**: See Epic 03.0 "Future Feature Handling" for guidance on Phase 1+ features in UI/API.

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-12-16 | Initial story creation | ARCHITECT-AGENT |
