# Story 03.11b - Index File (Entry Point)
# Generated: 2025-12-17
# Purpose: Story metadata and dependencies - read this first
# Status: DEFERRED - Requires Epic 05 (License Plates + Genealogy)

story:
  id: "03.11b"
  name: "WO Material Reservations (LP Allocation)"
  slug: "wo-reservations"
  epic: "03-planning"
  phase: "1B"  # Deferred until Epic 05 complete
  complexity: "M"
  estimate_days: 4
  type: "backend + frontend"
  state: "deferred"

# Why Deferred
deferred_reason: |
  Material reservation requires physical inventory tracking via License Plates (LPs).
  Without the LP infrastructure from Epic 05 (Warehouse Module), there is nothing to
  reserve against. This story builds on top of the warehouse module's inventory
  management capabilities including:
  - license_plates table with LP lifecycle management
  - lp_reservations table for soft reservation tracking
  - LP status management (available, reserved, consumed, blocked)
  - FIFO/FEFO picking algorithm infrastructure

# Files in this context folder
context_files:
  - _index.yaml      # This file - metadata, dependencies
  - database.yaml    # Tables, RLS, indexes, triggers
  - api.yaml         # Endpoints, auth, errors
  - frontend.yaml    # Components, hooks, types
  - tests.yaml       # Acceptance criteria, test specifications

# Dependencies
dependencies:
  required:
    - story: "03.11a"
      name: "WO BOM Snapshot (Materials Copy)"
      provides: ["wo_materials table", "reserved_qty column"]
    - story: "03.10"
      name: "WO CRUD + BOM Auto-Select"
      provides: ["work_orders table", "WO status lifecycle"]
    - epic: "05"
      name: "Warehouse Module"
      provides: ["license_plates table", "lp_reservations infrastructure"]
    - story: "05.3"
      name: "LP Reservations"
      provides: ["LP reservation patterns", "LP status management"]
    - story: "01.1"
      name: "Org Context + Base RLS"
      provides: ["Multi-tenant isolation"]
    - story: "01.X"
      name: "Warehouses CRUD"
      provides: ["warehouse_id for LP filtering"]
  blocked_by:
    - epic: "05"
      reason: "LP table and reservation infrastructure required"
  blocks:
    - story: "04.X"
      name: "Material Consumption"
      reason: "Reservation-to-consumption conversion"

# Reference Documents
files_to_read:
  prd:
    path: "docs/1-BASELINE/product/modules/planning.md"
    sections: ["FR-PLAN-021", "FR-PLAN-025", "7.7 Material Reservation"]
  architecture:
    path: "docs/1-BASELINE/architecture/modules/planning.md"
    sections: ["Database Schema", "wo_material_reservations"]
  warehouse_architecture:
    path: "docs/1-BASELINE/architecture/modules/warehouse.md"
    sections: ["lp_reservations", "License Plate Lifecycle"]
  story:
    path: "docs/2-MANAGEMENT/epics/current/03-planning/03.11b.wo-reservations.md"
  dependency_story:
    path: "docs/2-MANAGEMENT/epics/current/03-planning/03.11a.wo-bom-snapshot.md"
  wireframes:
    path: "docs/3-ARCHITECTURE/ux/wireframes/PLAN-015-work-order-detail.md"
    sections: ["Materials section", "Reservation UI"]
  adrs:
    - path: "docs/1-BASELINE/architecture/decisions/ADR-013-rls-org-isolation-pattern.md"
      relevance: "RLS policy pattern for org isolation"

# High-level deliverables
deliverables:
  - type: "migration"
    count: 1
    description: "wo_material_reservations table + indexes + RLS + trigger"
  - type: "api"
    count: 5
    description: "Reservation CRUD endpoints"
  - type: "service"
    count: 1
    description: "wo-reservation-service.ts with FIFO/FEFO algorithms"
  - type: "validation"
    count: 1
    description: "wo-reservations.ts Zod schemas"
  - type: "component"
    count: 5
    description: "ReservedLPsList, ReserveLPModal, AvailableLPsTable, ReservationStatusBadge, WOMaterialRow update"
  - type: "test"
    count: 4
    description: "Unit (FIFO/FEFO algorithms) + Integration (API) + Complex scenarios"

# Technical notes
technical_notes:
  - "DEFERRED until Epic 05 completes - do not implement yet"
  - "Soft reservations only (same LP can be reserved by multiple WOs with warnings)"
  - "FIFO: Select oldest LPs first by created_at (receipt date)"
  - "FEFO: Select soonest-expiry LPs first (overrides FIFO when enabled)"
  - "Auto-reserve on WO release status transition"
  - "Auto-release on WO cancel"
  - "Trigger updates wo_materials.reserved_qty on reservation changes"
  - "LP filters: status='available', qa_status='passed', warehouse_id match"
  - "Over-reservation allowed with warning (soft reservation flexibility)"
  - "Immutability: Cannot modify reservations after WO completed/closed"

# Key Business Rules
business_rules:
  - rule: "Soft Reservations"
    description: "Reservations are advisory; same LP can be reserved by multiple WOs with warnings"
  - rule: "FIFO Default"
    description: "Use oldest LPs first by receipt date (created_at)"
  - rule: "FEFO Override"
    description: "If warehouse has expiry-sensitive products, soonest expiry takes priority"
  - rule: "NULL Expiry Last"
    description: "LPs without expiry dates sorted last in FEFO mode"
  - rule: "Auto-Reserve on Release"
    description: "When WO transitions to 'released', auto-reservation triggers"
  - rule: "Auto-Release on Cancel"
    description: "When WO cancelled, all reservations released"
  - rule: "LP Filters"
    description: "Only reserve from status='available', qa_status='passed' LPs"
  - rule: "Over-Reserve Warning"
    description: "Allow reserving more than LP available, but show warning"
  - rule: "Partial OK"
    description: "Partial reservations allowed; production can proceed with warnings"
  - rule: "Immutability After Complete"
    description: "Cannot modify reservations after WO completed/closed"

# Risks
risks:
  - id: "RISK-01"
    description: "Epic 05 delays block this story"
    impact: "High"
    likelihood: "Medium"
    mitigation: "Clear dependency documentation, parallel planning"
  - id: "RISK-02"
    description: "Soft reservation conflicts between WOs"
    impact: "Medium"
    likelihood: "High"
    mitigation: "Clear UI warnings, audit logging"
  - id: "RISK-03"
    description: "FEFO edge cases (same expiry date)"
    impact: "Low"
    likelihood: "Medium"
    mitigation: "FIFO tiebreaker, comprehensive tests"
  - id: "RISK-04"
    description: "Performance on large WOs (50+ materials)"
    impact: "Medium"
    likelihood: "Low"
    mitigation: "Query optimization, async processing"
  - id: "RISK-05"
    description: "Over-reservation confusion for users"
    impact: "Medium"
    likelihood: "Medium"
    mitigation: "Clear visual indicators, warnings"
