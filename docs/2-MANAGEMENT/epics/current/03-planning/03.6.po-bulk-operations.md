# 03.6 - PO Bulk Operations (Bulk Create, Import, Export)

| Field | Value |
|-------|-------|
| **Story ID** | 03.6 |
| **Epic** | 03 - Planning |
| **Status** | Ready |
| **Phase** | P1 (Phase 1) |
| **Complexity** | M (Medium) |
| **Estimate** | 3-4 days |
| **Type** | Full-stack |

---

## PRD References

| FR ID | Requirement | Priority | Covered |
|-------|-------------|----------|---------|
| FR-PLAN-008 | Bulk PO Creation | Should Have | YES |
| FR-PLAN-005 | PO CRUD | Must Have | Extends (bulk) |

**Primary PRD:** `docs/1-BASELINE/product/modules/planning.md` (Section 5.5)
**Architecture:** `docs/1-BASELINE/architecture/modules/planning.md`
**UX Wireframes:** PLA-010 (Bulk Import Wizard), PLA-011 (Export Dialog)

---

## MVP Scope

This story implements Phase 1 bulk operations for Purchase Orders, enabling efficient high-volume PO management through Excel/CSV import, automatic supplier grouping, and export capabilities.

**MVP Includes**:
- Bulk PO creation endpoint with auto-grouping by default supplier
- Excel/CSV import with comprehensive validation
- Excel export with 3 sheets (summary, lines, errors)
- Bulk status update operations (approve, confirm, cancel multiple POs)
- Import wizard UI with preview and error handling
- Batch processing with transaction safety
- Validation schemas for import data
- Comprehensive error reporting with line-level feedback
- Partial success handling (some POs succeed, some fail)

**Deferred to Phase 2+**: See "Future Phases" section below.

---

## User Story

As a **Planner or Purchaser**, I want to **import multiple purchase orders from Excel, automatically group products by supplier, and export PO data for reporting** so that **I can efficiently manage high-volume procurement without manually creating individual POs, and share order information with suppliers and management**.

---

## Dependencies

| Dependency | Story/Epic | Type | Reason |
|------------|------------|------|--------|
| 01.1 | Org Context + Base RLS | HARD | Requires org_id context and RLS patterns |
| 01.8 | Warehouses CRUD | HARD | Bulk PO requires warehouse_id validation |
| 01.13 | Tax Codes CRUD | HARD | Bulk PO requires tax_code_id validation |
| 02.1 | Products CRUD | HARD | Import requires product lookup by code/SKU |
| 03.1 | Suppliers CRUD | HARD | Auto-grouping requires supplier data |
| 03.2 | Supplier-Product Assignment | HARD | Default supplier lookup for products |
| 03.3 | PO CRUD + Lines | HARD | Bulk operations use PO creation logic |
| 03.4 | PO Totals + Tax Calculations | HARD | Bulk POs need total calculations |

**Dependents:**
- 03.5a/b (PO Approval) - Bulk approval workflow
- Epic 05 (Warehouse) - Bulk import for receiving planning

---

## Acceptance Criteria (Gherkin)

### AC-1: Bulk PO Creation from Product List (FR-PLAN-008)

```gherkin
Scenario: Create multiple POs grouped by supplier
  Given planner has a list of products with quantities:
    | Product Code  | Qty  | Expected Delivery |
    | RM-FLOUR-001  | 1000 | 2025-01-15       |
    | RM-SUGAR-001  | 500  | 2025-01-15       |
    | RM-SALT-001   | 200  | 2025-01-15       |
    | PKG-BOX-001   | 5000 | 2025-01-15       |
  And RM-FLOUR-001 and RM-SALT-001 have default supplier "Mill Co."
  And RM-SUGAR-001 has default supplier "Sugar Inc."
  And PKG-BOX-001 has default supplier "Pack Ltd."
  When planner submits bulk PO creation request
  Then system creates 3 draft POs:
    - PO-2025-0001 (Mill Co.): RM-FLOUR-001 (1000), RM-SALT-001 (200)
    - PO-2025-0002 (Sugar Inc.): RM-SUGAR-001 (500)
    - PO-2025-0003 (Pack Ltd.): PKG-BOX-001 (5000)
  And each PO has status "draft"
  And each PO inherits supplier defaults (currency, tax code, payment terms)
  And operation completes within 2 seconds for 100 lines

Scenario: Handle products without default supplier
  Given planner includes product "RM-MISC-001" without default supplier
  When bulk PO creation runs
  Then system creates validation error:
    - Error: "Product RM-MISC-001 has no default supplier assigned"
    - Line: [line number in input]
  And no PO is created for that product
  And other valid products proceed successfully
```

### AC-2: Excel/CSV Import with Validation

```gherkin
Scenario: Import POs from Excel file
  Given planner navigates to /planning/purchase-orders
  When planner clicks "Import POs" button
  Then Import Wizard modal opens
  And wizard shows Step 1: Upload File

Scenario: Upload and validate Excel file
  Given Import Wizard is open on Step 1
  When planner uploads Excel file with columns:
    | Product Code | Quantity | Expected Delivery | Notes |
  Then system validates file format
  And parses all rows
  And displays Step 2: Preview & Validate
  And shows preview table with 50 rows max
  And indicates validation status per row

Scenario: Display validation errors in preview
  Given planner uploaded file with errors:
    | Row | Product Code | Qty  | Error |
    | 2   | INVALID-SKU  | 100  | Product not found |
    | 5   | RM-FLOUR-001 | -50  | Quantity must be positive |
    | 7   | RM-SUGAR-001 |      | Quantity is required |
  When preview displays
  Then error rows are highlighted in red
  And error messages show in "Error" column
  And valid rows are highlighted in green
  And summary shows: "3 errors, 12 valid rows"
  And "Continue" button is enabled if any valid rows exist

Scenario: Excel import format validation
  Given planner uploads Excel file
  When system validates format
  Then required columns are: Product Code, Quantity
  And optional columns are: Expected Delivery, Notes, Unit Price, Warehouse
  And missing required columns trigger error:
    "Missing required column: [column name]"
  And extra columns are ignored with warning

Scenario: CSV import support
  Given planner uploads CSV file (comma-delimited)
  When system processes file
  Then CSV is parsed identically to Excel
  And same validation rules apply
  And preview shows same format
```

### AC-3: Import Wizard Multi-Step Flow

```gherkin
Scenario: Complete import wizard flow
  Given planner on Import Wizard Step 2 (Preview)
  And 15 valid rows, 3 error rows
  When planner reviews preview
  And clicks "Create POs" button
  Then wizard advances to Step 3: Processing
  And progress bar displays: "Creating POs... 0/15"
  And POs are created in batches (supplier groups)
  And progress updates: "Creating POs... 15/15"
  And wizard advances to Step 4: Results

Scenario: Display import results summary
  Given import processing completed
  When Step 4: Results displays
  Then summary shows:
    - "Successfully created 3 POs from 15 lines"
    - List of created POs with links:
      - PO-2025-0001 (Mill Co.) - 8 lines - $12,450.00
      - PO-2025-0002 (Sugar Inc.) - 4 lines - $3,200.00
      - PO-2025-0003 (Pack Ltd.) - 3 lines - $5,600.00
  And "View POs" button navigates to PO list filtered by created POs
  And "Download Results" button exports Excel with 3 sheets (see AC-4)

Scenario: Handle partial import failure
  Given import with 15 valid rows
  And database constraint fails for 1 product (out of stock, etc.)
  When import processes
  Then successful POs are committed
  And failed rows are reported in results:
    - "Created 2 POs (12 lines)"
    - "Failed: 3 lines (see errors below)"
  And error list shows failed rows with reasons
  And "Download Errors" button exports error details
```

### AC-4: Excel Export (3 Sheets)

```gherkin
Scenario: Export POs to Excel
  Given planner on PO list page
  And 5 POs are selected (or all if none selected)
  When planner clicks "Export" button
  Then Excel file downloads: "POs_Export_YYYY-MM-DD_HHMMSS.xlsx"
  And file contains 3 sheets: Summary, Lines, Metadata

Scenario: Export Sheet 1 - Summary
  Given export includes 3 POs
  When Summary sheet is opened
  Then columns are:
    | PO Number | Supplier | Status | Expected Delivery | Currency | Subtotal | Tax | Total | Created Date | Created By |
  And each PO appears as 1 row
  And totals row at bottom sums: Subtotal, Tax, Total
  And header row is frozen (row 1)
  And columns are auto-sized

Scenario: Export Sheet 2 - Lines
  Given export includes 3 POs with total 20 lines
  When Lines sheet is opened
  Then columns are:
    | PO Number | Line # | Product Code | Product Name | Quantity | UOM | Unit Price | Line Total | Expected Delivery | Notes |
  And all 20 lines appear (grouped by PO Number)
  And PO Number column uses grouping/freeze for readability
  And totals row sums: Quantity, Line Total

Scenario: Export Sheet 3 - Metadata
  Given export file generated
  When Metadata sheet is opened
  Then information shows:
    | Field | Value |
    | Export Date | 2025-12-16 14:30:00 |
    | Exported By | John Planner |
    | Organization | Acme Foods Inc. |
    | Total POs | 3 |
    | Total Lines | 20 |
    | Total Value | $21,250.00 |
    | Filters Applied | Status: Draft, Supplier: Mill Co. |
  And this sheet is read-only reference

Scenario: Export filtered PO list
  Given planner applied filters: Status = "Draft", Supplier = "Mill Co."
  And 8 POs match filter
  When planner clicks "Export"
  Then only filtered 8 POs are exported
  And Metadata sheet shows: "Filters Applied: Status: Draft, Supplier: Mill Co."
```

### AC-5: Bulk Status Update

```gherkin
Scenario: Bulk approve multiple POs
  Given planner on PO list
  And selects 5 POs with status "pending_approval"
  When planner clicks "Bulk Actions" > "Approve"
  Then confirmation dialog shows:
    - "Approve 5 POs?"
    - List of PO numbers
  When planner confirms
  Then all 5 POs transition to "approved" status
  And success toast: "5 POs approved successfully"
  And PO list refreshes to show updated statuses
  And operation completes within 1 second

Scenario: Bulk cancel with validation
  Given planner selects 3 POs: Draft, Submitted, Receiving
  When planner clicks "Bulk Actions" > "Cancel"
  Then system validates each PO can be cancelled
  And PO "Receiving" fails validation (has receipts)
  And confirmation dialog shows:
    - "Cancel 2 POs? (1 cannot be cancelled)"
    - Valid: PO-2025-0001 (Draft), PO-2025-0002 (Submitted)
    - Invalid: PO-2025-0003 (Receiving - has receipts)
  When planner confirms
  Then 2 valid POs are cancelled
  And error message shows: "2 cancelled, 1 failed: PO-2025-0003 (has receipts)"

Scenario: Bulk status update permissions
  Given user has role "Purchaser" (no approve permission)
  And selects POs with status "pending_approval"
  When user clicks "Bulk Actions" > "Approve"
  Then error message: "You do not have permission to approve POs"
  And no status changes occur
```

### AC-6: Batch Processing & Transaction Safety

```gherkin
Scenario: Bulk import with transaction rollback
  Given import file with 50 products
  And products 1-40 are valid
  And product 41 violates unique constraint (duplicate in file)
  When import processes as single transaction per supplier group
  Then Supplier Group 1 (products 1-30) commits successfully
  And Supplier Group 2 (products 31-50, includes duplicate) rolls back entirely
  And results show:
    - "Created 1 PO (30 lines)"
    - "Failed 1 PO (20 lines): Duplicate product code in file"
  And database remains consistent

Scenario: Bulk status update atomic operation
  Given bulk approve 10 POs
  And PO #5 fails approval rule (exceeds threshold without manager)
  When bulk operation runs
  Then operation is NOT fully atomic (partial success allowed)
  And POs 1-4, 6-10 approve successfully
  And PO 5 remains "pending_approval"
  And results show: "9 approved, 1 failed: PO-2025-0005 (exceeds approval threshold)"

Scenario: Performance for large bulk operations
  Given import file with 500 products across 20 suppliers
  When planner submits bulk import
  Then processing completes within 30 seconds
  And progress bar updates every 5%
  And UI remains responsive during processing
  And batch processing uses 50 lines per batch
```

### AC-7: Service Layer Implementation

```gherkin
Scenario: Service method - bulkCreatePOs
  Given service receives product list with quantities
  When bulkCreatePOs() is called
  Then method groups products by default supplier
  And validates all products have default supplier
  And creates draft PO per supplier group
  And copies supplier defaults to each PO
  And adds lines with pricing from supplier-product or std_price
  And calculates totals for each PO
  And returns array of created POs with success/error per group

Scenario: Service method - validateImportData
  Given service receives parsed Excel/CSV rows
  When validateImportData() is called
  Then method validates each row:
    - Product code exists
    - Quantity is positive number
    - Expected delivery is valid date (if provided)
    - Unit price is positive (if provided)
    - Warehouse exists (if provided)
  And returns validation results with errors per row
  And validation completes within 100ms per 100 rows
```

### AC-8: Validation Schemas (Zod)

```gherkin
Scenario: Import row validation schema
  Given Zod schema: BulkPOImportRowSchema
  When validating import row:
    {
      product_code: "RM-FLOUR-001",
      quantity: 1000,
      expected_delivery: "2025-01-15",
      unit_price: 1.25,
      notes: "Urgent order"
    }
  Then schema validates:
    - product_code: non-empty string, max 50 chars
    - quantity: positive number, max 999999.99
    - expected_delivery: optional, ISO date string or Date object
    - unit_price: optional, positive number
    - notes: optional, max 500 chars
  And validation passes
  And parsed data includes type-safe values

Scenario: Bulk status update validation
  Given Zod schema: BulkStatusUpdateSchema
  When validating request:
    {
      po_ids: ["uuid1", "uuid2", "uuid3"],
      action: "approve",
      reason: "Approved by manager"
    }
  Then schema validates:
    - po_ids: array of UUIDs, min 1, max 100
    - action: enum ["approve", "reject", "cancel", "confirm"]
    - reason: optional string, max 500 chars
  And validation passes
```

### AC-9: Error Handling & User Feedback

```gherkin
Scenario: Import file format errors
  Given planner uploads text file (.txt)
  When system validates file type
  Then error message displays:
    "Invalid file format. Please upload .xlsx or .csv file."
  And file upload resets
  And planner can retry

Scenario: Import with all rows invalid
  Given planner uploads file with 10 rows
  And all 10 rows have validation errors
  When preview displays
  Then error summary shows: "10 errors, 0 valid rows"
  And "Create POs" button is disabled
  And message displays: "Fix errors before continuing or cancel import"
  And "Download Errors" button exports error list for correction

Scenario: Export with no POs selected
  Given planner on PO list
  And no POs are selected
  And list has 50 POs
  When planner clicks "Export"
  Then confirmation dialog asks: "Export all 50 POs?"
  When planner confirms
  Then all 50 POs export to Excel

Scenario: Bulk operation timeout handling
  Given planner initiates bulk import of 1000 products
  And operation exceeds 60 second timeout
  When timeout occurs
  Then error message: "Import timed out. Please split file into smaller batches (<500 rows)."
  And partial results are NOT committed (rollback)
  And planner can retry with smaller file
```

### AC-10: Future Features (Phase 2+)

Features deferred to Phase 2+:
- Import with auto-supplier assignment from price lists
- Import templates with custom field mapping
- Scheduled/recurring imports from SFTP/cloud storage
- Export to supplier-specific formats (EDI, XML)
- Bulk edit PO fields (warehouse, delivery date) via import
- Import validation against inventory levels
- Multi-currency import with conversion rates

**Implementation**: Per Epic 03.0 guidance, these features are documented but not implemented. No UI placeholders needed.

---

## Implementation Notes

### API Endpoints

```typescript
// Bulk PO creation from product list
POST /api/planning/purchase-orders/bulk-create
Request: {
  products: Array<{
    product_code: string;
    quantity: number;
    expected_delivery?: string;
    unit_price?: number;
    notes?: string;
  }>;
  default_warehouse_id?: string;
  default_expected_delivery?: string;
}
Response: {
  success: boolean;
  pos_created: Array<{
    po_id: string;
    po_number: string;
    supplier_id: string;
    supplier_name: string;
    line_count: number;
    total: number;
  }>;
  errors: Array<{
    product_code: string;
    error: string;
  }>;
}

// Import validation (parse & validate without creating)
POST /api/planning/purchase-orders/import/validate
Request: FormData with file
Response: {
  valid_rows: number;
  error_rows: number;
  preview: Array<{
    row_number: number;
    product_code: string;
    quantity: number;
    supplier_name?: string;
    errors?: string[];
  }>;
}

// Import execution (create POs from validated data)
POST /api/planning/purchase-orders/import/execute
Request: {
  rows: Array<BulkPOImportRow>;
  default_warehouse_id?: string;
}
Response: Same as bulk-create

// Export POs to Excel
POST /api/planning/purchase-orders/export
Request: {
  po_ids?: string[];  // If empty, export all (with filters)
  filters?: {
    status?: string;
    supplier_id?: string;
    date_from?: string;
    date_to?: string;
  };
}
Response: File download (application/vnd.openxmlformats-officedocument.spreadsheetml.sheet)

// Bulk status update
POST /api/planning/purchase-orders/bulk-status-update
Request: {
  po_ids: string[];
  action: 'approve' | 'reject' | 'cancel' | 'confirm';
  reason?: string;
}
Response: {
  success_count: number;
  error_count: number;
  errors: Array<{
    po_id: string;
    po_number: string;
    error: string;
  }>;
}
```

### Database

**Tables Used:**
- `purchase_orders` - PO headers (from 03.3)
- `purchase_order_lines` - PO line items (from 03.3)
- `products` - Product lookup by code
- `suppliers` - Supplier defaults
- `supplier_products` - Default supplier per product, pricing
- `warehouses` - Warehouse validation
- `tax_codes` - Tax calculation

**No schema changes required** - Uses existing tables from 03.3.

**Batch Processing Strategy:**
```sql
-- Create POs in transaction per supplier group
BEGIN;
  INSERT INTO purchase_orders (org_id, supplier_id, ...) VALUES (...);
  INSERT INTO purchase_order_lines (po_id, product_id, ...)
    SELECT ... FROM unnest($1::uuid[], $2::decimal[]);
COMMIT;
```

**Performance Indexes:**
- `products(org_id, code)` - For product lookup by code (existing)
- `supplier_products(product_id, is_default)` - For default supplier lookup (existing)

**RLS Policies:**
All existing RLS policies from 03.3 apply (org isolation).

### Frontend Components

**Pages:**
- `app/(authenticated)/planning/purchase-orders/page.tsx` - PO list page (existing, add Import/Export buttons)

**New Components:**
- `components/planning/purchase-orders/ImportWizard.tsx` - Multi-step import wizard
  - `ImportWizardStepUpload.tsx` - Step 1: File upload
  - `ImportWizardStepPreview.tsx` - Step 2: Preview & validation
  - `ImportWizardStepProcessing.tsx` - Step 3: Progress indicator
  - `ImportWizardStepResults.tsx` - Step 4: Results summary
- `components/planning/purchase-orders/BulkCreateModal.tsx` - Manual bulk creation form
- `components/planning/purchase-orders/BulkActionsMenu.tsx` - Bulk actions dropdown
- `components/planning/purchase-orders/ExportDialog.tsx` - Export configuration dialog
- `components/planning/purchase-orders/ImportPreviewTable.tsx` - Preview table with validation highlights
- `components/planning/purchase-orders/ImportErrorList.tsx` - Error details display

**Shared Components Used:**
- `Dialog` (ShadCN) - for modals/wizards
- `Button` (ShadCN)
- `DataTable` (ShadCN) - for preview
- `Progress` (ShadCN) - for processing indicator
- `Alert` (ShadCN) - for error/success messages
- `FileUpload` (custom) - for Excel/CSV upload
- `DropdownMenu` (ShadCN) - for bulk actions

### Services

**PO Bulk Service:** `lib/services/po-bulk-service.ts`
```typescript
interface POBulkService {
  // Bulk creation
  bulkCreatePOs(data: BulkCreatePOInput): Promise<BulkCreatePOResult>;

  // Import operations
  parseImportFile(file: File): Promise<ParsedImportData>;
  validateImportData(rows: ImportRow[]): Promise<ValidationResult>;
  executeImport(rows: ImportRow[], options: ImportOptions): Promise<BulkCreatePOResult>;

  // Export operations
  exportPOsToExcel(poIds: string[], filters?: POFilters): Promise<Blob>;
  generateExcelSummarySheet(pos: PO[]): WorkSheet;
  generateExcelLinesSheet(pos: PO[]): WorkSheet;
  generateExcelMetadataSheet(exportInfo: ExportMetadata): WorkSheet;

  // Bulk status updates
  bulkUpdateStatus(poIds: string[], action: BulkAction, reason?: string): Promise<BulkUpdateResult>;
  validateBulkStatusChange(poIds: string[], action: BulkAction): Promise<ValidationResult>;
}

interface BulkCreatePOInput {
  products: Array<{
    product_code: string;
    quantity: number;
    expected_delivery?: string;
    unit_price?: number;
    notes?: string;
  }>;
  default_warehouse_id?: string;
  default_expected_delivery?: string;
}

interface BulkCreatePOResult {
  success: boolean;
  pos_created: POSummary[];
  errors: BulkError[];
  total_lines: number;
  total_value: number;
}

interface ValidationResult {
  valid_rows: ImportRow[];
  error_rows: ImportRowError[];
  summary: {
    total: number;
    valid: number;
    errors: number;
  };
}
```

**Excel Service:** `lib/services/excel-service.ts`
```typescript
interface ExcelService {
  parseFile(file: File): Promise<any[][]>;
  createWorkbook(): Workbook;
  addSheet(workbook: Workbook, name: string, data: any[][]): WorkSheet;
  formatCurrency(value: number): string;
  formatDate(date: Date): string;
  autoSizeColumns(sheet: WorkSheet): void;
  freezeHeaderRow(sheet: WorkSheet): void;
  downloadWorkbook(workbook: Workbook, filename: string): void;
}
```

### Validation (Zod)

**Import Validation:** `lib/validation/po-bulk-schemas.ts`
```typescript
import { z } from 'zod';

// Single import row schema
export const BulkPOImportRowSchema = z.object({
  product_code: z.string()
    .min(1, "Product code is required")
    .max(50, "Product code too long"),
  quantity: z.number()
    .positive("Quantity must be positive")
    .max(999999.99, "Quantity too large"),
  expected_delivery: z.string()
    .datetime()
    .optional()
    .or(z.date().optional()),
  unit_price: z.number()
    .nonnegative("Unit price cannot be negative")
    .optional(),
  notes: z.string()
    .max(500, "Notes too long")
    .optional(),
  warehouse_code: z.string()
    .max(20)
    .optional(),
});

export type BulkPOImportRow = z.infer<typeof BulkPOImportRowSchema>;

// Bulk create request schema
export const BulkCreatePORequestSchema = z.object({
  products: z.array(BulkPOImportRowSchema)
    .min(1, "At least one product required")
    .max(500, "Maximum 500 products per batch"),
  default_warehouse_id: z.string().uuid().optional(),
  default_expected_delivery: z.string().datetime().optional(),
});

// Bulk status update schema
export const BulkStatusUpdateSchema = z.object({
  po_ids: z.array(z.string().uuid())
    .min(1, "At least one PO required")
    .max(100, "Maximum 100 POs per bulk operation"),
  action: z.enum(['approve', 'reject', 'cancel', 'confirm']),
  reason: z.string()
    .max(500)
    .optional(),
});

// Export request schema
export const POExportRequestSchema = z.object({
  po_ids: z.array(z.string().uuid()).optional(),
  filters: z.object({
    status: z.string().optional(),
    supplier_id: z.string().uuid().optional(),
    date_from: z.string().datetime().optional(),
    date_to: z.string().datetime().optional(),
  }).optional(),
});
```

### Key Business Rules

1. **Auto-Grouping by Supplier**
   - Each product MUST have exactly one default supplier (`supplier_products.is_default = true`)
   - Products without default supplier cause validation error
   - One PO created per supplier group
   - PO number auto-generated sequentially per organization

2. **Pricing Defaults**
   - If `unit_price` provided in import, use it
   - Else if `supplier_products.unit_price` exists, use it
   - Else if `products.std_price` exists, use it
   - Else fail validation with error: "No price available for product"

3. **Supplier Defaults Inheritance**
   - Each PO inherits from supplier: `currency`, `tax_code_id`, `payment_terms`
   - Warehouse defaults to `default_warehouse_id` if provided, else first active warehouse

4. **Transaction Safety**
   - Each supplier group (PO + lines) is ONE database transaction
   - If any line in group fails, entire PO group rolls back
   - Other supplier groups proceed independently
   - Partial success is allowed across supplier groups

5. **Bulk Status Update Rules**
   - Only POs in valid source state can transition (per status lifecycle from 03.3)
   - User must have permission for action (approve requires `purchase_orders.approve` permission)
   - POs with blocking conditions fail individually (e.g., cannot cancel if has receipts)
   - Successful updates logged in audit trail

6. **Import File Limits**
   - Maximum 500 rows per import (UX guidance to split larger files)
   - Maximum file size: 5MB
   - Timeout: 60 seconds (split if exceeded)
   - Supported formats: .xlsx, .csv (UTF-8)

7. **Export Limits**
   - Maximum 1000 POs per export
   - If selection exceeds limit, show warning and allow filter/selection
   - Export filename includes timestamp for versioning

8. **Validation Error Handling**
   - Row-level validation errors do NOT block other rows
   - Preview shows ALL rows (valid + errors) for user review
   - User can download error list as Excel for correction
   - User can proceed with valid rows only (skip errors)

---

## Deliverables

### API Routes
- `POST /api/planning/purchase-orders/bulk-create` - Bulk PO creation
- `POST /api/planning/purchase-orders/import/validate` - Import validation
- `POST /api/planning/purchase-orders/import/execute` - Import execution
- `POST /api/planning/purchase-orders/export` - Excel export
- `POST /api/planning/purchase-orders/bulk-status-update` - Bulk status change

### Components
- `ImportWizard.tsx` + 4 step components
- `BulkCreateModal.tsx`
- `BulkActionsMenu.tsx`
- `ExportDialog.tsx`
- `ImportPreviewTable.tsx`
- `ImportErrorList.tsx`

### Services
- `lib/services/po-bulk-service.ts` - Bulk operations service
- `lib/services/excel-service.ts` - Excel parsing/generation

### Validation Schemas
- `lib/validation/po-bulk-schemas.ts` - Zod schemas for bulk operations

### Tests
- **Unit Tests (Vitest)**
  - `po-bulk-service.test.ts` - Service methods
    - bulkCreatePOs with valid/invalid products
    - Auto-grouping by supplier logic
    - Pricing defaults cascade
    - Transaction rollback on error
    - Bulk status validation
  - `excel-service.test.ts` - Excel parsing/generation
    - Parse .xlsx and .csv files
    - Generate 3-sheet workbook
    - Handle malformed files
  - `po-bulk-schemas.test.ts` - Validation schemas
    - Valid/invalid import rows
    - Bulk operation limits
    - Error messages

- **Integration Tests**
  - `POST /api/planning/purchase-orders/bulk-create`
    - Success with 3 suppliers, 20 products
    - Partial failure (1 supplier group fails)
    - Validation errors (missing supplier, invalid price)
    - Performance: 100 products < 5 seconds
  - `POST /api/planning/purchase-orders/import/execute`
    - Excel file upload and parsing
    - CSV file upload
    - Validation error handling
    - Timeout handling (500+ rows)
  - `POST /api/planning/purchase-orders/export`
    - Export 3 POs to Excel
    - Verify 3 sheets (Summary, Lines, Metadata)
    - Filtered export
    - Empty selection (export all)
  - `POST /api/planning/purchase-orders/bulk-status-update`
    - Bulk approve 10 POs
    - Partial failure (1 PO invalid status)
    - Permission validation

- **E2E Tests (Playwright)**
  - Import wizard happy path:
    1. Upload Excel file
    2. Review preview (10 valid, 2 errors)
    3. Create POs
    4. Verify 3 POs created
    5. Download results
  - Bulk export:
    1. Filter PO list (status = Draft)
    2. Click Export
    3. Verify Excel download
    4. Validate Excel structure (3 sheets)
  - Bulk status update:
    1. Select 5 POs
    2. Bulk Actions > Approve
    3. Confirm dialog
    4. Verify status changed to "approved"

---

## Definition of Done

- [ ] All 10 Acceptance Criteria passing (Gherkin scenarios)
- [ ] API endpoints implemented with request/response validation
- [ ] Import wizard UI complete (4 steps: Upload, Preview, Processing, Results)
- [ ] Excel export generates 3 sheets (Summary, Lines, Metadata)
- [ ] Bulk status update with permission checks
- [ ] Auto-grouping by supplier logic correct (1 PO per supplier)
- [ ] Transaction safety: rollback on supplier group failure
- [ ] Zod validation schemas for import/export/bulk operations
- [ ] Unit tests passing (>80% coverage for service methods)
- [ ] Integration tests for all 5 API endpoints
- [ ] E2E smoke test: Import Excel → Create 3 POs → Export → Bulk Approve
- [ ] Error handling for malformed files, validation errors, timeouts
- [ ] Performance: 100 products bulk create < 5 seconds
- [ ] Performance: 500 row import < 30 seconds
- [ ] RLS policies verified (org isolation on bulk operations)
- [ ] Partial success handling with detailed error reporting
- [ ] File upload size limit (5MB) enforced
- [ ] Import row limit (500) enforced with UX guidance
- [ ] Export PO limit (1000) enforced with warning
- [ ] Code review approved
- [ ] Manual QA on dev environment
- [ ] Documentation updated (API docs, user guide for import format)

---

## Future Phases (Not in MVP)

### Phase 2
- **Import Templates** - Save custom field mappings for recurring imports
- **Auto-Supplier Assignment** - Lookup supplier from price lists during import (not just default)
- **Multi-Currency Import** - Import with currency conversion rates
- **Scheduled Imports** - SFTP/cloud storage polling for automated imports
- **Bulk Edit via Import** - Update existing POs (warehouse, delivery date) via Excel
- **Supplier-Specific Export Formats** - EDI, XML, custom templates
- **Import Validation vs Inventory** - Warn if order exceeds available stock

### Phase 3
- **Advanced Import Mapping** - UI for mapping Excel columns to PO fields
- **Import from Email Attachments** - Parse supplier emails for PO creation
- **Approval Workflow in Bulk Import** - Auto-submit imported POs for approval
- **Integration with Supplier Portals** - Direct import from supplier APIs
- **Audit Trail for Bulk Operations** - Detailed logs for bulk imports/exports

**Implementation**: See Epic 03.0 "Future Feature Handling" section. No UI placeholders required for Phase 2+ features.

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-12-16 | Initial story creation | ARCHITECT-AGENT |
