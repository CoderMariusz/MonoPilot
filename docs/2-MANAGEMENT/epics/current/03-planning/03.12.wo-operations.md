# 03.12 - WO Operations (Routing Copy)

| Field | Value |
|-------|-------|
| **Story ID** | 03.12 |
| **Epic** | 03 - Planning |
| **Status** | Ready |
| **Phase** | MVP (P0) |
| **Complexity** | M (Medium) |
| **Estimate** | 3-4 days |
| **Type** | Full-stack |

---

## PRD References

| FR ID | Requirement | Priority | Covered |
|-------|-------------|----------|---------|
| FR-PLAN-020 | Routing Copy (wo_operations) | Should Have | YES |
| FR-PLAN-022 | WO Status Lifecycle | Must Have | YES (operation-level tracking) |
| FR-PLAN-017 | WO CRUD | Must Have | NO - Story 03.10 |
| FR-PLAN-019 | BOM Snapshot (wo_materials) | Must Have | NO - Story 03.11a |

**Primary PRD:** `docs/1-BASELINE/product/modules/planning.md` (Section 7.5)
**Architecture:** `docs/1-BASELINE/architecture/modules/planning.md`
**UX Wireframes:** PLA-013 (WO Operations Timeline), PLA-014 (Operation Detail Panel)

---

## MVP Scope

This story implements Phase 0 (MVP) functionality for Work Order operations routing copy. When a WO has an associated routing (inherited from BOM or manually assigned), the routing operations are copied to `wo_operations` on WO release to create an immutable snapshot of the production steps.

**MVP Includes**:
- Complete `wo_operations` table schema with RLS policies
- Automatic routing copy on WO release (triggered by story 03.10's release action)
- Operation sequence preservation from routing_operations
- Machine and line assignment per operation (inherited from routing)
- Expected duration tracking (duration + setup_time + cleanup_time)
- Operation status lifecycle (pending, in_progress, completed, skipped)
- Operations timeline UI component on WO detail page
- API endpoint to retrieve WO operations
- Service layer methods for routing copy logic
- Validation to ensure operations copied only once per WO
- Settings toggle `wo_copy_routing` to enable/disable feature

**Deferred to Phase 1+**: See "Future Phases" section below.

---

## User Story

As a **Production Manager or Planner**, I want **work order operations to be automatically copied from the routing when I release a WO** so that **production operators have a clear sequence of steps to follow and we can track progress through each operation stage with the exact routing snapshot used at WO creation time**.

---

## Dependencies

| Dependency | Story/Epic | Type | Reason |
|------------|------------|------|--------|
| 01.1 | Org Context + Base RLS | HARD | Requires org_id context and RLS patterns |
| 01.9 | Production Lines CRUD | SOFT | wo_operations can reference production_line_id |
| 01.10 | Machines CRUD | SOFT | wo_operations can reference machine_id |
| 02.7 | Routings CRUD | HARD | Source of routing data |
| 02.8 | Routing Operations CRUD | HARD | Source routing_operations table to copy from |
| 03.10 | WO CRUD | HARD | WO header must exist, routing_id FK, release action |

**Dependents:**
- Epic 04 (Production) - Executes WO operations, updates actual times/yields
- 03.14 (WO Gantt Chart) - Visualizes operations timeline

---

## Acceptance Criteria (Gherkin)

### AC-1: Routing Copy on WO Release (FR-PLAN-020)

```gherkin
Scenario: Copy routing operations on WO release
  Given WO exists with status "planned"
  And WO has routing_id assigned (from BOM or manual)
  And routing has 3 operations: Mixing (seq 1), Baking (seq 2), Cooling (seq 3)
  And setting wo_copy_routing = true
  When planner releases WO
  Then 3 wo_operations records created
  And sequences match routing: 1, 2, 3
  And operation names copied: Mixing, Baking, Cooling
  And machine_id copied from routing operations
  And line_id copied from routing operations
  And expected_duration_minutes = routing.duration + routing.setup_time + routing.cleanup_time
  And all operations start with status "pending"

Scenario: No routing copy when routing_id is null
  Given WO exists with status "planned"
  And WO has routing_id = null (no routing assigned)
  When planner releases WO
  Then no wo_operations records created
  And WO releases successfully

Scenario: Routing copy disabled in settings
  Given WO exists with status "planned"
  And WO has routing_id assigned
  And setting wo_copy_routing = false
  When planner releases WO
  Then no wo_operations records created
  And WO releases successfully

Scenario: Prevent duplicate copy on re-release
  Given WO was previously released and wo_operations exist
  And WO was moved back to planned status
  When planner releases WO again
  Then existing wo_operations preserved (not duplicated)
  And no new wo_operations created

Scenario: Empty routing (no operations)
  Given WO has routing_id assigned
  And routing exists but has 0 routing_operations
  When planner releases WO
  Then no wo_operations created
  And WO releases successfully
  And warning "Routing has no operations to copy" logged
```

### AC-2: wo_operations Data Mapping (FR-PLAN-020)

```gherkin
Scenario: Operation name and description copy
  Given routing operation has name "Mixing" and description "Mix ingredients for 15 minutes"
  When routing copied to WO
  Then wo_operation.operation_name = "Mixing"
  And wo_operation.description = "Mix ingredients for 15 minutes"

Scenario: Sequence preservation
  Given routing has operations with sequences: 10, 20, 30
  When routing copied to WO
  Then wo_operations have sequences: 10, 20, 30
  And sequence order maintained

Scenario: Machine assignment copy
  Given routing operation seq 1 has machine_id = M123
  When routing copied to WO
  Then wo_operation seq 1 has machine_id = M123

Scenario: Line assignment copy
  Given routing operation seq 2 has line_id = L456
  When routing copied to WO
  Then wo_operation seq 2 has line_id = L456

Scenario: Expected duration calculation
  Given routing operation has:
    - duration = 60 minutes
    - setup_time = 15 minutes
    - cleanup_time = 10 minutes
  When routing copied to WO
  Then wo_operation.expected_duration_minutes = 85 (60 + 15 + 10)

Scenario: Expected yield copy
  Given routing operation has expected_yield_percent = 95.5
  When routing copied to WO
  Then wo_operation.expected_yield_percent = 95.5

Scenario: Instructions copy
  Given routing operation has instructions "Step 1: Preheat oven\nStep 2: Load product"
  When routing copied to WO
  Then wo_operation.instructions = "Step 1: Preheat oven\nStep 2: Load product"

Scenario: Null values handling
  Given routing operation has machine_id = null and line_id = null
  When routing copied to WO
  Then wo_operation.machine_id = null and wo_operation.line_id = null
  And no errors raised
```

### AC-3: wo_operations Status Lifecycle (FR-PLAN-022)

```gherkin
Scenario: Initial status on copy
  Given routing operations copied to WO
  When wo_operations created
  Then all operations have status = "pending"
  And started_at, completed_at, started_by, completed_by all null

Scenario: Operation status progression
  Given wo_operation exists with status "pending"
  When operator starts operation
  Then status changes to "in_progress"
  And started_at = current timestamp
  And started_by = operator user_id

Scenario: Complete operation
  Given wo_operation status "in_progress"
  When operator completes operation
  Then status changes to "completed"
  And completed_at = current timestamp
  And completed_by = operator user_id
  And actual_duration_minutes calculated = completed_at - started_at (in minutes)

Scenario: Skip operation
  Given wo_operation status "pending"
  When operator marks operation as skipped
  Then status changes to "skipped"
  And skip_reason recorded
  And actual_duration_minutes = 0

Scenario: Actual yield tracking
  Given wo_operation status "in_progress"
  When operator completes with actual_yield_percent = 92.3
  Then actual_yield_percent = 92.3
  And variance_percent = expected_yield_percent - actual_yield_percent
```

### AC-4: WO Operations Timeline UI (FR-PLAN-020)

```gherkin
Scenario: Operations timeline display on WO detail
  Given WO has 3 wo_operations
  When planner views WO detail page
  Then operations timeline component displays
  And shows all 3 operations in sequence order
  And each shows: sequence, name, machine, line, expected duration, status

Scenario: Operation status visual indicators
  Given wo_operations with statuses: pending, in_progress, completed
  When viewing timeline
  Then pending operations show gray badge
  And in_progress operations show yellow badge
  And completed operations show green badge
  And skipped operations show red badge with strikethrough

Scenario: Operation detail panel
  Given planner clicks on operation "Mixing"
  When operation detail panel opens
  Then shows: full description, instructions, expected times, actual times, yield data
  And shows started_by and completed_by user names
  And shows duration variance (actual vs expected)

Scenario: Empty state when no operations
  Given WO has routing_id = null or wo_copy_routing = false
  When viewing WO detail
  Then operations timeline shows message "No routing operations defined for this work order"
  And no timeline/list displayed

Scenario: Operations timeline read-only for planner
  Given user is PLANNER role
  When viewing operations timeline
  Then operations displayed in read-only mode
  And no start/complete buttons visible
  And note: "Operations executed by production operators in Production module"
```

### AC-5: API Endpoints (FR-PLAN-020)

```gherkin
Scenario: Get WO operations list
  Given WO has 5 wo_operations
  When calling GET /api/planning/work-orders/:wo_id/operations
  Then returns array of 5 operations
  And ordered by sequence ASC
  And includes: id, sequence, operation_name, machine, line, status, expected/actual times

Scenario: Get single operation detail
  Given wo_operation exists with id OP123
  When calling GET /api/planning/work-orders/:wo_id/operations/:op_id
  Then returns full operation details
  And includes: description, instructions, yield data, timestamps, user info

Scenario: Trigger routing copy manually (admin)
  Given WO has routing_id but no wo_operations
  And user has ADMIN role
  When calling POST /api/planning/work-orders/:wo_id/copy-routing
  Then routing operations copied
  And wo_operations created
  And returns operation count

Scenario: Cross-org operation access returns 404
  Given User A from Org A
  When requesting wo_operation from Org B
  Then 404 Not Found returned

Scenario: Invalid WO ID returns 404
  Given WO ID does not exist
  When calling GET /api/planning/work-orders/:wo_id/operations
  Then 404 Not Found returned
```

### AC-6: Service Layer Methods (FR-PLAN-020)

```gherkin
Scenario: copyRoutingToWO method
  Given WO with routing_id and no existing wo_operations
  When calling woOperationsService.copyRoutingToWO(woId)
  Then routing_operations queried from routing
  And wo_operations created with mapped fields
  And returns operation count

Scenario: copyRoutingToWO idempotency check
  Given WO already has wo_operations
  When calling woOperationsService.copyRoutingToWO(woId)
  Then method returns early without creating duplicates
  And logs warning "Operations already exist for WO"

Scenario: copyRoutingToWO with no routing
  Given WO has routing_id = null
  When calling woOperationsService.copyRoutingToWO(woId)
  Then method returns 0 operations created
  And no errors raised

Scenario: getOperationsForWO method
  Given WO has 4 wo_operations
  When calling woOperationsService.getOperationsForWO(woId)
  Then returns array of 4 operations ordered by sequence
  And includes related machine/line data

Scenario: calculateExpectedDuration method
  Given routing_operation with duration=60, setup=15, cleanup=10
  When calling calculateExpectedDuration(routingOperation)
  Then returns 85 minutes
```

### AC-7: Validation and Error Handling (FR-PLAN-020)

```gherkin
Scenario: Validate routing exists before copy
  Given WO has routing_id = R999
  And routing R999 does not exist
  When attempting to copy routing
  Then error "Routing not found" returned
  And no wo_operations created

Scenario: Validate org match on routing copy
  Given WO from Org A has routing_id from Org B
  When attempting to copy routing
  Then error "Routing does not belong to this organization" returned
  And no wo_operations created

Scenario: Sequence uniqueness constraint
  Given wo_operations being created have duplicate sequence 10
  When attempting to insert
  Then database constraint violation raised
  And transaction rolled back

Scenario: Required fields validation
  Given routing_operation missing operation_name
  When copying to wo_operations
  Then error "Operation name is required" returned
  And copy operation fails
```

### AC-8: Multi-tenancy and Permissions (FR-PLAN-020)

```gherkin
Scenario: Org isolation on wo_operations select
  Given User A from Org A
  When requesting wo_operations
  Then only operations from Org A WOs returned

Scenario: Planner can view operations
  Given user has PLANNER role
  When accessing GET /api/planning/work-orders/:id/operations
  Then operations returned successfully

Scenario: Production Manager can view operations
  Given user has PROD_MANAGER role
  When accessing GET /api/planning/work-orders/:id/operations
  Then operations returned successfully

Scenario: Operator cannot trigger manual copy
  Given user has OPERATOR role
  When calling POST /api/planning/work-orders/:id/copy-routing
  Then 403 Forbidden returned

Scenario: Cross-tenant wo_operation returns 404
  Given User A from Org A
  When accessing wo_operation from Org B
  Then 404 Not Found returned (not 403)
```

### AC-9: Integration with WO Release (Story 03.10)

```gherkin
Scenario: Routing copy integrated into release action
  Given WO in "planned" status with routing_id
  When planner calls POST /api/planning/work-orders/:id/release
  Then WO status changes to "released"
  And routing copy triggered automatically
  And wo_operations created
  And release completes successfully

Scenario: Release succeeds even if routing copy fails
  Given WO in "planned" status with invalid routing_id
  When planner releases WO
  Then WO status changes to "released"
  And routing copy fails gracefully
  And error logged but not returned to user
  And release completes successfully with warning

Scenario: Release with wo_copy_routing = false
  Given WO in "planned" status
  And setting wo_copy_routing = false
  When planner releases WO
  Then WO status changes to "released"
  And no routing copy attempted
  And release completes successfully
```

### AC-10: Settings Integration (Story 03.16)

```gherkin
Scenario: Default setting wo_copy_routing = true
  Given new org created
  When planning_settings initialized
  Then wo_copy_routing = true (default enabled)

Scenario: Setting toggle in planning settings page
  Given planner navigates to /settings/planning
  When viewing WO settings section
  Then "Copy Routing Operations" toggle visible
  And current value displayed
  And can toggle on/off

Scenario: Setting affects future WO releases
  Given setting wo_copy_routing changed to false
  And WO exists with routing_id
  When planner releases WO
  Then no wo_operations created (setting respected)
```

---

## Technical Specification

### Database Schema

```sql
-- WO Operations (routing snapshot)
CREATE TABLE wo_operations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  wo_id UUID NOT NULL REFERENCES work_orders(id) ON DELETE CASCADE,
  organization_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,

  -- Operation identity
  sequence INTEGER NOT NULL,
  operation_name TEXT NOT NULL,
  description TEXT,
  instructions TEXT,  -- Step-by-step instructions (from routing_operations.instructions)

  -- Resource assignment (copied from routing_operations)
  machine_id UUID REFERENCES machines(id),
  line_id UUID REFERENCES production_lines(id),

  -- Expected performance (from routing)
  expected_duration_minutes INTEGER,  -- duration + setup_time + cleanup_time
  expected_yield_percent DECIMAL(5,2),

  -- Actual performance (filled during production in Epic 04)
  actual_duration_minutes INTEGER,
  actual_yield_percent DECIMAL(5,2),

  -- Status tracking
  status TEXT DEFAULT 'pending' CHECK (status IN ('pending', 'in_progress', 'completed', 'skipped')),
  started_at TIMESTAMPTZ,
  completed_at TIMESTAMPTZ,
  started_by UUID REFERENCES users(id),
  completed_by UUID REFERENCES users(id),

  -- Skipped operations
  skip_reason TEXT,

  -- Notes
  notes TEXT,

  -- Audit
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),

  CONSTRAINT wo_ops_unique_sequence UNIQUE(wo_id, sequence),
  CONSTRAINT wo_ops_expected_duration_positive CHECK (expected_duration_minutes IS NULL OR expected_duration_minutes > 0),
  CONSTRAINT wo_ops_actual_duration_positive CHECK (actual_duration_minutes IS NULL OR actual_duration_minutes >= 0),
  CONSTRAINT wo_ops_expected_yield_range CHECK (expected_yield_percent IS NULL OR (expected_yield_percent >= 0 AND expected_yield_percent <= 100)),
  CONSTRAINT wo_ops_actual_yield_range CHECK (actual_yield_percent IS NULL OR (actual_yield_percent >= 0 AND actual_yield_percent <= 100))
);

-- Indexes for performance
CREATE INDEX idx_wo_ops_wo_id ON wo_operations(wo_id);
CREATE INDEX idx_wo_ops_org_id ON wo_operations(organization_id);
CREATE INDEX idx_wo_ops_status ON wo_operations(status);
CREATE INDEX idx_wo_ops_machine ON wo_operations(machine_id);
CREATE INDEX idx_wo_ops_line ON wo_operations(line_id);
CREATE INDEX idx_wo_ops_sequence ON wo_operations(wo_id, sequence);

-- Function: Copy routing operations to WO
CREATE OR REPLACE FUNCTION copy_routing_to_wo(
  p_wo_id UUID,
  p_org_id UUID
)
RETURNS INTEGER AS $$
DECLARE
  v_routing_id UUID;
  v_wo_copy_routing BOOLEAN;
  v_operation_count INTEGER := 0;
BEGIN
  -- Get WO routing_id
  SELECT routing_id INTO v_routing_id
  FROM work_orders
  WHERE id = p_wo_id AND org_id = p_org_id;

  -- Check if WO exists
  IF NOT FOUND THEN
    RAISE EXCEPTION 'Work order not found';
  END IF;

  -- Check setting
  SELECT COALESCE(wo_copy_routing, TRUE) INTO v_wo_copy_routing
  FROM planning_settings
  WHERE org_id = p_org_id;

  -- Exit if setting disabled or no routing
  IF v_wo_copy_routing = FALSE OR v_routing_id IS NULL THEN
    RETURN 0;
  END IF;

  -- Check if operations already exist (idempotency)
  SELECT COUNT(*) INTO v_operation_count
  FROM wo_operations
  WHERE wo_id = p_wo_id;

  IF v_operation_count > 0 THEN
    -- Operations already copied, return existing count
    RETURN v_operation_count;
  END IF;

  -- Copy routing operations to wo_operations
  INSERT INTO wo_operations (
    wo_id,
    organization_id,
    sequence,
    operation_name,
    description,
    instructions,
    machine_id,
    line_id,
    expected_duration_minutes,
    expected_yield_percent,
    status
  )
  SELECT
    p_wo_id,
    p_org_id,
    ro.sequence,
    ro.name,
    ro.description,
    ro.instructions,
    ro.machine_id,
    ro.line_id,
    COALESCE(ro.duration, 0) + COALESCE(ro.setup_time, 0) + COALESCE(ro.cleanup_time, 0),
    NULL,  -- expected_yield_percent not in routing_operations (can be added later)
    'pending'
  FROM routing_operations ro
  WHERE ro.routing_id = v_routing_id
  ORDER BY ro.sequence;

  GET DIAGNOSTICS v_operation_count = ROW_COUNT;

  RETURN v_operation_count;
END;
$$ LANGUAGE plpgsql;

-- Trigger: Update timestamp on modification
CREATE OR REPLACE FUNCTION update_wo_ops_timestamp()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at := NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER tr_wo_ops_update_timestamp
BEFORE UPDATE ON wo_operations
FOR EACH ROW
EXECUTE FUNCTION update_wo_ops_timestamp();

-- Trigger: Calculate actual duration on completion
CREATE OR REPLACE FUNCTION calculate_wo_ops_duration()
RETURNS TRIGGER AS $$
BEGIN
  IF NEW.status = 'completed' AND NEW.started_at IS NOT NULL AND NEW.completed_at IS NOT NULL THEN
    NEW.actual_duration_minutes := EXTRACT(EPOCH FROM (NEW.completed_at - NEW.started_at)) / 60;
  END IF;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER tr_wo_ops_calculate_duration
BEFORE UPDATE OF status, completed_at ON wo_operations
FOR EACH ROW
EXECUTE FUNCTION calculate_wo_ops_duration();
```

### RLS Policies

```sql
-- Enable RLS
ALTER TABLE wo_operations ENABLE ROW LEVEL SECURITY;

-- WO Operations: Org isolation via WO
CREATE POLICY "wo_ops_select" ON wo_operations
FOR SELECT TO authenticated
USING (
  organization_id = (SELECT org_id FROM users WHERE id = auth.uid())
);

CREATE POLICY "wo_ops_insert" ON wo_operations
FOR INSERT TO authenticated
WITH CHECK (
  organization_id = (SELECT org_id FROM users WHERE id = auth.uid())
  AND (
    (SELECT r.code FROM roles r JOIN users u ON u.role_id = r.id WHERE u.id = auth.uid())
    IN ('SUPER_ADMIN', 'ADMIN', 'PLANNER', 'PROD_MANAGER')
  )
);

CREATE POLICY "wo_ops_update" ON wo_operations
FOR UPDATE TO authenticated
USING (
  organization_id = (SELECT org_id FROM users WHERE id = auth.uid())
  AND (
    (SELECT r.code FROM roles r JOIN users u ON u.role_id = r.id WHERE u.id = auth.uid())
    IN ('SUPER_ADMIN', 'ADMIN', 'PLANNER', 'PROD_MANAGER', 'OPERATOR')
  )
);

CREATE POLICY "wo_ops_delete" ON wo_operations
FOR DELETE TO authenticated
USING (
  organization_id = (SELECT org_id FROM users WHERE id = auth.uid())
  AND (
    (SELECT r.code FROM roles r JOIN users u ON u.role_id = r.id WHERE u.id = auth.uid())
    IN ('SUPER_ADMIN', 'ADMIN')
  )
);
```

### API Endpoints

```
# WO Operations
GET    /api/v1/planning/work-orders/:wo_id/operations              - List WO operations (ordered by sequence)
GET    /api/v1/planning/work-orders/:wo_id/operations/:op_id       - Get operation detail
POST   /api/v1/planning/work-orders/:wo_id/copy-routing            - Manually trigger routing copy (admin)

# Operations status updates (Epic 04 Production)
PUT    /api/v1/planning/work-orders/:wo_id/operations/:op_id       - Update operation (Epic 04)
POST   /api/v1/planning/work-orders/:wo_id/operations/:op_id/start - Start operation (Epic 04)
POST   /api/v1/planning/work-orders/:wo_id/operations/:op_id/complete - Complete operation (Epic 04)
POST   /api/v1/planning/work-orders/:wo_id/operations/:op_id/skip  - Skip operation (Epic 04)
```

**Response Format (List):**
```typescript
{
  operations: [
    {
      id: string;
      wo_id: string;
      sequence: number;
      operation_name: string;
      description: string | null;
      machine_id: string | null;
      machine_code: string | null;
      machine_name: string | null;
      line_id: string | null;
      line_code: string | null;
      line_name: string | null;
      expected_duration_minutes: number | null;
      expected_yield_percent: number | null;
      actual_duration_minutes: number | null;
      actual_yield_percent: number | null;
      status: 'pending' | 'in_progress' | 'completed' | 'skipped';
      started_at: string | null;
      completed_at: string | null;
      started_by: string | null;
      completed_by: string | null;
      started_by_user: { name: string } | null;
      completed_by_user: { name: string } | null;
      skip_reason: string | null;
      notes: string | null;
      created_at: string;
    }
  ],
  total: number;
}
```

**Response Format (Detail):**
```typescript
{
  id: string;
  wo_id: string;
  sequence: number;
  operation_name: string;
  description: string | null;
  instructions: string | null;  // Step-by-step operator instructions
  machine_id: string | null;
  machine: { id: string; code: string; name: string } | null;
  line_id: string | null;
  line: { id: string; code: string; name: string } | null;
  expected_duration_minutes: number | null;
  expected_yield_percent: number | null;
  actual_duration_minutes: number | null;
  actual_yield_percent: number | null;
  duration_variance_minutes: number | null;  // actual - expected
  yield_variance_percent: number | null;     // actual - expected
  status: 'pending' | 'in_progress' | 'completed' | 'skipped';
  started_at: string | null;
  completed_at: string | null;
  started_by: string | null;
  completed_by: string | null;
  started_by_user: { id: string; name: string } | null;
  completed_by_user: { id: string; name: string } | null;
  skip_reason: string | null;
  notes: string | null;
  created_at: string;
  updated_at: string;
}
```

### Service Layer

```typescript
// lib/services/wo-operations-service.ts

export interface WOOperationsService {
  // List operations
  getOperationsForWO(woId: string): Promise<WOOperation[]>;
  getOperationById(woId: string, opId: string): Promise<WOOperationDetail | null>;

  // Routing copy
  copyRoutingToWO(woId: string, orgId: string): Promise<number>;  // Returns count of operations created

  // Utilities
  calculateExpectedDuration(routingOp: RoutingOperation): number;
  validateOperationSequence(operations: WOOperation[]): boolean;
}

// Type definitions
export type WOOperationStatus = 'pending' | 'in_progress' | 'completed' | 'skipped';

export interface WOOperation {
  id: string;
  wo_id: string;
  sequence: number;
  operation_name: string;
  description: string | null;
  machine_id: string | null;
  machine_code: string | null;
  machine_name: string | null;
  line_id: string | null;
  line_code: string | null;
  line_name: string | null;
  expected_duration_minutes: number | null;
  expected_yield_percent: number | null;
  actual_duration_minutes: number | null;
  actual_yield_percent: number | null;
  status: WOOperationStatus;
  started_at: string | null;
  completed_at: string | null;
  started_by: string | null;
  completed_by: string | null;
  started_by_user: { name: string } | null;
  completed_by_user: { name: string } | null;
  skip_reason: string | null;
  notes: string | null;
  created_at: string;
  updated_at: string;
}

export interface WOOperationDetail extends WOOperation {
  instructions: string | null;
  machine: {
    id: string;
    code: string;
    name: string;
  } | null;
  line: {
    id: string;
    code: string;
    name: string;
  } | null;
  duration_variance_minutes: number | null;  // actual - expected
  yield_variance_percent: number | null;     // actual - expected
}

export interface RoutingOperation {
  id: string;
  routing_id: string;
  sequence: number;
  name: string;
  description: string | null;
  machine_id: string | null;
  duration: number;
  setup_time: number;
  cleanup_time: number;
  labor_cost_per_hour: number | null;
  instructions: string | null;
  created_at: string;
}

// Implementation example
export async function copyRoutingToWO(woId: string, orgId: string): Promise<number> {
  // Call database function
  const { data, error } = await supabase.rpc('copy_routing_to_wo', {
    p_wo_id: woId,
    p_org_id: orgId
  });

  if (error) {
    console.error('Failed to copy routing to WO:', error);
    throw new Error(`Routing copy failed: ${error.message}`);
  }

  return data as number;
}

export async function getOperationsForWO(woId: string): Promise<WOOperation[]> {
  const { data, error } = await supabase
    .from('wo_operations')
    .select(`
      *,
      machine:machines(id, code, name),
      line:production_lines(id, code, name),
      started_by_user:users!started_by(name),
      completed_by_user:users!completed_by(name)
    `)
    .eq('wo_id', woId)
    .order('sequence', { ascending: true });

  if (error) throw error;

  return data.map(op => ({
    ...op,
    machine_code: op.machine?.code ?? null,
    machine_name: op.machine?.name ?? null,
    line_code: op.line?.code ?? null,
    line_name: op.line?.name ?? null,
  }));
}

export function calculateExpectedDuration(routingOp: RoutingOperation): number {
  return (routingOp.duration || 0) + (routingOp.setup_time || 0) + (routingOp.cleanup_time || 0);
}
```

### Validation Schema (Zod)

```typescript
// lib/validation/wo-operations.ts
import { z } from 'zod';

export const woOperationStatusEnum = z.enum(['pending', 'in_progress', 'completed', 'skipped']);

// Copy routing validation (admin action)
export const copyRoutingSchema = z.object({
  wo_id: z.string().uuid('Invalid WO ID'),
});

// Update operation validation (Epic 04)
export const updateWOOperationSchema = z.object({
  status: woOperationStatusEnum.optional(),
  actual_duration_minutes: z.number()
    .int('Duration must be integer')
    .nonnegative('Duration cannot be negative')
    .optional()
    .nullable(),
  actual_yield_percent: z.number()
    .min(0, 'Yield cannot be negative')
    .max(100, 'Yield cannot exceed 100%')
    .optional()
    .nullable(),
  skip_reason: z.string()
    .max(500, 'Skip reason too long')
    .optional()
    .nullable(),
  notes: z.string()
    .max(2000, 'Notes too long')
    .optional()
    .nullable(),
});

// Start operation validation (Epic 04)
export const startOperationSchema = z.object({
  started_at: z.string().datetime('Invalid timestamp').optional(),  // Defaults to NOW()
});

// Complete operation validation (Epic 04)
export const completeOperationSchema = z.object({
  completed_at: z.string().datetime('Invalid timestamp').optional(),  // Defaults to NOW()
  actual_yield_percent: z.number()
    .min(0, 'Yield cannot be negative')
    .max(100, 'Yield cannot exceed 100%')
    .optional()
    .nullable(),
  notes: z.string()
    .max(2000, 'Notes too long')
    .optional()
    .nullable(),
});

// Skip operation validation (Epic 04)
export const skipOperationSchema = z.object({
  skip_reason: z.string()
    .min(1, 'Skip reason is required')
    .max(500, 'Skip reason too long'),
});

// Type exports
export type WOOperationStatus = z.infer<typeof woOperationStatusEnum>;
export type UpdateWOOperationInput = z.infer<typeof updateWOOperationSchema>;
export type StartOperationInput = z.infer<typeof startOperationSchema>;
export type CompleteOperationInput = z.infer<typeof completeOperationSchema>;
export type SkipOperationInput = z.infer<typeof skipOperationSchema>;
```

---

## UI Components

```
app/(authenticated)/planning/work-orders/
  [id]/page.tsx                         -- WO detail page (includes operations timeline)

components/planning/work-orders/
  WOOperationsTimeline.tsx              -- Main operations timeline component
  WOOperationCard.tsx                   -- Single operation card in timeline
  WOOperationStatusBadge.tsx            -- Status badge (pending, in_progress, completed, skipped)
  WOOperationDetailPanel.tsx            -- Detailed operation view panel (modal/slide-over)
  WOOperationProgressBar.tsx            -- Visual progress indicator (operations completed / total)
  WOOperationsEmptyState.tsx            -- Empty state when no operations
```

### WOOperationsTimeline Component

```typescript
// components/planning/work-orders/WOOperationsTimeline.tsx

interface WOOperationsTimelineProps {
  woId: string;
  readOnly?: boolean;  // True for planner view, false for operator view (Epic 04)
}

export function WOOperationsTimeline({ woId, readOnly = true }: WOOperationsTimelineProps) {
  const { data: operations, isLoading, error } = useWOOperations(woId);

  if (isLoading) return <Skeleton />;
  if (error) return <ErrorDisplay message="Failed to load operations" />;
  if (!operations || operations.length === 0) {
    return <WOOperationsEmptyState />;
  }

  return (
    <div className="space-y-4">
      <div className="flex items-center justify-between">
        <h3 className="text-lg font-semibold">Operations</h3>
        <WOOperationProgressBar operations={operations} />
      </div>

      <div className="space-y-2">
        {operations.map((operation, index) => (
          <WOOperationCard
            key={operation.id}
            operation={operation}
            isLast={index === operations.length - 1}
            readOnly={readOnly}
          />
        ))}
      </div>
    </div>
  );
}
```

### Operation Status Badge Colors (TailwindCSS)

| Status | Badge Class |
|--------|-------------|
| pending | `bg-gray-100 text-gray-700` |
| in_progress | `bg-yellow-100 text-yellow-800` |
| completed | `bg-green-100 text-green-800` |
| skipped | `bg-red-100 text-red-800 line-through` |

---

## Wireframe References

- **PLA-013**: WO Operations Timeline - `/docs/3-ARCHITECTURE/ux/wireframes/PLA-013-wo-operations-timeline.md`
- **PLA-014**: Operation Detail Panel - `/docs/3-ARCHITECTURE/ux/wireframes/PLA-014-operation-detail-panel.md`

---

## Out of Scope

| Feature | Reason | Future Story |
|---------|--------|--------------|
| Operation start/complete actions | Production execution | Epic 04 (Production) |
| Actual time tracking (started_at, completed_at) | Production execution | Epic 04 |
| Actual yield tracking | Production execution | Epic 04 |
| Operation notes during execution | Production execution | Epic 04 |
| Material consumption per operation | Advanced feature | Epic 03b (Phase 2) |
| Labor cost tracking per operation | Costing feature | Epic 09 (Finance) |
| Operation-level quality checks | Quality integration | Epic 06 (Quality) |
| Operation dependencies (seq 2 cannot start until seq 1 done) | Advanced feature | Phase 2 |
| Parallel operations (multiple ops with same sequence) | Advanced feature | Phase 2 |

---

## Test Cases

### Unit Tests

**File:** `__tests__/unit/services/wo-operations-service.test.ts`

| Test Case | Description |
|-----------|-------------|
| `copyRoutingToWO()` creates operations | Verify operations copied from routing |
| `copyRoutingToWO()` calculates expected duration | duration + setup + cleanup |
| `copyRoutingToWO()` handles null routing_id | Returns 0 operations, no error |
| `copyRoutingToWO()` idempotency check | No duplicates if operations exist |
| `copyRoutingToWO()` preserves sequence order | Sequences match routing |
| `copyRoutingToWO()` copies machine/line assignments | machine_id and line_id copied |
| `copyRoutingToWO()` handles empty routing | No operations, no error |
| `copyRoutingToWO()` respects wo_copy_routing setting | No copy when setting = false |
| `getOperationsForWO()` returns ordered list | Ordered by sequence ASC |
| `getOperationsForWO()` includes machine/line data | Related data joined |
| `calculateExpectedDuration()` sums times | Correct total duration |

### Integration Tests

**File:** `__tests__/integration/api/planning/wo-operations.test.ts`

| Test Case | Description |
|-----------|-------------|
| GET `/work-orders/:wo_id/operations` returns list | Returns operations ordered by sequence |
| GET `/work-orders/:wo_id/operations` empty state | Returns empty array when no operations |
| GET `/work-orders/:wo_id/operations/:op_id` returns detail | Full operation detail |
| GET `/work-orders/:wo_id/operations/:op_id` 404 on invalid | Invalid op_id returns 404 |
| POST `/work-orders/:wo_id/copy-routing` creates operations | Manual trigger works |
| POST `/work-orders/:wo_id/copy-routing` admin only | Non-admin returns 403 |
| POST `/work-orders/:wo_id/copy-routing` idempotent | No duplicates created |
| Cross-org access returns 404 | Multi-tenancy enforced |
| Invalid WO ID returns 404 | Proper error handling |

### E2E Tests

**File:** `__tests__/e2e/planning/wo-operations.spec.ts`

| Test Case | Description |
|-----------|-------------|
| Release WO copies routing operations | WO release > operations created |
| View operations timeline on WO detail | Detail page > timeline displays |
| Operations timeline shows correct data | Sequence, name, machine, status |
| Operations timeline empty state | No routing > empty message |
| Click operation opens detail panel | Operation card > detail panel |
| Operation detail shows full info | Description, instructions, times |
| Status badges display correctly | Correct colors for each status |
| Progress bar shows completion % | Completed / total operations |

---

## Key Business Rules

1. **Routing Copy Trigger**: Operations copied on WO release (status: planned -> released)
2. **Setting Control**: `wo_copy_routing` setting enables/disables feature (default: true)
3. **Idempotency**: Operations copied only once per WO, subsequent releases do not duplicate
4. **Sequence Preservation**: Operation sequences match routing_operations exactly
5. **Expected Duration**: `expected_duration_minutes = duration + setup_time + cleanup_time`
6. **Null Routing**: WO without routing_id skips copy, no error
7. **Empty Routing**: Routing with 0 operations results in 0 wo_operations, no error
8. **Initial Status**: All operations start with status = 'pending'
9. **Immutability**: Once copied, wo_operations are immutable snapshots (like BOM snapshot)
10. **Production Updates**: Actual times/yields updated by Epic 04 Production module

---

## Performance Requirements

| Metric | Target |
|--------|--------|
| Routing copy on WO release | < 500ms (for routing with 10 operations) |
| GET operations list | < 200ms |
| GET operation detail | < 150ms |
| Operations timeline render | < 300ms |

---

## Definition of Done

- [ ] Database migration creates `wo_operations` table with all fields
- [ ] All constraints, indexes, and unique constraints created
- [ ] `copy_routing_to_wo()` function implemented and tested
- [ ] Trigger for auto-duration calculation on completion
- [ ] Trigger for timestamp updates
- [ ] RLS policies enforce org isolation and role permissions
- [ ] API endpoint GET `/work-orders/:wo_id/operations` implemented
- [ ] API endpoint GET `/work-orders/:wo_id/operations/:op_id` implemented
- [ ] API endpoint POST `/work-orders/:wo_id/copy-routing` implemented (admin)
- [ ] Zod schemas validate all inputs
- [ ] `wo-operations-service.ts` implements all methods
- [ ] Integration with WO release action in story 03.10
- [ ] Setting `wo_copy_routing` added to planning_settings
- [ ] WOOperationsTimeline component implemented
- [ ] WOOperationCard component with status badges
- [ ] WOOperationDetailPanel component
- [ ] WOOperationProgressBar component
- [ ] Empty state component
- [ ] Status badge colors correct
- [ ] Multi-tenancy: cross-org returns 404
- [ ] Permission matrix implemented (planner view-only, operator in Epic 04)
- [ ] Unit tests >= 80% coverage
- [ ] Integration tests for all endpoints
- [ ] E2E tests for critical flows
- [ ] Routing copy idempotency tested
- [ ] Edge cases tested (null routing, empty routing, duplicate sequences)
- [ ] Loading, empty, error states implemented
- [ ] Toast notifications on success/error
- [ ] Accessibility: keyboard nav, ARIA labels

---

## Future Phases (Not in MVP)

### Phase 1
- **Operation Start/Complete Actions** (Epic 04) - Production operators start/complete operations
- **Actual Time Tracking** (Epic 04) - Record started_at, completed_at timestamps
- **Actual Yield Tracking** (Epic 04) - Record actual_yield_percent per operation
- **Operation Notes** (Epic 04) - Operators add notes during execution
- **Duration Variance Alerts** (Epic 04) - Alert when actual > expected by threshold

### Phase 2
- **Material Consumption Per Operation** (Epic 03b) - Link wo_materials to specific operation
- **Labor Cost Tracking** (Epic 09) - Record labor hours and costs per operation
- **Operation Dependencies** - Cannot start operation N until operation N-1 completed
- **Parallel Operations** - Allow multiple operations with same sequence number
- **Operation Instructions Editor** - Rich text editor for step-by-step instructions
- **Operation Photos/Attachments** - Attach images, PDFs to operations

### Phase 3
- **Quality Checks Per Operation** (Epic 06) - Quality control steps integrated into operations
- **SOP Integration** - Link operations to standard operating procedures
- **Operation Performance Analytics** - Average duration, yield trends by operation type
- **Predictive Duration** - ML-based duration estimates from historical data

**Implementation**: See Epic 03.0 "Future Feature Handling" for guidance on Phase 1+ features in UI/API.

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-12-16 | Initial story creation | Claude Sonnet 4.5 (1M context) |
