# 03.3 - Purchase Orders CRUD + Lines (Master-Detail)

| Field | Value |
|-------|-------|
| **Story ID** | 03.3 |
| **Epic** | 03 - Planning |
| **Status** | Ready |
| **Phase** | MVP (P0) |
| **Complexity** | L (Large) |
| **Estimate** | 5-7 days |
| **Type** | Full-stack |

---

## PRD References

| FR ID | Requirement | Priority | Covered |
|-------|-------------|----------|---------|
| FR-PLAN-005 | PO CRUD | Must Have | YES |
| FR-PLAN-006 | PO Line Management | Must Have | YES |
| FR-PLAN-007 | PO Status Lifecycle | Must Have | YES |
| FR-PLAN-010 | PO Totals Calculation | Must Have | YES |
| FR-PLAN-008 | Bulk PO Creation | Must Have | NO - Story 03.4 |
| FR-PLAN-009 | PO Approval Workflow | Should Have | NO - Story 03.5a/b |
| FR-PLAN-011 | Configurable PO Statuses | Should Have | NO - Story 03.6 |

**Primary PRD:** `docs/1-BASELINE/product/modules/planning.md` (Section 5)
**Architecture:** `docs/1-BASELINE/architecture/modules/planning.md`
**UX Wireframes:** PLA-001 (PO List), PLA-002 (PO Detail/Form), PLA-003 (PO Lines Table)

---

## MVP Scope

This story implements Phase 0 (MVP) functionality for Purchase Order management. Advanced features (approval workflow, bulk creation, configurable statuses) are deferred to subsequent stories.

**MVP Includes**:
- Complete PO header CRUD (create, read, update, delete)
- PO line items management (add, edit, remove lines)
- Master-detail form pattern with embedded lines table
- Auto-calculation of line totals, subtotal, tax, and grand total
- Basic status lifecycle (draft, submitted, confirmed, receiving, closed, cancelled)
- Supplier defaults cascade (currency, tax code, payment terms)
- PO number auto-generation (PO-YYYY-NNNNN format)
- Line price defaults from supplier-product or product std_price
- Transaction-safe operations for header + lines

**Deferred to Phase 1+**: See "Future Phases" section below.

---

## User Story

As a **Planner or Purchaser**, I want to **create, view, edit, and manage purchase orders with line items** so that **I can efficiently procure raw materials, packaging, and other goods from suppliers with full cost visibility and proper documentation**.

---

## Dependencies

| Dependency | Story/Epic | Type | Reason |
|------------|------------|------|--------|
| 01.1 | Org Context + Base RLS | HARD | Requires org_id context and RLS patterns |
| 01.8 | Warehouses CRUD | HARD | PO requires warehouse_id for receiving destination |
| 01.13 | Tax Codes CRUD | HARD | PO requires tax_code_id for calculations |
| 02.1 | Products CRUD | HARD | PO lines require product_id reference |
| 03.1 | Suppliers CRUD | HARD | PO requires supplier_id FK |
| 03.2 | Supplier-Product Assignment | SOFT | Optional pricing defaults from supplier-product |

**Dependents:**
- 03.4 (Bulk PO Creation) - Builds on PO CRUD foundation
- 03.5a/b (PO Approval) - Extends PO status lifecycle
- 03.6 (Configurable Statuses) - Customizes status list
- Epic 05 (Warehouse - PO Receiving) - Uses PO for receiving

---

## Acceptance Criteria (Gherkin)

### AC-1: PO List Page (FR-PLAN-005)

```gherkin
Scenario: View purchase orders list
  Given planner navigates to `/planning/purchase-orders`
  When page loads
  Then PO list displays within 300ms
  And table shows columns: PO Number, Supplier, Status, Expected Date, Total, Created

Scenario: Search POs by number or supplier
  Given PO list with 20+ orders
  When planner enters search "PO-2024"
  Then only POs matching number or supplier name display within 200ms

Scenario: Filter by status
  Given PO list displayed
  When planner selects filter "Draft"
  Then only draft POs appear

Scenario: Filter by supplier
  Given PO list displayed
  When planner selects supplier "Mill Co."
  Then only POs from that supplier appear

Scenario: Filter by date range
  Given PO list displayed
  When planner sets date range for expected delivery
  Then only POs within date range appear

Scenario: Sort PO list
  Given PO list displayed
  When planner clicks "Expected Date" column header
  Then list sorts by date (toggle asc/desc)

Scenario: Pagination
  Given 100 POs exist
  When planner views PO list
  Then 20 POs display per page with pagination controls
```

### AC-2: Create PO Header (FR-PLAN-005)

```gherkin
Scenario: Open create PO page
  Given planner clicks "+ New Purchase Order"
  When page loads
  Then form displays: supplier dropdown, warehouse dropdown, expected date, payment terms, shipping method, notes

Scenario: Supplier selection cascades defaults
  Given planner selects supplier "Mill Co." (currency: EUR, tax: VAT-23, terms: Net 30)
  When supplier selected
  Then currency auto-fills "EUR"
  And tax code auto-fills "VAT-23"
  And payment terms auto-fills "Net 30"
  And fields are editable to override

Scenario: PO number auto-generated
  Given planner saves a new PO
  When PO is created
  Then PO number generated as "PO-2024-00001" (next sequence)
  And PO number is immutable after creation

Scenario: Required field validation
  Given planner leaves supplier empty
  When save attempted
  Then error "Supplier is required" displays inline
  And form submission blocked

Scenario: Expected delivery date validation
  Given planner enters past date for expected delivery
  When save attempted
  Then error "Expected delivery date must be in the future" displays

Scenario: Create PO without lines (draft)
  Given planner fills header fields without adding lines
  When "Save as Draft" clicked
  Then PO created with status "draft" and 0 lines
  And toast "Purchase order created" displays
```

### AC-3: PO Line Management (FR-PLAN-006)

```gherkin
Scenario: Add line item to PO
  Given planner is on PO detail page
  When "Add Line" button clicked
  Then line form appears with: product search, quantity, UoM, unit price, discount %, notes

Scenario: Product selection defaults pricing
  Given product "RM-FLOUR-001" has supplier-product price of 2.50 EUR
  When planner selects the product
  Then unit price auto-fills 2.50
  And UoM auto-fills product's base UoM (kg)

Scenario: Fallback to product std_price
  Given product "RM-YEAST-001" has no supplier-product assignment
  When planner selects the product
  Then unit price defaults to product.std_price
  And warning "No supplier-specific price. Using product standard price." displays

Scenario: Line total calculation
  Given planner enters: quantity 100, unit price 2.50, discount 10%
  When fields change
  Then discount amount shows 25.00
  And line total shows 225.00
  And calculation updates in real-time

Scenario: Edit line item
  Given PO has line for "RM-FLOUR-001" qty 100
  When planner clicks edit on that line
  Then inline edit mode activates
  And changes can be saved or cancelled

Scenario: Remove line item
  Given PO has 3 line items
  When planner clicks delete on line 2
  Then confirmation dialog "Remove this line item?" displays
  And upon confirm, line removed and line numbers re-sequenced

Scenario: Cannot add duplicate product
  Given PO already has line for "RM-FLOUR-001"
  When planner attempts to add same product again
  Then error "Product already exists on this PO. Edit existing line instead." displays

Scenario: Line-level delivery date
  Given PO header has expected date Dec 30, 2024
  When adding a line
  Then line expected_delivery_date defaults to header date
  And can be overridden per line

Scenario: Restrict line edits after receiving starts
  Given PO is in "receiving" status (some qty received)
  When planner views lines
  Then quantity cannot be reduced below received_qty
  And line cannot be deleted if received_qty > 0
```

### AC-4: PO Totals Calculation (FR-PLAN-010)

```gherkin
Scenario: Subtotal calculation
  Given PO has lines totaling 1000.00
  When viewing PO summary
  Then subtotal displays 1000.00

Scenario: Tax calculation
  Given PO has subtotal 1000.00 and tax code VAT-23 (23%)
  When viewing PO summary
  Then tax amount displays 230.00

Scenario: Grand total calculation
  Given PO has subtotal 1000.00 and tax 230.00
  When viewing PO summary
  Then grand total displays 1230.00

Scenario: Discount total calculation
  Given PO has lines with total discounts of 50.00
  When viewing PO summary
  Then discount total displays 50.00

Scenario: Real-time recalculation
  Given planner modifies a line quantity
  When field changes
  Then all totals (line, subtotal, tax, grand) recalculate within 100ms

Scenario: Currency consistency
  Given PO currency is EUR
  When viewing all monetary values
  Then all amounts display with EUR symbol/formatting
```

### AC-5: PO Status Lifecycle (FR-PLAN-007)

```gherkin
Scenario: Draft status capabilities
  Given PO is in "draft" status
  When planner views available actions
  Then can: edit header, add/edit/remove lines, submit, cancel

Scenario: Submit PO (no approval required)
  Given settings have approval disabled
  And PO has at least 1 line
  When planner clicks "Submit"
  Then status changes to "confirmed"
  And status history records transition

Scenario: Cannot submit PO without lines
  Given PO has 0 lines
  When planner clicks "Submit"
  Then error "Cannot submit PO without line items" displays

Scenario: Confirmed PO restrictions
  Given PO is "confirmed"
  When planner views available actions
  Then cannot add/remove lines
  And can only update: notes, internal_notes, expected dates
  And can cancel (if no receipts)

Scenario: Receiving status trigger
  Given PO is "confirmed"
  When first receipt is recorded against a line
  Then status auto-changes to "receiving"

Scenario: Close PO when fully received
  Given all PO lines have received_qty = ordered qty
  When last receipt is completed
  Then status auto-changes to "closed"

Scenario: Cancel PO
  Given PO has no receipts (all received_qty = 0)
  When planner clicks "Cancel"
  Then confirmation dialog displays
  And upon confirm, status changes to "cancelled"

Scenario: Cannot cancel PO with receipts
  Given PO has received_qty > 0 on any line
  When planner attempts to cancel
  Then error "Cannot cancel PO with recorded receipts" displays
```

### AC-6: Edit PO (FR-PLAN-005)

```gherkin
Scenario: Open PO detail page
  Given planner clicks on PO-2024-00001
  When page loads
  Then header fields display in read/edit mode (based on status)
  And lines table displays all line items
  And summary panel shows totals

Scenario: Edit header fields in draft
  Given PO is "draft"
  When planner changes expected delivery date
  Then change saved immediately (auto-save or explicit save)

Scenario: PO number immutable
  Given PO exists with number PO-2024-00001
  When planner views edit form
  Then PO number field is disabled/read-only

Scenario: Supplier change warning
  Given PO has lines with supplier-specific pricing
  When planner changes supplier
  Then warning "Changing supplier will clear pricing. Review line prices." displays
  And line prices reset to new supplier's defaults (or product std_price)
```

### AC-7: Delete/Cancel PO (FR-PLAN-005)

```gherkin
Scenario: Delete draft PO
  Given PO is "draft"
  When planner clicks "Delete"
  Then confirmation "Delete this draft PO and all its lines?" displays
  And upon confirm, PO and lines permanently deleted

Scenario: Soft delete vs hard delete
  Given PO is not in "draft" status
  When planner cancels PO
  Then PO is soft-deleted (cancelled status, not removed from DB)

Scenario: Cannot delete confirmed+ PO
  Given PO status is "confirmed" or later
  When planner attempts delete
  Then delete action is hidden (only cancel available)
```

### AC-8: Permission Enforcement

```gherkin
Scenario: Planner full access
  Given user has PLANNER role
  When accessing /planning/purchase-orders
  Then all CRUD actions available

Scenario: Production Manager view only
  Given user has PROD_MANAGER role
  When accessing /planning/purchase-orders
  Then can view list and detail
  But create/edit/delete buttons hidden

Scenario: Viewer read only
  Given user has VIEWER role
  When accessing /planning/purchase-orders
  Then table displays read-only
  And all action buttons hidden
```

### AC-9: Multi-tenancy

```gherkin
Scenario: Org isolation on list
  Given User A from Org A
  When requesting /api/planning/purchase-orders
  Then only Org A POs returned

Scenario: Cross-tenant access returns 404
  Given User A from Org A
  When requesting PO ID from Org B
  Then 404 Not Found returned (not 403)

Scenario: Lines inherit org isolation
  Given PO belongs to Org A
  When requesting its lines
  Then only lines for that PO returned (via po_id FK)
```

### AC-10: Transaction Integrity

```gherkin
Scenario: Create PO with lines in single transaction
  Given planner creates PO with 3 lines
  When save is triggered
  Then header and all lines created atomically
  And if any line fails validation, entire transaction rolls back

Scenario: Update PO with line changes in transaction
  Given planner modifies header and adds/removes lines
  When save is triggered
  Then all changes applied atomically
  And totals recalculated before commit

Scenario: Rollback on error
  Given planner creates PO with invalid line (negative quantity)
  When save is triggered
  Then transaction fails
  And no header record created
  And appropriate error message returned
```

---

## Technical Specification

### Database Schema

```sql
-- Purchase Orders Header
CREATE TABLE purchase_orders (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  po_number VARCHAR(20) NOT NULL,
  supplier_id UUID NOT NULL REFERENCES suppliers(id),
  currency VARCHAR(3) NOT NULL DEFAULT 'PLN',
  tax_code_id UUID REFERENCES tax_codes(id),
  expected_delivery_date DATE NOT NULL,
  warehouse_id UUID NOT NULL REFERENCES warehouses(id),
  status VARCHAR(20) NOT NULL DEFAULT 'draft',
  payment_terms VARCHAR(50),
  shipping_method VARCHAR(100),
  notes TEXT,
  internal_notes TEXT,

  -- Approval fields (used by Story 03.5)
  approval_status VARCHAR(20),  -- pending, approved, rejected
  approved_by UUID REFERENCES users(id),
  approved_at TIMESTAMPTZ,
  approval_notes TEXT,

  -- Calculated totals (denormalized for performance)
  subtotal DECIMAL(15,4) DEFAULT 0,
  tax_amount DECIMAL(15,4) DEFAULT 0,
  total DECIMAL(15,4) DEFAULT 0,
  discount_total DECIMAL(15,4) DEFAULT 0,

  -- Audit fields
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  created_by UUID REFERENCES users(id),
  updated_by UUID REFERENCES users(id),

  CONSTRAINT po_org_number_unique UNIQUE(org_id, po_number),
  CONSTRAINT po_status_check CHECK (status IN ('draft', 'submitted', 'pending_approval', 'confirmed', 'receiving', 'closed', 'cancelled')),
  CONSTRAINT po_currency_check CHECK (currency IN ('PLN', 'EUR', 'USD', 'GBP')),
  CONSTRAINT po_expected_date_check CHECK (expected_delivery_date >= CURRENT_DATE - INTERVAL '1 day')
);

-- Purchase Order Lines
CREATE TABLE purchase_order_lines (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  po_id UUID NOT NULL REFERENCES purchase_orders(id) ON DELETE CASCADE,
  line_number INTEGER NOT NULL,
  product_id UUID NOT NULL REFERENCES products(id),
  quantity DECIMAL(15,4) NOT NULL,
  uom VARCHAR(20) NOT NULL,
  unit_price DECIMAL(15,4) NOT NULL,
  discount_percent DECIMAL(5,2) DEFAULT 0,
  discount_amount DECIMAL(15,4) DEFAULT 0,
  line_total DECIMAL(15,4) NOT NULL,
  expected_delivery_date DATE,
  confirmed_delivery_date DATE,
  received_qty DECIMAL(15,4) DEFAULT 0,
  notes TEXT,

  -- Audit fields
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),

  CONSTRAINT po_line_unique UNIQUE(po_id, line_number),
  CONSTRAINT po_line_qty_positive CHECK (quantity > 0),
  CONSTRAINT po_line_price_positive CHECK (unit_price >= 0),
  CONSTRAINT po_line_discount_range CHECK (discount_percent >= 0 AND discount_percent <= 100),
  CONSTRAINT po_line_received_qty CHECK (received_qty >= 0 AND received_qty <= quantity * 1.1) -- Allow 10% over-receipt
);

-- PO Status History (audit trail)
CREATE TABLE po_status_history (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  po_id UUID NOT NULL REFERENCES purchase_orders(id) ON DELETE CASCADE,
  from_status VARCHAR(20),
  to_status VARCHAR(20) NOT NULL,
  changed_by UUID REFERENCES users(id),
  changed_at TIMESTAMPTZ DEFAULT NOW(),
  notes TEXT
);

-- Indexes for performance
CREATE INDEX idx_po_org_status ON purchase_orders(org_id, status);
CREATE INDEX idx_po_supplier ON purchase_orders(supplier_id);
CREATE INDEX idx_po_delivery_date ON purchase_orders(expected_delivery_date);
CREATE INDEX idx_po_warehouse ON purchase_orders(warehouse_id);
CREATE INDEX idx_po_created_at ON purchase_orders(created_at DESC);
CREATE INDEX idx_po_lines_po ON purchase_order_lines(po_id);
CREATE INDEX idx_po_lines_product ON purchase_order_lines(product_id);

-- Trigger: Auto-calculate line totals
CREATE OR REPLACE FUNCTION calc_po_line_totals()
RETURNS TRIGGER AS $$
BEGIN
  NEW.discount_amount := ROUND(NEW.quantity * NEW.unit_price * (NEW.discount_percent / 100), 4);
  NEW.line_total := ROUND((NEW.quantity * NEW.unit_price) - NEW.discount_amount, 4);
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER tr_po_line_calc_totals
BEFORE INSERT OR UPDATE OF quantity, unit_price, discount_percent ON purchase_order_lines
FOR EACH ROW
EXECUTE FUNCTION calc_po_line_totals();

-- Trigger: Auto-update PO totals when lines change
CREATE OR REPLACE FUNCTION update_po_totals()
RETURNS TRIGGER AS $$
DECLARE
  v_po_id UUID;
  v_subtotal DECIMAL(15,4);
  v_discount_total DECIMAL(15,4);
  v_tax_rate DECIMAL(5,2);
  v_tax_amount DECIMAL(15,4);
BEGIN
  v_po_id := COALESCE(NEW.po_id, OLD.po_id);

  -- Calculate aggregates
  SELECT
    COALESCE(SUM(line_total), 0),
    COALESCE(SUM(discount_amount), 0)
  INTO v_subtotal, v_discount_total
  FROM purchase_order_lines
  WHERE po_id = v_po_id;

  -- Get tax rate
  SELECT COALESCE(tc.rate, 0)
  INTO v_tax_rate
  FROM purchase_orders po
  LEFT JOIN tax_codes tc ON po.tax_code_id = tc.id
  WHERE po.id = v_po_id;

  v_tax_amount := ROUND(v_subtotal * (v_tax_rate / 100), 4);

  -- Update PO totals
  UPDATE purchase_orders
  SET
    subtotal = v_subtotal,
    discount_total = v_discount_total,
    tax_amount = v_tax_amount,
    total = v_subtotal + v_tax_amount,
    updated_at = NOW()
  WHERE id = v_po_id;

  RETURN NULL;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER tr_po_update_totals
AFTER INSERT OR UPDATE OR DELETE ON purchase_order_lines
FOR EACH ROW
EXECUTE FUNCTION update_po_totals();

-- Function: Generate next PO number
CREATE OR REPLACE FUNCTION generate_po_number(p_org_id UUID)
RETURNS TEXT AS $$
DECLARE
  v_year TEXT;
  v_next_seq INTEGER;
  v_prefix TEXT;
BEGIN
  v_year := TO_CHAR(NOW(), 'YYYY');
  v_prefix := 'PO-' || v_year || '-';

  -- Get next sequence for this org/year
  SELECT COALESCE(MAX(
    CAST(SUBSTRING(po_number FROM LENGTH(v_prefix) + 1) AS INTEGER)
  ), 0) + 1
  INTO v_next_seq
  FROM purchase_orders
  WHERE org_id = p_org_id
    AND po_number LIKE v_prefix || '%';

  RETURN v_prefix || LPAD(v_next_seq::TEXT, 5, '0');
END;
$$ LANGUAGE plpgsql;
```

### RLS Policies

```sql
-- Enable RLS
ALTER TABLE purchase_orders ENABLE ROW LEVEL SECURITY;
ALTER TABLE purchase_order_lines ENABLE ROW LEVEL SECURITY;
ALTER TABLE po_status_history ENABLE ROW LEVEL SECURITY;

-- Purchase Orders: Org isolation
CREATE POLICY "po_select" ON purchase_orders
FOR SELECT TO authenticated
USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

CREATE POLICY "po_insert" ON purchase_orders
FOR INSERT TO authenticated
WITH CHECK (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  AND (
    (SELECT r.code FROM roles r JOIN users u ON u.role_id = r.id WHERE u.id = auth.uid())
    IN ('SUPER_ADMIN', 'ADMIN', 'PLANNER', 'PURCHASER')
  )
);

CREATE POLICY "po_update" ON purchase_orders
FOR UPDATE TO authenticated
USING (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  AND (
    (SELECT r.code FROM roles r JOIN users u ON u.role_id = r.id WHERE u.id = auth.uid())
    IN ('SUPER_ADMIN', 'ADMIN', 'PLANNER', 'PURCHASER')
  )
);

CREATE POLICY "po_delete" ON purchase_orders
FOR DELETE TO authenticated
USING (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  AND status = 'draft'
  AND (
    (SELECT r.code FROM roles r JOIN users u ON u.role_id = r.id WHERE u.id = auth.uid())
    IN ('SUPER_ADMIN', 'ADMIN', 'PLANNER')
  )
);

-- PO Lines: Access through PO (org isolation via FK)
CREATE POLICY "po_lines_select" ON purchase_order_lines
FOR SELECT TO authenticated
USING (
  EXISTS (
    SELECT 1 FROM purchase_orders po
    WHERE po.id = purchase_order_lines.po_id
      AND po.org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  )
);

CREATE POLICY "po_lines_insert" ON purchase_order_lines
FOR INSERT TO authenticated
WITH CHECK (
  EXISTS (
    SELECT 1 FROM purchase_orders po
    WHERE po.id = purchase_order_lines.po_id
      AND po.org_id = (SELECT org_id FROM users WHERE id = auth.uid())
      AND po.status IN ('draft', 'submitted')
  )
);

CREATE POLICY "po_lines_update" ON purchase_order_lines
FOR UPDATE TO authenticated
USING (
  EXISTS (
    SELECT 1 FROM purchase_orders po
    WHERE po.id = purchase_order_lines.po_id
      AND po.org_id = (SELECT org_id FROM users WHERE id = auth.uid())
      AND po.status IN ('draft', 'submitted')
  )
);

CREATE POLICY "po_lines_delete" ON purchase_order_lines
FOR DELETE TO authenticated
USING (
  EXISTS (
    SELECT 1 FROM purchase_orders po
    WHERE po.id = purchase_order_lines.po_id
      AND po.org_id = (SELECT org_id FROM users WHERE id = auth.uid())
      AND po.status = 'draft'
  )
  AND received_qty = 0
);

-- Status History: Read through PO
CREATE POLICY "po_history_select" ON po_status_history
FOR SELECT TO authenticated
USING (
  EXISTS (
    SELECT 1 FROM purchase_orders po
    WHERE po.id = po_status_history.po_id
      AND po.org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  )
);

CREATE POLICY "po_history_insert" ON po_status_history
FOR INSERT TO authenticated
WITH CHECK (
  EXISTS (
    SELECT 1 FROM purchase_orders po
    WHERE po.id = po_status_history.po_id
      AND po.org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  )
);
```

### API Endpoints

```
# Purchase Orders
GET    /api/v1/planning/purchase-orders                    - List POs (paginated, filtered)
POST   /api/v1/planning/purchase-orders                    - Create PO (header + lines)
GET    /api/v1/planning/purchase-orders/:id                - Get PO with lines
PUT    /api/v1/planning/purchase-orders/:id                - Update PO (header + lines)
DELETE /api/v1/planning/purchase-orders/:id                - Delete draft PO

# PO Status Actions
POST   /api/v1/planning/purchase-orders/:id/submit         - Submit PO
POST   /api/v1/planning/purchase-orders/:id/confirm        - Confirm PO (skip approval)
POST   /api/v1/planning/purchase-orders/:id/cancel         - Cancel PO

# PO Lines (individual operations)
POST   /api/v1/planning/purchase-orders/:id/lines          - Add single line
PUT    /api/v1/planning/purchase-orders/:id/lines/:lineId  - Update single line
DELETE /api/v1/planning/purchase-orders/:id/lines/:lineId  - Delete single line

# Utilities
GET    /api/v1/planning/purchase-orders/:id/history        - Get status history
GET    /api/v1/planning/purchase-orders/next-number        - Preview next PO number
GET    /api/v1/planning/purchase-orders/validate-product   - Check if product can be added
```

**Query Parameters (List):**
- `search` - Filter by PO number or supplier name (min 2 chars)
- `supplier_id` - Filter by supplier UUID
- `status` - Filter by status (comma-separated for multiple)
- `warehouse_id` - Filter by receiving warehouse
- `date_from` - Expected delivery date from
- `date_to` - Expected delivery date to
- `sort` - Sort field (po_number, expected_delivery_date, total, created_at)
- `order` - Sort order (asc, desc)
- `page` - Page number (default 1)
- `limit` - Items per page (default 20, max 100)

### Service Layer

```typescript
// lib/services/purchase-order-service.ts

export interface POService {
  // List operations
  list(params: POListParams): Promise<PaginatedResult<POListItem>>;
  getById(id: string): Promise<PurchaseOrderWithLines | null>;

  // CRUD operations (transactional)
  create(data: CreatePOInput): Promise<PurchaseOrderWithLines>;
  update(id: string, data: UpdatePOInput): Promise<PurchaseOrderWithLines>;
  delete(id: string): Promise<void>;

  // Status transitions
  submit(id: string): Promise<PurchaseOrder>;
  confirm(id: string): Promise<PurchaseOrder>;
  cancel(id: string, reason?: string): Promise<PurchaseOrder>;

  // Line operations
  addLine(poId: string, line: CreatePOLineInput): Promise<POLine>;
  updateLine(poId: string, lineId: string, data: UpdatePOLineInput): Promise<POLine>;
  deleteLine(poId: string, lineId: string): Promise<void>;

  // Utilities
  generateNextNumber(orgId: string): Promise<string>;
  calculateTotals(lines: POLineInput[]): POTotals;
  getStatusHistory(poId: string): Promise<POStatusHistory[]>;
  validateStatusTransition(currentStatus: POStatus, newStatus: POStatus): boolean;
  canEditLines(status: POStatus): boolean;
  canDeleteLine(lineId: string): Promise<{ allowed: boolean; reason?: string }>;
  getDefaultsFromSupplier(supplierId: string): Promise<SupplierDefaults>;
  getProductPrice(productId: string, supplierId: string): Promise<ProductPriceInfo>;
}

// Type definitions
export type POStatus = 'draft' | 'submitted' | 'pending_approval' | 'confirmed' | 'receiving' | 'closed' | 'cancelled';
export type Currency = 'PLN' | 'EUR' | 'USD' | 'GBP';

export interface PurchaseOrder {
  id: string;
  org_id: string;
  po_number: string;
  supplier_id: string;
  currency: Currency;
  tax_code_id: string | null;
  expected_delivery_date: string;
  warehouse_id: string;
  status: POStatus;
  payment_terms: string | null;
  shipping_method: string | null;
  notes: string | null;
  internal_notes: string | null;
  approval_status: string | null;
  approved_by: string | null;
  approved_at: string | null;
  approval_notes: string | null;
  subtotal: number;
  tax_amount: number;
  total: number;
  discount_total: number;
  created_at: string;
  updated_at: string;
  created_by: string;
  updated_by: string;
}

export interface POLine {
  id: string;
  po_id: string;
  line_number: number;
  product_id: string;
  quantity: number;
  uom: string;
  unit_price: number;
  discount_percent: number;
  discount_amount: number;
  line_total: number;
  expected_delivery_date: string | null;
  confirmed_delivery_date: string | null;
  received_qty: number;
  notes: string | null;
  created_at: string;
  updated_at: string;
  // Joined fields for display
  product?: {
    code: string;
    name: string;
  };
}

export interface PurchaseOrderWithLines extends PurchaseOrder {
  lines: POLine[];
  supplier?: {
    code: string;
    name: string;
  };
  warehouse?: {
    code: string;
    name: string;
  };
  tax_code?: {
    code: string;
    rate: number;
  };
}

export interface POListItem {
  id: string;
  po_number: string;
  supplier_name: string;
  status: POStatus;
  expected_delivery_date: string;
  total: number;
  currency: Currency;
  line_count: number;
  created_at: string;
}

export interface POTotals {
  subtotal: number;
  discount_total: number;
  tax_amount: number;
  total: number;
}

export interface CreatePOInput {
  supplier_id: string;
  warehouse_id: string;
  expected_delivery_date: string;
  currency?: Currency;
  tax_code_id?: string;
  payment_terms?: string;
  shipping_method?: string;
  notes?: string;
  internal_notes?: string;
  lines: CreatePOLineInput[];
}

export interface CreatePOLineInput {
  product_id: string;
  quantity: number;
  unit_price: number;
  uom?: string;
  discount_percent?: number;
  expected_delivery_date?: string;
  notes?: string;
}

export interface UpdatePOInput {
  expected_delivery_date?: string;
  warehouse_id?: string;
  tax_code_id?: string;
  payment_terms?: string;
  shipping_method?: string;
  notes?: string;
  internal_notes?: string;
  lines?: UpdatePOLineInput[];
}

export interface UpdatePOLineInput extends Partial<CreatePOLineInput> {
  id?: string;  // If present, update; if absent, create new
  _delete?: boolean;  // Mark for deletion
}
```

### Validation Schema (Zod)

```typescript
// lib/validation/purchase-order.ts
import { z } from 'zod';

export const currencyEnum = z.enum(['PLN', 'EUR', 'USD', 'GBP']);

export const poStatusEnum = z.enum([
  'draft',
  'submitted',
  'pending_approval',
  'confirmed',
  'receiving',
  'closed',
  'cancelled'
]);

// PO Line validation
export const createPOLineSchema = z.object({
  product_id: z.string().uuid('Invalid product ID'),
  quantity: z.number()
    .positive('Quantity must be positive')
    .max(999999999, 'Quantity too large'),
  unit_price: z.number()
    .min(0, 'Unit price cannot be negative')
    .max(999999999, 'Price too large'),
  uom: z.string()
    .min(1, 'UoM is required')
    .max(20, 'UoM too long'),
  discount_percent: z.number()
    .min(0, 'Discount cannot be negative')
    .max(100, 'Discount cannot exceed 100%')
    .default(0),
  expected_delivery_date: z.string().date().optional().nullable(),
  notes: z.string().max(500, 'Notes too long').optional().nullable(),
});

export const updatePOLineSchema = createPOLineSchema.partial().extend({
  id: z.string().uuid().optional(),
  _delete: z.boolean().optional(),
});

// PO Header validation
export const createPOSchema = z.object({
  supplier_id: z.string().uuid('Invalid supplier ID'),
  warehouse_id: z.string().uuid('Invalid warehouse ID'),
  expected_delivery_date: z.string().date('Invalid date format')
    .refine(
      (date) => new Date(date) >= new Date(new Date().setHours(0, 0, 0, 0)),
      'Expected delivery date must be today or in the future'
    ),
  currency: currencyEnum.default('PLN'),
  tax_code_id: z.string().uuid().optional().nullable(),
  payment_terms: z.string().max(50, 'Payment terms too long').optional().nullable(),
  shipping_method: z.string().max(100, 'Shipping method too long').optional().nullable(),
  notes: z.string().max(2000, 'Notes too long').optional().nullable(),
  internal_notes: z.string().max(2000, 'Internal notes too long').optional().nullable(),
  lines: z.array(createPOLineSchema)
    .min(0) // Allow empty for draft
    .max(200, 'Maximum 200 lines per PO'),
});

export const updatePOSchema = z.object({
  expected_delivery_date: z.string().date().optional(),
  warehouse_id: z.string().uuid().optional(),
  tax_code_id: z.string().uuid().optional().nullable(),
  payment_terms: z.string().max(50).optional().nullable(),
  shipping_method: z.string().max(100).optional().nullable(),
  notes: z.string().max(2000).optional().nullable(),
  internal_notes: z.string().max(2000).optional().nullable(),
  lines: z.array(updatePOLineSchema).optional(),
});

// Submit validation (stricter)
export const submitPOSchema = z.object({
  id: z.string().uuid(),
}).refine(
  async (data) => {
    // Business rule: Must have at least 1 line to submit
    // This is validated in service layer
    return true;
  },
  { message: 'Cannot submit PO without line items' }
);

// Type exports
export type CreatePOInput = z.infer<typeof createPOSchema>;
export type UpdatePOInput = z.infer<typeof updatePOSchema>;
export type CreatePOLineInput = z.infer<typeof createPOLineSchema>;
export type UpdatePOLineInput = z.infer<typeof updatePOLineSchema>;
export type POStatus = z.infer<typeof poStatusEnum>;
export type Currency = z.infer<typeof currencyEnum>;
```

---

## UI Components

```
app/(authenticated)/planning/purchase-orders/
  page.tsx                              -- PO list page
  [id]/page.tsx                         -- PO detail/edit page
  new/page.tsx                          -- Create new PO page

components/planning/purchase-orders/
  PODataTable.tsx                       -- List table with sorting, filtering
  POFilters.tsx                         -- Search + status/supplier/date filters
  POStatusBadge.tsx                     -- Status badge with color coding
  POStatusTimeline.tsx                  -- Status history timeline

  POForm.tsx                            -- Master form (header + lines container)
  POHeaderForm.tsx                      -- Header fields section
  POSupplierSelect.tsx                  -- Supplier dropdown with cascade
  POWarehouseSelect.tsx                 -- Warehouse dropdown
  POTaxCodeSelect.tsx                   -- Tax code dropdown

  POLinesTable.tsx                      -- Lines DataTable (editable)
  POLineRow.tsx                         -- Single line row (inline edit)
  POLineModal.tsx                       -- Add/Edit line modal
  POProductSelect.tsx                   -- Product search with price lookup

  POSummaryPanel.tsx                    -- Totals display panel
  POTotalCalculator.tsx                 -- Real-time calculation display

  POActionsBar.tsx                      -- Action buttons (save, submit, cancel)
  PODeleteConfirmDialog.tsx             -- Delete confirmation
  POCancelConfirmDialog.tsx             -- Cancel confirmation with reason
  POStatusTransitionDialog.tsx          -- Status change confirmation

  POPrintView.tsx                       -- Print-friendly layout
  POExportMenu.tsx                      -- Export to PDF/Excel
```

### Status Badge Colors (TailwindCSS)

| Status | Badge Class |
|--------|-------------|
| draft | `bg-gray-100 text-gray-800` |
| submitted | `bg-blue-100 text-blue-800` |
| pending_approval | `bg-yellow-100 text-yellow-800` |
| confirmed | `bg-green-100 text-green-800` |
| receiving | `bg-purple-100 text-purple-800` |
| closed | `bg-emerald-100 text-emerald-800` |
| cancelled | `bg-red-100 text-red-800` |

### Currency Formatting

| Currency | Format | Example |
|----------|--------|---------|
| PLN | `#,##0.00 zl` | 1,234.56 zl |
| EUR | `#,##0.00` | 1,234.56 |
| USD | `$#,##0.00` | $1,234.56 |
| GBP | `#,##0.00` | 1,234.56 |

---

## Wireframe References

- **PLA-001**: Purchase Order List - `/docs/3-ARCHITECTURE/ux/wireframes/PLA-001-po-list.md`
- **PLA-002**: Purchase Order Detail/Form - `/docs/3-ARCHITECTURE/ux/wireframes/PLA-002-po-detail.md`
- **PLA-003**: PO Lines Table - `/docs/3-ARCHITECTURE/ux/wireframes/PLA-003-po-lines.md`

---

## Out of Scope

| Feature | Reason | Future Story |
|---------|--------|--------------|
| Bulk PO Creation | Separate workflow | Story 03.4 |
| PO Approval Workflow | Should Have feature | Story 03.5a/b |
| Configurable Statuses | Should Have feature | Story 03.6 |
| PO Templates | Phase 2 feature | Story 03.7 |
| Blanket POs | Phase 2 feature | Story 03.7 |
| PO Import from Excel | Bulk creation feature | Story 03.4 |
| PO Receiving | Warehouse module | Epic 05 |
| Supplier Notifications | Integration feature | Future |
| EDI Integration | Phase 3 feature | Epic 11 |

---

## Test Cases

### Unit Tests

**File:** `__tests__/unit/services/purchase-order-service.test.ts`

| Test Case | Description |
|-----------|-------------|
| `create()` generates unique PO number | Verify sequence generation |
| `create()` cascades supplier defaults | Currency, tax, terms inherited |
| `create()` validates required fields | Supplier, warehouse, date required |
| `create()` creates header and lines atomically | Transaction rollback on error |
| `update()` recalculates totals | Line changes update header totals |
| `update()` validates status restrictions | Cannot edit confirmed+ PO lines |
| `addLine()` checks for duplicate product | Same product blocked |
| `addLine()` defaults price from supplier-product | Price inheritance logic |
| `deleteLine()` blocked with received qty | Business rule enforcement |
| `submit()` requires at least 1 line | Cannot submit empty PO |
| `submit()` changes status correctly | draft -> confirmed (no approval) |
| `cancel()` blocked with receipts | Business rule enforcement |
| `calculateTotals()` handles discounts | Line discount calculation |
| `calculateTotals()` applies tax rate | Tax amount calculation |
| `validateStatusTransition()` enforces rules | Valid transitions only |

### Integration Tests

**File:** `__tests__/integration/api/planning/purchase-orders.test.ts`

| Test Case | Description |
|-----------|-------------|
| GET `/purchase-orders` returns paginated list | Pagination, filters, sort |
| GET `/purchase-orders?status=draft` filters | Status filter |
| GET `/purchase-orders?supplier_id=X` filters | Supplier filter |
| GET `/purchase-orders?date_from=X&date_to=Y` filters | Date range filter |
| POST `/purchase-orders` creates with lines | Full creation flow |
| POST `/purchase-orders` validates required | Missing fields return 400 |
| POST `/purchase-orders` duplicate product 400 | Uniqueness per PO |
| PUT `/purchase-orders/:id` updates header | Mutable fields only |
| PUT `/purchase-orders/:id` updates lines | Add, modify, delete lines |
| PUT `/purchase-orders/:id` recalculates totals | Automatic recalculation |
| DELETE `/purchase-orders/:id` draft only | Non-draft returns 400 |
| POST `/purchase-orders/:id/submit` validation | Requires lines |
| POST `/purchase-orders/:id/cancel` validation | No receipts required |
| Cross-org access returns 404 | Multi-tenancy |
| Permission denied returns 403 | Role enforcement |
| Transaction rollback on error | Atomic operations |

### E2E Tests

**File:** `__tests__/e2e/planning/purchase-orders.spec.ts`

| Test Case | Description |
|-----------|-------------|
| Create PO flow | Form > supplier > lines > save |
| Edit PO flow | Detail > edit > modify > save |
| Add line item | Detail > add line > product > qty > save |
| Remove line item | Detail > delete line > confirm |
| Submit PO | Draft > submit > status change |
| Cancel PO | Draft > cancel > confirm > status |
| Filter and search | List > filters > results |
| Sort by columns | Column headers toggle |
| Pagination | Page navigation |
| Supplier cascade | Select supplier > fields auto-fill |
| Price lookup | Select product > price auto-fill |
| Real-time totals | Modify line > totals update |
| Print view | Actions > print > layout |
| Permission-based UI | Different roles see different actions |

---

## Key Business Rules

1. **PO Number Format**: `PO-YYYY-NNNNN` (year + 5-digit sequence per org)
2. **Supplier Defaults Cascade**: Currency, tax code, payment terms from supplier to PO
3. **Price Defaults**: Supplier-product price > Product std_price > Manual entry
4. **Line Totals**: `line_total = (qty * unit_price) - discount_amount`
5. **Header Totals**: Calculated via database triggers on line changes
6. **Status Transitions**: Enforced per state machine (see AC-5)
7. **Edit Restrictions**: Lines locked after status = confirmed+
8. **Delete Restrictions**: Cannot delete line with received_qty > 0
9. **Cancel Restrictions**: Cannot cancel PO with any receipts
10. **Duplicate Products**: Same product cannot appear twice on same PO

---

## Performance Requirements

| Metric | Target |
|--------|--------|
| PO List load | < 300ms |
| PO Detail load (50 lines) | < 500ms |
| Create PO (10 lines) | < 1s |
| Line total recalculation | < 100ms |
| Search debounce | 200ms |

---

## Definition of Done

- [ ] Database migration creates `purchase_orders`, `purchase_order_lines`, `po_status_history` tables
- [ ] All constraints and indexes created
- [ ] Triggers for line total and PO total calculations working
- [ ] PO number generation function working (sequence per org/year)
- [ ] RLS policies enforce org isolation and role permissions
- [ ] All API endpoints implemented (list, CRUD, status actions, lines)
- [ ] Zod schemas validate all inputs (header + lines)
- [ ] `purchase-order-service.ts` implements all methods
- [ ] Transaction handling for create/update with rollback
- [ ] PO list page with DataTable (PLA-001)
- [ ] PO detail page with embedded lines table (PLA-002)
- [ ] Line management: add, edit, delete with validation
- [ ] Supplier cascade working (defaults auto-fill)
- [ ] Product price lookup working (supplier-product > std_price)
- [ ] Real-time totals calculation
- [ ] Status badges with correct colors
- [ ] Status transitions enforced with validation
- [ ] Submit/Cancel actions with proper checks
- [ ] Permission matrix implemented (planner, viewer)
- [ ] Multi-tenancy: cross-org returns 404
- [ ] Unit tests >= 80% coverage
- [ ] Integration tests for all endpoints
- [ ] E2E tests for critical flows
- [ ] Loading, empty, error states implemented
- [ ] Toast notifications on success/error
- [ ] Accessibility: keyboard nav, ARIA labels

---

## Future Phases (Not in MVP)

### Phase 1
- **PO Approval Workflow** (Story 03.5a/b) - Configurable approval with thresholds
- **Configurable Statuses** (Story 03.6) - Customizable status list per org
- **Bulk PO Creation** (Story 03.4) - Import products, auto-group by supplier

### Phase 2
- **PO Templates** (Story 03.7) - Reusable PO configurations
- **Blanket POs** (Story 03.7) - Long-term agreements with releases
- **PO Receiving Integration** - Deep link to warehouse receiving
- **Supplier Notifications** - Email/EDI on confirm

### Phase 3
- **EDI Integration** - EDIFACT X12 850/855
- **Supplier Portal** - Vendor self-service for order confirmation

**Implementation**: See Epic 03.0 "Future Feature Handling" for guidance on Phase 1+ features in UI/API.

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-12-16 | Initial story creation | ARCHITECT-AGENT |
