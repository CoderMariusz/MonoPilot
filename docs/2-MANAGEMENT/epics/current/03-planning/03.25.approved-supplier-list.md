# 03.25 - Approved Supplier List (ASL)

**Story ID:** 03.25
**Epic:** 03 - Planning
**Phase:** 3
**Complexity:** M (Medium)
**Estimate:** 3-4 days
**Type:** Backend + Frontend
**State:** ready
**Priority:** P2

**Primary PRD:** `docs/1-BASELINE/product/modules/PLANNING.md` (FR-PLAN-050)
**Architecture:** `docs/1-BASELINE/architecture/modules/planning.md`
**UX Wireframes:** PLAN-050 (Approval Workflow), PLAN-051 (ASL Dashboard)

## PRD References

| FR ID | Requirement | Priority | Phase | Covered |
|-------|-------------|----------|-------|---------|
| FR-PLAN-050 | Approved Supplier List | Could Have | 3 | Yes |
| FR-PLAN-001 | Supplier CRUD | Must Have | 1 | Dependency |
| FR-PLAN-002 | Supplier-Product Assignment | Must Have | 1 | Dependency |

## User Story

**As a** Quality Manager,
**I want** to manage an Approved Supplier List (ASL) with formal approval workflows,
**So that** we only purchase from qualified, vetted suppliers and maintain compliance with food safety regulations.

**As a** Purchaser,
**I want** the system to enforce ASL requirements when creating purchase orders,
**So that** I don't accidentally order from unapproved or suspended suppliers.

## Goal

Implement a formal Approved Supplier List (ASL) system that tracks supplier approval status, manages approval expiry and re-certification, and enforces purchasing restrictions. The system ensures food manufacturers maintain compliance with regulatory requirements (FSSC 22000, BRC, SQF) by controlling which suppliers can provide specific product categories.

## Scope

**In scope:**
- Supplier approval status workflow (pending, approved, suspended, rejected)
- Approval criteria and documentation management
- Approved product categories per supplier
- ASL enforcement on PO creation (block non-approved suppliers)
- Approval expiry dates and re-certification tracking
- Approval history and audit trail
- ASL dashboard with expiring/suspended supplier alerts
- Role-based approval permissions
- Approval notes and documentation attachment

**Out of scope:**
- Supplier scorecards and performance metrics (FR-PLAN-051, separate story)
- Supplier audits and findings management (FR-PLAN-052, separate story)
- Automatic score-based approval/suspension
- EDI integration for supplier qualification
- Integration with external certification databases

## Dependencies

| Story | Requirement | Status |
|-------|-------------|--------|
| 03.1 | Suppliers CRUD | Required - provides supplier master data |
| 03.2 | Supplier-Product Assignment | Required - provides product categories |
| 01.6 | Role Permissions | Required - approval role checks |

## Acceptance Criteria (Given/When/Then)

### Supplier Approval Workflow

#### AC-1: Initial Approval Status
- GIVEN a new supplier is created, WHEN saved to database, THEN `approval_status = 'pending'` by default.
- GIVEN a supplier with pending status, WHEN displayed in list, THEN orange "Pending" badge is shown.
- GIVEN a supplier with pending status, WHEN user attempts to create PO, THEN system blocks with error "Supplier not approved".

#### AC-2: Approve Supplier
- GIVEN user has QUALITY_MANAGER or ADMIN role, WHEN they open supplier approval modal, THEN approve/reject buttons are visible.
- GIVEN user clicks "Approve" for a pending supplier, WHEN approval form submitted, THEN:
  - `approval_status = 'approved'`
  - `approved_at = NOW()`
  - `approved_by = current_user_id`
  - `approval_expiry_date` set (based on org setting, default 12 months)
- GIVEN supplier approved, WHEN list displayed, THEN green "Approved" badge with expiry date shown.
- GIVEN supplier approved, WHEN user creates PO, THEN supplier is available in dropdown.

#### AC-3: Suspend Supplier
- GIVEN user has QUALITY_MANAGER or ADMIN role, WHEN they click "Suspend" on approved supplier, THEN confirmation modal appears.
- GIVEN suspension confirmed with reason, WHEN submitted, THEN:
  - `approval_status = 'suspended'`
  - `suspended_at = NOW()`
  - `suspended_by = current_user_id`
  - `suspension_reason` stored
- GIVEN supplier suspended, WHEN displayed, THEN red "Suspended" badge shown with reason tooltip.
- GIVEN supplier suspended, WHEN user attempts to create PO, THEN system blocks with error "Supplier suspended: {reason}".

#### AC-4: Reject Supplier
- GIVEN user has QUALITY_MANAGER or ADMIN role, WHEN they click "Reject" on pending supplier, THEN rejection reason required.
- GIVEN rejection submitted, WHEN completed, THEN:
  - `approval_status = 'rejected'`
  - `rejected_at = NOW()`
  - `rejected_by = current_user_id`
  - `rejection_reason` stored
- GIVEN supplier rejected, WHEN displayed, THEN dark red "Rejected" badge shown.
- GIVEN supplier rejected, WHEN user attempts to create PO, THEN system blocks with error "Supplier not approved".

#### AC-5: Reinstate Suspended Supplier
- GIVEN a suspended supplier, WHEN user with QUALITY_MANAGER role clicks "Reinstate", THEN reinstatement form appears.
- GIVEN reinstatement form submitted with notes, WHEN confirmed, THEN:
  - `approval_status = 'approved'`
  - `approved_at = NOW()` (reset)
  - `approval_expiry_date` recalculated
  - Previous suspension moved to history

### Approved Product Categories

#### AC-6: Category-Based Approval
- GIVEN a supplier is approved, WHEN approval form displayed, THEN user can select approved product categories.
- GIVEN categories selected (e.g., "Raw Materials", "Packaging"), WHEN saved, THEN supplier can only provide products in those categories.
- GIVEN supplier approved for "Raw Materials" only, WHEN creating PO with "Packaging" product, THEN warning displayed: "Supplier not approved for this product category".

#### AC-7: Product-Specific Approval
- GIVEN organization setting `asl_product_level = true`, WHEN approving supplier, THEN user selects specific products (not categories).
- GIVEN supplier approved for specific products, WHEN creating PO line, THEN only approved products available for this supplier.
- GIVEN product not in supplier's approved list, WHEN user attempts to add to PO, THEN error: "Product not in supplier's approved list".

### Approval Expiry and Re-certification

#### AC-8: Expiry Date Management
- GIVEN supplier approved with 12-month expiry, WHEN 30 days before expiry, THEN alert appears in dashboard.
- GIVEN supplier in expiry warning period, WHEN displayed in list, THEN "Expiring Soon" warning badge shown with days remaining.
- GIVEN supplier's approval expired, WHEN new day starts, THEN `approval_status` automatically changes to 'expired'.
- GIVEN supplier with expired approval, WHEN user creates PO, THEN system blocks with error "Supplier approval expired on {date}".

#### AC-9: Re-certification Workflow
- GIVEN supplier with expiring approval, WHEN user clicks "Renew Approval", THEN renewal form appears.
- GIVEN renewal form submitted, WHEN approved, THEN:
  - `approval_expiry_date` extended by org default (e.g., 12 months)
  - `last_recertification_date = NOW()`
  - `recertification_count` incremented
- GIVEN renewal completed, WHEN history viewed, THEN all certifications visible with dates.

#### AC-10: Grace Period
- GIVEN org setting `asl_grace_period_days = 7`, WHEN supplier approval expires, THEN 7-day grace period before blocking.
- GIVEN supplier in grace period, WHEN creating PO, THEN warning shown but PO allowed: "Supplier approval expired. Grace period ends {date}".
- GIVEN grace period ended, WHEN creating PO, THEN hard block applied.

### PO Creation Enforcement

#### AC-11: ASL Enforcement Toggle
- GIVEN organization setting `enforce_asl = true`, WHEN creating PO, THEN only approved suppliers shown in dropdown.
- GIVEN `enforce_asl = false`, WHEN creating PO, THEN all active suppliers shown with warning badges for non-approved.
- GIVEN `enforce_asl = true` and admin user, WHEN creating PO, THEN override option available with justification field.

#### AC-12: PO Validation
- GIVEN PO created for approved supplier, WHEN line added with unapproved product category, THEN error displayed.
- GIVEN PO draft for approved supplier, WHEN supplier becomes suspended, THEN warning on PO: "Supplier status changed to Suspended".
- GIVEN multiple suppliers in bulk PO, WHEN any supplier not approved, THEN validation errors shown per supplier.

### Approval Documentation

#### AC-13: Required Documents
- GIVEN org setting `asl_required_documents = ['certificate', 'audit_report']`, WHEN approving supplier, THEN documents must be uploaded.
- GIVEN missing required document, WHEN approval submitted, THEN error: "Required document missing: {document_type}".
- GIVEN documents uploaded, WHEN saved, THEN files stored with metadata (type, upload_date, expiry_date).

#### AC-14: Document Expiry Tracking
- GIVEN document with expiry date, WHEN 30 days before expiry, THEN alert appears in dashboard.
- GIVEN required document expired, WHEN supplier status checked, THEN warning: "Expired document: {document_type}".
- GIVEN all required documents expired, WHEN org setting `block_on_doc_expiry = true`, THEN supplier PO blocked.

### ASL Dashboard

#### AC-15: Dashboard Overview
- GIVEN user navigates to ASL dashboard, WHEN page loads, THEN KPI cards display:
  - Total Approved Suppliers
  - Pending Approval
  - Expiring Soon (30 days)
  - Suspended Suppliers
- GIVEN KPIs displayed, WHEN clicked, THEN filtered list shown.

#### AC-16: Expiry Calendar
- GIVEN ASL dashboard, WHEN calendar tab selected, THEN calendar view shows approval expiry dates.
- GIVEN month view, WHEN displayed, THEN suppliers expiring that month highlighted.
- GIVEN supplier expiry clicked, WHEN modal opens, THEN quick actions: Renew, Suspend, View Details.

#### AC-17: Alerts Panel
- GIVEN ASL dashboard, WHEN alerts panel visible, THEN grouped alerts show:
  - Suppliers pending approval > 7 days
  - Suppliers expiring within 30 days
  - Documents expiring within 30 days
  - Recently suspended suppliers (last 7 days)

### Audit Trail

#### AC-18: Approval History
- GIVEN supplier detail page, WHEN "Approval History" tab clicked, THEN full timeline displayed.
- GIVEN timeline, WHEN rendered, THEN each entry shows: action, date, user, notes, documents.
- GIVEN approval history, WHEN exported, THEN PDF report generated with all approval data.

#### AC-19: Audit Log Integration
- GIVEN any approval action (approve, suspend, reject, renew), WHEN completed, THEN audit log entry created.
- GIVEN audit log entry, WHEN queried, THEN includes: user_id, action, old_status, new_status, timestamp, ip_address.

### Multi-tenancy

#### AC-20: Org Isolation
- GIVEN User A from Org A, WHEN viewing ASL, THEN only Org A suppliers shown.
- GIVEN User A from Org A, WHEN attempting to approve Org B supplier, THEN 404 Not Found returned.

## Technical Specification

### Database Schema

#### supplier_approvals table

```sql
CREATE TABLE supplier_approvals (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  supplier_id UUID NOT NULL REFERENCES suppliers(id) ON DELETE CASCADE,
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,

  -- Approval status
  approval_status VARCHAR(20) NOT NULL DEFAULT 'pending'
    CHECK (approval_status IN ('pending', 'approved', 'suspended', 'rejected', 'expired')),

  -- Approval dates
  approved_at TIMESTAMPTZ,
  approved_by UUID REFERENCES users(id),
  approval_expiry_date DATE,
  last_recertification_date DATE,
  recertification_count INTEGER DEFAULT 0,

  -- Suspension/Rejection
  suspended_at TIMESTAMPTZ,
  suspended_by UUID REFERENCES users(id),
  suspension_reason TEXT,
  rejected_at TIMESTAMPTZ,
  rejected_by UUID REFERENCES users(id),
  rejection_reason TEXT,

  -- Approved scope
  approved_categories TEXT[],  -- e.g., ['raw_materials', 'packaging']
  approved_product_ids UUID[], -- For product-level approval

  -- Documentation
  approval_notes TEXT,

  -- Audit
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  created_by UUID REFERENCES users(id),
  updated_by UUID REFERENCES users(id),

  UNIQUE(supplier_id)
);

-- Indexes
CREATE INDEX idx_supplier_approvals_supplier ON supplier_approvals(supplier_id);
CREATE INDEX idx_supplier_approvals_org ON supplier_approvals(org_id);
CREATE INDEX idx_supplier_approvals_status ON supplier_approvals(org_id, approval_status);
CREATE INDEX idx_supplier_approvals_expiry ON supplier_approvals(org_id, approval_expiry_date)
  WHERE approval_status = 'approved';

-- Cleanup: Check for expired approvals daily (via scheduled function)
```

#### supplier_approval_history table

```sql
CREATE TABLE supplier_approval_history (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  supplier_id UUID NOT NULL REFERENCES suppliers(id) ON DELETE CASCADE,
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,

  -- Action details
  action VARCHAR(30) NOT NULL
    CHECK (action IN ('created', 'approved', 'suspended', 'rejected', 'reinstated', 'renewed', 'expired', 'document_added', 'document_expired')),
  previous_status VARCHAR(20),
  new_status VARCHAR(20),

  -- Action metadata
  action_date TIMESTAMPTZ DEFAULT NOW(),
  action_by UUID REFERENCES users(id),
  action_notes TEXT,

  -- Optional document reference
  document_id UUID,

  -- Audit
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Indexes
CREATE INDEX idx_approval_history_supplier ON supplier_approval_history(supplier_id);
CREATE INDEX idx_approval_history_org_date ON supplier_approval_history(org_id, action_date DESC);
```

#### supplier_approval_documents table

```sql
CREATE TABLE supplier_approval_documents (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  supplier_id UUID NOT NULL REFERENCES suppliers(id) ON DELETE CASCADE,
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,

  -- Document details
  document_type VARCHAR(50) NOT NULL, -- 'certificate', 'audit_report', 'insurance', 'haccp'
  document_name VARCHAR(255) NOT NULL,
  file_path TEXT NOT NULL,
  file_size INTEGER,
  mime_type VARCHAR(100),

  -- Validity
  issue_date DATE,
  expiry_date DATE,
  is_active BOOLEAN DEFAULT true,

  -- Audit
  uploaded_at TIMESTAMPTZ DEFAULT NOW(),
  uploaded_by UUID REFERENCES users(id),

  CONSTRAINT valid_dates CHECK (expiry_date IS NULL OR expiry_date > issue_date)
);

-- Indexes
CREATE INDEX idx_approval_docs_supplier ON supplier_approval_documents(supplier_id);
CREATE INDEX idx_approval_docs_expiry ON supplier_approval_documents(org_id, expiry_date)
  WHERE is_active = true;
```

#### organization_settings extension

```sql
-- Add ASL settings to organizations
ALTER TABLE organizations ADD COLUMN IF NOT EXISTS
  enforce_asl BOOLEAN DEFAULT false;

ALTER TABLE organizations ADD COLUMN IF NOT EXISTS
  asl_approval_expiry_months INTEGER DEFAULT 12 CHECK (asl_approval_expiry_months >= 1 AND asl_approval_expiry_months <= 60);

ALTER TABLE organizations ADD COLUMN IF NOT EXISTS
  asl_grace_period_days INTEGER DEFAULT 0 CHECK (asl_grace_period_days >= 0 AND asl_grace_period_days <= 30);

ALTER TABLE organizations ADD COLUMN IF NOT EXISTS
  asl_product_level BOOLEAN DEFAULT false; -- false = category level, true = product level

ALTER TABLE organizations ADD COLUMN IF NOT EXISTS
  asl_required_documents TEXT[] DEFAULT '{}'; -- e.g., ['certificate', 'audit_report']

ALTER TABLE organizations ADD COLUMN IF NOT EXISTS
  asl_block_on_doc_expiry BOOLEAN DEFAULT false;

ALTER TABLE organizations ADD COLUMN IF NOT EXISTS
  asl_expiry_warning_days INTEGER DEFAULT 30;
```

### RLS Policies

```sql
-- supplier_approvals: Users can see their org's approvals
CREATE POLICY "approvals_org_read" ON supplier_approvals
FOR SELECT USING (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
);

-- Only QUALITY_MANAGER and ADMIN can modify approvals
CREATE POLICY "approvals_quality_write" ON supplier_approvals
FOR ALL USING (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  AND (SELECT r.code FROM roles r JOIN users u ON u.role_id = r.id WHERE u.id = auth.uid()) IN ('SUPER_ADMIN', 'ADMIN', 'QUALITY_MANAGER')
);

-- supplier_approval_history: Read-only for org users
CREATE POLICY "approval_history_org_read" ON supplier_approval_history
FOR SELECT USING (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
);

-- supplier_approval_documents: Org isolation
CREATE POLICY "approval_docs_org" ON supplier_approval_documents
FOR ALL USING (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
);
```

### API Endpoints

```
# Supplier Approval Management
GET    /api/planning/suppliers/:supplierId/approval       - Get supplier approval status
POST   /api/planning/suppliers/:supplierId/approval       - Create/update approval
PUT    /api/planning/suppliers/:supplierId/approval       - Update approval details
POST   /api/planning/suppliers/:supplierId/approve        - Approve supplier
POST   /api/planning/suppliers/:supplierId/suspend        - Suspend supplier
POST   /api/planning/suppliers/:supplierId/reject         - Reject supplier
POST   /api/planning/suppliers/:supplierId/reinstate      - Reinstate suspended supplier
POST   /api/planning/suppliers/:supplierId/renew          - Renew expiring approval

# Approval History
GET    /api/planning/suppliers/:supplierId/approval/history - Get approval timeline

# Approval Documents
GET    /api/planning/suppliers/:supplierId/approval/documents     - List documents
POST   /api/planning/suppliers/:supplierId/approval/documents     - Upload document
DELETE /api/planning/suppliers/:supplierId/approval/documents/:id - Delete document

# ASL Dashboard
GET    /api/planning/asl/summary                          - Get ASL KPIs
GET    /api/planning/asl/expiring                         - Get suppliers expiring soon
GET    /api/planning/asl/pending                          - Get pending approvals
GET    /api/planning/asl/alerts                           - Get all ASL alerts

# Validation (for PO creation)
GET    /api/planning/suppliers/:supplierId/can-order      - Check if supplier can be used for PO
POST   /api/planning/asl/validate-po                      - Validate PO against ASL rules
```

### Service Methods

**Location:** `lib/services/supplier-approval-service.ts`

```typescript
interface SupplierApprovalService {
  // Approval CRUD
  getApproval(supplierId: string): Promise<SupplierApproval | null>;
  createApproval(supplierId: string, data: CreateApprovalDto): Promise<SupplierApproval>;
  updateApproval(supplierId: string, data: UpdateApprovalDto): Promise<SupplierApproval>;

  // Status transitions
  approveSupplier(supplierId: string, data: ApproveDto): Promise<SupplierApproval>;
  suspendSupplier(supplierId: string, reason: string): Promise<SupplierApproval>;
  rejectSupplier(supplierId: string, reason: string): Promise<SupplierApproval>;
  reinstateSupplier(supplierId: string, notes?: string): Promise<SupplierApproval>;
  renewApproval(supplierId: string, newExpiryDate?: Date): Promise<SupplierApproval>;

  // Validation
  canSupplierBeUsedForPO(supplierId: string): Promise<ValidationResult>;
  validatePOAgainstASL(poData: POValidationData): Promise<ASLValidationResult>;
  checkProductCategoryApproval(supplierId: string, productId: string): Promise<boolean>;

  // Expiry management
  getExpiringSoon(daysAhead: number): Promise<SupplierApproval[]>;
  processExpiredApprovals(): Promise<number>; // Scheduled job

  // History
  getApprovalHistory(supplierId: string): Promise<ApprovalHistoryEntry[]>;
  addHistoryEntry(supplierId: string, action: string, notes?: string): Promise<void>;

  // Documents
  getDocuments(supplierId: string): Promise<ApprovalDocument[]>;
  uploadDocument(supplierId: string, file: File, metadata: DocumentMetadata): Promise<ApprovalDocument>;
  deleteDocument(documentId: string): Promise<void>;
  getExpiringDocuments(daysAhead: number): Promise<ApprovalDocument[]>;

  // Dashboard
  getASLSummary(): Promise<ASLSummary>;
  getASLAlerts(): Promise<ASLAlert[]>;
}

interface ValidationResult {
  valid: boolean;
  errors: string[];
  warnings: string[];
  approval?: SupplierApproval;
}

interface ASLValidationResult {
  valid: boolean;
  supplierResults: {
    supplierId: string;
    supplierName: string;
    valid: boolean;
    errors: string[];
    warnings: string[];
  }[];
}

interface ASLSummary {
  total_approved: number;
  pending_approval: number;
  expiring_soon: number;
  suspended: number;
  expired: number;
  documents_expiring: number;
}

interface ASLAlert {
  type: 'pending_old' | 'expiring' | 'document_expiring' | 'recently_suspended';
  supplier_id: string;
  supplier_name: string;
  message: string;
  severity: 'warning' | 'error';
  date: string;
}
```

### Zod Validation Schemas

**Location:** `lib/validation/supplier-approval.ts`

```typescript
import { z } from 'zod';

// Approval status enum
export const approvalStatusSchema = z.enum([
  'pending', 'approved', 'suspended', 'rejected', 'expired'
]);

// Approve supplier request
export const approveSupplierSchema = z.object({
  approved_categories: z.array(z.string()).min(1, 'At least one category required'),
  approved_product_ids: z.array(z.string().uuid()).optional(),
  approval_expiry_date: z.string().datetime().optional(),
  approval_notes: z.string().max(2000).optional(),
});

// Suspend supplier request
export const suspendSupplierSchema = z.object({
  suspension_reason: z.string().min(10, 'Reason must be at least 10 characters').max(500),
});

// Reject supplier request
export const rejectSupplierSchema = z.object({
  rejection_reason: z.string().min(10, 'Reason must be at least 10 characters').max(500),
});

// Reinstate supplier request
export const reinstateSupplierSchema = z.object({
  reinstatement_notes: z.string().max(500).optional(),
  new_expiry_date: z.string().datetime().optional(),
});

// Renew approval request
export const renewApprovalSchema = z.object({
  new_expiry_date: z.string().datetime().optional(),
  renewal_notes: z.string().max(500).optional(),
  updated_categories: z.array(z.string()).optional(),
});

// Document upload
export const uploadDocumentSchema = z.object({
  document_type: z.enum(['certificate', 'audit_report', 'insurance', 'haccp', 'other']),
  document_name: z.string().min(1).max(255),
  issue_date: z.string().datetime().optional(),
  expiry_date: z.string().datetime().optional(),
});

// ASL settings update
export const aslSettingsSchema = z.object({
  enforce_asl: z.boolean(),
  asl_approval_expiry_months: z.number().min(1).max(60),
  asl_grace_period_days: z.number().min(0).max(30),
  asl_product_level: z.boolean(),
  asl_required_documents: z.array(z.string()),
  asl_block_on_doc_expiry: z.boolean(),
  asl_expiry_warning_days: z.number().min(7).max(90),
});
```

## UI Components

### Pages

- `app/(authenticated)/planning/asl/page.tsx` - ASL Dashboard
- `app/(authenticated)/planning/suppliers/[id]/approval/page.tsx` - Supplier approval detail

### Components

**Location:** `components/planning/asl/`

```
ASLDashboard.tsx              - Main dashboard with KPIs, calendar, alerts
ASLSummaryCards.tsx           - KPI cards (approved, pending, expiring, suspended)
ASLExpiryCalendar.tsx         - Calendar view of upcoming expirations
ASLAlertsPanel.tsx            - Grouped alerts by type
ASLSupplierList.tsx           - Filtered list of suppliers by status

SupplierApprovalModal.tsx     - Modal for approve/reject/suspend actions
SupplierApprovalBadge.tsx     - Status badge with color and tooltip
SupplierApprovalTimeline.tsx  - History timeline view
SupplierApprovalForm.tsx      - Form for categories, dates, notes

ApprovalDocumentsList.tsx     - List of approval documents
ApprovalDocumentUpload.tsx    - Document upload with metadata
ApprovalDocumentCard.tsx      - Single document display

CategorySelector.tsx          - Multi-select for product categories
ProductApprovalSelector.tsx   - Product-level approval selector
ExpiryDatePicker.tsx          - Date picker with expiry calculation
```

### Component Details

**ASLSummaryCards.tsx**
```tsx
interface ASLSummaryCardsProps {
  summary: ASLSummary;
  onCardClick: (filter: string) => void;
}
// Displays 4 cards: Approved, Pending, Expiring, Suspended
// Click navigates to filtered list
```

**SupplierApprovalModal.tsx**
```tsx
interface SupplierApprovalModalProps {
  supplier: Supplier;
  approval: SupplierApproval | null;
  action: 'approve' | 'suspend' | 'reject' | 'reinstate' | 'renew';
  onSuccess: () => void;
  onClose: () => void;
}
// Dynamic form based on action type
// Validates required documents for approval
```

**SupplierApprovalBadge.tsx**
```tsx
interface SupplierApprovalBadgeProps {
  status: ApprovalStatus;
  expiryDate?: Date;
  showExpiry?: boolean;
}
// Colors: pending=orange, approved=green, suspended=red, rejected=dark-red, expired=gray
// Shows days until expiry in tooltip
```

### UI Patterns

**Approval Status Badges:**
```
+------------------+
| Approved         | <- Green badge
| Expires: 45 days |
+------------------+

+------------------+
| Suspended        | <- Red badge
| Reason: Quality  |
+------------------+

+------------------+
| Pending          | <- Orange badge
| Since: 5 days    |
+------------------+
```

**ASL Dashboard Layout:**
```
+------------------------------------------+
| Approved Supplier List                   |
+------------------------------------------+
| [KPI: 42]   [KPI: 5]   [KPI: 3]  [KPI: 2]|
| Approved    Pending    Expiring  Suspend |
+------------------------------------------+
| Alerts                  | Expiry Calendar|
| - 3 pending > 7 days    |  [  January  ] |
| - 2 expiring in 30d     |  [  Feb      ] |
| - 1 doc expiring        |  [  Mar      ] |
+------------------------------------------+
| Supplier List (filtered)                 |
| [Search] [Status Filter] [Category]      |
| +------+--------+--------+-------+-----+ |
| | Code | Name   | Status | Expiry| ... | |
+------------------------------------------+
```

## Test Cases

### Unit Tests

**supplier-approval-service.test.ts**
```typescript
describe('SupplierApprovalService', () => {
  describe('approveSupplier', () => {
    it('sets status to approved with correct dates');
    it('calculates expiry based on org settings');
    it('requires at least one category');
    it('validates required documents are uploaded');
    it('creates history entry');
  });

  describe('suspendSupplier', () => {
    it('sets status to suspended with reason');
    it('requires suspension reason');
    it('blocks supplier from PO creation');
  });

  describe('canSupplierBeUsedForPO', () => {
    it('returns valid=true for approved supplier');
    it('returns valid=false for pending supplier');
    it('returns valid=false for suspended supplier');
    it('returns warning for expiring supplier');
    it('returns error for expired supplier');
    it('handles grace period correctly');
  });

  describe('processExpiredApprovals', () => {
    it('changes status to expired after expiry date');
    it('respects grace period setting');
    it('creates history entry for expiration');
  });
});
```

### Integration Tests

**supplier-approval-api.test.ts**
```typescript
describe('Supplier Approval API', () => {
  describe('POST /api/planning/suppliers/:id/approve', () => {
    it('approves supplier with valid data');
    it('returns 403 for non-quality-manager role');
    it('returns 400 for missing required documents');
    it('returns 404 for other org supplier');
  });

  describe('GET /api/planning/asl/summary', () => {
    it('returns correct KPI counts');
    it('filters by current org');
  });

  describe('POST /api/planning/asl/validate-po', () => {
    it('returns valid for approved suppliers');
    it('returns errors for non-approved suppliers');
    it('returns warnings for expiring suppliers');
  });
});
```

### E2E Tests

**asl-workflow.spec.ts**
```typescript
describe('ASL Workflow', () => {
  it('displays pending supplier in list');
  it('approves supplier with categories');
  it('shows approved badge after approval');
  it('allows PO creation for approved supplier');
  it('suspends supplier with reason');
  it('blocks PO creation for suspended supplier');
  it('reinstates suspended supplier');
  it('shows expiry warning in dashboard');
});
```

## Security Considerations

1. **Role-Based Access**
   - Only QUALITY_MANAGER and ADMIN can approve/suspend/reject
   - All users can view approval status
   - Purchasers cannot override ASL enforcement

2. **Audit Trail**
   - All approval actions logged with user, timestamp, IP
   - History cannot be modified or deleted
   - Export available for auditors

3. **Document Security**
   - Files stored in secure bucket with org isolation
   - Pre-signed URLs for document access
   - Virus scanning on upload

4. **Rate Limiting**
   - Max 10 approval actions per minute per user
   - Max 50 document uploads per hour per org

## Deliverables

- [ ] `supplier_approvals` table migration
- [ ] `supplier_approval_history` table migration
- [ ] `supplier_approval_documents` table migration
- [ ] Organizations table extension (ASL settings)
- [ ] RLS policies for all approval tables
- [ ] Supplier approval service (`lib/services/supplier-approval-service.ts`)
- [ ] Zod schemas (`lib/validation/supplier-approval.ts`)
- [ ] API routes for approval management
- [ ] API routes for document management
- [ ] API routes for ASL dashboard
- [ ] ASLDashboard component
- [ ] ASLSummaryCards component
- [ ] SupplierApprovalModal component
- [ ] SupplierApprovalBadge component
- [ ] SupplierApprovalTimeline component
- [ ] ApprovalDocumentsList component
- [ ] ASL dashboard page
- [ ] PO creation ASL validation integration
- [ ] Scheduled job for expiry processing
- [ ] Unit tests (>80% coverage)
- [ ] Integration tests
- [ ] E2E tests

## Definition of Done

- [ ] Supplier approval workflow complete (pending -> approved/rejected)
- [ ] Suspension and reinstatement working
- [ ] Approval expiry dates calculated and enforced
- [ ] Re-certification workflow working
- [ ] Category-based approval working
- [ ] ASL enforcement on PO creation working
- [ ] Grace period handling correct
- [ ] Document upload and expiry tracking working
- [ ] Required documents validation working
- [ ] ASL dashboard displaying correct KPIs
- [ ] Expiry calendar showing upcoming expirations
- [ ] Alerts panel showing all alert types
- [ ] Approval history timeline complete
- [ ] Audit log entries created for all actions
- [ ] Role permissions enforced (QUALITY_MANAGER, ADMIN)
- [ ] Cross-tenant isolation verified (RLS)
- [ ] Unit test coverage >= 80%
- [ ] Integration tests pass
- [ ] E2E tests pass
- [ ] Performance: Dashboard loads in <500ms
- [ ] Performance: Approval action completes in <200ms

## Future Phases

### Phase 3+ Extensions
- **Score-Based Auto-Suspension** - Automatically suspend suppliers below quality threshold
- **Supplier Portal** - Self-service for suppliers to upload documents
- **Certification Database Integration** - Auto-verify certifications with external databases
- **Bulk Approval** - Approve multiple suppliers at once
- **Approval Templates** - Pre-defined approval profiles by category
- **Compliance Reports** - Generate reports for auditors (BRC, SQF, FSSC)

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-01-14 | Initial story creation | ARCHITECT-AGENT |
