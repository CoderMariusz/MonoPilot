# 03.18 - Demand History Tracking

**Story ID:** 03.18
**Epic:** 03 - Planning
**Phase:** 2 (MRP/Forecasting Foundation)
**Complexity:** M (Medium)
**Estimate:** 3-4 days
**Type:** Backend + Frontend
**State:** ready

**Primary PRD:** `docs/1-BASELINE/product/modules/PLANNING.md` (FR-PLAN-030)
**UX Wireframes:** PLAN-030 (Demand History Dashboard), PLAN-031 (Product Demand Detail)

## PRD References

| FR ID | Requirement | Priority | Phase | Covered |
|-------|-------------|----------|-------|---------|
| FR-PLAN-030 | Historical Demand Tracking | Should Have | 2 | Yes |

## User Story

**As a** Planner,
**I want** to view historical demand patterns for each product,
**So that** I can make informed decisions about production scheduling and procurement based on actual consumption, production, and sales trends.

**As a** Operations Manager,
**I want** to analyze seasonality in demand,
**So that** I can plan inventory levels and production capacity for peak periods.

## Goal

Implement a comprehensive demand history tracking system that automatically captures consumption (from WO material usage), production (from WO completions), and sales (from shipped Sales Orders). This data forms the foundation for MRP calculations, forecasting, and safety stock management in subsequent stories.

## Scope

**In scope:**
- Automatic recording of daily demand data per product
- Aggregation to weekly/monthly periods
- Consumption tracking from Work Order material consumption
- Production tracking from Work Order outputs
- Sales tracking from shipped Sales Orders (Epic 07 integration point)
- Manual demand entry for historical data import
- Demand history dashboard with trend visualization
- Product-level demand detail page
- Seasonality pattern detection (basic)
- Data retention for 2+ years
- Export demand data to Excel/CSV

**Out of scope:**
- Demand forecasting algorithms (Story 03.19)
- Safety stock calculations (Story 03.20)
- Reorder point alerts (Story 03.21)
- MRP engine (Story 03.22)
- Advanced seasonality models (Phase 3)
- Machine learning predictions (Phase 3)

## Dependencies

| Story | Requirement | Status |
|-------|-------------|--------|
| 01.1 | Org Context + Base RLS | Required - provides org_id |
| 02.1 | Products | Required - product master data |
| 03.10 | Work Orders CRUD | Required - WO for consumption/production |
| 04.X | WO Completion | Optional - actual consumption data (can seed manually) |
| 07.X | Sales Orders Shipping | Optional - sales data integration |

## Acceptance Criteria (Given/When/Then)

### Demand Data Collection (FR-PLAN-030)

#### AC-1: Automatic Consumption Recording from WO
- GIVEN a Work Order is completed with material consumption, WHEN the WO status changes to "completed", THEN system records consumed_qty for each material product in demand_history table.
- GIVEN material consumption recorded, WHEN viewing demand_history, THEN source_type = 'wo_consumption' and source_reference = WO number.
- GIVEN multiple WOs completed on same day for same product, WHEN aggregating, THEN daily totals sum all WO consumptions.

#### AC-2: Automatic Production Recording from WO
- GIVEN a Work Order is completed, WHEN actual_qty > 0, THEN system records produced_qty for the output product in demand_history.
- GIVEN production recorded, WHEN viewing demand_history, THEN source_type = 'wo_production' and source_reference = WO number.
- GIVEN by-products produced in WO, WHEN completion recorded, THEN by-product quantities also recorded separately.

#### AC-3: Sales Recording from Shipped Orders (Integration Point)
- GIVEN a Sales Order is shipped (Epic 07), WHEN shipment confirmed, THEN system records sold_qty for each product in demand_history.
- GIVEN sales recorded, WHEN viewing demand_history, THEN source_type = 'so_shipment' and source_reference = SO number.
- GIVEN no Shipping module yet, WHEN viewing demand dashboard, THEN sold_qty columns show "N/A - pending integration".

#### AC-4: Manual Demand Entry
- GIVEN user has Planner role, WHEN they navigate to demand history page, THEN "Add Manual Entry" button is visible.
- GIVEN user clicks "Add Manual Entry", WHEN modal opens, THEN user can enter: product, date, consumed_qty, produced_qty, sold_qty, notes.
- GIVEN manual entry saved, WHEN viewing demand_history, THEN source_type = 'manual' and created_by shows user.
- GIVEN historical data import needed, WHEN user submits bulk manual entries, THEN system validates and saves all entries.

### Period Aggregation

#### AC-5: Daily to Weekly Aggregation
- GIVEN daily demand records exist, WHEN system runs weekly aggregation job (Sunday 23:59), THEN weekly summary created for period_type = 'weekly'.
- GIVEN weekly aggregation runs, WHEN calculating totals, THEN weekly_consumed = SUM(daily consumed_qty) for that week.
- GIVEN partial week data (e.g., start of tracking), WHEN aggregating, THEN pro-rate or flag as incomplete.

#### AC-6: Daily to Monthly Aggregation
- GIVEN daily demand records exist, WHEN month ends, THEN monthly summary created for period_type = 'monthly'.
- GIVEN monthly aggregation runs, WHEN calculating averages, THEN avg_daily_demand = total_consumed / days_with_data.

#### AC-7: Period Selection in UI
- GIVEN user on demand dashboard, WHEN selecting period toggle (Daily/Weekly/Monthly), THEN data updates to show selected aggregation.
- GIVEN Weekly selected, WHEN viewing chart, THEN X-axis shows week numbers (W01, W02, etc.) or week start dates.

### Demand History Dashboard

#### AC-8: Dashboard Layout
- GIVEN user navigates to `/planning/demand`, THEN page displays:
  - KPI cards: Total Consumption (30d), Total Production (30d), Total Sales (30d), Products Tracked
  - Period selector: Daily | Weekly | Monthly toggle
  - Date range picker (default: last 90 days)
  - Product search/filter
  - Trend chart (line chart showing consumption/production/sales over time)
  - Demand table with sortable columns

#### AC-9: Trend Chart Visualization
- GIVEN demand data exists for multiple periods, WHEN viewing trend chart, THEN three lines displayed: Consumption (blue), Production (green), Sales (orange).
- GIVEN user hovers on data point, WHEN tooltip appears, THEN shows: Date, Consumed: X, Produced: Y, Sold: Z.
- GIVEN time range exceeds 180 days, WHEN chart renders, THEN auto-switch to weekly/monthly aggregation for performance.

#### AC-10: Demand Table Display
- GIVEN user views demand table, THEN columns displayed: Product Code, Product Name, Period, Consumed Qty, Produced Qty, Sold Qty, Net Change, Trend Indicator.
- GIVEN Net Change column, WHEN calculating, THEN Net Change = Produced Qty - Consumed Qty - Sold Qty.
- GIVEN Trend Indicator column, WHEN calculating, THEN shows: up arrow (demand increasing), down arrow (decreasing), flat line (stable).

### Product Demand Detail

#### AC-11: Product Detail Navigation
- GIVEN user on demand dashboard, WHEN they click product row or "View Details", THEN navigate to `/planning/demand/[product_id]`.
- GIVEN product detail page loads, THEN display: Product info header, Period selector, Date range, Detailed trend chart, Daily records table, Seasonality panel.

#### AC-12: Product Seasonality Detection
- GIVEN 12+ months of demand data exists for product, WHEN viewing product detail, THEN Seasonality panel shows detected patterns.
- GIVEN seasonal pattern detected, WHEN displaying, THEN show: Peak months (e.g., "Nov-Dec"), Low months (e.g., "Feb-Mar"), Variation % from average.
- GIVEN insufficient data (<12 months), WHEN viewing seasonality panel, THEN show: "Insufficient data for seasonality analysis. Need 12+ months."

#### AC-13: Product Demand Metrics
- GIVEN product detail page, WHEN metrics calculated, THEN display:
  - Average Daily Demand (last 30/60/90 days selectable)
  - Standard Deviation (demand variability)
  - Coefficient of Variation (CV = StdDev / Average)
  - Highest single-day demand (peak)
  - Lowest single-day demand (trough)

### Data Management

#### AC-14: Data Retention
- GIVEN demand_history records exist, WHEN record age exceeds 24 months, THEN daily records archived to demand_history_archive.
- GIVEN archived records, WHEN user selects date range > 24 months ago, THEN query archive table.
- GIVEN retention setting configurable, WHEN admin changes retention period in settings, THEN archival job respects new setting.

#### AC-15: Export Demand Data
- GIVEN user on demand dashboard or product detail, WHEN clicking "Export" button, THEN export modal opens.
- GIVEN export modal, WHEN user selects format (Excel/CSV), date range, and products, THEN file downloads.
- GIVEN Excel export, THEN include: Summary sheet, Daily data sheet, Weekly aggregates sheet, Charts (Excel native).
- GIVEN large export (>10K rows), WHEN processing, THEN show progress indicator and allow background processing.

### Multi-tenancy & Security

#### AC-16: RLS Enforcement
- GIVEN User A from Org A queries demand_history, THEN only Org A records returned.
- GIVEN User A attempts to view Org B product demand via direct URL, THEN 404 Not Found (not 403).
- GIVEN API call without org_id context, THEN request rejected with 401.

#### AC-17: Role-Based Access
- GIVEN user with Viewer role, WHEN accessing demand dashboard, THEN can view but not add/edit entries.
- GIVEN user with Planner or Admin role, WHEN accessing demand dashboard, THEN can add manual entries and export.
- GIVEN user without Planning module access, WHEN navigating to `/planning/demand`, THEN redirect to unauthorized page.

## Technical Specification

### Database Schema

#### demand_history table

```sql
CREATE TABLE demand_history (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  product_id UUID NOT NULL REFERENCES products(id) ON DELETE CASCADE,

  -- Period identification
  record_date DATE NOT NULL,
  period_type VARCHAR(10) NOT NULL DEFAULT 'daily', -- 'daily', 'weekly', 'monthly'

  -- Demand quantities
  consumed_qty DECIMAL(15,4) DEFAULT 0, -- Material consumption from WOs
  produced_qty DECIMAL(15,4) DEFAULT 0, -- Production output from WOs
  sold_qty DECIMAL(15,4) DEFAULT 0,     -- Sales from shipped SOs

  -- Source tracking
  source_type VARCHAR(20) NOT NULL, -- 'wo_consumption', 'wo_production', 'so_shipment', 'manual', 'aggregation'
  source_reference VARCHAR(50),     -- WO-001, SO-123, etc.

  -- Audit
  notes TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  created_by UUID REFERENCES users(id),

  -- Constraints
  CONSTRAINT demand_history_unique_daily UNIQUE (org_id, product_id, record_date, source_type, source_reference)
);

-- Indexes for performance
CREATE INDEX idx_demand_history_org_product ON demand_history(org_id, product_id);
CREATE INDEX idx_demand_history_org_date ON demand_history(org_id, record_date DESC);
CREATE INDEX idx_demand_history_product_date ON demand_history(product_id, record_date DESC);
CREATE INDEX idx_demand_history_period ON demand_history(org_id, period_type, record_date);
CREATE INDEX idx_demand_history_source ON demand_history(source_type, source_reference);

-- Partial index for aggregated records
CREATE INDEX idx_demand_history_aggregated ON demand_history(org_id, product_id, period_type)
  WHERE period_type IN ('weekly', 'monthly');
```

#### demand_aggregates table (for pre-computed summaries)

```sql
CREATE TABLE demand_aggregates (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  product_id UUID NOT NULL REFERENCES products(id) ON DELETE CASCADE,

  -- Period
  period_start DATE NOT NULL,
  period_end DATE NOT NULL,
  period_type VARCHAR(10) NOT NULL, -- 'weekly', 'monthly', 'quarterly', 'yearly'

  -- Aggregated quantities
  total_consumed DECIMAL(15,4) DEFAULT 0,
  total_produced DECIMAL(15,4) DEFAULT 0,
  total_sold DECIMAL(15,4) DEFAULT 0,

  -- Statistics
  days_with_data INTEGER DEFAULT 0,
  avg_daily_consumed DECIMAL(15,4),
  avg_daily_produced DECIMAL(15,4),
  avg_daily_sold DECIMAL(15,4),
  std_dev_consumed DECIMAL(15,4),
  max_daily_consumed DECIMAL(15,4),
  min_daily_consumed DECIMAL(15,4),

  -- Trend indicators
  consumption_trend VARCHAR(10), -- 'increasing', 'decreasing', 'stable'
  trend_percent DECIMAL(5,2),   -- % change from previous period

  -- Metadata
  computed_at TIMESTAMPTZ DEFAULT NOW(),

  CONSTRAINT demand_aggregates_unique UNIQUE (org_id, product_id, period_type, period_start)
);

CREATE INDEX idx_demand_aggregates_lookup ON demand_aggregates(org_id, product_id, period_type, period_start DESC);
```

#### demand_seasonality table (for detected patterns)

```sql
CREATE TABLE demand_seasonality (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  product_id UUID NOT NULL REFERENCES products(id) ON DELETE CASCADE,

  -- Seasonality metrics
  analysis_start_date DATE NOT NULL,
  analysis_end_date DATE NOT NULL,
  data_points INTEGER NOT NULL,

  -- Monthly indices (1.0 = average, >1 = above average, <1 = below)
  jan_index DECIMAL(5,3),
  feb_index DECIMAL(5,3),
  mar_index DECIMAL(5,3),
  apr_index DECIMAL(5,3),
  may_index DECIMAL(5,3),
  jun_index DECIMAL(5,3),
  jul_index DECIMAL(5,3),
  aug_index DECIMAL(5,3),
  sep_index DECIMAL(5,3),
  oct_index DECIMAL(5,3),
  nov_index DECIMAL(5,3),
  dec_index DECIMAL(5,3),

  -- Peak/trough detection
  peak_months TEXT[], -- e.g., ['Nov', 'Dec']
  trough_months TEXT[], -- e.g., ['Feb', 'Mar']
  seasonality_strength DECIMAL(5,2), -- 0-100% (how seasonal is the product)

  -- Metadata
  computed_at TIMESTAMPTZ DEFAULT NOW(),
  confidence_level DECIMAL(5,2), -- Statistical confidence

  CONSTRAINT demand_seasonality_unique UNIQUE (org_id, product_id)
);
```

### RLS Policies

```sql
-- demand_history: Users can see their org's demand data
ALTER TABLE demand_history ENABLE ROW LEVEL SECURITY;

CREATE POLICY "demand_history_org_isolation" ON demand_history
FOR ALL USING (org_id = current_setting('app.current_org_id')::uuid);

-- demand_aggregates: Same org isolation
ALTER TABLE demand_aggregates ENABLE ROW LEVEL SECURITY;

CREATE POLICY "demand_aggregates_org_isolation" ON demand_aggregates
FOR ALL USING (org_id = current_setting('app.current_org_id')::uuid);

-- demand_seasonality: Same org isolation
ALTER TABLE demand_seasonality ENABLE ROW LEVEL SECURITY;

CREATE POLICY "demand_seasonality_org_isolation" ON demand_seasonality
FOR ALL USING (org_id = current_setting('app.current_org_id')::uuid);
```

### API Endpoints

```
# Demand History Dashboard
GET    /api/planning/demand                          - List demand summaries with filters
GET    /api/planning/demand/summary                  - Dashboard KPIs (30d totals)
GET    /api/planning/demand/trend                    - Trend data for chart

# Product Demand Detail
GET    /api/planning/demand/products/:productId      - Product demand detail
GET    /api/planning/demand/products/:productId/seasonality - Seasonality analysis

# Manual Entry
POST   /api/planning/demand/manual                   - Create manual demand entry
POST   /api/planning/demand/manual/bulk              - Bulk import demand entries

# Aggregation (internal/cron)
POST   /api/planning/demand/aggregate/daily          - Trigger daily aggregation
POST   /api/planning/demand/aggregate/weekly         - Trigger weekly aggregation
POST   /api/planning/demand/aggregate/monthly        - Trigger monthly aggregation

# Export
POST   /api/planning/demand/export                   - Export demand data to Excel/CSV

# Triggers (called by other modules)
POST   /api/planning/demand/record/consumption       - Record WO consumption (called by Production)
POST   /api/planning/demand/record/production        - Record WO production (called by Production)
POST   /api/planning/demand/record/sale              - Record SO shipment (called by Shipping)
```

### Service Methods

**Location:** `lib/services/demand-history-service.ts`

```typescript
interface DemandHistoryService {
  // Query methods
  getDemandSummary(params: DemandSummaryParams): Promise<DemandSummary>;
  getDemandList(params: DemandListParams): Promise<DemandListResult>;
  getDemandTrend(params: DemandTrendParams): Promise<DemandTrendData>;
  getProductDemand(productId: string, params: DateRangeParams): Promise<ProductDemandDetail>;
  getProductSeasonality(productId: string): Promise<SeasonalityAnalysis | null>;

  // Recording methods (called by triggers)
  recordConsumption(data: ConsumptionData): Promise<void>;
  recordProduction(data: ProductionData): Promise<void>;
  recordSale(data: SaleData): Promise<void>;

  // Manual entry
  createManualEntry(data: ManualDemandEntry): Promise<DemandHistoryRecord>;
  bulkCreateManualEntries(entries: ManualDemandEntry[]): Promise<BulkResult>;

  // Aggregation
  aggregateDaily(date: Date): Promise<AggregationResult>;
  aggregateWeekly(weekStartDate: Date): Promise<AggregationResult>;
  aggregateMonthly(monthStartDate: Date): Promise<AggregationResult>;
  computeSeasonality(productId: string): Promise<SeasonalityAnalysis>;

  // Export
  exportDemandData(params: ExportParams): Promise<Blob>;

  // Helpers
  calculateTrendIndicator(data: DemandData[]): TrendIndicator;
  detectSeasonalPattern(monthlyData: MonthlyDemand[]): SeasonalPattern;
}

interface DemandSummaryParams {
  dateFrom: Date;
  dateTo: Date;
  productIds?: string[];
}

interface DemandSummary {
  total_consumed: number;
  total_produced: number;
  total_sold: number;
  products_tracked: number;
  period_days: number;
}

interface DemandTrendData {
  periods: Array<{
    date: string;
    consumed: number;
    produced: number;
    sold: number;
  }>;
  period_type: 'daily' | 'weekly' | 'monthly';
}

interface SeasonalityAnalysis {
  product_id: string;
  has_seasonality: boolean;
  strength_percent: number;
  peak_months: string[];
  trough_months: string[];
  monthly_indices: Record<string, number>;
  confidence: number;
  data_months: number;
}

interface TrendIndicator {
  direction: 'increasing' | 'decreasing' | 'stable';
  change_percent: number;
}
```

### Zod Validation Schemas

**Location:** `lib/validation/demand-history.ts`

```typescript
import { z } from 'zod';

// Manual demand entry
export const manualDemandEntrySchema = z.object({
  product_id: z.string().uuid('Invalid product ID'),
  record_date: z.string().regex(/^\d{4}-\d{2}-\d{2}$/, 'Date must be YYYY-MM-DD format'),
  consumed_qty: z.number().min(0, 'Consumed quantity cannot be negative').optional().default(0),
  produced_qty: z.number().min(0, 'Produced quantity cannot be negative').optional().default(0),
  sold_qty: z.number().min(0, 'Sold quantity cannot be negative').optional().default(0),
  notes: z.string().max(500, 'Notes cannot exceed 500 characters').optional(),
});

export const bulkManualDemandSchema = z.object({
  entries: z.array(manualDemandEntrySchema).min(1).max(1000, 'Maximum 1000 entries per bulk import'),
});

// Query params
export const demandListParamsSchema = z.object({
  period_type: z.enum(['daily', 'weekly', 'monthly']).default('daily'),
  date_from: z.string().regex(/^\d{4}-\d{2}-\d{2}$/),
  date_to: z.string().regex(/^\d{4}-\d{2}-\d{2}$/),
  product_ids: z.array(z.string().uuid()).optional(),
  search: z.string().optional(),
  sort: z.enum(['date', 'consumed', 'produced', 'sold', 'product_name']).default('date'),
  order: z.enum(['asc', 'desc']).default('desc'),
  page: z.number().int().min(1).default(1),
  limit: z.number().int().min(1).max(100).default(20),
});

export const demandTrendParamsSchema = z.object({
  date_from: z.string().regex(/^\d{4}-\d{2}-\d{2}$/),
  date_to: z.string().regex(/^\d{4}-\d{2}-\d{2}$/),
  product_ids: z.array(z.string().uuid()).optional(),
  aggregation: z.enum(['auto', 'daily', 'weekly', 'monthly']).default('auto'),
});

// Export params
export const demandExportParamsSchema = z.object({
  format: z.enum(['xlsx', 'csv']),
  date_from: z.string().regex(/^\d{4}-\d{2}-\d{2}$/),
  date_to: z.string().regex(/^\d{4}-\d{2}-\d{2}$/),
  product_ids: z.array(z.string().uuid()).optional(),
  include_daily: z.boolean().default(true),
  include_weekly: z.boolean().default(true),
  include_monthly: z.boolean().default(true),
});

// Internal trigger schemas
export const recordConsumptionSchema = z.object({
  wo_id: z.string().uuid(),
  wo_number: z.string(),
  product_id: z.string().uuid(),
  quantity: z.number().positive(),
  record_date: z.string().regex(/^\d{4}-\d{2}-\d{2}$/),
});

export const recordProductionSchema = z.object({
  wo_id: z.string().uuid(),
  wo_number: z.string(),
  product_id: z.string().uuid(),
  quantity: z.number().positive(),
  record_date: z.string().regex(/^\d{4}-\d{2}-\d{2}$/),
  is_by_product: z.boolean().default(false),
});

export const recordSaleSchema = z.object({
  so_id: z.string().uuid(),
  so_number: z.string(),
  product_id: z.string().uuid(),
  quantity: z.number().positive(),
  record_date: z.string().regex(/^\d{4}-\d{2}-\d{2}$/),
});
```

## UI Components

### Pages

- `app/(authenticated)/planning/demand/page.tsx` - Demand history dashboard
- `app/(authenticated)/planning/demand/[productId]/page.tsx` - Product demand detail

### Components

**Location:** `components/planning/demand/`

```
DemandDashboard.tsx              - Main dashboard layout
DemandKPICards.tsx               - Summary KPI cards (4 cards)
DemandPeriodSelector.tsx         - Daily/Weekly/Monthly toggle
DemandTrendChart.tsx             - Line chart for trends (Recharts)
DemandDataTable.tsx              - Sortable demand table
DemandFilters.tsx                - Date range picker, product filter
DemandManualEntryModal.tsx       - Modal for manual entry
DemandBulkImportModal.tsx        - Excel/CSV import modal
DemandExportModal.tsx            - Export configuration modal

ProductDemandDetail.tsx          - Product detail layout
ProductDemandMetrics.tsx         - Demand statistics cards
ProductSeasonalityPanel.tsx      - Seasonality analysis display
ProductDemandChart.tsx           - Product-specific trend chart
ProductDemandTable.tsx           - Daily records for product
```

### Component Props

**DemandTrendChart.tsx**
```tsx
interface DemandTrendChartProps {
  data: DemandTrendData;
  height?: number;
  showConsumption?: boolean;
  showProduction?: boolean;
  showSales?: boolean;
  onPeriodClick?: (period: string) => void;
}
```

**ProductSeasonalityPanel.tsx**
```tsx
interface SeasonalityPanelProps {
  productId: string;
  seasonality: SeasonalityAnalysis | null;
  isLoading: boolean;
  minMonthsRequired?: number; // default 12
}

// Display states:
// 1. Loading: "Analyzing seasonality patterns..."
// 2. Insufficient data: "Need 12+ months of data (currently X months)"
// 3. No seasonality: "No significant seasonal patterns detected"
// 4. Seasonality detected: Peak/trough months with index chart
```

## Test Cases

### Unit Tests

**demand-history-service.test.ts**
```typescript
describe('DemandHistoryService', () => {
  describe('recordConsumption', () => {
    it('creates demand_history record with source_type=wo_consumption');
    it('updates existing daily record if same product/date/wo');
    it('validates quantity is positive');
    it('validates product exists');
  });

  describe('recordProduction', () => {
    it('creates demand_history record with source_type=wo_production');
    it('handles by-product recording separately');
    it('updates produced_qty correctly');
  });

  describe('aggregateWeekly', () => {
    it('sums daily records into weekly aggregate');
    it('calculates average correctly with partial data');
    it('handles week spanning month boundary');
    it('creates demand_aggregates record');
  });

  describe('computeSeasonality', () => {
    it('returns null if less than 12 months data');
    it('calculates monthly indices correctly');
    it('identifies peak months (index > 1.2)');
    it('identifies trough months (index < 0.8)');
    it('calculates seasonality strength');
  });

  describe('calculateTrendIndicator', () => {
    it('returns "increasing" if trend > 5%');
    it('returns "decreasing" if trend < -5%');
    it('returns "stable" if trend between -5% and 5%');
  });
});
```

**demand-history-validation.test.ts**
```typescript
describe('Demand History Validation', () => {
  describe('manualDemandEntrySchema', () => {
    it('accepts valid manual entry');
    it('rejects negative quantities');
    it('rejects invalid date format');
    it('rejects invalid product_id');
    it('allows zero quantities');
    it('limits notes to 500 characters');
  });

  describe('demandListParamsSchema', () => {
    it('defaults period_type to daily');
    it('validates date range format');
    it('limits page size to 100');
  });
});
```

### Integration Tests

**demand-history-api.test.ts**
```typescript
describe('Demand History API', () => {
  describe('GET /api/planning/demand', () => {
    it('returns demand list with pagination');
    it('filters by date range');
    it('filters by product IDs');
    it('aggregates by period_type');
    it('enforces RLS (only org data returned)');
  });

  describe('GET /api/planning/demand/summary', () => {
    it('returns 30-day totals');
    it('calculates products_tracked correctly');
  });

  describe('POST /api/planning/demand/manual', () => {
    it('creates manual entry with source_type=manual');
    it('validates product belongs to org');
    it('rejects duplicate date/product/source');
    it('requires Planner role minimum');
  });

  describe('POST /api/planning/demand/record/consumption', () => {
    it('internal endpoint requires service token');
    it('creates consumption record correctly');
    it('is idempotent (same WO/product/date updates, not duplicates)');
  });

  describe('POST /api/planning/demand/export', () => {
    it('generates Excel file with multiple sheets');
    it('generates CSV file single sheet');
    it('respects date range filter');
    it('limits export size to prevent timeout');
  });
});
```

### E2E Tests

**demand-dashboard.spec.ts**
```typescript
describe('Demand History Dashboard', () => {
  it('displays KPI cards with correct values');
  it('switches between daily/weekly/monthly views');
  it('updates chart when date range changed');
  it('navigates to product detail on row click');
  it('opens manual entry modal and saves entry');
  it('exports data to Excel');
});
```

**product-demand-detail.spec.ts**
```typescript
describe('Product Demand Detail', () => {
  it('displays product header and metrics');
  it('shows trend chart with consumption/production/sales');
  it('displays seasonality panel (or "insufficient data" message)');
  it('shows daily records table with pagination');
  it('allows period selection (30d/60d/90d)');
});
```

## Security Considerations

1. **Data Isolation** - RLS ensures strict org_id filtering on all demand tables.
2. **Role Enforcement** - Planner+ role required for manual entry/edit.
3. **Input Validation** - Zod schemas prevent SQL injection and invalid data.
4. **Rate Limiting** - Export endpoint limited to prevent abuse.
5. **Audit Trail** - All records have created_by, created_at for accountability.

## Performance Considerations

1. **Indexing Strategy** - Composite indexes on (org_id, product_id, record_date) for common queries.
2. **Aggregation Jobs** - Pre-compute weekly/monthly aggregates via scheduled jobs, not real-time.
3. **Chart Data Limits** - Auto-switch to weekly/monthly view if >180 days selected.
4. **Export Batching** - Stream large exports instead of loading all in memory.
5. **Seasonality Cache** - demand_seasonality table caches computed patterns, recomputed monthly.

## Deliverables

- [ ] `demand_history` table migration
- [ ] `demand_aggregates` table migration
- [ ] `demand_seasonality` table migration
- [ ] RLS policies for all demand tables
- [ ] Demand history service (`lib/services/demand-history-service.ts`)
- [ ] Zod schemas (`lib/validation/demand-history.ts`)
- [ ] API routes:
  - [ ] `GET /api/planning/demand`
  - [ ] `GET /api/planning/demand/summary`
  - [ ] `GET /api/planning/demand/trend`
  - [ ] `GET /api/planning/demand/products/:productId`
  - [ ] `GET /api/planning/demand/products/:productId/seasonality`
  - [ ] `POST /api/planning/demand/manual`
  - [ ] `POST /api/planning/demand/manual/bulk`
  - [ ] `POST /api/planning/demand/export`
  - [ ] `POST /api/planning/demand/record/consumption` (internal)
  - [ ] `POST /api/planning/demand/record/production` (internal)
  - [ ] `POST /api/planning/demand/record/sale` (internal)
- [ ] UI Components:
  - [ ] DemandDashboard page
  - [ ] ProductDemandDetail page
  - [ ] DemandKPICards
  - [ ] DemandTrendChart
  - [ ] DemandDataTable
  - [ ] DemandManualEntryModal
  - [ ] ProductSeasonalityPanel
- [ ] Scheduled jobs:
  - [ ] Daily aggregation job
  - [ ] Weekly aggregation job (Sunday)
  - [ ] Monthly aggregation job (1st of month)
  - [ ] Seasonality recomputation (monthly)
- [ ] Unit tests (>85% coverage)
- [ ] Integration tests
- [ ] E2E tests

## Definition of Done

- [ ] Demand history records created automatically when WO completes
- [ ] Production output recorded when WO produces finished goods
- [ ] Manual entry allows historical data import
- [ ] Dashboard displays KPIs, trend chart, and data table
- [ ] Period selector switches between daily/weekly/monthly views
- [ ] Product detail page shows demand metrics and seasonality
- [ ] Seasonality detection works with 12+ months of data
- [ ] Weekly/monthly aggregation jobs run on schedule
- [ ] Export generates valid Excel/CSV files
- [ ] RLS enforces org isolation on all queries
- [ ] Role-based access controls manual entry permissions
- [ ] Performance: Dashboard loads in <1s (P95)
- [ ] Performance: Export 10K rows in <5s
- [ ] Unit test coverage >= 85%
- [ ] Integration tests pass
- [ ] E2E smoke tests pass

## Future Enhancements (Not in This Story)

### Story 03.19: Demand Forecasting
- Moving average, weighted moving average algorithms
- Forecast confidence intervals
- Forecast vs actual comparison

### Story 03.20: Safety Stock Management
- Safety stock calculations
- Product-level safety stock overrides
- Dashboard for below-safety-stock products

### Story 03.21: Reorder Point Alerts
- Automated reorder point calculations
- Email/in-app notifications
- Integration with PO suggestions

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2026-01-14 | Initial story creation | ARCHITECT-AGENT |
