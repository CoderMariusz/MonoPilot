# 03.5a - PO Approval Setup (Settings + Roles)

| Field | Value |
|-------|-------|
| **Story ID** | 03.5a |
| **Epic** | 03 - Planning |
| **Status** | Ready |
| **Phase** | Phase 1 (P1) |
| **Complexity** | S (Small) |
| **Estimate** | 1-2 days |
| **Type** | Full-stack |

---

## PRD References

| FR ID | Requirement | Priority | Covered |
|-------|-------------|----------|---------|
| FR-PLAN-009 | PO Approval Workflow | Should Have | PARTIAL (Setup Only) |

**Primary PRD:** `docs/1-BASELINE/product/modules/planning.md` (Section 5 - FR-PLAN-009)
**Architecture:** `docs/1-BASELINE/architecture/modules/planning.md` (planning_settings table)
**UX Wireframes:** PLA-004 (Planning Settings Page)

---

## MVP Scope

This story implements the **settings configuration** for the PO approval workflow. The actual approval workflow logic (pending approval status, approve/reject actions, notifications) is deferred to Story 03.5b.

**MVP Includes**:
- Settings UI for PO approval configuration
- Three settings fields in `planning_settings` table
- Settings service methods to read/update approval settings
- Validation schemas for approval configuration
- Role dropdown populated from Epic 01.10 (Roles CRUD)
- Settings defaults (disabled by default)
- Unit tests for settings service

**Deferred to Story 03.5b**:
- PO status transitions (draft -> pending_approval -> approved)
- Approve/Reject buttons on PO detail page
- Approval history tracking
- Email notifications to approvers
- Role-based permission checks for approval actions

---

## Goal

Enable administrators to configure whether purchase orders require approval before confirmation, set optional threshold amounts, and designate which roles can approve POs.

## User Story

As an **Administrator**, I want to **configure PO approval settings including whether approval is required, the threshold amount, and which roles can approve** so that **I can enforce purchasing controls and ensure proper oversight of procurement spending**.

---

## Scope

**In scope (this story)**
- Planning Settings page UI (`/settings/planning`)
- Three settings fields:
  - `po_require_approval` (boolean toggle)
  - `po_approval_threshold` (decimal currency field)
  - `po_approval_roles` (multi-select role dropdown)
- Settings persistence in `planning_settings` table
- Settings service for CRUD operations
- Zod validation schemas for approval settings
- Default values (approval disabled, threshold null, roles ['admin', 'manager'])
- Unit tests for settings validation and service

**Out of scope (this story)**
- Approval workflow logic (Story 03.5b)
- PO status "pending_approval" (Story 03.5b)
- Approve/Reject actions (Story 03.5b)
- Approval history audit trail (Story 03.5b)
- Notifications to approvers (Story 03.5b)

---

## Dependencies

| Dependency | Story/Epic | Type | Reason |
|------------|------------|------|--------|
| 01.1 | Org Context + Base RLS | HARD | Requires org_id context and RLS patterns |
| 01.10 | Roles CRUD | HARD | Role dropdown must pull from roles table |
| 03.3 | PO CRUD + Lines | HARD | Settings apply to PO entity |
| 03.16 | Planning Settings CRUD | HARD | Settings page foundation |

**Dependents:**
- 03.5b (PO Approval Workflow) - Reads these settings to enforce approval logic

---

## Acceptance Criteria (Given/When/Then)

### AC-1: Planning Settings Page Navigation

**Given** admin navigates to `/settings/planning`
**When** page loads
**Then** settings page displays within 300ms
**And** page shows section "Purchase Order Approval"

### AC-2: Default Approval Settings (Fresh Org)

**Given** organization has no planning_settings record
**When** planning settings page loads for first time
**Then** system creates default settings:
- `po_require_approval = false`
- `po_approval_threshold = null`
- `po_approval_roles = ['admin', 'manager']`

**And** UI displays:
- Toggle "Require Approval" = OFF
- Threshold field = empty (disabled/grayed out)
- Role multi-select = "Admin, Manager" (pre-selected)

### AC-3: Enable PO Approval Toggle

**Given** admin is on planning settings page
**And** "Require Approval" toggle is OFF
**When** admin clicks toggle to enable
**Then** toggle switches to ON
**And** threshold field becomes enabled (editable)
**And** role multi-select remains enabled

**When** admin clicks "Save Settings"
**Then** settings saved with `po_require_approval = true`
**And** success toast: "Planning settings updated successfully"

### AC-4: Disable PO Approval Toggle

**Given** admin has approval enabled (`po_require_approval = true`)
**When** admin clicks toggle to disable
**Then** toggle switches to OFF
**And** threshold field becomes disabled (grayed out)
**And** role multi-select remains enabled

**When** admin saves
**Then** settings saved with `po_require_approval = false`
**And** threshold value preserved (but not enforced)

### AC-5: Set Approval Threshold Amount

**Given** admin has approval enabled
**When** admin enters threshold "10000.00"
**Then** threshold field accepts valid decimal
**And** currency symbol displays based on org default (e.g., "PLN 10,000.00")

**When** admin saves
**Then** settings saved with `po_approval_threshold = 10000.00`
**And** success toast displayed

### AC-6: Threshold Validation (Positive Number)

**Given** admin enters threshold "-500"
**When** save attempted
**Then** validation error: "Threshold must be a positive number"
**And** save blocked

**Given** admin enters threshold "0"
**When** save attempted
**Then** validation error: "Threshold must be greater than zero"
**And** save blocked

### AC-7: Threshold Validation (Max Precision)

**Given** admin enters threshold "12345.6789" (5 decimal places)
**When** save attempted
**Then** validation error: "Threshold can have at most 4 decimal places"
**And** save blocked

**Given** admin enters threshold "12345.67" (2 decimal places)
**When** save attempted
**Then** validation passes
**And** settings saved successfully

### AC-8: Threshold Optional (Null Allowed)

**Given** admin has approval enabled
**And** threshold field is empty
**When** admin saves
**Then** settings saved with `po_approval_threshold = null`
**And** approval applies to ALL POs regardless of amount

### AC-9: Role Multi-Select Dropdown

**Given** organization has roles: Admin, Manager, Planner, Viewer
**When** admin opens role multi-select dropdown
**Then** dropdown displays all 4 roles as checkboxes

**Given** dropdown is open
**When** admin selects "Admin" and "Manager"
**Then** both roles appear as chips/tags in the field
**And** checkboxes show selected state

**When** admin saves
**Then** settings saved with `po_approval_roles = ['admin', 'manager']`

### AC-10: Role Validation (At Least One Required)

**Given** admin has all roles deselected
**When** save attempted
**Then** validation error: "At least one approval role must be selected"
**And** save blocked

**Given** admin selects at least one role
**When** save attempted
**Then** validation passes

### AC-11: Settings Persistence Across Sessions

**Given** admin saves settings:
- `po_require_approval = true`
- `po_approval_threshold = 5000.00`
- `po_approval_roles = ['admin', 'finance_manager']`
**When** admin logs out and logs back in
**And** navigates to `/settings/planning`
**Then** all settings display with saved values:
- Toggle ON
- Threshold "5,000.00"
- Roles "Admin, Finance Manager" selected

### AC-12: Settings Update Timestamp

**Given** admin updates any approval setting
**When** save clicked
**Then** `updated_at` timestamp refreshed to now()
**And** audit log records change (if audit enabled)

### AC-13: RLS Policy Enforcement

**Given** user logged in as Org A
**When** user views planning settings
**Then** only Org A's `planning_settings` record loads
**And** user cannot see/edit Org B's settings via API

### AC-14: Permission Check (Admin Only)

**Given** user with role "Planner" (non-admin)
**When** user navigates to `/settings/planning`
**Then** access denied with message: "You do not have permission to access settings"

**Given** user with role "Admin"
**When** user navigates to `/settings/planning`
**Then** settings page loads successfully

### AC-15: Help Text and Tooltips

**Given** admin hovers over "Require Approval" toggle
**When** hover occurs
**Then** tooltip displays: "When enabled, POs must be approved before confirmation"

**Given** admin hovers over "Approval Threshold" field
**When** hover occurs
**Then** tooltip displays: "If set, only POs above this amount require approval. Leave empty to require approval for all POs."

**Given** admin hovers over "Approval Roles" field
**When** hover occurs
**Then** tooltip displays: "Users with these roles can approve purchase orders"

### AC-X: Future Features (Phase 1+ - Story 03.5b)

Features deferred to Story 03.5b:
- **Approval Workflow Logic** - PO status transitions, approve/reject actions
- **Approval History** - Track who approved/rejected and when
- **Email Notifications** - Notify approvers when PO pending
- **Approval Dashboard** - Show all pending approvals in one view

**Implementation**: Settings configured here will be consumed by 03.5b workflow logic.

---

## Implementation Notes

### API Endpoints

```typescript
// Get planning settings for current org
GET /api/settings/planning
Response: {
  success: true,
  data: {
    id: string,
    org_id: string,
    po_require_approval: boolean,
    po_approval_threshold: number | null,
    po_approval_roles: string[],
    // ... other planning settings
    updated_at: string
  }
}

// Update planning settings
PUT /api/settings/planning
Body: {
  po_require_approval?: boolean,
  po_approval_threshold?: number | null,
  po_approval_roles?: string[]
}
Response: {
  success: true,
  data: PlanningSettings,
  message: "Planning settings updated successfully"
}
```

### Database Schema

```sql
-- planning_settings table (already exists per architecture)
CREATE TABLE planning_settings (
  id                      UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id                  UUID NOT NULL REFERENCES organizations(id) UNIQUE,

  -- PO Approval Settings
  po_require_approval     BOOLEAN DEFAULT false,
  po_approval_threshold   DECIMAL(15,4),
  po_approval_roles       TEXT[] DEFAULT ARRAY['admin', 'manager'],

  -- Other PO/TO/WO settings...
  po_auto_number_prefix   TEXT DEFAULT 'PO-',
  -- ... additional fields per architecture doc

  created_at              TIMESTAMPTZ DEFAULT now(),
  updated_at              TIMESTAMPTZ DEFAULT now()
);

-- RLS Policies
ALTER TABLE planning_settings ENABLE ROW LEVEL SECURITY;

CREATE POLICY planning_settings_org_isolation ON planning_settings
  FOR ALL
  USING (org_id = current_setting('app.current_org_id')::uuid);

-- Index
CREATE INDEX idx_planning_settings_org ON planning_settings(org_id);
```

### Frontend Components

```
app/(authenticated)/settings/planning/
  page.tsx                          -- Planning Settings Page

components/settings/
  PlanningSettingsForm.tsx          -- Main form container
  POApprovalSettings.tsx            -- PO Approval section
  TOSettingsSection.tsx             -- Transfer Order settings
  WOSettingsSection.tsx             -- Work Order settings
```

### Services

```typescript
// lib/services/planning-settings-service.ts

export async function getPlanningSettings(
  orgId: string
): Promise<PlanningSettings> {
  // Fetch or create default settings for org
}

export async function updatePlanningSettings(
  orgId: string,
  updates: Partial<PlanningSettings>
): Promise<PlanningSettings> {
  // Validate and update settings
  // Return updated record
}

export async function getDefaultPlanningSettings(): PlanningSettings {
  // Return default values for new orgs
  return {
    po_require_approval: false,
    po_approval_threshold: null,
    po_approval_roles: ['admin', 'manager'],
    // ... other defaults
  };
}
```

### Validation (Zod)

```typescript
// lib/validation/planning-settings-schema.ts

import { z } from 'zod';

export const poApprovalSettingsSchema = z.object({
  po_require_approval: z.boolean(),
  po_approval_threshold: z
    .number()
    .positive('Threshold must be a positive number')
    .gt(0, 'Threshold must be greater than zero')
    .multipleOf(0.0001, 'Threshold can have at most 4 decimal places')
    .nullable()
    .optional(),
  po_approval_roles: z
    .array(z.string())
    .min(1, 'At least one approval role must be selected')
    .refine(
      (roles) => roles.every((r) => r.length > 0),
      'Roles cannot be empty strings'
    ),
});

export const planningSettingsUpdateSchema = z.object({
  // PO Approval
  po_require_approval: z.boolean().optional(),
  po_approval_threshold: z
    .number()
    .positive()
    .multipleOf(0.0001)
    .nullable()
    .optional(),
  po_approval_roles: z.array(z.string()).min(1).optional(),

  // Other settings fields...
});

export type POApprovalSettings = z.infer<typeof poApprovalSettingsSchema>;
export type PlanningSettingsUpdate = z.infer<typeof planningSettingsUpdateSchema>;
```

### Key Business Rules

1. **Default Settings on First Access**: If org has no `planning_settings` record, auto-create with defaults on first GET request
2. **Threshold Enforcement**: Threshold only enforced when `po_require_approval = true` (checked in Story 03.5b)
3. **Null Threshold = All POs**: If threshold is null/empty, approval required for ALL POs (no amount exemption)
4. **Role Array Storage**: Store roles as TEXT[] (PostgreSQL array), not JSONB, for easier querying
5. **Role Validation**: Roles must exist in organization's role list (FK check or soft validation)
6. **Settings Singleton**: One `planning_settings` record per org (enforced by UNIQUE constraint on org_id)
7. **Admin-Only Access**: Only users with admin role can view/edit planning settings
8. **Audit Trail**: Update `updated_at` timestamp on every save for change tracking

---

## Deliverables

### API Routes
- `GET /api/settings/planning` - Fetch planning settings
- `PUT /api/settings/planning` - Update planning settings

### Components
- `POApprovalSettings.tsx` - Approval settings section UI
- `PlanningSettingsForm.tsx` - Main settings form container

### Services
- `planning-settings-service.ts` - CRUD operations for settings

### Validation
- `planning-settings-schema.ts` - Zod schemas for validation

### Tests
- `planning-settings-service.test.ts` - Unit tests for service methods
- `planning-settings-api.test.ts` - API route tests
- `po-approval-settings.test.tsx` - Component tests

---

## Definition of Done

- [ ] Planning settings table confirmed in database (already exists per architecture)
- [ ] RLS policies applied to `planning_settings` table
- [ ] API endpoints implemented and tested (GET, PUT)
- [ ] Settings service methods implemented with validation
- [ ] Zod schemas defined and validated
- [ ] UI components built with role dropdown integration
- [ ] Unit tests passing (>80% coverage for service layer)
- [ ] API tests passing for all CRUD operations
- [ ] Component tests passing for settings UI
- [ ] Default settings auto-created on first access
- [ ] Settings persist correctly across sessions
- [ ] RLS isolation verified (org A cannot see org B settings)
- [ ] Admin permission check enforced
- [ ] Help text and tooltips implemented
- [ ] E2E smoke test: Admin can enable/disable approval and save settings
- [ ] Performance: Settings load in <300ms
- [ ] Performance: Settings save in <500ms
- [ ] Code review completed
- [ ] Documentation updated (API docs, settings guide)

---

## Future Phases (Not in This Story)

### Phase 1 - Story 03.5b (Approval Workflow)
- **PO Status "pending_approval"** - New status when PO submitted for approval
- **Approve/Reject Actions** - Buttons on PO detail page for approvers
- **Approval History Table** - Track approval/rejection events
- **Email Notifications** - Notify approvers when PO pending
- **Role-Based Access** - Only users with approval roles see approve/reject buttons
- **Approval Dashboard** - View all pending approvals in one place

### Phase 2
- **Multi-Level Approval** - Chain approvals (e.g., manager then director)
- **Conditional Approval Rules** - Different thresholds by product category, supplier, etc.
- **Approval Templates** - Pre-configured approval flows by PO type
- **Delegation** - Approvers can delegate to others when OOO

**Implementation**: See Epic 03.0 "Future Feature Handling" section.

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-12-16 | Initial story - PO Approval Setup | ARCHITECT-AGENT |
