# 03.22 - MRP Dashboard

**Story ID:** 03.22
**Epic:** 03 - Planning
**Phase:** Phase 2
**Complexity:** M (Medium)
**Estimate:** 3-4 days
**Type:** Backend + Frontend
**State:** ready
**Priority:** P2

**Primary PRD:** `docs/1-BASELINE/product/modules/planning.md` (FR-PLAN-037)
**UX Wireframes:** PLAN-MRP-001 (MRP Dashboard)

## PRD References

| FR ID | Requirement | Priority | Phase | Covered |
|-------|-------------|----------|-------|---------|
| FR-PLAN-037 | MRP Dashboard | Should Have | 2 | Yes |

## User Story

**As a** Planner,
**I want** a visual dashboard showing MRP calculation results, suggested orders, exceptions, and material coverage,
**So that** I can quickly review MRP output, approve or reject suggestions, investigate shortages, and understand why specific orders were recommended.

**As a** Production Manager,
**I want** to see material shortage alerts and action pegging details,
**So that** I can proactively resolve supply issues before they impact production schedules.

## Goal

Provide a comprehensive MRP Dashboard that visualizes material requirements planning results. Users can review MRP run history, approve/reject/modify suggested POs and WOs, investigate exception messages (shortages, late orders), and understand action pegging (why each order was suggested). The dashboard serves as the primary interface for MRP-driven decision making.

## Scope

**In scope:**
- MRP Run History panel (list of runs with status, timestamp, metrics)
- MRP Run detail view (run parameters, summary stats)
- Suggested Orders review table (PO and WO suggestions)
- Bulk approve/reject/modify suggested orders
- Convert approved suggestions to draft orders
- Exception Messages panel (shortages, late orders, excesses)
- Action Pegging view (why was this order suggested?)
- Material Coverage Analysis (days of stock by product)
- Material Shortage Alerts widget
- Filter by product, category, supplier, date range
- API endpoints for dashboard data
- Zod validation schemas
- Caching strategy (Redis, 5-minute TTL)
- Unit and E2E tests

**Out of scope:**
- MRP calculation engine (Story 03.21 - dependency)
- Master Production Schedule management (Story 03.20)
- Auto-replenishment rules (Story 03.23)
- Gantt chart integration (Story 03.14)
- Real-time WebSocket updates (Phase 3)
- Export to Excel (Phase 3)
- What-if scenario modeling (Phase 3)

## Dependencies

| Story | Requirement | Status |
|-------|-------------|--------|
| 03.21 | MRP Calculation Engine | Required - provides mrp_runs, mrp_suggestions, mrp_exceptions tables |
| 03.20 | Master Production Schedule | Required - MPS entries drive MRP |
| 03.3 | Purchase Orders CRUD | Required - convert suggestions to POs |
| 03.10 | Work Orders CRUD | Required - convert suggestions to WOs |
| 02.4 | BOMs | Required - BOM explosion data |
| 01.1 | Org Context + RLS | Required - multi-tenancy |

## Acceptance Criteria (Given/When/Then)

### MRP Run History (FR-PLAN-037)

#### AC-1: View MRP Run History
- GIVEN user navigates to `/planning/mrp`, WHEN page loads, THEN MRP Run History panel displays.
- GIVEN MRP runs exist, WHEN panel renders, THEN list shows: run ID, timestamp, status, total suggestions, total exceptions.
- GIVEN run list displayed, WHEN sorted, THEN runs ordered by created_at descending (newest first).
- GIVEN run with status "completed", WHEN displayed, THEN green badge shows "Completed".
- GIVEN run with status "running", WHEN displayed, THEN blue badge shows "Running" with spinner.
- GIVEN run with status "failed", WHEN displayed, THEN red badge shows "Failed" with error icon.

#### AC-2: View MRP Run Details
- GIVEN user clicks on MRP run row, WHEN modal opens, THEN run details display.
- GIVEN run details modal, WHEN rendered, THEN shows: run parameters, planning horizon, products included, run duration.
- GIVEN run details modal, WHEN rendered, THEN shows summary: total PO suggestions, total WO suggestions, total exceptions, coverage analysis.
- GIVEN run failed, WHEN details viewed, THEN error message and stack trace display.

#### AC-3: Trigger New MRP Run
- GIVEN user clicks "Run MRP" button, WHEN clicked, THEN MRP configuration modal opens.
- GIVEN MRP config modal, WHEN rendered, THEN shows: planning horizon (days), product filter, include safety stock toggle.
- GIVEN valid config entered, WHEN "Start Run" clicked, THEN new MRP run created with status "queued".
- GIVEN MRP run queued, WHEN run starts, THEN status changes to "running" and progress updates.
- GIVEN MRP run completes, WHEN finished, THEN status changes to "completed" and results available.

### Suggested Orders Review (FR-PLAN-037)

#### AC-4: View Suggested Purchase Orders
- GIVEN user clicks "Suggested POs" tab, WHEN tab loads, THEN suggested PO table displays.
- GIVEN suggested POs exist, WHEN table renders, THEN columns show: product, supplier, quantity, required date, order date, status, pegging.
- GIVEN suggested PO row, WHEN "Pegging" icon clicked, THEN action pegging modal opens showing demand sources.
- GIVEN suggested PO with status "pending", WHEN displayed, THEN row is selectable for bulk actions.
- GIVEN no suggested POs, WHEN tab loads, THEN empty state "No PO suggestions from last MRP run" displays.

#### AC-5: View Suggested Work Orders
- GIVEN user clicks "Suggested WOs" tab, WHEN tab loads, THEN suggested WO table displays.
- GIVEN suggested WOs exist, WHEN table renders, THEN columns show: product, quantity, required date, start date, status, pegging.
- GIVEN suggested WO row, WHEN "Pegging" icon clicked, THEN action pegging modal opens showing demand sources.
- GIVEN suggested WO with status "pending", WHEN displayed, THEN row is selectable for bulk actions.

#### AC-6: Approve Single Suggestion
- GIVEN user views suggested PO/WO, WHEN "Approve" button clicked, THEN confirmation dialog appears.
- GIVEN confirmation dialog, WHEN confirmed, THEN suggestion status changes to "approved".
- GIVEN approved suggestion, WHEN API called, THEN draft PO/WO created from suggestion data.
- GIVEN draft order created, WHEN success, THEN toast "Order PO-XXXX created from suggestion" displays.
- GIVEN approved suggestion, WHEN displayed, THEN row shows "Approved" badge and link to created order.

#### AC-7: Reject Single Suggestion
- GIVEN user views suggested PO/WO, WHEN "Reject" button clicked, THEN rejection dialog appears.
- GIVEN rejection dialog, WHEN rendered, THEN requires rejection reason (dropdown + optional notes).
- GIVEN reason selected, WHEN confirmed, THEN suggestion status changes to "rejected".
- GIVEN rejected suggestion, WHEN displayed, THEN row shows "Rejected" badge with reason tooltip.
- GIVEN rejected suggestion, WHEN MRP runs again, THEN same suggestion may reappear if demand still exists.

#### AC-8: Modify Suggestion Before Approval
- GIVEN user views suggested PO/WO, WHEN "Modify" button clicked, THEN edit modal opens.
- GIVEN edit modal, WHEN rendered, THEN pre-fills: quantity, required date, order date, supplier (for PO).
- GIVEN modified values entered, WHEN "Save & Approve" clicked, THEN modified suggestion approved.
- GIVEN modified suggestion approved, WHEN order created, THEN uses modified values (not original).
- GIVEN quantity changed, WHEN saved, THEN original suggestion shows "Modified" indicator.

#### AC-9: Bulk Actions on Suggestions
- GIVEN multiple suggestions selected, WHEN "Bulk Approve" clicked, THEN all selected suggestions approved.
- GIVEN bulk approval, WHEN confirmed, THEN progress indicator shows "Approving 5/10...".
- GIVEN bulk approval complete, WHEN finished, THEN toast "10 suggestions approved, 10 orders created" displays.
- GIVEN multiple suggestions selected, WHEN "Bulk Reject" clicked, THEN single rejection reason applies to all.
- GIVEN bulk rejection, WHEN reason entered, THEN all selected suggestions marked rejected.

### Exception Messages (FR-PLAN-037)

#### AC-10: View Exception Messages
- GIVEN user clicks "Exceptions" tab, WHEN tab loads, THEN exception messages table displays.
- GIVEN exceptions exist, WHEN table renders, THEN columns show: severity, type, product, message, affected orders, date.
- GIVEN exception types, WHEN displayed, THEN includes: shortage, late_delivery, excess_inventory, capacity_overload.
- GIVEN exception with severity "critical", WHEN displayed, THEN row highlighted red with warning icon.
- GIVEN exception with severity "warning", WHEN displayed, THEN row highlighted yellow.
- GIVEN no exceptions, WHEN tab loads, THEN success state "No exceptions - MRP plan is feasible" displays.

#### AC-11: Exception Types
- GIVEN exception type "shortage", WHEN displayed, THEN shows: product, shortfall quantity, date needed, affected WOs.
- GIVEN exception type "late_delivery", WHEN displayed, THEN shows: PO number, expected date, required date, days late.
- GIVEN exception type "excess_inventory", WHEN displayed, THEN shows: product, excess quantity, recommended action.
- GIVEN exception type "capacity_overload", WHEN displayed, THEN shows: line/machine, date, overload hours, affected WOs.

#### AC-12: Resolve Exception
- GIVEN user clicks "Resolve" on exception, WHEN clicked, THEN resolution modal opens.
- GIVEN resolution modal, WHEN rendered, THEN shows recommended actions based on exception type.
- GIVEN shortage exception, WHEN resolving, THEN options: expedite PO, create emergency PO, substitute material, delay WO.
- GIVEN action selected, WHEN confirmed, THEN system executes action and updates exception status.
- GIVEN exception resolved, WHEN displayed, THEN shows "Resolved" badge with resolution details.

### Action Pegging (FR-PLAN-037)

#### AC-13: View Action Pegging
- GIVEN user clicks pegging icon on suggestion, WHEN modal opens, THEN action pegging tree displays.
- GIVEN pegging tree, WHEN rendered, THEN shows: demand source (WO, forecast, safety stock) -> requirement -> suggestion.
- GIVEN PO suggestion, WHEN pegging viewed, THEN shows which WOs require this material and when.
- GIVEN WO suggestion, WHEN pegging viewed, THEN shows which demand source (MPS, forecast, customer order) drives it.
- GIVEN pegging tree node, WHEN clicked, THEN navigates to source entity (WO, MPS entry, forecast).

#### AC-14: Drill-Down from Pegging
- GIVEN pegging shows WO-001 requires material, WHEN WO-001 clicked, THEN WO detail page opens in new tab.
- GIVEN pegging shows MPS entry drives demand, WHEN MPS clicked, THEN MPS detail view opens.
- GIVEN pegging shows multiple demand sources, WHEN displayed, THEN all sources listed with percentages.

### Material Coverage Analysis (FR-PLAN-037)

#### AC-15: View Coverage Analysis
- GIVEN user clicks "Coverage" tab, WHEN tab loads, THEN coverage analysis displays.
- GIVEN coverage analysis, WHEN rendered, THEN shows: product, current stock, avg daily usage, days of stock, status.
- GIVEN coverage status, WHEN days_of_stock < safety_days, THEN "Critical" (red) badge displays.
- GIVEN coverage status, WHEN safety_days <= days_of_stock < reorder_days, THEN "Low" (yellow) badge displays.
- GIVEN coverage status, WHEN days_of_stock >= reorder_days, THEN "OK" (green) badge displays.
- GIVEN coverage analysis, WHEN sorted, THEN default sort by days_of_stock ascending (most critical first).

#### AC-16: Coverage Timeline View
- GIVEN user clicks "Timeline" toggle, WHEN activated, THEN coverage timeline chart displays.
- GIVEN timeline chart, WHEN rendered, THEN X-axis shows dates (planning horizon), Y-axis shows inventory level.
- GIVEN timeline chart, WHEN rendered, THEN shows: projected inventory line, safety stock line, reorder point line.
- GIVEN timeline shows inventory dipping below safety stock, WHEN displayed, THEN shortage period highlighted red.
- GIVEN timeline hover on date, WHEN hovered, THEN tooltip shows: date, projected qty, gross requirements, scheduled receipts.

### Material Shortage Alerts (FR-PLAN-037)

#### AC-17: Shortage Alerts Widget
- GIVEN MRP dashboard loads, WHEN rendered, THEN shortage alerts widget displays prominently.
- GIVEN shortages exist, WHEN widget renders, THEN shows count badge "5 shortages" with critical/warning breakdown.
- GIVEN shortage alert, WHEN displayed, THEN shows: product name, shortfall qty, date needed, affected WOs count.
- GIVEN shortage alert clicked, WHEN clicked, THEN navigates to Exceptions tab filtered to that shortage.
- GIVEN no shortages, WHEN widget renders, THEN green checkmark with "No material shortages" displays.

#### AC-18: Shortage Alert Notifications
- GIVEN new shortage detected during MRP run, WHEN run completes, THEN notification sent to planners.
- GIVEN shortage notification, WHEN received, THEN shows: product, quantity short, date, link to MRP dashboard.
- GIVEN user configures shortage threshold, WHEN shortage below threshold, THEN no notification sent (minor).

### Dashboard Filters & Search

#### AC-19: Filter Suggestions
- GIVEN suggested orders table, WHEN "Filter" clicked, THEN filter panel opens.
- GIVEN filter panel, WHEN rendered, THEN includes: product search, supplier dropdown, category, date range, status.
- GIVEN product filter applied, WHEN search entered, THEN table shows only matching product suggestions.
- GIVEN date range filter applied, WHEN dates selected, THEN shows suggestions with required_date in range.
- GIVEN status filter applied, WHEN "pending" selected, THEN shows only pending suggestions.
- GIVEN filters applied, WHEN "Clear Filters" clicked, THEN all filters reset and full list displays.

#### AC-20: Search Across Dashboard
- GIVEN global search box, WHEN product code entered, THEN all tabs filter to that product.
- GIVEN global search, WHEN supplier name entered, THEN PO suggestions filter to that supplier.
- GIVEN search active, WHEN badge displays, THEN shows "Filtered: [search term]" indicator.

### Performance & Caching

#### AC-21: Dashboard Performance
- GIVEN MRP dashboard loads, WHEN page renders, THEN loads in < 3 seconds.
- GIVEN 1000+ suggestions, WHEN table renders, THEN pagination enabled (50 per page default).
- GIVEN coverage calculation, WHEN running, THEN uses optimized queries with proper indexes.
- GIVEN exception count, WHEN displayed, THEN uses COUNT query, not full result fetch.

#### AC-22: Dashboard Caching
- GIVEN dashboard data requested, WHEN API called, THEN response cached in Redis.
- GIVEN cache TTL, WHEN set, THEN 5-minute TTL for dashboard aggregates.
- GIVEN MRP run completes, WHEN finished, THEN dashboard cache invalidated.
- GIVEN suggestion status changes, WHEN updated, THEN relevant cache keys invalidated.
- GIVEN cache keys, WHEN namespaced, THEN pattern: `mrp:dashboard:{org_id}:{widget}`.

### Multi-tenancy & Security

#### AC-23: RLS Enforcement
- GIVEN User A from Org A, WHEN viewing MRP dashboard, THEN only Org A data displays.
- GIVEN User A from Org A, WHEN attempting to view Org B MRP run, THEN 404 Not Found returns.
- GIVEN MRP suggestion, WHEN approving, THEN created order inherits user's org_id.
- GIVEN org_id in session, WHEN queries executed, THEN all queries filter by org_id.

## Technical Specification

### Database Schema

#### mrp_runs table (from Story 03.21)

```sql
-- Reference: Already created in Story 03.21
CREATE TABLE mrp_runs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  status VARCHAR(50) NOT NULL DEFAULT 'queued', -- queued, running, completed, failed
  planning_horizon_days INTEGER NOT NULL DEFAULT 30,
  include_safety_stock BOOLEAN DEFAULT true,
  product_filter JSONB, -- Optional: filter to specific products/categories
  started_at TIMESTAMPTZ,
  completed_at TIMESTAMPTZ,
  error_message TEXT,
  summary_stats JSONB, -- {po_suggestions: 10, wo_suggestions: 5, exceptions: 3}
  created_at TIMESTAMPTZ DEFAULT NOW(),
  created_by UUID REFERENCES users(id)
);

-- Indexes for dashboard
CREATE INDEX idx_mrp_runs_org_id ON mrp_runs(org_id);
CREATE INDEX idx_mrp_runs_created_at ON mrp_runs(org_id, created_at DESC);
CREATE INDEX idx_mrp_runs_status ON mrp_runs(org_id, status);
```

#### mrp_suggestions table (from Story 03.21)

```sql
-- Reference: Already created in Story 03.21
CREATE TABLE mrp_suggestions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  mrp_run_id UUID NOT NULL REFERENCES mrp_runs(id) ON DELETE CASCADE,
  suggestion_type VARCHAR(20) NOT NULL, -- 'purchase_order', 'work_order'
  product_id UUID NOT NULL REFERENCES products(id),
  supplier_id UUID REFERENCES suppliers(id), -- For PO suggestions
  quantity DECIMAL(15,4) NOT NULL,
  uom VARCHAR(20) NOT NULL,
  required_date DATE NOT NULL,
  order_date DATE NOT NULL, -- Suggested order/start date
  status VARCHAR(20) NOT NULL DEFAULT 'pending', -- pending, approved, rejected, modified
  rejection_reason VARCHAR(100),
  rejection_notes TEXT,
  modified_quantity DECIMAL(15,4),
  modified_date DATE,
  created_order_id UUID, -- FK to created PO/WO after approval
  created_order_type VARCHAR(20), -- 'purchase_order', 'work_order'
  pegging_data JSONB, -- Action pegging: [{demand_type, demand_id, quantity}]
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  updated_by UUID REFERENCES users(id)
);

-- Indexes for dashboard
CREATE INDEX idx_mrp_suggestions_run ON mrp_suggestions(mrp_run_id);
CREATE INDEX idx_mrp_suggestions_org ON mrp_suggestions(org_id);
CREATE INDEX idx_mrp_suggestions_status ON mrp_suggestions(org_id, status);
CREATE INDEX idx_mrp_suggestions_product ON mrp_suggestions(product_id);
CREATE INDEX idx_mrp_suggestions_type ON mrp_suggestions(org_id, suggestion_type);
```

#### mrp_exceptions table (from Story 03.21)

```sql
-- Reference: Already created in Story 03.21
CREATE TABLE mrp_exceptions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  mrp_run_id UUID NOT NULL REFERENCES mrp_runs(id) ON DELETE CASCADE,
  exception_type VARCHAR(50) NOT NULL, -- 'shortage', 'late_delivery', 'excess_inventory', 'capacity_overload'
  severity VARCHAR(20) NOT NULL, -- 'critical', 'warning', 'info'
  product_id UUID REFERENCES products(id),
  message TEXT NOT NULL,
  details JSONB, -- Type-specific details
  affected_orders JSONB, -- [{order_type, order_id}]
  exception_date DATE,
  status VARCHAR(20) NOT NULL DEFAULT 'open', -- open, resolved, ignored
  resolution_action VARCHAR(100),
  resolution_notes TEXT,
  resolved_at TIMESTAMPTZ,
  resolved_by UUID REFERENCES users(id),
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Indexes for dashboard
CREATE INDEX idx_mrp_exceptions_run ON mrp_exceptions(mrp_run_id);
CREATE INDEX idx_mrp_exceptions_org ON mrp_exceptions(org_id);
CREATE INDEX idx_mrp_exceptions_severity ON mrp_exceptions(org_id, severity);
CREATE INDEX idx_mrp_exceptions_status ON mrp_exceptions(org_id, status);
CREATE INDEX idx_mrp_exceptions_type ON mrp_exceptions(org_id, exception_type);
```

### RLS Policies

```sql
-- mrp_runs: Users can see their org's runs
CREATE POLICY "mrp_runs_org_read" ON mrp_runs
FOR SELECT USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

CREATE POLICY "mrp_runs_org_insert" ON mrp_runs
FOR INSERT WITH CHECK (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

-- mrp_suggestions: Users can see their org's suggestions
CREATE POLICY "mrp_suggestions_org_read" ON mrp_suggestions
FOR SELECT USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

CREATE POLICY "mrp_suggestions_org_update" ON mrp_suggestions
FOR UPDATE USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

-- mrp_exceptions: Users can see their org's exceptions
CREATE POLICY "mrp_exceptions_org_read" ON mrp_exceptions
FOR SELECT USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

CREATE POLICY "mrp_exceptions_org_update" ON mrp_exceptions
FOR UPDATE USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));
```

### API Endpoints

```
# MRP Runs
GET    /api/planning/mrp/runs                      - List MRP runs
GET    /api/planning/mrp/runs/:id                  - Get MRP run details
POST   /api/planning/mrp/runs                      - Trigger new MRP run
GET    /api/planning/mrp/runs/:id/status           - Get run status (polling)

# MRP Suggestions
GET    /api/planning/mrp/suggestions               - List suggestions (with filters)
GET    /api/planning/mrp/suggestions/:id           - Get suggestion details
PUT    /api/planning/mrp/suggestions/:id/approve   - Approve suggestion
PUT    /api/planning/mrp/suggestions/:id/reject    - Reject suggestion
PUT    /api/planning/mrp/suggestions/:id/modify    - Modify and approve
POST   /api/planning/mrp/suggestions/bulk-approve  - Bulk approve
POST   /api/planning/mrp/suggestions/bulk-reject   - Bulk reject
GET    /api/planning/mrp/suggestions/:id/pegging   - Get action pegging

# MRP Exceptions
GET    /api/planning/mrp/exceptions                - List exceptions (with filters)
GET    /api/planning/mrp/exceptions/:id            - Get exception details
PUT    /api/planning/mrp/exceptions/:id/resolve    - Resolve exception
PUT    /api/planning/mrp/exceptions/:id/ignore     - Ignore exception

# Dashboard Aggregates
GET    /api/planning/mrp/dashboard/summary         - Dashboard summary stats
GET    /api/planning/mrp/dashboard/coverage        - Material coverage analysis
GET    /api/planning/mrp/dashboard/shortages       - Shortage alerts
GET    /api/planning/mrp/dashboard/timeline        - Coverage timeline data
```

### Service Methods

**Location:** `lib/services/mrp-dashboard-service.ts`

```typescript
interface MrpDashboardService {
  // MRP Runs
  getMrpRuns(orgId: string, options?: ListOptions): Promise<MrpRunsResponse>;
  getMrpRunById(orgId: string, runId: string): Promise<MrpRun>;
  triggerMrpRun(orgId: string, config: MrpRunConfig): Promise<MrpRun>;
  getMrpRunStatus(orgId: string, runId: string): Promise<MrpRunStatus>;

  // Suggestions
  getSuggestions(orgId: string, filters: SuggestionFilters): Promise<SuggestionsResponse>;
  getSuggestionById(orgId: string, suggestionId: string): Promise<MrpSuggestion>;
  approveSuggestion(orgId: string, suggestionId: string, userId: string): Promise<ApprovalResult>;
  rejectSuggestion(orgId: string, suggestionId: string, reason: string, notes?: string): Promise<void>;
  modifySuggestion(orgId: string, suggestionId: string, modifications: SuggestionModification): Promise<ApprovalResult>;
  bulkApproveSuggestions(orgId: string, suggestionIds: string[], userId: string): Promise<BulkApprovalResult>;
  bulkRejectSuggestions(orgId: string, suggestionIds: string[], reason: string): Promise<void>;
  getActionPegging(orgId: string, suggestionId: string): Promise<PeggingTree>;

  // Exceptions
  getExceptions(orgId: string, filters: ExceptionFilters): Promise<ExceptionsResponse>;
  getExceptionById(orgId: string, exceptionId: string): Promise<MrpException>;
  resolveException(orgId: string, exceptionId: string, action: string, notes?: string): Promise<void>;
  ignoreException(orgId: string, exceptionId: string, reason: string): Promise<void>;

  // Dashboard Aggregates
  getDashboardSummary(orgId: string): Promise<DashboardSummary>;
  getMaterialCoverage(orgId: string, productIds?: string[]): Promise<CoverageAnalysis[]>;
  getShortageAlerts(orgId: string): Promise<ShortageAlert[]>;
  getCoverageTimeline(orgId: string, productId: string, days: number): Promise<TimelineData>;

  // Cache
  invalidateDashboardCache(orgId: string): Promise<void>;
}

interface MrpRun {
  id: string;
  org_id: string;
  status: 'queued' | 'running' | 'completed' | 'failed';
  planning_horizon_days: number;
  include_safety_stock: boolean;
  product_filter: object | null;
  started_at: string | null;
  completed_at: string | null;
  error_message: string | null;
  summary_stats: {
    po_suggestions: number;
    wo_suggestions: number;
    exceptions: number;
    critical_exceptions: number;
  };
  created_at: string;
  created_by: string;
}

interface MrpSuggestion {
  id: string;
  org_id: string;
  mrp_run_id: string;
  suggestion_type: 'purchase_order' | 'work_order';
  product_id: string;
  product_name: string;
  supplier_id: string | null;
  supplier_name: string | null;
  quantity: number;
  uom: string;
  required_date: string;
  order_date: string;
  status: 'pending' | 'approved' | 'rejected' | 'modified';
  rejection_reason: string | null;
  created_order_id: string | null;
  pegging_data: PeggingEntry[];
}

interface PeggingEntry {
  demand_type: 'work_order' | 'mps_entry' | 'forecast' | 'safety_stock';
  demand_id: string;
  demand_reference: string;
  quantity: number;
  required_date: string;
}

interface MrpException {
  id: string;
  org_id: string;
  mrp_run_id: string;
  exception_type: 'shortage' | 'late_delivery' | 'excess_inventory' | 'capacity_overload';
  severity: 'critical' | 'warning' | 'info';
  product_id: string | null;
  product_name: string | null;
  message: string;
  details: object;
  affected_orders: AffectedOrder[];
  exception_date: string;
  status: 'open' | 'resolved' | 'ignored';
  resolution_action: string | null;
}

interface CoverageAnalysis {
  product_id: string;
  product_name: string;
  product_code: string;
  current_stock: number;
  avg_daily_usage: number;
  days_of_stock: number;
  safety_stock_days: number;
  reorder_point_days: number;
  status: 'critical' | 'low' | 'ok';
  next_shortage_date: string | null;
}

interface ShortageAlert {
  product_id: string;
  product_name: string;
  shortfall_quantity: number;
  date_needed: string;
  affected_wo_count: number;
  severity: 'critical' | 'warning';
}

interface DashboardSummary {
  last_run: MrpRun | null;
  pending_po_suggestions: number;
  pending_wo_suggestions: number;
  open_exceptions: number;
  critical_exceptions: number;
  shortage_count: number;
  coverage_critical_count: number;
}
```

### Zod Validation Schemas

**Location:** `lib/validation/mrp-dashboard.ts`

```typescript
import { z } from 'zod';

// MRP Run schemas
export const mrpRunConfigSchema = z.object({
  planning_horizon_days: z.number().int().min(7).max(365).default(30),
  include_safety_stock: z.boolean().default(true),
  product_filter: z.object({
    product_ids: z.array(z.string().uuid()).optional(),
    category_ids: z.array(z.string().uuid()).optional(),
  }).optional(),
});

export const mrpRunSchema = z.object({
  id: z.string().uuid(),
  org_id: z.string().uuid(),
  status: z.enum(['queued', 'running', 'completed', 'failed']),
  planning_horizon_days: z.number(),
  include_safety_stock: z.boolean(),
  product_filter: z.record(z.any()).nullable(),
  started_at: z.string().datetime().nullable(),
  completed_at: z.string().datetime().nullable(),
  error_message: z.string().nullable(),
  summary_stats: z.object({
    po_suggestions: z.number(),
    wo_suggestions: z.number(),
    exceptions: z.number(),
    critical_exceptions: z.number(),
  }).nullable(),
  created_at: z.string().datetime(),
  created_by: z.string().uuid(),
});

// Suggestion schemas
export const suggestionFiltersSchema = z.object({
  mrp_run_id: z.string().uuid().optional(),
  suggestion_type: z.enum(['purchase_order', 'work_order']).optional(),
  product_id: z.string().uuid().optional(),
  supplier_id: z.string().uuid().optional(),
  status: z.enum(['pending', 'approved', 'rejected', 'modified']).optional(),
  required_date_from: z.string().date().optional(),
  required_date_to: z.string().date().optional(),
  page: z.number().int().min(1).default(1),
  limit: z.number().int().min(1).max(100).default(50),
});

export const approveSuggestionSchema = z.object({
  suggestion_id: z.string().uuid(),
});

export const rejectSuggestionSchema = z.object({
  suggestion_id: z.string().uuid(),
  reason: z.enum([
    'not_needed',
    'incorrect_quantity',
    'wrong_date',
    'alternative_supplier',
    'budget_constraint',
    'other',
  ]),
  notes: z.string().max(500).optional(),
});

export const modifySuggestionSchema = z.object({
  suggestion_id: z.string().uuid(),
  quantity: z.number().positive().optional(),
  required_date: z.string().date().optional(),
  order_date: z.string().date().optional(),
  supplier_id: z.string().uuid().optional(), // For PO suggestions only
});

export const bulkApproveSchema = z.object({
  suggestion_ids: z.array(z.string().uuid()).min(1).max(100),
});

export const bulkRejectSchema = z.object({
  suggestion_ids: z.array(z.string().uuid()).min(1).max(100),
  reason: z.enum([
    'not_needed',
    'incorrect_quantity',
    'wrong_date',
    'alternative_supplier',
    'budget_constraint',
    'other',
  ]),
  notes: z.string().max(500).optional(),
});

// Exception schemas
export const exceptionFiltersSchema = z.object({
  mrp_run_id: z.string().uuid().optional(),
  exception_type: z.enum(['shortage', 'late_delivery', 'excess_inventory', 'capacity_overload']).optional(),
  severity: z.enum(['critical', 'warning', 'info']).optional(),
  status: z.enum(['open', 'resolved', 'ignored']).optional(),
  product_id: z.string().uuid().optional(),
  page: z.number().int().min(1).default(1),
  limit: z.number().int().min(1).max(100).default(50),
});

export const resolveExceptionSchema = z.object({
  exception_id: z.string().uuid(),
  action: z.enum([
    'expedite_po',
    'create_emergency_po',
    'substitute_material',
    'delay_wo',
    'increase_capacity',
    'manual_resolution',
  ]),
  notes: z.string().max(500).optional(),
});

export const ignoreExceptionSchema = z.object({
  exception_id: z.string().uuid(),
  reason: z.string().min(1).max(500),
});

// Dashboard schemas
export const coverageQuerySchema = z.object({
  product_ids: z.array(z.string().uuid()).optional(),
  status_filter: z.enum(['critical', 'low', 'ok', 'all']).default('all'),
  sort_by: z.enum(['days_of_stock', 'product_name']).default('days_of_stock'),
  sort_order: z.enum(['asc', 'desc']).default('asc'),
});

export const timelineQuerySchema = z.object({
  product_id: z.string().uuid(),
  days: z.number().int().min(7).max(90).default(30),
});

export type MrpRunConfig = z.infer<typeof mrpRunConfigSchema>;
export type SuggestionFilters = z.infer<typeof suggestionFiltersSchema>;
export type ExceptionFilters = z.infer<typeof exceptionFiltersSchema>;
export type CoverageQuery = z.infer<typeof coverageQuerySchema>;
export type TimelineQuery = z.infer<typeof timelineQuerySchema>;
```

## UI Components

### Pages

- `app/(authenticated)/planning/mrp/page.tsx` - MRP Dashboard main page
- `app/(authenticated)/planning/mrp/runs/[id]/page.tsx` - MRP Run detail page

### Components

**Location:** `components/planning/mrp/`

```
MrpDashboard.tsx              - Main dashboard layout with tabs
MrpRunHistory.tsx             - MRP runs list panel
MrpRunCard.tsx                - Single run card with status
MrpRunDetailModal.tsx         - Run details modal
TriggerMrpModal.tsx           - New MRP run configuration modal

SuggestionsTable.tsx          - Suggested orders table
SuggestionRow.tsx             - Single suggestion row
SuggestionFilters.tsx         - Filter panel for suggestions
ApproveSuggestionDialog.tsx   - Approval confirmation dialog
RejectSuggestionDialog.tsx    - Rejection with reason dialog
ModifySuggestionModal.tsx     - Edit suggestion before approval
BulkActionsBar.tsx            - Bulk approve/reject actions
ActionPeggingModal.tsx        - Pegging tree visualization
PeggingTreeNode.tsx           - Single pegging node component

ExceptionsTable.tsx           - Exception messages table
ExceptionRow.tsx              - Single exception row
ExceptionFilters.tsx          - Filter panel for exceptions
ResolveExceptionModal.tsx     - Exception resolution modal
ExceptionDetailModal.tsx      - Exception details view

CoverageAnalysisTable.tsx     - Material coverage table
CoverageRow.tsx               - Single coverage row
CoverageTimeline.tsx          - Timeline chart component
CoverageStatusBadge.tsx       - Coverage status indicator

ShortageAlertsWidget.tsx      - Shortage alerts summary widget
DashboardSummaryCards.tsx     - KPI summary cards
MrpEmptyState.tsx             - Empty/first-run state
```

### Component Details

**MrpDashboard.tsx**
```tsx
interface MrpDashboardProps {
  initialTab?: 'suggestions' | 'exceptions' | 'coverage' | 'runs';
}

// Main layout with:
// - Header with "Run MRP" button
// - Summary cards row
// - Shortage alerts widget
// - Tab navigation (Suggested POs, Suggested WOs, Exceptions, Coverage, Run History)
// - Active tab content
```

**SuggestionsTable.tsx**
```tsx
interface SuggestionsTableProps {
  suggestions: MrpSuggestion[];
  isLoading: boolean;
  filters: SuggestionFilters;
  onFilterChange: (filters: SuggestionFilters) => void;
  onApprove: (id: string) => void;
  onReject: (id: string, reason: string, notes?: string) => void;
  onModify: (id: string, modifications: SuggestionModification) => void;
  onBulkApprove: (ids: string[]) => void;
  onBulkReject: (ids: string[], reason: string) => void;
  onViewPegging: (id: string) => void;
  selectedIds: string[];
  onSelectionChange: (ids: string[]) => void;
}
```

**ActionPeggingModal.tsx**
```tsx
interface ActionPeggingModalProps {
  isOpen: boolean;
  onClose: () => void;
  suggestionId: string;
  peggingData: PeggingEntry[];
  isLoading: boolean;
}

// Displays tree structure:
// - Root: Suggestion (PO/WO for product X)
//   - Branch: Demand source 1 (WO-001, 50 units)
//   - Branch: Demand source 2 (Safety Stock, 20 units)
//   - Branch: Demand source 3 (MPS Entry, 30 units)
```

**CoverageTimeline.tsx**
```tsx
interface CoverageTimelineProps {
  productId: string;
  timelineData: TimelineDataPoint[];
  safetyStockLevel: number;
  reorderPointLevel: number;
}

// Recharts line chart showing:
// - Projected inventory line
// - Safety stock line (dashed, orange)
// - Reorder point line (dashed, yellow)
// - Shortage periods (red shaded area)
```

### UI Patterns

**Dashboard Layout:**
```
+------------------------------------------------------------------+
| MRP Dashboard                                     [Run MRP]       |
+------------------------------------------------------------------+
| [Pending POs: 15] [Pending WOs: 8] [Exceptions: 3] [Shortages: 2] |
+------------------------------------------------------------------+
| +--------------------+                                            |
| | SHORTAGE ALERTS    |    +-------------------------------------+ |
| | 2 critical items   |    | [Suggested POs] [WOs] [Exc] [Cov]   | |
| | - Product A (50kg) |    +-------------------------------------+ |
| | - Product B (100L) |    | [Filters]                [Search]  | |
| +--------------------+    +-------------------------------------+ |
|                           | [ ] Product | Supplier | Qty | Date | |
|                           | [x] Flour   | Mill Co  | 500 | Jan 5| |
|                           | [ ] Sugar   | Sugar In | 200 | Jan 6| |
|                           +-------------------------------------+ |
|                           | Selected: 2  [Bulk Approve] [Reject] | |
+------------------------------------------------------------------+
```

**Pegging Tree:**
```
PO Suggestion: 500 kg Flour (Mill Co.)
   |
   +-- WO-2024-001: Cookie Production (200 kg)
   |      Required: Jan 10, 2024
   |
   +-- WO-2024-002: Bread Production (150 kg)
   |      Required: Jan 12, 2024
   |
   +-- Safety Stock Buffer (100 kg)
   |      Min Level: 100 kg
   |
   +-- Forecast Demand (50 kg)
          Period: Jan 15-20, 2024
```

**Coverage Timeline:**
```
Inventory Level (kg)
    |
500 |-----.                    Reorder Point
    |      \                   -----------
400 |       \    .---.
    |        \  /     \        Safety Stock
300 |    -----\/-------\------ -----------
    |                   \
200 |                    \
    |                     \
100 |                      \--- Shortage Period
    |___________________________(red shaded)_______
        Jan 5    Jan 10    Jan 15    Jan 20
```

## Test Cases

### Unit Tests

**mrp-dashboard-service.test.ts**
```typescript
describe('MrpDashboardService', () => {
  describe('getMrpRuns', () => {
    it('returns runs for org sorted by created_at desc');
    it('returns empty array when no runs exist');
    it('filters by status when specified');
  });

  describe('approveSuggestion', () => {
    it('creates draft PO from PO suggestion');
    it('creates draft WO from WO suggestion');
    it('updates suggestion status to approved');
    it('stores created order reference');
    it('throws error if suggestion already approved');
  });

  describe('rejectSuggestion', () => {
    it('updates status to rejected with reason');
    it('stores rejection notes');
    it('throws error if suggestion already processed');
  });

  describe('bulkApproveSuggestions', () => {
    it('approves multiple suggestions in transaction');
    it('returns count of successful approvals');
    it('skips already processed suggestions');
    it('creates orders for each approved suggestion');
  });

  describe('getMaterialCoverage', () => {
    it('calculates days of stock correctly');
    it('determines status based on thresholds');
    it('handles products with zero usage');
    it('sorts by days_of_stock ascending');
  });

  describe('getActionPegging', () => {
    it('returns pegging tree for suggestion');
    it('includes all demand sources');
    it('calculates quantity allocation correctly');
  });
});
```

**mrp-suggestions-api.test.ts**
```typescript
describe('MRP Suggestions API', () => {
  describe('GET /api/planning/mrp/suggestions', () => {
    it('returns paginated suggestions');
    it('filters by suggestion_type');
    it('filters by status');
    it('filters by date range');
    it('returns 401 for unauthenticated');
  });

  describe('PUT /api/planning/mrp/suggestions/:id/approve', () => {
    it('approves suggestion and creates order');
    it('returns created order details');
    it('returns 404 for non-existent suggestion');
    it('returns 400 if already processed');
  });

  describe('POST /api/planning/mrp/suggestions/bulk-approve', () => {
    it('approves multiple suggestions');
    it('returns success/failure counts');
    it('validates max 100 suggestions');
  });
});
```

### Integration Tests

**mrp-dashboard-integration.test.ts**
```typescript
describe('MRP Dashboard Integration', () => {
  describe('Suggestion to Order Flow', () => {
    it('creates draft PO when PO suggestion approved');
    it('PO contains correct product, supplier, quantity');
    it('PO expected_delivery_date matches suggestion required_date');
    it('suggestion shows link to created PO');
  });

  describe('Exception Resolution Flow', () => {
    it('resolves shortage by creating emergency PO');
    it('exception status updates to resolved');
    it('resolution details stored');
  });

  describe('Coverage Calculation', () => {
    it('calculates days_of_stock from inventory and usage');
    it('considers open POs as incoming supply');
    it('considers open WO material requirements as demand');
  });
});
```

### E2E Tests

**mrp-dashboard.spec.ts**
```typescript
describe('MRP Dashboard', () => {
  it('displays MRP dashboard with all components');
  it('shows summary cards with correct counts');
  it('displays shortage alerts widget');
  it('loads suggested POs table with data');
  it('filters suggestions by product');
  it('approves single suggestion and shows created order');
  it('rejects suggestion with reason');
  it('bulk approves selected suggestions');
  it('shows action pegging modal with demand sources');
  it('displays exceptions with severity badges');
  it('resolves exception and updates status');
  it('shows coverage analysis table');
  it('displays coverage timeline chart');
  it('triggers new MRP run');
  it('polls for run completion');
});
```

## Security Considerations

1. **RLS Enforcement**
   - All MRP tables have org_id column
   - RLS policies filter by authenticated user's org_id
   - Cross-tenant access returns 404, not 403

2. **Permission Checks**
   - Only users with planning permissions can view MRP dashboard
   - Only users with approval permissions can approve suggestions
   - Bulk operations limited to 100 items

3. **Audit Trail**
   - All suggestion approvals/rejections logged with user_id
   - Exception resolutions logged with timestamp
   - MRP runs track created_by user

4. **Data Validation**
   - All inputs validated with Zod schemas
   - Suggestion modifications validated against business rules
   - Date ranges capped to prevent expensive queries

## Deliverables

- [ ] MRP Dashboard page at `/planning/mrp`
- [ ] MRP Run History panel with status badges
- [ ] Trigger MRP Run modal with configuration
- [ ] Suggested POs table with actions
- [ ] Suggested WOs table with actions
- [ ] Approve/Reject/Modify suggestion workflows
- [ ] Bulk approve/reject functionality
- [ ] Action Pegging modal with tree visualization
- [ ] Exceptions table with severity indicators
- [ ] Resolve/Ignore exception workflows
- [ ] Material Coverage Analysis table
- [ ] Coverage Timeline chart (Recharts)
- [ ] Shortage Alerts widget
- [ ] Dashboard Summary Cards
- [ ] API routes for all dashboard endpoints
- [ ] MRP Dashboard Service (`lib/services/mrp-dashboard-service.ts`)
- [ ] Zod validation schemas (`lib/validation/mrp-dashboard.ts`)
- [ ] Redis caching with 5-minute TTL
- [ ] Cache invalidation on data changes
- [ ] RLS policies for mrp_runs, mrp_suggestions, mrp_exceptions
- [ ] Unit tests (>80% coverage)
- [ ] Integration tests
- [ ] E2E tests

## Definition of Done

- [ ] MRP Dashboard page loads at `/planning/mrp` route
- [ ] MRP Run History shows all runs with status badges
- [ ] User can trigger new MRP run with configuration
- [ ] Suggested POs table displays with all columns
- [ ] Suggested WOs table displays with all columns
- [ ] Single suggestion approve creates draft PO/WO
- [ ] Single suggestion reject stores reason and notes
- [ ] Modify suggestion allows changes before approval
- [ ] Bulk approve handles up to 100 suggestions
- [ ] Bulk reject applies single reason to all
- [ ] Action Pegging modal shows demand sources tree
- [ ] Clicking pegging node navigates to source entity
- [ ] Exceptions table shows all exception types
- [ ] Exception severity determines row highlighting
- [ ] Resolve exception executes action and updates status
- [ ] Material Coverage table calculates days_of_stock
- [ ] Coverage status badges (critical/low/ok) correct
- [ ] Coverage Timeline chart renders with correct data
- [ ] Shortage Alerts widget shows critical items
- [ ] Dashboard Summary Cards show correct counts
- [ ] All filters work correctly
- [ ] Pagination works for large datasets
- [ ] RLS policies prevent cross-org access
- [ ] Dashboard loads in < 3 seconds
- [ ] Cache invalidation works on data changes
- [ ] Unit test coverage >= 80%
- [ ] Integration tests pass
- [ ] E2E tests pass
- [ ] Mobile responsive design

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-01-14 | Initial story creation | ARCHITECT-AGENT |
