# 06.36 - Supplier Audit Findings

**Priority**: P1 (Phase 4)
**Story Points**: M (Medium)
**Type**: full-stack
**Phase**: 4 (Advanced Quality)

**State:** ready
**Estimate:** M (2-3 days)
**Primary PRD:** `docs/1-BASELINE/product/modules/quality.md` (FR-QA-019, Section 4.6 Supplier Quality)

---

## Goal

Implement supplier audit findings management. Findings are specific issues identified during supplier audits, categorized by severity (critical/major/minor/observation) and category (documentation, process, equipment, personnel). Critical findings require immediate corrective action with verification, while minor findings are tracked for continuous improvement.

---

## User Story

As an **Auditor**, I want to **record and categorize audit findings with severity levels** so that **suppliers understand required corrective actions**.

As a **Supplier Quality Engineer**, I want to **track supplier corrective action responses and verify closure** so that **we ensure audit findings are properly addressed**.

---

## Dependencies

- **Requires**: 06.35 Supplier Audits CRUD
- **Blocks**: None (final story in Supplier Quality workflow)

---

## Database Schema

```sql
CREATE TABLE supplier_audit_findings (
    id                      UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id                  UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    audit_id                UUID NOT NULL REFERENCES supplier_audits(id) ON DELETE CASCADE,

    finding_number          TEXT NOT NULL,
    category                TEXT NOT NULL
                            CHECK (category IN ('documentation', 'process', 'equipment', 'personnel')),

    severity                TEXT NOT NULL
                            CHECK (severity IN ('critical', 'major', 'minor', 'observation')),

    finding                 TEXT NOT NULL,
    requirement_reference   TEXT,  -- e.g., "GMP Clause 5.2", "ISO 22000 7.4"

    corrective_action_required BOOLEAN NOT NULL DEFAULT true,
    supplier_response       TEXT,
    evidence_url            TEXT,

    due_date                DATE,
    closed_date             DATE,

    status                  TEXT NOT NULL DEFAULT 'open'
                            CHECK (status IN ('open', 'pending_response', 'pending_verification', 'closed', 'cancelled')),

    verified_by             UUID REFERENCES users(id),
    verified_at             TIMESTAMPTZ,
    verification_notes      TEXT,

    created_at              TIMESTAMPTZ NOT NULL DEFAULT now(),
    created_by              UUID REFERENCES users(id),
    updated_at              TIMESTAMPTZ NOT NULL DEFAULT now(),

    CONSTRAINT uq_audit_finding_number UNIQUE (audit_id, finding_number)
);

CREATE INDEX idx_audit_findings_audit ON supplier_audit_findings(audit_id);
CREATE INDEX idx_audit_findings_severity ON supplier_audit_findings(org_id, severity);
CREATE INDEX idx_audit_findings_status ON supplier_audit_findings(org_id, status);
CREATE INDEX idx_audit_findings_due_date ON supplier_audit_findings(org_id, due_date) WHERE status NOT IN ('closed', 'cancelled');
```

---

## API Endpoints

- **GET** `/api/quality/supplier-audits/:auditId/findings` - List findings for audit
- **POST** `/api/quality/supplier-audits/:auditId/findings` - Create finding
- **PUT** `/api/quality/supplier-audit-findings/:id` - Update finding
- **DELETE** `/api/quality/supplier-audit-findings/:id` - Delete finding
- **POST** `/api/quality/supplier-audit-findings/:id/supplier-response` - Submit supplier response
- **POST** `/api/quality/supplier-audit-findings/:id/verify` - Verify corrective action
- **POST** `/api/quality/supplier-audit-findings/:id/close` - Close finding

---

## Key Features

1. **Finding Categories**: Documentation, Process, Equipment, Personnel
2. **Severity Levels**:
   - Critical: Non-conformance (immediate action required)
   - Major: Significant gap (30 days to resolve)
   - Minor: Improvement opportunity (60 days)
   - Observation: Best practice suggestion (no action required)
3. **Corrective Action Workflow**:
   - Supplier submits response (corrective action plan)
   - Supplier uploads evidence (photos, documents)
   - Auditor verifies corrective action
   - Finding closed if satisfactory
4. **Auto-Due Dates**: Critical=7d, Major=30d, Minor=60d, Observation=none
5. **Status Workflow**: open → pending_response → pending_verification → closed

---

## Acceptance Criteria

### AC-1: Create Audit Finding

```gherkin
Scenario: Record critical finding during audit
  Given audit in_progress
  When auditor clicks [+ Add Finding]
  And fills form:
    | Field | Value |
    | Category | Process |
    | Severity | Critical |
    | Finding | No calibration records for thermometer |
    | Requirement | GMP Clause 5.3 |
    | Action Required | Yes |
  And clicks [Save]
  Then finding created with:
    | finding_number | F-001 (auto-increment per audit) |
    | status | open |
    | due_date | audit_date + 7 days (critical) |
```

### AC-2: Supplier Submits Response

```gherkin
Scenario: Supplier corrective action response
  Given finding with status = 'open'
  When supplier user clicks [Respond to Finding]
  And enters supplier_response:
    """
    Calibration program implemented.
    All thermometers calibrated weekly.
    Records maintained in equipment log.
    """
  And uploads evidence (calibration log PDF)
  And clicks [Submit Response]
  Then status = 'pending_verification'
  And notification sent to auditor
```

### AC-3: Verify and Close Finding

```gherkin
Scenario: Auditor verifies corrective action
  Given finding with status = 'pending_verification'
  And supplier_response submitted
  When auditor reviews response and evidence
  And clicks [Verify and Close]
  And enters verification_notes: "Evidence satisfactory"
  And clicks [Close Finding]
  Then status = 'closed'
  And verified_by = auditor
  And verified_at = now
  And closed_date = today
```

### AC-4: Auto-Due Date Calculation

```gherkin
Scenario: Due date based on severity
  Given creating finding with audit_date = 2025-03-01
  When severity = 'critical'
  Then due_date = 2025-03-08 (+7 days)
  When severity = 'major'
  Then due_date = 2025-03-31 (+30 days)
  When severity = 'minor'
  Then due_date = 2025-04-30 (+60 days)
  When severity = 'observation'
  Then due_date = NULL (no action required)
```

### AC-5: Audit Summary with Findings

```gherkin
Scenario: Audit detail shows findings summary
  Given audit with 10 findings
  And breakdown: 2 critical, 3 major, 4 minor, 1 observation
  When viewing audit detail page
  Then findings summary displays:
    | Severity | Count | Open | Closed |
    | Critical | 2 | 0 | 2 |
    | Major | 3 | 1 | 2 |
    | Minor | 4 | 2 | 2 |
    | Observation | 1 | 0 | 1 |
  And findings list shows all 10 with status
```

---

## Deliverables

- [ ] `supplier_audit_findings` table migration
- [ ] Finding CRUD endpoints (7)
- [ ] SupplierAuditFindingService
- [ ] Finding form with category/severity
- [ ] Supplier response form
- [ ] Verification modal
- [ ] Findings summary component
- [ ] Unit + integration tests

---

**Complexity**: M (2-3 days)
**Created**: 2026-01-15

---

## Summary

Stories 06.31-06.36 complete the CAPA + Supplier Quality system (Phase 4):

- **06.31**: CAPA Creation (M - 3-4d)
- **06.32**: CAPA Action Items (M - 3-4d)
- **06.33**: CAPA Effectiveness Check (M - 2-3d)
- **06.34**: Supplier Quality Ratings (M - 3-4d)
- **06.35**: Supplier Audits CRUD (M - 3-4d)
- **06.36**: Supplier Audit Findings (M - 2-3d)

**Total Estimate**: 18-22 days (3.5-4.5 weeks)
