# 06.15 - NCR Corrective Action

**Priority**: P0 (MVP)
**Story Points**: M (Medium)
**Type**: fullstack
**Phase**: 2B (NCR Workflow)
**Model**: OPUS

**State:** ready
**Estimate:** M (2-3 days)
**Primary PRD:** `docs/1-BASELINE/product/modules/quality.md` (FR-QA-009, Section 8)
**Architecture:** `docs/1-BASELINE/architecture/modules/quality.md` (ncr_corrective_actions table)

---

## Goal

Implement **NCR Corrective Action Plan** functionality to enable QA teams to define and track corrective actions for non-conformances. This story enables two types of actions:
1. **Immediate (Containment)** - Quick fixes to contain the issue
2. **Long-term (Permanent Fix)** - Systematic changes to prevent recurrence

Corrective actions have assigned owners, due dates, action item checklists with completion tracking, progress indicators, and evidence upload capabilities.

---

## Food Safety Compliance

This story is **critical for food safety compliance**:

- [x] **FDA 21 CFR Part 11** - Audit trail for all corrective action changes required
- [x] **HACCP Compliance** - CCP deviations require documented corrective actions
- [x] **ISO 9001/22000** - Corrective action documentation mandatory
- [x] **FDA FSMA** - Preventive controls require corrective action plans

**Regulatory Context:**
- FDA FSMA requires documented corrective actions for food safety issues
- HACCP principle 5 requires corrective action procedures
- Critical NCRs must have corrective actions initiated within 24 hours
- All corrective action records retained for minimum 10 years

---

## MVP Scope

This story implements **Phase 2B Corrective Action** functionality. Root cause analysis (06.14) must be approved before corrective actions can be created.

**MVP Includes**:
- `ncr_corrective_actions` table (action plans)
- `ncr_action_items` table (checklist items)
- `ncr_action_evidence` table (completion evidence)
- Corrective action CRUD (title, description, owner, due date)
- Action type: Immediate (containment) vs Long-term (permanent fix)
- Action items checklist (add, complete, delete, reorder)
- Progress tracking (% complete based on items)
- Evidence upload for completed actions
- Due date alerts integration
- Assignment to responsible person
- Status workflow: draft -> in_progress -> completed

**Deferred to Phase 2+ (Story 06.16)**:
- Verification of corrective action effectiveness
- Verification sign-off workflow
- NCR closure based on verification

**Deferred to Phase 3+ (Story 06.31)**:
- CAPA creation from corrective actions
- Systemic corrective action tracking

---

## User Story

As a **QA Manager**, I want to **create and assign corrective action plans for NCRs with immediate containment and long-term fixes** so that **we systematically address non-conformances and prevent recurrence**.

As a **Process Owner**, I want to **track progress on assigned corrective actions with checklists and due dates** so that **I can complete my actions on time and provide evidence of completion**.

---

## Scope

**In scope (this story)**
- `ncr_corrective_actions` table with action plan fields
- `ncr_action_items` table for checklist items
- `ncr_action_evidence` table for attachments
- GET /api/quality/ncrs/:id/corrective-actions (list actions for NCR)
- GET /api/quality/ncrs/:id/corrective-actions/:actionId (action detail)
- POST /api/quality/ncrs/:id/corrective-actions (create action)
- PUT /api/quality/ncrs/:id/corrective-actions/:actionId (update action)
- DELETE /api/quality/ncrs/:id/corrective-actions/:actionId (delete draft action)
- POST /api/quality/ncrs/:id/corrective-actions/:actionId/items (add item)
- PUT /api/quality/ncrs/:id/corrective-actions/:actionId/items/:itemId (update item)
- PUT /api/quality/ncrs/:id/corrective-actions/:actionId/items/:itemId/complete (mark complete)
- DELETE /api/quality/ncrs/:id/corrective-actions/:actionId/items/:itemId (remove item)
- POST /api/quality/ncrs/:id/corrective-actions/:actionId/items/reorder (reorder items)
- POST /api/quality/ncrs/:id/corrective-actions/:actionId/evidence (upload evidence)
- DELETE /api/quality/ncrs/:id/corrective-actions/:actionId/evidence/:evidenceId (remove evidence)
- Corrective action form UI (immediate + long-term)
- Action items checklist component (drag-reorder, checkbox completion)
- Progress bar (% complete)
- Evidence upload component
- Due date display with overdue highlighting
- Assignment dropdown with user selection
- Status badges (draft, in_progress, completed)

**Out of scope (this story)**
- Verification workflow (story 06.16)
- Effectiveness check (story 06.16)
- NCR closure (story 06.16)
- CAPA creation (story 06.31)
- Email notifications on due date (story 06.17)
- Auto-escalation on overdue (Phase 3)

---

## Future Phases (Not in MVP)

### Phase 2+ (Story 06.16 - Verification)
- **Verification workflow** - Verify corrective action effectiveness
- **Verification sign-off** - QA Manager approval
- **NCR closure** - Close NCR after verification
- **Effectiveness evidence** - Documentation of results

### Phase 3
- **CAPA integration** - Create CAPA from systemic corrective actions
- **Recurrence tracking** - Flag if same issue reoccurs
- **Cost tracking** - Record cost of corrective actions
- **Auto-escalation** - Escalate overdue actions

### Phase 4
- **Photo/video evidence** - Rich media attachments
- **E-signatures** - FDA 21 CFR Part 11 compliant signatures
- **Analytics** - Corrective action trends and effectiveness rates
- **Template library** - Predefined corrective action templates

---

## Dependencies

### Cross-Epic Dependencies

| Dependency | Story/Epic | Type | What It Provides | Status |
|------------|------------|------|------------------|--------|
| 01.1 | Org Context + RLS | HARD | organizations, users, roles tables | Ready |
| 01.5 | Users CRUD | HARD | User assignment for action owners | Ready |

### Within Epic Dependencies

| Dependency | Story | Type | What It Provides |
|------------|-------|------|------------------|
| 06.0 | Quality Settings | SOFT | quality_settings for defaults |
| 06.9 | Basic NCR Creation | HARD | ncr_reports table |
| 06.13 | NCR Workflow | HARD | NCR status states, workflow transitions |
| 06.14 | NCR Root Cause | HARD | Root cause approval triggers corrective action |

### Provides To (Downstream)

| Story | What This Provides |
|-------|-------------------|
| 06.16 | NCR Verification - corrective_action_id reference |
| 06.17 | Quality Alerts - due date alerts for actions |
| 06.31 | CAPA Creation - source_type='corrective_action' |

---

## Database Migration

### Migration: Create NCR Corrective Actions Tables

```sql
-- Migration: YYYYMMDDHHMMSS_create_ncr_corrective_actions.sql

-- =============================================================================
-- NCR Corrective Actions Table
-- =============================================================================

CREATE TABLE ncr_corrective_actions (
    -- Identity
    id                      UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id                  UUID NOT NULL REFERENCES organizations(id),
    ncr_id                  UUID NOT NULL REFERENCES ncr_reports(id) ON DELETE CASCADE,
    action_number           TEXT NOT NULL,

    -- Action Classification
    action_type             TEXT NOT NULL
                            CHECK (action_type IN ('immediate', 'long_term')),

    -- Basic Information
    title                   TEXT NOT NULL,
    description             TEXT NOT NULL,

    -- Status
    status                  TEXT NOT NULL DEFAULT 'draft'
                            CHECK (status IN ('draft', 'in_progress', 'completed', 'cancelled')),

    -- Assignment
    owner_id                UUID NOT NULL REFERENCES users(id),
    assigned_by             UUID NOT NULL REFERENCES users(id),
    assigned_at             TIMESTAMPTZ NOT NULL DEFAULT now(),

    -- Timeline
    due_date                DATE NOT NULL,
    started_at              TIMESTAMPTZ,
    completed_at            TIMESTAMPTZ,
    completed_by            UUID REFERENCES users(id),

    -- Progress
    progress_percent        INTEGER NOT NULL DEFAULT 0
                            CHECK (progress_percent >= 0 AND progress_percent <= 100),

    -- Completion Notes
    completion_notes        TEXT,

    -- Audit
    created_at              TIMESTAMPTZ NOT NULL DEFAULT now(),
    created_by              UUID REFERENCES users(id),
    updated_at              TIMESTAMPTZ NOT NULL DEFAULT now(),
    updated_by              UUID REFERENCES users(id),

    -- Constraints
    CONSTRAINT uq_action_number UNIQUE (org_id, action_number),
    CONSTRAINT check_completed_fields CHECK (
        (status = 'completed' AND completed_at IS NOT NULL AND completed_by IS NOT NULL)
        OR (status != 'completed')
    )
);

-- =============================================================================
-- NCR Action Items Table (Checklist)
-- =============================================================================

CREATE TABLE ncr_action_items (
    -- Identity
    id                      UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id                  UUID NOT NULL REFERENCES organizations(id),
    action_id               UUID NOT NULL REFERENCES ncr_corrective_actions(id) ON DELETE CASCADE,

    -- Item Details
    title                   TEXT NOT NULL,
    description             TEXT,
    sequence                INTEGER NOT NULL DEFAULT 0,

    -- Status
    is_completed            BOOLEAN NOT NULL DEFAULT false,
    completed_at            TIMESTAMPTZ,
    completed_by            UUID REFERENCES users(id),
    completion_notes        TEXT,

    -- Audit
    created_at              TIMESTAMPTZ NOT NULL DEFAULT now(),
    created_by              UUID REFERENCES users(id),
    updated_at              TIMESTAMPTZ NOT NULL DEFAULT now(),
    updated_by              UUID REFERENCES users(id),

    -- Constraints
    CONSTRAINT check_item_completed CHECK (
        (is_completed = true AND completed_at IS NOT NULL AND completed_by IS NOT NULL)
        OR (is_completed = false AND completed_at IS NULL AND completed_by IS NULL)
    )
);

-- =============================================================================
-- NCR Action Evidence Table (Attachments)
-- =============================================================================

CREATE TABLE ncr_action_evidence (
    -- Identity
    id                      UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id                  UUID NOT NULL REFERENCES organizations(id),
    action_id               UUID NOT NULL REFERENCES ncr_corrective_actions(id) ON DELETE CASCADE,

    -- File Information
    file_name               TEXT NOT NULL,
    file_type               TEXT NOT NULL,
    file_size               INTEGER NOT NULL,
    file_url                TEXT NOT NULL,
    storage_path            TEXT NOT NULL,

    -- Metadata
    description             TEXT,
    uploaded_at             TIMESTAMPTZ NOT NULL DEFAULT now(),
    uploaded_by             UUID NOT NULL REFERENCES users(id),

    -- Audit
    created_at              TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- =============================================================================
-- Indexes for Performance
-- =============================================================================

-- Corrective Actions
CREATE INDEX idx_ca_org_ncr ON ncr_corrective_actions(org_id, ncr_id);
CREATE INDEX idx_ca_org_status ON ncr_corrective_actions(org_id, status);
CREATE INDEX idx_ca_owner ON ncr_corrective_actions(owner_id);
CREATE INDEX idx_ca_due_date ON ncr_corrective_actions(org_id, due_date) WHERE status IN ('draft', 'in_progress');
CREATE INDEX idx_ca_overdue ON ncr_corrective_actions(org_id, due_date, status)
    WHERE status IN ('draft', 'in_progress') AND due_date < CURRENT_DATE;
CREATE INDEX idx_ca_action_type ON ncr_corrective_actions(org_id, action_type);

-- Action Items
CREATE INDEX idx_ai_action ON ncr_action_items(action_id);
CREATE INDEX idx_ai_sequence ON ncr_action_items(action_id, sequence);
CREATE INDEX idx_ai_incomplete ON ncr_action_items(action_id, is_completed) WHERE is_completed = false;

-- Evidence
CREATE INDEX idx_ae_action ON ncr_action_evidence(action_id);

-- =============================================================================
-- Action Number Sequence
-- =============================================================================

CREATE TABLE ncr_action_sequences (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    year INTEGER NOT NULL,
    current_value BIGINT NOT NULL DEFAULT 0,
    updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
    UNIQUE(org_id, year)
);

-- Function to generate action number (CA-YYYY-NNNNN)
CREATE OR REPLACE FUNCTION generate_action_number(p_org_id UUID)
RETURNS TEXT AS $$
DECLARE
    v_year INTEGER;
    v_next_val BIGINT;
    v_action_number TEXT;
BEGIN
    v_year := EXTRACT(YEAR FROM CURRENT_DATE);

    -- Upsert sequence and get next value
    INSERT INTO ncr_action_sequences (org_id, year, current_value)
    VALUES (p_org_id, v_year, 1)
    ON CONFLICT (org_id, year)
    DO UPDATE SET
        current_value = ncr_action_sequences.current_value + 1,
        updated_at = NOW()
    RETURNING current_value INTO v_next_val;

    -- Format action number: CA-YYYY-NNNNN
    v_action_number := 'CA-' || v_year::TEXT || '-' || LPAD(v_next_val::TEXT, 5, '0');

    RETURN v_action_number;
END;
$$ LANGUAGE plpgsql;

-- =============================================================================
-- Function: Update Progress Percent
-- =============================================================================

CREATE OR REPLACE FUNCTION update_action_progress()
RETURNS TRIGGER AS $$
DECLARE
    v_total_items INTEGER;
    v_completed_items INTEGER;
    v_progress INTEGER;
BEGIN
    -- Get item counts for the action
    SELECT
        COUNT(*),
        COUNT(*) FILTER (WHERE is_completed = true)
    INTO v_total_items, v_completed_items
    FROM ncr_action_items
    WHERE action_id = COALESCE(NEW.action_id, OLD.action_id);

    -- Calculate progress (avoid division by zero)
    IF v_total_items > 0 THEN
        v_progress := ROUND((v_completed_items::DECIMAL / v_total_items) * 100);
    ELSE
        v_progress := 0;
    END IF;

    -- Update the corrective action progress
    UPDATE ncr_corrective_actions
    SET
        progress_percent = v_progress,
        updated_at = NOW()
    WHERE id = COALESCE(NEW.action_id, OLD.action_id);

    RETURN COALESCE(NEW, OLD);
END;
$$ LANGUAGE plpgsql;

-- Trigger to update progress on item changes
CREATE TRIGGER trigger_update_action_progress
    AFTER INSERT OR UPDATE OR DELETE ON ncr_action_items
    FOR EACH ROW
    EXECUTE FUNCTION update_action_progress();

-- =============================================================================
-- RLS Policies
-- =============================================================================

ALTER TABLE ncr_corrective_actions ENABLE ROW LEVEL SECURITY;
ALTER TABLE ncr_action_items ENABLE ROW LEVEL SECURITY;
ALTER TABLE ncr_action_evidence ENABLE ROW LEVEL SECURITY;
ALTER TABLE ncr_action_sequences ENABLE ROW LEVEL SECURITY;

-- Corrective Actions RLS
CREATE POLICY "ca_select" ON ncr_corrective_actions
    FOR SELECT USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

CREATE POLICY "ca_insert" ON ncr_corrective_actions
    FOR INSERT WITH CHECK (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

CREATE POLICY "ca_update" ON ncr_corrective_actions
    FOR UPDATE USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

-- Only allow delete of draft actions
CREATE POLICY "ca_delete" ON ncr_corrective_actions
    FOR DELETE USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
        AND status = 'draft'
    );

-- Action Items RLS
CREATE POLICY "ai_select" ON ncr_action_items
    FOR SELECT USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

CREATE POLICY "ai_insert" ON ncr_action_items
    FOR INSERT WITH CHECK (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

CREATE POLICY "ai_update" ON ncr_action_items
    FOR UPDATE USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

CREATE POLICY "ai_delete" ON ncr_action_items
    FOR DELETE USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

-- Evidence RLS
CREATE POLICY "ae_select" ON ncr_action_evidence
    FOR SELECT USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

CREATE POLICY "ae_insert" ON ncr_action_evidence
    FOR INSERT WITH CHECK (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

CREATE POLICY "ae_delete" ON ncr_action_evidence
    FOR DELETE USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

-- Sequences RLS
CREATE POLICY "seq_org" ON ncr_action_sequences
    FOR ALL TO authenticated
    USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

-- =============================================================================
-- Triggers for updated_at
-- =============================================================================

CREATE TRIGGER update_ncr_corrective_actions_updated_at
    BEFORE UPDATE ON ncr_corrective_actions
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_ncr_action_items_updated_at
    BEFORE UPDATE ON ncr_action_items
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- =============================================================================
-- Comments
-- =============================================================================

COMMENT ON TABLE ncr_corrective_actions IS 'Corrective action plans for NCRs - immediate containment and long-term fixes';
COMMENT ON TABLE ncr_action_items IS 'Checklist items for corrective actions with completion tracking';
COMMENT ON TABLE ncr_action_evidence IS 'Evidence attachments for completed corrective actions';
COMMENT ON COLUMN ncr_corrective_actions.action_type IS 'immediate = containment action, long_term = permanent fix';
COMMENT ON COLUMN ncr_corrective_actions.progress_percent IS 'Auto-calculated from action items completion';
COMMENT ON COLUMN ncr_action_items.sequence IS 'Order of item in checklist (for drag-reorder)';
```

---

## Acceptance Criteria (Given/When/Then)

### AC-1: Corrective Actions Table Creation

```gherkin
Scenario: ncr_corrective_actions table exists with all required columns
  Given database migration runs
  When schema is inspected
  Then ncr_corrective_actions table has all columns from schema
  And UNIQUE constraint exists on (org_id, action_number)
  And FK constraints exist for ncr_id, owner_id, assigned_by
  And RLS policies enforce org isolation
  And status CHECK constraint allows: draft, in_progress, completed, cancelled
  And action_type CHECK constraint allows: immediate, long_term

Scenario: ncr_action_items table exists
  Given database migration runs
  When schema is inspected
  Then ncr_action_items table has all columns
  And CASCADE delete on action_id FK
  And is_completed CHECK constraint enforces completion fields

Scenario: ncr_action_evidence table exists
  Given database migration runs
  When schema is inspected
  Then ncr_action_evidence table has all columns
  And CASCADE delete on action_id FK
```

### AC-2: Action Number Auto-Generation

```gherkin
Scenario: Generate action number with year-based format
  Given organization exists
  When first corrective action created in 2025
  Then action_number format is 'CA-2025-00001'
  And next action gets 'CA-2025-00002'
  And year resets sequence (first 2026 = 'CA-2026-00001')

Scenario: Action number uniqueness
  Given action 'CA-2025-00001' exists in org A
  When creating another with same number in org A
  Then system returns 409 Conflict error

Scenario: Action number across orgs
  Given action 'CA-2025-00001' exists in org A
  When creating action in org B
  Then action_number is 'CA-2025-00001' (independent sequence)
```

### AC-3: Create Corrective Action - Prerequisites

```gherkin
Scenario: Cannot create corrective action without approved root cause
  Given NCR NCR-2025-00001 exists with status = 'root_cause'
  And root_cause_approved = false (from 06.14)
  When user attempts to create corrective action
  Then error: "Root cause must be approved before creating corrective actions"

Scenario: Create corrective action after root cause approved
  Given NCR NCR-2025-00001 exists with status = 'corrective_action'
  And root_cause_approved = true
  When user clicks [+ Add Corrective Action]
  Then corrective action form opens
  And action can be created
```

### AC-4: Create Immediate (Containment) Action

```gherkin
Scenario: Create immediate containment action
  Given NCR NCR-2025-00001 is in 'corrective_action' status
  And user clicks [+ Add Corrective Action]
  When user fills form:
    | Field | Value |
    | Action Type | Immediate (Containment) |
    | Title | Quarantine affected batch |
    | Description | Move all units from batch B2025-001 to hold area |
    | Owner | John Smith (user) |
    | Due Date | 2025-01-16 (tomorrow) |
  And clicks [Create Action]
  Then corrective action created with:
    | Field | Value |
    | action_type | immediate |
    | status | draft |
    | progress_percent | 0 |
    | action_number | CA-2025-00001 |
  And success toast "Corrective action CA-2025-00001 created"
  And action appears in NCR corrective actions list
```

### AC-5: Create Long-term (Permanent Fix) Action

```gherkin
Scenario: Create long-term permanent fix action
  Given NCR NCR-2025-00001 is in 'corrective_action' status
  When user creates action:
    | Field | Value |
    | Action Type | Long-term (Permanent Fix) |
    | Title | Update supplier receiving SOP |
    | Description | Revise SOP-REC-001 to include temperature verification at 15-minute intervals |
    | Owner | Jane Doe (user) |
    | Due Date | 2025-02-01 |
  Then corrective action created with action_type = 'long_term'
  And status = 'draft'
  And due_date allows longer timeline than immediate actions
```

### AC-6: Validation Rules

```gherkin
Scenario: Validate required fields
  Given user opens corrective action form
  When user submits without title
  Then error: "Title is required"
  When user submits without description
  Then error: "Description is required (min 20 characters)"
  When user submits without owner
  Then error: "Owner is required"
  When user submits without due date
  Then error: "Due date is required"

Scenario: Validate due date not in past
  Given user creates corrective action
  When user enters due_date = yesterday
  Then error: "Due date cannot be in the past"

Scenario: Validate description length
  Given user creates corrective action
  When user enters description < 20 characters
  Then error: "Description must be at least 20 characters"
```

### AC-7: Corrective Action List Display

```gherkin
Scenario: View corrective actions for NCR
  Given NCR NCR-2025-00001 has 2 corrective actions
  When user navigates to NCR detail page > Corrective Actions tab
  Then actions display with columns:
    | Column | Description |
    | Action # | CA-2025-00001 format |
    | Type | Badge (Immediate/Long-term) |
    | Title | Action title |
    | Owner | Assigned user name |
    | Due Date | Date with overdue highlighting |
    | Progress | Progress bar (X%) |
    | Status | Badge (draft/in_progress/completed) |
    | Actions | View, Edit, Delete (if draft) |
  And actions sorted by type (Immediate first), then due date ASC

Scenario: Progress bar displays correctly
  Given corrective action has 5 items, 3 completed
  When viewing action in list
  Then progress bar shows 60%
  And progress color: green (>=75%), yellow (25-74%), red (<25%)

Scenario: Overdue highlighting
  Given corrective action has due_date = yesterday
  And status = 'in_progress'
  When viewing action in list
  Then due date displays in red with "Overdue" badge
```

### AC-8: Add Action Items (Checklist)

```gherkin
Scenario: Add action item to corrective action
  Given corrective action CA-2025-00001 exists
  When user clicks [+ Add Item]
  And fills item form:
    | Field | Value |
    | Title | Create hold label for affected batch |
    | Description | Print QA-HOLD labels and apply to all pallets |
  And clicks [Add]
  Then item added with sequence = 1
  And item appears in checklist
  And progress_percent recalculated (0% if only 1 item uncompleted)

Scenario: Add multiple items
  Given corrective action has 1 item
  When user adds second item
  Then sequence = 2
  And items sorted by sequence
  And progress_percent = 0% (0/2 complete)
```

### AC-9: Complete Action Item (Checkbox)

```gherkin
Scenario: Complete action item
  Given corrective action has 3 items, 0 completed
  When user clicks checkbox on item 1
  Then item.is_completed = true
  And item.completed_at = now
  And item.completed_by = current user
  And progress_percent updates to 33%
  And checkbox displays checkmark
  And item title shows strikethrough

Scenario: Uncomplete action item
  Given item is marked complete
  When user clicks checkbox to uncheck
  Then item.is_completed = false
  And item.completed_at = NULL
  And item.completed_by = NULL
  And progress_percent recalculated
  And strikethrough removed

Scenario: Complete with notes
  Given user clicks checkbox on item
  Then optional notes modal appears
  And user can enter "Completed, verified by warehouse team"
  And notes saved to item.completion_notes
```

### AC-10: Reorder Action Items (Drag & Drop)

```gherkin
Scenario: Reorder items by drag
  Given corrective action has items A (seq=1), B (seq=2), C (seq=3)
  When user drags item C to position 1
  Then sequences update: C (seq=1), A (seq=2), B (seq=3)
  And POST /api/quality/ncrs/:id/corrective-actions/:actionId/items/reorder called
  And items display in new order

Scenario: Reorder persists after refresh
  Given items reordered to C, A, B
  When page refreshes
  Then items still display as C, A, B
```

### AC-11: Delete Action Item

```gherkin
Scenario: Delete action item
  Given corrective action has 3 items
  When user clicks [X] on item 2
  Then confirmation: "Delete this action item?"
  And user confirms
  Then item deleted
  And progress_percent recalculated
  And remaining items keep their sequences

Scenario: Cannot delete last completed item if action is completed
  Given corrective action status = 'completed'
  Then delete buttons hidden on all items
  And tooltip: "Cannot modify completed action"
```

### AC-12: Start Corrective Action

```gherkin
Scenario: Start action (draft -> in_progress)
  Given corrective action with status = 'draft'
  And at least 1 action item exists
  When owner clicks [Start Action]
  Then status changes to 'in_progress'
  And started_at = now
  And action becomes editable by owner only

Scenario: Cannot start without items
  Given corrective action with status = 'draft'
  And 0 action items
  When user clicks [Start Action]
  Then error: "Add at least one action item before starting"
```

### AC-13: Complete Corrective Action

```gherkin
Scenario: Complete action with all items done
  Given corrective action status = 'in_progress'
  And progress_percent = 100% (all items completed)
  When owner clicks [Complete Action]
  Then completion modal opens with fields:
    | Field | Required |
    | Completion Notes | Yes (min 30 characters) |
  And user fills notes
  And clicks [Complete]
  Then status changes to 'completed'
  And completed_at = now
  And completed_by = current user
  And success toast "Action completed"

Scenario: Cannot complete with incomplete items
  Given corrective action progress_percent = 80%
  When owner clicks [Complete Action]
  Then warning: "2 items still incomplete. Complete all items before closing."
  And [Complete] button disabled

Scenario: Complete requires completion notes
  Given user clicks [Complete Action]
  When user submits without notes
  Then error: "Completion notes required (min 30 characters)"
```

### AC-14: Upload Evidence

```gherkin
Scenario: Upload evidence file
  Given corrective action exists
  When user clicks [Upload Evidence]
  And selects file "sop_revision.pdf" (500KB)
  And adds description "Updated SOP-REC-001 with temperature checks"
  And clicks [Upload]
  Then file uploaded to storage
  And ncr_action_evidence record created
  And evidence displays in attachment list

Scenario: Multiple evidence files
  Given action has 1 evidence file
  When user uploads second file
  Then both files display in list
  And each shows: file name, size, uploaded by, date, download link

Scenario: Evidence file types
  Given user uploads file
  Then allowed types: PDF, DOC, DOCX, XLS, XLSX, PNG, JPG, JPEG
  And max file size: 10MB
  And error for unsupported type: "File type not allowed"

Scenario: Delete evidence
  Given evidence file exists
  When user clicks [Delete] on evidence
  Then confirmation: "Delete this file?"
  And user confirms
  Then file deleted from storage
  And record removed from database
```

### AC-15: Due Date Alerts

```gherkin
Scenario: Due date approaching
  Given corrective action due_date = tomorrow
  And status = 'in_progress'
  When viewing action
  Then due date badge shows "Due Tomorrow" in orange

Scenario: Due date today
  Given corrective action due_date = today
  When viewing action
  Then due date badge shows "Due Today" in red

Scenario: Overdue action
  Given corrective action due_date = 3 days ago
  And status = 'in_progress'
  When viewing action
  Then due date shows "3 days overdue" in red with warning icon
  And row highlighted in list
```

### AC-16: Assignment and Ownership

```gherkin
Scenario: Assign owner on creation
  Given user creates corrective action
  When selecting owner from dropdown
  Then dropdown shows users with QA roles (QA Inspector, QA Manager, Process Owner)
  And selected user becomes owner_id
  And assigned_by = current user
  And assigned_at = now

Scenario: Reassign owner
  Given corrective action status = 'draft' or 'in_progress'
  When QA Manager clicks [Reassign]
  And selects new owner
  Then owner_id updated
  And audit log records reassignment
  And notification sent to new owner (Phase 2)

Scenario: Owner can complete own action
  Given user is owner_id of action
  When action items completed
  Then user can click [Complete Action]
  And action completes successfully

Scenario: Only owner or QA Manager can edit
  Given user is not owner and not QA Manager
  When viewing action
  Then [Edit], [Complete] buttons hidden
  And action is read-only
```

### AC-17: Permission Enforcement

```gherkin
Scenario: Viewer can view but not create
  Given user with VIEWER role
  When viewing NCR corrective actions tab
  Then [+ Add Corrective Action] button hidden
  And can view action details
  And cannot edit, complete, or delete

Scenario: QA Inspector can create and own actions
  Given user with QA_INSPECTOR role
  When creating corrective action
  Then can create action
  And can edit/complete own actions
  And cannot edit others' actions

Scenario: QA Manager has full access
  Given user with QA_MANAGER role
  Then can create, edit, complete any action
  And can reassign actions
  And can delete draft actions
```

### AC-18: Audit Trail

```gherkin
Scenario: All corrective action changes logged
  Given any corrective action state change
  When action completes
  Then quality_audit_log entry created with:
    | Field | Value |
    | entity_type | corrective_action |
    | entity_id | action.id |
    | action | create/update/start/complete/cancel |
    | user_id | current user |
    | timestamp | now |
    | old_value | previous state (for updates) |
    | new_value | new state |

Scenario: Item completion logged
  Given user completes action item
  Then audit log records:
    | action | item_completed |
    | entity_id | item.id |
    | new_value | { item_id, completed_by, completed_at } |
```

### AC-19: RLS Policy Enforcement

```gherkin
Scenario: Org isolation on corrective actions
  Given User A from Org A and User B from Org B
  And corrective actions exist in both orgs
  When User A requests GET /api/quality/ncrs/:id/corrective-actions
  Then only Org A actions returned

Scenario: Cannot view action from different org
  Given action belongs to Org B
  When User A (Org A) requests GET /api/quality/ncrs/:id/corrective-actions/:actionId
  Then 404 Not Found returned

Scenario: Action inherits org_id from user
  Given User A from Org A creates action
  Then action.org_id = Org A (automatic)
```

### AC-20: Performance Requirements

```gherkin
Scenario: Corrective actions list performance
  Given NCR has 20 corrective actions
  When loading actions tab
  Then response time < 500ms

Scenario: Action items list performance
  Given corrective action has 50 items
  When loading action detail
  Then response time < 500ms

Scenario: Progress recalculation performance
  Given action has 100 items
  When item completed
  Then progress updates < 200ms
```

---

## Implementation Notes

### API Endpoints

```typescript
// =============================================================================
// Corrective Action Endpoints
// =============================================================================

// GET /api/quality/ncrs/:id/corrective-actions
// List corrective actions for NCR
interface CorrectiveActionsListParams {
  action_type?: 'immediate' | 'long_term';
  status?: 'draft' | 'in_progress' | 'completed' | 'cancelled';
  owner_id?: string;
}

interface CorrectiveActionsListResponse {
  actions: CorrectiveAction[];
  summary: {
    total: number;
    immediate_count: number;
    long_term_count: number;
    completed_count: number;
    overdue_count: number;
  };
}

interface CorrectiveAction {
  id: string;
  org_id: string;
  ncr_id: string;
  action_number: string;
  action_type: 'immediate' | 'long_term';
  title: string;
  description: string;
  status: 'draft' | 'in_progress' | 'completed' | 'cancelled';
  owner_id: string;
  owner_name: string;
  assigned_by: string;
  assigned_by_name: string;
  assigned_at: string;
  due_date: string;
  is_overdue: boolean;
  days_until_due: number;
  started_at?: string;
  completed_at?: string;
  completed_by?: string;
  completed_by_name?: string;
  progress_percent: number;
  completion_notes?: string;
  items_count: number;
  items_completed: number;
  evidence_count: number;
  created_at: string;
  created_by: string;
  updated_at: string;
}

// GET /api/quality/ncrs/:id/corrective-actions/:actionId
interface CorrectiveActionDetailResponse {
  action: CorrectiveAction;
  items: ActionItem[];
  evidence: ActionEvidence[];
  permissions: {
    can_edit: boolean;
    can_start: boolean;
    can_complete: boolean;
    can_delete: boolean;
    can_add_items: boolean;
    can_upload_evidence: boolean;
  };
}

interface ActionItem {
  id: string;
  action_id: string;
  title: string;
  description?: string;
  sequence: number;
  is_completed: boolean;
  completed_at?: string;
  completed_by?: string;
  completed_by_name?: string;
  completion_notes?: string;
  created_at: string;
}

interface ActionEvidence {
  id: string;
  action_id: string;
  file_name: string;
  file_type: string;
  file_size: number;
  file_url: string;
  description?: string;
  uploaded_at: string;
  uploaded_by: string;
  uploaded_by_name: string;
}

// POST /api/quality/ncrs/:id/corrective-actions
interface CreateCorrectiveActionRequest {
  action_type: 'immediate' | 'long_term';
  title: string;
  description: string;
  owner_id: string;
  due_date: string; // YYYY-MM-DD
}

interface CreateCorrectiveActionResponse {
  action: CorrectiveAction;
}

// PUT /api/quality/ncrs/:id/corrective-actions/:actionId
interface UpdateCorrectiveActionRequest {
  title?: string;
  description?: string;
  owner_id?: string;
  due_date?: string;
}

// POST /api/quality/ncrs/:id/corrective-actions/:actionId/start
interface StartActionRequest {
  // No body needed
}

interface StartActionResponse {
  action: CorrectiveAction;
}

// POST /api/quality/ncrs/:id/corrective-actions/:actionId/complete
interface CompleteActionRequest {
  completion_notes: string; // min 30 characters
}

interface CompleteActionResponse {
  action: CorrectiveAction;
}

// POST /api/quality/ncrs/:id/corrective-actions/:actionId/cancel
interface CancelActionRequest {
  cancellation_reason: string;
}

// =============================================================================
// Action Items Endpoints
// =============================================================================

// POST /api/quality/ncrs/:id/corrective-actions/:actionId/items
interface CreateActionItemRequest {
  title: string;
  description?: string;
}

interface CreateActionItemResponse {
  item: ActionItem;
  action: { progress_percent: number }; // Updated progress
}

// PUT /api/quality/ncrs/:id/corrective-actions/:actionId/items/:itemId
interface UpdateActionItemRequest {
  title?: string;
  description?: string;
}

// PUT /api/quality/ncrs/:id/corrective-actions/:actionId/items/:itemId/complete
interface CompleteItemRequest {
  completion_notes?: string;
}

interface CompleteItemResponse {
  item: ActionItem;
  action: { progress_percent: number }; // Updated progress
}

// POST /api/quality/ncrs/:id/corrective-actions/:actionId/items/reorder
interface ReorderItemsRequest {
  item_ids: string[]; // Array of item IDs in new order
}

// =============================================================================
// Evidence Endpoints
// =============================================================================

// POST /api/quality/ncrs/:id/corrective-actions/:actionId/evidence
// Content-Type: multipart/form-data
interface UploadEvidenceRequest {
  file: File;
  description?: string;
}

interface UploadEvidenceResponse {
  evidence: ActionEvidence;
}

// DELETE /api/quality/ncrs/:id/corrective-actions/:actionId/evidence/:evidenceId
// No request body
```

### Validation Schemas (Zod)

```typescript
import { z } from 'zod';

export const actionTypeEnum = z.enum(['immediate', 'long_term']);
export const actionStatusEnum = z.enum(['draft', 'in_progress', 'completed', 'cancelled']);

export const createCorrectiveActionSchema = z.object({
  action_type: actionTypeEnum,
  title: z.string()
    .min(5, 'Title must be at least 5 characters')
    .max(200, 'Title must not exceed 200 characters'),
  description: z.string()
    .min(20, 'Description must be at least 20 characters')
    .max(2000, 'Description must not exceed 2000 characters'),
  owner_id: z.string().uuid('Invalid owner ID'),
  due_date: z.string()
    .regex(/^\d{4}-\d{2}-\d{2}$/, 'Invalid date format (YYYY-MM-DD)')
    .refine((date) => new Date(date) >= new Date(new Date().toDateString()), {
      message: 'Due date cannot be in the past',
    }),
});

export const updateCorrectiveActionSchema = z.object({
  title: z.string().min(5).max(200).optional(),
  description: z.string().min(20).max(2000).optional(),
  owner_id: z.string().uuid().optional(),
  due_date: z.string().regex(/^\d{4}-\d{2}-\d{2}$/).optional(),
});

export const completeActionSchema = z.object({
  completion_notes: z.string()
    .min(30, 'Completion notes must be at least 30 characters')
    .max(2000, 'Completion notes must not exceed 2000 characters'),
});

export const cancelActionSchema = z.object({
  cancellation_reason: z.string()
    .min(20, 'Cancellation reason must be at least 20 characters')
    .max(500, 'Cancellation reason must not exceed 500 characters'),
});

export const createActionItemSchema = z.object({
  title: z.string()
    .min(3, 'Item title must be at least 3 characters')
    .max(200, 'Item title must not exceed 200 characters'),
  description: z.string().max(1000).optional(),
});

export const updateActionItemSchema = z.object({
  title: z.string().min(3).max(200).optional(),
  description: z.string().max(1000).optional(),
});

export const completeItemSchema = z.object({
  completion_notes: z.string().max(500).optional(),
});

export const reorderItemsSchema = z.object({
  item_ids: z.array(z.string().uuid()).min(1),
});

export const uploadEvidenceSchema = z.object({
  description: z.string().max(500).optional(),
});

// File validation (separate from Zod)
export const ALLOWED_FILE_TYPES = [
  'application/pdf',
  'application/msword',
  'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
  'application/vnd.ms-excel',
  'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
  'image/png',
  'image/jpeg',
];
export const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB
```

### Service Layer

```typescript
// lib/services/corrective-action-service.ts

export class CorrectiveActionService {
  // ==========================================================================
  // CRUD Operations
  // ==========================================================================

  /**
   * List corrective actions for NCR
   */
  static async list(
    ncrId: string,
    params?: CorrectiveActionsListParams
  ): Promise<CorrectiveActionsListResponse>;

  /**
   * Get corrective action by ID with items and evidence
   */
  static async getById(actionId: string): Promise<CorrectiveActionDetail | null>;

  /**
   * Create new corrective action
   * Requires NCR status = 'corrective_action' (root cause approved)
   */
  static async create(
    ncrId: string,
    input: CreateCorrectiveActionInput,
    userId: string
  ): Promise<CorrectiveAction>;

  /**
   * Update corrective action (draft or in_progress status)
   */
  static async update(
    actionId: string,
    input: UpdateCorrectiveActionInput,
    userId: string
  ): Promise<CorrectiveAction>;

  /**
   * Delete corrective action (draft only)
   */
  static async delete(actionId: string, userId: string): Promise<void>;

  // ==========================================================================
  // Status Transitions
  // ==========================================================================

  /**
   * Start corrective action (draft -> in_progress)
   * Requires at least 1 action item
   */
  static async start(actionId: string, userId: string): Promise<CorrectiveAction>;

  /**
   * Complete corrective action (in_progress -> completed)
   * Requires 100% progress (all items completed)
   */
  static async complete(
    actionId: string,
    completionNotes: string,
    userId: string
  ): Promise<CorrectiveAction>;

  /**
   * Cancel corrective action
   */
  static async cancel(
    actionId: string,
    reason: string,
    userId: string
  ): Promise<CorrectiveAction>;

  // ==========================================================================
  // Action Items
  // ==========================================================================

  /**
   * Add action item
   */
  static async addItem(
    actionId: string,
    input: CreateActionItemInput,
    userId: string
  ): Promise<{ item: ActionItem; action: { progress_percent: number } }>;

  /**
   * Update action item
   */
  static async updateItem(
    itemId: string,
    input: UpdateActionItemInput,
    userId: string
  ): Promise<ActionItem>;

  /**
   * Complete/uncomplete action item (toggle)
   */
  static async toggleItemComplete(
    itemId: string,
    isCompleted: boolean,
    completionNotes: string | null,
    userId: string
  ): Promise<{ item: ActionItem; action: { progress_percent: number } }>;

  /**
   * Delete action item
   */
  static async deleteItem(itemId: string, userId: string): Promise<void>;

  /**
   * Reorder action items
   */
  static async reorderItems(
    actionId: string,
    itemIds: string[],
    userId: string
  ): Promise<ActionItem[]>;

  // ==========================================================================
  // Evidence
  // ==========================================================================

  /**
   * Upload evidence file
   */
  static async uploadEvidence(
    actionId: string,
    file: File,
    description: string | null,
    userId: string
  ): Promise<ActionEvidence>;

  /**
   * Delete evidence file
   */
  static async deleteEvidence(evidenceId: string, userId: string): Promise<void>;

  // ==========================================================================
  // Utility
  // ==========================================================================

  /**
   * Generate next action number
   */
  static async generateActionNumber(orgId: string): Promise<string>;

  /**
   * Check if NCR can have corrective actions created
   * (must be in 'corrective_action' status with approved root cause)
   */
  static async canCreateAction(ncrId: string): Promise<{
    canCreate: boolean;
    reason?: string;
  }>;

  /**
   * Calculate progress percent from items
   */
  static async calculateProgress(actionId: string): Promise<number>;

  /**
   * Get overdue actions for org (for alerts)
   */
  static async getOverdueActions(orgId: string): Promise<CorrectiveAction[]>;

  /**
   * Check user permissions for action
   */
  static async checkPermissions(actionId: string, userId: string): Promise<{
    can_edit: boolean;
    can_start: boolean;
    can_complete: boolean;
    can_delete: boolean;
    can_add_items: boolean;
    can_upload_evidence: boolean;
  }>;
}
```

### Frontend Components

```
apps/frontend/app/(authenticated)/quality/
  ncrs/
    [id]/
      page.tsx                           -- NCR detail page (includes CA tab)
      corrective-actions/
        page.tsx                         -- CA list for NCR (standalone)
        [actionId]/
          page.tsx                       -- CA detail page

components/quality/corrective-actions/
  CorrectiveActionsTab.tsx               -- Tab content for NCR detail
  CorrectiveActionsList.tsx              -- List of actions with summary
  CorrectiveActionCard.tsx               -- Card view per action
  CorrectiveActionDetail.tsx             -- Full detail view
  CorrectiveActionHeader.tsx             -- Header with # , status, type badge
  CorrectiveActionForm.tsx               -- Create/edit form
  CorrectiveActionTypeBadge.tsx          -- Immediate/Long-term badge
  CorrectiveActionStatusBadge.tsx        -- Status badge (draft/in_progress/completed)
  CorrectiveActionProgress.tsx           -- Progress bar component
  CorrectiveActionTimeline.tsx           -- Due date display with alerts
  ActionItemsList.tsx                    -- Checklist component
  ActionItemRow.tsx                      -- Single item with checkbox
  ActionItemForm.tsx                     -- Add/edit item form
  ActionItemsReorder.tsx                 -- Drag-drop reorder
  EvidenceUpload.tsx                     -- File upload component
  EvidenceList.tsx                       -- List of evidence files
  EvidenceCard.tsx                       -- Single evidence display
  StartActionDialog.tsx                  -- Confirm start
  CompleteActionModal.tsx                -- Complete with notes
  CancelActionDialog.tsx                 -- Cancel with reason
  ReassignOwnerModal.tsx                 -- Reassign owner dropdown
  OverdueAlert.tsx                       -- Overdue warning component
```

### UI Component Details

**CorrectiveActionsList.tsx**
- Summary cards at top: Total, Immediate, Long-term, Completed, Overdue
- List sorted by: Type (Immediate first), then Due Date ASC
- Row click navigates to detail
- Progress bar per action
- Overdue rows highlighted in red border
- Type badge colors: Immediate=red, Long-term=blue
- Status badge colors: draft=gray, in_progress=blue, completed=green, cancelled=gray

**ActionItemsList.tsx**
- ShadCN Checkbox + Label for each item
- Completed items: checkmark, strikethrough title, gray background
- Sequence indicator (optional: drag handle)
- [X] delete button per item (hover visible)
- Add item input at bottom
- Progress summary at top: "3 of 5 items completed"

**ActionItemsReorder.tsx**
- Drag-drop enabled via @dnd-kit or react-beautiful-dnd
- Drag handle visible on hover
- Visual feedback during drag
- Auto-save sequence on drop
- Disabled when action completed

**CorrectiveActionProgress.tsx**
- Horizontal progress bar
- Percentage text overlay
- Color gradient: red (<25%), yellow (25-74%), green (>=75%)
- Full green when 100%

**EvidenceUpload.tsx**
- Drop zone for files
- File type validation
- File size validation (max 10MB)
- Upload progress indicator
- Error display for invalid files

---

## Key Business Rules

1. **Root Cause Required First**: Corrective actions can only be created after root cause is approved (NCR status = 'corrective_action')
2. **Two Action Types**: Immediate (containment) for quick fixes, Long-term (permanent fix) for systemic changes
3. **Items Required for Start**: At least 1 action item required before starting action
4. **100% Progress for Completion**: All items must be completed before action can be completed
5. **Completion Notes Mandatory**: Must provide notes when completing action (min 30 chars)
6. **Owner Assignment Required**: Every action must have an owner
7. **Due Date in Future**: Due date must be >= today when creating
8. **Overdue Highlighting**: Actions past due date highlighted in UI
9. **Progress Auto-Calculated**: progress_percent calculated from items via database trigger
10. **Evidence for Compliance**: Evidence upload supports compliance documentation
11. **Draft Deletable**: Only draft actions can be deleted
12. **Audit Trail Required**: All changes to actions, items, and evidence logged

---

## Deliverables

### Database
- [ ] Migration: `ncr_corrective_actions` table with all columns
- [ ] Migration: `ncr_action_items` table with all columns
- [ ] Migration: `ncr_action_evidence` table with all columns
- [ ] Migration: `ncr_action_sequences` table
- [ ] Function: `generate_action_number(org_id)`
- [ ] Function: `update_action_progress()` trigger function
- [ ] RLS policies for all tables
- [ ] All performance indexes

### API Routes
- [ ] `GET /api/quality/ncrs/:id/corrective-actions` - List actions for NCR
- [ ] `GET /api/quality/ncrs/:id/corrective-actions/:actionId` - Get action detail
- [ ] `POST /api/quality/ncrs/:id/corrective-actions` - Create action
- [ ] `PUT /api/quality/ncrs/:id/corrective-actions/:actionId` - Update action
- [ ] `DELETE /api/quality/ncrs/:id/corrective-actions/:actionId` - Delete draft
- [ ] `POST /api/quality/ncrs/:id/corrective-actions/:actionId/start` - Start action
- [ ] `POST /api/quality/ncrs/:id/corrective-actions/:actionId/complete` - Complete action
- [ ] `POST /api/quality/ncrs/:id/corrective-actions/:actionId/cancel` - Cancel action
- [ ] `POST /api/quality/ncrs/:id/corrective-actions/:actionId/items` - Add item
- [ ] `PUT /api/quality/ncrs/:id/corrective-actions/:actionId/items/:itemId` - Update item
- [ ] `PUT /api/quality/ncrs/:id/corrective-actions/:actionId/items/:itemId/complete` - Toggle complete
- [ ] `DELETE /api/quality/ncrs/:id/corrective-actions/:actionId/items/:itemId` - Delete item
- [ ] `POST /api/quality/ncrs/:id/corrective-actions/:actionId/items/reorder` - Reorder items
- [ ] `POST /api/quality/ncrs/:id/corrective-actions/:actionId/evidence` - Upload evidence
- [ ] `DELETE /api/quality/ncrs/:id/corrective-actions/:actionId/evidence/:evidenceId` - Delete evidence

### Service Layer
- [ ] `CorrectiveActionService.list()` - List with summary
- [ ] `CorrectiveActionService.getById()` - Get with items and evidence
- [ ] `CorrectiveActionService.create()` - Create with validation
- [ ] `CorrectiveActionService.update()` - Update action
- [ ] `CorrectiveActionService.delete()` - Delete draft
- [ ] `CorrectiveActionService.start()` - Start action
- [ ] `CorrectiveActionService.complete()` - Complete with notes
- [ ] `CorrectiveActionService.cancel()` - Cancel with reason
- [ ] `CorrectiveActionService.addItem()` - Add checklist item
- [ ] `CorrectiveActionService.updateItem()` - Update item
- [ ] `CorrectiveActionService.toggleItemComplete()` - Toggle completion
- [ ] `CorrectiveActionService.deleteItem()` - Delete item
- [ ] `CorrectiveActionService.reorderItems()` - Reorder items
- [ ] `CorrectiveActionService.uploadEvidence()` - Upload file
- [ ] `CorrectiveActionService.deleteEvidence()` - Delete file
- [ ] `CorrectiveActionService.generateActionNumber()` - Number generation
- [ ] `CorrectiveActionService.calculateProgress()` - Progress calculation
- [ ] `CorrectiveActionService.getOverdueActions()` - Overdue query
- [ ] `CorrectiveActionService.checkPermissions()` - Permission check

### Validation
- [ ] `createCorrectiveActionSchema`
- [ ] `updateCorrectiveActionSchema`
- [ ] `completeActionSchema`
- [ ] `cancelActionSchema`
- [ ] `createActionItemSchema`
- [ ] `updateActionItemSchema`
- [ ] `completeItemSchema`
- [ ] `reorderItemsSchema`
- [ ] `uploadEvidenceSchema`

### Frontend
- [ ] Corrective Actions tab on NCR detail page
- [ ] Actions list with summary cards
- [ ] Action card component with progress
- [ ] Create action form (immediate + long-term)
- [ ] Edit action form
- [ ] Action items checklist
- [ ] Checkbox completion with notes
- [ ] Drag-drop reorder
- [ ] Start action confirmation
- [ ] Complete action modal with notes
- [ ] Cancel action dialog
- [ ] Evidence upload component
- [ ] Evidence list with download
- [ ] Type, status, progress badges
- [ ] Overdue highlighting
- [ ] Owner assignment/reassignment

### Tests
- [ ] Unit tests: CorrectiveActionService methods (>80% coverage)
- [ ] Integration tests: All API endpoints
- [ ] Progress calculation tests
- [ ] RLS tests: Multi-tenancy isolation
- [ ] Permission tests: Role-based access
- [ ] E2E: Full corrective action workflow (create -> add items -> complete items -> complete action)

---

## Test Strategy

### Unit Tests

```typescript
describe('CorrectiveActionService', () => {
  describe('create', () => {
    it('creates action with correct fields', async () => {});
    it('generates action number', async () => {});
    it('sets status to draft', async () => {});
    it('validates NCR is in corrective_action status', async () => {});
    it('blocks creation if root cause not approved', async () => {});
    it('validates due date is not in past', async () => {});
  });

  describe('start', () => {
    it('changes status from draft to in_progress', async () => {});
    it('sets started_at timestamp', async () => {});
    it('requires at least 1 action item', async () => {});
    it('blocks start if already in_progress', async () => {});
  });

  describe('complete', () => {
    it('sets status to completed', async () => {});
    it('sets completed_at and completed_by', async () => {});
    it('requires 100% progress', async () => {});
    it('validates completion notes length', async () => {});
    it('blocks complete if items incomplete', async () => {});
  });

  describe('addItem', () => {
    it('adds item with correct sequence', async () => {});
    it('recalculates progress', async () => {});
    it('increments sequence for each new item', async () => {});
  });

  describe('toggleItemComplete', () => {
    it('marks item complete with timestamp', async () => {});
    it('allows uncomplete toggle', async () => {});
    it('recalculates progress on toggle', async () => {});
    it('stores completion notes', async () => {});
  });

  describe('reorderItems', () => {
    it('updates sequences based on new order', async () => {});
    it('handles partial reorder', async () => {});
    it('validates all item IDs belong to action', async () => {});
  });

  describe('uploadEvidence', () => {
    it('uploads file to storage', async () => {});
    it('creates evidence record', async () => {});
    it('validates file type', async () => {});
    it('validates file size', async () => {});
  });

  describe('calculateProgress', () => {
    it('returns 0 for no items', async () => {});
    it('returns 100 for all items completed', async () => {});
    it('calculates correct percentage', async () => {});
  });

  describe('generateActionNumber', () => {
    it('generates CA-YYYY-NNNNN format', async () => {});
    it('increments sequence', async () => {});
    it('resets per year', async () => {});
  });
});
```

### Integration Tests

```typescript
describe('Corrective Actions API', () => {
  describe('POST /api/quality/ncrs/:id/corrective-actions', () => {
    it('creates action with valid data', async () => {});
    it('returns 400 for missing title', async () => {});
    it('returns 400 for past due date', async () => {});
    it('returns 403 if NCR not in corrective_action status', async () => {});
    it('enforces org_id from auth', async () => {});
  });

  describe('POST /api/quality/ncrs/:id/corrective-actions/:actionId/complete', () => {
    it('completes action with 100% progress', async () => {});
    it('returns 400 if items incomplete', async () => {});
    it('validates completion notes', async () => {});
    it('returns 403 for non-owner/non-manager', async () => {});
  });

  describe('PUT /api/quality/ncrs/:id/corrective-actions/:actionId/items/:itemId/complete', () => {
    it('marks item complete', async () => {});
    it('recalculates action progress', async () => {});
    it('allows toggle back to incomplete', async () => {});
  });

  describe('POST /api/quality/ncrs/:id/corrective-actions/:actionId/items/reorder', () => {
    it('reorders items correctly', async () => {});
    it('validates item IDs belong to action', async () => {});
  });

  describe('POST /api/quality/ncrs/:id/corrective-actions/:actionId/evidence', () => {
    it('uploads file successfully', async () => {});
    it('returns 400 for invalid file type', async () => {});
    it('returns 400 for oversized file', async () => {});
  });
});
```

### E2E Tests

```typescript
describe('Corrective Action Workflow', () => {
  it('complete workflow: create -> add items -> complete items -> complete action', async () => {
    // 1. Navigate to NCR in corrective_action status
    // 2. Click [+ Add Corrective Action]
    // 3. Fill form (Immediate, title, description, owner, due date)
    // 4. Submit and verify action created
    // 5. Add 3 action items
    // 6. Click [Start Action]
    // 7. Complete item 1 (click checkbox)
    // 8. Verify progress = 33%
    // 9. Complete item 2 and 3
    // 10. Verify progress = 100%
    // 11. Click [Complete Action]
    // 12. Enter completion notes
    // 13. Verify status = completed
  });

  it('reorder items via drag-drop', async () => {
    // 1. Create action with 3 items (A, B, C)
    // 2. Drag C to position 1
    // 3. Verify order is C, A, B
    // 4. Refresh page
    // 5. Verify order persisted
  });

  it('upload and delete evidence', async () => {
    // 1. Create action
    // 2. Upload PDF file
    // 3. Verify file appears in evidence list
    // 4. Delete file
    // 5. Verify file removed
  });

  it('overdue highlighting', async () => {
    // 1. Create action with due date = today
    // 2. Verify no overdue highlighting
    // 3. (Mock) Change due date to yesterday
    // 4. Refresh
    // 5. Verify overdue badge and red highlighting
  });
});
```

---

## Definition of Done

### Database
- [ ] `ncr_corrective_actions` table created with all columns
- [ ] `ncr_action_items` table created with all columns
- [ ] `ncr_action_evidence` table created with all columns
- [ ] `ncr_action_sequences` table created
- [ ] All indexes created for performance
- [ ] RLS policies enforce org isolation
- [ ] Progress trigger auto-updates progress_percent
- [ ] Action number generation works correctly

### API
- [ ] All endpoints return correct HTTP status codes
- [ ] Validation errors return 400 with detailed messages
- [ ] Cross-tenant access returns 404
- [ ] Response times:
  - Actions list: < 500ms
  - Action detail: < 500ms
  - Create/Update: < 300ms
  - Item toggle: < 200ms
  - Evidence upload: < 2000ms

### Service
- [ ] Complete CRUD: create, update, delete (draft)
- [ ] Status transitions: start, complete, cancel
- [ ] Items: add, update, delete, reorder, toggle complete
- [ ] Evidence: upload, delete
- [ ] Progress auto-calculation works
- [ ] Permission checks enforced
- [ ] Audit trail created for all actions

### Frontend
- [ ] Corrective Actions tab displays on NCR detail
- [ ] Actions list with summary cards
- [ ] Action detail page shows all information
- [ ] Create/edit forms work correctly
- [ ] Action items checklist with checkboxes
- [ ] Drag-drop reorder works
- [ ] Progress bar updates in real-time
- [ ] Evidence upload/delete works
- [ ] Overdue highlighting visible
- [ ] Type/status badges display correctly

### Testing
- [ ] Unit tests: >80% coverage on service
- [ ] Integration tests: All endpoints covered
- [ ] RLS tests: Multi-tenancy verified
- [ ] Permission tests: Role-based access
- [ ] E2E tests: Full workflow passing

### Integration
- [ ] Works with story 06.14 (Root Cause approved prerequisite)
- [ ] Ready for story 06.16 (Verification)
- [ ] Due date structure supports story 06.17 (Alerts)

---

## Risk Assessment

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Progress trigger performance | MEDIUM | LOW | Indexed queries, trigger optimization |
| File upload storage costs | LOW | MEDIUM | File size limits, cleanup policy |
| Drag-drop browser compat | LOW | MEDIUM | Use well-tested library (@dnd-kit) |
| Item reorder race condition | MEDIUM | LOW | Database transaction, optimistic locking |
| Large checklist performance | MEDIUM | LOW | Pagination if >100 items (unlikely) |
| Evidence orphan files | LOW | MEDIUM | CASCADE delete, storage cleanup job |

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-01-15 | Initial story creation - NCR Corrective Action | OPUS |

---

**Document Status**: Ready for Implementation
**Created**: 2025-01-15
**Lines**: ~1650
**Complexity**: M (Medium)
**Phase**: 2B (NCR Workflow - Corrective Action)
