# 06.40 - Document Control & Versioning

**Priority**: P1 (Post-MVP)
**Story Points**: M (Medium)
**Type**: fullstack
**Phase**: 4 (Analytics & Reporting)
**Model**: OPUS

**State:** ready
**Estimate:** M (3-4 days)
**Primary PRD:** `docs/1-BASELINE/product/modules/quality.md` (FR-QA-024, Section 13.2)
**Architecture:** `docs/1-BASELINE/architecture/modules/quality.md` (document_control pattern)

---

## Goal

Implement comprehensive document control and versioning system for quality documents (Quality Manual, SOPs, Work Instructions, Forms, Certificates) supporting ISO 9001 and FDA compliance. Enable QA Managers to upload, approve, version, link, search, and archive quality documents with full traceability and controlled access.

---

## Food Safety Compliance

This story is **critical for regulatory compliance**:

- [x] **ISO 9001:2015** - Clause 7.5 requires documented information control
- [x] **FDA 21 CFR Part 11** - Electronic records require version control
- [x] **HACCP** - HACCP plan documentation and change control
- [x] **Document Approval Workflow** - Draft → Review → Approved

**Regulatory Context:**
- ISO 9001 requires controlled documents with version tracking
- Document approval must be traceable (who approved, when)
- Obsolete documents must be archived (not deleted) for audit trail
- Document changes require reason for change (change control)
- Document expiry dates for time-sensitive documents (e.g., calibration certificates)

---

## MVP Scope

This story implements Phase 4 (Analytics & Reporting) functionality. Document Control is essential for quality system compliance and regulatory audits.

**MVP Includes**:
- `quality_documents` table with versioning
- Document CRUD (upload, metadata, version control)
- Document types: Quality Manual, SOP, Work Instruction, Form, Certificate
- Document approval workflow (Draft → Review → Approved)
- Version control (auto-increment version number on update)
- Document number auto-generation (DOC-TYPE-YYYY-NNNNN)
- Document expiry date (optional, with alerts)
- Document obsolescence (archive old versions)
- Document search (full-text, metadata filters)
- Document linking (link to product, inspection, NCR, CAPA)
- File upload to Supabase Storage (S3-compatible)
- GET /api/quality/documents (list with filters)
- GET /api/quality/documents/:id (detail with version history)
- POST /api/quality/documents (upload with metadata)
- PUT /api/quality/documents/:id (update creates new version)
- POST /api/quality/documents/:id/approve
- POST /api/quality/documents/:id/archive

**Deferred to Phase 5**: E-signature integration, collaborative editing (Google Docs style), advanced search (OCR content), document change comparison (diff).

---

## User Story

As a **QA Manager**, I want to **upload and version-control quality documents with approval workflow** so that **our quality system remains compliant with ISO 9001 and FDA requirements**.

As a **Quality Director**, I want to **search and link documents to inspections, NCRs, and products** so that **I can demonstrate traceability during audits**.

---

## Scope

**In scope (this story)**
- `quality_documents` table with versioning
- Document CRUD (create, read, update, archive)
- Document types: Quality Manual, SOP, Work Instruction, Form, Certificate, Other
- Document approval workflow (Draft → Review → Approved → Archived)
- Version control (version increments on update: 1.0 → 2.0)
- Document number auto-generation (QM-2025-00001, SOP-2025-00001, etc.)
- Document metadata: title, type, version, status, owner, approved_by, expiry_date
- Document expiry alerts (email notification 30 days before expiry)
- Document obsolescence (archive old versions, mark as obsolete)
- Document linking (link_type: product, inspection, ncr, capa, batch)
- File upload to Supabase Storage (PDF, DOCX, XLSX, PNG, JPG)
- Full-text search (title, description, tags)
- Document list with filters (type, status, owner, expiry)
- Document detail page with version history
- Document download (latest version or specific version)

**Out of scope (this story)**
- E-signature integration (21 CFR Part 11 compliant) - Phase 5
- Collaborative editing (multiple users editing same doc) - Phase 6
- OCR full-text search (search within PDF content) - Phase 5
- Document change comparison (diff between versions) - Phase 5
- Document templates (pre-filled forms) - Phase 5
- External document repository integration (SharePoint, Dropbox) - Phase 6

---

## Dependencies

### Cross-Epic Dependencies

| Dependency | Story/Epic | Type | What It Provides | Status |
|------------|------------|------|------------------|--------|
| 01.1 | Org Context + RLS | HARD | organizations, users tables | Ready |
| 02.1 | Products CRUD | SOFT | products table for document linking | Ready |

### Within Epic Dependencies

| Dependency | Story | Type | What It Provides |
|------------|-------|------|------------------|
| 06.3 | Product Specifications | SOFT | Specifications for document linking | Ready |
| 06.5 | Incoming Inspection | SOFT | Inspections for document linking | Ready |
| 06.9 | Basic NCR Creation | SOFT | NCRs for document linking | Ready |
| 06.31 | CAPA Creation | SOFT | CAPAs for document linking | Ready |

### Provides To (Downstream)

| Story | What This Provides |
|-------|-------------------|
| Phase 5 | E-Signature module - Document control foundation |
| Phase 6 | Training module - Link training materials to documents |

---

## Database Migration

### Migration: Create quality_documents table

```sql
-- Migration: YYYYMMDDHHMMSS_create_quality_documents.sql

CREATE TABLE quality_documents (
    -- Identity
    id                      UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id                  UUID NOT NULL REFERENCES organizations(id),
    document_number         TEXT NOT NULL,

    -- Document Type
    document_type           TEXT NOT NULL
                            CHECK (document_type IN (
                                'quality_manual', 'sop', 'work_instruction',
                                'form', 'certificate', 'haccp_plan', 'other'
                            )),

    -- Metadata
    title                   TEXT NOT NULL,
    description             TEXT,
    tags                    TEXT[], -- Array of tags for categorization

    -- Versioning
    version                 TEXT NOT NULL DEFAULT '1.0', -- Semantic versioning: major.minor
    is_latest_version       BOOLEAN NOT NULL DEFAULT true,
    previous_version_id     UUID REFERENCES quality_documents(id),

    -- Workflow Status
    status                  TEXT NOT NULL DEFAULT 'draft'
                            CHECK (status IN ('draft', 'review', 'approved', 'archived', 'obsolete')),

    -- Ownership
    owner_id                UUID NOT NULL REFERENCES users(id),
    reviewer_id             UUID REFERENCES users(id),
    approved_by             UUID REFERENCES users(id),
    approved_at             TIMESTAMPTZ,

    -- Expiry (optional, for time-sensitive documents like certificates)
    expiry_date             DATE,
    expiry_alert_sent       BOOLEAN DEFAULT false,

    -- File Storage
    file_path               TEXT NOT NULL, -- Supabase Storage path
    file_name               TEXT NOT NULL,
    file_size_bytes         BIGINT NOT NULL,
    file_type               TEXT NOT NULL, -- MIME type
    file_hash               TEXT, -- SHA-256 hash for integrity verification

    -- Linking (polymorphic - link to other entities)
    linked_entity_type      TEXT
                            CHECK (linked_entity_type IN (
                                'product', 'inspection', 'ncr', 'capa',
                                'batch', 'specification', NULL
                            )),
    linked_entity_id        UUID,

    -- Change Control
    change_reason           TEXT, -- Required when creating new version
    revision_notes          TEXT,

    -- Audit
    created_at              TIMESTAMPTZ NOT NULL DEFAULT now(),
    created_by              UUID REFERENCES users(id),
    updated_at              TIMESTAMPTZ NOT NULL DEFAULT now(),
    updated_by              UUID REFERENCES users(id),

    -- Constraints
    CONSTRAINT uq_document_number UNIQUE (org_id, document_number, version),
    CONSTRAINT check_approved_fields CHECK (
        (status = 'approved' AND approved_by IS NOT NULL AND approved_at IS NOT NULL) OR
        (status != 'approved')
    )
);

-- =============================================================================
-- Indexes for Performance
-- =============================================================================

CREATE INDEX idx_documents_org_type ON quality_documents(org_id, document_type);
CREATE INDEX idx_documents_org_status ON quality_documents(org_id, status);
CREATE INDEX idx_documents_latest ON quality_documents(org_id, is_latest_version) WHERE is_latest_version = true;
CREATE INDEX idx_documents_owner ON quality_documents(owner_id);
CREATE INDEX idx_documents_expiry ON quality_documents(org_id, expiry_date)
    WHERE expiry_date IS NOT NULL AND status = 'approved';
CREATE INDEX idx_documents_linked ON quality_documents(linked_entity_type, linked_entity_id)
    WHERE linked_entity_type IS NOT NULL;
CREATE INDEX idx_documents_created ON quality_documents(org_id, created_at DESC);

-- Full-text search on title, description, tags
CREATE INDEX idx_documents_search ON quality_documents
    USING gin(to_tsvector('english', COALESCE(title, '') || ' ' || COALESCE(description, '') || ' ' || COALESCE(array_to_string(tags, ' '), '')));

-- =============================================================================
-- Document Number Sequence
-- =============================================================================

CREATE TABLE document_number_sequences (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    year INTEGER NOT NULL,
    document_type TEXT NOT NULL,
    current_value BIGINT NOT NULL DEFAULT 0,
    updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
    UNIQUE(org_id, year, document_type)
);

-- Function to generate document number (QM-YYYY-NNNNN, SOP-YYYY-NNNNN, etc.)
CREATE OR REPLACE FUNCTION generate_document_number(p_org_id UUID, p_type TEXT)
RETURNS TEXT AS $$
DECLARE
    v_year INTEGER;
    v_next_val BIGINT;
    v_prefix TEXT;
    v_document_number TEXT;
BEGIN
    v_year := EXTRACT(YEAR FROM CURRENT_DATE);

    -- Determine prefix based on type
    CASE p_type
        WHEN 'quality_manual' THEN v_prefix := 'QM';
        WHEN 'sop' THEN v_prefix := 'SOP';
        WHEN 'work_instruction' THEN v_prefix := 'WI';
        WHEN 'form' THEN v_prefix := 'FORM';
        WHEN 'certificate' THEN v_prefix := 'CERT';
        WHEN 'haccp_plan' THEN v_prefix := 'HACCP';
        ELSE v_prefix := 'DOC';
    END CASE;

    -- Upsert sequence and get next value
    INSERT INTO document_number_sequences (org_id, year, document_type, current_value)
    VALUES (p_org_id, v_year, p_type, 1)
    ON CONFLICT (org_id, year, document_type)
    DO UPDATE SET
        current_value = document_number_sequences.current_value + 1,
        updated_at = NOW()
    RETURNING current_value INTO v_next_val;

    -- Format document number
    v_document_number := v_prefix || '-' || v_year::TEXT || '-' || LPAD(v_next_val::TEXT, 5, '0');

    RETURN v_document_number;
END;
$$ LANGUAGE plpgsql;

-- =============================================================================
-- RLS Policies
-- =============================================================================

ALTER TABLE quality_documents ENABLE ROW LEVEL SECURITY;

CREATE POLICY "documents_select" ON quality_documents
    FOR SELECT USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

CREATE POLICY "documents_insert" ON quality_documents
    FOR INSERT WITH CHECK (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

CREATE POLICY "documents_update" ON quality_documents
    FOR UPDATE USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

-- Only allow delete of draft documents
CREATE POLICY "documents_delete" ON quality_documents
    FOR DELETE USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
        AND status = 'draft'
    );

ALTER TABLE document_number_sequences ENABLE ROW LEVEL SECURITY;

CREATE POLICY "doc_seq_org" ON document_number_sequences
    FOR ALL TO authenticated
    USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

-- =============================================================================
-- Triggers
-- =============================================================================

CREATE TRIGGER update_quality_documents_updated_at
    BEFORE UPDATE ON quality_documents
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- =============================================================================
-- Function: Check Expiring Documents (Cron Job)
-- =============================================================================

CREATE OR REPLACE FUNCTION notify_expiring_documents()
RETURNS INTEGER AS $$
DECLARE
    v_expiring_doc RECORD;
    v_notified_count INTEGER := 0;
BEGIN
    -- Find documents expiring in next 30 days that haven't been alerted
    FOR v_expiring_doc IN
        SELECT id, org_id, document_number, title, expiry_date, owner_id
        FROM quality_documents
        WHERE status = 'approved'
          AND expiry_date IS NOT NULL
          AND expiry_date BETWEEN CURRENT_DATE AND CURRENT_DATE + INTERVAL '30 days'
          AND expiry_alert_sent = false
    LOOP
        -- TODO: Send notification to owner (integrate with notification service)
        -- For now, just mark as alerted
        UPDATE quality_documents
        SET expiry_alert_sent = true
        WHERE id = v_expiring_doc.id;

        v_notified_count := v_notified_count + 1;
    END LOOP;

    RETURN v_notified_count;
END;
$$ LANGUAGE plpgsql;

-- Schedule: Daily at 8am
-- SELECT cron.schedule('notify-expiring-docs', '0 8 * * *', 'SELECT notify_expiring_documents();');
```

---

## Acceptance Criteria (Given/When/Then)

### AC-1: Document Table Creation

```gherkin
Scenario: quality_documents table created
  Given database migration runs
  When schema inspected
  Then quality_documents table exists with all columns
  And UNIQUE constraint on (org_id, document_number, version)
  And FK constraints for all references
  And RLS policies enforce org isolation
```

### AC-2: Document Upload

```gherkin
Scenario: Upload new document
  Given user with QA_MANAGER role
  When navigating to Quality > Documents
  And clicking [+ Upload Document]
  Then form displays with fields:
    | Field | Required |
    | Document Type | Yes (dropdown: QM, SOP, WI, Form, Cert) |
    | Title | Yes |
    | Description | No |
    | Tags | No (multi-select or text input) |
    | File | Yes (drag-and-drop or browse) |
    | Owner | Yes (default: current user) |
    | Expiry Date | No |
    | Linked Entity | No (dropdown: Product, Inspection, NCR, CAPA) |
  And user fills form and uploads PDF
  And clicks [Save Draft]
  Then document created with:
    - status = 'draft'
    - version = '1.0'
    - document_number = auto-generated (e.g., SOP-2025-00001)
    - file uploaded to Supabase Storage
  And success toast: "Document SOP-2025-00001 created"

Scenario: Document number auto-generation
  Given organization exists
  When first SOP uploaded
  Then document_number = 'SOP-2025-00001'
  When second SOP uploaded
  Then document_number = 'SOP-2025-00002'
  When year changes to 2026
  Then next SOP = 'SOP-2026-00001' (sequence resets per year)
```

### AC-3: Document Approval Workflow

```gherkin
Scenario: Submit document for review
  Given document with status = 'draft'
  When owner clicks [Submit for Review]
  Then status changes to 'review'
  And reviewer_id assigned (QA Manager or Quality Director)
  And notification sent to reviewer

Scenario: Approve document
  Given document with status = 'review'
  And current user is reviewer
  When clicking [Approve]
  Then status changes to 'approved'
  And approved_by = current user
  And approved_at = now
  And notification sent to owner

Scenario: Reject document
  Given document with status = 'review'
  When reviewer clicks [Reject]
  And provides rejection reason
  Then status returns to 'draft'
  And revision_notes = rejection reason
  And notification sent to owner
```

### AC-4: Document Versioning

```gherkin
Scenario: Create new version of document
  Given approved document (version 1.0)
  When owner clicks [Create New Version]
  Then form opens with fields pre-filled from v1.0
  And user updates file or metadata
  And provides change_reason (required)
  And clicks [Save]
  Then new document record created:
    - version = '2.0'
    - document_number = same as v1.0
    - previous_version_id = v1.0 id
    - is_latest_version = true
    - status = 'draft'
  And old version updated:
    - is_latest_version = false
    - status = 'archived' (or remains 'approved' based on config)

Scenario: Version history display
  Given document with multiple versions (1.0, 2.0, 3.0)
  When viewing document detail page
  Then version history table displays:
    | Version | Status | Approved By | Approved Date | Actions |
    | 3.0 | Approved | Jane Doe | 2025-01-15 | [Download] [View] |
    | 2.0 | Archived | John Smith | 2025-01-10 | [Download] [View] |
    | 1.0 | Archived | John Smith | 2025-01-05 | [Download] [View] |
  And current version (3.0) highlighted
```

### AC-5: Document Search

```gherkin
Scenario: Search documents by title
  Given documents exist with various titles
  When user searches "SOP Cleaning"
  Then documents matching "Cleaning" in title displayed
  And search is case-insensitive

Scenario: Filter documents by type
  Given documents of multiple types
  When user filters by document_type = 'sop'
  Then only SOPs displayed

Scenario: Filter documents by status
  Given documents with various statuses
  When user filters by status = 'approved'
  Then only approved documents displayed

Scenario: Full-text search
  Given document with description "HACCP temperature monitoring"
  When user searches "temperature"
  Then document found via full-text search on title + description + tags
```

### AC-6: Document Linking

```gherkin
Scenario: Link document to product
  Given product "Chocolate Cake" exists
  And SOP "Allergen Control" exists
  When editing SOP
  And selecting linked_entity_type = 'product'
  And selecting linked_entity_id = Chocolate Cake
  Then document linked to product
  And product detail page shows linked documents

Scenario: View documents linked to inspection
  Given inspection INS-INC-2025-00001 exists
  And certificate linked to inspection
  When viewing inspection detail page
  Then "Linked Documents" section shows certificate
  And click opens certificate detail page
```

### AC-7: Document Expiry Alerts

```gherkin
Scenario: Set expiry date on document
  Given uploading calibration certificate
  When setting expiry_date = 2025-12-31
  Then expiry_date saved
  And expiry indicator shown on document list

Scenario: Expiry alert notification
  Given document with expiry_date = today + 25 days
  And expiry_alert_sent = false
  When daily cron job runs (notify_expiring_documents)
  Then email sent to owner:
    - Subject: "Document Expiring Soon: {document_number}"
    - Body: "Document '{title}' expires on {expiry_date}. Please renew or archive."
  And expiry_alert_sent = true

Scenario: Expired document badge
  Given document with expiry_date < today
  When viewing document list
  Then badge shows "EXPIRED" in red
  And document highlighted for attention
```

### AC-8: Document Obsolescence

```gherkin
Scenario: Mark document as obsolete
  Given approved document no longer needed
  When user clicks [Mark Obsolete]
  And provides reason
  Then status changes to 'obsolete'
  And revision_notes = reason
  And document removed from active list (default filter)

Scenario: View obsolete documents
  Given obsolete documents exist
  When user toggles "Show Obsolete"
  Then obsolete documents displayed with "OBSOLETE" badge
  And cannot be edited or downloaded (view-only)
```

### AC-9: Document Download

```gherkin
Scenario: Download latest version
  Given document with multiple versions
  When clicking [Download] on document list
  Then latest version file downloaded
  And filename = "{document_number}_v{version}_{title}.pdf"

Scenario: Download specific version
  Given document version history displayed
  When clicking [Download] on version 1.0
  Then version 1.0 file downloaded
  And filename includes version number
```

### AC-10: Document List View

```gherkin
Scenario: Display document list
  Given user navigates to Quality > Documents
  Then DataTable displays columns:
    | Column | Description |
    | Document Number | Link to detail page |
    | Type | Badge (QM, SOP, WI, Form, Cert) |
    | Title | Document title |
    | Version | Latest version number |
    | Status | Badge (Draft, Review, Approved, Archived, Obsolete) |
    | Owner | Owner name |
    | Approved By | Approver name (if approved) |
    | Expiry Date | Date (with warning if <30 days) |
    | Actions | Download, View, Edit |
  And pagination available (20 per page)
  And default filter: status IN ('draft', 'review', 'approved')
```

### AC-11: Document Detail View

```gherkin
Scenario: View document detail
  Given document exists
  When user clicks document number
  Then detail page displays:
    | Section | Content |
    | Header | Document number, type, version, status |
    | Metadata | Title, description, tags, owner, expiry |
    | File Info | File name, size, type, upload date |
    | Approval | Approved by, date, signature (if e-signature enabled) |
    | Linked To | Entity type, entity ID, link |
    | Version History | Table of all versions |
    | Actions | Download, Edit, Approve, Archive, New Version |
  And file preview (if PDF, embed viewer)

Scenario: View change reason
  Given document is new version (version > 1.0)
  When viewing detail page
  Then change_reason displayed prominently
  And revision_notes shown if provided
```

### AC-12: Permission Enforcement

```gherkin
Scenario: Viewer can view documents
  Given user with VIEWER role
  When viewing document list
  Then can view and download documents
  And cannot upload, edit, approve

Scenario: QA Inspector can upload drafts
  Given user with QA_INSPECTOR role
  Then can upload documents (draft status)
  And can edit own drafts
  And cannot approve documents

Scenario: QA Manager can approve
  Given user with QA_MANAGER role
  Then can upload, edit, approve documents
  And can mark as obsolete
  And can create new versions

Scenario: Quality Director has full access
  Given user with QUALITY_DIRECTOR role
  Then full access to all document operations
```

### AC-13: RLS Policy Enforcement

```gherkin
Scenario: Org isolation on documents
  Given User A from Org A and User B from Org B
  When User A queries documents
  Then sees only Org A documents

Scenario: Cross-org document access blocked
  Given document belongs to Org B
  When User A (Org A) attempts to access document
  Then API returns 404 Not Found
```

### AC-14: File Upload to Supabase Storage

```gherkin
Scenario: Upload file to Supabase Storage
  Given user uploading PDF document
  When file selected and form submitted
  Then file uploaded to Supabase Storage bucket 'quality-documents'
  And file_path = '{org_id}/{document_number}/v{version}/{filename}'
  And file_hash calculated (SHA-256)
  And file integrity verified on download

Scenario: File size limit
  Given user uploading file
  When file size > 50 MB
  Then error: "File size exceeds limit (50 MB)"
```

### AC-15: Performance Requirements

```gherkin
Scenario: Document list load time
  Given organization with 1,000 documents
  When loading document list
  Then response time < 500ms for paginated results (20 per page)

Scenario: Document upload performance
  Given user uploading 10 MB PDF
  When upload initiated
  Then upload completes within 10 seconds
  And progress bar shown during upload
```

---

## Implementation Notes

### API Endpoints

```typescript
// =============================================================================
// Document Endpoints
// =============================================================================

// GET /api/quality/documents
interface DocumentListRequest {
  document_type?: 'quality_manual' | 'sop' | 'work_instruction' | 'form' | 'certificate' | 'haccp_plan' | 'other';
  status?: 'draft' | 'review' | 'approved' | 'archived' | 'obsolete';
  owner_id?: string;
  search?: string;
  linked_entity_type?: string;
  linked_entity_id?: string;
  expiring_soon?: boolean; // Documents expiring in next 30 days
  latest_only?: boolean; // Default true
  sort_by?: 'created_at' | 'document_number' | 'title' | 'expiry_date';
  sort_order?: 'asc' | 'desc';
  page?: number;
  limit?: number;
}

interface DocumentListResponse {
  documents: QualityDocument[];
  pagination: {
    total: number;
    page: number;
    limit: number;
    pages: number;
  };
}

interface QualityDocument {
  id: string;
  org_id: string;
  document_number: string;
  document_type: string;
  title: string;
  description?: string;
  tags?: string[];
  version: string;
  is_latest_version: boolean;
  status: string;
  owner_id: string;
  owner_name: string;
  reviewer_id?: string;
  approved_by?: string;
  approved_by_name?: string;
  approved_at?: string;
  expiry_date?: string;
  file_path: string;
  file_name: string;
  file_size_bytes: number;
  file_type: string;
  linked_entity_type?: string;
  linked_entity_id?: string;
  created_at: string;
  updated_at: string;
}

// GET /api/quality/documents/:id
interface DocumentDetailResponse {
  document: QualityDocument;
  version_history: Array<{
    version: string;
    status: string;
    approved_by_name?: string;
    approved_at?: string;
    change_reason?: string;
    file_url: string; // Signed URL for download
  }>;
  linked_entities: Array<{
    entity_type: string;
    entity_id: string;
    entity_name: string;
  }>;
}

// POST /api/quality/documents
interface CreateDocumentRequest {
  document_type: string;
  title: string;
  description?: string;
  tags?: string[];
  owner_id?: string; // Default: current user
  expiry_date?: string;
  linked_entity_type?: string;
  linked_entity_id?: string;
  file: File; // Multipart form data
}

interface CreateDocumentResponse {
  document: QualityDocument;
}

// PUT /api/quality/documents/:id
interface UpdateDocumentRequest {
  title?: string;
  description?: string;
  tags?: string[];
  expiry_date?: string;
  linked_entity_type?: string;
  linked_entity_id?: string;
  file?: File; // If file updated, creates new version
  change_reason?: string; // Required if file updated (new version)
}

// POST /api/quality/documents/:id/submit-review
interface SubmitReviewRequest {
  reviewer_id: string;
}

// POST /api/quality/documents/:id/approve
interface ApproveDocumentRequest {
  approval_notes?: string;
}

// POST /api/quality/documents/:id/reject
interface RejectDocumentRequest {
  rejection_reason: string;
}

// POST /api/quality/documents/:id/new-version
interface NewVersionRequest {
  change_reason: string;
  file: File;
  revision_notes?: string;
}

// POST /api/quality/documents/:id/archive
interface ArchiveDocumentRequest {
  archive_reason: string;
}

// GET /api/quality/documents/:id/download
// Returns signed URL for file download
interface DocumentDownloadResponse {
  download_url: string; // Signed URL (expires in 1 hour)
  filename: string;
}
```

### Service Layer

```typescript
// lib/services/document-control-service.ts

export class DocumentControlService {
  // CRUD
  static async list(params: DocumentListParams): Promise<PaginatedResult<QualityDocument>>;
  static async getById(id: string): Promise<DocumentDetailResponse | null>;
  static async create(input: CreateDocumentInput, file: File): Promise<QualityDocument>;
  static async update(id: string, input: UpdateDocumentInput, file?: File): Promise<QualityDocument>;
  static async delete(id: string): Promise<void>; // Only drafts

  // Workflow
  static async submitForReview(id: string, reviewerId: string): Promise<QualityDocument>;
  static async approve(id: string, notes?: string): Promise<QualityDocument>;
  static async reject(id: string, reason: string): Promise<QualityDocument>;

  // Versioning
  static async createNewVersion(
    id: string,
    file: File,
    changeReason: string,
    revisionNotes?: string
  ): Promise<QualityDocument>;
  static async getVersionHistory(id: string): Promise<DocumentVersion[]>;

  // File Management
  static async uploadFile(file: File, orgId: string, documentNumber: string, version: string): Promise<string>;
  static async downloadFile(id: string, version?: string): Promise<string>; // Returns signed URL
  static async calculateFileHash(file: File): Promise<string>;

  // Archival & Obsolescence
  static async archive(id: string, reason: string): Promise<QualityDocument>;
  static async markObsolete(id: string, reason: string): Promise<QualityDocument>;

  // Expiry Management
  static async checkExpiringDocuments(): Promise<number>; // Cron job, returns count notified
  static async extendExpiry(id: string, newExpiryDate: Date): Promise<QualityDocument>;

  // Linking
  static async linkToEntity(
    id: string,
    entityType: string,
    entityId: string
  ): Promise<QualityDocument>;
  static async getLinkedDocuments(entityType: string, entityId: string): Promise<QualityDocument[]>;

  // Utility
  static async generateDocumentNumber(type: string): Promise<string>;
}
```

### Frontend Components

```
apps/frontend/app/(authenticated)/quality/
  documents/
    page.tsx                          -- Document list page
    [id]/
      page.tsx                        -- Document detail page
    new/
      page.tsx                        -- Upload document form

components/quality/documents/
  DocumentDataTable.tsx               -- DataTable with filters
  DocumentFilters.tsx                 -- Filter panel (type, status, owner)
  DocumentDetailView.tsx              -- Document detail container
  DocumentMetadata.tsx                -- Metadata display
  DocumentVersionHistory.tsx          -- Version history table
  DocumentUploadForm.tsx              -- Upload/create form
  DocumentApprovalActions.tsx         -- Approve/reject buttons
  DocumentStatusBadge.tsx             -- Status badge component
  DocumentTypeBadge.tsx               -- Type badge (QM, SOP, etc.)
  DocumentExpiryAlert.tsx             -- Expiry warning banner
  DocumentLinkedEntities.tsx          -- Linked entities list
  DocumentFilePreview.tsx             -- PDF preview (iframe or viewer)
  NewVersionModal.tsx                 -- Create new version modal
  ArchiveDocumentDialog.tsx           -- Archive confirmation
```

---

## Key Business Rules

1. **Version Increment**: Major version increment on file update (1.0 → 2.0), minor for metadata only (1.0 → 1.1) - MVP: major only
2. **Change Reason Required**: New version requires change_reason (why document updated)
3. **Approval Required**: Documents must be approved before becoming effective (except drafts)
4. **One Latest Version**: Only one document per document_number can have is_latest_version = true
5. **Archive Not Delete**: Obsolete documents archived, not deleted (audit trail)
6. **Expiry Alert**: Email notification sent 30 days before expiry
7. **File Integrity**: SHA-256 hash calculated and verified on download
8. **Document Number Uniqueness**: (org_id, document_number, version) unique constraint
9. **Draft Deletion Only**: Only draft documents can be deleted; approved documents must be archived
10. **Linked Entity Cascade**: If linked entity deleted, document link nullified (not cascade delete)

---

## Deliverables

### Database
- [ ] Migration: `quality_documents` table
- [ ] Migration: `document_number_sequences` table
- [ ] Function: `generate_document_number()`
- [ ] Function: `notify_expiring_documents()` cron job
- [ ] RLS policies for quality_documents
- [ ] All indexes (including full-text search)

### API Routes
- [ ] `GET /api/quality/documents` - List with filters
- [ ] `GET /api/quality/documents/:id` - Detail with version history
- [ ] `POST /api/quality/documents` - Upload document
- [ ] `PUT /api/quality/documents/:id` - Update (creates new version if file changed)
- [ ] `DELETE /api/quality/documents/:id` - Delete draft
- [ ] `POST /api/quality/documents/:id/submit-review` - Submit for review
- [ ] `POST /api/quality/documents/:id/approve` - Approve
- [ ] `POST /api/quality/documents/:id/reject` - Reject
- [ ] `POST /api/quality/documents/:id/new-version` - Create new version
- [ ] `POST /api/quality/documents/:id/archive` - Archive
- [ ] `GET /api/quality/documents/:id/download` - Download file

### Service Layer
- [ ] All DocumentControlService methods
- [ ] File upload to Supabase Storage
- [ ] SHA-256 hash calculation
- [ ] Signed URL generation for downloads

### Frontend
- [ ] Document list page with filters
- [ ] Document detail page with version history
- [ ] Upload document form
- [ ] Approval workflow UI
- [ ] New version modal
- [ ] File preview (PDF)
- [ ] Download buttons
- [ ] Expiry alerts

### Tests
- [ ] Unit tests: DocumentControlService (>80% coverage)
- [ ] Integration tests: All API endpoints
- [ ] E2E: Full document workflow (upload → approve → new version → archive)
- [ ] File upload/download tests
- [ ] RLS tests: Org isolation

---

## Definition of Done

### Database
- [ ] `quality_documents` table created
- [ ] RLS policies enforce org isolation
- [ ] Document number generation works
- [ ] Full-text search index works

### API
- [ ] All 11 endpoints work correctly
- [ ] File upload/download successful
- [ ] Response times < 500ms
- [ ] RLS policies prevent cross-org access

### Service
- [ ] All service methods work
- [ ] Versioning logic correct
- [ ] Approval workflow works
- [ ] File hash calculation accurate

### Frontend
- [ ] Document list displays correctly
- [ ] Upload form works
- [ ] Approval UI works
- [ ] Version history displays
- [ ] File download works
- [ ] Search and filters work

### Testing
- [ ] Unit tests: >80% coverage
- [ ] Integration tests: All endpoints
- [ ] E2E tests: Full workflow
- [ ] File upload/download verified

---

## Risk Assessment

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| File storage limits | MEDIUM | LOW | Monitor storage usage, implement retention policy |
| File upload timeout | MEDIUM | MEDIUM | Chunked upload for large files, 50 MB limit |
| Version control complexity | MEDIUM | MEDIUM | Clear versioning rules, comprehensive tests |
| Approval workflow confusion | LOW | MEDIUM | Clear UI states, tooltips, onboarding |
| Search performance | MEDIUM | LOW | Full-text search index, pagination |

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-01-15 | Initial story creation for Document Control & Versioning | OPUS |

---

**Document Status**: Ready for Implementation
**Created**: 2025-01-15
**Lines**: ~950
**Complexity**: M (Medium)
**Phase**: 4 (Analytics & Reporting)
