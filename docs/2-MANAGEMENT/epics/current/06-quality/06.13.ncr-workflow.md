# 06.13 - NCR Workflow State Machine

**Story ID:** 06.13
**Epic:** 06 - Quality
**Phase:** 2B
**Complexity:** L (Large)
**Estimate:** 4-5 days
**Type:** Backend (state machine logic)
**State:** ready

**Primary PRD:** `docs/1-BASELINE/product/modules/quality.md` (FR-QA-009, Section 8)
**Architecture:** `docs/1-BASELINE/architecture/modules/quality.md` (NCR Workflow)
**UX Wireframes:**
- `docs/3-ARCHITECTURE/ux/wireframes/QA-013-ncr-workflow-timeline.md`
- `docs/3-ARCHITECTURE/ux/wireframes/QA-013-ncr-transition-modal.md`
- `docs/3-ARCHITECTURE/ux/wireframes/QA-013-ncr-workflow-config.md`

## PRD References

| FR ID | Requirement | Priority | Phase | Covered |
|-------|-------------|----------|-------|---------|
| FR-QA-009 | NCR Creation & Workflow | P0 | 2 | Yes |

---

## User Story

**As a** QA Manager,
**I want** to manage NCR lifecycle through defined workflow states with proper authorization,
**So that** non-conformances are systematically investigated, resolved, and verified according to food safety requirements.

**As a** QA Inspector,
**I want** to see clear workflow progress and available transitions for each NCR,
**So that** I know what actions I can take and what steps remain before closure.

**As a** Process Owner,
**I want** to be automatically assigned when NCR enters my responsibility stage,
**So that** I receive timely notification and can act within SLA requirements.

---

## Goal

Implement a **complete NCR Workflow State Machine** that extends the basic NCR from story 06.9. This provides:

- **Full workflow states**: Draft -> Open -> Investigation -> Root Cause -> Corrective Action -> Verification -> Closed (+ Reopened)
- **State transition validation**: Cannot skip steps, proper sequence enforcement
- **Permission-based transitions**: QA Inspector vs QA Manager authorization per transition
- **Due date tracking**: Each state has configurable SLA with escalation
- **Assignment routing**: Auto-assign next owner based on state entry
- **Notification triggers**: Email/in-app alerts on state changes
- **Immutable audit trail**: Complete history via `ncr_state_history` table
- **Reopen capability**: Closed NCRs can be reopened with justification

---

## Food Safety Compliance

This story is **critical for food safety compliance**:

- [x] **FDA 21 CFR Part 11** - Immutable audit trail for all state changes
- [x] **HACCP Compliance** - Systematic investigation and corrective action documentation
- [x] **ISO 9001/22000** - Non-conformance workflow with root cause and verification
- [x] **FSMA Preventive Controls** - Documented corrective action process

**Regulatory Context:**
- Critical NCRs must complete investigation within 24 hours
- Root cause analysis required before closure
- Corrective actions must be verified for effectiveness
- All state transitions must be signed and timestamped
- Audit trail retained for 10 years minimum

---

## Scope

**In scope (this story)**
- Extend `ncr_reports.status` CHECK to full workflow states
- Create `ncr_state_transitions` table (valid transitions configuration)
- Create `ncr_state_history` table (immutable audit trail)
- Add workflow fields to `ncr_reports` (current_state_owner, state_entered_at, state_due_at)
- State machine validation (cannot skip steps)
- POST /api/quality/ncrs/:id/transition (state change endpoint)
- GET /api/quality/ncrs/:id/workflow (workflow history)
- GET /api/quality/ncrs/:id/available-transitions (what transitions are valid now)
- Permission-based transition authorization
- Due date calculation per state
- Auto-assignment on state entry
- Notification triggers (placeholder - actual sending in story 06.17)
- NCR status timeline component (vertical stepper)
- State transition modal (with notes + reason)
- Reopen logic (Closed -> Investigation with justification)

**Out of scope (this story)**
- Investigation form/tab content (story 06.14)
- Root cause analysis tools - 5-Why, Fishbone (story 06.14)
- Corrective action planning and tracking (story 06.15)
- Verification effectiveness checks (story 06.16)
- Email notification sending (story 06.17 - Quality Alerts)
- NCR workflow admin configuration UI (future - Phase 3)
- CAPA auto-creation from NCR (story 06.31)

---

## NCR Workflow States

### State Definitions

| State | Code | Description | Default SLA | Owner |
|-------|------|-------------|-------------|-------|
| Draft | `draft` | Initial creation, not yet submitted | N/A | Creator |
| Open | `open` | Submitted, awaiting investigation start | 24h | QA Manager |
| Investigation | `investigation` | Gathering data, analyzing issue | 48h | QA Inspector/Assigned |
| Root Cause | `root_cause` | Determining root cause (5-Why, Fishbone) | 72h | QA Team |
| Corrective Action | `corrective_action` | Implementing fix/prevention | 7d | Process Owner |
| Verification | `verification` | Verifying effectiveness of action | 14d | QA Manager |
| Closed | `closed` | Issue resolved, NCR complete | N/A | QA Manager |
| Reopened | `reopened` | Reopened for further investigation | 48h | QA Manager |

### State Transitions

```
Draft ----[submit]----> Open
Open ----[start_investigation]----> Investigation
Investigation ----[complete_investigation]----> Root Cause
Root Cause ----[identify_cause]----> Corrective Action
Corrective Action ----[implement_action]----> Verification
Verification ----[verify_effective]----> Closed
Verification ----[verify_ineffective]----> Corrective Action (loop back)
Closed ----[reopen]----> Reopened
Reopened ----[start_investigation]----> Investigation
```

### Transition Authorization

| Transition | From | To | Allowed Roles | Requires Notes |
|------------|------|-----|---------------|----------------|
| submit | draft | open | QA_INSPECTOR, QA_MANAGER, ADMIN | No |
| start_investigation | open | investigation | QA_INSPECTOR, QA_MANAGER | Yes |
| start_investigation | reopened | investigation | QA_INSPECTOR, QA_MANAGER | Yes |
| complete_investigation | investigation | root_cause | QA_INSPECTOR, QA_MANAGER | Yes |
| identify_cause | root_cause | corrective_action | QA_INSPECTOR, QA_MANAGER | Yes |
| implement_action | corrective_action | verification | PROCESS_OWNER, QA_MANAGER | Yes |
| verify_effective | verification | closed | QA_MANAGER only | Yes (50+ chars) |
| verify_ineffective | verification | corrective_action | QA_MANAGER only | Yes (50+ chars) |
| reopen | closed | reopened | QA_MANAGER only | Yes (50+ chars, justification) |

---

## Dependencies

### Cross-Epic Dependencies

| Dependency | Story/Epic | Type | What It Provides | Status |
|------------|------------|------|------------------|--------|
| 01.1 | Org Context + RLS | HARD | organizations, users, roles tables | Ready |
| 01.6 | Role Permissions | HARD | Role-based access control | Ready |

### Within Epic Dependencies

| Dependency | Story | Type | What It Provides |
|------------|-------|------|------------------|
| 06.9 | Basic NCR Creation | HARD | ncr_reports table with basic status |

### Provides To (Downstream)

| Story | What This Provides |
|-------|-------------------|
| 06.14 | NCR Root Cause Analysis - investigation workflow state |
| 06.15 | NCR Corrective Action - corrective_action workflow state |
| 06.16 | NCR Verification & Close - verification workflow state |
| 06.17 | Quality Alerts - notification trigger points |
| 06.31 | CAPA Creation - auto-create CAPA at corrective_action state |

---

## Database Migration

### Migration 1: Extend ncr_reports status

```sql
-- Migration: YYYYMMDDHHMMSS_extend_ncr_reports_workflow.sql

-- =============================================================================
-- Extend ncr_reports with full workflow states (Story 06.13)
-- =============================================================================

-- Step 1: Drop old constraint
ALTER TABLE ncr_reports DROP CONSTRAINT IF EXISTS ncr_reports_status_check;

-- Step 2: Add new constraint with all workflow states
ALTER TABLE ncr_reports
ADD CONSTRAINT ncr_reports_status_check
CHECK (status IN ('draft', 'open', 'investigation', 'root_cause',
                  'corrective_action', 'verification', 'closed', 'reopened'));

-- Step 3: Add workflow tracking columns
ALTER TABLE ncr_reports
ADD COLUMN IF NOT EXISTS current_state_owner UUID REFERENCES users(id),
ADD COLUMN IF NOT EXISTS state_entered_at TIMESTAMPTZ DEFAULT now(),
ADD COLUMN IF NOT EXISTS state_due_at TIMESTAMPTZ,
ADD COLUMN IF NOT EXISTS escalation_level INTEGER DEFAULT 0,
ADD COLUMN IF NOT EXISTS escalated_at TIMESTAMPTZ,
ADD COLUMN IF NOT EXISTS reopen_count INTEGER DEFAULT 0,
ADD COLUMN IF NOT EXISTS last_reopened_at TIMESTAMPTZ,
ADD COLUMN IF NOT EXISTS last_reopened_by UUID REFERENCES users(id),
ADD COLUMN IF NOT EXISTS reopen_reason TEXT;

-- Step 4: Create indexes for workflow queries
CREATE INDEX IF NOT EXISTS idx_ncr_state_owner ON ncr_reports(current_state_owner)
    WHERE current_state_owner IS NOT NULL;
CREATE INDEX IF NOT EXISTS idx_ncr_state_due ON ncr_reports(org_id, state_due_at)
    WHERE state_due_at IS NOT NULL AND status NOT IN ('draft', 'closed');
CREATE INDEX IF NOT EXISTS idx_ncr_escalation ON ncr_reports(org_id, escalation_level)
    WHERE escalation_level > 0;

-- Comments
COMMENT ON COLUMN ncr_reports.status IS 'Full workflow states: draft, open, investigation, root_cause, corrective_action, verification, closed, reopened';
COMMENT ON COLUMN ncr_reports.current_state_owner IS 'User responsible for current state';
COMMENT ON COLUMN ncr_reports.state_entered_at IS 'Timestamp when entered current state';
COMMENT ON COLUMN ncr_reports.state_due_at IS 'SLA due date for current state';
COMMENT ON COLUMN ncr_reports.escalation_level IS 'Current escalation level (0=none, 1=supervisor, 2=manager, 3=director)';
COMMENT ON COLUMN ncr_reports.reopen_count IS 'Number of times NCR has been reopened';
```

### Migration 2: Create ncr_state_transitions configuration table

```sql
-- Migration: YYYYMMDDHHMMSS_create_ncr_state_transitions.sql

-- =============================================================================
-- NCR State Transitions Configuration (Valid Transitions)
-- =============================================================================

CREATE TABLE ncr_state_transitions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,

    -- Transition definition
    transition_code TEXT NOT NULL,
    from_state TEXT NOT NULL CHECK (from_state IN ('draft', 'open', 'investigation', 'root_cause',
                                                    'corrective_action', 'verification', 'closed', 'reopened')),
    to_state TEXT NOT NULL CHECK (to_state IN ('draft', 'open', 'investigation', 'root_cause',
                                                'corrective_action', 'verification', 'closed', 'reopened')),

    -- Authorization
    allowed_roles TEXT[] NOT NULL, -- Array of role codes
    requires_notes BOOLEAN DEFAULT false,
    min_notes_length INTEGER DEFAULT 0,

    -- SLA for target state
    sla_hours INTEGER, -- NULL = no SLA

    -- Auto-assignment
    auto_assign_role TEXT, -- Role code to auto-assign
    auto_assign_user_id UUID REFERENCES users(id), -- Specific user (if set)

    -- Notification
    notify_roles TEXT[], -- Roles to notify on transition
    notify_users UUID[], -- Specific users to notify

    -- Display
    button_label TEXT NOT NULL,
    button_variant TEXT DEFAULT 'default', -- default, primary, destructive, outline
    confirmation_required BOOLEAN DEFAULT false,
    confirmation_message TEXT,

    -- Status
    is_active BOOLEAN DEFAULT true,
    sequence INTEGER DEFAULT 0, -- Display order

    -- Audit
    created_at TIMESTAMPTZ DEFAULT now(),
    updated_at TIMESTAMPTZ DEFAULT now(),

    -- Constraints
    UNIQUE(org_id, transition_code),
    UNIQUE(org_id, from_state, to_state)
);

-- Index for transition lookups
CREATE INDEX idx_ncr_transitions_lookup ON ncr_state_transitions(org_id, from_state, is_active);

-- RLS
ALTER TABLE ncr_state_transitions ENABLE ROW LEVEL SECURITY;

CREATE POLICY "ncr_transitions_select" ON ncr_state_transitions
    FOR SELECT USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

CREATE POLICY "ncr_transitions_admin" ON ncr_state_transitions
    FOR ALL USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
        AND (SELECT r.code FROM roles r JOIN users u ON u.role_id = r.id WHERE u.id = auth.uid()) IN ('SUPER_ADMIN', 'ADMIN')
    );

-- =============================================================================
-- Seed Default Transitions (per org)
-- =============================================================================

-- Function to seed default transitions for an org
CREATE OR REPLACE FUNCTION seed_ncr_transitions(p_org_id UUID)
RETURNS void AS $$
BEGIN
    INSERT INTO ncr_state_transitions (org_id, transition_code, from_state, to_state, allowed_roles, requires_notes, min_notes_length, sla_hours, auto_assign_role, button_label, button_variant, confirmation_required, confirmation_message, sequence)
    VALUES
        -- Draft -> Open (Submit)
        (p_org_id, 'submit', 'draft', 'open', ARRAY['QA_INSPECTOR', 'QA_MANAGER', 'ADMIN'], false, 0, 24, 'QA_MANAGER', 'Submit NCR', 'primary', true, 'Submit this NCR for investigation?', 1),

        -- Open -> Investigation
        (p_org_id, 'start_investigation', 'open', 'investigation', ARRAY['QA_INSPECTOR', 'QA_MANAGER'], true, 20, 48, NULL, 'Start Investigation', 'default', false, NULL, 2),

        -- Reopened -> Investigation
        (p_org_id, 'start_investigation_reopen', 'reopened', 'investigation', ARRAY['QA_INSPECTOR', 'QA_MANAGER'], true, 20, 48, NULL, 'Start Investigation', 'default', false, NULL, 3),

        -- Investigation -> Root Cause
        (p_org_id, 'complete_investigation', 'investigation', 'root_cause', ARRAY['QA_INSPECTOR', 'QA_MANAGER'], true, 50, 72, NULL, 'Complete Investigation', 'default', false, NULL, 4),

        -- Root Cause -> Corrective Action
        (p_org_id, 'identify_cause', 'root_cause', 'corrective_action', ARRAY['QA_INSPECTOR', 'QA_MANAGER'], true, 50, 168, 'PROCESS_OWNER', 'Identify Root Cause', 'default', false, NULL, 5),

        -- Corrective Action -> Verification
        (p_org_id, 'implement_action', 'corrective_action', 'verification', ARRAY['PROCESS_OWNER', 'QA_MANAGER', 'ADMIN'], true, 50, 336, 'QA_MANAGER', 'Implement Corrective Action', 'default', false, NULL, 6),

        -- Verification -> Closed (Effective)
        (p_org_id, 'verify_effective', 'verification', 'closed', ARRAY['QA_MANAGER'], true, 50, NULL, NULL, 'Verify Effective & Close', 'primary', true, 'Confirm corrective action is effective and close this NCR?', 7),

        -- Verification -> Corrective Action (Ineffective - loop back)
        (p_org_id, 'verify_ineffective', 'verification', 'corrective_action', ARRAY['QA_MANAGER'], true, 50, 168, 'PROCESS_OWNER', 'Mark Ineffective', 'destructive', true, 'Corrective action is not effective. Return to corrective action phase?', 8),

        -- Closed -> Reopened
        (p_org_id, 'reopen', 'closed', 'reopened', ARRAY['QA_MANAGER'], true, 50, 48, 'QA_MANAGER', 'Reopen NCR', 'destructive', true, 'Reopen this closed NCR for further investigation?', 9)
    ON CONFLICT (org_id, transition_code) DO NOTHING;
END;
$$ LANGUAGE plpgsql;

COMMENT ON TABLE ncr_state_transitions IS 'Valid NCR workflow transitions configuration per org';
```

### Migration 3: Create ncr_state_history audit table

```sql
-- Migration: YYYYMMDDHHMMSS_create_ncr_state_history.sql

-- =============================================================================
-- NCR State History (Immutable Audit Trail)
-- =============================================================================

CREATE TABLE ncr_state_history (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    ncr_id UUID NOT NULL REFERENCES ncr_reports(id) ON DELETE CASCADE,

    -- Transition
    transition_code TEXT NOT NULL,
    from_state TEXT NOT NULL,
    to_state TEXT NOT NULL,

    -- Actor
    transitioned_by UUID NOT NULL REFERENCES users(id),
    transitioned_at TIMESTAMPTZ NOT NULL DEFAULT now(),

    -- Notes
    transition_notes TEXT,

    -- State metadata at time of transition
    previous_owner UUID REFERENCES users(id),
    new_owner UUID REFERENCES users(id),
    previous_due_at TIMESTAMPTZ,
    new_due_at TIMESTAMPTZ,
    was_overdue BOOLEAN DEFAULT false,

    -- Immutable (no updated_at - records never change)
    created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- Index for history queries
CREATE INDEX idx_ncr_history_ncr ON ncr_state_history(ncr_id, transitioned_at DESC);
CREATE INDEX idx_ncr_history_org ON ncr_state_history(org_id, transitioned_at DESC);
CREATE INDEX idx_ncr_history_user ON ncr_state_history(transitioned_by, transitioned_at DESC);

-- RLS
ALTER TABLE ncr_state_history ENABLE ROW LEVEL SECURITY;

CREATE POLICY "ncr_history_select" ON ncr_state_history
    FOR SELECT USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

-- INSERT only (no UPDATE or DELETE - immutable audit trail)
CREATE POLICY "ncr_history_insert" ON ncr_state_history
    FOR INSERT WITH CHECK (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

-- Explicitly deny UPDATE and DELETE
CREATE POLICY "ncr_history_no_update" ON ncr_state_history
    FOR UPDATE USING (false);

CREATE POLICY "ncr_history_no_delete" ON ncr_state_history
    FOR DELETE USING (false);

COMMENT ON TABLE ncr_state_history IS 'Immutable audit trail for NCR state transitions (FDA 21 CFR Part 11)';
```

---

## Acceptance Criteria (Given/When/Then)

### AC-1: State Transition Validation

```gherkin
Scenario: Valid state transition
  Given NCR exists with status = 'open'
  And transition 'start_investigation' is configured from 'open' to 'investigation'
  When user with allowed role executes transition
  Then NCR status changes to 'investigation'
  And state_entered_at = now()
  And state_due_at calculated based on SLA

Scenario: Invalid state transition (skip step)
  Given NCR exists with status = 'open'
  When user attempts transition to 'root_cause' (skipping investigation)
  Then transition rejected with error "Invalid transition: no path from open to root_cause"
  And NCR status remains 'open'

Scenario: Invalid state transition (wrong direction)
  Given NCR exists with status = 'investigation'
  When user attempts transition back to 'open'
  Then transition rejected with error "Invalid transition: cannot go from investigation to open"
```

### AC-2: Permission-Based Authorization

```gherkin
Scenario: Authorized transition
  Given NCR with status = 'open'
  And user has role QA_INSPECTOR
  And transition 'start_investigation' allows QA_INSPECTOR
  When user executes transition
  Then transition succeeds

Scenario: Unauthorized transition
  Given NCR with status = 'verification'
  And user has role QA_INSPECTOR
  And transition 'verify_effective' allows only QA_MANAGER
  When QA_INSPECTOR attempts transition
  Then transition rejected with error "Permission denied: requires QA_MANAGER role"
  And NCR status remains 'verification'

Scenario: Close requires QA Manager
  Given NCR with status = 'verification'
  When QA_INSPECTOR attempts 'verify_effective' transition
  Then 403 Forbidden returned
  When QA_MANAGER attempts 'verify_effective' transition
  Then transition succeeds and NCR closed
```

### AC-3: Transition Notes Requirement

```gherkin
Scenario: Transition requires notes
  Given transition 'complete_investigation' requires notes (min 50 chars)
  When user submits transition without notes
  Then error "Transition notes required (minimum 50 characters)"

Scenario: Transition notes too short
  Given transition requires min 50 chars
  When user submits transition with 30 char notes
  Then error "Transition notes too short (minimum 50 characters)"

Scenario: Transition with sufficient notes
  Given transition requires min 50 chars
  When user submits transition with 100 char notes
  Then transition succeeds
  And notes stored in ncr_state_history
```

### AC-4: Due Date Calculation

```gherkin
Scenario: SLA due date set on transition
  Given transition to 'investigation' has sla_hours = 48
  When NCR transitions to 'investigation' at 2025-01-15 10:00:00
  Then state_due_at = 2025-01-17 10:00:00 (48 hours later)

Scenario: No SLA (null) means no due date
  Given transition to 'closed' has sla_hours = NULL
  When NCR transitions to 'closed'
  Then state_due_at = NULL

Scenario: Overdue detection
  Given NCR in 'investigation' with state_due_at = yesterday
  When checking NCR status
  Then is_overdue = true
  And escalation_level should be considered
```

### AC-5: Auto-Assignment on Transition

```gherkin
Scenario: Auto-assign to role
  Given transition to 'corrective_action' has auto_assign_role = 'PROCESS_OWNER'
  And org has default PROCESS_OWNER user configured
  When NCR transitions to 'corrective_action'
  Then current_state_owner = PROCESS_OWNER user
  And assigned_to = PROCESS_OWNER user

Scenario: Auto-assign to specific user
  Given transition has auto_assign_user_id = specific_user_uuid
  When NCR transitions
  Then current_state_owner = specific_user_uuid
  And assigned_to = specific_user_uuid

Scenario: No auto-assign keeps current owner
  Given transition has auto_assign_role = NULL and auto_assign_user_id = NULL
  When NCR transitions
  Then current_state_owner unchanged
  And assigned_to unchanged
```

### AC-6: State History (Audit Trail)

```gherkin
Scenario: History record created on transition
  Given NCR transitions from 'open' to 'investigation'
  Then ncr_state_history record created with:
    | Field | Value |
    | ncr_id | NCR UUID |
    | transition_code | start_investigation |
    | from_state | open |
    | to_state | investigation |
    | transitioned_by | current user |
    | transitioned_at | now() |
    | transition_notes | user notes |

Scenario: History is immutable
  Given ncr_state_history record exists
  When attempting to UPDATE or DELETE
  Then operation rejected (RLS policy)
  And record remains unchanged

Scenario: History includes overdue flag
  Given NCR was overdue when transitioning
  Then ncr_state_history.was_overdue = true
```

### AC-7: Reopen Logic

```gherkin
Scenario: Reopen closed NCR
  Given NCR with status = 'closed'
  And user is QA_MANAGER
  When user executes 'reopen' transition
  And provides reopen reason (min 50 chars)
  Then NCR status = 'reopened'
  And reopen_count incremented
  And last_reopened_at = now()
  And last_reopened_by = current user
  And reopen_reason stored

Scenario: Reopen requires justification
  Given 'reopen' transition requires notes (min 50 chars)
  When user attempts reopen without sufficient notes
  Then error "Reopen reason required (minimum 50 characters)"

Scenario: Only QA Manager can reopen
  Given NCR is closed
  And user is QA_INSPECTOR
  When user attempts 'reopen' transition
  Then 403 Forbidden returned
```

### AC-8: Available Transitions Endpoint

```gherkin
Scenario: Get available transitions for open NCR
  Given NCR with status = 'open'
  And user is QA_INSPECTOR
  When GET /api/quality/ncrs/:id/available-transitions
  Then returns:
    - transition_code: start_investigation
    - from_state: open
    - to_state: investigation
    - button_label: Start Investigation
    - requires_notes: true
    - user_can_execute: true

Scenario: Filter by user permissions
  Given NCR with status = 'verification'
  And user is QA_INSPECTOR
  When GET /api/quality/ncrs/:id/available-transitions
  Then returns empty (QA_INSPECTOR cannot execute verification transitions)

Scenario: QA Manager sees all available
  Given NCR with status = 'verification'
  And user is QA_MANAGER
  When GET /api/quality/ncrs/:id/available-transitions
  Then returns:
    - verify_effective (to closed)
    - verify_ineffective (to corrective_action)
```

### AC-9: Workflow History Endpoint

```gherkin
Scenario: Get NCR workflow history
  Given NCR has been transitioned 5 times
  When GET /api/quality/ncrs/:id/workflow
  Then returns array of 5 history records
  And ordered by transitioned_at DESC (newest first)
  And each record includes:
    | Field | Present |
    | transition_code | Yes |
    | from_state | Yes |
    | to_state | Yes |
    | transitioned_by | Yes |
    | transitioned_by_name | Yes |
    | transitioned_at | Yes |
    | transition_notes | Yes |
    | was_overdue | Yes |
```

### AC-10: NCR Status Timeline UI

```gherkin
Scenario: Timeline displays workflow progress
  Given NCR in 'corrective_action' state
  When viewing NCR detail page
  Then vertical timeline stepper shows:
    | State | Status |
    | Draft | completed (green check) |
    | Open | completed (green check) |
    | Investigation | completed (green check) |
    | Root Cause | completed (green check) |
    | Corrective Action | current (highlighted) |
    | Verification | pending (gray) |
    | Closed | pending (gray) |

Scenario: Timeline shows timestamps
  Given NCR has workflow history
  When viewing timeline
  Then each completed step shows:
    - State name
    - Completion date/time
    - Who completed it
    - Time spent in state

Scenario: Timeline indicates overdue
  Given NCR is overdue in current state
  When viewing timeline
  Then current state shows red indicator
  And "Overdue by X hours" displayed
```

### AC-11: State Transition Modal

```gherkin
Scenario: Transition modal opens
  Given NCR has available transition
  When user clicks transition button
  Then modal opens with:
    - Title: transition button_label
    - Current state -> New state display
    - Notes textarea (if required)
    - Character counter (if min length)
    - [Cancel] button
    - [Confirm Transition] button

Scenario: Confirmation required
  Given transition has confirmation_required = true
  When modal displays
  Then confirmation_message shown
  And checkbox "I confirm this transition" required

Scenario: Notes validation in modal
  Given transition requires 50 char notes
  And user enters 30 chars
  When user clicks [Confirm]
  Then inline error "Minimum 50 characters required"
  And button remains disabled until valid
```

### AC-12: Notification Triggers

```gherkin
Scenario: Transition triggers notification
  Given transition has notify_roles = ['QA_MANAGER']
  When transition executed
  Then notification event queued with:
    | Field | Value |
    | type | ncr_state_change |
    | ncr_id | NCR UUID |
    | from_state | previous state |
    | to_state | new state |
    | notify_roles | ['QA_MANAGER'] |
  And (actual sending handled by story 06.17)

Scenario: Critical NCR escalation notification
  Given NCR severity = 'critical'
  And NCR transitions to 'open'
  Then notification event includes escalation flag
  And priority = 'high'
```

### AC-13: RLS Enforcement

```gherkin
Scenario: Cross-tenant history isolation
  Given User A from Org A
  And NCR belongs to Org B
  When User A requests GET /api/quality/ncrs/:id/workflow
  Then 404 Not Found returned

Scenario: Transition config isolation
  Given Org A has custom transitions
  And Org B has default transitions
  When User A views available transitions
  Then only Org A transitions returned
```

---

## API Endpoints

```typescript
// =============================================================================
// NCR Workflow Endpoints (Story 06.13)
// =============================================================================

// POST /api/quality/ncrs/:id/transition
// Execute state transition
interface TransitionNCRRequest {
  transition_code: string;
  notes?: string;
  confirmed?: boolean; // For confirmation_required transitions
}

interface TransitionNCRResponse {
  ncr: NCRReport;
  transition: {
    code: string;
    from_state: string;
    to_state: string;
    transitioned_at: string;
    new_due_at: string | null;
    new_owner_id: string | null;
    new_owner_name: string | null;
  };
}

// GET /api/quality/ncrs/:id/workflow
// Get workflow history
interface NCRWorkflowResponse {
  ncr_id: string;
  ncr_number: string;
  current_state: string;
  state_entered_at: string;
  state_due_at: string | null;
  is_overdue: boolean;
  current_owner_id: string | null;
  current_owner_name: string | null;
  history: NCRStateHistoryEntry[];
}

interface NCRStateHistoryEntry {
  id: string;
  transition_code: string;
  from_state: string;
  to_state: string;
  transitioned_by: string;
  transitioned_by_name: string;
  transitioned_at: string;
  transition_notes: string | null;
  was_overdue: boolean;
  time_in_state_hours: number | null;
}

// GET /api/quality/ncrs/:id/available-transitions
// Get valid transitions for current state
interface AvailableTransitionsResponse {
  current_state: string;
  transitions: AvailableTransition[];
}

interface AvailableTransition {
  transition_code: string;
  from_state: string;
  to_state: string;
  button_label: string;
  button_variant: 'default' | 'primary' | 'destructive' | 'outline';
  requires_notes: boolean;
  min_notes_length: number;
  confirmation_required: boolean;
  confirmation_message: string | null;
  user_can_execute: boolean;
  blocked_reason: string | null; // If user cannot execute, why
  target_sla_hours: number | null;
}
```

---

## Service Layer

```typescript
// lib/services/ncr-workflow-service.ts

export class NCRWorkflowService {
  /**
   * Execute state transition
   */
  static async executeTransition(
    ncrId: string,
    transitionCode: string,
    notes: string | null,
    userId: string
  ): Promise<TransitionResult>;

  /**
   * Get available transitions for NCR
   */
  static async getAvailableTransitions(
    ncrId: string,
    userId: string
  ): Promise<AvailableTransition[]>;

  /**
   * Get workflow history for NCR
   */
  static async getWorkflowHistory(ncrId: string): Promise<NCRStateHistoryEntry[]>;

  /**
   * Validate transition is allowed
   */
  static async validateTransition(
    ncr: NCRReport,
    transition: StateTransition,
    userId: string,
    notes: string | null
  ): Promise<ValidationResult>;

  /**
   * Calculate due date for state
   */
  static calculateDueDate(slaHours: number | null): Date | null;

  /**
   * Determine auto-assign target
   */
  static async resolveAutoAssign(
    transition: StateTransition,
    orgId: string
  ): Promise<string | null>;

  /**
   * Check if NCR is overdue
   */
  static isOverdue(ncr: NCRReport): boolean;

  /**
   * Queue notification for transition
   */
  static async queueTransitionNotification(
    ncr: NCRReport,
    transition: StateTransition,
    actor: User
  ): Promise<void>;

  /**
   * Get transition configuration
   */
  static async getTransitionConfig(
    orgId: string,
    transitionCode: string
  ): Promise<StateTransition | null>;
}

interface TransitionResult {
  success: boolean;
  ncr: NCRReport;
  historyEntry: NCRStateHistoryEntry;
  error?: string;
}

interface ValidationResult {
  valid: boolean;
  errors: string[];
}
```

---

## Frontend Components

```
apps/frontend/app/(authenticated)/quality/
  ncrs/
    [id]/
      page.tsx                         -- NCR detail (add workflow integration)
      workflow/
        page.tsx                       -- Full workflow history page

components/quality/ncrs/
  NCRWorkflowTimeline.tsx              -- Vertical stepper showing states
  NCRWorkflowProgress.tsx              -- Compact progress bar
  NCRTransitionModal.tsx               -- Modal to execute transition
  NCRTransitionButton.tsx              -- Button that opens transition modal
  NCRAvailableTransitions.tsx          -- List of available transition buttons
  NCRWorkflowHistory.tsx               -- Table of history entries
  NCRStateHistoryCard.tsx              -- Card for single history entry
  NCROverdueIndicator.tsx              -- Badge/indicator for overdue state
  NCRStateBadge.tsx                    -- Badge for workflow state (extends StatusBadge)
```

### NCRWorkflowTimeline.tsx

Vertical stepper component showing workflow progress:
- All states listed vertically
- Completed states: green check, timestamp, actor
- Current state: highlighted, due date, time remaining
- Future states: grayed out
- Overdue indicator: red border, "Overdue by X hours"

### NCRTransitionModal.tsx

Modal for executing transitions:
- Title: transition button_label
- Current state -> Target state visual
- Notes textarea (with character counter if min required)
- Confirmation checkbox (if confirmation_required)
- [Cancel] and [Confirm Transition] buttons
- Loading state during submission
- Error display inline

---

## UI Styling

```typescript
// State colors
const stateColors = {
  draft: 'bg-gray-100 text-gray-800 border-gray-300',
  open: 'bg-blue-100 text-blue-800 border-blue-300',
  investigation: 'bg-purple-100 text-purple-800 border-purple-300',
  root_cause: 'bg-indigo-100 text-indigo-800 border-indigo-300',
  corrective_action: 'bg-orange-100 text-orange-800 border-orange-300',
  verification: 'bg-yellow-100 text-yellow-800 border-yellow-300',
  closed: 'bg-green-100 text-green-800 border-green-300',
  reopened: 'bg-red-100 text-red-800 border-red-300',
};

// Timeline step status
const stepStatus = {
  completed: 'border-green-500 bg-green-50',
  current: 'border-blue-500 bg-blue-50 ring-2 ring-blue-500',
  pending: 'border-gray-300 bg-gray-50',
  overdue: 'border-red-500 bg-red-50 ring-2 ring-red-500',
};
```

---

## Test Cases

### Unit Tests

```typescript
describe('NCRWorkflowService', () => {
  describe('executeTransition', () => {
    it('transitions from open to investigation', async () => {});
    it('rejects invalid transition (skip step)', async () => {});
    it('rejects unauthorized transition', async () => {});
    it('validates notes requirement', async () => {});
    it('calculates due date correctly', async () => {});
    it('auto-assigns owner', async () => {});
    it('creates history record', async () => {});
    it('increments reopen_count on reopen', async () => {});
  });

  describe('getAvailableTransitions', () => {
    it('returns valid transitions for state', async () => {});
    it('filters by user role', async () => {});
    it('marks user_can_execute correctly', async () => {});
    it('returns empty for terminal state (closed)', async () => {});
  });

  describe('validateTransition', () => {
    it('validates from_state matches', async () => {});
    it('validates user role allowed', async () => {});
    it('validates notes length', async () => {});
    it('returns all errors', async () => {});
  });

  describe('isOverdue', () => {
    it('returns true if past due date', async () => {});
    it('returns false if no due date', async () => {});
    it('returns false if before due date', async () => {});
  });
});
```

### Integration Tests

```typescript
describe('NCR Workflow API', () => {
  describe('POST /api/quality/ncrs/:id/transition', () => {
    it('executes valid transition', async () => {});
    it('returns 400 for invalid transition', async () => {});
    it('returns 403 for unauthorized role', async () => {});
    it('returns 400 for missing notes', async () => {});
    it('returns 404 for other org NCR', async () => {});
    it('creates history record', async () => {});
  });

  describe('GET /api/quality/ncrs/:id/available-transitions', () => {
    it('returns transitions for current state', async () => {});
    it('respects user role permissions', async () => {});
    it('returns empty for terminal state', async () => {});
  });

  describe('GET /api/quality/ncrs/:id/workflow', () => {
    it('returns workflow history', async () => {});
    it('orders by transitioned_at DESC', async () => {});
    it('includes time_in_state calculation', async () => {});
  });
});
```

### E2E Tests

```typescript
describe('NCR Workflow E2E', () => {
  it('complete workflow: open -> investigation -> root_cause -> corrective_action -> verification -> closed', async () => {
    // 1. Login as QA Inspector
    // 2. Open existing NCR in 'open' state
    // 3. Click 'Start Investigation'
    // 4. Fill notes, confirm transition
    // 5. Verify status = 'investigation'
    // 6. Complete investigation, identify cause
    // 7. Switch to QA Manager
    // 8. Verify effectiveness
    // 9. Close NCR
    // 10. Verify timeline shows all steps
  });

  it('reopen workflow: closed -> reopened -> investigation', async () => {
    // 1. Login as QA Manager
    // 2. Open closed NCR
    // 3. Click 'Reopen NCR'
    // 4. Fill justification notes
    // 5. Confirm
    // 6. Verify status = 'reopened'
    // 7. Verify reopen_count incremented
    // 8. Start investigation
    // 9. Verify can proceed through workflow
  });

  it('timeline displays workflow progress', async () => {
    // 1. Open NCR in 'corrective_action' state
    // 2. Verify timeline stepper
    // 3. First 4 states have green checks
    // 4. Current state highlighted
    // 5. Last 2 states grayed
  });
});
```

---

## Deliverables

### Database
- [ ] Migration: Extend `ncr_reports.status` CHECK constraint
- [ ] Migration: Add workflow columns to `ncr_reports`
- [ ] Migration: Create `ncr_state_transitions` table
- [ ] Migration: Create `ncr_state_history` table
- [ ] Function: `seed_ncr_transitions(org_id)` for default config
- [ ] RLS policies for all new tables
- [ ] All performance indexes

### API Routes
- [ ] `POST /api/quality/ncrs/:id/transition` - Execute transition
- [ ] `GET /api/quality/ncrs/:id/workflow` - Get workflow history
- [ ] `GET /api/quality/ncrs/:id/available-transitions` - Get valid transitions

### Service Layer
- [ ] `NCRWorkflowService.executeTransition()`
- [ ] `NCRWorkflowService.getAvailableTransitions()`
- [ ] `NCRWorkflowService.getWorkflowHistory()`
- [ ] `NCRWorkflowService.validateTransition()`
- [ ] `NCRWorkflowService.calculateDueDate()`
- [ ] `NCRWorkflowService.resolveAutoAssign()`
- [ ] `NCRWorkflowService.isOverdue()`
- [ ] `NCRWorkflowService.queueTransitionNotification()`

### Validation
- [ ] `transitionNCRSchema` - transition request validation
- [ ] `availableTransitionsQuerySchema`
- [ ] `workflowQuerySchema`

### Frontend
- [ ] NCRWorkflowTimeline component (vertical stepper)
- [ ] NCRTransitionModal component
- [ ] NCRTransitionButton component
- [ ] NCRAvailableTransitions component
- [ ] NCRWorkflowHistory component
- [ ] NCROverdueIndicator component
- [ ] NCRStateBadge component (extended)
- [ ] Integration in NCR detail page
- [ ] Hooks: useNCRWorkflow, useNCRTransitions

### Tests
- [ ] Unit tests: NCRWorkflowService (>80% coverage)
- [ ] Integration tests: All 3 workflow endpoints
- [ ] RLS tests: Multi-tenancy isolation
- [ ] Permission tests: Role-based transition authorization
- [ ] E2E: Complete workflow journey

---

## Definition of Done

### Database
- [ ] All migrations applied successfully
- [ ] `ncr_state_transitions` seeded with default config per org
- [ ] `ncr_state_history` enforces immutability (no UPDATE/DELETE)
- [ ] RLS policies enforce org isolation
- [ ] Performance indexes created

### API
- [ ] POST transition endpoint validates and executes correctly
- [ ] GET available-transitions filters by user role
- [ ] GET workflow returns ordered history
- [ ] All endpoints return correct HTTP status codes
- [ ] Response times < 500ms

### Service
- [ ] State machine validates transitions correctly
- [ ] Cannot skip states in workflow
- [ ] Due dates calculated from SLA config
- [ ] Auto-assignment works
- [ ] History records immutable
- [ ] Reopen logic works with count tracking

### Frontend
- [ ] Workflow timeline displays correctly
- [ ] Transition modal validates and submits
- [ ] Available transitions show for current state
- [ ] Overdue indicator displays when applicable
- [ ] State badges have correct colors

### Testing
- [ ] Unit tests: >80% coverage on workflow service
- [ ] Integration tests: All endpoints covered
- [ ] E2E: Full workflow (open -> closed) passing
- [ ] E2E: Reopen flow passing
- [ ] Permission tests: Role restrictions enforced

---

## Risk Assessment

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Complex state machine logic | HIGH | MEDIUM | Comprehensive validation, unit tests |
| Permission edge cases | MEDIUM | MEDIUM | Clear transition config, role checks |
| History immutability bypass | HIGH | LOW | RLS + no UPDATE/DELETE policies |
| Due date timezone issues | MEDIUM | MEDIUM | Store UTC, display local |
| Auto-assign user not found | MEDIUM | LOW | Fallback to null, log warning |
| Migration order dependency | MEDIUM | LOW | Explicit migration sequencing |

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-01-15 | Initial story creation - NCR Workflow State Machine | ARCHITECT-AGENT |

---

**Document Status**: Ready for Implementation
**Created**: 2025-01-15
**Lines**: ~1200
**Complexity**: L (Large)
**Phase**: 2B (In-Process & Final)
