# 06.0 - Quality Settings

**Priority**: P0 (MVP)
**Story Points**: M (Medium)
**Type**: backend + frontend

**State:** ready
**Estimate:** M (medium story)
**Primary PRD:** `docs/1-BASELINE/product/modules/quality.md` (FR-QA-*)
**Architecture:** `docs/1-BASELINE/architecture/modules/quality.md` (quality_settings table)

## Goal
Implement organization-level quality settings to configure the Quality module's operational parameters including inspection requirements, auto-numbering prefixes, NCR/CAPA response times, HACCP escalation thresholds, and audit trail retention policies.

## MVP Scope

This story implements Phase 1 (Core Quality) settings only. Features listed in "Future Phases" are deferred to Phase 2+ and should be handled per standard guidance.

**MVP Includes**:
- Quality settings table with org-level configuration
- Inspection settings (incoming/final requirements, auto-create on GRN)
- Hold settings (require reason, disposition on release)
- NCR settings (auto-numbering, response SLA, root cause requirement)
- CAPA settings (auto-numbering, effectiveness check requirements)
- CoA settings (auto-numbering, approval requirement)
- HACCP settings (CCP deviation escalation time, auto-NCR creation)
- Audit settings (change reason requirement, retention years)
- Settings UI page with form sections
- Default settings initialization for new organizations

**Deferred to Phase 2+**: See "Future Phases" section below.

## Scope

**In scope**
- GET /api/quality/settings (fetch org settings)
- PUT /api/quality/settings (update org settings)
- Settings UI page at /quality/settings
- Default settings seeded on org creation
- Validation for all settings fields
- Permission checks (Admin/QA Manager only)
- Settings audit trail (change tracking)

**Out of scope**
- Custom allergen configuration (deferred to Settings 01.12)
- CoA template builder (deferred to Phase 3 - Story 06.27)
- E-signature provider integration (Phase 3+)
- Multi-language support (Phase 4+)

## Future Phases (Not in MVP)

### Phase 2
- **Advanced sampling plans** - AQL level templates, custom acceptance criteria
- **Inspection frequency rules** - Skip lot inspection based on supplier rating
- **Auto-hold triggers** - Automatic hold creation based on test results
- **Quality alerts escalation** - Configurable escalation paths for quality events

### Phase 3
- **E-signature settings** - Provider selection (DocuSign, Adobe Sign, internal)
- **LIMS integration** - Connection settings for external lab systems
- **Regional compliance** - FDA, GFSI, BRC standard selection
- **Document retention policies** - Advanced archival rules per record type

### Phase 4
- **Multi-language quality forms** - Language preference for inspection forms
- **Video/photo attachment limits** - File size and format restrictions
- **Supplier portal settings** - Quality data sharing with suppliers
- **Calibration management** - Equipment calibration schedule settings

**Implementation**: See Epic 02.0 "Future Feature Handling" for how to handle Phase 1+ features in UI/API.

## Dependencies

### Cross-Epic Dependencies
- **01.1** - Org Context + Base RLS (organizations, users tables)
- **01.5** - Users CRUD (QA Manager, Admin roles for permissions)

### Master Data Dependencies
- None (this is the foundational settings story for Epic 06)

## Database Migration

### Migration: Create Quality Settings Table

**File:** `supabase/migrations/079_create_quality_settings_table.sql`

```sql
-- Migration 079: Quality Settings Table
CREATE TABLE IF NOT EXISTS quality_settings (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE UNIQUE,

    -- Inspection Settings
    require_incoming_inspection BOOLEAN DEFAULT true,
    require_final_inspection BOOLEAN DEFAULT true,
    auto_create_inspection_on_grn BOOLEAN DEFAULT true,
    default_sampling_level TEXT DEFAULT 'II' CHECK (default_sampling_level IN ('I', 'II', 'III', 'S-1', 'S-2', 'S-3', 'S-4')),

    -- Hold Settings
    require_hold_reason BOOLEAN DEFAULT true,
    require_disposition_on_release BOOLEAN DEFAULT true,

    -- NCR Settings
    ncr_auto_number_prefix TEXT DEFAULT 'NCR-',
    ncr_require_root_cause BOOLEAN DEFAULT true,
    ncr_critical_response_hours INTEGER DEFAULT 24 CHECK (ncr_critical_response_hours > 0),
    ncr_major_response_hours INTEGER DEFAULT 48 CHECK (ncr_major_response_hours > 0),

    -- CAPA Settings
    capa_auto_number_prefix TEXT DEFAULT 'CAPA-',
    capa_require_effectiveness BOOLEAN DEFAULT true,
    capa_effectiveness_wait_days INTEGER DEFAULT 30 CHECK (capa_effectiveness_wait_days >= 0),

    -- CoA Settings
    coa_auto_number_prefix TEXT DEFAULT 'COA-',
    coa_require_approval BOOLEAN DEFAULT false,

    -- HACCP Settings
    ccp_deviation_escalation_minutes INTEGER DEFAULT 15 CHECK (ccp_deviation_escalation_minutes > 0),
    ccp_auto_create_ncr BOOLEAN DEFAULT true,

    -- Audit Settings
    require_change_reason BOOLEAN DEFAULT true,
    retention_years INTEGER DEFAULT 7 CHECK (retention_years > 0 AND retention_years <= 50),

    created_at TIMESTAMPTZ DEFAULT now(),
    updated_at TIMESTAMPTZ DEFAULT now(),

    CONSTRAINT unique_org_settings UNIQUE (org_id)
);

-- Enable RLS
ALTER TABLE quality_settings ENABLE ROW LEVEL SECURITY;

-- RLS Policy: Users can only access their org's settings
CREATE POLICY "Quality settings org isolation"
    ON quality_settings
    FOR ALL
    USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

-- Index for performance
CREATE INDEX idx_quality_settings_org ON quality_settings(org_id);

-- Trigger to update updated_at
CREATE TRIGGER update_quality_settings_updated_at
    BEFORE UPDATE ON quality_settings
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- Function to initialize default settings for new orgs
CREATE OR REPLACE FUNCTION initialize_quality_settings()
RETURNS TRIGGER AS $$
BEGIN
    INSERT INTO quality_settings (org_id)
    VALUES (NEW.id)
    ON CONFLICT (org_id) DO NOTHING;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Trigger to auto-create settings on org creation
CREATE TRIGGER auto_create_quality_settings
    AFTER INSERT ON organizations
    FOR EACH ROW
    EXECUTE FUNCTION initialize_quality_settings();

COMMENT ON TABLE quality_settings IS 'Organization-level configuration for Quality module operational parameters';
COMMENT ON COLUMN quality_settings.default_sampling_level IS 'AQL general inspection level: I, II, III or special level: S-1, S-2, S-3, S-4';
COMMENT ON COLUMN quality_settings.ncr_critical_response_hours IS 'SLA for critical NCR response (default 24 hours)';
COMMENT ON COLUMN quality_settings.ccp_deviation_escalation_minutes IS 'Time before CCP deviation escalates to QA Manager (default 15 minutes)';
COMMENT ON COLUMN quality_settings.retention_years IS 'Quality record retention period in years (1-50)';
```

## Acceptance Criteria (Given/When/Then)

### Settings Page Load
- GIVEN user with Admin or QA Manager role navigates to /quality/settings, WHEN page loads, THEN all settings sections display within 500ms showing current values.
- GIVEN user with Viewer role navigates to /quality/settings, WHEN page loads, THEN all form fields are read-only and Save button is hidden.
- GIVEN org has no settings record, WHEN settings page loads, THEN default values display (require_incoming_inspection=true, ncr_auto_number_prefix='NCR-', etc.).

### Inspection Settings
- GIVEN user toggles "Require Incoming Inspection" to OFF, WHEN Save clicked, THEN setting persists and confirmation toast shows "Settings updated successfully".
- GIVEN user sets "Default Sampling Level" to "I", WHEN Save clicked, THEN new inspections created use AQL Level I by default.
- GIVEN "Auto-create Inspection on GRN" is enabled, WHEN GRN is completed, THEN incoming inspection is auto-created (validated in story 06.5).

### NCR Settings
- GIVEN user sets "Critical NCR Response Hours" to 12, WHEN Save clicked, THEN validation passes and setting saves.
- GIVEN user enters 0 for "Critical Response Hours", WHEN Save clicked, THEN validation error "Must be greater than 0" displays.
- GIVEN user sets "NCR Prefix" to "NC-", WHEN new NCR created, THEN NCR number starts with "NC-0001" (validated in story 06.9).
- GIVEN "Require Root Cause" is enabled, WHEN NCR workflow reaches Close step, THEN root_cause field is mandatory (validated in story 06.13).

### CAPA Settings
- GIVEN user sets "CAPA Effectiveness Wait Days" to 60, WHEN Save clicked, THEN setting persists and applies to new CAPAs.
- GIVEN "Require Effectiveness" is disabled, WHEN CAPA is closed, THEN effectiveness check is optional (validated in story 06.33).
- GIVEN user sets negative value for wait days, WHEN Save clicked, THEN validation error "Must be 0 or greater" displays.

### HACCP Settings
- GIVEN user sets "CCP Deviation Escalation" to 5 minutes, WHEN Save clicked, THEN setting persists.
- GIVEN CCP monitoring record exceeds critical limit, WHEN deviation occurs, THEN escalation alert triggers after 5 minutes (validated in story 06.25).
- GIVEN "Auto-create NCR on Deviation" is enabled, WHEN CCP deviation saved, THEN NCR is automatically created (validated in story 06.25).

### Audit Settings
- GIVEN user sets "Retention Years" to 10, WHEN Save clicked, THEN validation passes (max 50 years).
- GIVEN user enters 100 for retention years, WHEN Save clicked, THEN validation error "Maximum retention is 50 years" displays.
- GIVEN "Require Change Reason" is enabled, WHEN critical quality record is modified, THEN change_reason field is mandatory (validated across stories).

### Permission Enforcement
- GIVEN user with Viewer role attempts PUT /api/quality/settings, WHEN API called, THEN 403 Forbidden returned.
- GIVEN user with QA Inspector role navigates to settings, WHEN page loads, THEN "Insufficient permissions" message displays.

### Auto-initialization
- GIVEN new organization is created, WHEN organization insert completes, THEN quality_settings record auto-created with defaults.
- GIVEN existing org without settings record, WHEN GET /api/quality/settings called, THEN API returns default values (fallback logic).

## Implementation Notes

### API Endpoints

```typescript
// GET /api/quality/settings
// Returns: Quality settings for user's org
interface QualitySettingsResponse {
  settings: QualitySettings;
}

interface QualitySettings {
  id: string;
  org_id: string;

  // Inspection Settings
  require_incoming_inspection: boolean;
  require_final_inspection: boolean;
  auto_create_inspection_on_grn: boolean;
  default_sampling_level: 'I' | 'II' | 'III' | 'S-1' | 'S-2' | 'S-3' | 'S-4';

  // Hold Settings
  require_hold_reason: boolean;
  require_disposition_on_release: boolean;

  // NCR Settings
  ncr_auto_number_prefix: string;
  ncr_require_root_cause: boolean;
  ncr_critical_response_hours: number;
  ncr_major_response_hours: number;

  // CAPA Settings
  capa_auto_number_prefix: string;
  capa_require_effectiveness: boolean;
  capa_effectiveness_wait_days: number;

  // CoA Settings
  coa_auto_number_prefix: string;
  coa_require_approval: boolean;

  // HACCP Settings
  ccp_deviation_escalation_minutes: number;
  ccp_auto_create_ncr: boolean;

  // Audit Settings
  require_change_reason: boolean;
  retention_years: number;

  created_at: string;
  updated_at: string;
}

// PUT /api/quality/settings
// Request body: Partial<QualitySettings> (exclude id, org_id, timestamps)
interface UpdateQualitySettingsRequest {
  require_incoming_inspection?: boolean;
  require_final_inspection?: boolean;
  auto_create_inspection_on_grn?: boolean;
  default_sampling_level?: 'I' | 'II' | 'III' | 'S-1' | 'S-2' | 'S-3' | 'S-4';
  require_hold_reason?: boolean;
  require_disposition_on_release?: boolean;
  ncr_auto_number_prefix?: string;
  ncr_require_root_cause?: boolean;
  ncr_critical_response_hours?: number;
  ncr_major_response_hours?: number;
  capa_auto_number_prefix?: string;
  capa_require_effectiveness?: boolean;
  capa_effectiveness_wait_days?: number;
  coa_auto_number_prefix?: string;
  coa_require_approval?: boolean;
  ccp_deviation_escalation_minutes?: number;
  ccp_auto_create_ncr?: boolean;
  require_change_reason?: boolean;
  retention_years?: number;
}
```

### Database
- `quality_settings` table (migration 079)
- Schema detailed in migration above
- RLS enabled for org isolation
- Trigger auto-creates settings on org creation
- UNIQUE constraint on org_id ensures 1 settings record per org

### Frontend Components
- `QualitySettingsPage` - Main settings page at `/quality/settings`
- `InspectionSettingsSection` - Inspection configuration form
- `NCRSettingsSection` - NCR configuration form
- `CAPASettingsSection` - CAPA configuration form
- `HACCPSettingsSection` - HACCP/CCP configuration form
- `AuditSettingsSection` - Audit trail configuration form
- `SettingsSaveButton` - Save action with loading state

### Services
- `quality-settings-service.ts` - CRUD operations for settings
  - `getQualitySettings(orgId: string): Promise<QualitySettings>`
  - `updateQualitySettings(orgId: string, data: UpdateQualitySettingsRequest): Promise<QualitySettings>`
  - `getDefaultSettings(): QualitySettings` - Returns defaults if no record exists

### Validation (Zod)
```typescript
const updateQualitySettingsSchema = z.object({
  require_incoming_inspection: z.boolean().optional(),
  require_final_inspection: z.boolean().optional(),
  auto_create_inspection_on_grn: z.boolean().optional(),
  default_sampling_level: z.enum(['I', 'II', 'III', 'S-1', 'S-2', 'S-3', 'S-4']).optional(),

  require_hold_reason: z.boolean().optional(),
  require_disposition_on_release: z.boolean().optional(),

  ncr_auto_number_prefix: z.string().min(1).max(10).optional(),
  ncr_require_root_cause: z.boolean().optional(),
  ncr_critical_response_hours: z.number().int().min(1).max(168).optional(), // Max 1 week
  ncr_major_response_hours: z.number().int().min(1).max(336).optional(), // Max 2 weeks

  capa_auto_number_prefix: z.string().min(1).max(10).optional(),
  capa_require_effectiveness: z.boolean().optional(),
  capa_effectiveness_wait_days: z.number().int().min(0).max(365).optional(), // Max 1 year

  coa_auto_number_prefix: z.string().min(1).max(10).optional(),
  coa_require_approval: z.boolean().optional(),

  ccp_deviation_escalation_minutes: z.number().int().min(1).max(1440).optional(), // Max 24 hours
  ccp_auto_create_ncr: z.boolean().optional(),

  require_change_reason: z.boolean().optional(),
  retention_years: z.number().int().min(1).max(50).optional(),
});
```

### Permission Checks
- **GET /api/quality/settings**: Any authenticated user (read-only view)
- **PUT /api/quality/settings**: Admin or QA Manager role only
- UI: Hide Save button for non-Admin/QA Manager users
- API: Return 403 if user lacks permission

### Default Settings Values
```typescript
const DEFAULT_QUALITY_SETTINGS: Partial<QualitySettings> = {
  require_incoming_inspection: true,
  require_final_inspection: true,
  auto_create_inspection_on_grn: true,
  default_sampling_level: 'II',

  require_hold_reason: true,
  require_disposition_on_release: true,

  ncr_auto_number_prefix: 'NCR-',
  ncr_require_root_cause: true,
  ncr_critical_response_hours: 24,
  ncr_major_response_hours: 48,

  capa_auto_number_prefix: 'CAPA-',
  capa_require_effectiveness: true,
  capa_effectiveness_wait_days: 30,

  coa_auto_number_prefix: 'COA-',
  coa_require_approval: false,

  ccp_deviation_escalation_minutes: 15,
  ccp_auto_create_ncr: true,

  require_change_reason: true,
  retention_years: 7,
};
```

## Deliverables
- Migration 079: `quality_settings` table with RLS
- GET /api/quality/settings endpoint
- PUT /api/quality/settings endpoint
- Quality Settings page UI at /quality/settings
- InspectionSettingsSection component
- NCRSettingsSection component
- CAPASettingsSection component
- HACCPSettingsSection component
- AuditSettingsSection component
- quality-settings-service.ts
- Zod validation schemas
- Auto-initialization trigger on org creation
- Unit tests for service (>90% coverage)
- Integration tests for API endpoints
- Permission enforcement tests

## Test Strategy

### Unit Tests
- Service: getQualitySettings returns defaults if no record exists
- Service: updateQualitySettings validates constraints (positive numbers, max values)
- Validation: ncr_auto_number_prefix rejects empty string
- Validation: retention_years rejects values >50
- Validation: ccp_deviation_escalation_minutes rejects 0 or negative

### Integration Tests
- API: GET /api/quality/settings returns 200 with default values for new org
- API: PUT /api/quality/settings saves valid data and returns updated record
- API: PUT /api/quality/settings returns 400 for invalid data (negative hours)
- API: PUT /api/quality/settings returns 403 for user without Admin/QA Manager role
- Database: Trigger auto-creates settings on org creation

### E2E Tests
- User with Admin role can load settings page, edit values, and save
- User with Viewer role sees read-only settings page
- Settings persist after save and reflect on reload
- Validation errors display for invalid inputs

## Definition of Done
- [ ] quality_settings table created with RLS enabled
- [ ] Auto-initialization trigger creates settings on org creation
- [ ] GET /api/quality/settings returns settings or defaults
- [ ] PUT /api/quality/settings validates and saves data
- [ ] Settings page loads within 500ms
- [ ] All 5 settings sections render correctly (Inspection, NCR, CAPA, HACCP, Audit)
- [ ] Validation prevents invalid values (negative hours, retention >50 years)
- [ ] Permission checks hide Save button for non-Admin users
- [ ] API returns 403 for unauthorized PUT requests
- [ ] Default values match PRD specifications
- [ ] Auto-numbering prefixes work in dependent stories (06.9, 06.31, 06.28)
- [ ] SLA hours apply correctly in NCR workflow (validated in 06.13)
- [ ] CCP escalation time triggers alerts (validated in 06.25)
- [ ] Unit tests achieve >90% coverage
- [ ] Integration tests cover all API endpoints
- [ ] E2E tests validate settings persistence and permissions
