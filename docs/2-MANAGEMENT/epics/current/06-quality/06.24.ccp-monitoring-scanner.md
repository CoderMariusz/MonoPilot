# 06.24 - CCP Monitoring Scanner

**Priority**: P0 (MVP)
**Story Points**: L (Large)
**Type**: frontend (mobile)
**Phase**: 3 (HACCP)
**Model**: OPUS

**State:** ready
**Estimate:** L (4-5 days)
**Primary PRD:** `docs/1-BASELINE/product/modules/quality.md` (FR-QA-014, Section 6.2)

---

## Goal

Implement mobile CCP monitoring for shop floor operators using barcode scanners. This enables hands-free, fast CCP data entry on production lines with large touch targets (48px+), offline mode (50 records), and audio feedback on deviation. Mobile CCP monitoring integrates with desktop monitoring (story 06.23) using the same `haccp_ccp_monitoring` table.

---

## Food Safety Compliance

This story is **CRITICAL for shop floor food safety**:

- [x] **HACCP Compliance** - Mobile CCP monitoring for real-time production floor recording
- [x] **FDA 21 CFR Part 11** - Electronic signatures via user authentication
- [x] **Offline Mode** - Record up to 50 monitoring entries offline, sync on reconnect
- [x] **Audio Feedback** - Immediate audio alert on deviation (<1s)

**Regulatory Context:**
- HACCP monitoring must be performed at point of production (shop floor)
- Operators need hands-free, fast data entry during production
- Offline capability ensures no monitoring gaps due to WiFi issues
- Audio feedback ensures operator awareness of deviations

---

## MVP Scope

**MVP Includes**:
- Mobile-optimized CCP monitoring page (same table as desktop)
- Barcode scan: WO number (auto-load WO context)
- CCP selection dropdown (large touch targets 48px+)
- Monitoring value input (numeric keypad, large input field)
- Real-time validation indicator (pass/fail/marginal with colors and audio)
- Offline mode: cache 50 monitoring records, sync on reconnect
- Audio feedback: beep on pass, alarm on fail
- Simplified corrective action (predefined templates + text input)
- Integration with desktop monitoring (shared table)
- QR code generation for CCP quick access

**Deferred to Phase 3+**:
- Voice-to-text monitoring entry
- Photo capture for visual deviations
- NFC tag scanning for equipment
- GPS coordinates for monitoring location
- Multi-language support

---

## User Story

As a **Production Operator**, I want to **scan WO barcodes and quickly record CCP values on my mobile device** so that **I can monitor CCPs hands-free during production without slowing down the line**.

As a **QA Inspector**, I want to **review mobile CCP monitoring records** so that **I can verify operators are monitoring CCPs correctly on the production floor**.

---

## Acceptance Criteria (Condensed - See Full Story for All 17 ACs)

### AC-1: Mobile CCP Monitoring Page
```gherkin
Given production operator with mobile device
When navigating to /quality/haccp/ccp-monitoring/mobile
Then page displays:
  - Large WO barcode scan button
  - CCP dropdown (48px+ touch targets)
  - Monitoring value input (large numeric keypad)
  - Real-time validation indicator
  - Submit button (48px+ height)
And page optimized for mobile (portrait orientation)
```

### AC-2: Barcode Scan WO
```gherkin
Given mobile monitoring page open
When operator scans WO barcode (WO-123)
Then WO-123 loaded with product, batch, routing
And CCP dropdown filtered to CCPs for this routing
And WO number displayed in header
```

### AC-3: Offline Mode - Record Monitoring
```gherkin
Given operator offline (no WiFi)
When recording CCP monitoring value
Then record saved to IndexedDB (local storage)
And success toast "Saved offline (1/50)"
And offline indicator shown
```

### AC-4: Offline Mode - Sync on Reconnect
```gherkin
Given 12 monitoring records saved offline
When device reconnects to WiFi
Then auto-sync triggered
And all 12 records POST to API
And success toast "Synced 12 records"
And local storage cleared
```

### AC-5: Audio Feedback - Pass
```gherkin
Given operator enters value within limits
When validation shows PASS
Then audio beep (1 second, 500Hz)
And vibration (if supported)
```

### AC-6: Audio Feedback - Fail
```gherkin
Given operator enters value outside limits
When validation shows FAIL
Then audio alarm (3 beeps, 1kHz, urgent)
And vibration pattern (3 short bursts)
And full-screen red warning
```

### AC-7: Simplified Corrective Action Templates
```gherkin
Given monitoring result = fail
When corrective action field appears
Then show quick-select templates:
  - "Adjusted temperature"
  - "Rejected batch"
  - "Recalibrated equipment"
  - "Notified QA"
  - Custom (text input)
And operator selects template or enters custom
```

### AC-8: Large Touch Targets
```gherkin
Given mobile monitoring form
Then all interactive elements >= 48px:
  - Buttons
  - Dropdown options
  - Input fields
  - Checkboxes
And spacing >= 8px between targets
```

### AC-9: QR Code for CCP Quick Access
```gherkin
Given CCP-1 (Receiving Temperature)
When QA Manager generates QR code for CCP-1
Then QR code contains: /quality/haccp/ccp-monitoring/mobile?ccp=CCP-1
And operator scanning QR auto-selects CCP-1
And reduces data entry time
```

---

## Key Business Rules

1. **Same Table as Desktop**: Uses `haccp_ccp_monitoring` table (story 06.23)
2. **Offline Queue Limit**: Max 50 records offline, then block until sync
3. **Audio Feedback Mandatory**: Pass=beep, Fail=alarm (user cannot disable)
4. **Touch Target Minimum**: All interactive elements >= 48px (accessibility)
5. **Auto-Sync on Reconnect**: Offline records automatically sync when WiFi restored
6. **Simplified Corrective Actions**: Predefined templates for fast entry on fail
7. **WO Barcode Required**: Must scan WO first (establishes context)
8. **Vibration Feedback**: Use device vibration for tactile alerts
9. **Portrait Orientation Optimized**: Mobile UI designed for one-handed use
10. **Integration with Desktop**: Mobile records visible in desktop monitoring history

---

## Deliverables

### Frontend
- [ ] Mobile CCP monitoring page (/quality/haccp/ccp-monitoring/mobile)
- [ ] Barcode scanner integration (camera API)
- [ ] Offline storage (IndexedDB with Dexie.js)
- [ ] Auto-sync service worker
- [ ] Audio feedback (Web Audio API)
- [ ] Vibration feedback (Vibration API)
- [ ] Large touch targets (48px+ buttons/inputs)
- [ ] QR code generator for CCPs
- [ ] Corrective action template selector
- [ ] Real-time validation indicator (mobile)

### Tests
- [ ] E2E: Scan WO -> Select CCP -> Enter value -> Pass -> Submit
- [ ] E2E: Offline mode - record 5 entries -> reconnect -> sync
- [ ] E2E: Audio feedback on pass/fail
- [ ] Unit: Offline sync logic
- [ ] Unit: Validation with audio/vibration triggers

---

## Definition of Done

### Frontend
- [ ] Mobile page responsive (portrait orientation)
- [ ] Barcode scanner works (camera access)
- [ ] Offline mode works (50 records limit)
- [ ] Auto-sync on reconnect works
- [ ] Audio feedback plays on pass/fail
- [ ] Vibration works on supported devices
- [ ] Touch targets >= 48px
- [ ] QR code generation works
- [ ] Corrective action templates work
- [ ] Integration with desktop monitoring history

### Testing
- [ ] E2E tests: Full mobile workflow passing
- [ ] E2E tests: Offline mode sync passing
- [ ] Manual testing: Audio feedback on real device
- [ ] Manual testing: Vibration on real device
- [ ] Accessibility: Touch targets verified

### Integration
- [ ] Works with story 06.23 (same table)
- [ ] Works with Epic 04 (WO barcode scan)
- [ ] Ready for story 06.25/06.26 (deviation handling/alerts)

---

## Risk Assessment

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Camera API browser compatibility | MEDIUM | LOW | Fallback to manual WO entry |
| Offline sync conflicts | HIGH | MEDIUM | Timestamp-based conflict resolution |
| Audio feedback blocked by browser | MEDIUM | MEDIUM | Require user interaction before audio |
| IndexedDB storage limits | MEDIUM | LOW | 50-record hard limit, clear after sync |

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-01-15 | Initial story creation - CCP Monitoring Scanner | OPUS |

---

**Document Status**: Ready for Implementation
**Created**: 2025-01-15
**Complexity**: L (Large)
**Phase**: 3 (HACCP)
