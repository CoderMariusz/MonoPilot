# 06.4 - Test Parameters

**Priority**: P0 (MVP)
**Story Points**: M (Medium)
**Type**: backend + frontend
**Phase**: 1A (Core Quality)

**State:** ready
**Estimate:** M (medium story)
**Primary PRD:** `docs/1-BASELINE/product/modules/quality.md` (FR-QA-004)
**Architecture:** `docs/1-BASELINE/architecture/modules/quality.md` (quality_spec_parameters table)

## Goal

Implement test parameters for quality specifications with drag-to-reorder sequence, 4 parameter types (numeric, text, boolean, range), critical parameter flagging, and test method configuration. This enables QA teams to define detailed acceptance criteria and test methods for each product specification.

## MVP Scope

This story implements Phase 1A (Core Quality) functionality. Features listed in "Future Phases" are deferred.

**MVP Includes**:
- quality_spec_parameters table with RLS
- 4 parameter types: numeric, text, boolean, range
- Parameter sequence with drag-to-reorder
- Critical parameter flagging (is_critical)
- Test method field (dropdown/autocomplete)
- Parameter CRUD within specification detail page
- Acceptance criteria validation per type
- Min/max values for numeric and range types
- Unit of measure field

**Deferred to Phase 2+**: See "Future Phases" section below.

## Scope

**In scope**
- `quality_spec_parameters` table with RLS
- GET /api/quality/specifications/:specId/parameters (list parameters for spec)
- POST /api/quality/specifications/:specId/parameters (add parameter)
- PUT /api/quality/specifications/:specId/parameters/:id (update parameter)
- DELETE /api/quality/specifications/:specId/parameters/:id (delete parameter)
- PATCH /api/quality/specifications/:specId/parameters/reorder (bulk reorder)
- Parameter editor UI within specification detail page
- Drag-to-reorder interface (react-dnd or similar)
- Parameter type selector with type-specific fields
- Critical parameter toggle with visual indicator
- Test method dropdown with common methods + custom entry
- Validation per parameter type
- Parameter list display with type badges

**Out of scope (this story)**
- Test results recording (story 06.6)
- Parameter templates/library (Phase 2)
- Statistical process control (Phase 3)
- Formula-based parameters (Phase 3)

## Future Phases (Not in MVP)

### Phase 2
- **Parameter templates** - Reusable parameter sets by product category
- **Parameter library** - Org-wide parameter library with autocomplete
- **Parameter groups** - Logical grouping of related parameters
- **Conditional parameters** - Parameters that appear based on other values
- **Parameter import/export** - CSV/Excel import/export
- **Parameter history** - Track changes to parameters over time

### Phase 3
- **Formula parameters** - Calculated parameters (e.g., ratio = param1/param2)
- **Statistical Process Control** - Control charts, Cpk, Ppk calculations
- **Parameter tolerances** - Warning limits vs. critical limits
- **Trend analysis** - Statistical trending of parameter values
- **Parameter correlation** - Identify correlated parameters

### Deferred to Other Stories
- **Test results recording** - Story 06.6 (Test Results Recording)
- **Inspection linkage** - Story 06.5 (Incoming Inspection)
- **Document attachments** - Story 06.40 (Document Control)

## Dependencies

### Cross-Epic Dependencies
- **01.1** - Org Context + Base RLS (organizations, users tables)
- **02.1** - Products CRUD (products table for product reference)

### Within Epic Dependencies
- **06.3** - Product Specifications (quality_specifications table must exist)

### Provides To (Downstream)
- **06.5** - Incoming Inspection (parameters for inspection)
- **06.6** - Test Results Recording (parameters to record against)
- **06.10/06.11** - In-Process/Final Inspection (parameters reference)
- **06.18** - Test Result Trending (parameter data)
- **06.27** - CoA Templates (parameters for CoA)

## Database Migration

### Migration: Create quality_spec_parameters table

```sql
-- Migration: YYYYMMDDHHMMSS_create_quality_spec_parameters.sql

CREATE TABLE quality_spec_parameters (
    id                      UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    spec_id                 UUID NOT NULL REFERENCES quality_specifications(id) ON DELETE CASCADE,
    sequence                INTEGER NOT NULL,
    parameter_name          TEXT NOT NULL,
    parameter_type          TEXT NOT NULL
                            CHECK (parameter_type IN ('numeric', 'text', 'boolean', 'range')),
    target_value            TEXT,                    -- Target value (all types)
    min_value               DECIMAL(15,6),           -- For numeric/range types
    max_value               DECIMAL(15,6),           -- For numeric/range types
    unit                    TEXT,                    -- e.g., "°C", "kg", "pH", "%"
    test_method             TEXT,                    -- e.g., "AOAC 942.15", "ISO 5509", "Visual"
    instrument_required     BOOLEAN DEFAULT false,   -- Requires specific equipment
    instrument_id           UUID REFERENCES machines(id),  -- Optional: specific machine
    is_critical             BOOLEAN DEFAULT false,   -- Critical parameter (must pass)
    acceptance_criteria     TEXT,                    -- Additional criteria text
    sampling_instructions   TEXT,                    -- How to sample for this test
    created_at              TIMESTAMPTZ NOT NULL DEFAULT now(),
    created_by              UUID REFERENCES users(id),
    updated_at              TIMESTAMPTZ NOT NULL DEFAULT now(),
    updated_by              UUID REFERENCES users(id),

    CONSTRAINT uq_spec_sequence UNIQUE (spec_id, sequence),
    CONSTRAINT chk_numeric_values CHECK (
        parameter_type NOT IN ('numeric', 'range') OR
        (min_value IS NOT NULL OR max_value IS NOT NULL)
    )
);

-- Indexes for performance
CREATE INDEX idx_spec_parameters_spec ON quality_spec_parameters(spec_id);
CREATE INDEX idx_spec_parameters_sequence ON quality_spec_parameters(spec_id, sequence);
CREATE INDEX idx_spec_parameters_critical ON quality_spec_parameters(spec_id, is_critical)
    WHERE is_critical = true;

-- RLS Policies
ALTER TABLE quality_spec_parameters ENABLE ROW LEVEL SECURITY;

CREATE POLICY "quality_spec_parameters_select" ON quality_spec_parameters
    FOR SELECT USING (
        spec_id IN (
            SELECT id FROM quality_specifications
            WHERE org_id = (SELECT org_id FROM users WHERE id = auth.uid())
        )
    );

CREATE POLICY "quality_spec_parameters_insert" ON quality_spec_parameters
    FOR INSERT WITH CHECK (
        spec_id IN (
            SELECT id FROM quality_specifications
            WHERE org_id = (SELECT org_id FROM users WHERE id = auth.uid())
        )
    );

CREATE POLICY "quality_spec_parameters_update" ON quality_spec_parameters
    FOR UPDATE USING (
        spec_id IN (
            SELECT id FROM quality_specifications
            WHERE org_id = (SELECT org_id FROM users WHERE id = auth.uid())
        )
    );

CREATE POLICY "quality_spec_parameters_delete" ON quality_spec_parameters
    FOR DELETE USING (
        spec_id IN (
            SELECT id FROM quality_specifications
            WHERE org_id = (SELECT org_id FROM users WHERE id = auth.uid())
            AND status = 'draft'  -- Only delete parameters from draft specs
        )
    );

-- Trigger for updated_at
CREATE TRIGGER update_quality_spec_parameters_updated_at
    BEFORE UPDATE ON quality_spec_parameters
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- Function to reorder parameters
CREATE OR REPLACE FUNCTION reorder_spec_parameters(
    p_spec_id UUID,
    p_parameter_ids UUID[]
)
RETURNS void AS $$
DECLARE
    v_id UUID;
    v_seq INTEGER := 1;
BEGIN
    -- Update sequence for each parameter in order
    FOREACH v_id IN ARRAY p_parameter_ids LOOP
        UPDATE quality_spec_parameters
        SET sequence = v_seq,
            updated_at = now()
        WHERE id = v_id
          AND spec_id = p_spec_id;

        v_seq := v_seq + 1;
    END LOOP;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Function to get next sequence for a spec
CREATE OR REPLACE FUNCTION get_next_parameter_sequence(p_spec_id UUID)
RETURNS INTEGER AS $$
DECLARE
    v_max_seq INTEGER;
BEGIN
    SELECT COALESCE(MAX(sequence), 0) INTO v_max_seq
    FROM quality_spec_parameters
    WHERE spec_id = p_spec_id;

    RETURN v_max_seq + 1;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Constraint function: prevent parameter modification on non-draft specs
CREATE OR REPLACE FUNCTION check_spec_draft_status()
RETURNS TRIGGER AS $$
DECLARE
    v_status TEXT;
BEGIN
    SELECT status INTO v_status
    FROM quality_specifications
    WHERE id = NEW.spec_id;

    IF v_status != 'draft' THEN
        RAISE EXCEPTION 'Cannot modify parameters on non-draft specifications';
    END IF;

    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER enforce_draft_spec_for_parameters
    BEFORE INSERT OR UPDATE ON quality_spec_parameters
    FOR EACH ROW
    EXECUTE FUNCTION check_spec_draft_status();
```

## Acceptance Criteria (Given/When/Then)

### Parameter List Display

- **GIVEN** user opens specification detail page
- **WHEN** spec has parameters
- **THEN** parameters display in sequence order with: parameter_name, type badge, min/max values, unit, critical flag, test_method
- **AND** critical parameters show with red "Critical" badge
- **AND** parameters are visually grouped by sequence

- **GIVEN** specification is in draft status
- **WHEN** viewing parameters list
- **THEN** [+ Add Parameter] button visible at top
- **AND** each parameter row has Edit and Delete actions
- **AND** drag handles visible for reordering

- **GIVEN** specification is active/expired/superseded
- **WHEN** viewing parameters list
- **THEN** parameters are read-only
- **AND** no edit/delete/add actions visible

### Add Parameter

- **GIVEN** user clicks [+ Add Parameter] on draft spec
- **WHEN** parameter form displays
- **THEN** form shows: Parameter Name (required), Type (dropdown), Target Value, Min/Max (if numeric/range), Unit, Test Method, Critical toggle, Acceptance Criteria, Sampling Instructions

- **GIVEN** user selects parameter_type = 'numeric'
- **WHEN** type selected
- **THEN** Min Value and Max Value fields display (at least one required)
- **AND** Target Value field optional
- **AND** Unit field displays with common units dropdown

- **GIVEN** user selects parameter_type = 'text'
- **WHEN** type selected
- **THEN** only Target Value and Acceptance Criteria fields display
- **AND** Min/Max fields hidden

- **GIVEN** user selects parameter_type = 'boolean'
- **WHEN** type selected
- **THEN** Target Value shows dropdown: "Yes", "No"
- **AND** Min/Max fields hidden

- **GIVEN** user selects parameter_type = 'range'
- **WHEN** type selected
- **THEN** Min Value and Max Value fields display (both required)
- **AND** Target Value optional (midpoint suggestion)
- **AND** Unit field displays

- **GIVEN** user fills required fields and clicks [Save]
- **WHEN** parameter created
- **THEN** parameter added with sequence = max(sequence) + 1
- **AND** parameter appears at bottom of list
- **AND** success toast "Parameter added"

- **GIVEN** user attempts to save numeric parameter without min or max
- **WHEN** validation runs
- **THEN** error message "Numeric parameters require at least Min or Max value"

### Edit Parameter

- **GIVEN** user clicks Edit on parameter in draft spec
- **WHEN** edit form displays
- **THEN** form pre-populated with existing values
- **AND** all fields editable except spec_id

- **GIVEN** user changes parameter_type
- **WHEN** type changed
- **THEN** appropriate fields show/hide based on new type
- **AND** incompatible values cleared (e.g., min/max when switching to text)

- **GIVEN** user updates parameter and clicks [Save]
- **WHEN** update completes
- **THEN** parameter updated, updated_at and updated_by set
- **AND** success toast "Parameter updated"

- **GIVEN** user attempts to edit parameter on active spec
- **WHEN** edit attempted
- **THEN** API returns 400 error "Cannot modify parameters on non-draft specifications"
- **AND** UI shows error message

### Delete Parameter

- **GIVEN** user clicks Delete on parameter in draft spec
- **WHEN** confirmation modal displays
- **THEN** modal shows "Delete parameter '{parameter_name}'? This cannot be undone."

- **GIVEN** user confirms deletion
- **WHEN** delete completes
- **THEN** parameter removed from list
- **AND** remaining parameters' sequences unchanged (gap in sequence is OK)
- **AND** success toast "Parameter deleted"

- **GIVEN** user attempts to delete parameter on active spec
- **WHEN** delete attempted
- **THEN** API returns 403 error (RLS policy blocks)
- **AND** UI shows error message

### Reorder Parameters (Drag-to-Reorder)

- **GIVEN** draft spec with 5 parameters in sequence 1, 2, 3, 4, 5
- **WHEN** user drags parameter 4 to position 2
- **THEN** new sequence becomes: 1, 4, 2, 3, 5
- **AND** sequence values updated via PATCH /api/.../reorder
- **AND** list re-renders in new order

- **GIVEN** user drags parameter to new position
- **WHEN** drop completes
- **THEN** optimistic UI update (immediate reorder)
- **AND** API call updates backend
- **AND** on error, reverts to original order with error toast

- **GIVEN** specification is active
- **WHEN** viewing parameters
- **THEN** drag handles not visible
- **AND** parameters cannot be reordered

### Critical Parameter Flagging

- **GIVEN** user creating/editing parameter
- **WHEN** Critical toggle switched ON
- **THEN** is_critical = true saved
- **AND** parameter displays with red "Critical" badge in list

- **GIVEN** specification has 3 critical parameters out of 10 total
- **WHEN** parameters list displays
- **THEN** critical parameters visually distinct (red badge, bold name)
- **AND** tooltip on badge: "Critical parameter - must pass for overall inspection pass"

- **GIVEN** user views specification summary
- **WHEN** summary displays
- **THEN** shows "X critical parameters" count

### Test Method Field

- **GIVEN** user editing Test Method field
- **WHEN** field focused
- **THEN** autocomplete dropdown shows common methods:
  - "AOAC 942.15 (Ash)"
  - "AOAC 990.03 (Protein)"
  - "ISO 5509 (Fatty Acids)"
  - "ISO 6579 (Salmonella)"
  - "Visual Inspection"
  - "pH Meter"
  - "Thermometer"
  - "Weighing"
  - "Calipers"
  - (+ Custom entry)

- **GIVEN** user types custom method
- **WHEN** custom value entered
- **THEN** custom value saved and available in future autocomplete

- **GIVEN** parameter has instrument_required = true
- **WHEN** viewing parameter
- **THEN** displays "Requires Equipment" badge
- **AND** shows linked machine name if instrument_id set

### Parameter Type Validation

- **GIVEN** parameter_type = 'numeric', min_value = 5, max_value = 10
- **WHEN** test result entered with value 12
- **THEN** validation in story 06.6 marks as fail (out of spec)

- **GIVEN** parameter_type = 'range', min_value = 4.0, max_value = 6.5
- **WHEN** test result entered with value 5.2
- **THEN** validation marks as pass (within range)

- **GIVEN** parameter_type = 'boolean', target_value = "Yes"
- **WHEN** test result entered with "No"
- **THEN** validation marks as fail

- **GIVEN** parameter_type = 'text', acceptance_criteria = "Must be uniform golden color"
- **WHEN** test result recorded
- **THEN** inspector manually evaluates against criteria and marks pass/fail

### Unit of Measure (UOM)

- **GIVEN** user creating parameter with parameter_type = 'numeric' or 'range'
- **WHEN** Unit field focused
- **THEN** dropdown shows common units:
  - Temperature: °C, °F, K
  - Weight: g, kg, lb, oz
  - Volume: mL, L, gal
  - Dimension: mm, cm, m, in, ft
  - pH: pH
  - Percentage: %
  - Concentration: ppm, ppb, mg/L
  - Time: s, min, h
  - (+ Custom entry)

- **GIVEN** parameter with unit = "°C"
- **WHEN** displaying parameter
- **THEN** shows "Min: 72 °C, Max: 75 °C"
- **AND** unit symbol displayed after values

### Acceptance Criteria (Text Field)

- **GIVEN** user creating parameter
- **WHEN** Acceptance Criteria field filled
- **THEN** rich text area (max 1000 chars)
- **AND** supports multi-line text

- **GIVEN** parameter with acceptance_criteria = "Color: Uniform golden brown. No dark spots or discoloration."
- **WHEN** inspector performing test
- **THEN** criteria displayed prominently during test entry (story 06.6)

### Sampling Instructions

- **GIVEN** user creating parameter
- **WHEN** Sampling Instructions field filled
- **THEN** rich text area (max 1000 chars)
- **AND** provides guidance on how to sample for this test

- **GIVEN** parameter with sampling_instructions = "Sample 5 units randomly from each pallet. Test top, middle, and bottom layers."
- **WHEN** inspector starts test
- **THEN** instructions displayed before test entry

### Parameter Count & Summary

- **GIVEN** specification has parameters
- **WHEN** specification detail page displays
- **THEN** summary shows: "X parameters (Y critical)"
- **AND** breakdown by type: "3 numeric, 2 text, 1 boolean, 1 range"

- **GIVEN** specification has no parameters
- **WHEN** detail page displays
- **THEN** shows empty state: "No parameters defined. Add parameters to enable inspections."
- **AND** [+ Add Parameter] button prominent

## Implementation Notes

### API Endpoints

```typescript
// GET /api/quality/specifications/:specId/parameters
interface ParametersListResponse {
  parameters: QualitySpecParameter[];
  spec: {
    id: string;
    spec_number: string;
    name: string;
    status: string;
  };
}

interface QualitySpecParameter {
  id: string;
  spec_id: string;
  sequence: number;
  parameter_name: string;
  parameter_type: 'numeric' | 'text' | 'boolean' | 'range';
  target_value?: string;
  min_value?: number;
  max_value?: number;
  unit?: string;
  test_method?: string;
  instrument_required: boolean;
  instrument_id?: string;
  instrument_name?: string;
  is_critical: boolean;
  acceptance_criteria?: string;
  sampling_instructions?: string;
  created_at: string;
  created_by: string;
  updated_at: string;
  updated_by?: string;
}

// POST /api/quality/specifications/:specId/parameters
interface CreateParameterRequest {
  parameter_name: string;
  parameter_type: 'numeric' | 'text' | 'boolean' | 'range';
  target_value?: string;
  min_value?: number;
  max_value?: number;
  unit?: string;
  test_method?: string;
  instrument_required?: boolean;
  instrument_id?: string;
  is_critical?: boolean;
  acceptance_criteria?: string;
  sampling_instructions?: string;
}

// PUT /api/quality/specifications/:specId/parameters/:id
interface UpdateParameterRequest extends Partial<CreateParameterRequest> {}

// PATCH /api/quality/specifications/:specId/parameters/reorder
interface ReorderParametersRequest {
  parameter_ids: string[];  // Array of IDs in new order
}

interface ReorderParametersResponse {
  updated_count: number;
  parameters: QualitySpecParameter[];
}
```

### Validation (Zod)

```typescript
import { z } from 'zod';

const parameterTypeEnum = z.enum(['numeric', 'text', 'boolean', 'range']);

export const createParameterSchema = z.object({
  parameter_name: z.string()
    .min(2, 'Parameter name must be at least 2 characters')
    .max(200, 'Parameter name must not exceed 200 characters'),
  parameter_type: parameterTypeEnum,
  target_value: z.string().max(500).optional(),
  min_value: z.number().optional(),
  max_value: z.number().optional(),
  unit: z.string().max(50).optional(),
  test_method: z.string().max(200).optional(),
  instrument_required: z.boolean().default(false),
  instrument_id: z.string().uuid().optional().nullable(),
  is_critical: z.boolean().default(false),
  acceptance_criteria: z.string().max(1000).optional(),
  sampling_instructions: z.string().max(1000).optional(),
}).refine(
  (data) => {
    // Numeric and range types require at least min or max
    if (data.parameter_type === 'numeric' || data.parameter_type === 'range') {
      return data.min_value !== undefined || data.max_value !== undefined;
    }
    return true;
  },
  {
    message: 'Numeric and range parameters require at least one of min_value or max_value',
    path: ['min_value']
  }
).refine(
  (data) => {
    // Range type requires both min and max
    if (data.parameter_type === 'range') {
      return data.min_value !== undefined && data.max_value !== undefined;
    }
    return true;
  },
  {
    message: 'Range parameters require both min_value and max_value',
    path: ['min_value']
  }
).refine(
  (data) => {
    // If both min and max provided, min must be less than max
    if (data.min_value !== undefined && data.max_value !== undefined) {
      return data.min_value < data.max_value;
    }
    return true;
  },
  {
    message: 'min_value must be less than max_value',
    path: ['max_value']
  }
);

export const updateParameterSchema = createParameterSchema.partial();

export const reorderParametersSchema = z.object({
  parameter_ids: z.array(z.string().uuid()).min(1, 'At least one parameter ID required'),
});
```

### Service Layer

```typescript
// lib/services/spec-parameter-service.ts

export class SpecParameterService {
  /**
   * Get parameters for a specification
   */
  static async getBySpecId(specId: string): Promise<QualitySpecParameter[]> {
    const { data, error } = await supabase
      .from('quality_spec_parameters')
      .select(`
        *,
        instrument:machines!instrument_id(id, name, code)
      `)
      .eq('spec_id', specId)
      .order('sequence', { ascending: true });

    if (error) throw new DatabaseError(error.message);

    return data.map(param => ({
      ...param,
      instrument_name: param.instrument?.name,
    }));
  }

  /**
   * Create parameter with auto-sequence
   */
  static async create(
    specId: string,
    data: CreateParameterRequest,
    userId: string
  ): Promise<QualitySpecParameter> {
    // Verify spec is draft
    const spec = await SpecificationService.getById(specId);
    if (!spec) throw new NotFoundError('Specification not found');
    if (spec.status !== 'draft') {
      throw new ValidationError('Cannot add parameters to non-draft specifications');
    }

    // Get next sequence
    const { data: seqData } = await supabase
      .rpc('get_next_parameter_sequence', { p_spec_id: specId });

    const sequence = seqData || 1;

    const parameter = {
      spec_id: specId,
      sequence,
      ...data,
      created_by: userId,
    };

    const { data: created, error } = await supabase
      .from('quality_spec_parameters')
      .insert(parameter)
      .select()
      .single();

    if (error) throw new DatabaseError(error.message);

    return created;
  }

  /**
   * Update parameter
   */
  static async update(
    parameterId: string,
    data: UpdateParameterRequest,
    userId: string
  ): Promise<QualitySpecParameter> {
    // Trigger will enforce draft status check
    const { data: updated, error } = await supabase
      .from('quality_spec_parameters')
      .update({
        ...data,
        updated_at: new Date().toISOString(),
        updated_by: userId,
      })
      .eq('id', parameterId)
      .select()
      .single();

    if (error) {
      if (error.message.includes('Cannot modify parameters')) {
        throw new ValidationError('Cannot modify parameters on non-draft specifications');
      }
      throw new DatabaseError(error.message);
    }

    return updated;
  }

  /**
   * Delete parameter
   */
  static async delete(parameterId: string): Promise<void> {
    // RLS policy enforces draft-only deletion
    const { error } = await supabase
      .from('quality_spec_parameters')
      .delete()
      .eq('id', parameterId);

    if (error) {
      throw new DatabaseError(error.message);
    }
  }

  /**
   * Reorder parameters
   */
  static async reorder(
    specId: string,
    parameterIds: string[]
  ): Promise<QualitySpecParameter[]> {
    // Verify spec is draft
    const spec = await SpecificationService.getById(specId);
    if (!spec) throw new NotFoundError('Specification not found');
    if (spec.status !== 'draft') {
      throw new ValidationError('Cannot reorder parameters on non-draft specifications');
    }

    // Call reorder function
    const { error } = await supabase
      .rpc('reorder_spec_parameters', {
        p_spec_id: specId,
        p_parameter_ids: parameterIds
      });

    if (error) throw new DatabaseError(error.message);

    // Return updated list
    return this.getBySpecId(specId);
  }

  /**
   * Clone parameters to new spec version
   * (Called from SpecificationService.cloneAsNewVersion)
   */
  static async cloneToNewSpec(
    sourceSpecId: string,
    targetSpecId: string,
    userId: string
  ): Promise<void> {
    const sourceParams = await this.getBySpecId(sourceSpecId);

    for (const param of sourceParams) {
      const { spec_id, id, created_at, created_by, updated_at, updated_by, ...paramData } = param;

      await this.create(targetSpecId, paramData, userId);
    }
  }

  /**
   * Validate parameter value against parameter definition
   * (Used in story 06.6 - Test Results Recording)
   */
  static validateValue(
    parameter: QualitySpecParameter,
    value: string | number | boolean
  ): { valid: boolean; reason?: string } {
    switch (parameter.parameter_type) {
      case 'numeric':
      case 'range':
        const numValue = typeof value === 'number' ? value : parseFloat(value as string);
        if (isNaN(numValue)) {
          return { valid: false, reason: 'Invalid numeric value' };
        }
        if (parameter.min_value !== undefined && numValue < parameter.min_value) {
          return { valid: false, reason: `Below minimum (${parameter.min_value})` };
        }
        if (parameter.max_value !== undefined && numValue > parameter.max_value) {
          return { valid: false, reason: `Above maximum (${parameter.max_value})` };
        }
        return { valid: true };

      case 'boolean':
        if (parameter.target_value) {
          const match = value.toString().toLowerCase() === parameter.target_value.toLowerCase();
          return { valid: match, reason: match ? undefined : `Expected ${parameter.target_value}` };
        }
        return { valid: true };

      case 'text':
        // Text parameters are manually evaluated
        return { valid: true };

      default:
        return { valid: false, reason: 'Unknown parameter type' };
    }
  }
}
```

### Frontend Components

```
apps/frontend/app/(authenticated)/quality/specifications/[id]/
  components/
    ParameterEditor.tsx         -- Main parameter editor component
    ParameterTable.tsx          -- Draggable parameter list
    ParameterForm.tsx           -- Add/Edit parameter form
    ParameterRow.tsx            -- Individual parameter row (draggable)
    ParameterTypeSelector.tsx   -- Type dropdown with conditional fields
    TestMethodAutocomplete.tsx  -- Autocomplete for test methods
    UnitSelector.tsx            -- Unit dropdown with common units
    CriticalBadge.tsx           -- Visual indicator for critical params
    ParameterTypeBadge.tsx      -- Badge showing parameter type
    DeleteParameterDialog.tsx   -- Confirmation dialog
```

### UI Components Specification

**ParameterEditor.tsx** (Main component integrated into Specification Detail page)
- Displays parameters list if spec has parameters
- Shows empty state with [+ Add Parameter] if no parameters
- Header: "Parameters (X total, Y critical)"
- Type breakdown summary
- Add parameter button (if draft)
- Passes spec status to child components for read-only mode

**ParameterTable.tsx**
- Uses react-dnd or @dnd-kit for drag-to-reorder
- Columns: Drag Handle (draft only), Sequence, Name, Type, Target/Range, Unit, Test Method, Critical, Actions
- Each row is draggable (draft only)
- On drop: optimistic update + API call
- Responsive: mobile shows simplified view

**ParameterForm.tsx** (Dialog/Modal)
- Parameter Name input (required)
- Type selector with conditional fields:
  - Numeric: Min, Max (at least one required), Target (optional), Unit
  - Text: Target (optional), Acceptance Criteria
  - Boolean: Target dropdown (Yes/No)
  - Range: Min & Max (both required), Target (optional), Unit
- Test Method autocomplete
- Critical toggle
- Instrument Required toggle
  - If true: Instrument dropdown (machines)
- Acceptance Criteria textarea
- Sampling Instructions textarea
- Save / Cancel buttons

**ParameterRow.tsx**
- Drag handle (if draft and draggable enabled)
- Sequence number badge
- Parameter name (bold if critical)
- Type badge (color-coded: numeric=blue, text=green, boolean=purple, range=orange)
- Value display based on type:
  - Numeric: "Min: X, Max: Y (Unit)" or "Target: X (Unit)"
  - Text: "Target: X" or "See criteria"
  - Boolean: "Target: Yes/No"
  - Range: "Min: X - Max: Y (Unit)"
- Test method (truncated with tooltip)
- Critical badge (red, if is_critical=true)
- Actions: Edit, Delete (draft only)

**CriticalBadge.tsx**
- Red badge with "Critical" text
- Tooltip: "Critical parameter - must pass for overall inspection pass"
- Icon: AlertCircle or similar

**TestMethodAutocomplete.tsx**
- Combobox with common methods
- Filters as user types
- Shows recently used methods
- Allows custom entry
- Grouped by category (AOAC, ISO, Visual, Equipment)

## Deliverables

- Migration: `create_quality_spec_parameters.sql`
- Database functions: `reorder_spec_parameters`, `get_next_parameter_sequence`, `check_spec_draft_status`
- RLS policies for quality_spec_parameters
- API routes:
  - GET /api/quality/specifications/:specId/parameters
  - POST /api/quality/specifications/:specId/parameters
  - PUT /api/quality/specifications/:specId/parameters/:id
  - DELETE /api/quality/specifications/:specId/parameters/:id
  - PATCH /api/quality/specifications/:specId/parameters/reorder
- Zod validation schemas
- `SpecParameterService` class
- Parameter editor components (7 components)
- Drag-to-reorder functionality
- Integration into Specification Detail page
- Unit tests for service layer (>90% coverage)
- Integration tests for API endpoints
- E2E test for parameter CRUD + reorder flow

## Test Strategy

### Unit Tests

```typescript
describe('SpecParameterService', () => {
  describe('create', () => {
    it('auto-generates sequence number', async () => {});
    it('blocks parameter creation on active spec', async () => {});
    it('validates numeric type requires min or max', async () => {});
    it('validates range type requires both min and max', async () => {});
    it('validates min < max', async () => {});
  });

  describe('reorder', () => {
    it('updates sequences based on parameter_ids array order', async () => {});
    it('blocks reorder on active spec', async () => {});
    it('handles concurrent reorder requests', async () => {});
  });

  describe('validateValue', () => {
    it('validates numeric parameter within range', async () => {});
    it('fails numeric parameter below min', async () => {});
    it('fails numeric parameter above max', async () => {});
    it('validates boolean parameter matches target', async () => {});
    it('allows text parameter (manual evaluation)', async () => {});
  });

  describe('cloneToNewSpec', () => {
    it('copies all parameters to new spec', async () => {});
    it('preserves sequence order', async () => {});
    it('clears id and timestamps', async () => {});
  });
});
```

### Integration Tests

```typescript
describe('Spec Parameters API', () => {
  describe('POST /api/quality/specifications/:specId/parameters', () => {
    it('creates parameter with auto-sequence', async () => {});
    it('returns 400 for active spec', async () => {});
    it('validates required fields', async () => {});
    it('enforces RLS for org isolation', async () => {});
  });

  describe('PATCH /api/quality/specifications/:specId/parameters/reorder', () => {
    it('reorders parameters by ID array', async () => {});
    it('returns updated parameters list', async () => {});
    it('returns 400 for active spec', async () => {});
  });

  describe('DELETE /api/quality/specifications/:specId/parameters/:id', () => {
    it('deletes parameter from draft spec', async () => {});
    it('returns 403 for active spec (RLS blocks)', async () => {});
  });
});
```

### E2E Tests

```typescript
describe('Parameter Management Workflow', () => {
  it('complete CRUD + reorder lifecycle', async () => {
    // 1. Create draft specification
    // 2. Add 5 parameters (numeric, text, boolean, range, numeric)
    // 3. Verify sequence 1-5
    // 4. Mark parameter 2 as critical
    // 5. Drag parameter 4 to position 2
    // 6. Verify new sequence: 1, 4, 2, 3, 5
    // 7. Edit parameter 3
    // 8. Delete parameter 5
    // 9. Approve specification
    // 10. Verify parameters now read-only
  });
});
```

## Definition of Done

- [ ] Migration creates quality_spec_parameters table with all columns
- [ ] RLS policies enforce org isolation and draft-only editing
- [ ] Database functions for reorder and sequence generation work correctly
- [ ] Trigger enforces draft-only modifications
- [ ] All API endpoints implemented and tested
- [ ] Zod validation schemas complete with type-specific validation
- [ ] SpecParameterService with all methods implemented
- [ ] Parameter list displays within spec detail page
- [ ] Add parameter form with conditional fields per type
- [ ] Edit parameter works (draft only)
- [ ] Delete parameter with confirmation (draft only)
- [ ] Drag-to-reorder functionality with optimistic updates
- [ ] Critical parameter badge displays correctly
- [ ] Test method autocomplete with common methods
- [ ] Unit selector with common units
- [ ] Parameter type badges color-coded
- [ ] Read-only mode for active/expired/superseded specs
- [ ] Empty state when no parameters
- [ ] Parameter count summary displays
- [ ] Value validation logic for test results (used in 06.6)
- [ ] Clone parameters when cloning spec version
- [ ] Unit tests >90% coverage for service
- [ ] Integration tests for all API endpoints
- [ ] E2E test for full parameter lifecycle

---

**Document Status**: Ready for Implementation
**Created**: 2025-12-16
**Lines**: ~850
**Complexity**: M (Medium)
**Phase**: 1A (Core Quality)
