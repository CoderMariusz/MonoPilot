# 06.35 - Supplier Audits CRUD

**Priority**: P1 (Phase 4)
**Story Points**: M (Medium)
**Type**: full-stack
**Phase**: 4 (Advanced Quality)

**State:** ready
**Estimate:** M (3-4 days)
**Primary PRD:** `docs/1-BASELINE/product/modules/quality.md` (FR-QA-019, Section 4.6 Supplier Quality)

---

## Goal

Implement supplier audit scheduling, execution, and scoring. Audits verify supplier compliance with GMP, HACCP, and Quality System requirements through scheduled site visits. Audit scores feed into supplier quality ratings and determine next audit frequency (annual/biannual based on performance).

---

## User Story

As a **Quality Director**, I want to **schedule and conduct supplier audits with standardized checklists** so that **we verify supplier compliance and maintain approved supplier status**.

As a **Purchasing Manager**, I want to **view supplier audit history and scores** so that **I can assess supplier capability before awarding contracts**.

---

## Dependencies

- **Requires**: 06.34 Supplier Quality Ratings
- **Blocks**: 06.36 Supplier Audit Findings

---

## Database Schema

```sql
CREATE TABLE supplier_audits (
    id                      UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id                  UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    supplier_id             UUID NOT NULL REFERENCES suppliers(id) ON DELETE CASCADE,

    audit_number            TEXT NOT NULL,
    audit_type              TEXT NOT NULL
                            CHECK (audit_type IN ('initial', 'renewal', 'follow_up', 'ad_hoc')),

    audit_date              DATE NOT NULL,
    auditor_id              UUID REFERENCES users(id),

    status                  TEXT NOT NULL DEFAULT 'scheduled'
                            CHECK (status IN ('scheduled', 'in_progress', 'completed', 'cancelled')),

    -- Checklist scores (0-100 each)
    gmp_score               DECIMAL(5,2),
    haccp_score             DECIMAL(5,2),
    quality_system_score    DECIMAL(5,2),
    overall_score           DECIMAL(5,2),

    result                  TEXT CHECK (result IN ('approved', 'conditional', 'failed')),

    next_audit_date         DATE,
    report_url              TEXT,
    notes                   TEXT,

    completed_at            TIMESTAMPTZ,
    completed_by            UUID REFERENCES users(id),

    created_at              TIMESTAMPTZ NOT NULL DEFAULT now(),
    created_by              UUID REFERENCES users(id),
    updated_at              TIMESTAMPTZ NOT NULL DEFAULT now(),

    CONSTRAINT uq_supplier_audit_number UNIQUE (org_id, audit_number)
);

CREATE INDEX idx_supplier_audits_supplier ON supplier_audits(supplier_id);
CREATE INDEX idx_supplier_audits_date ON supplier_audits(org_id, audit_date);
CREATE INDEX idx_supplier_audits_next ON supplier_audits(org_id, next_audit_date) WHERE status = 'completed';
CREATE INDEX idx_supplier_audits_auditor ON supplier_audits(auditor_id) WHERE auditor_id IS NOT NULL;
```

---

## API Endpoints

- **GET** `/api/quality/supplier-audits` - List audits with filters
- **GET** `/api/quality/supplier-audits/:id` - Get audit detail
- **POST** `/api/quality/supplier-audits` - Schedule audit
- **PUT** `/api/quality/supplier-audits/:id` - Update audit
- **DELETE** `/api/quality/supplier-audits/:id` - Delete scheduled audit
- **POST** `/api/quality/supplier-audits/:id/complete` - Complete audit with scores
- **GET** `/api/quality/supplier-audits/supplier/:supplierId` - Supplier audit history

---

## Key Features

1. **Audit Types**:
   - Initial: First audit for new supplier
   - Renewal: Annual/biannual recertification
   - Follow-up: Verify corrective actions from previous audit
   - Ad-hoc: Triggered by quality issues
2. **Audit Checklist**: GMP, HACCP, Quality System (each scored 0-100)
3. **Overall Score**: Average of 3 checklist scores
4. **Audit Result**: Approved (>85), Conditional (70-85), Failed (<70)
5. **Next Audit Auto-Calculation**:
   - Approved: +12 months (annual)
   - Conditional: +6 months (biannual)
   - Failed: +3 months (quarterly follow-up)
6. **Audit Report Upload**: PDF report attachment
7. **Auditor Assignment**: Assign internal auditor or external firm

---

## Acceptance Criteria

### AC-1: Schedule Supplier Audit

```gherkin
Scenario: Schedule initial audit for new supplier
  Given new supplier added
  When QA Director clicks [Schedule Audit]
  And fills form:
    | Field | Value |
    | Audit Type | Initial |
    | Audit Date | 2025-04-15 |
    | Auditor | Jane Smith |
  And clicks [Schedule]
  Then audit created with:
    | audit_number | AUD-SUP-2025-00001 |
    | status | scheduled |
```

### AC-2: Complete Audit with Scores

```gherkin
Scenario: Complete audit and calculate overall score
  Given audit in_progress
  When auditor enters scores:
    | Checklist | Score |
    | GMP | 92 |
    | HACCP | 88 |
    | Quality System | 90 |
  And uploads audit report PDF
  And clicks [Complete Audit]
  Then overall_score = 90.0 (average)
  And result = 'approved' (score >85)
  And next_audit_date = +12 months
  And status = 'completed'
  And supplier approval_status updated
```

### AC-3: Auto-Calculate Next Audit Date

```gherkin
Scenario: Next audit based on result
  Given audit overall_score and result
  When overall_score >= 85
  Then next_audit_date = audit_date + 12 months (annual)
  When overall_score 70-84
  Then next_audit_date = audit_date + 6 months (biannual)
  When overall_score < 70
  Then next_audit_date = audit_date + 3 months (quarterly)
```

### AC-4: Supplier Audit History

```gherkin
Scenario: View supplier audit timeline
  Given supplier has 3 audits
  When viewing supplier detail page
  Then audit history table shows:
    | Audit # | Date | Type | Overall Score | Result | Next Audit |
    | AUD-SUP-2025-00003 | 2025-03-01 | Renewal | 90 | Approved | 2026-03-01 |
    | AUD-SUP-2024-00012 | 2024-03-15 | Renewal | 88 | Approved | 2025-03-15 |
    | AUD-SUP-2023-00005 | 2023-04-01 | Initial | 92 | Approved | 2024-04-01 |
  And trend chart shows score progression
```

---

## Deliverables

- [ ] `supplier_audits` table migration
- [ ] Audit CRUD endpoints (7)
- [ ] SupplierAuditService with scoring
- [ ] Audit scheduling form
- [ ] Audit checklist component (GMP, HACCP, QS)
- [ ] Complete audit modal with score input
- [ ] Supplier audit history view
- [ ] Unit + integration tests

---

**Complexity**: M (3-4 days)
**Created**: 2026-01-15
