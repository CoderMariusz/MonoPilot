# 06.37 - Quality Dashboard

**Priority**: P0 (MVP)
**Story Points**: L (Large)
**Type**: frontend (data visualization)
**Phase**: 4 (Analytics & Reporting)
**Model**: OPUS

**State:** ready
**Estimate:** L (5-6 days)
**Primary PRD:** `docs/1-BASELINE/product/modules/quality.md` (FR-QA-020, Section 10 Phase 4)
**Architecture:** `docs/1-BASELINE/architecture/modules/quality.md` (quality_audit_log table)

---

## Goal

Implement an executive Quality Dashboard providing real-time quality KPIs, trend charts, and actionable insights for QA Managers and Quality Directors. The dashboard serves as the central quality command center, displaying First Pass Yield, NCR rates, CCP compliance, inspection backlogs, and CAPA closure metrics with drill-down capabilities to underlying data.

---

## Food Safety Compliance

This story supports **compliance visibility**:

- [x] **FDA 21 CFR Part 11** - Dashboard displays audit-compliant data with traceability
- [x] **HACCP Compliance** - CCP monitoring compliance visibility
- [x] **ISO 9001** - Quality metrics aligned with management review requirements
- [x] **Real-time Monitoring** - Critical metrics updated via WebSocket

**Regulatory Context:**
- Quality dashboards required for management review per ISO 9001 clause 9.3
- CCP compliance trends needed for HACCP verification
- NCR and CAPA metrics demonstrate continuous improvement
- Executive visibility supports food safety culture

---

## MVP Scope

This story implements Phase 4 (Analytics & Reporting) functionality. Quality Dashboard is the culmination of all quality modules, providing visibility across inspections, NCRs, CCP monitoring, and CAPA.

**MVP Includes**:
- Quality KPI summary cards (5 key metrics)
- NCR trend line chart (last 90 days)
- Defect Pareto bar chart (top 10 defect types)
- Inspection status pie chart (pending/in-progress/completed)
- Supplier quality heatmap (scorecard visualization)
- Date range filters (7/30/90 days, YTD, custom)
- Dashboard PDF export
- Real-time updates via WebSocket for critical metrics
- Role-based dashboard views (Inspector vs Manager)
- Drill-down links to underlying data

**Deferred to Phase 4+**: Advanced analytics, predictive trends, SPC control charts (moved to 06.39).

---

## User Story

As a **QA Manager**, I want to **view a real-time quality dashboard with KPIs, trends, and alerts** so that **I can quickly assess quality performance, identify issues, and make data-driven decisions**.

As a **Quality Director**, I want to **see high-level quality metrics and drill down into specifics** so that **I can monitor compliance, report to management, and drive continuous improvement**.

---

## Scope

**In scope (this story)**
- KPI summary cards: First Pass Yield, NCR Rate, CCP Compliance, Inspection Backlog, CAPA Closure Rate
- NCR trend chart (line chart, 90-day rolling)
- Defect Pareto chart (top 10 defect types by frequency)
- Inspection status pie chart (scheduled/in_progress/completed breakdown)
- Supplier quality heatmap (suppliers by quality score)
- Date range filter (last 7/30/90 days, YTD, custom range)
- Dashboard PDF export (executive summary)
- Real-time updates (WebSocket for critical KPIs)
- Role-based views (QA Inspector sees different dashboard than QA Manager)
- GET /api/quality/dashboard/kpis
- GET /api/quality/dashboard/ncr-trend
- GET /api/quality/dashboard/defect-pareto
- GET /api/quality/dashboard/inspection-status
- GET /api/quality/dashboard/supplier-heatmap
- POST /api/quality/dashboard/export-pdf

**Out of scope (this story)**
- Statistical Process Control (SPC) charts (story 06.39)
- Advanced analytics and forecasting (story 06.39)
- Audit trail reports (story 06.38)
- Document control (story 06.40)
- Scheduled report email (story 06.39)
- Custom dashboard builder (Phase 5)

---

## Dependencies

### Cross-Epic Dependencies

| Dependency | Story/Epic | Type | What It Provides | Status |
|------------|------------|------|------------------|--------|
| 01.1 | Org Context + RLS | HARD | organizations, users, roles tables | Ready |
| 02.1 | Products CRUD | HARD | products table for defect analysis | Ready |
| 03.3 | Purchase Orders | HARD | Supplier context | Ready |

### Within Epic Dependencies

| Dependency | Story | Type | What It Provides |
|------------|-------|------|------------------|
| 06.5 | Incoming Inspection | HARD | quality_inspections data |
| 06.6 | Test Results Recording | HARD | test_results data |
| 06.9 | Basic NCR Creation | HARD | ncr_reports data |
| 06.10 | In-Process Inspection | HARD | inspection data |
| 06.11 | Final Inspection | HARD | inspection data |
| 06.13 | NCR Workflow | HARD | NCR status transitions |
| 06.22 | CCP Definition | HARD | CCP compliance data |
| 06.23 | CCP Monitoring Desktop | HARD | CCP monitoring records |
| 06.31 | CAPA Creation | HARD | CAPA data |
| 06.32 | CAPA Action Items | HARD | CAPA closure metrics |
| 06.34 | Supplier Quality Ratings | HARD | Supplier scorecard data |

### Provides To (Downstream)

| Story | What This Provides |
|-------|-------------------|
| 06.39 | Quality Analytics - Base dashboard components for reuse |
| Phase 5 | Custom dashboard builder - Dashboard framework |

---

## Database Migration

**No new tables required**. Dashboard reads from existing tables:
- `quality_inspections` (inspection metrics)
- `ncr_reports` (NCR trends)
- `quality_test_results` (defect analysis)
- `ccp_monitoring_records` (CCP compliance)
- `capa_records` (CAPA metrics)
- `supplier_quality_ratings` (supplier heatmap)

**Optional materialized view for performance**:

```sql
-- Migration: YYYYMMDDHHMMSS_create_quality_dashboard_mv.sql

-- Materialized view for dashboard KPIs (refresh every 5 minutes)
CREATE MATERIALIZED VIEW quality_dashboard_kpis AS
SELECT
    org_id,
    -- First Pass Yield (FPY)
    ROUND(
        100.0 * COUNT(*) FILTER (WHERE result = 'pass' AND inspection_type = 'incoming')
        / NULLIF(COUNT(*) FILTER (WHERE inspection_type = 'incoming' AND status = 'completed'), 0),
        2
    ) AS first_pass_yield,

    -- NCR Rate (per 1000 batches)
    ROUND(
        1000.0 * COUNT(DISTINCT ncr_id) FILTER (WHERE ncr_id IS NOT NULL)
        / NULLIF(COUNT(DISTINCT batch_number), 0),
        2
    ) AS ncr_rate,

    -- Inspection Backlog
    COUNT(*) FILTER (WHERE status IN ('scheduled', 'in_progress')) AS inspection_backlog,

    -- Completed inspections (last 30 days)
    COUNT(*) FILTER (WHERE status = 'completed' AND completed_at > NOW() - INTERVAL '30 days') AS inspections_completed_30d,

    -- Updated timestamp
    NOW() AS refreshed_at
FROM quality_inspections
GROUP BY org_id;

CREATE UNIQUE INDEX idx_dashboard_kpis_org ON quality_dashboard_kpis(org_id);

-- Refresh schedule (every 5 minutes)
CREATE OR REPLACE FUNCTION refresh_dashboard_kpis()
RETURNS void AS $$
BEGIN
    REFRESH MATERIALIZED VIEW CONCURRENTLY quality_dashboard_kpis;
END;
$$ LANGUAGE plpgsql;

-- Note: In production, schedule this via cron or pg_cron extension
-- SELECT cron.schedule('refresh-dashboard', '*/5 * * * *', 'SELECT refresh_dashboard_kpis();');

-- =============================================================================
-- RLS Policies for Materialized View
-- =============================================================================

ALTER MATERIALIZED VIEW quality_dashboard_kpis SET (security_barrier = true);

CREATE POLICY "dashboard_kpis_org" ON quality_dashboard_kpis
    FOR SELECT USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );
```

---

## Acceptance Criteria (Given/When/Then)

### AC-1: KPI Summary Cards

```gherkin
Scenario: Display 5 key quality KPIs
  Given user navigates to Quality > Dashboard
  When page loads
  Then 5 KPI cards displayed:
    | KPI | Target | Color |
    | First Pass Yield | >95% | Green if met, red if below |
    | NCR Rate | <5 per 1000 batches | Green if met, red if above |
    | CCP Compliance | >99% | Green if met, red if below |
    | Inspection Backlog | <10 | Orange if 5-10, red if >10 |
    | CAPA Closure Rate | >90% | Green if met, red if below |
  And each card shows:
    - Current value
    - Target value
    - Trend indicator (up/down/stable)
    - Comparison to previous period

Scenario: KPI drill-down
  Given user views KPI card
  When clicking on card
  Then navigates to detailed view:
    | KPI | Destination |
    | First Pass Yield | /quality/inspections?result=fail |
    | NCR Rate | /quality/ncr |
    | CCP Compliance | /quality/ccp/monitoring |
    | Inspection Backlog | /quality/inspections?status=scheduled |
    | CAPA Closure Rate | /quality/capa |
```

### AC-2: NCR Trend Chart

```gherkin
Scenario: Display NCR trend over time
  Given NCR data exists for last 90 days
  When user views dashboard
  Then line chart displays:
    - X-axis: Date (daily/weekly buckets based on range)
    - Y-axis: NCR count
    - Line color: Blue
    - Data points: Hoverable with tooltip showing date + count
    - Trend line: Optional moving average overlay
  And chart updates when date filter changes

Scenario: NCR trend tooltip
  Given user hovers over data point on NCR trend chart
  Then tooltip shows:
    | Field | Example |
    | Date | 2025-01-15 |
    | NCR Count | 8 |
    | Critical | 2 |
    | Major | 4 |
    | Minor | 2 |
  And click navigates to NCR list filtered by date
```

### AC-3: Defect Pareto Chart

```gherkin
Scenario: Display top 10 defect types
  Given defect data exists from test results
  When user views dashboard
  Then Pareto bar chart displays:
    - X-axis: Defect type (sorted by frequency descending)
    - Y-axis (left): Defect count (bars)
    - Y-axis (right): Cumulative percentage (line)
    - Top 10 defect types shown
    - Bars color-coded by severity (critical=red, major=orange, minor=yellow)
  And cumulative line shows 80/20 rule visualization

Scenario: Defect Pareto drill-down
  Given user clicks on defect type bar
  Then navigates to /quality/test-results?defect_type={type}
  And shows all test results with that defect type
```

### AC-4: Inspection Status Pie Chart

```gherkin
Scenario: Display inspection status breakdown
  Given inspections exist with various statuses
  When user views dashboard
  Then pie chart displays:
    | Status | Color | Example % |
    | Scheduled | Yellow | 40% |
    | In Progress | Blue | 30% |
    | Completed | Green | 30% |
  And legend shows counts: "Scheduled: 12 (40%)"
  And total inspections shown in chart title

Scenario: Inspection pie slice click
  Given user clicks on pie slice
  Then navigates to /quality/inspections?status={status}
  And table filtered by clicked status
```

### AC-5: Supplier Quality Heatmap

```gherkin
Scenario: Display supplier quality scorecard
  Given supplier quality ratings exist
  When user views dashboard
  Then heatmap displays:
    - Rows: Suppliers (top 10 by volume)
    - Columns: Quality metrics (Defect Rate, On-Time, CoA Compliance)
    - Cell color: Green (>90), Yellow (70-90), Red (<70)
    - Cell value: Score percentage
  And tooltip on hover shows metric details

Scenario: Supplier heatmap drill-down
  Given user clicks on supplier row
  Then navigates to /settings/suppliers/{id}/quality
  And shows detailed supplier quality history
```

### AC-6: Date Range Filter

```gherkin
Scenario: Filter dashboard by date range
  Given user is on dashboard
  When selecting date filter:
    | Option | Range |
    | Last 7 Days | Today - 7 days |
    | Last 30 Days | Today - 30 days |
    | Last 90 Days | Today - 90 days (default) |
    | YTD | Jan 1 - Today |
    | Custom | User-selected dates |
  Then all dashboard widgets refresh with filtered data
  And URL updates with date params
  And filter persists in session

Scenario: Custom date range
  Given user selects "Custom" from date filter
  When modal opens with date pickers
  And user selects start date = 2025-01-01, end date = 2025-01-15
  And clicks Apply
  Then dashboard filters to Jan 1-15
  And filter label shows "Jan 1, 2025 - Jan 15, 2025"
```

### AC-7: PDF Export

```gherkin
Scenario: Export dashboard as PDF
  Given user views dashboard with current filters
  When clicking [Export PDF] button
  Then PDF generated with:
    - Header: Org name, date range, generated timestamp
    - KPI summary table (5 KPIs)
    - NCR trend chart image
    - Defect Pareto chart image
    - Inspection status pie chart image
    - Supplier heatmap table
    - Footer: Page numbers, MonoPilot branding
  And PDF downloads as "Quality-Dashboard-{YYYY-MM-DD}.pdf"
  And generation completes within 5 seconds

Scenario: PDF export permission check
  Given user with VIEWER role
  When attempting PDF export
  Then error: "PDF export requires QA Manager or Quality Director role"
```

### AC-8: Real-Time Updates (WebSocket)

```gherkin
Scenario: Real-time KPI updates
  Given user viewing dashboard
  And WebSocket connection established
  When critical inspection completed elsewhere
  Then KPI cards update within 5 seconds
  And notification badge shows "1 update"
  And user can click to refresh charts

Scenario: WebSocket reconnection
  Given WebSocket connection lost
  When user viewing dashboard
  Then banner shows "Connecting..." for max 10 seconds
  And fallback to polling every 30 seconds
  And reconnect when network available
```

### AC-9: Role-Based Dashboard Views

```gherkin
Scenario: QA Inspector view
  Given user with QA_INSPECTOR role
  When viewing dashboard
  Then sees:
    - My Inspections (assigned to user)
    - Inspection Backlog (all pending)
    - NCR Summary (created by user)
    - Test Result Trends (for user's inspections)
  And does NOT see:
    - Supplier Quality Heatmap (manager only)
    - CAPA Closure Rate (manager only)

Scenario: QA Manager view
  Given user with QA_MANAGER role
  When viewing dashboard
  Then sees:
    - All 5 KPI cards
    - All charts (NCR trend, Defect Pareto, Inspection status, Supplier heatmap)
    - Team performance metrics
    - Export PDF button

Scenario: Quality Director view
  Given user with QUALITY_DIRECTOR role
  When viewing dashboard
  Then sees:
    - Executive summary (high-level KPIs only)
    - Compliance metrics (CCP, CAPA)
    - Supplier scorecard
    - Trend comparisons (YoY, MoM)
    - Export PDF button
```

### AC-10: Dashboard Performance

```gherkin
Scenario: Dashboard load time
  Given organization with 10,000 inspections, 500 NCRs, 100 suppliers
  When user loads dashboard
  Then page loads within 2 seconds
  And KPI cards render within 500ms
  And charts render within 1.5 seconds

Scenario: Dashboard refresh
  Given user on dashboard
  When clicking [Refresh] button
  Then all widgets reload
  And loading spinners shown during fetch
  And data updated within 1 second
```

### AC-11: Empty State Handling

```gherkin
Scenario: Dashboard with no data
  Given new organization with no quality data
  When viewing dashboard
  Then empty state message:
    "No quality data yet. Get started by creating inspections or NCRs."
  And [Create First Inspection] button shown
  And sample data preview available

Scenario: Dashboard with partial data
  Given organization has inspections but no NCRs
  When viewing dashboard
  Then inspection widgets display data
  And NCR trend chart shows empty state: "No NCR data for selected period"
  And other widgets display normally
```

### AC-12: Mobile Responsiveness

```gherkin
Scenario: Dashboard on mobile
  Given user accessing dashboard on mobile (< 768px width)
  When page loads
  Then layout adjusts:
    - KPI cards stack vertically (1 per row)
    - Charts resize to full width
    - Date filter becomes dropdown
    - Heatmap becomes scrollable table
  And all interactions remain functional
```

### AC-13: RLS Policy Enforcement

```gherkin
Scenario: Org isolation on dashboard data
  Given User A from Org A and User B from Org B
  When User A loads dashboard
  Then sees only Org A data
  And cannot access Org B data via API

Scenario: Cross-org data leak prevention
  Given User A from Org A
  When attempting to load dashboard with org_id=B in query params
  Then API returns 404 Not Found
  And RLS policy blocks data access
```

---

## Implementation Notes

### API Endpoints

```typescript
// =============================================================================
// Dashboard Endpoints
// =============================================================================

// GET /api/quality/dashboard/kpis
interface DashboardKPIsRequest {
  date_from?: string; // ISO date
  date_to?: string;   // ISO date
}

interface DashboardKPIsResponse {
  kpis: {
    first_pass_yield: {
      current: number;
      target: number;
      trend: 'up' | 'down' | 'stable';
      previous_period: number;
    };
    ncr_rate: {
      current: number; // per 1000 batches
      target: number;
      trend: 'up' | 'down' | 'stable';
      previous_period: number;
    };
    ccp_compliance: {
      current: number; // percentage
      target: number;
      trend: 'up' | 'down' | 'stable';
      previous_period: number;
    };
    inspection_backlog: {
      current: number;
      target: number;
      trend: 'up' | 'down' | 'stable';
      breakdown: {
        scheduled: number;
        in_progress: number;
      };
    };
    capa_closure_rate: {
      current: number; // percentage
      target: number;
      trend: 'up' | 'down' | 'stable';
      overdue_count: number;
    };
  };
  refreshed_at: string; // ISO timestamp
}

// GET /api/quality/dashboard/ncr-trend
interface NCRTrendRequest {
  date_from?: string;
  date_to?: string;
  bucket?: 'day' | 'week' | 'month'; // Auto-calculated based on range
}

interface NCRTrendResponse {
  data: Array<{
    date: string; // ISO date or week/month label
    total: number;
    critical: number;
    major: number;
    minor: number;
  }>;
}

// GET /api/quality/dashboard/defect-pareto
interface DefectParetoRequest {
  date_from?: string;
  date_to?: string;
  limit?: number; // Default 10
}

interface DefectParetoResponse {
  data: Array<{
    defect_type: string;
    count: number;
    severity: 'critical' | 'major' | 'minor';
    percentage: number;
    cumulative_percentage: number;
  }>;
}

// GET /api/quality/dashboard/inspection-status
interface InspectionStatusRequest {
  date_from?: string;
  date_to?: string;
}

interface InspectionStatusResponse {
  data: {
    scheduled: number;
    in_progress: number;
    completed: number;
    cancelled: number;
  };
  total: number;
}

// GET /api/quality/dashboard/supplier-heatmap
interface SupplierHeatmapRequest {
  limit?: number; // Default 10
}

interface SupplierHeatmapResponse {
  suppliers: Array<{
    supplier_id: string;
    supplier_name: string;
    defect_rate: number; // percentage
    on_time_rate: number; // percentage
    coa_compliance: number; // percentage
    overall_score: number; // average of above
  }>;
}

// POST /api/quality/dashboard/export-pdf
interface ExportDashboardPDFRequest {
  date_from?: string;
  date_to?: string;
  include_charts?: boolean; // Default true
}

interface ExportDashboardPDFResponse {
  pdf_url: string; // Temporary signed URL (expires in 1 hour)
  filename: string;
  generated_at: string;
}
```

### Service Layer

```typescript
// lib/services/dashboard-service.ts

export class DashboardService {
  /**
   * Get all KPIs for dashboard
   */
  static async getKPIs(dateFrom?: Date, dateTo?: Date): Promise<DashboardKPIs>;

  /**
   * Get NCR trend data
   */
  static async getNCRTrend(
    dateFrom: Date,
    dateTo: Date,
    bucket: 'day' | 'week' | 'month'
  ): Promise<NCRTrendData[]>;

  /**
   * Get defect Pareto data (top N defect types)
   */
  static async getDefectPareto(
    dateFrom: Date,
    dateTo: Date,
    limit: number
  ): Promise<DefectParetoData[]>;

  /**
   * Get inspection status breakdown
   */
  static async getInspectionStatus(
    dateFrom?: Date,
    dateTo?: Date
  ): Promise<InspectionStatusData>;

  /**
   * Get supplier quality heatmap data
   */
  static async getSupplierHeatmap(limit: number): Promise<SupplierHeatmapData[]>;

  /**
   * Export dashboard as PDF
   */
  static async exportDashboardPDF(
    dateFrom?: Date,
    dateTo?: Date,
    includeCharts?: boolean
  ): Promise<{ url: string; filename: string }>;

  /**
   * Calculate trend direction (up/down/stable)
   */
  static calculateTrend(current: number, previous: number): 'up' | 'down' | 'stable';

  /**
   * Refresh materialized view (for KPIs)
   */
  static async refreshKPIsCache(): Promise<void>;
}
```

### Frontend Components

```
apps/frontend/app/(authenticated)/quality/
  dashboard/
    page.tsx                          -- Main dashboard page

components/quality/dashboard/
  QualityDashboard.tsx                -- Dashboard container
  KPISummaryCards.tsx                 -- 5 KPI cards grid
  KPICard.tsx                         -- Individual KPI card with trend
  NCRTrendChart.tsx                   -- Line chart (Recharts)
  DefectParetoChart.tsx               -- Pareto bar+line chart (Recharts)
  InspectionStatusPieChart.tsx        -- Pie chart (Recharts)
  SupplierQualityHeatmap.tsx          -- Heatmap table visualization
  DashboardDateFilter.tsx             -- Date range filter dropdown
  DashboardExportPDFButton.tsx        -- PDF export button
  DashboardRefreshButton.tsx          -- Manual refresh button
  DashboardEmptyState.tsx             -- Empty state when no data
  DashboardLoadingSkeleton.tsx        -- Loading skeleton
  DashboardWebSocketProvider.tsx     -- WebSocket connection for real-time updates
```

### UI Libraries

**Charts**: Recharts (already in use)
**Heatmap**: Custom table with color-coded cells (CSS gradients)
**PDF Export**: jsPDF + html2canvas (server-side with Puppeteer preferred)
**WebSocket**: Supabase Realtime or native WebSocket API

---

## Key Business Rules

1. **KPI Targets Configurable**: KPI targets (FPY >95%, NCR Rate <5, etc.) configurable per organization in quality_settings
2. **Date Range Default**: Default dashboard shows last 90 days
3. **Real-Time Critical Metrics**: First Pass Yield and CCP Compliance update real-time via WebSocket
4. **Role-Based Views**: QA Inspector sees limited dashboard; QA Manager/Director see full dashboard
5. **PDF Export Permissions**: PDF export requires QA_MANAGER or QUALITY_DIRECTOR role
6. **Dashboard Cache**: KPIs cached in materialized view, refreshed every 5 minutes
7. **Drill-Down Links**: All widgets link to underlying data (inspections, NCRs, test results)
8. **Mobile Responsive**: Dashboard fully responsive for tablet/mobile viewing
9. **Empty State Guidance**: Empty states provide actionable guidance to get started
10. **Supplier Heatmap Top 10**: Heatmap limited to top 10 suppliers by purchase volume or inspection count

---

## Deliverables

### Database
- [ ] Materialized view: `quality_dashboard_kpis` (optional, for performance)
- [ ] Refresh function: `refresh_dashboard_kpis()`
- [ ] RLS policies for materialized view

### API Routes
- [ ] `GET /api/quality/dashboard/kpis` - KPI summary
- [ ] `GET /api/quality/dashboard/ncr-trend` - NCR trend data
- [ ] `GET /api/quality/dashboard/defect-pareto` - Defect Pareto data
- [ ] `GET /api/quality/dashboard/inspection-status` - Inspection status breakdown
- [ ] `GET /api/quality/dashboard/supplier-heatmap` - Supplier quality heatmap
- [ ] `POST /api/quality/dashboard/export-pdf` - PDF export

### Service Layer
- [ ] `DashboardService.getKPIs()` - Aggregate KPI data
- [ ] `DashboardService.getNCRTrend()` - Time-series NCR data
- [ ] `DashboardService.getDefectPareto()` - Defect frequency analysis
- [ ] `DashboardService.getInspectionStatus()` - Status breakdown
- [ ] `DashboardService.getSupplierHeatmap()` - Supplier quality matrix
- [ ] `DashboardService.exportDashboardPDF()` - PDF generation
- [ ] `DashboardService.calculateTrend()` - Trend calculation utility

### Frontend
- [ ] Dashboard page: `/quality/dashboard`
- [ ] 5 KPI cards with trend indicators
- [ ] NCR trend line chart
- [ ] Defect Pareto chart
- [ ] Inspection status pie chart
- [ ] Supplier quality heatmap
- [ ] Date range filter
- [ ] PDF export button
- [ ] WebSocket provider for real-time updates
- [ ] Loading skeletons and empty states
- [ ] Mobile responsive layout

### Tests
- [ ] Unit tests: DashboardService methods (>80% coverage)
- [ ] Integration tests: All API endpoints
- [ ] E2E: Full dashboard load and interaction
- [ ] E2E: Date filter and drill-down
- [ ] E2E: PDF export
- [ ] Performance tests: Dashboard load time <2s

---

## Definition of Done

### Database
- [ ] Materialized view created and indexed
- [ ] Refresh function works correctly
- [ ] RLS policies enforce org isolation

### API
- [ ] All 6 endpoints return correct data
- [ ] Response times < 500ms for all endpoints
- [ ] PDF export completes within 5 seconds
- [ ] RLS policies prevent cross-org data access

### Service
- [ ] All KPI calculations accurate
- [ ] Trend calculation logic correct
- [ ] Date filtering works for all endpoints
- [ ] PDF generation includes all charts

### Frontend
- [ ] Dashboard loads within 2 seconds
- [ ] All 5 KPI cards display correctly
- [ ] All 4 charts render correctly
- [ ] Date filter updates all widgets
- [ ] Drill-down links navigate correctly
- [ ] PDF export downloads successfully
- [ ] WebSocket updates KPIs in real-time
- [ ] Mobile layout responsive
- [ ] Empty states display when appropriate

### Testing
- [ ] Unit tests: >80% coverage
- [ ] Integration tests: All endpoints covered
- [ ] E2E tests: Full dashboard workflow
- [ ] Performance tests: Load time verified

---

## Risk Assessment

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Dashboard load performance | HIGH | MEDIUM | Materialized view for KPIs, server-side caching |
| Chart rendering performance | MEDIUM | LOW | Use Recharts with lazy loading, limit data points |
| PDF generation timeout | MEDIUM | MEDIUM | Server-side PDF generation with Puppeteer, 30s timeout |
| WebSocket connection reliability | MEDIUM | MEDIUM | Fallback to polling, reconnection logic |
| Mobile chart readability | MEDIUM | LOW | Responsive chart sizing, touch-friendly interactions |
| Data accuracy in KPIs | HIGH | LOW | Comprehensive unit tests, manual QA verification |

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-01-15 | Initial story creation for Quality Dashboard | OPUS |

---

**Document Status**: Ready for Implementation
**Created**: 2025-01-15
**Lines**: ~950
**Complexity**: L (Large)
**Phase**: 4 (Analytics & Reporting)
