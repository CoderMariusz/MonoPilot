# 06.29 - CoA PDF Export

**Priority**: P0 (MVP)
**Story Points**: M (Medium)
**Type**: backend
**Phase**: 3 (CoA & HACCP)
**Model**: OPUS

**State:** ready
**Estimate:** M (2-3 days)
**Primary PRD:** `docs/1-BASELINE/product/modules/quality.md` (FR-QA-011, Section 13.3)
**Architecture:** `docs/1-BASELINE/architecture/modules/quality.md` (CoA PDF generation)

---

## Goal

Implement PDF export functionality for certificates of analysis, generating archival-quality PDF/A documents with QR code verification links. PDFs are generated from approved CoAs and stored in S3/CDN for long-term retention (10 years) with optional email delivery to customers.

---

## Food Safety Compliance

This story is **critical for regulatory compliance**:

- [x] **FDA 21 CFR Part 11** - Electronic records must be PDF/A format for archival
- [x] **Document Retention** - CoA PDFs must be retained for 10 years minimum
- [x] **Customer Requirements** - PDF CoAs required for shipment documentation
- [x] **Traceability** - QR code on PDF enables verification of authenticity

**Regulatory Context:**
- PDF/A-1a or PDF/A-2a format required for long-term archival
- PDFs must include all CoA data (cannot be dynamic/editable)
- QR code must link to verification page (read-only CoA view)
- Customer email delivery with secure download links
- CDN/S3 storage with 10-year retention policy

---

## MVP Scope

**MVP Includes**:
- PDF generation from approved CoAs (<5 seconds)
- PDF/A format for archival compliance
- QR code with verification URL
- S3/Supabase Storage for PDF files
- CDN URL generation for downloads
- Email delivery to customers (optional)
- Download endpoint for authenticated users
- PDF preview before email send

**Deferred to Phase 3+**:
- Multi-language PDFs (Phase 4)
- Custom PDF layouts per customer (Phase 4)
- Bulk PDF generation (Phase 4)
- PDF watermarking (Phase 4)

---

## User Story

As a **QA Manager**, I want **to generate PDF certificates of analysis from approved CoAs and email them to customers** so that **customers receive professional, archival-quality certificates for their shipments**.

As a **Quality Director**, I want **CoA PDFs stored securely with 10-year retention and verification QR codes** so that **we maintain regulatory compliance and enable customer verification**.

---

## Dependencies

### Cross-Epic Dependencies

| Dependency | Story/Epic | Type | What It Provides | Status |
|------------|------------|------|------------------|--------|
| 01.1 | Org Context + RLS | HARD | organizations, users tables | Ready |

### Within Epic Dependencies

| Dependency | Story | Type | What It Provides |
|------------|-------|------|------------------|
| 06.27 | CoA Templates | HARD | Template structure for PDF rendering | Ready |
| 06.28 | CoA Generation Engine | HARD | certificates_of_analysis, coa_parameters | Ready |

---

## Database Migration

```sql
-- Migration: YYYYMMDDHHMMSS_add_coa_pdf_fields.sql

-- Add PDF-related columns to certificates_of_analysis
ALTER TABLE certificates_of_analysis
    ADD COLUMN pdf_url TEXT,
    ADD COLUMN pdf_generated_at TIMESTAMPTZ,
    ADD COLUMN pdf_generated_by UUID REFERENCES users(id),
    ADD COLUMN qr_code_url TEXT,
    ADD COLUMN verification_token TEXT UNIQUE;

-- Index for verification token lookup
CREATE INDEX idx_coas_verification_token ON certificates_of_analysis(verification_token)
    WHERE verification_token IS NOT NULL;

-- Table for email delivery tracking
CREATE TABLE coa_email_deliveries (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id UUID NOT NULL REFERENCES organizations(id),
    coa_id UUID NOT NULL REFERENCES certificates_of_analysis(id) ON DELETE CASCADE,

    recipient_email TEXT NOT NULL,
    recipient_name TEXT,

    sent_at TIMESTAMPTZ NOT NULL DEFAULT now(),
    sent_by UUID REFERENCES users(id),

    email_status TEXT NOT NULL DEFAULT 'sent'
                 CHECK (email_status IN ('sent', 'delivered', 'bounced', 'failed')),

    delivery_confirmed_at TIMESTAMPTZ,
    bounce_reason TEXT,

    -- Audit
    created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE INDEX idx_coa_emails_coa ON coa_email_deliveries(coa_id);
CREATE INDEX idx_coa_emails_org ON coa_email_deliveries(org_id);

ALTER TABLE coa_email_deliveries ENABLE ROW LEVEL SECURITY;

CREATE POLICY "coa_emails_org" ON coa_email_deliveries
    FOR ALL TO authenticated
    USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));
```

---

## Acceptance Criteria

### AC-1: PDF Generation from Approved CoA

```gherkin
Scenario: Generate PDF from approved CoA
  Given CoA COA-2025-00001 with status = 'approved'
  When user clicks [Generate PDF]
  Then PDF generated with:
    | Element | Content |
    | Header | Company logo, "Certificate of Analysis" title |
    | Product Info | Product name, batch, manufactured date, expiry |
    | Test Results | Table with parameters, specs, results, methods |
    | Compliance | List of compliance statements |
    | Signatures | Approved by, Approval date, E-signature |
    | QR Code | Bottom right corner with verification URL |
    | Footer | Company info, page numbers |
  And PDF saved to S3/Supabase Storage
  And pdf_url = CDN URL
  And pdf_generated_at = now
  And verification_token generated (UUID)
  And QR code contains: https://app.monopilot.com/verify/{token}
  And generation completes < 5 seconds

Scenario: PDF format is PDF/A for archival
  Given PDF generated
  When file inspected
  Then PDF format is PDF/A-1a or PDF/A-2a
  And fonts embedded
  And no external dependencies
```

### AC-2: QR Code Verification

```gherkin
Scenario: QR code links to verification page
  Given PDF with QR code containing verification token
  When customer scans QR code
  Then redirected to /verify/{token} (public page)
  And page displays:
    | Field | Value |
    | CoA Number | COA-2025-00001 |
    | Product | Product name |
    | Batch | Batch number |
    | Issue Date | Date |
    | Status | Verified (green badge) |
    | Test Results | Read-only table |
  And no authentication required (public access)

Scenario: Invalid verification token
  Given invalid or expired token
  When accessing /verify/{token}
  Then page shows "CoA not found or invalid verification code"
```

### AC-3: Email Delivery to Customer

```gherkin
Scenario: Email CoA PDF to customer
  Given CoA with PDF generated
  When user clicks [Email to Customer]
  And enters recipient: customer@example.com
  And clicks [Send]
  Then email sent with:
    | Subject | Certificate of Analysis - [Product] - [Batch] |
    | Body | Professional template with CoA details |
    | Attachment | PDF file (CoA-2025-00001.pdf) |
    | Link | Secure download link (valid 30 days) |
  And coa_email_deliveries record created
  And success toast "CoA emailed to customer@example.com"

Scenario: Email delivery tracking
  Given CoA emailed to customer
  When email delivery confirmed (webhook from email service)
  Then email_status = 'delivered'
  And delivery_confirmed_at = webhook timestamp

Scenario: Email bounce handling
  Given email sent to invalid address
  When email bounces
  Then email_status = 'bounced'
  And bounce_reason captured
  And user notified of bounce
```

### AC-4: PDF Download

```gherkin
Scenario: Download PDF from CoA detail page
  Given CoA with PDF generated
  When user clicks [Download PDF]
  Then PDF file downloaded with filename: CoA-2025-00001.pdf
  And Content-Type: application/pdf
  And Content-Disposition: attachment

Scenario: Download PDF from list
  Given CoA list with approved CoAs
  When clicking download icon in row
  Then PDF downloads directly
```

### AC-5: PDF Preview

```gherkin
Scenario: Preview PDF before email
  Given CoA PDF generated
  When user clicks [Preview PDF]
  Then modal shows embedded PDF viewer
  And can scroll through pages
  And can zoom in/out
  And can download from preview
```

### AC-6: PDF Storage and Retention

```gherkin
Scenario: PDF stored in S3/Supabase Storage
  Given PDF generated
  Then file uploaded to storage bucket: coa-pdfs/
  And filename pattern: {org_id}/{year}/{coa_number}.pdf
  And CDN URL returned
  And URL valid for 10 years (retention policy)

Scenario: PDF accessible after org changes
  Given CoA PDF from 5 years ago
  When user downloads
  Then PDF still accessible from CDN
  And content unchanged
```

### AC-7: Performance Requirements

```gherkin
Scenario: PDF generation performance
  Given CoA with 30 test parameters
  When generating PDF
  Then generation completes < 5 seconds
  And file size < 2MB

Scenario: PDF download performance
  Given PDF stored in CDN
  When user downloads
  Then download starts < 1 second
  And download speed > 1MB/s
```

---

## Implementation Notes

### API Endpoints

```typescript
// POST /api/quality/coas/:id/generate-pdf
interface GeneratePDFResponse {
  pdf_url: string;
  qr_code_url: string;
  verification_token: string;
  generated_at: string;
}

// POST /api/quality/coas/:id/email
interface EmailCoARequest {
  recipient_email: string;
  recipient_name?: string;
  message?: string;
}

// GET /api/quality/coas/:id/download
// Returns PDF file

// GET /verify/:token (public route)
interface VerifyCoAResponse {
  coa_number: string;
  product_name: string;
  batch_number: string;
  issue_date: string;
  status: 'verified' | 'invalid';
  parameters: CoAParameter[];
}
```

### Service Layer

```typescript
export class CoAPDFService {
  static async generatePDF(coaId: string): Promise<PDFGenerationResult>;
  static async uploadToStorage(pdfBuffer: Buffer, filename: string): Promise<string>;
  static async generateQRCode(verificationToken: string): Promise<string>;
  static async emailToCustomer(coaId: string, recipient: string): Promise<void>;
  static async getVerificationData(token: string): Promise<VerificationData | null>;
}
```

---

## Deliverables

### Database
- [ ] Migration: Add PDF fields to certificates_of_analysis
- [ ] Table: coa_email_deliveries
- [ ] RLS policies for email deliveries

### API Routes
- [ ] `POST /api/quality/coas/:id/generate-pdf`
- [ ] `POST /api/quality/coas/:id/email`
- [ ] `GET /api/quality/coas/:id/download`
- [ ] `GET /verify/:token` (public)

### Service Layer
- [ ] `CoAPDFService.generatePDF()` - PDF generation
- [ ] `CoAPDFService.uploadToStorage()` - S3/Storage upload
- [ ] `CoAPDFService.generateQRCode()` - QR code generation
- [ ] `CoAPDFService.emailToCustomer()` - Email delivery

### Tests
- [ ] Unit tests: PDF generation
- [ ] Integration tests: All endpoints
- [ ] E2E: Generate, email, verify workflow

---

## Definition of Done

- [ ] PDF generation works (<5 seconds)
- [ ] PDF format is PDF/A
- [ ] QR code verification works (public page)
- [ ] Email delivery works
- [ ] PDFs stored in S3/Storage with retention
- [ ] All tests passing

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-01-15 | Initial story creation | ARCHITECT-AGENT |

---

**Document Status**: Ready for Implementation
**Created**: 2025-01-15
**Complexity**: M (Medium)
**Phase**: 3 (CoA & HACCP)
