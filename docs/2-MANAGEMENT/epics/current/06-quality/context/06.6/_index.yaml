# Story 06.6 - Index File (Entry Point)
# Generated: 2025-12-17
# Purpose: Story metadata and dependencies - read this first

story:
  id: "06.6"
  name: "Test Results Recording"
  slug: "test-results-recording"
  epic: "06-quality"
  phase: "1A"
  complexity: "M"
  estimate_days: 3
  type: "frontend + backend + database"
  state: "ready"
  priority: "P0"

# Files in this context folder
context_files:
  - _index.yaml        # This file - metadata, dependencies
  - database.yaml      # Tables (quality_test_results), migrations, RLS
  - api.yaml           # Endpoints (POST/GET test results), auth
  - frontend.yaml      # Components (TestResultsForm, TestResultsTable), wireframes
  - validation.yaml    # Zod schemas for test results, validation rules
  - tests.yaml         # Acceptance criteria, unit/integration/E2E tests
  - gaps.yaml          # Readiness assessment

# Dependencies
dependencies:
  required:
    - story: "01.1"
      name: "Org Context + Base RLS"
      provides:
        - "organizations table"
        - "users table with org_id"
        - "RLS foundation"
    - story: "02.1"
      name: "Product Module"
      provides:
        - "products table"
    - story: "06.3"
      name: "Quality Specifications"
      provides:
        - "quality_specifications table"
        - "quality_spec_parameters table (with parameter_type, min/max/target values)"
    - story: "06.4"
      name: "Test Parameters"
      provides:
        - "quality_spec_parameters with acceptance criteria"
        - "parameter validation rules (numeric, text, boolean)"
    - story: "06.5"
      name: "Incoming Inspection"
      provides:
        - "quality_inspections table"
        - "inspection lifecycle (scheduled, in_progress, completed)"
  optional:
    - story: "01.10"
      name: "Equipment/Machines"
      provides:
        - "machines table for equipment tracking"
        - "calibration_date field support"
      impact: "Equipment tracking disabled if missing"
  blocked_by: []
  dependents:
    - epic: "06"
      name: "Quality Module"
      requires: "Test results for quality holds, NCR creation"

# Reference Documents
files_to_read:
  prd:
    path: "docs/1-BASELINE/product/modules/quality.md"
    sections: ["FR-QA-004", "Section 4.1", "Section 5", "Section 9"]
  architecture:
    path: "docs/1-BASELINE/architecture/modules/quality.md"
    sections: ["quality_test_results table", "Test Result Recording section"]
  story:
    path: "docs/2-MANAGEMENT/epics/current/06-quality/06.6.test-results-recording.md"
  wireframes:
    - id: "QA-004"
      path: "docs/3-ARCHITECTURE/ux/wireframes/QA-004-test-templates.md"
      sections: ["Test Result Recording (Embedded in Inspection)", "With Failed Result"]
    - id: "QA-005"
      path: "docs/3-ARCHITECTURE/ux/wireframes/QA-005-incoming-inspection.md"
      sections: ["Incoming Inspection detail", "Test Results step"]
    - id: "QA-006"
      path: "docs/3-ARCHITECTURE/ux/wireframes/QA-006-in-process-inspection.md"
      sections: ["In-Process Inspection detail", "Test Results step"]
  adrs:
    - path: "docs/1-BASELINE/architecture/decisions/ADR-013-rls-org-isolation-pattern.md"
      relevance: "RLS for quality_test_results org isolation"

# High-level deliverables
deliverables:
  - type: "migration"
    count: 1
    description: "quality_test_results table with RLS, indexes"
  - type: "validation"
    count: 1
    description: "Zod schemas (create, batch, update, query)"
  - type: "service"
    count: 1
    description: "TestResultsService with validation logic"
  - type: "api"
    count: 4
    description: "POST /test-results, GET /test-results/inspection/:id, PUT/DELETE"
  - type: "component"
    count: 3
    description: "TestResultsForm, TestResultsTable, TestResultsSummary"
  - type: "test"
    count: 3
    description: "Unit tests (validation), Integration tests (API), E2E tests"

# Technical notes
technical_notes:
  - "Test results table stores: measured_value (TEXT), numeric_value (DECIMAL), result_status (pass/fail/marginal)"
  - "Marginal detection: 5% rule for numeric parameters within valid range"
  - "Auto-calculation: pass/fail/marginal based on parameter acceptance criteria"
  - "Overall inspection result: All critical parameters must pass"
  - "Quality hold creation: Automatic on fail result (sync with Story 06.2)"
  - "Equipment tracking: Optional, references machines table (Epic 01.10)"
  - "Multi-type support: numeric (min/max range), text (exact match), boolean (true/false)"
  - "Result immutability: Test results cannot be edited after save (audit trail)"
  - "Batch create: Support 1-100 results per API call"
  - "Indexed for performance: inspection_id, parameter_id, org_id + status"

# Implementation notes
implementation_notes:
  - "Do NOT modify quality_spec_parameters - use existing data from Story 06.4"
  - "Integrate with quality_inspections.overall_result auto-calculation"
  - "On fail: trigger quality hold creation (if Story 06.2 available)"
  - "Validation layer: client-side (Zod) + server-side (Supabase check)"
  - "Alert system: Email QA Manager on critical parameter failure (Future: Story 06.17)"
  - "NCR creation: Optional, user can checkbox on failure (Future: Story 06.9)"
