# Epic 06 Quality Module - Story Creation Brief

**Date:** 2025-12-16
**Author:** ARCHITECT-AGENT
**Status:** READY FOR STORY CREATION
**Target Audience:** Story-writing agents (DEV-AGENT, TECH-WRITER)

---

## Executive Summary

This brief provides comprehensive guidance for creating Epic 06 (Quality Module) stories with **Food Safety Compliance as the critical path**. The Quality Module enables regulatory compliance (HACCP, FDA 21 CFR Part 11) and batch release workflows.

**Key Statistics:**
- PRD Lines: ~850
- Functional Requirements: 27 total (FR-QA-001 to FR-QA-026 + FR-QA-026)
- Phase 1 (Core Quality): 10 stories - **MVP**
- Phase 2 (In-Process & Final): 11 stories
- Phase 3 (HACCP & CoA): 10 stories
- Phase 4 (CAPA & Supplier): 10 stories
- Architecture: `/docs/1-BASELINE/architecture/modules/quality.md`
- PRD: `/docs/1-BASELINE/product/modules/quality.md`

**CRITICAL CONSTRAINT:** Phase 1 (Core Quality) enables incoming inspection. Phase 3 (HACCP/CCP) enables food safety compliance.

---

## 1. Story Breakdown Strategy

### 1.1 Phase Structure (Compliance First)

| Phase | Focus | Stories | Days | Priority |
|-------|-------|---------|------|----------|
| **Phase 1** | **Core Quality** | 10 | 12-16 | **P0 (MVP)** |
| Phase 2 | In-Process & Final | 11 | 14-18 | P0 |
| Phase 3 | HACCP & CoA | 10 | 14-18 | P1 |
| Phase 4 | CAPA & Supplier | 10 | 12-16 | P2 |

### 1.2 MVP vs Phase Split Recommendations

**MVP (Phase 1) - Core QA Operations:**
- Quality settings and status types
- Quality holds (inventory blocking)
- Product specifications with test parameters
- Incoming inspection workflow
- Test results recording
- Sampling plans (AQL)
- Scanner QA pass/fail
- Basic NCR creation

**Phase 1+ (In-Process & Final):**
- In-process inspection tied to WO
- Final inspection and batch release
- Full NCR workflow
- Operation quality checkpoints

**Phase 2+ (HACCP & CoA):**
- HACCP plans and CCPs
- CCP monitoring (desktop + scanner)
- CCP deviation alerts
- CoA templates and generation

**Phase 3+ (CAPA & Supplier):**
- Full CAPA workflow
- Supplier quality ratings
- Supplier audits
- Quality analytics

### 1.3 Recommended .Xa/.Xb Splits

Based on complexity and dependency analysis, these stories should be split:

#### 06.5 Incoming Inspection (Recommend Split)

```
06.5 (L)
  |
  +-- 06.5a: Incoming Inspection Core (MVP)
  |     - Inspection creation from PO receipt
  |     - Basic pass/fail workflow
  |     - LP QA status update
  |     Complexity: M
  |
  +-- 06.5b: Incoming Inspection Advanced (Phase 1+)
        - Auto-create from GRN (if setting enabled)
        - Sampling plan integration
        - Multi-sample inspections
        Complexity: M
```

#### 06.13 NCR Workflow (Recommend Split)

```
06.13 (L)
  |
  +-- 06.13a: NCR Workflow Core (MVP)
  |     - Draft -> Open -> Closed states
  |     - Basic assignment
  |     - Simple close workflow
  |     Complexity: M
  |
  +-- 06.13b: NCR Workflow Advanced (Phase 1+)
        - Full state machine (Investigation, Root Cause, Corrective Action, Verification)
        - Parallel workflow steps
        - Escalation rules
        Complexity: L
```

#### 06.21 HACCP Plan Setup (Recommend Split)

```
06.21 (L)
  |
  +-- 06.21a: HACCP Plan Core (MVP)
  |     - Plan header CRUD
  |     - Product assignment
  |     - Basic approval workflow
  |     Complexity: M
  |
  +-- 06.21b: HACCP Plan Advanced (Phase 2+)
        - Plan versioning
        - Review scheduling
        - Plan cloning
        Complexity: M
```

#### 06.28 CoA Generation (Recommend Split)

```
06.28 (L)
  |
  +-- 06.28a: CoA Generation Core (MVP)
  |     - Manual CoA creation
  |     - Test results inclusion
  |     - Basic PDF generation
  |     Complexity: M
  |
  +-- 06.28b: CoA Generation Advanced (Phase 2+)
        - Auto-generate on batch release
        - Email to customer
        - E-signature integration
        Complexity: M
```

---

## 2. MVP Scope Definition

### 2.1 Phase 1 MVP (Core Quality)

These stories deliver the MINIMUM for incoming QA operations:

| Story | Minimum Deliverables | Why Essential |
|-------|---------------------|---------------|
| 06.0 | `quality_settings` table, settings service | Foundation |
| 06.1 | Quality status enum (PENDING/PASSED/FAILED/HOLD) | Status management |
| 06.2 | `quality_holds`, `quality_hold_items` tables | Inventory blocking |
| 06.3 | `quality_specifications` table | Test templates |
| 06.4 | `quality_spec_parameters` table | Acceptance criteria |
| 06.5a | Incoming inspection workflow (core) | GRN QA gate |
| 06.6 | `quality_test_results` table | Data capture |
| 06.7 | `sampling_plans` table | Statistical QA |
| 06.8 | Scanner QA pass/fail | Mobile QA |
| 06.9 | Basic NCR creation | Non-conformance |

**What Phase 1 MVP Does NOT Include:**
- In-process inspection (requires Epic 04 WO)
- Final inspection (requires Epic 04 WO)
- Batch release (requires final inspection)
- Full NCR workflow (5 steps)
- HACCP plans and CCPs
- CCP monitoring
- CoA generation
- CAPA workflow
- Supplier quality ratings
- Quality dashboard

### 2.2 Critical Food Safety Requirements

**MVP Must Support:**
1. **Quality Hold** - Block inventory from consumption
2. **LP QA Status Update** - Pass/Fail affects LP availability
3. **Inspection Audit Trail** - Who inspected, when, what result
4. **NCR Creation** - Document non-conformances

**Phase 2 Food Safety (HACCP):**
1. **CCP Monitoring** - Record critical values
2. **Deviation Alerts** - Real-time (<30 seconds)
3. **Auto-NCR on CCP Failure** - Link deviation to NCR
4. **HACCP Verification** - Periodic review records

### 2.3 LP QA Status Integration (Epic 05 Dependency)

Quality module updates LP QA status:

```sql
-- license_plates table (from Epic 05)
qa_status TEXT NOT NULL DEFAULT 'pending'  -- pending, passed, failed, quarantine

-- Quality module updates this field:
UPDATE license_plates SET qa_status = 'passed' WHERE id = :lp_id;
UPDATE license_plates SET qa_status = 'failed' WHERE id = :lp_id;
UPDATE license_plates SET qa_status = 'quarantine' WHERE id = :lp_id;

-- Hold blocks consumption:
-- LP with qa_status != 'passed' cannot be consumed in Production
```

---

## 3. Story Template

### 3.1 Standard Story Structure

All Epic 06 stories should follow this template:

```markdown
# 06.X - [Story Title]

**Priority**: P0 (MVP) | P1 (Phase 1) | P2 (Phase 2+)
**Story Points**: S (1-2 days) | M (3-4 days) | L (5-7 days)
**Type:** backend | frontend | backend + frontend | scanner

**State:** ready | in_progress | done
**Primary PRD:** `docs/1-BASELINE/product/modules/quality.md` (FR-QA-XXX)
**Architecture:** `docs/1-BASELINE/architecture/modules/quality.md`

---

## MVP Scope

[Describe what is in this story's MVP scope]

---

## Food Safety Compliance

[State if this story is required for food safety compliance]
- [ ] HACCP Compliance
- [ ] FDA 21 CFR Part 11
- [ ] Audit Trail Required
- [ ] Not compliance-critical

---

## Goal

[1-2 sentences describing the objective]

## User Story

As a **[QA Inspector/QA Manager]**, I want **[action]** so that **[benefit]**.

## Scope

**In scope (this story)**
- [Specific features]

**Out of scope (this story)**
- [What's NOT included, reference other stories]

## Dependencies

- **01.X** - [Description]
- **02.X** - [Description]
- **05.X** - [LP QA status field]

## Acceptance Criteria (Given/When/Then)

### AC-1: [Feature Name]

**Given** [precondition]
**When** [action]
**Then** [expected result]

[Repeat for all ACs - aim for 5-10 ACs per story]

## Compliance Requirements

### Audit Trail
- [ ] All creates logged
- [ ] All updates logged with change reason
- [ ] Delete not allowed (soft delete only)

### E-Signature (if applicable)
- [ ] User ID + password re-entry
- [ ] Timestamp with timezone
- [ ] Meaning of signature captured

## Scanner UI Requirements (if applicable)

### Touch Targets
- Minimum 48x48 pixels for all buttons
- Large barcode scan area

### Audio Feedback
- Success tone on valid scan
- Error beep on invalid scan

## Implementation Notes

### API Endpoints

```typescript
GET /api/quality/[resource]
POST /api/quality/[resource]
```

### Database

```sql
-- Reference tables from architecture doc
```

### Frontend Components

```
app/(authenticated)/quality/[route]/
  components/
    [ComponentName].tsx
```

### Services

```typescript
// lib/services/[resource]-service.ts
export async function [operation](): Promise<[Type]>
```

### Validation (Zod)

```typescript
const [schema]Schema = z.object({
  // Fields
});
```

### Key Business Rules

1. [Rule 1]
2. [Rule 2]

## Deliverables

- API routes: [list endpoints]
- Components: [list components]
- Services: [list services]
- Tests: [describe test coverage]

## Definition of Done

- [ ] [Checkbox items]
- [ ] API tests passing (>80% coverage)
- [ ] RLS policies verified
- [ ] Audit trail working
- [ ] E2E smoke test for critical path

---

## Future Phases (Not in This Story)

### Phase 1+
- [Feature] - Brief description

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | YYYY-MM-DD | Initial story | [Agent] |
```

### 3.2 Required Sections for Quality Stories

Every story MUST have:
1. **MVP Scope** - Clear boundaries
2. **Food Safety Compliance** - HACCP, FDA 21 CFR Part 11 flags
3. **User Story** - As a / I want / So that
4. **Compliance Requirements** - Audit trail, e-signature if needed
5. **Scanner UI Requirements** - For scanner stories
6. **Acceptance Criteria** - Given/When/Then format (match PRD ACs)
7. **Key Business Rules** - From PRD Business Rules section
8. **Definition of Done** - Checkboxes
9. **Future Phases** - Deferred features

### 3.3 Complexity Guidelines

| Complexity | Days | When to Use | Model |
|------------|------|-------------|-------|
| S (Small) | 1-2 | Single feature, simple UI | sonnet |
| M (Medium) | 3-4 | Feature + relationships, moderate UI | sonnet |
| L (Large) | 5-7 | Complex workflow, scanner UI, multiple entities | opus |

---

## 4. Dependency Map

### 4.1 Story Dependencies Within Epic 06

```
06.0 (Quality Settings)
     |
     +---> 06.1 (Quality Status Types)
     |       |
     |       +---> 06.2 (Quality Holds) ---> Epic 05 LP QA Status
     |
     +---> 06.3 (Product Specifications)
     |       |
     |       +---> 06.4 (Test Parameters)
     |               |
     |               +---> 06.5/06.5a (Incoming Inspection) <---- Epic 03 PO
     |               |       |
     |               |       +---> 06.6 (Test Results)
     |               |       |
     |               |       +---> 06.7 (Sampling Plans)
     |               |       |
     |               |       +---> 06.8 (Scanner QA)
     |               |
     |               +---> 06.10 (In-Process Inspection) <---- Epic 04 WO
     |               |       |
     |               |       +---> 06.11 (Final Inspection)
     |               |               |
     |               |               +---> 06.12 (Batch Release)
     |               |                       |
     |               |                       +---> 06.27-06.29 (CoA)
     |               |
     |               +---> 06.19-06.20 (Op Checkpoints) <---- Epic 02 Routing
     |
     +---> 06.9 (Basic NCR)
     |       |
     |       +---> 06.13/06.13a (NCR Workflow)
     |       |       |
     |       |       +---> 06.14-06.16 (Root Cause to Close)
     |       |
     |       +---> 06.31 (CAPA Creation)
     |               |
     |               +---> 06.32-06.33 (Actions + Effectiveness)
     |
     +---> 06.21/06.21a (HACCP Plans) <---- Epic 02 Products
             |
             +---> 06.22 (CCP Definition)
             |       |
             |       +---> 06.23-06.24 (CCP Monitoring)
             |               |
             |               +---> 06.25-06.26 (Deviation + Alerts)
             |
             +---> 06.30 (HACCP Verification)
```

### 4.2 External Dependencies

| Epic 06 Story | From Epic 01 | From Epic 02 | From Epic 03 | From Epic 04 | From Epic 05 |
|---------------|--------------|--------------|--------------|--------------|--------------|
| 06.0 Settings | 01.1 (RLS) | - | - | - | - |
| 06.3 Specs | - | 02.1 (Products) | - | - | - |
| 06.5 Incoming | - | 02.1 (Products) | 03.3 (PO) | - | 05.1 (LP) |
| 06.10 In-Process | - | 02.1 (Products) | - | WO | 05.1 (LP) |
| 06.11 Final | - | 02.1 (Products) | - | WO | 05.1 (LP) |
| 06.19 Checkpoints | - | 02.7/02.8 (Routing) | - | WO | - |
| 06.21 HACCP | - | 02.1 (Products) | - | - | - |
| 06.23 CCP Monitor | - | - | - | WO | - |
| 06.34 Supplier | - | - | 03.1 (Suppliers) | - | - |

### 4.3 What Epic 06 Enables

```
Epic 06 Phase 1 Complete
    |
    +---> Epic 05: LP QA status updates work
    +---> Epic 07: Basic QA gate for shipping
    |
Epic 06 Phase 2 Complete
    |
    +---> Epic 04: In-process QA checks at operations
    +---> Epic 07: Batch release gate
    |
Epic 06 Phase 3 Complete
    |
    +---> Epic 07: CoA documents for shipments
    +---> HACCP Compliance operational
    |
Epic 06 Phase 4 Complete
    |
    +---> Supplier quality scorecard
    +---> Full quality analytics
```

---

## 5. Phase 1 Stories Detail (MVP)

### 06.0 Quality Settings

| Field | Value |
|-------|-------|
| Priority | P0 |
| Complexity | M |
| Dependencies | 01.1 |
| PRD FRs | FR-QA-* |

**Key Deliverables:**
- `quality_settings` table (1 row per org)
- Settings service
- Settings UI page

**Key Settings:**
```typescript
interface QualitySettings {
  require_incoming_inspection: boolean;
  require_final_inspection: boolean;
  auto_create_inspection_on_grn: boolean;
  default_sampling_level: 'I' | 'II' | 'III';
  ncr_auto_number_prefix: string;
  ncr_require_root_cause: boolean;
  ncr_critical_response_hours: number;
  ccp_deviation_escalation_minutes: number;
  ccp_auto_create_ncr: boolean;
  require_change_reason: boolean;
  retention_years: number;
}
```

### 06.1 Quality Status Types

| Field | Value |
|-------|-------|
| Priority | P0 |
| Complexity | S |
| Dependencies | 06.0 |
| PRD FRs | FR-QA-001 |

**Status Enum:**
```typescript
enum QAStatus {
  PENDING = 'pending',      // Awaiting inspection
  PASSED = 'passed',        // Meets specifications
  FAILED = 'failed',        // Does not meet specs
  HOLD = 'hold',            // Investigation required
  RELEASED = 'released',    // Approved after hold
  QUARANTINED = 'quarantine', // Isolated pending review
  CONDITIONAL = 'conditional' // Limited use allowed
}
```

**Business Rules:**
- PENDING allows consumption if `allow_pending_consumption` setting
- PASSED allows consumption and shipment
- FAILED blocks all operations
- HOLD blocks all operations
- QUARANTINE blocks all operations, requires physical isolation

### 06.2 Quality Holds CRUD

| Field | Value |
|-------|-------|
| Priority | P0 |
| Complexity | M |
| Dependencies | 06.1, Epic 05 |
| PRD FRs | FR-QA-002 |

**Tables:**
- `quality_holds` (header)
- `quality_hold_items` (items on hold)

**Key Features:**
- Create hold with reason
- Add LP(s) to hold
- Release hold with disposition
- Link to NCR (optional)
- Audit trail

**LP Integration:**
```sql
-- When hold created:
UPDATE license_plates SET qa_status = 'hold' WHERE id IN (:lp_ids);

-- When hold released:
UPDATE license_plates SET qa_status = :disposition_status WHERE id IN (:lp_ids);
-- disposition_status = 'passed' | 'failed' | 'quarantine'
```

### 06.3 Product Specifications

| Field | Value |
|-------|-------|
| Priority | P0 |
| Complexity | M |
| Dependencies | Epic 02.1 |
| PRD FRs | FR-QA-003 |

**Table:** `quality_specifications`

**Key Features:**
- Link to product
- Version control
- Effective date range
- Approval workflow
- Review scheduling

### 06.4 Test Parameters

| Field | Value |
|-------|-------|
| Priority | P0 |
| Complexity | M |
| Dependencies | 06.3 |
| PRD FRs | FR-QA-004 |

**Table:** `quality_spec_parameters`

**Parameter Types:**
- `numeric` - Min/max values
- `text` - Expected string match
- `boolean` - Pass/fail binary
- `range` - Within tolerance

**Key Fields:**
```sql
parameter_name TEXT NOT NULL,
parameter_type TEXT NOT NULL,          -- numeric, text, boolean, range
target_value TEXT,
min_value DECIMAL(15,6),
max_value DECIMAL(15,6),
unit TEXT,
test_method TEXT,                      -- AOAC, ISO, internal
is_critical BOOLEAN DEFAULT false      -- Critical parameter flag
```

### 06.5/06.5a Incoming Inspection

| Field | Value |
|-------|-------|
| Priority | P0 |
| Complexity | L (M for .a) |
| Dependencies | 06.4, Epic 03.3, Epic 05.1 |
| PRD FRs | FR-QA-005 |

**Table:** `quality_inspections` (type='incoming')

**MVP Workflow:**
1. GRN received, inspection created (manual or auto)
2. Inspector assigned
3. Inspector records test results
4. Pass/Fail determined
5. LP QA status updated

**Key ACs:**
- Inspection linked to PO and LP
- Test parameters loaded from spec
- Results recorded per parameter
- Overall pass/fail calculated
- LP QA status updated on completion

### 06.6 Test Results Recording

| Field | Value |
|-------|-------|
| Priority | P0 |
| Complexity | M |
| Dependencies | 06.5 |
| PRD FRs | FR-QA-004 |

**Table:** `quality_test_results`

**Key Fields:**
```sql
inspection_id UUID NOT NULL,
parameter_id UUID NOT NULL,
measured_value TEXT,
numeric_value DECIMAL(15,6),
result_status TEXT NOT NULL,           -- pass, fail, marginal
tested_by UUID NOT NULL,
tested_at TIMESTAMPTZ DEFAULT now(),
equipment_id UUID,                     -- Equipment used
notes TEXT
```

### 06.7 Sampling Plans (AQL)

| Field | Value |
|-------|-------|
| Priority | P0 |
| Complexity | M |
| Dependencies | 06.3 |
| PRD FRs | FR-QA-008 |

**Table:** `sampling_plans`

**AQL Levels:**
- Level I: Reduced (75% of normal)
- Level II: Normal (standard)
- Level III: Tightened (125% of normal)

**Sample Size Table Reference:** ISO 2859 / ANSI Z1.4

### 06.8 Scanner QA Pass/Fail

| Field | Value |
|-------|-------|
| Priority | P0 |
| Complexity | M |
| Dependencies | 06.5 |
| PRD FRs | FR-QA-025 |

**Scanner Workflow:**
1. Scan LP barcode
2. Display inspection details
3. Record pass/fail per parameter
4. Submit results
5. Update LP QA status

**UI Requirements:**
- 48px+ touch targets
- Large pass/fail buttons (green/red)
- Audio feedback on scan
- Confirm before submit

### 06.9 Basic NCR Creation

| Field | Value |
|-------|-------|
| Priority | P0 |
| Complexity | M |
| Dependencies | 06.1 |
| PRD FRs | FR-QA-009 |

**Table:** `ncr_reports`

**MVP Fields:**
```sql
ncr_number TEXT NOT NULL,
title TEXT NOT NULL,
description TEXT NOT NULL,
severity TEXT NOT NULL,                -- critical, major, minor
category TEXT NOT NULL,                -- product, process, supplier, equipment
status TEXT DEFAULT 'draft',
detected_date DATE NOT NULL,
detected_by UUID NOT NULL
```

**MVP Status:** Draft -> Open -> Closed (simple)
**Full Workflow:** Phase 2 (06.13)

---

## 6. Phase 2 Stories Detail (In-Process & Final)

### 06.10 In-Process Inspection

| Field | Value |
|-------|-------|
| Priority | P0 |
| Complexity | L |
| Dependencies | 06.4, Epic 04 |
| PRD FRs | FR-QA-006 |

**Integration with Production:**
- Triggered at WO operation completion
- Tied to routing step
- Records in-process test results
- Can halt production on failure

### 06.11 Final Inspection

| Field | Value |
|-------|-------|
| Priority | P0 |
| Complexity | L |
| Dependencies | 06.10, Epic 04 |
| PRD FRs | FR-QA-007 |

**Integration with Production:**
- Triggered on WO completion
- Gates batch release
- All test results reviewed
- Pass required for release

### 06.12 Batch Release Approval

| Field | Value |
|-------|-------|
| Priority | P0 |
| Complexity | M |
| Dependencies | 06.11 |
| PRD FRs | FR-QA-010 |

**Release Criteria:**
- Final inspection passed
- No active holds on batch
- All CCP records complete (Phase 3)
- QA Manager approval

### 06.13/06.13a NCR Workflow

| Field | Value |
|-------|-------|
| Priority | P0 |
| Complexity | L (M for .a) |
| Dependencies | 06.9 |
| PRD FRs | FR-QA-009 |

**Table:** `ncr_workflow`

**Full Workflow States:**
```
Draft -> Open -> Investigation -> Root Cause -> Corrective Action -> Verification -> Closed
                                                                              |
                                                                              +-> Reopened
```

**Response Times:**
- Critical: 24 hours
- Major: 48 hours
- Minor: 7 days

### 06.19-06.20 Operation Quality Checkpoints

| Field | Value |
|-------|-------|
| Priority | P1 |
| Complexity | L + M |
| Dependencies | Epic 02.7/02.8, Epic 04 |
| PRD FRs | FR-QA-026 |

**Tables:**
- `operation_quality_checkpoints` (definition in routing)
- `operation_checkpoint_results` (execution in WO)

**Checkpoint Types:**
- Visual (appearance check)
- Measurement (numeric value)
- Equipment (automated check)
- Attribute (pass/fail)

**Auto-Hold on Failure:**
- If `auto_hold_on_failure=true`, failed checkpoint creates hold
- Production halts until QA review

---

## 7. Phase 3 Stories Detail (HACCP & CoA)

### 06.21/06.21a HACCP Plan Setup

| Field | Value |
|-------|-------|
| Priority | P1 |
| Complexity | L (M for .a) |
| Dependencies | 06.0, Epic 02.1 |
| PRD FRs | FR-QA-013 |

**Table:** `haccp_plans`

**Key Features:**
- Product-specific HACCP plan
- Version control
- Approval workflow
- Review scheduling
- CCP listing

### 06.22 CCP Definition

| Field | Value |
|-------|-------|
| Priority | P1 |
| Complexity | M |
| Dependencies | 06.21 |
| PRD FRs | FR-QA-014 |

**Table:** `haccp_ccps`

**Key Fields:**
```sql
ccp_number TEXT NOT NULL,              -- CCP-1, CCP-2
process_step TEXT NOT NULL,
hazard_type TEXT NOT NULL,             -- biological, chemical, physical
critical_limit_min DECIMAL(15,6),
critical_limit_max DECIMAL(15,6),
unit TEXT NOT NULL,                    -- C, ppm, pH, seconds
monitoring_frequency TEXT NOT NULL,    -- continuous, every_batch, hourly
corrective_action TEXT NOT NULL
```

### 06.23-06.24 CCP Monitoring

| Field | Value |
|-------|-------|
| Priority | P1 |
| Complexity | M + L |
| Dependencies | 06.22 |
| PRD FRs | FR-QA-014 |

**Table:** `haccp_monitoring_records`

**Desktop Monitoring (06.23):**
- Manual entry form
- Validation against limits
- Immediate feedback

**Scanner Monitoring (06.24):**
- Scan WO/batch barcode
- Select CCP
- Enter value
- Immediate validation
- Audio alert on deviation

**Performance Requirement:** <300ms response time

### 06.25-06.26 CCP Deviation Handling

| Field | Value |
|-------|-------|
| Priority | P1 |
| Complexity | M + M |
| Dependencies | 06.24 |
| PRD FRs | FR-QA-015 |

**Table:** `haccp_deviations`

**Deviation Workflow:**
1. Out-of-limit value detected
2. Deviation record auto-created
3. Alert sent (<30 seconds)
4. Corrective action required
5. Link to NCR (if auto_create_ncr enabled)

**Alert Channels:**
- Email (all severities)
- SMS (critical only)
- In-app notification
- Audio alarm (scanner)

### 06.27-06.29 CoA Management

| Field | Value |
|-------|-------|
| Priority | P1 |
| Complexity | M + L + M |
| Dependencies | 06.11 |
| PRD FRs | FR-QA-011, FR-QA-012 |

**Tables:**
- `coa_templates`
- `certificates_of_analysis`
- `coa_parameters`

**CoA Workflow:**
1. Batch completes final inspection
2. CoA created (manual or auto)
3. Test results populated
4. QA approves (e-signature optional)
5. PDF generated (<5 seconds)
6. Email to customer (optional)
7. Archive

---

## 8. Quality Checklist

Before submitting a story for review:

### 8.1 PRD Coverage
- [ ] All referenced FR-QA-XXX have ACs mapped
- [ ] ACs match PRD Given/When/Then format
- [ ] Business rules from PRD included
- [ ] Phase 1+ features documented in "Future Phases"

### 8.2 Food Safety Compliance
- [ ] HACCP requirements identified (if applicable)
- [ ] FDA 21 CFR Part 11 requirements identified (if applicable)
- [ ] Audit trail requirements specified
- [ ] E-signature requirements specified (if applicable)

### 8.3 Technical Completeness
- [ ] API endpoints fully specified (match Architecture doc)
- [ ] Database tables referenced from quality.md
- [ ] Service methods listed
- [ ] Zod validation schemas defined
- [ ] RLS policies mentioned

### 8.4 Scanner Stories
- [ ] Touch target sizes specified (48px+)
- [ ] Audio feedback defined
- [ ] Workflow steps documented
- [ ] Error handling specified

### 8.5 Story Quality (INVEST)
- [ ] **I**ndependent: Can be developed standalone
- [ ] **N**egotiable: Scope can adjust if needed
- [ ] **V**aluable: Delivers user value
- [ ] **E**stimable: Complexity is clear (S/M/L)
- [ ] **S**mall: Can complete in 1 sprint
- [ ] **T**estable: ACs are verifiable

### 8.6 Definition of Done
- [ ] Has API test coverage target (>80%)
- [ ] Has E2E smoke test for critical path
- [ ] Has RLS policy test
- [ ] Has audit trail test (if applicable)
- [ ] Scanner: Touch targets verified, audio tested

---

## 9. Story Index (To Be Created)

### Phase 1 - Core Quality (MVP)

| Story ID | Name | Complexity | Priority | Status |
|----------|------|------------|----------|--------|
| 06.0 | Quality Settings | M | P0 | TO CREATE |
| 06.1 | Quality Status Types | S | P0 | TO CREATE |
| 06.2 | Quality Holds CRUD | M | P0 | TO CREATE |
| 06.3 | Product Specifications | M | P0 | TO CREATE |
| 06.4 | Test Parameters | M | P0 | TO CREATE |
| 06.5a | Incoming Inspection Core | M | P0 | TO CREATE |
| 06.5b | Incoming Inspection Advanced | M | P1 | TO CREATE |
| 06.6 | Test Results Recording | M | P0 | TO CREATE |
| 06.7 | Sampling Plans (AQL) | M | P0 | TO CREATE |
| 06.8 | Scanner QA Pass/Fail | M | P0 | TO CREATE |
| 06.9 | Basic NCR Creation | M | P0 | TO CREATE |

**Phase 1 Stories: 11** (with splits)
**Estimated Days: 14-18**

### Phase 2 - In-Process & Final

| Story ID | Name | Complexity | Priority | Status |
|----------|------|------------|----------|--------|
| 06.10 | In-Process Inspection | L | P0 | TO CREATE |
| 06.11 | Final Inspection | L | P0 | TO CREATE |
| 06.12 | Batch Release Approval | M | P0 | TO CREATE |
| 06.13a | NCR Workflow Core | M | P0 | TO CREATE |
| 06.13b | NCR Workflow Advanced | L | P1 | TO CREATE |
| 06.14 | NCR Root Cause Analysis | M | P1 | TO CREATE |
| 06.15 | NCR Corrective Action | M | P1 | TO CREATE |
| 06.16 | NCR Verification & Close | M | P1 | TO CREATE |
| 06.17 | Quality Alerts | M | P1 | TO CREATE |
| 06.18 | Test Result Trending | M | P1 | TO CREATE |
| 06.19 | Operation Quality Checkpoints | L | P1 | TO CREATE |
| 06.20 | Checkpoint Results & Sign-off | M | P1 | TO CREATE |

**Phase 2 Stories: 12** (with splits)
**Estimated Days: 16-22**

### Phase 3 - HACCP & CoA

| Story ID | Name | Complexity | Priority | Status |
|----------|------|------------|----------|--------|
| 06.21a | HACCP Plan Core | M | P1 | TO CREATE |
| 06.21b | HACCP Plan Advanced | M | P2 | TO CREATE |
| 06.22 | CCP Definition | M | P1 | TO CREATE |
| 06.23 | CCP Monitoring Desktop | M | P1 | TO CREATE |
| 06.24 | CCP Monitoring Scanner | L | P1 | TO CREATE |
| 06.25 | CCP Deviation Handling | M | P1 | TO CREATE |
| 06.26 | CCP Deviation Alerts | M | P1 | TO CREATE |
| 06.27 | CoA Templates | M | P1 | TO CREATE |
| 06.28a | CoA Generation Core | M | P1 | TO CREATE |
| 06.28b | CoA Generation Advanced | M | P2 | TO CREATE |
| 06.29 | CoA PDF Export | M | P1 | TO CREATE |
| 06.30 | HACCP Verification Records | M | P1 | TO CREATE |

**Phase 3 Stories: 12** (with splits)
**Estimated Days: 16-20**

### Phase 4 - CAPA & Supplier Quality

| Story ID | Name | Complexity | Priority | Status |
|----------|------|------------|----------|--------|
| 06.31 | CAPA Creation | M | P2 | TO CREATE |
| 06.32 | CAPA Actions | M | P2 | TO CREATE |
| 06.33 | CAPA Effectiveness Check | M | P2 | TO CREATE |
| 06.34 | Supplier Quality Ratings | M | P2 | TO CREATE |
| 06.35 | Supplier Audits | M | P2 | TO CREATE |
| 06.36 | Supplier Audit Findings | M | P2 | TO CREATE |
| 06.37 | Quality Dashboard | L | P2 | TO CREATE |
| 06.38 | Audit Trail Reports | M | P2 | TO CREATE |
| 06.39 | Quality Analytics | L | P2 | TO CREATE |
| 06.40 | Document Control | M | P2 | TO CREATE |

**Phase 4 Stories: 10**
**Estimated Days: 14-18**

---

## 10. Handoff to Story Writers

### 10.1 Instructions for Story Creation

1. **Read PRD Section** - Each FR-QA-XXX has detailed ACs in PRD
2. **Use Template** - Follow template in Section 3
3. **Reference Architecture** - Use schema from quality.md
4. **Map FRs to ACs** - PRD ACs are comprehensive, use as-is
5. **Document Compliance** - FDA 21 CFR Part 11, HACCP if applicable
6. **Scanner UI** - Include design specs for scanner stories

### 10.2 File Naming Convention

```
docs/2-MANAGEMENT/epics/current/06-quality/
  06.0.epic-overview.md
  06.0.story-creation-brief.md (this file)
  MVP-DEPENDENCY-ANALYSIS.md
  06.0.quality-settings.md
  06.1.quality-status-types.md
  06.2.quality-holds-crud.md
  06.3.product-specifications.md
  06.4.test-parameters.md
  06.5a.incoming-inspection-core.md
  06.5b.incoming-inspection-advanced.md
  06.6.test-results-recording.md
  ... (06.7 through 06.40)
```

### 10.3 Priority Order for Story Creation

**First Priority (Phase 1 - MVP):**
1. 06.0 Quality Settings
2. 06.1 Quality Status Types
3. 06.2 Quality Holds CRUD
4. 06.3 Product Specifications
5. 06.4 Test Parameters
6. 06.5a Incoming Inspection Core
7. 06.6 Test Results Recording
8. 06.7 Sampling Plans
9. 06.8 Scanner QA Pass/Fail
10. 06.9 Basic NCR Creation

**Second Priority (Phase 2):**
11. 06.10-06.20 (In-Process, Final, NCR Workflow, Checkpoints)

**Third Priority (Phases 3-4):**
12. 06.21-06.40 (HACCP, CoA, CAPA, Supplier)

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-12-16 | Initial story creation brief with compliance-first strategy | ARCHITECT-AGENT |
