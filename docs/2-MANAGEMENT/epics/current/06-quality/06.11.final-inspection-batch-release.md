# 06.11 - Final Inspection + Batch Release

**Priority**: P0 (MVP - Regulatory Critical)
**Story Points**: L (Large - 5-7 days)
**Type:** backend + frontend
**Phase**: 2 (In-Process & Final)
**Model**: OPUS

**State:** ready
**Estimate:** L (5-7 days)
**Primary PRD:** `docs/1-BASELINE/product/modules/quality.md` (FR-QA-007, FR-QA-010, Section 9.3)
**Architecture:** `docs/1-BASELINE/architecture/modules/quality.md` (quality_inspections table, Batch Release API)

---

## Goal

Implement the final inspection workflow and batch release approval process for finished goods from completed Work Orders. This story provides the critical quality gate that controls whether batches can proceed to shipping (Epic 07). Final inspection aggregates and verifies all quality evidence collected during production: test results, CCP monitoring records, operation checkpoints, and label verification. Batch release is the formal approval step required by food safety regulations before products can ship.

**CRITICAL IMPORTANCE:**
- **Regulatory Compliance**: FDA FSMA, HACCP, GFSI require documented batch release before shipping
- **Gates Shipping Module**: Epic 07 cannot ship LPs without batch release approval
- **Traceability**: Creates complete audit trail linking WO -> Inspection -> Test Results -> CCP Records -> Release Decision
- **Food Safety**: Last checkpoint before products reach consumers

---

## Food Safety Compliance

This story is **CRITICAL for food safety regulatory compliance**:

- [x] **HACCP Compliance** - Verifies all CCP monitoring records complete and within limits
- [x] **FDA 21 CFR Part 11** - Full audit trail with e-signature ready fields
- [x] **FSMA Compliance** - Preventive controls verification before release
- [x] **Audit Trail Required** - Release decision, approver, timestamp, all referenced records
- [x] **Batch Traceability** - Links release to WO, BOM snapshot, all consumed materials

**Regulatory Context:**
- Final inspection verifies product meets specifications before release
- Batch release is formal approval by authorized personnel (QA Manager+)
- All quality evidence must be reviewed and documented
- Release decision is legally binding for food safety
- Records retained for minimum 2 years (food) / 7 years (medical foods)

---

## MVP Scope

This story implements Phase 2 (In-Process & Final) functionality. Final inspection reuses the `quality_inspections` table (type='final') and inspection patterns from story 06.5. Batch release adds a formal approval workflow.

**MVP Includes**:
- `quality_inspections` with type='final' for finished goods
- Auto-create final inspection on WO completion (if setting enabled)
- Manual final inspection creation from pending queue
- Pre-inspection checklist verification (all evidence collection complete)
- Test results recording per finished product specification
- Result determination: pass/fail/conditional
- Batch release approval workflow (separate from inspection completion)
- Release checklist with evidence verification
- LP QA status update on release
- Batch release gates shipping (LP.release_status field)
- Final inspection queue page
- Batch release approval page
- Integration with Epic 04 (WO completion) and Epic 07 (Shipping gate)

**Deferred to Phase 3+**:
- CoA auto-generation on release (Story 06.27-06.29)
- E-signature for release approval (Phase 3)
- Retention sample management (Story 06.23 - Phase 4)
- Auto-CoA email to customer (Phase 3)

---

## User Story

As a **QA Inspector**, I want to **perform final inspection on completed Work Order batches, verifying all quality evidence is complete and the product meets specifications** so that **only quality-verified batches are approved for release to shipping**.

As a **QA Manager**, I want to **review final inspection results and formally approve batch release** so that **we maintain regulatory compliance and ensure only approved batches ship to customers**.

As a **Shipping Coordinator**, I want to **see which batches are released and available for shipping** so that **I only ship products that have passed quality approval**.

---

## Scope

**In scope (this story)**
- `quality_inspections` table with type='final' logic
- Auto-create final inspection on WO completion (configurable)
- Pre-inspection checklist verification:
  - All operation checkpoints complete
  - All CCP monitoring records within limits
  - All required in-process inspections passed
  - Label accuracy verified (placeholder - manual check in MVP)
- GET /api/quality/inspections/final (final inspection queue)
- GET /api/quality/inspections/:id (inspection detail with evidence summary)
- POST /api/quality/inspections (manual creation for final type)
- POST /api/quality/inspections/:id/start
- POST /api/quality/inspections/:id/complete
- POST /api/quality/batch/:batchId/release-check (validate release criteria)
- POST /api/quality/batch/:batchId/release (formal batch release)
- GET /api/quality/batch/:batchId/status (batch QA status)
- Batch release approval page with evidence summary
- Release checklist with sign-off
- LP status update: qa_status='passed', release_status='released'
- LP.release_status field gates shipping in Epic 07
- Final inspection queue page with filters
- Final inspection detail page with evidence tabs
- Release approval modal with checklist
- Batch release status badge on LP detail page

**Out of scope (this story)**
- Test results recording (story 06.6 - required dependency)
- In-process inspection (story 06.10 - prerequisite)
- Operation checkpoints (story 06.19-06.20 - read-only reference)
- CCP monitoring records (story 06.23-06.26 - read-only reference)
- NCR auto-creation on failure (story 06.9, 06.13)
- CoA generation (story 06.27-06.29)
- E-signature integration (Phase 3)
- Retention sample management (Phase 4)

---

## Dependencies

### Cross-Epic Dependencies

| Dependency | Story/Epic | Type | What It Provides | Status |
|------------|------------|------|------------------|--------|
| 01.1 | Org Context + RLS | HARD | organizations, users, roles tables | Ready |
| 02.1 | Products CRUD | HARD | products table for product reference | Ready |
| 03.10 | Work Orders | HARD | work_orders table, WO completion event | Ready |
| 04.2c | WO Complete | HARD | WO completion triggers final inspection | Ready |
| 05.1 | LP Table + CRUD | HARD | license_plates table for output LPs | Ready |
| 05.7 | LP QA Status | HARD | LP.qa_status, LP.release_status fields | Required |

### Within Epic Dependencies

| Dependency | Story | Type | What It Provides |
|------------|-------|------|------------------|
| 06.0 | Quality Settings | HARD | quality_settings for auto-create, defaults |
| 06.1 | Quality Status Types | HARD | QA status enum for LP updates |
| 06.3 | Product Specifications | HARD | quality_specifications for test parameters |
| 06.4 | Test Parameters | HARD | quality_spec_parameters for test criteria |
| 06.5 | Incoming Inspection | HARD | quality_inspections table, inspection patterns |
| 06.6 | Test Results Recording | HARD | quality_test_results table, recording UI |
| 06.10 | In-Process Inspection | SOFT | Reference for in-process inspection status |
| 06.19 | Operation Checkpoints | SOFT | Reference for checkpoint results |

### Provides To (Downstream)

| Story/Epic | What This Provides |
|------------|-------------------|
| 06.27 | CoA Templates - Released batch reference |
| 06.28 | CoA Generation - Release status triggers CoA |
| 07.* | Shipping Module - LP.release_status='released' gates shipping |
| Epic 09 | Finance Module - Released batches for invoicing |

---

## Database Schema

### Migration: Add release_status to license_plates (if not exists)

```sql
-- Migration: YYYYMMDDHHMMSS_add_lp_release_status.sql
-- NOTE: May already exist from Epic 05. Check before creating.

-- Add release_status column to license_plates
ALTER TABLE license_plates
ADD COLUMN IF NOT EXISTS release_status TEXT DEFAULT 'pending'
    CHECK (release_status IN ('pending', 'released', 'hold', 'rejected'));

-- Add release metadata columns
ALTER TABLE license_plates
ADD COLUMN IF NOT EXISTS released_by UUID REFERENCES users(id),
ADD COLUMN IF NOT EXISTS released_at TIMESTAMPTZ,
ADD COLUMN IF NOT EXISTS release_notes TEXT;

-- Index for shipping module queries
CREATE INDEX IF NOT EXISTS idx_lp_release_status
    ON license_plates(org_id, release_status)
    WHERE release_status = 'released';
```

### New Table: batch_release_records

```sql
-- Migration: YYYYMMDDHHMMSS_create_batch_release_records.sql

CREATE TABLE batch_release_records (
    -- Identity
    id                      UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id                  UUID NOT NULL REFERENCES organizations(id),
    release_number          TEXT NOT NULL,

    -- Batch Reference
    batch_number            TEXT NOT NULL,
    wo_id                   UUID REFERENCES work_orders(id),
    product_id              UUID NOT NULL REFERENCES products(id),

    -- Inspection Reference
    final_inspection_id     UUID REFERENCES quality_inspections(id),

    -- Release Checklist Status
    checklist_test_results  BOOLEAN DEFAULT false,  -- All tests passed
    checklist_ccp_records   BOOLEAN DEFAULT false,  -- All CCPs within limits
    checklist_checkpoints   BOOLEAN DEFAULT false,  -- All checkpoints passed
    checklist_label_verify  BOOLEAN DEFAULT false,  -- Labels verified
    checklist_spec_review   BOOLEAN DEFAULT false,  -- Spec compliance confirmed
    checklist_ncr_review    BOOLEAN DEFAULT false,  -- No open NCRs (or resolved)

    -- Release Decision
    release_decision        TEXT NOT NULL DEFAULT 'pending'
                            CHECK (release_decision IN ('pending', 'approved', 'rejected', 'conditional')),
    release_reason          TEXT,

    -- Conditional Release Details
    conditional_reason      TEXT,
    conditional_restrictions TEXT,
    conditional_expires_at  TIMESTAMPTZ,

    -- Quantities
    total_quantity          DECIMAL(15,4),
    released_quantity       DECIMAL(15,4),
    rejected_quantity       DECIMAL(15,4),

    -- Approval Workflow
    submitted_by            UUID REFERENCES users(id),
    submitted_at            TIMESTAMPTZ,
    approved_by             UUID REFERENCES users(id),
    approved_at             TIMESTAMPTZ,
    approval_notes          TEXT,

    -- E-Signature Ready Fields (Phase 3)
    signature_meaning       TEXT,  -- "I approve release of this batch"
    signature_timestamp     TIMESTAMPTZ,

    -- Audit
    created_at              TIMESTAMPTZ NOT NULL DEFAULT now(),
    created_by              UUID REFERENCES users(id),
    updated_at              TIMESTAMPTZ NOT NULL DEFAULT now(),
    updated_by              UUID REFERENCES users(id),

    -- Constraints
    CONSTRAINT uq_batch_release_number UNIQUE (org_id, release_number)
);

-- =============================================================================
-- Indexes
-- =============================================================================

CREATE INDEX idx_batch_release_org_status ON batch_release_records(org_id, release_decision);
CREATE INDEX idx_batch_release_batch ON batch_release_records(org_id, batch_number);
CREATE INDEX idx_batch_release_wo ON batch_release_records(wo_id) WHERE wo_id IS NOT NULL;
CREATE INDEX idx_batch_release_product ON batch_release_records(product_id);
CREATE INDEX idx_batch_release_pending ON batch_release_records(org_id, release_decision)
    WHERE release_decision = 'pending';
CREATE INDEX idx_batch_release_approved_by ON batch_release_records(approved_by)
    WHERE approved_by IS NOT NULL;

-- =============================================================================
-- Release Number Sequence
-- =============================================================================

CREATE TABLE IF NOT EXISTS release_number_sequences (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    year INTEGER NOT NULL,
    current_value BIGINT NOT NULL DEFAULT 0,
    updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
    UNIQUE(org_id, year)
);

-- Function to generate release number (REL-YYYY-NNNNN)
CREATE OR REPLACE FUNCTION generate_release_number(p_org_id UUID)
RETURNS TEXT AS $$
DECLARE
    v_year INTEGER;
    v_next_val BIGINT;
    v_release_number TEXT;
BEGIN
    v_year := EXTRACT(YEAR FROM CURRENT_DATE);

    -- Upsert sequence and get next value
    INSERT INTO release_number_sequences (org_id, year, current_value)
    VALUES (p_org_id, v_year, 1)
    ON CONFLICT (org_id, year)
    DO UPDATE SET
        current_value = release_number_sequences.current_value + 1,
        updated_at = NOW()
    RETURNING current_value INTO v_next_val;

    -- Format release number
    v_release_number := 'REL-' || v_year::TEXT || '-' || LPAD(v_next_val::TEXT, 5, '0');

    RETURN v_release_number;
END;
$$ LANGUAGE plpgsql;

-- =============================================================================
-- RLS Policies
-- =============================================================================

ALTER TABLE batch_release_records ENABLE ROW LEVEL SECURITY;

CREATE POLICY "batch_release_select" ON batch_release_records
    FOR SELECT USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

CREATE POLICY "batch_release_insert" ON batch_release_records
    FOR INSERT WITH CHECK (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

CREATE POLICY "batch_release_update" ON batch_release_records
    FOR UPDATE USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

-- No delete policy - release records are immutable once approved
CREATE POLICY "batch_release_delete" ON batch_release_records
    FOR DELETE USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
        AND release_decision = 'pending'
    );

ALTER TABLE release_number_sequences ENABLE ROW LEVEL SECURITY;

CREATE POLICY "release_seq_org" ON release_number_sequences
    FOR ALL TO authenticated
    USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

-- =============================================================================
-- Junction Table: Released LPs
-- =============================================================================

CREATE TABLE batch_release_lps (
    id                      UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    release_id              UUID NOT NULL REFERENCES batch_release_records(id) ON DELETE CASCADE,
    lp_id                   UUID NOT NULL REFERENCES license_plates(id),
    quantity                DECIMAL(15,4),
    release_status          TEXT NOT NULL DEFAULT 'released'
                            CHECK (release_status IN ('released', 'hold', 'rejected')),
    notes                   TEXT,
    created_at              TIMESTAMPTZ NOT NULL DEFAULT now(),

    UNIQUE(release_id, lp_id)
);

CREATE INDEX idx_batch_release_lps_release ON batch_release_lps(release_id);
CREATE INDEX idx_batch_release_lps_lp ON batch_release_lps(lp_id);

ALTER TABLE batch_release_lps ENABLE ROW LEVEL SECURITY;

CREATE POLICY "batch_release_lps_policy" ON batch_release_lps
    FOR ALL TO authenticated
    USING (
        release_id IN (
            SELECT id FROM batch_release_records
            WHERE org_id = (SELECT org_id FROM users WHERE id = auth.uid())
        )
    );

-- =============================================================================
-- Trigger for updated_at
-- =============================================================================

CREATE TRIGGER update_batch_release_records_updated_at
    BEFORE UPDATE ON batch_release_records
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- =============================================================================
-- Function: Auto-create final inspection on WO completion
-- =============================================================================

CREATE OR REPLACE FUNCTION create_final_inspection_on_wo_complete()
RETURNS TRIGGER AS $$
DECLARE
    v_settings RECORD;
    v_spec_id UUID;
    v_inspection_number TEXT;
    v_output_lp RECORD;
BEGIN
    -- Only trigger on WO status change to 'completed'
    IF NEW.status = 'completed' AND (OLD.status IS NULL OR OLD.status != 'completed') THEN

        -- Check if auto-create is enabled
        SELECT * INTO v_settings
        FROM quality_settings
        WHERE org_id = NEW.org_id;

        IF v_settings.require_final_inspection = true THEN

            -- Get active specification for product (if exists)
            SELECT id INTO v_spec_id
            FROM quality_specifications
            WHERE org_id = NEW.org_id
              AND product_id = NEW.product_id
              AND status = 'active'
            ORDER BY effective_date DESC
            LIMIT 1;

            -- Generate inspection number
            v_inspection_number := generate_inspection_number(NEW.org_id, 'final');

            -- Create single final inspection for the WO batch
            INSERT INTO quality_inspections (
                org_id,
                inspection_number,
                inspection_type,
                reference_type,
                reference_id,
                product_id,
                spec_id,
                batch_number,
                lot_size,
                status,
                scheduled_date,
                priority,
                created_by
            ) VALUES (
                NEW.org_id,
                v_inspection_number,
                'final',
                'wo',
                NEW.id,
                NEW.product_id,
                v_spec_id,
                NEW.batch_number,
                NEW.produced_qty,
                'scheduled',
                CURRENT_DATE,
                'high',  -- Final inspections are high priority
                NEW.completed_by
            );

        END IF;
    END IF;

    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Create trigger on work_orders table
-- Note: Assumes work_orders table exists from Epic 03
CREATE TRIGGER trigger_create_final_inspection_on_wo_complete
    AFTER UPDATE ON work_orders
    FOR EACH ROW
    EXECUTE FUNCTION create_final_inspection_on_wo_complete();

-- =============================================================================
-- Function: Update LP release status on batch release approval
-- =============================================================================

CREATE OR REPLACE FUNCTION update_lp_release_status_on_batch_release()
RETURNS TRIGGER AS $$
BEGIN
    -- Only trigger on release approval
    IF NEW.release_decision = 'approved' AND (OLD.release_decision IS NULL OR OLD.release_decision != 'approved') THEN

        -- Update all LPs in this release
        UPDATE license_plates lp
        SET
            release_status = 'released',
            released_by = NEW.approved_by,
            released_at = NOW()
        FROM batch_release_lps brl
        WHERE brl.release_id = NEW.id
          AND brl.lp_id = lp.id
          AND brl.release_status = 'released';

        -- Update rejected LPs
        UPDATE license_plates lp
        SET
            release_status = 'rejected',
            updated_at = NOW()
        FROM batch_release_lps brl
        WHERE brl.release_id = NEW.id
          AND brl.lp_id = lp.id
          AND brl.release_status = 'rejected';

    END IF;

    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_update_lp_release_status
    AFTER UPDATE ON batch_release_records
    FOR EACH ROW
    EXECUTE FUNCTION update_lp_release_status_on_batch_release();
```

---

## Acceptance Criteria (Given/When/Then)

### AC-1: Final Inspection Auto-Creation on WO Completion

```gherkin
Scenario: Auto-create final inspection when WO completes
  Given quality_settings.require_final_inspection = true
  And Work Order WO-2025-001 exists with status = 'in_progress'
  And WO has product "Bread Loaf" with batch_number = "BATCH-001"
  When WO status changes to 'completed'
  Then final inspection record created with:
    | Field | Value |
    | inspection_type | final |
    | reference_type | wo |
    | reference_id | WO uuid |
    | batch_number | BATCH-001 |
    | status | scheduled |
    | priority | high |
  And inspection_number format 'INS-FIN-2025-00001'
  And spec_id populated if active spec exists for product

Scenario: No auto-create when setting disabled
  Given quality_settings.require_final_inspection = false
  When WO completes
  Then no final inspection record created
  And batch can still be released manually (with warning)
```

### AC-2: Final Inspection Queue Display

```gherkin
Scenario: Final inspection queue loads
  Given user navigates to Quality > Inspections > Final
  When page loads
  Then DataTable displays final inspections with columns:
    | Column | Description |
    | Inspection # | Link to detail (INS-FIN-YYYY-NNNNN) |
    | WO Number | Link to WO detail |
    | Product | Product name |
    | Batch | Batch number |
    | Quantity | Lot size |
    | Status | Badge (scheduled/in_progress/completed) |
    | Priority | Badge (high=orange, urgent=red) |
    | Scheduled | Date |
    | Inspector | Assigned user name or "Unassigned" |
    | Evidence | Icons showing checklist status |
    | Actions | Start, View, Release |
  And list loads within 500ms
  And default filter shows pending (scheduled + in_progress)
```

### AC-3: Pre-Inspection Evidence Verification

```gherkin
Scenario: View evidence summary before starting final inspection
  Given final inspection for WO-2025-001 exists
  And WO had 3 in-process inspections (all passed)
  And WO had 5 CCP monitoring records (all within limits)
  And WO had 10 operation checkpoints (all passed)
  When user clicks [View] on final inspection
  Then evidence summary panel displays:
    | Evidence Type | Count | Status |
    | In-Process Inspections | 3 | All Passed |
    | CCP Monitoring Records | 5 | All Within Limits |
    | Operation Checkpoints | 10 | All Passed |
    | Open NCRs | 0 | None |
  And overall evidence status badge shows "Ready" (green)

Scenario: Evidence shows warnings when issues exist
  Given WO has 1 in-process inspection with result = 'conditional'
  And WO has 1 CCP record out of limits (corrective action taken)
  When viewing evidence summary
  Then warnings displayed:
    - "1 in-process inspection with conditional result"
    - "1 CCP deviation (corrective action recorded)"
  And evidence status badge shows "Review Required" (yellow)
```

### AC-4: Start Final Inspection

```gherkin
Scenario: Start final inspection with complete evidence
  Given final inspection with status = 'scheduled'
  And all pre-requisites met (evidence complete)
  And inspector assigned
  When user clicks [Start Inspection]
  Then status changes to 'in_progress'
  And started_at = now
  And inspection detail page opens with test entry form

Scenario: Start final inspection with incomplete evidence
  Given final inspection with status = 'scheduled'
  And 1 in-process inspection still in_progress
  When user clicks [Start Inspection]
  Then warning modal: "Production quality checks incomplete"
  And shows: "1 in-process inspection still in progress"
  And user can choose [Start Anyway] or [Cancel]
  And if [Start Anyway]: inspection starts with warning logged
```

### AC-5: Complete Final Inspection - Pass

```gherkin
Scenario: Complete final inspection with pass result
  Given final inspection in_progress with all tests recorded
  And all test results status = 'pass'
  When user clicks [Complete Inspection]
  Then result determination modal shows:
    | Field | Value |
    | Suggested Result | PASS (all tests passed) |
    | Evidence Summary | 3 IP inspections, 5 CCPs, 10 checkpoints |
    | Result Dropdown | Pass / Fail / Conditional |
  And user confirms result = 'pass'
  Then inspection.status = 'completed'
  And inspection.result = 'pass'
  And success toast "Final inspection completed - PASS"
  And [Proceed to Batch Release] button appears
```

### AC-6: Complete Final Inspection - Fail

```gherkin
Scenario: Complete final inspection with fail result
  Given final inspection in_progress
  And 2 test results status = 'fail'
  When user clicks [Complete Inspection]
  Then suggested result = 'FAIL'
  And user confirms result = 'fail'
  Then inspection.result = 'fail'
  And prompt: "Create NCR for failed final inspection?"
  And if yes, redirect to NCR creation (story 06.9)
  And batch release blocked until NCR resolution
```

### AC-7: Release Check API

```gherkin
Scenario: Check batch release readiness - Ready
  Given batch BATCH-001 with completed final inspection (pass)
  And all evidence checklist items satisfiable
  When calling POST /api/quality/batch/BATCH-001/release-check
  Then response:
    {
      "batch_number": "BATCH-001",
      "can_release": true,
      "checklist": {
        "final_inspection_passed": true,
        "all_tests_passed": true,
        "ccp_records_complete": true,
        "checkpoints_passed": true,
        "no_open_ncrs": true
      },
      "warnings": [],
      "blockers": []
    }

Scenario: Check batch release readiness - Blocked
  Given batch BATCH-001 with final inspection result = 'fail'
  When calling POST /api/quality/batch/BATCH-001/release-check
  Then response:
    {
      "can_release": false,
      "blockers": [
        "Final inspection failed - cannot release"
      ],
      "suggested_action": "Create NCR and resolve before release"
    }

Scenario: Check batch release readiness - Warnings
  Given batch BATCH-001 with final inspection result = 'conditional'
  When calling POST /api/quality/batch/BATCH-001/release-check
  Then response:
    {
      "can_release": true,
      "warnings": [
        "Final inspection conditional - restrictions apply"
      ],
      "conditional_restrictions": "Must ship within 7 days"
    }
```

### AC-8: Batch Release Approval - Happy Path

```gherkin
Scenario: Approve batch release
  Given batch BATCH-001 passes release check
  And user has QA_MANAGER role
  When user navigates to batch release page
  And reviews evidence summary
  And checks all release checklist items:
    - [x] Test results reviewed
    - [x] CCP records verified
    - [x] Operation checkpoints confirmed
    - [x] Label accuracy verified
    - [x] Specification compliance confirmed
    - [x] No open NCRs (or resolved)
  And clicks [Approve Release]
  Then batch_release_records created with:
    | Field | Value |
    | release_decision | approved |
    | approved_by | current user |
    | approved_at | now |
    | all checklist fields | true |
  And all output LPs updated:
    | Field | Value |
    | release_status | released |
    | released_by | current user |
    | released_at | now |
  And success toast "Batch BATCH-001 released for shipping"
```

### AC-9: Batch Release Approval - Conditional

```gherkin
Scenario: Approve conditional batch release
  Given batch BATCH-001 has conditional final inspection
  And user has QA_MANAGER role
  When user selects release_decision = 'conditional'
  And fills conditional details:
    | Field | Value |
    | Conditional Reason | Minor color variation |
    | Restrictions | Ship to Distributor A only |
    | Expires At | +7 days |
  And clicks [Approve Conditional Release]
  Then batch_release_records.release_decision = 'conditional'
  And conditional fields populated
  And LPs updated with release_status = 'released'
  And LP.release_notes contains restriction info
  And warning displayed in shipping module (Epic 07)
```

### AC-10: Batch Release Rejection

```gherkin
Scenario: Reject batch release
  Given batch BATCH-001 has failed final inspection
  And user has QA_MANAGER role
  When user selects release_decision = 'rejected'
  And enters rejection reason
  And clicks [Reject Release]
  Then batch_release_records.release_decision = 'rejected'
  And all output LPs updated:
    | Field | Value |
    | release_status | rejected |
  And prompt: "Create NCR for rejected batch?"
  And LPs blocked from shipping
```

### AC-11: Permission Enforcement for Batch Release

```gherkin
Scenario: QA Inspector cannot approve release
  Given user has QA_INSPECTOR role (not QA_MANAGER)
  When user views batch release page
  Then checklist visible but [Approve Release] button disabled
  And tooltip: "QA Manager approval required"
  And [Submit for Approval] button shown instead

Scenario: QA Manager can approve
  Given user has QA_MANAGER role
  Then [Approve Release] button enabled
  And can directly approve or reject

Scenario: Production user cannot access release
  Given user has PRODUCTION role only
  When attempting to access /quality/batch-release/:id
  Then 403 Forbidden returned
```

### AC-12: LP Release Status Gates Shipping

```gherkin
Scenario: Released LP can be shipped
  Given LP00000001 has release_status = 'released'
  When Shipping module queries available inventory
  Then LP00000001 included in available LPs
  And LP can be allocated to sales order

Scenario: Pending LP blocked from shipping
  Given LP00000001 has release_status = 'pending'
  When Shipping module queries available inventory
  Then LP00000001 NOT included in available LPs
  And tooltip: "Pending QA release"

Scenario: Rejected LP blocked from shipping
  Given LP00000001 has release_status = 'rejected'
  When Shipping module queries available inventory
  Then LP00000001 NOT included
  And requires disposition decision (NCR process)
```

### AC-13: Final Inspection Detail Page

```gherkin
Scenario: View final inspection detail
  Given final inspection INS-FIN-2025-00001 exists
  When user navigates to /quality/inspections/INS-FIN-2025-00001
  Then page displays tabs:
    | Tab | Content |
    | Overview | Header, Status, WO info, Product, Batch |
    | Test Results | Test parameters grid (from 06.6) |
    | Evidence | In-process inspections, CCPs, Checkpoints |
    | Release | Release status, checklist, approval history |
  And evidence tab shows:
    - List of in-process inspections with results
    - CCP monitoring records summary
    - Operation checkpoint results
    - Any NCRs linked to this batch
```

### AC-14: Audit Trail

```gherkin
Scenario: All release actions logged
  Given batch release approval
  When approval completes
  Then quality_audit_log entry created:
    | Field | Value |
    | entity_type | batch_release |
    | entity_id | release record id |
    | action | approve |
    | user_id | approver id |
    | new_value | { decision: 'approved', checklist: {...} } |

Scenario: View release audit history
  Given batch with release history
  When user clicks [View History] on release record
  Then timeline shows all actions:
    - Created by Inspector A at time T1
    - Checklist updated by Inspector A at time T2
    - Submitted for approval at time T3
    - Approved by QA Manager at time T4
```

### AC-15: Performance Requirements

```gherkin
Scenario: Final inspection queue performance
  Given 500 final inspections in organization
  When listing final inspection queue
  Then response time < 500ms

Scenario: Evidence summary performance
  Given final inspection with 50 related records
  When loading evidence summary
  Then response time < 1 second

Scenario: Batch release performance
  Given batch with 20 output LPs
  When approving release
  Then all LP updates complete < 2 seconds
```

---

## Implementation Notes

### API Endpoints

```typescript
// =============================================================================
// Final Inspection Endpoints (extends inspection patterns from 06.5)
// =============================================================================

// GET /api/quality/inspections/final
// List final inspections queue
interface FinalInspectionListParams {
  status?: 'scheduled' | 'in_progress' | 'completed';
  wo_id?: string;
  batch_number?: string;
  product_id?: string;
  date_from?: string;
  date_to?: string;
  page?: number;
  limit?: number;
}

interface FinalInspectionListResponse {
  inspections: QualityInspection[];
  pagination: Pagination;
  summary: {
    scheduled: number;
    in_progress: number;
    completed_today: number;
    pending_release: number;
  };
}

// GET /api/quality/inspections/:id/evidence
// Get evidence summary for final inspection
interface InspectionEvidenceSummary {
  inspection_id: string;
  wo_id: string;
  batch_number: string;

  in_process_inspections: {
    total: number;
    passed: number;
    failed: number;
    conditional: number;
    in_progress: number;
    items: InProcessInspectionSummary[];
  };

  ccp_monitoring: {
    total_records: number;
    within_limits: number;
    deviations: number;
    deviations_resolved: number;
    items: CCPMonitoringSummary[];
  };

  operation_checkpoints: {
    total: number;
    passed: number;
    failed: number;
    items: CheckpointSummary[];
  };

  ncrs: {
    open: number;
    closed: number;
    items: NCRSummary[];
  };

  overall_status: 'ready' | 'review_required' | 'blocked';
  blockers: string[];
  warnings: string[];
}

// =============================================================================
// Batch Release Endpoints
// =============================================================================

// POST /api/quality/batch/:batchId/release-check
// Check if batch can be released
interface ReleaseCheckRequest {
  batch_number: string;  // or from URL param
}

interface ReleaseCheckResponse {
  batch_number: string;
  wo_id: string;
  product_id: string;
  product_name: string;
  total_quantity: number;
  output_lps: number;

  can_release: boolean;

  checklist: {
    final_inspection_exists: boolean;
    final_inspection_passed: boolean;
    all_tests_passed: boolean;
    ccp_records_complete: boolean;
    ccp_records_within_limits: boolean;
    checkpoints_passed: boolean;
    no_open_ncrs: boolean;
  };

  final_inspection: {
    id: string;
    inspection_number: string;
    status: string;
    result: string | null;
  } | null;

  blockers: string[];
  warnings: string[];
  suggested_action?: string;
}

// POST /api/quality/batch/:batchId/release
// Approve batch release
interface BatchReleaseRequest {
  release_decision: 'approved' | 'rejected' | 'conditional';

  // Checklist confirmations
  checklist: {
    test_results: boolean;
    ccp_records: boolean;
    checkpoints: boolean;
    label_verify: boolean;
    spec_review: boolean;
    ncr_review: boolean;
  };

  // For conditional release
  conditional_reason?: string;
  conditional_restrictions?: string;
  conditional_expires_at?: string;

  // For rejection
  rejection_reason?: string;

  // General notes
  approval_notes?: string;

  // LPs to release (optional - default all)
  lp_ids?: string[];

  // LP-specific decisions (optional)
  lp_decisions?: Array<{
    lp_id: string;
    status: 'released' | 'hold' | 'rejected';
    notes?: string;
  }>;
}

interface BatchReleaseResponse {
  release: BatchReleaseRecord;
  lps_updated: number;
  lps_released: number;
  lps_rejected: number;
  message: string;
}

// GET /api/quality/batch/:batchId/status
// Get batch QA status summary
interface BatchStatusResponse {
  batch_number: string;
  wo_id: string;
  product: ProductSummary;

  qa_status: {
    final_inspection_status: string | null;
    final_inspection_result: string | null;
    release_status: 'pending' | 'approved' | 'rejected' | 'conditional';
    released_at: string | null;
    released_by: string | null;
  };

  lp_summary: {
    total: number;
    released: number;
    pending: number;
    rejected: number;
    hold: number;
  };

  can_ship: boolean;
  restrictions?: string;
}

// GET /api/quality/batch-releases
// List batch release records
interface BatchReleaseListParams {
  release_decision?: 'pending' | 'approved' | 'rejected' | 'conditional';
  product_id?: string;
  date_from?: string;
  date_to?: string;
  page?: number;
  limit?: number;
}

// GET /api/quality/batch-releases/:id
// Get release record detail
interface BatchReleaseDetailResponse {
  release: BatchReleaseRecord;
  final_inspection: QualityInspection | null;
  evidence_summary: InspectionEvidenceSummary;
  lps: Array<{
    lp: LicensePlate;
    release_status: string;
    notes: string | null;
  }>;
  audit_history: AuditLogEntry[];
}
```

### Validation Schemas (Zod)

```typescript
import { z } from 'zod';

export const releaseDecisionEnum = z.enum(['approved', 'rejected', 'conditional']);

export const releaseChecklistSchema = z.object({
  test_results: z.boolean(),
  ccp_records: z.boolean(),
  checkpoints: z.boolean(),
  label_verify: z.boolean(),
  spec_review: z.boolean(),
  ncr_review: z.boolean(),
});

export const lpDecisionSchema = z.object({
  lp_id: z.string().uuid(),
  status: z.enum(['released', 'hold', 'rejected']),
  notes: z.string().max(500).optional(),
});

export const batchReleaseRequestSchema = z.object({
  release_decision: releaseDecisionEnum,

  checklist: releaseChecklistSchema,

  // Conditional fields
  conditional_reason: z.string().max(500).optional(),
  conditional_restrictions: z.string().max(1000).optional(),
  conditional_expires_at: z.string().datetime().optional(),

  // Rejection field
  rejection_reason: z.string().max(1000).optional(),

  approval_notes: z.string().max(2000).optional(),

  lp_ids: z.array(z.string().uuid()).optional(),
  lp_decisions: z.array(lpDecisionSchema).optional(),
}).refine(
  (data) => {
    if (data.release_decision === 'conditional') {
      return data.conditional_reason && data.conditional_restrictions;
    }
    return true;
  },
  {
    message: 'Conditional reason and restrictions required for conditional release',
    path: ['conditional_reason'],
  }
).refine(
  (data) => {
    if (data.release_decision === 'rejected') {
      return data.rejection_reason;
    }
    return true;
  },
  {
    message: 'Rejection reason required for rejected release',
    path: ['rejection_reason'],
  }
).refine(
  (data) => {
    // At least 4 of 6 checklist items must be true for approval
    if (data.release_decision === 'approved') {
      const checklistValues = Object.values(data.checklist);
      const trueCount = checklistValues.filter(Boolean).length;
      return trueCount >= 4;
    }
    return true;
  },
  {
    message: 'At least 4 checklist items must be confirmed for approval',
    path: ['checklist'],
  }
);

export const batchReleaseListQuerySchema = z.object({
  release_decision: releaseDecisionEnum.optional(),
  product_id: z.string().uuid().optional(),
  date_from: z.string().optional(),
  date_to: z.string().optional(),
  page: z.coerce.number().int().positive().default(1),
  limit: z.coerce.number().int().min(1).max(100).default(20),
});
```

### Service Layer

```typescript
// lib/services/batch-release-service.ts

export class BatchReleaseService {
  // ==========================================================================
  // Release Check
  // ==========================================================================

  /**
   * Check if batch can be released
   * Returns checklist status and blockers
   */
  static async checkReleaseReadiness(batchNumber: string): Promise<ReleaseCheckResult> {
    // 1. Get WO by batch number
    // 2. Get final inspection for WO
    // 3. Aggregate evidence: in-process inspections, CCPs, checkpoints
    // 4. Check for open NCRs
    // 5. Build checklist status
    // 6. Return can_release, blockers, warnings
  }

  /**
   * Get evidence summary for final inspection
   */
  static async getEvidenceSummary(inspectionId: string): Promise<EvidenceSummary> {
    // 1. Get inspection with WO reference
    // 2. Query in-process inspections for WO
    // 3. Query CCP monitoring records for WO
    // 4. Query operation checkpoint results for WO
    // 5. Query NCRs linked to WO/batch
    // 6. Calculate overall status
  }

  // ==========================================================================
  // Release Approval
  // ==========================================================================

  /**
   * Create and approve batch release
   */
  static async approveBatchRelease(
    batchNumber: string,
    input: BatchReleaseInput,
    userId: string
  ): Promise<BatchReleaseResult> {
    // 1. Validate release check passes (or has acceptable warnings)
    // 2. Validate user has QA_MANAGER role
    // 3. Create batch_release_records entry
    // 4. Link output LPs to release record
    // 5. Update LP release_status based on decision
    // 6. Create audit log entry
    // 7. Return release result
  }

  /**
   * Submit release for approval (by inspector)
   */
  static async submitForApproval(
    batchNumber: string,
    checklist: ReleaseChecklist,
    userId: string
  ): Promise<BatchReleaseRecord> {
    // 1. Create batch_release_records with release_decision = 'pending'
    // 2. Set submitted_by, submitted_at
    // 3. Store checklist state
    // 4. Notify QA Managers
    // 5. Return pending release record
  }

  // ==========================================================================
  // LP Release Status
  // ==========================================================================

  /**
   * Update LP release status
   */
  static async updateLPReleaseStatus(
    lpId: string,
    status: 'released' | 'hold' | 'rejected',
    userId: string,
    notes?: string
  ): Promise<void> {
    // 1. Update license_plates.release_status
    // 2. Set released_by, released_at if releasing
    // 3. Create audit log entry
  }

  /**
   * Get output LPs for batch
   */
  static async getOutputLPs(batchNumber: string): Promise<LicensePlate[]> {
    // Query LPs created from WO with this batch number
    // Include current qa_status and release_status
  }

  // ==========================================================================
  // Queries
  // ==========================================================================

  /**
   * List batch release records
   */
  static async list(params: BatchReleaseListParams): Promise<PaginatedResult<BatchReleaseRecord>>;

  /**
   * Get release record by ID
   */
  static async getById(releaseId: string): Promise<BatchReleaseDetail | null>;

  /**
   * Get batch QA status
   */
  static async getBatchStatus(batchNumber: string): Promise<BatchStatus>;

  /**
   * Get pending releases (for QA Manager queue)
   */
  static async getPendingReleases(): Promise<BatchReleaseRecord[]>;

  // ==========================================================================
  // Utility
  // ==========================================================================

  /**
   * Generate next release number
   */
  static async generateReleaseNumber(): Promise<string>;

  /**
   * Check if batch has active release record
   */
  static async hasActiveRelease(batchNumber: string): Promise<boolean>;
}
```

### Frontend Components

```
apps/frontend/app/(authenticated)/quality/
  inspections/
    final/
      page.tsx                       -- Final inspection queue
  batch-release/
    page.tsx                         -- Batch release queue (pending approvals)
    [id]/
      page.tsx                       -- Batch release detail & approval

components/quality/final-inspection/
  FinalInspectionDataTable.tsx       -- DataTable with evidence indicators
  FinalInspectionFilters.tsx         -- Filter panel
  FinalInspectionDetail.tsx          -- Detail view with tabs
  EvidenceSummaryPanel.tsx           -- Evidence aggregation display
  EvidenceTab.tsx                    -- Tab content with evidence lists
  InProcessInspectionsList.tsx       -- List of in-process inspections
  CCPMonitoringList.tsx              -- List of CCP records
  CheckpointResultsList.tsx          -- List of checkpoint results
  NCRListForBatch.tsx                -- NCRs linked to batch
  StartInspectionWithWarning.tsx     -- Start dialog with evidence warnings

components/quality/batch-release/
  BatchReleaseQueue.tsx              -- Pending releases queue
  BatchReleaseDetail.tsx             -- Release detail view
  ReleaseCheckDisplay.tsx            -- Display release check results
  ReleaseChecklist.tsx               -- Interactive checklist component
  ReleaseChecklistItem.tsx           -- Individual checklist item with checkbox
  ReleaseApprovalModal.tsx           -- Approval confirmation modal
  ConditionalReleaseForm.tsx         -- Conditional release details form
  RejectionReasonForm.tsx            -- Rejection reason input
  ReleaseStatusBadge.tsx             -- Status badge (pending/approved/rejected)
  ReleaseLPList.tsx                  -- List of LPs in release
  LPReleaseStatusBadge.tsx           -- LP release status badge
  ReleaseAuditHistory.tsx            -- Timeline of release actions
  SubmitForApprovalButton.tsx        -- Inspector submit button
  ApproveReleaseButton.tsx           -- Manager approve button

components/quality/shared/
  BatchStatusCard.tsx                -- Summary card showing batch QA status
  EvidenceStatusIcon.tsx             -- Icon indicating evidence status
  ChecklistProgress.tsx              -- Progress indicator for checklist
```

### UI Component Details

**FinalInspectionDataTable.tsx**
- ShadCN DataTable pattern (reuse from 06.5)
- Additional columns: WO Number, Evidence Status, Release Status
- Evidence column shows icons: checkmark (complete), warning (issues), x (blocked)
- Row highlight for urgent priority
- Quick actions: Start, Complete, View Evidence, Release

**EvidenceSummaryPanel.tsx**
- Card-based layout with 4 sections
- Each section shows count and status badge
- Collapsible detail lists
- Overall status banner at top (Ready/Review/Blocked)
- Links to detailed records

**ReleaseChecklist.tsx**
- Interactive checklist with 6 items
- Each item has checkbox, label, description
- Validation indicator (green check / red x)
- Progress bar at top
- Cannot submit until minimum items checked
- Tooltips explaining each requirement

**ReleaseApprovalModal.tsx**
- Three-column layout on desktop
- Left: Batch summary and evidence overview
- Center: Checklist with checkboxes
- Right: Decision selection and notes
- Conditional/Rejection details appear based on selection
- Confirmation step before final approval
- Loading state during API call

**BatchStatusCard.tsx** (reusable)
- Compact card showing batch QA status
- Used on WO detail page, LP detail page, Shipping pages
- Shows: Final inspection status, Release status, Restrictions (if any)
- Color-coded status indicators

---

## Key Business Rules

1. **Final Inspection Required**: Final inspection auto-created on WO completion if `require_final_inspection = true`
2. **Evidence Aggregation**: Final inspection page shows all quality evidence from production (in-process, CCPs, checkpoints)
3. **Two-Step Release**: Inspection completion and batch release are separate steps (can complete inspection without immediate release)
4. **QA Manager Approval Required**: Only QA_MANAGER role can approve/reject batch release
5. **Inspector Submit**: QA_INSPECTOR can complete inspection and submit for approval, but not approve
6. **Checklist Minimum**: At least 4 of 6 checklist items must be confirmed for approval
7. **Release Gates Shipping**: LP.release_status must be 'released' for shipping module to include in available inventory
8. **Conditional Restrictions**: Conditional releases carry restrictions that display in shipping module
9. **Rejected Batches Blocked**: Rejected LPs cannot be shipped, require disposition decision
10. **Audit Trail Required**: All release decisions logged with user, timestamp, and full decision details
11. **No Edit After Approval**: Release records are immutable once approved (new release required for changes)
12. **NCR Blocks Release**: Open NCRs linked to batch block release approval

---

## Deliverables

### Database
- [ ] Migration: Add `release_status`, `released_by`, `released_at` to `license_plates` (if not exists)
- [ ] Migration: Create `batch_release_records` table
- [ ] Migration: Create `batch_release_lps` junction table
- [ ] Migration: Create `release_number_sequences` table
- [ ] Function: `generate_release_number(org_id)`
- [ ] Function: `create_final_inspection_on_wo_complete()` trigger
- [ ] Function: `update_lp_release_status_on_batch_release()` trigger
- [ ] RLS policies for all new tables
- [ ] All performance indexes

### API Routes
- [ ] `GET /api/quality/inspections/final` - Final inspection queue
- [ ] `GET /api/quality/inspections/:id/evidence` - Evidence summary
- [ ] `POST /api/quality/batch/:batchId/release-check` - Check release readiness
- [ ] `POST /api/quality/batch/:batchId/release` - Approve/reject release
- [ ] `GET /api/quality/batch/:batchId/status` - Batch QA status
- [ ] `GET /api/quality/batch-releases` - List release records
- [ ] `GET /api/quality/batch-releases/:id` - Release detail
- [ ] `POST /api/quality/batch-releases/:id/submit` - Submit for approval

### Service Layer
- [ ] `BatchReleaseService.checkReleaseReadiness()` - Release check logic
- [ ] `BatchReleaseService.getEvidenceSummary()` - Evidence aggregation
- [ ] `BatchReleaseService.approveBatchRelease()` - Approval workflow
- [ ] `BatchReleaseService.submitForApproval()` - Inspector submit
- [ ] `BatchReleaseService.updateLPReleaseStatus()` - LP status update
- [ ] `BatchReleaseService.getOutputLPs()` - Get batch LPs
- [ ] `BatchReleaseService.list()` - List with pagination
- [ ] `BatchReleaseService.getBatchStatus()` - Status summary
- [ ] `InspectionService.createFinalInspection()` - Create for WO (extends 06.5)

### Validation
- [ ] `releaseChecklistSchema`
- [ ] `batchReleaseRequestSchema`
- [ ] `batchReleaseListQuerySchema`

### Frontend
- [ ] Final inspection queue page
- [ ] Final inspection detail with evidence tabs
- [ ] Evidence summary panel
- [ ] Batch release queue page
- [ ] Batch release detail & approval page
- [ ] Release checklist component
- [ ] Release approval modal
- [ ] Conditional release form
- [ ] Release status badges
- [ ] Batch status card (reusable)
- [ ] LP release status integration

### Tests
- [ ] Unit tests: BatchReleaseService methods (>80% coverage)
- [ ] Integration tests: All API endpoints
- [ ] LP release status update tests
- [ ] Auto-creation trigger tests
- [ ] Permission tests (QA Manager vs Inspector)
- [ ] RLS tests: Multi-tenancy isolation
- [ ] E2E: Full workflow (WO complete -> Final inspection -> Release)

---

## Test Strategy

### Unit Tests

```typescript
describe('BatchReleaseService', () => {
  describe('checkReleaseReadiness', () => {
    it('returns can_release=true when all criteria met', async () => {});
    it('returns blockers when final inspection failed', async () => {});
    it('returns warnings for conditional inspection', async () => {});
    it('blocks release when open NCRs exist', async () => {});
    it('handles missing final inspection gracefully', async () => {});
  });

  describe('getEvidenceSummary', () => {
    it('aggregates in-process inspections correctly', async () => {});
    it('aggregates CCP monitoring records', async () => {});
    it('aggregates operation checkpoints', async () => {});
    it('identifies open NCRs for batch', async () => {});
    it('calculates overall status correctly', async () => {});
  });

  describe('approveBatchRelease', () => {
    it('creates release record on approval', async () => {});
    it('updates LP release_status to released', async () => {});
    it('handles conditional release correctly', async () => {});
    it('handles rejection correctly', async () => {});
    it('requires QA_MANAGER role', async () => {});
    it('validates checklist minimum', async () => {});
    it('creates audit log entry', async () => {});
  });

  describe('submitForApproval', () => {
    it('creates pending release record', async () => {});
    it('stores checklist state', async () => {});
    it('does not update LP status', async () => {});
  });

  describe('updateLPReleaseStatus', () => {
    it('sets release_status to released', async () => {});
    it('sets released_by and released_at', async () => {});
    it('creates audit log entry', async () => {});
  });
});
```

### Integration Tests

```typescript
describe('Batch Release API', () => {
  describe('POST /api/quality/batch/:batchId/release-check', () => {
    it('returns complete checklist for ready batch', async () => {});
    it('returns blockers for failed inspection', async () => {});
    it('returns 404 for unknown batch', async () => {});
    it('enforces RLS for org isolation', async () => {});
  });

  describe('POST /api/quality/batch/:batchId/release', () => {
    it('approves release with valid checklist', async () => {});
    it('updates all batch LPs', async () => {});
    it('requires conditional fields for conditional release', async () => {});
    it('requires rejection reason for rejection', async () => {});
    it('returns 403 for non-QA-Manager', async () => {});
    it('returns 400 for insufficient checklist', async () => {});
  });

  describe('GET /api/quality/batch/:batchId/status', () => {
    it('returns complete batch status', async () => {});
    it('shows LP summary correctly', async () => {});
    it('indicates can_ship correctly', async () => {});
  });
});
```

### E2E Tests

```typescript
describe('Final Inspection + Batch Release Workflow', () => {
  it('complete workflow: WO completion -> Final inspection -> Release', async () => {
    // 1. Complete WO (triggers final inspection creation)
    // 2. Verify final inspection appears in queue
    // 3. Start final inspection
    // 4. Record test results
    // 5. Complete inspection with pass
    // 6. Navigate to batch release
    // 7. Complete release checklist
    // 8. Approve release
    // 9. Verify LPs have release_status='released'
    // 10. Verify batch appears in Shipping available inventory
  });

  it('failed inspection blocks release', async () => {
    // 1. Complete WO
    // 2. Start final inspection
    // 3. Record failing test result
    // 4. Complete inspection with fail
    // 5. Attempt batch release
    // 6. Verify blocker displayed
    // 7. Verify LPs remain release_status='pending'
  });

  it('conditional release with restrictions', async () => {
    // 1. Complete inspection with conditional
    // 2. Approve conditional release with restrictions
    // 3. Verify restrictions stored
    // 4. Verify warning displays in Shipping module
  });

  it('QA Inspector submits, QA Manager approves', async () => {
    // 1. Login as QA Inspector
    // 2. Complete inspection
    // 3. Submit for approval (cannot approve directly)
    // 4. Login as QA Manager
    // 5. View pending approvals
    // 6. Approve release
    // 7. Verify success
  });
});
```

---

## Definition of Done

### Database
- [ ] `batch_release_records` table created with all columns
- [ ] `batch_release_lps` junction table created
- [ ] LP release status columns added
- [ ] All indexes created for performance
- [ ] RLS policies enforce org isolation
- [ ] Triggers for auto-creation and LP update work correctly
- [ ] Release number generation works correctly

### API
- [ ] All endpoints return correct HTTP status codes
- [ ] Validation errors return 400 with detailed messages
- [ ] Permission errors return 403 with explanation
- [ ] Cross-tenant access returns 404
- [ ] Response times:
  - Release check: < 1 second
  - Evidence summary: < 1 second
  - Release approval: < 2 seconds
  - LP updates: < 500ms per LP

### Service
- [ ] Complete workflow: WO complete -> Final inspection -> Release
- [ ] Evidence aggregation from multiple sources working
- [ ] Release check logic comprehensive and accurate
- [ ] Permission checks enforced (QA Manager for approval)
- [ ] LP release_status updated on approval
- [ ] Audit trail created for all actions

### Frontend
- [ ] Final inspection queue displays correctly
- [ ] Evidence summary panel shows all sources
- [ ] Batch release queue shows pending approvals
- [ ] Release checklist interactive and validated
- [ ] Release approval modal with all options
- [ ] Conditional release form works
- [ ] Status badges display correctly
- [ ] Permission-based UI (buttons shown/hidden appropriately)

### Integration
- [ ] Works with story 06.5 (Inspection patterns)
- [ ] Works with story 06.6 (Test Results Recording)
- [ ] Works with story 06.10 (In-Process Inspection reference)
- [ ] Works with Epic 04 WO completion trigger
- [ ] Works with Epic 05 LP service
- [ ] LP.release_status gates Epic 07 Shipping

### Testing
- [ ] Unit tests: >80% coverage on service
- [ ] Integration tests: All endpoints covered
- [ ] Permission tests: QA Manager vs Inspector
- [ ] LP status update tests passing
- [ ] RLS tests: Multi-tenancy verified
- [ ] E2E tests: Full workflow passing

---

## Risk Assessment

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| **Evidence aggregation performance** | MEDIUM | MEDIUM | Denormalize counts, cache summaries |
| **LP update race condition** | HIGH | LOW | Database transaction, row locking |
| **Complex permission logic** | MEDIUM | MEDIUM | Clear role checks, comprehensive tests |
| **WO completion trigger timing** | MEDIUM | LOW | Async trigger, manual fallback |
| **Shipping module integration** | HIGH | LOW | Clear LP.release_status contract |
| **Audit trail completeness** | HIGH | LOW | Trigger-based logging, validation |

---

## Integration with Epic 07 (Shipping)

### Contract: LP Release Status

The shipping module (Epic 07) will query available inventory using the `release_status` field:

```sql
-- Shipping module inventory query (Epic 07)
SELECT lp.*
FROM license_plates lp
WHERE lp.org_id = :org_id
  AND lp.status = 'available'           -- Not consumed/shipped
  AND lp.qa_status = 'passed'           -- QA approved
  AND lp.release_status = 'released'    -- Batch released
  AND lp.product_id = :product_id;
```

**UI Integration:**
- Shipping allocation page shows only released LPs
- LPs with `release_status='pending'` show tooltip "Pending QA release"
- LPs with conditional release show restriction warning
- Rejected LPs not shown in available inventory

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-12-16 | Initial comprehensive story creation | OPUS |

---

**Document Status**: Ready for Implementation
**Created**: 2025-12-16
**Lines**: ~1500
**Complexity**: L (Large)
**Phase**: 2 (In-Process & Final)
**Model**: OPUS - Critical regulatory workflow with multiple dependencies
