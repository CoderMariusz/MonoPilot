# 06.30 - HACCP Verification Records

**Priority**: P0 (MVP)
**Story Points**: M (Medium)
**Type**: full-stack
**Phase**: 3 (CoA & HACCP)
**Model**: OPUS

**State:** ready
**Estimate:** M (3-4 days)
**Primary PRD:** `docs/1-BASELINE/product/modules/quality.md` (FR-QA-013, Section 4.5)
**Architecture:** `docs/1-BASELINE/architecture/modules/quality.md` (haccp_verification_records table)

---

## Goal

Implement HACCP verification record management for systematic verification of HACCP plan effectiveness. Enables scheduled verification activities (calibration, record review, audits) with multi-level approvals, automated next verification date calculation, and complete verification history tracking. This is a regulatory requirement for HACCP compliance.

---

## Food Safety Compliance

This story is **critical for HACCP compliance**:

- [x] **HACCP Principle 6** - Verification procedures required for HACCP plan
- [x] **FDA HACCP Regulations** - Documented verification activities mandatory
- [x] **GFSI Standards** - Annual verification of HACCP effectiveness
- [x] **Audit Trail** - All verification activities must be logged with signatures
- [x] **Retention** - Verification records retained for 5 years minimum

**Regulatory Context:**
- Verification activities include: CCP record review, calibration verification, HACCP plan review, audit
- Verification frequency: Monthly for CCP records, Quarterly for calibrations, Annually for plan review
- Dual signatures required: QA Manager + Quality Director
- Verification must confirm: CCP records complete, deviations reviewed, corrective actions effective
- Failed verification triggers immediate corrective action

---

## MVP Scope

**MVP Includes**:
- `haccp_verification_records` table with approval workflow
- HACCP verification scheduling (monthly/quarterly/annually)
- Verification types: Calibration, Record Review, Plan Review, Audit
- Verification checklist (CCP records complete, deviations reviewed, corrective actions effective)
- Verification result: Pass/Fail/Partial
- Dual e-signature capture (QA Manager + Quality Director)
- Next verification date auto-calculation
- Verification history with filters
- Overdue verification alerts
- Verification dashboard widget

**Deferred to Phase 3+**:
- Verification templates (Phase 4)
- Photo attachments for evidence (Phase 4)
- Integration with equipment calibration system (Phase 4)
- Automated verification reminders (Phase 4)

---

## User Story

As a **QA Manager**, I want **to schedule and record HACCP verification activities with checklists and approval workflow** so that **we maintain HACCP compliance and demonstrate systematic verification of our food safety plan**.

As a **Quality Director**, I want **to review and approve HACCP verifications with electronic signature** so that **we ensure verification activities are thorough and meet regulatory requirements**.

---

## Dependencies

### Cross-Epic Dependencies

| Dependency | Story/Epic | Type | What It Provides | Status |
|------------|------------|------|------------------|--------|
| 01.1 | Org Context + RLS | HARD | organizations, users, roles tables | Ready |

### Within Epic Dependencies

| Dependency | Story | Type | What It Provides |
|------------|-------|------|------------------|
| 06.21 | HACCP Plan Setup | HARD | haccp_plans table | Ready |
| 06.22 | CCP Definition | HARD | haccp_ccps table | Ready |
| 06.23 | CCP Monitoring (Desktop) | HARD | haccp_monitoring_records for verification | Ready |
| 06.25 | CCP Deviation Handling | HARD | haccp_deviations for review | Ready |

---

## Database Migration

```sql
-- Migration: YYYYMMDDHHMMSS_create_haccp_verification_records.sql

CREATE TABLE haccp_verification_records (
    -- Identity
    id                      UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id                  UUID NOT NULL REFERENCES organizations(id),
    verification_number     TEXT NOT NULL,

    -- HACCP Plan Reference
    haccp_plan_id           UUID NOT NULL REFERENCES haccp_plans(id),

    -- Verification Info
    verification_type       TEXT NOT NULL
                            CHECK (verification_type IN ('calibration', 'record_review', 'plan_review', 'audit')),

    verification_date       DATE NOT NULL,
    scheduled_date          DATE,

    -- Frequency
    frequency               TEXT
                            CHECK (frequency IN ('monthly', 'quarterly', 'annually', 'as_needed')),

    next_verification_date  DATE,

    -- Verifier Info
    verified_by             UUID NOT NULL REFERENCES users(id),
    verified_at             TIMESTAMPTZ NOT NULL DEFAULT now(),

    -- Checklist Items (JSONB)
    checklist_items         JSONB NOT NULL DEFAULT '[]'::jsonb,

    -- Result
    result                  TEXT NOT NULL
                            CHECK (result IN ('pass', 'fail', 'partial')),

    findings                TEXT,
    recommendations         TEXT,

    -- Corrective Actions Required
    corrective_actions_required BOOLEAN NOT NULL DEFAULT false,
    corrective_action_notes TEXT,

    -- Dual Approval (QA Manager + Quality Director)
    qa_manager_approved_by  UUID REFERENCES users(id),
    qa_manager_approved_at  TIMESTAMPTZ,
    qa_manager_signature    TEXT,

    director_approved_by    UUID REFERENCES users(id),
    director_approved_at    TIMESTAMPTZ,
    director_signature      TEXT,

    -- Status
    status                  TEXT NOT NULL DEFAULT 'draft'
                            CHECK (status IN ('draft', 'pending_qa_approval', 'pending_director_approval', 'approved', 'rejected')),

    -- Immutability
    is_locked               BOOLEAN NOT NULL DEFAULT false,

    -- Audit
    created_at              TIMESTAMPTZ NOT NULL DEFAULT now(),
    created_by              UUID REFERENCES users(id),
    updated_at              TIMESTAMPTZ NOT NULL DEFAULT now(),
    updated_by              UUID REFERENCES users(id),

    -- Constraints
    CONSTRAINT uq_verification_number UNIQUE (org_id, verification_number)
);

-- =============================================================================
-- Indexes for Performance
-- =============================================================================

CREATE INDEX idx_verifications_org ON haccp_verification_records(org_id);
CREATE INDEX idx_verifications_org_status ON haccp_verification_records(org_id, status);
CREATE INDEX idx_verifications_plan ON haccp_verification_records(haccp_plan_id);
CREATE INDEX idx_verifications_type ON haccp_verification_records(org_id, verification_type);
CREATE INDEX idx_verifications_date ON haccp_verification_records(org_id, verification_date);
CREATE INDEX idx_verifications_next_date ON haccp_verification_records(org_id, next_verification_date)
    WHERE next_verification_date IS NOT NULL;
CREATE INDEX idx_verifications_overdue ON haccp_verification_records(org_id, next_verification_date)
    WHERE next_verification_date < CURRENT_DATE AND status = 'approved';

-- =============================================================================
-- Verification Number Sequence
-- =============================================================================

CREATE TABLE haccp_verification_number_sequences (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    year INTEGER NOT NULL,
    current_value BIGINT NOT NULL DEFAULT 0,
    updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
    UNIQUE(org_id, year)
);

-- Function to generate verification number (HACCP-VER-YYYY-NNNNN)
CREATE OR REPLACE FUNCTION generate_verification_number(p_org_id UUID)
RETURNS TEXT AS $$
DECLARE
    v_year INTEGER;
    v_next_val BIGINT;
    v_verification_number TEXT;
BEGIN
    v_year := EXTRACT(YEAR FROM CURRENT_DATE);

    -- Upsert sequence and get next value
    INSERT INTO haccp_verification_number_sequences (org_id, year, current_value)
    VALUES (p_org_id, v_year, 1)
    ON CONFLICT (org_id, year)
    DO UPDATE SET
        current_value = haccp_verification_number_sequences.current_value + 1,
        updated_at = NOW()
    RETURNING current_value INTO v_next_val;

    -- Format verification number
    v_verification_number := 'HACCP-VER-' || v_year::TEXT || '-' || LPAD(v_next_val::TEXT, 5, '0');

    RETURN v_verification_number;
END;
$$ LANGUAGE plpgsql;

-- =============================================================================
-- RLS Policies
-- =============================================================================

ALTER TABLE haccp_verification_records ENABLE ROW LEVEL SECURITY;

CREATE POLICY "verifications_select" ON haccp_verification_records
    FOR SELECT USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

CREATE POLICY "verifications_insert" ON haccp_verification_records
    FOR INSERT WITH CHECK (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

CREATE POLICY "verifications_update" ON haccp_verification_records
    FOR UPDATE USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
        AND is_locked = false
    );

CREATE POLICY "verifications_delete" ON haccp_verification_records
    FOR DELETE USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
        AND status = 'draft'
    );

ALTER TABLE haccp_verification_number_sequences ENABLE ROW LEVEL SECURITY;

CREATE POLICY "verification_seq_org" ON haccp_verification_number_sequences
    FOR ALL TO authenticated
    USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

-- =============================================================================
-- Triggers
-- =============================================================================

CREATE TRIGGER update_verifications_updated_at
    BEFORE UPDATE ON haccp_verification_records
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- =============================================================================
-- Function: Calculate next verification date
-- =============================================================================

CREATE OR REPLACE FUNCTION calculate_next_verification_date()
RETURNS TRIGGER AS $$
DECLARE
    v_interval INTERVAL;
BEGIN
    -- When verification approved, calculate next verification date
    IF NEW.status = 'approved' AND (OLD.status IS NULL OR OLD.status != 'approved') THEN

        -- Calculate interval based on frequency
        CASE NEW.frequency
            WHEN 'monthly' THEN v_interval := INTERVAL '1 month';
            WHEN 'quarterly' THEN v_interval := INTERVAL '3 months';
            WHEN 'annually' THEN v_interval := INTERVAL '1 year';
            ELSE v_interval := NULL;
        END CASE;

        -- Set next verification date
        IF v_interval IS NOT NULL THEN
            NEW.next_verification_date := NEW.verification_date + v_interval;
        END IF;

        -- Lock verification record
        NEW.is_locked := true;
    END IF;

    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_calculate_next_verification
    BEFORE UPDATE ON haccp_verification_records
    FOR EACH ROW
    WHEN (NEW.status = 'approved')
    EXECUTE FUNCTION calculate_next_verification_date();
```

---

## Acceptance Criteria

### AC-1: Verification Table Creation

```gherkin
Scenario: haccp_verification_records table exists
  Given database migration runs
  When schema is inspected
  Then haccp_verification_records table has all columns
  And UNIQUE constraint on (org_id, verification_number)
  And RLS policies enforce org isolation
```

### AC-2: Create Verification Record

```gherkin
Scenario: Create monthly CCP record review
  Given HACCP plan exists for Bread production
  When QA Manager creates verification
  And fills:
    | Field | Value |
    | Type | Record Review |
    | Date | 2025-01-15 |
    | Frequency | Monthly |
  And completes checklist:
    - CCP monitoring records complete for all CCPs
    - No missing data points
    - All deviations documented
    - Corrective actions taken and effective
  And sets result = 'pass'
  Then verification created with:
    | verification_number | HACCP-VER-2025-00001 |
    | status | draft |
    | verified_by | Current user |
    | verified_at | Now |
    | checklist_items | 4 items with checked status |

Scenario: Checklist stored in JSONB
  Given verification with 4 checklist items
  When saved
  Then checklist_items contains:
    [
      {"item": "CCP records complete", "checked": true, "notes": null},
      {"item": "No missing data", "checked": true, "notes": null},
      {"item": "Deviations documented", "checked": true, "notes": null},
      {"item": "Corrective actions effective", "checked": true, "notes": "All reviewed"}
    ]
```

### AC-3: Verification Types

```gherkin
Scenario: Record review verification
  Given verification_type = 'record_review'
  When creating verification
  Then default checklist includes:
    - CCP monitoring records complete
    - Deviations reviewed and documented
    - Corrective actions taken
    - No gaps in monitoring

Scenario: Calibration verification
  Given verification_type = 'calibration'
  Then default checklist includes:
    - All equipment calibrated
    - Calibration within tolerance
    - Calibration certificates on file
    - Next calibration dates scheduled

Scenario: Plan review verification
  Given verification_type = 'plan_review'
  Then default checklist includes:
    - HACCP plan reviewed for accuracy
    - CCPs still valid
    - Critical limits appropriate
    - Monitoring procedures adequate
    - HACCP team reviewed changes

Scenario: Audit verification
  Given verification_type = 'audit'
  Then default checklist includes:
    - Internal audit conducted
    - HACCP compliance verified
    - Non-conformances documented
    - Corrective actions assigned
```

### AC-4: Dual Approval Workflow

```gherkin
Scenario: Submit for QA Manager approval
  Given verification in draft
  When verifier clicks [Submit for Approval]
  Then status = 'pending_qa_approval'
  And QA Manager notified

Scenario: QA Manager approves
  Given verification pending_qa_approval
  And current user is QA_MANAGER
  When clicking [Approve as QA Manager]
  And entering e-signature password
  Then qa_manager_approved_by = current user
  And qa_manager_approved_at = now
  And qa_manager_signature = encrypted signature
  And status = 'pending_director_approval'
  And Quality Director notified

Scenario: Quality Director approves (final)
  Given verification pending_director_approval
  And current user is QUALITY_DIRECTOR
  When clicking [Approve as Director]
  And entering e-signature password
  Then director_approved_by = current user
  And director_approved_at = now
  And director_signature = encrypted signature
  And status = 'approved'
  And is_locked = true
  And next_verification_date calculated
```

### AC-5: Next Verification Date Calculation

```gherkin
Scenario: Monthly verification next date
  Given verification approved with:
    | frequency | monthly |
    | verification_date | 2025-01-15 |
  Then next_verification_date = 2025-02-15

Scenario: Quarterly verification next date
  Given verification approved with:
    | frequency | quarterly |
    | verification_date | 2025-01-15 |
  Then next_verification_date = 2025-04-15

Scenario: Annual verification next date
  Given verification approved with:
    | frequency | annually |
    | verification_date | 2025-01-15 |
  Then next_verification_date = 2026-01-15
```

### AC-6: Failed Verification Handling

```gherkin
Scenario: Verification fails with findings
  Given verification with result = 'fail'
  When verifier enters findings:
    "CCP monitoring gaps found for CCP-3 (Cooking Temperature) on 2025-01-10"
  And sets corrective_actions_required = true
  And enters corrective_action_notes:
    "Retrain operators on CCP monitoring procedures. Audit next 3 days."
  Then verification saved
  And alert sent to Production Lead
  And corrective action workflow triggered

Scenario: Partial pass with recommendations
  Given verification with result = 'partial'
  Then findings field required
  And recommendations field required
  And corrective actions optional
```

### AC-7: Overdue Verification Alerts

```gherkin
Scenario: Identify overdue verifications
  Given verification approved with next_verification_date = 2025-01-10
  And today is 2025-01-15 (5 days overdue)
  When loading verification dashboard
  Then overdue badge shown
  And alert notification sent to QA Manager

Scenario: Upcoming verification reminders
  Given verification with next_verification_date = 2025-01-20
  And today is 2025-01-13 (7 days before)
  Then reminder notification sent to QA Manager
```

### AC-8: Verification History

```gherkin
Scenario: View verification history for HACCP plan
  Given HACCP plan with 12 monthly verifications
  When viewing verification history
  Then list shows all 12 verifications sorted by date descending
  And displays:
    | Column | Content |
    | Verification # | HACCP-VER-2025-00001 |
    | Type | Record Review |
    | Date | 2025-01-15 |
    | Result | PASS badge |
    | Verified By | User name |
    | Status | Approved |
    | Next Due | 2025-02-15 |
```

### AC-9: Verification Dashboard Widget

```gherkin
Scenario: HACCP verification summary widget
  Given Quality Dashboard
  Then widget displays:
    | Metric | Value |
    | Overdue Verifications | 2 (red) |
    | Due This Week | 3 (yellow) |
    | Due This Month | 5 (blue) |
    | Last Verification | 2025-01-10 (PASS) |
  And clicking widget navigates to verification list
```

### AC-10: Immutability After Approval

```gherkin
Scenario: Approved verification is locked
  Given verification with status = 'approved'
  When attempting to edit
  Then error: "Cannot edit approved verification"
  And all fields read-only

Scenario: Rejected verification can be edited
  Given verification rejected by QA Manager
  When status = 'draft' again
  Then can edit and resubmit
```

### AC-11: Permission Enforcement

```gherkin
Scenario: QA Inspector can create verifications
  Given user with QA_INSPECTOR role
  Then can create and submit for approval
  But cannot approve

Scenario: QA Manager can approve first level
  Given user with QA_MANAGER role
  Then can approve as QA Manager
  But cannot approve as Director

Scenario: Quality Director can approve final
  Given user with QUALITY_DIRECTOR role
  Then can approve as Director (final approval)
```

### AC-12: RLS Policy Enforcement

```gherkin
Scenario: Org isolation
  Given User A from Org A
  When requesting verifications
  Then only Org A verifications returned
```

---

## Implementation Notes

### API Endpoints

```typescript
// GET /api/quality/haccp-verifications
interface VerificationListParams {
  haccp_plan_id?: string;
  verification_type?: 'calibration' | 'record_review' | 'plan_review' | 'audit';
  status?: string;
  result?: 'pass' | 'fail' | 'partial';
  overdue?: boolean;
  date_from?: string;
  date_to?: string;
}

interface HACCPVerification {
  id: string;
  verification_number: string;
  haccp_plan_id: string;
  verification_type: string;
  verification_date: string;
  frequency: string;
  next_verification_date?: string;
  verified_by: string;
  result: 'pass' | 'fail' | 'partial';
  status: string;
  checklist_items: ChecklistItem[];
  findings?: string;
  corrective_actions_required: boolean;
}

// POST /api/quality/haccp-verifications
interface CreateVerificationRequest {
  haccp_plan_id: string;
  verification_type: string;
  verification_date: string;
  frequency: string;
  checklist_items: ChecklistItem[];
  result: 'pass' | 'fail' | 'partial';
  findings?: string;
}

// POST /api/quality/haccp-verifications/:id/approve-qa
interface ApproveQARequest {
  password: string;
}

// POST /api/quality/haccp-verifications/:id/approve-director
interface ApproveDirectorRequest {
  password: string;
}
```

---

## Deliverables

### Database
- [ ] Migration: haccp_verification_records table
- [ ] Function: generate_verification_number()
- [ ] Function: calculate_next_verification_date() trigger
- [ ] RLS policies

### API Routes
- [ ] `GET /api/quality/haccp-verifications`
- [ ] `POST /api/quality/haccp-verifications`
- [ ] `POST /api/quality/haccp-verifications/:id/approve-qa`
- [ ] `POST /api/quality/haccp-verifications/:id/approve-director`

### Service Layer
- [ ] `HACCPVerificationService.create()`
- [ ] `HACCPVerificationService.approveQA()`
- [ ] `HACCPVerificationService.approveDirector()`
- [ ] `HACCPVerificationService.getOverdue()`

### Frontend
- [ ] Verification list page
- [ ] Create verification form
- [ ] Dual approval workflow UI
- [ ] Overdue alerts

### Tests
- [ ] Unit tests: Service methods
- [ ] Integration tests: API endpoints
- [ ] E2E: Verification creation and dual approval

---

## Definition of Done

- [ ] All tables and triggers created
- [ ] Dual approval workflow works
- [ ] Next verification date auto-calculated
- [ ] Overdue alerts functional
- [ ] All tests passing

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-01-15 | Initial story creation | ARCHITECT-AGENT |

---

**Document Status**: Ready for Implementation
**Created**: 2025-01-15
**Complexity**: M (Medium)
**Phase**: 3 (CoA & HACCP)
