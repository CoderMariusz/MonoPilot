# 06.31 - CAPA Creation

**Priority**: P1 (Phase 4)
**Story Points**: M (Medium)
**Type**: full-stack
**Phase**: 4 (Advanced Quality)
**Model**: OPUS

**State:** ready
**Estimate:** M (3-4 days)
**Primary PRD:** `docs/1-BASELINE/product/modules/quality.md` (FR-QA-016, Section 4.2 NCR & CAPA)
**Architecture:** `docs/1-BASELINE/architecture/modules/quality.md` (capa_records table)

---

## Goal

Implement CAPA (Corrective and Preventive Action) creation and management. CAPA records address systemic quality issues identified through NCRs, audits, customer complaints, or management reviews. This story enables QA teams to create, track, and manage CAPAs with automatic target date calculation, source linkage, and owner assignment.

---

## Food Safety Compliance

This story is **critical for quality management compliance**:

- [x] **ISO 9001:2015** - Clause 10.2 Nonconformity and corrective action
- [x] **FDA 21 CFR Part 11** - Audit trail for all CAPA actions
- [x] **FSMA** - Preventive Controls for Human Food (PC rule)
- [x] **Audit Trail Required** - All CAPA state changes, assignments, dates

**Regulatory Context:**
- ISO 9001 requires systematic approach to corrective/preventive actions
- GFSI schemes (SQF, BRC) mandate CAPA systems
- Trend analysis for preventive action identification
- Root cause analysis documentation
- All records retained for minimum 10 years

---

## MVP Scope

This story implements Phase 4 (Advanced Quality) CAPA creation functionality.

**MVP Includes**:
- `capa_records` table with source type polymorphism
- CAPA number auto-generation (CAPA-YYYY-NNNNN)
- CAPA types: Corrective vs Preventive
- CAPA priority levels: Low/Medium/High/Critical
- Source integration: NCR, Audit, Complaint, Management Review
- Owner assignment
- Target close date auto-calculation based on priority
- Integration with 06.13 NCR (create CAPA from NCR)
- CAPA list with filters and search
- CAPA detail page
- Create/Edit CAPA forms

**Deferred to Story 06.32**: CAPA action items (checklist)
**Deferred to Story 06.33**: CAPA effectiveness checks

---

## User Story

As a **QA Manager**, I want to **create and manage CAPA records for systemic quality issues identified through NCRs, audits, or complaints** so that **we systematically address root causes and prevent recurrence**.

As a **Quality Director**, I want to **track CAPA status, priority, and ownership** so that **I can ensure timely resolution and compliance with quality standards**.

---

## Scope

**In scope (this story)**
- `capa_records` table with full schema
- POST /api/quality/capa (create CAPA)
- GET /api/quality/capa (list with filters)
- GET /api/quality/capa/:id (detail)
- PUT /api/quality/capa/:id (update)
- DELETE /api/quality/capa/:id (delete if status='open')
- POST /api/quality/ncrs/:id/create-capa (create from NCR)
- CAPA number auto-generation
- Target close date auto-calculation (priority-based)
- Owner assignment
- CAPA status workflow: open → in_progress → closed
- CAPA list page with filters (status, priority, source type, owner)
- CAPA detail page
- Create CAPA modal
- Edit CAPA form

**Out of scope (this story)**
- CAPA action items (story 06.32)
- CAPA effectiveness checks (story 06.33)
- CAPA analytics/dashboard (future)
- CAPA templates (future)
- CAPA attachments (future)

---

## Dependencies

### Cross-Epic Dependencies

| Dependency | Story/Epic | Type | What It Provides | Status |
|------------|------------|------|------------------|--------|
| 01.1 | Org Context + RLS | HARD | organizations, users tables | Ready |
| 06.13 | NCR Creation | HARD | ncr_reports table for source linkage | Ready |

### Within Epic Dependencies

| Dependency | Story | Type | What It Provides |
|------------|-------|------|------------------|
| 06.13 | NCR Creation | HARD | ncr_reports table, NCR reference |

### Provides To (Downstream)

| Story | What This Provides |
|-------|-------------------|
| 06.32 | CAPA Action Items - capa_id reference |
| 06.33 | CAPA Effectiveness Check - capa record |

---

## Database Migration

### Migration: Create capa_records table

```sql
-- Migration: YYYYMMDDHHMMSS_create_capa_records_table.sql

CREATE TABLE capa_records (
    -- Identity
    id                      UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id                  UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    capa_number             TEXT NOT NULL,

    -- Source Reference (polymorphic)
    source_type             TEXT NOT NULL
                            CHECK (source_type IN ('ncr', 'audit', 'complaint', 'management_review', 'manual')),
    source_id               UUID,  -- NULL for manual CAPAs

    -- CAPA Details
    title                   TEXT NOT NULL,
    description             TEXT NOT NULL,

    -- CAPA Type
    capa_type               TEXT NOT NULL
                            CHECK (capa_type IN ('corrective', 'preventive')),

    -- Priority
    priority                TEXT NOT NULL DEFAULT 'medium'
                            CHECK (priority IN ('low', 'medium', 'high', 'critical')),

    -- Status
    status                  TEXT NOT NULL DEFAULT 'open'
                            CHECK (status IN ('open', 'in_progress', 'closed', 'cancelled')),

    -- Assignment
    owner_id                UUID REFERENCES users(id),
    assigned_by             UUID REFERENCES users(id),
    assigned_at             TIMESTAMPTZ,

    -- Dates
    created_date            DATE NOT NULL DEFAULT CURRENT_DATE,
    target_close_date       DATE NOT NULL,
    actual_close_date       DATE,

    -- Root Cause
    root_cause              TEXT,
    root_cause_method       TEXT,  -- e.g., "5 Whys", "Fishbone", "Fault Tree"

    -- Closure
    closed_by               UUID REFERENCES users(id),
    closed_at               TIMESTAMPTZ,
    closure_notes           TEXT,

    -- Audit
    created_at              TIMESTAMPTZ NOT NULL DEFAULT now(),
    created_by              UUID REFERENCES users(id),
    updated_at              TIMESTAMPTZ NOT NULL DEFAULT now(),
    updated_by              UUID REFERENCES users(id),

    -- Constraints
    CONSTRAINT uq_capa_number UNIQUE (org_id, capa_number),
    CONSTRAINT capa_closed_check CHECK (
        (status = 'closed' AND closed_by IS NOT NULL AND closed_at IS NOT NULL AND actual_close_date IS NOT NULL)
        OR status != 'closed'
    )
);

-- =============================================================================
-- Indexes for Performance
-- =============================================================================

CREATE INDEX idx_capa_org_status ON capa_records(org_id, status);
CREATE INDEX idx_capa_org_priority ON capa_records(org_id, priority);
CREATE INDEX idx_capa_org_type ON capa_records(org_id, capa_type);
CREATE INDEX idx_capa_owner ON capa_records(owner_id) WHERE owner_id IS NOT NULL;
CREATE INDEX idx_capa_source ON capa_records(source_type, source_id) WHERE source_id IS NOT NULL;
CREATE INDEX idx_capa_created_date ON capa_records(org_id, created_date);
CREATE INDEX idx_capa_target_close ON capa_records(org_id, target_close_date)
    WHERE status IN ('open', 'in_progress');
CREATE INDEX idx_capa_overdue ON capa_records(org_id, target_close_date, status)
    WHERE target_close_date < CURRENT_DATE AND status != 'closed';

-- =============================================================================
-- CAPA Number Sequence
-- =============================================================================

CREATE TABLE capa_number_sequences (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    year INTEGER NOT NULL,
    current_value BIGINT NOT NULL DEFAULT 0,
    updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
    UNIQUE(org_id, year)
);

-- Function to generate CAPA number (CAPA-YYYY-NNNNN)
CREATE OR REPLACE FUNCTION generate_capa_number(p_org_id UUID)
RETURNS TEXT AS $$
DECLARE
    v_year INTEGER;
    v_next_val BIGINT;
    v_capa_number TEXT;
BEGIN
    v_year := EXTRACT(YEAR FROM CURRENT_DATE);

    -- Upsert sequence and get next value
    INSERT INTO capa_number_sequences (org_id, year, current_value)
    VALUES (p_org_id, v_year, 1)
    ON CONFLICT (org_id, year)
    DO UPDATE SET
        current_value = capa_number_sequences.current_value + 1,
        updated_at = NOW()
    RETURNING current_value INTO v_next_val;

    -- Format CAPA number
    v_capa_number := 'CAPA-' || v_year::TEXT || '-' || LPAD(v_next_val::TEXT, 5, '0');

    RETURN v_capa_number;
END;
$$ LANGUAGE plpgsql;

-- =============================================================================
-- Function: Calculate target close date based on priority
-- =============================================================================

CREATE OR REPLACE FUNCTION calculate_capa_target_date(p_priority TEXT, p_created_date DATE)
RETURNS DATE AS $$
DECLARE
    v_days_to_add INTEGER;
BEGIN
    CASE p_priority
        WHEN 'critical' THEN v_days_to_add := 7;    -- 1 week
        WHEN 'high' THEN v_days_to_add := 30;       -- 30 days
        WHEN 'medium' THEN v_days_to_add := 60;     -- 60 days
        WHEN 'low' THEN v_days_to_add := 90;        -- 90 days
        ELSE v_days_to_add := 60;                    -- Default 60 days
    END CASE;

    RETURN p_created_date + v_days_to_add;
END;
$$ LANGUAGE plpgsql;

-- =============================================================================
-- RLS Policies
-- =============================================================================

ALTER TABLE capa_records ENABLE ROW LEVEL SECURITY;

CREATE POLICY "capa_select" ON capa_records
    FOR SELECT USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

CREATE POLICY "capa_insert" ON capa_records
    FOR INSERT WITH CHECK (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

CREATE POLICY "capa_update" ON capa_records
    FOR UPDATE USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

-- Only allow delete of open CAPAs (not started)
CREATE POLICY "capa_delete" ON capa_records
    FOR DELETE USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
        AND status = 'open'
    );

ALTER TABLE capa_number_sequences ENABLE ROW LEVEL SECURITY;

CREATE POLICY "capa_seq_org" ON capa_number_sequences
    FOR ALL TO authenticated
    USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

-- =============================================================================
-- Trigger for updated_at
-- =============================================================================

CREATE TRIGGER update_capa_records_updated_at
    BEFORE UPDATE ON capa_records
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();
```

---

## Acceptance Criteria (Given/When/Then)

### AC-1: CAPA Table Creation

```gherkin
Scenario: capa_records table exists with all required columns
  Given database migration runs
  When schema is inspected
  Then capa_records table has all columns from schema
  And UNIQUE constraint exists on (org_id, capa_number)
  And CHECK constraints enforce valid status/priority/type
  And RLS policies enforce org isolation
```

### AC-2: CAPA Number Auto-Generation

```gherkin
Scenario: Generate CAPA number with year-based format
  Given organization exists
  When creating first CAPA in 2025
  Then capa_number = 'CAPA-2025-00001'
  And next CAPA gets 'CAPA-2025-00002'
  And year resets sequence (first 2026 = 'CAPA-2026-00001')

Scenario: CAPA number uniqueness per org
  Given CAPA 'CAPA-2025-00001' exists in org A
  When creating another with same number in org A
  Then system returns 409 Conflict error
```

### AC-3: Target Close Date Auto-Calculation

```gherkin
Scenario: Target date calculation by priority
  Given creating CAPA with priority
  When priority = 'critical'
  Then target_close_date = created_date + 7 days
  When priority = 'high'
  Then target_close_date = created_date + 30 days
  When priority = 'medium'
  Then target_close_date = created_date + 60 days
  When priority = 'low'
  Then target_close_date = created_date + 90 days

Scenario: Override target date manually
  Given creating CAPA with priority = 'medium' (default 60 days)
  When user manually sets target_close_date = created_date + 45 days
  Then target_close_date = created_date + 45 days
  And override respected
```

### AC-4: Create CAPA Manually

```gherkin
Scenario: Create manual CAPA
  Given user navigates to CAPA list page
  And clicks [+ New CAPA]
  When user fills form:
    | Field | Value |
    | Title | Supplier temperature excursion |
    | Description | Multiple shipments received above spec |
    | CAPA Type | Preventive |
    | Priority | High |
    | Owner | QA Manager |
    | Root Cause | Inadequate supplier cold chain control |
  And clicks [Create]
  Then CAPA created with:
    | Field | Value |
    | capa_number | CAPA-2025-00001 (auto-generated) |
    | status | open |
    | source_type | manual |
    | source_id | NULL |
    | target_close_date | created_date + 30 days (high priority) |
  And success toast "CAPA CAPA-2025-00001 created"
```

### AC-5: Create CAPA from NCR

```gherkin
Scenario: Create CAPA from NCR detail page
  Given NCR NCR-2025-00005 exists
  And user views NCR detail page
  When user clicks [Create CAPA]
  Then CAPA form opens with pre-filled:
    | Field | Value |
    | source_type | ncr |
    | source_id | NCR uuid |
    | title | "CAPA for NCR-2025-00005" (editable) |
    | description | Copied from NCR description |
    | capa_type | corrective (default for NCR) |
    | priority | Inherited from NCR severity |
  And user can edit and submit
  Then CAPA created with source linkage

Scenario: NCR shows linked CAPA
  Given CAPA created from NCR
  When viewing NCR detail page
  Then "Linked CAPA" section shows:
    | CAPA Number | Status | Owner | Target Date |
    | CAPA-2025-00001 | Open | QA Manager | 2025-03-15 |
  And click navigates to CAPA detail
```

### AC-6: CAPA List Display

```gherkin
Scenario: CAPA list page loads
  Given user navigates to Quality > CAPA
  When page loads
  Then DataTable displays CAPAs with columns:
    | Column | Description |
    | CAPA # | Link to detail |
    | Title | CAPA title |
    | Type | Badge (Corrective/Preventive) |
    | Priority | Badge with color |
    | Status | Badge (Open/In Progress/Closed) |
    | Owner | Assigned owner name |
    | Source | NCR link or type |
    | Created | Date |
    | Target Close | Date |
    | Actions | View, Edit, Delete |
  And list loads within 500ms
  And pagination available (20 per page)

Scenario: Filter by status
  Given CAPAs with various statuses exist
  When user filters by status = 'open'
  Then only open CAPAs display
  And URL updates with filter state

Scenario: Filter by priority
  Given CAPAs with mixed priorities
  When user filters by priority = 'critical'
  Then only critical CAPAs display
  And sorted by target_close_date ascending (oldest first)

Scenario: Filter by owner
  Given CAPAs assigned to different owners
  When user filters by owner = 'QA Manager'
  Then only CAPAs owned by QA Manager display

Scenario: Filter by source type
  Given CAPAs from various sources
  When user filters by source_type = 'ncr'
  Then only CAPAs created from NCRs display
  And source column shows NCR links

Scenario: Search by CAPA number or title
  Given CAPAs exist
  When user searches "CAPA-2025-00001" or "temperature"
  Then matching CAPAs display
  And search debounced (300ms)
```

### AC-7: CAPA Detail Page

```gherkin
Scenario: View CAPA detail
  Given CAPA CAPA-2025-00001 exists
  When user navigates to /quality/capa/CAPA-2025-00001
  Then page displays:
    | Section | Content |
    | Header | CAPA #, Status badge, Priority badge, Type badge |
    | Details | Title, Description, Root Cause, Root Cause Method |
    | Source | Source type, Source link (if NCR/Audit) |
    | Assignment | Owner name, Assigned by, Assigned date |
    | Dates | Created, Target Close, Actual Close (if closed) |
    | Actions | Based on status and permissions |
    | Action Items | List from story 06.32 (placeholder) |
    | Effectiveness | Checks from story 06.33 (placeholder) |
```

### AC-8: Edit CAPA

```gherkin
Scenario: Edit open CAPA
  Given CAPA with status = 'open'
  When user clicks [Edit]
  Then form displays with current values
  And user can modify:
    - Title
    - Description
    - Priority (recalculates target_close_date)
    - Owner
    - Root cause
    - Root cause method
    - Target close date (manual override)
  And user saves
  Then CAPA updated
  And audit log records changes

Scenario: Cannot edit closed CAPA fields
  Given CAPA with status = 'closed'
  When viewing CAPA detail
  Then [Edit] button hidden
  And all fields read-only
  And warning "Closed CAPAs cannot be edited"
```

### AC-9: Assign CAPA Owner

```gherkin
Scenario: Assign owner on creation
  Given creating new CAPA
  When user selects owner from dropdown
  Then owner_id set to selected user
  And assigned_by = current user
  And assigned_at = now

Scenario: Reassign owner
  Given CAPA assigned to User A
  When QA Manager clicks [Reassign]
  And selects User B
  Then owner_id updated to User B
  And assigned_by = QA Manager
  And assigned_at = now
  And notification sent to User B
  And audit log records reassignment
```

### AC-10: CAPA Status Workflow

```gherkin
Scenario: Change status to in_progress
  Given CAPA with status = 'open'
  When user clicks [Start CAPA]
  Then status changes to 'in_progress'
  And audit log records status change
  And badge updates to "In Progress" (blue)

Scenario: Close CAPA
  Given CAPA with status = 'in_progress'
  And all action items completed (story 06.32)
  And effectiveness checks passed (story 06.33)
  When user clicks [Close CAPA]
  Then modal appears:
    | Field | Required |
    | Actual Close Date | Yes (default today) |
    | Closure Notes | Yes |
  And user fills and confirms
  Then status = 'closed'
  And closed_by = current user
  And closed_at = now
  And actual_close_date saved
  And success toast "CAPA closed successfully"

Scenario: Cannot close CAPA with incomplete actions
  Given CAPA with status = 'in_progress'
  And 2 of 5 action items incomplete
  When user clicks [Close CAPA]
  Then warning: "Cannot close CAPA with incomplete actions (3 remaining)"
  And [Close] button disabled
```

### AC-11: Delete CAPA

```gherkin
Scenario: Delete open CAPA
  Given CAPA with status = 'open'
  And no action items created yet
  When user clicks [Delete]
  Then confirmation dialog: "Delete CAPA CAPA-2025-00001? This cannot be undone."
  And user confirms
  Then CAPA deleted
  And redirect to CAPA list

Scenario: Cannot delete in-progress or closed CAPA
  Given CAPA with status = 'in_progress' or 'closed'
  When viewing CAPA detail
  Then [Delete] button hidden
```

### AC-12: Overdue CAPA Indicator

```gherkin
Scenario: Display overdue indicator
  Given CAPA with target_close_date = yesterday
  And status != 'closed'
  When viewing CAPA in list or detail
  Then "OVERDUE" badge displayed (red)
  And days overdue calculated: "(2 days overdue)"

Scenario: Overdue CAPAs highlighted in list
  Given multiple CAPAs, some overdue
  When filtering by status = 'open' or 'in_progress'
  Then overdue CAPAs displayed at top
  And row highlighted with red background
```

### AC-13: Permission Enforcement

```gherkin
Scenario: QA Inspector can view but not create
  Given user with QA_INSPECTOR role
  When viewing CAPA list
  Then [+ New CAPA] button hidden
  And can click to view CAPA detail
  And [Edit], [Delete], [Close] buttons hidden

Scenario: QA Manager can full CRUD
  Given user with QA_MANAGER role
  Then can create, edit, assign, close, delete CAPAs
  And can reassign owners
```

### AC-14: Audit Trail

```gherkin
Scenario: All CAPA actions logged
  Given any CAPA state change
  When action completes
  Then quality_audit_log entry created with:
    | Field | Value |
    | entity_type | capa |
    | entity_id | capa.id |
    | action | create/update/close/delete/assign |
    | user_id | current user |
    | timestamp | now |
    | old_value | previous state |
    | new_value | new state |
```

### AC-15: RLS Policy Enforcement

```gherkin
Scenario: Org isolation on CAPA list
  Given User A from Org A and User B from Org B
  And CAPAs exist in both orgs
  When User A requests GET /api/quality/capa
  Then only Org A CAPAs returned

Scenario: Cannot view CAPA from different org
  Given CAPA belongs to Org B
  When User A (Org A) requests GET /api/quality/capa/:id
  Then 404 Not Found returned
```

---

## Implementation Notes

### API Endpoints

```typescript
// =============================================================================
// CAPA Endpoints
// =============================================================================

// GET /api/quality/capa
interface CapaListParams {
  status?: 'open' | 'in_progress' | 'closed' | 'cancelled';
  priority?: 'low' | 'medium' | 'high' | 'critical';
  capa_type?: 'corrective' | 'preventive';
  owner_id?: string;
  source_type?: 'ncr' | 'audit' | 'complaint' | 'management_review' | 'manual';
  overdue?: boolean;  // true = target_close_date < today AND status != 'closed'
  search?: string;
  sort_by?: 'capa_number' | 'created_date' | 'target_close_date' | 'priority';
  sort_order?: 'asc' | 'desc';
  page?: number;
  limit?: number;
}

interface CapaListResponse {
  capas: CapaRecord[];
  pagination: {
    total: number;
    page: number;
    limit: number;
    pages: number;
  };
  summary: {
    total_open: number;
    total_in_progress: number;
    total_overdue: number;
  };
}

interface CapaRecord {
  id: string;
  org_id: string;
  capa_number: string;
  source_type: string;
  source_id?: string;
  source_number?: string;  // NCR number or audit number for display
  title: string;
  description: string;
  capa_type: 'corrective' | 'preventive';
  priority: 'low' | 'medium' | 'high' | 'critical';
  status: 'open' | 'in_progress' | 'closed' | 'cancelled';
  owner_id?: string;
  owner_name?: string;
  assigned_by?: string;
  assigned_at?: string;
  created_date: string;
  target_close_date: string;
  actual_close_date?: string;
  root_cause?: string;
  root_cause_method?: string;
  closed_by?: string;
  closed_at?: string;
  closure_notes?: string;
  created_at: string;
  created_by: string;
  updated_at: string;
  days_overdue?: number;  // Calculated if overdue
}

// POST /api/quality/capa
interface CreateCapaRequest {
  source_type: 'ncr' | 'audit' | 'complaint' | 'management_review' | 'manual';
  source_id?: string;
  title: string;
  description: string;
  capa_type: 'corrective' | 'preventive';
  priority: 'low' | 'medium' | 'high' | 'critical';
  owner_id?: string;
  root_cause?: string;
  root_cause_method?: string;
  target_close_date?: string;  // Optional override
}

interface CreateCapaResponse {
  capa: CapaRecord;
}

// GET /api/quality/capa/:id
interface CapaDetailResponse {
  capa: CapaRecord;
  action_items: CapaAction[];  // From story 06.32
  effectiveness_checks: CapaEffectivenessCheck[];  // From story 06.33
  source_details?: {  // If source_id present
    type: string;
    number: string;
    title: string;
    link: string;
  };
}

// PUT /api/quality/capa/:id
interface UpdateCapaRequest {
  title?: string;
  description?: string;
  priority?: 'low' | 'medium' | 'high' | 'critical';
  owner_id?: string;
  root_cause?: string;
  root_cause_method?: string;
  target_close_date?: string;
  status?: 'open' | 'in_progress' | 'cancelled';
}

// POST /api/quality/capa/:id/close
interface CloseCapaRequest {
  actual_close_date: string;
  closure_notes: string;
}

interface CloseCapaResponse {
  capa: CapaRecord;
}

// POST /api/quality/ncrs/:id/create-capa
interface CreateCapaFromNcrRequest {
  title?: string;  // Override default
  capa_type?: 'corrective' | 'preventive';  // Default corrective
  priority?: string;  // Override NCR severity mapping
  owner_id?: string;
}
```

### Validation Schemas (Zod)

```typescript
import { z } from 'zod';

export const capaTypeEnum = z.enum(['corrective', 'preventive']);
export const capaPriorityEnum = z.enum(['low', 'medium', 'high', 'critical']);
export const capaStatusEnum = z.enum(['open', 'in_progress', 'closed', 'cancelled']);
export const capaSourceTypeEnum = z.enum(['ncr', 'audit', 'complaint', 'management_review', 'manual']);

export const createCapaSchema = z.object({
  source_type: capaSourceTypeEnum,
  source_id: z.string().uuid().optional(),
  title: z.string().min(5, 'Title must be at least 5 characters').max(200),
  description: z.string().min(20, 'Description must be at least 20 characters').max(5000),
  capa_type: capaTypeEnum,
  priority: capaPriorityEnum,
  owner_id: z.string().uuid('Invalid owner ID').optional(),
  root_cause: z.string().max(2000).optional(),
  root_cause_method: z.string().max(100).optional(),
  target_close_date: z.string().regex(/^\d{4}-\d{2}-\d{2}$/).optional(),
});

export const updateCapaSchema = z.object({
  title: z.string().min(5).max(200).optional(),
  description: z.string().min(20).max(5000).optional(),
  priority: capaPriorityEnum.optional(),
  owner_id: z.string().uuid().optional(),
  root_cause: z.string().max(2000).optional(),
  root_cause_method: z.string().max(100).optional(),
  target_close_date: z.string().regex(/^\d{4}-\d{2}-\d{2}$/).optional(),
  status: z.enum(['open', 'in_progress', 'cancelled']).optional(),
});

export const closeCapaSchema = z.object({
  actual_close_date: z.string().regex(/^\d{4}-\d{2}-\d{2}$/),
  closure_notes: z.string().min(20, 'Closure notes must be at least 20 characters').max(2000),
});

export const capaListQuerySchema = z.object({
  status: capaStatusEnum.optional(),
  priority: capaPriorityEnum.optional(),
  capa_type: capaTypeEnum.optional(),
  owner_id: z.string().uuid().optional(),
  source_type: capaSourceTypeEnum.optional(),
  overdue: z.coerce.boolean().optional(),
  search: z.string().min(1).optional(),
  sort_by: z.enum(['capa_number', 'created_date', 'target_close_date', 'priority']).default('created_date'),
  sort_order: z.enum(['asc', 'desc']).default('desc'),
  page: z.coerce.number().int().positive().default(1),
  limit: z.coerce.number().int().min(1).max(100).default(20),
});
```

### Service Layer

```typescript
// lib/services/capa-service.ts

export class CapaService {
  /**
   * List CAPAs with filtering and pagination
   */
  static async list(params: CapaListParams): Promise<PaginatedResult<CapaRecord>>;

  /**
   * Get CAPA by ID with action items and effectiveness checks
   */
  static async getById(id: string): Promise<CapaDetailResponse | null>;

  /**
   * Get CAPA by number
   */
  static async getByNumber(capaNumber: string): Promise<CapaRecord | null>;

  /**
   * Create new CAPA
   */
  static async create(input: CreateCapaInput): Promise<CapaRecord>;

  /**
   * Create CAPA from NCR
   */
  static async createFromNcr(ncrId: string, input: CreateCapaFromNcrInput): Promise<CapaRecord>;

  /**
   * Update CAPA (open/in_progress only)
   */
  static async update(id: string, input: UpdateCapaInput): Promise<CapaRecord>;

  /**
   * Close CAPA
   */
  static async close(id: string, input: CloseCapaInput, userId: string): Promise<CapaRecord>;

  /**
   * Delete CAPA (open only)
   */
  static async delete(id: string): Promise<void>;

  /**
   * Assign owner
   */
  static async assignOwner(id: string, ownerId: string, assignedBy: string): Promise<CapaRecord>;

  /**
   * Change status (open -> in_progress)
   */
  static async changeStatus(id: string, status: string): Promise<CapaRecord>;

  /**
   * Generate CAPA number
   */
  static async generateCapaNumber(orgId: string): Promise<string>;

  /**
   * Calculate target close date based on priority
   */
  static calculateTargetDate(priority: string, createdDate: Date): Date;

  /**
   * Check if CAPA can be closed (all actions complete, effectiveness passed)
   */
  static async canClose(capaId: string): Promise<{
    canClose: boolean;
    missingActions: string[];
    pendingChecks: string[];
  }>;

  /**
   * Get overdue CAPAs for org
   */
  static async getOverdue(orgId: string): Promise<CapaRecord[]>;
}
```

### Frontend Components

```
apps/frontend/app/(authenticated)/quality/
  capa/
    page.tsx                       -- CAPA list page
    [id]/
      page.tsx                     -- CAPA detail page
    new/
      page.tsx                     -- Create CAPA page

components/quality/capa/
  CapaDataTable.tsx                -- DataTable with filters
  CapaFilters.tsx                  -- Filter panel (status, priority, owner, source)
  CapaStatusBadge.tsx              -- Status badge (open/in_progress/closed)
  CapaPriorityBadge.tsx            -- Priority badge (color-coded)
  CapaTypeBadge.tsx                -- Type badge (Corrective/Preventive)
  CapaDetail.tsx                   -- Detail view container
  CapaHeader.tsx                   -- Header with CAPA #, badges, actions
  CapaSourceInfo.tsx               -- Source type, link to NCR/Audit
  CapaOwnerInfo.tsx                -- Owner, assigned by, assigned date
  CapaDatesInfo.tsx                -- Created, Target, Actual close dates
  CapaActions.tsx                  -- Action buttons based on status
  CreateCapaForm.tsx               -- Create CAPA form
  CreateCapaFromNcrModal.tsx       -- Modal for creating from NCR
  EditCapaForm.tsx                 -- Edit CAPA form
  CloseCapaModal.tsx               -- Close CAPA with notes
  AssignOwnerModal.tsx             -- Owner assignment modal
  OverdueBadge.tsx                 -- Overdue indicator with days
  CapaSummaryCard.tsx              -- Summary card for dashboard
```

---

## Key Business Rules

1. **CAPA Number Uniqueness**: CAPA numbers unique per org per year (CAPA-YYYY-NNNNN)
2. **Target Date Auto-Calculation**: Based on priority (Critical=7d, High=30d, Medium=60d, Low=90d)
3. **Manual Target Date Override**: Users can override auto-calculated target date
4. **Source Polymorphism**: CAPA can be linked to NCR, Audit, Complaint, Management Review, or Manual
5. **Owner Assignment Required**: CAPA should have owner before moving to in_progress
6. **Cannot Edit Closed CAPA**: Closed CAPAs are immutable (read-only)
7. **Delete Only Open**: Only open CAPAs without action items can be deleted
8. **Closure Requirements**: CAPA can only close when all action items complete and effectiveness checks pass (enforced in stories 06.32, 06.33)
9. **Overdue Calculation**: CAPA overdue if target_close_date < today AND status != 'closed'
10. **Audit Trail Required**: All CAPA state changes, assignments, closures logged

---

## Deliverables

### Database
- [ ] Migration: `capa_records` table with all columns
- [ ] Migration: `capa_number_sequences` table
- [ ] Function: `generate_capa_number(org_id)`
- [ ] Function: `calculate_capa_target_date(priority, created_date)`
- [ ] RLS policies for capa_records
- [ ] All performance indexes

### API Routes
- [ ] `GET /api/quality/capa` - List with filters
- [ ] `GET /api/quality/capa/:id` - Get detail
- [ ] `POST /api/quality/capa` - Create CAPA
- [ ] `PUT /api/quality/capa/:id` - Update CAPA
- [ ] `DELETE /api/quality/capa/:id` - Delete open CAPA
- [ ] `POST /api/quality/capa/:id/close` - Close CAPA
- [ ] `POST /api/quality/ncrs/:id/create-capa` - Create from NCR

### Service Layer
- [ ] `CapaService.list()` - List with pagination
- [ ] `CapaService.getById()` - Get with details
- [ ] `CapaService.create()` - Create CAPA
- [ ] `CapaService.createFromNcr()` - Create from NCR
- [ ] `CapaService.update()` - Update CAPA
- [ ] `CapaService.close()` - Close with validation
- [ ] `CapaService.delete()` - Delete open CAPA
- [ ] `CapaService.assignOwner()` - Assign owner
- [ ] `CapaService.changeStatus()` - Change status
- [ ] `CapaService.generateCapaNumber()` - Number generation
- [ ] `CapaService.calculateTargetDate()` - Target date calc
- [ ] `CapaService.canClose()` - Closure validation

### Validation
- [ ] `createCapaSchema`
- [ ] `updateCapaSchema`
- [ ] `closeCapaSchema`
- [ ] `capaListQuerySchema`

### Frontend
- [ ] CAPA list page with filters
- [ ] CAPA detail page
- [ ] Create CAPA form
- [ ] Create CAPA from NCR modal
- [ ] Edit CAPA form
- [ ] Close CAPA modal
- [ ] Assign owner modal
- [ ] Status, priority, type badges
- [ ] Overdue indicator
- [ ] Filter panel
- [ ] Search functionality

### Tests
- [ ] Unit tests: CapaService methods (>80% coverage)
- [ ] Integration tests: All API endpoints
- [ ] Target date calculation tests
- [ ] RLS tests: Multi-tenancy isolation
- [ ] E2E: Full CAPA workflow (create -> assign -> in_progress -> close)

---

## Definition of Done

### Database
- [ ] `capa_records` table created with all columns
- [ ] `capa_number_sequences` table created
- [ ] All indexes created for performance
- [ ] RLS policies enforce org isolation
- [ ] CAPA number generation works correctly
- [ ] Target date calculation function works

### API
- [ ] All endpoints return correct HTTP status codes
- [ ] Validation errors return 400 with detailed messages
- [ ] Cross-tenant access returns 404
- [ ] Response times:
  - CAPA list: < 500ms
  - CAPA detail: < 500ms
  - Create/Update: < 300ms

### Service
- [ ] Complete workflow: create -> assign -> in_progress -> close
- [ ] CAPA number auto-generation works
- [ ] Target date auto-calculation works
- [ ] Create from NCR integration works
- [ ] Audit trail created for all actions

### Frontend
- [ ] CAPA list displays correctly with filters
- [ ] CAPA detail page shows all information
- [ ] Create CAPA form works
- [ ] Create from NCR modal works
- [ ] Edit form works (open/in_progress only)
- [ ] Close modal with validation works
- [ ] Badges display correctly (status, priority, type, overdue)
- [ ] Filters and search work
- [ ] Pagination works

### Testing
- [ ] Unit tests: >80% coverage on service
- [ ] Integration tests: All endpoints covered
- [ ] RLS tests: Multi-tenancy verified
- [ ] E2E tests: Full workflow passing

### Integration
- [ ] Works with story 06.13 (NCR Creation)
- [ ] Integration points for 06.32 (Action Items) prepared
- [ ] Integration points for 06.33 (Effectiveness) prepared

---

## Risk Assessment

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| CAPA closure without completion | HIGH | MEDIUM | Validation in canClose(), block UI |
| Target date calculation errors | MEDIUM | LOW | Comprehensive unit tests |
| NCR integration complexity | MEDIUM | MEDIUM | Clear API contract, fallback handling |
| Permission model complexity | MEDIUM | LOW | Clear role definitions, tests |
| Overdue calculation performance | LOW | LOW | Indexed query, cached summary |

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2026-01-15 | Initial story creation for CAPA Creation (Phase 4) | OPUS |

---

**Document Status**: Ready for Implementation
**Created**: 2026-01-15
**Lines**: ~800
**Complexity**: M (Medium - 3-4 days)
**Phase**: 4 (Advanced Quality)
