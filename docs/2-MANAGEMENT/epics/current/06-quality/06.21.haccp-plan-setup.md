# 06.21 - HACCP Plan Setup

**Priority**: P0 (Food Safety Compliance)
**Story Points**: L (Large)
**Type**: fullstack
**Phase**: 3 (HACCP & CoA)
**Model**: OPUS

**State:** ready
**Estimate:** L (4-5 days)
**Primary PRD:** `docs/1-BASELINE/product/modules/quality.md` (FR-QA-013, Section 6)
**Architecture:** `docs/1-BASELINE/architecture/modules/quality.md` (haccp_plans, haccp_hazards tables)

---

## Goal

Implement HACCP (Hazard Analysis Critical Control Points) plan management with full lifecycle support. HACCP plans are product-specific documents that identify biological, chemical, and physical hazards, assess risk using severity x likelihood matrices, and identify Critical Control Points (CCPs) through decision tree analysis. This story establishes the foundation for food safety compliance that enables CCP monitoring in subsequent stories.

---

## Food Safety Compliance

This story is **critical for food safety compliance**:

- [x] **HACCP Compliance** - HACCP Principle 1 (Hazard Analysis) and documentation requirements
- [x] **FDA FSMA** - Preventive Controls for Human Food requires documented hazard analysis
- [x] **Codex Alimentarius** - International HACCP guidelines compliance
- [x] **FDA 21 CFR Part 11** - Audit trail for all HACCP plan changes required
- [x] **GFSI Standards** - BRC, SQF, FSSC 22000 all require documented HACCP plans

**Regulatory Context:**
- FDA FSMA requires documented hazard analysis for each food product
- HACCP plans must be signed off by qualified individuals
- All changes to HACCP plans must be documented with reason
- Plans must be reviewed at least annually (configurable)
- Plans must have effective dates and version control
- Hazard analysis must cover biological, chemical, and physical hazards
- Risk assessment (severity x likelihood) determines CCP identification

---

## MVP Scope

This story implements Phase 3 (HACCP & CoA) functionality. HACCP Plan Setup is the foundation for all CCP-related features.

**MVP Includes**:
- `haccp_plans` table with version control and approval workflow
- `haccp_hazards` table with risk matrix (severity x likelihood)
- `haccp_plan_versions` table for version history
- HACCP plan CRUD operations (per product)
- Hazard analysis with type classification (Biological/Chemical/Physical)
- Severity x Likelihood risk matrix (5x5)
- CCP identification support (decision tree logic)
- Dual approval workflow (QA Manager + Director)
- Effective date and next review date management
- HACCP plan creation wizard (5 steps)
- Hazard analysis matrix UI (visual grid)
- Plan status workflow: draft -> pending_approval -> approved -> active

**Deferred to Phase 3+ (Story 06.21b)**:
- HACCP plan templates (pre-configured industry templates)
- Bulk hazard import from library
- HACCP plan comparison (version diff)
- Regulatory export formats (FDA, GFSI)

---

## User Story

As a **QA Manager**, I want to **create and maintain HACCP plans for each product, documenting hazard analysis and risk assessment** so that **we meet food safety regulatory requirements and systematically identify CCPs**.

As a **Quality Director**, I want to **review and approve HACCP plans with dual sign-off** so that **plans meet our quality standards and regulatory requirements before becoming effective**.

As a **Food Safety Team Member**, I want to **analyze hazards using severity and likelihood scoring** so that **we can objectively determine which process steps require CCP designation**.

---

## Scope

**In scope (this story)**
- `haccp_plans` table with product linkage and versioning
- `haccp_hazards` table with risk assessment fields
- `haccp_plan_versions` table for audit trail
- GET /api/quality/haccp/plans (list with filters)
- GET /api/quality/haccp/plans/:id (plan detail with hazards)
- POST /api/quality/haccp/plans (create new plan)
- PUT /api/quality/haccp/plans/:id (update draft plan)
- POST /api/quality/haccp/plans/:id/submit (submit for approval)
- POST /api/quality/haccp/plans/:id/approve (QA Manager approval)
- POST /api/quality/haccp/plans/:id/director-approve (Director final approval)
- POST /api/quality/haccp/plans/:id/reject (reject with reason)
- POST /api/quality/haccp/plans/:id/new-version (create new version from approved)
- POST /api/quality/haccp/plans/:id/hazards (add hazard)
- PUT /api/quality/haccp/plans/:id/hazards/:hazardId (update hazard)
- DELETE /api/quality/haccp/plans/:id/hazards/:hazardId (remove hazard)
- POST /api/quality/haccp/plans/:id/hazards/:hazardId/ccp-decision (mark as CCP)
- HACCP plans list page with filters
- HACCP plan detail page with hazard matrix
- HACCP plan creation wizard (5 steps)
- Hazard analysis matrix (drag-drop to severity x likelihood grid)
- CCP decision tree flowchart component
- Approval workflow UI with dual sign-off
- Version history timeline

**Out of scope (this story)**
- CCP definition details (story 06.22)
- CCP monitoring (stories 06.23, 06.24)
- CCP deviations (stories 06.25, 06.26)
- HACCP verification records (story 06.30)
- HACCP templates library (future)
- Regulatory export formats (future)

---

## Future Phases (Not in MVP)

### Phase 3+ (Story 06.21b - HACCP Advanced)
- **HACCP plan templates** - Pre-configured templates for common food types
- **Hazard library** - Reusable hazard definitions across products
- **Bulk hazard import** - Import hazards from library or CSV
- **Version comparison** - Diff view between plan versions
- **Plan cloning** - Clone from another product's plan

### Phase 4
- **Regulatory exports** - FDA, GFSI-specific export formats
- **External audit mode** - Read-only view for auditors
- **HACCP team management** - Define HACCP team members per plan
- **Training records integration** - Link to team training records
- **Prerequisite programs** - Link to PRPs and SOPs

---

## Dependencies

### Cross-Epic Dependencies

| Dependency | Story/Epic | Type | What It Provides | Status |
|------------|------------|------|------------------|--------|
| 01.1 | Org Context + RLS | HARD | organizations, users, roles tables | Ready |
| 02.1 | Products CRUD | HARD | products table for product reference | Ready |
| 02.7 | Routings CRUD | SOFT | routings table for process step reference | Ready |
| 02.8 | Routing Operations | SOFT | routing_operations for CCP step mapping | Ready |

### Within Epic Dependencies

| Dependency | Story | Type | What It Provides |
|------------|-------|------|------------------|
| 06.0 | Quality Settings | SOFT | Default review frequency, risk thresholds |

### Provides To (Downstream)

| Story | What This Provides |
|-------|-------------------|
| 06.22 | CCP Definition - haccp_plan_id reference, hazard linkage |
| 06.23 | CCP Monitoring Desktop - plan context |
| 06.24 | CCP Monitoring Scanner - plan context |
| 06.25 | CCP Deviation Handling - hazard type reference |
| 06.30 | HACCP Verification Records - plan_id reference |

---

## Database Migration

### Migration: Create haccp_plans table

```sql
-- Migration: YYYYMMDDHHMMSS_create_haccp_tables.sql

-- =============================================================================
-- HACCP Plans Table
-- =============================================================================

CREATE TABLE haccp_plans (
    -- Identity
    id                      UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id                  UUID NOT NULL REFERENCES organizations(id),
    plan_number             TEXT NOT NULL,

    -- Product Reference
    product_id              UUID NOT NULL REFERENCES products(id),

    -- Version Control
    version                 INTEGER NOT NULL DEFAULT 1,
    parent_version_id       UUID REFERENCES haccp_plans(id),

    -- Plan Details
    name                    TEXT NOT NULL,
    description             TEXT,
    scope                   TEXT,                -- What processes/products covered

    -- Process Reference (optional - links to routing)
    routing_id              UUID REFERENCES routings(id),

    -- Status and Workflow
    status                  TEXT NOT NULL DEFAULT 'draft'
                            CHECK (status IN ('draft', 'pending_approval', 'approved', 'active', 'superseded', 'archived')),

    -- Review Schedule
    review_frequency_months INTEGER NOT NULL DEFAULT 12,
    next_review_date        DATE,
    last_reviewed_at        TIMESTAMPTZ,
    last_reviewed_by        UUID REFERENCES users(id),

    -- Effective Dates
    effective_date          DATE,
    expiry_date             DATE,

    -- HACCP Team
    team_leader_id          UUID REFERENCES users(id),
    team_members            JSONB DEFAULT '[]',   -- Array of user IDs

    -- Approval Workflow (Dual Approval)
    -- First approval: QA Manager
    qa_approved_by          UUID REFERENCES users(id),
    qa_approved_at          TIMESTAMPTZ,
    qa_approval_notes       TEXT,

    -- Second approval: Director
    director_approved_by    UUID REFERENCES users(id),
    director_approved_at    TIMESTAMPTZ,
    director_approval_notes TEXT,

    -- Rejection
    rejected_by             UUID REFERENCES users(id),
    rejected_at             TIMESTAMPTZ,
    rejection_reason        TEXT,

    -- Summary Statistics (denormalized for performance)
    total_hazards           INTEGER DEFAULT 0,
    biological_hazards      INTEGER DEFAULT 0,
    chemical_hazards        INTEGER DEFAULT 0,
    physical_hazards        INTEGER DEFAULT 0,
    identified_ccps         INTEGER DEFAULT 0,

    -- Audit
    created_at              TIMESTAMPTZ NOT NULL DEFAULT now(),
    created_by              UUID REFERENCES users(id),
    updated_at              TIMESTAMPTZ NOT NULL DEFAULT now(),
    updated_by              UUID REFERENCES users(id),

    -- Constraints
    CONSTRAINT uq_haccp_plan_number UNIQUE (org_id, plan_number),
    CONSTRAINT uq_haccp_product_version UNIQUE (org_id, product_id, version)
);

-- =============================================================================
-- HACCP Hazards Table
-- =============================================================================

CREATE TABLE haccp_hazards (
    -- Identity
    id                      UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id                  UUID NOT NULL REFERENCES organizations(id),
    haccp_plan_id           UUID NOT NULL REFERENCES haccp_plans(id) ON DELETE CASCADE,

    -- Sequence
    sequence                INTEGER NOT NULL,

    -- Process Step Reference (optional - links to routing operation)
    process_step            TEXT NOT NULL,       -- Step name/description
    operation_id            UUID REFERENCES routing_operations(id),

    -- Hazard Classification
    hazard_type             TEXT NOT NULL
                            CHECK (hazard_type IN ('biological', 'chemical', 'physical')),
    hazard_name             TEXT NOT NULL,
    hazard_description      TEXT,

    -- Source and Cause
    hazard_source           TEXT,                -- Where hazard originates
    potential_cause         TEXT,                -- Why it might occur

    -- Risk Assessment (1-5 scale)
    severity                INTEGER NOT NULL DEFAULT 1
                            CHECK (severity BETWEEN 1 AND 5),
    likelihood              INTEGER NOT NULL DEFAULT 1
                            CHECK (likelihood BETWEEN 1 AND 5),
    risk_score              INTEGER GENERATED ALWAYS AS (severity * likelihood) STORED,
    risk_level              TEXT GENERATED ALWAYS AS (
                            CASE
                                WHEN severity * likelihood >= 15 THEN 'critical'
                                WHEN severity * likelihood >= 10 THEN 'high'
                                WHEN severity * likelihood >= 5 THEN 'medium'
                                ELSE 'low'
                            END
                            ) STORED,

    -- CCP Decision Tree (Q1-Q4)
    ccp_q1_preventive       BOOLEAN,             -- Q1: Preventive measures exist?
    ccp_q2_designed         BOOLEAN,             -- Q2: Step designed to eliminate/reduce?
    ccp_q3_contamination    BOOLEAN,             -- Q3: Could contamination exceed acceptable level?
    ccp_q4_subsequent       BOOLEAN,             -- Q4: Will subsequent step eliminate/reduce?

    -- CCP Determination
    is_ccp                  BOOLEAN DEFAULT FALSE,
    ccp_number              TEXT,                -- CCP-1, CCP-2, etc. (NULL if not CCP)
    ccp_justification       TEXT,                -- Why this is/isn't a CCP

    -- Control Measures (if not CCP)
    control_measures        TEXT,                -- Prerequisite programs, SOPs, etc.

    -- Audit
    created_at              TIMESTAMPTZ NOT NULL DEFAULT now(),
    created_by              UUID REFERENCES users(id),
    updated_at              TIMESTAMPTZ NOT NULL DEFAULT now(),
    updated_by              UUID REFERENCES users(id)
);

-- =============================================================================
-- HACCP Plan Versions Table (Audit Trail)
-- =============================================================================

CREATE TABLE haccp_plan_versions (
    -- Identity
    id                      UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id                  UUID NOT NULL REFERENCES organizations(id),
    haccp_plan_id           UUID NOT NULL REFERENCES haccp_plans(id) ON DELETE CASCADE,

    -- Version Info
    version                 INTEGER NOT NULL,
    version_date            TIMESTAMPTZ NOT NULL DEFAULT now(),

    -- Change Details
    change_type             TEXT NOT NULL
                            CHECK (change_type IN ('created', 'updated', 'submitted', 'approved', 'rejected', 'activated', 'superseded', 'archived')),
    change_reason           TEXT,
    change_summary          TEXT,

    -- Snapshot of Plan State
    plan_snapshot           JSONB NOT NULL,      -- Full plan state at this version
    hazards_snapshot        JSONB NOT NULL,      -- Full hazards state at this version

    -- Actor
    changed_by              UUID REFERENCES users(id),
    changed_at              TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- =============================================================================
-- Indexes for Performance
-- =============================================================================

-- haccp_plans indexes
CREATE INDEX idx_haccp_plans_org_status ON haccp_plans(org_id, status);
CREATE INDEX idx_haccp_plans_product ON haccp_plans(product_id);
CREATE INDEX idx_haccp_plans_org_product ON haccp_plans(org_id, product_id);
CREATE INDEX idx_haccp_plans_status ON haccp_plans(org_id, status) WHERE status IN ('active', 'approved');
CREATE INDEX idx_haccp_plans_review_due ON haccp_plans(org_id, next_review_date) WHERE status = 'active';
CREATE INDEX idx_haccp_plans_routing ON haccp_plans(routing_id) WHERE routing_id IS NOT NULL;

-- haccp_hazards indexes
CREATE INDEX idx_haccp_hazards_plan ON haccp_hazards(haccp_plan_id);
CREATE INDEX idx_haccp_hazards_type ON haccp_hazards(haccp_plan_id, hazard_type);
CREATE INDEX idx_haccp_hazards_ccp ON haccp_hazards(haccp_plan_id, is_ccp) WHERE is_ccp = TRUE;
CREATE INDEX idx_haccp_hazards_risk ON haccp_hazards(haccp_plan_id, risk_level);
CREATE INDEX idx_haccp_hazards_sequence ON haccp_hazards(haccp_plan_id, sequence);

-- haccp_plan_versions indexes
CREATE INDEX idx_haccp_versions_plan ON haccp_plan_versions(haccp_plan_id);
CREATE INDEX idx_haccp_versions_date ON haccp_plan_versions(haccp_plan_id, version_date DESC);

-- =============================================================================
-- Plan Number Sequence
-- =============================================================================

CREATE TABLE haccp_plan_number_sequences (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    year INTEGER NOT NULL,
    current_value BIGINT NOT NULL DEFAULT 0,
    updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
    UNIQUE(org_id, year)
);

-- Function to generate plan number (HACCP-YYYY-NNNNN)
CREATE OR REPLACE FUNCTION generate_haccp_plan_number(p_org_id UUID)
RETURNS TEXT AS $$
DECLARE
    v_year INTEGER;
    v_next_val BIGINT;
    v_plan_number TEXT;
BEGIN
    v_year := EXTRACT(YEAR FROM CURRENT_DATE);

    -- Upsert sequence and get next value
    INSERT INTO haccp_plan_number_sequences (org_id, year, current_value)
    VALUES (p_org_id, v_year, 1)
    ON CONFLICT (org_id, year)
    DO UPDATE SET
        current_value = haccp_plan_number_sequences.current_value + 1,
        updated_at = NOW()
    RETURNING current_value INTO v_next_val;

    -- Format plan number
    v_plan_number := 'HACCP-' || v_year::TEXT || '-' || LPAD(v_next_val::TEXT, 5, '0');

    RETURN v_plan_number;
END;
$$ LANGUAGE plpgsql;

-- =============================================================================
-- RLS Policies
-- =============================================================================

ALTER TABLE haccp_plans ENABLE ROW LEVEL SECURITY;
ALTER TABLE haccp_hazards ENABLE ROW LEVEL SECURITY;
ALTER TABLE haccp_plan_versions ENABLE ROW LEVEL SECURITY;
ALTER TABLE haccp_plan_number_sequences ENABLE ROW LEVEL SECURITY;

-- haccp_plans RLS
CREATE POLICY "haccp_plans_select" ON haccp_plans
    FOR SELECT USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

CREATE POLICY "haccp_plans_insert" ON haccp_plans
    FOR INSERT WITH CHECK (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

CREATE POLICY "haccp_plans_update" ON haccp_plans
    FOR UPDATE USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

-- Only allow delete of draft plans
CREATE POLICY "haccp_plans_delete" ON haccp_plans
    FOR DELETE USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
        AND status = 'draft'
    );

-- haccp_hazards RLS
CREATE POLICY "haccp_hazards_org" ON haccp_hazards
    FOR ALL TO authenticated
    USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

-- haccp_plan_versions RLS
CREATE POLICY "haccp_versions_org" ON haccp_plan_versions
    FOR ALL TO authenticated
    USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

-- haccp_plan_number_sequences RLS
CREATE POLICY "haccp_seq_org" ON haccp_plan_number_sequences
    FOR ALL TO authenticated
    USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

-- =============================================================================
-- Triggers
-- =============================================================================

-- Update updated_at timestamp
CREATE TRIGGER update_haccp_plans_updated_at
    BEFORE UPDATE ON haccp_plans
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_haccp_hazards_updated_at
    BEFORE UPDATE ON haccp_hazards
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- =============================================================================
-- Function: Update Plan Statistics
-- =============================================================================

CREATE OR REPLACE FUNCTION update_haccp_plan_statistics()
RETURNS TRIGGER AS $$
BEGIN
    UPDATE haccp_plans
    SET
        total_hazards = (SELECT COUNT(*) FROM haccp_hazards WHERE haccp_plan_id = COALESCE(NEW.haccp_plan_id, OLD.haccp_plan_id)),
        biological_hazards = (SELECT COUNT(*) FROM haccp_hazards WHERE haccp_plan_id = COALESCE(NEW.haccp_plan_id, OLD.haccp_plan_id) AND hazard_type = 'biological'),
        chemical_hazards = (SELECT COUNT(*) FROM haccp_hazards WHERE haccp_plan_id = COALESCE(NEW.haccp_plan_id, OLD.haccp_plan_id) AND hazard_type = 'chemical'),
        physical_hazards = (SELECT COUNT(*) FROM haccp_hazards WHERE haccp_plan_id = COALESCE(NEW.haccp_plan_id, OLD.haccp_plan_id) AND hazard_type = 'physical'),
        identified_ccps = (SELECT COUNT(*) FROM haccp_hazards WHERE haccp_plan_id = COALESCE(NEW.haccp_plan_id, OLD.haccp_plan_id) AND is_ccp = TRUE),
        updated_at = NOW()
    WHERE id = COALESCE(NEW.haccp_plan_id, OLD.haccp_plan_id);

    RETURN COALESCE(NEW, OLD);
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_update_haccp_statistics
    AFTER INSERT OR UPDATE OR DELETE ON haccp_hazards
    FOR EACH ROW
    EXECUTE FUNCTION update_haccp_plan_statistics();

-- =============================================================================
-- Function: Create Version Snapshot
-- =============================================================================

CREATE OR REPLACE FUNCTION create_haccp_version_snapshot(
    p_plan_id UUID,
    p_change_type TEXT,
    p_change_reason TEXT,
    p_user_id UUID
)
RETURNS UUID AS $$
DECLARE
    v_plan RECORD;
    v_hazards JSONB;
    v_version_id UUID;
BEGIN
    -- Get current plan state
    SELECT * INTO v_plan FROM haccp_plans WHERE id = p_plan_id;

    -- Get current hazards state
    SELECT COALESCE(jsonb_agg(row_to_json(h)), '[]'::jsonb)
    INTO v_hazards
    FROM haccp_hazards h
    WHERE h.haccp_plan_id = p_plan_id;

    -- Create version record
    INSERT INTO haccp_plan_versions (
        org_id,
        haccp_plan_id,
        version,
        change_type,
        change_reason,
        change_summary,
        plan_snapshot,
        hazards_snapshot,
        changed_by
    ) VALUES (
        v_plan.org_id,
        p_plan_id,
        v_plan.version,
        p_change_type,
        p_change_reason,
        p_change_type || ' by user',
        row_to_json(v_plan)::jsonb,
        v_hazards,
        p_user_id
    )
    RETURNING id INTO v_version_id;

    RETURN v_version_id;
END;
$$ LANGUAGE plpgsql;
```

---

## Acceptance Criteria (Given/When/Then)

### AC-1: HACCP Plans Table Creation

```gherkin
Scenario: haccp_plans table exists with all required columns
  Given database migration runs
  When schema is inspected
  Then haccp_plans table has all columns from schema
  And UNIQUE constraint exists on (org_id, plan_number)
  And UNIQUE constraint exists on (org_id, product_id, version)
  And FK constraints exist for all references
  And RLS policies enforce org isolation
```

### AC-2: Plan Number Auto-Generation

```gherkin
Scenario: Generate plan number with year-based format
  Given organization exists
  When HACCP plan created
  Then plan_number format is 'HACCP-2025-00001'
  And next plan gets 'HACCP-2025-00002'
  And year resets sequence (first 2026 = 'HACCP-2026-00001')

Scenario: Plan number uniqueness
  Given plan 'HACCP-2025-00001' exists in org A
  When creating another with same number in org A
  Then system returns 409 Conflict error
```

### AC-3: HACCP Plan CRUD

```gherkin
Scenario: Create HACCP plan
  Given user navigates to Quality > HACCP > Plans
  And clicks [+ New HACCP Plan]
  When user selects product "Sourdough Bread"
  And enters name "Sourdough Bread HACCP Plan"
  And enters description "HACCP plan for sourdough bread production"
  And clicks [Create]
  Then plan created with status = 'draft'
  And plan_number auto-generated
  And user redirected to plan detail page
  And success toast "HACCP Plan HACCP-2025-00001 created"

Scenario: Update draft HACCP plan
  Given HACCP plan with status = 'draft'
  When user edits name, description, or scope
  And clicks [Save]
  Then plan updated
  And updated_at timestamp updated
  And version snapshot created

Scenario: Delete draft HACCP plan
  Given HACCP plan with status = 'draft'
  When user clicks [Delete]
  And confirms deletion
  Then plan and all hazards deleted
  And success toast "Plan deleted"

Scenario: Cannot delete approved plan
  Given HACCP plan with status = 'approved' or 'active'
  When user attempts to delete
  Then delete button disabled
  And tooltip shows "Cannot delete approved plans"
```

### AC-4: HACCP Plan List Display

```gherkin
Scenario: HACCP plans list loads
  Given user navigates to Quality > HACCP > Plans
  When page loads
  Then DataTable displays plans with columns:
    | Column | Description |
    | Plan # | Link to detail |
    | Product | Product name |
    | Version | Version number |
    | Status | Badge (draft/pending/approved/active) |
    | Hazards | Count (Bio/Chem/Phys breakdown) |
    | CCPs | Count of identified CCPs |
    | Effective Date | Date or "Not set" |
    | Next Review | Date with warning if overdue |
    | Actions | Edit, View, Delete |
  And list loads within 500ms
  And pagination available (20 per page)

Scenario: Filter by status
  Given plans exist with various statuses
  When user filters by status = 'active'
  Then only active plans display

Scenario: Filter by product
  Given plans for multiple products
  When user filters by product = 'Sourdough Bread'
  Then only plans for that product display

Scenario: Sort by next review date
  Given plans with various review dates
  When user sorts by next_review_date ascending
  Then plans due soonest appear first
  And overdue reviews highlighted in red
```

### AC-5: HACCP Plan Creation Wizard

```gherkin
Scenario: Wizard Step 1 - Product Selection
  Given user starts new HACCP plan wizard
  When Step 1 displays
  Then shows product dropdown with all active products
  And "Product already has active plan" warning if applicable
  And [Next] enabled only when product selected

Scenario: Wizard Step 2 - Plan Details
  Given user completed Step 1
  When Step 2 displays
  Then shows fields:
    | Field | Required |
    | Plan Name | Yes |
    | Description | No |
    | Scope | No |
    | Routing (Process) | No (dropdown) |
    | Team Leader | No |
    | Review Frequency | Yes (default 12 months) |

Scenario: Wizard Step 3 - Hazard Identification
  Given user completed Step 2
  When Step 3 displays
  Then shows process steps (from routing or manual entry)
  And for each step, user can add hazards:
    | Field | Required |
    | Hazard Type | Yes (Bio/Chem/Phys) |
    | Hazard Name | Yes |
    | Hazard Description | No |
    | Source | No |
    | Potential Cause | No |

Scenario: Wizard Step 4 - Risk Assessment
  Given user completed Step 3
  When Step 4 displays
  Then shows 5x5 risk matrix grid
  And hazards can be placed on grid (drag-drop or select)
  And grid shows:
    | Severity (1-5) | Columns |
    | Likelihood (1-5) | Rows |
  And risk level auto-calculated:
    | Score | Level |
    | 15-25 | Critical (red) |
    | 10-14 | High (orange) |
    | 5-9 | Medium (yellow) |
    | 1-4 | Low (green) |

Scenario: Wizard Step 5 - CCP Determination
  Given user completed Step 4
  When Step 5 displays
  Then shows CCP decision tree for each hazard
  And decision tree questions:
    | Q1 | Do preventive measures exist? |
    | Q2 | Is step designed to eliminate/reduce hazard? |
    | Q3 | Could contamination exceed acceptable level? |
    | Q4 | Will subsequent step eliminate/reduce? |
  And CCP automatically suggested based on answers
  And user can override with justification

Scenario: Wizard completion
  Given user completed Step 5
  When user clicks [Create Plan]
  Then plan created with status = 'draft'
  And all hazards created with risk scores
  And CCP designations saved
  And user redirected to plan detail page
```

### AC-6: Hazard Analysis

```gherkin
Scenario: Add hazard to plan
  Given HACCP plan in draft status
  When user clicks [+ Add Hazard]
  Then modal shows hazard form:
    | Field | Type | Required |
    | Process Step | Text/Select | Yes |
    | Hazard Type | Dropdown (Bio/Chem/Phys) | Yes |
    | Hazard Name | Text | Yes |
    | Description | Textarea | No |
    | Source | Text | No |
    | Potential Cause | Text | No |
    | Severity | Slider 1-5 | Yes |
    | Likelihood | Slider 1-5 | Yes |
  And risk score auto-calculates as user adjusts severity/likelihood
  And risk level badge updates in real-time

Scenario: Edit hazard
  Given hazard exists on draft plan
  When user clicks [Edit] on hazard
  Then modal pre-fills with current data
  And user can modify any field
  And [Save] updates hazard

Scenario: Delete hazard
  Given hazard exists on draft plan
  When user clicks [Delete] on hazard
  And confirms deletion
  Then hazard removed
  And plan statistics updated

Scenario: Hazard type classification
  Given user creates hazard
  When selecting hazard_type
  Then dropdown shows:
    | Type | Examples |
    | Biological | Bacteria, Viruses, Parasites, Molds |
    | Chemical | Allergens, Pesticides, Cleaning agents |
    | Physical | Metal, Glass, Plastic, Wood, Stones |
```

### AC-7: Risk Assessment Matrix

```gherkin
Scenario: Risk matrix display
  Given HACCP plan with hazards
  When viewing risk matrix tab
  Then 5x5 grid displays:
    | Severity | 1 (Negligible) | 2 (Minor) | 3 (Moderate) | 4 (Major) | 5 (Catastrophic) |
    | Likelihood 1 (Rare) | Green | Green | Yellow | Orange | Red |
    | Likelihood 2 (Unlikely) | Green | Yellow | Yellow | Orange | Red |
    | Likelihood 3 (Possible) | Yellow | Yellow | Orange | Red | Red |
    | Likelihood 4 (Likely) | Yellow | Orange | Orange | Red | Red |
    | Likelihood 5 (Almost Certain) | Orange | Orange | Red | Red | Red |
  And hazards appear as chips in their cell
  And clicking hazard shows detail popover

Scenario: Drag hazard on matrix
  Given hazard at Severity=3, Likelihood=2
  When user drags hazard to Severity=4, Likelihood=3
  Then hazard moves to new cell
  And severity and likelihood updated in database
  And risk_score recalculated (now 12, High)

Scenario: Risk level distribution
  Given plan with multiple hazards
  When viewing summary panel
  Then shows distribution:
    | Level | Count | Percentage |
    | Critical | 2 | 20% |
    | High | 3 | 30% |
    | Medium | 3 | 30% |
    | Low | 2 | 20% |
```

### AC-8: CCP Decision Tree

```gherkin
Scenario: CCP decision tree flowchart
  Given hazard exists on plan
  When user opens CCP decision tab
  Then flowchart displays:
    Q1: Do preventive control measures exist?
    ├── No → Modify step, process or product (Not a CCP)
    └── Yes → Q2

    Q2: Is this step specifically designed to eliminate/reduce hazard?
    ├── Yes → CCP
    └── No → Q3

    Q3: Could contamination occur or increase to unacceptable level?
    ├── No → Not a CCP
    └── Yes → Q4

    Q4: Will a subsequent step eliminate/reduce the hazard?
    ├── Yes → Not a CCP (control at later step)
    └── No → CCP

Scenario: Answer CCP questions
  Given hazard displayed in decision tree
  When user answers Q1 = Yes
  Then Q2 becomes active
  When user answers Q2 = No
  Then Q3 becomes active
  When user answers Q3 = Yes
  Then Q4 becomes active
  When user answers Q4 = No
  Then system marks hazard as CCP
  And CCP number auto-assigned (CCP-1, CCP-2, etc.)
  And success message "Hazard identified as CCP-1"

Scenario: Override CCP determination
  Given decision tree suggests CCP
  But user determines it's not CCP
  When user clicks [Override]
  Then justification field required
  And user enters "Controlled by prerequisite program PRP-003"
  And hazard marked as NOT CCP with justification saved
```

### AC-9: Approval Workflow - Submit for Approval

```gherkin
Scenario: Submit plan for approval
  Given HACCP plan with status = 'draft'
  And plan has at least 1 hazard analyzed
  When user clicks [Submit for Approval]
  Then confirmation dialog shows summary:
    | Item | Value |
    | Plan | HACCP-2025-00001 |
    | Product | Sourdough Bread |
    | Total Hazards | 12 |
    | Identified CCPs | 3 |
  And user confirms
  Then status changes to 'pending_approval'
  And QA Manager notified
  And version snapshot created

Scenario: Cannot submit incomplete plan
  Given HACCP plan with 0 hazards
  When user clicks [Submit for Approval]
  Then error "Add at least one hazard before submitting"
  And button disabled
```

### AC-10: Approval Workflow - QA Manager Approval

```gherkin
Scenario: QA Manager reviews plan
  Given user with QA_MANAGER role
  And plan with status = 'pending_approval'
  When QA Manager opens plan detail
  Then sees [Approve] and [Reject] buttons
  And [Approve] shows approval modal

Scenario: QA Manager approves
  Given QA Manager clicks [Approve]
  When approval modal opens
  Then shows approval notes field (optional)
  And user enters notes "Reviewed all hazards, risk assessment complete"
  And clicks [Approve]
  Then qa_approved_by = current user
  And qa_approved_at = now
  And status remains 'pending_approval' (awaiting Director)
  And Director notified
  And success toast "Approved. Awaiting Director approval."

Scenario: QA Manager rejects
  Given QA Manager clicks [Reject]
  When rejection modal opens
  Then rejection_reason required
  And user enters "Missing control measures for CCP-2"
  And clicks [Reject]
  Then status changes to 'draft'
  And rejected_by, rejected_at, rejection_reason saved
  And plan creator notified
  And warning toast "Plan rejected. Returned to draft."
```

### AC-11: Approval Workflow - Director Final Approval

```gherkin
Scenario: Director reviews QA-approved plan
  Given user with QUALITY_DIRECTOR or DIRECTOR role
  And plan with qa_approved_by IS NOT NULL
  And status = 'pending_approval'
  When Director opens plan detail
  Then sees [Final Approve] and [Reject] buttons
  And review summary shows:
    | QA Approved By | John Smith |
    | QA Approved At | 2025-01-15 10:30 |
    | QA Notes | Reviewed all hazards... |

Scenario: Director gives final approval
  Given Director clicks [Final Approve]
  When approval modal opens
  Then shows:
    - Effective date (required)
    - Expiry date (optional)
    - Approval notes (optional)
  And user sets effective_date = 2025-02-01
  And clicks [Approve]
  Then director_approved_by = current user
  And director_approved_at = now
  And status changes to 'approved'
  And next_review_date calculated (effective + review_frequency)
  And success toast "HACCP Plan approved. Effective from 2025-02-01."

Scenario: Director rejects
  Given Director clicks [Reject]
  When rejection modal opens
  Then rejection_reason required
  And can choose to return to QA or draft
  And if rejected to draft, both approvals cleared
```

### AC-12: Plan Activation

```gherkin
Scenario: Activate approved plan
  Given plan with status = 'approved'
  And effective_date <= today
  When user clicks [Activate]
  Or automatic activation trigger runs
  Then status changes to 'active'
  And any previous active plan for same product changes to 'superseded'
  And success toast "Plan is now active"

Scenario: Only one active plan per product
  Given Product A has active HACCP plan v1
  When new HACCP plan v2 for Product A activated
  Then v1 status changes to 'superseded'
  And v2 status = 'active'
  And only v2 appears in "Active Plans" filter
```

### AC-13: Version Control

```gherkin
Scenario: Create new version from approved plan
  Given HACCP plan with status = 'active'
  When user clicks [Create New Version]
  Then new plan created with:
    | Field | Value |
    | version | previous + 1 |
    | parent_version_id | previous plan ID |
    | status | draft |
    | All hazards | Copied from parent |
  And user can modify new version
  And original active plan unchanged

Scenario: View version history
  Given plan with multiple versions
  When user clicks [Version History]
  Then timeline shows:
    | Version | Date | Action | User |
    | v3 | 2025-01-15 | Activated | Director |
    | v2 | 2024-07-01 | Superseded | - |
    | v1 | 2024-01-01 | Archived | - |
  And clicking version shows snapshot at that point
```

### AC-14: Review Schedule

```gherkin
Scenario: Review date calculation
  Given plan activated with effective_date = 2025-01-01
  And review_frequency_months = 12
  Then next_review_date = 2026-01-01

Scenario: Review due warning
  Given plan with next_review_date = 2025-02-01
  And today = 2025-01-15
  When viewing plans list
  Then review date shows with warning badge "Due in 17 days"

Scenario: Overdue review alert
  Given plan with next_review_date = 2025-01-01
  And today = 2025-01-15
  When viewing plans list
  Then review date shows with red alert "Overdue 14 days"
  And notification sent to QA Manager
```

### AC-15: Permission Enforcement

```gherkin
Scenario: QA Inspector can view but not approve
  Given user with QA_INSPECTOR role
  When viewing HACCP plan
  Then can view all details
  And [Approve], [Reject], [Delete] buttons hidden
  And can add/edit hazards on draft plans

Scenario: QA Manager can approve (first level)
  Given user with QA_MANAGER role
  When viewing pending_approval plan
  Then [Approve] and [Reject] visible
  And cannot do final approval

Scenario: Director has full access
  Given user with QUALITY_DIRECTOR role
  Then can do final approval
  And can override CCP decisions
  And can delete draft plans
  And can archive active plans
```

### AC-16: Audit Trail

```gherkin
Scenario: All plan changes logged
  Given any HACCP plan state change
  When action completes
  Then haccp_plan_versions entry created with:
    | Field | Value |
    | change_type | created/updated/submitted/approved/rejected/activated |
    | plan_snapshot | Full plan state JSON |
    | hazards_snapshot | Full hazards state JSON |
    | changed_by | current user |
    | changed_at | now |

Scenario: Version snapshot queryable
  Given plan has 5 version snapshots
  When audit requested for 2024-06-01
  Then system returns snapshot closest to that date
  And shows plan state and all hazards at that time
```

### AC-17: RLS Policy Enforcement

```gherkin
Scenario: Org isolation on plan list
  Given User A from Org A and User B from Org B
  And HACCP plans exist in both orgs
  When User A requests GET /api/quality/haccp/plans
  Then only Org A plans returned

Scenario: Cannot view plan from different org
  Given plan belongs to Org B
  When User A (Org A) requests GET /api/quality/haccp/plans/:id
  Then 404 Not Found returned
```

### AC-18: Performance Requirements

```gherkin
Scenario: Plan list performance
  Given 100 HACCP plans in organization
  When listing plans with pagination
  Then response time < 500ms

Scenario: Plan detail performance
  Given plan with 50 hazards
  When loading plan detail page
  Then response time < 500ms

Scenario: Risk matrix rendering
  Given plan with 30 hazards
  When rendering risk matrix
  Then matrix displays within 300ms
```

---

## Implementation Notes

### API Endpoints

```typescript
// =============================================================================
// HACCP Plan Endpoints
// =============================================================================

// GET /api/quality/haccp/plans
// List plans with filters
interface HACCPPlanListParams {
  status?: 'draft' | 'pending_approval' | 'approved' | 'active' | 'superseded' | 'archived';
  product_id?: string;
  review_due?: boolean;    // Plans with review due within 30 days
  search?: string;
  sort_by?: 'plan_number' | 'product_name' | 'effective_date' | 'next_review_date' | 'created_at';
  sort_order?: 'asc' | 'desc';
  page?: number;
  limit?: number;
}

interface HACCPPlanListResponse {
  plans: HACCPPlanSummary[];
  pagination: {
    total: number;
    page: number;
    limit: number;
    pages: number;
  };
}

interface HACCPPlanSummary {
  id: string;
  org_id: string;
  plan_number: string;
  product_id: string;
  product_name: string;
  product_code: string;
  version: number;
  name: string;
  status: 'draft' | 'pending_approval' | 'approved' | 'active' | 'superseded' | 'archived';
  total_hazards: number;
  biological_hazards: number;
  chemical_hazards: number;
  physical_hazards: number;
  identified_ccps: number;
  effective_date?: string;
  next_review_date?: string;
  review_due_days?: number;  // Negative if overdue
  created_at: string;
  updated_at: string;
}

// GET /api/quality/haccp/plans/:id
interface HACCPPlanDetailResponse {
  plan: HACCPPlan;
  hazards: HACCPHazard[];
  versions: HACCPPlanVersionSummary[];
  risk_summary: RiskSummary;
  ccp_summary: CCPSummary;
  can_submit: boolean;
  can_approve: boolean;
  can_final_approve: boolean;
}

interface HACCPPlan {
  id: string;
  org_id: string;
  plan_number: string;
  product_id: string;
  product_name: string;
  product_code: string;
  version: number;
  parent_version_id?: string;
  name: string;
  description?: string;
  scope?: string;
  routing_id?: string;
  routing_name?: string;
  status: string;
  review_frequency_months: number;
  next_review_date?: string;
  last_reviewed_at?: string;
  effective_date?: string;
  expiry_date?: string;
  team_leader_id?: string;
  team_leader_name?: string;
  team_members: string[];
  qa_approved_by?: string;
  qa_approved_by_name?: string;
  qa_approved_at?: string;
  qa_approval_notes?: string;
  director_approved_by?: string;
  director_approved_by_name?: string;
  director_approved_at?: string;
  director_approval_notes?: string;
  rejected_by?: string;
  rejected_at?: string;
  rejection_reason?: string;
  total_hazards: number;
  biological_hazards: number;
  chemical_hazards: number;
  physical_hazards: number;
  identified_ccps: number;
  created_at: string;
  created_by: string;
  updated_at: string;
}

interface HACCPHazard {
  id: string;
  haccp_plan_id: string;
  sequence: number;
  process_step: string;
  operation_id?: string;
  hazard_type: 'biological' | 'chemical' | 'physical';
  hazard_name: string;
  hazard_description?: string;
  hazard_source?: string;
  potential_cause?: string;
  severity: number;
  likelihood: number;
  risk_score: number;
  risk_level: 'critical' | 'high' | 'medium' | 'low';
  ccp_q1_preventive?: boolean;
  ccp_q2_designed?: boolean;
  ccp_q3_contamination?: boolean;
  ccp_q4_subsequent?: boolean;
  is_ccp: boolean;
  ccp_number?: string;
  ccp_justification?: string;
  control_measures?: string;
  created_at: string;
  updated_at: string;
}

interface RiskSummary {
  critical: number;
  high: number;
  medium: number;
  low: number;
  by_type: {
    biological: { critical: number; high: number; medium: number; low: number };
    chemical: { critical: number; high: number; medium: number; low: number };
    physical: { critical: number; high: number; medium: number; low: number };
  };
}

interface CCPSummary {
  total_ccps: number;
  ccps: Array<{
    ccp_number: string;
    hazard_name: string;
    hazard_type: string;
    process_step: string;
    risk_level: string;
  }>;
}

// POST /api/quality/haccp/plans
interface CreateHACCPPlanRequest {
  product_id: string;
  name: string;
  description?: string;
  scope?: string;
  routing_id?: string;
  review_frequency_months?: number;
  team_leader_id?: string;
  team_members?: string[];
}

interface CreateHACCPPlanResponse {
  plan: HACCPPlan;
}

// PUT /api/quality/haccp/plans/:id
interface UpdateHACCPPlanRequest {
  name?: string;
  description?: string;
  scope?: string;
  routing_id?: string;
  review_frequency_months?: number;
  team_leader_id?: string;
  team_members?: string[];
}

// POST /api/quality/haccp/plans/:id/submit
interface SubmitPlanResponse {
  plan: HACCPPlan;
  message: string;
}

// POST /api/quality/haccp/plans/:id/approve
interface ApprovePlanRequest {
  approval_notes?: string;
}

interface ApprovePlanResponse {
  plan: HACCPPlan;
  requires_director_approval: boolean;
  message: string;
}

// POST /api/quality/haccp/plans/:id/director-approve
interface DirectorApprovePlanRequest {
  effective_date: string;
  expiry_date?: string;
  approval_notes?: string;
}

interface DirectorApprovePlanResponse {
  plan: HACCPPlan;
  message: string;
}

// POST /api/quality/haccp/plans/:id/reject
interface RejectPlanRequest {
  rejection_reason: string;
  return_to?: 'draft' | 'qa_review';
}

// POST /api/quality/haccp/plans/:id/new-version
interface NewVersionResponse {
  plan: HACCPPlan;
  message: string;
}

// POST /api/quality/haccp/plans/:id/activate
interface ActivatePlanResponse {
  plan: HACCPPlan;
  superseded_plan_id?: string;
  message: string;
}

// =============================================================================
// HACCP Hazard Endpoints
// =============================================================================

// POST /api/quality/haccp/plans/:id/hazards
interface CreateHazardRequest {
  process_step: string;
  operation_id?: string;
  hazard_type: 'biological' | 'chemical' | 'physical';
  hazard_name: string;
  hazard_description?: string;
  hazard_source?: string;
  potential_cause?: string;
  severity: number;
  likelihood: number;
}

// PUT /api/quality/haccp/plans/:id/hazards/:hazardId
interface UpdateHazardRequest {
  process_step?: string;
  operation_id?: string;
  hazard_type?: 'biological' | 'chemical' | 'physical';
  hazard_name?: string;
  hazard_description?: string;
  hazard_source?: string;
  potential_cause?: string;
  severity?: number;
  likelihood?: number;
}

// DELETE /api/quality/haccp/plans/:id/hazards/:hazardId
// Returns { success: true, message: "Hazard deleted" }

// POST /api/quality/haccp/plans/:id/hazards/:hazardId/ccp-decision
interface CCPDecisionRequest {
  ccp_q1_preventive: boolean;
  ccp_q2_designed?: boolean;
  ccp_q3_contamination?: boolean;
  ccp_q4_subsequent?: boolean;
  is_ccp: boolean;
  ccp_justification?: string;
  control_measures?: string;
}

interface CCPDecisionResponse {
  hazard: HACCPHazard;
  ccp_number?: string;
  message: string;
}
```

### Validation Schemas (Zod)

```typescript
import { z } from 'zod';

export const haccpPlanStatusEnum = z.enum([
  'draft', 'pending_approval', 'approved', 'active', 'superseded', 'archived'
]);

export const hazardTypeEnum = z.enum(['biological', 'chemical', 'physical']);

export const riskLevelEnum = z.enum(['critical', 'high', 'medium', 'low']);

export const createHACCPPlanSchema = z.object({
  product_id: z.string().uuid('Invalid product ID'),
  name: z.string()
    .min(5, 'Name must be at least 5 characters')
    .max(200, 'Name must be less than 200 characters'),
  description: z.string().max(2000).optional(),
  scope: z.string().max(1000).optional(),
  routing_id: z.string().uuid().optional().nullable(),
  review_frequency_months: z.number()
    .int()
    .min(1, 'Review frequency must be at least 1 month')
    .max(36, 'Review frequency cannot exceed 36 months')
    .default(12),
  team_leader_id: z.string().uuid().optional().nullable(),
  team_members: z.array(z.string().uuid()).default([]),
});

export const updateHACCPPlanSchema = z.object({
  name: z.string()
    .min(5, 'Name must be at least 5 characters')
    .max(200, 'Name must be less than 200 characters')
    .optional(),
  description: z.string().max(2000).optional().nullable(),
  scope: z.string().max(1000).optional().nullable(),
  routing_id: z.string().uuid().optional().nullable(),
  review_frequency_months: z.number()
    .int()
    .min(1)
    .max(36)
    .optional(),
  team_leader_id: z.string().uuid().optional().nullable(),
  team_members: z.array(z.string().uuid()).optional(),
});

export const createHazardSchema = z.object({
  process_step: z.string()
    .min(2, 'Process step must be at least 2 characters')
    .max(200, 'Process step must be less than 200 characters'),
  operation_id: z.string().uuid().optional().nullable(),
  hazard_type: hazardTypeEnum,
  hazard_name: z.string()
    .min(3, 'Hazard name must be at least 3 characters')
    .max(200, 'Hazard name must be less than 200 characters'),
  hazard_description: z.string().max(1000).optional().nullable(),
  hazard_source: z.string().max(500).optional().nullable(),
  potential_cause: z.string().max(500).optional().nullable(),
  severity: z.number()
    .int()
    .min(1, 'Severity must be between 1 and 5')
    .max(5, 'Severity must be between 1 and 5'),
  likelihood: z.number()
    .int()
    .min(1, 'Likelihood must be between 1 and 5')
    .max(5, 'Likelihood must be between 1 and 5'),
});

export const updateHazardSchema = createHazardSchema.partial();

export const ccpDecisionSchema = z.object({
  ccp_q1_preventive: z.boolean(),
  ccp_q2_designed: z.boolean().optional(),
  ccp_q3_contamination: z.boolean().optional(),
  ccp_q4_subsequent: z.boolean().optional(),
  is_ccp: z.boolean(),
  ccp_justification: z.string().max(1000).optional().nullable(),
  control_measures: z.string().max(1000).optional().nullable(),
}).refine(
  (data) => {
    // If is_ccp is overridden (different from tree result), justification required
    // This is handled in service layer based on decision tree logic
    return true;
  }
);

export const approvePlanSchema = z.object({
  approval_notes: z.string().max(1000).optional(),
});

export const directorApprovePlanSchema = z.object({
  effective_date: z.string().regex(/^\d{4}-\d{2}-\d{2}$/, 'Invalid date format'),
  expiry_date: z.string().regex(/^\d{4}-\d{2}-\d{2}$/).optional().nullable(),
  approval_notes: z.string().max(1000).optional(),
});

export const rejectPlanSchema = z.object({
  rejection_reason: z.string()
    .min(10, 'Rejection reason must be at least 10 characters')
    .max(1000, 'Rejection reason must be less than 1000 characters'),
  return_to: z.enum(['draft', 'qa_review']).default('draft'),
});

export const haccpPlanListQuerySchema = z.object({
  status: haccpPlanStatusEnum.optional(),
  product_id: z.string().uuid().optional(),
  review_due: z.coerce.boolean().optional(),
  search: z.string().min(1).optional(),
  sort_by: z.enum(['plan_number', 'product_name', 'effective_date', 'next_review_date', 'created_at']).default('created_at'),
  sort_order: z.enum(['asc', 'desc']).default('desc'),
  page: z.coerce.number().int().positive().default(1),
  limit: z.coerce.number().int().min(1).max(100).default(20),
});
```

### Service Layer

```typescript
// lib/services/haccp-service.ts

export class HACCPService {
  // ==========================================================================
  // Plan CRUD Operations
  // ==========================================================================

  /**
   * List HACCP plans with filtering and pagination
   */
  static async listPlans(params: HACCPPlanListParams): Promise<PaginatedResult<HACCPPlanSummary>>;

  /**
   * Get plan by ID with full details
   */
  static async getPlanById(planId: string): Promise<HACCPPlanDetailResponse | null>;

  /**
   * Get plan by number
   */
  static async getPlanByNumber(planNumber: string): Promise<HACCPPlan | null>;

  /**
   * Create new HACCP plan
   */
  static async createPlan(input: CreateHACCPPlanInput): Promise<HACCPPlan>;

  /**
   * Update draft plan
   */
  static async updatePlan(planId: string, input: UpdateHACCPPlanInput): Promise<HACCPPlan>;

  /**
   * Delete draft plan
   */
  static async deletePlan(planId: string): Promise<void>;

  // ==========================================================================
  // Approval Workflow
  // ==========================================================================

  /**
   * Submit plan for approval
   * Validates plan has hazards before allowing submission
   */
  static async submitForApproval(planId: string, userId: string): Promise<HACCPPlan>;

  /**
   * QA Manager approval (first level)
   */
  static async approveByQAManager(
    planId: string,
    userId: string,
    notes?: string
  ): Promise<HACCPPlan>;

  /**
   * Director approval (final level)
   * Sets effective date and activates plan
   */
  static async approveByDirector(
    planId: string,
    userId: string,
    effectiveDate: string,
    expiryDate?: string,
    notes?: string
  ): Promise<HACCPPlan>;

  /**
   * Reject plan with reason
   */
  static async rejectPlan(
    planId: string,
    userId: string,
    reason: string,
    returnTo?: 'draft' | 'qa_review'
  ): Promise<HACCPPlan>;

  /**
   * Activate approved plan
   * Supersedes any existing active plan for same product
   */
  static async activatePlan(planId: string, userId: string): Promise<{
    plan: HACCPPlan;
    supersededPlanId?: string;
  }>;

  // ==========================================================================
  // Version Control
  // ==========================================================================

  /**
   * Create new version from existing plan
   * Copies all hazards to new version
   */
  static async createNewVersion(planId: string, userId: string): Promise<HACCPPlan>;

  /**
   * Get version history for plan
   */
  static async getVersionHistory(planId: string): Promise<HACCPPlanVersionSummary[]>;

  /**
   * Get specific version snapshot
   */
  static async getVersionSnapshot(versionId: string): Promise<HACCPPlanVersion>;

  // ==========================================================================
  // Hazard Operations
  // ==========================================================================

  /**
   * Add hazard to plan
   */
  static async addHazard(planId: string, input: CreateHazardInput): Promise<HACCPHazard>;

  /**
   * Update hazard
   */
  static async updateHazard(
    planId: string,
    hazardId: string,
    input: UpdateHazardInput
  ): Promise<HACCPHazard>;

  /**
   * Delete hazard
   */
  static async deleteHazard(planId: string, hazardId: string): Promise<void>;

  /**
   * Reorder hazard
   */
  static async reorderHazard(
    planId: string,
    hazardId: string,
    direction: 'up' | 'down'
  ): Promise<void>;

  /**
   * Update hazard risk assessment
   */
  static async updateRiskAssessment(
    hazardId: string,
    severity: number,
    likelihood: number
  ): Promise<HACCPHazard>;

  // ==========================================================================
  // CCP Decision
  // ==========================================================================

  /**
   * Record CCP decision for hazard
   */
  static async recordCCPDecision(
    planId: string,
    hazardId: string,
    decision: CCPDecisionInput
  ): Promise<HACCPHazard>;

  /**
   * Calculate CCP result from decision tree answers
   */
  static calculateCCPFromDecisionTree(
    q1: boolean,
    q2?: boolean,
    q3?: boolean,
    q4?: boolean
  ): { isCCP: boolean; reason: string };

  /**
   * Assign next CCP number for plan
   */
  static async assignCCPNumber(planId: string): Promise<string>;

  // ==========================================================================
  // Risk Analysis
  // ==========================================================================

  /**
   * Calculate risk summary for plan
   */
  static async calculateRiskSummary(planId: string): Promise<RiskSummary>;

  /**
   * Get hazards by risk level
   */
  static async getHazardsByRiskLevel(
    planId: string,
    riskLevel: 'critical' | 'high' | 'medium' | 'low'
  ): Promise<HACCPHazard[]>;

  /**
   * Calculate risk level from severity and likelihood
   */
  static calculateRiskLevel(severity: number, likelihood: number): 'critical' | 'high' | 'medium' | 'low';

  // ==========================================================================
  // Review Management
  // ==========================================================================

  /**
   * Get plans due for review
   */
  static async getPlansForReview(daysAhead: number): Promise<HACCPPlanSummary[]>;

  /**
   * Mark plan as reviewed
   */
  static async markPlanReviewed(planId: string, userId: string): Promise<HACCPPlan>;

  // ==========================================================================
  // Utility
  // ==========================================================================

  /**
   * Generate next plan number
   */
  static async generatePlanNumber(): Promise<string>;

  /**
   * Check if product has active plan
   */
  static async getActivePlanForProduct(productId: string): Promise<HACCPPlan | null>;

  /**
   * Create version snapshot
   */
  static async createVersionSnapshot(
    planId: string,
    changeType: string,
    changeReason: string,
    userId: string
  ): Promise<string>;
}
```

### Frontend Components

```
apps/frontend/app/(authenticated)/quality/
  haccp/
    plans/
      page.tsx                       -- HACCP plans list
      new/
        page.tsx                     -- Create plan wizard
      [id]/
        page.tsx                     -- Plan detail
        edit/
          page.tsx                   -- Edit plan (draft only)

components/quality/haccp/
  HACCPPlansDataTable.tsx            -- DataTable with filters
  HACCPPlanFilters.tsx               -- Filter panel (status, product)
  HACCPPlanStatusBadge.tsx           -- Status badge component
  HACCPPlanDetail.tsx                -- Detail view container
  HACCPPlanHeader.tsx                -- Header with status, actions
  HACCPPlanSummaryCard.tsx           -- Summary statistics card
  HACCPPlanWizard.tsx                -- 5-step creation wizard

  WizardStep1Product.tsx             -- Step 1: Product selection
  WizardStep2Details.tsx             -- Step 2: Plan details
  WizardStep3Hazards.tsx             -- Step 3: Hazard identification
  WizardStep4RiskMatrix.tsx          -- Step 4: Risk assessment
  WizardStep5CCPDecision.tsx         -- Step 5: CCP determination

  HazardsTable.tsx                   -- Hazards list table
  HazardModal.tsx                    -- Add/Edit hazard modal
  HazardTypeIcon.tsx                 -- Bio/Chem/Phys icons
  HazardTypeBadge.tsx                -- Type badge with color

  RiskMatrix.tsx                     -- 5x5 risk matrix grid
  RiskMatrixCell.tsx                 -- Individual cell with hazards
  RiskMatrixHazardChip.tsx           -- Draggable hazard chip
  RiskLevelBadge.tsx                 -- Critical/High/Medium/Low badge
  RiskSummaryPanel.tsx               -- Risk distribution summary

  CCPDecisionTree.tsx                -- Decision tree flowchart
  CCPDecisionNode.tsx                -- Individual question node
  CCPDecisionResult.tsx              -- CCP/Not CCP result display
  CCPSummaryPanel.tsx                -- CCPs identified summary

  ApprovalWorkflow.tsx               -- Approval status and actions
  ApprovalModal.tsx                  -- Approve with notes modal
  RejectModal.tsx                    -- Reject with reason modal
  DirectorApprovalModal.tsx          -- Final approval with effective date

  VersionHistoryTimeline.tsx         -- Version history display
  VersionCompareView.tsx             -- Compare versions (future)

  ReviewDueBadge.tsx                 -- Review due/overdue badge
  ReviewSchedulePanel.tsx            -- Review schedule info
```

### UI Component Details

**HACCPPlanWizard.tsx**
- 5-step wizard with progress indicator
- Step validation before next
- Draft auto-save between steps
- Back/Next/Save Draft/Complete actions
- Responsive layout (full-width on mobile)

**RiskMatrix.tsx**
- 5x5 grid using CSS Grid
- Color-coded cells (green/yellow/orange/red)
- Hazard chips with drag-drop support
- Hover shows hazard details
- Click hazard opens detail modal
- Legend showing severity/likelihood labels

**CCPDecisionTree.tsx**
- Flowchart using react-flow or custom SVG
- Interactive question nodes
- Yes/No buttons at each node
- Animated path highlighting
- Result node shows CCP/Not CCP
- Override option with justification

**ApprovalWorkflow.tsx**
- Shows current approval status
- QA approval section (name, date, notes)
- Director approval section
- Action buttons based on user role and status
- Rejection history if applicable

---

## Key Business Rules

1. **One Active Plan Per Product**: Only one HACCP plan can be 'active' per product at a time
2. **Dual Approval Required**: Plans require both QA Manager and Director approval
3. **Version Immutability**: Approved/active plans cannot be modified; create new version instead
4. **Hazard Required**: Plans must have at least 1 hazard before submission
5. **Risk Auto-Calculation**: Risk score = severity x likelihood, risk level derived automatically
6. **CCP Numbering**: CCPs numbered sequentially within a plan (CCP-1, CCP-2, etc.)
7. **Review Schedule**: Next review date = effective date + review frequency
8. **Supersession**: Activating new version automatically supersedes previous active version
9. **Audit Trail**: All state changes create version snapshots
10. **Draft Deletion Only**: Only draft plans can be deleted; others archived

---

## Deliverables

### Database
- [ ] Migration: `haccp_plans` table with all columns
- [ ] Migration: `haccp_hazards` table with risk fields and CCP decision
- [ ] Migration: `haccp_plan_versions` table for audit trail
- [ ] Migration: `haccp_plan_number_sequences` table
- [ ] Function: `generate_haccp_plan_number(org_id)`
- [ ] Function: `update_haccp_plan_statistics()` trigger
- [ ] Function: `create_haccp_version_snapshot()`
- [ ] RLS policies for all HACCP tables
- [ ] All performance indexes

### API Routes
- [ ] `GET /api/quality/haccp/plans` - List with filters
- [ ] `GET /api/quality/haccp/plans/:id` - Get detail with hazards
- [ ] `POST /api/quality/haccp/plans` - Create plan
- [ ] `PUT /api/quality/haccp/plans/:id` - Update draft plan
- [ ] `DELETE /api/quality/haccp/plans/:id` - Delete draft plan
- [ ] `POST /api/quality/haccp/plans/:id/submit` - Submit for approval
- [ ] `POST /api/quality/haccp/plans/:id/approve` - QA Manager approval
- [ ] `POST /api/quality/haccp/plans/:id/director-approve` - Director approval
- [ ] `POST /api/quality/haccp/plans/:id/reject` - Reject plan
- [ ] `POST /api/quality/haccp/plans/:id/activate` - Activate approved plan
- [ ] `POST /api/quality/haccp/plans/:id/new-version` - Create new version
- [ ] `POST /api/quality/haccp/plans/:id/hazards` - Add hazard
- [ ] `PUT /api/quality/haccp/plans/:id/hazards/:hazardId` - Update hazard
- [ ] `DELETE /api/quality/haccp/plans/:id/hazards/:hazardId` - Delete hazard
- [ ] `POST /api/quality/haccp/plans/:id/hazards/:hazardId/ccp-decision` - Record CCP decision

### Service Layer
- [ ] `HACCPService.listPlans()` - List with pagination
- [ ] `HACCPService.getPlanById()` - Get with hazards
- [ ] `HACCPService.createPlan()` - Create plan
- [ ] `HACCPService.updatePlan()` - Update draft
- [ ] `HACCPService.deletePlan()` - Delete draft
- [ ] `HACCPService.submitForApproval()` - Submit workflow
- [ ] `HACCPService.approveByQAManager()` - First approval
- [ ] `HACCPService.approveByDirector()` - Final approval
- [ ] `HACCPService.rejectPlan()` - Rejection
- [ ] `HACCPService.activatePlan()` - Activation
- [ ] `HACCPService.createNewVersion()` - Version control
- [ ] `HACCPService.addHazard()` - Add hazard
- [ ] `HACCPService.recordCCPDecision()` - CCP decision
- [ ] `HACCPService.calculateRiskSummary()` - Risk analysis
- [ ] `HACCPService.calculateCCPFromDecisionTree()` - CCP logic

### Validation
- [ ] `createHACCPPlanSchema`
- [ ] `updateHACCPPlanSchema`
- [ ] `createHazardSchema`
- [ ] `updateHazardSchema`
- [ ] `ccpDecisionSchema`
- [ ] `approvePlanSchema`
- [ ] `directorApprovePlanSchema`
- [ ] `rejectPlanSchema`
- [ ] `haccpPlanListQuerySchema`

### Frontend
- [ ] HACCP plans list page with filters
- [ ] Plan detail page with tabs (Hazards, Risk Matrix, CCPs, Approval)
- [ ] 5-step creation wizard
- [ ] Hazards table with CRUD
- [ ] Risk matrix with drag-drop
- [ ] CCP decision tree flowchart
- [ ] Approval workflow UI
- [ ] Version history timeline
- [ ] Status, risk level, hazard type badges
- [ ] Review due/overdue indicators

### Tests
- [ ] Unit tests: HACCPService methods (>80% coverage)
- [ ] Integration tests: All API endpoints
- [ ] Risk calculation tests
- [ ] CCP decision tree tests
- [ ] Approval workflow tests
- [ ] RLS tests: Multi-tenancy isolation
- [ ] E2E: Full HACCP plan lifecycle (create -> approve -> activate)

---

## Test Strategy

### Unit Tests

```typescript
describe('HACCPService', () => {
  describe('createPlan', () => {
    it('creates plan with correct fields', async () => {});
    it('generates plan number', async () => {});
    it('validates product exists', async () => {});
    it('warns if product has active plan', async () => {});
    it('links routing if provided', async () => {});
  });

  describe('addHazard', () => {
    it('adds hazard to draft plan', async () => {});
    it('calculates risk_score and risk_level', async () => {});
    it('updates plan statistics', async () => {});
    it('blocks adding to non-draft plan', async () => {});
    it('auto-assigns sequence number', async () => {});
  });

  describe('calculateRiskLevel', () => {
    it('returns critical for score >= 15', () => {});
    it('returns high for score 10-14', () => {});
    it('returns medium for score 5-9', () => {});
    it('returns low for score 1-4', () => {});
  });

  describe('calculateCCPFromDecisionTree', () => {
    it('Q1=No -> Not CCP (modify process)', () => {});
    it('Q1=Yes, Q2=Yes -> CCP', () => {});
    it('Q1=Yes, Q2=No, Q3=No -> Not CCP', () => {});
    it('Q1=Yes, Q2=No, Q3=Yes, Q4=Yes -> Not CCP (later step)', () => {});
    it('Q1=Yes, Q2=No, Q3=Yes, Q4=No -> CCP', () => {});
  });

  describe('submitForApproval', () => {
    it('changes status to pending_approval', async () => {});
    it('creates version snapshot', async () => {});
    it('blocks if no hazards', async () => {});
    it('blocks if not draft', async () => {});
  });

  describe('approveByQAManager', () => {
    it('records qa_approved_by and timestamp', async () => {});
    it('requires QA_MANAGER role', async () => {});
    it('blocks if not pending_approval', async () => {});
    it('does not change status (awaits director)', async () => {});
  });

  describe('approveByDirector', () => {
    it('requires qa_approved_by first', async () => {});
    it('sets effective_date and next_review_date', async () => {});
    it('changes status to approved', async () => {});
    it('requires DIRECTOR role', async () => {});
  });

  describe('activatePlan', () => {
    it('changes status to active', async () => {});
    it('supersedes previous active plan', async () => {});
    it('blocks if not approved', async () => {});
    it('blocks if effective_date in future', async () => {});
  });

  describe('createNewVersion', () => {
    it('creates new plan with incremented version', async () => {});
    it('copies all hazards', async () => {});
    it('sets parent_version_id', async () => {});
    it('new plan status is draft', async () => {});
  });
});
```

### Integration Tests

```typescript
describe('HACCP Plans API', () => {
  describe('POST /api/quality/haccp/plans', () => {
    it('creates plan with valid data', async () => {});
    it('returns 400 for missing product_id', async () => {});
    it('returns 400 for invalid product', async () => {});
    it('enforces org_id from auth', async () => {});
  });

  describe('POST /api/quality/haccp/plans/:id/approve', () => {
    it('approves pending plan as QA Manager', async () => {});
    it('returns 403 for non-QA-Manager', async () => {});
    it('returns 400 for non-pending plan', async () => {});
  });

  describe('POST /api/quality/haccp/plans/:id/director-approve', () => {
    it('final approves with effective date', async () => {});
    it('requires QA approval first', async () => {});
    it('returns 403 for non-Director', async () => {});
  });

  describe('POST /api/quality/haccp/plans/:id/hazards', () => {
    it('adds hazard with risk calculation', async () => {});
    it('returns 400 for invalid severity/likelihood', async () => {});
    it('blocks adding to non-draft plan', async () => {});
  });

  describe('POST /api/quality/haccp/plans/:id/hazards/:id/ccp-decision', () => {
    it('marks hazard as CCP', async () => {});
    it('assigns CCP number', async () => {});
    it('requires justification for override', async () => {});
  });

  describe('GET /api/quality/haccp/plans', () => {
    it('returns only org plans', async () => {});
    it('filters by status', async () => {});
    it('filters by product', async () => {});
    it('filters by review_due', async () => {});
    it('paginates correctly', async () => {});
  });
});
```

### E2E Tests

```typescript
describe('HACCP Plan Lifecycle', () => {
  it('complete workflow: create -> hazards -> risk -> ccp -> approve -> activate', async () => {
    // 1. Navigate to HACCP plans
    // 2. Start new plan wizard
    // 3. Select product
    // 4. Enter plan details
    // 5. Add hazards (Bio, Chem, Phys)
    // 6. Assess risks on matrix
    // 7. Complete CCP decision tree
    // 8. Review summary
    // 9. Submit for approval
    // 10. Login as QA Manager, approve
    // 11. Login as Director, final approve with date
    // 12. Verify plan status = approved
    // 13. Activate plan
    // 14. Verify plan status = active
  });

  it('version control: create new version from active plan', async () => {
    // 1. View active plan
    // 2. Click Create New Version
    // 3. Modify hazards
    // 4. Submit and approve new version
    // 5. Activate new version
    // 6. Verify old version superseded
  });

  it('rejection workflow', async () => {
    // 1. Submit plan for approval
    // 2. Login as QA Manager
    // 3. Reject with reason
    // 4. Verify plan returns to draft
    // 5. Verify rejection reason saved
  });
});
```

---

## Definition of Done

### Database
- [ ] `haccp_plans` table created with all columns
- [ ] `haccp_hazards` table created with risk and CCP fields
- [ ] `haccp_plan_versions` table created for audit
- [ ] All indexes created for performance
- [ ] RLS policies enforce org isolation
- [ ] Trigger for statistics update works
- [ ] Plan number generation works correctly
- [ ] Risk score and level auto-calculated

### API
- [ ] All endpoints return correct HTTP status codes
- [ ] Validation errors return 400 with detailed messages
- [ ] Cross-tenant access returns 404
- [ ] Response times:
  - Plan list: < 500ms
  - Plan detail with hazards: < 500ms
  - Create/Update: < 300ms
  - Approval actions: < 500ms

### Service
- [ ] Complete plan lifecycle: create -> approve -> activate
- [ ] Hazard CRUD with risk calculation
- [ ] CCP decision tree logic correct
- [ ] Version control with snapshots
- [ ] Dual approval workflow enforced
- [ ] Audit trail created for all actions
- [ ] Permission checks enforced

### Frontend
- [ ] Plans list displays correctly with filters
- [ ] 5-step wizard works end-to-end
- [ ] Hazard CRUD with modal
- [ ] Risk matrix with drag-drop
- [ ] CCP decision tree interactive
- [ ] Approval workflow UI complete
- [ ] Version history displays
- [ ] All badges and indicators correct
- [ ] Responsive on mobile

### Testing
- [ ] Unit tests: >80% coverage on service
- [ ] Integration tests: All endpoints covered
- [ ] CCP decision tree logic tests
- [ ] Risk calculation tests
- [ ] Approval workflow tests
- [ ] RLS tests: Multi-tenancy verified
- [ ] E2E tests: Full lifecycle passing

### Integration
- [ ] Works with Epic 02 Products (product_id FK)
- [ ] Works with Epic 02 Routings (routing_id FK, optional)
- [ ] Provides to Story 06.22 (CCP Definition)

---

## Risk Assessment

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Complex approval workflow | MEDIUM | MEDIUM | Clear state machine, comprehensive tests |
| Risk matrix drag-drop performance | LOW | MEDIUM | Optimize rendering, limit visible hazards |
| CCP decision tree UX complexity | MEDIUM | MEDIUM | Clear flowchart, step-by-step guidance |
| Version control data integrity | HIGH | LOW | Database transactions, snapshot validation |
| Dual approval timing issues | MEDIUM | LOW | Clear status indicators, notification system |
| Large plans with many hazards | MEDIUM | LOW | Pagination, lazy loading, indexes |

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-01-15 | Initial story creation with comprehensive HACCP plan management | ARCHITECT-AGENT |

---

**Document Status**: Ready for Implementation
**Created**: 2025-01-15
**Lines**: ~1700
**Complexity**: L (Large)
**Phase**: 3 (HACCP & CoA)
