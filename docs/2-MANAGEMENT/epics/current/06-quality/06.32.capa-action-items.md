# 06.32 - CAPA Action Items

**Priority**: P1 (Phase 4)
**Story Points**: M (Medium)
**Type**: full-stack
**Phase**: 4 (Advanced Quality)
**Model**: OPUS

**State:** ready
**Estimate:** M (3-4 days)
**Primary PRD:** `docs/1-BASELINE/product/modules/quality.md` (FR-QA-017, Section 4.2 NCR & CAPA)

---

## Goal

Implement CAPA action items checklist management. Action items are the specific tasks required to address the root cause identified in the CAPA. Each action has a responsible person, due date, completion status, and evidence attachments. Progress tracking shows overall CAPA completion percentage.

---

## User Story

As a **CAPA Owner**, I want to **create and track action items for my CAPA with assigned responsibilities and due dates** so that **I can systematically implement corrective/preventive actions**.

As a **QA Manager**, I want to **monitor action item completion status and progress percentage** so that **I can ensure timely CAPA closure**.

---

## Dependencies

- **Requires**: 06.31 CAPA Creation (capa_records table)
- **Blocks**: 06.33 CAPA Effectiveness Check

---

## Database Schema

```sql
CREATE TABLE capa_actions (
    id                      UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id                  UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    capa_id                 UUID NOT NULL REFERENCES capa_records(id) ON DELETE CASCADE,

    action_type             TEXT NOT NULL CHECK (action_type IN ('immediate', 'long_term')),
    description             TEXT NOT NULL,
    responsible_person_id   UUID REFERENCES users(id),
    due_date                DATE NOT NULL,

    status                  TEXT NOT NULL DEFAULT 'pending'
                            CHECK (status IN ('pending', 'in_progress', 'completed', 'cancelled')),
    completed_at            TIMESTAMPTZ,
    completed_by            UUID REFERENCES users(id),

    evidence_url            TEXT,
    evidence_notes          TEXT,

    sequence                INTEGER NOT NULL DEFAULT 1,

    created_at              TIMESTAMPTZ NOT NULL DEFAULT now(),
    created_by              UUID REFERENCES users(id),
    updated_at              TIMESTAMPTZ NOT NULL DEFAULT now(),

    CONSTRAINT uq_capa_action_sequence UNIQUE (capa_id, sequence)
);

CREATE INDEX idx_capa_actions_capa ON capa_actions(capa_id);
CREATE INDEX idx_capa_actions_responsible ON capa_actions(responsible_person_id) WHERE responsible_person_id IS NOT NULL;
CREATE INDEX idx_capa_actions_due_date ON capa_actions(org_id, due_date) WHERE status IN ('pending', 'in_progress');
```

---

## API Endpoints

- **GET** `/api/quality/capa/:capaId/actions` - List action items for CAPA
- **POST** `/api/quality/capa/:capaId/actions` - Create action item
- **PUT** `/api/quality/capa/actions/:id` - Update action item
- **DELETE** `/api/quality/capa/actions/:id` - Delete action item
- **POST** `/api/quality/capa/actions/:id/complete` - Mark action complete with evidence
- **GET** `/api/quality/capa/:capaId/progress` - Get progress percentage

---

## Key Features

1. **Action Types**: Immediate (short-term fix) vs Long-term (systemic change)
2. **Responsibility Assignment**: Assign to specific user
3. **Due Date Tracking**: Track due dates, overdue indicators
4. **Evidence Upload**: Attach photos/documents as completion proof
5. **Progress Tracking**: Calculate % completion (completed / total)
6. **Sequential Ordering**: Drag-and-drop reordering of actions
7. **Status Workflow**: pending → in_progress → completed

---

## Acceptance Criteria

### AC-1: Create Action Item

```gherkin
Scenario: Add action item to CAPA
  Given CAPA CAPA-2025-00001 exists
  When user clicks [+ Add Action]
  And fills form:
    | Field | Value |
    | Type | Immediate |
    | Description | Update receiving SOP |
    | Responsible | QA Manager |
    | Due Date | 2025-03-15 |
  And clicks [Save]
  Then action item created
  And sequence = next available (1, 2, 3...)
  And status = 'pending'
```

### AC-2: Complete Action Item

```gherkin
Scenario: Mark action complete with evidence
  Given action item with status = 'in_progress'
  When user clicks [Mark Complete]
  And uploads evidence (PDF/photo)
  And enters evidence_notes
  And clicks [Complete]
  Then status = 'completed'
  And completed_at = now
  And completed_by = current user
  And evidence_url saved
  And CAPA progress percentage recalculated
```

### AC-3: Progress Calculation

```gherkin
Scenario: Calculate CAPA progress
  Given CAPA with 5 action items
  And 3 completed, 2 pending
  When viewing CAPA detail
  Then progress shows "60% complete (3 of 5 actions)"
  And progress bar displayed
```

### AC-4: Cannot Close CAPA with Incomplete Actions

```gherkin
Scenario: Block CAPA closure
  Given CAPA with 5 action items
  And only 3 completed
  When user attempts to close CAPA
  Then error: "Cannot close CAPA with 2 incomplete actions"
  And [Close CAPA] button disabled
```

---

## Deliverables

- [ ] `capa_actions` table migration
- [ ] Action CRUD endpoints (7)
- [ ] CapaActionService with methods
- [ ] Action item components (list, form, complete modal)
- [ ] Progress bar component
- [ ] Unit + integration tests

---

**Complexity**: M (3-4 days)
**Created**: 2026-01-15
