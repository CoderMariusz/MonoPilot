# 06.10 - In-Process Inspection

**Priority**: P0 (MVP Phase 2)
**Story Points**: L (Large)
**Type**: backend + frontend
**Phase**: 2 (In-Process & Final)
**Model**: OPUS

**State:** ready
**Estimate:** L (5-8 days)
**Primary PRD:** `docs/1-BASELINE/product/modules/quality.md` (FR-QA-006, Section 9.2)
**Architecture:** `docs/1-BASELINE/architecture/modules/quality.md` (quality_inspections table)

---

## Goal

Implement the in-process inspection workflow for Work-In-Progress (WIP) quality verification during production. This enables QA teams to inspect semi-finished products at critical operation checkpoints, verify process parameters, and determine pass/fail/conditional results before allowing production to continue. In-process inspection is a critical quality gate that ensures product conformance throughout the manufacturing process and catches defects early before final production.

---

## Food Safety Compliance

This story is **critical for food safety compliance**:

- [x] **HACCP Compliance** - In-process CCPs require inspection records at critical operations
- [x] **FDA 21 CFR Part 11** - Audit trail for all inspection actions required
- [x] **Audit Trail Required** - Inspector ID, timestamp, result, all test values
- [x] **Traceability** - Inspection linked to WO, Operation, and Batch

**Regulatory Context:**
- FDA FSMA requires documented in-process quality checks
- Process parameter verification (temperature, time, pH, etc.)
- Visual inspection for contamination, defects
- CCP monitoring values at critical operations
- All records retained for minimum 2 years (configurable)

---

## MVP Scope

This story implements Phase 2 (In-Process & Final) functionality. In-process inspection builds on patterns established in story 06.5 (Incoming Inspection) and integrates with Epic 04 (Production) for WO operation checkpoints.

**MVP Includes**:
- `quality_inspections` table with type='in_process' filter
- Auto-create inspection on WO operation completion (if setting enabled)
- Manual inspection creation from production queue
- Integration with `wo_operations` table (Epic 04)
- Inspection workflow: scheduled -> in_progress -> completed
- Inspector assignment and reassignment
- Test results recording per specification parameter (via story 06.6)
- Result determination: pass/fail/conditional
- WIP quality status update on inspection completion
- Operation checkpoint linkage
- Inspection queue dashboard with filters (by WO, operation, product)
- Inspection detail page with test results grid
- Integration with Epic 04 (WO Operations) for operation context
- Multi-operation inspection workflow support
- Batch/lot quality tracking during production

**Deferred to Phase 2+ (Story 06.10b)**: See "Future Phases" section below.

---

## User Story

As a **QA Inspector**, I want to **inspect Work-In-Progress at critical production operations, recording test results and determining pass/fail status** so that **defects are caught early in the production process, preventing waste and ensuring product quality before final production**.

As a **QA Manager**, I want to **view in-process inspection queues by work order and operation, assign inspectors, and review inspection results** so that **I can ensure timely quality checks at each production stage and maintain compliance records**.

As a **Production Operator**, I want to **be notified when my WO operation requires QA inspection and see the inspection status** so that **I know when to pause production for quality verification and when I can proceed to the next operation**.

---

## Scope

**In scope (this story)**
- `quality_inspections` table reuse with type='in_process'
- Auto-create inspection on WO operation completion (configurable)
- GET /api/quality/inspections (list with type='in_process' filter)
- GET /api/quality/inspections/:id (inspection detail)
- POST /api/quality/inspections (manual creation with WO reference)
- POST /api/quality/inspections/:id/start (begin inspection)
- POST /api/quality/inspections/:id/assign (assign/reassign inspector)
- POST /api/quality/inspections/:id/complete (complete with result)
- GET /api/quality/inspections/in-process (in-process queue)
- GET /api/quality/inspections/wo/:woId (inspections by work order)
- GET /api/quality/inspections/operation/:operationId (inspections by operation)
- WO operation status consideration on inspection result
- Inspection queue page with WO/operation filters and sorting
- Inspection detail page with test results and WO context
- Start/Complete inspection workflow UI
- Inspector assignment modal
- Result determination logic (pass/fail/conditional)
- Integration with WO operation workflow
- Multi-operation batch inspection support

**Out of scope (this story)**
- Test results recording (story 06.6 - dependency)
- Operation quality checkpoints definition (story 06.19)
- Final inspection (story 06.11)
- Sampling plans integration (story 06.7)
- Scanner QA workflow (story 06.8)
- NCR auto-creation on failure (story 06.9)
- HACCP CCP monitoring (Phase 3 - story 06.23)
- Batch release gate (story 06.12)

---

## Future Phases (Not in MVP)

### Phase 2+ (Story 06.10b - In-Process Inspection Advanced)
- **Auto-create from operation completion** - Automatic inspection creation on specific operation completion
- **Sampling plan integration** - Use AQL-based sampling from story 06.7
- **Multi-sample inspections** - Multiple samples per batch at operation
- **Inspection scheduling** - Scheduled vs triggered inspections
- **Inspection templates per operation** - Pre-configured inspection types
- **Photo attachments** - Capture defect photos during inspection

### Phase 3
- **CCP monitoring integration** - In-process CCPs linked to inspections
- **Auto-NCR on critical failure** - Automatic NCR creation for critical failures
- **E-signature for completion** - FDA 21 CFR Part 11 compliant signatures
- **Inspection analytics** - Pass rate trends by operation/product
- **Real-time alerts** - Notify production on inspection failure

### Deferred to Other Stories
- **Test results recording** - Story 06.6 (Test Results Recording)
- **Operation quality checkpoints** - Story 06.19 (Operation Quality Checkpoints)
- **Checkpoint results & sign-off** - Story 06.20 (Checkpoint Results)
- **Quality holds** - Story 06.2 (Quality Holds CRUD)
- **NCR creation** - Story 06.9 (Basic NCR Creation)

---

## Dependencies

### Cross-Epic Dependencies

| Dependency | Story/Epic | Type | What It Provides | Status |
|------------|------------|------|------------------|--------|
| 01.1 | Org Context + RLS | HARD | organizations, users, roles tables | Ready |
| 02.1 | Products CRUD | HARD | products table for product reference | Ready |
| 02.7 | Routings CRUD | SOFT | routings table for operation context | Ready |
| 02.8 | Routing Operations | SOFT | routing_operations for checkpoint mapping | Ready |
| 03.10 | WO CRUD | HARD | work_orders table, WO reference | Ready |
| 03.12 | WO Operations | HARD | wo_operations table, operation reference | Ready |
| 04.2a | WO Start | HARD | WO status lifecycle | Ready |
| 04.3 | Operation Start/Complete | HARD | Operation status, timestamps | Ready |

### Within Epic Dependencies

| Dependency | Story | Type | What It Provides |
|------------|-------|------|------------------|
| 06.0 | Quality Settings | HARD | quality_settings for auto-create, defaults |
| 06.1 | Quality Status Types | HARD | QA status enum for updates |
| 06.3 | Product Specifications | HARD | quality_specifications for test parameters |
| 06.4 | Test Parameters | HARD | quality_spec_parameters for test criteria |
| 06.5 | Incoming Inspection | HARD | quality_inspections table, inspection patterns |

### Provides To (Downstream)

| Story | What This Provides |
|-------|-------------------|
| 06.6 | Test Results Recording - inspection_id reference |
| 06.11 | Final Inspection - inspection patterns, WO integration |
| 06.12 | Batch Release - inspection result for release gate |
| 06.17 | Quality Alerts - inspection result events |
| 06.19 | Operation Checkpoints - inspection linkage patterns |
| 06.20 | Checkpoint Results - inspection integration |

---

## Database Schema

### Reuses: quality_inspections Table (from Story 06.5)

The `quality_inspections` table created in story 06.5 supports in-process inspections with `inspection_type = 'in_process'`. This story adds WO operation-specific fields and patterns.

```sql
-- No new table needed - reuses quality_inspections from story 06.5
-- Key fields for in-process inspections:

-- inspection_type = 'in_process'
-- reference_type = 'wo' or 'wo_operation'
-- reference_id = work_order.id or wo_operation.id
-- wo_id = work_orders.id (direct reference)
-- wo_operation_id = wo_operations.id (operation reference)

-- Additional fields used by in-process:
-- batch_number from WO
-- product_id from WO output product
```

### Migration: Add wo_operation_id to quality_inspections

```sql
-- Migration: YYYYMMDDHHMMSS_add_wo_operation_to_inspections.sql

-- Add wo_operation_id column for in-process inspections
ALTER TABLE quality_inspections
ADD COLUMN wo_id UUID REFERENCES work_orders(id),
ADD COLUMN wo_operation_id UUID REFERENCES wo_operations(id);

-- Add indexes for WO-based queries
CREATE INDEX idx_inspections_wo ON quality_inspections(wo_id) WHERE wo_id IS NOT NULL;
CREATE INDEX idx_inspections_wo_operation ON quality_inspections(wo_operation_id) WHERE wo_operation_id IS NOT NULL;
CREATE INDEX idx_inspections_wo_type ON quality_inspections(org_id, wo_id, inspection_type)
    WHERE inspection_type = 'in_process';

-- Add combined index for pending in-process inspections by WO
CREATE INDEX idx_inspections_wo_pending ON quality_inspections(org_id, wo_id, status)
    WHERE inspection_type = 'in_process' AND status IN ('scheduled', 'in_progress');

-- =============================================================================
-- Function: Auto-create in-process inspection on WO operation completion
-- =============================================================================

CREATE OR REPLACE FUNCTION create_inprocess_inspection_on_operation_complete()
RETURNS TRIGGER AS $$
DECLARE
    v_settings RECORD;
    v_wo RECORD;
    v_spec_id UUID;
    v_inspection_number TEXT;
    v_routing_op RECORD;
BEGIN
    -- Only trigger on operation status change to 'completed'
    IF NEW.status = 'completed' AND (OLD.status IS NULL OR OLD.status != 'completed') THEN

        -- Get org_id from the work order
        SELECT wo.*, p.id as output_product_id
        INTO v_wo
        FROM work_orders wo
        JOIN products p ON p.id = wo.product_id
        WHERE wo.id = NEW.wo_id;

        -- Check if auto-create is enabled for in-process inspections
        SELECT * INTO v_settings
        FROM quality_settings
        WHERE org_id = v_wo.org_id;

        IF v_settings.auto_create_inspection_on_operation = true THEN

            -- Check if this operation requires inspection (from routing_operations)
            SELECT ro.* INTO v_routing_op
            FROM routing_operations ro
            WHERE ro.id = NEW.routing_operation_id
              AND ro.requires_quality_check = true;

            IF v_routing_op.id IS NOT NULL THEN

                -- Get active specification for product (if exists)
                SELECT id INTO v_spec_id
                FROM quality_specifications
                WHERE org_id = v_wo.org_id
                  AND product_id = v_wo.output_product_id
                  AND status = 'active'
                ORDER BY effective_date DESC
                LIMIT 1;

                -- Generate inspection number
                v_inspection_number := generate_inspection_number(v_wo.org_id, 'in_process');

                -- Create inspection record
                INSERT INTO quality_inspections (
                    org_id,
                    inspection_number,
                    inspection_type,
                    reference_type,
                    reference_id,
                    product_id,
                    spec_id,
                    wo_id,
                    wo_operation_id,
                    batch_number,
                    status,
                    scheduled_date,
                    priority,
                    created_by
                ) VALUES (
                    v_wo.org_id,
                    v_inspection_number,
                    'in_process',
                    'wo_operation',
                    NEW.id,
                    v_wo.output_product_id,
                    v_spec_id,
                    NEW.wo_id,
                    NEW.id,
                    v_wo.batch_number,
                    'scheduled',
                    CURRENT_DATE,
                    CASE
                        WHEN v_routing_op.is_critical THEN 'high'
                        ELSE 'normal'
                    END,
                    NEW.completed_by
                );

            END IF;
        END IF;
    END IF;

    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Create trigger on wo_operations table
-- Note: Add this trigger after Epic 04 wo_operations table is created
-- CREATE TRIGGER trigger_create_inprocess_inspection
--     AFTER UPDATE ON wo_operations
--     FOR EACH ROW
--     EXECUTE FUNCTION create_inprocess_inspection_on_operation_complete();

-- =============================================================================
-- Function: Update WO operation QA status on inspection completion
-- =============================================================================

CREATE OR REPLACE FUNCTION update_wo_operation_qa_on_inspection()
RETURNS TRIGGER AS $$
BEGIN
    -- Only trigger on inspection completion for in_process type
    IF NEW.status = 'completed'
       AND NEW.inspection_type = 'in_process'
       AND (OLD.status IS NULL OR OLD.status != 'completed') THEN

        -- Update WO operation QA status if operation reference exists
        IF NEW.wo_operation_id IS NOT NULL THEN
            UPDATE wo_operations
            SET qa_status = CASE NEW.result
                WHEN 'pass' THEN 'passed'
                WHEN 'fail' THEN 'failed'
                WHEN 'conditional' THEN 'conditional'
                ELSE 'pending'
            END,
            qa_inspection_id = NEW.id,
            updated_at = NOW()
            WHERE id = NEW.wo_operation_id;
        END IF;
    END IF;

    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_update_wo_operation_qa
    AFTER UPDATE ON quality_inspections
    FOR EACH ROW
    WHEN (NEW.inspection_type = 'in_process')
    EXECUTE FUNCTION update_wo_operation_qa_on_inspection();

-- =============================================================================
-- Add requires_quality_check to routing_operations (if not exists)
-- =============================================================================

ALTER TABLE routing_operations
ADD COLUMN IF NOT EXISTS requires_quality_check BOOLEAN DEFAULT false,
ADD COLUMN IF NOT EXISTS is_critical BOOLEAN DEFAULT false;

-- Add qa_status to wo_operations (if not exists)
ALTER TABLE wo_operations
ADD COLUMN IF NOT EXISTS qa_status TEXT DEFAULT 'pending'
    CHECK (qa_status IN ('pending', 'passed', 'failed', 'conditional', 'not_required')),
ADD COLUMN IF NOT EXISTS qa_inspection_id UUID REFERENCES quality_inspections(id);

-- Index for WO operations QA status queries
CREATE INDEX IF NOT EXISTS idx_wo_operations_qa_status
ON wo_operations(qa_status) WHERE qa_status != 'not_required';

-- =============================================================================
-- Add auto_create_inspection_on_operation to quality_settings (if not exists)
-- =============================================================================

ALTER TABLE quality_settings
ADD COLUMN IF NOT EXISTS auto_create_inspection_on_operation BOOLEAN DEFAULT false,
ADD COLUMN IF NOT EXISTS require_operation_qa_pass BOOLEAN DEFAULT false,
ADD COLUMN IF NOT EXISTS block_next_operation_on_fail BOOLEAN DEFAULT true;
```

---

## Acceptance Criteria (Given/When/Then)

### AC-1: In-Process Inspection Creation from WO Operation

```gherkin
Scenario: Auto-create inspection when operation completes (setting enabled)
  Given quality_settings.auto_create_inspection_on_operation = true
  And routing_operation.requires_quality_check = true
  And WO operation "OP-001" completes
  When wo_operation status changes to 'completed'
  Then inspection record created with:
    | Field | Value |
    | inspection_type | in_process |
    | reference_type | wo_operation |
    | reference_id | WO operation UUID |
    | wo_id | Work Order UUID |
    | wo_operation_id | WO operation UUID |
    | status | scheduled |
    | product_id | WO output product |
    | batch_number | WO batch number |
  And spec_id populated if active spec exists for product
  And inspection_number format is 'INS-IPR-2025-00001'

Scenario: No auto-create when operation doesn't require QA
  Given routing_operation.requires_quality_check = false
  When WO operation completes
  Then no inspection record created

Scenario: No auto-create when setting disabled
  Given quality_settings.auto_create_inspection_on_operation = false
  When WO operation completes
  Then no inspection record created
```

### AC-2: Manual In-Process Inspection Creation

```gherkin
Scenario: Create in-process inspection manually from WO
  Given user navigates to in-process inspection queue
  And clicks [+ New Inspection]
  When user selects:
    | Field | Value |
    | Work Order | WO-2025-00001 |
    | Operation | Mixing (Seq 2) |
    | Product | Auto-filled from WO |
    | Specification | QS-202512-001 (optional) |
    | Priority | High |
  And clicks [Create]
  Then inspection created with status = 'scheduled'
  And inspection_number auto-generated 'INS-IPR-YYYY-NNNNN'
  And wo_operation_id set to selected operation
  And success toast "Inspection INS-IPR-2025-00001 created"

Scenario: Create inspection from WO detail page
  Given user views WO detail page
  And WO has operations with qa_status = 'pending'
  When user clicks [Create QA Inspection] on operation row
  Then form pre-filled with WO, operation, product
  And user can adjust and submit

Scenario: Validation - Operation already has active inspection
  Given wo_operation has inspection with status = 'scheduled'
  When attempting to create another inspection for same operation
  Then warning "Operation already has a pending inspection (INS-IPR-2025-00001)"
  And user can choose to proceed or cancel

Scenario: Validation - WO must be in progress
  Given WO has status = 'released' (not started)
  When attempting to create in-process inspection
  Then error "Work Order must be in progress for in-process inspection"
```

### AC-3: In-Process Inspection Queue

```gherkin
Scenario: In-process inspection queue loads
  Given user navigates to Quality > Inspections > In-Process
  When page loads
  Then DataTable displays inspections with columns:
    | Column | Description |
    | Inspection # | Link to detail |
    | Work Order | WO number with link |
    | Operation | Operation name and sequence |
    | Product | Product name |
    | Batch | Batch number |
    | Status | Badge (scheduled/in_progress/completed) |
    | Priority | Badge with color |
    | Inspector | Assigned user name or "Unassigned" |
    | Actions | Start, Assign, View |
  And list loads within 500ms
  And pagination available (20 per page)

Scenario: Filter by Work Order
  Given in-process inspections exist for multiple WOs
  When user filters by Work Order = "WO-2025-00001"
  Then only inspections for that WO display

Scenario: Filter by operation
  Given inspections exist for various operations
  When user filters by Operation = "Mixing"
  Then only inspections for Mixing operations display

Scenario: Filter by status
  Given inspections exist with various statuses
  When user filters by status = 'scheduled'
  Then only scheduled inspections display

Scenario: Search by WO number or product
  Given inspections exist
  When user searches "WO-2025" or "Flour"
  Then matching inspections display
  And search debounced (300ms)
```

### AC-4: Inspection Detail with WO Context

```gherkin
Scenario: View in-process inspection detail
  Given inspection INS-IPR-2025-00001 exists
  When user navigates to /quality/inspections/INS-IPR-2025-00001
  Then page displays:
    | Section | Content |
    | Header | Inspection #, Status badge, Priority badge |
    | WO Context | WO number link, WO status, Operation name |
    | Operation | Operation sequence, name, description |
    | Product | Product name, code |
    | Batch | Batch number, production date |
    | Specification | Spec name/version with link (or "No spec") |
    | Assignment | Inspector name, assigned date |
    | Timing | Scheduled, Started, Completed dates |
    | Test Results | Grid of parameters and results (from 06.6) |
    | Actions | Based on status and permissions |
    | WO Link | Quick link to WO detail page |
    | Operation History | Previous operation QA results |

Scenario: View operation context
  Given inspection linked to wo_operation
  When viewing detail page
  Then operation card shows:
    | Field | Value |
    | Sequence | 2 |
    | Name | Mixing |
    | Machine | Mixer M-001 |
    | Started At | 2025-01-15 10:00:00 |
    | Completed At | 2025-01-15 10:45:00 |
    | Operator | John Doe |
    | Duration | 45 minutes |
```

### AC-5: Start In-Process Inspection

```gherkin
Scenario: Start inspection
  Given inspection with status = 'scheduled'
  And inspector_id = current user
  When user clicks [Start Inspection]
  Then status changes to 'in_progress'
  And started_at = now
  And user redirected to inspection detail page
  And test results form displayed

Scenario: Start inspection shows WO operation context
  Given inspection linked to WO operation
  When inspection started
  Then inspection detail shows operation information
  And recent operation parameters visible (temp, time, etc.)

Scenario: Cannot start if WO paused or cancelled
  Given WO has status = 'paused' or 'cancelled'
  When attempting to start inspection
  Then error "Cannot inspect - Work Order is [status]"
  And inspection remains scheduled
```

### AC-6: Complete In-Process Inspection

```gherkin
Scenario: Complete inspection with pass result
  Given inspection in_progress with all tests recorded
  And all test results status = 'pass'
  When user clicks [Complete Inspection]
  Then result determination modal shows:
    | Field | Value |
    | Suggested Result | PASS (all tests passed) |
    | Result Dropdown | Pass / Fail / Conditional |
    | Notes | Optional text field |
  And user confirms with result = 'pass'
  Then inspection.status = 'completed'
  And inspection.result = 'pass'
  And wo_operation.qa_status = 'passed'
  And success toast "Inspection completed - PASS"

Scenario: Complete with fail - production impact
  Given inspection completed with result = 'fail'
  And quality_settings.block_next_operation_on_fail = true
  Then wo_operation.qa_status = 'failed'
  And alert sent to Production Lead
  And next operation cannot start until resolved
  And prompt: "Create NCR for failed inspection?"

Scenario: Complete with conditional
  Given inspection completed with result = 'conditional'
  When user fills conditional details:
    | Field | Value |
    | Reason | pH slightly elevated |
    | Restrictions | Use within 24 hours |
    | Expires At | 2025-01-16 10:00:00 |
  Then wo_operation.qa_status = 'conditional'
  And production can continue with warning
```

### AC-7: WO Operation QA Status Integration

```gherkin
Scenario: WO operation shows QA status
  Given wo_operation has qa_status = 'passed'
  When viewing WO detail page
  Then operation row shows QA badge (green "Passed")
  And clicking badge links to inspection detail

Scenario: WO operation shows pending QA
  Given wo_operation has qa_status = 'pending'
  And inspection exists with status = 'scheduled'
  When viewing WO detail page
  Then operation row shows "QA Pending" badge (yellow)
  And [Create Inspection] button hidden (already exists)

Scenario: Next operation blocked on QA fail
  Given wo_operation seq 2 has qa_status = 'failed'
  And quality_settings.block_next_operation_on_fail = true
  When operator attempts to start operation seq 3
  Then error "Previous operation QA failed - resolve before continuing"
  And operation seq 3 remains 'pending'

Scenario: QA not required for operation
  Given routing_operation.requires_quality_check = false
  When WO operation completes
  Then wo_operation.qa_status = 'not_required'
  And no inspection created
  And next operation can proceed
```

### AC-8: Multi-Operation Inspection View

```gherkin
Scenario: View all inspections for a WO
  Given WO-2025-00001 has 3 operations with inspections
  When user clicks "View WO Inspections" or filters by WO
  Then all 3 inspections displayed grouped by operation sequence
  And shows operation name, inspection status, result
  And overall WO quality summary shown

Scenario: WO quality summary
  Given WO has 3 operations with inspections:
    | Operation | Inspection Status | Result |
    | Mixing (seq 1) | completed | pass |
    | Cooking (seq 2) | completed | pass |
    | Packing (seq 3) | in_progress | - |
  When viewing WO quality summary
  Then shows: "2/3 Operations Passed | 1 In Progress"

Scenario: Navigate between operation inspections
  Given viewing inspection for operation seq 2
  When user clicks "Previous Operation" or "Next Operation"
  Then navigates to inspection for seq 1 or seq 3
  And maintains WO context
```

### AC-9: Inspector Assignment

```gherkin
Scenario: Assign inspector to scheduled inspection
  Given inspection with status = 'scheduled' and inspector_id = NULL
  When QA Manager clicks [Assign]
  Then modal shows list of users with QA_INSPECTOR or QA_MANAGER role
  And user selects inspector
  And clicks [Assign]
  Then inspection.inspector_id updated
  And notification sent to assigned inspector
  And notification includes WO and operation context

Scenario: Self-assign from production context
  Given operator completes operation requiring QA
  And user is QA Inspector viewing WO detail
  When clicking [Self-Assign Inspection]
  Then inspector_id set to current user
  And can immediately start inspection
```

### AC-10: Production Integration Alerts

```gherkin
Scenario: Alert production on inspection completion
  Given inspection for operation seq 2 completed
  And result = 'pass'
  When inspection completed
  Then notification sent to Production Operator assigned to WO
  And notification: "QA Passed for Mixing - proceed to next operation"

Scenario: Alert production on inspection failure
  Given inspection for operation seq 2 completed
  And result = 'fail'
  When inspection completed
  Then alert sent to Production Lead
  And alert: "QA FAILED for Mixing on WO-2025-00001 - production blocked"
  And next operation start blocked

Scenario: Inspection aging alert
  Given inspection scheduled for > 2 hours without starting
  And quality_settings.inspection_sla_hours = 2
  When SLA exceeded
  Then alert sent to QA Manager
  And inspection flagged as "Overdue"
```

### AC-11: Permission Enforcement

```gherkin
Scenario: Production Operator can view but not create
  Given user with PROD_OPERATOR role
  When viewing in-process inspection queue
  Then can view inspections related to assigned WOs
  And [+ New Inspection] button hidden
  And can see inspection status on WO detail

Scenario: QA Inspector can inspect
  Given user with QA_INSPECTOR role
  When viewing inspection queue
  Then can create, start, record results, complete (pass/fail)
  And cannot approve conditional without QA_MANAGER

Scenario: QA Manager has full access
  Given user with QA_MANAGER role
  Then all actions available
  And can approve conditional results
  And can override suggested result
  And can delete scheduled inspections
```

### AC-12: Audit Trail

```gherkin
Scenario: All inspection actions logged
  Given any inspection state change
  When action completes
  Then quality_audit_log entry created with:
    | Field | Value |
    | entity_type | inspection |
    | entity_id | inspection.id |
    | action | create/update/start/complete/cancel/assign |
    | user_id | current user |
    | timestamp | now |
    | old_value | previous state (for updates) |
    | new_value | new state |
    | metadata | { wo_id, wo_operation_id } |

Scenario: WO operation QA status change logged
  Given inspection completed with result
  When wo_operation.qa_status updated
  Then audit log records QA status change
  And links to source inspection
```

### AC-13: RLS Policy Enforcement

```gherkin
Scenario: Org isolation on inspection list
  Given User A from Org A and User B from Org B
  And in-process inspections exist in both orgs
  When User A requests GET /api/quality/inspections/in-process
  Then only Org A inspections returned

Scenario: Cross-WO inspection access validation
  Given inspection belongs to WO in Org B
  When User A (Org A) requests inspection detail
  Then 404 Not Found returned

Scenario: WO reference validated on creation
  Given User A from Org A creates inspection
  And selects WO from Org B
  Then 400 Bad Request: "Invalid Work Order"
```

### AC-14: Performance Requirements

```gherkin
Scenario: In-process inspection queue performance
  Given 500 in-process inspections in organization
  When listing inspections with pagination
  Then response time < 500ms

Scenario: Inspection by WO query performance
  Given WO with 10 operations and inspections
  When querying inspections by WO ID
  Then response time < 300ms

Scenario: Inspection creation performance
  Given valid inspection data with WO reference
  When creating inspection
  Then operation completes < 300ms
  And WO operation qa_status updated < 100ms
```

---

## Implementation Notes

### API Endpoints

```typescript
// =============================================================================
// In-Process Inspection Endpoints
// =============================================================================

// GET /api/quality/inspections/in-process
// List in-process inspections with filters
interface InProcessListParams {
  wo_id?: string;
  wo_operation_id?: string;
  status?: 'scheduled' | 'in_progress' | 'completed' | 'cancelled';
  priority?: 'low' | 'normal' | 'high' | 'urgent';
  inspector_id?: string;
  product_id?: string;
  date_from?: string;
  date_to?: string;
  search?: string;
  sort_by?: 'inspection_number' | 'scheduled_date' | 'created_at' | 'priority';
  sort_order?: 'asc' | 'desc';
  page?: number;
  limit?: number;
}

// GET /api/quality/inspections/wo/:woId
// List all inspections for a Work Order
interface WOInspectionsResponse {
  wo: {
    id: string;
    wo_number: string;
    status: string;
    product_name: string;
    batch_number: string;
  };
  inspections: QualityInspection[];
  summary: {
    total_operations: number;
    inspections_completed: number;
    inspections_passed: number;
    inspections_failed: number;
    inspections_pending: number;
  };
}

// GET /api/quality/inspections/operation/:operationId
// Get inspection for specific operation
interface OperationInspectionResponse {
  operation: {
    id: string;
    sequence: number;
    name: string;
    status: string;
    started_at: string;
    completed_at: string;
    operator_name: string;
    qa_status: string;
  };
  inspection: QualityInspection | null;
  previous_operation_qa: {
    operation_name: string;
    result: string;
  } | null;
}

// POST /api/quality/inspections (for in-process)
interface CreateInProcessInspectionRequest {
  wo_id: string;
  wo_operation_id: string;
  product_id?: string;  // Auto-filled from WO if not provided
  spec_id?: string;
  batch_number?: string;  // Auto-filled from WO if not provided
  priority?: 'low' | 'normal' | 'high' | 'urgent';
  scheduled_date?: string;
  inspector_id?: string;
  notes?: string;
}

// POST /api/quality/inspections/:id/complete (extended for in-process)
interface CompleteInProcessInspectionRequest {
  result: 'pass' | 'fail' | 'conditional';
  result_notes?: string;
  defects_found?: number;
  major_defects?: number;
  minor_defects?: number;
  critical_defects?: number;

  // For conditional result
  conditional_reason?: string;
  conditional_restrictions?: string;
  conditional_expires_at?: string;

  // For failed result
  create_ncr?: boolean;
  block_next_operation?: boolean;  // Override default setting

  // Operation context
  process_parameters?: {
    parameter_name: string;
    measured_value: string;
    within_spec: boolean;
  }[];
}

interface CompleteInProcessInspectionResponse {
  inspection: QualityInspection;
  wo_operation_updated: boolean;
  wo_operation_qa_status: string;
  next_operation_blocked: boolean;
  ncr_id?: string;
  alert_sent_to?: string[];
}
```

### Validation Schemas (Zod)

```typescript
import { z } from 'zod';

export const createInProcessInspectionSchema = z.object({
  wo_id: z.string().uuid('Invalid Work Order ID'),
  wo_operation_id: z.string().uuid('Invalid Operation ID'),
  product_id: z.string().uuid('Invalid product ID').optional(),
  spec_id: z.string().uuid('Invalid specification ID').optional(),
  batch_number: z.string().max(100).optional(),
  priority: z.enum(['low', 'normal', 'high', 'urgent']).default('normal'),
  scheduled_date: z.string().regex(/^\d{4}-\d{2}-\d{2}$/).optional(),
  inspector_id: z.string().uuid().optional(),
  notes: z.string().max(2000).optional(),
});

export const completeInProcessInspectionSchema = z.object({
  result: z.enum(['pass', 'fail', 'conditional']),
  result_notes: z.string().max(2000).optional(),
  defects_found: z.number().int().min(0).default(0),
  major_defects: z.number().int().min(0).default(0),
  minor_defects: z.number().int().min(0).default(0),
  critical_defects: z.number().int().min(0).default(0),

  // Conditional fields
  conditional_reason: z.string().max(500).optional(),
  conditional_restrictions: z.string().max(1000).optional(),
  conditional_expires_at: z.string().datetime().optional(),

  // Control flags
  create_ncr: z.boolean().default(false),
  block_next_operation: z.boolean().optional(),

  // Process parameters captured
  process_parameters: z.array(z.object({
    parameter_name: z.string(),
    measured_value: z.string(),
    within_spec: z.boolean(),
  })).optional(),
}).refine(
  (data) => {
    if (data.result === 'conditional') {
      return data.conditional_reason && data.conditional_restrictions;
    }
    return true;
  },
  {
    message: 'Conditional reason and restrictions required for conditional result',
    path: ['conditional_reason'],
  }
);

export const inProcessListQuerySchema = z.object({
  wo_id: z.string().uuid().optional(),
  wo_operation_id: z.string().uuid().optional(),
  status: z.enum(['scheduled', 'in_progress', 'completed', 'cancelled']).optional(),
  priority: z.enum(['low', 'normal', 'high', 'urgent']).optional(),
  inspector_id: z.string().uuid().optional(),
  product_id: z.string().uuid().optional(),
  date_from: z.string().optional(),
  date_to: z.string().optional(),
  search: z.string().min(1).optional(),
  sort_by: z.enum(['inspection_number', 'scheduled_date', 'created_at', 'priority']).default('scheduled_date'),
  sort_order: z.enum(['asc', 'desc']).default('desc'),
  page: z.coerce.number().int().positive().default(1),
  limit: z.coerce.number().int().min(1).max(100).default(20),
});
```

### Service Layer

```typescript
// lib/services/in-process-inspection-service.ts

export class InProcessInspectionService {
  // ==========================================================================
  // CRUD Operations (extends InspectionService)
  // ==========================================================================

  /**
   * List in-process inspections with WO/operation filters
   */
  static async listInProcess(params: InProcessListParams): Promise<PaginatedResult<QualityInspection>>;

  /**
   * Get all inspections for a Work Order
   */
  static async getByWorkOrder(woId: string): Promise<WOInspectionsResponse>;

  /**
   * Get inspection for specific WO operation
   */
  static async getByOperation(operationId: string): Promise<OperationInspectionResponse>;

  /**
   * Create in-process inspection with WO validation
   */
  static async createInProcess(input: CreateInProcessInspectionInput): Promise<QualityInspection>;

  // ==========================================================================
  // Workflow Operations
  // ==========================================================================

  /**
   * Complete in-process inspection with WO operation update
   */
  static async completeInProcess(
    id: string,
    input: CompleteInProcessInspectionInput,
    userId: string
  ): Promise<CompleteInProcessResult>;

  /**
   * Update WO operation QA status based on inspection result
   */
  static async updateOperationQAStatus(
    operationId: string,
    result: 'pass' | 'fail' | 'conditional',
    inspectionId: string
  ): Promise<void>;

  /**
   * Check if next operation can start based on QA status
   */
  static async canStartNextOperation(woId: string, currentSequence: number): Promise<{
    canStart: boolean;
    blockedReason?: string;
    requiredAction?: string;
  }>;

  // ==========================================================================
  // WO Integration
  // ==========================================================================

  /**
   * Get WO quality summary (all operations QA status)
   */
  static async getWOQualitySummary(woId: string): Promise<{
    total_operations: number;
    qa_required: number;
    passed: number;
    failed: number;
    pending: number;
    conditional: number;
    overall_status: 'pass' | 'fail' | 'pending' | 'conditional';
  }>;

  /**
   * Create inspections for operations requiring QA
   * Called when WO starts or on-demand
   */
  static async createForWOOperations(woId: string, userId: string): Promise<QualityInspection[]>;

  // ==========================================================================
  // Auto-Creation
  // ==========================================================================

  /**
   * Check if operation requires inspection
   */
  static async operationRequiresInspection(operationId: string): Promise<boolean>;

  /**
   * Create inspection on operation completion
   * Called by trigger or service
   */
  static async createForOperationCompletion(
    operationId: string,
    userId: string
  ): Promise<QualityInspection | null>;

  // ==========================================================================
  // Alerts & Notifications
  // ==========================================================================

  /**
   * Send inspection completion notification to production
   */
  static async notifyProductionOnCompletion(
    inspectionId: string,
    result: string
  ): Promise<void>;

  /**
   * Check for overdue inspections and send alerts
   */
  static async checkAndAlertOverdueInspections(): Promise<void>;
}
```

### Frontend Components

```
apps/frontend/app/(authenticated)/quality/
  inspections/
    page.tsx                       -- Inspections list (all types)
    in-process/
      page.tsx                     -- In-process inspection queue
    wo/
      [woId]/
        page.tsx                   -- Inspections for specific WO
    [id]/
      page.tsx                     -- Inspection detail

apps/frontend/app/(authenticated)/production/
  work-orders/
    [id]/
      page.tsx                     -- WO detail with QA status per operation

components/quality/inspections/in-process/
  InProcessInspectionDataTable.tsx  -- DataTable with WO/operation filters
  InProcessFilters.tsx              -- Filter panel (WO, operation, status)
  WOInspectionSummary.tsx           -- Summary card for WO quality
  OperationQABadge.tsx              -- QA status badge for operation
  OperationInspectionCard.tsx       -- Inspection card with operation context
  InProcessInspectionDetail.tsx     -- Detail view with WO context
  WOContextPanel.tsx                -- WO and operation information panel
  OperationQATimeline.tsx           -- Timeline of operation QA results
  CreateInProcessModal.tsx          -- Create inspection with WO/op selection
  WOOperationSelector.tsx           -- WO and operation dropdown selector
  QAResultImpactAlert.tsx           -- Alert showing production impact
  NextOperationBlockedAlert.tsx     -- Warning when next op blocked

components/production/
  OperationQAStatusBadge.tsx        -- QA badge on operation card
  OperationQAActions.tsx            -- QA actions (create/view inspection)
  WOQualitySummaryCard.tsx          -- Overall WO quality status
```

### UI Component Details

**InProcessInspectionDataTable.tsx**
- ShadCN DataTable pattern
- Columns: Inspection #, WO, Operation, Product, Batch, Status, Priority, Inspector, Actions
- Row click navigates to detail
- Inline actions: Start, Assign, View
- WO column links to WO detail
- Operation shows sequence + name
- Priority badge colors: urgent=red, high=orange, normal=blue, low=gray
- Grouping by WO optional

**WOContextPanel.tsx**
- Three-section layout:
  - WO Info: Number, Status, Product, Batch
  - Operation Info: Sequence, Name, Machine, Duration
  - Previous QA: Last operation QA result (if any)
- Quick link to WO detail page
- Shows overall WO quality status

**OperationQATimeline.tsx**
- Vertical timeline of all WO operations
- Each operation shows: sequence, name, QA status badge
- Current inspection highlighted
- Click operation to view/create inspection
- Shows blocked operations if QA failed

**QAResultImpactAlert.tsx**
- Displayed in complete modal for fail/conditional
- Shows: "Failing this inspection will block operation [next op name]"
- For conditional: "Production can continue with restrictions"
- Override checkbox (QA Manager only)

---

## Key Business Rules

1. **WO Status Prerequisite**: In-process inspection can only be created for WO with status='in_progress'
2. **Operation Linkage Required**: In-process inspections must link to a wo_operation
3. **Auto-Create on Operation Complete**: If setting enabled and routing operation requires QA, inspection auto-created
4. **QA Status Propagation**: Inspection result updates wo_operation.qa_status automatically
5. **Next Operation Blocking**: If block_next_operation_on_fail=true, failed QA prevents next operation start
6. **One Active Inspection per Operation**: Prevent duplicate inspections for same operation (warn but allow override)
7. **Conditional Requires Manager**: Conditional approval requires QA_MANAGER role
8. **Production Notification**: Production team notified on inspection completion (pass/fail)
9. **Audit Trail Required**: All status changes, WO integration events logged
10. **Specification Optional in MVP**: Inspection can complete without linked specification (manual pass/fail)
11. **Operation Context Preserved**: Inspection captures operation parameters (temp, time, etc.) for reference

---

## Deliverables

### Database
- [ ] Migration: Add `wo_id`, `wo_operation_id` to quality_inspections
- [ ] Migration: Add `qa_status`, `qa_inspection_id` to wo_operations
- [ ] Migration: Add `requires_quality_check`, `is_critical` to routing_operations
- [ ] Migration: Add quality settings columns for in-process
- [ ] Function: `create_inprocess_inspection_on_operation_complete()` trigger function
- [ ] Function: `update_wo_operation_qa_on_inspection()` trigger
- [ ] All performance indexes

### API Routes
- [ ] `GET /api/quality/inspections/in-process` - In-process queue with filters
- [ ] `GET /api/quality/inspections/wo/:woId` - Inspections by WO
- [ ] `GET /api/quality/inspections/operation/:operationId` - Inspection by operation
- [ ] `POST /api/quality/inspections` - Create in-process inspection (extended)
- [ ] `POST /api/quality/inspections/:id/complete` - Complete with WO update

### Service Layer
- [ ] `InProcessInspectionService.listInProcess()` - List with WO filters
- [ ] `InProcessInspectionService.getByWorkOrder()` - WO inspections with summary
- [ ] `InProcessInspectionService.getByOperation()` - Operation inspection detail
- [ ] `InProcessInspectionService.createInProcess()` - Create with WO validation
- [ ] `InProcessInspectionService.completeInProcess()` - Complete with WO update
- [ ] `InProcessInspectionService.updateOperationQAStatus()` - Update operation QA
- [ ] `InProcessInspectionService.canStartNextOperation()` - Block check
- [ ] `InProcessInspectionService.getWOQualitySummary()` - WO quality summary
- [ ] `InProcessInspectionService.notifyProductionOnCompletion()` - Notifications

### Validation
- [ ] `createInProcessInspectionSchema`
- [ ] `completeInProcessInspectionSchema`
- [ ] `inProcessListQuerySchema`

### Frontend
- [ ] In-process inspection queue page
- [ ] WO inspections page
- [ ] Inspection detail with WO context
- [ ] Create in-process inspection modal
- [ ] WO/Operation selector components
- [ ] Operation QA status badge
- [ ] WO quality summary card
- [ ] Operation QA timeline
- [ ] QA result impact alert
- [ ] Production integration components

### Tests
- [ ] Unit tests: InProcessInspectionService methods (>80% coverage)
- [ ] Integration tests: All API endpoints
- [ ] WO operation QA status update tests
- [ ] Next operation blocking tests
- [ ] Auto-creation trigger tests
- [ ] RLS tests: Multi-tenancy isolation
- [ ] E2E: Full in-process inspection workflow

---

## Test Strategy

### Unit Tests

```typescript
describe('InProcessInspectionService', () => {
  describe('createInProcess', () => {
    it('creates inspection with correct WO reference', async () => {});
    it('validates WO is in progress', async () => {});
    it('validates WO operation exists', async () => {});
    it('warns if operation has active inspection', async () => {});
    it('links specification if found for product', async () => {});
    it('auto-fills product and batch from WO', async () => {});
  });

  describe('completeInProcess', () => {
    it('updates wo_operation.qa_status on pass', async () => {});
    it('updates wo_operation.qa_status on fail', async () => {});
    it('blocks next operation on fail if setting enabled', async () => {});
    it('handles conditional result', async () => {});
    it('creates NCR if requested', async () => {});
    it('sends production notification', async () => {});
  });

  describe('canStartNextOperation', () => {
    it('allows start when previous QA passed', async () => {});
    it('blocks when previous QA failed', async () => {});
    it('allows when previous QA is not_required', async () => {});
    it('blocks when previous QA pending', async () => {});
    it('respects setting override', async () => {});
  });

  describe('getWOQualitySummary', () => {
    it('calculates correct counts', async () => {});
    it('returns overall_status pass when all pass', async () => {});
    it('returns overall_status fail when any fail', async () => {});
    it('returns overall_status pending when any pending', async () => {});
  });

  describe('operationRequiresInspection', () => {
    it('returns true when routing_operation.requires_quality_check', async () => {});
    it('returns false when not required', async () => {});
    it('checks routing_operation through wo_operation', async () => {});
  });
});
```

### Integration Tests

```typescript
describe('In-Process Inspections API', () => {
  describe('GET /api/quality/inspections/in-process', () => {
    it('returns only in_process type inspections', async () => {});
    it('filters by WO correctly', async () => {});
    it('filters by operation correctly', async () => {});
    it('respects RLS for org isolation', async () => {});
    it('paginates correctly', async () => {});
  });

  describe('GET /api/quality/inspections/wo/:woId', () => {
    it('returns all inspections for WO', async () => {});
    it('includes quality summary', async () => {});
    it('returns 404 for cross-org WO', async () => {});
  });

  describe('POST /api/quality/inspections (in-process)', () => {
    it('creates with WO and operation reference', async () => {});
    it('validates WO is in_progress', async () => {});
    it('returns 400 for invalid WO', async () => {});
    it('returns 400 for invalid operation', async () => {});
  });

  describe('POST /api/quality/inspections/:id/complete (in-process)', () => {
    it('updates wo_operation.qa_status', async () => {});
    it('blocks next operation on fail', async () => {});
    it('sends production notification', async () => {});
    it('creates NCR on request', async () => {});
  });
});
```

### E2E Tests

```typescript
describe('In-Process Inspection Workflow', () => {
  it('complete workflow: create -> assign -> start -> record results -> complete -> verify WO update', async () => {
    // 1. Start WO and complete operation
    // 2. Verify inspection auto-created (or create manually)
    // 3. Assign inspector
    // 4. Start inspection
    // 5. Record test results (story 06.6)
    // 6. Complete with pass result
    // 7. Verify wo_operation.qa_status = 'passed'
    // 8. Verify next operation can start
    // 9. Verify inspection in completed list
  });

  it('fail inspection and verify operation blocked', async () => {
    // 1. Create and start in-process inspection
    // 2. Record failing test result
    // 3. Complete with fail
    // 4. Verify wo_operation.qa_status = 'failed'
    // 5. Verify next operation blocked
    // 6. Verify production alert sent
  });

  it('WO quality summary updates correctly', async () => {
    // 1. WO with 3 operations requiring QA
    // 2. Complete first inspection - pass
    // 3. Verify summary: 1 passed, 2 pending
    // 4. Complete second inspection - fail
    // 5. Verify summary shows overall fail
  });

  it('view inspections from WO detail page', async () => {
    // 1. Navigate to WO detail
    // 2. See operation QA badges
    // 3. Click to view inspection detail
    // 4. Navigate between operation inspections
  });
});
```

---

## Definition of Done

### Database
- [ ] `wo_id`, `wo_operation_id` columns added to quality_inspections
- [ ] `qa_status`, `qa_inspection_id` columns added to wo_operations
- [ ] `requires_quality_check`, `is_critical` columns added to routing_operations
- [ ] Quality settings extended for in-process config
- [ ] All indexes created for performance
- [ ] Triggers for auto-create and QA status update work
- [ ] RLS policies enforce org isolation

### API
- [ ] All endpoints return correct HTTP status codes
- [ ] Validation errors return 400 with detailed messages
- [ ] Cross-tenant access returns 404
- [ ] Response times:
  - In-process list: < 500ms
  - WO inspections: < 300ms
  - Create/Complete: < 300ms
  - WO operation update: < 100ms

### Service
- [ ] Complete workflow: create -> assign -> start -> complete
- [ ] WO operation QA status updated automatically on completion
- [ ] Next operation blocking works correctly
- [ ] Result determination logic works correctly
- [ ] Production notifications sent
- [ ] Audit trail created for all actions

### Frontend
- [ ] In-process inspection queue displays correctly
- [ ] WO inspections page shows all operations with QA
- [ ] Inspection detail page shows WO/operation context
- [ ] Create modal with WO/operation selection works
- [ ] Operation QA badges display on WO detail
- [ ] WO quality summary card works
- [ ] Operation QA timeline works
- [ ] QA impact alerts display correctly
- [ ] Filters and search work
- [ ] Pagination works

### Testing
- [ ] Unit tests: >80% coverage on service
- [ ] Integration tests: All endpoints covered
- [ ] WO operation QA update tests passing
- [ ] Operation blocking tests passing
- [ ] RLS tests: Multi-tenancy verified
- [ ] E2E tests: Full workflow passing

### Integration
- [ ] Works with story 06.5 (Incoming Inspection patterns)
- [ ] Works with story 06.6 (Test Results Recording)
- [ ] Works with Epic 04 (WO operations)
- [ ] Works with Epic 03 (Work Orders)

---

## Risk Assessment

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| WO operation status race condition | HIGH | MEDIUM | Database transaction, optimistic locking |
| Auto-create trigger complexity | MEDIUM | MEDIUM | Thorough trigger testing, fallback to manual |
| Production workflow disruption | HIGH | LOW | Clear communication, gradual rollout |
| Permission complexity (QA + Production) | MEDIUM | MEDIUM | Clear role definitions, comprehensive tests |
| Performance with many WO inspections | MEDIUM | LOW | Proper indexes, pagination, caching |
| Cross-module dependency on Epic 04 | HIGH | LOW | Clear interface contracts, mock services |

---

## Integration Points with Epic 04 (Production)

### Data Flow

```
+-------------+     +----------------+     +----------------+
|   WO Start  | --> |   Operation    | --> |   Operation    |
|   (04.2a)   |     |   Start        |     |   Complete     |
+-------------+     |   (04.3)       |     |   (04.3)       |
                    +----------------+     +----------------+
                           |                      |
                           |     If requires_quality_check = true
                           |                      |
                           v                      v
                    +----------------+     +----------------+
                    |   qa_status =  |     | Auto-create    |
                    |   'pending'    |     | Inspection     |
                    +----------------+     +----------------+
                                                 |
                                                 v
                                          +----------------+
                                          | In-Process     |
                                          | Inspection     |
                                          | Workflow       |
                                          +----------------+
                                                 |
                                          Complete (pass/fail)
                                                 |
                                                 v
                                          +----------------+
                                          | Update         |
                                          | wo_operation   |
                                          | qa_status      |
                                          +----------------+
                                                 |
                              +------------------+------------------+
                              |                                     |
                       If PASS                               If FAIL
                              |                                     |
                              v                                     v
                    +----------------+                    +----------------+
                    | Next Operation |                    | Next Op        |
                    | Can Start      |                    | BLOCKED        |
                    +----------------+                    +----------------+
```

### Event Integration

| Event | Producer | Consumer | Action |
|-------|----------|----------|--------|
| `wo_operation.completed` | Epic 04 | Quality Module | Create in-process inspection (if required) |
| `inspection.completed` | Quality Module | Epic 04 | Update wo_operation.qa_status |
| `inspection.failed` | Quality Module | Epic 04 | Block next operation, alert production |
| `wo_operation.starting` | Epic 04 | Quality Module | Check if previous QA passed |

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-12-16 | Initial story creation with comprehensive WO integration | OPUS |

---

**Document Status**: Ready for Implementation
**Created**: 2025-12-16
**Lines**: ~1400
**Complexity**: L (Large)
**Phase**: 2 (In-Process & Final)
