# Epic 04 Production Module - Story Creation Brief

**Date:** 2025-12-16
**Author:** ARCHITECT-AGENT
**Status:** READY FOR STORY CREATION
**Target Audience:** Story-writing agents (DEV-AGENT, TECH-WRITER)

---

## Executive Summary

This brief provides comprehensive guidance for creating Epic 04 (Production Module) stories. The Production Module is the **shop floor execution layer** of MonoPilot, handling Work Order execution, material consumption, output registration, and OEE tracking.

**Key Statistics:**
- PRD Lines: ~1,700
- Functional Requirements: 27 total (FR-PROD-001 to FR-PROD-022g)
- Phase 0 (MVP Core): 7 stories (no LP dependency)
- Phase 1 (Full Production): 10 stories (requires Epic 05)
- Phase 2 (OEE): 11 stories
- Architecture: `/docs/1-BASELINE/architecture/modules/production.md`
- PRD: `/docs/1-BASELINE/product/modules/production.md`

**CRITICAL CONSTRAINT:** Material consumption and output registration require License Plates (Epic 05). This brief defines a phase split strategy to allow parallel development.

---

## 1. Story Breakdown Strategy

### 1.1 Major Feature Areas

| Area | PRD Section | FRs | Phase 0 Stories | Phase 1 Stories | Phase 2 Stories |
|------|-------------|-----|-----------------|-----------------|-----------------|
| **Dashboard** | Section 1 | FR-001 | 04.1 | - | - |
| **WO Execution** | Section 2-5 | FR-002 to 005 | 04.2a, 04.2b, 04.2c | - | - |
| **Operations** | Section 6 | FR-004 | 04.3 | - | - |
| **Consumption** | Section 7-10 | FR-006 to 010 | - | 04.6a-e | - |
| **Output** | Section 11-15 | FR-011 to 015 | - | 04.7a-d | - |
| **Reservations** | Section 16 | FR-016 | - | 04.8 | - |
| **Settings** | Section 17 | FR-017 | 04.5 | - | - |
| **OEE** | Section 18-22 | FR-018 to 022 | - | - | 04.9a-d, 04.10a-g |
| **Yield** | Section 14 | FR-014 | 04.4 | - | - |

### 1.2 Stories Requiring Phase Split

Apply phase split pattern from `PHASE-SPLIT-PROPOSAL.md`:

| Story | Split Recommendation | Rationale |
|-------|---------------------|-----------|
| **04.2 WO Lifecycle** | 04.2a (Start), 04.2b (Pause/Resume), 04.2c (Complete) | Logical separation, allows incremental delivery |
| **04.6 Consumption** | 04.6a (Desktop), 04.6b (Scanner), 04.6c (1:1), 04.6d (Correction), 04.6e (Over-consumption) | Each is independent feature |
| **04.7 Output** | 04.7a (Desktop), 04.7b (Scanner), 04.7c (By-products), 04.7d (Multiple) | Each is independent feature |
| **04.9 OEE** | 04.9a (Calculation), 04.9b (Downtime), 04.9c (Machine), 04.9d (Shifts) | Technical separation |
| **04.10 Reports** | 04.10a through 04.10g | Each report is standalone |

### 1.3 Stories NOT Requiring Split

| Story | Reason | Complexity |
|-------|--------|------------|
| 04.1 | Dashboard - focused scope | M |
| 04.3 | Operations - focused scope | M |
| 04.4 | Yield Tracking - focused scope | S |
| 04.5 | Settings - configuration only | M |
| 04.8 | Reservations - single domain | L |

---

## 2. MVP Scope Definition

### 2.1 Phase 0 MVP Core (NO LP Dependency)

These stories can be implemented immediately after Epic 03 WO stories:

| Story | Name | FRs | Enables | Complexity |
|-------|------|-----|---------|------------|
| 04.5 | Production Settings | FR-017 | All production features | M |
| 04.1 | Production Dashboard | FR-001 | Visibility into shop floor | M |
| 04.2a | WO Start | FR-002 | Begin production | M |
| 04.2b | WO Pause/Resume | FR-003 | Interruption handling | S |
| 04.2c | WO Complete | FR-005 | Close production | M |
| 04.3 | Operation Start/Complete | FR-004 | Step tracking | M |
| 04.4 | Yield Tracking | FR-014 | Performance metrics | S |

**Total Phase 0 Stories: 7**
**Estimated Days: 10-14**

**Why This Works Without LPs:**
- Dashboard shows WO status (from Epic 03 work_orders table)
- WO lifecycle updates status field only
- Operations track time and yield without material transactions
- Settings configure toggles that Phase 1 will use

### 2.2 Phase 1 Full Production (REQUIRES Epic 05)

These stories require the `license_plates` table from Epic 05:

| Story | Name | FRs | Why Requires LP |
|-------|------|-----|-----------------|
| 04.6a | Consumption Desktop | FR-006 | Consumes FROM LPs |
| 04.6b | Consumption Scanner | FR-007 | Scans LP barcodes |
| 04.6c | 1:1 Consumption | FR-008 | Full LP consumption |
| 04.6d | Consumption Correction | FR-009 | Reverses LP transactions |
| 04.6e | Over-Consumption Control | FR-010 | Tracks LP usage vs requirements |
| 04.7a | Output Desktop | FR-011 | Creates new LPs |
| 04.7b | Output Scanner | FR-012 | Prints LP labels |
| 04.7c | By-Product Registration | FR-013 | Creates by-product LPs |
| 04.7d | Multiple Outputs | FR-015 | Multiple LP creation |
| 04.8 | Material Reservations | FR-016 | Reserves specific LPs |

**Total Phase 1 Stories: 10**
**Estimated Days: 18-24**
**Prerequisite: Epic 05 license_plates + lp_genealogy tables**

### 2.3 Phase 2 OEE & Analytics

These stories can proceed after Phase 1:

| Story | Name | FRs | Notes |
|-------|------|-----|-------|
| 04.9a | OEE Calculation | FR-018 | A x P x Q formula |
| 04.9b | Downtime Tracking | FR-019 | Categorized downtime |
| 04.9c | Machine Integration | FR-020 | Manual counters |
| 04.9d | Shift Management | FR-021 | Shift configuration |
| 04.10a | OEE Summary Report | FR-022a | OEE analytics |
| 04.10b | Downtime Analysis Report | FR-022b | Pareto charts |
| 04.10c | Yield Analysis Report | FR-022c | Trend analysis |
| 04.10d | Production Output Report | FR-022d | Output metrics |
| 04.10e | Material Consumption Report | FR-022e | Variance analysis |
| 04.10f | Quality Rate Report | FR-022f | QA statistics |
| 04.10g | WO Completion Report | FR-022g | On-time analysis |

**Total Phase 2 Stories: 11**
**Estimated Days: 14-18**

---

## 3. Story Template

### 3.1 Standard Story Structure

All Epic 04 stories should follow this template:

```markdown
# 04.X - [Story Title]

**Priority**: P0 (MVP) | P1 (Phase 1) | P2 (Phase 2)
**Story Points**: S (1-2 days) | M (3-4 days) | L (5-7 days)
**Type:** backend | frontend | backend + frontend | scanner

**State:** ready
**Primary PRD:** `docs/1-BASELINE/product/modules/production.md` (FR-PROD-XXX)
**Architecture:** `docs/1-BASELINE/architecture/modules/production.md`
**UX Wireframes:** PRD-XXX (if available)

---

## MVP Scope

[Describe what is in this story's MVP scope]

---

## LP Dependency Status

[State if this story requires Epic 05 License Plates]
- [ ] NO LP dependency - can proceed immediately
- [ ] REQUIRES Epic 05 - defer to Phase 1

---

## Goal

[1-2 sentences describing the objective]

## User Story

As a **[production operator/manager]**, I want **[action]** so that **[benefit]**.

## Scope

**In scope (this story)**
- [Specific features]

**Out of scope (this story)**
- [What's NOT included, reference other stories]

## Dependencies

- **01.X** - [Description]
- **03.X** - [Description]
- **05.X** - [Description if LP dependency]

## Acceptance Criteria (Given/When/Then)

### AC-1: [Feature Name]

**Given** [precondition]
**When** [action]
**Then** [expected result]

[Repeat for all ACs - aim for 5-10 ACs per story]

## Scanner UI Requirements (if applicable)

### Touch Targets
- Minimum 48x48 pixels for all buttons
- Large number pad for quantity input

### Audio Feedback
- Success tone on valid scan
- Error beep on invalid scan
- Confirmation sound on submission

### Label Printing
- ZPL format for Zebra printers
- Auto-print on output registration
- Include: LP barcode, product, qty, batch, expiry

## Implementation Notes

### API Endpoints

```typescript
// List endpoints with request/response types
POST /api/production/work-orders/:id/[action]
GET /api/production/[resource]
```

### Database

```sql
-- Reference tables from architecture doc
-- Include any migration notes
```

### Frontend Components

```
app/(authenticated)/production/[route]/
  components/
    [ComponentName].tsx

app/(authenticated)/scanner/[workflow]/
  components/
    [ScannerComponentName].tsx
```

### Services

```typescript
// lib/services/[resource]-service.ts
export async function [operation](): Promise<[Type]>
```

### Validation (Zod)

```typescript
const [schema]Schema = z.object({
  // Fields
});
```

### Key Business Rules

1. [Rule 1]
2. [Rule 2]

## Deliverables

- API routes: [list endpoints]
- Components: [list components]
- Services: [list services]
- Tests: [describe test coverage]

## Definition of Done

- [ ] [Checkbox items]
- [ ] API tests passing (>80% coverage)
- [ ] E2E smoke test for critical path
- [ ] Performance: [specific targets]
- [ ] Scanner: Touch targets verified, audio tested

---

## Future Phases (Not in This Story)

### Phase 1
- [Feature] - Brief description

### Phase 2
- [Feature] - Brief description

**Implementation**: See Epic 04.0 "Future Feature Handling" section.

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | YYYY-MM-DD | Initial story | [Agent] |
```

### 3.2 Required Sections for Production Stories

Every story MUST have:
1. **MVP Scope** - Clear boundaries
2. **LP Dependency Status** - Explicit statement
3. **User Story** - As a / I want / So that
4. **Scanner UI Requirements** - For scanner stories (04.6b, 04.7b)
5. **Acceptance Criteria** - Given/When/Then format (match PRD ACs)
6. **Key Business Rules** - From PRD Business Rules section
7. **Definition of Done** - Checkboxes
8. **Future Phases** - Deferred features

### 3.3 Complexity Guidelines

| Complexity | Days | When to Use | Model |
|------------|------|-------------|-------|
| S (Small) | 1-2 | Single feature, simple UI | sonnet |
| M (Medium) | 3-4 | Feature + relationships, moderate UI | sonnet |
| L (Large) | 5-7 | Complex logic, scanner UI, multiple entities | opus |

---

## 4. Dependency Map

### 4.1 Story Dependencies Within Epic 04

```
                    +-------------------+
                    | 04.5 Settings     |
                    +--------+----------+
                             |
         +-------------------+-------------------+
         |                   |                   |
         v                   v                   v
+----------------+  +----------------+  +----------------+
| 04.1 Dashboard |  | 04.2a WO Start |  | 04.3 Operations|
+----------------+  +--------+-------+  +--------+-------+
                             |                   |
         +-------------------+                   |
         |                   |                   |
         v                   v                   v
+----------------+  +----------------+  +----------------+
| 04.2b Pause/   |  | 04.2c Complete |  | 04.4 Yield     |
| Resume         |  |                |  | Tracking       |
+----------------+  +----------------+  +----------------+
         |                   |
         |    +--------------+--------------+
         |    |                             |
         v    v                             v
================== EPIC 05 LP BARRIER ==================
         |    |                             |
         v    v                             v
+----------------+  +----------------+  +----------------+
| 04.6a Consume  |  | 04.7a Output   |  | 04.8 Material  |
| Desktop        |  | Desktop        |  | Reservations   |
+--------+-------+  +--------+-------+  +----------------+
         |                   |
         v                   v
+----------------+  +----------------+
| 04.6b Consume  |  | 04.7b Output   |
| Scanner        |  | Scanner        |
+--------+-------+  +--------+-------+
         |                   |
         v                   v
+----------------+  +----------------+
| 04.6c 1:1      |  | 04.7c By-      |
| 04.6d Correct  |  | Products       |
| 04.6e Over     |  | 04.7d Multiple |
+----------------+  +----------------+
                             |
================== PHASE 1 COMPLETE ==================
                             |
                             v
                    +----------------+
                    | 04.9d Shifts   |
                    +--------+-------+
                             |
         +-------------------+-------------------+
         |                   |                   |
         v                   v                   v
+----------------+  +----------------+  +----------------+
| 04.9b Downtime |  | 04.9a OEE Calc |  | 04.9c Machine  |
+----------------+  +----------------+  +----------------+
                             |
                             v
                    +----------------+
                    | 04.10a-g       |
                    | Reports        |
                    +----------------+
```

### 4.2 External Dependencies

| Epic 04 Story | From Epic 01 | From Epic 02 | From Epic 03 | From Epic 05 |
|---------------|--------------|--------------|--------------|--------------|
| 04.5 Settings | 01.1 (RLS) | - | - | - |
| 04.1 Dashboard | 01.1 | - | 03.10 (WOs) | - |
| 04.2a WO Start | 01.11 (Lines) | - | 03.10, 03.11a | - |
| 04.2b Pause | - | - | 03.10 | - |
| 04.2c Complete | - | - | 03.10, 03.11a, 03.12 | - |
| 04.3 Operations | 01.10 (Machines) | - | 03.12 (wo_operations) | - |
| 04.4 Yield | - | - | 03.10, 03.11a | - |
| **04.6a Consume** | - | 02.1 (Products) | 03.11a (wo_materials) | **05.1 (LPs)** |
| **04.7a Output** | 01.9 (Locations) | 02.1 (Products) | 03.10 | **05.1 (LPs)** |
| **04.8 Reservations** | - | - | 03.11a | **05.1 (LPs)** |
| 04.9a OEE | 01.10, 01.11 | - | - | - |
| 04.9d Shifts | 01.1 | - | - | - |

### 4.3 LP Dependency Summary

**Stories that DO NOT require LPs (Phase 0):**
- 04.1 Dashboard
- 04.2a, 04.2b, 04.2c WO Lifecycle
- 04.3 Operations
- 04.4 Yield Tracking
- 04.5 Settings

**Stories that REQUIRE LPs (Phase 1):**
- 04.6a-e Consumption (ALL)
- 04.7a-d Output (ALL)
- 04.8 Reservations

**Stories that can proceed after Phase 1 (Phase 2):**
- 04.9a-d OEE
- 04.10a-g Reports

---

## 5. Agent Assignment Strategy

### 5.1 Parallel Development Waves

**Wave 1 (Phase 0 Foundation) - Days 1-4**

| Story | Agent | Model | Days | Notes |
|-------|-------|-------|------|-------|
| 04.5 Production Settings | BACKEND-DEV | sonnet | 2 | Configure first |
| 04.1 Production Dashboard | FULLSTACK-DEV | sonnet | 3 | Parallel with 04.5 |

**Wave 2 (Phase 0 WO Lifecycle) - Days 4-8**

| Story | Agent | Model | Days | Depends On |
|-------|-------|-------|------|------------|
| 04.2a WO Start | FULLSTACK-DEV | sonnet | 2 | 04.5 |
| 04.3 Operation Start/Complete | FULLSTACK-DEV | sonnet | 3 | 04.5 |
| 04.4 Yield Tracking | FRONTEND-DEV | sonnet | 2 | 04.2a |

**Wave 3 (Phase 0 Complete) - Days 8-10**

| Story | Agent | Model | Days | Depends On |
|-------|-------|-------|------|------------|
| 04.2b WO Pause/Resume | BACKEND-DEV | sonnet | 2 | 04.2a |
| 04.2c WO Complete | FULLSTACK-DEV | sonnet | 3 | 04.2a, 04.3 |

**=== EPIC 05 LP BARRIER ===**

**Wave 4 (Phase 1 Core) - Days 11-18**
After Epic 05 license_plates table exists:

| Story | Agent | Model | Days | Depends On |
|-------|-------|-------|------|------------|
| 04.6a Consumption Desktop | FULLSTACK-DEV | opus | 5 | Epic 05 LPs |
| 04.7a Output Desktop | FULLSTACK-DEV | opus | 5 | Epic 05 LPs |

**Wave 5 (Phase 1 Scanner) - Days 18-24**

| Story | Agent | Model | Days | Depends On |
|-------|-------|-------|------|------------|
| 04.6b Consumption Scanner | FULLSTACK-DEV | opus | 4 | 04.6a |
| 04.7b Output Scanner | FULLSTACK-DEV | opus | 4 | 04.7a |

**Wave 6 (Phase 1 Advanced) - Days 24-32**

| Story | Agent | Model | Days | Depends On |
|-------|-------|-------|------|------------|
| 04.6c 1:1 Consumption | BACKEND-DEV | sonnet | 1 | 04.6a |
| 04.6d Consumption Correction | FULLSTACK-DEV | sonnet | 2 | 04.6a |
| 04.6e Over-Consumption | FULLSTACK-DEV | sonnet | 2 | 04.6a |
| 04.7c By-Product Registration | FULLSTACK-DEV | sonnet | 2 | 04.7a |
| 04.7d Multiple Outputs | BACKEND-DEV | sonnet | 1 | 04.7a |
| 04.8 Material Reservations | BACKEND-DEV | opus | 4 | 04.6a, Epic 05 |

**Wave 7 (Phase 2 OEE) - Days 33-44**

| Story | Agent | Model | Days | Depends On |
|-------|-------|-------|------|------------|
| 04.9d Shift Management | FULLSTACK-DEV | sonnet | 3 | 04.5 |
| 04.9b Downtime Tracking | FULLSTACK-DEV | sonnet | 3 | 04.9d |
| 04.9a OEE Calculation | BACKEND-DEV | opus | 5 | 04.9b, 04.9d |
| 04.9c Machine Integration | FULLSTACK-DEV | sonnet | 3 | 04.9a |

**Wave 8 (Phase 2 Reports) - Days 44-50**

| Story | Agent | Model | Days | Depends On |
|-------|-------|-------|------|------------|
| 04.10a-g Reports | FRONTEND-DEV | sonnet | 1-2 each | Phase 1 complete |

### 5.2 Model Selection Guidelines

| Criterion | Use Opus | Use Sonnet |
|-----------|----------|------------|
| Complexity | L (5+ days) | S/M (1-4 days) |
| Scanner UI | Yes (mobile-first UX) | No |
| LP transactions | Yes (complex validation) | No |
| Multiple entities | 3+ tables | 1-2 tables |
| Business rules | Many validation rules | Simple CRUD |

**Opus-Required Stories:**
- 04.6a Consumption Desktop (LP validation, genealogy)
- 04.6b Consumption Scanner (mobile UX, barcode handling)
- 04.7a Output Desktop (LP creation, genealogy)
- 04.7b Output Scanner (ZPL printing, mobile UX)
- 04.8 Reservations (LP allocation, FIFO/FEFO)
- 04.9a OEE Calculation (A x P x Q formula)

**Sonnet-Suitable Stories:**
- 04.1 Dashboard (aggregation queries)
- 04.2a-c WO Lifecycle (status updates)
- 04.3 Operations (duration tracking)
- 04.4 Yield Tracking (calculations)
- 04.5 Settings (configuration CRUD)
- 04.6c, 04.6d, 04.6e (extensions to 04.6a)
- 04.7c, 04.7d (extensions to 04.7a)
- 04.9b-d OEE support (focused scope)
- 04.10a-g Reports (chart rendering)

---

## 6. Scanner UI Guidelines

### 6.1 Design Principles

For stories 04.6b and 04.7b:

1. **Mobile-First**: Design for handheld devices with one-hand operation
2. **Large Touch Targets**: Minimum 48x48 pixels, prefer 64px for primary actions
3. **Clear Feedback**: Visual (green/red indicators) + Audio (tones/beeps)
4. **Minimal Steps**: Reduce workflow to essential screens only
5. **Offline Consideration**: Note Phase 3 offline support requirement

### 6.2 Scanner Workflow Structure

```
+------------------+     +------------------+     +------------------+
| Scan WO Barcode  | --> | Scan LP Barcode  | --> | Enter Quantity   |
| (Camera/HW scan) |     | (Validate LP)    |     | (Number pad)     |
+------------------+     +------------------+     +------------------+
                                                          |
+------------------+     +------------------+              |
| Print Label      | <-- | Confirm & Submit | <-----------+
| (ZPL to printer) |     | (Green check)    |
+------------------+     +------------------+
```

### 6.3 Audio Feedback Specification

| Event | Sound | Duration |
|-------|-------|----------|
| Valid scan | Success tone (high pitch) | 200ms |
| Invalid scan | Error beep (low pitch) | 300ms |
| Submission complete | Confirmation chime | 500ms |
| Network error | Alert tone | 400ms |

### 6.4 ZPL Label Template (for 04.7b)

```zpl
^XA
^FO50,50^A0N,30,30^FD[LP Number]^FS
^FO50,100^BY2,2,100^BCN,100,Y,N,N^FD[LP Barcode]^FS
^FO50,230^A0N,25,25^FDProduct: [Product Name]^FS
^FO50,270^A0N,25,25^FDQty: [Quantity] [UoM]^FS
^FO50,310^A0N,25,25^FDBatch: [Batch Number]^FS
^FO50,350^A0N,25,25^FDExpiry: [Expiry Date]^FS
^XZ
```

---

## 7. Quality Checklist

Before submitting a story for review:

### 7.1 PRD Coverage
- [ ] All referenced FRs have ACs mapped
- [ ] ACs match PRD Given/When/Then format
- [ ] Business rules from PRD included
- [ ] Phase 1+ features documented in "Future Phases"

### 7.2 LP Dependency
- [ ] LP dependency status explicitly stated
- [ ] Phase 0 stories have NO LP references
- [ ] Phase 1 stories have Epic 05 dependency documented

### 7.3 Technical Completeness
- [ ] API endpoints fully specified (match Architecture doc)
- [ ] Database tables referenced from production.md
- [ ] Service methods listed
- [ ] Zod validation schemas defined
- [ ] RLS policies mentioned

### 7.4 Scanner Stories (04.6b, 04.7b)
- [ ] Touch target sizes specified (48px+)
- [ ] Audio feedback defined
- [ ] ZPL template provided (for output)
- [ ] Workflow steps documented

### 7.5 Story Quality (INVEST)
- [ ] **I**ndependent: Can be developed standalone
- [ ] **N**egotiable: Scope can adjust if needed
- [ ] **V**aluable: Delivers user value
- [ ] **E**stimable: Complexity is clear (S/M/L)
- [ ] **S**mall: Can complete in 1 sprint
- [ ] **T**estable: ACs are verifiable

### 7.6 Definition of Done
- [ ] Has API test coverage target (>80%)
- [ ] Has E2E smoke test for critical path
- [ ] Has performance targets where applicable
- [ ] Scanner: Touch targets verified, audio tested

---

## 8. Story Index (To Be Created)

### Phase 0 - MVP Core (No LP Dependency)

| Story ID | Name | Complexity | Priority | Status | Model |
|----------|------|------------|----------|--------|-------|
| 04.5 | Production Settings | M | P0 | TO CREATE | sonnet |
| 04.1 | Production Dashboard | M | P0 | TO CREATE | sonnet |
| 04.2a | WO Start | M | P0 | TO CREATE | sonnet |
| 04.2b | WO Pause/Resume | S | P0 | TO CREATE | sonnet |
| 04.2c | WO Complete | M | P0 | TO CREATE | sonnet |
| 04.3 | Operation Start/Complete | M | P0 | TO CREATE | sonnet |
| 04.4 | Yield Tracking | S | P0 | TO CREATE | sonnet |

### Phase 1 - Full Production (Requires Epic 05)

| Story ID | Name | Complexity | Priority | Status | Model |
|----------|------|------------|----------|--------|-------|
| 04.6a | Material Consumption Desktop | L | P1 | DEFERRED | opus |
| 04.6b | Material Consumption Scanner | L | P1 | DEFERRED | opus |
| 04.6c | 1:1 Consumption Enforcement | S | P1 | DEFERRED | sonnet |
| 04.6d | Consumption Correction | M | P1 | DEFERRED | sonnet |
| 04.6e | Over-Consumption Control | M | P1 | DEFERRED | sonnet |
| 04.7a | Output Registration Desktop | L | P1 | DEFERRED | opus |
| 04.7b | Output Registration Scanner | L | P1 | DEFERRED | opus |
| 04.7c | By-Product Registration | M | P1 | DEFERRED | sonnet |
| 04.7d | Multiple Outputs per WO | S | P1 | DEFERRED | sonnet |
| 04.8 | Material Reservations | L | P1 | DEFERRED | opus |

### Phase 2 - OEE & Analytics

| Story ID | Name | Complexity | Priority | Status | Model |
|----------|------|------------|----------|--------|-------|
| 04.9a | OEE Calculation | L | P2 | TO CREATE | opus |
| 04.9b | Downtime Tracking | M | P2 | TO CREATE | sonnet |
| 04.9c | Machine Integration | M | P2 | TO CREATE | sonnet |
| 04.9d | Shift Management | M | P2 | TO CREATE | sonnet |
| 04.10a | OEE Summary Report | M | P2 | TO CREATE | sonnet |
| 04.10b | Downtime Analysis Report | M | P2 | TO CREATE | sonnet |
| 04.10c | Yield Analysis Report | S | P2 | TO CREATE | sonnet |
| 04.10d | Production Output Report | S | P2 | TO CREATE | sonnet |
| 04.10e | Material Consumption Report | S | P2 | TO CREATE | sonnet |
| 04.10f | Quality Rate Report | S | P2 | TO CREATE | sonnet |
| 04.10g | WO Completion Report | S | P2 | TO CREATE | sonnet |

**Phase 0 Stories: 7** (can start immediately)
**Phase 1 Stories: 10** (deferred to Epic 05)
**Phase 2 Stories: 11** (after Phase 1)
**Total: 28 stories**

---

## 9. Handoff to Story Writers

### 9.1 Instructions for Story Creation

1. **Read PRD Section** - Each FR has detailed ACs in PRD
2. **Use Template** - Follow template in Section 3
3. **Reference Architecture** - Use schema from production.md
4. **Map FRs to ACs** - PRD ACs are comprehensive, use as-is
5. **Document LP Dependency** - Explicit for every story
6. **Scanner UI** - Include design specs for 04.6b, 04.7b

### 9.2 File Naming Convention

```
docs/2-MANAGEMENT/epics/current/04-production/
  04.0.epic-overview.md
  04.0.story-creation-brief.md (this file)
  04.1.production-dashboard.md
  04.2a.wo-start.md
  04.2b.wo-pause-resume.md
  04.2c.wo-complete.md
  04.3.operation-start-complete.md
  04.4.yield-tracking.md
  04.5.production-settings.md
  04.6a.consumption-desktop.md
  04.6b.consumption-scanner.md
  04.6c.consumption-one-to-one.md
  04.6d.consumption-correction.md
  04.6e.over-consumption-control.md
  04.7a.output-desktop.md
  04.7b.output-scanner.md
  04.7c.by-product-registration.md
  04.7d.multiple-outputs.md
  04.8.material-reservations.md
  04.9a.oee-calculation.md
  04.9b.downtime-tracking.md
  04.9c.machine-integration.md
  04.9d.shift-management.md
  04.10a.oee-summary-report.md
  ... (04.10b through 04.10g)
```

### 9.3 Parallel Work Assignment

**Team 1 (WO Lifecycle):**
- 04.5 -> 04.2a -> 04.2b -> 04.2c

**Team 2 (Operations + Dashboard):**
- 04.1, 04.3, 04.4 (parallel with Team 1)

**Team 3 (Consumption) - After Epic 05:**
- 04.6a -> 04.6b -> 04.6c, 04.6d, 04.6e

**Team 4 (Output) - After Epic 05:**
- 04.7a -> 04.7b -> 04.7c, 04.7d

**Team 5 (OEE) - After Phase 1:**
- 04.9d -> 04.9b -> 04.9a -> 04.9c -> 04.10a-g

---

## 10. Risk Assessment

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| **LP dependency blocks Phase 1** | High | Certain | Phase split (04a/04b), defer 10 stories to Epic 05+ |
| Scanner device compatibility | Medium | Medium | Test on multiple Android devices, fallback to camera |
| ZPL printer configuration | Medium | Medium | Printer setup guide, test labels |
| Genealogy data integrity | High | Medium | Transaction isolation, integration tests |
| OEE formula accuracy | Medium | Medium | Unit tests with known data, reference examples |
| Dashboard performance | Medium | Low | Caching (30s TTL), efficient aggregations |
| Over-consumption approval delays | Low | Medium | Async notifications, manager alerts |
| Concurrent WO edits | Medium | Low | Optimistic locking, RLS |

---

## 11. Key Business Rules Reference

From PRD, these rules MUST be enforced:

### Material Consumption
- LP must be 'available' status to consume
- Product and UoM must match material requirement
- Consumed qty cannot exceed LP qty
- Over-consumption blocked unless setting enabled
- 1:1 consumption strictly enforced when flagged
- Genealogy created for all consumptions
- Reversals require manager permission

### Output Registration
- At least one output required to complete WO
- QA status required if setting enabled
- Expiry date auto-calculated from shelf life
- Batch number from WO or auto-generated
- Multiple outputs allowed per WO
- By-products prompted if defined in BOM
- Genealogy updated with child LP

### Work Order Lifecycle
- WO must be 'Released' to start
- Pause requires setting enabled
- Resume only from 'Paused' status
- Complete requires output registered (Phase 1)
- Auto-complete when output >= planned (if enabled)
- Operations sequence enforced (if enabled)

### OEE Calculation
- Availability = (operating_time / planned_time) x 100
- Performance = (actual / theoretical) x 100
- Quality = (good / total) x 100
- OEE = Availability x Performance x Quality
- Calculated per shift, per machine
- Downtime reduces availability
- Rejects reduce quality factor

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-12-16 | Initial story creation brief | ARCHITECT-AGENT |
