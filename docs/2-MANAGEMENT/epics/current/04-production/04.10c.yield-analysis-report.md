# 04.10c - Yield Analysis Report

**Story ID:** 04.10c
**Epic:** 04 - Production
**Phase:** 2 (OEE & Analytics)
**Complexity:** M (Medium)
**Estimate:** 2 days
**Priority:** P2
**Type:** Full-stack

**Primary PRD:** `docs/1-BASELINE/product/modules/PRODUCTION.md` (FR-PROD-022c)
**UX Wireframes:** TBD (Analytics Dashboard Pattern)

---

## PRD References

| FR ID | Requirement | Priority | Phase | Covered |
|-------|-------------|----------|-------|---------|
| FR-PROD-022c | Yield Analysis Report | P1 | Phase 2 | Yes |

---

## User Story

**As a** production manager,
**I want** to analyze yield trends by product, line, and operator with statistical insights and outlier detection,
**So that** I can identify systematic yield issues, compare operator performance, and take corrective actions to improve overall production efficiency.

**As a** plant supervisor,
**I want** to quickly identify work orders with abnormally low yields,
**So that** I can investigate root causes and implement process improvements.

---

## Goal

Implement a comprehensive yield analysis report that provides trend visualization, multi-dimensional filtering, statistical analysis, and outlier detection. The report enables data-driven decisions by highlighting yield patterns, comparing performance across products/lines/operators, and flagging anomalies for investigation.

---

## Scope

**In scope:**
- Yield trend line chart (daily/weekly/monthly aggregation)
- Product comparison bar chart (average yield by product)
- Operator performance comparison (yield by operator)
- Line/machine yield comparison
- Outlier detection (WOs with yield < configurable threshold)
- Outlier scatter plot visualization
- Statistical metrics (average, min, max, std deviation, variance)
- Multi-dimensional filters (product, line, operator, date range)
- Data table with sortable columns
- CSV export functionality
- Responsive design (desktop-first)
- Loading states and empty states

**Out of scope:**
- Predictive analytics / ML-based yield forecasting (Phase 3)
- Real-time streaming updates (use refresh button)
- Email/notification alerts for low yield (separate story)
- Yield variance by material (FR-PROD-022e covers this)
- Drill-down to individual WO detail (link only)
- Printable PDF export (future enhancement)

---

## Dependencies

| Story | Requirement | Status |
|-------|-------------|--------|
| 04.4 | Yield Tracking (yield_logs table, yield_percent field) | Required - provides yield data |
| 04.7a | Output Registration Desktop | Required - provides production_outputs |
| 04.1 | Production Dashboard | Optional - pattern reference |
| 01.1 | Org Context + Base RLS | Required - multi-tenancy |

**Data Sources:**
- `work_orders.yield_percent` - Calculated yield per WO
- `yield_logs` - Historical yield changes (audit trail)
- `production_outputs` - Output quantities and QA status
- `wo_operations.actual_yield_percent` - Operation-level yield

---

## Acceptance Criteria (Given/When/Then)

### AC-1: Report Page Access

**Given** user navigates to `/production/analytics/yield`
**When** page loads
**Then** yield analysis report displays with default filters (last 30 days, all products, all lines)

**Given** user has role "Operator"
**When** accessing yield report
**Then** report displays (read-only analytics available to all production roles)

**Given** user from Org A
**When** report loads
**Then** only Org A's yield data is included (RLS enforced)

---

### AC-2: Yield Trend Chart

**Given** yield data exists for product X over last 30 days
**When** trend chart renders
**Then** chart displays daily yield points with connecting line and trend line (linear regression)

**Given** date range filter = "Last 7 days"
**When** filter applied
**Then** chart shows 7 data points (one per day) with aggregated yield

**Given** date range filter = "Last 90 days"
**When** filter applied
**Then** chart shows weekly aggregation (13 data points) for readability

**Given** multiple products selected in filter
**When** trend chart renders
**Then** each product displays as separate line with distinct color in legend

**Given** no data exists for selected filters
**When** chart renders
**Then** "No yield data for selected criteria" message displays with empty state illustration

**Given** user hovers over data point on chart
**When** tooltip displays
**Then** shows: Date, Product (if multi), Average Yield %, WO Count, Min Yield, Max Yield

---

### AC-3: Product Comparison Chart

**Given** 5 products have yield data
**When** product comparison bar chart renders
**Then** horizontal bar chart shows average yield for each product, sorted by yield descending

**Given** product comparison chart rendered
**When** bar hovered
**Then** tooltip shows: Product Name, Average Yield %, WO Count, Std Deviation

**Given** product A has avg yield 95% and product B has 75%
**When** chart renders
**Then** product A bar is green, product B bar is red (threshold-based coloring)

**Given** "Show only low yield products" toggle enabled
**When** filter applied
**Then** only products with avg yield < 80% display

---

### AC-4: Operator Performance Analysis

**Given** filter "Group by Operator" selected
**When** report generates
**Then** operator comparison chart displays showing average yield per operator

**Given** Operator A completed 50 WOs with avg yield 92% and Operator B completed 30 WOs with avg yield 78%
**When** operator chart renders
**Then** bars show both operators with respective yields and WO counts

**Given** operator performance displayed
**When** sorted by yield
**Then** operators ordered from highest to lowest yield

**Given** operator filter applied for "John Smith"
**When** report generates
**Then** only WOs where John Smith recorded outputs are included

**Given** user clicks on operator bar
**When** clicked
**Then** filters table below to show only that operator's WOs

---

### AC-5: Outlier Detection

**Given** threshold = 80% (default)
**When** outlier analysis runs
**Then** all WOs with yield_percent < 80% flagged as outliers

**Given** 10 WOs are outliers
**When** outlier section displays
**Then** table shows: WO Number, Product, Planned Qty, Actual Qty, Yield %, Date, Operator, Line

**Given** outlier scatter plot renders
**When** plotted
**Then** X-axis = Date, Y-axis = Yield %, with horizontal threshold line at 80%

**Given** scatter plot data point clicked
**When** clicked
**Then** navigates to WO detail page (`/production/work-orders/{id}`)

**Given** user adjusts threshold slider to 70%
**When** threshold changed
**Then** outlier list updates to show only WOs with yield < 70%

**Given** WO has yield = 65% (< 70% threshold)
**When** outlier displayed
**Then** row highlighted in red with "Critical" badge

**Given** WO has yield = 75% (between 70-80%)
**When** outlier displayed
**Then** row highlighted in yellow with "Warning" badge

---

### AC-6: Statistical Metrics

**Given** yield data exists for selected filters
**When** statistics panel displays
**Then** shows: Average Yield, Median Yield, Min Yield, Max Yield, Std Deviation, Variance, WO Count

**Given** average yield = 87.5%
**When** displayed
**Then** value shows "87.5%" with 1 decimal precision

**Given** std deviation = 8.2%
**When** displayed
**Then** value shows "8.2%" indicating yield consistency

**Given** statistics calculated
**When** rendered
**Then** calculation completes within 500ms for up to 1000 WOs

**Given** no data exists
**When** statistics panel renders
**Then** shows "N/A" for all metrics with "No data" message

---

### AC-7: Line/Machine Comparison

**Given** filter "Group by Production Line" selected
**When** report generates
**Then** line comparison chart displays showing average yield per line

**Given** Line A has avg yield 90% and Line B has avg yield 82%
**When** chart renders
**Then** bars display with yield values and WO counts per line

**Given** machine filter applied to "Machine M-001"
**When** report generates
**Then** only WOs executed on Machine M-001 included

**Given** line clicked in chart
**When** clicked
**Then** filters data table to show only WOs from that line

---

### AC-8: Data Table

**Given** report generates with results
**When** data table renders
**Then** columns display: WO Number, Product, Line, Operator, Planned Qty, Actual Qty, Yield %, Completed Date

**Given** data table displayed
**When** column header clicked
**Then** table sorts by that column (toggle asc/desc)

**Given** "Yield %" column header clicked
**When** sorted ascending
**Then** lowest yield WOs appear first

**Given** data table with 100+ rows
**When** rendered
**Then** pagination displays (25 rows per page default)

**Given** user clicks WO Number in table
**When** clicked
**Then** navigates to WO detail page in new tab

**Given** row with yield < 80%
**When** displayed
**Then** yield cell has red background and warning icon

---

### AC-9: Filters

**Given** report page loads
**When** filter panel renders
**Then** filters available: Date Range, Product (multi-select), Line (multi-select), Operator (multi-select), Shift

**Given** date range picker displayed
**When** user selects "Last 7 days"
**Then** start_date = today - 7, end_date = today

**Given** custom date range selected
**When** user picks Jan 1 - Jan 31
**Then** report shows only WOs completed within that range

**Given** multiple products selected (Product A, Product B)
**When** filter applied
**Then** report includes WOs for both products

**Given** filters changed
**When** "Apply Filters" clicked
**Then** report regenerates within 2 seconds

**Given** filters applied
**When** "Reset Filters" clicked
**Then** all filters return to default values (last 30 days, all)

**Given** active filters exist
**When** filter chips displayed
**Then** each active filter shows as removable chip (e.g., "Product: Bread", "Line: Line A")

---

### AC-10: CSV Export

**Given** report generated with results
**When** "Export CSV" button clicked
**Then** CSV file downloads within 3 seconds

**Given** CSV export triggered
**When** file generated
**Then** columns include: WO Number, Product, Line, Operator, Planned Qty, Actual Qty, Yield %, Completed Date, Shift

**Given** 500 WOs in filtered results
**When** CSV exported
**Then** all 500 rows included in file

**Given** export completes
**When** file downloaded
**Then** filename format: `yield-analysis-{YYYY-MM-DD}.csv`

**Given** no data exists for filters
**When** export attempted
**Then** button disabled with tooltip "No data to export"

---

### AC-11: Performance

**Given** report with 1000 WOs
**When** page loads
**Then** initial render completes within 3 seconds

**Given** filter changed
**When** report regenerates
**Then** update completes within 2 seconds

**Given** charts rendering
**When** displayed
**Then** animations complete smoothly (60fps)

**Given** large dataset (5000+ WOs)
**When** report loads
**Then** data aggregated server-side to prevent browser memory issues

---

### AC-12: Empty and Error States

**Given** no yield data exists for organization
**When** report loads
**Then** empty state displays with message "No production data yet. Complete work orders to see yield analysis."

**Given** API error occurs
**When** report fails to load
**Then** error message "Failed to load yield data. Please try again." displays with retry button

**Given** partial data load failure
**When** chart fails but table succeeds
**Then** chart shows error state while table displays available data

---

## Technical Specification

### Database Schema

**No new tables required.** Uses existing tables from Story 04.4:

```sql
-- Existing tables used:
-- work_orders (yield_percent, planned_quantity, produced_quantity, status, completed_at, line_id)
-- yield_logs (wo_id, old_yield_percent, new_yield_percent, created_at, created_by)
-- production_outputs (wo_id, quantity, qa_status, created_at, created_by)
-- wo_operations (actual_yield_percent, operator_id, completed_at)
-- production_lines (id, name)
-- users (id, full_name) - for operator names
```

**Analytics View (Optional - for performance):**

```sql
-- Materialized view for faster analytics (optional optimization)
CREATE MATERIALIZED VIEW yield_analytics_mv AS
SELECT
  wo.id AS wo_id,
  wo.wo_number,
  wo.org_id,
  wo.product_id,
  p.name AS product_name,
  wo.line_id,
  pl.name AS line_name,
  wo.planned_quantity,
  wo.produced_quantity,
  wo.yield_percent,
  wo.completed_at::date AS completion_date,
  DATE_TRUNC('week', wo.completed_at) AS completion_week,
  DATE_TRUNC('month', wo.completed_at) AS completion_month,
  u.full_name AS completed_by_name
FROM work_orders wo
LEFT JOIN products p ON wo.product_id = p.id
LEFT JOIN production_lines pl ON wo.line_id = pl.id
LEFT JOIN users u ON wo.completed_by = u.id
WHERE wo.status = 'Completed'
  AND wo.yield_percent IS NOT NULL;

-- Refresh policy (if using materialized view)
REFRESH MATERIALIZED VIEW yield_analytics_mv;

-- Index for common queries
CREATE INDEX idx_yield_analytics_org_date ON yield_analytics_mv(org_id, completion_date);
CREATE INDEX idx_yield_analytics_product ON yield_analytics_mv(org_id, product_id);
CREATE INDEX idx_yield_analytics_line ON yield_analytics_mv(org_id, line_id);
```

### RLS Policies

```sql
-- Standard org_id isolation (inherited from work_orders)
-- No additional RLS needed - queries filter by org_id via existing policies
```

### API Endpoints

```
# Yield Analysis Report
GET    /api/production/analytics/yield
       Query: start_date, end_date, product_ids[], line_ids[], operator_ids[], shift_id
       Response: {
         summary: { avg_yield, median_yield, min_yield, max_yield, std_dev, wo_count },
         trend_data: Array<{ date, avg_yield, wo_count, min_yield, max_yield }>,
         product_comparison: Array<{ product_id, product_name, avg_yield, wo_count, std_dev }>,
         line_comparison: Array<{ line_id, line_name, avg_yield, wo_count, std_dev }>,
         operator_comparison: Array<{ operator_id, operator_name, avg_yield, wo_count, std_dev }>,
         outliers: Array<YieldOutlier>,
         data: Array<YieldDataRow>
       }

# Yield Trend Data (separate endpoint for chart updates)
GET    /api/production/analytics/yield/trend
       Query: start_date, end_date, product_ids[], aggregation (daily|weekly|monthly)
       Response: {
         data: Array<{ date, avg_yield, wo_count, min_yield, max_yield, product_id? }>
       }

# Outliers Detection
GET    /api/production/analytics/yield/outliers
       Query: start_date, end_date, threshold (default 80)
       Response: {
         outliers: Array<{
           wo_id, wo_number, product_name, line_name, operator_name,
           planned_qty, actual_qty, yield_percent, completed_at
         }>,
         count: number
       }

# Export CSV
GET    /api/production/analytics/yield/export
       Query: start_date, end_date, product_ids[], line_ids[], operator_ids[]
       Response: CSV file stream
```

### Service Methods

**Location:** `lib/services/yield-analytics-service.ts`

```typescript
interface YieldAnalyticsService {
  // Main report data
  getYieldAnalytics(params: YieldAnalyticsParams): Promise<YieldAnalyticsResult>;

  // Trend data for charts
  getYieldTrend(params: YieldTrendParams): Promise<YieldTrendData[]>;

  // Comparison analysis
  getProductYieldComparison(params: FilterParams): Promise<ProductYieldComparison[]>;
  getLineYieldComparison(params: FilterParams): Promise<LineYieldComparison[]>;
  getOperatorYieldComparison(params: FilterParams): Promise<OperatorYieldComparison[]>;

  // Outlier detection
  getYieldOutliers(params: OutlierParams): Promise<YieldOutlier[]>;

  // Statistical calculations
  calculateYieldStatistics(yields: number[]): YieldStatistics;

  // Export
  exportYieldDataCSV(params: FilterParams): Promise<ReadableStream>;
}

interface YieldAnalyticsParams {
  org_id: string;
  start_date: Date;
  end_date: Date;
  product_ids?: string[];
  line_ids?: string[];
  operator_ids?: string[];
  shift_id?: string;
}

interface YieldStatistics {
  average: number;
  median: number;
  min: number;
  max: number;
  std_deviation: number;
  variance: number;
  count: number;
}

interface YieldTrendData {
  date: string;
  avg_yield: number;
  wo_count: number;
  min_yield: number;
  max_yield: number;
  product_id?: string;
  product_name?: string;
}

interface YieldOutlier {
  wo_id: string;
  wo_number: string;
  product_name: string;
  line_name: string;
  operator_name: string;
  planned_qty: number;
  actual_qty: number;
  yield_percent: number;
  completed_at: string;
  severity: 'warning' | 'critical';
}

interface ProductYieldComparison {
  product_id: string;
  product_name: string;
  avg_yield: number;
  wo_count: number;
  std_deviation: number;
  min_yield: number;
  max_yield: number;
}
```

### Zod Validation Schemas

**Location:** `lib/validation/yield-analytics.ts`

```typescript
import { z } from 'zod';

// Query parameters schema
export const yieldAnalyticsQuerySchema = z.object({
  start_date: z.string().datetime().optional(),
  end_date: z.string().datetime().optional(),
  product_ids: z.array(z.string().uuid()).optional(),
  line_ids: z.array(z.string().uuid()).optional(),
  operator_ids: z.array(z.string().uuid()).optional(),
  shift_id: z.string().uuid().optional(),
  threshold: z.number().min(0).max(100).default(80),
  aggregation: z.enum(['daily', 'weekly', 'monthly']).default('daily'),
}).refine(
  (data) => {
    if (data.start_date && data.end_date) {
      return new Date(data.start_date) <= new Date(data.end_date);
    }
    return true;
  },
  { message: 'Start date must be before or equal to end date' }
);

// Response schemas
export const yieldStatisticsSchema = z.object({
  average: z.number().min(0).max(200), // Allow >100% for overproduction
  median: z.number().min(0).max(200),
  min: z.number().min(0).max(200),
  max: z.number().min(0).max(200),
  std_deviation: z.number().min(0),
  variance: z.number().min(0),
  count: z.number().int().nonnegative(),
});

export const yieldTrendPointSchema = z.object({
  date: z.string(),
  avg_yield: z.number(),
  wo_count: z.number().int().nonnegative(),
  min_yield: z.number(),
  max_yield: z.number(),
  product_id: z.string().uuid().optional(),
  product_name: z.string().optional(),
});

export const yieldOutlierSchema = z.object({
  wo_id: z.string().uuid(),
  wo_number: z.string(),
  product_name: z.string(),
  line_name: z.string().nullable(),
  operator_name: z.string().nullable(),
  planned_qty: z.number(),
  actual_qty: z.number(),
  yield_percent: z.number(),
  completed_at: z.string().datetime(),
  severity: z.enum(['warning', 'critical']),
});

export const yieldAnalyticsResponseSchema = z.object({
  summary: yieldStatisticsSchema,
  trend_data: z.array(yieldTrendPointSchema),
  product_comparison: z.array(z.object({
    product_id: z.string().uuid(),
    product_name: z.string(),
    avg_yield: z.number(),
    wo_count: z.number().int(),
    std_deviation: z.number(),
  })),
  line_comparison: z.array(z.object({
    line_id: z.string().uuid(),
    line_name: z.string(),
    avg_yield: z.number(),
    wo_count: z.number().int(),
    std_deviation: z.number(),
  })),
  operator_comparison: z.array(z.object({
    operator_id: z.string().uuid(),
    operator_name: z.string(),
    avg_yield: z.number(),
    wo_count: z.number().int(),
    std_deviation: z.number(),
  })),
  outliers: z.array(yieldOutlierSchema),
});
```

---

## UI Components

### Pages

- `app/(authenticated)/production/analytics/yield/page.tsx` - Main yield analysis report page

### Components

**Location:** `components/production/analytics/yield/`

```
YieldAnalyticsPage.tsx        - Main page container with filters and sections
YieldTrendChart.tsx           - Line chart for yield trends over time
YieldProductComparison.tsx    - Horizontal bar chart comparing products
YieldOperatorComparison.tsx   - Bar chart comparing operator performance
YieldLineComparison.tsx       - Bar chart comparing production lines
YieldOutlierScatter.tsx       - Scatter plot for outlier visualization
YieldOutlierTable.tsx         - Table listing outlier WOs
YieldStatisticsPanel.tsx      - Statistics summary cards
YieldDataTable.tsx            - Paginated data table with all WOs
YieldFilters.tsx              - Filter panel with date range, product, line, operator
YieldExportButton.tsx         - CSV export button with loading state
```

### Component Props

```typescript
// YieldTrendChart.tsx
interface YieldTrendChartProps {
  data: YieldTrendData[];
  isLoading: boolean;
  error?: string;
  showMultiProduct?: boolean;
  height?: number;
}

// YieldOutlierTable.tsx
interface YieldOutlierTableProps {
  outliers: YieldOutlier[];
  threshold: number;
  onThresholdChange: (threshold: number) => void;
  onWOClick: (woId: string) => void;
  isLoading: boolean;
}

// YieldFilters.tsx
interface YieldFiltersProps {
  filters: YieldFilterState;
  onFiltersChange: (filters: YieldFilterState) => void;
  onApply: () => void;
  onReset: () => void;
  products: SelectOption[];
  lines: SelectOption[];
  operators: SelectOption[];
  shifts: SelectOption[];
}

interface YieldFilterState {
  dateRange: { start: Date; end: Date };
  productIds: string[];
  lineIds: string[];
  operatorIds: string[];
  shiftId?: string;
  threshold: number;
}

// YieldStatisticsPanel.tsx
interface YieldStatisticsPanelProps {
  statistics: YieldStatistics | null;
  isLoading: boolean;
}
```

### UI Patterns

**Report Layout:**
```
+-------------------------------------------------------------------+
| Yield Analysis Report                           [Export CSV] [Refresh]|
+-------------------------------------------------------------------+
| Filters: [Date Range v] [Products v] [Lines v] [Operators v] [Apply] |
|          Active: Product: Bread, Line: Line A         [Reset Filters]|
+-------------------------------------------------------------------+
| Statistics Panel                                                    |
| +----------+ +----------+ +----------+ +----------+ +----------+    |
| | Average  | | Median   | | Min      | | Max      | | Std Dev  |    |
| | 87.5%    | | 89.0%    | | 65.2%    | | 99.1%    | | 8.2%     |    |
| +----------+ +----------+ +----------+ +----------+ +----------+    |
+-------------------------------------------------------------------+
| Yield Trend                                      [Daily v]          |
| [Line Chart showing yield over time with trend line]                |
|                                                                     |
+-------------------------------------------------------------------+
| +-----------------------------+ +-----------------------------+     |
| | Product Comparison          | | Operator Performance        |     |
| | [Horizontal Bar Chart]      | | [Horizontal Bar Chart]      |     |
| +-----------------------------+ +-----------------------------+     |
+-------------------------------------------------------------------+
| Low Yield Outliers (Threshold: [80%] slider)                       |
| [Scatter Plot]                                                      |
| +---------------------------------------------------------------+  |
| | WO Number | Product | Line | Operator | Yield | Date | Severity|  |
| | WO-001    | Bread   | A    | John     | 65.2% | 1/15 | Critical|  |
| | WO-042    | Cookies | B    | Sarah    | 78.1% | 1/18 | Warning |  |
| +---------------------------------------------------------------+  |
+-------------------------------------------------------------------+
| All Yield Data                                   [1-25 of 150]      |
| +---------------------------------------------------------------+  |
| | WO Number | Product | Line | Operator | Planned | Actual | Yield|  |
| | WO-150    | Bread   | A    | John     | 1000    | 950    | 95%  |  |
| +---------------------------------------------------------------+  |
| [< Prev] [1] [2] [3] ... [6] [Next >]                               |
+-------------------------------------------------------------------+
```

**Color Coding:**
- Green: Yield >= 80%
- Yellow: 70% <= Yield < 80%
- Red: Yield < 70%

---

## Test Cases

### Unit Tests

**yield-analytics-service.test.ts**
```typescript
describe('YieldAnalyticsService', () => {
  describe('calculateYieldStatistics', () => {
    it('calculates average yield correctly for array of values');
    it('calculates median yield correctly for odd count');
    it('calculates median yield correctly for even count');
    it('calculates std deviation correctly');
    it('returns zero values for empty array');
    it('handles single value array');
  });

  describe('getYieldTrend', () => {
    it('aggregates daily yields correctly');
    it('aggregates weekly yields correctly');
    it('aggregates monthly yields correctly');
    it('filters by product_ids when provided');
    it('filters by date range correctly');
  });

  describe('getYieldOutliers', () => {
    it('returns WOs below threshold');
    it('classifies severity as critical for yield < 70%');
    it('classifies severity as warning for 70% <= yield < 80%');
    it('returns empty array when no outliers exist');
    it('respects custom threshold parameter');
  });

  describe('getProductYieldComparison', () => {
    it('groups yields by product correctly');
    it('calculates per-product statistics');
    it('sorts by average yield descending');
  });

  describe('getOperatorYieldComparison', () => {
    it('groups yields by operator correctly');
    it('excludes WOs without operator assignment');
  });
});
```

### Integration Tests

**yield-analytics-api.test.ts**
```typescript
describe('Yield Analytics API', () => {
  describe('GET /api/production/analytics/yield', () => {
    it('returns complete analytics data structure');
    it('filters by date range correctly');
    it('filters by product_ids correctly');
    it('filters by line_ids correctly');
    it('filters by operator_ids correctly');
    it('returns 401 for unauthenticated request');
    it('enforces org_id isolation (RLS)');
    it('returns empty data for no results');
  });

  describe('GET /api/production/analytics/yield/trend', () => {
    it('returns trend data with daily aggregation');
    it('returns trend data with weekly aggregation');
    it('returns trend data with monthly aggregation');
  });

  describe('GET /api/production/analytics/yield/outliers', () => {
    it('returns outliers below default 80% threshold');
    it('returns outliers below custom threshold');
    it('classifies severity correctly');
  });

  describe('GET /api/production/analytics/yield/export', () => {
    it('returns CSV file with correct headers');
    it('includes all filtered data in export');
    it('handles large datasets (1000+ rows)');
  });
});
```

### E2E Tests

**yield-analytics.spec.ts**
```typescript
describe('Yield Analysis Report', () => {
  beforeEach(() => {
    cy.login('production_manager');
    cy.visit('/production/analytics/yield');
  });

  it('displays report with default filters');
  it('shows statistics panel with calculated values');
  it('renders yield trend chart');
  it('renders product comparison chart');
  it('filters by date range');
  it('filters by product selection');
  it('updates outlier table when threshold changed');
  it('navigates to WO detail when WO clicked');
  it('exports CSV file');
  it('shows empty state when no data');
  it('handles API errors gracefully');
});
```

---

## Security Considerations

1. **RLS Enforcement**
   - All queries filter by org_id from current user session
   - No cross-tenant data leakage possible
   - API validates org_id ownership for all resources

2. **Authorization**
   - Read-only analytics available to all production roles
   - Export requires authenticated user
   - No sensitive personal data exposed (only aggregated stats)

3. **Rate Limiting**
   - Export endpoint limited to 10 requests per minute
   - Report generation limited to 60 requests per minute

4. **Input Validation**
   - All query parameters validated with Zod schemas
   - Date range limited to maximum 1 year
   - Array parameters limited to 50 items

---

## Deliverables

### API Routes
- [ ] `GET /api/production/analytics/yield` - Main analytics endpoint
- [ ] `GET /api/production/analytics/yield/trend` - Trend data endpoint
- [ ] `GET /api/production/analytics/yield/outliers` - Outliers endpoint
- [ ] `GET /api/production/analytics/yield/export` - CSV export endpoint

### Services
- [ ] `lib/services/yield-analytics-service.ts` - Analytics business logic

### Validation
- [ ] `lib/validation/yield-analytics.ts` - Zod schemas

### Components
- [ ] `YieldAnalyticsPage.tsx` - Main page
- [ ] `YieldTrendChart.tsx` - Trend visualization
- [ ] `YieldProductComparison.tsx` - Product comparison chart
- [ ] `YieldOperatorComparison.tsx` - Operator performance chart
- [ ] `YieldLineComparison.tsx` - Line comparison chart
- [ ] `YieldOutlierScatter.tsx` - Scatter plot
- [ ] `YieldOutlierTable.tsx` - Outliers table
- [ ] `YieldStatisticsPanel.tsx` - Statistics cards
- [ ] `YieldDataTable.tsx` - Data table with pagination
- [ ] `YieldFilters.tsx` - Filter panel
- [ ] `YieldExportButton.tsx` - Export button

### Tests
- [ ] Unit tests for yield-analytics-service (>80% coverage)
- [ ] Integration tests for API endpoints
- [ ] E2E tests for report workflow

---

## Definition of Done

- [ ] Report page accessible at `/production/analytics/yield`
- [ ] Statistics panel displays avg, median, min, max, std dev, count
- [ ] Trend chart renders with daily/weekly/monthly aggregation
- [ ] Product comparison chart sorts by yield descending
- [ ] Operator performance chart displays correctly
- [ ] Line comparison chart displays correctly
- [ ] Outlier scatter plot renders with threshold line
- [ ] Outlier table shows WOs below threshold with severity badges
- [ ] Threshold slider updates outliers dynamically
- [ ] All filters functional (date, product, line, operator)
- [ ] Filter chips show active filters
- [ ] Reset filters returns to defaults
- [ ] Data table paginated and sortable
- [ ] CSV export downloads correct data
- [ ] Empty state displays when no data
- [ ] Error state displays on API failure
- [ ] Performance: Initial load < 3s, filter update < 2s
- [ ] RLS enforced - users see only their org's data
- [ ] Unit tests >80% coverage
- [ ] Integration tests pass
- [ ] E2E tests pass
- [ ] Responsive design works on tablet and desktop

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2026-01-14 | Initial story creation | ARCHITECT-AGENT |
