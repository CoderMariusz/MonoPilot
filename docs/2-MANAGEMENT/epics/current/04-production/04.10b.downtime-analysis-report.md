# 04.10b - Downtime Analysis Report

**Story ID:** 04.10b
**Epic:** 04 - Production
**Phase:** Phase 2
**Complexity:** M (Medium)
**Estimate:** 3 days
**Type:** Backend + Frontend
**State:** ready
**Priority:** P2

**Primary PRD:** `docs/1-BASELINE/product/modules/PRODUCTION.md` (FR-PROD-022b)
**Architecture:** `docs/1-BASELINE/architecture/modules/production.md`
**UX Wireframes:** PROD-020 (Downtime Analysis), PROD-021 (Pareto Chart)

## PRD References

| FR ID | Requirement | Priority | Phase | Covered |
|-------|-------------|----------|-------|---------|
| FR-PROD-022b | Downtime Analysis Report | P1 | Phase 2 | Yes |

---

## User Story

**As a** production manager,
**I want** to analyze downtime patterns with Pareto charts and detailed breakdowns,
**So that** I can identify the biggest contributors to lost production time and prioritize improvement efforts.

**As a** maintenance supervisor,
**I want** to see downtime trends by machine and category over time,
**So that** I can plan preventive maintenance schedules and reduce unplanned downtime.

**As a** plant director,
**I want** to compare planned vs unplanned downtime distribution,
**So that** I can understand production efficiency and make strategic decisions about equipment investments.

---

## Goal

Implement a comprehensive Downtime Analysis Report with Pareto analysis, planned vs unplanned breakdown, reason code distribution, and machine-level performance metrics. Enable export capabilities and interactive filtering for data exploration.

---

## Scope

**In scope (this story):**
- Pareto chart by downtime category (sorted by total duration)
- Pareto chart by reason code (top 10)
- Planned vs unplanned downtime breakdown (pie chart)
- Downtime trend over time (line chart)
- Top machines by downtime table
- Downtime frequency vs duration analysis
- Summary statistics (total hours, avg duration, event count)
- Filter by: date range, machine, line, category, shift, planned/unplanned
- Export to CSV
- Print-friendly report layout
- API endpoint for report data

**Out of scope (this story):**
- Downtime logging and tracking (04.9b - prerequisite)
- Real-time downtime alerts (04.9b)
- Predictive downtime analysis (Phase 3)
- Cost per downtime hour calculation (future)
- Maintenance scheduling integration (future)

---

## Dependencies

| Story | Name | Requirement | Status |
|-------|------|-------------|--------|
| **04.9b** | Downtime Tracking | Required - downtime_logs table and data | PREREQUISITE |
| **04.9d** | Shift Management | Optional - shift filter | OPTIONAL |
| **01.10** | Machines | Required - machine reference data | PREREQUISITE |
| **01.11** | Production Lines | Required - line filter | PREREQUISITE |
| **04.5** | Production Settings | Required - enable_downtime_tracking | PREREQUISITE |

**Dependency Graph:**
```
01.10 (Machines) + 01.11 (Lines)
    |
    v
04.9b (Downtime Tracking)
    |
    v
04.10b (Downtime Analysis Report) <-- THIS STORY
```

---

## Acceptance Criteria (Given/When/Then)

### AC-1: Pareto Chart by Category

**Given** downtime data exists for multiple categories
**When** Pareto chart rendered
**Then** categories sorted by total duration (highest first)

**Given** 5 categories with durations: Breakdown=300min, Changeover=200min, Material Wait=150min, Maintenance=100min, Other=50min
**When** Pareto chart displayed
**Then** bars display in order: Breakdown (37.5%), Changeover (25%), Material Wait (18.75%), Maintenance (12.5%), Other (6.25%)

**Given** Pareto chart rendered
**When** displayed
**Then** cumulative percentage line overlays bars (reaching 100% at rightmost bar)

**Given** user hovers over Pareto bar
**When** tooltip displayed
**Then** shows: Category name, Total minutes, Event count, Percentage of total

**Given** filter = "Unplanned only" applied
**When** Pareto chart regenerates
**Then** only is_planned = false categories display

**Given** no downtime data for selected filters
**When** Pareto chart area rendered
**Then** message "No downtime data for selected criteria" displays

### AC-2: Pareto Chart by Reason Code

**Given** downtime data exists with reason codes
**When** Top 10 Reason Codes table rendered
**Then** reason codes sorted by frequency (highest first)

**Given** top 10 reasons table displayed
**When** rendered
**Then** columns show: Rank, Reason Code, Category, Count, Total Minutes, Avg Minutes

**Given** more than 10 reason codes exist
**When** table rendered
**Then** only top 10 display with "View All" link

**Given** user clicks "View All" on reason codes
**When** clicked
**Then** expanded modal shows all reason codes with same columns

**Given** reason code has count = 0 in selected period
**When** table filtered
**Then** reason code does not appear in table

### AC-3: Planned vs Unplanned Breakdown

**Given** downtime data exists with is_planned values
**When** Planned vs Unplanned pie chart rendered
**Then** pie shows two segments: Planned (blue) and Unplanned (red)

**Given** total downtime = 800 minutes, unplanned = 500 minutes, planned = 300 minutes
**When** pie chart displayed
**Then** Unplanned = 62.5%, Planned = 37.5%

**Given** user hovers over pie segment
**When** tooltip displayed
**Then** shows: Type (Planned/Unplanned), Total minutes, Percentage, Event count

**Given** all downtime is planned (0 unplanned)
**When** pie chart rendered
**Then** single segment "Planned: 100%" displays

**Given** all downtime is unplanned (0 planned)
**When** pie chart rendered
**Then** single segment "Unplanned: 100%" displays

### AC-4: Downtime Trend Over Time

**Given** date range = "Last 30 days"
**When** trend line chart rendered
**Then** shows daily downtime total (in hours) for each day

**Given** trend chart displayed
**When** rendered
**Then** X-axis shows dates, Y-axis shows hours

**Given** user hovers over data point on trend
**When** tooltip displayed
**Then** shows: Date, Total Hours, Planned Hours, Unplanned Hours, Event Count

**Given** two separate lines configured
**When** trend chart rendered
**Then** Planned (blue) and Unplanned (red) lines display separately

**Given** date range = "Last 7 days"
**When** trend chart rendered
**Then** shows daily values for each of the 7 days

**Given** machine filter = "Machine A" applied
**When** trend chart regenerates
**Then** shows trend only for Machine A

### AC-5: Top Machines by Downtime

**Given** downtime data exists for multiple machines
**When** Top Machines table rendered
**Then** machines sorted by total downtime duration (highest first)

**Given** Top Machines table displayed
**When** rendered
**Then** columns show: Rank, Machine Name, Line, Total Hours, Unplanned %, Event Count, Avg Duration

**Given** 10 machines have downtime data
**When** table rendered
**Then** all 10 machines display (no pagination for this summary table)

**Given** machine has 0 downtime in selected period
**When** table filtered
**Then** machine does not appear in table

**Given** user clicks machine name in table
**When** clicked
**Then** filters report to show only that machine's data

### AC-6: Summary Statistics Panel

**Given** downtime analysis report loads
**When** summary panel rendered
**Then** displays: Total Downtime Hours, Total Events, Unplanned %, Avg Duration (minutes), Top Category, Top Reason

**Given** 10 downtime events with total = 600 minutes
**When** summary calculated
**Then** Total Hours = 10.0h, Total Events = 10, Avg Duration = 60 min

**Given** unplanned = 400 minutes, total = 600 minutes
**When** Unplanned % calculated
**Then** Unplanned % = 66.7%

**Given** most common category = "Breakdown" (5 events)
**When** Top Category displayed
**Then** shows "Breakdown (5 events)"

**Given** most common reason = "Motor Failure" (3 events)
**When** Top Reason displayed
**Then** shows "Motor Failure (3 events)"

### AC-7: Filter Controls

**Given** user views Downtime Analysis Report
**When** page loads
**Then** filter controls display: Date Range, Machine, Line, Category, Shift, Planned/Unplanned toggle

**Given** date range filter
**When** rendered
**Then** presets include: Today, Last 7 Days, Last 30 Days, Last 90 Days, Custom

**Given** machine filter dropdown
**When** opened
**Then** lists all active machines with option "All Machines"

**Given** category filter dropdown
**When** opened
**Then** lists all 9 downtime categories with option "All Categories"

**Given** user selects multiple filters
**When** filters applied
**Then** all filters combine with AND logic

**Given** user clicks "Reset Filters"
**When** clicked
**Then** all filters reset to default (Last 30 Days, All)

**Given** filter changes applied
**When** report regenerates
**Then** all charts and tables update within 2 seconds

### AC-8: Export to CSV

**Given** user clicks "Export CSV" button
**When** export triggered
**Then** CSV file downloads with all downtime records matching current filters

**Given** CSV export generated
**When** file opened
**Then** columns include: Date, Machine, Line, Category, Reason Code, Started At, Ended At, Duration (min), Planned/Unplanned, Notes

**Given** 1000 downtime records match filters
**When** export triggered
**Then** CSV includes all 1000 records

**Given** no downtime records match filters
**When** export triggered
**Then** CSV downloads with headers only and message "No data"

**Given** export in progress
**When** button clicked
**Then** loading spinner displays, button disabled

### AC-9: Print-Friendly Layout

**Given** user clicks "Print Report" button
**When** print preview opens
**Then** report displays in single-page or multi-page print format

**Given** print layout rendered
**When** displayed
**Then** includes: Report title, Date range, Filters applied, Summary stats, Pareto chart, Pie chart, Top machines table

**Given** print layout rendered
**When** displayed
**Then** excludes: Navigation, Filter controls, Export buttons

**Given** charts in print mode
**When** rendered
**Then** charts use print-friendly colors (no gradient backgrounds)

### AC-10: Report Page Navigation

**Given** enable_downtime_tracking = true
**When** user navigates to `/production/reports/downtime`
**Then** Downtime Analysis Report page loads within 2 seconds

**Given** enable_downtime_tracking = false
**When** user navigates to `/production/reports/downtime`
**Then** message "Downtime tracking is disabled. Enable in Settings." displays

**Given** user on Production Dashboard
**When** clicks "View Reports" or "Downtime Analysis"
**Then** navigates to `/production/reports/downtime`

**Given** sidebar navigation
**When** Production > Reports expanded
**Then** "Downtime Analysis" link visible

### AC-11: Multi-tenancy and RLS

**Given** User from Org A views Downtime Analysis Report
**When** data loads
**Then** only Org A downtime data returned

**Given** User from Org A attempts to filter by Org B machine
**When** API called
**Then** machine not found in dropdown (not exposed)

**Given** downtime_logs table
**When** RLS policy applied
**Then** org_id filter automatically enforced on all queries

---

## Technical Specification

### Database Queries

#### Pareto by Category Query

```sql
SELECT
  category,
  COUNT(*) AS event_count,
  SUM(duration_minutes) AS total_minutes,
  AVG(duration_minutes) AS avg_minutes,
  ROUND(SUM(duration_minutes) * 100.0 / SUM(SUM(duration_minutes)) OVER (), 2) AS percentage
FROM downtime_logs
WHERE org_id = :org_id
  AND is_deleted = false
  AND started_at >= :start_date
  AND started_at < :end_date
  AND (:machine_id IS NULL OR machine_id = :machine_id)
  AND (:category IS NULL OR category = :category)
  AND (:is_planned IS NULL OR is_planned = :is_planned)
GROUP BY category
ORDER BY total_minutes DESC;
```

#### Pareto by Reason Code Query

```sql
SELECT
  reason_code,
  category,
  COUNT(*) AS event_count,
  SUM(duration_minutes) AS total_minutes,
  AVG(duration_minutes) AS avg_minutes
FROM downtime_logs
WHERE org_id = :org_id
  AND is_deleted = false
  AND reason_code IS NOT NULL
  AND started_at >= :start_date
  AND started_at < :end_date
  AND (:machine_id IS NULL OR machine_id = :machine_id)
  AND (:is_planned IS NULL OR is_planned = :is_planned)
GROUP BY reason_code, category
ORDER BY event_count DESC
LIMIT 10;
```

#### Planned vs Unplanned Query

```sql
SELECT
  is_planned,
  COUNT(*) AS event_count,
  SUM(duration_minutes) AS total_minutes,
  ROUND(SUM(duration_minutes) * 100.0 / SUM(SUM(duration_minutes)) OVER (), 2) AS percentage
FROM downtime_logs
WHERE org_id = :org_id
  AND is_deleted = false
  AND started_at >= :start_date
  AND started_at < :end_date
  AND (:machine_id IS NULL OR machine_id = :machine_id)
GROUP BY is_planned;
```

#### Daily Trend Query

```sql
SELECT
  DATE(started_at) AS date,
  SUM(duration_minutes) AS total_minutes,
  SUM(CASE WHEN is_planned THEN duration_minutes ELSE 0 END) AS planned_minutes,
  SUM(CASE WHEN NOT is_planned THEN duration_minutes ELSE 0 END) AS unplanned_minutes,
  COUNT(*) AS event_count
FROM downtime_logs
WHERE org_id = :org_id
  AND is_deleted = false
  AND started_at >= :start_date
  AND started_at < :end_date
  AND (:machine_id IS NULL OR machine_id = :machine_id)
GROUP BY DATE(started_at)
ORDER BY date;
```

#### Top Machines Query

```sql
SELECT
  m.id AS machine_id,
  m.name AS machine_name,
  pl.name AS line_name,
  COUNT(*) AS event_count,
  SUM(dl.duration_minutes) AS total_minutes,
  AVG(dl.duration_minutes) AS avg_minutes,
  ROUND(SUM(CASE WHEN NOT dl.is_planned THEN dl.duration_minutes ELSE 0 END) * 100.0 /
    NULLIF(SUM(dl.duration_minutes), 0), 1) AS unplanned_percent
FROM downtime_logs dl
JOIN machines m ON dl.machine_id = m.id
LEFT JOIN production_lines pl ON m.production_line_id = pl.id
WHERE dl.org_id = :org_id
  AND dl.is_deleted = false
  AND dl.started_at >= :start_date
  AND dl.started_at < :end_date
GROUP BY m.id, m.name, pl.name
ORDER BY total_minutes DESC
LIMIT 10;
```

### API Endpoints

```
# Downtime Analysis Report
GET    /api/production/analytics/downtime-analysis    - Full report data (combined)

# Individual Report Sections (optional, for lazy loading)
GET    /api/production/analytics/downtime/summary     - Summary statistics
GET    /api/production/analytics/downtime/pareto-category  - Pareto by category
GET    /api/production/analytics/downtime/pareto-reason    - Pareto by reason code
GET    /api/production/analytics/downtime/planned-unplanned - Pie chart data
GET    /api/production/analytics/downtime/trend       - Daily trend data
GET    /api/production/analytics/downtime/top-machines - Top machines table

# Export
POST   /api/production/analytics/downtime/export      - Export to CSV

Query Parameters (all endpoints):
  - start_date: string (ISO date) - Required
  - end_date: string (ISO date) - Required
  - machine_id: string (UUID) - Optional
  - line_id: string (UUID) - Optional
  - category: string - Optional
  - shift_id: string (UUID) - Optional
  - is_planned: boolean - Optional
```

### Service Methods

**Location:** `lib/services/downtime-analytics-service.ts`

```typescript
interface DowntimeAnalyticsService {
  // Full Report
  getDowntimeAnalysisReport(params: DowntimeReportParams): Promise<DowntimeAnalysisReport>;

  // Individual Sections
  getSummaryStats(params: DowntimeReportParams): Promise<DowntimeSummaryStats>;
  getParetoByCategory(params: DowntimeReportParams): Promise<ParetoCategoryData[]>;
  getParetoByReasonCode(params: DowntimeReportParams): Promise<ParetoReasonData[]>;
  getPlannedUnplannedBreakdown(params: DowntimeReportParams): Promise<PlannedUnplannedData>;
  getDailyTrend(params: DowntimeReportParams): Promise<DailyTrendData[]>;
  getTopMachines(params: DowntimeReportParams): Promise<TopMachineData[]>;

  // Export
  exportToCSV(params: DowntimeReportParams): Promise<string>; // Returns CSV string

  // Helpers
  calculateCumulativePercent(data: ParetoCategoryData[]): ParetoCategoryData[];
  formatDuration(minutes: number): string; // "2h 30m" format
}

interface DowntimeReportParams {
  org_id: string;
  start_date: Date;
  end_date: Date;
  machine_id?: string;
  line_id?: string;
  category?: string;
  shift_id?: string;
  is_planned?: boolean;
}

interface DowntimeAnalysisReport {
  summary: DowntimeSummaryStats;
  paretoByCategory: ParetoCategoryData[];
  paretoByReason: ParetoReasonData[];
  plannedUnplanned: PlannedUnplannedData;
  dailyTrend: DailyTrendData[];
  topMachines: TopMachineData[];
  filters: AppliedFilters;
  generatedAt: string;
}

interface DowntimeSummaryStats {
  totalMinutes: number;
  totalHours: number;
  totalEvents: number;
  unplannedPercent: number;
  avgDurationMinutes: number;
  topCategory: { name: string; count: number };
  topReason: { name: string; count: number } | null;
}

interface ParetoCategoryData {
  category: string;
  categoryLabel: string;
  eventCount: number;
  totalMinutes: number;
  avgMinutes: number;
  percentage: number;
  cumulativePercent: number;
  isPlanned: boolean;
}

interface ParetoReasonData {
  reasonCode: string;
  reasonLabel: string;
  category: string;
  eventCount: number;
  totalMinutes: number;
  avgMinutes: number;
  rank: number;
}

interface PlannedUnplannedData {
  planned: {
    minutes: number;
    hours: number;
    eventCount: number;
    percentage: number;
  };
  unplanned: {
    minutes: number;
    hours: number;
    eventCount: number;
    percentage: number;
  };
  total: {
    minutes: number;
    hours: number;
    eventCount: number;
  };
}

interface DailyTrendData {
  date: string;
  totalMinutes: number;
  totalHours: number;
  plannedMinutes: number;
  unplannedMinutes: number;
  eventCount: number;
}

interface TopMachineData {
  rank: number;
  machineId: string;
  machineName: string;
  lineName: string | null;
  totalMinutes: number;
  totalHours: number;
  eventCount: number;
  avgMinutes: number;
  unplannedPercent: number;
}

interface AppliedFilters {
  startDate: string;
  endDate: string;
  machineName?: string;
  lineName?: string;
  category?: string;
  shiftName?: string;
  isPlanned?: boolean;
}
```

### Zod Validation Schemas

**Location:** `lib/validation/downtime-analytics-schema.ts`

```typescript
import { z } from 'zod';

// Report Query Parameters
export const downtimeReportQuerySchema = z.object({
  start_date: z.string().date('Invalid start date'),
  end_date: z.string().date('Invalid end date'),
  machine_id: z.string().uuid().optional(),
  line_id: z.string().uuid().optional(),
  category: z.string().optional(),
  shift_id: z.string().uuid().optional(),
  is_planned: z.coerce.boolean().optional(),
}).refine(
  (data) => new Date(data.end_date) >= new Date(data.start_date),
  { message: 'End date must be on or after start date', path: ['end_date'] }
).refine(
  (data) => {
    const daysDiff = (new Date(data.end_date).getTime() - new Date(data.start_date).getTime()) / (1000 * 60 * 60 * 24);
    return daysDiff <= 365;
  },
  { message: 'Date range cannot exceed 365 days', path: ['end_date'] }
);

// Export Request Schema
export const downtimeExportRequestSchema = downtimeReportQuerySchema.extend({
  format: z.enum(['csv']).default('csv'),
  include_notes: z.boolean().default(false),
});

// Response Schemas
export const pareto CategoryDataSchema = z.object({
  category: z.string(),
  category_label: z.string(),
  event_count: z.number().int().min(0),
  total_minutes: z.number().min(0),
  avg_minutes: z.number().min(0),
  percentage: z.number().min(0).max(100),
  cumulative_percent: z.number().min(0).max(100),
  is_planned: z.boolean(),
});

export const paretoCategoryListSchema = z.array(pareto CategoryDataSchema);

export const plannedUnplannedDataSchema = z.object({
  planned: z.object({
    minutes: z.number().min(0),
    hours: z.number().min(0),
    event_count: z.number().int().min(0),
    percentage: z.number().min(0).max(100),
  }),
  unplanned: z.object({
    minutes: z.number().min(0),
    hours: z.number().min(0),
    event_count: z.number().int().min(0),
    percentage: z.number().min(0).max(100),
  }),
  total: z.object({
    minutes: z.number().min(0),
    hours: z.number().min(0),
    event_count: z.number().int().min(0),
  }),
});

export const dailyTrendDataSchema = z.object({
  date: z.string().date(),
  total_minutes: z.number().min(0),
  total_hours: z.number().min(0),
  planned_minutes: z.number().min(0),
  unplanned_minutes: z.number().min(0),
  event_count: z.number().int().min(0),
});

export const dailyTrendListSchema = z.array(dailyTrendDataSchema);

export const summaryStatsSchema = z.object({
  total_minutes: z.number().min(0),
  total_hours: z.number().min(0),
  total_events: z.number().int().min(0),
  unplanned_percent: z.number().min(0).max(100),
  avg_duration_minutes: z.number().min(0),
  top_category: z.object({
    name: z.string(),
    count: z.number().int().min(0),
  }),
  top_reason: z.object({
    name: z.string(),
    count: z.number().int().min(0),
  }).nullable(),
});

export type DowntimeReportQuery = z.infer<typeof downtimeReportQuerySchema>;
export type DowntimeExportRequest = z.infer<typeof downtimeExportRequestSchema>;
```

---

## UI Components

### Pages

- `app/(authenticated)/production/reports/downtime/page.tsx` - Downtime Analysis Report page

### Components

**Location:** `components/production/reports/downtime/`

```
DowntimeAnalysisReport.tsx       - Main report container
DowntimeSummaryPanel.tsx         - Summary statistics panel
DowntimeParetoChart.tsx          - Pareto chart (category) with cumulative line
DowntimeReasonTable.tsx          - Top 10 reason codes table
DowntimePieChart.tsx             - Planned vs Unplanned pie chart
DowntimeTrendChart.tsx           - Daily trend line chart
DowntimeTopMachinesTable.tsx     - Top machines by downtime table
DowntimeReportFilters.tsx        - Filter controls panel
DowntimeExportButton.tsx         - Export to CSV button
DowntimePrintButton.tsx          - Print report button
DowntimeNoDataMessage.tsx        - Empty state message
DowntimeDateRangePresets.tsx     - Date range preset buttons
```

### Component Specifications

**DowntimeAnalysisReport.tsx**
```tsx
interface DowntimeAnalysisReportProps {
  initialFilters?: DowntimeReportFilters;
}

// Layout:
// 1. Filter bar (sticky top)
// 2. Summary panel (stats cards)
// 3. Two-column grid:
//    - Left: Pareto chart (category)
//    - Right: Planned vs Unplanned pie
// 4. Trend chart (full width)
// 5. Two-column grid:
//    - Left: Top machines table
//    - Right: Top reasons table
```

**DowntimeParetoChart.tsx**
```tsx
interface DowntimeParetoChartProps {
  data: ParetoCategoryData[];
  onCategoryClick?: (category: string) => void;
  height?: number;
  showCumulativeLine?: boolean;
}

// Chart features:
// - Vertical bars for each category
// - Cumulative percentage line overlay
// - Color coding by planned (blue) vs unplanned (red)
// - Tooltips with details
// - Click to filter by category
```

**DowntimePieChart.tsx**
```tsx
interface DowntimePieChartProps {
  data: PlannedUnplannedData;
  height?: number;
  showLegend?: boolean;
}

// Chart features:
// - Two segments: Planned (blue), Unplanned (red)
// - Center label showing total hours
// - Percentage labels on segments
// - Hover tooltips with detailed stats
```

**DowntimeTrendChart.tsx**
```tsx
interface DowntimeTrendChartProps {
  data: DailyTrendData[];
  showPlannedLine?: boolean;
  showUnplannedLine?: boolean;
  height?: number;
}

// Chart features:
// - Line chart with date on X-axis
// - Y-axis in hours
// - Optional separate lines for planned/unplanned
// - Area fill under lines
// - Tooltips on hover
```

**DowntimeSummaryPanel.tsx**
```tsx
interface DowntimeSummaryPanelProps {
  stats: DowntimeSummaryStats;
  isLoading?: boolean;
}

// Cards layout:
// +--------+ +--------+ +--------+ +--------+ +--------+ +--------+
// | Total  | | Events | | Unpln% | | Avg    | | Top    | | Top    |
// | Hours  | |        | |        | | Dur.   | | Cat.   | | Reason |
// +--------+ +--------+ +--------+ +--------+ +--------+ +--------+
```

**DowntimeReportFilters.tsx**
```tsx
interface DowntimeReportFiltersProps {
  filters: DowntimeReportFilters;
  onChange: (filters: DowntimeReportFilters) => void;
  machines: Machine[];
  lines: ProductionLine[];
  shifts: Shift[];
  onReset: () => void;
}

// Filter controls:
// - Date range picker with presets
// - Machine dropdown (multi-select optional)
// - Line dropdown
// - Category dropdown (multi-select optional)
// - Shift dropdown
// - Planned/Unplanned toggle (All | Planned | Unplanned)
// - Reset button
```

### UI Layout

**Report Page Layout:**
```
+------------------------------------------------------------------+
| Downtime Analysis Report                    [Export] [Print]      |
+------------------------------------------------------------------+
| Filters: [Date Range v] [Machine v] [Line v] [Category v] [Reset] |
+------------------------------------------------------------------+
|                                                                   |
|  SUMMARY                                                          |
|  +-------+ +-------+ +-------+ +-------+ +-------+ +-------+      |
|  | 42.5h | | 85    | | 62.5% | | 30min | | Break-| | Motor |      |
|  | Total | | Events| | Unpln | | Avg   | | down  | | Fail  |      |
|  +-------+ +-------+ +-------+ +-------+ +-------+ +-------+      |
|                                                                   |
|  +-----------------------------+ +-----------------------------+  |
|  | PARETO BY CATEGORY          | | PLANNED vs UNPLANNED        |  |
|  |                             | |                             |  |
|  | [Bar Chart]                 | |    [Pie Chart]              |  |
|  | with cumulative line        | |    Planned: 37.5%           |  |
|  |                             | |    Unplanned: 62.5%         |  |
|  +-----------------------------+ +-----------------------------+  |
|                                                                   |
|  DOWNTIME TREND (Last 30 Days)                                    |
|  +-------------------------------------------------------------+  |
|  |  [Line Chart showing daily downtime hours]                  |  |
|  |  --- Planned    --- Unplanned                               |  |
|  +-------------------------------------------------------------+  |
|                                                                   |
|  +-----------------------------+ +-----------------------------+  |
|  | TOP MACHINES                | | TOP REASON CODES            |  |
|  | 1. Mixer-01      8.5h  20%  | | 1. Motor Failure    15      |  |
|  | 2. Filler-02     6.2h  45%  | | 2. Electrical Issue 12      |  |
|  | 3. Oven-01       5.8h  80%  | | 3. Product Change   10      |  |
|  | 4. Wrapper-01    4.1h  35%  | | 4. Raw Material     8       |  |
|  +-----------------------------+ +-----------------------------+  |
|                                                                   |
+------------------------------------------------------------------+
```

**Print Layout:**
```
+------------------------------------------------------------------+
|                   DOWNTIME ANALYSIS REPORT                        |
|                   [Company Name] | [Date Range]                   |
+------------------------------------------------------------------+
| Filters Applied: All Machines | All Categories | Unplanned Only   |
+------------------------------------------------------------------+
|                                                                   |
| SUMMARY                                                           |
| Total Downtime: 42.5 hours | Events: 85 | Unplanned: 62.5%       |
| Avg Duration: 30 min | Top Category: Breakdown | Top: Motor Fail  |
+------------------------------------------------------------------+
|                                                                   |
| [Pareto Chart - Print optimized]                                  |
|                                                                   |
+------------------------------------------------------------------+
|                                                                   |
| [Planned vs Unplanned Pie - Print optimized]                      |
|                                                                   |
+------------------------------------------------------------------+
|                                                                   |
| TOP MACHINES BY DOWNTIME                                          |
| +-----+------------+--------+-------+----------+------+------+    |
| | #   | Machine    | Line   | Hours | Unpl.%   | Cnt  | Avg  |    |
| +-----+------------+--------+-------+----------+------+------+    |
| | 1   | Mixer-01   | Line 1 | 8.5   | 20%      | 15   | 34m  |    |
| | 2   | Filler-02  | Line 1 | 6.2   | 45%      | 12   | 31m  |    |
| ...                                                               |
+------------------------------------------------------------------+
|                                                                   |
| Generated: [Timestamp] | Page 1 of 1                              |
+------------------------------------------------------------------+
```

---

## Test Cases

### Unit Tests

**downtime-analytics-service.test.ts**
```typescript
describe('DowntimeAnalyticsService', () => {
  describe('getSummaryStats', () => {
    it('calculates total hours correctly from minutes');
    it('calculates unplanned percentage correctly');
    it('identifies top category by event count');
    it('identifies top reason by event count');
    it('handles zero downtime records');
    it('handles null reason codes');
  });

  describe('getParetoByCategory', () => {
    it('sorts categories by total duration descending');
    it('calculates percentage of total correctly');
    it('calculates cumulative percentage correctly');
    it('filters by is_planned when specified');
    it('returns empty array when no data');
  });

  describe('getParetoByReasonCode', () => {
    it('returns top 10 reason codes by frequency');
    it('excludes null reason codes');
    it('includes category for each reason');
  });

  describe('getPlannedUnplannedBreakdown', () => {
    it('calculates planned vs unplanned correctly');
    it('handles 100% planned scenario');
    it('handles 100% unplanned scenario');
    it('handles zero downtime scenario');
  });

  describe('getDailyTrend', () => {
    it('groups downtime by date correctly');
    it('separates planned and unplanned per day');
    it('fills missing dates with zero values');
    it('orders by date ascending');
  });

  describe('getTopMachines', () => {
    it('sorts machines by total downtime descending');
    it('limits to top 10 machines');
    it('calculates unplanned percentage per machine');
    it('includes machine and line names');
  });

  describe('exportToCSV', () => {
    it('generates valid CSV with headers');
    it('includes all matching downtime records');
    it('formats dates correctly');
    it('handles special characters in notes');
  });

  describe('calculateCumulativePercent', () => {
    it('calculates cumulative correctly for 3 items');
    it('reaches 100% for last item');
    it('handles single item (100%)');
  });
});
```

### Integration Tests

**downtime-analytics-api.test.ts**
```typescript
describe('Downtime Analytics API', () => {
  describe('GET /api/production/analytics/downtime-analysis', () => {
    it('returns full report data with valid filters');
    it('returns 400 for missing date range');
    it('returns 400 for invalid date range (end before start)');
    it('returns 400 for date range exceeding 365 days');
    it('filters by machine_id correctly');
    it('filters by category correctly');
    it('filters by is_planned correctly');
    it('returns empty report structure when no data');
    it('enforces RLS (org_id filter)');
    it('returns 401 for unauthenticated request');
  });

  describe('POST /api/production/analytics/downtime/export', () => {
    it('returns CSV content with correct headers');
    it('includes all matching records');
    it('respects filters');
    it('handles large datasets (1000+ records)');
    it('returns empty CSV when no data');
  });

  describe('GET /api/production/analytics/downtime/summary', () => {
    it('returns summary stats');
    it('calculates metrics correctly');
    it('caches response for performance');
  });

  describe('GET /api/production/analytics/downtime/pareto-category', () => {
    it('returns Pareto data sorted correctly');
    it('includes cumulative percentage');
  });

  describe('GET /api/production/analytics/downtime/trend', () => {
    it('returns daily trend data');
    it('fills missing dates with zeros');
  });
});
```

### E2E Tests

**downtime-analysis-report.spec.ts**
```typescript
describe('Downtime Analysis Report', () => {
  beforeEach(() => {
    // Setup: Create test downtime data
  });

  it('loads report page and displays all sections');
  it('displays summary statistics correctly');
  it('renders Pareto chart with correct order');
  it('renders pie chart with planned vs unplanned');
  it('renders trend chart with daily data');
  it('renders top machines table');
  it('renders top reasons table');

  describe('Filtering', () => {
    it('filters by date range');
    it('filters by machine');
    it('filters by category');
    it('filters by planned/unplanned toggle');
    it('combines multiple filters');
    it('resets filters to default');
    it('updates all charts when filters change');
  });

  describe('Export', () => {
    it('exports CSV with current filter data');
    it('shows loading state during export');
    it('handles export error gracefully');
  });

  describe('Print', () => {
    it('opens print preview');
    it('shows print-optimized layout');
    it('excludes navigation elements');
  });

  describe('Interactions', () => {
    it('clicking Pareto bar filters by that category');
    it('clicking machine row filters by that machine');
    it('hovering chart elements shows tooltips');
  });

  describe('Edge Cases', () => {
    it('displays empty state when no data');
    it('displays disabled message when feature off');
    it('handles large datasets without performance issues');
  });
});
```

---

## Performance Considerations

1. **Query Optimization:**
   - Use database-level aggregations (not app-level)
   - Index on `(org_id, started_at, machine_id, is_planned)`
   - Limit date range to 365 days max

2. **Caching:**
   - Cache report data for 5 minutes (stale-while-revalidate)
   - Invalidate cache when new downtime logged

3. **Lazy Loading:**
   - Load summary first, then charts
   - Use skeleton loaders during data fetch

4. **Chart Performance:**
   - Limit data points on trend chart (max 90 days)
   - Use chart virtualization for large datasets

5. **Export Performance:**
   - Stream CSV for large exports (>5000 records)
   - Show progress indicator for large exports

---

## Deliverables

### API Routes
- [ ] `GET /api/production/analytics/downtime-analysis`
- [ ] `GET /api/production/analytics/downtime/summary`
- [ ] `GET /api/production/analytics/downtime/pareto-category`
- [ ] `GET /api/production/analytics/downtime/pareto-reason`
- [ ] `GET /api/production/analytics/downtime/planned-unplanned`
- [ ] `GET /api/production/analytics/downtime/trend`
- [ ] `GET /api/production/analytics/downtime/top-machines`
- [ ] `POST /api/production/analytics/downtime/export`

### Services
- [ ] `lib/services/downtime-analytics-service.ts`

### Validation
- [ ] `lib/validation/downtime-analytics-schema.ts`

### Components
- [ ] `DowntimeAnalysisReport.tsx` - Main container
- [ ] `DowntimeSummaryPanel.tsx` - Summary stats
- [ ] `DowntimeParetoChart.tsx` - Pareto by category
- [ ] `DowntimeReasonTable.tsx` - Top 10 reasons
- [ ] `DowntimePieChart.tsx` - Planned vs unplanned
- [ ] `DowntimeTrendChart.tsx` - Daily trend
- [ ] `DowntimeTopMachinesTable.tsx` - Top machines
- [ ] `DowntimeReportFilters.tsx` - Filter controls
- [ ] `DowntimeExportButton.tsx` - Export CSV
- [ ] `DowntimePrintButton.tsx` - Print report
- [ ] `DowntimeNoDataMessage.tsx` - Empty state

### Pages
- [ ] `app/(authenticated)/production/reports/downtime/page.tsx`

### Tests
- [ ] Unit tests for downtime-analytics-service (>80% coverage)
- [ ] Integration tests for all API endpoints
- [ ] E2E tests for report interactions

---

## Definition of Done

- [ ] Downtime Analysis Report page accessible at `/production/reports/downtime`
- [ ] Summary panel displays: Total Hours, Events, Unplanned %, Avg Duration, Top Category, Top Reason
- [ ] Pareto chart displays categories sorted by total duration with cumulative line
- [ ] Pareto chart shows percentage of total for each category
- [ ] Top 10 reason codes table displays with rank, code, category, count, duration
- [ ] Planned vs Unplanned pie chart displays with correct percentages
- [ ] Pie chart colors: Planned (blue), Unplanned (red)
- [ ] Trend chart shows daily downtime over selected date range
- [ ] Trend chart has separate lines for planned and unplanned
- [ ] Top machines table shows machines sorted by total downtime
- [ ] Top machines table includes unplanned percentage per machine
- [ ] Filter by date range works (presets: Today, 7D, 30D, 90D, Custom)
- [ ] Filter by machine dropdown works
- [ ] Filter by line dropdown works
- [ ] Filter by category dropdown works
- [ ] Filter by planned/unplanned toggle works
- [ ] Multiple filters combine with AND logic
- [ ] Reset filters button returns to defaults
- [ ] Export to CSV downloads file with all filtered data
- [ ] CSV includes columns: Date, Machine, Line, Category, Reason, Started, Ended, Duration, Planned, Notes
- [ ] Print button opens print-friendly layout
- [ ] Print layout excludes navigation and filter controls
- [ ] Report loads within 2 seconds for 30-day range
- [ ] Empty state message displays when no data matches filters
- [ ] Disabled message displays when enable_downtime_tracking = false
- [ ] Multi-tenant RLS enforced (users see only their org data)
- [ ] Cross-org data access returns 404 (not 403)
- [ ] Tooltips display on chart hover
- [ ] Clicking Pareto bar filters by that category
- [ ] Clicking machine name filters by that machine
- [ ] Unit test coverage >= 80%
- [ ] Integration tests pass for all endpoints
- [ ] E2E tests pass for critical flows

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-01-14 | Initial story creation | ARCHITECT-AGENT |
