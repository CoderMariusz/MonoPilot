# 04.10d - Production Output Report

**Story ID:** 04.10d
**Epic:** 04 - Production
**Phase:** Phase 2
**Complexity:** M (Medium)
**Estimate:** 2 days
**Type:** Backend + Frontend
**State:** ready
**Priority:** P2

**Primary PRD:** `docs/1-BASELINE/product/modules/PRODUCTION.md` (FR-PROD-022d)
**Architecture:** `docs/1-BASELINE/architecture/modules/production.md`
**UX Wireframes:** TBD (Production Output Report Dashboard)

## PRD References

| FR ID | Requirement | Priority | Phase | Covered |
|-------|-------------|----------|-------|---------|
| FR-PROD-022d | Production Output Report | P1 | Phase 2 | Yes |

---

## User Story

**As a** production manager,
**I want** to view production output reports showing units produced by product and production line over time,
**So that** I can analyze production trends, compare planned vs actual output, and make data-driven decisions about resource allocation.

**As a** plant supervisor,
**I want** to see stacked charts visualizing output by product category,
**So that** I can quickly identify which products contribute most to production volume and track performance against targets.

---

## Goal

Implement a comprehensive Production Output Report that aggregates production outputs by product, production line, and time period. Provide stacked area/bar charts for visual analysis, plan vs actual comparison, and detailed output summary tables with filtering and export capabilities.

---

## Scope

**In scope (this story):**
- Production output aggregation by product, line, shift, and time period
- Stacked area chart (output over time by product)
- Stacked bar chart (output by line)
- Plan vs Actual comparison chart
- Output summary table with breakdown by product/line
- Date range filtering (daily, weekly, monthly, custom)
- Product filter (single, multiple, or all)
- Production line filter (single, multiple, or all)
- Shift filter (Day/Night/All)
- UoM-aware aggregation (display in primary UoM)
- CSV/Excel export of report data
- Dashboard widget for Production Dashboard integration
- Service layer: `output-report-service.ts`
- Zod schema validation
- Unit and integration tests

**Out of scope (this story):**
- OEE integration and calculations (Story 04.9a)
- Quality Rate Report (Story 04.10f)
- Material Consumption Report (Story 04.10e)
- Real-time output streaming
- Predictive output forecasting (Phase 3)

---

## Dependencies

| Story | Name | Requirement | Status |
|-------|------|-------------|--------|
| **04.7a** | Output Registration Desktop | Required - production_outputs data | PREREQUISITE |
| **04.7b** | Output Registration Scanner | Optional - additional output data | OPTIONAL |
| **03.3** | Work Orders | Required - planned quantities | PREREQUISITE |
| **01.11** | Production Lines | Required - line configuration | PREREQUISITE |
| **04.9d** | Shift Management | Optional - shift-based filtering | OPTIONAL |

**Critical Path:**
```
04.7a (Output Registration) + 03.3 (Work Orders) + 01.11 (Production Lines)
    |
    v
04.10d (Production Output Report) <-- THIS STORY
```

---

## Acceptance Criteria (Given/When/Then)

### AC-1: Report Data Aggregation

**Given** date range = last 7 days
**When** report generated
**Then** total units produced displays per day with product breakdown

**Given** production_outputs exist for 5 products over 7 days
**When** report loads
**Then** all 5 products appear in stacked chart with distinct colors

**Given** production_outputs from multiple lines
**When** report aggregates data
**Then** output quantities summed correctly per line per day

**Given** outputs exist in different UoMs for same product
**When** report aggregates
**Then** quantities converted to product's primary UoM before summing

**Given** no outputs exist for selected date range
**When** report generated
**Then** message "No production data for selected period" displays with empty state

**Given** date range spans 1000+ outputs
**When** report loads
**Then** data displays within 5 seconds

### AC-2: Stacked Area Chart (Output Over Time)

**Given** report page loads
**When** stacked area chart rendered
**Then** X-axis shows dates, Y-axis shows quantity, each product has distinct color

**Given** multiple products produced
**When** stacked area chart rendered
**Then** each product layer stacks on previous, total height = total output

**Given** date range filter = "Last 30 Days"
**When** filter applied
**Then** stacked area chart updates to show daily values for 30 days

**Given** single product filter selected (Product A only)
**When** filter applied
**Then** chart shows only Product A as single area (not stacked)

**Given** user hovers over chart area
**When** tooltip displayed
**Then** shows: Date, Product Name, Quantity, Percentage of Day's Total

**Given** chart legend displayed
**When** user clicks on product in legend
**Then** that product's layer toggles visibility (show/hide)

### AC-3: Stacked Bar Chart (Output by Line)

**Given** report page loads
**When** line comparison chart rendered
**Then** horizontal bar chart shows each line with output quantity

**Given** 3 production lines active
**When** line comparison chart rendered
**Then** all 3 lines display with bars sized proportionally

**Given** line comparison chart with product breakdown
**When** stacked mode enabled
**Then** each line's bar shows product composition as stacked segments

**Given** user hovers over line bar segment
**When** tooltip displayed
**Then** shows: Line Name, Product Name, Quantity, Percentage

**Given** lines have different total outputs
**When** chart rendered
**Then** bars sorted by total output descending (highest first)

### AC-4: Plan vs Actual Comparison

**Given** work orders with planned_qty exist for date range
**When** plan vs actual chart rendered
**Then** bar chart shows grouped bars: planned (blue) vs actual (green) per product

**Given** actual output = 950 AND planned output = 1000 for Product A
**When** variance calculated
**Then** variance = -5.0% (below plan)

**Given** actual output = 1050 AND planned output = 1000 for Product A
**When** variance displayed
**Then** variance = +5.0% (green indicator, above plan)

**Given** no work orders exist (unplanned production)
**When** plan vs actual chart rendered
**Then** "Planned" bar shows as 0, actual shows registered output

**Given** variance < 0 (under plan)
**When** variance indicator displayed
**Then** shows red color with negative percentage

**Given** variance >= 0 (at or above plan)
**When** variance indicator displayed
**Then** shows green color with positive percentage

**Given** plan vs actual data
**When** variance tooltip displayed
**Then** shows: Product, Planned Qty, Actual Qty, Variance %, Variance Qty

### AC-5: Output Summary Table

**Given** report page loads
**When** summary table rendered
**Then** columns display: Product, Line, Planned, Actual, Variance %, Approved, Pending, Rejected

**Given** 10 products with outputs in date range
**When** summary table rendered
**Then** all 10 products listed with their metrics

**Given** summary table displayed
**When** user sorts by "Variance %" ascending
**Then** products sorted with most under-plan first

**Given** summary table row with negative variance
**When** row displayed
**Then** variance cell shows red background with negative value

**Given** summary table row with positive variance
**When** row displayed
**Then** variance cell shows green background with positive value

**Given** user clicks product row
**When** row clicked
**Then** expands to show daily breakdown for that product

**Given** summary table with expanded row
**When** daily breakdown displayed
**Then** shows: Date, Line, Shift, Quantity, QA Status breakdown

### AC-6: Filtering

**Given** date range picker displayed
**When** user selects "Last 7 Days"
**Then** report refreshes with last 7 days data

**Given** date range picker displayed
**When** user selects "Last 30 Days"
**Then** report refreshes with last 30 days data

**Given** date range picker displayed
**When** user selects "Custom" and picks Jan 1 - Jan 15
**Then** report shows data for Jan 1 through Jan 15 inclusive

**Given** product filter dropdown displayed
**When** user selects "Product A" and "Product B"
**Then** report shows only Product A and Product B data

**Given** product filter dropdown
**When** user selects "All Products"
**Then** report shows data for all products

**Given** line filter dropdown displayed
**When** user selects "Line 1"
**Then** report shows only Line 1 output data

**Given** shift filter dropdown displayed
**When** user selects "Day Shift"
**Then** report shows only Day shift output data

**Given** multiple filters applied
**When** filters combined (Product A + Line 1 + Day Shift)
**Then** report shows intersection of all filter criteria

### AC-7: Export Functionality

**Given** report displayed with data
**When** user clicks "Export CSV"
**Then** CSV file downloads within 2 seconds

**Given** CSV exported
**When** file opened
**Then** columns include: Date, Product, Product Code, Line, Shift, Planned Qty, Actual Qty, Variance %, UoM, Approved, Pending, Rejected

**Given** export with filters applied
**When** CSV generated
**Then** only filtered data included in export

**Given** report displayed
**When** user clicks "Export Excel"
**Then** Excel file downloads with formatted data and charts

**Given** large dataset (1000+ rows)
**When** export triggered
**Then** export completes within 10 seconds with progress indicator

### AC-8: Dashboard Widget

**Given** Production Dashboard loads
**When** Output Report widget rendered
**Then** shows mini summary: Today's Output, Week Total, Trend Arrow

**Given** Output Report widget displayed
**When** user clicks widget
**Then** navigates to full Production Output Report page

**Given** Output Report widget
**When** rendered
**Then** shows top 3 products by output quantity with mini bar chart

**Given** Output Report widget
**When** today's output > yesterday's output
**Then** trend arrow shows green up arrow with percentage increase

**Given** Output Report widget
**When** today's output < yesterday's output
**Then** trend arrow shows red down arrow with percentage decrease

### AC-9: Multi-tenancy and RLS

**Given** User from Org A views Output Report
**When** data loads
**Then** only Org A output data returned

**Given** User from Org A attempts to query Org B data
**When** API called
**Then** 404 Not Found returned (not 403)

**Given** production_outputs table
**When** RLS policy applied
**Then** org_id filter automatically enforced

---

## Technical Specification

### Database Schema

Uses existing tables from dependencies. Key queries aggregate from:

#### production_outputs table (from 04.7a via license_plates)

```sql
-- Query aggregation from license_plates with production source
SELECT
  DATE(lp.created_at) as output_date,
  lp.product_id,
  p.name as product_name,
  p.code as product_code,
  pl.id as line_id,
  pl.name as line_name,
  s.id as shift_id,
  s.name as shift_name,
  lp.uom,
  SUM(lp.quantity) as total_quantity,
  SUM(CASE WHEN lp.qa_status = 'approved' THEN lp.quantity ELSE 0 END) as approved_qty,
  SUM(CASE WHEN lp.qa_status = 'pending' THEN lp.quantity ELSE 0 END) as pending_qty,
  SUM(CASE WHEN lp.qa_status = 'rejected' THEN lp.quantity ELSE 0 END) as rejected_qty,
  COUNT(*) as output_count
FROM license_plates lp
JOIN products p ON p.id = lp.product_id
LEFT JOIN work_orders wo ON wo.id = lp.wo_id
LEFT JOIN production_lines pl ON pl.id = wo.line_id
LEFT JOIN shifts s ON s.id = wo.shift_id
WHERE lp.org_id = $org_id
  AND lp.source = 'production'
  AND lp.created_at BETWEEN $start_date AND $end_date
GROUP BY
  DATE(lp.created_at),
  lp.product_id, p.name, p.code,
  pl.id, pl.name,
  s.id, s.name,
  lp.uom
ORDER BY output_date DESC, total_quantity DESC;
```

### Database Views/Functions

```sql
-- Materialized view for output report aggregation (performance)
CREATE MATERIALIZED VIEW mv_production_output_daily AS
SELECT
  org_id,
  DATE(created_at) as output_date,
  product_id,
  wo_id,
  uom,
  SUM(quantity) as total_quantity,
  SUM(CASE WHEN qa_status = 'approved' THEN quantity ELSE 0 END) as approved_qty,
  SUM(CASE WHEN qa_status = 'pending' THEN quantity ELSE 0 END) as pending_qty,
  SUM(CASE WHEN qa_status = 'rejected' THEN quantity ELSE 0 END) as rejected_qty,
  COUNT(*) as output_count
FROM license_plates
WHERE source = 'production'
GROUP BY org_id, DATE(created_at), product_id, wo_id, uom;

-- Index for fast queries
CREATE INDEX idx_mv_output_daily_org_date ON mv_production_output_daily(org_id, output_date DESC);
CREATE INDEX idx_mv_output_daily_product ON mv_production_output_daily(org_id, product_id, output_date DESC);

-- Refresh function (called by scheduled job)
CREATE OR REPLACE FUNCTION refresh_output_daily_view()
RETURNS void AS $$
BEGIN
  REFRESH MATERIALIZED VIEW CONCURRENTLY mv_production_output_daily;
END;
$$ LANGUAGE plpgsql;

-- Function to get plan vs actual by product
CREATE OR REPLACE FUNCTION get_plan_vs_actual(
  p_org_id UUID,
  p_start_date DATE,
  p_end_date DATE,
  p_product_ids UUID[] DEFAULT NULL,
  p_line_ids UUID[] DEFAULT NULL
)
RETURNS TABLE (
  product_id UUID,
  product_name TEXT,
  product_code TEXT,
  planned_qty NUMERIC,
  actual_qty NUMERIC,
  variance_qty NUMERIC,
  variance_percent NUMERIC
) AS $$
BEGIN
  RETURN QUERY
  SELECT
    p.id as product_id,
    p.name as product_name,
    p.code as product_code,
    COALESCE(SUM(wo.planned_qty), 0) as planned_qty,
    COALESCE(SUM(lp_agg.total_qty), 0) as actual_qty,
    COALESCE(SUM(lp_agg.total_qty), 0) - COALESCE(SUM(wo.planned_qty), 0) as variance_qty,
    CASE
      WHEN COALESCE(SUM(wo.planned_qty), 0) = 0 THEN NULL
      ELSE ROUND(
        ((COALESCE(SUM(lp_agg.total_qty), 0) - COALESCE(SUM(wo.planned_qty), 0)) /
         NULLIF(SUM(wo.planned_qty), 0)) * 100, 1
      )
    END as variance_percent
  FROM products p
  LEFT JOIN work_orders wo ON wo.product_id = p.id
    AND wo.org_id = p_org_id
    AND wo.scheduled_date BETWEEN p_start_date AND p_end_date
    AND (p_line_ids IS NULL OR wo.line_id = ANY(p_line_ids))
  LEFT JOIN (
    SELECT
      lp.product_id,
      SUM(lp.quantity) as total_qty
    FROM license_plates lp
    WHERE lp.org_id = p_org_id
      AND lp.source = 'production'
      AND DATE(lp.created_at) BETWEEN p_start_date AND p_end_date
    GROUP BY lp.product_id
  ) lp_agg ON lp_agg.product_id = p.id
  WHERE p.org_id = p_org_id
    AND (p_product_ids IS NULL OR p.id = ANY(p_product_ids))
    AND (
      EXISTS (SELECT 1 FROM work_orders w WHERE w.product_id = p.id AND w.scheduled_date BETWEEN p_start_date AND p_end_date)
      OR EXISTS (SELECT 1 FROM license_plates l WHERE l.product_id = p.id AND l.source = 'production' AND DATE(l.created_at) BETWEEN p_start_date AND p_end_date)
    )
  GROUP BY p.id, p.name, p.code
  ORDER BY actual_qty DESC;
END;
$$ LANGUAGE plpgsql;
```

### RLS Policies

```sql
-- RLS for materialized view access through function wrapper
CREATE POLICY "output_report_org_isolation" ON license_plates
  FOR SELECT USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

-- RLS on work_orders for plan data
CREATE POLICY "wo_report_org_isolation" ON work_orders
  FOR SELECT USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));
```

### API Endpoints

```
# Output Report Data
GET    /api/production/analytics/output-report          - Get output report data
  Query params:
    - start_date: string (ISO date, required)
    - end_date: string (ISO date, required)
    - product_ids?: string[] (UUIDs)
    - line_ids?: string[] (UUIDs)
    - shift_ids?: string[] (UUIDs)
    - granularity: 'daily' | 'weekly' | 'monthly' (default: 'daily')

GET    /api/production/analytics/output-report/summary  - Get output summary by product/line
  Query params:
    - start_date: string
    - end_date: string
    - product_ids?: string[]
    - line_ids?: string[]
    - group_by: 'product' | 'line' | 'both' (default: 'product')

GET    /api/production/analytics/output-report/plan-vs-actual - Get plan vs actual comparison
  Query params:
    - start_date: string
    - end_date: string
    - product_ids?: string[]
    - line_ids?: string[]

GET    /api/production/analytics/output-report/by-line  - Get output breakdown by line
  Query params:
    - start_date: string
    - end_date: string
    - line_ids?: string[]

# Export
POST   /api/production/analytics/output-report/export   - Export report data
  Body:
    - format: 'csv' | 'xlsx'
    - start_date: string
    - end_date: string
    - filters: object
```

### Service Methods

**Location:** `lib/services/output-report-service.ts`

```typescript
interface OutputReportService {
  // Main report data
  getOutputReport(params: OutputReportParams): Promise<OutputReportData>;
  getOutputSummary(params: OutputSummaryParams): Promise<OutputSummary[]>;
  getPlanVsActual(params: PlanVsActualParams): Promise<PlanVsActualData[]>;
  getOutputByLine(params: LineReportParams): Promise<LineOutputData[]>;

  // Aggregation helpers
  aggregateByDate(outputs: RawOutput[], granularity: Granularity): DailyOutput[];
  aggregateByProduct(outputs: RawOutput[]): ProductOutput[];
  aggregateByLine(outputs: RawOutput[]): LineOutput[];

  // Calculations
  calculateVariance(planned: number, actual: number): VarianceResult;
  calculateTrend(current: number, previous: number): TrendResult;

  // Export
  exportToCSV(data: OutputReportData): Promise<Blob>;
  exportToExcel(data: OutputReportData): Promise<Blob>;

  // Widget
  getWidgetData(): Promise<OutputWidgetData>;
}

interface OutputReportParams {
  startDate: string;
  endDate: string;
  productIds?: string[];
  lineIds?: string[];
  shiftIds?: string[];
  granularity: 'daily' | 'weekly' | 'monthly';
}

interface OutputReportData {
  timeSeriesData: TimeSeriesDataPoint[];
  productBreakdown: ProductBreakdown[];
  lineBreakdown: LineBreakdown[];
  summary: ReportSummary;
  filters: AppliedFilters;
}

interface TimeSeriesDataPoint {
  date: string;
  products: {
    productId: string;
    productName: string;
    productCode: string;
    quantity: number;
    uom: string;
    color: string;
  }[];
  totalQuantity: number;
}

interface ProductBreakdown {
  productId: string;
  productName: string;
  productCode: string;
  plannedQty: number;
  actualQty: number;
  varianceQty: number;
  variancePercent: number | null;
  approvedQty: number;
  pendingQty: number;
  rejectedQty: number;
  uom: string;
}

interface LineBreakdown {
  lineId: string;
  lineName: string;
  totalQuantity: number;
  productBreakdown: {
    productId: string;
    productName: string;
    quantity: number;
    percentage: number;
    color: string;
  }[];
}

interface ReportSummary {
  totalOutputs: number;
  totalQuantity: number;
  primaryUom: string;
  avgDailyOutput: number;
  peakDay: { date: string; quantity: number };
  lowDay: { date: string; quantity: number };
  overallVariancePercent: number | null;
}

interface PlanVsActualData {
  productId: string;
  productName: string;
  productCode: string;
  plannedQty: number;
  actualQty: number;
  varianceQty: number;
  variancePercent: number | null;
  status: 'above_plan' | 'on_plan' | 'below_plan';
}

interface VarianceResult {
  varianceQty: number;
  variancePercent: number | null;
  status: 'above_plan' | 'on_plan' | 'below_plan';
}

interface TrendResult {
  direction: 'up' | 'down' | 'stable';
  changePercent: number;
  changeQty: number;
}

interface OutputWidgetData {
  todayOutput: number;
  weekTotal: number;
  monthTotal: number;
  trend: TrendResult;
  topProducts: {
    productName: string;
    quantity: number;
    percentage: number;
  }[];
  uom: string;
}

type Granularity = 'daily' | 'weekly' | 'monthly';
```

### Zod Validation Schemas

**Location:** `lib/validation/output-report-validation.ts`

```typescript
import { z } from 'zod';

// Output Report Query Schema
export const outputReportQuerySchema = z.object({
  start_date: z.string().date('Invalid start date'),
  end_date: z.string().date('Invalid end date'),
  product_ids: z.array(z.string().uuid()).optional(),
  line_ids: z.array(z.string().uuid()).optional(),
  shift_ids: z.array(z.string().uuid()).optional(),
  granularity: z.enum(['daily', 'weekly', 'monthly']).default('daily'),
}).refine(
  (data) => new Date(data.start_date) <= new Date(data.end_date),
  { message: 'Start date must be before or equal to end date' }
).refine(
  (data) => {
    const diffDays = (new Date(data.end_date).getTime() - new Date(data.start_date).getTime()) / (1000 * 60 * 60 * 24);
    return diffDays <= 365;
  },
  { message: 'Date range cannot exceed 365 days' }
);

// Output Summary Query Schema
export const outputSummaryQuerySchema = z.object({
  start_date: z.string().date(),
  end_date: z.string().date(),
  product_ids: z.array(z.string().uuid()).optional(),
  line_ids: z.array(z.string().uuid()).optional(),
  group_by: z.enum(['product', 'line', 'both']).default('product'),
});

// Plan vs Actual Query Schema
export const planVsActualQuerySchema = z.object({
  start_date: z.string().date(),
  end_date: z.string().date(),
  product_ids: z.array(z.string().uuid()).optional(),
  line_ids: z.array(z.string().uuid()).optional(),
});

// Export Request Schema
export const exportRequestSchema = z.object({
  format: z.enum(['csv', 'xlsx']),
  start_date: z.string().date(),
  end_date: z.string().date(),
  product_ids: z.array(z.string().uuid()).optional(),
  line_ids: z.array(z.string().uuid()).optional(),
  shift_ids: z.array(z.string().uuid()).optional(),
  include_daily_breakdown: z.boolean().default(false),
});

// Response Schemas
export const timeSeriesDataPointSchema = z.object({
  date: z.string().date(),
  products: z.array(z.object({
    product_id: z.string().uuid(),
    product_name: z.string(),
    product_code: z.string(),
    quantity: z.number().min(0),
    uom: z.string(),
    color: z.string(),
  })),
  total_quantity: z.number().min(0),
});

export const productBreakdownSchema = z.object({
  product_id: z.string().uuid(),
  product_name: z.string(),
  product_code: z.string(),
  planned_qty: z.number().min(0),
  actual_qty: z.number().min(0),
  variance_qty: z.number(),
  variance_percent: z.number().nullable(),
  approved_qty: z.number().min(0),
  pending_qty: z.number().min(0),
  rejected_qty: z.number().min(0),
  uom: z.string(),
});

export const lineBreakdownSchema = z.object({
  line_id: z.string().uuid(),
  line_name: z.string(),
  total_quantity: z.number().min(0),
  product_breakdown: z.array(z.object({
    product_id: z.string().uuid(),
    product_name: z.string(),
    quantity: z.number().min(0),
    percentage: z.number().min(0).max(100),
    color: z.string(),
  })),
});

export const outputReportResponseSchema = z.object({
  time_series_data: z.array(timeSeriesDataPointSchema),
  product_breakdown: z.array(productBreakdownSchema),
  line_breakdown: z.array(lineBreakdownSchema),
  summary: z.object({
    total_outputs: z.number().int().min(0),
    total_quantity: z.number().min(0),
    primary_uom: z.string(),
    avg_daily_output: z.number().min(0),
    peak_day: z.object({
      date: z.string().date(),
      quantity: z.number().min(0),
    }),
    low_day: z.object({
      date: z.string().date(),
      quantity: z.number().min(0),
    }),
    overall_variance_percent: z.number().nullable(),
  }),
  filters: z.object({
    start_date: z.string().date(),
    end_date: z.string().date(),
    product_ids: z.array(z.string().uuid()).optional(),
    line_ids: z.array(z.string().uuid()).optional(),
    shift_ids: z.array(z.string().uuid()).optional(),
    granularity: z.enum(['daily', 'weekly', 'monthly']),
  }),
});
```

---

## UI Components

### Pages

- `app/(authenticated)/production/reports/output/page.tsx` - Production Output Report page

### Components

**Location:** `components/production/reports/output/`

```
OutputReportDashboard.tsx      - Main report container with all sections
OutputStackedAreaChart.tsx     - Stacked area chart for time series
OutputStackedBarChart.tsx      - Stacked bar chart for line comparison
PlanVsActualChart.tsx          - Grouped bar chart for plan vs actual
OutputSummaryTable.tsx         - Detailed summary table with expansion
OutputReportFilters.tsx        - Date range, product, line, shift filters
OutputExportButton.tsx         - Export dropdown (CSV/Excel)
OutputReportWidget.tsx         - Mini widget for Production Dashboard
OutputTrendIndicator.tsx       - Trend arrow with percentage
VarianceIndicator.tsx          - Color-coded variance display
DateRangeSelector.tsx          - Date range picker with presets
ProductMultiSelect.tsx         - Multi-select dropdown for products
LineMultiSelect.tsx            - Multi-select dropdown for lines
```

### Component Details

**OutputStackedAreaChart.tsx**
```tsx
interface OutputStackedAreaChartProps {
  data: TimeSeriesDataPoint[];
  height?: number;
  showLegend?: boolean;
  onDataPointClick?: (date: string, product: string) => void;
}

// Chart features:
// - X-axis: Dates (formatted based on granularity)
// - Y-axis: Quantity (with UoM)
// - Stacked areas for each product
// - Distinct colors per product
// - Interactive legend (click to toggle)
// - Tooltips on hover
// - Responsive design
```

**OutputStackedBarChart.tsx**
```tsx
interface OutputStackedBarChartProps {
  data: LineBreakdown[];
  orientation?: 'horizontal' | 'vertical';
  showProductBreakdown?: boolean;
  onBarClick?: (lineId: string) => void;
}

// Chart features:
// - Horizontal bars for each line
// - Stacked segments for product breakdown
// - Sorted by total output descending
// - Tooltips showing product/quantity
// - Click to drill down
```

**PlanVsActualChart.tsx**
```tsx
interface PlanVsActualChartProps {
  data: PlanVsActualData[];
  showVariance?: boolean;
  sortBy?: 'planned' | 'actual' | 'variance';
  onProductClick?: (productId: string) => void;
}

// Chart features:
// - Grouped vertical bars (Planned blue, Actual green)
// - Variance percentage annotation
// - Color-coded variance (green positive, red negative)
// - Sorted by selected metric
// - Click to view product details
```

**OutputSummaryTable.tsx**
```tsx
interface OutputSummaryTableProps {
  data: ProductBreakdown[];
  sortable?: boolean;
  expandable?: boolean;
  onSort?: (column: string, direction: 'asc' | 'desc') => void;
  onRowExpand?: (productId: string) => Promise<DailyBreakdown[]>;
}

// Table columns:
// - Product (name + code)
// - Line
// - Planned Qty
// - Actual Qty
// - Variance % (color-coded)
// - Approved
// - Pending
// - Rejected
// - UoM
//
// Features:
// - Sortable columns
// - Expandable rows for daily breakdown
// - Color-coded variance cells
// - Click row to expand/collapse
```

**OutputReportFilters.tsx**
```tsx
interface OutputReportFiltersProps {
  filters: AppliedFilters;
  onChange: (filters: AppliedFilters) => void;
  onReset: () => void;
}

// Filter sections:
// - Date Range: [Preset v] [Start Date] - [End Date]
//   Presets: Today, Last 7 Days, Last 30 Days, This Month, Last Month, Custom
// - Products: [Multi-select with search]
// - Lines: [Multi-select with search]
// - Shifts: [Multi-select]
// - [Apply] [Reset]
```

**OutputReportWidget.tsx**
```tsx
interface OutputReportWidgetProps {
  data: OutputWidgetData;
  onClick?: () => void;
}

// Widget layout:
// +---------------------------+
// | Production Output         |
// | Today: 2,450 kg     [^5%] |
// |                           |
// | Week: 15,230 kg           |
// | Month: 62,100 kg          |
// |                           |
// | Top Products:             |
// | [=====] Product A  45%    |
// | [===] Product B    30%    |
// | [==] Product C     25%    |
// +---------------------------+
```

### UI Patterns

**Report Dashboard Layout:**
```
+------------------------------------------------------------------+
| Production Output Report                      [Export v] [Refresh] |
+------------------------------------------------------------------+
| Filters: [Last 7 Days v] [Products v] [Lines v] [Shifts v] [Apply]|
+------------------------------------------------------------------+
|                                                                    |
|  Summary Cards                                                     |
|  +------------+ +------------+ +------------+ +------------+       |
|  | Total      | | Avg Daily  | | Peak Day   | | Variance   |       |
|  | 15,230 kg  | | 2,176 kg   | | Jan 12     | | -3.2%      |       |
|  +------------+ +------------+ +------------+ +------------+       |
|                                                                    |
|  Output Over Time (Stacked Area)                                   |
|  +------------------------------------------------------------+  |
|  |    ___________                                              |  |
|  |   /           \    Product A                                |  |
|  |  /  Product B  \___________                                 |  |
|  | /                          \                                |  |
|  +------------------------------------------------------------+  |
|  | Jan 8 | Jan 9 | Jan 10 | Jan 11 | Jan 12 | Jan 13 | Jan 14 |  |
|                                                                    |
|  +---------------------------+  +-------------------------------+  |
|  | Output by Line            |  | Plan vs Actual                |  |
|  | [====] Line 1    8,500 kg |  | Prod A [==] [===] -8%        |  |
|  | [===] Line 2     4,200 kg |  | Prod B [===] [===] +2%       |  |
|  | [==] Line 3      2,530 kg |  | Prod C [==] [==] 0%          |  |
|  +---------------------------+  +-------------------------------+  |
|                                                                    |
|  Output Summary                                    [Expand All]    |
|  +---------------------------------------------------------------+ |
|  | Product      | Line   | Planned | Actual | Var%  | App | Pend | |
|  |--------------|--------|---------|--------|-------|-----|------| |
|  | Product A    | Line 1 | 5,000   | 4,600  | -8.0% | 4500| 100  | |
|  |   > Jan 8    | Line 1 | -       | 650    |       | 640 | 10   | |
|  |   > Jan 9    | Line 1 | -       | 680    |       | 670 | 10   | |
|  | Product B    | Line 2 | 3,000   | 3,060  | +2.0% | 3000| 60   | |
|  +---------------------------------------------------------------+ |
|                                                                    |
+------------------------------------------------------------------+
```

**Color Coding:**
```
Variance Colors:
- Green:  variance >= 0% (at or above plan)
- Yellow: variance >= -5% (slightly below plan)
- Red:    variance < -5% (significantly below plan)

Chart Colors (Product Series):
- Distinct colors from predefined palette
- Consistent across all charts
- Legend shows color mapping
```

---

## Implementation Notes

### Output Aggregation Logic

```typescript
// lib/services/output-report-service.ts

export async function getOutputReport(params: OutputReportParams): Promise<OutputReportData> {
  const { startDate, endDate, productIds, lineIds, shiftIds, granularity } = params;

  // 1. Fetch raw output data
  const rawOutputs = await fetchProductionOutputs(startDate, endDate, productIds, lineIds, shiftIds);

  // 2. Aggregate by date/granularity
  const timeSeriesData = aggregateByDateAndProduct(rawOutputs, granularity);

  // 3. Aggregate by product (with plan comparison)
  const productBreakdown = await aggregateByProduct(rawOutputs, startDate, endDate);

  // 4. Aggregate by line
  const lineBreakdown = aggregateByLine(rawOutputs);

  // 5. Calculate summary statistics
  const summary = calculateSummary(timeSeriesData, productBreakdown);

  return {
    timeSeriesData,
    productBreakdown,
    lineBreakdown,
    summary,
    filters: { startDate, endDate, productIds, lineIds, shiftIds, granularity },
  };
}

function aggregateByDateAndProduct(
  outputs: RawOutput[],
  granularity: Granularity
): TimeSeriesDataPoint[] {
  // Group by date bucket (day/week/month)
  const grouped = outputs.reduce((acc, output) => {
    const bucket = getDateBucket(output.created_at, granularity);
    if (!acc[bucket]) {
      acc[bucket] = {};
    }
    if (!acc[bucket][output.product_id]) {
      acc[bucket][output.product_id] = {
        productId: output.product_id,
        productName: output.product_name,
        productCode: output.product_code,
        quantity: 0,
        uom: output.uom,
        color: getProductColor(output.product_id),
      };
    }
    acc[bucket][output.product_id].quantity += Number(output.quantity);
    return acc;
  }, {} as Record<string, Record<string, ProductQuantity>>);

  // Transform to array format
  return Object.entries(grouped)
    .map(([date, products]) => ({
      date,
      products: Object.values(products),
      totalQuantity: Object.values(products).reduce((sum, p) => sum + p.quantity, 0),
    }))
    .sort((a, b) => a.date.localeCompare(b.date));
}

function getDateBucket(date: Date, granularity: Granularity): string {
  switch (granularity) {
    case 'daily':
      return format(date, 'yyyy-MM-dd');
    case 'weekly':
      return format(startOfWeek(date), 'yyyy-MM-dd');
    case 'monthly':
      return format(startOfMonth(date), 'yyyy-MM');
  }
}

// Color palette for consistent product colors
const PRODUCT_COLORS = [
  '#3B82F6', // blue
  '#10B981', // green
  '#F59E0B', // amber
  '#EF4444', // red
  '#8B5CF6', // purple
  '#EC4899', // pink
  '#06B6D4', // cyan
  '#84CC16', // lime
  '#F97316', // orange
  '#6366F1', // indigo
];

function getProductColor(productId: string): string {
  // Use hash of productId for consistent color assignment
  const hash = productId.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
  return PRODUCT_COLORS[hash % PRODUCT_COLORS.length];
}
```

### Plan vs Actual Calculation

```typescript
async function aggregateByProduct(
  outputs: RawOutput[],
  startDate: string,
  endDate: string
): Promise<ProductBreakdown[]> {
  // Group outputs by product
  const outputsByProduct = outputs.reduce((acc, output) => {
    if (!acc[output.product_id]) {
      acc[output.product_id] = {
        productId: output.product_id,
        productName: output.product_name,
        productCode: output.product_code,
        actualQty: 0,
        approvedQty: 0,
        pendingQty: 0,
        rejectedQty: 0,
        uom: output.uom,
      };
    }
    acc[output.product_id].actualQty += Number(output.quantity);
    if (output.qa_status === 'approved') {
      acc[output.product_id].approvedQty += Number(output.quantity);
    } else if (output.qa_status === 'pending') {
      acc[output.product_id].pendingQty += Number(output.quantity);
    } else if (output.qa_status === 'rejected') {
      acc[output.product_id].rejectedQty += Number(output.quantity);
    }
    return acc;
  }, {} as Record<string, Partial<ProductBreakdown>>);

  // Get planned quantities from work orders
  const plannedByProduct = await getPlannedQuantities(startDate, endDate);

  // Merge actual with planned
  return Object.values(outputsByProduct).map((product) => {
    const planned = plannedByProduct[product.productId!] || 0;
    const actual = product.actualQty!;
    const varianceQty = actual - planned;
    const variancePercent = planned > 0
      ? Math.round((varianceQty / planned) * 1000) / 10
      : null;

    return {
      ...product,
      plannedQty: planned,
      varianceQty,
      variancePercent,
    } as ProductBreakdown;
  });
}
```

### Key Business Rules

1. **Output Aggregation:**
   - Only include outputs with source = 'production'
   - Respect org_id filtering via RLS
   - Handle UoM conversions when products have multiple UoMs
   - Group by date bucket based on granularity

2. **Plan vs Actual:**
   - Planned qty comes from work_orders.planned_qty
   - Include WOs with scheduled_date in date range
   - Variance = (Actual - Planned) / Planned * 100
   - Null variance when no planned qty (unplanned production)

3. **QA Status Breakdown:**
   - approved_qty: qa_status = 'approved'
   - pending_qty: qa_status = 'pending' or NULL
   - rejected_qty: qa_status = 'rejected'

4. **Performance:**
   - Use materialized view for large date ranges
   - Refresh materialized view every 15 minutes
   - Cache report data for 5 minutes (configurable)

5. **Export:**
   - Include all filtered data in export
   - CSV for data analysis
   - Excel with formatted charts for management

---

## Test Cases

### Unit Tests

**output-report-service.test.ts**
```typescript
describe('OutputReportService', () => {
  describe('getOutputReport', () => {
    it('aggregates outputs correctly by date');
    it('calculates product totals correctly');
    it('handles empty date range');
    it('respects product filter');
    it('respects line filter');
    it('handles different granularities (daily/weekly/monthly)');
  });

  describe('aggregateByDateAndProduct', () => {
    it('groups outputs by date bucket');
    it('sums quantities per product per day');
    it('assigns consistent colors to products');
    it('sorts by date ascending');
  });

  describe('calculateVariance', () => {
    it('returns positive variance when actual > planned');
    it('returns negative variance when actual < planned');
    it('returns null variance when planned = 0');
    it('rounds to 1 decimal place');
  });

  describe('calculateTrend', () => {
    it('returns up when current > previous');
    it('returns down when current < previous');
    it('returns stable when difference < 1%');
  });

  describe('exportToCSV', () => {
    it('generates valid CSV with headers');
    it('includes all columns');
    it('handles special characters in product names');
  });
});
```

### Integration Tests

**output-report-api.test.ts**
```typescript
describe('Output Report API', () => {
  describe('GET /api/production/analytics/output-report', () => {
    it('returns report data for valid date range');
    it('returns 400 for invalid date range');
    it('returns 400 when end_date < start_date');
    it('filters by product_ids correctly');
    it('filters by line_ids correctly');
    it('returns empty data for no outputs');
    it('respects RLS org_id filter');
  });

  describe('GET /api/production/analytics/output-report/plan-vs-actual', () => {
    it('returns plan vs actual comparison');
    it('calculates variance correctly');
    it('handles products with no planned qty');
    it('handles products with no actual output');
  });

  describe('POST /api/production/analytics/output-report/export', () => {
    it('exports CSV file');
    it('exports Excel file');
    it('includes filtered data only');
    it('returns 400 for invalid format');
  });
});
```

### E2E Tests

**output-report.spec.ts**
```typescript
describe('Production Output Report', () => {
  it('displays stacked area chart with product data');
  it('displays line comparison bar chart');
  it('displays plan vs actual chart');
  it('displays summary table with data');

  it('filters by date range preset');
  it('filters by custom date range');
  it('filters by product selection');
  it('filters by line selection');
  it('combines multiple filters');

  it('expands table row to show daily breakdown');
  it('sorts table by column');

  it('exports CSV file');
  it('exports Excel file');

  it('shows empty state for no data');
  it('handles loading state');
  it('handles error state with retry');

  it('blocks access to other org data');
});
```

---

## Security Considerations

1. **Multi-tenancy**
   - All queries filtered by org_id via RLS
   - Cross-tenant access returns 404 (not 403)
   - Export only includes user's org data

2. **Role-Based Access**
   - All authenticated users can view reports
   - Export may require specific role (configurable)

3. **Data Protection**
   - No PII in output data
   - Product names may be sensitive (company IP)
   - Export files should be secured

4. **Rate Limiting**
   - Max 10 report requests per minute
   - Max 5 export requests per minute
   - Large date ranges limited to 365 days

---

## Deliverables

### Database
- [ ] `get_plan_vs_actual` function
- [ ] `mv_production_output_daily` materialized view (optional, for performance)
- [ ] Indexes for query performance

### API Routes
- [ ] `GET /api/production/analytics/output-report`
- [ ] `GET /api/production/analytics/output-report/summary`
- [ ] `GET /api/production/analytics/output-report/plan-vs-actual`
- [ ] `GET /api/production/analytics/output-report/by-line`
- [ ] `POST /api/production/analytics/output-report/export`

### Services
- [ ] `lib/services/output-report-service.ts` - Report data aggregation

### Validation
- [ ] `lib/validation/output-report-validation.ts` - Zod schemas

### Components
- [ ] `OutputReportDashboard.tsx` - Main container
- [ ] `OutputStackedAreaChart.tsx` - Time series chart
- [ ] `OutputStackedBarChart.tsx` - Line comparison chart
- [ ] `PlanVsActualChart.tsx` - Plan vs actual comparison
- [ ] `OutputSummaryTable.tsx` - Detailed table
- [ ] `OutputReportFilters.tsx` - Filter controls
- [ ] `OutputExportButton.tsx` - Export dropdown
- [ ] `OutputReportWidget.tsx` - Dashboard widget
- [ ] `OutputTrendIndicator.tsx` - Trend display
- [ ] `VarianceIndicator.tsx` - Variance display

### Pages
- [ ] `app/(authenticated)/production/reports/output/page.tsx`

### Tests
- [ ] Unit tests for aggregation logic (>80% coverage)
- [ ] Integration tests for API endpoints
- [ ] E2E tests for report interactions

---

## Definition of Done

- [ ] Report displays output data aggregated by product, line, and time
- [ ] Stacked area chart shows output over time with product breakdown
- [ ] Stacked bar chart shows output by production line
- [ ] Plan vs Actual chart compares planned vs actual with variance
- [ ] Summary table shows all products with metrics
- [ ] Table rows expand to show daily breakdown
- [ ] Date range filter works (presets and custom)
- [ ] Product filter (single and multi-select) works
- [ ] Line filter (single and multi-select) works
- [ ] Shift filter works
- [ ] Combined filters work correctly
- [ ] CSV export downloads with correct data
- [ ] Excel export downloads with formatted data
- [ ] Dashboard widget shows summary and trend
- [ ] Widget click navigates to full report
- [ ] Empty state displays for no data
- [ ] Loading state displays during data fetch
- [ ] Error state displays with retry option
- [ ] Multi-tenant RLS enforced
- [ ] Report loads within 5 seconds for 1000+ outputs
- [ ] Export completes within 10 seconds
- [ ] Unit tests >80% coverage
- [ ] Integration tests pass
- [ ] E2E tests pass

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-01-14 | Initial story creation | ARCHITECT-AGENT |
