# 04.2b - WO Pause/Resume

**Priority**: P0 (MVP Core - Phase 0)
**Story Points**: S (Small - 1-2 days)
**Type:** backend + frontend

**State:** ready
**Primary PRD:** `docs/1-BASELINE/product/modules/production.md` (FR-PROD-003)
**Architecture:** `docs/1-BASELINE/architecture/modules/production.md`
**UX Wireframes:** PROD-002 (WO Execution Detail)

---

## MVP Scope

Implement Work Order pause/resume functionality allowing operators to temporarily halt production with reason tracking. This story covers:
- Pause active WOs with mandatory reason selection
- Resume paused WOs
- Track pause history with duration calculation
- Settings toggle to enable/disable pause functionality
- UI buttons conditional on settings and WO status

---

## LP Dependency Status

- [x] NO LP dependency - can proceed immediately
- [ ] REQUIRES Epic 05 - defer to Phase 1

This story only manages WO status transitions and pause tracking. No material transactions or License Plates are involved.

---

## Goal

Enable production operators to pause and resume work orders with reason tracking, providing visibility into production interruptions and downtime.

## User Story

As a **production operator**, I want to **pause and resume work orders with a reason** so that **I can accurately track production interruptions and downtime causes**.

## Scope

**In scope (this story)**
- Pause In Progress WOs with mandatory reason
- Resume Paused WOs
- Pause reason tracking (breakdown, material shortage, break, other)
- Duration calculation (pause to resume)
- wo_pauses table for full history
- Settings toggle: allow_pause_wo (default: false)
- Conditional UI: Show/hide Pause button based on setting
- API endpoints: POST /api/production/work-orders/:id/pause and /resume
- Service layer: wo-pause-service.ts
- Validation: Zod schemas for pause/resume requests

**Out of scope (this story)**
- WO Start functionality (04.2a)
- WO Complete functionality (04.2c)
- Operations tracking (04.3)
- OEE downtime integration (Phase 2 - 04.9b)
- Automatic pause on material shortage (future enhancement)
- Pause notifications/alerts (future enhancement)

## Dependencies

- **01.1** - Organizations (RLS via org_id)
- **03.10** - Work Orders table (status field, work_orders table)
- **04.2a** - WO Start (provides In Progress status to pause from)

## Acceptance Criteria (Given/When/Then)

### AC-1: Pause Button Visibility

**Given** allow_pause_wo = true AND WO status = "In Progress"
**When** user views WO execution page
**Then** "Pause" button is visible and enabled

**Given** allow_pause_wo = false AND WO status = "In Progress"
**When** user views WO execution page
**Then** "Pause" button is NOT visible

### AC-2: Pause Work Order

**Given** WO status = "In Progress" AND allow_pause_wo = true
**When** user clicks "Pause" and selects reason "Machine Breakdown"
**Then**
- WO status changes to "Paused" within 1 second
- paused_at timestamp is set to current time (+/- 1 second)
- New record created in wo_pauses table with pause_reason = "Machine Breakdown"
- Success message displays: "Work order paused"

### AC-3: Pause Reason Required

**Given** user clicks "Pause" button
**When** no reason is selected and user clicks "Confirm"
**Then** validation error displays: "Pause reason is required"

### AC-4: Invalid Status for Pause

**Given** WO status = "Completed"
**When** user attempts to pause WO
**Then** "Pause" button is disabled

**Given** WO status = "Draft"
**When** user attempts to start then pause WO
**Then** error message displays: "Cannot pause work order with status 'draft'. Only in_progress WOs can be paused."

### AC-5: Already Paused

**Given** WO status = "Paused"
**When** user attempts to pause WO again
**Then** error message displays: "Work order is already paused"

### AC-6: Resume Work Order

**Given** WO status = "Paused"
**When** user clicks "Resume"
**Then**
- Resume confirmation modal displays
- Upon confirmation, WO status changes to "In Progress" within 1 second
- resumed_at timestamp is set in wo_pauses record
- Success message displays: "Work order resumed"

### AC-7: Duration Calculation

**Given** WO was paused for 15 minutes
**When** WO is resumed
**Then** wo_pauses.duration_minutes = 15 (+/- 1 minute)

### AC-8: Pause Not Enabled

**Given** allow_pause_wo = false
**When** user attempts to pause WO via API
**Then** 400 error response: "Pause functionality is disabled for this organization"

### AC-9: Pause History

**Given** WO has been paused 3 times
**When** user views WO execution detail page
**Then** Pause History section displays all 3 pause records with:
- Pause reason
- Paused at timestamp
- Resumed at timestamp (or "Currently Paused")
- Duration in minutes
- User who paused/resumed

### AC-10: Not Paused Status

**Given** WO status = "In Progress" (not paused)
**When** user attempts to resume WO
**Then** error message displays: "Cannot resume work order with status 'in_progress'. Only paused WOs can be resumed."

## Implementation Notes

### API Endpoints

```typescript
// Pause active WO
POST /api/production/work-orders/:id/pause
Request: {
  pause_reason: "machine_breakdown" | "material_shortage" | "break" | "quality_issue" | "other"
  notes?: string  // Optional operator notes
}
Response: {
  id: string
  wo_number: string
  status: "paused"
  paused_at: string  // ISO timestamp
  paused_by_user_id: string
  paused_by_user?: { id, first_name, last_name }
  pause_reason: string
  notes?: string
}

// Resume paused WO
POST /api/production/work-orders/:id/resume
Request: {} // Empty body
Response: {
  id: string
  wo_number: string
  status: "in_progress"
  pause_history: [{
    id: string
    pause_reason: string | null
    notes: string | null
    paused_at: string  // ISO timestamp
    resumed_at: string  // ISO timestamp
    duration_minutes: number
  }]
}

// Get pause history
GET /api/production/work-orders/:id/pause-history
Response: {
  total_pauses: number
  total_downtime_minutes: number
  pauses: [{
    id: string
    pause_reason: string | null
    notes: string | null
    paused_at: string
    resumed_at: string | null
    duration_minutes: number | null
    paused_by_user?: { id, first_name, last_name }
    resumed_by_user?: { id, first_name, last_name }
  }]
}
```

### Database

**Table: wo_pauses** (already exists via migration 036)

```sql
CREATE TABLE wo_pauses (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  work_order_id UUID NOT NULL REFERENCES work_orders(id) ON DELETE CASCADE,

  -- Pause details
  pause_reason VARCHAR(100),  -- machine_breakdown, material_shortage, break, quality_issue, other
  notes TEXT,

  -- Timestamps
  paused_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
  paused_by_user_id UUID NOT NULL REFERENCES users(id),
  resumed_at TIMESTAMP WITH TIME ZONE,
  resumed_by_user_id UUID REFERENCES users(id),

  -- Calculated
  duration_minutes INTEGER DEFAULT 0,  -- Calculated on resume

  -- Audit
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),

  CONSTRAINT downtime_nonnegative CHECK (duration_minutes >= 0)
);

CREATE INDEX idx_wo_pauses_work_order ON wo_pauses(work_order_id);
CREATE INDEX idx_wo_pauses_org ON wo_pauses(org_id);

-- RLS Policy
CREATE POLICY wo_pauses_isolation ON wo_pauses
  USING (org_id = (auth.jwt() ->> 'org_id')::uuid);
```

**Table: production_settings** (update)

```sql
ALTER TABLE production_settings
  ADD COLUMN IF NOT EXISTS allow_pause_wo BOOLEAN DEFAULT false;

-- Note: Migration 036 sets default to true, but story specifies false
-- Update in migration or via settings UI
```

**Table: work_orders** (existing fields used)

```sql
-- Fields used by pause/resume:
status TEXT  -- Values: draft, released, in_progress, paused, completed, cancelled
paused_at TIMESTAMP WITH TIME ZONE
paused_by_user_id UUID REFERENCES users(id)
```

### Frontend Components

```
app/(authenticated)/production/work-orders/[id]/
  components/
    WOPauseButton.tsx         -- Pause button with modal
    WOResumeButton.tsx        -- Resume button with confirmation
    WOPauseHistory.tsx        -- Pause history table
    PauseReasonSelect.tsx     -- Dropdown for pause reasons
```

### Services

**Service:** `lib/services/wo-pause-service.ts`

```typescript
// Check if pause is enabled for org
export async function isPauseEnabled(orgId: string): Promise<boolean>

// Get configurable pause reasons
export async function getPauseReasons(orgId: string): Promise<{
  code: string
  label: string
}[]>

// Pause work order
export async function pauseWorkOrder(
  woId: string,
  userId: string,
  userRole: string,
  orgId: string,
  pauseReason?: string,
  notes?: string
): Promise<PauseResult>

// Resume work order
export async function resumeWorkOrder(
  woId: string,
  userId: string,
  userRole: string,
  orgId: string
): Promise<ResumeResult>

// Get pause history
export async function getPauseHistory(
  woId: string,
  orgId: string
): Promise<PauseHistoryItem[]>

// Get downtime summary
export async function getDowntimeSummary(
  woId: string,
  orgId: string
): Promise<{
  total_minutes: number
  by_reason: { reason: string; minutes: number }[]
}>
```

### Validation (Zod)

**File:** `lib/validation/production-schemas.ts`

```typescript
import { z } from 'zod'

export const pauseReasonEnum = z.enum([
  'machine_breakdown',
  'material_shortage',
  'break',
  'quality_issue',
  'other'
])

export const pauseWorkOrderSchema = z.object({
  pause_reason: pauseReasonEnum,
  notes: z.string().max(500).optional()
})

export const resumeWorkOrderSchema = z.object({})  // Empty schema

export type PauseWorkOrderInput = z.infer<typeof pauseWorkOrderSchema>
export type ResumeWorkOrderInput = z.infer<typeof resumeWorkOrderSchema>
```

### Key Business Rules

1. **Status Transition Rules**
   - Pause: Only WOs with status = 'in_progress' can be paused
   - Resume: Only WOs with status = 'paused' can be resumed
   - Cannot pause already paused WOs (idempotency check)

2. **Settings Control**
   - Pause button hidden when allow_pause_wo = false
   - API rejects pause requests when setting disabled
   - Default: false (story requirement, may differ from migration default)

3. **Pause Reason**
   - Mandatory field for pause operation
   - Predefined list: Machine Breakdown, Material Shortage, Break, Quality Issue, Other
   - Stored in wo_pauses.pause_reason
   - Configurable via production_settings.pause_reasons (JSON array)

4. **Duration Calculation**
   - Calculated on resume: duration_minutes = ROUND((resumed_at - paused_at) / 60000)
   - Stored in wo_pauses.duration_minutes
   - NULL if not yet resumed

5. **Multiple Pauses**
   - Same WO can be paused multiple times
   - Each pause creates new wo_pauses record
   - History preserved indefinitely
   - Latest uncompleted pause (resumed_at IS NULL) is resumed

6. **Permissions**
   - Roles allowed: admin, manager, operator
   - Same role for pause and resume
   - User tracked in paused_by_user_id and resumed_by_user_id

7. **Atomic Operations**
   - Pause: Update work_orders.status + Insert wo_pauses (transaction)
   - Resume: Update work_orders.status + Update wo_pauses (transaction)
   - Optimistic locking via status check in WHERE clause

8. **RLS Enforcement**
   - All queries filtered by org_id
   - wo_pauses table has RLS policy
   - work_orders table already has RLS from Epic 03

## Deliverables

**API Routes:**
- `app/api/production/work-orders/[id]/pause/route.ts` - POST endpoint
- `app/api/production/work-orders/[id]/resume/route.ts` - POST endpoint
- `app/api/production/work-orders/[id]/pause-history/route.ts` - GET endpoint

**Services:**
- `lib/services/wo-pause-service.ts` - Pause/resume business logic

**Components:**
- `app/(authenticated)/production/work-orders/[id]/components/WOPauseButton.tsx` - Pause modal
- `app/(authenticated)/production/work-orders/[id]/components/WOResumeButton.tsx` - Resume confirmation
- `app/(authenticated)/production/work-orders/[id]/components/WOPauseHistory.tsx` - History table
- `app/(authenticated)/production/work-orders/[id]/components/PauseReasonSelect.tsx` - Reason dropdown

**Validation:**
- `lib/validation/production-schemas.ts` - Add pause/resume schemas

**Tests:**
- `lib/services/wo-pause-service.test.ts` - Unit tests for service
- `app/api/production/work-orders/[id]/pause/route.test.ts` - API tests
- `app/api/production/work-orders/[id]/resume/route.test.ts` - API tests
- `e2e/production/wo-pause-resume.spec.ts` - E2E smoke test

## Definition of Done

- [x] Migration 036 reviewed (wo_pauses table + production_settings columns)
- [ ] API endpoints implemented and documented
- [ ] Service layer with error handling (WOPauseError class)
- [ ] Zod validation schemas for pause/resume
- [ ] UI components with conditional rendering (allow_pause_wo check)
- [ ] Pause modal with reason dropdown and notes field
- [ ] Resume confirmation modal
- [ ] Pause history table component
- [ ] RLS policies verified on wo_pauses table
- [ ] API tests passing (>80% coverage)
  - Pause: valid status, invalid status, already paused, reason required, setting disabled
  - Resume: valid status, invalid status, duration calculation
  - Pause history: multiple pauses, empty history
- [ ] E2E smoke test for critical path
  - Start WO -> Pause (with reason) -> Verify status -> Resume -> Verify status -> Check history
- [ ] Performance: Pause/resume operations < 500ms p95
- [ ] Activity logs created for pause/resume events
- [ ] User info included in response (paused_by_user, resumed_by_user)
- [ ] Optimistic locking prevents race conditions
- [ ] Settings: allow_pause_wo toggle functional
- [ ] Settings: Default value set to false (per story requirement)

---

## Future Phases (Not in This Story)

### Phase 2 - OEE Integration
- Link wo_pauses to downtime_records for OEE calculation (04.9b)
- Automatic downtime categorization
- Pause reason analysis in OEE reports (04.10b)

### Phase 3 - Enhancements
- Automatic pause on material shortage detection
- Push notifications for pause events
- Manager approval required for resume (configurable)
- Pause duration alerts (e.g., paused > 30 minutes)
- Offline pause/resume support (PWA)
- Bulk pause/resume for multiple WOs
- Pause reason autocomplete with historical suggestions

**Implementation**: See Epic 04.0 "Future Feature Handling" section.

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-12-16 | Initial story creation | ARCHITECT-AGENT |
