# 04.3 - Operation Start/Complete

| Field | Value |
|-------|-------|
| **Story ID** | 04.3 |
| **Epic** | 04 - Production |
| **Status** | Ready |
| **Phase** | Phase 0 - MVP Core |
| **Complexity** | M (Medium) |
| **Estimate** | 3-4 days |
| **Type** | Full-stack |
| **Priority** | P0 (MVP Core - No LP Dependency) |

---

## PRD References

| FR ID | Requirement | Priority | Covered |
|-------|-------------|----------|---------|
| FR-PROD-004 | Operation Start/Complete - Track individual production steps | P0 | YES |
| FR-PROD-018 | OEE Calculation (requires operation data) | P2 | NO - Story 04.9a |

**Primary PRD:** `docs/1-BASELINE/product/modules/production.md` (FR-PROD-004)
**Architecture:** `docs/1-BASELINE/architecture/modules/production.md`
**UX Wireframes:** PRD-004 (Operation execution cards, timeline view)

---

## MVP Scope

**Phase 0 - Operation Start/Complete (This Story):**
- Start operation: pending → in_progress
- Complete operation: in_progress → completed
- Timestamp tracking (started_at, completed_at, started_by, completed_by)
- Duration calculation (actual_duration_minutes = completed_at - started_at)
- Yield capture on complete (actual_yield_percent field)
- Sequence enforcement (if require_operation_sequence setting = true)
- operation_logs table for audit trail (started, completed events)
- UI: Operation cards with Start/Complete buttons
- UI: Timeline view showing operation progress
- Service layer (operation-service.ts)
- NO material consumption per operation (deferred to Phase 2)

**What This Story Enables:**
- Production operators track progress through routing steps
- System captures actual vs. expected operation times
- Yield tracking per operation for variance analysis
- Audit trail of who started/completed each step
- Foundation for OEE calculation (Phase 2)

---

## LP Dependency Status

- [x] NO LP dependency - can proceed immediately
- [ ] REQUIRES Epic 05 - defer to Phase 1

**Rationale:** This story only updates `wo_operations` table fields (status, timestamps, yield). No License Plate transactions involved. Material consumption per operation is a Phase 2 feature.

---

## User Story

As a **production operator**, I want to **start and complete individual operations in a work order** so that **the system tracks my progress through the production steps, captures actual operation times and yields, and provides visibility to managers on shop floor execution**.

---

## Dependencies

| Dependency | Story/Epic | Type | Reason |
|------------|------------|------|--------|
| 01.1 | Org Context + Base RLS | HARD | Requires org_id context and RLS patterns |
| 01.10 | Machines CRUD | SOFT | Operation machine assignment validation |
| 01.11 | Production Lines CRUD | SOFT | Operation line assignment validation |
| 03.10 | WO CRUD | HARD | Requires work_orders table |
| 03.12 | WO Operations | HARD | Requires wo_operations table with status field |
| 04.2a | WO Start | HARD | Operations can only start if WO is In Progress |
| 04.5 | Production Settings | SOFT | Settings for require_operation_sequence |

**Dependents:**
- 04.2c (WO Complete) - Cannot complete WO until all operations completed
- 04.4 (Yield Tracking) - Uses operation yield data
- 04.9a (OEE Calculation) - Uses operation timestamps and durations
- 04.10c (Yield Analysis Report) - Aggregates operation yields

---

## Acceptance Criteria (Gherkin)

### AC-1: Start Operation (FR-PROD-004)

```gherkin
Scenario: Start operation with pending status
  Given wo_operation "OP-001" has status "pending"
  And parent WO has status "in_progress"
  When operator clicks "Start Operation"
  Then operation status changes to "in_progress" within 1 second
  And started_at timestamp set to current time (+/- 1 second)
  And started_by set to operator's user ID
  And success toast "Operation started successfully" displays

Scenario: Start button only visible for pending operations
  Given wo_operation has status "pending"
  When operator views operation card
  Then "Start" button is visible and enabled

Scenario: Start button disabled for non-pending operations
  Given wo_operation has status "in_progress"
  When operator views operation card
  Then "Start" button is disabled or hidden
  And "Complete" button is visible and enabled

Scenario: Cannot start operation if WO not in progress
  Given wo_operation status "pending"
  And parent WO status "released" (not started)
  When operator attempts to start operation
  Then error "Work Order must be started first" displays
  And operation status remains "pending"

Scenario: Cannot start already in-progress operation
  Given wo_operation status "in_progress"
  When operator attempts to start operation
  Then "Start" button is disabled
  And status remains "in_progress"
```

### AC-2: Complete Operation (FR-PROD-004)

```gherkin
Scenario: Complete operation with in-progress status
  Given wo_operation "OP-002" has status "in_progress"
  And started_at = 2025-01-15 10:00:00
  When operator clicks "Complete Operation"
  And enters actual_yield_percent = 95.5
  And current time = 2025-01-15 10:45:00
  Then operation status changes to "completed"
  And completed_at = 2025-01-15 10:45:00
  And completed_by set to operator's user ID
  And actual_duration_minutes = 45 (calculated)
  And actual_yield_percent = 95.5
  And success toast "Operation completed successfully" displays

Scenario: Complete button only visible for in-progress operations
  Given wo_operation has status "in_progress"
  When operator views operation card
  Then "Complete" button is visible and enabled

Scenario: Complete button disabled for non-in-progress operations
  Given wo_operation has status "pending"
  When operator views operation card
  Then "Complete" button is disabled or hidden

Scenario: Cannot complete pending operation
  Given wo_operation status "pending"
  When operator attempts to complete operation
  Then error "Operation must be started first" displays
  And status remains "pending"

Scenario: Cannot complete already completed operation
  Given wo_operation status "completed"
  When operator views operation card
  Then "Complete" button is disabled
  And status badge shows "Completed" in green
```

### AC-3: Duration Tracking (FR-PROD-004)

```gherkin
Scenario: Duration auto-calculated on complete
  Given wo_operation started_at = 2025-01-15 09:00:00
  When operator completes operation at 2025-01-15 10:30:00
  Then actual_duration_minutes = 90

Scenario: Duration calculation accurate to nearest minute
  Given wo_operation started_at = 2025-01-15 09:00:30
  When operator completes at 2025-01-15 10:00:45
  Then actual_duration_minutes = 60 (rounds to nearest minute)

Scenario: Expected vs actual duration variance
  Given wo_operation expected_duration_minutes = 60
  And actual_duration_minutes = 75
  When viewing operation detail
  Then duration variance = +15 minutes (15 over expected)
  And variance displays in yellow/red if > 10% over

Scenario: Operation detail shows duration comparison
  Given wo_operation has expected and actual durations
  When operator views operation detail panel
  Then shows:
    | Field | Value |
    | Expected Duration | 60 minutes |
    | Actual Duration | 75 minutes |
    | Variance | +15 minutes (25% over) |
```

### AC-4: Yield Tracking (FR-PROD-004)

```gherkin
Scenario: Yield capture on complete
  Given wo_operation expected_yield_percent = 98.0
  When operator completes operation
  And enters actual_yield_percent = 95.5
  Then actual_yield_percent saved = 95.5
  And yield variance = -2.5% (below expected)

Scenario: Yield field required on complete
  Given wo_operation status "in_progress"
  When operator clicks "Complete" without entering yield
  Then validation error "Actual yield is required" displays
  And operation remains "in_progress"

Scenario: Yield must be 0-100%
  Given operator enters actual_yield_percent = 105
  When attempting to complete
  Then validation error "Yield must be between 0 and 100%" displays

Scenario: Yield variance calculation
  Given wo_operation expected_yield = 98.0
  And actual_yield = 95.5
  When viewing operation detail
  Then yield variance = -2.5 percentage points
  And displays in red if variance < -5%

Scenario: Yield optional for non-production operations
  Given wo_operation name = "Cleaning" (non-production task)
  And expected_yield_percent is null
  When operator completes operation
  Then actual_yield_percent field is optional
  And can complete without entering yield
```

### AC-5: Sequence Enforcement (FR-PROD-004)

```gherkin
Scenario: Sequence enforcement enabled
  Given setting require_operation_sequence = true
  And wo_operations: seq 1 (completed), seq 2 (pending), seq 3 (pending)
  When operator attempts to start seq 3
  Then error "Operation seq 2 must be completed first" displays
  And seq 3 remains "pending"

Scenario: Sequence enforcement allows next operation
  Given setting require_operation_sequence = true
  And wo_operations: seq 1 (completed), seq 2 (in_progress), seq 3 (pending)
  When operator starts seq 2
  Then operation starts successfully (previous op completed)

Scenario: Sequence enforcement disabled
  Given setting require_operation_sequence = false
  And wo_operations: seq 1 (pending), seq 2 (pending), seq 3 (pending)
  When operator starts seq 3
  Then operation starts successfully (any order allowed)

Scenario: First operation always startable
  Given setting require_operation_sequence = true
  And wo_operation seq 1 has status "pending"
  When operator starts seq 1
  Then operation starts successfully (no prior operations)

Scenario: Skip operation breaks sequence check
  Given setting require_operation_sequence = true
  And wo_operations: seq 1 (skipped), seq 2 (pending)
  When operator starts seq 2
  Then operation starts successfully (skipped ops don't block)
```

### AC-6: Audit Trail - operation_logs (FR-PROD-004)

```gherkin
Scenario: Log created on operation start
  Given wo_operation "OP-001" status "pending"
  When operator starts operation
  Then operation_logs record created with:
    | Field | Value |
    | operation_id | OP-001 UUID |
    | event_type | started |
    | user_id | Operator UUID |
    | timestamp | Current time |
    | old_status | pending |
    | new_status | in_progress |

Scenario: Log created on operation complete
  Given wo_operation "OP-002" status "in_progress"
  When operator completes operation with yield 95.5%
  Then operation_logs record created with:
    | Field | Value |
    | event_type | completed |
    | new_status | completed |
    | metadata | {"actual_yield_percent": 95.5, "duration_minutes": 45} |

Scenario: Log history viewable
  Given wo_operation has 2 logs (started, completed)
  When manager views operation detail
  Then operation history section shows:
    - Started by John Doe at 2025-01-15 10:00:00
    - Completed by John Doe at 2025-01-15 10:45:00

Scenario: Logs retained on operation edit
  Given wo_operation has existing logs
  When operator updates yield from 95% to 96%
  Then operation_logs record created with event_type "updated"
  And previous logs retained
```

### AC-7: UI - Operation Cards (FR-PROD-004)

```gherkin
Scenario: Operation card displays key info
  Given wo_operation exists
  When operator views WO detail page
  Then operation card shows:
    - Sequence number
    - Operation name
    - Machine assignment (if any)
    - Expected duration
    - Status badge (color-coded)
    - Start/Complete buttons (context-sensitive)

Scenario: Operation card timeline view
  Given WO has 5 operations
  When viewing operations timeline
  Then operations displayed vertically with progress line
  And completed operations show green checkmark
  And in-progress operation shows yellow spinner
  And pending operations show gray circle

Scenario: Operation card click opens detail panel
  Given operator clicks operation card
  When detail panel opens
  Then shows:
    - Full description
    - Instructions
    - Expected vs actual times
    - Expected vs actual yield
    - Started/completed by user names
    - Operation logs history

Scenario: Empty state when no operations
  Given WO has no wo_operations
  When viewing operations section
  Then message "No routing operations defined" displays
  And no operation cards shown
```

### AC-8: Permission Enforcement

```gherkin
Scenario: Production Operator can start/complete operations
  Given user has PROD_OPERATOR role
  When viewing operation card
  Then "Start" and "Complete" buttons visible

Scenario: Production Manager can start/complete operations
  Given user has PROD_MANAGER role
  When viewing operation card
  Then "Start" and "Complete" buttons visible

Scenario: Planner cannot start/complete operations
  Given user has PLANNER role
  When viewing operation card
  Then buttons disabled or hidden
  And read-only view displayed

Scenario: Admin can start/complete operations
  Given user has ADMIN role
  When viewing operation card
  Then "Start" and "Complete" buttons visible
```

### AC-9: Multi-tenancy (RLS)

```gherkin
Scenario: Org isolation on operation start
  Given User A from Org A
  And wo_operation belongs to Org A
  When User A starts operation
  Then operation starts successfully

Scenario: Cross-tenant operation access returns 404
  Given User A from Org A
  And wo_operation belongs to Org B
  When User A attempts to start operation
  Then 404 Not Found returned (not 403)
  And operation status unchanged

Scenario: Operation logs isolated by org
  Given User A from Org A
  When querying operation_logs
  Then only logs from Org A operations returned
```

### AC-10: API Response and Error Handling

```gherkin
Scenario: Successful start returns updated operation
  Given wo_operation status "pending"
  When POST /api/production/operations/:id/start
  Then response status 200
  And response body contains:
    | Field | Value |
    | id | Operation UUID |
    | status | in_progress |
    | started_at | ISO timestamp |
    | started_by | User UUID |

Scenario: Start invalid operation returns 400
  Given wo_operation status "completed"
  When POST /api/production/operations/:id/start
  Then response status 400
  And error "Operation already completed" returned

Scenario: Complete with missing yield returns 400
  Given wo_operation status "in_progress"
  When POST /api/production/operations/:id/complete without yield
  Then response status 400
  And error "Actual yield is required" returned

Scenario: Start operation with WO not in progress returns 400
  Given wo_operation status "pending"
  And parent WO status "released"
  When POST /api/production/operations/:id/start
  Then response status 400
  And error "Work Order must be started first" returned

Scenario: Sequence enforcement violation returns 409
  Given require_operation_sequence = true
  And prior operation not completed
  When POST /api/production/operations/:id/start
  Then response status 409
  And error "Previous operation must be completed first" returned
```

---

## Technical Specification

### Database Schema

**Existing `wo_operations` Table (from Epic 03.12):**

```sql
-- This story UPDATES existing wo_operations table fields:
-- No new table schema changes required for wo_operations

-- Fields used/updated by this story:
-- status (updated to 'in_progress' or 'completed')
-- started_at (set on start)
-- started_by (set on start)
-- completed_at (set on complete)
-- completed_by (set on complete)
-- actual_duration_minutes (calculated on complete)
-- actual_yield_percent (captured on complete)
-- updated_at (auto-updated)

-- Status enum values (existing):
-- 'pending', 'in_progress', 'completed', 'skipped'
```

**New `operation_logs` Table:**

```sql
-- Operation audit log
CREATE TABLE operation_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  operation_id UUID NOT NULL REFERENCES wo_operations(id) ON DELETE CASCADE,
  organization_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,

  -- Event details
  event_type TEXT NOT NULL CHECK (event_type IN ('started', 'completed', 'updated', 'skipped')),
  timestamp TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  user_id UUID NOT NULL REFERENCES users(id),

  -- Status change tracking
  old_status TEXT,
  new_status TEXT,

  -- Event metadata (JSON for flexibility)
  metadata JSONB,  -- e.g., {"actual_yield_percent": 95.5, "duration_minutes": 45}

  -- Notes
  notes TEXT,

  -- Audit
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Indexes
CREATE INDEX idx_op_logs_operation ON operation_logs(operation_id);
CREATE INDEX idx_op_logs_org ON operation_logs(organization_id);
CREATE INDEX idx_op_logs_timestamp ON operation_logs(timestamp DESC);
CREATE INDEX idx_op_logs_event_type ON operation_logs(event_type);
CREATE INDEX idx_op_logs_user ON operation_logs(user_id);

-- Trigger: Auto-create log on wo_operations status change
CREATE OR REPLACE FUNCTION log_operation_status_change()
RETURNS TRIGGER AS $$
BEGIN
  -- Only log if status changed
  IF OLD.status IS DISTINCT FROM NEW.status THEN
    INSERT INTO operation_logs (
      operation_id,
      organization_id,
      event_type,
      user_id,
      old_status,
      new_status,
      metadata
    )
    VALUES (
      NEW.id,
      NEW.organization_id,
      CASE
        WHEN NEW.status = 'in_progress' THEN 'started'
        WHEN NEW.status = 'completed' THEN 'completed'
        WHEN NEW.status = 'skipped' THEN 'skipped'
        ELSE 'updated'
      END,
      auth.uid(),
      OLD.status,
      NEW.status,
      jsonb_build_object(
        'actual_yield_percent', NEW.actual_yield_percent,
        'actual_duration_minutes', NEW.actual_duration_minutes
      )
    );
  END IF;

  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER tr_log_operation_status_change
AFTER UPDATE OF status ON wo_operations
FOR EACH ROW
EXECUTE FUNCTION log_operation_status_change();
```

### RLS Policies

```sql
-- Enable RLS on operation_logs
ALTER TABLE operation_logs ENABLE ROW LEVEL SECURITY;

-- Operation logs: Org isolation
CREATE POLICY "op_logs_select" ON operation_logs
FOR SELECT TO authenticated
USING (
  organization_id = (SELECT org_id FROM users WHERE id = auth.uid())
);

CREATE POLICY "op_logs_insert" ON operation_logs
FOR INSERT TO authenticated
WITH CHECK (
  organization_id = (SELECT org_id FROM users WHERE id = auth.uid())
);

-- No UPDATE or DELETE policies - logs are immutable
```

---

### API Endpoints

```typescript
// Start Operation
POST /api/production/operations/:id/start

// Request Body (optional):
{
  started_at?: string;  // Override timestamp (defaults to NOW())
}

// Response (200 OK):
{
  id: string;
  wo_id: string;
  sequence: number;
  operation_name: string;
  status: 'in_progress';
  started_at: string;        // ISO timestamp
  started_by: string;        // User UUID
  expected_duration_minutes: number;
  // ... other operation fields
}

// Error Responses:
// 400 Bad Request - Invalid status transition
{
  error: 'Operation must be pending to start',
  current_status: 'completed'
}

// 400 Bad Request - WO not started
{
  error: 'Work Order must be started first',
  wo_status: 'released'
}

// 409 Conflict - Sequence enforcement violation
{
  error: 'Previous operation must be completed first',
  required_sequence: 2,
  current_sequence: 3
}

// Complete Operation
POST /api/production/operations/:id/complete

// Request Body:
{
  actual_yield_percent: number;  // Required, 0-100
  completed_at?: string;         // Override timestamp (defaults to NOW())
  notes?: string;                // Optional completion notes
}

// Response (200 OK):
{
  id: string;
  wo_id: string;
  sequence: number;
  operation_name: string;
  status: 'completed';
  started_at: string;
  completed_at: string;
  started_by: string;
  completed_by: string;
  expected_duration_minutes: number;
  actual_duration_minutes: number;  // Auto-calculated
  expected_yield_percent: number;
  actual_yield_percent: number;
  duration_variance_minutes: number;  // actual - expected
  yield_variance_percent: number;     // actual - expected
  // ... other operation fields
}

// Error Responses:
// 400 Bad Request - Invalid status
{
  error: 'Operation must be in progress to complete',
  current_status: 'pending'
}

// 400 Bad Request - Missing yield
{
  error: 'Actual yield is required',
  field: 'actual_yield_percent'
}

// Get Operation Logs
GET /api/production/operations/:id/logs

// Response:
{
  logs: [
    {
      id: string;
      event_type: 'started' | 'completed' | 'updated' | 'skipped';
      timestamp: string;
      user_id: string;
      user_name: string;
      old_status: string;
      new_status: string;
      metadata: {
        actual_yield_percent?: number;
        duration_minutes?: number;
      };
      notes: string | null;
    }
  ],
  total: number;
}
```

---

### Service Layer

```typescript
// lib/services/operation-service.ts

export interface OperationService {
  startOperation(
    operationId: string,
    options?: StartOperationOptions
  ): Promise<WOOperation>;

  completeOperation(
    operationId: string,
    input: CompleteOperationInput
  ): Promise<WOOperation>;

  canStartOperation(operationId: string): Promise<ValidationResult>;

  getOperationLogs(operationId: string): Promise<OperationLog[]>;
}

export interface StartOperationOptions {
  started_at?: string;  // ISO timestamp
}

export interface CompleteOperationInput {
  actual_yield_percent: number;  // 0-100
  completed_at?: string;         // ISO timestamp
  notes?: string;
}

export interface ValidationResult {
  allowed: boolean;
  reason?: string;
  warnings?: string[];
}

export interface OperationLog {
  id: string;
  event_type: 'started' | 'completed' | 'updated' | 'skipped';
  timestamp: string;
  user_id: string;
  user_name: string;
  old_status: string;
  new_status: string;
  metadata: Record<string, any>;
  notes: string | null;
}

// Implementation
export async function startOperation(
  operationId: string,
  options: StartOperationOptions = {}
): Promise<WOOperation> {
  // 1. Get operation and validate
  const operation = await getOperationById(operationId);
  if (!operation) throw new NotFoundError('Operation not found');

  // 2. Validate status
  if (operation.status !== 'pending') {
    throw new BadRequestError(
      `Operation must be pending to start. Current status: ${operation.status}`
    );
  }

  // 3. Check parent WO status
  const wo = await getWorkOrderById(operation.wo_id);
  if (wo.status !== 'in_progress') {
    throw new BadRequestError('Work Order must be started first');
  }

  // 4. Check sequence enforcement
  const settings = await getProductionSettings();
  if (settings.require_operation_sequence) {
    const canStart = await validateOperationSequence(operation);
    if (!canStart.allowed) {
      throw new ConflictError(canStart.reason!);
    }
  }

  // 5. Update operation status
  const started_at = options.started_at || new Date().toISOString();
  const updated = await supabase
    .from('wo_operations')
    .update({
      status: 'in_progress',
      started_at,
      started_by: userId,
      updated_at: new Date().toISOString(),
    })
    .eq('id', operationId)
    .select()
    .single();

  // 6. Log is auto-created by trigger

  return updated;
}

export async function completeOperation(
  operationId: string,
  input: CompleteOperationInput
): Promise<WOOperation> {
  // 1. Get operation and validate
  const operation = await getOperationById(operationId);
  if (!operation) throw new NotFoundError('Operation not found');

  // 2. Validate status
  if (operation.status !== 'in_progress') {
    throw new BadRequestError(
      `Operation must be in progress to complete. Current status: ${operation.status}`
    );
  }

  // 3. Validate yield
  if (input.actual_yield_percent == null) {
    throw new BadRequestError('Actual yield is required');
  }
  if (input.actual_yield_percent < 0 || input.actual_yield_percent > 100) {
    throw new BadRequestError('Yield must be between 0 and 100%');
  }

  // 4. Calculate duration
  const completed_at = input.completed_at || new Date().toISOString();
  const started_at = new Date(operation.started_at);
  const completed = new Date(completed_at);
  const duration_minutes = Math.round((completed.getTime() - started_at.getTime()) / 60000);

  // 5. Update operation
  const updated = await supabase
    .from('wo_operations')
    .update({
      status: 'completed',
      completed_at,
      completed_by: userId,
      actual_duration_minutes: duration_minutes,
      actual_yield_percent: input.actual_yield_percent,
      notes: input.notes || operation.notes,
      updated_at: new Date().toISOString(),
    })
    .eq('id', operationId)
    .select()
    .single();

  // 6. Calculate variances
  const duration_variance = duration_minutes - (operation.expected_duration_minutes || 0);
  const yield_variance = input.actual_yield_percent - (operation.expected_yield_percent || 0);

  // 7. Log is auto-created by trigger

  return {
    ...updated,
    duration_variance_minutes: duration_variance,
    yield_variance_percent: yield_variance,
  };
}

export async function validateOperationSequence(
  operation: WOOperation
): Promise<ValidationResult> {
  // Get all operations for this WO ordered by sequence
  const operations = await supabase
    .from('wo_operations')
    .select('*')
    .eq('wo_id', operation.wo_id)
    .order('sequence', { ascending: true });

  // Check if any prior operation is not completed or skipped
  const priorOps = operations.filter(op => op.sequence < operation.sequence);
  const incompletePrior = priorOps.find(
    op => op.status !== 'completed' && op.status !== 'skipped'
  );

  if (incompletePrior) {
    return {
      allowed: false,
      reason: `Operation ${incompletePrior.sequence} must be completed first`,
    };
  }

  return { allowed: true };
}

export async function getOperationLogs(
  operationId: string
): Promise<OperationLog[]> {
  const { data, error } = await supabase
    .from('operation_logs')
    .select(`
      *,
      user:users(name)
    `)
    .eq('operation_id', operationId)
    .order('timestamp', { ascending: false });

  if (error) throw error;

  return data.map(log => ({
    ...log,
    user_name: log.user.name,
  }));
}
```

---

### Validation Schema (Zod)

```typescript
// lib/validation/operation-execution.ts
import { z } from 'zod';

export const startOperationSchema = z.object({
  started_at: z.string().datetime().optional(),
});

export const completeOperationSchema = z.object({
  actual_yield_percent: z.number()
    .min(0, 'Yield cannot be negative')
    .max(100, 'Yield cannot exceed 100%'),
  completed_at: z.string().datetime().optional(),
  notes: z.string().max(2000, 'Notes too long').optional(),
});

export type StartOperationInput = z.infer<typeof startOperationSchema>;
export type CompleteOperationInput = z.infer<typeof completeOperationSchema>;
```

---

## UI Components

```
app/(authenticated)/production/work-orders/[id]/
  page.tsx                              -- WO detail page with operations section

components/production/operations/
  OperationsTimeline.tsx                -- Main timeline view of all operations
  OperationCard.tsx                     -- Single operation card with Start/Complete buttons
  OperationStatusBadge.tsx              -- Status badge (pending, in_progress, completed)
  OperationDetailPanel.tsx              -- Detailed operation view (modal/slide-over)
  StartOperationButton.tsx              -- Start button with validation
  CompleteOperationModal.tsx            -- Modal to capture yield on complete
  OperationProgressBar.tsx              -- Visual progress (completed/total)
  OperationLogsHistory.tsx              -- Audit log timeline
  DurationVarianceIndicator.tsx         -- Shows duration variance with color coding
  YieldVarianceIndicator.tsx            -- Shows yield variance with color coding
```

### UI Flow

1. **WO Detail Page** (`/production/work-orders/:id`):
   - Operations section below WO header
   - Timeline view showing all operations vertically
   - Each operation displayed as a card

2. **Operation Card**:
   - Shows: sequence, name, machine, expected duration, status badge
   - Buttons context-sensitive:
     - Pending: "Start" button enabled
     - In Progress: "Complete" button enabled
     - Completed: No buttons, green checkmark

3. **Start Operation**:
   - Click "Start" button
   - Confirmation: "Start operation [name]?"
   - On confirm: POST /api/production/operations/:id/start
   - Success: Status badge updates, toast notification

4. **Complete Operation**:
   - Click "Complete" button
   - Modal opens:
     - Shows operation name and duration
     - Input field: Actual Yield (%) - required
     - Text area: Notes (optional)
     - "Complete" and "Cancel" buttons
   - On submit: POST /api/production/operations/:id/complete
   - Success: Status badge updates, duration/yield displayed, toast notification

5. **Operation Detail Panel**:
   - Click anywhere on operation card (not on buttons)
   - Slide-over panel opens from right
   - Shows:
     - Full description and instructions
     - Expected vs actual times (with variance)
     - Expected vs actual yield (with variance)
     - Started/completed by user names
     - Operation logs history timeline

---

### Badge Colors (TailwindCSS)

| Status | Badge Class |
|--------|-------------|
| pending | `bg-gray-100 text-gray-700` |
| in_progress | `bg-yellow-100 text-yellow-800` |
| completed | `bg-green-100 text-green-800` |
| skipped | `bg-red-100 text-red-800` |

### Variance Color Coding

| Variance Type | Condition | Color |
|---------------|-----------|-------|
| Duration | Within 10% expected | `text-gray-600` |
| Duration | 10-25% over expected | `text-yellow-600` |
| Duration | >25% over expected | `text-red-600` |
| Yield | Within 5pp expected | `text-gray-600` |
| Yield | 5-10pp below expected | `text-yellow-600` |
| Yield | >10pp below expected | `text-red-600` |

---

## Key Business Rules

1. **Status Validation**: Only pending operations can be started, only in-progress operations can be completed
2. **WO Status Prerequisite**: Parent WO must be in "in_progress" status before any operation can start
3. **Sequence Enforcement**: If `require_operation_sequence` setting = true, operations must be started in order (prior op must be completed or skipped)
4. **Timestamp Tracking**: started_at and started_by set on start; completed_at and completed_by set on complete
5. **Duration Calculation**: actual_duration_minutes = completed_at - started_at (in minutes, rounded)
6. **Yield Required**: actual_yield_percent is required on complete (0-100 range)
7. **Audit Trail**: operation_logs auto-created on status change via trigger
8. **Multi-tenancy**: All operations enforce org_id isolation via RLS
9. **Immutability**: Once completed, operation cannot be restarted (would require admin skip/reset)
10. **Skipped Operations**: Skipped operations don't block sequence (sequence check only requires completed or skipped)

---

## Out of Scope (This Story)

| Feature | Reason | Future Story |
|---------|--------|--------------|
| Material consumption per operation | Phase 2 feature | Epic 04 Phase 2 |
| Operation skip/reset actions | Edge case, admin function | Story 04.3b (Phase 1) |
| Labor cost tracking per operation | Finance integration | Epic 09 (Finance) |
| Quality checks per operation | Quality module integration | Epic 06 (Quality) |
| Operation pause/resume | Complex state management | Phase 2 |
| Multiple operators per operation | Advanced tracking | Phase 2 |
| Operation photos/attachments | Rich media support | Phase 2 |
| Real-time OEE calculation | Requires Phase 2 OEE engine | Story 04.9a |
| Operation dependencies (beyond sequence) | Complex scheduling | Phase 2 |
| Parallel operations (same sequence) | Advanced routing | Phase 2 |

---

## Test Cases

### Unit Tests

**File:** `__tests__/unit/services/operation-service.test.ts`

| Test Case | Description |
|-----------|-------------|
| `startOperation()` updates status to in_progress | Verify status change |
| `startOperation()` sets started_at timestamp | Within 1 second of now |
| `startOperation()` sets started_by to current user | Audit tracking |
| `startOperation()` rejects non-pending operation | Throws BadRequestError |
| `startOperation()` rejects if WO not in progress | Throws BadRequestError |
| `startOperation()` enforces sequence when enabled | Throws ConflictError |
| `startOperation()` allows any order when sequence disabled | No sequence check |
| `completeOperation()` updates status to completed | Verify status change |
| `completeOperation()` calculates duration correctly | completed_at - started_at |
| `completeOperation()` saves actual_yield_percent | Yield captured |
| `completeOperation()` requires yield input | Throws BadRequestError |
| `completeOperation()` validates yield range 0-100 | Rejects invalid values |
| `completeOperation()` rejects non-in-progress operation | Throws BadRequestError |
| `validateOperationSequence()` allows if prior completed | Returns allowed: true |
| `validateOperationSequence()` blocks if prior pending | Returns allowed: false |
| `validateOperationSequence()` allows if prior skipped | Skipped doesn't block |
| `getOperationLogs()` returns audit trail | Ordered by timestamp DESC |

### Integration Tests

**File:** `__tests__/integration/api/production/operations.test.ts`

| Test Case | Description |
|-----------|-------------|
| POST `/operations/:id/start` returns 200 | Success case |
| POST `/operations/:id/start` sets timestamps | started_at, updated_at |
| POST `/operations/:id/start` creates audit log | operation_logs record |
| POST `/operations/:id/start` non-pending returns 400 | Invalid status |
| POST `/operations/:id/start` WO not started returns 400 | Prerequisite check |
| POST `/operations/:id/start` sequence violation returns 409 | Conflict error |
| POST `/operations/:id/complete` returns 200 | Success case |
| POST `/operations/:id/complete` calculates duration | actual_duration_minutes |
| POST `/operations/:id/complete` missing yield returns 400 | Validation error |
| POST `/operations/:id/complete` invalid yield returns 400 | Range validation |
| POST `/operations/:id/complete` creates audit log | operation_logs record |
| GET `/operations/:id/logs` returns logs | Audit trail |
| Cross-org operation access returns 404 | Multi-tenancy enforced |
| Permission denied returns 403 | Planner cannot start |

### E2E Tests

**File:** `__tests__/e2e/production/operation-execution.spec.ts`

| Test Case | Description |
|-----------|-------------|
| Start operation flow | Detail page > Start button > Confirm > Success |
| Start button visibility | Only visible for pending ops |
| Start button disabled for non-pending | Button disabled |
| Complete operation flow | Start > Complete > Enter yield > Success |
| Complete modal validation | Yield required, range check |
| Status badge updates | pending → in_progress → completed |
| Duration displays after complete | Shows actual duration |
| Yield variance displays | Shows actual vs expected |
| Operation detail panel | Click card > Panel opens with full info |
| Operation logs visible | History shows start/complete events |
| Sequence enforcement alert | Cannot skip operation in sequence |
| Success toast notifications | "Operation started/completed" |
| Permission-based UI | Planner sees disabled buttons |

---

## Definition of Done

- [ ] API endpoint `POST /api/production/operations/:id/start` implemented
- [ ] API endpoint `POST /api/production/operations/:id/complete` implemented
- [ ] API endpoint `GET /api/production/operations/:id/logs` implemented
- [ ] `operation_logs` table created with RLS policies
- [ ] Trigger `tr_log_operation_status_change` auto-creates logs
- [ ] `operation-service.ts` implements startOperation() method
- [ ] `operation-service.ts` implements completeOperation() method
- [ ] `operation-service.ts` implements validateOperationSequence() method
- [ ] `operation-service.ts` implements getOperationLogs() method
- [ ] Zod schemas validate start/complete requests
- [ ] Status validation: pending → in_progress, in_progress → completed
- [ ] WO status prerequisite: WO must be in_progress
- [ ] Sequence enforcement respects `require_operation_sequence` setting
- [ ] Timestamp tracking: started_at/started_by and completed_at/completed_by
- [ ] Duration auto-calculation on complete
- [ ] Yield capture on complete (required, 0-100 range)
- [ ] Audit logs auto-created via trigger
- [ ] OperationsTimeline component shows all operations
- [ ] OperationCard component with Start/Complete buttons
- [ ] StartOperationButton with validation checks
- [ ] CompleteOperationModal with yield input
- [ ] OperationDetailPanel shows full operation info
- [ ] OperationLogsHistory displays audit trail
- [ ] Status badge colors correct (pending, in_progress, completed)
- [ ] Duration variance indicator with color coding
- [ ] Yield variance indicator with color coding
- [ ] Success/error toast notifications
- [ ] Permission enforcement: Operator, Manager, Admin can execute
- [ ] Multi-tenancy: RLS enforces org isolation (cross-org returns 404)
- [ ] Unit tests >= 80% coverage
- [ ] Integration tests for all endpoints
- [ ] E2E tests for start/complete flows
- [ ] Loading states implemented (button spinners)
- [ ] Empty/error states handled
- [ ] Accessibility: keyboard nav, ARIA labels, screen reader support

---

## Future Phases (Not in This Story)

### Phase 1 (After MVP)
- **Operation Skip Action** (Story 04.3b) - Allow operators/managers to skip operations with reason
- **Operation Reset Action** (Story 04.3c) - Admin can reset completed operation to pending (for corrections)
- **Operation Pause/Resume** (Story 04.3d) - Pause in-progress operation, track pause duration
- **Multiple Operators** - Track multiple operators working on same operation

### Phase 2 (Advanced Features)
- **Material Consumption Per Operation** - Link consumption to specific operations (not just WO-level)
- **Labor Time Tracking** - Clock in/out per operation, calculate labor costs
- **Operation Photos** - Attach photos during execution for quality documentation
- **Real-time OEE Impact** - Operation completion triggers OEE recalculation
- **Operation Dependencies** - Define custom dependencies beyond simple sequence
- **Parallel Operations** - Allow multiple operations to run simultaneously

### Phase 3 (Future)
- **Machine Integration** - Auto-start/complete from machine sensors
- **Quality Checks Per Operation** - Inline QC checks during operation execution
- **SOP Integration** - Link operations to standard operating procedures
- **Predictive Analytics** - ML-based duration/yield predictions from historical data

**Implementation**: See Epic 04.0 "Future Feature Handling" section.

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-12-16 | Initial story creation | ARCHITECT-AGENT |
