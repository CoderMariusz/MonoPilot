# 04.6d - Consumption Correction (Reversal)

**Story ID:** 04.6d
**Epic:** 04 - Production
**Phase:** 1 (MVP)
**Complexity:** S (Small)
**Estimate:** 2 days
**Type:** Full-stack
**State:** ready

**Primary PRD:** `docs/1-BASELINE/product/modules/PRODUCTION.md` (FR-PROD-009)
**Context Files:** `docs/2-MANAGEMENT/epics/current/04-production/context/04.6d/`

## PRD References

| FR ID | Requirement | Priority | Phase | Covered |
|-------|-------------|----------|-------|---------|
| FR-PROD-009 | Consumption Correction | P0 | MVP | Yes |

## User Story

**As a** production manager,
**I want** to reverse incorrect material consumptions,
**So that** I can correct mistakes when operators scan wrong LPs or enter wrong quantities.

**As an** administrator,
**I want** all consumption reversals to be logged with reasons,
**So that** we maintain full traceability and audit trail for compliance.

## Goal

Implement consumption reversal functionality that allows Managers/Admins to undo incorrect material consumptions. The reversal atomically restores LP quantity, marks the consumption as reversed, updates genealogy records, and creates audit trail entries. Operators cannot reverse consumptions - only Manager/Admin roles.

## Scope

**In scope:**
- Reverse button visible only to Manager/Admin roles
- Confirmation modal with reversal reason (required)
- LP quantity restoration (consumed qty added back)
- LP status update (consumed -> available if applicable)
- Genealogy record update (is_reversed = true)
- material_consumptions update (reversed, reversed_at, reversed_by, reason)
- Audit log entry creation
- Consumption history shows "Reversed" status badge
- Success/error toast notifications

**Out of scope:**
- Batch reversal (multiple consumptions at once)
- Reversal approval workflow (managers can reverse directly)
- Undo reversal (once reversed, cannot undo - must re-consume)
- Email/push notifications for reversal
- Reversal limits per day/WO

## Dependencies

| Story | Requirement | Status |
|-------|-------------|--------|
| 04.6a | Material Consumption Desktop | Required - provides material_consumptions table, LP qty updates |
| 05.1 | License Plates CRUD | Required - provides license_plates table, lp_genealogy table |
| 01.1 | Org Context + Base RLS | Required - provides auth context, permission-service |

**Blocked by:** 04.6a (Reversal requires existing consumption records)
**Blocks:** 04.10e (Material Consumption Report - needs reversal data for accurate variance)

## Acceptance Criteria (Given/When/Then)

### Permission Control (AC1, AC2)

- GIVEN user has role "Manager" or "Admin", WHEN viewing consumption history, THEN "Reverse" button is visible on each row.
- GIVEN user has role "Operator", WHEN viewing consumption history, THEN "Reverse" button is NOT visible.

### LP Quantity Restoration (AC3, AC8)

- GIVEN consumption of 40 kg from LP-001 (now qty = 60), WHEN manager reverses consumption, THEN LP-001.qty = 100.
- GIVEN LP status was "consumed" before reversal, WHEN reversal completes for 50 kg, THEN LP status changes to "available" with qty = 50.
- GIVEN LP status was "available" (partial consumption), WHEN reversal completes, THEN LP status remains "available" (only qty changes).

### Consumption Record Update (AC4)

- GIVEN consumption reversed, WHEN querying material_consumptions table, THEN record shows reversed = true, reversed_at = timestamp, reversed_by = manager user ID.
- GIVEN reversal reason = "scanned_wrong_lp", WHEN record queried, THEN reversal_reason = "scanned_wrong_lp".
- GIVEN already reversed consumption, WHEN manager attempts to reverse again, THEN error "This consumption has already been reversed" displays.

### Genealogy Update (AC5)

- GIVEN consumption reversed, WHEN querying lp_genealogy table, THEN genealogy record shows is_reversed = true.

### Reversal Reason Validation (AC6)

- GIVEN manager clicks "Reverse", WHEN confirmation modal displays, THEN "Reason for reversal" is required field.
- GIVEN reason not selected, WHEN user clicks "Confirm Reversal", THEN button is disabled.
- GIVEN reason = "other" selected, WHEN notes field empty, THEN "Confirm Reversal" button is disabled.
- GIVEN reason = "other" selected, WHEN notes field has content, THEN "Confirm Reversal" button is enabled.

### Audit Trail (AC7)

- GIVEN reversal completes, WHEN recorded, THEN audit_log entry created with action = "consumption_reversal", user_id, timestamp, original_consumption_id.
- GIVEN audit log entry, WHEN metadata queried, THEN contains original_qty, lp_id, wo_id, reason, notes.

### Error Handling

- GIVEN consumption does not exist, WHEN reversal attempted, THEN 404 "Consumption not found" returns.
- GIVEN user is Operator, WHEN reversal API called, THEN 403 "Only Managers and Admins can reverse consumptions" returns.
- GIVEN database error during transaction, WHEN reversal fails, THEN transaction rolls back and 500 error returns.

### Multi-tenancy

- GIVEN User A from Org A, WHEN attempting to reverse Org B consumption, THEN 404 Not Found returns (not 403).

## Technical Specification

### Database Schema

#### material_consumptions table extension

```sql
-- Add reversal fields to material_consumptions
ALTER TABLE material_consumptions
  ADD COLUMN IF NOT EXISTS reversed BOOLEAN NOT NULL DEFAULT false,
  ADD COLUMN IF NOT EXISTS reversed_at TIMESTAMPTZ,
  ADD COLUMN IF NOT EXISTS reversed_by UUID REFERENCES users(id),
  ADD COLUMN IF NOT EXISTS reversal_reason TEXT,
  ADD COLUMN IF NOT EXISTS reversal_notes TEXT;

-- Add constraint for reversal reason values
ALTER TABLE material_consumptions
  ADD CONSTRAINT chk_reversal_reason CHECK (
    reversal_reason IS NULL OR
    reversal_reason IN ('scanned_wrong_lp', 'wrong_quantity', 'operator_error', 'quality_issue', 'other')
  );

-- Index for finding reversed consumptions
CREATE INDEX IF NOT EXISTS idx_material_consumptions_reversed
  ON material_consumptions(org_id, reversed);

-- Index for WO consumption queries (exclude reversed)
CREATE INDEX IF NOT EXISTS idx_material_consumptions_wo_active
  ON material_consumptions(wo_id)
  WHERE reversed = false;
```

#### lp_genealogy table extension

```sql
-- Add is_reversed to lp_genealogy if not exists
ALTER TABLE lp_genealogy
  ADD COLUMN IF NOT EXISTS is_reversed BOOLEAN NOT NULL DEFAULT false;
```

### Reversal Reason Values

| Code | Label | Description |
|------|-------|-------------|
| scanned_wrong_lp | Scanned Wrong LP | Operator scanned incorrect License Plate |
| wrong_quantity | Wrong Quantity Entered | Incorrect quantity was entered during consumption |
| operator_error | Operator Error | General operator mistake |
| quality_issue | Quality Issue | Material quality problem discovered after consumption |
| other | Other (specify) | Other reason - requires notes |

### RLS Policies

```sql
-- Only Manager/Admin can reverse consumptions
CREATE POLICY "consumption_reversal_update" ON material_consumptions
FOR UPDATE USING (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  AND reversed = false
  AND EXISTS (
    SELECT 1 FROM users u
    JOIN roles r ON r.id = u.role_id
    WHERE u.id = auth.uid()
    AND (r.name = 'admin' OR r.name = 'production_manager' OR r.name = 'owner')
  )
);
```

### API Endpoints

```
POST   /api/production/work-orders/:woId/consume/reverse   - Reverse consumption (Manager/Admin only)
```

**Request:**
```typescript
interface ReverseConsumptionRequest {
  consumption_id: string;  // UUID - required
  reason: ReversalReason;  // required
  notes?: string;          // optional, required if reason = 'other'
}
```

**Response:**
```typescript
interface ConsumptionReversalResult {
  success: boolean;
  consumption_id: string;
  wo_id: string;
  wo_number: string;
  lp_id: string;
  lp_number: string;
  restored_qty: number;
  lp_new_qty: number;
  lp_new_status: string;
  reversed_at: string;
  reversed_by: string;
  reversed_by_name: string;
  reason: ReversalReason;
  audit_log_id: string;
  message: string;
}
```

**Error Codes:**
| Status | Code | Message | When |
|--------|------|---------|------|
| 400 | ALREADY_REVERSED | This consumption has already been reversed | reversed = true |
| 400 | REASON_REQUIRED | Reason for reversal is required | reason missing |
| 400 | NOTES_REQUIRED_FOR_OTHER | Notes are required when reason is 'other' | reason = 'other' without notes |
| 401 | UNAUTHORIZED | Unauthorized | No valid JWT |
| 403 | FORBIDDEN | Only Managers and Admins can reverse consumptions | User role is Operator |
| 404 | CONSUMPTION_NOT_FOUND | Consumption not found | Invalid ID or different org |
| 500 | REVERSAL_FAILED | Failed to reverse consumption | Database error |

### Service Methods

**Location:** `lib/services/consumption-service.ts`

```typescript
interface ConsumptionService {
  // Reversal operations
  reverseConsumption(
    consumptionId: string,
    reason: ReversalReason,
    notes?: string
  ): Promise<ConsumptionReversalResult>;

  canReverseConsumption(consumptionId: string): Promise<{ canReverse: boolean; reason?: string }>;

  getConsumptionForReversal(consumptionId: string): Promise<ConsumptionDetail>;
}

type ReversalReason =
  | 'scanned_wrong_lp'
  | 'wrong_quantity'
  | 'operator_error'
  | 'quality_issue'
  | 'other';
```

### Zod Validation Schemas

**Location:** `lib/validation/production-schemas.ts`

```typescript
import { z } from 'zod';

export const reverseConsumptionSchema = z.object({
  consumption_id: z.string().uuid('Invalid consumption ID'),
  reason: z.enum(
    ['scanned_wrong_lp', 'wrong_quantity', 'operator_error', 'quality_issue', 'other'],
    { required_error: 'Reason for reversal is required' }
  ),
  notes: z.string().max(500, 'Notes must be 500 characters or less').optional()
}).refine(
  (data) => data.reason !== 'other' || (data.notes && data.notes.trim().length > 0),
  {
    message: 'Notes are required when reason is "other"',
    path: ['notes']
  }
);

export const reversalReasonLabels = {
  scanned_wrong_lp: 'Scanned Wrong LP',
  wrong_quantity: 'Wrong Quantity Entered',
  operator_error: 'Operator Error',
  quality_issue: 'Quality Issue',
  other: 'Other (specify)'
} as const;
```

### Transaction Flow

The reversal must be atomic - all or nothing:

1. Validate consumption exists and not reversed
2. Update material_consumptions (reversed = true, reversed_at, reversed_by, reason, notes)
3. Restore LP quantity (qty += consumed_qty)
4. Update LP status if was 'consumed' -> 'available'
5. Mark lp_genealogy as reversed (is_reversed = true)
6. Create audit_log entry
7. Commit transaction

If any step fails, rollback entire transaction.

## UI Components

### Pages

- `app/(authenticated)/production/consumption/[woId]/page.tsx` - Existing page, add Reverse button

### Components

**Location:** `components/production/consumption/`

```
ReverseConsumptionModal.tsx     - Modal for reversing consumption
ReverseConsumptionSuccess.tsx   - Success confirmation after reversal
ConsumptionHistoryTable.tsx     - UPDATE: Add Reverse button and Reversed badge
```

### Component Details

**ReverseConsumptionModal.tsx**
```tsx
interface ReverseConsumptionModalProps {
  consumption: ConsumptionHistoryItem;
  open: boolean;
  onOpenChange: (open: boolean) => void;
  onSuccess: (result: ConsumptionReversalResult) => void;
}
```

Sections:
1. **Consumption Details** - Read-only display of LP, product, qty, consumed by/at
2. **Warning Message** - Alert explaining reversal effects
3. **Reversal Form** - Reason dropdown (required) + notes textarea

Actions:
- Cancel (secondary) - Close modal
- Confirm Reversal (destructive) - Submit reversal

**ConsumptionHistoryTable Changes:**
- Add "Status" column with badge (Active/Reversed)
- Add [Rev] button in Actions column (Manager/Admin only)
- Hide [Rev] button for reversed rows
- Add reversed_at tooltip on Reversed badge

### UI Patterns

**Status Badge:**
```tsx
{consumption.reversed ? (
  <Badge variant="secondary" className="bg-gray-100 text-gray-600">
    Reversed
  </Badge>
) : (
  <Badge variant="default" className="bg-green-100 text-green-700">
    Active
  </Badge>
)}
```

**Reverse Button (conditional):**
```tsx
{isManagerOrAdmin && !consumption.reversed && (
  <Button variant="ghost" size="sm" onClick={() => handleOpenReverseModal(consumption)}>
    <Undo2 className="h-4 w-4" />
  </Button>
)}
```

### States

| State | Description | UI |
|-------|-------------|-----|
| idle | Modal closed | - |
| viewing | Modal open, showing details | Form enabled |
| submitting | Reversal in progress | Spinner, inputs disabled |
| success | Reversal complete | Toast, modal closes, table refreshes |
| error | Reversal failed | Error message, form re-enabled |

### Toast Notifications

- **Success:** "Consumption reversed successfully" - "LP-{number} quantity restored to {qty} {uom}"
- **Error:** "Failed to reverse consumption" - "{error_message}"

## Test Cases

### Unit Tests

**production-schemas.test.ts**
```typescript
describe('reverseConsumptionSchema', () => {
  it('rejects empty object');
  it('rejects missing consumption_id');
  it('rejects missing reason');
  it('accepts valid consumption_id + reason');
  it('accepts all valid reason values');
  it('rejects invalid reason');
  it('accepts reason="other" with notes');
  it('rejects reason="other" without notes');
  it('rejects notes over 500 characters');
});
```

**ReverseConsumptionModal.test.tsx**
```typescript
describe('ReverseConsumptionModal', () => {
  it('renders consumption details correctly');
  it('disables confirm button until reason selected');
  it('requires notes when reason is other');
  it('shows loading state during submission');
  it('calls onSuccess callback on successful reversal');
  it('displays error message on failure');
});
```

### Integration Tests

**route.test.ts**
```typescript
describe('POST /api/production/work-orders/:woId/consume/reverse', () => {
  it('returns 401 for unauthenticated request');
  it('returns 403 for Operator role');
  it('returns 200 for Manager role');
  it('returns 200 for Admin role');
  it('returns 404 for non-existent consumption');
  it('returns 400 for already reversed consumption');
  it('returns 400 for missing reason');
  it('restores LP quantity on reversal');
  it('updates consumption record on reversal');
  it('updates genealogy record on reversal');
  it('creates audit log entry');
  it('changes LP status from consumed to available');
});
```

### E2E Tests

**consumption-reversal.spec.ts**
```typescript
describe('Consumption Reversal', () => {
  it('Manager can reverse consumption');
  it('Operator cannot see Reverse button');
  it('Reason is required for reversal');
  it('Notes required when reason is Other');
  it('Cannot reverse already reversed consumption');
  it('LP quantity restored after reversal');
  it('Audit trail created on reversal');
});
```

## Security Considerations

1. **Role-Based Access**
   - Only Manager/Admin can reverse consumptions
   - RLS policy enforces role check at database level
   - API validates role before processing

2. **Audit Trail**
   - All reversals logged with actor, timestamp, reason
   - Metadata includes original consumption details
   - Cannot delete or modify audit entries

3. **Transaction Integrity**
   - Atomic transaction ensures all-or-nothing
   - Rollback on any failure
   - LP quantity always consistent

4. **Multi-Tenancy**
   - org_id filter on all queries
   - Cross-org attempts return 404 (not 403)

## Deliverables

- [ ] Migration: Add reversal fields to material_consumptions
- [ ] Migration: Add is_reversed to lp_genealogy
- [ ] RLS policy for consumption_reversal_update
- [ ] API route: POST /api/production/work-orders/:woId/consume/reverse
- [ ] Service: reverseConsumption() in consumption-service.ts
- [ ] Zod schema: reverseConsumptionSchema
- [ ] Component: ReverseConsumptionModal
- [ ] Component: ReverseConsumptionSuccess
- [ ] Update: ConsumptionHistoryTable (Reverse button, badge)
- [ ] Unit tests (>80% coverage)
- [ ] Integration tests
- [ ] E2E tests

## Definition of Done

- [ ] Reverse button visible only for Manager/Admin roles
- [ ] Reverse button hidden for Operator role
- [ ] Reverse button disabled for already reversed consumptions
- [ ] Modal displays consumption details correctly
- [ ] Reason field is required
- [ ] Notes required when reason is "other"
- [ ] LP quantity restored atomically on reversal
- [ ] LP status changed from "consumed" to "available" when applicable
- [ ] material_consumptions updated (reversed, reversed_at, reversed_by, reason)
- [ ] lp_genealogy marked as reversed (is_reversed = true)
- [ ] Audit log entry created with correct metadata
- [ ] Success toast displays with LP info
- [ ] Error toast displays on failure
- [ ] Consumption history shows "Reversed" badge
- [ ] Cross-tenant reversal returns 404
- [ ] Transaction rolls back on any failure
- [ ] Unit test coverage >= 80%
- [ ] Integration tests pass
- [ ] E2E tests pass
