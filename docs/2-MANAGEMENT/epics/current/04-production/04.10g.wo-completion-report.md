# 04.10g - WO Completion Report

**Story ID:** 04.10g
**Epic:** 04 - Production
**Phase:** 2
**Complexity:** S (Small)
**Estimate:** 2 days
**Priority:** P2
**Type:** Backend + Frontend
**State:** ready

**Primary PRD:** `docs/1-BASELINE/product/modules/PRODUCTION.md` (FR-PROD-022g)
**UX Wireframes:** PROD-REPORT-007 (WO Completion Report)

## PRD References

| FR ID | Requirement | Priority | Phase | Covered |
|-------|-------------|----------|-------|---------|
| FR-PROD-022g | WO Completion Report | P1 | Phase 2 | Yes |

## User Story

**As a** production manager,
**I want** to analyze work order completion performance with on-time vs delayed breakdown,
**So that** I can identify bottlenecks, track delay patterns, and improve production scheduling accuracy.

**As an** operations director,
**I want** to see completion rate trends over time,
**So that** I can measure scheduling effectiveness and set realistic targets.

## Goal

Implement comprehensive Work Order completion analytics showing on-time delivery performance, delay analysis by reason, and completion rate trends. Enable drill-down to individual delayed WOs and export capabilities for external reporting.

## Scope

**In scope:**
- On-time vs delayed WO classification
- On-time completion rate calculation
- Average delay duration metrics (hours/days)
- Delay reasons distribution analysis
- Completion trends over time (daily/weekly/monthly)
- Completion breakdown by line/product
- Top delayed WOs table with drill-down
- Filtering by date range, line, product, status
- Export to CSV
- Mobile-responsive charts

**Out of scope:**
- Predictive analytics for future delays (Phase 3)
- Automated delay notifications (separate alerting story)
- Root cause analysis automation
- Integration with external BI tools
- Real-time delay tracking during production

## Dependencies

| Story | Requirement | Status |
|-------|-------------|--------|
| 04.2c | WO Complete | Required - provides completed_at timestamp |
| 03.10 | WO CRUD | Required - work_orders table with scheduled dates |
| 04.5 | Production Settings | Required - base settings infrastructure |
| 01.1 | Org Context + RLS | Required - multi-tenancy |

## Acceptance Criteria (Given/When/Then)

### On-Time Classification

#### AC-1: On-Time WO Classification
- GIVEN WO scheduled_date = "2025-01-10" AND completed_at = "2025-01-10 15:30:00", WHEN analyzed, THEN WO classified as "On-time".

#### AC-2: Delayed WO Classification
- GIVEN WO scheduled_date = "2025-01-10" AND completed_at = "2025-01-12 09:00:00", WHEN analyzed, THEN WO classified as "Delayed" with delay = 2 days.

#### AC-3: Same Day Before Midnight
- GIVEN WO scheduled_date = "2025-01-10" AND completed_at = "2025-01-10 23:59:59", WHEN analyzed, THEN WO classified as "On-time".

#### AC-4: Not Yet Completed WO
- GIVEN WO scheduled_date = "2025-01-10" AND completed_at = NULL AND today = "2025-01-12", WHEN analyzed, THEN WO classified as "Overdue" (not included in completion stats).

### On-Time Completion Rate

#### AC-5: On-Time Rate Calculation
- GIVEN 100 completed WOs: 80 on-time, 20 delayed, WHEN on-time rate calculated, THEN rate = 80%.

#### AC-6: Rate with No Completed WOs
- GIVEN 0 completed WOs in date range, WHEN on-time rate calculated, THEN "N/A" displays with message "No completed work orders in selected period".

#### AC-7: Rate Trend Display
- GIVEN on-time rate data for last 30 days, WHEN trend chart rendered, THEN shows daily/weekly on-time rate with trend line.

### Average Delay Metrics

#### AC-8: Average Delay Calculation
- GIVEN 5 delayed WOs with delays: 1 day, 2 days, 3 days, 1 day, 3 days, WHEN average delay calculated, THEN average = 2 days.

#### AC-9: Delay in Hours Display
- GIVEN WO delay = 36 hours, WHEN delay displayed, THEN shows "1d 12h" format.

#### AC-10: Max Delay Tracking
- GIVEN delayed WOs, WHEN metrics displayed, THEN shows: Average Delay, Max Delay, Total Delay Hours.

### Delay Reasons Distribution

#### AC-11: Delay Reasons Pie Chart
- GIVEN delay reasons logged: Material Shortage (10), Machine Breakdown (5), Quality Issue (3), Other (2), WHEN pie chart rendered, THEN segments show percentage for each reason.

#### AC-12: Top Delay Reason Identification
- GIVEN delay reasons exist, WHEN report generated, THEN top 3 delay reasons highlighted with occurrence count.

#### AC-13: No Delay Reasons Logged
- GIVEN delayed WOs exist but no delay_reason recorded, WHEN distribution displayed, THEN shows "Unspecified" category.

### Completion by Line/Product

#### AC-14: Completion Rate by Line
- GIVEN Line A: 90% on-time, Line B: 75% on-time, Line C: 95% on-time, WHEN comparison table rendered, THEN lines sorted by on-time rate descending.

#### AC-15: Completion Rate by Product
- GIVEN Product X: 85% on-time, Product Y: 70% on-time, WHEN product breakdown viewed, THEN each product shows completed count, on-time count, rate %.

#### AC-16: Drill-Down to Line Detail
- GIVEN user clicks on "Line A" row, WHEN clicked, THEN filtered view shows only Line A WOs.

### Top Delayed WOs Table

#### AC-17: Delayed WOs Table Content
- GIVEN delayed WOs exist, WHEN top delayed table rendered, THEN columns show: WO Number, Product, Scheduled Date, Completed Date, Delay (hours), Delay Reason.

#### AC-18: Sorting by Delay Duration
- GIVEN delayed WOs table, WHEN sorted, THEN WOs ordered by delay duration (longest first) by default.

#### AC-19: Click to View WO Detail
- GIVEN user clicks WO number in table, WHEN clicked, THEN navigates to WO detail page.

#### AC-20: Top N Limit
- GIVEN 50 delayed WOs exist, WHEN top delayed table rendered, THEN shows top 10 by default with "Show More" option.

### Filtering & Date Range

#### AC-21: Date Range Filter
- GIVEN date range = "Last 7 days", WHEN filter applied, THEN only WOs completed in last 7 days included.

#### AC-22: Line Filter
- GIVEN filter = "Line A", WHEN applied, THEN only WOs assigned to Line A display.

#### AC-23: Product Filter
- GIVEN filter = "Product X", WHEN applied, THEN only WOs for Product X display.

#### AC-24: Status Filter
- GIVEN filter = "Delayed only", WHEN applied, THEN only delayed WOs display in all metrics.

#### AC-25: Combined Filters
- GIVEN date range = "Last 30 days" AND line = "Line A" AND product = "Product X", WHEN all filters applied, THEN metrics calculated only for matching WOs.

### Trend Chart

#### AC-26: Daily Trend View
- GIVEN date range = "Last 7 days", WHEN trend chart rendered, THEN shows daily on-time rate.

#### AC-27: Weekly Trend View
- GIVEN date range = "Last 3 months", WHEN trend chart rendered, THEN shows weekly on-time rate (aggregated).

#### AC-28: Target Line Display
- GIVEN target_completion_rate = 90% (org setting), WHEN trend chart rendered, THEN horizontal target line displays at 90%.

#### AC-29: Trend Direction Indicator
- GIVEN on-time rate improving (+5% vs previous period), WHEN metric card displayed, THEN green up arrow shows with "+5%".

### Export

#### AC-30: CSV Export
- GIVEN report generated with filters, WHEN user clicks "Export CSV", THEN CSV downloads with columns: WO Number, Product, Line, Scheduled Date, Completed Date, Status (On-time/Delayed), Delay Hours, Delay Reason.

#### AC-31: Export Respects Filters
- GIVEN filter = "Line A" AND date range = "Last 30 days", WHEN export clicked, THEN CSV contains only filtered data.

### Performance & Multi-tenancy

#### AC-32: Report Load Time
- GIVEN 1000 completed WOs in date range, WHEN report generated, THEN data displays within 3 seconds.

#### AC-33: Multi-tenancy Isolation
- GIVEN User A from Org A, WHEN requesting report, THEN only Org A work orders included in metrics.

## Technical Specification

### Database Query

**Primary Query - Completion Analysis:**

```sql
-- Get WO completion data with delay calculation
SELECT
  wo.id,
  wo.wo_number,
  wo.product_id,
  p.name as product_name,
  wo.production_line_id,
  pl.name as line_name,
  wo.scheduled_date,
  wo.completed_at,
  wo.delay_reason,
  CASE
    WHEN wo.completed_at IS NULL THEN 'overdue'
    WHEN DATE(wo.completed_at) <= wo.scheduled_date THEN 'on_time'
    ELSE 'delayed'
  END as completion_status,
  CASE
    WHEN wo.completed_at IS NOT NULL AND DATE(wo.completed_at) > wo.scheduled_date
    THEN EXTRACT(EPOCH FROM (wo.completed_at - (wo.scheduled_date + INTERVAL '1 day'))) / 3600
    ELSE 0
  END as delay_hours
FROM work_orders wo
JOIN products p ON wo.product_id = p.id
LEFT JOIN production_lines pl ON wo.production_line_id = pl.id
WHERE wo.org_id = :org_id
  AND wo.status = 'completed'
  AND wo.completed_at BETWEEN :start_date AND :end_date
  -- Optional filters
  AND (:line_id IS NULL OR wo.production_line_id = :line_id)
  AND (:product_id IS NULL OR wo.product_id = :product_id)
ORDER BY wo.completed_at DESC;
```

**Aggregation Query - Summary Metrics:**

```sql
-- Completion rate summary
SELECT
  COUNT(*) as total_completed,
  COUNT(*) FILTER (WHERE DATE(completed_at) <= scheduled_date) as on_time_count,
  COUNT(*) FILTER (WHERE DATE(completed_at) > scheduled_date) as delayed_count,
  ROUND(
    COUNT(*) FILTER (WHERE DATE(completed_at) <= scheduled_date)::numeric /
    NULLIF(COUNT(*), 0) * 100,
    1
  ) as on_time_rate,
  AVG(
    CASE
      WHEN DATE(completed_at) > scheduled_date
      THEN EXTRACT(EPOCH FROM (completed_at - (scheduled_date + INTERVAL '1 day'))) / 3600
    END
  ) as avg_delay_hours,
  MAX(
    CASE
      WHEN DATE(completed_at) > scheduled_date
      THEN EXTRACT(EPOCH FROM (completed_at - (scheduled_date + INTERVAL '1 day'))) / 3600
    END
  ) as max_delay_hours
FROM work_orders
WHERE org_id = :org_id
  AND status = 'completed'
  AND completed_at BETWEEN :start_date AND :end_date;
```

**Trend Query - Daily/Weekly Aggregation:**

```sql
-- Daily on-time rate trend
SELECT
  DATE(completed_at) as completion_date,
  COUNT(*) as total_completed,
  COUNT(*) FILTER (WHERE DATE(completed_at) <= scheduled_date) as on_time_count,
  ROUND(
    COUNT(*) FILTER (WHERE DATE(completed_at) <= scheduled_date)::numeric /
    NULLIF(COUNT(*), 0) * 100,
    1
  ) as on_time_rate
FROM work_orders
WHERE org_id = :org_id
  AND status = 'completed'
  AND completed_at BETWEEN :start_date AND :end_date
GROUP BY DATE(completed_at)
ORDER BY completion_date;
```

### work_orders Table Extension

**Required fields (verify existence):**

```sql
-- Ensure these columns exist in work_orders
ALTER TABLE work_orders ADD COLUMN IF NOT EXISTS
  delay_reason TEXT; -- Optional: reason for delay (if tracked)

-- Index for report performance
CREATE INDEX IF NOT EXISTS idx_work_orders_completion_report
ON work_orders(org_id, status, completed_at, scheduled_date)
WHERE status = 'completed';
```

### API Endpoints

```
# WO Completion Report
GET    /api/v1/production/analytics/wo-completion    - Get completion report data
GET    /api/v1/production/analytics/wo-completion/summary  - Get summary KPIs only
GET    /api/v1/production/analytics/wo-completion/trend    - Get trend data
GET    /api/v1/production/analytics/wo-completion/by-line  - Get breakdown by line
GET    /api/v1/production/analytics/wo-completion/by-product - Get breakdown by product
GET    /api/v1/production/analytics/wo-completion/delayed  - Get top delayed WOs
POST   /api/v1/production/analytics/wo-completion/export   - Export to CSV
```

### Query Parameters

```typescript
interface WOCompletionReportParams {
  start_date: string;       // ISO date, required
  end_date: string;         // ISO date, required
  line_id?: string;         // UUID, optional filter
  product_id?: string;      // UUID, optional filter
  status?: 'all' | 'on_time' | 'delayed'; // Optional filter
  granularity?: 'daily' | 'weekly' | 'monthly'; // For trend
  limit?: number;           // For paginated results
  offset?: number;          // For paginated results
}
```

### Service Methods

**Location:** `lib/services/production-analytics-service.ts`

```typescript
interface ProductionAnalyticsService {
  // WO Completion Report
  getWOCompletionReport(params: WOCompletionReportParams): Promise<WOCompletionReport>;
  getWOCompletionSummary(params: WOCompletionReportParams): Promise<WOCompletionSummary>;
  getWOCompletionTrend(params: WOCompletionReportParams): Promise<WOCompletionTrend[]>;
  getCompletionByLine(params: WOCompletionReportParams): Promise<LineCompletion[]>;
  getCompletionByProduct(params: WOCompletionReportParams): Promise<ProductCompletion[]>;
  getTopDelayedWOs(params: WOCompletionReportParams): Promise<DelayedWO[]>;
  exportWOCompletionReport(params: WOCompletionReportParams): Promise<CSVExport>;

  // Helpers
  classifyCompletion(wo: WorkOrder): 'on_time' | 'delayed' | 'overdue';
  calculateDelay(scheduledDate: Date, completedAt: Date): DelayInfo;
  formatDelayDuration(hours: number): string;
}

interface WOCompletionReport {
  summary: WOCompletionSummary;
  trend: WOCompletionTrend[];
  by_line: LineCompletion[];
  by_product: ProductCompletion[];
  delayed_wos: DelayedWO[];
  delay_reasons: DelayReasonDistribution[];
  filters_applied: WOCompletionReportParams;
  generated_at: string;
}

interface WOCompletionSummary {
  total_completed: number;
  on_time_count: number;
  delayed_count: number;
  on_time_rate: number;
  avg_delay_hours: number | null;
  max_delay_hours: number | null;
  total_delay_hours: number;
  trend_direction: 'up' | 'down' | 'stable';
  trend_change_percent: number;
}

interface WOCompletionTrend {
  period: string;           // Date or week label
  total_completed: number;
  on_time_count: number;
  on_time_rate: number;
}

interface LineCompletion {
  line_id: string;
  line_name: string;
  total_completed: number;
  on_time_count: number;
  delayed_count: number;
  on_time_rate: number;
  avg_delay_hours: number | null;
}

interface ProductCompletion {
  product_id: string;
  product_name: string;
  total_completed: number;
  on_time_count: number;
  delayed_count: number;
  on_time_rate: number;
}

interface DelayedWO {
  id: string;
  wo_number: string;
  product_name: string;
  line_name: string;
  scheduled_date: string;
  completed_at: string;
  delay_hours: number;
  delay_formatted: string;  // "2d 4h"
  delay_reason: string | null;
}

interface DelayReasonDistribution {
  reason: string;
  count: number;
  percentage: number;
  total_delay_hours: number;
}

interface DelayInfo {
  hours: number;
  days: number;
  formatted: string;
}
```

### Zod Validation Schemas

**Location:** `lib/validation/production-analytics.ts`

```typescript
import { z } from 'zod';

// Query parameters schema
export const woCompletionReportParamsSchema = z.object({
  start_date: z.string().regex(/^\d{4}-\d{2}-\d{2}$/, 'Invalid date format (YYYY-MM-DD)'),
  end_date: z.string().regex(/^\d{4}-\d{2}-\d{2}$/, 'Invalid date format (YYYY-MM-DD)'),
  line_id: z.string().uuid().optional(),
  product_id: z.string().uuid().optional(),
  status: z.enum(['all', 'on_time', 'delayed']).default('all'),
  granularity: z.enum(['daily', 'weekly', 'monthly']).default('daily'),
  limit: z.number().int().min(1).max(100).default(10),
  offset: z.number().int().min(0).default(0),
}).refine(
  (data) => new Date(data.start_date) <= new Date(data.end_date),
  { message: 'start_date must be before or equal to end_date' }
);

// Response schemas
export const woCompletionSummarySchema = z.object({
  total_completed: z.number().int().min(0),
  on_time_count: z.number().int().min(0),
  delayed_count: z.number().int().min(0),
  on_time_rate: z.number().min(0).max(100).nullable(),
  avg_delay_hours: z.number().nullable(),
  max_delay_hours: z.number().nullable(),
  total_delay_hours: z.number().min(0),
  trend_direction: z.enum(['up', 'down', 'stable']),
  trend_change_percent: z.number(),
});

export const woCompletionTrendSchema = z.object({
  period: z.string(),
  total_completed: z.number().int().min(0),
  on_time_count: z.number().int().min(0),
  on_time_rate: z.number().min(0).max(100),
});

export const delayedWOSchema = z.object({
  id: z.string().uuid(),
  wo_number: z.string(),
  product_name: z.string(),
  line_name: z.string().nullable(),
  scheduled_date: z.string(),
  completed_at: z.string(),
  delay_hours: z.number(),
  delay_formatted: z.string(),
  delay_reason: z.string().nullable(),
});

export const delayReasonDistributionSchema = z.object({
  reason: z.string(),
  count: z.number().int().min(0),
  percentage: z.number().min(0).max(100),
  total_delay_hours: z.number().min(0),
});
```

## UI Components

### Pages

- `app/(authenticated)/production/analytics/wo-completion/page.tsx` - Main report page

### Components

**Location:** `components/production/analytics/`

```
WOCompletionReport.tsx           - Main report container
WOCompletionSummaryCards.tsx     - KPI cards (on-time rate, avg delay, etc.)
WOCompletionTrendChart.tsx       - Line chart for on-time rate over time
OnTimeDelayedPieChart.tsx        - Pie chart: on-time vs delayed
DelayReasonsChart.tsx            - Pie/bar chart for delay reasons distribution
CompletionByLineTable.tsx        - Table showing completion rate by line
CompletionByProductTable.tsx     - Table showing completion rate by product
TopDelayedWOsTable.tsx           - Table of most delayed WOs
WOCompletionFilters.tsx          - Filter controls (date range, line, product)
WOCompletionExportButton.tsx     - Export to CSV button
```

### Component Details

**WOCompletionSummaryCards.tsx**
```tsx
interface WOCompletionSummaryCardsProps {
  summary: WOCompletionSummary;
  isLoading: boolean;
}

// Cards displayed:
// 1. On-Time Rate (%) - large, with trend indicator
// 2. Total Completed - count with period label
// 3. Average Delay - hours/days for delayed WOs
// 4. Max Delay - worst case delay
// Color coding: Green (>=90%), Yellow (75-89%), Red (<75%)
```

**WOCompletionTrendChart.tsx**
```tsx
interface WOCompletionTrendChartProps {
  trend: WOCompletionTrend[];
  targetRate?: number;        // Optional target line
  granularity: 'daily' | 'weekly' | 'monthly';
  isLoading: boolean;
}

// Features:
// - Line chart with on-time rate over time
// - Horizontal target line if target defined
// - Tooltip on hover: date, total, on-time, rate
// - Responsive sizing
```

**TopDelayedWOsTable.tsx**
```tsx
interface TopDelayedWOsTableProps {
  delayedWOs: DelayedWO[];
  onWOClick: (woId: string) => void;
  showMore: () => void;
  hasMore: boolean;
  isLoading: boolean;
}

// Columns:
// - WO Number (link)
// - Product
// - Line
// - Scheduled Date
// - Completed Date
// - Delay (formatted)
// - Delay Reason
```

### UI Layout

**Report Layout:**
```
+------------------------------------------------------------------+
| WO Completion Report                              [Export CSV]    |
+------------------------------------------------------------------+
| Filters: [Date Range v] [Line v] [Product v] [Status v] [Apply]  |
+------------------------------------------------------------------+
| +---------------+ +---------------+ +---------------+ +---------+ |
| | On-Time Rate  | | Completed     | | Avg Delay     | |Max Delay| |
| |    85%        | |     120       | |   4.2 hours   | | 3 days  | |
| |   +5% vs prev | |  (last 30d)   | |               | |         | |
| +---------------+ +---------------+ +---------------+ +---------+ |
+------------------------------------------------------------------+
| On-Time vs Delayed          |  Delay Reasons Distribution        |
| [====PIE CHART====]         |  [====BAR CHART====]               |
| On-time: 102 (85%)          |  Material Shortage: 8 (44%)        |
| Delayed: 18 (15%)           |  Machine Breakdown: 5 (28%)        |
|                             |  Quality Issue: 3 (17%)            |
|                             |  Other: 2 (11%)                    |
+-----------------------------+------------------------------------+
| Completion Rate Trend (Last 30 Days)                             |
| [========LINE CHART - On-Time Rate Over Time========]            |
| Target: 90% ------------------------------------                  |
+------------------------------------------------------------------+
| Completion by Line                                               |
| +------+----------+--------+--------+----------+                 |
| | Line | Completed| On-Time| Delayed| Rate     |                 |
| +------+----------+--------+--------+----------+                 |
| | A    |    45    |   42   |    3   |   93.3%  | [green]         |
| | B    |    38    |   30   |    8   |   78.9%  | [yellow]        |
| | C    |    37    |   30   |    7   |   81.1%  | [yellow]        |
| +------+----------+--------+--------+----------+                 |
+------------------------------------------------------------------+
| Top Delayed Work Orders                                          |
| +--------+---------+------+--------+----------+-------+--------+ |
| | WO#    | Product | Line | Sched. | Completed| Delay | Reason | |
| +--------+---------+------+--------+----------+-------+--------+ |
| | WO-501 | Bread   | A    | Jan 5  | Jan 8    | 3d    | Maint. | |
| | WO-489 | Cookies | B    | Jan 3  | Jan 5    | 2d 4h | Stock  | |
| | WO-512 | Cake    | C    | Jan 7  | Jan 9    | 2d    | QA     | |
| +--------+---------+------+--------+----------+-------+--------+ |
|                                           [Show More]            |
+------------------------------------------------------------------+
```

## Test Cases

### Unit Tests

**production-analytics-service.test.ts**
```typescript
describe('ProductionAnalyticsService - WO Completion', () => {
  describe('classifyCompletion', () => {
    it('returns on_time when completed on scheduled date');
    it('returns on_time when completed before scheduled date');
    it('returns delayed when completed after scheduled date');
    it('returns overdue when not completed and past scheduled date');
  });

  describe('calculateDelay', () => {
    it('calculates delay in hours correctly');
    it('formats delay as "Xd Yh" for multi-day delays');
    it('formats delay as "Xh" for same-day delays');
    it('returns 0 for on-time completions');
  });

  describe('getWOCompletionSummary', () => {
    it('calculates on-time rate correctly');
    it('calculates average delay for delayed WOs only');
    it('handles zero completed WOs gracefully');
    it('applies date range filter correctly');
    it('applies line filter correctly');
  });

  describe('getWOCompletionTrend', () => {
    it('aggregates by day for daily granularity');
    it('aggregates by week for weekly granularity');
    it('calculates trend direction correctly');
  });

  describe('getTopDelayedWOs', () => {
    it('sorts by delay duration descending');
    it('limits results to specified count');
    it('includes delay reason when available');
  });
});
```

### Integration Tests

**wo-completion-api.test.ts**
```typescript
describe('WO Completion Report API', () => {
  describe('GET /api/v1/production/analytics/wo-completion', () => {
    it('returns complete report for valid date range');
    it('returns 400 for invalid date format');
    it('returns 400 when start_date > end_date');
    it('filters by line_id when provided');
    it('filters by product_id when provided');
    it('returns only on_time WOs when status=on_time');
    it('returns only delayed WOs when status=delayed');
    it('returns 401 for unauthenticated request');
    it('enforces org_id isolation');
  });

  describe('GET /api/v1/production/analytics/wo-completion/summary', () => {
    it('returns summary KPIs');
    it('returns N/A for empty result set');
  });

  describe('GET /api/v1/production/analytics/wo-completion/trend', () => {
    it('returns daily trend data');
    it('returns weekly aggregated data when granularity=weekly');
  });

  describe('POST /api/v1/production/analytics/wo-completion/export', () => {
    it('returns CSV with correct headers');
    it('includes all filtered data in export');
    it('formats dates correctly in CSV');
  });
});
```

### E2E Tests

**wo-completion-report.spec.ts**
```typescript
describe('WO Completion Report', () => {
  it('displays summary cards with correct metrics');
  it('shows pie chart with on-time vs delayed breakdown');
  it('renders trend chart with target line');
  it('filters data when date range changed');
  it('filters data when line selected');
  it('shows top delayed WOs table');
  it('navigates to WO detail when row clicked');
  it('exports CSV with current filters');
  it('displays loading states correctly');
  it('shows empty state message when no data');
});
```

## Security Considerations

1. **Data Isolation**
   - RLS policies ensure org_id filtering on all queries
   - No cross-tenant data leakage in aggregations

2. **Query Performance**
   - Index on (org_id, status, completed_at, scheduled_date)
   - Limit result sets to prevent memory issues
   - Consider materialized views for large datasets

3. **Export Security**
   - Exports respect same RLS policies as UI queries
   - Log export actions for audit trail

## Deliverables

- [ ] Database index for completion report performance
- [ ] API route: GET /api/v1/production/analytics/wo-completion
- [ ] API route: GET /api/v1/production/analytics/wo-completion/summary
- [ ] API route: GET /api/v1/production/analytics/wo-completion/trend
- [ ] API route: GET /api/v1/production/analytics/wo-completion/by-line
- [ ] API route: GET /api/v1/production/analytics/wo-completion/by-product
- [ ] API route: GET /api/v1/production/analytics/wo-completion/delayed
- [ ] API route: POST /api/v1/production/analytics/wo-completion/export
- [ ] Service methods in production-analytics-service.ts
- [ ] Zod validation schemas for request/response
- [ ] WOCompletionReport page component
- [ ] WOCompletionSummaryCards component
- [ ] WOCompletionTrendChart component
- [ ] OnTimeDelayedPieChart component
- [ ] DelayReasonsChart component
- [ ] CompletionByLineTable component
- [ ] CompletionByProductTable component
- [ ] TopDelayedWOsTable component
- [ ] WOCompletionFilters component
- [ ] CSV export functionality
- [ ] Unit tests (>80% coverage)
- [ ] Integration tests
- [ ] E2E tests

## Definition of Done

- [ ] On-time vs delayed classification works correctly
- [ ] On-time rate calculation accurate (verified with test data)
- [ ] Average delay calculated for delayed WOs only
- [ ] Delay duration formatted correctly (Xd Yh format)
- [ ] Trend chart shows daily/weekly on-time rate
- [ ] Target line displays on trend chart (if configured)
- [ ] Trend direction indicator shows improvement/decline
- [ ] Delay reasons pie chart displays distribution
- [ ] Completion breakdown by line/product working
- [ ] Top delayed WOs table sorts by delay descending
- [ ] Clicking WO number navigates to WO detail
- [ ] Date range filter works correctly
- [ ] Line filter works correctly
- [ ] Product filter works correctly
- [ ] Status filter (all/on_time/delayed) works
- [ ] CSV export includes correct columns
- [ ] Export respects current filters
- [ ] Report loads within 3 seconds for 1000 WOs
- [ ] Multi-tenancy: Only org's WOs included
- [ ] Empty state displays when no data
- [ ] Loading states displayed during fetch
- [ ] Mobile-responsive charts render correctly
- [ ] Unit tests passing (>80% coverage)
- [ ] Integration tests passing
- [ ] E2E tests passing
- [ ] Code review completed

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-01-14 | Initial story creation | ARCHITECT-AGENT |
