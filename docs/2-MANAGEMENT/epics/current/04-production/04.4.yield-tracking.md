# 04.4 - Yield Tracking

**Priority:** P0 (MVP Core - Phase 0)
**Story Points:** S (Small)
**Type:** frontend + backend

**State:** ready
**Primary PRD:** `docs/1-BASELINE/product/modules/production.md` (FR-PROD-014)
**Architecture:** `docs/1-BASELINE/architecture/modules/production.md`
**UX Wireframes:** TBD (WO Detail Yield Section)

---

## MVP Scope

Manual yield entry and tracking on Work Order detail page without License Plate dependency. Operators can enter produced quantity directly, and the system calculates yield percentage with visual indicators and historical tracking.

**Phase 0 Scope (This Story):**
- Manual yield entry form on WO detail page
- Update `work_orders.produced_quantity` field
- Automatic yield percentage calculation (produced / planned * 100)
- Yield history tracking with timestamps and user audit
- Low yield warnings with color-coded indicators
- Yield display components (input form, history table, gauge)

**Deferred to Phase 1 (Story 04.7a):**
- Automatic yield tracking from output registration via License Plates
- Integration with `production_outputs` table
- Real-time yield updates from LP creation

---

## LP Dependency Status

- [x] NO LP dependency - can proceed immediately
- [ ] REQUIRES Epic 05 - defer to Phase 1

**Rationale:** This story implements manual yield entry directly to `work_orders.produced_quantity`. Automatic yield tracking from outputs (which requires LPs) is deferred to Story 04.7a (Output Registration Desktop).

---

## Goal

Enable operators and supervisors to manually record production yields and view yield performance metrics on Work Orders without requiring output registration infrastructure.

## User Story

As a **production operator**, I want to **manually enter produced quantities on work orders and see yield percentages with historical trends** so that **I can track production efficiency and identify low-performing runs before the output registration system is fully deployed**.

---

## Dependencies

| Story | Name | Reason |
|-------|------|--------|
| **01.1** | Org context + RLS | Required for tenant isolation |
| **03.10** | Work Order Generation | Requires `work_orders` table with `planned_quantity` field |
| **04.2a** | WO Start | Yield tracking begins after WO is started |

**Critical Path:** 01.1 -> 03.10 -> 04.2a -> **04.4**

---

## Scope

**In scope (this story)**
- Manual yield entry form on WO detail page
- Update `work_orders.produced_quantity` field via API
- Automatic yield percentage calculation: `(produced_quantity / planned_quantity) * 100`
- Yield history tracking with `yield_logs` table (timestamp, user, quantity changes)
- Visual yield indicators (green ≥ 80%, yellow 70-79%, red < 70%)
- Yield gauge component showing current percentage
- Yield history table showing all manual entries
- Validation: no negative values, optional max = planned_qty (configurable)
- Service layer: `yield-service.ts`
- Zod schema validation
- Unit and integration tests

**Out of scope (this story)**
- Automatic yield calculation from output registration (Story 04.7a - Phase 1)
- Material yield tracking (consumption vs planned) (Story 04.6a - Phase 1)
- Operation-level yield tracking (Story 04.3 handles operation completion)
- Trend charts and analytics (Story 04.10c - Phase 2)
- Yield variance alerts via notifications (Phase 2)
- Machine-specific yield tracking (Phase 2)

---

## Acceptance Criteria (Given/When/Then)

### AC-1: Yield Entry Form Display

**Given** operator views WO detail page for WO with status "In Progress"
**When** page loads
**Then** yield entry section displays with current produced_quantity, planned_quantity, and yield percentage

**Given** WO has planned_quantity = 1000 and produced_quantity = 0
**When** yield section displays
**Then** yield shows "0%" with gray indicator (not started)

**Given** WO has status "Draft" or "Released" (not started)
**When** yield section displays
**Then** yield entry form is disabled with message "Start WO to enter yield"

**Given** WO has status "Completed" or "Cancelled"
**When** yield section displays
**Then** yield entry form is disabled, showing final yield percentage

### AC-2: Manual Yield Entry

**Given** operator enters produced_quantity = 950 in yield form
**When** "Update Yield" button clicked
**Then** work_orders.produced_quantity updates to 950 within 500ms

**Given** produced_quantity = 950 and planned_quantity = 1000
**When** yield updates
**Then** yield_percent calculates to 95.0% (rounded to 1 decimal place)

**Given** operator enters negative value (-50)
**When** form validation runs
**Then** error "Produced quantity must be positive" displays inline

**Given** operator enters non-numeric value ("ABC")
**When** form validation runs
**Then** error "Must be a valid number" displays inline

**Given** setting `allow_overproduction = false` and planned_quantity = 1000
**When** operator enters produced_quantity = 1100
**Then** error "Produced quantity cannot exceed planned quantity (1000)" displays

**Given** setting `allow_overproduction = true` and planned_quantity = 1000
**When** operator enters produced_quantity = 1100
**Then** validation passes and yield_percent = 110.0%

### AC-3: Yield Percentage Calculation

**Given** planned_quantity = 1000 and produced_quantity = 950
**When** yield calculated
**Then** yield_percent = 95.0%

**Given** planned_quantity = 500 and produced_quantity = 475
**When** yield calculated
**Then** yield_percent = 95.0%

**Given** planned_quantity = 1000 and produced_quantity = 1050 (overproduction allowed)
**When** yield calculated
**Then** yield_percent = 105.0%

**Given** planned_quantity = 1000 and produced_quantity = 0
**When** yield calculated
**Then** yield_percent = 0.0%

**Given** yield calculation result is 95.456%
**When** displayed
**Then** yield rounds to 95.5% (1 decimal place)

### AC-4: Yield Visual Indicators

**Given** yield_percent = 95%
**When** yield gauge displays
**Then** indicator shows green with "Excellent" label

**Given** yield_percent = 75%
**When** yield gauge displays
**Then** indicator shows yellow with "Below Target" label

**Given** yield_percent = 65%
**When** yield gauge displays
**Then** indicator shows red with "Low Yield" label

**Given** yield_percent = 80% (threshold boundary)
**When** yield gauge displays
**Then** indicator shows green

**Given** yield_percent = 79.9% (just below threshold)
**When** yield gauge displays
**Then** indicator shows yellow

**Given** yield_percent = 69.9%
**When** yield gauge displays
**Then** indicator shows red

### AC-5: Yield History Tracking

**Given** operator updates produced_quantity from 0 to 500 at 10:00 AM
**When** update saves
**Then** yield_logs table records: wo_id, user_id, old_qty = 0, new_qty = 500, old_yield = 0%, new_yield = 50%, timestamp = 10:00 AM

**Given** operator updates produced_quantity from 500 to 950 at 2:00 PM
**When** update saves
**Then** new yield_logs entry created with old_qty = 500, new_qty = 950, timestamps

**Given** WO has 3 yield updates in history
**When** yield history table displays
**Then** all 3 entries show with columns: Timestamp, User, Old Qty, New Qty, Yield Change (%), Notes

**Given** yield history table displayed
**When** entries rendered
**Then** entries sort by timestamp DESC (newest first)

**Given** yield update includes optional notes "Adjusted after recount"
**When** saved
**Then** notes display in history table for that entry

### AC-6: Low Yield Warnings

**Given** yield_percent = 75% (< 80% threshold)
**When** WO detail page displays
**Then** warning banner shows "Low Yield Alert: 75% (Target: ≥80%)" in yellow

**Given** yield_percent = 65% (< 70% threshold)
**When** WO detail page displays
**Then** warning banner shows "Critical Low Yield: 65% (Target: ≥80%)" in red

**Given** yield_percent = 85% (≥ 80% threshold)
**When** WO detail page displays
**Then** no low yield warning displays

**Given** WO with yield < 80% on dashboard alerts panel
**When** dashboard loads
**Then** "Low Yield" alert displays for this WO in Medium priority section

### AC-7: Yield Display on WO List

**Given** operator views WO list/dashboard
**When** table renders
**Then** "Yield %" column displays for each WO with color-coded badges (green/yellow/red)

**Given** WO has produced_quantity = 0
**When** yield column displays
**Then** shows "—" or "N/A" (not "0%")

**Given** WO list filtered by yield < 80%
**When** filter applied
**Then** only WOs with low yield display

---

## Implementation Notes

### API Endpoints

```typescript
// Update produced quantity (manual yield entry)
PATCH /api/production/work-orders/:id/yield
  Request: { produced_quantity: number, notes?: string }
  Response: {
    wo_id: string,
    produced_quantity: number,
    yield_percent: number,
    updated_at: string
  }

// Get yield history for WO
GET /api/production/work-orders/:id/yield/history
  Response: {
    logs: Array<{
      id: string,
      timestamp: string,
      user_name: string,
      old_quantity: number,
      new_quantity: number,
      old_yield_percent: number,
      new_yield_percent: number,
      notes?: string
    }>
  }
```

### Database

**Existing Table (from planning.md):**
```sql
-- work_orders table already has these fields:
planned_quantity    DECIMAL(15,4) NOT NULL
produced_quantity   DECIMAL(15,4) DEFAULT 0
yield_percent       DECIMAL(5,2)            -- Calculated
```

**New Table (Migration Required):**
```sql
CREATE TABLE yield_logs (
  id                  UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id              UUID NOT NULL REFERENCES organizations(id),
  wo_id               UUID NOT NULL REFERENCES work_orders(id) ON DELETE CASCADE,
  old_quantity        DECIMAL(15,4) NOT NULL,
  new_quantity        DECIMAL(15,4) NOT NULL,
  old_yield_percent   DECIMAL(5,2) NOT NULL,
  new_yield_percent   DECIMAL(5,2) NOT NULL,
  notes               TEXT,
  created_at          TIMESTAMPTZ DEFAULT now(),
  created_by          UUID REFERENCES users(id),
  CONSTRAINT yield_logs_org_id_fkey FOREIGN KEY (org_id) REFERENCES organizations(id),
  CONSTRAINT yield_logs_wo_id_fkey FOREIGN KEY (wo_id) REFERENCES work_orders(id)
);

-- RLS policies
CREATE POLICY "yield_logs_tenant_isolation" ON yield_logs
  USING (org_id = current_setting('app.current_org_id')::uuid);

-- Indexes
CREATE INDEX idx_yield_logs_wo_id ON yield_logs(wo_id);
CREATE INDEX idx_yield_logs_created_at ON yield_logs(created_at DESC);
```

### Frontend Components

```
app/(authenticated)/production/work-orders/[id]/
  components/
    YieldSection.tsx              -- Main yield display section
    YieldEntryForm.tsx            -- Manual entry form
    YieldGauge.tsx                -- Visual percentage indicator
    YieldHistoryTable.tsx         -- History of yield updates
    YieldWarningBanner.tsx        -- Low yield alert banner
```

### Services

```typescript
// lib/services/yield-service.ts

export async function updateWorkOrderYield(
  woId: string,
  producedQuantity: number,
  notes?: string
): Promise<YieldUpdateResult> {
  // 1. Fetch current WO data (planned_quantity, old produced_quantity)
  // 2. Validate: no negative, optionally check overproduction setting
  // 3. Calculate new yield_percent = (producedQuantity / plannedQuantity) * 100
  // 4. Update work_orders.produced_quantity and yield_percent
  // 5. Insert yield_logs entry with old/new values
  // 6. Return updated WO data
}

export async function getYieldHistory(
  woId: string
): Promise<YieldLog[]> {
  // Fetch yield_logs for WO, JOIN users for user names, ORDER BY created_at DESC
}

export async function calculateYieldPercentage(
  producedQuantity: number,
  plannedQuantity: number
): number {
  // Formula: (produced / planned) * 100, rounded to 1 decimal
  if (plannedQuantity === 0) return 0;
  return Math.round((producedQuantity / plannedQuantity) * 1000) / 10;
}

export function getYieldIndicatorColor(yieldPercent: number): YieldColor {
  // >= 80: green, 70-79: yellow, < 70: red
  if (yieldPercent >= 80) return 'green';
  if (yieldPercent >= 70) return 'yellow';
  return 'red';
}
```

### Validation (Zod)

```typescript
// lib/validation/yield-validation.ts

export const updateYieldSchema = z.object({
  produced_quantity: z
    .number()
    .nonnegative({ message: "Produced quantity must be positive" })
    .finite(),
  notes: z.string().max(1000).optional(),
});

export const yieldLogSchema = z.object({
  wo_id: z.string().uuid(),
  old_quantity: z.number().nonnegative(),
  new_quantity: z.number().nonnegative(),
  old_yield_percent: z.number().min(0).max(10000), // Allow > 100% for overproduction
  new_yield_percent: z.number().min(0).max(10000),
  notes: z.string().max(1000).optional(),
});

// Runtime validation with settings check
export async function validateYieldUpdate(
  woId: string,
  producedQuantity: number,
  orgId: string
): Promise<ValidationResult> {
  // 1. Validate schema
  // 2. Fetch WO planned_quantity
  // 3. Check production_settings.allow_overproduction
  // 4. If !allow_overproduction && producedQuantity > planned, reject
  // 5. Return validation result
}
```

### Key Business Rules

1. **Yield Calculation:** `yield_percent = (produced_quantity / planned_quantity) * 100`
2. **Rounding:** Yield percent rounded to 1 decimal place (e.g., 95.5%)
3. **Overproduction Control:** If `production_settings.allow_overproduction = false`, produced_quantity cannot exceed planned_quantity
4. **Low Yield Threshold:** Yield < 80% triggers warning (configurable in Phase 2)
5. **Status Restriction:** Yield entry only allowed when WO status = 'In Progress'
6. **Audit Trail:** Every yield update creates `yield_logs` entry with old/new values and user
7. **Zero Planned Quantity:** If planned_quantity = 0, yield_percent = 0 (edge case)
8. **Visual Indicators:**
   - Green: yield >= 80%
   - Yellow: 70% <= yield < 80%
   - Red: yield < 70%

---

## Deliverables

### API Routes
- `PATCH /api/production/work-orders/:id/yield` - Update produced quantity
- `GET /api/production/work-orders/:id/yield/history` - Fetch yield history

### Components
- `YieldSection.tsx` - Container component
- `YieldEntryForm.tsx` - Form with validation
- `YieldGauge.tsx` - Visual percentage display
- `YieldHistoryTable.tsx` - History with pagination
- `YieldWarningBanner.tsx` - Alert component

### Services
- `lib/services/yield-service.ts` - Business logic for yield tracking

### Validation
- `lib/validation/yield-validation.ts` - Zod schemas

### Database
- Migration: Create `yield_logs` table with RLS policies
- Update: Ensure `work_orders` has `yield_percent` column (already in schema)

### Tests
- Unit tests: `yield-service.test.ts` (calculation logic, validation)
- Integration tests: API endpoint tests with Supabase
- E2E tests: Manual yield entry workflow (Playwright)

---

## Definition of Done

- [ ] `yield_logs` table created with RLS policies
- [ ] API endpoint `PATCH /api/production/work-orders/:id/yield` implemented
- [ ] API endpoint `GET /api/production/work-orders/:id/yield/history` implemented
- [ ] `yield-service.ts` with calculation and validation logic
- [ ] Zod validation schemas for yield updates
- [ ] `YieldSection` component integrated on WO detail page
- [ ] Yield gauge with color-coded indicators (green/yellow/red)
- [ ] Yield history table with user audit trail
- [ ] Low yield warning banner on WO detail page
- [ ] Yield column added to WO list/dashboard table
- [ ] Overproduction validation based on `production_settings`
- [ ] Unit tests for yield calculation (>80% coverage)
- [ ] Integration tests for yield update API
- [ ] E2E test: Operator enters yield, sees updated percentage and history
- [ ] Performance: Yield updates complete within 500ms
- [ ] Error handling: Network errors, validation errors display user-friendly messages
- [ ] Documentation: Inline comments for yield calculation formula

---

## Future Phases (Not in This Story)

### Phase 1 (Story 04.7a - Output Registration Desktop)
- **Automatic Yield Calculation from Outputs:** When operator registers output via License Plates, system automatically updates `work_orders.produced_quantity` by summing all `production_outputs.quantity` for the WO
- **Integration with production_outputs Table:** `SUM(production_outputs.quantity WHERE wo_id = X)` -> `work_orders.produced_quantity`
- **Dual Yield Sources:** Support both manual entry (this story) and automatic from outputs (04.7a), with automatic taking precedence if configured

### Phase 1 (Story 04.6a - Material Consumption Desktop)
- **Material Yield Tracking:** Calculate material yield as `(planned_material_qty / actual_consumed_qty) * 100`
- **Material Efficiency Indicators:** Show material variance on WO detail page
- **Over-consumption Impact:** Display how consumption affects overall yield

### Phase 2 (Story 04.10c - Yield Analysis Report)
- **Yield Trend Charts:** Daily/weekly/monthly yield trends by product, line, machine
- **Pareto Analysis:** Identify products/lines with consistently low yield
- **Yield Variance Analysis:** Compare planned vs actual yield over time
- **Export Yield Data:** CSV/Excel export for external analysis

### Phase 2 (Enhanced Alerts)
- **Yield Notifications:** Send alerts to managers when yield drops below threshold
- **Predictive Alerts:** ML-based prediction of yield issues based on historical patterns
- **Shift-based Yield Comparison:** Compare yield across shifts to identify training needs

### Phase 2 (Advanced Settings)
- **Configurable Thresholds:** Allow org to set custom low yield thresholds (default 80%)
- **Product-specific Yield Targets:** Different yield targets per product category
- **Machine-specific Yield Tracking:** Yield by machine to identify equipment issues

**Implementation:** See Epic 04.0 "Story Creation Brief" for phase roadmap.

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-12-16 | Initial story creation | ARCHITECT-AGENT |
