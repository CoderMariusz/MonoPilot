# 04.6e - Over-Consumption Control

**Story ID:** 04.6e
**Epic:** 04 - Production
**Phase:** 1 (MVP)
**Complexity:** S (Small)
**Estimate:** 2 days
**Type:** Full-stack
**State:** ready

**Primary PRD:** `docs/1-BASELINE/product/modules/PRODUCTION.md` (FR-PROD-010)
**Context Files:** `docs/2-MANAGEMENT/epics/current/04-production/context/04.6e/`

## PRD References

| FR ID | Requirement | Priority | Phase | Covered |
|-------|-------------|----------|-------|---------|
| FR-PROD-010 | Over-Consumption Control | P0 | MVP | Yes |

## User Story

**As an** operator,
**I want** to request manager approval when I need to consume more material than the BOM requires,
**So that** I can proceed with production while maintaining proper oversight and variance tracking.

**As a** production manager,
**I want** to approve or reject over-consumption requests with documented reasons,
**So that** I can control material usage, investigate waste, and maintain accurate cost tracking.

## Goal

Implement over-consumption control that detects when material consumption exceeds BOM requirements and either allows it with variance tracking (when setting enabled) or requires manager approval (when setting disabled). Track variance percentages in the materials table and flag high-variance (>10%) work orders on the dashboard.

## Scope

**In scope:**
- Detection of over-consumption (consumed + attempting > required)
- Approval request modal for Operator
- Approval/Reject controls for Manager
- Pending approval status display
- Variance indicator on materials table
- Variance color coding (green/yellow/red)
- Dashboard high variance alert flag
- Audit trail for approvals/rejections
- Production settings integration (`allow_over_consumption`)

**Out of scope:**
- Email/push notifications for approval requests
- Approval request expiration
- Bulk approval of multiple requests
- Variance tolerance configuration per material
- Automatic approval rules

## Dependencies

| Story | Requirement | Status |
|-------|-------------|--------|
| 04.6a | Material Consumption Desktop | Required - provides consumption flow |
| 04.5 | Production Settings | Required - provides allow_over_consumption setting |
| 01.1 | Org Context + Base RLS | Required - provides auth context |

**Blocks:**
- 04.1 (Production Dashboard) - Dashboard shows high variance alerts
- 04.10e (Material Consumption Report) - Reports need variance data

## Acceptance Criteria (Given/When/Then)

### Over-Consumption Detection

#### When Over-Consumption Disabled (allow_over_consumption = false)
- GIVEN allow_over_consumption = false AND required = 100 AND consumed = 100, WHEN user attempts to consume additional 10, THEN approval request modal displays.
- GIVEN approval is pending, WHEN operator views consumption, THEN "Awaiting manager approval" status displays.
- GIVEN operator creates over-consumption request, WHEN request submitted, THEN request_id generated and status = 'pending'.

#### When Over-Consumption Enabled (allow_over_consumption = true)
- GIVEN allow_over_consumption = true AND required = 100 AND consumed = 100, WHEN user consumes additional 10, THEN consumption proceeds with variance = +10%.
- GIVEN consumption proceeds with variance, WHEN materials table displays, THEN variance percentage shown in appropriate color.

### Variance Indicator Display

#### Exact Match (0%)
- GIVEN material has consumed_qty = required_qty, WHEN displayed in materials table, THEN variance indicator shows in green with "0%".

#### Acceptable Variance (1-10%)
- GIVEN material has variance between 1% and 10%, WHEN displayed in materials table, THEN variance indicator shows in yellow with percentage (e.g., "+5%").

#### High Variance (>10%)
- GIVEN material has variance > 10%, WHEN displayed in materials table, THEN variance indicator shows in red with percentage (e.g., "+15%").
- GIVEN WO has any material with variance > 10%, WHEN dashboard loads, THEN WO is flagged in "High Variance" alert section.

### Manager Approval Workflow

#### Approve Over-Consumption
- GIVEN over-consumption approval requested, WHEN manager clicks "Approve", THEN approval reason input displays (optional).
- GIVEN manager approves with reason "Additional material needed due to higher moisture content", WHEN confirmed, THEN consumption proceeds and audit trail records approval with reason.
- GIVEN manager approves, WHEN approval complete, THEN LP quantity decreases by requested amount.
- GIVEN manager approves, WHEN approval complete, THEN consumption record created with link to approval request.

#### Reject Over-Consumption
- GIVEN over-consumption approval requested, WHEN manager clicks "Reject", THEN rejection reason input displays (required).
- GIVEN manager attempts to reject without reason, WHEN form submitted, THEN validation error "Rejection reason is required" displays.
- GIVEN manager rejects with reason "Investigate waste", WHEN confirmed, THEN consumption is blocked and rejection reason is recorded.
- GIVEN rejection recorded, WHEN operator views request, THEN rejection reason displays with manager name and timestamp.

### Permission Enforcement

- GIVEN user has role "Operator", WHEN viewing approval modal, THEN only "Awaiting approval" view displays (no approve/reject buttons).
- GIVEN user has role "Manager" or "Admin", WHEN viewing approval modal, THEN "Approve" and "Reject" buttons are visible.
- GIVEN Operator attempts to approve via API, WHEN request processed, THEN 403 Forbidden returns.

### Pending Request Handling

- GIVEN pending request exists for a material, WHEN operator attempts to create another request for same material, THEN error "A pending approval request already exists" displays.
- GIVEN operator views pending request, WHEN "Cancel Request" clicked, THEN request status changes to 'cancelled' and can create new request.

### Multi-tenancy

- GIVEN User A from Org A, WHEN requesting approval, THEN only org_id = Org A context used.
- GIVEN User A from Org A, WHEN attempting to view Org B approval, THEN 404 Not Found returns (not 403).

## Technical Specification

### Database Schema

#### over_consumption_approvals table

```sql
CREATE TABLE IF NOT EXISTS over_consumption_approvals (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id),
  wo_id UUID NOT NULL REFERENCES work_orders(id),
  wo_material_id UUID NOT NULL REFERENCES wo_materials(id),
  lp_id UUID NOT NULL REFERENCES license_plates(id),

  -- Quantity tracking
  requested_qty DECIMAL(15,4) NOT NULL,
  current_consumed_qty DECIMAL(15,4) NOT NULL,
  required_qty DECIMAL(15,4) NOT NULL,
  total_after_qty DECIMAL(15,4) NOT NULL,
  over_consumption_qty DECIMAL(15,4) NOT NULL,
  variance_percent DECIMAL(8,2) NOT NULL,

  -- Request info
  requested_by UUID NOT NULL REFERENCES users(id),
  requested_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),

  -- Status and decision
  status TEXT NOT NULL DEFAULT 'pending'
    CHECK (status IN ('pending', 'approved', 'rejected', 'cancelled')),
  decided_by UUID REFERENCES users(id),
  decided_at TIMESTAMPTZ,
  approval_reason TEXT,
  rejection_reason TEXT,

  -- Linked consumption (after approval)
  consumption_id UUID REFERENCES material_consumptions(id),

  -- Timestamps
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- Indexes
CREATE INDEX idx_over_consumption_approvals_org_status
  ON over_consumption_approvals(org_id, status);

CREATE INDEX idx_over_consumption_approvals_wo
  ON over_consumption_approvals(wo_id, status);

CREATE INDEX idx_over_consumption_approvals_pending
  ON over_consumption_approvals(org_id)
  WHERE status = 'pending';

-- Trigger to update updated_at
CREATE TRIGGER update_over_consumption_approvals_updated_at
  BEFORE UPDATE ON over_consumption_approvals
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();
```

### RLS Policies

```sql
-- Enable RLS
ALTER TABLE over_consumption_approvals ENABLE ROW LEVEL SECURITY;

-- SELECT: All users in org can view approvals
CREATE POLICY over_consumption_approvals_select ON over_consumption_approvals
  FOR SELECT USING (
    org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  );

-- INSERT: Any production user can request approval
CREATE POLICY over_consumption_approvals_insert ON over_consumption_approvals
  FOR INSERT WITH CHECK (
    org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    AND requested_by = auth.uid()
  );

-- UPDATE: Only Manager/Admin can approve/reject
CREATE POLICY over_consumption_approvals_update ON over_consumption_approvals
  FOR UPDATE USING (
    org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    AND EXISTS (
      SELECT 1 FROM users u
      JOIN roles r ON r.id = u.role_id
      WHERE u.id = auth.uid()
      AND (r.name = 'admin' OR r.name = 'production_manager' OR r.name = 'owner')
    )
  );
```

### API Endpoints

```
# Over-Consumption Approval Workflow
POST   /api/production/work-orders/:woId/over-consumption/request   - Request approval for over-consumption
POST   /api/production/work-orders/:woId/over-consumption/approve   - Approve request (Manager only)
POST   /api/production/work-orders/:woId/over-consumption/reject    - Reject request (Manager only)
GET    /api/production/work-orders/:woId/over-consumption/pending   - Get pending requests for WO
```

### Service Methods

**Location:** `lib/services/over-consumption-service.ts`

```typescript
interface OverConsumptionService {
  // Detection
  checkOverConsumption(woMaterialId: string, requestedQty: number): Promise<{
    isOverConsumption: boolean;
    overQty?: number;
    variancePercent?: number;
    requiredQty?: number;
    currentConsumedQty?: number;
  }>;

  // Request workflow
  createOverConsumptionRequest(
    woId: string,
    woMaterialId: string,
    lpId: string,
    requestedQty: number
  ): Promise<OverConsumptionRequestResult>;

  // Approval workflow
  approveOverConsumption(requestId: string, reason?: string): Promise<OverConsumptionApprovalResult>;
  rejectOverConsumption(requestId: string, reason: string): Promise<OverConsumptionRejectionResult>;

  // Query
  getPendingRequests(woId: string): Promise<PendingRequest[]>;
  getHighVarianceWOs(): Promise<HighVarianceWO[]>;
}

interface OverConsumptionRequestResult {
  request_id: string;
  status: 'pending';
  wo_id: string;
  wo_number: string;
  wo_material_id: string;
  product_code: string;
  product_name: string;
  lp_id: string;
  lp_number: string;
  required_qty: number;
  current_consumed_qty: number;
  requested_qty: number;
  total_after_qty: number;
  over_consumption_qty: number;
  variance_percent: number;
  requested_by: string;
  requested_by_name: string;
  requested_at: string;
  message: string;
}

interface OverConsumptionApprovalResult {
  request_id: string;
  status: 'approved';
  consumption_id: string;
  approved_by: string;
  approved_by_name: string;
  approved_at: string;
  reason: string | null;
  lp_new_qty: number;
  message: string;
}

interface OverConsumptionRejectionResult {
  request_id: string;
  status: 'rejected';
  rejected_by: string;
  rejected_by_name: string;
  rejected_at: string;
  reason: string;
  message: string;
}

interface VarianceIndicator {
  percent: number;
  status: 'exact' | 'acceptable' | 'high';
  color: 'green' | 'yellow' | 'red';
}
```

### Zod Validation Schemas

**Location:** `lib/validation/production-schemas.ts`

```typescript
import { z } from 'zod';

// Over-consumption request
export const overConsumptionRequestSchema = z.object({
  wo_material_id: z.string().uuid('Invalid material ID'),
  lp_id: z.string().uuid('Invalid LP ID'),
  requested_qty: z.number().positive('Quantity must be positive'),
});

// Over-consumption approval
export const overConsumptionApprovalSchema = z.object({
  request_id: z.string().uuid('Invalid request ID'),
  reason: z.string().max(500).optional(),
});

// Over-consumption rejection
export const overConsumptionRejectionSchema = z.object({
  request_id: z.string().uuid('Invalid request ID'),
  reason: z.string().min(1, 'Rejection reason is required').max(500),
});
```

## UI Components

### Pages

- Uses existing: `app/(authenticated)/production/consumption/[woId]/page.tsx`
  - Add variance indicator to materials table
  - Integrate over-consumption approval modal
  - Show pending approval status

### Components

**Location:** `components/production/consumption/`

```
OverConsumptionApprovalModal.tsx  - Modal for approval workflow (operator & manager views)
VarianceIndicator.tsx             - Visual indicator for material variance
```

### Component Details

**OverConsumptionApprovalModal.tsx**
```tsx
interface OverConsumptionApprovalModalProps {
  overConsumptionData: OverConsumptionDetection;
  open: boolean;
  onOpenChange: (open: boolean) => void;
  onApproved: (result: OverConsumptionApprovalResult) => void;
  onRejected: (result: OverConsumptionRejectionResult) => void;
  onRequestSubmitted: (result: OverConsumptionRequestResult) => void;
  isManager: boolean;
}

// Sections:
// 1. Over-Consumption Summary (material, qty, variance)
// 2. Manager: Approval controls (optional reason + approve/reject)
// 3. Operator: Awaiting status (pending message + cancel button)
```

**VarianceIndicator.tsx**
```tsx
interface VarianceIndicatorProps {
  variancePercent: number;
  size?: 'sm' | 'md';
}

// Renders:
// - 0%: Green CheckCircle + "0%"
// - 1-10%: Yellow AlertTriangle + "+X%"
// - >10%: Red XCircle + "+X%"
```

### UI Patterns

**Variance Indicator:**
```
+----------------------------------+
| [icon] +X%                       |
+----------------------------------+
  Green (0%)    = CheckCircle
  Yellow (1-10%) = AlertTriangle
  Red (>10%)    = XCircle
```

**Over-Consumption Modal (Operator View):**
```
+------------------------------------------+
| [!] Over-Consumption Approval Required   |
+------------------------------------------+
| Material: RM-001 - Raw Material A        |
| WO Number: WO-2025-001                   |
|                                          |
| BOM Requirement:  100 kg                 |
| Already Consumed: 100 kg                 |
| Attempting:       +10 kg                 |
| Total After:      110 kg                 |
| Over-consumption: +10 kg (+10%)          |
+------------------------------------------+
| [clock] Awaiting Manager Approval        |
|                                          |
| Notification sent to: Sarah Lee          |
| Request ID: abc-123-xyz                  |
+------------------------------------------+
| [Close]                  [Cancel Request]|
+------------------------------------------+
```

**Over-Consumption Modal (Manager View):**
```
+------------------------------------------+
| [!] Over-Consumption Approval Required   |
+------------------------------------------+
| Material: RM-001 - Raw Material A        |
| WO Number: WO-2025-001                   |
| Requested by: John Doe                   |
|                                          |
| BOM Requirement:  100 kg                 |
| Already Consumed: 100 kg                 |
| Attempting:       +10 kg                 |
| Total After:      110 kg                 |
| Over-consumption: +10 kg (+10%)          |
+------------------------------------------+
| Reason for Approval (Optional)           |
| [__________________________________]     |
|                                          |
+------------------------------------------+
| [Reject]             [Approve Over-Cons.]|
+------------------------------------------+
```

## Test Cases

### Unit Tests

**variance-indicator.test.tsx**
```typescript
describe('VarianceIndicator', () => {
  it('renders green indicator for 0% variance');
  it('renders yellow indicator for 5% variance');
  it('renders red indicator for 15% variance');
  it('formats decimal variance correctly (7.5%)');
  it('uses correct icons for each status');
});
```

**production-schemas.test.ts**
```typescript
describe('overConsumptionRequestSchema', () => {
  it('rejects missing wo_material_id');
  it('rejects missing lp_id');
  it('rejects missing requested_qty');
  it('rejects negative requested_qty');
  it('accepts valid request');
});

describe('overConsumptionRejectionSchema', () => {
  it('rejects missing reason');
  it('rejects empty reason');
  it('accepts valid reason');
});
```

**over-consumption-service.test.ts**
```typescript
describe('OverConsumptionService', () => {
  describe('checkOverConsumption', () => {
    it('returns true when consumption exceeds BOM');
    it('returns false when consumption within BOM');
    it('returns false when exactly meets BOM');
    it('calculates variance percent correctly');
  });
});
```

### Integration Tests

**over-consumption-request.test.ts**
```typescript
describe('POST /api/production/work-orders/:woId/over-consumption/request', () => {
  it('returns 201 when over-consumption request created');
  it('returns 400 when not actually over-consumption');
  it('returns 400 when over-consumption is allowed by settings');
  it('returns 400 when pending request already exists');
  it('returns 404 when WO not found');
});
```

**over-consumption-approve.test.ts**
```typescript
describe('POST /api/production/work-orders/:woId/over-consumption/approve', () => {
  it('returns 403 for Operator role');
  it('returns 200 for Manager role and creates consumption');
  it('creates audit log entry on approval');
  it('returns 400 for already decided request');
  it('returns 404 for request not found');
});
```

**over-consumption-reject.test.ts**
```typescript
describe('POST /api/production/work-orders/:woId/over-consumption/reject', () => {
  it('returns 200 for Manager rejection with reason');
  it('returns 400 when reason missing');
  it('returns 403 for non-Manager role');
  it('does not create consumption record on rejection');
});
```

### E2E Tests

**over-consumption.spec.ts**
```typescript
describe('Over-Consumption Control', () => {
  it('shows approval modal when setting OFF and over-consumption detected');
  it('proceeds directly when setting ON with variance tracking');
  it('manager can approve over-consumption');
  it('manager can reject over-consumption');
  it('variance indicator displays correct colors');
  it('dashboard shows high variance alert for >10% variance');
});
```

## Error Handling

| Scenario | HTTP Status | Error Code | Message |
|----------|-------------|------------|---------|
| Not over-consumption | 400 | NOT_OVER_CONSUMPTION | This consumption does not exceed the BOM requirement |
| Over-consumption allowed | 400 | OVER_CONSUMPTION_ALLOWED | Over-consumption is allowed by settings |
| Pending request exists | 400 | PENDING_REQUEST_EXISTS | A pending approval request already exists |
| Request already decided | 400 | ALREADY_DECIDED | This request has already been approved or rejected |
| Rejection without reason | 400 | REASON_REQUIRED | Rejection reason is required |
| Not Manager/Admin | 403 | FORBIDDEN | Only Managers and Admins can approve/reject |
| Request not found | 404 | REQUEST_NOT_FOUND | Approval request not found |
| WO not found | 404 | WO_NOT_FOUND | Work order not found |

## Variance Calculation

**Formula:**
```
variance_percent = ((consumed_qty - required_qty) / required_qty) * 100
```

**Thresholds:**
| Range | Color | Icon | Description |
|-------|-------|------|-------------|
| = 0% | Green | CheckCircle | Exact match |
| 1% - 10% | Yellow | AlertTriangle | Acceptable variance |
| > 10% | Red | XCircle | High variance (dashboard alert) |

## Deliverables

- [ ] `over_consumption_approvals` table migration
- [ ] RLS policies for approval table
- [ ] Over-consumption service (`lib/services/over-consumption-service.ts`)
- [ ] Zod schemas in `lib/validation/production-schemas.ts`
- [ ] POST /api/production/work-orders/:woId/over-consumption/request
- [ ] POST /api/production/work-orders/:woId/over-consumption/approve
- [ ] POST /api/production/work-orders/:woId/over-consumption/reject
- [ ] GET /api/production/work-orders/:woId/over-consumption/pending
- [ ] OverConsumptionApprovalModal component
- [ ] VarianceIndicator component
- [ ] Update MaterialsTable with variance column
- [ ] Integration with consumption flow (checkOverConsumption before consume)
- [ ] Unit tests (>80% coverage)
- [ ] Integration tests
- [ ] E2E tests

## Definition of Done

- [ ] Over-consumption detected when consumed + requested > required
- [ ] When allow_over_consumption = false, approval modal displays
- [ ] When allow_over_consumption = true, consumption proceeds with variance tracking
- [ ] Variance indicator shows correct color (green/yellow/red)
- [ ] Manager can approve with optional reason
- [ ] Manager can reject with required reason
- [ ] Operator sees "Awaiting approval" status for pending requests
- [ ] Non-Manager users cannot approve/reject (403)
- [ ] Approved requests create consumption record and update LP
- [ ] Rejected requests block consumption
- [ ] WOs with >10% variance flagged on dashboard
- [ ] Audit trail records all approval decisions
- [ ] Cross-tenant access returns 404 (not 403)
- [ ] Unit test coverage >= 80%
- [ ] Integration tests pass
- [ ] E2E tests pass
