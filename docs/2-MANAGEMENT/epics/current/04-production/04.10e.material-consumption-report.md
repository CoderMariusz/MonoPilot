# 04.10e - Material Consumption Report

**Story ID:** 04.10e
**Epic:** 04 - Production
**Phase:** 2 (Analytics)
**Complexity:** M (Medium)
**Estimate:** 2 days
**Type:** Full-stack
**State:** ready
**Priority:** P2

**Primary PRD:** `docs/1-BASELINE/product/modules/PRODUCTION.md` (FR-PROD-022e)
**UX Wireframes:** PROD-REP-005 (Material Consumption Report)

## PRD References

| FR ID | Requirement | Priority | Phase | Covered |
|-------|-------------|----------|-------|---------|
| FR-PROD-022e | Material Consumption Report | P1 | Phase 2 | Yes |

## User Story

**As a** production manager,
**I want** to analyze material consumption versus planned quantities,
**So that** I can identify waste, track variance trends, and take corrective action on high-variance materials.

**As a** operations analyst,
**I want** to view consumption trends over time by material and product,
**So that** I can optimize BOM quantities and improve production efficiency.

## Goal

Implement comprehensive material consumption reporting with variance analysis. The report compares planned vs actual consumption, highlights high-variance materials, provides trend visualization, and enables drill-down to specific work orders. Alerts identify materials with consistent over-consumption patterns.

## Scope

**In scope:**
- Consumption vs plan variance analysis
- High variance alerts (configurable threshold)
- Material consumption trends over time
- Top 10 high variance materials table
- Variance scatter plot (planned vs actual)
- Filters: product, material, date range, WO, line
- Export to CSV
- Drill-down to WO consumption details

**Out of scope:**
- Cost analysis (Finance module - 09.x)
- Supplier performance analysis (future)
- Predictive consumption forecasting (future)
- Real-time consumption monitoring (covered in Dashboard)

## Dependencies

| Story | Requirement | Status |
|-------|-------------|--------|
| 04.6a | Material Consumption Desktop | Required - provides wo_material_consumptions data |
| 04.5 | Production Settings | Required - variance threshold settings |
| 03.11a | WO Materials | Required - planned quantities reference |
| 01.1 | Org Context + Base RLS | Required - provides auth context |

**Blocks:**
- None (standalone report)

## Acceptance Criteria (Given/When/Then)

### Variance Calculation

#### AC-04.10e-001: Positive Variance Calculation
- GIVEN WO planned 100 kg of Material A AND actual consumed is 110 kg, WHEN variance calculated, THEN variance = +10% AND variance_qty = +10 kg.

#### AC-04.10e-002: Negative Variance Calculation
- GIVEN WO planned 100 kg of Material A AND actual consumed is 90 kg, WHEN variance calculated, THEN variance = -10% AND variance_qty = -10 kg.

#### AC-04.10e-003: Zero Variance
- GIVEN WO planned 100 kg AND actual consumed is 100 kg, WHEN variance calculated, THEN variance = 0% AND row displayed in green.

### Variance Display

#### AC-04.10e-004: High Variance Highlight
- GIVEN variance > +10% (configurable threshold), WHEN displayed in table, THEN row highlighted in red with warning icon.

#### AC-04.10e-005: Acceptable Variance Highlight
- GIVEN variance between -5% and +5%, WHEN displayed in table, THEN row highlighted in green.

#### AC-04.10e-006: Moderate Variance Highlight
- GIVEN variance between +5% and +10%, WHEN displayed in table, THEN row highlighted in yellow.

### Visualizations

#### AC-04.10e-007: Scatter Plot Hover
- GIVEN scatter plot rendered with data points, WHEN user hovers over a point, THEN tooltip shows: WO number, material name, planned qty, actual qty, variance %.

#### AC-04.10e-008: Trend Line Chart
- GIVEN material filter = "Material A" AND date range = last 30 days, WHEN trend chart rendered, THEN daily consumption totals display with average line.

#### AC-04.10e-009: Top 10 High Variance Table
- GIVEN consumption data exists, WHEN report loads, THEN top 10 materials by absolute variance % display sorted descending.

### Filtering

#### AC-04.10e-010: Product Filter
- GIVEN product filter = "Product X", WHEN applied, THEN only consumptions for WOs producing Product X display.

#### AC-04.10e-011: Material Filter
- GIVEN material filter = "Material A", WHEN applied, THEN only Material A consumptions display across all WOs.

#### AC-04.10e-012: Date Range Filter
- GIVEN date range = Jan 1 to Jan 31, WHEN applied, THEN only consumptions within that range included in calculations.

#### AC-04.10e-013: WO Filter
- GIVEN WO filter = "WO-2025-001", WHEN applied, THEN only that WO's consumption data displays.

#### AC-04.10e-014: Line Filter
- GIVEN line filter = "Line A", WHEN applied, THEN only consumptions from WOs assigned to Line A display.

### High Variance Alerts

#### AC-04.10e-015: High Variance Material Alert
- GIVEN Material A has average variance > +15% over last 7 days, WHEN alerts section viewed, THEN alert "Material A: Consistent over-consumption (+15% avg)" displays.

#### AC-04.10e-016: Variance Threshold Configuration
- GIVEN admin configures high_variance_threshold = 12%, WHEN variance is 13%, THEN material flagged as high variance.

### Export

#### AC-04.10e-017: CSV Export
- GIVEN report generated with filters applied, WHEN "Export CSV" clicked, THEN CSV downloads with columns: WO Number, Material, Material SKU, Planned Qty, Actual Qty, Variance %, Variance Qty, UoM, Consumed Date.

#### AC-04.10e-018: Export All Data
- GIVEN 500 consumption records match filters, WHEN export clicked, THEN all 500 records included in CSV (not just visible page).

### Performance

#### AC-04.10e-019: Report Load Time
- GIVEN 30 days of data with 1000+ consumptions, WHEN report generated, THEN data displays within 3 seconds.

#### AC-04.10e-020: Filter Response Time
- GIVEN report loaded, WHEN filter changed, THEN data refreshes within 1 second.

### Empty States

#### AC-04.10e-021: No Data
- GIVEN no consumption data exists for selected filters, WHEN report generated, THEN "No consumption data for selected criteria" message displays with clear filters option.

### Multi-tenancy

#### AC-04.10e-022: Org Isolation
- GIVEN User from Org A, WHEN requesting consumption report, THEN only Org A consumption data returned.

## Technical Specification

### Database Views/Functions

#### consumption_variance_view

```sql
CREATE OR REPLACE VIEW consumption_variance_view AS
SELECT
  c.org_id,
  c.wo_id,
  w.wo_number,
  w.product_id AS wo_product_id,
  p.name AS product_name,
  p.sku AS product_sku,
  w.line_id,
  l.name AS line_name,
  c.wo_material_id,
  c.product_id AS material_product_id,
  mp.name AS material_name,
  mp.sku AS material_sku,
  wm.required_qty AS planned_qty,
  wm.consumed_qty AS actual_qty,
  wm.uom,
  (wm.consumed_qty - wm.required_qty) AS variance_qty,
  CASE
    WHEN wm.required_qty > 0 THEN
      ROUND(((wm.consumed_qty - wm.required_qty) / wm.required_qty * 100)::numeric, 2)
    ELSE 0
  END AS variance_percent,
  c.consumed_at::date AS consumption_date,
  w.scheduled_date,
  w.completed_at
FROM wo_material_consumptions c
JOIN work_orders w ON c.wo_id = w.id
JOIN wo_materials wm ON c.wo_material_id = wm.id
JOIN products p ON w.product_id = p.id
JOIN products mp ON c.product_id = mp.id
LEFT JOIN production_lines l ON w.line_id = l.id
WHERE c.status = 'active';

-- Index for performance
CREATE INDEX idx_consumption_variance_org_date
ON wo_material_consumptions(org_id, consumed_at DESC);
```

#### get_consumption_variance_summary function

```sql
CREATE OR REPLACE FUNCTION get_consumption_variance_summary(
  p_org_id UUID,
  p_start_date DATE,
  p_end_date DATE,
  p_product_id UUID DEFAULT NULL,
  p_material_id UUID DEFAULT NULL,
  p_line_id UUID DEFAULT NULL,
  p_wo_id UUID DEFAULT NULL
)
RETURNS TABLE (
  material_product_id UUID,
  material_name TEXT,
  material_sku TEXT,
  total_planned_qty DECIMAL,
  total_actual_qty DECIMAL,
  total_variance_qty DECIMAL,
  avg_variance_percent DECIMAL,
  consumption_count INTEGER,
  wo_count INTEGER,
  uom TEXT
) AS $$
BEGIN
  RETURN QUERY
  SELECT
    wm.product_id,
    mp.name,
    mp.sku,
    SUM(wm.required_qty)::DECIMAL,
    SUM(wm.consumed_qty)::DECIMAL,
    SUM(wm.consumed_qty - wm.required_qty)::DECIMAL,
    ROUND(AVG(
      CASE WHEN wm.required_qty > 0
      THEN ((wm.consumed_qty - wm.required_qty) / wm.required_qty * 100)
      ELSE 0 END
    )::numeric, 2),
    COUNT(DISTINCT c.id)::INTEGER,
    COUNT(DISTINCT c.wo_id)::INTEGER,
    wm.uom
  FROM wo_material_consumptions c
  JOIN work_orders w ON c.wo_id = w.id
  JOIN wo_materials wm ON c.wo_material_id = wm.id
  JOIN products mp ON wm.product_id = mp.id
  WHERE c.org_id = p_org_id
    AND c.status = 'active'
    AND c.consumed_at::date BETWEEN p_start_date AND p_end_date
    AND (p_product_id IS NULL OR w.product_id = p_product_id)
    AND (p_material_id IS NULL OR wm.product_id = p_material_id)
    AND (p_line_id IS NULL OR w.line_id = p_line_id)
    AND (p_wo_id IS NULL OR c.wo_id = p_wo_id)
  GROUP BY wm.product_id, mp.name, mp.sku, wm.uom
  ORDER BY ABS(SUM(wm.consumed_qty - wm.required_qty) / NULLIF(SUM(wm.required_qty), 0) * 100) DESC;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

#### get_consumption_trend function

```sql
CREATE OR REPLACE FUNCTION get_consumption_trend(
  p_org_id UUID,
  p_start_date DATE,
  p_end_date DATE,
  p_material_id UUID DEFAULT NULL,
  p_granularity TEXT DEFAULT 'day' -- 'day', 'week', 'month'
)
RETURNS TABLE (
  period_start DATE,
  total_planned_qty DECIMAL,
  total_actual_qty DECIMAL,
  variance_qty DECIMAL,
  variance_percent DECIMAL,
  consumption_count INTEGER
) AS $$
BEGIN
  RETURN QUERY
  SELECT
    CASE p_granularity
      WHEN 'day' THEN c.consumed_at::date
      WHEN 'week' THEN date_trunc('week', c.consumed_at)::date
      WHEN 'month' THEN date_trunc('month', c.consumed_at)::date
    END AS period_start,
    SUM(wm.required_qty)::DECIMAL,
    SUM(wm.consumed_qty)::DECIMAL,
    SUM(wm.consumed_qty - wm.required_qty)::DECIMAL,
    ROUND(AVG(
      CASE WHEN wm.required_qty > 0
      THEN ((wm.consumed_qty - wm.required_qty) / wm.required_qty * 100)
      ELSE 0 END
    )::numeric, 2),
    COUNT(*)::INTEGER
  FROM wo_material_consumptions c
  JOIN wo_materials wm ON c.wo_material_id = wm.id
  WHERE c.org_id = p_org_id
    AND c.status = 'active'
    AND c.consumed_at::date BETWEEN p_start_date AND p_end_date
    AND (p_material_id IS NULL OR wm.product_id = p_material_id)
  GROUP BY 1
  ORDER BY 1;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

### Settings Extension

```sql
-- Add variance threshold to production_settings
ALTER TABLE production_settings ADD COLUMN IF NOT EXISTS
  high_variance_threshold_percent DECIMAL DEFAULT 10
  CHECK (high_variance_threshold_percent >= 0 AND high_variance_threshold_percent <= 100);

ALTER TABLE production_settings ADD COLUMN IF NOT EXISTS
  variance_alert_threshold_percent DECIMAL DEFAULT 15
  CHECK (variance_alert_threshold_percent >= 0 AND variance_alert_threshold_percent <= 100);
```

### API Endpoints

```
# Consumption Variance Report
GET    /api/production/analytics/consumption-variance
       - Get consumption variance summary
       - Query: start_date, end_date, product_id?, material_id?, line_id?, wo_id?, page?, limit?
       - Returns: { summary, items: [], pagination }

# Consumption Trend
GET    /api/production/analytics/consumption-trend
       - Get consumption trend over time
       - Query: start_date, end_date, material_id?, granularity? (day|week|month)
       - Returns: { trend: [], material_name? }

# High Variance Materials
GET    /api/production/analytics/high-variance-materials
       - Get top materials by variance
       - Query: start_date, end_date, limit? (default 10), threshold?
       - Returns: { materials: [], threshold_used }

# High Variance Alerts
GET    /api/production/analytics/consumption-alerts
       - Get materials with consistent high variance
       - Query: days? (default 7), threshold?
       - Returns: { alerts: [] }

# Export
POST   /api/production/analytics/consumption-variance/export
       - Export filtered data to CSV
       - Body: { start_date, end_date, product_id?, material_id?, line_id?, wo_id?, format: 'csv' }
       - Returns: CSV file download
```

### Service Methods

**Location:** `lib/services/consumption-report-service.ts`

```typescript
interface ConsumptionReportService {
  // Variance Analysis
  getConsumptionVariance(
    orgId: string,
    startDate: Date,
    endDate: Date,
    filters?: ConsumptionFilters,
    pagination?: PaginationParams
  ): Promise<ConsumptionVarianceResult>;

  // Trend Analysis
  getConsumptionTrend(
    orgId: string,
    startDate: Date,
    endDate: Date,
    materialId?: string,
    granularity?: 'day' | 'week' | 'month'
  ): Promise<ConsumptionTrendResult>;

  // High Variance
  getHighVarianceMaterials(
    orgId: string,
    startDate: Date,
    endDate: Date,
    limit?: number,
    threshold?: number
  ): Promise<HighVarianceMaterial[]>;

  // Alerts
  getConsumptionAlerts(
    orgId: string,
    days?: number,
    threshold?: number
  ): Promise<ConsumptionAlert[]>;

  // Export
  exportConsumptionReport(
    orgId: string,
    params: ExportParams
  ): Promise<Buffer>;

  // Helpers
  calculateVariance(planned: number, actual: number): VarianceResult;
  getVarianceColor(variancePercent: number, threshold: number): 'green' | 'yellow' | 'red';
}

interface ConsumptionFilters {
  product_id?: string;
  material_id?: string;
  line_id?: string;
  wo_id?: string;
}

interface ConsumptionVarianceResult {
  summary: {
    total_planned_qty: number;
    total_actual_qty: number;
    total_variance_qty: number;
    avg_variance_percent: number;
    total_consumptions: number;
    total_wos: number;
  };
  items: ConsumptionVarianceItem[];
  pagination: PaginationInfo;
}

interface ConsumptionVarianceItem {
  wo_number: string;
  wo_id: string;
  product_name: string;
  material_name: string;
  material_sku: string;
  planned_qty: number;
  actual_qty: number;
  variance_qty: number;
  variance_percent: number;
  uom: string;
  consumption_date: string;
  line_name?: string;
  variance_color: 'green' | 'yellow' | 'red';
}

interface ConsumptionTrendResult {
  trend: {
    period_start: string;
    total_planned_qty: number;
    total_actual_qty: number;
    variance_qty: number;
    variance_percent: number;
    consumption_count: number;
  }[];
  material_name?: string;
  avg_variance: number;
}

interface HighVarianceMaterial {
  material_product_id: string;
  material_name: string;
  material_sku: string;
  total_planned_qty: number;
  total_actual_qty: number;
  total_variance_qty: number;
  avg_variance_percent: number;
  consumption_count: number;
  wo_count: number;
  uom: string;
}

interface ConsumptionAlert {
  material_id: string;
  material_name: string;
  material_sku: string;
  avg_variance_percent: number;
  trend: 'increasing' | 'stable' | 'decreasing';
  affected_wos: number;
  message: string;
  severity: 'warning' | 'critical';
}

interface VarianceResult {
  variance_qty: number;
  variance_percent: number;
  direction: 'over' | 'under' | 'exact';
}
```

### Zod Validation Schemas

**Location:** `lib/validation/consumption-report-schema.ts`

```typescript
import { z } from 'zod';

// Query params for variance report
export const consumptionVarianceQuerySchema = z.object({
  start_date: z.string().refine((d) => !isNaN(Date.parse(d)), 'Invalid start date'),
  end_date: z.string().refine((d) => !isNaN(Date.parse(d)), 'Invalid end date'),
  product_id: z.string().uuid().optional(),
  material_id: z.string().uuid().optional(),
  line_id: z.string().uuid().optional(),
  wo_id: z.string().uuid().optional(),
  page: z.coerce.number().min(1).default(1),
  limit: z.coerce.number().min(1).max(100).default(20),
}).refine(
  (data) => new Date(data.start_date) <= new Date(data.end_date),
  { message: 'Start date must be before or equal to end date' }
);

// Query params for trend
export const consumptionTrendQuerySchema = z.object({
  start_date: z.string().refine((d) => !isNaN(Date.parse(d)), 'Invalid start date'),
  end_date: z.string().refine((d) => !isNaN(Date.parse(d)), 'Invalid end date'),
  material_id: z.string().uuid().optional(),
  granularity: z.enum(['day', 'week', 'month']).default('day'),
});

// Query params for high variance
export const highVarianceQuerySchema = z.object({
  start_date: z.string().refine((d) => !isNaN(Date.parse(d)), 'Invalid start date'),
  end_date: z.string().refine((d) => !isNaN(Date.parse(d)), 'Invalid end date'),
  limit: z.coerce.number().min(1).max(50).default(10),
  threshold: z.coerce.number().min(0).max(100).optional(),
});

// Query params for alerts
export const consumptionAlertsQuerySchema = z.object({
  days: z.coerce.number().min(1).max(90).default(7),
  threshold: z.coerce.number().min(0).max(100).optional(),
});

// Export request
export const exportConsumptionReportSchema = z.object({
  start_date: z.string().refine((d) => !isNaN(Date.parse(d)), 'Invalid start date'),
  end_date: z.string().refine((d) => !isNaN(Date.parse(d)), 'Invalid end date'),
  product_id: z.string().uuid().optional(),
  material_id: z.string().uuid().optional(),
  line_id: z.string().uuid().optional(),
  wo_id: z.string().uuid().optional(),
  format: z.enum(['csv']).default('csv'),
});

// Response schemas
export const consumptionVarianceItemSchema = z.object({
  wo_number: z.string(),
  wo_id: z.string().uuid(),
  product_name: z.string(),
  material_name: z.string(),
  material_sku: z.string(),
  planned_qty: z.number(),
  actual_qty: z.number(),
  variance_qty: z.number(),
  variance_percent: z.number(),
  uom: z.string(),
  consumption_date: z.string(),
  line_name: z.string().nullable(),
  variance_color: z.enum(['green', 'yellow', 'red']),
});

export const consumptionVarianceResponseSchema = z.object({
  summary: z.object({
    total_planned_qty: z.number(),
    total_actual_qty: z.number(),
    total_variance_qty: z.number(),
    avg_variance_percent: z.number(),
    total_consumptions: z.number(),
    total_wos: z.number(),
  }),
  items: z.array(consumptionVarianceItemSchema),
  pagination: z.object({
    page: z.number(),
    limit: z.number(),
    total: z.number(),
    total_pages: z.number(),
  }),
});
```

## UI Components

### Pages

- `app/(authenticated)/production/reports/consumption/page.tsx` - Material Consumption Report page

### Components

**Location:** `components/production/reports/consumption/`

```
ConsumptionReportPage.tsx      - Main report page with filters and tabs
ConsumptionFiltersBar.tsx      - Filter controls (date range, product, material, line, WO)
ConsumptionSummaryCards.tsx    - Summary KPI cards (total planned, actual, variance)
ConsumptionVarianceTable.tsx   - Detailed variance table with sorting/pagination
VarianceScatterChart.tsx       - Scatter plot (planned vs actual)
ConsumptionTrendChart.tsx      - Line chart for consumption trends
HighVarianceMaterialsCard.tsx  - Top 10 high variance materials card
ConsumptionAlertsPanel.tsx     - High variance alerts panel
ExportButton.tsx               - CSV export button
VarianceBadge.tsx              - Color-coded variance percentage badge
```

### Component Details

**ConsumptionReportPage.tsx**
```tsx
// Layout:
// - Page header with title and date range picker
// - Filter bar (Product, Material, Line, WO dropdowns)
// - Summary cards row (4 cards)
// - Tab navigation: Overview | Details | Trends | Alerts
// - Tab content area
// - Export button (fixed bottom right)
```

**ConsumptionSummaryCards.tsx**
```tsx
interface ConsumptionSummaryCardsProps {
  summary: {
    total_planned_qty: number;
    total_actual_qty: number;
    total_variance_qty: number;
    avg_variance_percent: number;
    total_consumptions: number;
    total_wos: number;
  };
  isLoading: boolean;
}

// Cards:
// 1. Total Planned - sum of planned quantities
// 2. Total Actual - sum of actual consumed
// 3. Net Variance - variance qty with direction indicator
// 4. Avg Variance % - color-coded by threshold
```

**ConsumptionVarianceTable.tsx**
```tsx
interface ConsumptionVarianceTableProps {
  items: ConsumptionVarianceItem[];
  pagination: PaginationInfo;
  onPageChange: (page: number) => void;
  onSort: (column: string, direction: 'asc' | 'desc') => void;
  onRowClick: (woId: string) => void;
  isLoading: boolean;
}

// Columns:
// - WO Number (link to WO detail)
// - Product (finished product)
// - Material (consumed material)
// - Planned Qty
// - Actual Qty
// - Variance Qty (with direction icon)
// - Variance % (color-coded badge)
// - UoM
// - Date

// Features:
// - Sortable columns
// - Row click to drill down to WO
// - Color-coded variance cells
// - Pagination
```

**VarianceScatterChart.tsx**
```tsx
interface VarianceScatterChartProps {
  data: {
    wo_number: string;
    material_name: string;
    planned_qty: number;
    actual_qty: number;
    variance_percent: number;
  }[];
  onPointClick?: (woId: string) => void;
}

// Chart:
// - X-axis: Planned Quantity
// - Y-axis: Actual Quantity
// - Diagonal line: Perfect match (planned = actual)
// - Points above line: Over-consumption
// - Points below line: Under-consumption
// - Point color: Green (<5%), Yellow (5-10%), Red (>10%)
// - Hover tooltip: WO, Material, Planned, Actual, Variance %
```

**ConsumptionTrendChart.tsx**
```tsx
interface ConsumptionTrendChartProps {
  data: {
    period_start: string;
    total_planned_qty: number;
    total_actual_qty: number;
    variance_percent: number;
  }[];
  granularity: 'day' | 'week' | 'month';
  materialName?: string;
}

// Chart:
// - Dual line chart (Planned vs Actual)
// - X-axis: Time period
// - Y-axis: Quantity
// - Secondary Y-axis: Variance %
// - Shaded area between lines
// - Average variance line (dashed)
```

**HighVarianceMaterialsCard.tsx**
```tsx
interface HighVarianceMaterialsCardProps {
  materials: HighVarianceMaterial[];
  threshold: number;
  onMaterialClick: (materialId: string) => void;
  isLoading: boolean;
}

// Content:
// - Title: "Top 10 High Variance Materials"
// - Table: Material, Planned, Actual, Variance %, WO Count
// - Sorted by absolute variance descending
// - Click to filter report by material
```

**ConsumptionAlertsPanel.tsx**
```tsx
interface ConsumptionAlertsPanelProps {
  alerts: ConsumptionAlert[];
  onAlertClick: (materialId: string) => void;
  isLoading: boolean;
}

// Content:
// - List of alert cards
// - Each card: Material name, avg variance, trend icon, message
// - Severity colors: Warning (yellow), Critical (red)
// - Click to drill down to material details
```

**VarianceBadge.tsx**
```tsx
interface VarianceBadgeProps {
  variance_percent: number;
  threshold?: number; // default 10
  showDirection?: boolean;
}

// Display:
// - Green: -5% to +5%
// - Yellow: +5% to +threshold
// - Red: > +threshold
// - Arrow up (over) / Arrow down (under) icon
// - Percentage text
```

### Hooks

**Location:** `lib/hooks/`

```typescript
// useConsumptionVariance.ts - Fetch variance data with filters
// useConsumptionTrend.ts - Fetch trend data
// useHighVarianceMaterials.ts - Fetch top variance materials
// useConsumptionAlerts.ts - Fetch consumption alerts
// useExportConsumptionReport.ts - Handle CSV export
```

### UI States

| State | Description | Display |
|-------|-------------|---------|
| loading | Initial data load | Skeleton loaders for charts and tables |
| empty | No data for filters | "No consumption data for selected criteria" with clear filters |
| error | API errors | Toast notification with retry option |
| success | Export complete | Toast "Report exported successfully" |
| partial | Some data missing | Yellow info banner with explanation |

## Test Cases

### Unit Tests

**consumption-report-service.test.ts**
```typescript
describe('ConsumptionReportService', () => {
  describe('calculateVariance', () => {
    it('calculates positive variance correctly');
    it('calculates negative variance correctly');
    it('returns zero for exact match');
    it('handles zero planned quantity');
  });

  describe('getVarianceColor', () => {
    it('returns green for variance within 5%');
    it('returns yellow for variance between 5-10%');
    it('returns red for variance over threshold');
    it('uses custom threshold when provided');
  });

  describe('getConsumptionVariance', () => {
    it('filters by product correctly');
    it('filters by material correctly');
    it('filters by date range correctly');
    it('paginates results correctly');
    it('enforces org isolation');
  });
});
```

**consumption-report-schema.test.ts**
```typescript
describe('consumptionVarianceQuerySchema', () => {
  it('validates required date fields');
  it('rejects invalid date format');
  it('rejects end_date before start_date');
  it('accepts valid optional filters');
});
```

### Integration Tests

**consumption-variance-api.test.ts**
```typescript
describe('GET /api/production/analytics/consumption-variance', () => {
  it('returns 401 for unauthenticated request');
  it('returns 400 for missing date range');
  it('returns correct summary calculations');
  it('filters by product_id correctly');
  it('filters by material_id correctly');
  it('paginates results correctly');
  it('enforces RLS org isolation');
});

describe('GET /api/production/analytics/consumption-trend', () => {
  it('returns daily trend by default');
  it('aggregates by week when specified');
  it('aggregates by month when specified');
  it('filters by material correctly');
});

describe('GET /api/production/analytics/high-variance-materials', () => {
  it('returns top 10 by default');
  it('respects custom limit');
  it('uses custom threshold when provided');
  it('sorts by absolute variance descending');
});

describe('POST /api/production/analytics/consumption-variance/export', () => {
  it('returns CSV file');
  it('includes all columns');
  it('applies filters to export');
  it('handles large datasets');
});
```

### E2E Tests

**consumption-report.spec.ts**
```typescript
describe('Material Consumption Report', () => {
  it('displays summary cards on load');
  it('filters by date range updates data');
  it('filters by product updates table');
  it('scatter chart shows hover tooltip');
  it('trend chart renders with data');
  it('high variance materials clickable');
  it('export downloads CSV file');
  it('empty state shows when no data');
});
```

### Performance Targets

| Metric | Target | Test |
|--------|--------|------|
| Report load time | < 3s | Measure time from page load to data display (30 days) |
| Filter response time | < 1s | Measure time from filter change to data refresh |
| Export time | < 5s | Measure time from export click to download start (1000 records) |
| Chart render time | < 500ms | Measure time to render scatter/trend charts |

## Security Considerations

1. **Role-Based Access**
   - Report access: owner, admin, production_manager, planner, analyst
   - Export access: same roles
   - Settings modification: owner, admin only

2. **RLS Enforcement**
   - All queries filtered by org_id
   - Functions use SECURITY DEFINER with org_id check
   - Cross-tenant access returns empty results

3. **Data Export**
   - Export limited to filtered data
   - No PII in export (only operational data)
   - Audit log entry for exports

4. **Rate Limiting**
   - Export limited to 10 requests per hour
   - Report queries limited to 100 per minute

## Deliverables

- [ ] `consumption_variance_view` database view
- [ ] `get_consumption_variance_summary` function
- [ ] `get_consumption_trend` function
- [ ] Production settings extension (variance thresholds)
- [ ] Consumption report service (`lib/services/consumption-report-service.ts`)
- [ ] Zod schemas (`lib/validation/consumption-report-schema.ts`)
- [ ] GET /api/production/analytics/consumption-variance route
- [ ] GET /api/production/analytics/consumption-trend route
- [ ] GET /api/production/analytics/high-variance-materials route
- [ ] GET /api/production/analytics/consumption-alerts route
- [ ] POST /api/production/analytics/consumption-variance/export route
- [ ] ConsumptionReportPage component
- [ ] ConsumptionFiltersBar component
- [ ] ConsumptionSummaryCards component
- [ ] ConsumptionVarianceTable component
- [ ] VarianceScatterChart component
- [ ] ConsumptionTrendChart component
- [ ] HighVarianceMaterialsCard component
- [ ] ConsumptionAlertsPanel component
- [ ] VarianceBadge component
- [ ] useConsumptionVariance hook
- [ ] useConsumptionTrend hook
- [ ] useHighVarianceMaterials hook
- [ ] useConsumptionAlerts hook
- [ ] useExportConsumptionReport hook
- [ ] Report page (`/production/reports/consumption`)
- [ ] Unit tests (>80% coverage)
- [ ] Integration tests
- [ ] E2E tests

## Definition of Done

- [ ] Variance calculated correctly (planned vs actual)
- [ ] Variance color coding works (green/yellow/red thresholds)
- [ ] All filters work correctly (product, material, line, WO, date range)
- [ ] Summary cards display correct totals
- [ ] Variance table sortable and paginated
- [ ] Scatter plot renders with hover tooltips
- [ ] Trend chart shows consumption over time
- [ ] Top 10 high variance materials displayed
- [ ] Alerts panel shows materials with consistent high variance
- [ ] CSV export includes all filtered data
- [ ] Report loads within 3 seconds (30 days data)
- [ ] Filter changes refresh within 1 second
- [ ] Empty state displays when no data
- [ ] RLS enforces org isolation
- [ ] Unit test coverage >= 80%
- [ ] Integration tests pass
- [ ] E2E tests pass
- [ ] Performance targets met
