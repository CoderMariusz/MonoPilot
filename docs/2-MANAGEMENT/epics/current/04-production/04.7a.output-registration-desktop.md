# 04.7a - Output Registration Desktop

**Story ID:** 04.7a
**Epic:** 04 - Production
**Phase:** 1 (MVP)
**Complexity:** M (Medium)
**Estimate:** 3 days
**Type:** Full-stack
**State:** ready

**Primary PRD:** `docs/1-BASELINE/product/modules/PRODUCTION.md` (FR-PROD-011, FR-PROD-013, FR-PROD-014, FR-PROD-015)
**UX Wireframes:** PROD-004 (Output Registration Desktop)

## PRD References

| FR ID | Requirement | Priority | Phase | Covered |
|-------|-------------|----------|-------|---------|
| FR-PROD-011 | Output Registration (Desktop) | P0 | MVP | Yes |
| FR-PROD-013 | By-Product Registration | P0 | MVP | Yes |
| FR-PROD-014 | Yield Tracking | P0 | MVP | Yes |
| FR-PROD-015 | Multiple Outputs per WO | P0 | MVP | Yes |

## User Story

**As a** production operator,
**I want** to register production outputs from the desktop interface,
**So that** I can track completed quantities, create License Plates for inventory, and maintain full traceability through genealogy.

**As a** production manager,
**I want** to view yield metrics and output history,
**So that** I can monitor production efficiency and identify issues.

## Goal

Implement desktop output registration workflow that creates License Plates for produced goods, updates work order progress, calculates yield metrics, establishes genealogy links to consumed materials, and handles by-product registration. Support multiple partial outputs per work order with cumulative progress tracking.

## Scope

**In scope:**
- Register Output Modal with quantity, QA status, location, expiry date
- Auto-calculation of expiry date from product shelf life
- Batch number inheritance from WO or custom input
- LP creation with source='production' and wo_id linkage
- Genealogy linking (consumed materials -> output LP)
- WO progress updates (output_qty, progress_percent)
- Output history table with filtering, sorting, export
- Yield calculations (output yield, material yield)
- Color-coded yield indicators (green/yellow/red)
- By-product registration with expected qty calculation
- Auto-create by-product LPs (when enabled)
- Settings-aware QA status requirement
- CSV export of output history

**Out of scope:**
- Scanner/mobile output registration (04.7b)
- Label printing (04.7c)
- Auto-complete WO on full output (handled in WO Complete story)
- OEE calculations (Phase 2)
- Quality inspection triggers (Quality module)

## Dependencies

| Story | Requirement | Status |
|-------|-------------|--------|
| 05.1 | License Plates table, LP number generation | Required |
| 05.2 | LP Genealogy table, trace functions | Required |
| 03.3 | Work Orders table, WO Materials | Required |
| 02.4 | BOM Items with is_by_product, yield_percent | Required |

## Acceptance Criteria (Given/When/Then)

### Output Registration (FR-PROD-011)

#### LP Creation
- GIVEN user enters qty=500 and QA status=Approved, WHEN user clicks "Register Output", THEN new LP is created with qty=500, qa_status="Approved", source="production", wo_id=current WO.
- GIVEN product.shelf_life_days=30 AND today=2025-01-01, WHEN Register Output Modal opens, THEN expiry date field defaults to 2025-01-31.
- GIVEN WO has wo_number="WO-2025-001", WHEN output registered without custom batch, THEN LP.batch_number="WO-2025-001".
- GIVEN production line has default_location_id=LOC-A, WHEN Register Output Modal opens, THEN location dropdown pre-selects LOC-A.
- GIVEN user enters qty=0, WHEN submitting, THEN validation error "Quantity must be greater than 0" displays.
- GIVEN output registered, WHEN LP created, THEN LP.source="production" AND LP.wo_id=current WO ID.

#### QA Status Handling
- GIVEN require_qa_on_output=true, WHEN user submits without QA status, THEN validation error "QA status is required" displays.
- GIVEN require_qa_on_output=false, WHEN user submits without QA status, THEN output registers with qa_status=null.
- GIVEN QA status selection, WHEN user clicks "Approved"/"Pending"/"Rejected", THEN corresponding status is set on LP.

#### Genealogy Linking
- GIVEN WO has consumed LP-001 and LP-002, WHEN output registered creating LP-003, THEN lp_genealogy records created with child_lp_id=LP-003 for both parent LPs.
- GIVEN no materials consumed on WO, WHEN output registered, THEN LP created but no genealogy records (warning displayed).
- GIVEN genealogy created, WHEN querying LP-003 backward trace, THEN LP-001 and LP-002 returned as parents.

### By-Product Registration (FR-PROD-013)

#### Expected Qty Calculation
- GIVEN WO.planned_qty=1000 AND by-product yield_percent=5, WHEN by-product registration modal opens, THEN expected qty shows as 50.
- GIVEN auto_create_by_product_lp=true, WHEN main output registered, THEN by-product LPs auto-created with expected quantities.
- GIVEN auto_create_by_product_lp=false, WHEN main output registered, THEN user manually enters by-product quantities.

#### By-Product LP Creation
- GIVEN by-product expected=50 AND user enters actual=45, WHEN registered, THEN LP created with qty=45.
- GIVEN by-product registered, WHEN genealogy queried, THEN by-product LP has same parent_lp_ids as main output LP.
- GIVEN BOM has 3 by-products defined, WHEN by-product registration starts, THEN all 3 by-products display in sequence.
- GIVEN by-product qty entered=0, WHEN user confirms, THEN warning "By-product quantity is 0. Continue?" displays.
- GIVEN all by-products registered, WHEN complete, THEN "By-product registration complete" confirmation displays.

### Yield Tracking (FR-PROD-014)

#### Yield Calculations
- GIVEN WO.planned_qty=1000 AND actual_output_qty=950, WHEN yield calculated, THEN output_yield=95.0%.
- GIVEN planned_material_qty=100 AND actual_consumed_qty=110, WHEN material yield calculated, THEN material_yield=90.9%.
- GIVEN yield calculation, WHEN computed, THEN result is rounded to 1 decimal place (e.g., 95.5%).
- GIVEN no outputs registered, WHEN yield displayed, THEN "N/A" shows instead of percentage.

#### Yield Indicators
- GIVEN output_yield=95%, WHEN displayed, THEN yield indicator shows in green.
- GIVEN output_yield=85%, WHEN displayed, THEN yield indicator shows in yellow.
- GIVEN output_yield=75%, WHEN displayed, THEN yield indicator shows in red.

### Multiple Outputs per WO (FR-PROD-015)

#### Progress Tracking
- GIVEN WO.planned_qty=1000 AND first output=400, WHEN output registered, THEN WO.output_qty=400 AND progress=40%.
- GIVEN WO.output_qty=400 AND second output=300, WHEN second output registered, THEN WO.output_qty=700 AND progress=70%.
- GIVEN 3 outputs registered (LP-001, LP-002, LP-003), WHEN output history viewed, THEN all 3 LPs display with individual quantities.

#### UI Indicators
- GIVEN each output creates separate LP, WHEN output registered, THEN new unique LP ID is generated.
- GIVEN WO has 5 outputs, WHEN output history table loaded, THEN all 5 outputs display within 1 second.
- GIVEN progress bar displayed, WHEN output_qty=750 of 1000 planned, THEN progress bar shows 75% filled.

### Multi-tenancy
- GIVEN User A from Org A, WHEN querying outputs, THEN only Org A outputs returned.
- GIVEN User A from Org A, WHEN attempting to register output for Org B WO, THEN 404 Not Found returns.

## Technical Specification

### Database Schema

Uses existing tables from dependencies. Key columns for output registration:

#### license_plates table (from 05.1)

```sql
-- Columns used for production output
id              UUID PRIMARY KEY
org_id          UUID NOT NULL REFERENCES organizations(id)
lp_number       TEXT NOT NULL UNIQUE (per org)
product_id      UUID NOT NULL REFERENCES products(id)
quantity        NUMERIC(15,4) NOT NULL CHECK (quantity > 0)
uom             TEXT NOT NULL
location_id     UUID REFERENCES locations(id)
status          TEXT NOT NULL DEFAULT 'available'
qa_status       TEXT -- 'approved', 'pending', 'rejected'
batch_number    TEXT
expiry_date     DATE
source          TEXT NOT NULL DEFAULT 'production' -- 'receipt', 'production', 'adjustment'
wo_id           UUID REFERENCES work_orders(id) -- Link to WO for production source
notes           TEXT
created_by      UUID NOT NULL REFERENCES users(id)
created_at      TIMESTAMPTZ DEFAULT NOW()

-- Indexes
CREATE INDEX idx_lps_org_status ON license_plates(org_id, status);
CREATE INDEX idx_lps_org_product ON license_plates(org_id, product_id);
CREATE INDEX idx_lps_wo ON license_plates(wo_id);
CREATE INDEX idx_lps_batch ON license_plates(org_id, batch_number);
```

#### lp_genealogy table (from 05.2)

```sql
-- Tracks parent-child LP relationships for traceability
id              UUID PRIMARY KEY
org_id          UUID NOT NULL REFERENCES organizations(id)
parent_lp_id    UUID NOT NULL REFERENCES license_plates(id)
child_lp_id     UUID NOT NULL REFERENCES license_plates(id)
operation_type  TEXT NOT NULL -- 'consumption', 'production', 'split', 'merge'
quantity        NUMERIC(15,4) -- Qty from parent used in child
wo_id           UUID REFERENCES work_orders(id)
operation_date  TIMESTAMPTZ DEFAULT NOW()
is_reversed     BOOLEAN DEFAULT FALSE

-- Indexes
CREATE INDEX idx_genealogy_org ON lp_genealogy(org_id);
CREATE INDEX idx_genealogy_parent ON lp_genealogy(parent_lp_id);
CREATE INDEX idx_genealogy_child ON lp_genealogy(child_lp_id);
CREATE INDEX idx_genealogy_wo ON lp_genealogy(wo_id);
```

### Database Functions

```sql
-- Calculate output yield for a work order
CREATE OR REPLACE FUNCTION calculate_output_yield(p_wo_id UUID)
RETURNS NUMERIC AS $$
BEGIN
  RETURN (
    SELECT ROUND(
      (COALESCE(SUM(lp.quantity), 0) / NULLIF(wo.planned_qty, 0)) * 100,
      1
    )
    FROM work_orders wo
    LEFT JOIN license_plates lp ON lp.wo_id = wo.id
      AND lp.source = 'production'
      AND lp.product_id = wo.product_id
    WHERE wo.id = p_wo_id
    GROUP BY wo.planned_qty
  );
END;
$$ LANGUAGE plpgsql;

-- Get output summary for work order
CREATE OR REPLACE FUNCTION get_wo_output_summary(p_wo_id UUID)
RETURNS JSONB AS $$
BEGIN
  RETURN (
    SELECT jsonb_build_object(
      'total_outputs', COUNT(*),
      'total_qty', COALESCE(SUM(quantity), 0),
      'approved_count', COUNT(*) FILTER (WHERE qa_status = 'approved'),
      'pending_count', COUNT(*) FILTER (WHERE qa_status = 'pending'),
      'rejected_count', COUNT(*) FILTER (WHERE qa_status = 'rejected')
    )
    FROM license_plates
    WHERE wo_id = p_wo_id AND source = 'production'
  );
END;
$$ LANGUAGE plpgsql;
```

### RLS Policies

```sql
-- license_plates: Org isolation
CREATE POLICY "lps_org_isolation" ON license_plates
FOR ALL USING (org_id = (auth.jwt() ->> 'org_id')::uuid);

-- lp_genealogy: Org isolation
CREATE POLICY "genealogy_org_isolation" ON lp_genealogy
FOR ALL USING (org_id = (auth.jwt() ->> 'org_id')::uuid);
```

### API Endpoints

```
# Output Registration
GET    /api/production/outputs/:woId              - Get output page data (WO, yields, outputs, by-products)
POST   /api/production/outputs                    - Register production output
GET    /api/production/outputs/:woId/export       - Export outputs as CSV

# By-Product Registration
POST   /api/production/outputs/by-products        - Register by-product output
```

### Service Methods

**Location:** `lib/services/output-service.ts`

```typescript
interface OutputService {
  // Page data
  getOutputPageData(woId: string): Promise<OutputPageData>;

  // Output registration
  registerOutput(data: RegisterOutputInput): Promise<RegisterOutputResponse>;

  // By-product registration
  registerByProduct(data: RegisterByProductInput): Promise<RegisterByProductResponse>;

  // Export
  exportOutputsCSV(woId: string): Promise<Blob>;

  // Helpers
  calculateExpiryDate(shelfLifeDays: number, baseDate?: Date): Date;
  generateBatchNumber(wo: WorkOrder, productCode?: string): string;
}

interface OutputPageData {
  wo: WorkOrderSummary;
  yields: YieldData;
  outputs: OutputLP[];
  by_products: ByProduct[];
  settings: ProductionSettings;
}

interface WorkOrderSummary {
  id: string;
  wo_number: string;
  status: string;
  product_id: string;
  product_name: string;
  product_code: string;
  batch_number: string;
  planned_qty: number;
  output_qty: number;
  uom: string;
  progress_percent: number;
  remaining_qty: number;
  default_location_id: string | null;
  default_location_name: string | null;
}

interface YieldData {
  overall_yield: number | null;
  output_yield: number | null;
  material_yield: number | null;
  operation_yield: number | null;
  output_trend: number | null;
  target_yield: number;
}

interface RegisterOutputInput {
  wo_id: string;
  quantity: number;
  uom: string;
  batch_number: string;
  qa_status?: 'approved' | 'pending' | 'rejected';
  location_id: string;
  expiry_date: string;
  notes?: string;
}

interface RegisterOutputResponse {
  lp: LicensePlate;
  genealogy: {
    parent_lps: { lp_id: string; lp_number: string; qty_consumed: number }[];
    child_lp_id: string;
  };
  wo_updated: {
    output_qty: number;
    progress_percent: number;
    status: string;
  };
  by_products?: {
    auto_created: boolean;
    by_products_created: ByProductLP[];
  };
}
```

**Location:** `lib/services/yield-service.ts`

```typescript
interface YieldService {
  // Yield calculations
  calculateOutputYield(outputQty: number, plannedQty: number): number;
  calculateMaterialYield(plannedMaterial: number, actualConsumed: number): number;

  // Yield display
  getYieldColor(yieldPercent: number): 'green' | 'yellow' | 'red';
  getYieldLabel(yieldPercent: number | null): string;
}

// Yield thresholds
const YIELD_THRESHOLDS = {
  green: 95,   // >= 95% green
  yellow: 80,  // >= 80% yellow
  red: 0       // < 80% red
};
```

**Location:** `lib/services/by-product-service.ts`

```typescript
interface ByProductService {
  // Calculations
  calculateExpectedQty(plannedQty: number, yieldPercent: number): number;

  // Registration
  registerByProduct(data: RegisterByProductInput): Promise<RegisterByProductResponse>;

  // Batch number
  generateByProductBatch(mainBatch: string, productCode: string): string;
}

interface RegisterByProductInput {
  wo_id: string;
  main_output_lp_id: string;
  by_product_id: string;
  quantity: number;
  uom: string;
  batch_number: string;
  qa_status?: 'approved' | 'pending' | 'rejected';
  location_id: string;
  expiry_date: string;
  notes?: string;
}
```

### Zod Validation Schemas

**Location:** `lib/validation/output.ts`

```typescript
import { z } from 'zod';

// Register output schema
export const registerOutputSchema = z.object({
  wo_id: z.string().uuid('Invalid work order ID'),
  quantity: z.number().positive('Quantity must be greater than 0'),
  uom: z.string().min(1, 'Unit of measure is required'),
  batch_number: z.string().min(1, 'Batch number is required').max(50),
  qa_status: z.enum(['approved', 'pending', 'rejected']).optional(),
  location_id: z.string().uuid('Invalid location'),
  expiry_date: z.string().refine((val) => !isNaN(Date.parse(val)), {
    message: 'Invalid expiry date'
  }),
  notes: z.string().max(500).optional()
});

// Register by-product schema
export const registerByProductSchema = z.object({
  wo_id: z.string().uuid(),
  main_output_lp_id: z.string().uuid(),
  by_product_id: z.string().uuid(),
  quantity: z.number().min(0, 'Quantity cannot be negative'),
  uom: z.string().min(1),
  batch_number: z.string().min(1).max(50),
  qa_status: z.enum(['approved', 'pending', 'rejected']).optional(),
  location_id: z.string().uuid(),
  expiry_date: z.string(),
  notes: z.string().max(500).optional()
});

// Custom validation for QA status requirement
export const createOutputSchemaWithSettings = (requireQA: boolean) => {
  if (requireQA) {
    return registerOutputSchema.extend({
      qa_status: z.enum(['approved', 'pending', 'rejected'], {
        required_error: 'QA status is required'
      })
    });
  }
  return registerOutputSchema;
};
```

## UI Components

### Pages

- `app/(authenticated)/production/outputs/[woId]/page.tsx` - Output Registration page

### Components

**Location:** `components/production/outputs/`

```
WOSummaryCard.tsx           - WO info, progress bar, batch
YieldSummaryCard.tsx        - Yield metrics with color coding
OutputHistoryTable.tsx      - Outputs list with filters, sorting, actions
ByProductsSection.tsx       - By-products status and registration
RegisterOutputModal.tsx     - Modal form for output registration
RegisterByProductModal.tsx  - Modal form for by-product registration
OutputProgressBar.tsx       - Visual progress indicator
YieldIndicator.tsx          - Color-coded yield display
```

### Component Details

**WOSummaryCard.tsx**
```tsx
interface WOSummaryCardProps {
  wo: WorkOrderSummary;
}

// Displays:
// +------------------------------------------+
// | WO-2025-0156                   In Progress|
// | Product: Wheat Flour 25kg                 |
// | Batch: B-2025-0156                        |
// |                                           |
// | Progress: 750 / 1000 kg (75%)             |
// | [=============================-------]    |
// | Remaining: 250 kg                         |
// +------------------------------------------+
```

**YieldSummaryCard.tsx**
```tsx
interface YieldSummaryCardProps {
  yields: YieldData;
  onViewMaterialConsumption?: () => void;
}

// Displays:
// +------------------------------------------+
// | Yield Summary                             |
// |                                           |
// | Overall    Output     Material   Operation|
// |  92.5%      95.0%      90.9%      96.0%  |
// |   [Y]        [G]        [Y]        [G]   |
// |                                           |
// | Target: 95% | Trend: +2.5% vs last batch |
// +------------------------------------------+
// [G] = green, [Y] = yellow, [R] = red
```

**OutputHistoryTable.tsx**
```tsx
interface OutputHistoryTableProps {
  outputs: OutputLP[];
  summary: OutputSummary;
  onRegisterOutput: () => void;
  onExportCSV: () => void;
  onViewLP: (lpId: string) => void;
  onPrintLabel: (lpId: string) => void;
}

// Columns:
// LP Number | Qty | UoM | Batch | QA Status | Location | Expiry | Created At | Actions
//
// Actions: View LP, Print Label
// Filters: QA Status, Location
// Sorting: All columns
// Export: CSV download
```

**RegisterOutputModal.tsx**
```tsx
interface RegisterOutputModalProps {
  wo: WorkOrderSummary;
  defaultLocation?: Location;
  requireQAStatus: boolean;
  onConfirm: (data: RegisterOutputInput) => Promise<void>;
  onCancel: () => void;
}

// Form fields:
// - Quantity (number input, required)
// - UoM (display only, from product)
// - Batch Number (text, default from WO)
// - QA Status (select: Approved/Pending/Rejected)
// - Location (select dropdown, default from line)
// - Expiry Date (date picker, auto-calculated)
// - Notes (textarea, optional)
```

**ByProductsSection.tsx**
```tsx
interface ByProductsSectionProps {
  byProducts: ByProduct[];
  autoCreateEnabled: boolean;
  onRegisterByProduct: (byProduct: ByProduct) => void;
  onRegisterAll: () => void;
  onViewLPs: (byProductId: string) => void;
}

// Displays table:
// Product Name | Expected | Actual | Status    | Actions
// Wheat Germ   | 50 kg    | 45 kg  | Registered| [View LPs]
// Bran         | 100 kg   | 0 kg   | Pending   | [Register Now]
//
// Footer: [Register All Pending] if auto_create disabled
```

### UI States

| State | Description | Components |
|-------|-------------|------------|
| loading | Skeleton loaders | WOSummaryCard, YieldSummaryCard, OutputHistoryTable |
| empty | No outputs, prompt to register | Empty state illustration, "Register First Output" button |
| error | Error with retry | Error card, retry button, back to WO link |
| success | Full data display | All sections populated with data |

## Test Cases

### Unit Tests

**output-service.test.ts**
```typescript
describe('OutputService', () => {
  describe('registerOutput', () => {
    it('creates LP with source=production and wo_id');
    it('links genealogy to consumed materials');
    it('updates WO output_qty and progress');
    it('validates quantity is positive');
    it('auto-calculates expiry date from shelf life');
  });

  describe('calculateExpiryDate', () => {
    it('adds shelf_life_days to today');
    it('handles leap year correctly');
    it('defaults to 90 days if shelf_life not set');
  });
});
```

**yield-service.test.ts**
```typescript
describe('YieldService', () => {
  describe('calculateOutputYield', () => {
    it('returns percentage rounded to 1 decimal');
    it('handles zero planned qty (returns null)');
    it('handles zero output (returns 0%)');
  });

  describe('getYieldColor', () => {
    it('returns green for >= 95%');
    it('returns yellow for 80-94%');
    it('returns red for < 80%');
  });
});
```

**by-product-service.test.ts**
```typescript
describe('ByProductService', () => {
  describe('calculateExpectedQty', () => {
    it('returns planned_qty * yield_percent / 100');
    it('rounds to appropriate precision');
  });

  describe('generateByProductBatch', () => {
    it('appends -BP-{productCode} to main batch');
    it('handles special characters in product code');
  });
});
```

### Integration Tests

**output-api.test.ts**
```typescript
describe('Output API', () => {
  describe('GET /api/production/outputs/:woId', () => {
    it('returns WO summary, yields, outputs, by-products');
    it('returns 404 for non-existent WO');
    it('returns 403 for other org WO');
    it('calculates yields correctly');
  });

  describe('POST /api/production/outputs', () => {
    it('creates LP with correct fields');
    it('creates genealogy links to consumed materials');
    it('updates WO output_qty');
    it('returns 400 for validation errors');
    it('returns 400 when QA required but missing');
  });

  describe('POST /api/production/outputs/by-products', () => {
    it('creates by-product LP');
    it('links genealogy to main output');
    it('returns 400 for invalid by-product');
  });
});
```

### E2E Tests

**output-registration.spec.ts**
```typescript
describe('Output Registration', () => {
  it('displays WO summary and progress');
  it('shows yield metrics with color indicators');
  it('opens Register Output modal');
  it('validates required fields');
  it('auto-calculates expiry date');
  it('creates output and updates progress');
  it('shows success toast after registration');

  it('displays output history table');
  it('filters outputs by QA status');
  it('sorts outputs by column');
  it('exports outputs to CSV');

  it('shows by-products section');
  it('registers by-product with expected qty');
  it('warns when by-product qty is zero');

  it('blocks access to other org WO');
});
```

## Security Considerations

1. **Authorization**
   - Verify user has access to WO's organization
   - Check role permissions for output registration
   - Validate location belongs to same org

2. **Data Integrity**
   - Validate WO is in 'In Progress' status
   - Prevent duplicate LP numbers
   - Ensure genealogy links are consistent

3. **Audit Trail**
   - Log all output registrations with user, timestamp
   - Track genealogy creation for traceability
   - Record WO progress updates

## Deliverables

- [ ] `calculate_output_yield` DB function
- [ ] `get_wo_output_summary` DB function
- [ ] Output service (`lib/services/output-service.ts`)
- [ ] Yield service (`lib/services/yield-service.ts`)
- [ ] By-product service (`lib/services/by-product-service.ts`)
- [ ] Zod schemas (`lib/validation/output.ts`)
- [ ] API route GET `/api/production/outputs/[woId]`
- [ ] API route POST `/api/production/outputs`
- [ ] API route POST `/api/production/outputs/by-products`
- [ ] API route GET `/api/production/outputs/[woId]/export`
- [ ] WOSummaryCard component
- [ ] YieldSummaryCard component
- [ ] OutputHistoryTable component
- [ ] ByProductsSection component
- [ ] RegisterOutputModal component
- [ ] RegisterByProductModal component
- [ ] Output Registration page
- [ ] Unit tests (>80% coverage)
- [ ] Integration tests
- [ ] E2E tests

## Definition of Done

- [ ] Output registration creates LP with correct metadata
- [ ] LP source='production' and wo_id linked correctly
- [ ] Expiry date auto-calculated from product shelf life
- [ ] Batch number defaults from WO or allows custom
- [ ] QA status validation respects settings
- [ ] Genealogy links created to consumed materials
- [ ] WO output_qty and progress_percent updated
- [ ] Progress bar displays correct percentage
- [ ] Yield calculations display correctly with color coding
- [ ] Output history table shows all registered outputs
- [ ] Filtering and sorting work on output table
- [ ] CSV export downloads correct data
- [ ] By-products section shows expected quantities
- [ ] By-product registration creates LP with genealogy
- [ ] Auto-create by-products works when enabled
- [ ] Multi-tenancy isolation enforced
- [ ] Unit tests pass (>80% coverage)
- [ ] Integration tests pass
- [ ] E2E tests pass
