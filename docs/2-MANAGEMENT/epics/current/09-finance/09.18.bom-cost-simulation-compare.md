# Story 09.18: BOM Cost Simulation & Compare

**Epic:** 09-finance
**Phase:** 2
**Complexity:** M (2-3 days)
**Type:** Frontend
**Story File:** `09.18.bom-cost-simulation-compare.md`

---

## User Story

As a **Product Manager** or **R&D Manager**,
I want to **simulate BOM cost changes and compare BOM versions**,
So that I can **evaluate cost impact of recipe changes before committing** and make informed product decisions.

---

## Business Context

**Problem**: Recipe changes (ingredient substitutions, packaging updates, yield adjustments) impact product cost, but teams lack tools to preview cost impact before implementing changes.

**Value**:
- Enable "what-if" analysis for ingredient substitutions
- Compare cost impact of BOM versions before activation
- Support data-driven recipe optimization decisions
- Reduce unintended cost increases from recipe changes

**Use Cases**:
1. R&D Manager wants to substitute cocoa powder supplier → runs cost simulation with new ingredient cost → sees +8% cost increase → negotiates better pricing before switching
2. Product Manager compares BOM v1.2 (current) vs v2.0 (proposed) → sees cost breakdown by category → decides to phase in v2.0 only for new production orders
3. Finance Analyst simulates 5% yield improvement → sees cost per unit decrease by $0.20 → recommends process optimization investment

---

## Acceptance Criteria

### AC1: BOM Cost Simulation (FR-9.2.3)

**Given** user has BOM open in edit/view mode
**When** clicking "Simulate Cost" button
**Then** system displays simulation modal with:
- Current BOM cost breakdown (material, labor, overhead, total)
- Editable fields for simulation:
  - Material costs (override individual ingredient costs)
  - Labor hours per operation (override standard hours)
  - Overhead rate (override cost center rate)
  - Yield % (override standard yield)
- Simulated cost breakdown (updated in real-time as user changes values)
- Cost delta (amount and %) vs current BOM cost
- "Apply Changes" button (creates new BOM version with simulated costs)

**Validation**:
- Simulation does NOT modify existing BOM or standard_costs
- Cost recalculates instantly (<200ms) on field change
- Simulated values highlighted in yellow background
- Delta displayed with color coding (red for increase, green for decrease)

---

### AC2: BOM Version Cost Comparison (FR-9.2.4)

**Given** product has multiple BOM versions (v1.0, v1.1, v2.0)
**When** user navigates to `/technical/boms/:id/compare`
**Then** system displays side-by-side comparison:
- BOM metadata (version, effective date, status)
- Material costs (item-by-item comparison with qty and unit cost)
- Labor costs (operation-by-operation comparison)
- Overhead costs (cost center allocation)
- Total cost summary
- Cost delta between versions (absolute and %)
- Visual indicators (new items in green, removed items in red, changed items in yellow)

**Given** user selects 2+ BOM versions (checkbox selection)
**When** clicking "Compare Costs" button
**Then** comparison table opens with selected versions

**Validation**:
- Compare up to 4 BOM versions simultaneously
- Cost breakdown shows line-item changes
- Export comparison to CSV/Excel available
- Responsive layout for 2-4 columns

---

### AC3: Cost Impact Preview

**Given** user is creating/editing a BOM
**When** adding/modifying BOM items
**Then** system displays real-time cost impact preview:
- Previous total cost (before change)
- New total cost (after change)
- Delta (amount and %)
- Tooltip explaining which items changed

**Validation**:
- Cost preview updates without saving BOM
- Preview visible in sidebar or sticky footer
- Clear visual distinction between saved and unsaved state

---

### AC4: What-If Ingredient Substitution

**Given** BOM has ingredient A (sunflower oil @ $3.50/kg)
**When** user simulates substitution with ingredient B (canola oil @ $2.80/kg)
**Then** system:
- Shows cost impact: -$0.70/kg on this ingredient
- Recalculates total BOM cost
- Displays allergen changes (if applicable)
- Allows "Save as New BOM Version" with substitution applied

**Validation**:
- Substitution simulation does not modify original BOM
- Allergen warnings displayed if new ingredient has different allergens
- User can simulate multiple substitutions before saving

---

## Technical Design

### API Endpoints

```typescript
// Simulate BOM cost with overrides
POST /api/finance/bom-costs/:bomId/simulate
Body: {
  material_overrides?: { bom_item_id: string, unit_cost: number }[];
  labor_overrides?: { operation_id: string, standard_hours: number }[];
  overhead_rate_override?: number;
  yield_override?: number;
}
Response: {
  current_cost: { material, labor, overhead, total };
  simulated_cost: { material, labor, overhead, total };
  delta: { amount, percent };
  breakdown: { item_id, item_name, current_cost, simulated_cost }[];
}

// Compare BOM versions
GET /api/finance/bom-costs/compare
Query: {
  bom_ids: string[]; // Array of BOM IDs to compare
}
Response: {
  versions: {
    bom_id: string;
    version: string;
    effective_date: string;
    status: string;
    cost_breakdown: {
      materials: { item_id, name, qty, unit_cost, total_cost }[];
      labor: { operation_id, name, hours, hourly_rate, total_cost }[];
      overhead: { cost_center, allocation_basis, rate, total_cost }[];
      totals: { material, labor, overhead, grand_total };
    };
  }[];
  comparison: {
    item_id: string;
    item_name: string;
    change_type: 'added' | 'removed' | 'modified' | 'unchanged';
    costs_by_version: { bom_id, cost }[];
  }[];
}

// Get cost impact preview (real-time)
POST /api/finance/bom-costs/preview
Body: {
  bom_items: { product_id, quantity, uom }[];
  routing_operations?: { operation_id, standard_hours }[];
  cost_center_id?: string;
}
Response: {
  material_cost: number;
  labor_cost: number;
  overhead_cost: number;
  total_cost: number;
}
```

### Service: BOMCostSimulationService

```typescript
// apps/frontend/lib/services/bom-cost-simulation-service.ts
export class BOMCostSimulationService {
  // Simulate BOM cost with overrides
  static async simulateBOMCost(
    bomId: string,
    overrides: SimulationOverrides
  ): Promise<CostSimulationResult> {
    // Fetch current BOM with standard costs
    // Apply overrides to material costs, labor hours, overhead rate, yield
    // Recalculate total cost with overrides
    // Calculate delta vs current cost
    // Return comparison breakdown
  }

  // Compare multiple BOM versions
  static async compareBOMVersions(bomIds: string[]): Promise<BOMVersionComparison> {
    // Fetch all BOM versions with cost breakdowns
    // Align items across versions (handle added/removed items)
    // Calculate cost deltas between versions
    // Identify change type per item (added, removed, modified)
    // Return side-by-side comparison data
  }

  // Get real-time cost preview (no save)
  static async previewBOMCost(bomItems: BOMItem[], operations?: Operation[]): Promise<CostPreview> {
    // Calculate cost based on current standard costs
    // Use yield adjustment if provided
    // Return cost breakdown without saving
  }

  // Create new BOM version from simulation
  static async applySimulation(
    bomId: string,
    simulationResult: CostSimulationResult,
    newVersion: string
  ): Promise<BOM> {
    // Clone BOM as new version
    // Apply simulated costs as new standard costs
    // Set effective_from date
    // Return new BOM version
  }
}
```

---

## Frontend Components

### BOMCostSimulationModal
```tsx
// apps/frontend/components/finance/bom/BOMCostSimulationModal.tsx
export function BOMCostSimulationModal({ bomId, open, onClose }: Props) {
  const { data: currentCost } = useBOMCost(bomId);
  const [overrides, setOverrides] = useState<SimulationOverrides>({});
  const { data: simulation, mutate } = useBOMCostSimulation(bomId, overrides);

  const handleOverrideChange = (field: string, value: number) => {
    setOverrides({ ...overrides, [field]: value });
    mutate(); // Trigger real-time recalculation
  };

  return (
    <Dialog open={open} onOpenChange={onClose}>
      <DialogContent className="max-w-4xl">
        <DialogHeader>
          <DialogTitle>BOM Cost Simulation</DialogTitle>
        </DialogHeader>

        <div className="grid grid-cols-2 gap-6">
          {/* Current Cost (read-only) */}
          <Card>
            <CardHeader><CardTitle>Current Cost</CardTitle></CardHeader>
            <CardContent>
              <CostBreakdown cost={currentCost} />
            </CardContent>
          </Card>

          {/* Simulated Cost (with overrides) */}
          <Card>
            <CardHeader><CardTitle>Simulated Cost</CardTitle></CardHeader>
            <CardContent>
              <div className="space-y-4">
                <Label>Material Cost Overrides</Label>
                {currentCost?.materials.map(item => (
                  <div key={item.id} className="flex items-center gap-2">
                    <span>{item.name}</span>
                    <Input
                      type="number"
                      placeholder={item.unit_cost.toString()}
                      onChange={(e) => handleMaterialOverride(item.id, parseFloat(e.target.value))}
                      className="bg-yellow-50"
                    />
                  </div>
                ))}

                <Label>Yield Override (%)</Label>
                <Input
                  type="number"
                  placeholder="100"
                  onChange={(e) => handleOverrideChange('yield', parseFloat(e.target.value))}
                  className="bg-yellow-50"
                />

                <CostBreakdown cost={simulation?.simulated_cost} highlighted />
              </div>
            </CardContent>
          </Card>
        </div>

        {/* Cost Delta */}
        <Card className="border-2">
          <CardContent className="pt-6">
            <div className="flex items-center justify-between">
              <span className="text-lg font-semibold">Cost Delta</span>
              <Badge variant={simulation?.delta.amount > 0 ? 'destructive' : 'success'} className="text-lg">
                {formatCurrency(simulation?.delta.amount)} ({simulation?.delta.percent.toFixed(2)}%)
              </Badge>
            </div>
          </CardContent>
        </Card>

        <DialogFooter>
          <Button variant="outline" onClick={onClose}>Cancel</Button>
          <Button onClick={() => applyCostSimulation(simulation)}>Apply as New BOM Version</Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}
```

### BOMVersionComparisonPage
```tsx
// apps/frontend/app/(authenticated)/finance/bom-costs/compare/page.tsx
export default function BOMVersionComparisonPage() {
  const searchParams = useSearchParams();
  const bomIds = searchParams.getAll('bomId'); // ?bomId=uuid1&bomId=uuid2

  const { data: comparison, isLoading } = useBOMVersionComparison(bomIds);

  return (
    <div className="space-y-6">
      <PageHeader title="BOM Cost Comparison" />

      <Card>
        <CardContent>
          <BOMVersionSelector selectedIds={bomIds} />
        </CardContent>
      </Card>

      {isLoading ? (
        <Skeleton className="h-96" />
      ) : (
        <BOMComparisonTable data={comparison} />
      )}
    </div>
  );
}
```

### BOMComparisonTable
```tsx
// apps/frontend/components/finance/bom/BOMComparisonTable.tsx
export function BOMComparisonTable({ data }: Props) {
  return (
    <Table>
      <TableHeader>
        <TableRow>
          <TableHead>Item</TableHead>
          {data.versions.map(v => (
            <TableHead key={v.bom_id}>
              {v.version} <br />
              <span className="text-xs text-muted-foreground">{formatDate(v.effective_date)}</span>
            </TableHead>
          ))}
          <TableHead>Change</TableHead>
        </TableRow>
      </TableHeader>
      <TableBody>
        {data.comparison.map(item => (
          <TableRow key={item.item_id} className={getRowClassName(item.change_type)}>
            <TableCell>{item.item_name}</TableCell>
            {item.costs_by_version.map(cost => (
              <TableCell key={cost.bom_id}>{formatCurrency(cost.cost)}</TableCell>
            ))}
            <TableCell>
              <Badge variant={getBadgeVariant(item.change_type)}>
                {item.change_type}
              </Badge>
            </TableCell>
          </TableRow>
        ))}

        {/* Totals Row */}
        <TableRow className="font-bold border-t-2">
          <TableCell>Total Cost</TableCell>
          {data.versions.map(v => (
            <TableCell key={v.bom_id}>{formatCurrency(v.cost_breakdown.totals.grand_total)}</TableCell>
          ))}
          <TableCell>
            <Badge variant="outline">
              {calculateVersionDelta(data.versions)}
            </Badge>
          </TableCell>
        </TableRow>
      </TableBody>
    </Table>
  );
}

function getRowClassName(changeType: ChangeType): string {
  switch (changeType) {
    case 'added': return 'bg-green-50';
    case 'removed': return 'bg-red-50';
    case 'modified': return 'bg-yellow-50';
    default: return '';
  }
}
```

### CostImpactPreviewCard
```tsx
// apps/frontend/components/finance/bom/CostImpactPreviewCard.tsx
export function CostImpactPreviewCard({ bomItems }: Props) {
  const { data: preview } = useBOMCostPreview(bomItems);

  return (
    <Card className="sticky bottom-4">
      <CardHeader>
        <CardTitle className="text-sm">Cost Impact Preview</CardTitle>
      </CardHeader>
      <CardContent>
        <div className="space-y-2 text-sm">
          <div className="flex justify-between">
            <span>Material Cost:</span>
            <span>{formatCurrency(preview?.material_cost)}</span>
          </div>
          <div className="flex justify-between">
            <span>Labor Cost:</span>
            <span>{formatCurrency(preview?.labor_cost)}</span>
          </div>
          <div className="flex justify-between">
            <span>Overhead Cost:</span>
            <span>{formatCurrency(preview?.overhead_cost)}</span>
          </div>
          <Separator />
          <div className="flex justify-between font-bold">
            <span>Total Cost:</span>
            <span>{formatCurrency(preview?.total_cost)}</span>
          </div>
        </div>
      </CardContent>
    </Card>
  );
}
```

---

## Dependencies

### Required Stories
- **02.4** - BOM Management (BOM structure and versioning)
- **09.2** - Standard Cost Definition (standard costs for calculation)
- **09.5** - BOM Costing (base BOM cost calculation logic)

---

## Testing Requirements

### Unit Tests
- Cost simulation calculation accuracy with overrides
- BOM version comparison alignment (added/removed items)
- Delta calculation correctness
- Real-time preview update logic

### Integration Tests
- Simulate cost → apply as new BOM version → verify new BOM created
- Compare 2-4 BOM versions → verify cost breakdown matches
- Cost preview updates on BOM item changes

### E2E Tests
1. **Cost simulation workflow**:
   - Open BOM detail page
   - Click "Simulate Cost"
   - Override material cost for 2 ingredients
   - Verify delta calculation
   - Apply simulation as BOM v2.0
   - Verify new BOM version created

2. **BOM version comparison**:
   - Navigate to BOM comparison page
   - Select BOM v1.0, v1.2, v2.0
   - Verify side-by-side cost breakdown
   - Export comparison to CSV
   - Verify CSV contains all versions

---

## Performance Requirements

- Cost simulation recalculation: <200ms
- BOM version comparison query: <1 second (4 versions)
- Cost preview update: <100ms
- Export comparison to CSV: <2 seconds

---

## Security & Permissions

### Roles
- **product_manager**: View simulation, compare versions
- **r_and_d**: View simulation, compare versions, create new BOM versions
- **finance_manager**: Full access
- **admin**: Full access

---

## UX/UI Specifications

### BOM Cost Simulation Modal Layout
```
┌──────────────────────────────────────────────────────────┐
│  BOM Cost Simulation - Chocolate Bar v1.2              │
├─────────────────────┬────────────────────────────────────┤
│  Current Cost       │  Simulated Cost                    │
│  ───────────────    │  ────────────────────────────      │
│  Material:  $2.50   │  Material:  $2.35 (override)       │
│  Labor:     $0.40   │  Labor:     $0.38 (yield adj)      │
│  Overhead:  $0.60   │  Overhead:  $0.57                  │
│  ───────────────    │  ────────────────────────────      │
│  Total:     $3.50   │  Total:     $3.30                  │
└─────────────────────┴────────────────────────────────────┘
│  Cost Delta: -$0.20 (-5.71%) ✅                         │
├──────────────────────────────────────────────────────────┤
│  [Cancel]                   [Apply as New BOM Version]  │
└──────────────────────────────────────────────────────────┘
```

### BOM Version Comparison Table
```
┌────────────┬──────────┬──────────┬──────────┬─────────┐
│ Item       │ v1.0     │ v1.2     │ v2.0     │ Change  │
├────────────┼──────────┼──────────┼──────────┼─────────┤
│ Cocoa      │ $1.20    │ $1.20    │ $1.10    │ Modified│
│ Sugar      │ $0.50    │ $0.50    │ $0.50    │ -       │
│ Milk       │ $0.80    │ $0.75    │ -        │ Removed │
│ Almond Milk│ -        │ -        │ $0.70    │ Added   │
├────────────┼──────────┼──────────┼──────────┼─────────┤
│ Total Cost │ $3.50    │ $3.45    │ $3.30    │ -5.71%  │
└────────────┴──────────┴──────────┴──────────┴─────────┘
```

---

## Documentation Requirements

- API endpoint documentation (simulation, comparison)
- Cost simulation user guide with examples
- BOM version comparison workflow
- Best practices for recipe cost optimization

---

## Future Enhancements (Out of Scope)

- Batch simulation (simulate multiple BOMs at once)
- Scenario management (save/load simulation scenarios)
- Cost sensitivity analysis (tornado charts)
- Integration with supplier pricing APIs
- Automated cost optimization suggestions (ML-based)

---

## Story Metadata

**Estimated Effort:** 2-3 days
**Story Points:** 5
**Priority:** P1 (Phase 2)
**FR Coverage:** FR-9.2.3, FR-9.2.4
**Related Stories:** 09.5 (BOM Costing), 02.4 (BOM Management)
