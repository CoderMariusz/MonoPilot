# Story 09.25: Variance Root Cause & Approval

**Epic:** 09-finance
**Phase:** 3
**Complexity:** M (3-4 days)
**Type:** Full-stack
**Story File:** `09.25.variance-root-cause-approval.md`

---

## User Story

As a **Finance Manager** or **Cost Accountant**,
I want to **categorize variance root causes, approve significant variances, and document corrective actions**,
So that I can **understand why variances occur, ensure accountability, and prevent recurrence**.

---

## Business Context

**Problem**: Variances are identified but root causes unknown, leading to repeated issues. No accountability for cost overruns.

**Value**:
- Root cause analysis drives continuous improvement
- Approval workflow ensures variances reviewed and understood
- Historical root cause data reveals systemic issues
- Corrective action tracking prevents recurrence
- Variance trend analysis by root cause supports proactive management

**Use Cases**:
1. Cost Accountant reviews $5K material variance → categorizes as "Supplier Price Increase" → documents supplier changed pricing → recommends renegotiation → Finance Manager approves variance
2. Production Manager investigates labor variance → identifies root cause "Equipment Downtime" → documents 4 hours unplanned maintenance → creates corrective action "Schedule preventive maintenance" → submits for approval
3. Finance Manager reviews variances requiring approval → sees 3 variances due to "Quality Issues" → escalates to Quality Manager → implements process improvements
4. CFO analyzes variance trends → sees "Overtime" as top root cause (30% of labor variances) → implements hiring plan to reduce overtime dependency

---

## Acceptance Criteria

### AC1: Variance Root Cause Categorization (FR-9.4.7)

**Given** cost variance exists (from 09.13, 09.14, 09.15)
**When** user categorizes variance root cause
**Then** the system allows:
- Select root cause category (dropdown):
  - **Material Variances**:
    - Supplier Price Increase
    - Supplier Price Decrease
    - Material Quality Issues
    - Incorrect BOM Quantity
    - Material Waste/Spillage
    - Inventory Shrinkage
    - Purchasing Error
  - **Labor Variances**:
    - Equipment Downtime
    - Operator Training/Skill Gap
    - Process Inefficiency
    - Overtime (Planned)
    - Overtime (Unplanned)
    - Higher-Paid Worker Substitution
    - Rework/Quality Issues
  - **Overhead Variances**:
    - Utility Cost Increase
    - Maintenance Overrun
    - Facility Cost Increase
    - Overhead Allocation Error
  - **General**:
    - Yield Loss
    - Seasonal Variation
    - One-Time Event
    - Data Entry Error
    - Other (require notes)
- Enter detailed notes (free text, min 20 characters)
- Attach supporting documents (PDF, Excel, images)
- Assign responsibility (user or department)
- Define corrective action (what will be done to prevent recurrence)
- Set target resolution date

**Validation**:
- Root cause category required for variances >$500 or >5%
- Notes required if category = "Other"
- Corrective action required for critical variances (>10% or >$5K)
- Root cause cannot be changed after variance approved (audit trail)

---

### AC2: Variance Approval Workflow (FR-9.4.8, FR-9.1.8)

**Given** variance exceeds approval threshold
**When** variance submitted for approval
**Then** the system:
- **Approval Thresholds** (configurable):
  - <$1,000 or <5%: Auto-approved (no workflow)
  - $1,000-$5,000 or 5-10%: Cost Accountant approval
  - >$5,000 or >10%: Finance Manager approval
  - >$10,000 or >20%: CFO approval
- **Workflow Steps**:
  1. Variance identified (automatically or manually)
  2. Root cause entered (required for approval)
  3. Submitted for approval (status = "Pending Approval")
  4. Approver notified (email + in-app)
  5. Approver reviews:
     - Variance details (amount, %, category)
     - Root cause explanation
     - Corrective actions planned
     - Historical context (similar past variances)
  6. Approver actions:
     - **Approve**: Status = "Approved" (final)
     - **Reject**: Status = "Rejected", requires rejection reason
     - **Request More Info**: Returns to submitter with questions
  7. Audit log records approval chain

**Validation**:
- Only users with approver role can approve variances in their threshold
- Variance cannot be edited while "Pending Approval"
- Rejection reason required (min 20 characters)
- Approval/rejection timestamp recorded
- Submitter notified of all status changes

---

### AC3: Significant Variance Threshold (FR-9.4.8)

**Given** organization defines variance thresholds
**When** configuring variance approval settings
**Then** the system allows:
- Set thresholds by:
  - **Amount**: Dollar value (e.g., >$5,000)
  - **Percentage**: % of standard/budget (e.g., >10%)
  - **Category**: Material, Labor, Overhead (different thresholds per category)
- Threshold logic: Triggered if **amount OR percentage** exceeds threshold
- Multiple approval tiers (e.g., $1K-$5K, $5K-$10K, >$10K)
- Exceptions: Certain products or cost centers exempt from approval
- Notification: Alert submitter when variance requires approval

**Example**:
```
Material Variance Thresholds:
- >$1,000 OR >5%: Cost Accountant approval
- >$5,000 OR >10%: Finance Manager approval

Labor Variance Thresholds:
- >$2,000 OR >10%: Cost Accountant approval
- >$10,000 OR >15%: Finance Manager approval
```

**Validation**:
- Thresholds configurable per organization
- Default thresholds provided (can be customized)
- Thresholds applied consistently across all variance types
- System validates: Higher tier threshold > lower tier threshold

---

### AC4: Corrective Action Tracking

**Given** variance has identified root cause
**When** defining corrective action
**Then** the system allows:
- **Action Description**: What will be done to prevent recurrence
- **Action Type**:
  - Process Change
  - Training
  - Equipment Repair/Upgrade
  - Supplier Negotiation
  - BOM Update
  - Standard Cost Revision
  - Policy Update
  - Other
- **Assignee**: User responsible for implementing action
- **Target Date**: When action should be completed
- **Status**: Planned, In Progress, Completed, Cancelled
- **Completion Notes**: What was actually done
- **Effectiveness**: Did action prevent recurrence? (Yes/No/TBD)

**Tracking**:
- Corrective actions appear on user's task list
- Overdue actions highlighted on finance dashboard
- Completion triggers notification to variance submitter
- Link corrective action to future variances (to track effectiveness)

**Validation**:
- Corrective action required for variances >$5K or >10%
- Target date must be in future
- Assignee must have appropriate role
- Effectiveness evaluation required 30 days after completion

---

### AC5: Variance Root Cause Reporting

**Given** variances have categorized root causes
**When** user views root cause analysis report
**Then** the system displays:
- **Root Cause Summary**:
  - Count of variances by root cause category
  - Total variance amount by root cause
  - % of total variances by root cause
- **Pareto Chart**: Top 10 root causes (80/20 rule visualization)
- **Trend Analysis**: Root cause frequency over time
- **By Category**: Material, Labor, Overhead root causes separately
- **Filters**: Date range, product, production line, cost center
- **Drill-down**: Click root cause → view individual variances

**Example Table**:
```
Root Cause                    | Count | Total Amount | % of Total | Avg Amount
------------------------------|-------|--------------|------------|------------
Equipment Downtime            | 15    | $45,000      | 28%        | $3,000
Supplier Price Increase       | 12    | $38,000      | 23%        | $3,167
Operator Training Gap         | 10    | $25,000      | 15%        | $2,500
Material Quality Issues       | 8     | $20,000      | 12%        | $2,500
...
```

**Validation**:
- Report aggregates cost_variances table grouped by root_cause_category
- Pareto chart orders root causes by total variance amount (descending)
- Trend chart shows counts or amounts over time (user selectable)
- Export to Excel/PDF supported

---

### AC6: Variance Approval Dashboard

**Given** user has finance_manager or cost_accountant role
**When** viewing variance approval dashboard
**Then** the system displays:
- **Pending Approvals** (my approvals):
  - Variance ID, WO number, product
  - Variance amount, %
  - Root cause category
  - Submitted by, submitted date
  - Days pending
  - Action buttons: Approve, Reject, Request Info
- **Recently Approved/Rejected** (last 30 days)
- **Approval Statistics**:
  - Total variances approved this month
  - Total variance amount approved
  - Avg approval turnaround time
  - Rejection rate
- **Alerts**: Variances pending >7 days (highlighted)

**Interactivity**:
- Click variance → open detailed variance modal
- Bulk approve: Select multiple variances → approve all at once (if same approver)
- Filter by: Status, date range, variance type, submitter
- Sort by: Amount, %, pending days

**Validation**:
- Dashboard shows only variances user is authorized to approve
- Real-time updates (WebSocket or polling every 30 seconds)
- Bulk approval requires confirmation dialog
- Approval comments optional but recommended

---

## Technical Design

### Database Schema Enhancements

#### cost_variances (enhanced from 09.13)
```sql
-- Add to existing cost_variances table
ALTER TABLE cost_variances
  ADD COLUMN root_cause_category VARCHAR(100),
  ADD COLUMN root_cause_notes TEXT,
  ADD COLUMN root_cause_documented_by UUID REFERENCES users(id),
  ADD COLUMN root_cause_documented_at TIMESTAMPTZ,
  ADD COLUMN corrective_action TEXT,
  ADD COLUMN corrective_action_type VARCHAR(50),
  ADD COLUMN assigned_to UUID REFERENCES users(id),
  ADD COLUMN target_resolution_date DATE,
  ADD COLUMN corrective_action_status VARCHAR(20) DEFAULT 'planned', -- planned, in_progress, completed, cancelled
  ADD COLUMN completed_at TIMESTAMPTZ,
  ADD COLUMN completion_notes TEXT,
  ADD COLUMN action_effective BOOLEAN, -- Did action prevent recurrence?
  ADD COLUMN approval_required BOOLEAN DEFAULT FALSE,
  ADD COLUMN approval_threshold_amount NUMERIC(15,2),
  ADD COLUMN approval_threshold_percent NUMERIC(5,2),
  ADD COLUMN approved_by UUID REFERENCES users(id),
  ADD COLUMN approved_at TIMESTAMPTZ,
  ADD COLUMN approval_notes TEXT,
  ADD COLUMN rejection_reason TEXT;

CREATE INDEX idx_cost_variances_root_cause ON cost_variances(org_id, root_cause_category);
CREATE INDEX idx_cost_variances_status ON cost_variances(org_id, status);
CREATE INDEX idx_cost_variances_assigned ON cost_variances(assigned_to);
```

#### variance_approval_thresholds
```sql
CREATE TABLE variance_approval_thresholds (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  org_id UUID NOT NULL REFERENCES organizations(id),

  variance_category VARCHAR(50) NOT NULL, -- 'material', 'labor', 'overhead', 'total'

  tier_name VARCHAR(50) NOT NULL, -- 'Small', 'Medium', 'Large'
  amount_threshold NUMERIC(15,2), -- NULL = no amount threshold
  percent_threshold NUMERIC(5,2), -- NULL = no percent threshold

  approver_role VARCHAR(50) NOT NULL, -- 'cost_accountant', 'finance_manager', 'cfo'

  is_active BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),

  CONSTRAINT unique_threshold UNIQUE (org_id, variance_category, tier_name)
);

CREATE INDEX idx_variance_thresholds_org ON variance_approval_thresholds(org_id);

-- RLS
ALTER TABLE variance_approval_thresholds ENABLE ROW LEVEL SECURITY;
CREATE POLICY variance_thresholds_org_isolation ON variance_approval_thresholds FOR ALL USING (org_id = current_setting('app.org_id')::UUID);
```

#### variance_attachments
```sql
CREATE TABLE variance_attachments (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  org_id UUID NOT NULL REFERENCES organizations(id),
  variance_id UUID NOT NULL REFERENCES cost_variances(id) ON DELETE CASCADE,

  file_name VARCHAR(255) NOT NULL,
  file_path TEXT NOT NULL, -- Supabase Storage path
  file_type VARCHAR(50), -- 'pdf', 'xlsx', 'image/jpeg'
  file_size_bytes BIGINT,

  uploaded_by UUID REFERENCES users(id),
  uploaded_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_variance_attachments_variance ON variance_attachments(variance_id);

-- RLS
ALTER TABLE variance_attachments ENABLE ROW LEVEL SECURITY;
CREATE POLICY variance_attachments_org_isolation ON variance_attachments FOR ALL USING (org_id = current_setting('app.org_id')::UUID);
```

### API Endpoints

```typescript
// Categorize Variance Root Cause
PATCH /api/finance/variances/:id/root-cause
Body: {
  root_cause_category: string;
  root_cause_notes: string;
  corrective_action?: string;
  corrective_action_type?: string;
  assigned_to?: string;
  target_resolution_date?: ISO date;
}
Response: { updated variance }

// Submit Variance for Approval
POST /api/finance/variances/:id/submit-for-approval
Response: { updated variance, required_approver_role }

// Approve/Reject Variance
POST /api/finance/variances/:id/approve
Body: { approval_notes?: string }
Response: { updated variance }

POST /api/finance/variances/:id/reject
Body: { rejection_reason: string }
Response: { updated variance }

POST /api/finance/variances/:id/request-info
Body: { questions: string }
Response: { updated variance }

// Corrective Action Update
PATCH /api/finance/variances/:id/corrective-action
Body: {
  corrective_action_status: 'in_progress' | 'completed' | 'cancelled';
  completion_notes?: string;
  action_effective?: boolean;
}
Response: { updated variance }

// Variance Approval Dashboard
GET /api/finance/variances/pending-approvals
Query Params:
  - approverRole?: string (filter by role)
Response: {
  pending: Variance[];
  recently_approved: Variance[];
  statistics: { total_approved, total_amount, avg_turnaround_days, rejection_rate };
}

// Root Cause Analysis Report
GET /api/finance/reports/variance-root-causes
Query Params:
  - dateFrom, dateTo
  - varianceCategory?: 'material' | 'labor' | 'overhead'
Response: {
  root_causes: {
    category: string;
    count: number;
    total_amount: number;
    percent_of_total: number;
    avg_amount: number;
  }[];
  trend: { date: ISO date, root_cause, count, amount }[];
}

// Variance Approval Thresholds (Admin)
GET /api/finance/settings/variance-approval-thresholds
POST /api/finance/settings/variance-approval-thresholds
PATCH /api/finance/settings/variance-approval-thresholds/:id
```

### Service: VarianceApprovalService

```typescript
// apps/frontend/lib/services/variance-approval-service.ts
export class VarianceApprovalService {
  // Categorize variance root cause
  static async categorizeRootCause(
    varianceId: string,
    rootCauseData: RootCauseInput
  ): Promise<Variance> {
    // Update variance with root cause
    // Check if approval required based on thresholds
    // If approval required, submit for approval
  }

  // Submit for approval
  static async submitForApproval(varianceId: string): Promise<Variance> {
    // Determine required approver based on thresholds
    // Update status to pending_approval
    // Notify approver
  }

  // Approve variance
  static async approveVariance(
    varianceId: string,
    approverId: string,
    notes?: string
  ): Promise<Variance> {
    // Validate approver role
    // Update variance status to approved
    // Record approval timestamp and approver
    // Notify submitter
  }

  // Reject variance
  static async rejectVariance(
    varianceId: string,
    approverId: string,
    reason: string
  ): Promise<Variance> {
    // Update variance status to rejected
    // Record rejection reason
    // Notify submitter
  }

  // Get pending approvals for user
  static async getPendingApprovals(userId: string): Promise<Variance[]> {
    // Get user's roles
    // Query variances requiring approval for those roles
    // Filter by approval thresholds
  }

  // Get root cause analysis
  static async getRootCauseAnalysis(
    filters: ReportFilters
  ): Promise<RootCauseReport> {
    // Aggregate variances by root_cause_category
    // Calculate counts, amounts, percentages
    // Generate Pareto data (sorted by amount)
  }

  // Update corrective action
  static async updateCorrectiveAction(
    varianceId: string,
    actionUpdate: CorrectiveActionUpdate
  ): Promise<Variance> {
    // Update corrective action status
    // If completed, record completion notes
    // Notify assigned user
  }
}
```

---

## Frontend Components

### VarianceRootCauseModal
```tsx
// apps/frontend/components/finance/variance/VarianceRootCauseModal.tsx
export function VarianceRootCauseModal({ variance, open, onClose }: Props) {
  const [rootCauseData, setRootCauseData] = useState<RootCauseInput>({
    root_cause_category: '',
    root_cause_notes: '',
    corrective_action: '',
  });

  const handleSave = async () => {
    await VarianceApprovalService.categorizeRootCause(variance.id, rootCauseData);
    toast.success('Root cause documented');
    onClose();
  };

  const rootCauseOptions = {
    material: [
      'Supplier Price Increase',
      'Supplier Price Decrease',
      'Material Quality Issues',
      'Incorrect BOM Quantity',
      'Material Waste/Spillage',
      'Inventory Shrinkage',
      'Purchasing Error',
      'Other'
    ],
    labor: [
      'Equipment Downtime',
      'Operator Training/Skill Gap',
      'Process Inefficiency',
      'Overtime (Planned)',
      'Overtime (Unplanned)',
      'Higher-Paid Worker Substitution',
      'Rework/Quality Issues',
      'Other'
    ],
    overhead: [
      'Utility Cost Increase',
      'Maintenance Overrun',
      'Facility Cost Increase',
      'Overhead Allocation Error',
      'Other'
    ]
  };

  return (
    <Dialog open={open} onOpenChange={onClose}>
      <DialogContent>
        <DialogHeader>
          <DialogTitle>Document Variance Root Cause</DialogTitle>
          <DialogDescription>
            Variance: {formatCurrency(variance.variance_amount)} ({variance.variance_percent}%)
          </DialogDescription>
        </DialogHeader>

        <div className="space-y-4">
          <div>
            <Label>Root Cause Category</Label>
            <Select
              value={rootCauseData.root_cause_category}
              onValueChange={(val) => setRootCauseData({ ...rootCauseData, root_cause_category: val })}
            >
              <SelectTrigger><SelectValue placeholder="Select root cause" /></SelectTrigger>
              <SelectContent>
                <SelectGroup label="Material Variances">
                  {rootCauseOptions.material.map(cause => (
                    <SelectItem key={cause} value={cause}>{cause}</SelectItem>
                  ))}
                </SelectGroup>
                <SelectGroup label="Labor Variances">
                  {rootCauseOptions.labor.map(cause => (
                    <SelectItem key={cause} value={cause}>{cause}</SelectItem>
                  ))}
                </SelectGroup>
                <SelectGroup label="Overhead Variances">
                  {rootCauseOptions.overhead.map(cause => (
                    <SelectItem key={cause} value={cause}>{cause}</SelectItem>
                  ))}
                </SelectGroup>
              </SelectContent>
            </Select>
          </div>

          <div>
            <Label>Root Cause Notes (min 20 characters)</Label>
            <Textarea
              value={rootCauseData.root_cause_notes}
              onChange={(e) => setRootCauseData({ ...rootCauseData, root_cause_notes: e.target.value })}
              placeholder="Describe the root cause in detail..."
              rows={4}
            />
          </div>

          <div>
            <Label>Corrective Action</Label>
            <Textarea
              value={rootCauseData.corrective_action}
              onChange={(e) => setRootCauseData({ ...rootCauseData, corrective_action: e.target.value })}
              placeholder="What will be done to prevent recurrence?"
              rows={3}
            />
          </div>

          <div className="grid grid-cols-2 gap-4">
            <div>
              <Label>Assign To</Label>
              <UserSelect
                value={rootCauseData.assigned_to}
                onChange={(userId) => setRootCauseData({ ...rootCauseData, assigned_to: userId })}
              />
            </div>
            <div>
              <Label>Target Date</Label>
              <DatePicker
                value={rootCauseData.target_resolution_date}
                onChange={(date) => setRootCauseData({ ...rootCauseData, target_resolution_date: date })}
              />
            </div>
          </div>
        </div>

        <DialogFooter>
          <Button variant="outline" onClick={onClose}>Cancel</Button>
          <Button onClick={handleSave} disabled={!rootCauseData.root_cause_category || rootCauseData.root_cause_notes.length < 20}>
            Save & Submit for Approval
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}
```

### VarianceApprovalDashboard
```tsx
// apps/frontend/app/(authenticated)/finance/variances/approvals/page.tsx
export default function VarianceApprovalDashboard() {
  const { data, isLoading } = usePendingApprovals();

  const handleApprove = async (varianceId: string, notes: string) => {
    await VarianceApprovalService.approveVariance(varianceId, userId, notes);
    toast.success('Variance approved');
  };

  const handleReject = async (varianceId: string, reason: string) => {
    await VarianceApprovalService.rejectVariance(varianceId, userId, reason);
    toast.success('Variance rejected');
  };

  return (
    <div className="space-y-6">
      <PageHeader title="Variance Approvals" />

      <div className="grid grid-cols-4 gap-4">
        <Card>
          <CardHeader className="pb-2">
            <CardTitle className="text-sm font-medium">Pending Approvals</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{data?.pending.length || 0}</div>
          </CardContent>
        </Card>
        <Card>
          <CardHeader className="pb-2">
            <CardTitle className="text-sm font-medium">Total Amount</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">
              {formatCurrency(data?.pending.reduce((sum, v) => sum + v.variance_amount, 0) || 0)}
            </div>
          </CardContent>
        </Card>
        <Card>
          <CardHeader className="pb-2">
            <CardTitle className="text-sm font-medium">Approved This Month</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{data?.statistics.total_approved || 0}</div>
          </CardContent>
        </Card>
        <Card>
          <CardHeader className="pb-2">
            <CardTitle className="text-sm font-medium">Avg Turnaround</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{data?.statistics.avg_turnaround_days || 0} days</div>
          </CardContent>
        </Card>
      </div>

      <Card>
        <CardHeader>
          <CardTitle>Variances Awaiting Your Approval</CardTitle>
        </CardHeader>
        <CardContent>
          <DataTable
            columns={varianceApprovalColumns}
            data={data?.pending || []}
          />
        </CardContent>
      </Card>

      <Card>
        <CardHeader>
          <CardTitle>Recently Approved/Rejected (Last 30 Days)</CardTitle>
        </CardHeader>
        <CardContent>
          <DataTable
            columns={recentVarianceColumns}
            data={data?.recently_approved || []}
          />
        </CardContent>
      </Card>
    </div>
  );
}
```

---

## Dependencies

### Required Stories
- **09.13** - Material Variance (cost_variances table)
- **09.14** - Labor Variance (cost_variances table)
- **09.15** - Yield/Scrap Variance (cost_variances table)
- **01.1** - Org Context + RLS (users, roles for approval)

---

## Testing Requirements

### Unit Tests
- Variance approval threshold logic (amount vs percent)
- Root cause categorization validation
- Corrective action completeness check

### Integration Tests
- Variance submission and approval workflow
- Root cause reporting aggregation
- Corrective action status updates
- Approval notification delivery

### E2E Tests
1. **Variance Root Cause and Approval**:
   - Identify variance >$5K
   - Document root cause and corrective action
   - Submit for approval
   - Finance Manager approves
   - Verify variance status updated

2. **Root Cause Reporting**:
   - Create 10 variances with different root causes
   - View root cause analysis report
   - Verify Pareto chart displays top causes
   - Export report to Excel

---

## Performance Requirements

- Root cause categorization: <500ms
- Approval action: <1 second
- Root cause report generation: <2 seconds (1000 variances)
- Approval dashboard load: <1 second

---

## Security & Permissions

Roles: cost_accountant (approve variances <$5K)
Roles: finance_manager (approve variances $5K-$10K)
Roles: cfo (approve variances >$10K)

---

## Story Metadata

**Estimated Effort:** 3-4 days
**Story Points:** 8
**Priority:** P2 (Phase 3)
**FR Coverage:** FR-9.4.7, FR-9.4.8, FR-9.1.8
**Related Stories:** 09.13 (Material Variance), 09.14 (Labor Variance), 09.16 (Real-Time Variance), 09.23 (Budget Management)
