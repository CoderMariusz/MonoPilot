# 09.4 - Labor Cost Tracking

**Priority**: P0 (MVP)
**Story Points**: M (Medium)
**Type**: backend
**Phase**: 1 (Foundation)
**Model**: OPUS

**State:** ready
**Estimate:** M (3-4 days)
**Primary PRD:** `docs/1-BASELINE/product/modules/finance.md` (FR-9.1.2, FR-9.3.2 Labor Cost Tracking)
**Architecture:** `docs/1-BASELINE/architecture/modules/finance.md` (labor_costs, cost_centers tables)

---

## Goal

Implement labor cost tracking from operation time logs, apply labor rates per role/machine, calculate labor costs per work order and operation, and establish cost center allocation. This enables accurate work order labor cost calculation and labor efficiency analysis.

---

## User Story

As a **Cost Accountant**, I want to **track actual labor costs from operation time logs with configured labor rates** so that **I can calculate accurate work order labor costs and analyze labor efficiency**.

As a **Finance Manager**, I want to **define labor rates per role, machine, or cost center** so that **labor costs reflect actual hourly rates and overhead allocation methods**.

---

## MVP Scope

**MVP Includes**:
- `cost_centers` table
- `labor_costs` table
- Labor rate definition per role/machine
- Time tracking integration (operation_time_logs)
- Labor cost calculation (hours Ã— rate)
- Link costs to work orders and operations
- Cost center assignment
- Labor cost summary per WO API
- Service layer integration

**Deferred to Phase 2+**:
- Labor rate variance calculation (Phase 2)
- Labor efficiency variance (Phase 2)
- Overtime rate premium
- Multi-tier labor rates

---

## Dependencies

| Dependency | Story/Epic | Type | Status |
|------------|------------|------|--------|
| 01.1 | Org Context | HARD | Ready |
| 04.X | Operation Time Tracking | HARD | Implemented |
| 09.1 | Finance Settings | HARD | Ready |
| 09.2 | Standard Costs | HARD | Ready |

---

## Database Migration

```sql
-- Migration: create_cost_centers_and_labor_costs.sql

CREATE TABLE cost_centers (
    id                  UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id              UUID NOT NULL REFERENCES organizations(id),
    code                TEXT NOT NULL,
    name                TEXT NOT NULL,
    description         TEXT,
    parent_id           UUID REFERENCES cost_centers(id),
    type                TEXT NOT NULL CHECK (type IN ('production', 'overhead', 'admin')),
    production_line_id  UUID REFERENCES production_lines(id),
    department          TEXT,
    is_active           BOOLEAN NOT NULL DEFAULT true,
    created_at          TIMESTAMPTZ NOT NULL DEFAULT now(),
    updated_at          TIMESTAMPTZ NOT NULL DEFAULT now(),

    CONSTRAINT uq_cost_center_code UNIQUE (org_id, code)
);

CREATE INDEX idx_cost_centers_org ON cost_centers(org_id);
CREATE INDEX idx_cost_centers_parent ON cost_centers(parent_id) WHERE parent_id IS NOT NULL;
CREATE INDEX idx_cost_centers_type ON cost_centers(org_id, type);

ALTER TABLE cost_centers ENABLE ROW LEVEL SECURITY;

CREATE POLICY "cost_centers_select" ON cost_centers
    FOR SELECT USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

CREATE POLICY "cost_centers_insert" ON cost_centers
    FOR INSERT WITH CHECK (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
        AND (SELECT role FROM users WHERE id = auth.uid()) IN ('admin', 'finance_manager')
    );

CREATE TABLE labor_costs (
    id                  UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id              UUID NOT NULL REFERENCES organizations(id),
    work_order_id       UUID NOT NULL REFERENCES work_orders(id),
    operation_id        UUID REFERENCES routing_operations(id),
    user_id             UUID REFERENCES users(id),
    machine_id          UUID REFERENCES machines(id),

    hours_actual        NUMERIC(10,2) NOT NULL,
    hours_standard      NUMERIC(10,2),
    hourly_rate         NUMERIC(15,4) NOT NULL,
    total_cost          NUMERIC(15,4) NOT NULL,

    currency_id         UUID NOT NULL REFERENCES currencies(id),
    cost_center_id      UUID REFERENCES cost_centers(id),
    transaction_date    TIMESTAMPTZ NOT NULL DEFAULT now(),
    created_at          TIMESTAMPTZ NOT NULL DEFAULT now(),

    CONSTRAINT chk_hours CHECK (hours_actual > 0),
    CONSTRAINT chk_total_cost CHECK (total_cost = hours_actual * hourly_rate)
);

CREATE INDEX idx_labor_costs_org ON labor_costs(org_id);
CREATE INDEX idx_labor_costs_wo ON labor_costs(work_order_id);
CREATE INDEX idx_labor_costs_operation ON labor_costs(operation_id) WHERE operation_id IS NOT NULL;
CREATE INDEX idx_labor_costs_date ON labor_costs(org_id, transaction_date);

ALTER TABLE labor_costs ENABLE ROW LEVEL SECURITY;

CREATE POLICY "labor_costs_select" ON labor_costs
    FOR SELECT USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

-- Function: Calculate labor cost from time log
CREATE OR REPLACE FUNCTION calculate_labor_cost_from_timelog(
    p_org_id UUID,
    p_work_order_id UUID,
    p_operation_id UUID,
    p_user_id UUID,
    p_hours NUMERIC
)
RETURNS UUID AS $$
DECLARE
    v_labor_cost_id UUID;
    v_hourly_rate NUMERIC;
    v_total_cost NUMERIC;
    v_currency_id UUID;
    v_cost_center_id UUID;
BEGIN
    -- Get base currency
    SELECT base_currency_id INTO v_currency_id
    FROM finance_settings
    WHERE org_id = p_org_id;

    -- Get hourly rate (from user profile, role, or default)
    SELECT COALESCE(hourly_rate, 25.00) INTO v_hourly_rate
    FROM users
    WHERE id = p_user_id;

    -- Get cost center from production line
    SELECT cc.id INTO v_cost_center_id
    FROM work_orders wo
    JOIN production_lines pl ON wo.production_line_id = pl.id
    JOIN cost_centers cc ON cc.production_line_id = pl.id
    WHERE wo.id = p_work_order_id
    LIMIT 1;

    v_total_cost := p_hours * v_hourly_rate;

    INSERT INTO labor_costs (
        org_id, work_order_id, operation_id, user_id,
        hours_actual, hourly_rate, total_cost,
        currency_id, cost_center_id, transaction_date
    ) VALUES (
        p_org_id, p_work_order_id, p_operation_id, p_user_id,
        p_hours, v_hourly_rate, v_total_cost,
        v_currency_id, v_cost_center_id, NOW()
    )
    RETURNING id INTO v_labor_cost_id;

    RETURN v_labor_cost_id;
END;
$$ LANGUAGE plpgsql;
```

---

## Acceptance Criteria

### AC-1: Cost Center CRUD
```gherkin
Given user is Finance Manager
When creating cost center:
  | code | CC-PROD-01 |
  | name | Production Line 1 |
  | type | production |
Then cost center created successfully
And can be assigned to labor costs
```

### AC-2: Labor Cost Calculation
```gherkin
Given operation time log:
  | work_order_id | WO-001 |
  | user_id | operator_123 |
  | hours_actual | 2.5 |
And user hourly_rate = 30.00 PLN
When calculating labor cost
Then labor_cost record created:
  | hours_actual | 2.5 |
  | hourly_rate | 30.00 |
  | total_cost | 75.00 |
And cost linked to work order
```

### AC-3: Cost Center Assignment
```gherkin
Given work order on Production Line 1
And cost center CC-PROD-01 linked to Line 1
When calculating labor cost
Then labor_cost.cost_center_id = CC-PROD-01
```

### AC-4: Labor Cost Summary API
```gherkin
Given GET /api/finance/work-order-costs/:workOrderId/labor
When requesting labor costs for WO
Then response contains:
  | operation | user | hours | rate | total_cost |
And summary totals
```

---

## Deliverables

- [ ] `cost_centers` table
- [ ] `labor_costs` table
- [ ] Labor cost calculation function
- [ ] Cost center CRUD API
- [ ] Labor cost summary API
- [ ] Service: LaborCostService, CostCenterService
- [ ] Tests: Labor cost scenarios

---

## Definition of Done

- [ ] Labor costs calculated from time logs
- [ ] Cost centers assignable
- [ ] Costs linked to work orders and operations
- [ ] API returns accurate summaries
- [ ] Tests cover all scenarios
- [ ] Performance < 500ms

---

**Created**: 2025-01-15 | **Complexity**: M (3-4 days) | **Phase**: 1
