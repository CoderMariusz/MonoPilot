# Story 09.19: Cost Reporting Suite

**Epic:** 09-finance
**Phase:** 2
**Complexity:** L (4-5 days)
**Type:** Full-stack
**Story File:** `09.19.cost-reporting-suite.md`

---

## User Story

As a **Finance Manager** or **Cost Accountant**,
I want to **generate comprehensive cost reports by product, period, production line, and cost center**,
So that I can **analyze cost performance, identify trends, and support financial decision-making**.

---

## Business Context

**Problem**: Finance teams spend hours manually exporting and consolidating cost data from multiple sources for reporting and analysis.

**Value**:
- Automated cost reporting (eliminate manual Excel exports)
- Multi-dimensional analysis (product × period × line × cost center)
- Trend visibility for strategic planning
- Export to Excel/PDF for stakeholder distribution
- Reduce month-end close time by 40%

**Use Cases**:
1. Finance Manager generates "Cost by Product" report for Q1 → exports to Excel → shares with executive team for profitability review
2. Cost Accountant runs "Cost by Period" report (monthly) → identifies 15% cost increase in March → drills into variance analysis
3. Production Controller generates "Cost by Production Line" report → compares Line 1 vs Line 2 efficiency → recommends equipment upgrade
4. CFO requests "Cost by Cost Center" report → analyzes overhead allocation → adjusts budgets for next quarter

---

## Acceptance Criteria

### AC1: Cost by Product Report (FR-9.6.1)

**Given** user navigates to `/finance/reports/cost-by-product`
**When** selecting date range and filters
**Then** the system displays:
- Product list with cost breakdown (material, labor, overhead, total)
- Cost per unit (total cost / units produced)
- Total cost for period
- Units produced count
- Variance vs standard cost (amount and %)
- Sortable columns (by total cost, variance %, etc.)
- Filters: Product category, date range, cost variance threshold

**Export**: CSV, Excel (with charts), PDF

**Validation**:
- Report aggregates work_order_costs grouped by product
- Cost per unit = total cost / SUM(quantity_produced)
- Variance calculation matches 09.16 real-time variance logic

---

### AC2: Cost by Period Report (FR-9.6.2)

**Given** user navigates to `/finance/reports/cost-by-period`
**When** selecting period type (daily, weekly, monthly, quarterly)
**Then** the system displays:
- Time series table/chart with cost by period
- Cost breakdown by category (material, labor, overhead)
- Period-over-period change (amount and %)
- Cumulative cost (year-to-date or custom)
- Trend line chart
- Filters: Date range, cost category, product filter

**Export**: CSV, Excel (with trend chart), PDF

**Validation**:
- Periods correctly grouped by selected type
- Period-over-period % = ((current - previous) / previous) × 100
- Cumulative cost = SUM(period costs) to date

---

### AC3: Cost by Production Line Report (FR-9.6.3)

**Given** user navigates to `/finance/reports/cost-by-line`
**When** selecting date range and production lines
**Then** the system displays:
- Production line list with cost breakdown
- Labor cost and efficiency metrics (hours actual vs standard)
- Material cost (consumed on this line)
- Overhead allocated to line
- Units produced per line
- Cost per unit by line
- Comparison chart (bar chart comparing lines)
- Filters: Date range, production line, shift

**Export**: CSV, Excel (with comparison chart), PDF

**Validation**:
- Cost allocated to line via work_order.production_line_id
- Labor efficiency = (hours_standard / hours_actual) × 100
- Overhead allocated using cost_center linked to production_line

---

### AC4: Cost by Cost Center Report (FR-9.6.4)

**Given** user navigates to `/finance/reports/cost-by-cost-center`
**When** selecting date range and cost centers
**Then** the system displays:
- Cost center list with cost breakdown
- Budget vs actual comparison (if budgets defined in 09.22)
- Variance to budget (amount and %)
- Cost allocation by category (material, labor, overhead)
- Cost center hierarchy view (if hierarchy exists)
- Filters: Date range, cost center type, budget variance threshold

**Export**: CSV, Excel (with budget comparison chart), PDF

**Validation**:
- Cost aggregated from work_order_costs.cost_center_id
- Budget variance = actual cost - budget amount
- Hierarchy rollup sums child cost centers to parent

---

### AC5: Export to Excel/PDF

**Given** user viewing any cost report
**When** clicking "Export" button and selecting format (Excel or PDF)
**Then** the system generates export with:
- Report title and parameters (date range, filters)
- Full data table (all rows, not just visible)
- Charts (if applicable): trend charts, comparison charts
- Summary section (totals, averages, key metrics)
- Timestamp and generated by user
- Organization branding (logo, name)

**Excel Format**:
- Multiple sheets: Summary, Detailed Data, Charts
- Formatted headers, currency formatting
- Formulas for totals and averages
- Freeze panes for headers

**PDF Format**:
- Print-friendly layout (portrait or landscape)
- Page breaks preserve table structure
- Header/footer with page numbers
- Company logo in header

**Validation**:
- Export completes in <5 seconds for 1000 rows
- Excel file opens without errors in Excel 2016+
- PDF renders correctly in Adobe Reader
- Export includes only data user has permission to view (RLS enforced)

---

## Technical Design

### API Endpoints

```typescript
// Cost by Product Report
GET /api/finance/reports/cost-by-product
Query Params:
  - dateFrom: ISO date
  - dateTo: ISO date
  - productCategoryId?: string
  - minVariancePercent?: number

Response: {
  products: {
    product_id: string;
    sku: string;
    product_name: string;
    units_produced: number;
    material_cost: number;
    labor_cost: number;
    overhead_cost: number;
    total_cost: number;
    cost_per_unit: number;
    standard_cost_per_unit: number;
    variance_amount: number;
    variance_percent: number;
  }[];
  summary: { total_cost, total_units, avg_cost_per_unit };
}

// Cost by Period Report
GET /api/finance/reports/cost-by-period
Query Params:
  - dateFrom, dateTo
  - periodType: 'daily' | 'weekly' | 'monthly' | 'quarterly'
  - costCategory?: 'material' | 'labor' | 'overhead' | 'all'

Response: {
  periods: {
    period_start: ISO date;
    period_end: ISO date;
    material_cost: number;
    labor_cost: number;
    overhead_cost: number;
    total_cost: number;
    period_over_period_change_percent: number;
    cumulative_cost: number;
  }[];
  summary: { total_cost, avg_period_cost, max_period_cost };
}

// Cost by Production Line Report
GET /api/finance/reports/cost-by-line
Query Params:
  - dateFrom, dateTo
  - lineIds?: string[]
  - shiftType?: 'day' | 'night' | 'weekend'

Response: {
  lines: {
    line_id: string;
    line_name: string;
    material_cost: number;
    labor_cost: number;
    labor_hours_actual: number;
    labor_hours_standard: number;
    labor_efficiency_percent: number;
    overhead_cost: number;
    total_cost: number;
    units_produced: number;
    cost_per_unit: number;
  }[];
  summary: { total_cost, avg_efficiency, total_units };
}

// Cost by Cost Center Report
GET /api/finance/reports/cost-by-cost-center
Query Params:
  - dateFrom, dateTo
  - costCenterIds?: string[]
  - includeHierarchy?: boolean

Response: {
  cost_centers: {
    cost_center_id: string;
    cost_center_code: string;
    cost_center_name: string;
    material_cost: number;
    labor_cost: number;
    overhead_cost: number;
    total_cost: number;
    budget_amount?: number;
    budget_variance?: number;
    budget_variance_percent?: number;
    children?: CostCenter[]; // If hierarchy
  }[];
  summary: { total_cost, total_budget_variance };
}

// Export Report
POST /api/finance/reports/export
Body: {
  report_type: 'cost_by_product' | 'cost_by_period' | 'cost_by_line' | 'cost_by_cost_center';
  format: 'csv' | 'excel' | 'pdf';
  filters: Record<string, any>;
  data: any[]; // Report data to export
}
Response: Blob (file download)
```

### Service: CostReportingService

```typescript
// apps/frontend/lib/services/cost-reporting-service.ts
export class CostReportingService {
  // Generate Cost by Product Report
  static async getCostByProduct(filters: ReportFilters): Promise<CostByProductReport> {
    // Join work_order_costs, work_orders, products
    // Group by product_id
    // Calculate totals, variance, cost per unit
  }

  // Generate Cost by Period Report
  static async getCostByPeriod(filters: PeriodReportFilters): Promise<CostByPeriodReport> {
    // Group work_order_costs by period (date_trunc based on periodType)
    // Calculate period-over-period change
    // Calculate cumulative cost
  }

  // Generate Cost by Production Line Report
  static async getCostByLine(filters: ReportFilters): Promise<CostByLineReport> {
    // Join work_order_costs, work_orders, production_lines, labor_costs
    // Group by production_line_id
    // Calculate efficiency metrics
  }

  // Generate Cost by Cost Center Report
  static async getCostByCostCenter(filters: ReportFilters): Promise<CostByCostCenterReport> {
    // Join work_order_costs, cost_centers, cost_center_budgets
    // Group by cost_center_id
    // Include hierarchy rollup if requested
    // Calculate budget variance
  }

  // Export report to Excel/PDF
  static async exportReport(
    reportType: ReportType,
    format: ExportFormat,
    data: any[]
  ): Promise<Blob> {
    // Generate Excel workbook with ExcelJS or XLSX
    // Generate PDF with PDFKit or similar
    // Include charts, formatting, branding
  }
}
```

### Database Queries

#### Cost by Product (Optimized)
```sql
SELECT
  p.id AS product_id,
  p.sku,
  p.name AS product_name,
  SUM(woc.quantity_produced) AS units_produced,
  SUM(woc.material_cost_actual) AS material_cost,
  SUM(woc.labor_cost_actual) AS labor_cost,
  SUM(woc.overhead_cost_actual) AS overhead_cost,
  SUM(woc.total_cost_actual) AS total_cost,
  SUM(woc.total_cost_actual) / NULLIF(SUM(woc.quantity_produced), 0) AS cost_per_unit,
  SUM(woc.total_cost_standard) / NULLIF(SUM(woc.quantity_produced), 0) AS standard_cost_per_unit,
  SUM(woc.total_variance) AS variance_amount,
  (SUM(woc.total_variance) / NULLIF(SUM(woc.total_cost_standard), 0)) * 100 AS variance_percent
FROM work_order_costs woc
JOIN work_orders wo ON woc.work_order_id = wo.id
JOIN products p ON wo.product_id = p.id
WHERE wo.org_id = :org_id
  AND woc.costing_date BETWEEN :date_from AND :date_to
  AND (:product_category_id IS NULL OR p.category_id = :product_category_id)
GROUP BY p.id, p.sku, p.name
HAVING (:min_variance_percent IS NULL OR ABS((SUM(woc.total_variance) / NULLIF(SUM(woc.total_cost_standard), 0)) * 100) >= :min_variance_percent)
ORDER BY total_cost DESC;
```

#### Cost by Period (with Period-over-Period)
```sql
WITH period_costs AS (
  SELECT
    DATE_TRUNC(:period_type, woc.costing_date) AS period_start,
    SUM(woc.material_cost_actual) AS material_cost,
    SUM(woc.labor_cost_actual) AS labor_cost,
    SUM(woc.overhead_cost_actual) AS overhead_cost,
    SUM(woc.total_cost_actual) AS total_cost
  FROM work_order_costs woc
  JOIN work_orders wo ON woc.work_order_id = wo.id
  WHERE wo.org_id = :org_id
    AND woc.costing_date BETWEEN :date_from AND :date_to
  GROUP BY period_start
),
period_with_previous AS (
  SELECT
    period_start,
    period_start + INTERVAL '1 day' * (:period_interval - 1) AS period_end,
    material_cost,
    labor_cost,
    overhead_cost,
    total_cost,
    LAG(total_cost) OVER (ORDER BY period_start) AS previous_period_cost,
    SUM(total_cost) OVER (ORDER BY period_start) AS cumulative_cost
  FROM period_costs
)
SELECT
  period_start,
  period_end,
  material_cost,
  labor_cost,
  overhead_cost,
  total_cost,
  CASE
    WHEN previous_period_cost IS NOT NULL AND previous_period_cost > 0
    THEN ((total_cost - previous_period_cost) / previous_period_cost) * 100
    ELSE NULL
  END AS period_over_period_change_percent,
  cumulative_cost
FROM period_with_previous
ORDER BY period_start;
```

---

## Frontend Components

### CostByProductReportPage
```tsx
// apps/frontend/app/(authenticated)/finance/reports/cost-by-product/page.tsx
export default function CostByProductReportPage() {
  const [filters, setFilters] = useState<ReportFilters>({
    dateFrom: subDays(new Date(), 30),
    dateTo: new Date(),
  });

  const { data, isLoading } = useCostByProduct(filters);

  return (
    <div className="space-y-6">
      <PageHeader title="Cost by Product Report" />

      <Card>
        <CardContent className="flex gap-4">
          <DateRangePicker value={filters} onChange={(range) => setFilters({ ...filters, ...range })} />
          <ProductCategoryFilter value={filters.productCategoryId} onChange={(id) => setFilters({ ...filters, productCategoryId: id })} />
          <Input
            type="number"
            placeholder="Min Variance %"
            onChange={(e) => setFilters({ ...filters, minVariancePercent: parseFloat(e.target.value) })}
          />
          <Button onClick={() => exportReport('cost_by_product', 'excel', data)}>
            Export to Excel
          </Button>
        </CardContent>
      </Card>

      <CostByProductTable data={data} />

      <Card>
        <CardHeader><CardTitle>Summary</CardTitle></CardHeader>
        <CardContent>
          <CostSummaryMetrics summary={data?.summary} />
        </CardContent>
      </Card>
    </div>
  );
}
```

### CostByProductTable
```tsx
// apps/frontend/components/finance/reports/CostByProductTable.tsx
export function CostByProductTable({ data }: Props) {
  const columns: ColumnDef<ProductCost>[] = [
    { accessorKey: 'sku', header: 'SKU' },
    { accessorKey: 'product_name', header: 'Product' },
    { accessorKey: 'units_produced', header: 'Units Produced' },
    { accessorKey: 'material_cost', header: 'Material Cost', cell: ({ value }) => formatCurrency(value) },
    { accessorKey: 'labor_cost', header: 'Labor Cost', cell: ({ value }) => formatCurrency(value) },
    { accessorKey: 'overhead_cost', header: 'Overhead Cost', cell: ({ value }) => formatCurrency(value) },
    { accessorKey: 'total_cost', header: 'Total Cost', cell: ({ value }) => formatCurrency(value) },
    { accessorKey: 'cost_per_unit', header: 'Cost/Unit', cell: ({ value }) => formatCurrency(value) },
    { accessorKey: 'variance_percent', header: 'Variance %', cell: ({ row }) => (
      <Badge variant={row.original.variance_amount > 0 ? 'destructive' : 'success'}>
        {row.original.variance_percent.toFixed(2)}%
      </Badge>
    )},
  ];

  return <DataTable columns={columns} data={data?.products || []} />;
}
```

### CostByPeriodReportPage
```tsx
// apps/frontend/app/(authenticated)/finance/reports/cost-by-period/page.tsx
export default function CostByPeriodReportPage() {
  const [periodType, setPeriodType] = useState<PeriodType>('monthly');
  const [filters, setFilters] = useState<PeriodReportFilters>({
    dateFrom: subMonths(new Date(), 6),
    dateTo: new Date(),
    periodType: 'monthly',
  });

  const { data, isLoading } = useCostByPeriod({ ...filters, periodType });

  return (
    <div className="space-y-6">
      <PageHeader title="Cost by Period Report" />

      <Card>
        <CardContent className="flex gap-4">
          <PeriodTypeSelector value={periodType} onChange={setPeriodType} />
          <DateRangePicker value={filters} onChange={(range) => setFilters({ ...filters, ...range })} />
          <Button onClick={() => exportReport('cost_by_period', 'excel', data)}>
            Export to Excel
          </Button>
        </CardContent>
      </Card>

      <CostTrendChart data={data?.periods} />

      <CostByPeriodTable data={data} />
    </div>
  );
}
```

### CostTrendChart
```tsx
// apps/frontend/components/finance/reports/CostTrendChart.tsx
export function CostTrendChart({ data }: Props) {
  const chartData = data?.map(period => ({
    date: format(new Date(period.period_start), 'MMM yyyy'),
    material: period.material_cost,
    labor: period.labor_cost,
    overhead: period.overhead_cost,
    total: period.total_cost,
  }));

  return (
    <Card>
      <CardHeader><CardTitle>Cost Trend</CardTitle></CardHeader>
      <CardContent>
        <ResponsiveContainer width="100%" height={300}>
          <LineChart data={chartData}>
            <CartesianGrid strokeDasharray="3 3" />
            <XAxis dataKey="date" />
            <YAxis />
            <Tooltip />
            <Legend />
            <Line type="monotone" dataKey="material" stroke="#8884d8" name="Material" />
            <Line type="monotone" dataKey="labor" stroke="#82ca9d" name="Labor" />
            <Line type="monotone" dataKey="overhead" stroke="#ffc658" name="Overhead" />
            <Line type="monotone" dataKey="total" stroke="#ff7300" strokeWidth={2} name="Total" />
          </LineChart>
        </ResponsiveContainer>
      </CardContent>
    </Card>
  );
}
```

### ExportReportButton
```tsx
// apps/frontend/components/finance/reports/ExportReportButton.tsx
export function ExportReportButton({ reportType, data, filters }: Props) {
  const [format, setFormat] = useState<ExportFormat>('excel');
  const [isExporting, setIsExporting] = useState(false);

  const handleExport = async () => {
    setIsExporting(true);
    try {
      const blob = await CostReportingService.exportReport(reportType, format, data);
      downloadBlob(blob, `${reportType}_${format}_${Date.now()}.${format}`);
    } catch (error) {
      toast.error('Export failed');
    } finally {
      setIsExporting(false);
    }
  };

  return (
    <div className="flex items-center gap-2">
      <Select value={format} onValueChange={setFormat}>
        <SelectTrigger className="w-32">
          <SelectValue />
        </SelectTrigger>
        <SelectContent>
          <SelectItem value="excel">Excel</SelectItem>
          <SelectItem value="csv">CSV</SelectItem>
          <SelectItem value="pdf">PDF</SelectItem>
        </SelectContent>
      </Select>

      <Button onClick={handleExport} disabled={isExporting}>
        {isExporting ? 'Exporting...' : `Export to ${format.toUpperCase()}`}
      </Button>
    </div>
  );
}
```

---

## Dependencies

### Required Stories
- **09.1** - Finance Settings
- **09.2** - Standard Cost Definition
- **09.3** - Material Cost Tracking
- **09.4** - Labor Cost Tracking
- **09.6** - WO Cost Summary
- **09.12** - Overhead Allocation (for cost center report)

---

## Testing Requirements

### Unit Tests
- Cost aggregation by product, period, line, cost center
- Period-over-period calculation correctness
- Cumulative cost calculation
- Budget variance calculation
- Export formatting (Excel, PDF)

### Integration Tests
- Report generation with various filters
- Export to Excel/CSV/PDF functional
- Chart rendering with correct data
- Summary metrics calculation

### E2E Tests
1. **Cost by Product Report**:
   - Navigate to cost by product page
   - Apply date range and category filter
   - Verify table sorted by total cost
   - Export to Excel → verify file downloads and opens correctly

2. **Cost by Period Report**:
   - Navigate to cost by period page
   - Select "Monthly" period type
   - Verify trend chart displays correctly
   - Verify period-over-period % calculated correctly

---

## Performance Requirements

- Report generation: <3 seconds (1000 products)
- Export to Excel: <5 seconds (1000 rows)
- Export to PDF: <5 seconds (1000 rows)
- Chart rendering: <1 second

---

## Security & Permissions

Roles: finance_manager, cost_accountant, admin (view/export all reports)

---

## Story Metadata

**Estimated Effort:** 4-5 days
**Story Points:** 13
**Priority:** P0 (Phase 2)
**FR Coverage:** FR-9.6.1, FR-9.6.2, FR-9.6.3, FR-9.6.4
**Related Stories:** 09.16 (Variance Dashboard), 09.17 (Drill-Down), 09.22 (Budget Management)
