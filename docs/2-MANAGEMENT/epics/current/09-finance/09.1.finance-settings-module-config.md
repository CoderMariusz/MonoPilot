# 09.1 - Finance Settings & Module Config

**Priority**: P0 (MVP)
**Story Points**: S (Small)
**Type**: backend
**Phase**: 1 (Foundation)
**Model**: OPUS

**State:** ready
**Estimate:** S (1-2 days)
**Primary PRD:** `docs/1-BASELINE/product/modules/finance.md` (Finance Module Settings)
**Architecture:** `docs/1-BASELINE/architecture/modules/finance.md` (finance_settings table)

---

## Goal

Implement finance module configuration and settings management to enable organizations to configure valuation methods (FIFO/WAC), variance thresholds, overhead allocation methods, and cost center hierarchy levels. This establishes the foundation for all cost tracking and financial reporting in the system.

---

## Finance Compliance Context

This story is **foundational for financial compliance**:

- [x] **Accounting Standards** - Valuation method configuration (FIFO/WAC) required for GAAP/IFRS compliance
- [x] **Polish Accounting Act** - Multi-currency support with PLN as base currency
- [x] **Audit Trail Required** - All settings changes must be logged with user ID and timestamp
- [x] **Cost Center Structure** - Foundation for cost allocation and reporting

**Regulatory Context:**
- Polish Accounting Act requires consistent inventory valuation method
- Valuation method cannot be changed mid-period without revaluation
- Variance thresholds support management by exception
- Cost center hierarchy enables department-level reporting

---

## MVP Scope

This story implements Phase 1 (Foundation) functionality for finance module settings.

**MVP Includes**:
- `finance_settings` table with organization-level configuration
- Finance module toggle (enable/disable)
- Valuation method selection (FIFO, WAC, Standard)
- Variance threshold configuration (warning 5%, critical 10%)
- Overhead allocation method (labor hours, machine hours, units)
- Cost center hierarchy levels (1-5 levels)
- Base currency configuration (PLN default)
- Settings CRUD API endpoints
- Settings management UI page
- Audit logging for all settings changes
- RLS enforcement for multi-tenancy

**Deferred to Phase 2+**:
- Advanced overhead allocation methods (activity-based costing)
- Multi-site cost center consolidation
- Custom variance threshold by product category
- Variance alert notification configuration (story 9.11)
- Budget period configuration (story 9.14)

---

## User Story

As a **Finance Manager**, I want to **configure finance module settings including valuation method, variance thresholds, and overhead allocation rules** so that **cost tracking and reporting align with our accounting policies and business requirements**.

As a **System Administrator**, I want to **enable or disable the finance module and control access to financial features** so that **only authorized organizations can access cost tracking capabilities**.

---

## Scope

**In scope (this story)**
- `finance_settings` table creation
- Finance module enable/disable toggle
- Valuation method configuration (FIFO, weighted_average, standard_cost)
- Variance threshold configuration (warning_percent, critical_percent)
- Overhead allocation method (labor_hours, machine_hours, units_produced)
- Cost center hierarchy levels (1-5)
- Base currency ID reference
- GET /api/finance/settings (get org settings)
- PUT /api/finance/settings (update settings)
- POST /api/finance/settings/initialize (create default settings)
- Settings management page UI
- Settings validation (thresholds 0-100%, hierarchy 1-5)
- Audit logging integration
- RLS policies for finance_settings

**Out of scope (this story)**
- Currency CRUD (story 9.2 - Standard Cost Definition includes currency setup)
- Tax code configuration (story 9.2)
- Cost center CRUD (story 9.6 - Labor Cost Tracking)
- GL account mapping (Phase 2)
- Variance alert configuration (Phase 2, story 9.11)
- Budget settings (Phase 2, story 9.14)
- Advanced costing methods (activity-based costing - Phase 3)

---

## Dependencies

### Cross-Epic Dependencies

| Dependency | Story/Epic | Type | What It Provides | Status |
|------------|------------|------|------------------|--------|
| 01.1 | Org Context + RLS | HARD | organizations, users, roles tables | Ready |
| 01.2 | Settings Module | SOFT | Settings page patterns | Ready |

### Within Epic Dependencies

| Dependency | Story | Type | What It Provides |
|------------|-------|------|------------------|
| None | - | - | First story in Epic 09 |

### Provides To (Downstream)

| Story | What This Provides |
|-------|-------------------|
| 09.2 | Standard Cost Definition - valuation method, base currency |
| 09.3 | Material Cost Tracking - valuation method (FIFO/WAC) |
| 09.4 | Labor Cost Tracking - overhead allocation method |
| 09.5 | BOM Costing - cost rollup settings |
| All Phase 2+ | Finance module enabled check, variance thresholds |

---

## Database Migration

### Migration: Create finance_settings table

```sql
-- Migration: YYYYMMDDHHMMSS_create_finance_settings.sql

CREATE TABLE finance_settings (
    -- Identity
    id                          UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id                      UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,

    -- Module Control
    finance_enabled             BOOLEAN NOT NULL DEFAULT false,

    -- Valuation Method
    valuation_method            TEXT NOT NULL DEFAULT 'fifo'
                                CHECK (valuation_method IN ('fifo', 'weighted_average', 'standard_cost')),

    -- Variance Thresholds
    variance_warning_percent    NUMERIC(5,2) NOT NULL DEFAULT 5.00
                                CHECK (variance_warning_percent >= 0 AND variance_warning_percent <= 100),
    variance_critical_percent   NUMERIC(5,2) NOT NULL DEFAULT 10.00
                                CHECK (variance_critical_percent >= 0 AND variance_critical_percent <= 100),

    -- Overhead Allocation
    overhead_allocation_method  TEXT NOT NULL DEFAULT 'labor_hours'
                                CHECK (overhead_allocation_method IN ('labor_hours', 'machine_hours', 'units_produced', 'none')),

    -- Cost Center Configuration
    cost_center_hierarchy_levels INTEGER NOT NULL DEFAULT 3
                                 CHECK (cost_center_hierarchy_levels >= 1 AND cost_center_hierarchy_levels <= 5),
    enable_cost_center_budgets  BOOLEAN NOT NULL DEFAULT true,

    -- Currency Configuration
    base_currency_id            UUID REFERENCES currencies(id),

    -- Cost Calculation Settings
    auto_calculate_wo_costs     BOOLEAN NOT NULL DEFAULT true,
    auto_calculate_bom_costs    BOOLEAN NOT NULL DEFAULT true,
    include_scrap_in_variance   BOOLEAN NOT NULL DEFAULT true,

    -- Rounding Configuration
    cost_rounding_decimals      INTEGER NOT NULL DEFAULT 4
                                CHECK (cost_rounding_decimals >= 2 AND cost_rounding_decimals <= 6),

    -- Audit
    created_at                  TIMESTAMPTZ NOT NULL DEFAULT now(),
    created_by                  UUID REFERENCES users(id),
    updated_at                  TIMESTAMPTZ NOT NULL DEFAULT now(),
    updated_by                  UUID REFERENCES users(id),

    -- Constraints
    CONSTRAINT uq_finance_settings_org UNIQUE (org_id),
    CONSTRAINT chk_variance_thresholds CHECK (variance_critical_percent >= variance_warning_percent)
);

-- =============================================================================
-- Indexes for Performance
-- =============================================================================

CREATE INDEX idx_finance_settings_org ON finance_settings(org_id);
CREATE INDEX idx_finance_settings_enabled ON finance_settings(org_id, finance_enabled)
    WHERE finance_enabled = true;

-- =============================================================================
-- RLS Policies
-- =============================================================================

ALTER TABLE finance_settings ENABLE ROW LEVEL SECURITY;

CREATE POLICY "finance_settings_select" ON finance_settings
    FOR SELECT USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

CREATE POLICY "finance_settings_insert" ON finance_settings
    FOR INSERT WITH CHECK (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
        AND (
            SELECT role FROM users WHERE id = auth.uid()
        ) IN ('admin', 'finance_manager')
    );

CREATE POLICY "finance_settings_update" ON finance_settings
    FOR UPDATE USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
        AND (
            SELECT role FROM users WHERE id = auth.uid()
        ) IN ('admin', 'finance_manager')
    );

-- No delete policy - settings cannot be deleted, only disabled

-- =============================================================================
-- Trigger for updated_at
-- =============================================================================

CREATE TRIGGER update_finance_settings_updated_at
    BEFORE UPDATE ON finance_settings
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- =============================================================================
-- Function: Initialize default finance settings for new organization
-- =============================================================================

CREATE OR REPLACE FUNCTION initialize_finance_settings(p_org_id UUID, p_user_id UUID)
RETURNS UUID AS $$
DECLARE
    v_settings_id UUID;
    v_pln_currency_id UUID;
BEGIN
    -- Get PLN currency ID (assuming currencies table exists)
    SELECT id INTO v_pln_currency_id
    FROM currencies
    WHERE org_id = p_org_id
      AND code = 'PLN'
    LIMIT 1;

    -- Create default finance settings
    INSERT INTO finance_settings (
        org_id,
        finance_enabled,
        valuation_method,
        variance_warning_percent,
        variance_critical_percent,
        overhead_allocation_method,
        cost_center_hierarchy_levels,
        enable_cost_center_budgets,
        base_currency_id,
        auto_calculate_wo_costs,
        auto_calculate_bom_costs,
        include_scrap_in_variance,
        cost_rounding_decimals,
        created_by,
        updated_by
    ) VALUES (
        p_org_id,
        false, -- Disabled by default, must be explicitly enabled
        'fifo',
        5.00,
        10.00,
        'labor_hours',
        3,
        true,
        v_pln_currency_id,
        true,
        true,
        true,
        4,
        p_user_id,
        p_user_id
    )
    RETURNING id INTO v_settings_id;

    RETURN v_settings_id;
END;
$$ LANGUAGE plpgsql;

-- =============================================================================
-- Function: Validate settings changes (called from application)
-- =============================================================================

CREATE OR REPLACE FUNCTION validate_finance_settings_update()
RETURNS TRIGGER AS $$
BEGIN
    -- Ensure critical threshold >= warning threshold
    IF NEW.variance_critical_percent < NEW.variance_warning_percent THEN
        RAISE EXCEPTION 'Critical threshold (%) must be >= warning threshold (%)',
            NEW.variance_critical_percent, NEW.variance_warning_percent;
    END IF;

    -- Ensure cost center hierarchy is reasonable
    IF NEW.cost_center_hierarchy_levels < 1 OR NEW.cost_center_hierarchy_levels > 5 THEN
        RAISE EXCEPTION 'Cost center hierarchy levels must be between 1 and 5';
    END IF;

    -- Ensure rounding decimals are reasonable
    IF NEW.cost_rounding_decimals < 2 OR NEW.cost_rounding_decimals > 6 THEN
        RAISE EXCEPTION 'Cost rounding decimals must be between 2 and 6';
    END IF;

    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER validate_finance_settings_before_update
    BEFORE UPDATE ON finance_settings
    FOR EACH ROW
    EXECUTE FUNCTION validate_finance_settings_update();

-- =============================================================================
-- Audit Log Function for Settings Changes
-- =============================================================================

CREATE OR REPLACE FUNCTION log_finance_settings_changes()
RETURNS TRIGGER AS $$
DECLARE
    v_changes JSONB;
BEGIN
    v_changes := jsonb_build_object(
        'old_values', row_to_json(OLD),
        'new_values', row_to_json(NEW)
    );

    -- Insert audit log entry (assuming audit_log table exists)
    INSERT INTO audit_log (
        org_id,
        user_id,
        entity_type,
        entity_id,
        action,
        changes,
        created_at
    ) VALUES (
        NEW.org_id,
        NEW.updated_by,
        'finance_settings',
        NEW.id,
        'update',
        v_changes,
        NOW()
    );

    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER audit_finance_settings_changes
    AFTER UPDATE ON finance_settings
    FOR EACH ROW
    WHEN (OLD IS DISTINCT FROM NEW)
    EXECUTE FUNCTION log_finance_settings_changes();
```

---

## Acceptance Criteria (Given/When/Then)

### AC-1: Finance Settings Table Creation

```gherkin
Scenario: finance_settings table exists with all required columns
  Given database migration runs
  When schema is inspected
  Then finance_settings table has all columns from schema
  And UNIQUE constraint exists on org_id
  And CHECK constraint validates valuation_method IN ('fifo', 'weighted_average', 'standard_cost')
  And CHECK constraint validates variance thresholds 0-100%
  And CHECK constraint validates cost_center_hierarchy_levels 1-5
  And CHECK constraint validates critical >= warning threshold
  And RLS policies enforce org isolation
```

### AC-2: Default Settings Initialization

```gherkin
Scenario: Initialize default settings for new organization
  Given organization "ABC Foods" exists
  And user is admin
  When calling initialize_finance_settings(org_id, user_id)
  Then finance_settings record created with:
    | Field | Value |
    | finance_enabled | false |
    | valuation_method | fifo |
    | variance_warning_percent | 5.00 |
    | variance_critical_percent | 10.00 |
    | overhead_allocation_method | labor_hours |
    | cost_center_hierarchy_levels | 3 |
    | enable_cost_center_budgets | true |
    | auto_calculate_wo_costs | true |
    | cost_rounding_decimals | 4 |
  And base_currency_id set to PLN if exists
  And created_by and updated_by set to user_id

Scenario: Cannot create duplicate settings for same org
  Given finance_settings already exists for org_id
  When attempting to insert another record with same org_id
  Then system returns 409 Conflict error
  And error message "Finance settings already exist for organization"
```

### AC-3: Get Finance Settings

```gherkin
Scenario: Get finance settings for organization
  Given finance_settings exist for org
  When user requests GET /api/finance/settings
  Then system returns 200 OK
  And response contains:
    | Field | Type |
    | finance_enabled | boolean |
    | valuation_method | string |
    | variance_warning_percent | number |
    | variance_critical_percent | number |
    | overhead_allocation_method | string |
    | cost_center_hierarchy_levels | number |
    | base_currency_id | uuid |
    | auto_calculate_wo_costs | boolean |
  And response time < 200ms

Scenario: Get settings when none exist
  Given finance_settings do NOT exist for org
  When user requests GET /api/finance/settings
  Then system returns 404 Not Found
  And error message "Finance settings not initialized. Please contact administrator."
```

### AC-4: Update Finance Settings

```gherkin
Scenario: Update finance settings successfully
  Given user is Finance Manager
  And finance_settings exist for org
  When user sends PUT /api/finance/settings with:
    | Field | Value |
    | valuation_method | weighted_average |
    | variance_warning_percent | 7.5 |
    | variance_critical_percent | 15.0 |
    | overhead_allocation_method | machine_hours |
  Then system returns 200 OK
  And settings updated in database
  And updated_at timestamp updated
  And updated_by set to current user
  And audit log entry created with old and new values

Scenario: Enable finance module
  Given finance_enabled = false
  When Finance Manager updates finance_enabled = true
  Then finance module activated
  And success message "Finance module enabled successfully"
  And audit log records activation

Scenario: Cannot update with invalid valuation method
  Given user is Finance Manager
  When updating valuation_method = 'invalid_method'
  Then system returns 400 Bad Request
  And error message "Valuation method must be one of: fifo, weighted_average, standard_cost"

Scenario: Cannot set critical threshold below warning
  Given variance_warning_percent = 5.0
  When updating variance_critical_percent = 3.0
  Then system returns 400 Bad Request
  And error message "Critical threshold must be >= warning threshold"

Scenario: Cannot set invalid hierarchy levels
  Given user is Finance Manager
  When updating cost_center_hierarchy_levels = 7
  Then system returns 400 Bad Request
  And error message "Cost center hierarchy levels must be between 1 and 5"
```

### AC-5: Permission Enforcement

```gherkin
Scenario: Finance Manager can update settings
  Given user has role = 'finance_manager'
  When user updates finance settings
  Then update succeeds

Scenario: Admin can update settings
  Given user has role = 'admin'
  When user updates finance settings
  Then update succeeds

Scenario: Viewer cannot update settings
  Given user has role = 'viewer'
  When user attempts to update finance settings
  Then system returns 403 Forbidden
  And error message "Insufficient permissions to update finance settings"

Scenario: Production Supervisor cannot update settings
  Given user has role = 'production_supervisor'
  When user attempts to update finance settings
  Then system returns 403 Forbidden
```

### AC-6: Valuation Method Configuration

```gherkin
Scenario: Configure FIFO valuation
  Given user is Finance Manager
  When selecting valuation_method = 'fifo'
  Then setting saved successfully
  And help text shows "First In, First Out - Uses oldest inventory cost"

Scenario: Configure Weighted Average valuation
  When selecting valuation_method = 'weighted_average'
  Then setting saved successfully
  And help text shows "Weighted Average Cost - Average of all inventory"

Scenario: Configure Standard Cost valuation
  When selecting valuation_method = 'standard_cost'
  Then setting saved successfully
  And help text shows "Standard Cost - Uses pre-defined standard costs"
  And warning shown "Standard costs must be defined for all products"
```

### AC-7: Variance Threshold Configuration

```gherkin
Scenario: Set variance thresholds
  Given user is Finance Manager
  When setting:
    | variance_warning_percent | 5.0 |
    | variance_critical_percent | 10.0 |
  Then thresholds saved successfully
  And help text shows "Warning alerts at 5%, Critical alerts at 10%"

Scenario: Thresholds must be percentage (0-100)
  When setting variance_warning_percent = 150
  Then validation error "Threshold must be between 0 and 100"

Scenario: Critical must be >= warning
  Given variance_warning_percent = 10
  When setting variance_critical_percent = 5
  Then validation error "Critical threshold (5%) must be >= warning threshold (10%)"

Scenario: Thresholds can be equal
  When setting both warning and critical to 8.0
  Then update succeeds
  And single alert level used
```

### AC-8: Overhead Allocation Method

```gherkin
Scenario: Select overhead allocation method
  Given user is Finance Manager
  When selecting overhead_allocation_method from:
    | labor_hours |
    | machine_hours |
    | units_produced |
    | none |
  Then selection saved successfully

Scenario: Labor hours allocation
  When selecting overhead_allocation_method = 'labor_hours'
  Then help text shows "Overhead allocated based on labor hours worked"

Scenario: Machine hours allocation
  When selecting overhead_allocation_method = 'machine_hours'
  Then help text shows "Overhead allocated based on machine runtime hours"

Scenario: Units produced allocation
  When selecting overhead_allocation_method = 'units_produced'
  Then help text shows "Overhead allocated based on units produced"

Scenario: No overhead allocation
  When selecting overhead_allocation_method = 'none'
  Then help text shows "Overhead not automatically allocated"
  And warning shown "Manual overhead allocation required"
```

### AC-9: Cost Center Hierarchy Configuration

```gherkin
Scenario: Configure cost center hierarchy levels
  Given user is Finance Manager
  When setting cost_center_hierarchy_levels to:
    | 1 | Flat structure (no hierarchy) |
    | 2 | Two levels (Department > Team) |
    | 3 | Three levels (Division > Department > Team) |
    | 4 | Four levels |
    | 5 | Five levels (max) |
  Then setting saved successfully

Scenario: Default hierarchy is 3 levels
  Given new organization
  When finance settings initialized
  Then cost_center_hierarchy_levels = 3

Scenario: Cannot exceed 5 levels
  When setting cost_center_hierarchy_levels = 6
  Then validation error "Maximum 5 hierarchy levels allowed"
```

### AC-10: Base Currency Configuration

```gherkin
Scenario: Set base currency to PLN
  Given currencies table has PLN currency
  When setting base_currency_id to PLN uuid
  Then setting saved successfully
  And all cost calculations use PLN as base

Scenario: Set base currency to EUR
  Given organization operates in Eurozone
  When setting base_currency_id to EUR uuid
  Then setting saved successfully
  And warning "Multi-currency transactions will convert to EUR"

Scenario: Cannot set invalid currency
  When setting base_currency_id to non-existent uuid
  Then validation error "Invalid currency ID"
```

### AC-11: Auto-Calculation Settings

```gherkin
Scenario: Enable automatic work order cost calculation
  Given user is Finance Manager
  When setting auto_calculate_wo_costs = true
  Then costs automatically calculated on WO completion
  And help text "Costs calculated when work order status = 'completed'"

Scenario: Disable automatic work order cost calculation
  When setting auto_calculate_wo_costs = false
  Then manual cost calculation required
  And help text "Finance Manager must manually trigger cost calculation"

Scenario: Enable automatic BOM cost calculation
  When setting auto_calculate_bom_costs = true
  Then BOM costs recalculated on BOM changes
  And help text "BOM costs updated when ingredients or quantities change"

Scenario: Include scrap in variance
  Given setting include_scrap_in_variance = true
  When calculating variances
  Then scrap costs included in material variance
```

### AC-12: Cost Rounding Configuration

```gherkin
Scenario: Set cost rounding decimals
  Given user is Finance Manager
  When setting cost_rounding_decimals to:
    | 2 | Round to 0.01 (cents) |
    | 3 | Round to 0.001 |
    | 4 | Round to 0.0001 (default) |
    | 5 | Round to 0.00001 |
    | 6 | Round to 0.000001 |
  Then rounding applied to all cost calculations

Scenario: Cannot set < 2 decimals
  When setting cost_rounding_decimals = 1
  Then validation error "Minimum 2 decimal places required"

Scenario: Cannot set > 6 decimals
  When setting cost_rounding_decimals = 8
  Then validation error "Maximum 6 decimal places allowed"
```

### AC-13: RLS Policy Enforcement

```gherkin
Scenario: Org isolation on settings read
  Given User A from Org A and User B from Org B
  And settings exist for both orgs
  When User A requests GET /api/finance/settings
  Then only Org A settings returned

Scenario: Cannot view settings from different org
  Given settings belong to Org B
  When User A (Org A) requests GET /api/finance/settings
  Then 404 Not Found returned

Scenario: Cannot update settings from different org
  Given settings belong to Org B
  When User A (Org A) attempts PUT /api/finance/settings
  Then 403 Forbidden returned
```

### AC-14: Audit Logging

```gherkin
Scenario: Log all settings changes
  Given finance settings exist
  When any field updated
  Then audit_log entry created with:
    | Field | Value |
    | entity_type | finance_settings |
    | entity_id | settings uuid |
    | action | update |
    | user_id | current user |
    | changes | JSON with old and new values |

Scenario: Log finance module activation
  Given finance_enabled = false
  When Finance Manager sets finance_enabled = true
  Then audit log records:
    | action | update |
    | field | finance_enabled |
    | old_value | false |
    | new_value | true |

Scenario: Log valuation method change
  Given valuation_method = 'fifo'
  When changed to 'weighted_average'
  Then audit log records method change with timestamp
  And warning generated if mid-period change
```

### AC-15: Settings Management UI

```gherkin
Scenario: Finance settings page layout
  Given user navigates to /finance/settings
  When page loads
  Then page displays sections:
    | Section | Fields |
    | Module Control | Finance Enabled toggle |
    | Valuation | Valuation Method dropdown |
    | Variance Thresholds | Warning %, Critical % |
    | Overhead Allocation | Allocation Method dropdown |
    | Cost Centers | Hierarchy Levels, Enable Budgets |
    | Currency | Base Currency selector |
    | Automation | Auto-calculate checkboxes |
    | Rounding | Decimals selector |
  And [Save Settings] button at bottom
  And [Cancel] button to discard changes

Scenario: Form validation feedback
  Given user is editing settings
  When entering invalid value (e.g., critical < warning)
  Then inline error message shown immediately
  And [Save Settings] button disabled until valid

Scenario: Confirmation on critical changes
  Given user changes valuation_method mid-period
  When clicking [Save Settings]
  Then confirmation dialog shows:
    "Changing valuation method may require inventory revaluation. Continue?"
  And [Confirm] and [Cancel] buttons

Scenario: Success notification
  Given user updates settings
  When save succeeds
  Then success toast "Finance settings updated successfully"
  And page data refreshed with new values
```

### AC-16: Performance Requirements

```gherkin
Scenario: Settings load performance
  Given finance settings exist
  When user loads /finance/settings page
  Then page loads within 500ms
  And API response time < 200ms

Scenario: Settings update performance
  Given user updates multiple fields
  When clicking [Save Settings]
  Then update completes within 300ms
  And success notification shown
```

---

## Implementation Notes

### API Endpoints

```typescript
// =============================================================================
// Finance Settings Endpoints
// =============================================================================

// GET /api/finance/settings
// Get finance settings for organization
interface GetFinanceSettingsResponse {
  settings: FinanceSettings;
}

interface FinanceSettings {
  id: string;
  org_id: string;
  finance_enabled: boolean;
  valuation_method: 'fifo' | 'weighted_average' | 'standard_cost';
  variance_warning_percent: number;
  variance_critical_percent: number;
  overhead_allocation_method: 'labor_hours' | 'machine_hours' | 'units_produced' | 'none';
  cost_center_hierarchy_levels: number;
  enable_cost_center_budgets: boolean;
  base_currency_id?: string;
  base_currency_code?: string;
  auto_calculate_wo_costs: boolean;
  auto_calculate_bom_costs: boolean;
  include_scrap_in_variance: boolean;
  cost_rounding_decimals: number;
  created_at: string;
  updated_at: string;
}

// PUT /api/finance/settings
// Update finance settings
interface UpdateFinanceSettingsRequest {
  finance_enabled?: boolean;
  valuation_method?: 'fifo' | 'weighted_average' | 'standard_cost';
  variance_warning_percent?: number;
  variance_critical_percent?: number;
  overhead_allocation_method?: 'labor_hours' | 'machine_hours' | 'units_produced' | 'none';
  cost_center_hierarchy_levels?: number;
  enable_cost_center_budgets?: boolean;
  base_currency_id?: string;
  auto_calculate_wo_costs?: boolean;
  auto_calculate_bom_costs?: boolean;
  include_scrap_in_variance?: boolean;
  cost_rounding_decimals?: number;
}

interface UpdateFinanceSettingsResponse {
  settings: FinanceSettings;
  audit_log_id: string;
}

// POST /api/finance/settings/initialize
// Initialize default finance settings for organization
interface InitializeFinanceSettingsRequest {
  base_currency_code?: string; // Default: PLN
}

interface InitializeFinanceSettingsResponse {
  settings: FinanceSettings;
  message: string;
}
```

### Validation Schemas (Zod)

```typescript
import { z } from 'zod';

export const valuationMethodEnum = z.enum(['fifo', 'weighted_average', 'standard_cost']);
export const overheadAllocationMethodEnum = z.enum(['labor_hours', 'machine_hours', 'units_produced', 'none']);

export const updateFinanceSettingsSchema = z.object({
  finance_enabled: z.boolean().optional(),
  valuation_method: valuationMethodEnum.optional(),
  variance_warning_percent: z.number()
    .min(0, 'Warning threshold must be >= 0')
    .max(100, 'Warning threshold must be <= 100')
    .optional(),
  variance_critical_percent: z.number()
    .min(0, 'Critical threshold must be >= 0')
    .max(100, 'Critical threshold must be <= 100')
    .optional(),
  overhead_allocation_method: overheadAllocationMethodEnum.optional(),
  cost_center_hierarchy_levels: z.number()
    .int('Hierarchy levels must be an integer')
    .min(1, 'Minimum 1 hierarchy level')
    .max(5, 'Maximum 5 hierarchy levels')
    .optional(),
  enable_cost_center_budgets: z.boolean().optional(),
  base_currency_id: z.string().uuid('Invalid currency ID').optional(),
  auto_calculate_wo_costs: z.boolean().optional(),
  auto_calculate_bom_costs: z.boolean().optional(),
  include_scrap_in_variance: z.boolean().optional(),
  cost_rounding_decimals: z.number()
    .int('Rounding decimals must be an integer')
    .min(2, 'Minimum 2 decimal places')
    .max(6, 'Maximum 6 decimal places')
    .optional(),
}).refine(
  (data) => {
    if (data.variance_warning_percent !== undefined && data.variance_critical_percent !== undefined) {
      return data.variance_critical_percent >= data.variance_warning_percent;
    }
    return true;
  },
  {
    message: 'Critical threshold must be >= warning threshold',
    path: ['variance_critical_percent'],
  }
);

export const initializeFinanceSettingsSchema = z.object({
  base_currency_code: z.string().length(3, 'Currency code must be 3 characters').default('PLN'),
});
```

### Service Layer

```typescript
// lib/services/finance-settings-service.ts

export class FinanceSettingsService {
  /**
   * Get finance settings for organization
   */
  static async get(orgId: string): Promise<FinanceSettings | null> {
    // Query finance_settings with base_currency join
    // Return null if not found
  }

  /**
   * Update finance settings
   */
  static async update(
    orgId: string,
    input: UpdateFinanceSettingsInput,
    userId: string
  ): Promise<FinanceSettings> {
    // Validate input
    // Check permissions
    // Update finance_settings
    // Audit log automatically created by trigger
    // Return updated settings
  }

  /**
   * Initialize default finance settings for new organization
   */
  static async initialize(
    orgId: string,
    userId: string,
    currencyCode: string = 'PLN'
  ): Promise<FinanceSettings> {
    // Check if settings already exist
    // Get currency ID for currencyCode
    // Call initialize_finance_settings() database function
    // Return created settings
  }

  /**
   * Check if finance module is enabled
   */
  static async isEnabled(orgId: string): Promise<boolean> {
    // Quick check for finance_enabled flag
    // Used by middleware to block access if disabled
  }

  /**
   * Validate settings changes (business logic)
   */
  static async validateUpdate(
    current: FinanceSettings,
    updates: UpdateFinanceSettingsInput
  ): Promise<{ valid: boolean; warnings: string[] }> {
    // Check for mid-period valuation method change
    // Warn if disabling finance module with active data
    // Return validation result with warnings
  }
}
```

### Frontend Components

```
apps/frontend/app/(authenticated)/finance/
  settings/
    page.tsx                       -- Finance settings management page

components/finance/settings/
  FinanceSettingsForm.tsx          -- Main settings form
  ValuationMethodSelector.tsx      -- Valuation method dropdown with help text
  VarianceThresholdInputs.tsx      -- Warning/Critical threshold inputs
  OverheadAllocationSelector.tsx   -- Overhead method selector
  CostCenterHierarchyConfig.tsx    -- Hierarchy levels config
  CurrencySelector.tsx             -- Base currency selector
  AutoCalculationToggles.tsx       -- Auto-calc checkboxes
  RoundingDecimalsSelector.tsx     -- Rounding decimals dropdown
```

---

## Key Business Rules

1. **Unique Settings per Org**: Only one finance_settings record per organization
2. **Critical >= Warning**: Critical threshold must always be >= warning threshold
3. **Hierarchy Levels**: 1-5 levels only, default 3
4. **Rounding Decimals**: 2-6 decimals, default 4
5. **Finance Disabled by Default**: New orgs must explicitly enable finance module
6. **PLN Default Currency**: Polish organizations default to PLN
7. **Valuation Method Consistency**: Mid-period changes require revaluation
8. **Permission Required**: Only admin and finance_manager can update settings
9. **Audit All Changes**: Every settings update logged to audit_log
10. **FIFO Default**: Default valuation method is FIFO for compliance

---

## Deliverables

### Database
- [ ] Migration: `finance_settings` table with all columns
- [ ] Function: `initialize_finance_settings(org_id, user_id)`
- [ ] Function: `validate_finance_settings_update()` trigger
- [ ] Function: `log_finance_settings_changes()` trigger
- [ ] RLS policies for finance_settings
- [ ] Performance indexes

### API Routes
- [ ] `GET /api/finance/settings` - Get org settings
- [ ] `PUT /api/finance/settings` - Update settings
- [ ] `POST /api/finance/settings/initialize` - Initialize defaults

### Service Layer
- [ ] `FinanceSettingsService.get()` - Get settings
- [ ] `FinanceSettingsService.update()` - Update settings
- [ ] `FinanceSettingsService.initialize()` - Initialize defaults
- [ ] `FinanceSettingsService.isEnabled()` - Check if enabled
- [ ] `FinanceSettingsService.validateUpdate()` - Validate changes

### Validation
- [ ] `updateFinanceSettingsSchema`
- [ ] `initializeFinanceSettingsSchema`

### Frontend
- [ ] Finance settings page
- [ ] Valuation method selector
- [ ] Variance threshold inputs
- [ ] Overhead allocation selector
- [ ] Cost center hierarchy config
- [ ] Currency selector
- [ ] Auto-calculation toggles
- [ ] Success/error notifications

### Tests
- [ ] Unit tests: FinanceSettingsService methods (>80% coverage)
- [ ] Integration tests: All API endpoints
- [ ] Validation tests: All constraint checks
- [ ] RLS tests: Multi-tenancy isolation
- [ ] E2E: Settings CRUD workflow

---

## Definition of Done

### Database
- [ ] `finance_settings` table created with all columns
- [ ] All CHECK constraints enforced
- [ ] RLS policies enforce org isolation
- [ ] Triggers for updated_at and audit logging work
- [ ] Initialize function creates correct defaults

### API
- [ ] All endpoints return correct HTTP status codes
- [ ] Validation errors return 400 with detailed messages
- [ ] Cross-tenant access returns 403/404
- [ ] Response times:
  - Get settings: < 200ms
  - Update settings: < 300ms

### Service
- [ ] Get settings works with currency join
- [ ] Update validates and saves correctly
- [ ] Initialize creates defaults with PLN currency
- [ ] isEnabled check performs quickly
- [ ] Audit logging works for all changes

### Frontend
- [ ] Settings page loads correctly
- [ ] All form fields functional
- [ ] Validation feedback immediate
- [ ] Confirmation on critical changes
- [ ] Success/error notifications shown
- [ ] Form state managed correctly

### Testing
- [ ] Unit tests: >80% coverage on service
- [ ] Integration tests: All endpoints covered
- [ ] RLS tests: Multi-tenancy verified
- [ ] E2E tests: Full CRUD workflow passing

---

## Risk Assessment

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Mid-period valuation method change | HIGH | LOW | Validation warning, confirmation dialog, audit log |
| Invalid threshold configuration | MEDIUM | MEDIUM | CHECK constraints, form validation, help text |
| Permission misconfiguration | HIGH | LOW | RLS policies, role checks, comprehensive tests |
| Currency reference invalid | MEDIUM | LOW | FK constraint, validation, default to PLN |
| Settings not initialized | MEDIUM | LOW | Initialize function, onboarding workflow |

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-01-15 | Initial story creation for Epic 09 Phase 1 | ARCHITECT |

---

**Document Status**: Ready for Implementation
**Created**: 2025-01-15
**Lines**: ~850
**Complexity**: S (Small - 1-2 days)
**Phase**: 1 (Foundation)
