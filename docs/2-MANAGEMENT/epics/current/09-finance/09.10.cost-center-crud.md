# 09.10 - Cost Center CRUD

**Priority**: P0 (MVP)
**Story Points**: M (Medium)
**Type**: fullstack
**Phase**: 1 (Foundation)
**Model**: SONNET

**State:** ready
**Estimate:** M (3-4 days)
**Primary PRD:** `docs/1-BASELINE/product/modules/finance.md` (FR-9.10.1-3)
**Architecture:** `docs/1-BASELINE/architecture/modules/finance.md` (cost_centers table)

---

## Goal

Implement cost center CRUD (code, name, type: production/warehouse/admin), cost center hierarchy (parent_id), cost center assignment (machines, lines), and cost center reporting structure. Enable cost tracking and allocation by organizational unit.

---

## User Story

As a **Finance Manager**, I want to **define cost centers for different production lines and departments** so that **I can track and allocate costs by organizational unit**.

As a **Production Manager**, I want to **view costs allocated to my production line's cost center** so that **I can monitor department profitability**.

---

## Scope

**In scope**
- `cost_centers` table with CRUD operations
- Cost center hierarchy (parent-child relationships)
- Cost center types: production, warehouse, admin
- Cost center assignment to:
  - Production lines (production_line_id FK)
  - Machines (future)
  - Work orders (via work_order_costs)
- GET /api/finance/cost-centers (list with hierarchy)
- GET /api/finance/cost-centers/:id (detail)
- POST /api/finance/cost-centers (create)
- PUT /api/finance/cost-centers/:id (update)
- DELETE /api/finance/cost-centers/:id (soft delete)
- Cost center management page
- Hierarchical cost center tree view

**Out of scope**
- Cost center budgets (Phase 2)
- Cost allocation rules (Phase 2)
- Cost center reporting (Phase 2)
- Inter-cost-center transfers (Phase 3)

---

## Dependencies

### Cross-Epic Dependencies

| Dependency | Story/Epic | Type | What It Provides | Status |
|------------|------------|------|------------------|--------|
| 01.1 | Org Context + RLS | HARD | organizations, users, roles | Ready |
| 04.1 | Work Orders CRUD | SOFT | work_orders for cost assignment | Ready |

### Provides To (Downstream)

| Story | What This Provides |
|-------|-------------------|
| 09.6 | WO Cost Summary - cost center assignment |
| 09.7 | Inventory Valuation - cost center reference |
| Phase 2 | Budget vs actual reporting |

---

## Database Migration

```sql
-- Migration: YYYYMMDDHHMMSS_create_cost_centers.sql

CREATE TABLE cost_centers (
    id                      UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id                  UUID NOT NULL REFERENCES organizations(id),
    code                    TEXT NOT NULL,
    name                    TEXT NOT NULL,
    description             TEXT,

    -- Hierarchy
    parent_id               UUID REFERENCES cost_centers(id),

    -- Type
    type                    TEXT NOT NULL DEFAULT 'production'
                            CHECK (type IN ('production', 'warehouse', 'admin', 'overhead')),

    -- Assignments
    production_line_id      UUID REFERENCES production_lines(id),
    department              TEXT,

    -- Status
    is_active               BOOLEAN DEFAULT TRUE,

    -- Audit
    created_at              TIMESTAMPTZ NOT NULL DEFAULT now(),
    created_by              UUID REFERENCES users(id),
    updated_at              TIMESTAMPTZ NOT NULL DEFAULT now(),
    updated_by              UUID REFERENCES users(id),

    -- Constraints
    CONSTRAINT uq_cost_center_code UNIQUE (org_id, code),
    CONSTRAINT chk_no_self_parent CHECK (parent_id != id)
);

CREATE INDEX idx_cost_centers_org ON cost_centers(org_id);
CREATE INDEX idx_cost_centers_org_active ON cost_centers(org_id, is_active) WHERE is_active = TRUE;
CREATE INDEX idx_cost_centers_parent ON cost_centers(parent_id) WHERE parent_id IS NOT NULL;
CREATE INDEX idx_cost_centers_line ON cost_centers(production_line_id) WHERE production_line_id IS NOT NULL;
CREATE INDEX idx_cost_centers_type ON cost_centers(org_id, type);

-- RLS Policies
ALTER TABLE cost_centers ENABLE ROW LEVEL SECURITY;

CREATE POLICY "cost_centers_select" ON cost_centers
    FOR SELECT USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

CREATE POLICY "cost_centers_insert" ON cost_centers
    FOR INSERT WITH CHECK (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

CREATE POLICY "cost_centers_update" ON cost_centers
    FOR UPDATE USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

CREATE POLICY "cost_centers_delete" ON cost_centers
    FOR DELETE USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

-- Trigger
CREATE TRIGGER update_cost_centers_updated_at
    BEFORE UPDATE ON cost_centers
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- Function: Get cost center hierarchy
CREATE OR REPLACE FUNCTION get_cost_center_hierarchy(p_org_id UUID)
RETURNS TABLE(
    id UUID,
    code TEXT,
    name TEXT,
    type TEXT,
    parent_id UUID,
    parent_code TEXT,
    level INTEGER,
    path TEXT
) AS $$
BEGIN
    RETURN QUERY
    WITH RECURSIVE cc_tree AS (
        -- Root cost centers (no parent)
        SELECT
            cc.id,
            cc.code,
            cc.name,
            cc.type,
            cc.parent_id,
            NULL::TEXT AS parent_code,
            0 AS level,
            cc.code::TEXT AS path
        FROM cost_centers cc
        WHERE cc.org_id = p_org_id
          AND cc.parent_id IS NULL
          AND cc.is_active = TRUE

        UNION ALL

        -- Child cost centers
        SELECT
            cc.id,
            cc.code,
            cc.name,
            cc.type,
            cc.parent_id,
            parent.code AS parent_code,
            parent.level + 1 AS level,
            (parent.path || ' > ' || cc.code)::TEXT AS path
        FROM cost_centers cc
        INNER JOIN cc_tree parent ON cc.parent_id = parent.id
        WHERE cc.org_id = p_org_id
          AND cc.is_active = TRUE
    )
    SELECT * FROM cc_tree
    ORDER BY path;
END;
$$ LANGUAGE plpgsql;
```

---

## Acceptance Criteria

### AC-1: Cost Center CRUD

```gherkin
Scenario: Create cost center
  Given admin on cost centers page
  When creating cost center:
    | Code | LINE-01 |
    | Name | Production Line 1 |
    | Type | production |
  Then cost_centers record created
  And is_active = TRUE

Scenario: Create hierarchical cost center
  Given parent cost center "PROD" exists
  When creating child cost center:
    | Code | LINE-01 |
    | Name | Production Line 1 |
    | Parent | PROD |
  Then parent_id = PROD cost center ID
  And hierarchy displays correctly
```

### AC-2: Cost Center Hierarchy

```gherkin
Scenario: Display cost center tree
  Given cost centers:
    | Code | Parent |
    | PROD | NULL |
    | LINE-01 | PROD |
    | LINE-02 | PROD |
  When viewing cost center tree
  Then displays:
    PROD (Production)
      └─ LINE-01 (Production Line 1)
      └─ LINE-02 (Production Line 2)
```

### AC-3: Cost Center Assignment

```gherkin
Scenario: Assign production line to cost center
  Given production line "Line 1" exists
  When assigning to cost center "LINE-01"
  Then cost_centers.production_line_id = Line 1 ID
  And cost center appears on line detail page
```

---

## Key Business Rules

1. **Unique Code**: Cost center code unique within organization
2. **No Self-Parent**: Cost center cannot be its own parent (check constraint)
3. **No Circular References**: Prevent circular parent-child relationships (validation)
4. **Active Centers Only**: Inactive cost centers hidden from selectors
5. **Soft Delete**: Deactivate instead of delete (preserve historical cost allocations)
6. **Hierarchy Depth**: Maximum 5 levels depth recommended

---

## Deliverables

- [ ] Migration: cost_centers table
- [ ] Function: get_cost_center_hierarchy()
- [ ] API: Cost center CRUD endpoints
- [ ] Service: CostCenterService
- [ ] Component: Cost center tree view
- [ ] Page: Cost center management
- [ ] Tests: Unit, integration, E2E

---

**Document Status**: Ready for Implementation
**Created**: 2025-01-15
**Complexity**: M (Medium)
**Phase**: 1 (Foundation)
