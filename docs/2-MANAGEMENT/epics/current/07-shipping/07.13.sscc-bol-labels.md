# 07.13 - SSCC Generation + BOL + Shipping Labels

**Priority**: P0 (MVP Core - Compliance)
**Complexity**: L (4-5 days)
**Type:** backend + frontend
**Phase:** 1C (After Story 07.11 - Packing Station)

**State:** ready
**Primary PRD:** `docs/1-BASELINE/product/modules/shipping.md` (FR-7.38, FR-7.39, FR-7.40, FR-7.41)
**Architecture:** `docs/1-BASELINE/architecture/modules/shipping.md` (lines 189-191, 209-219, 444-447, 1035-1072)

---

## MVP Scope

This story implements GS1-compliant SSCC generation, Bill of Lading (BOL) PDF generation, shipping label printing (ZPL format), and packing slip generation. This is a **compliance-critical** story for food manufacturing traceability.

**What's IN scope:**
- GS1 SSCC-18 generation with MOD 10 check digit
- POST /api/shipping/shipments/:id/generate-sscc endpoint
- POST /api/shipping/shipments/:id/generate-bol endpoint
- POST /api/shipping/shipments/:id/print-labels endpoint
- POST /api/shipping/shipments/:id/print-packing-slip endpoint
- SSCC label preview component (barcode + metadata)
- BOL preview component (PDF viewer in modal)
- ZPL label format for Zebra printers
- PDF fallback for non-Zebra printers
- GS1 Company Prefix configuration in org settings
- SSCC uniqueness enforcement (global, not just org-scoped)
- Check digit validation (MOD 10 algorithm)

**What's OUT of scope (deferred to other stories/phases):**
- GS1 EDI ASN 856 (Epic 11 Integrations)
- Multi-shipment BOL (Phase 2)
- Custom label templates (Phase 2)
- Carrier-specific label generation via API (Story 07.26)
- Rate shopping integration (Phase 3)
- Advanced Shipping Notice automation (Phase 2)

---

## Dependencies

### Epic Dependencies
- **Epic 01.1** - Organizations, RLS, users, roles (HARD)
- **Epic 01.7** - Organization settings (HARD - GS1 Company Prefix storage)
- **Epic 02.1** - Products (HARD)
- **Epic 02.3** - Allergens (for packing slip warnings) (SOFT)

### Story Dependencies (within Epic 07)
- **07.1** - Customers CRUD (provides customers table)
- **07.2** - Customer Contacts + Addresses (provides customer_addresses table)
- **07.3** - Sales Orders CRUD (provides sales_orders table)
- **07.11** - Packing Station + Shipment Creation (provides shipments, shipment_boxes, shipment_box_contents tables) **[BLOCKER]**

### Provides To
- **07.14** - Shipment + Ship Confirm (consumes SSCC-labeled shipments with BOL)
- **07.15** - Shipping Dashboard (displays SSCC label print success metrics)
- **Epic 11** - Integrations (SSCC data for EDI ASN 856)

---

## Goal

Enable warehouse staff to generate GS1-compliant SSCC barcodes for all shipment boxes, generate professional BOL documents, and print shipping labels in ZPL format for Zebra printers, ensuring full traceability and regulatory compliance for food manufacturing shipments.

## User Story

As a **warehouse packer**, I want to **generate SSCC barcodes for each box, print shipping labels, and generate a BOL** so that **shipments are properly identified with industry-standard barcodes and documentation for carrier handoff and regulatory traceability**.

## Scope

**In scope (this story)**
- GS1 SSCC-18 generation algorithm with MOD 10 check digit
- SSCC storage in shipment_boxes.sscc (UNIQUE constraint)
- generate-sscc endpoint (idempotent - only generates for NULL sscc)
- generate-bol endpoint with PDF generation (pdfmake library)
- print-labels endpoint with ZPL output (bwip-js for GS1-128)
- print-packing-slip endpoint with PDF output
- SSCC label preview component with barcode visualization
- BOL preview with PDF.js viewer
- Packing slip PDF with line items, lot numbers, allergen warnings
- GS1 Company Prefix stored in organizations.gs1_company_prefix
- SSCC sequence counter in organizations.next_sscc_sequence
- Barcode generation service (bwip-js for GS1-128)
- PDF generation service (pdfmake for BOL and packing slip)
- ZPL generation service for Zebra printer labels
- Label format selection (4x6" standard, 4x8" pallet)
- RLS policies for multi-tenant isolation

**Out of scope (this story)**
- EDI ASN 856 generation (Epic 11)
- Carrier API integration for labels (Story 07.26)
- Multi-shipment consolidated BOL (Phase 2)
- Custom label template designer (Phase 2)
- Rate shopping (Phase 3)

---

## Acceptance Criteria (Given/When/Then)

### AC-1: Generate SSCC for All Boxes

**Given** a shipment with status = 'packed' and 3 boxes without SSCC
**When** the user clicks "Generate SSCC" button
**Then** the system calls POST /api/shipping/shipments/:id/generate-sscc
**And** generates unique SSCC-18 for each box using:
- Extension digit: 0 (carton) or 9 (pallet)
- GS1 Company Prefix from organizations.gs1_company_prefix (7-10 digits)
- Serial Reference from organizations.next_sscc_sequence (padded to fill 17 digits)
- Check digit calculated using MOD 10 algorithm
**And** updates shipment_boxes.sscc for each box
**And** increments organizations.next_sscc_sequence by box count
**And** displays success message: "3 SSCC codes generated successfully"

### AC-2: SSCC Format Validation

**Given** an organization with GS1 Company Prefix = "0614141"
**And** next_sscc_sequence = 12345
**When** SSCC is generated for a carton (extension = 0)
**Then** the SSCC format is: 0 0614141 000012345 C
- Where C = MOD 10 check digit
- Total: 18 digits (1 extension + 7-10 prefix + 6-9 serial + 1 check)
**And** the SSCC is globally unique (no duplicate in any org)

### AC-3: Idempotent SSCC Generation

**Given** a shipment with 3 boxes where Box 1 and Box 2 already have SSCC
**And** Box 3 has sscc = NULL
**When** the user clicks "Generate SSCC"
**Then** the system only generates SSCC for Box 3
**And** does not regenerate SSCC for Box 1 and Box 2
**And** displays message: "1 SSCC code generated (2 already exist)"

### AC-4: MOD 10 Check Digit Calculation

**Given** an SSCC base of 17 digits: "00614141000012345"
**When** the check digit is calculated
**Then** the algorithm applies:
1. Starting from rightmost digit, multiply odd positions by 3, even by 1
2. Sum all products
3. Check digit = (10 - (sum % 10)) % 10
**And** the result is appended to form 18-digit SSCC
**And** validateSSCC(sscc) returns true for valid check digits

### AC-5: Generate BOL PDF

**Given** a shipment with status = 'packed' and all boxes have SSCC
**When** the user clicks "Generate BOL" button
**Then** the system calls POST /api/shipping/shipments/:id/generate-bol
**And** generates a PDF containing:

**Header:**
- BOL Number: BOL-{shipment_number}
- Date: current date
- Carrier: shipments.carrier (if assigned)
- Pro Number: shipments.tracking_number (if available)

**Shipper Section:**
- Organization name, address, phone, email (from organizations + locations)

**Consignee Section:**
- Customer name, address, phone (from customer_addresses)

**Freight Details Table:**
| Item # | SSCC Barcode | Weight (kg) | Dimensions | Freight Class | NMFC |
| 1 | 00123456789012345678 | 48.5 | 60x40x30 cm | 65 | 1234 |

**Totals:**
- Total Cartons: COUNT(shipment_boxes)
- Total Weight: SUM(shipment_boxes.weight)
- Declared Value: calculated from SO lines

**Product Summary (by carton):**
- Per carton: products with lot numbers and BBD

**Signature Section:**
- Shipper signature/date placeholder
- Carrier signature/date placeholder

**And** stores PDF in Supabase Storage at `bol/{org_id}/{shipment_id}.pdf`
**And** returns download URL in response

### AC-6: Print Shipping Labels (ZPL Format)

**Given** a shipment with all boxes having SSCC
**When** the user clicks "Print Labels" button
**Then** the system calls POST /api/shipping/shipments/:id/print-labels
**And** generates ZPL code for each box containing:
```zpl
^XA
^FO50,50^BY3^BCN,100,Y,N,N^FD00123456789012345678^FS
^FO50,180^A0N,30,30^FD00 1234 5678 9012 3456 78^FS
^FO50,230^A0N,25,25^FDSHIP TO:^FS
^FO50,260^A0N,25,25^FDBlue Mountain Restaurant^FS
^FO50,290^A0N,25,25^FD789 Main Street^FS
^FO50,320^A0N,25,25^FDDenver, CO 80210^FS
^FO50,370^A0N,25,25^FDORDER: SO-2025-00123^FS
^FO50,400^A0N,25,25^FDBOX: 1 of 3^FS
^FO50,430^A0N,25,25^FDWEIGHT: 48.5 kg^FS
^XZ
```
**And** returns ZPL string array for all boxes
**And** UI can send ZPL to Zebra printer via browser print API or network socket

### AC-7: SSCC Label Preview Component

**Given** a shipment box with SSCC = "00123456789012345678"
**When** the user views the SSCC label preview
**Then** the system displays:
- GS1-128 barcode image (rendered with bwip-js)
- Human-readable SSCC: "00 1234 5678 9012 3456 78" (formatted with spaces)
- Ship To address block
- Sales order number
- Box X of Y identifier
- Weight in kg
- Handling instructions (if applicable)
**And** user can toggle between label sizes: 4x6" (carton) and 4x8" (pallet)

### AC-8: Generate Packing Slip PDF

**Given** a shipment with packed boxes and line items
**When** the user clicks "Print Packing Slip" button
**Then** the system calls POST /api/shipping/shipments/:id/print-packing-slip
**And** generates a PDF containing:

**Header:**
- "PACKING SLIP" title
- Sales Order Number, Shipment Number
- Date, Tracking Number

**Ship To / Ship From:**
- Customer address (ship to)
- Warehouse address (ship from)

**Line Items Table:**
| Line # | Product | Qty Ordered | Qty Shipped | Backorder | Lot # | BBD |
| 1 | Organic Flour 5lb | 100 | 100 | 0 | LOT-2024-001 | 2025-06-30 |

**Carton Summary:**
- Box X of Y, SSCC, Weight, Dimensions

**Special Instructions:**
- Customer notes from SO
- Temperature handling requirements
- Allergen warnings (if applicable)

**Signature Section:**
- Shipped By / Date
- Received By / Date

**And** stores PDF in Supabase Storage
**And** returns download URL

### AC-9: GS1 Company Prefix Configuration

**Given** an organization without GS1 Company Prefix configured
**When** the user attempts to generate SSCC
**Then** the system returns error: "GS1 Company Prefix not configured"
**And** displays message with link to Organization Settings
**And** blocks SSCC generation until prefix is configured

### AC-10: SSCC Uniqueness Enforcement

**Given** two organizations (Org A and Org B)
**When** both attempt to generate SSCC at the same time
**Then** the system ensures globally unique SSCC numbers
**And** uses database transaction with SELECT FOR UPDATE on next_sscc_sequence
**And** enforces UNIQUE constraint on shipment_boxes.sscc across all orgs
**And** handles concurrent requests without duplicate SSCC

### AC-11: Check Digit Validation Service

**Given** an SSCC number "00614141000012346"
**When** the system validates the check digit
**Then** the validateSSCC function returns:
- true if check digit is correct
- false if check digit is incorrect
**And** recalculateCheckDigit("0061414100001234") returns the correct check digit
**And** test coverage for check digit calculation is >95%

### AC-12: BOL Preview Modal

**Given** a generated BOL PDF
**When** the user clicks "Preview BOL" button
**Then** the system displays a modal with:
- PDF.js viewer rendering the BOL
- Zoom controls (50%, 75%, 100%, 125%, 150%)
- Print button
- Download button
- Email button (opens email modal)
- Close button

### AC-13: RLS Policy for Document Storage

**Given** two organizations (Org A and Org B) with stored PDFs
**When** a user from Org A requests BOL for Org B's shipment
**Then** the system returns 403 Forbidden
**And** Supabase Storage policies enforce org_id path prefix
**And** signed URLs include org_id verification

---

## Technical Design

### ADR-1: SSCC Structure Decision

**Context:** SSCC-18 requires Extension Digit (1) + GS1 Prefix (7-10) + Serial (6-9) + Check (1) = 18 total

**Decision:** Use Extension Digit 0 for cartons, 9 for pallets. Serial Reference is a global counter per org.

**Rationale:** Extension digit signals packaging level. Global counter ensures uniqueness without complex coordination.

### ADR-2: SSCC Uniqueness Strategy

**Context:** SSCC must be globally unique, not just within org.

**Decision:** Combine org's GS1 Company Prefix (assigned by GS1, guaranteed unique) with org-scoped serial counter.

**Rationale:** GS1 prefix ensures cross-org uniqueness. Within org, atomic counter increment prevents duplicates.

### ADR-3: PDF Library Selection

**Options:**
| Library | Pros | Cons |
|---------|------|------|
| pdfmake | Pure JS, no dependencies, declarative API | Limited styling options |
| jsPDF | Popular, HTML to PDF support | Larger bundle size |
| puppeteer | Full HTML/CSS support | Heavy, requires Chrome headless |

**Decision:** Use pdfmake for BOL and packing slip generation.

**Rationale:** Lightweight, works in Edge Functions, declarative syntax fits structured documents.

### ADR-4: Label Format Decision

**Decision:** Use ZPL (Zebra Programming Language) as primary format, PDF as fallback.

**Rationale:** ZPL is industry standard for Zebra printers (90%+ of warehouse label printers). PDF provides universal fallback.

### ADR-5: Barcode Library Selection

**Options:**
| Library | Pros | Cons |
|---------|------|------|
| bwip-js | Supports GS1-128, pure JS | Complex API |
| jsbarcode | Simple API | Limited GS1 support |

**Decision:** Use bwip-js for GS1-128 barcode generation.

**Rationale:** Full GS1 Application Identifier support, including FNC1 character for GS1-128 compliance.

---

## SSCC Generation Algorithm

### MOD 10 Check Digit Calculation (Pseudocode)

```typescript
/**
 * Calculate GS1 MOD 10 check digit
 * @param digits - 17-digit string (extension + prefix + serial)
 * @returns single character check digit (0-9)
 */
function calculateGS1CheckDigit(digits: string): string {
  if (digits.length !== 17) {
    throw new Error('SSCC base must be exactly 17 digits');
  }

  let sum = 0;
  for (let i = 0; i < digits.length; i++) {
    const digit = parseInt(digits[i], 10);
    // Positions from right: odd positions multiply by 3, even by 1
    // Since we're iterating left-to-right on 17 digits:
    // Position 0 (leftmost) is position 17 from right (odd) -> multiply by 3
    const multiplier = (digits.length - i) % 2 === 0 ? 1 : 3;
    sum += digit * multiplier;
  }

  const checkDigit = (10 - (sum % 10)) % 10;
  return checkDigit.toString();
}

/**
 * Generate full SSCC-18
 * @param gs1Prefix - GS1 Company Prefix (7-10 digits)
 * @param serial - Serial reference number
 * @param extension - Extension digit (0=carton, 9=pallet)
 */
function generateSSCC(
  gs1Prefix: string,
  serial: number,
  extension: '0' | '9' = '0'
): string {
  // Validate GS1 prefix length
  if (gs1Prefix.length < 7 || gs1Prefix.length > 10) {
    throw new Error('GS1 prefix must be 7-10 digits');
  }

  // Calculate serial padding (17 total = 1 ext + prefix + serial)
  const serialLength = 17 - 1 - gs1Prefix.length;
  const paddedSerial = serial.toString().padStart(serialLength, '0');

  // Check serial doesn't exceed length
  if (paddedSerial.length > serialLength) {
    throw new Error('Serial reference overflow');
  }

  // Build base (17 digits)
  const base = extension + gs1Prefix + paddedSerial;

  // Calculate and append check digit
  const checkDigit = calculateGS1CheckDigit(base);

  return base + checkDigit;
}

/**
 * Validate SSCC-18 check digit
 */
function validateSSCC(sscc: string): boolean {
  if (!/^\d{18}$/.test(sscc)) return false;

  const base = sscc.substring(0, 17);
  const expectedCheck = calculateGS1CheckDigit(base);
  const actualCheck = sscc.charAt(17);

  return expectedCheck === actualCheck;
}

/**
 * Format SSCC with spaces for human readability
 */
function formatSSCC(sscc: string): string {
  // Format: 00 1234 5678 9012 3456 78
  return sscc.replace(/(\d{2})(\d{4})(\d{4})(\d{4})(\d{4})(\d{2})/, '$1 $2 $3 $4 $5 $6');
}
```

### Check Digit Example Calculation

```
SSCC Base: 0 0614141 000012345 (17 digits)

Position:  17 16 15 14 13 12 11 10  9  8  7  6  5  4  3  2  1
Digit:      0  0  6  1  4  1  4  1  0  0  0  0  1  2  3  4  5
Multiplier: 3  1  3  1  3  1  3  1  3  1  3  1  3  1  3  1  3
Product:    0  0 18  1 12  1 12  1  0  0  0  0  3  2  9  4 15

Sum = 0+0+18+1+12+1+12+1+0+0+0+0+3+2+9+4+15 = 78
Check = (10 - (78 % 10)) % 10 = (10 - 8) % 10 = 2

Full SSCC: 00614141000012345 + 2 = 006141410000123452
```

---

## BOL Template (ASCII Mockup)

```
+==============================================================================+
|                           BILL OF LADING                                      |
|                                                                               |
| BOL #: BOL-SH-2025-00123              Date: 2025-01-15                       |
| Carrier: DHL Freight                   Pro #: 1Z999AA10012345678             |
+==============================================================================+
|                                                                               |
| SHIPPER:                              | CONSIGNEE (SHIP TO):                 |
| MonoPilot Foods                       | Blue Mountain Restaurant             |
| 456 Industrial Blvd                   | Attn: John Smith                     |
| Denver, CO 80202, USA                 | 789 Main Street                      |
| Phone: (303) 555-5678                 | Denver, CO 80210, USA                |
| Email: shipping@monopilot.com         | Phone: (303) 555-1234                |
|                                       |                                       |
+---------------------------------------+---------------------------------------+
|                                                                               |
| SPECIAL INSTRUCTIONS:                                                         |
| - Handle with care - Perishable items                                         |
| - Keep refrigerated at 2-8°C (35-46°F)                                        |
| - Do not stack - Fragile items                                                |
|                                                                               |
+==============================================================================+
| FREIGHT TERMS: Prepaid              | PAYMENT TERMS: Due upon receipt        |
+==============================================================================+
|                                                                               |
| SHIPMENT DETAILS:                                                             |
+------+----------------------+----------+-------------------+--------+--------+
| Item | SSCC Barcode         | Weight   | Dimensions (LxWxH)| Freight| NMFC   |
|  #   |                      | (kg)     | (cm)              | Class  | Code   |
+------+----------------------+----------+-------------------+--------+--------+
|  1   | 00123456789012345678 |    48.5  | 60 x 40 x 30      |   65   |  1234  |
|  2   | 00123456789012345686 |    42.3  | 60 x 40 x 25      |   65   |  1234  |
+------+----------------------+----------+-------------------+--------+--------+
|                                                                               |
| TOTALS: 2 cartons / 0 pallets | Total Weight: 90.8 kg                        |
|         Declared Value: $3,738.75 USD                                         |
|                                                                               |
+==============================================================================+
|                                                                               |
| PRODUCT SUMMARY:                                                              |
|                                                                               |
| Carton 1 (SSCC: 00123456789012345678):                                       |
|   - Organic Flour 5lb (Lot: FLOUR-2024-001, BBD: 2025-06-30) x 100 units     |
|   - Butter 2kg Block (Lot: BUTT-2024-022, BBD: 2025-04-15) x 12 units        |
|                                                                               |
| Carton 2 (SSCC: 00123456789012345686):                                       |
|   - Organic Sugar 10lb (Lot: SUGAR-2024-045, BBD: 2025-12-31) x 50 units     |
|   - Butter 2kg Block (Lot: BUTT-2024-022, BBD: 2025-04-15) x 13 units        |
|                                                                               |
+==============================================================================+
|                                                                               |
| SHIPPER SIGNATURE:                    | CARRIER SIGNATURE:                    |
|                                       |                                       |
| Signature: __________________________ | Signature: __________________________ |
| Name:      __________________________ | Name:      __________________________ |
| Title:     __________________________ | Title:     __________________________ |
| Date:      __________________________ | Date:      __________________________ |
|                                       |                                       |
+---------------------------------------+---------------------------------------+
|                                                                               |
| RETURN BOL TO: shipping@monopilot.com                                         |
| Document ID: BOL-SH-2025-00123 | Generated: 2025-01-15 14:30 | Page 1 of 1   |
|                                                                               |
+==============================================================================+
```

---

## ZPL Label Template

```zpl
^XA
^CF0,30
^LH0,0

; GS1-128 SSCC Barcode
^FO50,50^BY3
^BCN,150,Y,N,N
^FD>800123456789012345678^FS

; Human-readable SSCC
^FO50,230
^A0N,35,35
^FDSSCC: 00 1234 5678 9012 3456 78^FS

; Separator line
^FO50,280^GB700,3,3^FS

; Ship To Header
^FO50,300
^A0N,25,25
^FDSHIP TO:^FS

; Customer Name
^FO50,340
^A0N,40,40
^FDBlue Mountain Restaurant^FS

; Address Line 1
^FO50,390
^A0N,30,30
^FD789 Main Street^FS

; City, State, Zip
^FO50,430
^A0N,30,30
^FDDenver, CO 80210^FS

; Separator line
^FO50,480^GB700,3,3^FS

; Order Info
^FO50,500
^A0N,25,25
^FDPO #: PO-2025-4521^FS

^FO400,500
^A0N,25,25
^FDORDER: SO-2025-00123^FS

; Box Info
^FO50,540
^A0N,30,30
^FDBOX: 1 of 2^FS

^FO400,540
^A0N,30,30
^FDWEIGHT: 48.5 kg^FS

; Separator line
^FO50,590^GB700,3,3^FS

; Special Instructions
^FO50,610
^A0N,25,25
^FDKeep Refrigerated (2-8°C)^FS

^FO50,650
^A0N,25,25
^FDFragile - Handle with Care^FS

^XZ
```

---

## Implementation Notes

### API Endpoints

```typescript
// Generate SSCC for all boxes in shipment
POST /api/shipping/shipments/:id/generate-sscc
Body: {}
Response: {
  generated_count: number;
  skipped_count: number;
  boxes: Array<{
    box_id: string;
    box_number: number;
    sscc: string;
    sscc_formatted: string;
  }>;
}

// Generate BOL PDF
POST /api/shipping/shipments/:id/generate-bol
Body: {
  force_regenerate?: boolean;  // Re-generate even if exists
  include_product_list?: boolean;  // Include detailed product summary
}
Response: {
  bol_number: string;
  pdf_url: string;
  generated_at: string;
  file_size_kb: number;
}

// Print shipping labels (ZPL format)
POST /api/shipping/shipments/:id/print-labels
Body: {
  format: '4x6' | '4x8';
  output: 'zpl' | 'pdf';
  box_ids?: string[];  // Optional: specific boxes only
}
Response: {
  labels: Array<{
    box_id: string;
    box_number: number;
    sscc: string;
    zpl?: string;  // If output = 'zpl'
    pdf_url?: string;  // If output = 'pdf'
  }>;
}

// Generate packing slip PDF
POST /api/shipping/shipments/:id/print-packing-slip
Body: {
  force_regenerate?: boolean;
}
Response: {
  pdf_url: string;
  generated_at: string;
  file_size_kb: number;
}

// Get SSCC label preview
GET /api/shipping/shipments/:id/boxes/:boxId/label-preview
Query: {
  format?: '4x6' | '4x8';
}
Response: {
  sscc: string;
  sscc_formatted: string;
  barcode_image_base64: string;  // PNG base64
  label_content: {
    ship_to: {...};
    order_number: string;
    box_number: string;
    weight: string;
    handling_instructions?: string;
  };
}
```

### Database Schema Updates

```sql
-- Add GS1 columns to organizations table (Epic 01.7)
ALTER TABLE organizations
ADD COLUMN IF NOT EXISTS gs1_company_prefix TEXT,
ADD COLUMN IF NOT EXISTS next_sscc_sequence BIGINT DEFAULT 1;

-- Add constraint for GS1 prefix format
ALTER TABLE organizations
ADD CONSTRAINT chk_gs1_prefix_format
CHECK (gs1_company_prefix IS NULL OR gs1_company_prefix ~ '^\d{7,10}$');

-- Ensure SSCC uniqueness GLOBALLY (across all orgs)
-- Note: shipment_boxes.sscc already has UNIQUE constraint from Story 07.11
-- Verify it's truly unique (not just per-shipment):
-- DROP CONSTRAINT IF EXISTS shipment_boxes_sscc_key;
-- ALTER TABLE shipment_boxes ADD CONSTRAINT shipment_boxes_sscc_unique UNIQUE(sscc);

-- Create index for SSCC lookup
CREATE INDEX IF NOT EXISTS idx_shipment_boxes_sscc
ON shipment_boxes(sscc) WHERE sscc IS NOT NULL;

-- SSCC generation function
CREATE OR REPLACE FUNCTION generate_sscc_for_org(
  org_uuid UUID,
  extension_digit TEXT DEFAULT '0'
)
RETURNS TEXT AS $$
DECLARE
  gs1_prefix TEXT;
  serial_num BIGINT;
  base_digits TEXT;
  check_digit TEXT;
  serial_length INT;
  sscc TEXT;
BEGIN
  -- Get GS1 prefix and increment sequence atomically
  SELECT gs1_company_prefix, next_sscc_sequence
  INTO gs1_prefix, serial_num
  FROM organizations
  WHERE id = org_uuid
  FOR UPDATE;

  IF gs1_prefix IS NULL THEN
    RAISE EXCEPTION 'GS1 Company Prefix not configured for organization';
  END IF;

  -- Update sequence
  UPDATE organizations
  SET next_sscc_sequence = next_sscc_sequence + 1
  WHERE id = org_uuid;

  -- Calculate serial length (17 - 1 extension - prefix length)
  serial_length := 17 - 1 - LENGTH(gs1_prefix);

  -- Build base (17 digits)
  base_digits := extension_digit || gs1_prefix ||
                 LPAD(serial_num::TEXT, serial_length, '0');

  -- Calculate check digit (MOD 10 algorithm)
  check_digit := calculate_gs1_check_digit(base_digits);

  sscc := base_digits || check_digit;

  RETURN sscc;
END;
$$ LANGUAGE plpgsql;

-- Check digit calculation function
CREATE OR REPLACE FUNCTION calculate_gs1_check_digit(digits TEXT)
RETURNS TEXT AS $$
DECLARE
  sum_val INT := 0;
  i INT;
  digit INT;
  multiplier INT;
BEGIN
  IF LENGTH(digits) != 17 THEN
    RAISE EXCEPTION 'SSCC base must be exactly 17 digits';
  END IF;

  FOR i IN 1..17 LOOP
    digit := CAST(SUBSTRING(digits, i, 1) AS INT);
    -- Position from right: odd = 3, even = 1
    multiplier := CASE WHEN (17 - i + 1) % 2 = 1 THEN 3 ELSE 1 END;
    sum_val := sum_val + (digit * multiplier);
  END LOOP;

  RETURN ((10 - (sum_val % 10)) % 10)::TEXT;
END;
$$ LANGUAGE plpgsql IMMUTABLE;
```

### Frontend Components

```typescript
// apps/frontend/app/(authenticated)/shipping/packing/components/SSCCLabelPreview.tsx
interface SSCCLabelPreviewProps {
  shipmentId: string;
  boxId: string;
  sscc: string;
  format?: '4x6' | '4x8';
}

export function SSCCLabelPreview({ shipmentId, boxId, sscc, format = '4x6' }: SSCCLabelPreviewProps) {
  // Render barcode using bwip-js
  // Display label preview with all metadata
  // Format selector: 4x6" / 4x8"
  // Print button, Download button
}

// apps/frontend/app/(authenticated)/shipping/shipments/[id]/components/BOLPreview.tsx
interface BOLPreviewProps {
  shipmentId: string;
  pdfUrl: string;
  onClose: () => void;
}

export function BOLPreview({ shipmentId, pdfUrl, onClose }: BOLPreviewProps) {
  // PDF.js viewer
  // Zoom controls
  // Print, Download, Email buttons
  // Close button
}

// apps/frontend/app/(authenticated)/shipping/shipments/[id]/components/LabelActions.tsx
export function LabelActions({ shipmentId }: { shipmentId: string }) {
  // Generate SSCC button
  // Print Labels button (opens format selector)
  // Generate BOL button
  // Print Packing Slip button
  // Preview modals for each document type
}
```

### Services

```typescript
// lib/services/sscc-service.ts
export class SSCCService {
  /**
   * Generate SSCC codes for all boxes in shipment
   */
  static async generateSSCCForShipment(shipmentId: string): Promise<{
    generated_count: number;
    skipped_count: number;
    boxes: SSCCResult[];
  }>;

  /**
   * Calculate MOD 10 check digit
   */
  static calculateCheckDigit(base17: string): string;

  /**
   * Validate SSCC format and check digit
   */
  static validateSSCC(sscc: string): boolean;

  /**
   * Format SSCC with spaces for display
   */
  static formatSSCC(sscc: string): string;
}

// lib/services/label-service.ts
export class LabelService {
  /**
   * Generate ZPL code for shipping label
   */
  static generateZPL(box: ShipmentBox, customer: Customer, format: '4x6' | '4x8'): string;

  /**
   * Generate barcode image (PNG base64)
   */
  static generateBarcodeImage(sscc: string): Promise<string>;

  /**
   * Get label preview data
   */
  static getLabelPreview(shipmentId: string, boxId: string): Promise<LabelPreviewData>;
}

// lib/services/document-service.ts
export class DocumentService {
  /**
   * Generate BOL PDF
   */
  static async generateBOL(shipmentId: string): Promise<{
    pdf_url: string;
    bol_number: string;
  }>;

  /**
   * Generate Packing Slip PDF
   */
  static async generatePackingSlip(shipmentId: string): Promise<{
    pdf_url: string;
  }>;

  /**
   * Store document in Supabase Storage
   */
  static async storeDocument(
    type: 'bol' | 'packing-slip',
    orgId: string,
    shipmentId: string,
    pdfBuffer: Buffer
  ): Promise<string>;
}
```

### Validation (Zod)

```typescript
// lib/validation/sscc-schema.ts
import { z } from 'zod';

export const generateSSCCSchema = z.object({
  shipment_id: z.string().uuid('Invalid shipment ID')
});

export const printLabelsSchema = z.object({
  format: z.enum(['4x6', '4x8']).default('4x6'),
  output: z.enum(['zpl', 'pdf']).default('zpl'),
  box_ids: z.array(z.string().uuid()).optional()
});

export const generateBOLSchema = z.object({
  force_regenerate: z.boolean().default(false),
  include_product_list: z.boolean().default(true)
});

export const ssccFormatSchema = z.string()
  .length(18, 'SSCC must be 18 digits')
  .regex(/^\d{18}$/, 'SSCC must contain only digits')
  .refine(
    (sscc) => SSCCService.validateSSCC(sscc),
    'Invalid SSCC check digit'
  );

export const gs1PrefixSchema = z.string()
  .min(7, 'GS1 prefix must be 7-10 digits')
  .max(10, 'GS1 prefix must be 7-10 digits')
  .regex(/^\d+$/, 'GS1 prefix must contain only digits');

export type GenerateSSCCInput = z.infer<typeof generateSSCCSchema>;
export type PrintLabelsInput = z.infer<typeof printLabelsSchema>;
export type GenerateBOLInput = z.infer<typeof generateBOLSchema>;
```

### Key Business Rules

1. **SSCC Format**: 18 digits = Extension(1) + GS1 Prefix(7-10) + Serial(6-9) + Check(1)
2. **Extension Digit**: 0 = carton/case, 9 = pallet (configurable in future)
3. **GS1 Prefix**: Required in org settings before SSCC generation
4. **Serial Reference**: Auto-incremented per org, stored in organizations.next_sscc_sequence
5. **Check Digit**: MOD 10 algorithm per GS1 specification
6. **Uniqueness**: SSCC globally unique (enforced by UNIQUE constraint)
7. **Idempotency**: generate-sscc only creates for boxes with NULL sscc
8. **BOL Dependency**: All boxes must have SSCC before BOL generation
9. **Storage**: PDFs stored in Supabase Storage with org_id path prefix
10. **Caching**: BOL/Packing Slip PDFs cached for 24h, invalidated on shipment update

---

## GS1 Compliance Requirements

### GS1-128 Barcode Encoding

The GS1-128 barcode format requires:
1. **FNC1 Start**: Special start character to indicate GS1 format
2. **Application Identifier (00)**: Indicates SSCC data type
3. **18-digit SSCC**: Full SSCC number
4. **FNC1 Separator**: After variable-length AIs (not needed for SSCC)

```typescript
// bwip-js encoding for GS1-128 SSCC
import bwipjs from 'bwip-js';

async function generateGS1128Barcode(sscc: string): Promise<Buffer> {
  const png = await bwipjs.toBuffer({
    bcid: 'gs1-128',
    text: '(00)' + sscc,  // AI (00) = SSCC
    scale: 3,
    height: 15,
    includetext: true,
    textxalign: 'center',
    textfont: 'Helvetica',
    textsize: 10,
    parsefnc: true,  // Parse FNC1 characters
  });
  return png;
}
```

### Application Identifiers Used

| AI | Description | Format | Used In |
|----|-------------|--------|---------|
| (00) | SSCC | 18 digits | Shipping label, BOL |
| (01) | GTIN | 14 digits | Product labels (future) |
| (10) | Batch/Lot | up to 20 alphanumeric | LP labels |
| (15) | Best Before Date | YYMMDD | LP labels |

---

## Deliverables

### Database
- Migration: `supabase/migrations/YYYYMMDDHHMMSS_add_sscc_support.sql`
  - Add gs1_company_prefix to organizations
  - Add next_sscc_sequence to organizations
  - Add generate_sscc_for_org() function
  - Add calculate_gs1_check_digit() function
  - Verify/add UNIQUE constraint on shipment_boxes.sscc

### API Routes
- `apps/frontend/app/api/shipping/shipments/[id]/generate-sscc/route.ts` (POST)
- `apps/frontend/app/api/shipping/shipments/[id]/generate-bol/route.ts` (POST)
- `apps/frontend/app/api/shipping/shipments/[id]/print-labels/route.ts` (POST)
- `apps/frontend/app/api/shipping/shipments/[id]/print-packing-slip/route.ts` (POST)
- `apps/frontend/app/api/shipping/shipments/[id]/boxes/[boxId]/label-preview/route.ts` (GET)

### Services
- `lib/services/sscc-service.ts` (SSCC generation, validation)
- `lib/services/label-service.ts` (ZPL generation, barcode rendering)
- `lib/services/document-service.ts` (BOL, packing slip PDF generation)

### Validation
- `lib/validation/sscc-schema.ts`

### Frontend Pages
- Update: `apps/frontend/app/(authenticated)/shipping/shipments/[id]/page.tsx` (add label actions)

### Components
- `apps/frontend/app/(authenticated)/shipping/shipments/[id]/components/LabelActions.tsx`
- `apps/frontend/app/(authenticated)/shipping/shipments/[id]/components/SSCCLabelPreview.tsx`
- `apps/frontend/app/(authenticated)/shipping/shipments/[id]/components/BOLPreview.tsx`
- `apps/frontend/app/(authenticated)/shipping/shipments/[id]/components/PackingSlipPreview.tsx`

### Tests
- `lib/services/__tests__/sscc-service.test.ts` (unit tests, >95% coverage)
- `lib/services/__tests__/label-service.test.ts` (unit tests)
- `lib/services/__tests__/document-service.test.ts` (unit tests)
- `tests/e2e/shipping/sscc-bol-workflow.spec.ts` (E2E tests)

---

## Definition of Done

- [ ] Database migration applied (gs1_company_prefix, next_sscc_sequence, functions)
- [ ] SSCC generation produces valid 18-digit codes
- [ ] MOD 10 check digit calculation passes >95% test coverage
- [ ] validateSSCC correctly identifies valid/invalid SSCCs
- [ ] formatSSCC produces human-readable format with spaces
- [ ] generate-sscc endpoint is idempotent (skips existing SSCCs)
- [ ] SSCC uniqueness enforced across all organizations
- [ ] GS1-128 barcode renders correctly (bwip-js)
- [ ] ZPL label template produces valid Zebra output
- [ ] BOL PDF generates with all required sections
- [ ] Packing slip PDF includes line items, lots, allergens
- [ ] PDFs stored in Supabase Storage with org_id prefix
- [ ] SSCCLabelPreview component displays barcode and metadata
- [ ] BOLPreview component renders PDF with PDF.js
- [ ] LabelActions component provides all document generation buttons
- [ ] RLS policies enforce document access control
- [ ] Unit tests pass (>90% coverage for SSCC service)
- [ ] E2E test: Generate SSCC -> Print Labels -> Generate BOL workflow
- [ ] Multi-tenant isolation verified (Org A cannot access Org B's documents)

---

## Future Phases (Not in This Story)

### Phase 2
- Custom label templates (configurable via settings)
- Multi-shipment consolidated BOL
- ASN 856 EDI generation
- Carrier-specific label formats via API (Story 07.26)
- Advanced barcode options (DataMatrix, QR codes)

### Phase 3
- Label template designer UI
- Custom BOL templates
- Automated label printing (print on pack completion)
- Label reprint audit trail

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-12-16 | Initial story creation | ARCHITECT-AGENT |
