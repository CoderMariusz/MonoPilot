# 07.22 - Packing Advanced Features

**Story ID:** 07.22
**Epic:** 07 - Shipping
**Phase:** 2-3
**Complexity:** M (Medium)
**Priority:** P2
**Estimate:** 3-4 days
**Type:** Backend + Frontend
**State:** ready

**Primary PRD:** `docs/1-BASELINE/product/modules/shipping.md` (FR-7.43, FR-7.44)

## PRD References

| FR ID | Requirement | Priority | Phase | Covered |
|-------|-------------|----------|-------|---------|
| FR-7.43 | Shipment Quality Checks | P1 | 2 | Yes |
| FR-7.44 | Hazmat Declaration | P2 | 3 | Yes |

## User Story

**As a** warehouse packer,
**I want** to complete quality checks and hazmat declarations before shipping,
**So that** shipments meet regulatory requirements and customer specifications for safe delivery.

**As a** quality manager,
**I want** to define quality check checklists for shipments,
**So that** critical verification steps are not skipped and compliance is documented.

**As a** shipping coordinator,
**I want** hazmat products to be flagged with proper UN numbers and documentation,
**So that** carriers can handle dangerous goods safely and legally.

## Goal

Implement advanced packing features including shipment quality check checklists (pre-ship verification), hazmat declaration management (UN numbers, labels, documentation), allergen cross-check validation before final shipment, and temperature requirements verification. These features ensure regulatory compliance and customer safety requirements are met before goods leave the warehouse.

## Scope

**In scope:**
- Shipment quality check checklists (configurable per product/customer)
- Quality check completion tracking (who/when/pass/fail)
- Hazmat product identification and flagging
- UN number assignment and validation
- Hazmat label requirements (Class 1-9 labels)
- Hazmat documentation generation (dangerous goods declaration)
- Allergen cross-check validation before shipping
- Temperature requirements verification (chilled/frozen/ambient)
- Block shipment if mandatory checks incomplete
- Audit trail for all quality/hazmat decisions

**Out of scope:**
- SSCC generation (Story 07.13)
- BOL generation (Story 07.13 - though hazmat adds fields to BOL)
- Carrier hazmat surcharge calculation (Phase 3+)
- Chemical safety data sheet (SDS) management
- ADR/IATA full compliance certification
- Real-time temperature monitoring (IoT)

## Dependencies

| Story | Requirement | Status |
|-------|-------------|--------|
| 07.11 | Packing Station + Shipment Creation | Required - provides shipments, boxes |
| 07.13 | SSCC + Labels + BOL | Required - for hazmat label integration |
| 02.1 | Products | Required - product data with hazmat/allergen flags |
| 02.3 | Allergens | Required - allergen definitions |

### Provides To
- 07.13 - SSCC + Labels + BOL (hazmat fields for labels/BOL)
- 07.14 - Shipment Manifest + Ship (quality gate before shipping)

## Acceptance Criteria (Given/When/Then)

### Shipment Quality Checks (FR-7.43)

#### Quality Check Template Management
- GIVEN admin navigates to Settings > Shipping > Quality Checks, WHEN page loads, THEN list of quality check templates displays.
- GIVEN admin clicks "Add Template", WHEN form displayed, THEN fields include: name, description, check items, applies_to (product category, customer, all).
- GIVEN template with 5 check items created, WHEN template saved, THEN template available for assignment to shipments.
- GIVEN check item defined, WHEN defining item, THEN can specify: check_name, check_type (visual, measurement, document), is_mandatory, instructions.

#### Quality Check Assignment to Shipment
- GIVEN shipment created for Customer A, WHEN Customer A has assigned quality template, THEN shipment inherits quality checks from template.
- GIVEN shipment contains Product X (category: frozen), WHEN frozen category has quality template, THEN shipment inherits category checks.
- GIVEN shipment has no template matches, WHEN packing completes, THEN default quality checks apply (if configured).
- GIVEN shipment with 8 check items, WHEN packing page loads, THEN "Quality Checks" section displays with checklist.

#### Quality Check Completion
- GIVEN packer views quality checks section, WHEN all items unchecked, THEN status shows "0/8 completed".
- GIVEN packer checks item "Verify seal integrity", WHEN checkbox clicked, THEN item marked complete with timestamp and user.
- GIVEN packer checks measurement item "Box weight within tolerance", WHEN entering value, THEN system validates against spec (e.g., 10-12 kg).
- GIVEN measurement out of tolerance, WHEN value entered, THEN warning displays: "Weight 14 kg exceeds max 12 kg" with option to override with reason.
- GIVEN all mandatory checks completed, WHEN status updated, THEN "Ready to Ship" indicator displays.
- GIVEN 2 mandatory checks incomplete, WHEN packer clicks "Complete Packing", THEN error: "Cannot complete packing: 2 mandatory quality checks pending".

#### Quality Check Documentation
- GIVEN all quality checks passed, WHEN shipment marked complete, THEN quality_check_results record created with all check outcomes.
- GIVEN check required photo evidence, WHEN check marked complete, THEN photo upload required before check saves.
- GIVEN quality check failed with override, WHEN override applied, THEN override_reason and override_by captured in audit trail.

### Hazmat Declaration (FR-7.44)

#### Product Hazmat Configuration
- GIVEN product is hazardous, WHEN editing product in Technical module, THEN hazmat fields available: is_hazmat, un_number, hazard_class, packing_group, proper_shipping_name.
- GIVEN product with UN1263 (Paint), WHEN product saved, THEN hazmat classification stored: UN1263, Class 3, PG II.
- GIVEN product list, WHEN filtered by is_hazmat=true, THEN only hazmat products display with UN numbers.

#### Shipment Hazmat Detection
- GIVEN shipment contains 1 hazmat product (UN1263), WHEN packing page loads, THEN "HAZMAT" badge displays prominently.
- GIVEN shipment with multiple hazmat products, WHEN viewing hazmat section, THEN all UN numbers listed with quantities.
- GIVEN shipment with non-hazmat products only, WHEN packing page loads, THEN no hazmat indicator displays.

#### Hazmat Declaration Form
- GIVEN shipment flagged as hazmat, WHEN packer opens hazmat declaration, THEN form pre-populated with: UN numbers, proper shipping names, hazard classes from products.
- GIVEN hazmat declaration form, WHEN form displayed, THEN fields include:
  - Shipper's declaration checkbox
  - Emergency contact phone
  - Total quantity per UN number
  - Packing group verification
  - Label requirements (diamond labels)
  - Special handling instructions
- GIVEN packer reviews hazmat form, WHEN clicking "Confirm Declaration", THEN declaration saved with timestamp and digital signature (checkbox acknowledgment).

#### Hazmat Label Requirements
- GIVEN shipment with UN1263 (Class 3 - Flammable Liquid), WHEN label requirements displayed, THEN shows: "Requires Class 3 diamond label (red)".
- GIVEN shipment with multiple hazard classes, WHEN label requirements displayed, THEN all required labels listed (e.g., Class 3, Class 8).
- GIVEN hazmat shipment ready for labels, WHEN generating shipping label (Story 07.13), THEN hazmat indicators included on label.

#### Hazmat Documentation
- GIVEN hazmat declaration completed, WHEN clicking "Generate DG Declaration", THEN PDF generated with:
  - Shipper and consignee details
  - UN number(s), proper shipping name(s), hazard class(es)
  - Packing group, total quantity
  - Emergency response info
  - Shipper's certification statement
- GIVEN hazmat shipment, WHEN generating BOL (Story 07.13), THEN BOL includes hazmat section with UN numbers and placards required.

#### Hazmat Shipping Blocks
- GIVEN hazmat shipment without completed declaration, WHEN packer clicks "Complete Packing", THEN error: "Hazmat declaration required before shipping".
- GIVEN hazmat declaration incomplete (missing emergency contact), WHEN submitting declaration, THEN validation error: "Emergency contact phone required".
- GIVEN carrier does not accept hazmat, WHEN selecting carrier, THEN warning: "DHL Express does not accept Class 3 hazmat. Select different carrier."

### Allergen Cross-Check Validation

#### Customer Allergen Restrictions Review
- GIVEN Customer A has allergen restrictions [Peanuts, Tree Nuts], WHEN shipment created for Customer A, THEN allergen section displays restrictions.
- GIVEN shipment contains Product X with [Milk, Soy] allergens, WHEN allergen cross-check runs, THEN status shows "PASS - No restricted allergens found".
- GIVEN shipment contains Product Y with [Peanuts] allergen, WHEN allergen cross-check runs, THEN status shows "FAIL - Contains restricted allergen: Peanuts".

#### Allergen Validation Workflow
- GIVEN shipment fails allergen cross-check, WHEN status displayed, THEN "ALLERGEN ALERT" badge shows prominently.
- GIVEN allergen alert triggered, WHEN packer reviews, THEN details show: "Product Y (SKU-123) contains Peanuts. Customer A restricts: Peanuts, Tree Nuts."
- GIVEN allergen conflict detected, WHEN packer clicks "Override", THEN confirmation required: "Confirm customer has approved this shipment despite allergen conflict."
- GIVEN allergen override confirmed, WHEN override saved, THEN audit log captures: user, timestamp, reason, approval reference.

#### Allergen Documentation
- GIVEN shipment with allergen products, WHEN generating packing slip (Story 07.13), THEN allergen summary included.
- GIVEN allergen override applied, WHEN shipment ships, THEN override record attached to shipment history.

### Temperature Requirements Verification

#### Product Temperature Configuration
- GIVEN product requires refrigeration, WHEN editing product, THEN storage_temp field set: 'chilled' (2-8C), 'frozen' (-18C), 'ambient'.
- GIVEN products in shipment, WHEN temperature requirements checked, THEN system identifies strictest requirement.

#### Temperature Verification Workflow
- GIVEN shipment contains frozen product, WHEN packing page loads, THEN "FROZEN SHIPMENT" indicator displays.
- GIVEN shipment requires chilled transport, WHEN carrier selected, THEN system validates carrier supports temperature-controlled.
- GIVEN packer completes packing, WHEN temperature verification triggered, THEN checklist includes:
  - [ ] Product temperature verified before packing
  - [ ] Cool packs/dry ice included (if required)
  - [ ] Insulated packaging used
  - [ ] Temperature logger placed (if required)
- GIVEN temperature requirements not met, WHEN completing packing, THEN warning: "Temperature requirements not verified. Proceed anyway?"

#### Dock Door Temperature Validation
- GIVEN shipment requires frozen transport, WHEN assigning dock door, THEN only frozen-capable dock doors shown.
- GIVEN dock door is ambient-only, WHEN frozen shipment assigned, THEN error: "Dock Door 3 does not support frozen shipments."

### Multi-Tenancy & Audit

#### Organization Isolation
- GIVEN Org A quality templates, WHEN Org B queries templates, THEN Org B sees only own templates (RLS enforced).
- GIVEN Org A hazmat shipments, WHEN Org B queries hazmat data, THEN Org B cannot access Org A data.

#### Audit Trail
- GIVEN quality check completed, WHEN check saved, THEN audit log entry: check_id, user_id, timestamp, result, notes.
- GIVEN hazmat declaration submitted, WHEN declaration saved, THEN audit log entry: declaration_id, user_id, timestamp, signature.
- GIVEN allergen override approved, WHEN override saved, THEN audit log entry: shipment_id, user_id, timestamp, reason, approval_ref.

## Technical Specification

### Database Schema

#### shipment_quality_templates table

```sql
CREATE TABLE shipment_quality_templates (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,

  -- Template identification
  name VARCHAR(100) NOT NULL,
  description TEXT,
  is_active BOOLEAN DEFAULT true,

  -- Applicability
  applies_to_all BOOLEAN DEFAULT false,
  applies_to_categories JSONB DEFAULT '[]', -- ["frozen", "chilled"]
  applies_to_customer_ids JSONB DEFAULT '[]', -- [uuid1, uuid2]

  -- Timestamps
  created_at TIMESTAMPTZ DEFAULT NOW(),
  created_by UUID REFERENCES users(id),
  updated_at TIMESTAMPTZ DEFAULT NOW(),

  UNIQUE(org_id, name)
);

CREATE INDEX idx_sqt_org_active ON shipment_quality_templates(org_id, is_active);
```

#### shipment_quality_check_items table

```sql
CREATE TABLE shipment_quality_check_items (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  template_id UUID NOT NULL REFERENCES shipment_quality_templates(id) ON DELETE CASCADE,

  -- Check definition
  check_name VARCHAR(200) NOT NULL,
  check_type VARCHAR(50) NOT NULL DEFAULT 'checkbox', -- 'checkbox', 'measurement', 'document', 'photo'
  instructions TEXT,
  is_mandatory BOOLEAN DEFAULT true,
  sequence_order INTEGER DEFAULT 0,

  -- Measurement specs (for check_type = 'measurement')
  measurement_unit VARCHAR(20), -- 'kg', 'cm', 'C'
  measurement_min DECIMAL(10,2),
  measurement_max DECIMAL(10,2),

  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_sqci_template ON shipment_quality_check_items(template_id);
```

#### shipment_quality_checks table

```sql
CREATE TABLE shipment_quality_checks (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  shipment_id UUID NOT NULL REFERENCES shipments(id) ON DELETE CASCADE,
  template_id UUID REFERENCES shipment_quality_templates(id),

  -- Overall status
  status VARCHAR(20) NOT NULL DEFAULT 'pending', -- 'pending', 'in_progress', 'passed', 'failed', 'passed_with_override'
  completed_at TIMESTAMPTZ,
  completed_by UUID REFERENCES users(id),

  -- Summary
  total_checks INTEGER DEFAULT 0,
  passed_checks INTEGER DEFAULT 0,
  failed_checks INTEGER DEFAULT 0,
  overridden_checks INTEGER DEFAULT 0,

  created_at TIMESTAMPTZ DEFAULT NOW(),

  UNIQUE(shipment_id)
);

CREATE INDEX idx_sqc_shipment ON shipment_quality_checks(shipment_id);
CREATE INDEX idx_sqc_org_status ON shipment_quality_checks(org_id, status);
```

#### shipment_quality_check_results table

```sql
CREATE TABLE shipment_quality_check_results (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  quality_check_id UUID NOT NULL REFERENCES shipment_quality_checks(id) ON DELETE CASCADE,
  check_item_id UUID NOT NULL REFERENCES shipment_quality_check_items(id),

  -- Result
  status VARCHAR(20) NOT NULL DEFAULT 'pending', -- 'pending', 'passed', 'failed', 'skipped'
  checked_at TIMESTAMPTZ,
  checked_by UUID REFERENCES users(id),

  -- Measurement results (if applicable)
  measurement_value DECIMAL(10,2),
  measurement_passed BOOLEAN,

  -- Override info
  is_overridden BOOLEAN DEFAULT false,
  override_reason TEXT,
  override_by UUID REFERENCES users(id),
  override_at TIMESTAMPTZ,

  -- Evidence
  notes TEXT,
  photo_url TEXT,

  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_sqcr_quality_check ON shipment_quality_check_results(quality_check_id);
```

#### products table extension (hazmat fields)

```sql
-- Add hazmat fields to products table
ALTER TABLE products ADD COLUMN IF NOT EXISTS is_hazmat BOOLEAN DEFAULT false;
ALTER TABLE products ADD COLUMN IF NOT EXISTS un_number VARCHAR(10); -- 'UN1263'
ALTER TABLE products ADD COLUMN IF NOT EXISTS hazard_class VARCHAR(10); -- '3', '8', '9'
ALTER TABLE products ADD COLUMN IF NOT EXISTS packing_group VARCHAR(5); -- 'I', 'II', 'III'
ALTER TABLE products ADD COLUMN IF NOT EXISTS proper_shipping_name TEXT;
ALTER TABLE products ADD COLUMN IF NOT EXISTS hazmat_labels JSONB DEFAULT '[]'; -- ["flammable", "corrosive"]
ALTER TABLE products ADD COLUMN IF NOT EXISTS storage_temp VARCHAR(20) DEFAULT 'ambient'; -- 'ambient', 'chilled', 'frozen'
```

#### shipment_hazmat_declarations table

```sql
CREATE TABLE shipment_hazmat_declarations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  shipment_id UUID NOT NULL REFERENCES shipments(id) ON DELETE CASCADE,

  -- Declaration status
  status VARCHAR(20) NOT NULL DEFAULT 'draft', -- 'draft', 'submitted', 'approved'

  -- Shipper certification
  shipper_certified BOOLEAN DEFAULT false,
  shipper_name VARCHAR(200),
  shipper_title VARCHAR(100),
  certified_at TIMESTAMPTZ,

  -- Emergency contact
  emergency_contact_name VARCHAR(200),
  emergency_contact_phone VARCHAR(50) NOT NULL,

  -- Aggregated hazmat info
  hazmat_summary JSONB NOT NULL DEFAULT '[]', -- [{un_number, proper_name, class, packing_group, qty}]
  total_packages INTEGER DEFAULT 0,
  total_weight DECIMAL(10,2),

  -- Labels required
  labels_required JSONB DEFAULT '[]', -- ["class_3", "class_8"]

  -- Special handling
  special_instructions TEXT,

  -- Timestamps
  created_at TIMESTAMPTZ DEFAULT NOW(),
  created_by UUID REFERENCES users(id),
  submitted_at TIMESTAMPTZ,
  submitted_by UUID REFERENCES users(id),

  UNIQUE(shipment_id)
);

CREATE INDEX idx_shd_shipment ON shipment_hazmat_declarations(shipment_id);
CREATE INDEX idx_shd_org_status ON shipment_hazmat_declarations(org_id, status);
```

#### shipment_allergen_validations table

```sql
CREATE TABLE shipment_allergen_validations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  shipment_id UUID NOT NULL REFERENCES shipments(id) ON DELETE CASCADE,

  -- Validation status
  status VARCHAR(20) NOT NULL DEFAULT 'pending', -- 'pending', 'passed', 'failed', 'overridden'
  validated_at TIMESTAMPTZ,
  validated_by UUID REFERENCES users(id),

  -- Customer restrictions
  customer_restrictions JSONB DEFAULT '[]', -- allergen IDs from customer

  -- Products with allergens
  products_allergens JSONB DEFAULT '[]', -- [{product_id, product_name, allergens: []}]

  -- Conflicts found
  conflicts JSONB DEFAULT '[]', -- [{allergen_id, allergen_name, product_id, product_name}]

  -- Override
  is_overridden BOOLEAN DEFAULT false,
  override_reason TEXT,
  override_by UUID REFERENCES users(id),
  override_at TIMESTAMPTZ,
  approval_reference VARCHAR(100), -- Customer approval reference

  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_sav_shipment ON shipment_allergen_validations(shipment_id);
```

#### shipment_temperature_checks table

```sql
CREATE TABLE shipment_temperature_checks (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  shipment_id UUID NOT NULL REFERENCES shipments(id) ON DELETE CASCADE,

  -- Temperature requirement
  required_temp VARCHAR(20) NOT NULL, -- 'ambient', 'chilled', 'frozen'

  -- Verification status
  status VARCHAR(20) NOT NULL DEFAULT 'pending', -- 'pending', 'verified', 'failed'
  verified_at TIMESTAMPTZ,
  verified_by UUID REFERENCES users(id),

  -- Checklist items
  temp_verified BOOLEAN DEFAULT false,
  cool_packs_included BOOLEAN DEFAULT false,
  insulated_packaging BOOLEAN DEFAULT false,
  temp_logger_placed BOOLEAN DEFAULT false,

  -- Notes
  notes TEXT,

  created_at TIMESTAMPTZ DEFAULT NOW(),

  UNIQUE(shipment_id)
);

CREATE INDEX idx_stc_shipment ON shipment_temperature_checks(shipment_id);
```

### RLS Policies

```sql
-- Quality templates
ALTER TABLE shipment_quality_templates ENABLE ROW LEVEL SECURITY;
CREATE POLICY "sqt_org_isolation" ON shipment_quality_templates
  FOR ALL USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

-- Quality check items
ALTER TABLE shipment_quality_check_items ENABLE ROW LEVEL SECURITY;
CREATE POLICY "sqci_org_isolation" ON shipment_quality_check_items
  FOR ALL USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

-- Quality checks
ALTER TABLE shipment_quality_checks ENABLE ROW LEVEL SECURITY;
CREATE POLICY "sqc_org_isolation" ON shipment_quality_checks
  FOR ALL USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

-- Quality check results
ALTER TABLE shipment_quality_check_results ENABLE ROW LEVEL SECURITY;
CREATE POLICY "sqcr_org_isolation" ON shipment_quality_check_results
  FOR ALL USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

-- Hazmat declarations
ALTER TABLE shipment_hazmat_declarations ENABLE ROW LEVEL SECURITY;
CREATE POLICY "shd_org_isolation" ON shipment_hazmat_declarations
  FOR ALL USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

-- Allergen validations
ALTER TABLE shipment_allergen_validations ENABLE ROW LEVEL SECURITY;
CREATE POLICY "sav_org_isolation" ON shipment_allergen_validations
  FOR ALL USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

-- Temperature checks
ALTER TABLE shipment_temperature_checks ENABLE ROW LEVEL SECURITY;
CREATE POLICY "stc_org_isolation" ON shipment_temperature_checks
  FOR ALL USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));
```

### API Endpoints

```
# Quality Check Templates
GET    /api/shipping/quality-templates                    - List templates
GET    /api/shipping/quality-templates/:id                - Get template with items
POST   /api/shipping/quality-templates                    - Create template
PUT    /api/shipping/quality-templates/:id                - Update template
DELETE /api/shipping/quality-templates/:id                - Delete template

# Quality Check Items
POST   /api/shipping/quality-templates/:id/items          - Add check item
PUT    /api/shipping/quality-templates/:id/items/:itemId  - Update check item
DELETE /api/shipping/quality-templates/:id/items/:itemId  - Delete check item

# Shipment Quality Checks
GET    /api/shipping/shipments/:id/quality-checks         - Get shipment quality checks
POST   /api/shipping/shipments/:id/quality-checks         - Initialize quality checks for shipment
PUT    /api/shipping/shipments/:id/quality-checks/:checkId - Update check result
POST   /api/shipping/shipments/:id/quality-checks/:checkId/override - Override failed check

# Hazmat Declaration
GET    /api/shipping/shipments/:id/hazmat                 - Get hazmat declaration
POST   /api/shipping/shipments/:id/hazmat                 - Create/update hazmat declaration
POST   /api/shipping/shipments/:id/hazmat/submit          - Submit declaration
GET    /api/shipping/shipments/:id/hazmat/document        - Generate DG declaration PDF

# Allergen Validation
GET    /api/shipping/shipments/:id/allergen-validation    - Get allergen validation
POST   /api/shipping/shipments/:id/allergen-validation    - Run allergen cross-check
POST   /api/shipping/shipments/:id/allergen-validation/override - Override conflict

# Temperature Verification
GET    /api/shipping/shipments/:id/temperature-check      - Get temperature check
POST   /api/shipping/shipments/:id/temperature-check      - Create/update temperature check
POST   /api/shipping/shipments/:id/temperature-check/verify - Mark as verified
```

### Service Methods

**Location:** `lib/services/shipment-quality-service.ts`

```typescript
interface ShipmentQualityService {
  // Template management
  getTemplates(orgId: string): Promise<QualityTemplate[]>;
  getTemplate(templateId: string): Promise<QualityTemplate>;
  createTemplate(data: CreateTemplateInput): Promise<QualityTemplate>;
  updateTemplate(templateId: string, data: UpdateTemplateInput): Promise<QualityTemplate>;
  deleteTemplate(templateId: string): Promise<void>;

  // Check item management
  addCheckItem(templateId: string, data: CheckItemInput): Promise<CheckItem>;
  updateCheckItem(itemId: string, data: CheckItemInput): Promise<CheckItem>;
  deleteCheckItem(itemId: string): Promise<void>;

  // Shipment quality checks
  initializeChecks(shipmentId: string): Promise<ShipmentQualityCheck>;
  getChecks(shipmentId: string): Promise<ShipmentQualityCheck>;
  updateCheckResult(checkId: string, result: CheckResultInput): Promise<CheckResult>;
  overrideCheck(checkId: string, reason: string): Promise<CheckResult>;
  completeQualityChecks(shipmentId: string): Promise<void>;

  // Validation
  canCompleteShipment(shipmentId: string): Promise<QualityGateResult>;
}

interface QualityGateResult {
  can_complete: boolean;
  blockers: {
    type: 'quality' | 'hazmat' | 'allergen' | 'temperature';
    message: string;
  }[];
}
```

**Location:** `lib/services/shipment-hazmat-service.ts`

```typescript
interface ShipmentHazmatService {
  // Detection
  detectHazmat(shipmentId: string): Promise<HazmatDetection>;

  // Declaration
  getDeclaration(shipmentId: string): Promise<HazmatDeclaration | null>;
  createDeclaration(shipmentId: string): Promise<HazmatDeclaration>;
  updateDeclaration(declarationId: string, data: HazmatDeclarationInput): Promise<HazmatDeclaration>;
  submitDeclaration(declarationId: string): Promise<HazmatDeclaration>;

  // Documentation
  generateDGDeclaration(shipmentId: string): Promise<Buffer>; // PDF

  // Validation
  validateCarrierHazmatSupport(carrierId: string, hazardClasses: string[]): Promise<CarrierHazmatSupport>;
}

interface HazmatDetection {
  is_hazmat: boolean;
  products: {
    product_id: string;
    product_name: string;
    un_number: string;
    hazard_class: string;
    packing_group: string;
    proper_shipping_name: string;
    quantity: number;
  }[];
  labels_required: string[];
}
```

**Location:** `lib/services/shipment-allergen-service.ts`

```typescript
interface ShipmentAllergenService {
  // Validation
  validateAllergens(shipmentId: string): Promise<AllergenValidation>;

  // Override
  overrideConflict(validationId: string, reason: string, approvalRef?: string): Promise<AllergenValidation>;

  // Query
  getValidation(shipmentId: string): Promise<AllergenValidation | null>;
}

interface AllergenValidation {
  status: 'pending' | 'passed' | 'failed' | 'overridden';
  customer_restrictions: Allergen[];
  products_allergens: ProductAllergen[];
  conflicts: AllergenConflict[];
  is_overridden: boolean;
  override_reason?: string;
  approval_reference?: string;
}
```

**Location:** `lib/services/shipment-temperature-service.ts`

```typescript
interface ShipmentTemperatureService {
  // Detection
  detectTemperatureRequirement(shipmentId: string): Promise<TempRequirement>;

  // Verification
  getCheck(shipmentId: string): Promise<TemperatureCheck | null>;
  createCheck(shipmentId: string): Promise<TemperatureCheck>;
  updateCheck(checkId: string, data: TempCheckInput): Promise<TemperatureCheck>;
  verifyCheck(checkId: string): Promise<TemperatureCheck>;

  // Dock validation
  validateDockDoor(dockDoorId: string, requiredTemp: string): Promise<boolean>;
}
```

### Zod Validation Schemas

**Location:** `lib/validation/shipment-quality.ts`

```typescript
import { z } from 'zod';

export const qualityTemplateSchema = z.object({
  name: z.string().min(1).max(100),
  description: z.string().optional(),
  is_active: z.boolean().default(true),
  applies_to_all: z.boolean().default(false),
  applies_to_categories: z.array(z.string()).default([]),
  applies_to_customer_ids: z.array(z.string().uuid()).default([]),
});

export const checkItemSchema = z.object({
  check_name: z.string().min(1).max(200),
  check_type: z.enum(['checkbox', 'measurement', 'document', 'photo']),
  instructions: z.string().optional(),
  is_mandatory: z.boolean().default(true),
  sequence_order: z.number().int().default(0),
  measurement_unit: z.string().max(20).optional(),
  measurement_min: z.number().optional(),
  measurement_max: z.number().optional(),
}).refine(
  (data) => {
    if (data.check_type === 'measurement') {
      return data.measurement_unit && data.measurement_min !== undefined && data.measurement_max !== undefined;
    }
    return true;
  },
  { message: 'Measurement checks require unit, min, and max values' }
);

export const checkResultSchema = z.object({
  status: z.enum(['passed', 'failed', 'skipped']),
  measurement_value: z.number().optional(),
  notes: z.string().optional(),
  photo_url: z.string().url().optional(),
});

export const checkOverrideSchema = z.object({
  reason: z.string().min(10, 'Override reason must be at least 10 characters'),
});
```

**Location:** `lib/validation/shipment-hazmat.ts`

```typescript
import { z } from 'zod';

export const hazmatDeclarationSchema = z.object({
  emergency_contact_name: z.string().max(200).optional(),
  emergency_contact_phone: z.string().min(10).max(50),
  special_instructions: z.string().optional(),
});

export const hazmatSubmitSchema = z.object({
  shipper_name: z.string().min(1).max(200),
  shipper_title: z.string().max(100).optional(),
  shipper_certified: z.literal(true, {
    errorMap: () => ({ message: 'Shipper certification is required' }),
  }),
});

export const productHazmatSchema = z.object({
  is_hazmat: z.boolean().default(false),
  un_number: z.string().regex(/^UN\d{4}$/, 'UN number must be in format UN0000').optional(),
  hazard_class: z.string().max(10).optional(),
  packing_group: z.enum(['I', 'II', 'III']).optional(),
  proper_shipping_name: z.string().max(500).optional(),
  hazmat_labels: z.array(z.string()).default([]),
}).refine(
  (data) => {
    if (data.is_hazmat) {
      return data.un_number && data.hazard_class && data.proper_shipping_name;
    }
    return true;
  },
  { message: 'Hazmat products require UN number, hazard class, and proper shipping name' }
);
```

**Location:** `lib/validation/shipment-allergen.ts`

```typescript
import { z } from 'zod';

export const allergenOverrideSchema = z.object({
  reason: z.string().min(20, 'Override reason must be at least 20 characters'),
  approval_reference: z.string().optional(),
});
```

**Location:** `lib/validation/shipment-temperature.ts`

```typescript
import { z } from 'zod';

export const temperatureCheckSchema = z.object({
  temp_verified: z.boolean(),
  cool_packs_included: z.boolean(),
  insulated_packaging: z.boolean(),
  temp_logger_placed: z.boolean(),
  notes: z.string().optional(),
});

export const productTempSchema = z.object({
  storage_temp: z.enum(['ambient', 'chilled', 'frozen']).default('ambient'),
});
```

## UI Components

### Pages

- `app/(authenticated)/settings/shipping/quality-templates/page.tsx` - Quality templates management
- `app/(authenticated)/settings/shipping/quality-templates/[id]/page.tsx` - Template detail/edit

### Components

**Location:** `components/shipping/quality/`

```
QualityTemplatesList.tsx         - List of quality check templates
QualityTemplateForm.tsx          - Create/edit template form
CheckItemsList.tsx               - Check items within template
CheckItemForm.tsx                - Add/edit check item
ShipmentQualityChecks.tsx        - Quality checks panel on packing page
QualityCheckItem.tsx             - Individual check item with controls
QualityCheckOverrideDialog.tsx   - Override confirmation dialog
QualityStatusBadge.tsx           - Status indicator badge
```

**Location:** `components/shipping/hazmat/`

```
HazmatIndicator.tsx              - HAZMAT badge/banner
HazmatDeclarationForm.tsx        - Declaration form
HazmatProductsList.tsx           - List of hazmat products in shipment
HazmatLabelsRequired.tsx         - Required labels display
HazmatCertificationCheckbox.tsx  - Shipper certification
```

**Location:** `components/shipping/allergen/`

```
AllergenValidationPanel.tsx      - Allergen validation status/details
AllergenConflictsList.tsx        - List of detected conflicts
AllergenOverrideDialog.tsx       - Override confirmation
AllergenStatusBadge.tsx          - Pass/Fail/Override badge
```

**Location:** `components/shipping/temperature/`

```
TemperatureIndicator.tsx         - FROZEN/CHILLED badge
TemperatureCheckPanel.tsx        - Temperature verification checklist
TemperatureRequirements.tsx      - Required handling display
```

### Component Integration (Packing Page)

```tsx
// apps/frontend/app/(authenticated)/shipping/packing/[shipmentId]/page.tsx

import { ShipmentQualityChecks } from '@/components/shipping/quality/ShipmentQualityChecks';
import { HazmatIndicator } from '@/components/shipping/hazmat/HazmatIndicator';
import { HazmatDeclarationForm } from '@/components/shipping/hazmat/HazmatDeclarationForm';
import { AllergenValidationPanel } from '@/components/shipping/allergen/AllergenValidationPanel';
import { TemperatureCheckPanel } from '@/components/shipping/temperature/TemperatureCheckPanel';

export default function PackingPage({ params }: Props) {
  // Layout: Add new sections to packing page
  // 1. Header: Add hazmat/allergen/temp indicators
  // 2. Sidebar or accordion: Quality checks, Hazmat declaration, Allergen validation, Temp verification
  // 3. Complete button: Validate all gates before allowing completion
}
```

## Test Cases

### Unit Tests

**shipment-quality-service.test.ts**
```typescript
describe('ShipmentQualityService', () => {
  describe('initializeChecks', () => {
    it('creates checks from matching template');
    it('applies customer-specific template');
    it('applies category-specific template');
    it('applies default template when no specific match');
  });

  describe('updateCheckResult', () => {
    it('marks check as passed');
    it('marks check as failed');
    it('validates measurement against min/max');
    it('rejects measurement out of range');
  });

  describe('canCompleteShipment', () => {
    it('returns true when all mandatory checks passed');
    it('returns false with mandatory check pending');
    it('returns true when failed checks are overridden');
  });
});
```

**shipment-hazmat-service.test.ts**
```typescript
describe('ShipmentHazmatService', () => {
  describe('detectHazmat', () => {
    it('detects hazmat products in shipment');
    it('returns empty for non-hazmat shipment');
    it('aggregates multiple hazmat products');
  });

  describe('submitDeclaration', () => {
    it('validates emergency contact required');
    it('validates shipper certification required');
    it('updates status to submitted');
  });

  describe('generateDGDeclaration', () => {
    it('generates PDF with correct UN numbers');
    it('includes shipper certification');
    it('includes emergency contact');
  });
});
```

**shipment-allergen-service.test.ts**
```typescript
describe('ShipmentAllergenService', () => {
  describe('validateAllergens', () => {
    it('returns passed when no conflicts');
    it('returns failed when conflict detected');
    it('detects all conflicting products');
  });

  describe('overrideConflict', () => {
    it('requires minimum reason length');
    it('captures override user and timestamp');
    it('updates status to overridden');
  });
});
```

### Integration Tests

**quality-checks-api.test.ts**
```typescript
describe('Quality Checks API', () => {
  describe('GET /api/shipping/shipments/:id/quality-checks', () => {
    it('returns quality checks for shipment');
    it('returns 404 for non-existent shipment');
    it('enforces org isolation');
  });

  describe('POST /api/shipping/shipments/:id/quality-checks/:checkId/override', () => {
    it('overrides failed check with reason');
    it('rejects short override reason');
    it('creates audit log entry');
  });
});
```

**hazmat-api.test.ts**
```typescript
describe('Hazmat API', () => {
  describe('POST /api/shipping/shipments/:id/hazmat/submit', () => {
    it('submits declaration with valid data');
    it('rejects missing emergency contact');
    it('rejects without shipper certification');
  });

  describe('GET /api/shipping/shipments/:id/hazmat/document', () => {
    it('generates PDF document');
    it('returns 400 if declaration not submitted');
  });
});
```

### E2E Tests

**packing-quality-checks.spec.ts**
```typescript
describe('Packing Quality Checks', () => {
  it('displays quality checklist on packing page');
  it('marks checks as complete');
  it('shows measurement input for measurement checks');
  it('blocks packing completion with mandatory checks pending');
  it('allows override of failed check with reason');
  it('completes packing when all checks passed');
});
```

**packing-hazmat.spec.ts**
```typescript
describe('Packing Hazmat', () => {
  it('displays HAZMAT indicator for hazmat shipment');
  it('shows hazmat declaration form');
  it('requires emergency contact');
  it('generates DG declaration PDF');
  it('blocks packing without submitted declaration');
});
```

**packing-allergen.spec.ts**
```typescript
describe('Packing Allergen Validation', () => {
  it('shows PASS for shipment with no allergen conflicts');
  it('shows FAIL for shipment with allergen conflict');
  it('displays conflict details');
  it('allows override with reason');
  it('captures approval reference');
});
```

## Deliverables

### Database
- Migration: `supabase/migrations/YYYYMMDDHHMMSS_create_packing_advanced_features.sql`
  - `shipment_quality_templates` table
  - `shipment_quality_check_items` table
  - `shipment_quality_checks` table
  - `shipment_quality_check_results` table
  - `shipment_hazmat_declarations` table
  - `shipment_allergen_validations` table
  - `shipment_temperature_checks` table
  - Products table extension (hazmat/temp fields)
  - RLS policies
  - Indexes

### API Routes
- `apps/frontend/app/api/shipping/quality-templates/route.ts` (GET, POST)
- `apps/frontend/app/api/shipping/quality-templates/[id]/route.ts` (GET, PUT, DELETE)
- `apps/frontend/app/api/shipping/quality-templates/[id]/items/route.ts` (POST)
- `apps/frontend/app/api/shipping/quality-templates/[id]/items/[itemId]/route.ts` (PUT, DELETE)
- `apps/frontend/app/api/shipping/shipments/[id]/quality-checks/route.ts` (GET, POST)
- `apps/frontend/app/api/shipping/shipments/[id]/quality-checks/[checkId]/route.ts` (PUT)
- `apps/frontend/app/api/shipping/shipments/[id]/quality-checks/[checkId]/override/route.ts` (POST)
- `apps/frontend/app/api/shipping/shipments/[id]/hazmat/route.ts` (GET, POST)
- `apps/frontend/app/api/shipping/shipments/[id]/hazmat/submit/route.ts` (POST)
- `apps/frontend/app/api/shipping/shipments/[id]/hazmat/document/route.ts` (GET)
- `apps/frontend/app/api/shipping/shipments/[id]/allergen-validation/route.ts` (GET, POST)
- `apps/frontend/app/api/shipping/shipments/[id]/allergen-validation/override/route.ts` (POST)
- `apps/frontend/app/api/shipping/shipments/[id]/temperature-check/route.ts` (GET, POST)
- `apps/frontend/app/api/shipping/shipments/[id]/temperature-check/verify/route.ts` (POST)

### Services
- `lib/services/shipment-quality-service.ts`
- `lib/services/shipment-hazmat-service.ts`
- `lib/services/shipment-allergen-service.ts`
- `lib/services/shipment-temperature-service.ts`

### Validation
- `lib/validation/shipment-quality.ts`
- `lib/validation/shipment-hazmat.ts`
- `lib/validation/shipment-allergen.ts`
- `lib/validation/shipment-temperature.ts`

### Frontend Pages
- `apps/frontend/app/(authenticated)/settings/shipping/quality-templates/page.tsx`
- `apps/frontend/app/(authenticated)/settings/shipping/quality-templates/[id]/page.tsx`

### Components
- Quality: `QualityTemplatesList`, `QualityTemplateForm`, `CheckItemsList`, `CheckItemForm`, `ShipmentQualityChecks`, `QualityCheckItem`, `QualityCheckOverrideDialog`, `QualityStatusBadge`
- Hazmat: `HazmatIndicator`, `HazmatDeclarationForm`, `HazmatProductsList`, `HazmatLabelsRequired`, `HazmatCertificationCheckbox`
- Allergen: `AllergenValidationPanel`, `AllergenConflictsList`, `AllergenOverrideDialog`, `AllergenStatusBadge`
- Temperature: `TemperatureIndicator`, `TemperatureCheckPanel`, `TemperatureRequirements`

### Tests
- `lib/services/__tests__/shipment-quality-service.test.ts`
- `lib/services/__tests__/shipment-hazmat-service.test.ts`
- `lib/services/__tests__/shipment-allergen-service.test.ts`
- `lib/services/__tests__/shipment-temperature-service.test.ts`
- `tests/e2e/shipping/packing-quality-checks.spec.ts`
- `tests/e2e/shipping/packing-hazmat.spec.ts`
- `tests/e2e/shipping/packing-allergen.spec.ts`

## Definition of Done

- [ ] Database migration applied (7 new tables, products extension)
- [ ] RLS policies enabled and tested (org isolation)
- [ ] Quality templates CRUD working
- [ ] Quality check items CRUD working
- [ ] Shipment quality checks initialized from templates
- [ ] Quality check completion tracking (who/when/result)
- [ ] Quality check override with reason capture
- [ ] Mandatory checks block shipment completion
- [ ] Product hazmat fields editable in Technical module
- [ ] Hazmat detection identifies hazmat shipments
- [ ] HAZMAT indicator displays on packing page
- [ ] Hazmat declaration form pre-populated
- [ ] Hazmat declaration submission with certification
- [ ] DG declaration PDF generation
- [ ] Hazmat declaration required before shipping
- [ ] Allergen cross-check runs automatically
- [ ] Allergen conflicts displayed clearly
- [ ] Allergen override with reason and approval ref
- [ ] Allergen validation status integrated with packing
- [ ] Temperature requirements detected from products
- [ ] Temperature check verification checklist
- [ ] Temperature badge displays (FROZEN/CHILLED)
- [ ] All quality gates validated before Complete Packing
- [ ] Audit trail for all overrides and decisions
- [ ] Unit tests pass (>80% coverage)
- [ ] Integration tests pass
- [ ] E2E tests pass
- [ ] Multi-tenant isolation verified

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-01-15 | Initial story creation | ARCHITECT-AGENT |
