# 07.1 - Customers CRUD + Contacts + Addresses

**Priority**: P0 (MVP - Phase 1A)
**Complexity**: M (3-4 days)
**Type:** backend + frontend

**State:** ready
**Primary PRD:** `docs/1-BASELINE/product/modules/shipping.md` (FR-7.1 to FR-7.8)
**Architecture:** `docs/1-BASELINE/architecture/modules/shipping.md`

---

## MVP Scope

This story implements the foundational customer management system for the Shipping Module, enabling users to create, manage, and track customer information including multiple contacts and shipping addresses. This is a prerequisite for creating sales orders.

**In scope (this story):**
- Customers table CRUD (customer_code, name, email, phone, tax_id, credit_limit, allergen_restrictions)
- Customer contacts management (1:N relationship)
- Customer addresses management (1:N, billing/shipping types, default flag)
- Customer list view with filters (search, status, category)
- Customer detail view with tabs (info, contacts, addresses, order history placeholder)
- Form validation (Zod schemas)
- Multi-tenant isolation (RLS)
- Encrypted tax_id field (Supabase Vault)

**Out of scope (this story):**
- Customer order history (Story 07.3 - Sales Orders)
- Customer allergen validation against products (Story 07.3 - requires SO creation)
- Customer credit limits enforcement (Phase 1B)
- Customer pricing agreements (Phase 2)
- Customer categories/grouping (Phase 2)
- Customer payment terms (Phase 1B)

---

## Dependencies

### Epic Dependencies
- **Epic 01.1** - Organization context, RLS, users table, auth
- **Epic 01.6** - Role-based permissions (Admin, Sales roles)
- **Epic 02.3** - Allergens table (for allergen_restrictions JSONB array)

### Story Dependencies (within Epic 07)
- None (This is the first story in Epic 07)

### Provides To
- **07.3** - Sales Orders (customers required for SO creation)
- **07.6** - SO Cancellation (customer reference)
- **07.7** - Inventory Allocation (allergen validation)
- **07.15** - Shipping Dashboard (customer stats)

---

## Goal

Enable shipping clerks and sales managers to create and manage customer records with multiple contacts and shipping addresses, supporting the complete order-to-delivery workflow with full traceability and food safety compliance.

## User Story

As a **shipping clerk or sales manager**, I want to **manage customer records with multiple contacts and addresses** so that **I can accurately process orders, ensure correct delivery locations, and maintain customer allergen restrictions for food safety compliance**.

---

## Scope

**In scope (this story)**
- Create/Read/Update/Archive customers
- Customer fields: customer_code, name, email, phone, tax_id, credit_limit, allergen_restrictions, category, is_active, notes
- Customer contacts: name, title, email, phone, is_primary flag
- Customer addresses: address_type (billing/shipping), is_default flag, full address fields, dock_hours, delivery notes
- Customer list page with DataTable (search, filter by status/category, sort)
- Customer detail page with tabbed interface (Details, Contacts, Addresses, Order History placeholder)
- Form validation: email format, unique customer_code per org, required fields
- RLS policies for multi-tenant isolation
- Encrypted tax_id storage (PII compliance)

**Out of scope (this story)**
- Customer order history display (requires Story 07.3)
- Allergen validation UI (requires product data from Story 07.3)
- Customer credit limit warnings (Phase 1B)
- Customer portal/self-service (Phase 3)
- Customer import from CSV (Phase 2)
- Customer pricing agreements (Phase 2)

---

## Acceptance Criteria (Given/When/Then)

### AC-1: Customer List Page

**Given** a shipping clerk navigates to `/shipping/customers`
**When** the page loads
**Then** the customer list displays within 500ms with columns: Customer Code, Name, Email, Phone, Category, Status, and Actions

**Given** the customer list has 200 customers
**When** the clerk searches for "Acme"
**Then** only customers matching "Acme" in name, customer_code, or email display within 300ms

**Given** the customer list is displayed
**When** the clerk filters by status "inactive"
**Then** only archived/inactive customers appear

**Given** the customer list is displayed
**When** the clerk filters by category "wholesale"
**Then** only wholesale customers appear

### AC-2: Customer Creation

**Given** an admin clicks "Add Customer" on the customer list page
**When** the customer form modal opens
**Then** the form displays fields: customer_code, name, email, phone, tax_id, credit_limit, category, allergen_restrictions, notes

**Given** valid customer data is entered:
- customer_code: "CUST001"
- name: "Acme Foods Inc"
- email: "orders@acmefoods.com"
- phone: "+1-555-0123"
- category: "wholesale"
**When** the "Create" button is clicked
**Then** the customer is created and appears in the list within 1 second

**Given** a customer_code "CUST001" already exists in the organization
**When** a clerk attempts to create a new customer with the same code
**Then** an error displays: "Customer code already exists"

**Given** an invalid email format is entered (e.g., "invalid@")
**When** the form is submitted
**Then** an inline error displays: "Invalid email format"

### AC-3: Customer Details View

**Given** a clerk clicks on a customer row in the list
**When** the customer detail page loads
**Then** tabs display: Details, Contacts, Addresses, Order History (disabled)

**Given** the customer detail page is displayed
**When** the "Details" tab is active
**Then** all customer fields are displayed: customer_code, name, email, phone, tax_id (masked), credit_limit, category, allergen_restrictions, is_active, notes

**Given** the customer has allergen restrictions (e.g., ["peanuts", "dairy"])
**When** the Details tab is viewed
**Then** the allergen restrictions display as colored badges

### AC-4: Customer Contacts Management

**Given** a clerk navigates to the "Contacts" tab on customer detail page
**When** the tab loads
**Then** a list of all contacts for this customer displays (name, title, email, phone, is_primary)

**Given** the clerk clicks "Add Contact"
**When** the contact form modal opens
**Then** fields display: name (required), title, email, phone, is_primary checkbox

**Given** valid contact data is entered:
- name: "John Smith"
- title: "Purchasing Manager"
- email: "jsmith@acmefoods.com"
- phone: "+1-555-0124"
- is_primary: true
**When** "Save" is clicked
**Then** the contact is added and appears in the contacts list

**Given** a customer has 3 contacts and one is marked as primary
**When** a clerk marks a different contact as primary
**Then** the old primary contact is unmarked and the new contact is marked as primary (only one primary per customer)

**Given** a clerk clicks delete on a contact
**When** the confirmation dialog is accepted
**Then** the contact is removed from the list (soft delete)

### AC-5: Customer Addresses Management

**Given** a clerk navigates to the "Addresses" tab on customer detail page
**When** the tab loads
**Then** a list of all addresses for this customer displays (address_type, address, city, state, postal_code, is_default)

**Given** the clerk clicks "Add Address"
**When** the address form modal opens
**Then** fields display: address_type (billing/shipping), address_line1, address_line2, city, state, postal_code, country, dock_hours, notes, is_default checkbox

**Given** valid shipping address data is entered:
- address_type: "shipping"
- address_line1: "123 Main St"
- city: "Springfield"
- state: "IL"
- postal_code: "62701"
- country: "USA"
- is_default: true
**When** "Save" is clicked
**Then** the address is added and appears in the addresses list

**Given** a customer has 2 shipping addresses and one is marked as default
**When** a clerk marks a different address as default
**Then** the old default is unmarked and the new address is marked as default (only one default per address_type)

**Given** an address has dock_hours specified as `{"mon": "8-17", "tue": "8-17"}`
**When** the address is viewed
**Then** the dock hours display in a readable format: "Mon: 8:00 AM - 5:00 PM, Tue: 8:00 AM - 5:00 PM"

### AC-6: Customer Edit

**Given** an admin clicks "Edit" on a customer detail page
**When** the edit form modal opens
**Then** the form pre-populates with current customer data

**Given** the clerk updates the customer name from "Acme Foods Inc" to "Acme Foods International"
**When** "Save" is clicked
**Then** the updated name displays immediately on the detail page and in the list

**Given** the clerk updates the allergen_restrictions from ["peanuts"] to ["peanuts", "tree nuts", "dairy"]
**When** "Save" is clicked
**Then** the updated allergen restrictions display as badges

### AC-7: Customer Archive/Deactivate

**Given** an admin clicks "Archive" on an active customer
**When** the confirmation dialog is accepted
**Then** the customer status changes to "inactive" (is_active = false)

**Given** a customer is archived
**When** the customer list is viewed without filters
**Then** the archived customer does not appear (default filter = active only)

**Given** a customer is archived and has open sales orders
**When** the archive action is attempted
**Then** a warning displays: "Customer has open orders. Archive anyway?" (allow with confirmation)

**Given** an inactive customer is viewed
**When** the "Reactivate" button is clicked
**Then** the customer status changes to "active"

### AC-8: Tax ID Encryption

**Given** a clerk enters a tax ID (e.g., "12-3456789") in the customer form
**When** the customer is saved
**Then** the tax_id is encrypted at rest using Supabase Vault

**Given** a customer has an encrypted tax_id
**When** the customer detail page is viewed
**Then** the tax_id displays masked (e.g., "***-***-6789") except for last 4 digits

**Given** a user with admin role views a customer
**When** they click "Reveal Tax ID"
**Then** the full tax_id is decrypted and displayed (audit logged)

### AC-9: Multi-Tenant Isolation

**Given** two organizations (Org A and Org B) each have customers with code "CUST001"
**When** a user from Org A queries customers
**Then** only Org A's "CUST001" is returned (RLS enforced)

**Given** a user from Org A attempts to access a customer from Org B via direct API call
**When** the request is processed
**Then** a 404 error is returned (RLS blocks cross-org access)

### AC-10: Permission Enforcement

**Given** a user with role "VIEWER" navigates to `/shipping/customers`
**When** the page loads
**Then** the "Add Customer" button is hidden and all edit/delete actions are disabled (read-only)

**Given** a user with role "PROD_OPERATOR" attempts to access `/shipping/customers`
**When** the request is made
**Then** access is denied with message: "Insufficient permissions to access Customers"

**Given** a user with role "ADMIN" or "SALES" navigates to the customers page
**When** the page loads
**Then** full CRUD actions are available

---

## Implementation Notes

### API Endpoints

```typescript
// Customers
GET    /api/shipping/customers                    // List with filters
GET    /api/shipping/customers/:id                // Customer detail
POST   /api/shipping/customers                    // Create customer
PUT    /api/shipping/customers/:id                // Update customer
DELETE /api/shipping/customers/:id                // Archive customer (soft delete)

// Contacts
GET    /api/shipping/customers/:id/contacts       // List contacts
POST   /api/shipping/customers/:id/contacts       // Add contact
PUT    /api/shipping/customers/:id/contacts/:contactId  // Update contact
DELETE /api/shipping/customers/:id/contacts/:contactId  // Delete contact

// Addresses
GET    /api/shipping/customers/:id/addresses      // List addresses
POST   /api/shipping/customers/:id/addresses      // Add address
PUT    /api/shipping/customers/:id/addresses/:addressId  // Update address
DELETE /api/shipping/customers/:id/addresses/:addressId  // Delete address
PUT    /api/shipping/customers/:id/addresses/:addressId/set-default  // Set as default

// Future endpoints (Story 07.3+)
// GET    /api/shipping/customers/:id/orders         // Order history
// GET    /api/shipping/customers/:id/allergen-validation  // Validate against products
```

### Database Schema

```sql
-- Customers table (from architecture doc)
CREATE TABLE customers (
  id                    UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id                UUID NOT NULL REFERENCES organizations(id),
  customer_code         TEXT NOT NULL,
  name                  TEXT NOT NULL,
  email                 TEXT,
  phone                 TEXT,
  tax_id                TEXT,                    -- Encrypted via Supabase Vault
  credit_limit          DECIMAL(15,2),
  payment_terms_days    INTEGER DEFAULT 30,
  category              TEXT,                    -- retail, wholesale, distributor
  allergen_restrictions JSONB,                   -- Array of allergen IDs
  is_active             BOOLEAN DEFAULT true,
  notes                 TEXT,
  created_at            TIMESTAMPTZ DEFAULT now(),
  created_by            UUID REFERENCES users(id),
  updated_at            TIMESTAMPTZ DEFAULT now(),

  CONSTRAINT customers_org_code_unique UNIQUE(org_id, customer_code)
);

-- Customer contacts table
CREATE TABLE customer_contacts (
  id                    UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id                UUID NOT NULL REFERENCES organizations(id),
  customer_id           UUID NOT NULL REFERENCES customers(id) ON DELETE CASCADE,
  name                  TEXT NOT NULL,
  title                 TEXT,
  email                 TEXT,
  phone                 TEXT,
  is_primary            BOOLEAN DEFAULT false,
  created_at            TIMESTAMPTZ DEFAULT now()
);

-- Customer addresses table
CREATE TABLE customer_addresses (
  id                    UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id                UUID NOT NULL REFERENCES organizations(id),
  customer_id           UUID NOT NULL REFERENCES customers(id) ON DELETE CASCADE,
  address_type          TEXT NOT NULL,           -- billing, shipping
  is_default            BOOLEAN DEFAULT false,
  address_line1         TEXT NOT NULL,
  address_line2         TEXT,
  city                  TEXT NOT NULL,
  state                 TEXT,
  postal_code           TEXT NOT NULL,
  country               TEXT NOT NULL,
  dock_hours            JSONB,                   -- {mon: "8-17", ...}
  notes                 TEXT,                    -- Delivery instructions
  created_at            TIMESTAMPTZ DEFAULT now()
);

-- Indexes
CREATE INDEX idx_customers_org_code ON customers(org_id, customer_code);
CREATE INDEX idx_customers_org_active ON customers(org_id, is_active);
CREATE INDEX idx_customers_name ON customers(name);
CREATE INDEX idx_customers_email ON customers(email);
CREATE INDEX idx_customer_contacts_customer ON customer_contacts(customer_id);
CREATE INDEX idx_customer_addresses_customer ON customer_addresses(customer_id);

-- RLS Policies
ALTER TABLE customers ENABLE ROW LEVEL SECURITY;
ALTER TABLE customer_contacts ENABLE ROW LEVEL SECURITY;
ALTER TABLE customer_addresses ENABLE ROW LEVEL SECURITY;

CREATE POLICY "customers_org_isolation" ON customers
  FOR ALL USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

CREATE POLICY "customer_contacts_org_isolation" ON customer_contacts
  FOR ALL USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

CREATE POLICY "customer_addresses_org_isolation" ON customer_addresses
  FOR ALL USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));
```

### Frontend Components

```
apps/frontend/app/(authenticated)/shipping/customers/
  page.tsx                          -- Customer list page
  [id]/page.tsx                     -- Customer detail page
  new/page.tsx                      -- Create customer page (optional, or use modal)
  components/
    CustomerTable.tsx               -- DataTable with search, filters, sort
    CustomerForm.tsx                -- Create/Edit customer form
    ContactsTab.tsx                 -- Contacts list + CRUD
    ContactForm.tsx                 -- Add/Edit contact modal
    AddressesTab.tsx                -- Addresses list + CRUD
    AddressForm.tsx                 -- Add/Edit address modal
    CustomerDetailsTab.tsx          -- Customer info display
    CustomerOrderHistory.tsx        -- Placeholder for Story 07.3
    CustomerStatusBadge.tsx         -- Active/Inactive badge
    CustomerCategoryBadge.tsx       -- Category badge
    AllergenBadge.tsx               -- Individual allergen badge
```

### Services

```typescript
// lib/services/customer-service.ts
export class CustomerService {
  static async listCustomers(filters: {
    search?: string;
    status?: 'active' | 'inactive';
    category?: string;
    page?: number;
    limit?: number;
  }): Promise<{ customers: Customer[]; total: number }>;

  static async getCustomer(id: string): Promise<Customer>;

  static async createCustomer(data: CreateCustomerInput): Promise<Customer>;

  static async updateCustomer(id: string, data: UpdateCustomerInput): Promise<Customer>;

  static async archiveCustomer(id: string): Promise<void>;

  static async reactivateCustomer(id: string): Promise<void>;

  static async validateCustomerCode(code: string, orgId: string, excludeId?: string): Promise<boolean>;

  // Contacts
  static async listContacts(customerId: string): Promise<CustomerContact[]>;

  static async createContact(customerId: string, data: CreateContactInput): Promise<CustomerContact>;

  static async updateContact(customerId: string, contactId: string, data: UpdateContactInput): Promise<CustomerContact>;

  static async deleteContact(customerId: string, contactId: string): Promise<void>;

  static async setPrimaryContact(customerId: string, contactId: string): Promise<void>;

  // Addresses
  static async listAddresses(customerId: string): Promise<CustomerAddress[]>;

  static async createAddress(customerId: string, data: CreateAddressInput): Promise<CustomerAddress>;

  static async updateAddress(customerId: string, addressId: string, data: UpdateAddressInput): Promise<CustomerAddress>;

  static async deleteAddress(customerId: string, addressId: string): Promise<void>;

  static async setDefaultAddress(customerId: string, addressId: string, addressType: 'billing' | 'shipping'): Promise<void>;
}
```

### Validation (Zod)

```typescript
// lib/validation/customer-schema.ts
import { z } from 'zod';

export const customerSchema = z.object({
  customer_code: z.string()
    .min(1, "Customer code is required")
    .max(50, "Customer code must be at most 50 characters")
    .regex(/^[A-Z0-9-]+$/, "Customer code must contain only uppercase letters, numbers, and hyphens"),
  name: z.string()
    .min(1, "Customer name is required")
    .max(200, "Customer name must be at most 200 characters"),
  email: z.string()
    .email("Invalid email format")
    .optional()
    .nullable(),
  phone: z.string()
    .max(50, "Phone must be at most 50 characters")
    .optional()
    .nullable(),
  tax_id: z.string()
    .max(50, "Tax ID must be at most 50 characters")
    .optional()
    .nullable(),
  credit_limit: z.number()
    .min(0, "Credit limit must be non-negative")
    .optional()
    .nullable(),
  payment_terms_days: z.number()
    .int()
    .min(0, "Payment terms must be non-negative")
    .default(30),
  category: z.enum(['retail', 'wholesale', 'distributor', 'other'])
    .optional()
    .nullable(),
  allergen_restrictions: z.array(z.string())
    .optional()
    .default([]),
  is_active: z.boolean().default(true),
  notes: z.string().optional().nullable(),
});

export const customerContactSchema = z.object({
  name: z.string()
    .min(1, "Contact name is required")
    .max(100, "Name must be at most 100 characters"),
  title: z.string()
    .max(100, "Title must be at most 100 characters")
    .optional()
    .nullable(),
  email: z.string()
    .email("Invalid email format")
    .optional()
    .nullable(),
  phone: z.string()
    .max(50, "Phone must be at most 50 characters")
    .optional()
    .nullable(),
  is_primary: z.boolean().default(false),
});

export const customerAddressSchema = z.object({
  address_type: z.enum(['billing', 'shipping']),
  is_default: z.boolean().default(false),
  address_line1: z.string()
    .min(1, "Address line 1 is required")
    .max(200, "Address line 1 must be at most 200 characters"),
  address_line2: z.string()
    .max(200, "Address line 2 must be at most 200 characters")
    .optional()
    .nullable(),
  city: z.string()
    .min(1, "City is required")
    .max(100, "City must be at most 100 characters"),
  state: z.string()
    .max(50, "State must be at most 50 characters")
    .optional()
    .nullable(),
  postal_code: z.string()
    .min(1, "Postal code is required")
    .max(20, "Postal code must be at most 20 characters"),
  country: z.string()
    .min(1, "Country is required")
    .max(100, "Country must be at most 100 characters"),
  dock_hours: z.record(z.string(), z.string())
    .optional()
    .nullable(),
  notes: z.string()
    .max(500, "Notes must be at most 500 characters")
    .optional()
    .nullable(),
});
```

### Key Business Rules

1. **Unique Customer Code**: `customer_code` must be unique per organization (enforced by database constraint)
2. **Only One Primary Contact**: When marking a contact as primary, unmark any existing primary contact for that customer
3. **Only One Default Address per Type**: When marking an address as default, unmark any existing default for that address_type (billing vs shipping)
4. **Cascade Delete**: When a customer is archived, contacts and addresses remain but are not shown by default
5. **Tax ID Encryption**: Store tax_id using Supabase Vault encryption, display masked (last 4 digits only) except for admin users with "reveal" permission
6. **Allergen Restrictions**: Store as JSONB array of allergen IDs (references allergens table from Epic 02.3)
7. **Category Values**: Enum constraint on category field: retail, wholesale, distributor, other
8. **Address Type Values**: Enum constraint on address_type: billing, shipping
9. **Soft Delete**: Archive customers by setting `is_active = false`, not physical deletion (maintains referential integrity for historical orders)

---

## Food Safety Rules

### Allergen Validation

- Customer `allergen_restrictions` is stored as JSONB array of allergen IDs (e.g., `["uuid-1", "uuid-2"]`)
- Reference allergens from `allergens` table (Epic 02.3)
- Display allergen names as colored badges on customer detail page
- Validation against products occurs in Story 07.3 (Sales Order creation)
- Example: If customer has restriction `["peanut_allergen_id", "dairy_allergen_id"]`, any sales order for this customer will be validated against product allergens

---

## Deliverables

- **Database Migration**: Create `customers`, `customer_contacts`, `customer_addresses` tables with RLS policies
- **API Routes**:
  - `/api/shipping/customers` (GET, POST)
  - `/api/shipping/customers/:id` (GET, PUT, DELETE)
  - `/api/shipping/customers/:id/contacts` (GET, POST, PUT, DELETE)
  - `/api/shipping/customers/:id/addresses` (GET, POST, PUT, DELETE)
  - `/api/shipping/customers/:id/addresses/:addressId/set-default` (PUT)
- **Frontend Pages**:
  - Customer list page (`/shipping/customers`)
  - Customer detail page (`/shipping/customers/:id`)
- **Components**:
  - CustomerTable (DataTable with search, filters)
  - CustomerForm (Create/Edit modal)
  - ContactsTab + ContactForm
  - AddressesTab + AddressForm
  - CustomerDetailsTab
  - Status and category badges
- **Services**: `customer-service.ts` with CRUD operations
- **Validation**: Zod schemas for customers, contacts, addresses
- **Tests**:
  - Unit tests for customer-service (>80% coverage)
  - Integration tests for all API endpoints
  - E2E test for complete customer creation workflow

---

## Definition of Done

- [ ] Database tables created with RLS policies enabled
- [ ] All API endpoints functional and returning correct data
- [ ] Customer list page loads within 500ms for 200 customers
- [ ] Search and filter work within 300ms
- [ ] Create customer form validates all fields
- [ ] Customer detail page displays all tabs correctly
- [ ] Contact CRUD operations work end-to-end
- [ ] Address CRUD operations work end-to-end
- [ ] Only one primary contact per customer enforced
- [ ] Only one default address per type enforced
- [ ] Tax ID encrypted at rest and masked in UI
- [ ] Allergen restrictions display as badges
- [ ] Multi-tenant isolation verified (RLS tests pass)
- [ ] Permission checks hide unauthorized actions
- [ ] Unit tests pass (>80% coverage for services)
- [ ] Integration tests pass for all API endpoints
- [ ] E2E test passes for customer creation workflow
- [ ] Code reviewed and approved
- [ ] Documentation updated (API docs, component docs)

---

## Future Phases (Not in This Story)

### Phase 1B
- Customer credit limit warnings during order creation (Story 07.3)
- Customer payment terms enforcement (Story 07.3)

### Phase 2
- Customer categories/grouping for bulk actions
- Customer pricing agreements (special pricing per product)
- Customer order history analytics (charts, trends)
- Customer import from CSV/API
- Customer export to CSV
- Customer portal for self-service order tracking

### Phase 3
- Customer tiering (Gold/Silver/Bronze with automatic discounts)
- Customer loyalty program integration
- Customer EDI integration (850/810)
- Customer-specific shipping rules
- Customer sales forecasting
- Advanced customer analytics (predictive ordering, churn risk)

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-12-16 | Initial story creation | PM-AGENT |
