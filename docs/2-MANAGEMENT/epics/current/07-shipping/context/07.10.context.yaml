story:
  id: "07.10"
  name: "Pick Confirmation - Scanner/Mobile UI"
  epic: "07-shipping"
  phase: "1C"
  complexity: "L"
  estimate_days: 4-5
  priority: "P0"
  type: "frontend + backend (scanner)"

dependencies:
  required:
    - story: "01.1"
      provides: ["organizations", "users", "roles", "RLS"]
      epic: "01-settings"
    - story: "01.9"
      provides: ["locations", "location hierarchy (zone/aisle/bin)"]
      epic: "01-settings"
    - story: "02.1"
      provides: ["products"]
      epic: "02-technical"
    - story: "02.3"
      provides: ["allergens"]
      epic: "02-technical"
    - story: "05.1"
      provides: ["license_plates"]
      epic: "05-warehouse"
    - story: "05.3"
      provides: ["lp_reservations", "inventory allocations"]
      epic: "05-warehouse"
    - story: "07.3"
      provides: ["sales_orders table"]
      epic: "07-shipping"
    - story: "07.7"
      provides: ["inventory_allocations table", "allocation logic"]
      epic: "07-shipping"
    - story: "07.8"
      provides: ["pick_lists", "pick_list_lines tables"]
      epic: "07-shipping"
      blocker: true
    - story: "07.9"
      provides: ["pick confirmation logic", "short pick handling", "status transitions"]
      epic: "07-shipping"
      blocker: true

  provides_to:
    - story: "07.11"
      needs: ["completed pick lists"]
      description: "Packing station workflow uses picked items"
    - story: "07.12"
      needs: ["scanner patterns", "audio/vibration hooks"]
      description: "Pack confirmation scanner reuses scanner components"

files_to_read:
  prd: "docs/1-BASELINE/product/modules/shipping.md"
  prd_sections: ["FR-7.25", "FR-7.26", "FR-7.27", "FR-7.28"]
  architecture: "docs/1-BASELINE/architecture/modules/shipping.md"
  architecture_sections:
    - lines: "507-517"
      description: "Scanner endpoints"
    - lines: "630-641"
      description: "Scanner component structure"
    - lines: "1050-1072"
      description: "Scanner UI requirements (touch targets, audio, offline)"
  story: "docs/2-MANAGEMENT/epics/current/07-shipping/07.10.pick-scanner.md"
  related_stories:
    - "docs/2-MANAGEMENT/epics/current/07-shipping/07.8.pick-list-generation.md"
    - "docs/2-MANAGEMENT/epics/current/07-shipping/07.9.pick-confirmation-desktop.md"
  patterns:
    - "docs/1-BASELINE/architecture/patterns/ADR-013-rls-policies.md"
    - "apps/frontend/app/(authenticated)/scanner/"  # Reference for scanner patterns

files_to_create:
  api:
    - path: "apps/frontend/app/api/shipping/scanner/pick/route.ts"
      methods: ["POST"]
      auth: true
      roles: ["Picker", "Warehouse", "Manager", "Admin"]
      description: "Scanner-optimized pick confirmation endpoint"
    - path: "apps/frontend/app/api/shipping/scanner/lookup/lp/[barcode]/route.ts"
      methods: ["GET"]
      auth: true
      roles: ["Picker", "Warehouse", "Manager", "Admin"]
      description: "LP quick lookup for barcode validation"
    - path: "apps/frontend/app/api/shipping/scanner/suggest-pick/[lineId]/route.ts"
      methods: ["GET"]
      auth: true
      roles: ["Picker", "Warehouse", "Manager", "Admin"]
      description: "Suggest best LP for a pick line (FIFO/FEFO)"

  services:
    - path: "lib/services/scanner-pick-service.ts"
      methods:
        - "confirmPick(params)"
        - "lookupLP(barcode)"
        - "suggestPick(lineId)"
        - "startPickList(pickListId)"
        - "getPickListForScanner(pickListId)"

  validation:
    - path: "lib/validation/scanner-pick-schema.ts"
      schemas:
        - "scannerPickSchema"
        - "lpLookupSchema"

  pages:
    - path: "apps/frontend/app/(authenticated)/scanner/shipping/pick/page.tsx"
      description: "Main scanner pick page"

  components:
    - path: "apps/frontend/app/(authenticated)/scanner/shipping/pick/components/MyPicksList.tsx"
      description: "List of assigned pick lists"
    - path: "apps/frontend/app/(authenticated)/scanner/shipping/pick/components/PickLineCard.tsx"
      description: "Current pick line display"
    - path: "apps/frontend/app/(authenticated)/scanner/shipping/pick/components/LocationCard.tsx"
      description: "Location display with zone badge"
    - path: "apps/frontend/app/(authenticated)/scanner/shipping/pick/components/ProductCard.tsx"
      description: "Product info (name, SKU, lot, BBD)"
    - path: "apps/frontend/app/(authenticated)/scanner/shipping/pick/components/QuantityCard.tsx"
      description: "Quantity display and expected LP"
    - path: "apps/frontend/app/(authenticated)/scanner/shipping/pick/components/ScanInput.tsx"
      description: "Barcode scan input with auto-focus"
    - path: "apps/frontend/app/(authenticated)/scanner/shipping/pick/components/NumberPad.tsx"
      description: "64x64 number pad buttons for quantity entry"
    - path: "apps/frontend/app/(authenticated)/scanner/shipping/pick/components/ShortPickModal.tsx"
      description: "Short pick dialog with reason dropdown"
    - path: "apps/frontend/app/(authenticated)/scanner/shipping/pick/components/AllergenBanner.tsx"
      description: "Red allergen warning banner"
    - path: "apps/frontend/app/(authenticated)/scanner/shipping/pick/components/FifoWarning.tsx"
      description: "FIFO/FEFO warning with override"
    - path: "apps/frontend/app/(authenticated)/scanner/shipping/pick/components/ProgressBar.tsx"
      description: "Line progress indicator (X of Y)"
    - path: "apps/frontend/app/(authenticated)/scanner/shipping/pick/components/PickComplete.tsx"
      description: "Completion celebration screen"
    - path: "apps/frontend/app/(authenticated)/scanner/shipping/pick/components/ScannerSettings.tsx"
      description: "Settings modal (audio, vibration, display)"

  hooks:
    - path: "apps/frontend/app/(authenticated)/scanner/shipping/pick/hooks/useAudioFeedback.ts"
      description: "Web Audio API integration for success/error tones"
    - path: "apps/frontend/app/(authenticated)/scanner/shipping/pick/hooks/useVibration.ts"
      description: "Navigator.vibrate() API integration"
    - path: "apps/frontend/app/(authenticated)/scanner/shipping/pick/hooks/useScanInput.ts"
      description: "Barcode input handling (camera + hardware scanner)"
    - path: "apps/frontend/app/(authenticated)/scanner/shipping/pick/hooks/usePickProgress.ts"
      description: "Pick list progress tracking"

  utils:
    - path: "apps/frontend/app/(authenticated)/scanner/shipping/pick/utils/audioTones.ts"
      description: "Audio tone frequency/duration definitions"
    - path: "apps/frontend/app/(authenticated)/scanner/shipping/pick/utils/vibrationPatterns.ts"
      description: "Vibration pattern definitions"

  tests:
    - path: "lib/services/__tests__/scanner-pick-service.test.ts"
      type: "unit"
      coverage: ">80%"
    - path: "tests/e2e/shipping/scanner-pick.spec.ts"
      type: "e2e"
      scenarios:
        - "Full pick workflow (start -> pick all -> complete)"
        - "Short pick flow (skip line, capture reason)"
        - "Invalid LP scan (error feedback)"
        - "FIFO warning and override"

database:
  tables:
    - name: "pick_list_lines"
      note: "Existing table from Story 07.8, add columns if not present from 07.9"
      columns_to_add:
        - "short_pick_reason TEXT"
        - "short_pick_notes TEXT"
      new_indexes:
        - "idx_pick_list_lines_pending ON pick_list_lines(pick_list_id, status) WHERE status = 'pending'"

api_endpoints:
  - method: "POST"
    path: "/api/shipping/scanner/pick"
    auth: true
    roles: ["Picker", "Warehouse", "Manager", "Admin"]
    input:
      pick_line_id: "string (uuid)"
      scanned_lp_barcode: "string"
      quantity_picked: "number"
      short_pick: "boolean"
      short_pick_reason: "string (optional, required if short_pick)"
      short_pick_notes: "string (optional)"
    output:
      success: "boolean"
      pick_line_status: "'picked' | 'short'"
      next_line: "PickLinePreview | null"
      progress: "{ total_lines, picked_lines, short_lines }"
      pick_list_complete: "boolean"
    business_logic:
      - "Validate scanned LP matches expected (or acceptable alternate)"
      - "Update pick_list_line: quantity_picked, status, picked_at, picked_by, picked_license_plate_id"
      - "If short_pick, store reason and trigger backorder workflow"
      - "Calculate next pending line (by pick_sequence)"
      - "Check if all lines picked/short -> mark pick_list complete"
      - "Return optimized response with next line preview"
    performance:
      target: "< 200ms p95"

  - method: "GET"
    path: "/api/shipping/scanner/lookup/lp/:barcode"
    auth: true
    roles: ["Picker", "Warehouse", "Manager", "Admin"]
    output:
      lp_number: "string"
      product_id: "string (uuid)"
      product_name: "string"
      product_sku: "string"
      lot_number: "string"
      best_before_date: "string | null"
      on_hand_quantity: "number"
      location_id: "string (uuid)"
      location_path: "string"
      allergens: "string[]"
      qa_status: "string"
    error_codes:
      404: "LP not found"
    business_logic:
      - "Fast lookup: LP + product + location join"
      - "Return null/404 if not found"
      - "Filter by org_id (RLS)"
    performance:
      target: "< 100ms p95"

  - method: "GET"
    path: "/api/shipping/scanner/suggest-pick/:lineId"
    auth: true
    roles: ["Picker", "Warehouse", "Manager", "Admin"]
    output:
      suggested_lp: "string"
      alternate_lps: "LPPreview[]"
      fifo_warning: "boolean"
    business_logic:
      - "Return suggested LP from allocation"
      - "List alternate LPs for same product (if available)"
      - "Flag if suggested LP is oldest (FIFO compliant)"

ux:
  wireframes:
    - id: "SCAN-001"
      name: "My Picks List"
      path: "docs/2-MANAGEMENT/epics/current/07-shipping/07.10.pick-scanner.md#screen-1-my-picks-list"
      description: "List of assigned pick lists with priority badges"
    - id: "SCAN-002"
      name: "Pick Line (Active)"
      path: "docs/2-MANAGEMENT/epics/current/07-shipping/07.10.pick-scanner.md#screen-2-pick-line-active-picking"
      description: "Current pick line with location, product, qty, scan input"
    - id: "SCAN-003"
      name: "Quantity Confirmation"
      path: "docs/2-MANAGEMENT/epics/current/07-shipping/07.10.pick-scanner.md#screen-3-quantity-confirmation"
      description: "Number pad for quantity entry"
    - id: "SCAN-004"
      name: "Short Pick Modal"
      path: "docs/2-MANAGEMENT/epics/current/07-shipping/07.10.pick-scanner.md#screen-4-short-pick-modal"
      description: "Short pick dialog with reason dropdown"
    - id: "SCAN-005"
      name: "Pick Complete"
      path: "docs/2-MANAGEMENT/epics/current/07-shipping/07.10.pick-scanner.md#screen-5-pick-list-complete"
      description: "Completion celebration screen"

  patterns:
    mobile_first: "Design for 320px minimum viewport width"
    touch_targets: "48x48px minimum, 64x64px for number pad"
    auto_focus: "Scan input auto-focus after each action"
    feedback: "Immediate visual + audio + vibration feedback"
    progress: "Progress bar always visible"

  components:
    - "MyPicksList: Large touch rows (64px), priority badges, Start/Continue buttons"
    - "PickLineCard: Location + Product + Quantity cards stacked"
    - "LocationCard: Zone badge, large path text (32px)"
    - "ProductCard: Name, SKU, lot, BBD"
    - "QuantityCard: Large qty (32px), expected LP"
    - "ScanInput: Full-width input, auto-focus, clear button"
    - "NumberPad: 64x64 buttons, 0-9 + Clear + Backspace"
    - "ShortPickModal: Qty input, reason dropdown, notes, confirm"
    - "AllergenBanner: Red background, warning icon, persistent"
    - "FifoWarning: Amber banner, override button"
    - "ProgressBar: X of Y text + visual bar"
    - "PickComplete: Green background, checkmark animation, summary"
    - "ScannerSettings: Audio volume, vibration toggle, display options"

  states:
    - "loading: Skeleton loaders for pick list and lines"
    - "empty: 'No picks assigned' message"
    - "scanning: Waiting for barcode scan"
    - "validating: LP validation in progress"
    - "success: Green flash, success tone, vibration"
    - "error: Red flash, error tone, vibration, error message"
    - "warning: Amber flash, FIFO/allergen warning"
    - "confirming: Quantity entry mode"
    - "short_pick: Short pick modal open"
    - "complete: Pick list completion screen"

audio_feedback:
  - event: "Start Pick List"
    frequency: "440Hz"
    duration: "100ms"
    pattern: "Single tone"
  - event: "Valid LP Scan"
    frequency: "880Hz"
    duration: "150ms"
    pattern: "Single high tone"
  - event: "Invalid LP Scan"
    frequency: "220Hz"
    duration: "300ms"
    pattern: "Descending tone"
  - event: "Quantity Confirmed"
    frequency: "660Hz -> 880Hz"
    duration: "200ms"
    pattern: "Rising sweep"
  - event: "Pick Line Complete"
    frequency: "880Hz"
    duration: "100ms x2"
    pattern: "Double beep"
  - event: "Pick List Complete"
    frequency: "440Hz -> 880Hz"
    duration: "500ms"
    pattern: "Victory sweep"
  - event: "Error (General)"
    frequency: "220Hz"
    duration: "200ms x2"
    pattern: "Double low"
  - event: "Short Pick"
    frequency: "440Hz + 554Hz"
    duration: "200ms"
    pattern: "Chord"

vibration_feedback:
  - event: "Valid Scan"
    pattern: [100]
    unit: "ms"
  - event: "Invalid Scan"
    pattern: [200, 100, 200]
    description: "vibrate, pause, vibrate"
  - event: "Pick Complete"
    pattern: [100, 50, 100]
  - event: "Error"
    pattern: [300, 100, 300]

visual_feedback:
  - event: "Valid Scan"
    color: "#22C55E"
    duration: "200ms"
    animation: "Flash overlay + fade"
  - event: "Invalid Scan"
    color: "#EF4444"
    duration: "300ms"
    animation: "Flash overlay + shake"
  - event: "Warning"
    color: "#F59E0B"
    duration: "250ms"
    animation: "Flash border"
  - event: "Pick Complete"
    color: "#22C55E"
    duration: "300ms"
    animation: "Full screen + scale"

accessibility:
  wcag_level: "AA"
  touch_targets:
    minimum: "48x48px"
    buttons: "56px height"
    number_pad: "64x64px"
    list_rows: "64px min height"
    spacing: "8px between targets"
  color_contrast:
    text_on_background: "4.5:1 minimum"
    large_text: "3:1 minimum"
    ui_components: "3:1 against adjacent"
  focus_management:
    visible_focus: true
    auto_focus: "Scan input after each action"
    tab_order: "Logical through UI"
    focus_trap: "In modals"
  screen_reader:
    semantic_html: true
    aria_labels: "All interactive elements"
    live_regions: "Status updates"
    announce_scan: "Scan results announced"

validation_rules:
  pick_line_id: "UUID"
  scanned_lp_barcode: "Non-empty string"
  quantity_picked: "Positive number, <= quantity_to_pick (unless override)"
  short_pick: "Boolean"
  short_pick_reason: "Required if short_pick = true, enum: insufficient_inventory, product_not_found, product_damaged, location_empty, other"

patterns:
  rls: "ADR-013 - All tables have org_id filter"
  api: "REST with org_id filter from auth context"
  service: "Class-based with static methods"
  validation: "Zod schemas for all inputs"
  audio: "Web Audio API (AudioContext)"
  vibration: "Navigator.vibrate() API"
  scanner_input: "Hardware scanner or camera (QuaggaJS/ZXing)"

business_rules:
  - "LP Validation: Scanned LP must match expected LP or be acceptable alternate (same product, available qty)"
  - "FIFO/FEFO Warning: Warn if picker scans newer lot than suggested (allow override with logging)"
  - "Short Pick: Any quantity < quantity_to_pick triggers short pick flow with reason required"
  - "Auto-Advance: After successful pick, auto-advance to next pending line by pick_sequence"
  - "Pick Complete: When all lines picked or short, mark pick_list.status = 'completed'"
  - "Allergen Alert: Display red banner for products with customer allergen conflicts"
  - "RLS Enforcement: All queries filtered by org_id from auth context"
  - "Performance: Scan feedback < 100ms, API response < 200ms"

performance_requirements:
  - metric: "Scan feedback"
    target: "< 100ms"
    description: "Time from scan to visual/audio feedback"
  - metric: "API response"
    target: "< 200ms"
    description: "p95 latency for scanner endpoints"
  - metric: "Page initial load"
    target: "< 2s"
    description: "First contentful paint"
  - metric: "Time to interactive"
    target: "< 3s"
    description: "After page load"
  - metric: "Memory usage"
    target: "< 100MB"
    description: "Browser memory"

acceptance_checklist:
  - "Scanner page renders at /scanner/shipping/pick"
  - "My Picks list displays assigned pick lists sorted by priority"
  - "Start pick list updates status to 'in_progress'"
  - "Current pick line shows location, product, quantity, expected LP"
  - "Scan input auto-focuses after each action"
  - "Valid LP scan triggers success feedback (green, beep, vibration)"
  - "Invalid LP scan triggers error feedback (red, error beep, vibration)"
  - "LP lookup API returns in < 100ms"
  - "Number pad allows quantity adjustment (64x64 buttons)"
  - "Confirm pick updates pick_list_lines and advances to next line"
  - "Short pick flow captures reason and creates backorder"
  - "Allergen warning banner displays for products with allergens"
  - "FIFO/FEFO warning displays when scanning newer lot"
  - "Pick list completion shows celebration screen"
  - "Scanner pick API returns in < 200ms"
  - "All touch targets are 48x48px minimum"
  - "High contrast mode available"
  - "Audio feedback configurable (volume, mute)"
  - "Vibration feedback works on mobile devices"
  - "RLS policies enforce org isolation"
  - "Unit tests pass (>80% coverage)"
  - "E2E tests for full pick workflow, short pick, invalid scan, FIFO warning"
  - "Tested on Zebra TC52, Honeywell CT40, and mobile phones"

output_artifacts:
  - "3 API endpoints (pick, lookup/lp, suggest-pick)"
  - "ScannerPickService with 5 methods"
  - "2 Zod validation schemas"
  - "1 scanner page"
  - "13 React components"
  - "4 custom hooks"
  - "2 utility files"
  - "Unit tests (>80% coverage)"
  - "E2E tests (4 scenarios)"

device_support:
  hardware_scanners:
    - "Zebra TC52"
    - "Zebra TC21"
    - "Honeywell CT40"
    - "Honeywell CT60"
  mobile_phones:
    - "iOS Safari (iPhone 8+)"
    - "Android Chrome (Android 8+)"
  browsers:
    - "Chrome 90+"
    - "Safari 14+"
    - "Edge 90+"

notes:
  - "This story depends on Story 07.9 (Desktop Pick Confirmation) for core pick logic"
  - "Offline mode is deferred to Phase 2 - document but do not implement"
  - "Audio uses Web Audio API for low-latency playback"
  - "Vibration uses Navigator.vibrate() with graceful fallback"
  - "Barcode scanning supports both hardware scanners and camera (QuaggaJS/ZXing)"
  - "All feedback must be < 100ms to feel instant in warehouse environment"
  - "Test in bright warehouse lighting conditions"
