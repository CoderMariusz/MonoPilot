# Story Context: 07.7 Inventory Allocation Engine (FIFO/FEFO + Backorders)
# Generated: 2025-12-16
# Purpose: AI agent context for implementing inventory allocation engine

story:
  id: "07.7"
  name: "Inventory Allocation Engine (FIFO/FEFO + Backorders)"
  epic: "07-shipping"
  phase: "1B"
  complexity: "L"
  estimate_days: 4-5
  type: "backend"
  state: "blocked"
  priority: "P0"
  story_file: "docs/2-MANAGEMENT/epics/current/07-shipping/07.7.inventory-allocation.md"

blockers:
  - epic: "05"
    name: "Warehouse Module - LP Foundation"
    status: "IN_PROGRESS"
    required_stories:
      - story: "05.1"
        name: "License Plates Schema"
        provides: ["license_plates table", "status column", "qa_status column"]
      - story: "05.3"
        name: "LP Reservations"
        provides: ["lp_reservations table", "reservation workflow"]
      - story: "05.4"
        name: "FIFO/FEFO Patterns"
        provides: ["query patterns", "expiry_date handling"]

dependencies:
  required:
    - story: "01.1"
      name: "Org Context + Base RLS"
      provides:
        - "organizations table"
        - "org_id context"
        - "RLS policies for tenant isolation"
    - story: "02.1"
      name: "Products CRUD"
      provides:
        - "products table"
        - "picking_strategy column"
    - story: "02.2"
      name: "Product Settings"
      provides:
        - "shelf_life_days column"
    - story: "05.1"
      name: "License Plates Schema"
      status: "BLOCKER"
      provides:
        - "license_plates table"
        - "status enum (available, reserved, consumed, blocked)"
        - "qa_status enum (pending, passed, failed, quarantine)"
        - "expiry_date column"
        - "quantity column"
    - story: "05.3"
      name: "LP Reservations"
      status: "BLOCKER"
      provides:
        - "lp_reservations table"
        - "reservation workflow"
    - story: "07.2"
      name: "Sales Orders Core"
      provides:
        - "sales_orders table"
        - "sales_order_lines table"
        - "quantity_allocated column"
    - story: "07.3"
      name: "SO Status Workflow"
      provides:
        - "status transitions"
        - "confirmed status"

files_to_read:
  prd: "docs/1-BASELINE/product/modules/shipping.md"
  prd_sections:
    - "FR-7.12"  # Inventory Allocation (Auto/Manual)
    - "FR-7.16"  # Backorder Management
    - "FR-7.18"  # Reserved Inventory Tracking
  architecture: "docs/1-BASELINE/architecture/modules/shipping.md"
  architecture_sections:
    - "lines 128-139"   # inventory_allocations table schema
    - "lines 332-334"   # allocation indexes
    - "lines 664-694"   # allocation flow diagram
    - "lines 790-819"   # FIFO/FEFO algorithm
    - "lines 994-999"   # allocation business rules
  warehouse_architecture: "docs/1-BASELINE/architecture/modules/warehouse.md"
  warehouse_sections:
    - "lines 30-60"     # license_plates table schema
    - "lines 176-188"   # lp_reservations table
    - "lines 599-617"   # FIFO/FEFO pick suggestion flow
    - "lines 789-817"   # FIFO/FEFO business rules
  story: "docs/2-MANAGEMENT/epics/current/07-shipping/07.7.inventory-allocation.md"
  brief: "docs/2-MANAGEMENT/epics/current/07-shipping/STORY-WRITING-BRIEF.md"
  patterns:
    - "apps/frontend/lib/services/*.ts"  # Service layer patterns
    - "supabase/migrations/*.sql"        # Migration patterns

files_to_create:
  database:
    - path: "supabase/migrations/YYYYMMDDHHMMSS_create_inventory_allocations.sql"
      type: "migration"
      description: "Create inventory_allocations table with RLS"
    - path: "supabase/migrations/YYYYMMDDHHMMSS_create_shipping_settings.sql"
      type: "migration"
      description: "Create shipping_settings table for org configuration"
    - path: "supabase/migrations/YYYYMMDDHHMMSS_add_backorder_flag.sql"
      type: "migration"
      description: "Add backorder_flag column to sales_order_lines"
  api:
    - path: "apps/frontend/app/api/shipping/sales-orders/[id]/allocate/route.ts"
      methods: ["POST"]
      description: "Trigger allocation for confirmed SO"
    - path: "apps/frontend/app/api/shipping/sales-orders/[id]/release-allocation/route.ts"
      methods: ["POST"]
      description: "Release/cancel all allocations for SO"
    - path: "apps/frontend/app/api/shipping/sales-orders/[id]/allocations/route.ts"
      methods: ["GET"]
      description: "Get allocation details for SO"
  services:
    - path: "apps/frontend/lib/services/allocation-service.ts"
      description: "FIFO/FEFO allocation logic, release, queries"
    - path: "apps/frontend/lib/services/backorder-service.ts"
      description: "Backorder signal creation and queries"
  validation:
    - path: "apps/frontend/lib/validation/allocation-schema.ts"
      description: "Zod schemas for allocation requests/responses"
  components:
    - path: "apps/frontend/app/(authenticated)/shipping/sales-orders/[id]/components/AllocationTab.tsx"
      description: "Tab container for allocation view"
    - path: "apps/frontend/app/(authenticated)/shipping/sales-orders/[id]/components/AllocationView.tsx"
      description: "Main allocation display component"
    - path: "apps/frontend/app/(authenticated)/shipping/sales-orders/[id]/components/AllocationTable.tsx"
      description: "Lines with nested LP allocations"
    - path: "apps/frontend/app/(authenticated)/shipping/sales-orders/[id]/components/AllocationActions.tsx"
      description: "Allocate/Release action buttons"
    - path: "apps/frontend/app/(authenticated)/shipping/sales-orders/[id]/components/AllocationProgress.tsx"
      description: "Progress bar showing allocation percentage"
    - path: "apps/frontend/app/(authenticated)/shipping/sales-orders/[id]/components/BackorderAlert.tsx"
      description: "Warning banner for backorder quantities"

database:
  tables:
    - name: "inventory_allocations"
      columns:
        - "id UUID PRIMARY KEY DEFAULT gen_random_uuid()"
        - "org_id UUID NOT NULL REFERENCES organizations(id)"
        - "sales_order_line_id UUID NOT NULL REFERENCES sales_order_lines(id) ON DELETE CASCADE"
        - "license_plate_id UUID NOT NULL REFERENCES license_plates(id)"
        - "quantity_allocated DECIMAL(15,4) NOT NULL CHECK (quantity_allocated > 0)"
        - "quantity_picked DECIMAL(15,4) DEFAULT 0 CHECK (quantity_picked >= 0)"
        - "allocated_at TIMESTAMPTZ DEFAULT now()"
        - "allocated_by UUID REFERENCES users(id)"
        - "released_at TIMESTAMPTZ"
      constraints:
        - "UNIQUE(sales_order_line_id, license_plate_id)"
      rls: true
      rls_policies:
        - name: "inventory_allocations_org_isolation"
          operation: "ALL"
          using: "org_id = (SELECT org_id FROM users WHERE id = auth.uid())"
      indexes:
        - "sales_order_line_id"
        - "license_plate_id"
        - "org_id WHERE released_at IS NULL"

    - name: "shipping_settings"
      columns:
        - "id UUID PRIMARY KEY DEFAULT gen_random_uuid()"
        - "org_id UUID NOT NULL REFERENCES organizations(id) UNIQUE"
        - "auto_allocate_on_confirm BOOLEAN DEFAULT true"
        - "allocation_threshold_pct DECIMAL(5,2) DEFAULT 80.00"
        - "default_picking_strategy TEXT DEFAULT 'FIFO'"
        - "created_at TIMESTAMPTZ DEFAULT now()"
        - "updated_at TIMESTAMPTZ DEFAULT now()"
      rls: true
      rls_policies:
        - name: "shipping_settings_org_isolation"
          operation: "ALL"
          using: "org_id = (SELECT org_id FROM users WHERE id = auth.uid())"

  modifications:
    - table: "sales_order_lines"
      add_column: "backorder_flag BOOLEAN DEFAULT false"

  critical_indexes:
    - name: "idx_lp_allocation_query"
      description: "Primary index for allocation LP query (CRITICAL)"
      sql: |
        CREATE INDEX idx_lp_allocation_query ON license_plates (
            org_id, product_id, status, qa_status, expiry_date, created_at
        ) WHERE status = 'available' AND qa_status = 'passed';

api_endpoints:
  - method: "POST"
    path: "/api/shipping/sales-orders/:id/allocate"
    description: "Trigger inventory allocation for confirmed SO"
    auth: true
    roles: ["MANAGER", "ADMIN", "SUPER_ADMIN"]
    request_body:
      force: "boolean (optional, default false) - re-allocate even if already allocated"
    response:
      success: "boolean"
      so_status: "'confirmed' | 'allocated'"
      lines: "LineAllocationResult[]"
      total_ordered: "number"
      total_allocated: "number"
      fulfillment_pct: "number"
      warnings: "string[]"
    errors:
      400: "Order must be confirmed before allocation"
      403: "Insufficient permissions"
      404: "Sales order not found"
    side_effects:
      - "Create inventory_allocations records"
      - "Update license_plates.status to 'reserved'"
      - "Update sales_order_lines.quantity_allocated"
      - "Set sales_order_lines.backorder_flag if short"
      - "Update sales_orders.status to 'allocated' if threshold met"
      - "Publish backorder.created event if short"

  - method: "POST"
    path: "/api/shipping/sales-orders/:id/release-allocation"
    description: "Release/cancel all allocations for SO"
    auth: true
    roles: ["MANAGER", "ADMIN", "SUPER_ADMIN"]
    response:
      success: "boolean"
      so_status: "'confirmed'"
      released_count: "number"
      lps_released: "number"
    errors:
      400: "No allocations to release"
      403: "Insufficient permissions"
      404: "Sales order not found"
    side_effects:
      - "Delete inventory_allocations records"
      - "Update license_plates.status to 'available'"
      - "Reset sales_order_lines.quantity_allocated to 0"
      - "Reset sales_order_lines.backorder_flag to false"
      - "Update sales_orders.status to 'confirmed'"

  - method: "GET"
    path: "/api/shipping/sales-orders/:id/allocations"
    description: "Get allocation details for SO"
    auth: true
    roles: ["ALL_AUTHENTICATED"]
    response:
      so_id: "UUID"
      so_status: "string"
      lines: "AllocationLineDetail[]"
      summary:
        total_lines: "number"
        fully_allocated_lines: "number"
        partial_allocated_lines: "number"
        unallocated_lines: "number"
        total_quantity_ordered: "number"
        total_quantity_allocated: "number"
        fulfillment_pct: "number"
    performance: "< 200ms with joins"

algorithms:
  fifo_allocation:
    description: "First In, First Out - allocate oldest LPs first"
    order_by: "created_at ASC"
    use_case: "Default for all products"

  fefo_allocation:
    description: "First Expired, First Out - allocate soonest expiry first"
    order_by: "expiry_date ASC, created_at ASC"
    use_case: "Products with shelf_life_days or picking_strategy='FEFO'"

  allocation_flow:
    pseudocode: |
      1. Validate SO is in 'confirmed' status
      2. For each SO line:
         a. Get product picking_strategy (FIFO or FEFO)
         b. Query available LPs: status='available', qa_status='passed', qty>0
         c. Order by picking strategy (FIFO or FEFO)
         d. Lock rows with FOR UPDATE SKIP LOCKED
         e. Loop through LPs until qty fulfilled:
            - Create allocation record
            - Update LP status to 'reserved' (if full qty)
            - Create lp_reservation (if partial qty)
            - Accumulate allocated qty
         f. Update SO line quantity_allocated
         g. If short: set backorder_flag, publish event
      3. Calculate fulfillment percentage
      4. If >= threshold: set SO status = 'allocated'
      5. Commit transaction

  concurrency_handling:
    strategy: "Pessimistic locking with skip"
    sql_pattern: "SELECT ... FOR UPDATE SKIP LOCKED"
    isolation: "SERIALIZABLE"
    retry_logic:
      attempts: 3
      backoff: "exponential (100ms, 200ms, 400ms)"

ux:
  patterns:
    table: "Nested table showing lines with child LP allocations"
    progress: "Progress bar for each line (green/yellow/red)"
    alerts: "Banner warnings for backorders"
    modal: "Confirmation dialog for release action"
  states:
    loading: "Skeleton with shimmer during allocation"
    empty: "No allocations - show 'Allocate' button prominently"
    partial: "Yellow/orange indicators for partial allocation"
    full: "Green indicators for fully allocated"
    backorder: "Red badge with 'Backorder: X units' message"
  allocation_view:
    columns:
      line_level:
        - "Line #"
        - "Product"
        - "Ordered Qty"
        - "Allocated Qty"
        - "Backorder Qty"
        - "Status"
      lp_level:
        - "LP Number"
        - "Location"
        - "Lot"
        - "Expiry"
        - "Qty Allocated"
        - "Allocated At"

validation_rules:
  allocation_prerequisites:
    so_status:
      required: "'confirmed'"
      error: "Order must be confirmed before allocation"
    existing_allocation:
      check: "If allocations exist and force != true"
      error: "Order already has allocations. Use force=true to re-allocate"

  lp_eligibility:
    status:
      required: "'available'"
      error: "LP is not available for allocation"
    qa_status:
      required: "'passed'"
      error: "LP has not passed quality inspection"
    quantity:
      required: "> 0"
      error: "LP has no available quantity"
    expiry_date:
      check: "IF expiry_date IS NOT NULL THEN expiry_date > CURRENT_DATE"
      error: "LP has expired"
    org_id:
      required: "must match SO org_id"
      error: "LP belongs to different organization"

patterns:
  rls: "Standard org_id isolation on inventory_allocations and shipping_settings"
  api: "REST with org_id filter from auth context"
  service: "Class-based AllocationService with static methods"
  validation: "Zod schemas in lib/validation/allocation-schema.ts"
  transaction: "SERIALIZABLE isolation with SELECT FOR UPDATE SKIP LOCKED"
  events: "Publish backorder.created for Planning module consumption"

adrs:
  - id: "ADR-07.7.1"
    title: "FIFO vs FEFO Selection Strategy"
    decision: "Product-level picking_strategy field determines allocation order"

  - id: "ADR-07.7.2"
    title: "Partial Allocation Policy"
    decision: "80% threshold for status transition, configurable per org"

  - id: "ADR-07.7.3"
    title: "Backorder Creation Policy"
    decision: "Event-based, Planning module subscribes to backorder.created"

  - id: "ADR-07.7.4"
    title: "Allocation Locking Strategy"
    decision: "SELECT FOR UPDATE SKIP LOCKED with 5s timeout, 3 retries"

  - id: "ADR-07.7.5"
    title: "Concurrent Allocation Conflict Resolution"
    decision: "First-commit wins, skip locked LPs, notify user"

acceptance_checklist:
  auto_allocation:
    - "GIVEN confirmed SO with lines, WHEN auto_allocate enabled, THEN allocation runs on confirm"
    - "GIVEN sufficient LPs, WHEN allocation runs, THEN quantity_allocated = quantity_ordered"
    - "GIVEN allocation complete, WHEN all lines >= 80%, THEN SO status = 'allocated'"

  fifo:
    - "GIVEN 3 LPs with different created_at, WHEN FIFO allocation, THEN oldest LP allocated first"
    - "GIVEN partial quantity needed, WHEN FIFO, THEN oldest LP fully used before next"

  fefo:
    - "GIVEN 3 LPs with different expiry_date, WHEN FEFO allocation, THEN earliest expiry allocated first"
    - "GIVEN same expiry date, WHEN FEFO, THEN oldest created_at used as tiebreaker"

  backorder:
    - "GIVEN 60 units available for 100 unit order, WHEN allocation runs, THEN qty_allocated=60"
    - "GIVEN partial allocation, WHEN complete, THEN backorder_flag=true on line"
    - "GIVEN backorder, WHEN complete, THEN backorder.created event published"

  release:
    - "GIVEN SO with allocations, WHEN release-allocation called, THEN allocations deleted"
    - "GIVEN release complete, WHEN done, THEN LP status = 'available'"
    - "GIVEN release complete, WHEN done, THEN SO status = 'confirmed'"

  concurrency:
    - "GIVEN 2 users allocating same product, WHEN simultaneous, THEN no duplicate LP allocation"
    - "GIVEN locked LP, WHEN SKIP LOCKED, THEN allocation tries next LP"

  exclusions:
    - "GIVEN LP with qa_status='failed', WHEN allocation query, THEN LP excluded"
    - "GIVEN LP with expiry_date in past, WHEN allocation query, THEN LP excluded"
    - "GIVEN LP with status='reserved', WHEN allocation query, THEN LP excluded"

definition_of_done:
  - "inventory_allocations table created with RLS policies"
  - "shipping_settings table created for org configuration"
  - "FIFO allocation orders LPs by created_at ASC"
  - "FEFO allocation orders LPs by expiry_date ASC, created_at ASC"
  - "Product picking_strategy determines FIFO vs FEFO"
  - "Partial allocation sets backorder_flag on SO line"
  - "SO status transitions to 'allocated' when threshold met"
  - "Manual allocate endpoint works for Manager+ role"
  - "Release allocation resets LP status and quantities"
  - "Allocation view API returns nested LP details"
  - "AllocationView component displays in SO detail page"
  - "Expired and QA-failed LPs excluded from allocation"
  - "SELECT FOR UPDATE prevents concurrent conflicts"
  - "Transaction rollback on partial failure"
  - "backorder.created event published"
  - "Unit tests cover allocation algorithm (>90% coverage)"
  - "Integration tests cover API endpoints"
  - "Concurrency tests verify no duplicate allocations"
  - "E2E test: Full allocation workflow"

tests:
  unit:
    - "AllocationService.allocate with FIFO orders by created_at"
    - "AllocationService.allocate with FEFO orders by expiry_date"
    - "AllocationService.getPickingStrategy returns product setting or default"
    - "AllocationService.calculateFulfillmentPct calculates correctly"
    - "AllocationService excludes LP with qa_status != 'passed'"
    - "AllocationService excludes LP with status != 'available'"
    - "AllocationService excludes expired LPs"
    - "AllocationService handles partial allocation"
    - "AllocationService sets backorder_flag when short"
    - "AllocationService.releaseAllocation deletes records"
    - "BackorderService.createBackorderSignal publishes event"
  integration:
    - "POST /allocate returns allocation results"
    - "POST /allocate transitions status when threshold met"
    - "POST /allocate returns 400 for non-confirmed SO"
    - "POST /allocate returns 403 for non-manager"
    - "POST /release-allocation deletes allocations"
    - "POST /release-allocation resets SO status"
    - "GET /allocations returns nested LP details"
    - "RLS blocks cross-org access"
  concurrency:
    - "Parallel allocations for same product don't duplicate LP"
    - "SKIP LOCKED prevents deadlock"
    - "Retry logic handles transient failures"
  e2e:
    - "Confirm SO -> Auto-allocate -> View allocations"
    - "Manual allocate -> Release -> Re-allocate"
    - "Partial allocation -> View backorder warning"

performance:
  targets:
    single_line_allocation: "< 200ms"
    ten_line_allocation: "< 1s"
    fifty_line_allocation: "< 5s"
    release_allocation: "< 500ms"
    allocation_view_query: "< 200ms"

  indexes:
    critical:
      - name: "idx_lp_allocation_query"
        purpose: "Primary allocation LP lookup"
        columns: ["org_id", "product_id", "status", "qa_status", "expiry_date", "created_at"]
        where: "status = 'available' AND qa_status = 'passed'"
    secondary:
      - name: "idx_allocations_so_line"
        purpose: "Lookup allocations by SO line"
        columns: ["sales_order_line_id"]
      - name: "idx_allocations_lp"
        purpose: "Lookup allocations by LP"
        columns: ["license_plate_id"]

  caching:
    - key: "org:{orgId}:allocation:in_progress:{soId}"
      ttl: "5 min"
      purpose: "Lock during allocation"
    - key: "org:{orgId}:product:{productId}:picking_strategy"
      ttl: "24 hour"
      purpose: "Cache product picking strategy"
    - key: "org:{orgId}:settings:allocation_threshold"
      ttl: "1 hour"
      purpose: "Cache org allocation settings"

output_artifacts:
  - "Migration: create_inventory_allocations.sql"
  - "Migration: create_shipping_settings.sql"
  - "Migration: add_backorder_flag_to_so_lines.sql"
  - "API: POST /api/shipping/sales-orders/:id/allocate"
  - "API: POST /api/shipping/sales-orders/:id/release-allocation"
  - "API: GET /api/shipping/sales-orders/:id/allocations"
  - "AllocationService with FIFO/FEFO logic"
  - "BackorderService for backorder signals"
  - "allocation-schema.ts with Zod validation"
  - "AllocationTab component"
  - "AllocationView component"
  - "AllocationTable component"
  - "AllocationActions component"
  - "AllocationProgress component"
  - "BackorderAlert component"
  - "Unit tests for allocation algorithm"
  - "Integration tests for API endpoints"
  - "Concurrency tests"
  - "E2E test for allocation workflow"

implementation_notes:
  backend:
    - "Use SERIALIZABLE transaction isolation for allocation"
    - "SELECT FOR UPDATE SKIP LOCKED to prevent deadlocks"
    - "Retry allocation 3 times with exponential backoff"
    - "Query products table for picking_strategy per line"
    - "Batch process lines (10 at a time) for large orders"
    - "Publish backorder.created event to message bus"
    - "Calculate fulfillment % after all lines processed"
    - "Only transition status if ALL lines meet threshold"
  frontend:
    - "Add Allocations tab to SO detail page"
    - "Show nested table with lines and LP children"
    - "Color-code allocation status (green/yellow/red)"
    - "Show progress bars for each line"
    - "Display backorder warnings prominently"
    - "Disable Allocate button if not confirmed status"
    - "Show confirmation dialog before release"
    - "Real-time update after allocation completes"
  database:
    - "Critical: Create partial index on license_plates for allocation query"
    - "Add backorder_flag column to sales_order_lines"
    - "Create shipping_settings table for org configuration"
    - "Ensure FK constraints with ON DELETE CASCADE"
    - "Add CHECK constraints on quantity columns"
  dependencies:
    - "BLOCKED: Wait for Epic 05 License Plates table"
    - "BLOCKED: Wait for Epic 05 lp_reservations table"
    - "Products table must have picking_strategy column"
    - "SO must be confirmed before allocation"

future_phases:
  phase_1b:
    - "Story 07.8: Lot-Specific Allocation (requested_lot field)"
  phase_2:
    - "Cross-dock allocation (incoming POs)"
    - "Multi-warehouse allocation"
    - "Wave allocation optimization"
    - "Allocation priority queues"
  phase_3:
    - "Real-time inventory sync via WebSocket"
    - "Predictive allocation before SO confirmed"
