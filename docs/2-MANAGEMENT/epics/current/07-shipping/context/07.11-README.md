# Story 07.11 - Packing & Shipment Creation

## Context Files Summary

This directory contains complete YAML context files for Story 07.11, created for AI agent consumption.

### Files Included

1. **07.11.context.yaml** (22 KB)
   - Main story context with dependencies, file structure, API endpoints, UX requirements
   - Database table definitions, validation rules, acceptance checklist
   - Patterns, testing requirements, estimated effort
   - **Primary file for agent task assignment**

2. **07.11-prd-sections.yaml** (9.4 KB)
   - PRD requirements mapping (FR-7.34, FR-7.35, FR-7.37, FR-7.40, FR-7.42)
   - Acceptance criteria mapping with implementation focus
   - Food safety rules (allergen separation, lot traceability)
   - GS1 compliance notes
   - Implementation priority (must-have, should-have, nice-to-have)

3. **07.11-wireframes.yaml** (18 KB)
   - Comprehensive wireframe reference mapping
   - SHIP-017: Packing Station Interface (10 screens)
   - SHIP-020: Packing Slip Generation (8 screens)
   - Data fields mapping for PDF, API endpoints, accessibility requirements
   - Performance targets and keyboard navigation

4. **07.11-database-schema.yaml** (19 KB)
   - Detailed database table definitions
   - Table: shipments (shipment lifecycle, auto-numbering SH-YYYY-NNNNN)
   - Table: shipment_boxes (carton/box records with weight/dimensions)
   - Table: shipment_box_contents (traceability with lot_number)
   - RLS policies, indexes, cascade deletes, database functions
   - Relationships and cardinality

5. **07.11-api-endpoints.yaml** (22 KB)
   - 7 API endpoints fully documented with request/response schemas
   - POST /api/shipping/shipments (create shipment)
   - GET /api/shipping/shipments (list with filters)
   - GET /api/shipping/shipments/:id (detail)
   - GET /api/shipping/shipments/:id/available-lps (pick candidates)
   - POST /api/shipping/shipments/:id/boxes (add box)
   - PUT /api/shipping/shipments/:id/boxes/:boxId (update weight/dimensions)
   - POST /api/shipping/shipments/:id/boxes/:boxId/contents (add LP to box)
   - POST /api/shipping/shipments/:id/complete-packing (finalize)
   - Error codes, authentication, rate limiting, examples

---

## Quick Reference

**Story ID:** 07.11
**Name:** Packing & Shipment Creation
**Phase:** 1C (After Story 07.9 - Pick Confirmation)
**Complexity:** L (Large)
**Estimate:** 5-7 days
**Priority:** P0 (MVP Core)

**Key Features:**
- Shipment creation from sales orders with auto-generated shipment_number
- Multi-box shipment support (auto-incremented box_number)
- License plate assignment with lot_number traceability
- Weight/dimensions capture with validation (10-200 cm range)
- Allergen separation warnings (non-blocking)
- Packing completion validation
- 3-column packing workbench UI (Available LPs, Box Builder, Summary)
- Packing slip PDF generation (deferred to Story 07.13 for SSCC)

**Database Tables Created:**
1. shipments (shipment lifecycle, SH-YYYY-NNNNN numbering)
2. shipment_boxes (cartons with weight/dimensions)
3. shipment_box_contents (traceability with lot_number)

**API Endpoints:** 7 endpoints for shipment CRUD, box management, LP assignment, completion

**UI Components:**
- PackingWorkbench (main 3-column layout)
- BoxBuilder (tabs for each box)
- LPSelector (searchable combobox)
- PackingSummary (progress card)
- AllergenWarningDialog (non-blocking modal)
- ShipmentsTable, BoxesTable, dialogs for modals

**RLS Security:** org_id isolation on all three tables

**Cascade Delete:** shipment → boxes → contents

---

## How to Use These Files

### For BACKEND-DEV Agent:
1. Start with **07.11.context.yaml** for overall scope
2. Use **07.11-database-schema.yaml** for migration creation
3. Use **07.11-api-endpoints.yaml** for route implementation
4. Reference **07.11-prd-sections.yaml** for acceptance criteria

### For FRONTEND-DEV Agent:
1. Start with **07.11.context.yaml** for component structure
2. Use **07.11-wireframes.yaml** for UI implementation
3. Reference **07.11-api-endpoints.yaml** for API integration
4. Use **07.11-prd-sections.yaml** for validation rules

### For ARCHITECT Agent:
1. Use **07.11-database-schema.yaml** for data model review
2. Reference **07.11.context.yaml** for system dependencies
3. Check **07.11-prd-sections.yaml** for food safety patterns

---

## Key Acceptance Criteria

- [ ] Shipments table created with SH-YYYY-NNNNN auto-numbering (per-org, annual reset)
- [ ] Shipment_boxes table with auto-incremented box_number per shipment
- [ ] Shipment_box_contents table with lot_number traceability
- [ ] 7 API endpoints implemented with proper validation and error handling
- [ ] RLS policies prevent cross-org access
- [ ] Cascade delete works (SO cancel → shipment/boxes/contents deleted)
- [ ] PackingWorkbench UI displays 3-column layout
- [ ] Allergen warnings displayed (non-blocking)
- [ ] Weight/dimension validation enforces 10-200 cm range
- [ ] Complete packing validates all boxes have weight
- [ ] Sales order status updates: create ('packing'), complete ('packed')
- [ ] Unit tests >80% coverage for ShipmentService
- [ ] E2E tests for packing workflow (create → box → LP → complete)
- [ ] Multi-tenant isolation verified

---

## Dependencies

**Required Stories (Blocking):**
- Story 07.9 - Pick Confirmation Desktop (provides picked LPs)

**Related Stories (Non-Blocking):**
- Story 07.1-7.8 - Core shipping setup (customers, SO, picking)
- Story 06.11 - Batch Release (quality holds)
- Story 07.12 - Pack Confirmation Scanner (consumes this story)
- Story 07.13 - SSCC + Labels + BOL (generates SSCC, packing slip)
- Story 07.14 - Manifest & Ship Confirm (uses packed shipments)

**Epics:**
- Epic 01 (Settings, Organizations, RLS)
- Epic 02 (Technical, Products, Allergens)
- Epic 05 (Warehouse, Locations, License Plates)

---

## Testing Strategy

### Unit Tests (80%+ coverage)
- Shipment creation and numbering
- Box management (add, update, cascade delete)
- LP assignment and allergen checks
- Weight/dimension validation
- Packing completion logic

### E2E Tests
1. Happy path: Create shipment → Add boxes → Assign LPs → Complete packing
2. Allergen warnings: Pack allergen product with restricted customer
3. Weight validation: Exceed carton capacity, receive error
4. Cascade delete: Cancel SO, verify shipment/boxes/contents deleted
5. Multi-tenant: Verify org isolation in RLS

### Performance Tests
- Create shipment: <500ms
- Add box: <300ms
- Add LP to box: <300ms
- List shipments: <1s (with 1000+ records)
- Complete packing: <1s

---

## Version History

**Version 1.0** - 2025-12-18
- Initial YAML context creation (5 files)
- PRD mapping, wireframes, database schema, API endpoints documented
- Ready for BACKEND-DEV and FRONTEND-DEV handoff

---

## Notes

- Shipment number format: SH-YYYY-NNNNN (auto-incremented per org, resets annually)
- SSCC generation deferred to Story 07.13 (fields created but NULL in 07.11)
- Packing slip PDF generation deferred to Story 07.13 (table structure created in 07.11)
- Allergen warnings are non-blocking (packer can continue anyway)
- Status workflow: pending → packing → packed → manifested → shipped → delivered
- All queries filtered by org_id (RLS enforcement)
- Lot numbers captured at pack time for food safety traceability

---

**For Questions:** Refer to the specific YAML file sections or the original story markdown at:
`docs/2-MANAGEMENT/epics/current/07-shipping/07.11.packing-shipment-creation.md`
