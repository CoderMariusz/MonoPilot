# Story Context: 07.3 SO Status Workflow + Hold/Cancel
# Generated: 2025-12-16
# Purpose: AI agent context for implementing sales order hold/cancel workflow with status state machine

story:
  id: "07.3"
  name: "Sales Order Status Workflow + Hold/Cancel"
  epic: "07-shipping"
  phase: "1A"
  complexity: "S"
  estimate_days: 2
  type: "backend + frontend"
  state: "ready"
  priority: "P0"
  story_file: "docs/2-MANAGEMENT/epics/current/07-shipping/07.3.so-status-workflow.md"

dependencies:
  required:
    - story: "01.1"
      name: "Org Context + Base RLS"
      provides:
        - "organizations table"
        - "users table with org_id"
        - "RLS foundation"
        - "auth context"
    - story: "02.1"
      name: "Products CRUD"
      provides:
        - "products table for SO lines"
    - story: "07.1"
      name: "Customers CRUD"
      provides:
        - "customers table"
    - story: "07.2"
      name: "Sales Orders CRUD"
      provides:
        - "sales_orders table"
        - "sales_order_lines table"
        - "Base SO CRUD service"
  dependents:
    - story: "07.7"
      name: "Inventory Allocation"
      requires: "on_hold status check to prevent allocation"
    - story: "07.8"
      name: "Pick List Generation"
      requires: "cancelled status check to prevent pick list creation"
    - story: "07.15"
      name: "Shipping Dashboard"
      requires: "status counts for KPI cards"

files_to_read:
  prd: "docs/1-BASELINE/product/modules/shipping.md"
  prd_sections:
    - "FR-7.11"  # SO Status Workflow
    - "FR-7.13"  # SO Confirmation/Hold
    - "FR-7.17"  # SO Cancellation
    - "FR-7.19"  # Promised Ship Date (reference only)
  prd_lines:
    - "189-197"  # sales_orders table schema
    - "759-774"  # Status workflows business rules
  architecture: "docs/1-BASELINE/architecture/modules/shipping.md"
  arch_lines:
    - "96"       # sales_orders.status enum definition
    - "1001-1008" # Status workflow state machine
  story: "docs/2-MANAGEMENT/epics/current/07-shipping/07.3.so-status-workflow.md"
  adrs:
    - "docs/1-BASELINE/architecture/decisions/ADR-013-rls-org-isolation-pattern.md"
  patterns:
    - "apps/frontend/lib/validation/*.ts"  # Existing Zod schema patterns
    - "apps/frontend/lib/services/*.ts"    # Existing service patterns
    - "apps/frontend/components/ui/badge.tsx"  # ShadCN Badge for status
    - "apps/frontend/components/ui/alert-dialog.tsx"  # ShadCN AlertDialog for confirmation

files_to_create:
  database:
    - path: "supabase/migrations/072_extend_sales_orders_status.sql"
      type: "migration"
      description: "Add 'on_hold' to sales_order_status enum, add index"
  api:
    - path: "apps/frontend/app/api/shipping/sales-orders/[id]/hold/route.ts"
      methods: ["POST"]
      description: "Put sales order on hold with optional reason"
    - path: "apps/frontend/app/api/shipping/sales-orders/[id]/cancel/route.ts"
      methods: ["POST"]
      description: "Cancel sales order with required reason"
  services:
    - path: "apps/frontend/lib/services/sales-order-service.ts"
      description: "Add holdOrder() and cancelOrder() methods"
  validation:
    - path: "apps/frontend/lib/validation/sales-order-schema.ts"
      description: "Add holdOrderSchema and cancelOrderSchema"
  components:
    - path: "apps/frontend/components/shipping/sales-orders/SOStatusBadge.tsx"
      description: "Color-coded status badge with 9 status states"
    - path: "apps/frontend/components/shipping/sales-orders/SOStatusTimeline.tsx"
      description: "Vertical timeline showing status history with timestamps"
    - path: "apps/frontend/components/shipping/sales-orders/HoldOrderDialog.tsx"
      description: "Confirmation dialog for hold action with optional reason"
    - path: "apps/frontend/components/shipping/sales-orders/CancelOrderDialog.tsx"
      description: "Confirmation dialog for cancel with required reason input"

database:
  tables:
    - name: "sales_orders"
      description: "Extend status enum to include on_hold"
      status_enum_values:
        - "draft"          # Initial state, editable
        - "confirmed"      # Locked, ready for allocation
        - "on_hold"        # NEW: Paused, prevents allocation
        - "cancelled"      # Terminal state, releases allocation
        - "allocated"      # Inventory reserved
        - "picking"        # Pick list generated
        - "packing"        # All picked, packing in progress
        - "shipped"        # Manifested, left dock
        - "delivered"      # POD received
      columns_modified:
        - "status TEXT NOT NULL DEFAULT 'draft' CHECK (status IN (9 values))"
      indexes_added:
        - "CREATE INDEX idx_sales_orders_status_updated ON sales_orders(org_id, status, updated_at)"
      rls: true
      rls_policies:
        - name: "sales_orders_select"
          operation: "SELECT"
          using: "org_id = (SELECT org_id FROM users WHERE id = auth.uid())"
        - name: "sales_orders_update_hold"
          operation: "UPDATE"
          using: |
            org_id = (SELECT org_id FROM users WHERE id = auth.uid())
            AND (SELECT r.code FROM roles r JOIN users u ON u.role_id = r.id WHERE u.id = auth.uid())
            IN ('SUPER_ADMIN', 'ADMIN', 'MANAGER', 'SALES')
        - name: "sales_orders_update_cancel"
          operation: "UPDATE"
          using: |
            org_id = (SELECT org_id FROM users WHERE id = auth.uid())
            AND (SELECT r.code FROM roles r JOIN users u ON u.role_id = r.id WHERE u.id = auth.uid())
            IN ('SUPER_ADMIN', 'ADMIN', 'MANAGER')

api_endpoints:
  - method: "POST"
    path: "/api/shipping/sales-orders/:id/hold"
    description: "Put sales order on hold with optional reason"
    auth: true
    roles: ["SUPER_ADMIN", "ADMIN", "MANAGER", "SALES"]
    request_body:
      reason: "string (optional, max 500 chars)"
    response:
      success: "boolean"
      status: "'on_hold'"
      updated_at: "timestamp"
    errors:
      400: "Cannot hold order after allocation has started"
      400: "Cannot hold a cancelled order"
      404: "Sales order not found"
    business_rules:
      - "Valid from statuses: draft, confirmed"
      - "Invalid from statuses: allocated, picking, packing, shipped, delivered, cancelled"
      - "Reason appended to notes with timestamp"
      - "updated_at timestamp updated"

  - method: "POST"
    path: "/api/shipping/sales-orders/:id/cancel"
    description: "Cancel sales order with required reason"
    auth: true
    roles: ["SUPER_ADMIN", "ADMIN", "MANAGER"]
    request_body:
      reason: "string (required, min 1 char, max 500 chars)"
    response:
      success: "boolean"
      status: "'cancelled'"
      updated_at: "timestamp"
    errors:
      400: "Cancel reason is required"
      400: "Cannot cancel order after picking has started. Please contact warehouse manager."
      403: "Insufficient permissions to cancel orders"
      404: "Sales order not found"
    business_rules:
      - "Valid from statuses: draft, confirmed, on_hold, allocated"
      - "Invalid from statuses: picking, packing, shipped, delivered, cancelled"
      - "Reason is required (validation)"
      - "Reason appended to notes with timestamp"
      - "updated_at timestamp updated"
      - "Allocation release handled in Story 07.7 (future)"

ux:
  components:
    - name: "SOStatusBadge"
      description: "Color-coded badge for 9 status states"
      variants:
        draft: "bg-gray-100 text-gray-800"
        confirmed: "bg-blue-100 text-blue-800"
        on_hold: "bg-yellow-100 text-yellow-800 (pause icon)"
        cancelled: "bg-red-100 text-red-800 (x icon)"
        allocated: "bg-purple-100 text-purple-800"
        picking: "bg-purple-100 text-purple-800"
        packing: "bg-purple-100 text-purple-800"
        shipped: "bg-green-100 text-green-800"
        delivered: "bg-green-100 text-green-800"
    - name: "SOStatusTimeline"
      description: "Vertical timeline showing status history"
      features:
        - "Status icon, label, timestamp, user name"
        - "Most recent status highlighted"
        - "Chronological order (top to bottom)"
        - "Terminal states (cancelled, delivered) at bottom"
    - name: "HoldOrderDialog"
      description: "Confirmation dialog for hold action"
      features:
        - "Optional reason textarea (max 500 chars)"
        - "Cancel and Confirm buttons"
        - "Reason saved to notes field"
    - name: "CancelOrderDialog"
      description: "Confirmation dialog for cancel action"
      features:
        - "Required reason textarea (min 1 char, max 500 chars)"
        - "Validation error if empty"
        - "Warning text about allocation release (if allocated)"
        - "Cancel and Confirm buttons (Confirm is destructive)"
  patterns:
    badge: "ShadCN Badge component with color variants"
    dialog: "ShadCN AlertDialog for confirmation"
    timeline: "Custom timeline component with vertical line and status nodes"
  states:
    loading: "Skeleton loader for timeline"
    empty: "No status history available"
    error: "Failed to load status history"
    success: "Timeline populated with status data"

validation_rules:
  hold_reason:
    type: "string"
    required: false
    max: 500
    error_max: "Hold reason must be at most 500 characters"
  cancel_reason:
    type: "string"
    required: true
    min: 1
    max: 500
    error_empty: "Cancel reason is required"
    error_min: "Cancel reason cannot be empty"
    error_max: "Cancel reason must be at most 500 characters"

patterns:
  rls: "ADR-013 - RLS Org Isolation Pattern"
  api: "REST with org_id filter from auth context"
  service: "Class-based SalesOrderService with static methods"
  validation: "Zod schemas in lib/validation/sales-order-schema.ts"
  status_state_machine: |
    Valid transitions:
    - draft → confirmed, on_hold, cancelled
    - confirmed → on_hold, cancelled, allocated
    - on_hold → confirmed, cancelled
    - allocated → cancelled (only before picking starts)

    Invalid transitions trigger 400 error with message:
    "Invalid status transition: {from} → {to}"
  notes_append_pattern: |
    const timestamp = new Date().toISOString();
    const prefix = action === 'hold' ? 'HOLD' : 'CANCELLED';
    const updatedNotes = `${existingNotes || ''}\n[${prefix} - ${timestamp}] ${reason}`.trim();

business_rules:
  hold_order:
    - "Can only hold from: draft, confirmed"
    - "Cannot hold from: allocated, picking, packing, shipped, delivered, cancelled"
    - "Reason is optional"
    - "Reason appended to notes with timestamp if provided"
    - "updated_at timestamp updated"
    - "Roles: Sales, Manager, Admin"
  cancel_order:
    - "Can only cancel from: draft, confirmed, on_hold, allocated"
    - "Cannot cancel from: picking, packing, shipped, delivered, cancelled"
    - "Reason is required (validation error if missing)"
    - "Reason appended to notes with timestamp"
    - "updated_at timestamp updated"
    - "Roles: Manager, Admin only (Sales cannot cancel)"
    - "Allocation release handled in Story 07.7"
  status_state_machine:
    - "Enforce valid transitions only"
    - "Return 400 error for invalid transitions"
    - "Include from/to states in error message"
  audit_trail:
    - "updated_at always updated on status change"
    - "confirmed_at set when status = confirmed (Story 07.2)"
    - "notes field contains full history of hold/cancel actions with timestamps"

acceptance_checklist:
  database:
    - "GIVEN migration runs, WHEN sales_orders table updated, THEN status enum includes 'on_hold'"
    - "GIVEN sales_orders table, WHEN status column checked, THEN accepts all 9 status values"
    - "GIVEN sales_orders table, WHEN index checked, THEN idx_sales_orders_status_updated exists on (org_id, status, updated_at)"

  hold_order:
    - "GIVEN SO with status 'draft', WHEN POST /hold called, THEN status changes to 'on_hold' and updated_at updated"
    - "GIVEN SO with status 'confirmed', WHEN POST /hold called, THEN status changes to 'on_hold'"
    - "GIVEN SO with status 'allocated', WHEN POST /hold called, THEN 400 error 'Cannot hold order after allocation has started'"
    - "GIVEN SO with status 'cancelled', WHEN POST /hold called, THEN 400 error 'Cannot hold a cancelled order'"
    - "GIVEN SO with status 'draft', WHEN POST /hold with reason, THEN notes appended with '[HOLD] reason'"

  cancel_order:
    - "GIVEN SO with status 'draft', WHEN POST /cancel with reason, THEN status changes to 'cancelled' and updated_at updated"
    - "GIVEN SO with status 'confirmed', WHEN POST /cancel with reason, THEN status changes to 'cancelled'"
    - "GIVEN SO with status 'on_hold', WHEN POST /cancel with reason, THEN status changes to 'cancelled'"
    - "GIVEN SO with status 'picking', WHEN POST /cancel called, THEN 400 error 'Cannot cancel order after picking has started'"
    - "GIVEN SO with status 'draft', WHEN POST /cancel with no reason, THEN 400 error 'Cancel reason is required'"
    - "GIVEN SO with status 'confirmed', WHEN POST /cancel with reason, THEN notes appended with '[CANCELLED] reason'"

  authorization:
    - "GIVEN user with Sales role, WHEN POST /hold called, THEN operation succeeds"
    - "GIVEN user with Manager role, WHEN POST /cancel called, THEN operation succeeds"
    - "GIVEN user with Admin role, WHEN POST /cancel called, THEN operation succeeds"
    - "GIVEN user with Sales role, WHEN POST /cancel called, THEN 403 error 'Insufficient permissions to cancel orders'"
    - "GIVEN user with Warehouse role, WHEN POST /cancel called, THEN 403 error"

  ui_components:
    - "GIVEN SO detail page, WHEN viewing status, THEN SOStatusBadge displays with correct color"
    - "GIVEN SO with status 'on_hold', WHEN viewing badge, THEN yellow background with pause icon"
    - "GIVEN SO with status 'cancelled', WHEN viewing badge, THEN red background with x icon"
    - "GIVEN SO with status history, WHEN viewing timeline, THEN SOStatusTimeline shows chronological order"
    - "GIVEN HoldOrderDialog open, WHEN reason field empty, THEN form submits successfully (optional)"
    - "GIVEN CancelOrderDialog open, WHEN reason field empty, THEN validation error 'Cancel reason is required' displays"

  multi_tenancy:
    - "GIVEN User A from Org A, WHEN holding SO from Org B, THEN 404 Not Found returned"
    - "GIVEN User A from Org A, WHEN cancelling SO from Org B, THEN 404 Not Found returned"

definition_of_done:
  - "Migration extends sales_orders.status enum with 'on_hold'"
  - "Index created on (org_id, status, updated_at)"
  - "POST /api/shipping/sales-orders/:id/hold endpoint implemented"
  - "POST /api/shipping/sales-orders/:id/cancel endpoint implemented"
  - "holdOrderSchema validates optional reason (max 500)"
  - "cancelOrderSchema validates required reason (min 1, max 500)"
  - "SalesOrderService.holdOrder() enforces status state machine"
  - "SalesOrderService.cancelOrder() enforces status state machine"
  - "Role-based authorization: Sales can hold, Manager+ can cancel"
  - "Reason appended to notes field with timestamp prefix"
  - "updated_at timestamp updated on status change"
  - "SOStatusBadge component with 9 color variants"
  - "SOStatusTimeline component displays status history"
  - "HoldOrderDialog with optional reason textarea"
  - "CancelOrderDialog with required reason textarea"
  - "RLS policies enforce org isolation"
  - "Multi-tenancy: cross-org returns 404"
  - "Unit tests >= 80% coverage for service methods"
  - "Integration tests for /hold and /cancel endpoints"
  - "E2E tests for hold/cancel flows"
  - "Toast notifications on success/error"
  - "Permission-based UI: hide cancel button for Sales role"

tests:
  unit:
    - "SalesOrderService.holdOrder() from 'draft' succeeds"
    - "SalesOrderService.holdOrder() from 'confirmed' succeeds"
    - "SalesOrderService.holdOrder() from 'allocated' throws error"
    - "SalesOrderService.holdOrder() from 'cancelled' throws error"
    - "SalesOrderService.holdOrder() appends reason to notes"
    - "SalesOrderService.cancelOrder() from 'draft' succeeds"
    - "SalesOrderService.cancelOrder() from 'confirmed' succeeds"
    - "SalesOrderService.cancelOrder() from 'on_hold' succeeds"
    - "SalesOrderService.cancelOrder() from 'picking' throws error"
    - "SalesOrderService.cancelOrder() without reason throws error"
    - "SalesOrderService.cancelOrder() appends reason to notes"
    - "holdOrderSchema validates optional reason"
    - "cancelOrderSchema rejects empty reason"
    - "cancelOrderSchema rejects reason > 500 chars"
    - "SOStatusBadge renders correct color for each status"
  integration:
    - "POST /api/shipping/sales-orders/:id/hold returns 200 for valid status"
    - "POST /api/shipping/sales-orders/:id/hold returns 400 for invalid status"
    - "POST /api/shipping/sales-orders/:id/cancel returns 200 for valid status"
    - "POST /api/shipping/sales-orders/:id/cancel returns 400 for invalid status"
    - "POST /api/shipping/sales-orders/:id/cancel returns 400 without reason"
    - "POST /api/shipping/sales-orders/:id/cancel returns 403 for Sales role"
    - "POST /api/shipping/sales-orders/:id/hold updates updated_at timestamp"
    - "POST /api/shipping/sales-orders/:id/cancel updates updated_at timestamp"
    - "Cross-org hold/cancel returns 404"
  e2e:
    - "Full hold flow: SO detail > Hold button > dialog > reason > confirm > status badge updates"
    - "Full cancel flow: SO detail > Cancel button > dialog > reason > confirm > status badge updates"
    - "Cancel validation: SO detail > Cancel button > dialog > submit empty > error message"
    - "Permission test: Sales user sees Hold but not Cancel button"
    - "Status timeline updates after hold/cancel action"

output_artifacts:
  database:
    - "Migration: 072_extend_sales_orders_status.sql"
    - "Index: idx_sales_orders_status_updated"
  backend:
    - "sales-order-service.ts with holdOrder() and cancelOrder() methods"
    - "sales-order-schema.ts with holdOrderSchema and cancelOrderSchema"
    - "API route: POST /api/shipping/sales-orders/:id/hold"
    - "API route: POST /api/shipping/sales-orders/:id/cancel"
  frontend:
    - "SOStatusBadge.tsx component (9 status variants)"
    - "SOStatusTimeline.tsx component"
    - "HoldOrderDialog.tsx component"
    - "CancelOrderDialog.tsx component"
  tests:
    - "Unit tests for sales-order-service (>80% coverage)"
    - "Integration tests for hold/cancel endpoints"
    - "E2E tests for hold/cancel flows"

implementation_notes:
  backend:
    - "Use status state machine validation before any status change"
    - "Append to notes field with format: '[ACTION - TIMESTAMP] reason'"
    - "Always update updated_at timestamp on status change"
    - "Use ADR-013 RLS pattern for org isolation"
    - "Check user role in RLS policy for cancel operation"
    - "Return 404 (not 403) for cross-org access"
  frontend:
    - "Use ShadCN Badge for status with predefined color variants"
    - "Use ShadCN AlertDialog for confirmation dialogs"
    - "Disable Cancel button if user has Sales role (use usePermissions hook)"
    - "Show warning in CancelOrderDialog if order is allocated"
    - "Display timestamp in locale format in timeline"
    - "Toast notification on success/error"
  validation:
    - "holdOrderSchema: reason is optional, max 500 chars"
    - "cancelOrderSchema: reason is required, min 1 char, max 500 chars"
    - "Validate status transitions in service layer (not just DB constraint)"
