# Story Context: 07.2 Sales Orders Core CRUD (Draft/Confirmed)
# Generated: 2025-12-16
# Purpose: AI agent context for implementing sales order CRUD operations

story:
  id: "07.2"
  name: "Sales Orders Core CRUD (Draft/Confirmed)"
  epic: "07-shipping"
  phase: "1A"
  complexity: "M"
  estimate_days: 3-4
  type: "backend + frontend"
  state: "ready"
  priority: "P0"
  story_file: "docs/2-MANAGEMENT/epics/current/07-shipping/07.2.sales-orders-core.md"

dependencies:
  required:
    - story: "01.1"
      name: "Org Context + Base RLS"
      provides:
        - "organizations table"
        - "org_id context"
        - "RLS policies for tenant isolation"
    - story: "02.1"
      name: "Products CRUD"
      provides:
        - "products table (for SO lines)"
    - story: "07.1"
      name: "Customers & Addresses"
      provides:
        - "customers table"
        - "customer_addresses table"

files_to_read:
  prd: "docs/1-BASELINE/product/modules/shipping.md"
  prd_sections:
    - "FR-7.9"   # Sales Order Creation (Manual)
    - "FR-7.10"  # Sales Order Lines Management
    - "FR-7.11"  # SO Status Workflow
    - "FR-7.12"  # Inventory Allocation (NOT in this story - Story 07.7)
    - "FR-7.13"  # SO Confirmation/Hold
    - "FR-7.15"  # Partial Fulfillment (structure only)
    - "FR-7.17"  # SO Cancellation (NOT in this story - Story 07.5)
    - "FR-7.18"  # Reserved Inventory Tracking (NOT in this story - Story 07.7)
  architecture: "docs/1-BASELINE/architecture/modules/shipping.md"
  architecture_sections:
    - "lines 85-127"   # sales_orders and sales_order_lines schema
    - "lines 324-405"  # API endpoints and indexes
    - "lines 566-577"  # Frontend structure
    - "lines 664-694"  # Allocation flow (reference for future)
  story: "docs/2-MANAGEMENT/epics/current/07-shipping/07.2.sales-orders-core.md"
  brief: "docs/2-MANAGEMENT/epics/current/07-shipping/STORY-WRITING-BRIEF.md"
  patterns:
    - "apps/frontend/lib/validation/*.ts"  # Zod schema patterns
    - "apps/frontend/components/ui/data-table.tsx"  # DataTable pattern
    - "apps/frontend/lib/services/*.ts"  # Service layer patterns

files_to_create:
  database:
    - path: "supabase/migrations/YYYYMMDDHHMMSS_create_sales_orders.sql"
      type: "migration"
      description: "Create sales_orders and sales_order_lines tables with RLS"
  api:
    - path: "apps/frontend/app/api/shipping/sales-orders/route.ts"
      methods: ["GET", "POST"]
      description: "List SOs (with filters), Create SO"
    - path: "apps/frontend/app/api/shipping/sales-orders/[id]/route.ts"
      methods: ["GET", "PUT", "DELETE"]
      description: "Get SO detail, Update SO (draft only), Delete SO (draft only)"
    - path: "apps/frontend/app/api/shipping/sales-orders/[id]/confirm/route.ts"
      methods: ["POST"]
      description: "Confirm SO (draft → confirmed)"
    - path: "apps/frontend/app/api/shipping/sales-orders/[id]/lines/route.ts"
      methods: ["POST"]
      description: "Add line to SO (optional - can be part of main SO update)"
    - path: "apps/frontend/app/api/shipping/sales-orders/[id]/lines/[lineId]/route.ts"
      methods: ["PUT", "DELETE"]
      description: "Update/Delete SO line (optional)"
  services:
    - path: "apps/frontend/lib/services/sales-order-service.ts"
      description: "SO CRUD, status transitions, calculations"
    - path: "apps/frontend/lib/services/sales-order-line-service.ts"
      description: "SO line CRUD, line number auto-increment"
  validation:
    - path: "apps/frontend/lib/validation/sales-order-schema.ts"
      description: "Zod schemas for SO create/update/lines"
  pages:
    - path: "apps/frontend/app/(authenticated)/shipping/sales-orders/page.tsx"
      description: "SO list page with filters"
    - path: "apps/frontend/app/(authenticated)/shipping/sales-orders/[id]/page.tsx"
      description: "SO detail page with lines table"
    - path: "apps/frontend/app/(authenticated)/shipping/sales-orders/new/page.tsx"
      description: "Create SO wizard (3 steps)"
  components:
    - path: "apps/frontend/app/(authenticated)/shipping/sales-orders/components/SOTable.tsx"
      description: "DataTable with sorting, filtering, pagination"
    - path: "apps/frontend/app/(authenticated)/shipping/sales-orders/components/SOFilters.tsx"
      description: "Status, customer, date range filters"
    - path: "apps/frontend/app/(authenticated)/shipping/sales-orders/components/SOWizard.tsx"
      description: "Multi-step wizard (customer → lines → review)"
    - path: "apps/frontend/app/(authenticated)/shipping/sales-orders/components/SOLinesTable.tsx"
      description: "Lines table within SO detail"
    - path: "apps/frontend/app/(authenticated)/shipping/sales-orders/components/SOLineForm.tsx"
      description: "Add/edit line form"
    - path: "apps/frontend/app/(authenticated)/shipping/sales-orders/components/SOStatusBadge.tsx"
      description: "Status indicator (draft, confirmed)"
    - path: "apps/frontend/app/(authenticated)/shipping/sales-orders/components/SOStatusTimeline.tsx"
      description: "Visual timeline of SO lifecycle"
    - path: "apps/frontend/app/(authenticated)/shipping/sales-orders/components/ConfirmOrderDialog.tsx"
      description: "Confirmation dialog for SO confirm"
    - path: "apps/frontend/app/(authenticated)/shipping/sales-orders/components/DeleteOrderDialog.tsx"
      description: "Confirmation dialog for SO delete (draft only)"

database:
  tables:
    - name: "sales_orders"
      columns:
        - "id UUID PRIMARY KEY DEFAULT gen_random_uuid()"
        - "org_id UUID NOT NULL REFERENCES organizations(id)"
        - "order_number TEXT NOT NULL"
        - "customer_id UUID NOT NULL REFERENCES customers(id)"
        - "customer_po TEXT"
        - "shipping_address_id UUID NOT NULL REFERENCES customer_addresses(id)"
        - "order_date DATE NOT NULL"
        - "promised_ship_date DATE"
        - "required_delivery_date DATE"
        - "status TEXT NOT NULL DEFAULT 'draft'"
        - "total_amount DECIMAL(15,2)"
        - "notes TEXT"
        - "allergen_validated BOOLEAN DEFAULT false"
        - "created_at TIMESTAMPTZ DEFAULT now()"
        - "created_by UUID REFERENCES users(id)"
        - "updated_at TIMESTAMPTZ DEFAULT now()"
        - "confirmed_at TIMESTAMPTZ"
        - "shipped_at TIMESTAMPTZ"
      constraints:
        - "UNIQUE(org_id, order_number)"
      rls: true
      rls_policies:
        - name: "sales_orders_org_isolation"
          operation: "ALL"
          using: "org_id = (SELECT org_id FROM users WHERE id = auth.uid())"
      indexes:
        - "org_id, status"
        - "customer_id"
        - "promised_ship_date"
        - "order_date"

    - name: "sales_order_lines"
      columns:
        - "id UUID PRIMARY KEY DEFAULT gen_random_uuid()"
        - "org_id UUID NOT NULL REFERENCES organizations(id)"
        - "sales_order_id UUID NOT NULL REFERENCES sales_orders(id) ON DELETE CASCADE"
        - "line_number INTEGER NOT NULL"
        - "product_id UUID NOT NULL REFERENCES products(id)"
        - "quantity_ordered DECIMAL(15,4) NOT NULL CHECK (quantity_ordered > 0)"
        - "quantity_allocated DECIMAL(15,4) DEFAULT 0"
        - "quantity_picked DECIMAL(15,4) DEFAULT 0"
        - "quantity_packed DECIMAL(15,4) DEFAULT 0"
        - "quantity_shipped DECIMAL(15,4) DEFAULT 0"
        - "unit_price DECIMAL(15,4) NOT NULL CHECK (unit_price >= 0)"
        - "line_total DECIMAL(15,2)"
        - "requested_lot TEXT"
        - "notes TEXT"
        - "created_at TIMESTAMPTZ DEFAULT now()"
      constraints:
        - "UNIQUE(sales_order_id, line_number)"
      rls: true
      rls_policies:
        - name: "sales_order_lines_org_isolation"
          operation: "ALL"
          using: "org_id = (SELECT org_id FROM users WHERE id = auth.uid())"
      indexes:
        - "sales_order_id"
        - "product_id"

  sequence:
    - name: "organizations.next_so_sequence"
      description: "Per-org sequence for order number generation (SO-YYYY-NNNNN)"
      type: "INTEGER DEFAULT 1"

api_endpoints:
  - method: "GET"
    path: "/api/shipping/sales-orders"
    description: "List sales orders with pagination, search, and filtering"
    auth: true
    roles: ["ALL_AUTHENTICATED"]
    query_params:
      - "page: number (default 1)"
      - "limit: number (default 25, max 100)"
      - "search: string (searches order_number, customer_po)"
      - "customer_id: UUID (filter by customer)"
      - "status: 'draft' | 'confirmed' (filter by status)"
      - "start_date: date (order_date >= start_date)"
      - "end_date: date (order_date <= end_date)"
      - "sortBy: 'order_number' | 'order_date' | 'customer' | 'status' | 'total'"
      - "sortOrder: 'asc' | 'desc'"
    response:
      sales_orders: "SalesOrder[]"
      total: "number"
      page: "number"
      limit: "number"
    performance: "< 500ms for 1000 orders"

  - method: "GET"
    path: "/api/shipping/sales-orders/:id"
    description: "Get SO detail with lines, customer, address"
    auth: true
    roles: ["ALL_AUTHENTICATED"]
    response:
      sales_order: "SalesOrder"
      lines: "SalesOrderLine[]"
      customer: "Customer"
      shipping_address: "CustomerAddress"

  - method: "POST"
    path: "/api/shipping/sales-orders"
    description: "Create new sales order"
    auth: true
    roles: ["SALES", "MANAGER", "ADMIN", "SUPER_ADMIN"]
    request_body:
      customer_id: "UUID (required)"
      customer_po: "string (optional, max 100)"
      shipping_address_id: "UUID (required)"
      order_date: "date (required, default today)"
      promised_ship_date: "date (optional)"
      required_delivery_date: "date (optional)"
      notes: "string (optional, max 1000)"
      lines: "array (min 1 line required)"
    response:
      id: "UUID"
      order_number: "string (auto-generated SO-YYYY-NNNNN)"
      status: "draft"
      created_at: "timestamp"
    side_effects:
      - "Auto-generate order_number (SO-YYYY-NNNNN)"
      - "Auto-increment line_number for each line"
      - "Calculate line_total for each line"
      - "Calculate total_amount for SO"

  - method: "PUT"
    path: "/api/shipping/sales-orders/:id"
    description: "Update sales order (draft only)"
    auth: true
    roles: ["SALES", "MANAGER", "ADMIN", "SUPER_ADMIN"]
    request_body:
      customer_po: "string (optional)"
      shipping_address_id: "UUID (optional)"
      promised_ship_date: "date (optional)"
      required_delivery_date: "date (optional)"
      notes: "string (optional)"
      lines: "array (optional, full replace or merge)"
    response:
      id: "UUID"
      updated_at: "timestamp"
    errors:
      400: "Cannot edit confirmed orders"
      404: "Sales order not found"

  - method: "DELETE"
    path: "/api/shipping/sales-orders/:id"
    description: "Delete sales order (draft only)"
    auth: true
    roles: ["MANAGER", "ADMIN", "SUPER_ADMIN"]
    response:
      success: true
      message: "Sales order deleted"
    errors:
      400: "Cannot delete confirmed orders. Contact administrator."
      404: "Sales order not found"
    side_effects:
      - "Cascade delete all sales_order_lines (ON DELETE CASCADE)"

  - method: "POST"
    path: "/api/shipping/sales-orders/:id/confirm"
    description: "Confirm sales order (draft → confirmed)"
    auth: true
    roles: ["SALES", "MANAGER", "ADMIN", "SUPER_ADMIN"]
    response:
      id: "UUID"
      status: "confirmed"
      confirmed_at: "timestamp"
    errors:
      400: "Order already confirmed"
      404: "Sales order not found"
    side_effects:
      - "Set status = 'confirmed'"
      - "Set confirmed_at = now()"
      - "Lock order for editing"
      - "Trigger allocation (Story 07.7 - future)"

ux:
  patterns:
    table: "ShadCN DataTable with column sorting, filtering, pagination"
    wizard: "Multi-step form with progress indicator (3 steps)"
    modal: "ShadCN Dialog for confirmations"
    form: "react-hook-form with Zod resolver"
    badge: "ShadCN Badge for status indicators"
    search: "Debounced search input (300ms)"
    filters: "Dropdown filters with clear button"
  states:
    loading: "Skeleton rows (3) with shimmer animation"
    empty: "'No orders found' illustration with 'Create First Order' CTA"
    error: "'Failed to load orders' warning with Retry button"
    success: "Table populated with order data"
  status_badges:
    draft: "bg-yellow-100 text-yellow-800"
    confirmed: "bg-blue-100 text-blue-800"
    allocated: "bg-purple-100 text-purple-800 (future)"
    picking: "bg-orange-100 text-orange-800 (future)"
    packing: "bg-cyan-100 text-cyan-800 (future)"
    shipped: "bg-green-100 text-green-800 (future)"
    delivered: "bg-gray-100 text-gray-800 (future)"
    cancelled: "bg-red-100 text-red-800 (future)"
  wizard_steps:
    - step: 1
      title: "Customer & Address"
      fields: ["customer_id", "shipping_address_id", "customer_po"]
    - step: 2
      title: "Add Lines"
      fields: ["lines[] with product_id, quantity, price"]
    - step: 3
      title: "Review & Save"
      fields: ["summary, totals, dates, notes"]

validation_rules:
  customer_id:
    type: "uuid"
    required: true
    error_empty: "Customer is required"
    error_invalid: "Invalid customer"
  shipping_address_id:
    type: "uuid"
    required: true
    error_empty: "Shipping address is required"
    error_invalid: "Invalid shipping address"
  order_date:
    type: "date"
    required: true
    default: "today"
  lines:
    type: "array"
    min: 1
    error_empty: "Order must have at least one line"
  line.product_id:
    type: "uuid"
    required: true
    error_empty: "Product is required"
    error_invalid: "Invalid product"
  line.quantity_ordered:
    type: "number"
    required: true
    min: 0.0001
    max: 999999.9999
    precision: 4
    error_empty: "Quantity is required"
    error_invalid: "Quantity must be greater than zero"
  line.unit_price:
    type: "number"
    required: true
    min: 0
    max: 999999.9999
    precision: 4
    error_empty: "Unit price is required"
    error_invalid: "Unit price cannot be negative"
  customer_po:
    type: "string"
    required: false
    max: 100
  notes:
    type: "string"
    required: false
    max: 1000

patterns:
  rls: "Standard org_id isolation on sales_orders and sales_order_lines"
  api: "REST with org_id filter from auth context"
  service: "Class-based SalesOrderService with static methods"
  validation: "Zod schemas in lib/validation/sales-order-schema.ts"
  order_number_generation: |
    async generateOrderNumber(orgId: string): Promise<string> {
      const org = await db.organizations.findUnique({ where: { id: orgId } });
      const year = new Date().getFullYear();
      const sequence = org.next_so_sequence;
      const orderNumber = `SO-${year}-${String(sequence).padStart(5, '0')}`;

      // Increment sequence
      await db.organizations.update({
        where: { id: orgId },
        data: { next_so_sequence: { increment: 1 } }
      });

      return orderNumber;
    }
  line_number_generation: |
    async getNextLineNumber(soId: string): Promise<number> {
      const maxLine = await db.sales_order_lines.findFirst({
        where: { sales_order_id: soId },
        orderBy: { line_number: 'desc' }
      });
      return (maxLine?.line_number || 0) + 1;
    }
  calculations: |
    calculateLineTotal(quantity: number, unitPrice: number): number {
      return Math.round(quantity * unitPrice * 100) / 100; // 2 decimal places
    }

    calculateOrderTotal(lines: SOLine[]): number {
      return lines.reduce((sum, line) => sum + line.line_total, 0);
    }

acceptance_checklist:
  so_list_page:
    - "GIVEN clerk navigates to /shipping/sales-orders, WHEN page loads, THEN SO list displays within 500ms"
    - "GIVEN SO list has 500 orders, WHEN clerk searches 'SO-2025-00123', THEN filtered results display within 300ms"
    - "GIVEN SO list displayed, WHEN clerk filters by status 'confirmed', THEN only confirmed orders appear"
    - "GIVEN SO list displayed, WHEN clerk filters by customer, THEN only that customer's orders appear"
    - "GIVEN SO list with pagination, WHEN page 2 clicked, THEN next 25 orders display"

  create_so:
    - "GIVEN clerk clicks 'Create Sales Order', WHEN wizard opens, THEN Step 1 displays customer selection"
    - "GIVEN customer selected, WHEN next clicked, THEN shipping address dropdown populates"
    - "GIVEN clerk on Step 2, WHEN 'Add Line' clicked, THEN product/quantity/price fields appear"
    - "GIVEN line added with qty 100 @ $10.50, WHEN saved, THEN line total displays $1,050.00"
    - "GIVEN clerk on Step 3, WHEN 'Save as Draft' clicked, THEN SO created with auto-generated order number"

  edit_so:
    - "GIVEN clerk opens draft SO, WHEN 'Edit' clicked, THEN wizard reopens with existing data"
    - "GIVEN clerk updates line quantity, WHEN saved, THEN line total and SO total recalculate"
    - "GIVEN clerk opens confirmed SO, WHEN page loads, THEN 'Edit' button hidden"

  confirm_so:
    - "GIVEN clerk opens draft SO, WHEN 'Confirm Order' clicked, THEN confirmation dialog displays"
    - "GIVEN confirmation accepted, WHEN confirm completes, THEN SO status changes to 'confirmed'"
    - "GIVEN SO is confirmed, WHEN detail page reloaded, THEN Edit button hidden"

  order_number:
    - "GIVEN new SO created, WHEN saved, THEN order number generated as SO-YYYY-NNNNN"
    - "GIVEN year changes to 2026, WHEN first SO of 2026 created, THEN order number resets to SO-2026-00001"
    - "GIVEN 50 orders in org A, WHEN org B creates order, THEN order number for org B is SO-2025-00001"

  totals:
    - "GIVEN line with qty 100 @ $10.50, WHEN saved, THEN line_total = $1,050.00"
    - "GIVEN SO with 3 lines totaling $1,800.00, WHEN saved, THEN SO total_amount = $1,800.00"

  cascade_delete:
    - "GIVEN SO with 5 lines, WHEN SO deleted (draft), THEN all 5 lines deleted automatically"
    - "GIVEN SO is confirmed, WHEN delete attempted, THEN error 'Cannot delete confirmed orders' displays"

  rls:
    - "GIVEN user from org A logged in, WHEN SO list loads, THEN only org A's orders appear"
    - "GIVEN user from org B tries to access org A's SO by URL, WHEN request made, THEN 404 error returns"

definition_of_done:
  - "sales_orders table created with RLS policies"
  - "sales_order_lines table created with RLS policies"
  - "Order number auto-generation works (SO-YYYY-NNNNN)"
  - "SO list page loads within 500ms for 1000 orders"
  - "Create SO wizard works end-to-end (3 steps)"
  - "Edit SO updates immediately in UI (draft only)"
  - "Confirm SO changes status to confirmed, locks editing"
  - "Line totals and SO total calculate correctly"
  - "Cascade delete removes all lines when SO deleted"
  - "Multi-tenant isolation verified"
  - "Permission checks hide unauthorized actions"
  - "Search and filters work within 300ms"
  - "Status badges display correctly"
  - "All API endpoints have integration tests"
  - "Unit tests cover services (>80% coverage)"
  - "E2E test: Full SO creation and confirmation flow"

tests:
  unit:
    - "SalesOrderService.generateOrderNumber returns SO-YYYY-NNNNN format"
    - "SalesOrderService.calculateLineTotal returns correct decimal"
    - "SalesOrderService.calculateOrderTotal sums all line totals"
    - "SalesOrderService.canEdit returns false for confirmed status"
    - "SalesOrderService.canDelete returns false for confirmed status"
    - "SalesOrderLineService.getNextLineNumber auto-increments correctly"
    - "Zod schema rejects quantity <= 0"
    - "Zod schema rejects negative unit_price"
    - "Zod schema requires at least 1 line"
  integration:
    - "GET /api/shipping/sales-orders returns paginated results"
    - "GET /api/shipping/sales-orders?status=draft filters correctly"
    - "GET /api/shipping/sales-orders/:id returns SO with lines"
    - "POST /api/shipping/sales-orders creates SO with auto-generated order number"
    - "POST /api/shipping/sales-orders calculates line_total and total_amount"
    - "PUT /api/shipping/sales-orders/:id updates draft SO"
    - "PUT /api/shipping/sales-orders/:id returns 400 for confirmed SO"
    - "DELETE /api/shipping/sales-orders/:id cascades to lines"
    - "DELETE /api/shipping/sales-orders/:id returns 400 for confirmed SO"
    - "POST /api/shipping/sales-orders/:id/confirm changes status to confirmed"
    - "RLS blocks cross-org access"
  e2e:
    - "Full SO creation: Select customer → Add lines → Review → Save"
    - "Edit draft SO and see immediate updates"
    - "Confirm SO and verify Edit button hidden"
    - "Search and filter SO list"
    - "Delete draft SO and verify lines removed"

output_artifacts:
  - "Migration: create_sales_orders_and_lines.sql"
  - "API: GET/POST /api/shipping/sales-orders"
  - "API: GET/PUT/DELETE /api/shipping/sales-orders/:id"
  - "API: POST /api/shipping/sales-orders/:id/confirm"
  - "SalesOrderService with CRUD, calculations, status transitions"
  - "SalesOrderLineService with line CRUD, line number auto-increment"
  - "sales-order-schema.ts with Zod validation"
  - "SO list page with filters"
  - "SO detail page with lines table"
  - "SO creation wizard (3 steps)"
  - "SO components: Table, Filters, Wizard, StatusBadge, Timeline"
  - "Unit tests for services"
  - "Integration tests for API endpoints"
  - "E2E test for SO creation flow"

implementation_notes:
  frontend:
    - "Use ShadCN DataTable for SO list with server-side pagination"
    - "Use multi-step wizard for SO creation (customer → lines → review)"
    - "Debounce search input by 300ms to reduce API calls"
    - "Show skeleton loaders while data is loading"
    - "Display status badges with color coding"
    - "Hide Edit/Delete buttons for confirmed orders"
    - "Show confirmation dialog before confirming SO"
    - "Recalculate totals in real-time as lines are added/edited"
  backend:
    - "Auto-generate order_number on SO creation using org sequence"
    - "Auto-increment line_number when adding lines to SO"
    - "Calculate line_total = quantity * unit_price on save"
    - "Calculate total_amount = SUM(line_totals) on SO save"
    - "Validate status = 'draft' before allowing edit/delete"
    - "Implement cascade delete via ON DELETE CASCADE FK constraint"
    - "Use RLS for org isolation on both tables"
    - "Store confirmed_at timestamp when status changes to confirmed"
  database:
    - "Add organizations.next_so_sequence column for order number generation"
    - "Ensure UNIQUE constraint on (org_id, order_number)"
    - "Ensure UNIQUE constraint on (sales_order_id, line_number)"
    - "Add CHECK constraint: quantity_ordered > 0"
    - "Add CHECK constraint: unit_price >= 0"
    - "Create indexes for common query patterns (org_id + status, customer_id, dates)"
  future_phases:
    - "Story 07.7 will add allocation logic on SO confirmation"
    - "Story 07.5 will add hold/cancel status transitions"
    - "Story 07.6 will add allergen validation before confirmation"
    - "quantity_allocated/picked/packed/shipped columns exist but unused in this story"
