# Story 07.2 - API Specification
# Purpose: Endpoints, request/response schemas, error handling
# Agent: BACKEND-DEV (API focus)

base_path: "/api/shipping/sales-orders"

endpoints:
  - method: "GET"
    path: "/api/shipping/sales-orders"
    description: "List sales orders (paginated, filtered)"
    file: "apps/frontend/app/api/shipping/sales-orders/route.ts"
    auth: "required"
    roles: ["*"]

    query_params:
      - name: "search"
        type: "string"
        required: false
        description: "Filter by SO number or customer name (min 2 chars)"
      - name: "status"
        type: "string"
        enum: ["draft", "confirmed", "all"]
        default: "all"
      - name: "customer_id"
        type: "string (UUID)"
        required: false
      - name: "start_date"
        type: "string (YYYY-MM-DD)"
        required: false
      - name: "end_date"
        type: "string (YYYY-MM-DD)"
        required: false
      - name: "sortBy"
        type: "string"
        enum: ["order_number", "order_date", "status", "total_amount"]
        default: "order_date"
      - name: "sortOrder"
        type: "string"
        enum: ["asc", "desc"]
        default: "desc"
      - name: "page"
        type: "number"
        default: 1
      - name: "limit"
        type: "number"
        default: 25
        max: 100

    response:
      status: 200
      type: "PaginatedResult<SalesOrder>"
      schema:
        sales_orders: "SalesOrder[]"
        pagination:
          total: "number"
          page: "number"
          limit: "number"
          pages: "number"

    errors:
      - { status: 400, code: "INVALID_QUERY", message: "Invalid query parameters" }
      - { status: 401, code: "UNAUTHORIZED", message: "Unauthorized" }

  - method: "GET"
    path: "/api/shipping/sales-orders/:id"
    description: "Get sales order with lines and details"
    auth: "required"
    roles: ["*"]

    response:
      status: 200
      type: "SalesOrderDetail"
      schema:
        id: "string (UUID)"
        order_number: "string"
        customer: "{ id, name, email, phone }"
        shipping_address: "{ address_line1, city, state, postal_code }"
        status: "string (draft | confirmed)"
        order_date: "string (ISO date)"
        required_delivery_date: "string (ISO date)"
        promised_ship_date: "string (ISO date, nullable)"
        total_amount: "number"
        lines: "SalesOrderLine[]"
        created_at: "string (ISO datetime)"
        confirmed_at: "string (ISO datetime, nullable)"

    errors:
      - { status: 404, code: "NOT_FOUND", message: "Sales order not found" }

  - method: "POST"
    path: "/api/shipping/sales-orders"
    description: "Create sales order"
    auth: "required"
    roles: ["SUPER_ADMIN", "ADMIN", "SALES", "SHIPPING_MANAGER", "SHIPPING_CLERK"]

    request:
      type: "CreateSalesOrderRequest"
      schema:
        customer_id: "string (UUID), required"
        customer_po: "string, optional"
        shipping_address_id: "string (UUID), required"
        order_date: "string (YYYY-MM-DD), required, defaults to today"
        promised_ship_date: "string (YYYY-MM-DD), optional"
        required_delivery_date: "string (YYYY-MM-DD), required"
        notes: "string, optional"
        lines:
          - product_id: "string (UUID)"
            quantity_ordered: "number (> 0)"
            unit_price: "number (>= 0)"
            requested_lot: "string, optional"
            notes: "string, optional"

    response:
      status: 201
      type: "SalesOrder"
      example:
        id: "uuid-so-1"
        order_number: "SO-2025-00001"
        status: "draft"
        customer_id: "uuid-cust"
        customer_name: "Acme Corp"
        total_amount: 1250.00
        line_count: 1
        created_at: "2025-12-18T10:00:00Z"

    errors:
      - { status: 400, code: "VALIDATION_ERROR", message: "Validation failed", fields: ["customer_id", "lines"] }
      - { status: 403, code: "PERMISSION_DENIED", message: "Insufficient permissions" }
      - { status: 409, code: "DUPLICATE_ORDER_NUMBER", message: "Order number already exists" }

  - method: "PUT"
    path: "/api/shipping/sales-orders/:id"
    description: "Update sales order (draft only)"
    auth: "required"
    roles: ["SUPER_ADMIN", "ADMIN", "SALES", "SHIPPING_MANAGER", "SHIPPING_CLERK"]

    request:
      type: "UpdateSalesOrderRequest"
      schema:
        customer_po: "string, optional"
        shipping_address_id: "string (UUID), optional"
        promised_ship_date: "string (YYYY-MM-DD), optional"
        required_delivery_date: "string (YYYY-MM-DD), optional"
        notes: "string, optional"

    response:
      status: 200
      type: "SalesOrder"

    errors:
      - { status: 400, code: "INVALID_STATUS", message: "Cannot edit confirmed orders" }
      - { status: 404, code: "NOT_FOUND", message: "Sales order not found" }

  - method: "DELETE"
    path: "/api/shipping/sales-orders/:id"
    description: "Delete sales order (draft only, cascades to lines)"
    auth: "required"
    roles: ["SUPER_ADMIN", "ADMIN", "MANAGER", "SHIPPING_MANAGER"]

    response:
      status: 204

    errors:
      - { status: 400, code: "INVALID_STATUS", message: "Cannot delete confirmed orders" }
      - { status: 404, code: "NOT_FOUND", message: "Sales order not found" }

  - method: "POST"
    path: "/api/shipping/sales-orders/:id/confirm"
    description: "Confirm sales order (draft â†’ confirmed, triggers allocation workflow)"
    auth: "required"
    roles: ["SUPER_ADMIN", "ADMIN", "SALES", "SHIPPING_MANAGER", "SHIPPING_CLERK"]

    request: "{}"

    response:
      status: 200
      type: "SalesOrder"
      example:
        id: "uuid-so-1"
        status: "confirmed"
        confirmed_at: "2025-12-18T10:15:00Z"

    errors:
      - { status: 400, code: "INVALID_STATUS", message: "Order already confirmed" }
      - { status: 400, code: "EMPTY_LINES", message: "Cannot confirm order with no lines" }
      - { status: 404, code: "NOT_FOUND", message: "Sales order not found" }

  - method: "POST"
    path: "/api/shipping/sales-orders/:id/lines"
    description: "Add line to sales order"
    auth: "required"
    roles: ["SUPER_ADMIN", "ADMIN", "SALES", "SHIPPING_MANAGER", "SHIPPING_CLERK"]

    request:
      type: "CreateSalesOrderLineRequest"
      schema:
        product_id: "string (UUID), required"
        quantity_ordered: "number (> 0), required"
        unit_price: "number (>= 0), required"
        requested_lot: "string, optional"
        notes: "string, optional"

    response:
      status: 201
      type: "SalesOrderLine"
      example:
        id: "uuid-line-1"
        line_number: 1
        product_id: "uuid-prod"
        quantity_ordered: 100
        unit_price: 12.50
        line_total: 1250.00

    errors:
      - { status: 400, code: "INVALID_STATUS", message: "Cannot add lines to confirmed orders" }
      - { status: 400, code: "INVALID_PRODUCT", message: "Product not found or not a finished good" }
      - { status: 404, code: "NOT_FOUND", message: "Sales order not found" }

  - method: "PUT"
    path: "/api/shipping/sales-orders/:id/lines/:lineId"
    description: "Update sales order line"
    auth: "required"
    roles: ["SUPER_ADMIN", "ADMIN", "SALES", "SHIPPING_MANAGER", "SHIPPING_CLERK"]

    request:
      type: "UpdateSalesOrderLineRequest"
      schema:
        quantity_ordered: "number (> 0), optional"
        unit_price: "number (>= 0), optional"
        requested_lot: "string, optional"
        notes: "string, optional"

    response:
      status: 200
      type: "SalesOrderLine"

    errors:
      - { status: 400, code: "INVALID_STATUS", message: "Cannot update lines in confirmed orders" }
      - { status: 404, code: "NOT_FOUND", message: "Line not found" }

  - method: "DELETE"
    path: "/api/shipping/sales-orders/:id/lines/:lineId"
    description: "Delete sales order line"
    auth: "required"
    roles: ["SUPER_ADMIN", "ADMIN", "SALES", "SHIPPING_MANAGER", "SHIPPING_CLERK"]

    response:
      status: 204

    errors:
      - { status: 400, code: "INVALID_STATUS", message: "Cannot delete lines from confirmed orders" }
      - { status: 400, code: "LAST_LINE", message: "Cannot delete last line from order" }
      - { status: 404, code: "NOT_FOUND", message: "Line not found" }

# Services
services:
  - path: "apps/frontend/lib/services/sales-order-service.ts"
    description: "Sales order business logic"
    exports:
      - name: "SalesOrderService"
        type: "class"
        methods:
          - name: "list"
            params: ["params: SalesOrderListParams"]
            returns: "Promise<PaginatedResult<SalesOrder>>"
          - name: "getById"
            params: ["id: string"]
            returns: "Promise<SalesOrder>"
          - name: "create"
            params: ["data: CreateSalesOrderRequest"]
            returns: "Promise<SalesOrder>"
          - name: "update"
            params: ["id: string", "data: UpdateSalesOrderRequest"]
            returns: "Promise<SalesOrder>"
          - name: "delete"
            params: ["id: string"]
            returns: "Promise<void>"
          - name: "confirm"
            params: ["id: string"]
            returns: "Promise<SalesOrder>"
          - name: "calculateLineTotal"
            params: ["quantity: number", "unitPrice: number"]
            returns: "number"
          - name: "calculateOrderTotal"
            params: ["lines: SalesOrderLine[]"]
            returns: "number"

  - path: "apps/frontend/lib/services/sales-order-line-service.ts"
    description: "Sales order line management"
    exports:
      - name: "SalesOrderLineService"
        type: "class"
        methods:
          - name: "addLine"
            params: ["soId: string", "data: CreateSalesOrderLineRequest"]
            returns: "Promise<SalesOrderLine>"
          - name: "updateLine"
            params: ["lineId: string", "data: UpdateSalesOrderLineRequest"]
            returns: "Promise<SalesOrderLine>"
          - name: "deleteLine"
            params: ["lineId: string"]
            returns: "Promise<void>"
          - name: "getNextLineNumber"
            params: ["soId: string"]
            returns: "Promise<number>"

# Types
types:
  - path: "apps/frontend/lib/types/sales-order.ts"
    description: "Sales order TypeScript interfaces"
    exports:
      - name: "SalesOrder"
        fields:
          - "id: string"
          - "org_id: string"
          - "order_number: string"
          - "customer_id: string"
          - "customer_po?: string"
          - "shipping_address_id: string"
          - "order_date: string"
          - "promised_ship_date?: string"
          - "required_delivery_date: string"
          - "status: 'draft' | 'confirmed'"
          - "total_amount: number"
          - "notes?: string"
          - "allergen_validated: boolean"
          - "created_at: string"
          - "created_by: string"
          - "updated_at: string"
          - "confirmed_at?: string"
          - "shipped_at?: string"

      - name: "SalesOrderLine"
        fields:
          - "id: string"
          - "sales_order_id: string"
          - "line_number: number"
          - "product_id: string"
          - "quantity_ordered: number"
          - "quantity_allocated: number"
          - "quantity_picked: number"
          - "quantity_packed: number"
          - "quantity_shipped: number"
          - "unit_price: number"
          - "line_total: number"
          - "requested_lot?: string"
          - "notes?: string"
          - "created_at: string"

      - name: "CreateSalesOrderRequest"
        fields:
          - "customer_id: string"
          - "customer_po?: string"
          - "shipping_address_id: string"
          - "order_date: string"
          - "promised_ship_date?: string"
          - "required_delivery_date: string"
          - "notes?: string"
          - "lines: CreateSalesOrderLineRequest[]"

      - name: "CreateSalesOrderLineRequest"
        fields:
          - "product_id: string"
          - "quantity_ordered: number"
          - "unit_price: number"
          - "requested_lot?: string"
          - "notes?: string"

      - name: "UpdateSalesOrderRequest"
        fields:
          - "customer_po?: string"
          - "shipping_address_id?: string"
          - "promised_ship_date?: string"
          - "required_delivery_date?: string"
          - "notes?: string"

      - name: "UpdateSalesOrderLineRequest"
        fields:
          - "quantity_ordered?: number"
          - "unit_price?: number"
          - "requested_lot?: string"
          - "notes?: string"

      - name: "SalesOrderListParams"
        fields:
          - "search?: string"
          - "status?: 'draft' | 'confirmed' | 'all'"
          - "customer_id?: string"
          - "start_date?: string"
          - "end_date?: string"
          - "sortBy?: string"
          - "sortOrder?: 'asc' | 'desc'"
          - "page?: number"
          - "limit?: number"

      - name: "PaginatedResult<SalesOrder>"
        fields:
          - "sales_orders: SalesOrder[]"
          - "pagination: { total: number; page: number; limit: number; pages: number }"

# Patterns
patterns:
  order_number_generation: |
    // Auto-generated on INSERT via database trigger
    // Format: SO-YYYY-NNNNN
    // Example: SO-2025-00001 (org-scoped sequence)
    // Resets per calendar year per org

  cascade_delete: |
    // Deleting sales_order cascades to sales_order_lines
    // ON DELETE CASCADE in foreign key constraint

  total_calculation: |
    // Line total: quantity_ordered * unit_price
    // Order total: SUM(line_totals)
    // Calculated fields in database (GENERATED ALWAYS AS ... STORED)
