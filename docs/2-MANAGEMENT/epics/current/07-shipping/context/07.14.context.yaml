story:
  id: "07.14"
  name: "Shipment Manifest + Ship + Tracking"
  epic: "07-shipping"
  phase: "1C"
  complexity: "M"
  estimate_days: 3-4
  priority: "P0"
  type: "backend + frontend"

dependencies:
  required:
    - story: "01.1"
      provides: ["organizations", "users", "roles", "RLS"]
      epic: "01-settings"
    - story: "01.8"
      provides: ["warehouses"]
      epic: "01-settings"
    - story: "02.1"
      provides: ["products"]
      epic: "02-technical"
    - story: "05.1"
      provides: ["license_plates", "LP status tracking"]
      epic: "05-warehouse"
    - story: "07.1"
      provides: ["customers table"]
      epic: "07-shipping"
    - story: "07.2"
      provides: ["customer_addresses table"]
      epic: "07-shipping"
    - story: "07.3"
      provides: ["sales_orders table"]
      epic: "07-shipping"
    - story: "07.4"
      provides: ["sales_order_lines table"]
      epic: "07-shipping"
    - story: "07.7"
      provides: ["inventory_allocations table"]
      epic: "07-shipping"
    - story: "07.8"
      provides: ["pick_lists table"]
      epic: "07-shipping"
    - story: "07.9"
      provides: ["pick_list_lines.status='picked'"]
      epic: "07-shipping"
    - story: "07.11"
      provides: ["shipments", "shipment_boxes", "shipment_box_contents"]
      epic: "07-shipping"
      blocker: true
    - story: "07.13"
      provides: ["SSCC generation", "boxes.sscc populated"]
      epic: "07-shipping"
      blocker: true

  provides_to:
    - story: "07.15"
      needs: ["shipped/delivered status", "shipped_at timestamps"]
      description: "Dashboard displays shipment metrics"
    - story: "07.16"
      needs: ["shipped orders", "delivery dates"]
      description: "Orders by status report"
    - epic: "09-finance"
      needs: ["shipped sales orders", "shipped_at"]
      description: "Invoice generation triggers on shipped status"

files_to_read:
  prd: "docs/1-BASELINE/product/modules/shipping.md"
  prd_sections: ["FR-7.15 Partial Fulfillment"]
  architecture: "docs/1-BASELINE/architecture/modules/shipping.md"
  architecture_sections:
    - lines: "178-202"
      description: "shipments table schema (status, shipped_at, delivered_at)"
    - lines: "448-454"
      description: "Ship/Manifest API endpoints"
    - lines: "757-788"
      description: "Ship confirmation flow diagram"
  story: "docs/2-MANAGEMENT/epics/current/07-shipping/07.14.shipment-manifest-ship.md"
  patterns:
    - "docs/1-BASELINE/architecture/patterns/ADR-013-rls-policies.md"
    - "lib/services/shipment-service.ts"  # Extend this from Story 07.11
    - "apps/frontend/app/(authenticated)/production/work-orders/[id]/page.tsx"  # Reference for action buttons

files_to_create:
  database:
    - path: "supabase/migrations/YYYYMMDDHHMMSS_ship_shipment_rpc.sql"
      type: "migration"
      includes:
        - "ship_shipment() RPC function (transaction wrapper)"
        - "Indexes for shipped_at, delivered_at"
        - "Status workflow constraint (optional)"

  api:
    - path: "apps/frontend/app/api/shipping/shipments/[id]/manifest/route.ts"
      methods: ["POST"]
      auth: true
      roles: ["Warehouse", "Manager", "Admin"]
    - path: "apps/frontend/app/api/shipping/shipments/[id]/ship/route.ts"
      methods: ["POST"]
      auth: true
      roles: ["Warehouse", "Manager", "Admin"]
    - path: "apps/frontend/app/api/shipping/shipments/[id]/mark-delivered/route.ts"
      methods: ["POST"]
      auth: true
      roles: ["Manager", "Admin"]
    - path: "apps/frontend/app/api/shipping/shipments/[id]/tracking/route.ts"
      methods: ["GET"]
      auth: true
      roles: ["Any authenticated"]

  services:
    - path: "lib/services/shipment-service.ts"
      methods:
        - "manifestShipment(shipmentId)"
        - "shipShipment(shipmentId)"
        - "markDelivered(shipmentId)"
        - "getTrackingInfo(shipmentId)"
        - "getCarrierTrackingUrl(carrier, trackingNumber)"  # Private helper
      notes: "Extend existing ShipmentService from Story 07.11"

  validation:
    - path: "lib/validation/shipment-schema.ts"
      schemas:
        - "manifestShipmentSchema"
        - "shipShipmentSchema"
        - "markDeliveredSchema"
        - "trackingInfoSchema"
      notes: "Extend existing file from Story 07.11"

  pages:
    - path: "apps/frontend/app/(authenticated)/shipping/shipments/[id]/page.tsx"
      description: "Update existing shipment detail page with action buttons"
      modifications:
        - "Add ShipmentActions component"
        - "Add ShipConfirmDialog"
        - "Add TrackingDialog"

  components:
    - path: "apps/frontend/app/(authenticated)/shipping/shipments/components/ShipmentActions.tsx"
      description: "Action buttons (Manifest, Ship, Mark Delivered, View Tracking)"
      props:
        - "shipment: Shipment"
        - "onManifest: () => void"
        - "onShip: () => void"
        - "onMarkDelivered: () => void"
        - "onViewTracking: () => void"
      logic:
        - "Disable buttons based on status workflow"
        - "Hide Mark Delivered if user not Manager+"
        - "Display loading states during actions"
    - path: "apps/frontend/app/(authenticated)/shipping/shipments/components/ShipConfirmDialog.tsx"
      description: "Confirmation dialog for ship action (irreversible warning)"
      props:
        - "open: boolean"
        - "shipmentNumber: string"
        - "onConfirm: () => void"
        - "onCancel: () => void"
      ui:
        - "ShadCN AlertDialog"
        - "Warning icon, danger variant for Ship button"
        - "Message: 'This action is irreversible. All inventory will be consumed.'"
    - path: "apps/frontend/app/(authenticated)/shipping/shipments/components/TrackingDialog.tsx"
      description: "Tracking info modal with timeline"
      props:
        - "open: boolean"
        - "trackingInfo: TrackingInfo"
        - "onClose: () => void"
      ui:
        - "ShadCN Dialog"
        - "Display carrier, tracking number, external link"
        - "Embed TrackingTimeline component"
    - path: "apps/frontend/app/(authenticated)/shipping/shipments/components/TrackingTimeline.tsx"
      description: "Status timeline with badges and dates"
      props:
        - "timeline: { packed_at, manifested_at, shipped_at, delivered_at }"
      ui:
        - "Vertical timeline (CSS or ShadCN)"
        - "Status badges (checkmark for complete, spinner for in-progress, empty for pending)"
        - "Timestamps and user names"
        - "Example: ✓ Packed (2025-12-16 10:30 by John Doe)"

  tests:
    - path: "lib/services/__tests__/shipment-service.test.ts"
      type: "unit"
      coverage: ">80%"
      scenarios:
        - "manifestShipment: validates SSCC presence"
        - "manifestShipment: throws error if boxes missing SSCC"
        - "shipShipment: validates manifested status"
        - "shipShipment: updates LPs to 'shipped'"
        - "shipShipment: updates SO status and shipped_at"
        - "shipShipment: updates SO lines quantity_shipped"
        - "markDelivered: updates shipment and SO to 'delivered'"
        - "getTrackingInfo: returns timeline and external URL"
        - "getCarrierTrackingUrl: generates correct URLs for DHL/UPS/DPD/FedEx"
    - path: "tests/e2e/shipping/ship-workflow.spec.ts"
      type: "e2e"
      scenarios:
        - "Full workflow: pack → manifest → ship → deliver"
        - "Manifest validation: Error if boxes missing SSCC"
        - "Ship validation: Error if not manifested"
        - "Ship confirmation dialog: Cancel vs. Confirm"
        - "LP consumption: Verify LPs status='shipped'"
        - "SO cascade: Verify SO status='shipped', quantity_shipped updated"
        - "Mark delivered permission: Manager only"
        - "Tracking display: Show timeline and external link"

database:
  tables:
    - name: "shipments"
      modifications:
        - "Add indexes: shipped_at, delivered_at"
        - "Add constraint: status workflow validation (optional)"
      notes: "Table already exists from Story 07.11, only add indexes"

  functions:
    - name: "ship_shipment(p_shipment_id UUID, p_shipped_at TIMESTAMPTZ)"
      returns: "shipments"
      description: "Transaction wrapper for ship action"
      logic:
        - "Validate shipment status (manifested or packed)"
        - "Update shipments.status='shipped', shipped_at"
        - "Update license_plates.status='shipped' (via shipment_box_contents join)"
        - "Update sales_orders.status='shipped', shipped_at"
        - "Update sales_order_lines.quantity_shipped = quantity_packed"
        - "Return updated shipment"
      security: "SECURITY DEFINER (runs as superuser to update across tables)"

api_endpoints:
  - method: "POST"
    path: "/api/shipping/shipments/:id/manifest"
    auth: true
    roles: ["Warehouse", "Manager", "Admin"]
    input: {}
    output:
      success: "boolean"
      shipment: "Shipment"
    business_logic:
      - "Validate shipment.status = 'packed'"
      - "Fetch all shipment_boxes for shipment_id"
      - "Validate all boxes have non-null sscc"
      - "If validation fails: throw 400 error with count of missing SSCC"
      - "Update shipment.status = 'manifested'"
      - "Return updated shipment"

  - method: "POST"
    path: "/api/shipping/shipments/:id/ship"
    auth: true
    roles: ["Warehouse", "Manager", "Admin"]
    input:
      confirm: "boolean (required)"
    output:
      success: "boolean"
      shipment: "Shipment"
    business_logic:
      - "Validate confirm = true (Zod)"
      - "Validate shipment.status IN ('manifested', 'packed')"
      - "Call ship_shipment() RPC function"
      - "Return updated shipment"
    transaction: "Wrapped in ship_shipment() RPC (atomic)"

  - method: "POST"
    path: "/api/shipping/shipments/:id/mark-delivered"
    auth: true
    roles: ["Manager", "Admin"]
    input: {}
    output:
      success: "boolean"
      shipment: "Shipment"
    business_logic:
      - "Validate user role (Manager or Admin)"
      - "Validate shipment.status = 'shipped'"
      - "Update shipment.status = 'delivered', delivered_at = now()"
      - "Update sales_orders.status = 'delivered'"
      - "Return updated shipment"

  - method: "GET"
    path: "/api/shipping/shipments/:id/tracking"
    auth: true
    roles: ["Any authenticated"]
    output:
      carrier: "string | null"
      tracking_number: "string | null"
      status: "string"
      timeline:
        packed_at: "string | null"
        packed_by: "string | null"
        manifested_at: "string | null"
        shipped_at: "string | null"
        delivered_at: "string | null"
      external_url: "string | null"
    business_logic:
      - "Fetch shipment by id"
      - "Fetch packed_by user name"
      - "Construct timeline from timestamps"
      - "Generate external_url using getCarrierTrackingUrl()"
      - "Return tracking info"

ux:
  wireframes: []  # No wireframes, standard detail page actions
  patterns:
    button: "ShadCN Button (disabled states based on status)"
    dialog: "ShadCN AlertDialog for ship confirmation"
    modal: "ShadCN Dialog for tracking info"
    timeline: "Vertical timeline with status badges (custom or Tremor)"
    badge: "ShadCN Badge for status display"
  components:
    - "ShipmentActions: Button group in shipment detail header (Manifest | Ship | Mark Delivered | View Tracking)"
    - "ShipConfirmDialog: AlertDialog with warning (irreversible action)"
    - "TrackingDialog: Dialog with carrier info, tracking number (clickable link), timeline"
    - "TrackingTimeline: Vertical timeline with checkmarks (✓), spinners (⏳), empty circles (☐)"
  states:
    - "loading: Spinner on action buttons during API call"
    - "disabled: Buttons disabled based on status workflow"
    - "error: Toast error message if action fails"
    - "success: Toast success message on action completion"
    - "confirmation: ShipConfirmDialog displayed before ship action"
  action_buttons_visibility:
    manifest:
      visible_when: "status = 'packed'"
      enabled_when: "all boxes have SSCC"
    ship:
      visible_when: "status IN ('manifested', 'packed')"
      enabled_when: "status = 'manifested' OR (status = 'packed' AND all SSCC present)"
      confirmation_required: true
    mark_delivered:
      visible_when: "status = 'shipped' AND user role IN ('Manager', 'Admin')"
      enabled_when: true
    view_tracking:
      visible_when: "status IN ('shipped', 'delivered')"
      enabled_when: true

validation_rules:
  manifest:
    - "shipment.status must be 'packed'"
    - "all shipment_boxes must have non-null sscc"
    - "if validation fails: return 400 with count of missing SSCC"
  ship:
    - "confirm must be true (Zod validation)"
    - "shipment.status must be 'manifested' or 'packed'"
    - "transaction: all updates must succeed or rollback"
  mark_delivered:
    - "user role must be Manager or Admin"
    - "shipment.status must be 'shipped'"
  tracking:
    - "shipment_id must be valid UUID"
    - "shipment must exist and belong to user's org (RLS)"

patterns:
  rls: "ADR-013 - All tables have org_id filter"
  api: "REST with org_id filter from auth context"
  service: "Extend existing ShipmentService class (static methods)"
  validation: "Zod schemas for all inputs"
  transaction: "ship_shipment() RPC wraps all updates in transaction"
  permission: "Role-based access control (Manager+ for mark delivered)"
  confirmation: "Ship action requires confirmation dialog"
  status_workflow: "State machine: packed → manifested → shipped → delivered"

business_rules:
  - "Status workflow: packed → manifested → shipped → delivered (no skipping, no reverting)"
  - "Manifest validation: All boxes must have SSCC before manifesting"
  - "Ship confirmation: Requires explicit confirmation (irreversible action)"
  - "LP consumption: All LPs in shipment_box_contents → status='shipped'"
  - "SO cascade: sales_orders.status='shipped', shipped_at=now()"
  - "SO lines cascade: sales_order_lines.quantity_shipped = quantity_packed"
  - "Transaction atomicity: All ship updates succeed or rollback"
  - "Permission: Ship (Warehouse+), Mark Delivered (Manager+)"
  - "Tracking URL: Generate carrier-specific URLs (DHL, UPS, DPD, FedEx)"
  - "Carrier API placeholder: Comment in manifest endpoint for Phase 2 integration"
  - "Partial shipments: quantity_shipped = quantity_packed (not quantity_ordered)"
  - "Audit trail: Status changes logged (timestamp, user_id)"

acceptance_checklist:
  - "Manifest endpoint validates all boxes have SSCC"
  - "Manifest endpoint updates status to 'manifested'"
  - "Manifest validation fails if boxes missing SSCC (400 error)"
  - "Ship endpoint validates manifested or packed status"
  - "Ship endpoint requires confirmation (confirm=true)"
  - "Ship confirmation dialog displays with warning"
  - "Ship action updates shipment status to 'shipped', shipped_at=now()"
  - "Ship action updates all LPs to status='shipped' (via RPC)"
  - "Ship action updates SO status to 'shipped', shipped_at=now()"
  - "Ship action updates SO lines quantity_shipped = quantity_packed"
  - "Ship action wrapped in transaction (rollback on error)"
  - "Mark delivered endpoint restricted to Manager+ roles"
  - "Mark delivered updates shipment and SO to 'delivered'"
  - "Mark delivered sets delivered_at timestamp"
  - "Tracking endpoint returns carrier, tracking_number, timeline"
  - "Tracking timeline displays packed, manifested, shipped, delivered dates"
  - "Tracking external URL generated for DHL/UPS/DPD/FedEx"
  - "ShipmentActions buttons disabled based on status workflow"
  - "ShipmentActions hides Mark Delivered for non-managers"
  - "ShipConfirmDialog displays on ship button click"
  - "TrackingDialog displays timeline and external link"
  - "TrackingTimeline shows status badges and dates"
  - "RLS policies enforce org isolation"
  - "Unit tests pass (>80% coverage)"
  - "E2E test: Full workflow (pack → manifest → ship → deliver)"
  - "Permission test: Non-manager cannot mark delivered"
  - "Status workflow validation tests pass"

output_artifacts:
  - "Database migration: ship_shipment() RPC, indexes"
  - "4 API endpoints (manifest, ship, mark-delivered, tracking)"
  - "ShipmentService extensions: 4 new methods"
  - "4 Zod validation schemas"
  - "4 React components (ShipmentActions, ShipConfirmDialog, TrackingDialog, TrackingTimeline)"
  - "Updated shipment detail page with action buttons"
  - "Unit tests (>80% coverage)"
  - "E2E tests (8 scenarios)"

notes:
  - "Story 07.13 (SSCC generation) must be complete before this story (boxes.sscc required)"
  - "Story 07.11 (Packing) provides shipments/boxes tables (extend ShipmentService)"
  - "ship_shipment() RPC ensures transactional integrity (all updates succeed or rollback)"
  - "Carrier API integration is Phase 2 (Story 07.25), manual tracking_number entry for MVP"
  - "Mark delivered is manual for MVP, Phase 2 adds carrier webhook auto-update"
  - "Partial shipment handling: quantity_shipped = quantity_packed (supports backorders)"
  - "Confirmation dialog prevents accidental ship clicks (irreversible action)"
  - "Tracking URLs use public carrier tracking pages (no API key required)"
  - "Status workflow enforced in backend validation (cannot skip or revert states)"
  - "Permission checks in both frontend (UI visibility) and backend (API authorization)"
