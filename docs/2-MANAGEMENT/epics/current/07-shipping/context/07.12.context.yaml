story:
  id: "07.12"
  name: "Packing Scanner UI (Mobile)"
  epic: "07-shipping"
  phase: "1C"
  complexity: "M"
  estimate_days: 3-4
  type: "backend + frontend (mobile)"
  model: "SONNET"

dependencies:
  required:
    - story: "07.11"
      provides: ["shipments table", "shipment_boxes table", "shipment_box_contents table", "ShipmentService"]
    - story: "07.8"
      provides: ["pick_lists table", "picked LPs available"]
    - story: "07.2"
      provides: ["sales_orders table", "SO context"]
    - story: "02.3"
      provides: ["allergens table", "customer allergen restrictions"]
    - story: "05.1"
      provides: ["license_plates table", "LP lookup"]
  optional:
    - story: "07.10"
      provides: ["scanner UI patterns", "audio feedback", "number pad"]
    - story: "05.19"
      provides: ["scanner receive patterns", "camera scanner"]

files_to_read:
  prd: "docs/1-BASELINE/product/modules/shipping.md"
  prd_sections: ["Section 5.2 Pack Confirmation (Scanner), lines 618-645"]
  architecture: "docs/1-BASELINE/architecture/modules/shipping.md"
  architecture_sections: ["lines 507-517 (Scanner Endpoints)", "lines 630-641 (Scanner Components)"]
  story: "docs/2-MANAGEMENT/epics/current/07-shipping/07.12.packing-scanner.md"
  patterns:
    - "docs/2-MANAGEMENT/epics/current/05-warehouse/05.19.scanner-receive.md"
    - "docs/2-MANAGEMENT/epics/current/07-shipping/07.11.packing-station-workflow.md"

files_to_create:
  database: []  # Uses existing tables

  api:
    - path: "apps/frontend/app/api/shipping/scanner/pack/route.ts"
      methods: ["POST"]
      description: "Add item to box"
    - path: "apps/frontend/app/api/shipping/scanner/pack/box/create/route.ts"
      methods: ["POST"]
      description: "Create new box"
    - path: "apps/frontend/app/api/shipping/scanner/pack/box/close/route.ts"
      methods: ["POST"]
      description: "Close box with weight"
    - path: "apps/frontend/app/api/shipping/scanner/pack/shipments/route.ts"
      methods: ["GET"]
      description: "List pending shipments"
    - path: "apps/frontend/app/api/shipping/scanner/pack/lookup/[barcode]/route.ts"
      methods: ["GET"]
      description: "Lookup SO or LP by barcode"
    - path: "apps/frontend/app/api/shipping/scanner/pack/box/[boxId]/route.ts"
      methods: ["GET", "DELETE"]
      description: "Get box details, remove item"

  services:
    - path: "apps/frontend/lib/services/packing-scanner-service.ts"
      exports: ["PackingScannerService"]
      description: "Scanner packing operations"

  validation:
    - path: "apps/frontend/lib/validation/packing-scanner.ts"
      schemas: ["packItemSchema", "createBoxSchema", "closeBoxSchema", "pendingShipmentsQuerySchema", "lookupBarcodeSchema"]

  pages:
    - path: "apps/frontend/app/(authenticated)/scanner/shipping/pack/page.tsx"
      description: "Scanner pack main page"

  components:
    - path: "apps/frontend/components/scanner/shipping/pack/PackingScannerWizard.tsx"
      description: "Step wizard container"
    - path: "apps/frontend/components/scanner/shipping/pack/Step1SelectShipment.tsx"
      description: "Select shipment step"
    - path: "apps/frontend/components/scanner/shipping/pack/Step2BoxManagement.tsx"
      description: "Box management step"
    - path: "apps/frontend/components/scanner/shipping/pack/Step3ScanItem.tsx"
      description: "Scan LP step"
    - path: "apps/frontend/components/scanner/shipping/pack/Step4QuantityEntry.tsx"
      description: "Quantity confirmation step"
    - path: "apps/frontend/components/scanner/shipping/pack/Step5BoxClose.tsx"
      description: "Close box step"
    - path: "apps/frontend/components/scanner/shipping/pack/Step6Complete.tsx"
      description: "Complete shipment step"
    - path: "apps/frontend/components/scanner/shipping/pack/PendingShipmentsList.tsx"
      description: "Packable shipments list"
    - path: "apps/frontend/components/scanner/shipping/pack/BoxSelector.tsx"
      description: "Box dropdown/switcher"
    - path: "apps/frontend/components/scanner/shipping/pack/BoxContentsSummary.tsx"
      description: "Current box items summary"
    - path: "apps/frontend/components/scanner/shipping/pack/LPDetailsCard.tsx"
      description: "LP product details"
    - path: "apps/frontend/components/scanner/shipping/pack/AllergenWarningBanner.tsx"
      description: "Allergen alert banner"
    - path: "apps/frontend/components/scanner/shipping/pack/WeightEntryModal.tsx"
      description: "Weight capture modal"
    # Reuse shared scanner components from 05.19/07.10:
    - path: "apps/frontend/components/scanner/shared/BarcodeScanner.tsx"
      reuse: true
    - path: "apps/frontend/components/scanner/shared/NumberPad.tsx"
      reuse: true
    - path: "apps/frontend/components/scanner/shared/AudioFeedback.tsx"
      reuse: true
    - path: "apps/frontend/components/scanner/shared/SuccessAnimation.tsx"
      reuse: true
    - path: "apps/frontend/components/scanner/shared/ErrorAnimation.tsx"
      reuse: true
    - path: "apps/frontend/components/scanner/shared/ScannerHeader.tsx"
      reuse: true
    - path: "apps/frontend/components/scanner/shared/LargeTouchButton.tsx"
      reuse: true

database:
  tables:
    - name: "shipments"
      columns: ["id", "shipment_number", "sales_order_id", "customer_id", "status", "packed_at", "packed_by"]
      rls: true
      access: "read/update"
      story_source: "07.11"
    - name: "shipment_boxes"
      columns: ["id", "shipment_id", "box_number", "sscc", "weight", "length", "width", "height", "status"]
      rls: true
      access: "create/read/update"
      story_source: "07.11"
    - name: "shipment_box_contents"
      columns: ["id", "shipment_box_id", "sales_order_line_id", "product_id", "license_plate_id", "lot_number", "quantity"]
      rls: true
      access: "create/read/delete"
      story_source: "07.11"
    - name: "sales_orders"
      columns: ["id", "order_number", "customer_id", "status"]
      rls: true
      access: "read"
      story_source: "07.2"
    - name: "sales_order_lines"
      columns: ["id", "sales_order_id", "product_id", "quantity_packed"]
      rls: true
      access: "read/update"
      story_source: "07.2"
    - name: "license_plates"
      columns: ["id", "lp_number", "product_id", "lot_number", "on_hand_quantity", "allocated_quantity"]
      rls: true
      access: "read"
      story_source: "05.1"
    - name: "customers"
      columns: ["id", "name", "allergen_restrictions"]
      rls: true
      access: "read"
      story_source: "07.1"
    - name: "products"
      columns: ["id", "name", "allergens"]
      rls: true
      access: "read"
      story_source: "02.1"

api_endpoints:
  - method: "POST"
    path: "/api/shipping/scanner/pack"
    auth: true
    roles: ["warehouse", "picker", "packer", "manager", "admin"]
    description: "Add item to box"
    request_schema: "packItemSchema"
    response: "PackItemResponse"

  - method: "POST"
    path: "/api/shipping/scanner/pack/box/create"
    auth: true
    roles: ["warehouse", "picker", "packer", "manager", "admin"]
    description: "Create new box"
    request_schema: "createBoxSchema"
    response: "ShipmentBox"

  - method: "POST"
    path: "/api/shipping/scanner/pack/box/close"
    auth: true
    roles: ["warehouse", "picker", "packer", "manager", "admin"]
    description: "Close box with weight"
    request_schema: "closeBoxSchema"
    response: "ShipmentBox"

  - method: "GET"
    path: "/api/shipping/scanner/pack/shipments"
    auth: true
    roles: ["warehouse", "picker", "packer", "manager", "admin"]
    description: "List pending shipments"
    query_schema: "pendingShipmentsQuerySchema"
    response: "PendingShipmentSummary[]"

  - method: "GET"
    path: "/api/shipping/scanner/pack/lookup/:barcode"
    auth: true
    roles: ["warehouse", "picker", "packer", "manager", "admin"]
    description: "Lookup SO or LP"
    response: "Shipment | LicensePlate"

  - method: "GET"
    path: "/api/shipping/scanner/pack/box/:boxId"
    auth: true
    roles: ["warehouse", "picker", "packer", "manager", "admin"]
    description: "Get box details"
    response: "BoxDetailsResponse"

  - method: "DELETE"
    path: "/api/shipping/scanner/pack/box/:boxId/item/:id"
    auth: true
    roles: ["warehouse", "picker", "packer", "manager", "admin"]
    description: "Remove item from box"
    response: "success"

ux:
  wireframes: []  # Scanner UI - mobile-first design

  patterns:
    layout: "Full-screen mobile scanner layout (reuse from 05.19)"
    navigation: "6-step wizard with progress indicator"
    scanning: "Camera barcode scanner with guide overlay"
    input: "Number pad for quantity/weight (48dp+ keys)"
    feedback: "Audio/visual feedback system"
    lists: "Touch-optimized lists (56dp rows)"
    buttons: "Large touch targets (48dp minimum)"
    modals: "Full-screen or bottom-sheet modals"

  states:
    - "loading: Pending shipments loading"
    - "scanning: Camera active for barcode"
    - "entering: Number pad visible for input"
    - "warning: Allergen alert banner"
    - "success: Item added confirmation"
    - "error: Invalid scan or validation"
    - "complete: Shipment packed"

  components:
    - "PendingShipmentsList: List of packable orders"
    - "BoxSelector: Dropdown to switch between open boxes"
    - "BoxContentsSummary: Real-time item count and weight"
    - "LPDetailsCard: Product info from scanned LP"
    - "AllergenWarningBanner: Yellow alert banner (persistent)"
    - "WeightEntryModal: Number pad for weight capture"
    - "NumberPad: Reusable number pad (48dp keys)"
    - "BarcodeScanner: Camera scanner (reuse)"
    - "SuccessAnimation: Green checkmark (reuse)"
    - "ErrorAnimation: Red X (reuse)"

audio_feedback:
  success_tone:
    frequency: "880Hz"
    duration: "200ms"
    trigger: "Valid barcode scan"

  error_beep:
    frequency: "220Hz"
    duration: "300ms"
    trigger: "Invalid barcode scan"

  confirmation_chime:
    frequency: "660Hz + 880Hz"
    duration: "500ms"
    trigger: "Box closed successfully"

  allergen_alert:
    frequency: "440Hz"
    duration: "400ms"
    pattern: "Repeating 2x"
    trigger: "Allergen product scanned"

  haptic:
    success: "Short buzz (50ms)"
    error: "Double buzz (50ms + 50ms)"
    confirm: "Long buzz (100ms)"
    alert: "Triple buzz (allergen)"

validation_rules:
  shipment_id: "UUID, must exist and be packable (status in ['pending', 'packing'])"
  box_id: "UUID, must exist and be open"
  license_plate_id: "UUID, must be allocated to this shipment"
  quantity: "Positive number, cannot exceed LP available quantity"
  weight: "Optional, positive number, max 1000 kg"
  dimensions: "Optional, positive numbers, max 500 cm each"
  so_line_id: "UUID, must match allocated LP"
  allergen_check: "If customer has restrictions, check product allergens and warn"
  empty_box: "Cannot close box with no items"

business_rules:
  - "LP must be allocated to shipment before packing"
  - "Quantity cannot exceed LP available quantity"
  - "Box auto-created on shipment selection"
  - "Multiple boxes can be open simultaneously"
  - "Cannot close empty box"
  - "Weight capture optional on box close"
  - "Allergen warnings persistent and require acknowledgment"
  - "Scanner authenticated users only"
  - "Warehouse context enforced (user's assigned warehouse)"
  - "Shipments must have status 'pending' or 'packing'"
  - "Response times < 500ms for all operations"

patterns:
  rls: "ADR-013 (org_id filter on all queries)"
  api: "REST with org_id and warehouse_id filter"
  service: "class-based with static methods"
  validation: "zod schemas with detailed error messages"
  mobile_ui: "Touch-first, 48dp minimum, high contrast"
  audio: "Web Audio API with OscillatorNode"
  camera: "getUserMedia API for barcode scanning"
  error_handling: "Retry logic with network error recovery"

acceptance_checklist:
  - "Scanner pack page renders mobile-optimized layout"
  - "All touch targets >= 48dp"
  - "Pending shipments list displays and filters correctly"
  - "Shipment selection by scan or manual works"
  - "Box auto-created on shipment selection"
  - "Box selector switches between open boxes"
  - "LP scan validates allocation and availability"
  - "Product details auto-fill from LP"
  - "Quantity entry with number pad (quick adjust buttons)"
  - "Item added to box with success feedback"
  - "Box contents summary updates in real-time"
  - "Allergen warning banner displays for restricted products"
  - "Allergen alert tone plays on allergen product scan"
  - "Close box with optional weight capture"
  - "Weight validation and carrier limit warnings"
  - "Complete shipment updates status to 'packed'"
  - "Audio feedback for all actions (success, error, confirm, alert)"
  - "Visual feedback (animations, banners, badges)"
  - "High contrast colors for warehouse lighting"
  - "Error handling with retry logic"
  - "Network error recovery"
  - "RLS enforced (org and warehouse isolation)"
  - "Response times < 500ms"
  - "Unit tests >80% coverage on service"
  - "Integration tests for all API endpoints"
  - "E2E test for full pack workflow"
  - "Touch target tests pass"
  - "Audio feedback tests pass"
  - "Allergen warning tests pass"

output_artifacts:
  - "Scanner pack API endpoints (7 routes)"
  - "PackingScannerService with 9 methods"
  - "5 Zod validation schemas"
  - "Scanner pack page component"
  - "6-step wizard component"
  - "13 UI components (8 new, 5 reused)"
  - "Allergen warning banner component"
  - "Box selector component"
  - "Weight entry modal"
  - "Unit tests (>80% coverage)"
  - "Integration tests (all endpoints)"
  - "E2E tests (full workflow)"
  - "Touch target compliance tests"
  - "Audio feedback tests"
  - "Allergen logic tests"

test_coverage:
  unit:
    - "PackingScannerService.addItemToBox()"
    - "PackingScannerService.createBox()"
    - "PackingScannerService.closeBox()"
    - "PackingScannerService.getPendingShipments()"
    - "PackingScannerService.lookupShipment()"
    - "PackingScannerService.lookupLP()"
    - "PackingScannerService.getBoxDetails()"
    - "PackingScannerService.checkAllergenConflict()"
    - "Validation schemas (all 5)"

  integration:
    - "POST /api/shipping/scanner/pack"
    - "POST /api/shipping/scanner/pack/box/create"
    - "POST /api/shipping/scanner/pack/box/close"
    - "GET /api/shipping/scanner/pack/shipments"
    - "GET /api/shipping/scanner/pack/lookup/:barcode"
    - "GET /api/shipping/scanner/pack/box/:boxId"
    - "DELETE /api/shipping/scanner/pack/box/:boxId/item/:id"
    - "RLS enforcement tests"
    - "Performance tests (< 500ms)"

  e2e:
    - "Full pack workflow (select → scan → add → close → complete)"
    - "Multi-box workflow"
    - "Allergen warning display and audio"
    - "Box switcher functionality"
    - "Weight entry modal"
    - "Error recovery (network error)"
    - "Touch target compliance"

performance_targets:
  page_load: "< 1 second"
  api_response: "< 500ms"
  barcode_scan: "< 500ms total (scan + lookup)"
  number_pad: "< 100ms input update"
  audio_feedback: "< 50ms trigger delay"
  animation: "60fps smooth animations"

future_enhancements:
  phase_2:
    - "Weight scale integration (auto-fill)"
    - "Offline queue support with sync"
    - "SSCC label printing trigger from scanner"

  phase_3:
    - "GS1 barcode parsing (AI codes)"
    - "Box optimization suggestions"
    - "Packing performance metrics"
    - "Multi-product allergen separation logic"

notes:
  - "Reuses scanner patterns from Story 05.19 (Scanner Receive)"
  - "Reuses audio/visual feedback from Story 07.10 (Pick Scanner)"
  - "Mobile-first design with 48dp touch targets"
  - "High contrast colors for warehouse lighting"
  - "Allergen warnings prominent and persistent"
  - "Multi-box support with box switcher"
  - "Weight capture optional (Phase 1)"
  - "SSCC label printing deferred to Story 07.13"
  - "All operations < 500ms for snappy UX"
