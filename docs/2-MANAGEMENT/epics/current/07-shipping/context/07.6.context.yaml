story:
  id: "07.6"
  name: "SO Allergen Validation + Customer Order History"
  epic: "07-shipping"
  phase: "1A"
  complexity: "M"
  estimate_days: 2-3
  priority: "P0"
  type: "backend + frontend"

dependencies:
  required:
    - story: "01.1"
      provides: ["organizations", "users", "roles", "RLS"]
    - story: "01.6"
      provides: ["role-based permissions", "Manager role"]
    - story: "02.1"
      provides: ["products table"]
    - story: "02.3"
      provides: ["allergens table", "product_allergens junction"]
    - story: "07.1"
      provides: ["customers table", "allergen_restrictions JSONB"]
    - story: "07.2"
      provides: ["sales_orders table", "sales_order_lines table"]

files_to_read:
  prd: "docs/1-BASELINE/product/modules/shipping.md"
  prd_sections: ["FR-7.32", "FR-7.33", "FR-7.34", "FR-7.35", "FR-7.36"]
  architecture: "docs/1-BASELINE/architecture/modules/shipping.md"
  architecture_sections: ["Allergen Validation", "Customer order history API"]
  story: "docs/2-MANAGEMENT/epics/current/07-shipping/07.6.so-allergen-validation.md"
  related_stories:
    - "docs/2-MANAGEMENT/epics/current/02-technical/02.3.product-allergens.md"
    - "docs/2-MANAGEMENT/epics/current/07-shipping/07.1.customers-crud.md"
    - "docs/2-MANAGEMENT/epics/current/07-shipping/07.2.sales-orders-core.md"
  patterns:
    - "apps/frontend/lib/services/allergen-service.ts" # If exists from 02.3

files_to_create:
  database:
    - path: "supabase/migrations/XXX_add_allergen_validation_to_sales_orders.sql"
      type: "migration"
      content: "Add allergen validation columns to sales_orders"
    - path: "supabase/migrations/XXX_create_audit_logs_table.sql"
      type: "migration"
      content: "Create audit_logs table for override tracking"

  api:
    - path: "apps/frontend/app/api/shipping/sales-orders/[id]/validate-allergens/route.ts"
      methods: ["POST"]
      auth: true
      roles: ["any authenticated"]
    - path: "apps/frontend/app/api/shipping/sales-orders/[id]/override-allergen/route.ts"
      methods: ["POST"]
      auth: true
      roles: ["Manager", "Admin"]
    - path: "apps/frontend/app/api/shipping/customers/[id]/orders/route.ts"
      methods: ["GET"]
      auth: true
      roles: ["any authenticated"]

  services:
    - path: "apps/frontend/lib/services/allergen-validation-service.ts"
      functions:
        - "validateSalesOrderAllergens(salesOrderId, userId)"
        - "overrideAllergenBlock(salesOrderId, userId, reason)"
        - "updateValidationStatus(salesOrderId, isValid, userId, conflicts)"
    - path: "apps/frontend/lib/services/customer-order-service.ts"
      functions:
        - "getCustomerOrders(customerId, page, limit)"

  validation:
    - path: "apps/frontend/lib/validation/allergen-override-schema.ts"
      schemas: ["overrideAllergenSchema"]

  components:
    - path: "apps/frontend/components/shipping/AllergenAlert.tsx"
      description: "Red/orange banner displaying allergen conflicts with override button"
    - path: "apps/frontend/components/shipping/AllergenOverrideModal.tsx"
      description: "Modal for Manager+ to enter override reason"
    - path: "apps/frontend/components/shipping/CustomerOrderHistory.tsx"
      description: "Table displaying customer order history with pagination"
    - path: "apps/frontend/app/(authenticated)/shipping/sales-orders/[id]/page.tsx"
      description: "Update SO detail page to display AllergenAlert"
    - path: "apps/frontend/app/(authenticated)/shipping/customers/[id]/page.tsx"
      description: "Update customer detail to add Order History tab"

database:
  tables:
    - name: "sales_orders"
      columns:
        - "allergen_validated BOOLEAN DEFAULT false"
        - "allow_allergen_override BOOLEAN DEFAULT false"
        - "allergen_validation_date TIMESTAMPTZ"
        - "allergen_validation_user UUID REFERENCES users(id)"
        - "allergen_override_date TIMESTAMPTZ"
        - "allergen_override_user UUID REFERENCES users(id)"
        - "allergen_override_reason TEXT"
      rls: true
      indexes:
        - "idx_sales_orders_allergen_validated ON (org_id, allergen_validated, status)"

    - name: "audit_logs"
      columns:
        - "id UUID PRIMARY KEY"
        - "org_id UUID NOT NULL REFERENCES organizations(id)"
        - "entity_type TEXT NOT NULL"
        - "entity_id UUID NOT NULL"
        - "action TEXT NOT NULL"
        - "old_value JSONB"
        - "new_value JSONB"
        - "user_id UUID REFERENCES users(id)"
        - "reason TEXT"
        - "created_at TIMESTAMPTZ DEFAULT now()"
      rls: true
      indexes:
        - "idx_audit_logs_entity ON (entity_type, entity_id)"
        - "idx_audit_logs_org ON (org_id, created_at DESC)"

api_endpoints:
  - method: "POST"
    path: "/api/shipping/sales-orders/:id/validate-allergens"
    auth: true
    roles: ["any authenticated"]
    description: "Validate SO lines against customer allergen restrictions"
    request_body: "none"
    response:
      valid: "boolean"
      conflicts: "AllergenConflict[]"
      customer_restrictions: "string[]"
      validated_at: "string"
      validated_by: "string"

  - method: "POST"
    path: "/api/shipping/sales-orders/:id/override-allergen"
    auth: true
    roles: ["Manager", "Admin"]
    description: "Override allergen block with reason and audit trail"
    request_body:
      reason: "string (min 20 chars, max 500)"
      confirmed: "boolean (must be true)"
    response:
      success: "boolean"
      allergen_validated: "boolean"
      allow_allergen_override: "boolean"
      overridden_by: "string"
      overridden_at: "string"
      audit_log_id: "string"

  - method: "GET"
    path: "/api/shipping/customers/:id/orders"
    auth: true
    roles: ["any authenticated"]
    description: "Get paginated order history for customer"
    query_params:
      page: "number (default 1)"
      limit: "number (default 20, max 100)"
      status: "string (optional filter)"
    response:
      orders: "CustomerOrder[]"
      pagination: "PaginationMetadata"

validation_rules:
  allergen_validation:
    - "Only 'contains' allergens trigger conflicts (not 'may_contain')"
    - "Validation runs on SO confirm, line add/edit, and manual trigger"
    - "Customer with no allergen_restrictions passes validation automatically"
    - "Validation resets to false on any line change"

  allergen_override:
    - "Manager or Admin role required"
    - "Reason text required (min 20 chars, max 500)"
    - "Confirmed checkbox must be true"
    - "Creates audit_logs entry with user_id, timestamp, reason"
    - "Sets allergen_validated = true, allow_allergen_override = true"

  customer_orders:
    - "Paginated (default 20 per page, max 100)"
    - "Sorted by order_date DESC (newest first)"
    - "RLS enforces org_id isolation"

patterns:
  rls: "ADR-013"
  api: "REST with org_id filter"
  service: "class-based with async functions"
  validation: "Zod schemas"
  component: "ShadCN UI patterns (Alert, DataTable, Dialog)"

business_rules:
  - "Allergen conflicts block SO confirmation unless overridden by Manager+"
  - "Only 'contains' allergens (not 'may_contain') trigger blocking conflicts"
  - "Override approval requires reason text and creates audit trail"
  - "Validation runs automatically on SO confirm and line changes"
  - "Customer order history is read-only reference data"
  - "Validation performance target: <1 second for 50-line orders"

acceptance_checklist:
  - "POST /api/shipping/sales-orders/:id/validate-allergens endpoint works"
  - "POST /api/shipping/sales-orders/:id/override-allergen endpoint works (Manager+ only)"
  - "GET /api/shipping/customers/:id/orders endpoint returns paginated orders"
  - "AllergenAlert displays red banner with conflict list"
  - "Manager override modal captures reason and creates audit log"
  - "Override success changes alert to orange with reason displayed"
  - "Non-Manager users cannot override allergen blocks"
  - "SO confirmation blocked when allergen_validated = false"
  - "Customer order history tab displays in Customer Detail page"
  - "Order history links to SO detail page"
  - "Validation completes within 1 second for 50-line orders"
  - "RLS policies enforce multi-tenant isolation"
  - "Unit tests cover validation logic (>90%)"
  - "Integration tests cover all API endpoints"
  - "E2E test covers allergen conflict detection and Manager override"

output_artifacts:
  migrations:
    - "XXX_add_allergen_validation_to_sales_orders.sql"
    - "XXX_create_audit_logs_table.sql"
  api_routes:
    - "/api/shipping/sales-orders/[id]/validate-allergens/route.ts"
    - "/api/shipping/sales-orders/[id]/override-allergen/route.ts"
    - "/api/shipping/customers/[id]/orders/route.ts"
  services:
    - "lib/services/allergen-validation-service.ts"
    - "lib/services/customer-order-service.ts"
  validation:
    - "lib/validation/allergen-override-schema.ts"
  components:
    - "components/shipping/AllergenAlert.tsx"
    - "components/shipping/AllergenOverrideModal.tsx"
    - "components/shipping/CustomerOrderHistory.tsx"
  tests:
    - "lib/services/__tests__/allergen-validation-service.test.ts"
    - "app/api/shipping/sales-orders/[id]/validate-allergens/__tests__/route.test.ts"
    - "app/api/shipping/sales-orders/[id]/override-allergen/__tests__/route.test.ts"
    - "e2e/shipping/allergen-validation-override.spec.ts"

food_safety_critical: true
audit_trail_required: true
manager_approval_required: true
