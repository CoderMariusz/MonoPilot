# Story 07.13 Context Files - SSCC/BOL Labels

## Overview

Story 07.13 implements GS1-compliant SSCC barcode generation, Bill of Lading (BOL) PDF generation, shipping label printing (Zebra ZPL format), and packing slip generation for food manufacturing traceability and carrier handoff.

**Story ID**: 07.13
**Epic**: 07-Shipping
**Phase**: 1C (After Story 07.11 - Packing)
**Complexity**: M (3-4 days)
**Priority**: P0 (MVP Core - Compliance)

---

## Context Files in This Directory

### 1. **07.13.sscc-bol-labels.context.yaml** (Primary)

Main YAML context file containing:
- Story metadata (ID, name, epic, phase, complexity, estimate)
- Dependencies (required and provides_to)
- Files to read (PRD, architecture, wireframes, patterns)
- Files to create (database, API, services, validation, pages, components)
- Database tables specification
- API endpoints overview
- UX wireframes mapping (SHIP-019, SHIP-021)
- Validation rules
- Acceptance checklist (24 items)
- Output artifacts
- Estimated effort: 16-20 hours
- Quality target: 95%+

**Use Case**: Primary source for AI agents implementing Story 07.13. Contains complete story context in single file.

---

### 2. **07.13-wireframes.yaml** (UX Reference)

Detailed wireframe mapping for 2 wireframes:

#### SHIP-019: SSCC Label Generation & Printing
- Single label preview with barcode, ship-to address, order info
- Batch label queue (table with 8+ labels, status, errors)
- Print settings: printer selection, format (4x6/4x8), orientation, copies, mode
- Error scenarios: GS1 prefix not configured, invalid dimensions, printer offline
- Responsive design (desktop/tablet/mobile)
- Data sources and business logic

#### SHIP-021: Bill of Lading PDF Generation & Printing
- BOL success state: PDF preview (8.5x11) with Print/Email/Download buttons
- Email modal: carrier contact dropdown, CC, subject, message
- Error states: no carrier assigned, PDF timeout, incomplete shipment
- Loading and empty states
- Data sources (shipments, boxes, customers, products, carriers)
- Email template with carrier contact suggestions
- Responsive design across breakpoints

**Use Case**: FRONTEND-DEV needs detailed screen layouts, states, form fields, validation. Referenced by Story 07.13 wireframes.

---

### 3. **07.13-api-endpoints.yaml** (API Contract)

Comprehensive API specification for 5 endpoints:

#### POST /api/shipping/shipments/:id/generate-sscc
- Generates SSCC-18 for all boxes (idempotent)
- Request/response schemas with examples
- Error codes: GS1_PREFIX_NOT_CONFIGURED, MISSING_BOX_DATA, SHIPMENT_NOT_PACKED
- Validation rules and business logic
- Curl example

#### POST /api/shipping/shipments/:id/generate-bol
- Generates BOL PDF with carrier info, carton list, product summary
- Request/response schemas
- Error codes: NO_CARRIER_ASSIGNED, MISSING_SSCC, MISSING_BOX_DATA, PDF_GENERATION_TIMEOUT
- PDF caching strategy (24h Redis TTL)
- Validation checklist (carrier, SSCC, weights, dimensions, address)

#### POST /api/shipping/shipments/:id/print-labels
- Generates ZPL or PDF labels for boxes
- Format options: 4x6" (carton), 4x8" (pallet)
- Output options: zpl (Zebra), pdf (universal)
- Returns ZPL string or PDF URL per box

#### POST /api/shipping/shipments/:id/print-packing-slip
- Generates packing slip PDF with line items, lots, BBD, allergens
- Similar caching and storage as BOL

#### GET /api/shipping/shipments/:id/boxes/:boxId/label-preview
- Returns SSCC label preview with barcode image (base64 PNG)
- Includes all metadata for label display

**Use Case**: BACKEND-DEV implements these endpoints exactly to spec. Includes all error handling, validation, request/response examples.

---

### 4. **07.13-database-schema.yaml** (Data Layer)

Database specifications:

#### Organizations Table Changes
- `gs1_company_prefix` (7-10 digits): GS1 identifier, required for SSCC generation
- `next_sscc_sequence` (BIGINT): Auto-increment counter per organization
- Constraint validation for GS1 prefix format

#### Shipment Boxes Table Changes
- Verify existing SSCC column with UNIQUE constraint (global)
- Existing weight, length, width, height columns with validation
- Add index: idx_shipment_boxes_sscc for barcode lookups

#### Database Functions (PL/pgSQL)
- `generate_sscc_for_org(org_uuid, extension_digit)`: Atomic SSCC generation
  - SELECT FOR UPDATE prevents concurrent duplicates
  - Increments next_sscc_sequence atomically
  - Calculates check digit using MOD 10
  - Returns 18-digit SSCC string
  - Error: GS1 prefix not configured

- `calculate_gs1_check_digit(digits)`: MOD 10 check digit calculation
  - Validates 17-digit base input
  - Multiplies positions by 3 (odd) or 1 (even) from right
  - Returns single check digit (0-9)
  - Immutable function for consistency

#### RLS Policies
- shipment_boxes org_isolation: User can only access org's boxes
- BOL storage path: /bol/{org_id}/{shipment_id}.pdf
- Packing slip storage path: /packing-slip/{org_id}/{shipment_id}.pdf

#### Constraints & Validation
- SSCC globally unique (no duplicates across organizations)
- GS1 prefix format: 7-10 numeric digits
- Box dimensions: weight > 0, length/width/height optional but 10-200 cm if provided

#### Migration Checklist
9-item checklist for database setup

**Use Case**: BACKEND-DEV or ARCHITECT verifies database schema, creates migration SQL, runs tests. Includes complete PL/pgSQL function code and constraint definitions.

---

### 5. **07.13-prd-sections.yaml** (Requirements Traceability)

Maps story implementation to PRD requirements:

#### Shipping Module (docs/1-BASELINE/product/modules/shipping.md)
- **FR-7.38** - SSCC-18 Barcode Generation
  - SSCC format, extension digit, GS1 prefix, serial reference, check digit
  - Global uniqueness, idempotency, error handling

- **FR-7.39** - GS1-128 Barcode Label Generation & Printing
  - Barcode encoding with FNC1, Application Identifier (00)
  - ZPL format for Zebra printers, PDF fallback
  - Label formats (4x6", 4x8"), human-readable text
  - Batch printing, error handling

- **FR-7.40** - Packing Slip PDF Generation
  - 8.5x11 letter format
  - Header, ship-to/from, line items, carton summary
  - Allergen warnings, signature section
  - Storage in Supabase Storage, 24h caching

- **FR-7.41** - Bill of Lading PDF Generation & Printing
  - BOL numbering, shipper/consignee, freight details table
  - SSCC barcodes, weight, dimensions, freight class, NMFC
  - Totals, product summary, multi-page support
  - Email workflow with carrier contact suggestions
  - Error handling (no carrier, missing SSCC, etc.)

#### Architecture Module (docs/1-BASELINE/architecture/modules/shipping.md)
- **SSCC Algorithm** (Lines 189-191): 18-digit structure with check digit
- **GS1-128 Barcode** (Lines 209-219): Encoding, FNC1 start, Application Identifier
- **BOL PDF Structure** (Lines 444-447): Layout, sections, dimensions, multi-page
- **Label Printing System** (Lines 1035-1072): Printer support, ZPL format, batch workflow

#### GS1 Compliance
- SSCC 18 digits with MOD 10 check digit
- FNC1 start character in barcode
- Application Identifier (00) for SSCC
- Global uniqueness enforcement

**Use Case**: FRONTEND-DEV and BACKEND-DEV verify their implementations match PRD requirements. Also used by QA for acceptance testing.

---

## How to Use These Files

### For BACKEND-DEV:
1. Read **07.13.sscc-bol-labels.context.yaml** for complete story context
2. Consult **07.13-database-schema.yaml** for database setup (PL/pgSQL functions, constraints)
3. Use **07.13-api-endpoints.yaml** as API contract for 5 endpoints
4. Reference **07.13-prd-sections.yaml** to map implementation to requirements

### For FRONTEND-DEV:
1. Read **07.13.sscc-bol-labels.context.yaml** for story overview
2. Study **07.13-wireframes.yaml** for detailed screen layouts (SHIP-019, SHIP-021)
3. Use **07.13-api-endpoints.yaml** for endpoint contracts
4. Review **07.13-prd-sections.yaml** for user-facing requirements

### For QA:
1. Read **07.13.sscc-bol-labels.context.yaml** acceptance checklist (24 items)
2. Use **07.13-api-endpoints.yaml** for error testing (error codes, validation)
3. Study **07.13-wireframes.yaml** for UI test scenarios (success, loading, error, empty states)
4. Reference **07.13-prd-sections.yaml** for requirement traceability

### For ARCHITECT/CODE-REVIEWER:
1. Review **07.13-database-schema.yaml** for schema decisions (SSCC uniqueness, atomicity)
2. Check **07.13-api-endpoints.yaml** for API design (5 endpoints, rate limiting if needed)
3. Validate **07.13-wireframes.yaml** for UX consistency with other stories
4. Verify **07.13.sscc-bol-labels.context.yaml** dependencies and outputs

---

## Key Concepts

### SSCC-18 (Serial Shipping Container Code)
- 18-digit GS1 barcode
- Structure: Extension(1) + GS1Prefix(7-10) + Serial(6-9) + Check(1)
- Extension: 0 for carton, 9 for pallet
- GS1 Prefix: Globally unique identifier (assigned by GS1 org)
- Serial: Organization-scoped auto-increment counter
- Check Digit: MOD 10 algorithm per GS1 standard
- Global uniqueness enforced by database UNIQUE constraint

### MOD 10 Check Digit Algorithm
1. Multiply digits by alternating 3 and 1 (from right)
2. Sum products
3. Check = (10 - (sum % 10)) % 10

Example: Base "00614141000012345" → Check "2" → SSCC "006141410000123452"

### GS1-128 Barcode
- FNC1 start character (indicates GS1 format)
- Application Identifier (00) for SSCC
- 18-digit SSCC data
- Rendered as PNG with bwip-js library
- Printed with ZPL (Zebra) or PDF (universal)

### BOL (Bill of Lading)
- 8.5x11 letter PDF document
- Shipper and consignee information
- Freight details table (SSCC, weight, dimensions, freight class, NMFC)
- Product summary by carton
- Signature section (shipper and carrier)
- BOL numbering: BOL-YYYY-XXXXXX per organization
- Email workflow with carrier contact suggestions

### Label Printing
- **ZPL (Zebra Programming Language)**: Native format for Zebra printers
- **PDF**: Universal printer support via browser
- **Label Formats**: 4x6" (standard carton), 4x8" (pallet)
- **Batch Printing**: Queue multiple labels, print all with status tracking

---

## Dependencies

### Required:
- **Story 07.11 - Packing**: Provides shipment_boxes, shipment_box_contents tables
- **Epic 01 - Settings**: Provides organizations table for GS1 Company Prefix config
- **Epic 01 - Warehouses**: Provides locations for shipper address (BOL)
- **Epic 02.3 - Allergens**: Provides allergen data for packing slip warnings
- **Story 07.2 - Customer Addresses**: Provides shipping address (BOL consignee)

### Provides To:
- **Story 07.14 - Shipment Confirm**: Uses SSCC-labeled shipments with BOL
- **Story 07.15 - Shipping Dashboard**: Displays SSCC generation and print metrics
- **Epic 11 - Integrations**: EDI ASN 856 requires SSCC and BOL data

---

## Acceptance Criteria (24 items)

1. organizations table has gs1_company_prefix (7-10 digits) and next_sscc_sequence
2. shipment_boxes.sscc column has UNIQUE constraint (global)
3. generate_sscc_for_org() function generates valid SSCC-18 with MOD 10 check digit
4. calculate_gs1_check_digit() function correctly implements MOD 10 algorithm
5. validateSSCC() returns true for valid, false for invalid check digit
6. formatSSCC() formats 18-digit SSCC as '00 1234 5678 9012 3456 78'
7. POST /api/shipping/shipments/:id/generate-sscc is idempotent (skips existing)
8. SSCC uniqueness enforced globally (across all orgs) via UNIQUE constraint
9. GS1-128 barcode renders correctly with bwip-js (FNC1 start, AI 00)
10. ZPL label format produces valid Zebra output (4x6 and 4x8 options)
11. BOL PDF generates with all required sections (header, freight table, totals, signatures)
12. Packing slip PDF includes line items, lots, BBD, allergen warnings
13. PDFs stored in Supabase Storage with org_id path prefix
14. SSCCLabelPreview displays barcode image, formatted SSCC, metadata, format selector
15. BOLPreview renders PDF with PDF.js, zoom controls, Print/Email/Download buttons
16. LabelActions component provides 4 buttons (Generate SSCC, Print Labels, BOL, Packing Slip)
17. RLS policies enforce org_id isolation for document storage and access
18. Email validation requires valid RFC 5322 format, at least 1 recipient
19. BOL email includes carrier contact suggestion or fallback to carrier_configs.contact_email
20. Label generation blocks if GS1 Company Prefix not configured (shows error with settings link)
21. BOL generation blocks if carrier not assigned, all boxes lack SSCC, or weights missing
22. Multi-tenant isolation verified (Org A cannot access Org B's PDFs/documents)
23. Unit tests: >95% coverage for SSCC check digit calculation
24. E2E test: Generate SSCC → Print Labels → Generate BOL → Email BOL workflow

---

## Deliverables

### Database
- Migration: 07.13_add_sscc_support.sql

### Backend
- SSCCService (generate, validate, format)
- LabelService (ZPL generation, barcode rendering)
- DocumentService (BOL, packing slip PDF generation)
- 5 API route handlers
- Validation schemas (Zod)

### Frontend
- 4 UI components (LabelActions, SSCCLabelPreview, BOLPreview, PackingSlipPreview)
- Updated shipment detail page

### Tests
- Unit tests: SSCCService (>95% check digit), LabelService, DocumentService (>90%)
- E2E test: SSCC → Labels → BOL workflow

### Documentation
- This context file set (5 YAML files)

---

## Estimated Effort
**16-20 hours** (SSCC algorithm, 5 endpoints, 3 services, 4 components, label generation, BOL PDF, tests)

## Quality Target
**95%+**

---

## Notes

- **Atomicity**: SSCC generation uses SELECT FOR UPDATE to prevent concurrent duplicates
- **Caching**: BOL/packing slip PDFs cached 24h in Redis, invalidate on shipment update
- **GS1 Compliance**: SSCC-18 format, MOD 10 check digit, GS1-128 barcode with FNC1
- **Multi-tenancy**: All operations scoped to org_id via RLS policies and Storage paths
- **Error Handling**: Comprehensive error codes and messages for all failure scenarios
- **Responsive Design**: All UI screens support desktop (>1024px), tablet (768-1024px), mobile (<768px)
- **Printer Support**: ZPL (Zebra), PDF (universal), Brother QL (native), Email

---

**Created**: 2025-12-18
**Version**: 1.0
**Author**: TECH-WRITER
**Status**: Ready for Implementation
