story:
  id: "07.9"
  name: "Pick Confirmation - Desktop UI"
  epic: "07-shipping"
  phase: "1B"
  complexity: "M"
  estimate_days: 3-4

dependencies:
  required:
    - story: "07.8"
      provides: ["pick_lists", "pick_list_lines", "pick_sequence"]
    - story: "07.7"
      provides: ["inventory_allocations", "FIFO/FEFO logic"]
    - story: "07.4"
      provides: ["sales_order_lines"]
    - story: "07.3"
      provides: ["sales_orders"]
    - epic: "05.1"
      provides: ["license_plates", "quantity_on_hand"]
    - epic: "05.3"
      provides: ["lp_reservations", "allocations"]
    - epic: "02.3"
      provides: ["allergens", "customer allergen restrictions"]
    - epic: "01.9"
      provides: ["locations", "zone/aisle/bin hierarchy"]

files_to_read:
  prd: "docs/1-BASELINE/product/modules/shipping.md"
  prd_sections: ["FR-7.24", "FR-7.26", "FR-7.27", "FR-7.28", "FR-7.30"]
  architecture: "docs/1-BASELINE/architecture/modules/shipping.md"
  architecture_lines: [159-176, 419-427, 696-722]
  story: "docs/2-MANAGEMENT/epics/current/07-shipping/07.9.pick-confirmation-desktop.md"
  patterns:
    - "apps/frontend/app/(authenticated)/warehouse/*/page.tsx"
    - "lib/services/*-service.ts"

files_to_create:
  database:
    - path: "supabase/migrations/YYYYMMDDHHMMSS_add_pick_confirmation_functions.sql"
      type: "migration"
      content: "RPC functions: increment_so_line_qty_picked, decrement_lp_quantity"

  api:
    - path: "apps/frontend/app/api/shipping/pick-lists/[id]/start/route.ts"
      methods: ["POST"]
    - path: "apps/frontend/app/api/shipping/pick-lists/[id]/lines/[lineId]/pick/route.ts"
      methods: ["PUT"]
    - path: "apps/frontend/app/api/shipping/pick-lists/[id]/lines/[lineId]/short-pick/route.ts"
      methods: ["POST"]
    - path: "apps/frontend/app/api/shipping/pick-lists/[id]/complete/route.ts"
      methods: ["POST"]

  services:
    - path: "lib/services/pick-confirmation-service.ts"

  validation:
    - path: "lib/validation/pick-confirmation-schema.ts"

  pages:
    - path: "apps/frontend/app/(authenticated)/shipping/pick-lists/[id]/pick/page.tsx"
      description: "Main pick confirmation page"

  components:
    - path: "apps/frontend/app/(authenticated)/shipping/pick-lists/[id]/pick/components/PickConfirmationHeader.tsx"
    - path: "apps/frontend/app/(authenticated)/shipping/pick-lists/[id]/pick/components/PickLineCard.tsx"
    - path: "apps/frontend/app/(authenticated)/shipping/pick-lists/[id]/pick/components/ShortPickModal.tsx"
    - path: "apps/frontend/app/(authenticated)/shipping/pick-lists/[id]/pick/components/PickProgressBar.tsx"
    - path: "apps/frontend/app/(authenticated)/shipping/pick-lists/[id]/pick/components/AllergenWarningBanner.tsx"
    - path: "apps/frontend/app/(authenticated)/shipping/pick-lists/[id]/pick/components/LPBarcodeDisplay.tsx"

database:
  tables:
    - name: "pick_list_lines"
      columns: ["quantity_picked", "picked_license_plate_id", "picked_at", "picked_by", "status", "notes"]
      rls: true
      operation: "UPDATE"
    - name: "inventory_allocations"
      columns: ["quantity_picked"]
      rls: true
      operation: "UPDATE"
    - name: "sales_order_lines"
      columns: ["quantity_picked", "backorder_quantity"]
      rls: true
      operation: "UPDATE"
    - name: "license_plates"
      columns: ["quantity_on_hand", "allocated_quantity"]
      rls: true
      operation: "UPDATE"
    - name: "pick_lists"
      columns: ["status", "started_at", "completed_at"]
      rls: true
      operation: "UPDATE"
    - name: "sales_orders"
      columns: ["status"]
      rls: true
      operation: "UPDATE"

api_endpoints:
  - method: "POST"
    path: "/api/shipping/pick-lists/:id/start"
    auth: true
    roles: ["Picker", "Warehouse", "Manager", "Admin"]
    validation: "Only assigned picker or Warehouse+"

  - method: "PUT"
    path: "/api/shipping/pick-lists/:id/lines/:lineId/pick"
    auth: true
    roles: ["Picker", "Warehouse", "Manager", "Admin"]
    body_schema: "confirmPickSchema"
    updates: ["pick_list_lines", "inventory_allocations", "sales_order_lines", "license_plates"]

  - method: "POST"
    path: "/api/shipping/pick-lists/:id/lines/:lineId/short-pick"
    auth: true
    roles: ["Picker", "Warehouse", "Manager", "Admin"]
    body_schema: "shortPickSchema"
    updates: ["pick_list_lines", "inventory_allocations", "sales_order_lines", "license_plates", "backorder_lines"]

  - method: "POST"
    path: "/api/shipping/pick-lists/:id/complete"
    auth: true
    roles: ["Picker", "Warehouse", "Manager", "Admin"]
    validation: "All lines must be 'picked' or 'short'"
    updates: ["pick_lists", "sales_orders"]

ux:
  pages:
    - route: "/shipping/pick-lists/:id/pick"
      description: "Desktop pick confirmation page with line-by-line workflow"
      layout: "single-column, focused workflow"
      components: ["PickConfirmationHeader", "PickLineCard", "PickProgressBar", "ShortPickModal"]

  patterns:
    form: "Single line focus with quantity input + action buttons"
    modal: "ShadCN Dialog for short pick reason selection"
    progress: "Real-time progress bar (X of Y lines)"
    validation: "Inline validation, cannot exceed quantity_to_pick"

  states:
    - "loading": "Fetching pick list and lines"
    - "in_progress": "Picking active, show current line"
    - "completed": "All lines picked/short, show summary"
    - "error": "Permission denied or validation error"

  interactions:
    - "Start Picking": "POST /start → Navigate to /pick page"
    - "Confirm Pick": "PUT /pick → Update quantities → Next line"
    - "Short Pick": "Open modal → Select reason → POST /short-pick → Next line"
    - "Complete": "POST /complete → Navigate to my-picks or detail page"
    - "Navigate": "Previous/Next buttons to move between lines"

validation_rules:
  quantity_picked: "Must be > 0 and <= quantity_to_pick"
  reason: "Required for short picks (enum: insufficient_inventory, damaged, expired, location_empty, quality_hold, other)"
  permission: "Only assigned picker or Warehouse+ roles can access"
  completion: "All lines must have status IN ('picked', 'short') before completing"
  allergen: "Display warning if product allergens match customer restrictions"

patterns:
  rls: "ADR-013 - All tables filtered by org_id"
  api: "REST with org_id filter, status transition validation"
  service: "class-based with static methods, transaction-safe updates"
  validation: "Zod schemas for confirmPickSchema, shortPickSchema"
  cascade_updates: "Single pick confirmation updates 4 tables atomically"

business_rules:
  - "Pick confirmation updates 4 tables: pick_list_lines, inventory_allocations, sales_order_lines, license_plates"
  - "Short pick creates backorder if quantity_picked < quantity_ordered for SO line"
  - "Allergen warning displayed if product allergens conflict with customer restrictions"
  - "LP barcode displayed for hybrid desktop/scanner users"
  - "Status workflow: assigned → in_progress → completed"
  - "SO status: fully picked → 'packing', partially picked → 'partial'"
  - "Permission: Only assigned picker or Warehouse+ can confirm picks"
  - "Cannot pick more than quantity_to_pick (validation error)"

acceptance_checklist:
  - "POST /start updates pick_lists.status to 'in_progress'"
  - "PUT /pick updates 4 tables (pick_list_lines, allocations, SO lines, LPs)"
  - "POST /short-pick records reason and creates backorder if needed"
  - "POST /complete validates all lines picked/short"
  - "PickConfirmationPage displays current line with all details"
  - "PickLineCard has editable quantity input with validation"
  - "ShortPickModal requires reason selection"
  - "PickProgressBar updates in real-time"
  - "AllergenWarningBanner displays if allergen conflict"
  - "LPBarcodeDisplay shows CODE128 barcode"
  - "Permission check: only assigned picker or Warehouse+"
  - "Backorder created for short picks"
  - "SO status updates correctly (packing or partial)"
  - "RLS policies enforce multi-tenant isolation"
  - "Unit tests: >80% coverage for PickConfirmationService"
  - "E2E test: Full pick workflow (start → pick all → complete)"
  - "E2E test: Short pick workflow (reason → backorder)"
  - "E2E test: Allergen warning acknowledgment"

output_artifacts:
  - "Pick confirmation page at /shipping/pick-lists/:id/pick"
  - "4 API endpoints (start, pick, short-pick, complete)"
  - "PickConfirmationService with atomic updates"
  - "6 React components (Header, Card, Modal, Progress, Allergen, Barcode)"
  - "Zod validation schemas"
  - "RPC functions for quantity updates"
  - "Unit tests (>80% coverage)"
  - "E2E tests (3 critical paths)"
  - "Multi-tenant RLS enforcement"
