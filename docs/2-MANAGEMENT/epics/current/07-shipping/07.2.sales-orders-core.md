# 07.2 - Sales Orders Core CRUD (Draft/Confirmed)

**Priority:** P0 (MVP - Phase 1A)
**Story Points:** M (Medium)
**Complexity:** M (3-4 days)
**Type:** backend + frontend

**State:** ready
**Primary PRD:** `docs/1-BASELINE/product/modules/shipping.md` (FR-7.9 to FR-7.18)
**Architecture:** `docs/1-BASELINE/architecture/modules/shipping.md` (lines 85-127, 324-405)

---

## MVP Scope

This story implements Phase 1A (MVP) core sales order functionality. Order creation with lines, draft/confirmed status workflow, and order list/detail views. Allocation logic is handled separately in Story 07.7.

**Status workflow for this story:** draft → confirmed

**Out of scope:**
- Inventory allocation (Story 07.7)
- Pick/Pack/Ship statuses (Stories 07.8-07.11)
- Allergen validation (Story 07.6)
- Clone/Import (Story 07.5)
- Backorder management (Phase 1B)

---

## Dependencies

### Epic Dependencies
- **Epic 01.1** - Org context, RLS, users table
- **Epic 02.1** - Products table (for sales order lines)
- **Story 07.1** - Customers table, customer_addresses table

### Story Dependencies (within Epic 07)
None - This is the first core shipping story after customer management.

### Provides To
- **Story 07.5** - SO clone/template (Phase 1B)
- **Story 07.6** - Allergen validation (Phase 1A)
- **Story 07.7** - Inventory allocation (Phase 1B)
- **Story 07.8** - Pick list generation (Phase 1C)

---

## Goal

Enable shipping clerks to create, edit, and manage sales orders with multiple product lines, tracking order status from draft through confirmation, with full audit trail and multi-tenant isolation.

## User Story

As a **Shipping Clerk**, I want to **create and manage sales orders with multiple product lines** so that **I can track customer orders from creation through fulfillment**.

## Scope

**In scope (this story)**
- `sales_orders` table CRUD with auto-generated order numbers (SO-YYYY-NNNNN)
- `sales_order_lines` table CRUD with line-level quantities and pricing
- SO list page with filters (status, date range, customer)
- SO detail page with lines table, totals, status timeline
- SO creation wizard (customer selection → address → add lines → review)
- SO edit (draft only)
- SO confirmation (draft → confirmed)
- Status enum: draft, confirmed (extensible for future statuses)
- Line totals and SO total calculation
- Order number auto-generation via sequence
- Cascade delete on lines when SO deleted
- RLS policies for sales_orders and sales_order_lines

**Out of scope (this story)**
- Inventory allocation (Story 07.7) - confirmed status allows allocation to start
- Pick/Pack/Ship workflow (Stories 07.8-07.11)
- Allergen validation against customer restrictions (Story 07.6)
- SO clone/template functionality (Story 07.5)
- Hold/Cancel states (Story 07.5)
- Backorder handling (Phase 1B)
- CSV/API import (Phase 2)

---

## Acceptance Criteria (Given/When/Then)

### AC-1: Sales Order List Page

**Given** shipping clerk navigates to `/shipping/sales-orders`
**When** page loads
**Then** SO list displays within 500ms for up to 1000 orders

**Given** SO list has 500 orders
**When** clerk applies search "SO-2025-00123"
**Then** filtered results display within 300ms

**Given** SO list displayed
**When** clerk filters by status "confirmed"
**Then** only confirmed orders appear

**Given** SO list displayed
**When** clerk filters by customer "Acme Corp"
**Then** only orders for Acme Corp appear

**Given** SO list displayed
**When** clerk filters by date range "2025-12-01 to 2025-12-31"
**Then** only orders within that range appear

**Given** SO list with pagination
**When** page 2 clicked
**Then** next 25 orders display

### AC-2: Create Sales Order - Customer Selection

**Given** clerk clicks "Create Sales Order"
**When** wizard opens
**Then** Step 1 displays customer selection dropdown

**Given** customer "Acme Corp" selected
**When** next clicked
**Then** shipping address dropdown populates with Acme's addresses

**Given** no customer selected
**When** next clicked
**Then** error "Customer is required" displays

### AC-3: Create Sales Order - Add Lines

**Given** clerk on Step 2 (Add Lines)
**When** "Add Line" clicked
**Then** product dropdown, quantity, unit price fields appear

**Given** product "Widget A" selected with quantity 100, price $10.50
**When** line added
**Then** line total displays $1,050.00

**Given** multiple lines added
**When** any quantity/price changed
**Then** line total and SO total recalculate immediately

**Given** invalid quantity (0 or negative)
**When** save attempted
**Then** error "Quantity must be greater than zero" displays

**Given** duplicate product in multiple lines
**When** save attempted
**Then** allowed (valid use case for different lots/prices)

### AC-4: Create Sales Order - Review & Save

**Given** clerk on Step 3 (Review)
**When** review displays
**Then** customer, address, all lines, totals shown

**Given** clerk clicks "Save as Draft"
**When** save completes
**Then** SO created with status "draft", order number auto-generated (SO-2025-00001)

**Given** SO saved as draft
**When** SO list reloaded
**Then** new SO appears in list with "draft" status badge

### AC-5: Edit Sales Order (Draft Only)

**Given** clerk opens draft SO
**When** "Edit" clicked
**Then** wizard reopens with existing data pre-populated

**Given** clerk changes line quantity from 100 to 150
**When** save completes
**Then** line total and SO total update immediately

**Given** clerk deletes a line
**When** confirmation accepted
**Then** line removed, SO total recalculates

**Given** clerk opens confirmed SO
**When** page loads
**Then** "Edit" button hidden (cannot edit confirmed orders)

### AC-6: Confirm Sales Order

**Given** clerk opens draft SO
**When** "Confirm Order" clicked
**Then** confirmation dialog displays "This will lock the order. Continue?"

**Given** confirmation accepted
**When** confirm completes
**Then** SO status changes to "confirmed", confirmed_at timestamp set

**Given** SO is confirmed
**When** SO detail page reloaded
**Then** status shows "confirmed", Edit button hidden

**Given** SO is confirmed
**When** allocation story implemented
**Then** confirmed trigger can start allocation workflow (future)

### AC-7: Order Number Auto-Generation

**Given** new SO created
**When** saved (draft or confirmed)
**Then** order number generated as SO-YYYY-NNNNN (e.g., SO-2025-00001)

**Given** year changes from 2025 to 2026
**When** first SO of 2026 created
**Then** order number resets to SO-2026-00001

**Given** 50 orders exist in org A
**When** org B creates first order
**Then** order number for org B is SO-2025-00001 (separate sequence per org)

### AC-8: Line Number Auto-Increment

**Given** clerk adds first line to SO
**When** line saved
**Then** line_number = 1

**Given** clerk adds second line to SO
**When** line saved
**Then** line_number = 2

**Given** clerk deletes line 2 of 3 lines
**When** deletion completes
**Then** line 3 remains line 3 (no renumbering)

### AC-9: Total Calculations

**Given** line with quantity 100, unit_price $10.50
**When** line saved
**Then** line_total = $1,050.00

**Given** SO with 3 lines: $1,050.00, $500.00, $250.00
**When** SO saved
**Then** SO total_amount = $1,800.00

**Given** line quantity updated from 100 to 150
**When** update completes
**Then** line_total and SO total_amount recalculate immediately

### AC-10: Cascade Delete

**Given** SO with 5 lines
**When** SO deleted (draft only)
**Then** all 5 sales_order_lines records deleted automatically

**Given** SO is confirmed
**When** delete attempted
**Then** error "Cannot delete confirmed orders. Contact administrator." displays

### AC-11: RLS and Multi-Tenancy

**Given** user from org A logged in
**When** SO list loads
**Then** only org A's orders appear

**Given** user from org B tries to access org A's SO by URL
**When** request made
**Then** 404 error returns (RLS blocks access)

### AC-12: Permission Enforcement

**Given** user with VIEWER role
**When** `/shipping/sales-orders` accessed
**Then** list displays but "Create Order" button hidden

**Given** user with SALES role
**When** SO page loaded
**Then** "Create Order", "Edit", "Confirm" buttons visible

**Given** user with no shipping permissions
**When** `/shipping/sales-orders` accessed
**Then** redirect to dashboard with "Access Denied"

---

## Implementation Notes

### API Endpoints

```typescript
// GET /api/shipping/sales-orders
// Query params: page, limit, search, customer_id, status, start_date, end_date, sortBy, sortOrder
interface SalesOrdersListResponse {
  sales_orders: SalesOrder[];
  total: number;
  page: number;
  limit: number;
}

// GET /api/shipping/sales-orders/:id
interface SalesOrderDetailResponse {
  sales_order: SalesOrder;
  lines: SalesOrderLine[];
  customer: Customer;
  shipping_address: CustomerAddress;
}

// POST /api/shipping/sales-orders
interface CreateSalesOrderRequest {
  customer_id: UUID;
  customer_po?: string;
  shipping_address_id: UUID;
  order_date: Date;
  promised_ship_date?: Date;
  required_delivery_date?: Date;
  notes?: string;
  lines: {
    product_id: UUID;
    quantity_ordered: number;
    unit_price: number;
    requested_lot?: string;
    notes?: string;
  }[];
}

// PUT /api/shipping/sales-orders/:id (draft only)
interface UpdateSalesOrderRequest {
  customer_po?: string;
  shipping_address_id?: UUID;
  promised_ship_date?: Date;
  required_delivery_date?: Date;
  notes?: string;
  lines?: {
    id?: UUID; // Existing line to update
    product_id: UUID;
    quantity_ordered: number;
    unit_price: number;
    requested_lot?: string;
    notes?: string;
  }[];
}

// DELETE /api/shipping/sales-orders/:id (draft only)
// No body required

// POST /api/shipping/sales-orders/:id/confirm
// No body required, returns updated SO with status "confirmed"

// Line-level endpoints (alternative approach)
// POST /api/shipping/sales-orders/:id/lines
// PUT /api/shipping/sales-orders/:id/lines/:lineId
// DELETE /api/shipping/sales-orders/:id/lines/:lineId
```

### Database

**Reference:** Architecture doc lines 85-127

```sql
-- sales_orders table
CREATE TABLE sales_orders (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id),
  order_number TEXT NOT NULL,           -- Auto: SO-YYYY-NNNNN
  customer_id UUID NOT NULL REFERENCES customers(id),
  customer_po TEXT,                     -- Customer's PO number
  shipping_address_id UUID NOT NULL REFERENCES customer_addresses(id),
  order_date DATE NOT NULL,
  promised_ship_date DATE,
  required_delivery_date DATE,
  status TEXT NOT NULL DEFAULT 'draft', -- draft, confirmed (extensible)
  total_amount DECIMAL(15,2),           -- Calculated from lines
  notes TEXT,
  allergen_validated BOOLEAN DEFAULT false, -- Story 07.6
  created_at TIMESTAMPTZ DEFAULT now(),
  created_by UUID REFERENCES users(id),
  updated_at TIMESTAMPTZ DEFAULT now(),
  confirmed_at TIMESTAMPTZ,
  shipped_at TIMESTAMPTZ,               -- Future: Story 07.14

  UNIQUE(org_id, order_number)
);

-- sales_order_lines table
CREATE TABLE sales_order_lines (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id),
  sales_order_id UUID NOT NULL REFERENCES sales_orders(id) ON DELETE CASCADE,
  line_number INTEGER NOT NULL,         -- Auto-increment per order
  product_id UUID NOT NULL REFERENCES products(id),
  quantity_ordered DECIMAL(15,4) NOT NULL CHECK (quantity_ordered > 0),
  quantity_allocated DECIMAL(15,4) DEFAULT 0,   -- Story 07.7
  quantity_picked DECIMAL(15,4) DEFAULT 0,      -- Story 07.8
  quantity_packed DECIMAL(15,4) DEFAULT 0,      -- Story 07.11
  quantity_shipped DECIMAL(15,4) DEFAULT 0,     -- Story 07.14
  unit_price DECIMAL(15,4) NOT NULL CHECK (unit_price >= 0),
  line_total DECIMAL(15,2),             -- Calculated: quantity * unit_price
  requested_lot TEXT,                   -- Optional specific lot request
  notes TEXT,
  created_at TIMESTAMPTZ DEFAULT now(),

  UNIQUE(sales_order_id, line_number)
);

-- Indexes
CREATE INDEX idx_sales_orders_org_status ON sales_orders(org_id, status);
CREATE INDEX idx_sales_orders_customer ON sales_orders(customer_id);
CREATE INDEX idx_sales_orders_promised_date ON sales_orders(promised_ship_date);
CREATE INDEX idx_sales_orders_order_date ON sales_orders(order_date);
CREATE INDEX idx_so_lines_order ON sales_order_lines(sales_order_id);
CREATE INDEX idx_so_lines_product ON sales_order_lines(product_id);

-- RLS Policies
ALTER TABLE sales_orders ENABLE ROW LEVEL SECURITY;
ALTER TABLE sales_order_lines ENABLE ROW LEVEL SECURITY;

CREATE POLICY "sales_orders_org_isolation" ON sales_orders
  FOR ALL USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

CREATE POLICY "sales_order_lines_org_isolation" ON sales_order_lines
  FOR ALL USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

-- Sequence for order number generation (stored per org)
-- Alternative: Use organizations.next_so_sequence column
ALTER TABLE organizations ADD COLUMN IF NOT EXISTS next_so_sequence INTEGER DEFAULT 1;
```

### Frontend Components

```
apps/frontend/app/(authenticated)/shipping/
  sales-orders/
    page.tsx                    -- SO list page
    [id]/page.tsx               -- SO detail page
    new/page.tsx                -- Create SO wizard
    components/
      SOTable.tsx               -- DataTable with filters
      SOFilters.tsx             -- Status, customer, date range filters
      SOWizard.tsx              -- Multi-step wizard (customer → lines → review)
      SOLinesTable.tsx          -- Lines table within SO detail
      SOLineForm.tsx            -- Add/edit line form
      SOStatusBadge.tsx         -- Status indicator (draft, confirmed)
      SOStatusTimeline.tsx      -- Visual timeline of SO lifecycle
      ConfirmOrderDialog.tsx    -- Confirmation dialog for SO confirm
      DeleteOrderDialog.tsx     -- Confirmation dialog for SO delete (draft only)
```

### Services

```typescript
// lib/services/sales-order-service.ts
export class SalesOrderService {
  // Order CRUD
  async getSalesOrders(params: SOListParams): Promise<SOListResponse>;
  async getSalesOrder(id: string): Promise<SODetailResponse>;
  async createSalesOrder(data: CreateSORequest): Promise<SalesOrder>;
  async updateSalesOrder(id: string, data: UpdateSORequest): Promise<SalesOrder>;
  async deleteSalesOrder(id: string): Promise<void>; // Draft only

  // Status transitions
  async confirmSalesOrder(id: string): Promise<SalesOrder>; // draft → confirmed

  // Order number generation
  async generateOrderNumber(orgId: string): Promise<string>;

  // Calculations
  calculateLineTotal(quantity: number, unitPrice: number): number;
  calculateOrderTotal(lines: SOLine[]): number;

  // Validation helpers
  async canEdit(soId: string): Promise<{ allowed: boolean; reason?: string }>;
  async canDelete(soId: string): Promise<{ allowed: boolean; reason?: string }>;
  async canConfirm(soId: string): Promise<{ allowed: boolean; reason?: string }>;
}

// lib/services/sales-order-line-service.ts
export class SalesOrderLineService {
  async getLines(soId: string): Promise<SOLine[]>;
  async addLine(soId: string, data: AddLineRequest): Promise<SOLine>;
  async updateLine(lineId: string, data: UpdateLineRequest): Promise<SOLine>;
  async deleteLine(lineId: string): Promise<void>;

  // Auto-increment line_number
  async getNextLineNumber(soId: string): Promise<number>;
}
```

### Validation (Zod)

```typescript
// lib/validation/sales-order-schema.ts
const createSalesOrderSchema = z.object({
  customer_id: z.string().uuid("Invalid customer"),
  customer_po: z.string().max(100).optional(),
  shipping_address_id: z.string().uuid("Invalid shipping address"),
  order_date: z.date(),
  promised_ship_date: z.date().optional(),
  required_delivery_date: z.date().optional(),
  notes: z.string().max(1000).optional(),
  lines: z.array(z.object({
    product_id: z.string().uuid("Invalid product"),
    quantity_ordered: z.number().positive("Quantity must be greater than zero"),
    unit_price: z.number().nonnegative("Unit price cannot be negative"),
    requested_lot: z.string().max(100).optional(),
    notes: z.string().max(500).optional(),
  })).min(1, "Order must have at least one line"),
});

const updateSalesOrderSchema = z.object({
  customer_po: z.string().max(100).optional(),
  shipping_address_id: z.string().uuid().optional(),
  promised_ship_date: z.date().optional(),
  required_delivery_date: z.date().optional(),
  notes: z.string().max(1000).optional(),
  lines: z.array(z.object({
    id: z.string().uuid().optional(), // Existing line
    product_id: z.string().uuid("Invalid product"),
    quantity_ordered: z.number().positive("Quantity must be greater than zero"),
    unit_price: z.number().nonnegative("Unit price cannot be negative"),
    requested_lot: z.string().max(100).optional(),
    notes: z.string().max(500).optional(),
  })).optional(),
});

const salesOrderLineSchema = z.object({
  product_id: z.string().uuid("Invalid product"),
  quantity_ordered: z.number().positive("Quantity must be greater than zero"),
  unit_price: z.number().nonnegative("Unit price cannot be negative"),
  requested_lot: z.string().max(100).optional(),
  notes: z.string().max(500).optional(),
});
```

### Key Business Rules

1. **Order Number Format:** SO-YYYY-NNNNN (e.g., SO-2025-00123)
   - Year from order creation date
   - Sequence resets each year per org
   - Stored in `organizations.next_so_sequence`

2. **Status Workflow (this story):**
   - draft → confirmed
   - Draft orders are editable
   - Confirmed orders are locked (no edit/delete)
   - Only draft orders can be deleted

3. **Line Number Auto-Increment:**
   - Auto-assigned when line created
   - Not renumbered on deletion
   - Unique per sales_order_id

4. **Total Calculations:**
   - line_total = quantity_ordered * unit_price
   - total_amount = SUM(all line_totals)
   - Calculated on save/update, stored in database

5. **Cascade Delete:**
   - Deleting sales_order deletes all sales_order_lines (ON DELETE CASCADE)
   - Only allowed for draft status

6. **Multi-Tenancy:**
   - All queries filtered by org_id via RLS
   - Order numbers unique per (org_id, order_number)

7. **Date Validations:**
   - order_date defaults to today
   - promised_ship_date >= order_date (optional validation)
   - required_delivery_date >= order_date (optional validation)

8. **Permission Requirements:**
   - View SO: Any authenticated user
   - Create SO: SALES, MANAGER, ADMIN, SUPER_ADMIN
   - Edit SO: SALES, MANAGER, ADMIN, SUPER_ADMIN (draft only)
   - Confirm SO: SALES, MANAGER, ADMIN, SUPER_ADMIN
   - Delete SO: MANAGER, ADMIN, SUPER_ADMIN (draft only)

---

## Deliverables

- `sales_orders` and `sales_order_lines` tables with RLS
- API routes: GET/POST /api/shipping/sales-orders
- API route: GET/PUT/DELETE /api/shipping/sales-orders/:id
- API route: POST /api/shipping/sales-orders/:id/confirm
- API routes: POST/PUT/DELETE /api/shipping/sales-orders/:id/lines (optional)
- SO list page with filters (status, customer, date range)
- SO detail page with lines table
- SO creation wizard (3 steps)
- SO edit modal/page (draft only)
- SalesOrderService with CRUD and calculations
- SalesOrderLineService for line management
- Zod validation schemas
- RLS policies for sales_orders and sales_order_lines
- Unit tests for services (>80% coverage)
- Integration tests for API endpoints
- E2E test: Create SO → Add lines → Confirm

---

## Definition of Done

- [ ] sales_orders table created with RLS policies
- [ ] sales_order_lines table created with RLS policies
- [ ] Order number auto-generation works (SO-YYYY-NNNNN)
- [ ] SO list page loads within 500ms for 1000 orders
- [ ] Create SO wizard works end-to-end (customer → lines → review → save)
- [ ] Edit SO updates immediately in UI (draft only)
- [ ] Confirm SO changes status to "confirmed", locks editing
- [ ] Line totals and SO total calculate correctly
- [ ] Cascade delete removes all lines when SO deleted
- [ ] Multi-tenant isolation verified (org A cannot see org B orders)
- [ ] Permission checks hide unauthorized actions
- [ ] Search and filters work within 300ms
- [ ] Status badges display correctly (draft, confirmed)
- [ ] All API endpoints have integration tests
- [ ] Unit tests cover services (>80% coverage)
- [ ] E2E test: Full SO creation and confirmation flow

---

## Future Phases (Not in This Story)

### Phase 1B (Allocation & Picking)

- **Story 07.7: Inventory Allocation**
  - Auto-allocation on SO confirmation
  - FIFO/FEFO logic
  - Partial allocation → backorder creation
  - Status: confirmed → allocated

- **Story 07.5: SO Hold/Cancel**
  - Hold status for temporary pause
  - Cancel workflow with allocation release

- **Story 07.6: Allergen Validation**
  - Check customer.allergen_restrictions vs product.allergens
  - Block confirmation if conflict detected

### Phase 2

- **SO Clone/Template**
  - Duplicate existing SO with new order number

- **SO Import (CSV/API)**
  - Bulk SO creation from external systems

- **Backorder Management**
  - Track unfulfilled quantities
  - Link to production/purchasing

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-12-16 | Initial story for Epic 07 Phase 1A | PM-AGENT |
