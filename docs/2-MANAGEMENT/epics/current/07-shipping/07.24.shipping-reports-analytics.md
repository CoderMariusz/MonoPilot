# 07.24 - Shipping Reports & Analytics

**Story ID:** 07.24
**Epic:** 07 - Shipping
**Phase:** 2-3 (Advanced Analytics)
**Complexity:** L (Large)
**Estimate:** 7-10 days
**Priority:** P2
**Type:** Backend + Frontend
**State:** ready

**Primary PRD:** `docs/1-BASELINE/product/modules/shipping.md` (FR-7.66 to FR-7.72)
**Architecture:** `docs/1-BASELINE/architecture/modules/shipping.md`

---

## PRD References

| FR ID | Requirement | Priority | Phase | Covered |
|-------|-------------|----------|-------|---------|
| FR-7.66 | Shipping Volume Report | P1 | 2 | Yes |
| FR-7.67 | Order Fulfillment Report | P1 | 2 | Yes |
| FR-7.68 | Pick Performance Report | P2 | 2 | Yes |
| FR-7.69 | On-Time Delivery Report | P1 | 2 | Yes |
| FR-7.70 | Backorder Report | P1 | 2 | Yes |
| FR-7.71 | Carrier Performance Report | P2 | 3 | Yes |
| FR-7.72 | Returns Analysis Report | P2 | 3 | Yes |

---

## User Story

**As a** shipping manager or logistics director,
**I want** comprehensive reports and analytics on shipping operations,
**So that** I can identify trends, measure performance against targets, optimize carrier selection, and reduce costs while improving delivery times.

**As an** operations analyst,
**I want** exportable reports with historical data,
**So that** I can perform deeper analysis, create presentations, and track KPIs over time.

---

## Goal

Implement a comprehensive reporting and analytics suite for shipping operations, covering volume trends, fulfillment rates, pick performance, on-time delivery metrics, backorder analysis, carrier performance comparison, and returns analysis. Reports support date range filtering, data export, and drill-down capabilities to enable data-driven operational decisions.

---

## Scope

**In scope (this story):**
- Shipping Volume Report (FR-7.66): Daily/weekly/monthly shipment counts and trends
- Order Fulfillment Report (FR-7.67): Fulfillment rate vs. targets, partial vs. complete
- Pick Performance Report (FR-7.68): Picks/hour, accuracy %, picker leaderboard
- On-Time Delivery Report (FR-7.69): OTD %, late delivery analysis, customer impact
- Backorder Report (FR-7.70): Aging analysis, value at risk, product breakdown
- Carrier Performance Report (FR-7.71): OTD by carrier, cost per shipment, transit times
- Returns Analysis Report (FR-7.72): Reason codes, value trends, top returned products
- Date range filters (preset and custom)
- Chart visualizations (line, bar, pie, table)
- Export to CSV/Excel for all reports
- Print-friendly report layouts
- Redis caching for report queries (5min TTL)
- Drill-down from summary to detail views

**Out of scope (this story):**
- Real-time streaming analytics (Phase 3)
- Predictive analytics / ML forecasting (Phase 3)
- Custom report builder (Phase 3)
- Scheduled report emails (Phase 3)
- Dashboard embedding (external BI tools)
- Cost optimization recommendations (Phase 3)

---

## Dependencies

### Story Dependencies (within Epic 07)

| Story | Requirement | Status |
|-------|-------------|--------|
| 07.2 | Sales Orders Core | Required - order data source |
| 07.3 | SO Status Workflow | Required - status transitions |
| 07.7 | Inventory Allocation | Required - backorder detection |
| 07.8 | Pick List Generation | Required - pick performance data |
| 07.9 | Pick Confirmation Desktop | Required - pick metrics |
| 07.10 | Pick Scanner | Required - pick metrics |
| 07.11 | Packing + Shipment Creation | Required - shipment data |
| 07.14 | Ship Confirmation | Required - shipped/delivered data |
| 07.15 | Shipping Dashboard | Required - KPI baseline |
| 07.16 | RMA Core | Required - returns data |
| 07.20 | Carrier Integration | Required - carrier data |

### Epic Dependencies

| Epic | Requirement | Status |
|------|-------------|--------|
| 01.1 | Org Context + Base RLS | Required - auth context |
| 02.1 | Products | Required - product data |

### Provides To

- All shipping stories (analytics for operational decisions)
- Finance module (shipping cost analysis)

---

## Acceptance Criteria (Given/When/Then)

### AC-1: Shipping Volume Report (FR-7.66)

**Given** user navigates to Reports > Shipping Volume
**When** the report loads with default date range (last 30 days)
**Then** the report displays:
- Total shipments count for the period
- Daily shipment count line chart
- Weekly/monthly aggregation toggle
- Shipments by carrier breakdown (stacked bar chart)
- Top 10 customers by shipment volume (bar chart)
- Average shipments per day metric

**Given** user selects "Weekly" aggregation
**When** the chart updates
**Then** data points aggregate to weekly totals with week labels

**Given** user selects "Monthly" aggregation
**When** the chart updates
**Then** data points aggregate to monthly totals with month labels

**Given** user selects custom date range (Jan 1 - Dec 31, 2025)
**When** the report refreshes
**Then** all metrics and charts reflect the full year data within 3 seconds

**Given** user clicks "Export CSV"
**When** export completes
**Then** CSV file downloads with columns: date, shipment_count, carrier, customer, weight_kg, boxes

---

### AC-2: Order Fulfillment Report (FR-7.67)

**Given** user navigates to Reports > Order Fulfillment
**When** the report loads
**Then** the report displays:
- Overall fulfillment rate % (orders shipped / orders created)
- Complete fulfillment rate % (orders shipped 100% / total orders)
- Partial fulfillment rate % (orders shipped partial / total orders)
- Fulfillment rate trend line chart (daily)
- Fulfillment rate vs. target gauge (target: 95%)
- Orders by status breakdown pie chart
- Average time to ship (order created to shipped)

**Given** 100 orders created, 85 shipped complete, 10 shipped partial, 5 cancelled
**When** the fulfillment metrics calculate
**Then** display:
- Overall: 95% (95/100)
- Complete: 85%
- Partial: 10%
- Cancelled: 5%

**Given** organization has fulfillment target of 98%
**When** the gauge renders
**Then** current rate displays with color indicator (red if below target, green if at/above)

**Given** user clicks on "Partial" segment in pie chart
**When** drill-down activates
**Then** user navigates to filtered order list showing only partial shipment orders

---

### AC-3: Pick Performance Report (FR-7.68)

**Given** user navigates to Reports > Pick Performance
**When** the report loads
**Then** the report displays:
- Overall picks per hour (lines picked / total pick hours)
- Pick accuracy % (correct picks / total picks)
- Average pick time (minutes per line)
- Picker leaderboard table (top 10 pickers by picks/hour)
- Pick performance trend (daily picks/hour line chart)
- Short pick rate % (short picks / total picks)
- Zone performance breakdown (picks by warehouse zone)

**Given** picker John completed 150 picks in 2 hours
**When** the leaderboard calculates
**Then** John's picks/hour = 75

**Given** 1000 picks completed, 5 short picks, 995 correct
**When** accuracy calculates
**Then** pick accuracy = 99.5%, short pick rate = 0.5%

**Given** user clicks on picker name in leaderboard
**When** drill-down activates
**Then** user sees individual picker performance details (daily breakdown, zones worked)

**Given** user selects "Zone Performance" tab
**When** zone metrics display
**Then** each zone shows: picks count, avg picks/hour, short pick rate

---

### AC-4: On-Time Delivery Report (FR-7.69)

**Given** user navigates to Reports > On-Time Delivery
**When** the report loads
**Then** the report displays:
- Overall OTD % (shipped by promised_ship_date / total orders with promised date)
- OTD % trend line chart (daily/weekly)
- Late deliveries count and days late distribution (histogram)
- OTD by customer (top 10 worst performers)
- OTD by carrier (comparison bar chart)
- Average days late for late shipments
- Customer impact analysis (orders affected, estimated revenue at risk)

**Given** 100 orders with promised dates, 92 shipped on/before date, 8 late
**When** OTD calculates
**Then** OTD = 92%

**Given** 8 late orders: 3 are 1 day late, 3 are 2 days late, 2 are 5 days late
**When** late distribution histogram renders
**Then** buckets show: 1-day (3), 2-day (3), 3-4 day (0), 5+ day (2)

**Given** user clicks on customer in "worst performers" list
**When** drill-down activates
**Then** user sees all late orders for that customer with reasons

**Given** OTD target is 95%
**When** current OTD is 92%
**Then** display red indicator with "-3% below target" warning

---

### AC-5: Backorder Report (FR-7.70)

**Given** user navigates to Reports > Backorders
**When** the report loads
**Then** the report displays:
- Total backorder lines count
- Total backorder value ($)
- Backorder aging buckets (0-7 days, 8-14 days, 15-30 days, 31+ days)
- Backorder by product (top 10 products on backorder)
- Backorder by customer (top 10 customers with backorders)
- Backorder trend (daily backorder value line chart)
- Expected resolution dates (if production orders exist)

**Given** 50 backorder lines totaling $25,000 with aging:
- 0-7 days: 20 lines ($10,000)
- 8-14 days: 15 lines ($8,000)
- 15-30 days: 10 lines ($5,000)
- 31+ days: 5 lines ($2,000)
**When** aging analysis displays
**Then** stacked bar chart shows distribution with color coding (older = more red)

**Given** user clicks on product in "top backordered products"
**When** drill-down activates
**Then** user sees all SO lines for that product with customer and qty details

**Given** user clicks "Export"
**When** export completes
**Then** CSV contains: product, customer, qty_ordered, qty_allocated, qty_backordered, value, age_days, order_date

---

### AC-6: Carrier Performance Report (FR-7.71)

**Given** user navigates to Reports > Carrier Performance
**When** the report loads
**Then** the report displays:
- Carrier comparison table: carrier, shipments, OTD %, avg transit days, cost/shipment, total cost
- OTD by carrier bar chart
- Cost per shipment by carrier bar chart
- Transit time distribution by carrier (box plot or histogram)
- Carrier trend (monthly shipment volume by carrier, stacked area chart)
- Exception rate by carrier (damaged, lost, delayed %)

**Given** carriers DHL, UPS, DPD with shipments:
- DHL: 100 shipments, 95% OTD, 2.5 avg transit days, $12.50 avg cost
- UPS: 80 shipments, 92% OTD, 2.8 avg transit days, $11.00 avg cost
- DPD: 50 shipments, 88% OTD, 3.0 avg transit days, $9.50 avg cost
**When** comparison table renders
**Then** all metrics display with conditional formatting (best values highlighted green)

**Given** user clicks on carrier in table
**When** drill-down activates
**Then** user sees all shipments for that carrier with detailed tracking history

**Given** user selects "Cost Analysis" view
**When** view changes
**Then** display cost breakdown: base rate, fuel surcharge, residential delivery, signature required

---

### AC-7: Returns Analysis Report (FR-7.72)

**Given** user navigates to Reports > Returns Analysis
**When** the report loads
**Then** the report displays:
- Total returns count for period
- Total return value ($)
- Return rate % (returns / total shipments)
- Returns by reason code pie chart (damaged, expired, wrong_product, quality_issue, other)
- Returns by product (top 10 most returned products)
- Returns by customer (top 10 customers with highest returns)
- Returns trend (monthly return count and value line chart)
- Disposition breakdown (restocked, scrapped, quality hold)

**Given** 30 returns in period with reasons:
- Damaged: 10 (33%)
- Quality Issue: 8 (27%)
- Wrong Product: 5 (17%)
- Expired: 4 (13%)
- Other: 3 (10%)
**When** reason code pie chart renders
**Then** segments display with proportional sizing and percentage labels

**Given** user clicks on "Damaged" segment
**When** drill-down activates
**Then** user sees all RMA lines with reason "damaged" and product/lot details

**Given** user selects "Trend Analysis" tab
**When** trend view displays
**Then** show month-over-month comparison with return rate % and value

**Given** disposition data exists
**When** disposition breakdown displays
**Then** show: Restocked X% ($value), Scrapped Y% ($value), Quality Hold Z% ($value)

---

### AC-8: Date Range Filtering

**Given** any report is loaded
**When** date range picker displays
**Then** preset options available: Today, Last 7 Days, Last 30 Days, Last 90 Days, Last 12 Months, Custom

**Given** user selects "Custom" date range
**When** date picker modal opens
**Then** user can select start and end dates (max 2 years range)

**Given** user selects date range and clicks "Apply"
**When** report refreshes
**Then** all metrics, charts, and tables update within 3 seconds

**Given** date range is changed
**When** URL updates
**Then** date range is persisted in URL query params (shareable links)

---

### AC-9: Export Functionality

**Given** any report is displayed
**When** user clicks "Export CSV"
**Then** browser downloads CSV file with report data and current date in filename

**Given** any report is displayed
**When** user clicks "Export Excel"
**Then** browser downloads XLSX file with formatted data and multiple sheets (summary + details)

**Given** user clicks "Print"
**When** print dialog opens
**Then** report renders in print-friendly layout (no navigation, formatted tables)

**Given** export in progress
**When** generating large report (>10,000 rows)
**Then** progress indicator displays with estimated time

---

### AC-10: Performance and Caching

**Given** user loads any report
**When** data fetches
**Then** response returns within 3 seconds for 1-year date range

**Given** report data is cached (< 5min old)
**When** same report with same parameters loads
**Then** cached data returns within 200ms

**Given** new shipment/order is created
**When** user loads report
**Then** new data may not appear immediately (passive cache invalidation, 5min TTL)

**Given** user clicks "Refresh" button on report
**When** refresh triggers
**Then** cache is bypassed and fresh data loads

---

### AC-11: Multi-Tenancy and Security

**Given** User from Org A loads shipping volume report
**When** data loads
**Then** only Org A's shipment data is included (RLS enforced)

**Given** user with role VIEWER loads report
**When** report renders
**Then** all reports are accessible (read-only, no export restrictions by default)

**Given** organization has export disabled (future setting)
**When** user attempts export
**Then** export buttons are hidden/disabled

---

### AC-12: Responsive Design

**Given** user views report on desktop (> 1024px)
**When** report renders
**Then** charts display side-by-side, tables use full width

**Given** user views report on tablet (768-1024px)
**When** report renders
**Then** charts stack vertically, tables scroll horizontally

**Given** user views report on mobile (< 768px)
**When** report renders
**Then** simplified view with key metrics only, charts reduced, export still available

---

## Technical Specification

### API Endpoints

```
# Shipping Volume Report
GET /api/shipping/reports/volume
  Query: date_from, date_to, aggregation (daily|weekly|monthly)
  Response: { summary, chart_data, by_carrier, by_customer }

# Order Fulfillment Report
GET /api/shipping/reports/fulfillment
  Query: date_from, date_to
  Response: { summary, trend, by_status, avg_time_to_ship }

# Pick Performance Report
GET /api/shipping/reports/pick-performance
  Query: date_from, date_to, picker_id (optional), zone_id (optional)
  Response: { summary, leaderboard, trend, by_zone }

# On-Time Delivery Report
GET /api/shipping/reports/otd
  Query: date_from, date_to
  Response: { summary, trend, late_distribution, by_customer, by_carrier }

# Backorder Report
GET /api/shipping/reports/backorders
  Query: date_from, date_to
  Response: { summary, aging, by_product, by_customer, trend }

# Carrier Performance Report
GET /api/shipping/reports/carrier-performance
  Query: date_from, date_to, carrier (optional)
  Response: { comparison_table, otd_chart, cost_chart, transit_distribution, trend }

# Returns Analysis Report
GET /api/shipping/reports/returns
  Query: date_from, date_to
  Response: { summary, by_reason, by_product, by_customer, trend, disposition }

# Export Endpoints (all reports)
GET /api/shipping/reports/{report-type}/export
  Query: date_from, date_to, format (csv|xlsx)
  Response: File download (Content-Disposition: attachment)
```

### Response Schemas

```typescript
// Shipping Volume Report Response
interface ShippingVolumeReport {
  summary: {
    total_shipments: number;
    total_weight_kg: number;
    total_boxes: number;
    avg_per_day: number;
    period: { from: string; to: string };
  };
  chart_data: Array<{
    date: string; // ISO date or week/month label
    shipments: number;
    weight_kg: number;
  }>;
  by_carrier: Array<{
    carrier: string;
    shipments: number;
    percentage: number;
  }>;
  by_customer: Array<{
    customer_id: string;
    customer_name: string;
    shipments: number;
    percentage: number;
  }>;
}

// Order Fulfillment Report Response
interface OrderFulfillmentReport {
  summary: {
    total_orders: number;
    shipped_complete: number;
    shipped_partial: number;
    cancelled: number;
    overall_rate: number; // percentage
    complete_rate: number;
    partial_rate: number;
    target_rate: number;
  };
  trend: Array<{
    date: string;
    fulfillment_rate: number;
    orders_created: number;
    orders_shipped: number;
  }>;
  by_status: Array<{
    status: string;
    count: number;
    percentage: number;
  }>;
  avg_time_to_ship_hours: number;
}

// Pick Performance Report Response
interface PickPerformanceReport {
  summary: {
    total_picks: number;
    picks_per_hour: number;
    accuracy_pct: number;
    short_pick_rate: number;
    avg_pick_time_minutes: number;
  };
  leaderboard: Array<{
    picker_id: string;
    picker_name: string;
    total_picks: number;
    picks_per_hour: number;
    accuracy_pct: number;
    hours_worked: number;
  }>;
  trend: Array<{
    date: string;
    picks: number;
    picks_per_hour: number;
    accuracy_pct: number;
  }>;
  by_zone: Array<{
    zone_id: string;
    zone_name: string;
    picks: number;
    picks_per_hour: number;
    short_pick_rate: number;
  }>;
}

// On-Time Delivery Report Response
interface OnTimeDeliveryReport {
  summary: {
    total_orders_with_date: number;
    on_time: number;
    late: number;
    otd_pct: number;
    target_pct: number;
    avg_days_late: number;
  };
  trend: Array<{
    date: string;
    otd_pct: number;
    on_time: number;
    late: number;
  }>;
  late_distribution: Array<{
    bucket: string; // "1 day", "2 days", "3-4 days", "5+ days"
    count: number;
  }>;
  by_customer: Array<{
    customer_id: string;
    customer_name: string;
    total_orders: number;
    late_orders: number;
    otd_pct: number;
  }>;
  by_carrier: Array<{
    carrier: string;
    total_shipments: number;
    on_time: number;
    otd_pct: number;
  }>;
}

// Backorder Report Response
interface BackorderReport {
  summary: {
    total_lines: number;
    total_value: number;
    avg_age_days: number;
  };
  aging: Array<{
    bucket: string; // "0-7 days", "8-14 days", "15-30 days", "31+ days"
    lines: number;
    value: number;
  }>;
  by_product: Array<{
    product_id: string;
    product_name: string;
    sku: string;
    lines: number;
    qty_backordered: number;
    value: number;
  }>;
  by_customer: Array<{
    customer_id: string;
    customer_name: string;
    lines: number;
    value: number;
  }>;
  trend: Array<{
    date: string;
    lines: number;
    value: number;
  }>;
}

// Carrier Performance Report Response
interface CarrierPerformanceReport {
  comparison: Array<{
    carrier: string;
    shipments: number;
    otd_pct: number;
    avg_transit_days: number;
    avg_cost: number;
    total_cost: number;
    exception_rate: number;
  }>;
  otd_chart: Array<{
    carrier: string;
    otd_pct: number;
  }>;
  cost_chart: Array<{
    carrier: string;
    avg_cost: number;
  }>;
  transit_distribution: Array<{
    carrier: string;
    min_days: number;
    avg_days: number;
    max_days: number;
    p25_days: number;
    p75_days: number;
  }>;
  trend: Array<{
    month: string;
    carrier: string;
    shipments: number;
  }>;
}

// Returns Analysis Report Response
interface ReturnsAnalysisReport {
  summary: {
    total_returns: number;
    total_value: number;
    return_rate: number; // percentage of shipments
    avg_return_value: number;
  };
  by_reason: Array<{
    reason_code: string;
    reason_label: string;
    count: number;
    percentage: number;
    value: number;
  }>;
  by_product: Array<{
    product_id: string;
    product_name: string;
    sku: string;
    returns: number;
    value: number;
    return_rate: number;
  }>;
  by_customer: Array<{
    customer_id: string;
    customer_name: string;
    returns: number;
    value: number;
    return_rate: number;
  }>;
  trend: Array<{
    month: string;
    returns: number;
    value: number;
    return_rate: number;
  }>;
  disposition: Array<{
    disposition: string; // "restocked", "scrapped", "quality_hold"
    count: number;
    percentage: number;
    value: number;
  }>;
}
```

### Database Queries

```sql
-- Shipping Volume: Daily shipments
SELECT
  DATE(shipped_at) as ship_date,
  COUNT(*) as shipments,
  SUM(total_weight) as weight_kg,
  SUM(total_boxes) as boxes
FROM shipments
WHERE org_id = :org_id
  AND shipped_at >= :date_from
  AND shipped_at <= :date_to
  AND status = 'shipped'
GROUP BY DATE(shipped_at)
ORDER BY ship_date;

-- Shipping Volume: By Carrier
SELECT
  carrier,
  COUNT(*) as shipments,
  ROUND(COUNT(*) * 100.0 / SUM(COUNT(*)) OVER(), 2) as percentage
FROM shipments
WHERE org_id = :org_id
  AND shipped_at >= :date_from
  AND shipped_at <= :date_to
  AND status = 'shipped'
GROUP BY carrier
ORDER BY shipments DESC;

-- Order Fulfillment: Overall metrics
SELECT
  COUNT(*) as total_orders,
  COUNT(*) FILTER (WHERE status = 'shipped' OR status = 'delivered') as shipped_orders,
  COUNT(*) FILTER (WHERE status = 'cancelled') as cancelled_orders,
  COUNT(*) FILTER (
    WHERE (status = 'shipped' OR status = 'delivered')
    AND NOT EXISTS (
      SELECT 1 FROM sales_order_lines sol
      WHERE sol.sales_order_id = so.id
      AND sol.quantity_shipped < sol.quantity_ordered
    )
  ) as shipped_complete
FROM sales_orders so
WHERE org_id = :org_id
  AND order_date >= :date_from
  AND order_date <= :date_to;

-- Pick Performance: Picker leaderboard
SELECT
  u.id as picker_id,
  u.full_name as picker_name,
  COUNT(pll.id) as total_picks,
  SUM(pll.quantity_picked) as units_picked,
  COUNT(pll.id) FILTER (WHERE pll.status = 'short') as short_picks,
  EXTRACT(EPOCH FROM SUM(pll.picked_at - pl.started_at)) / 3600 as hours_worked,
  ROUND(COUNT(pll.id)::numeric / NULLIF(EXTRACT(EPOCH FROM SUM(pll.picked_at - pl.started_at)) / 3600, 0), 2) as picks_per_hour
FROM pick_list_lines pll
JOIN pick_lists pl ON pll.pick_list_id = pl.id
JOIN users u ON pll.picked_by = u.id
WHERE pl.org_id = :org_id
  AND pll.picked_at >= :date_from
  AND pll.picked_at <= :date_to
  AND pll.status IN ('picked', 'short')
GROUP BY u.id, u.full_name
ORDER BY picks_per_hour DESC
LIMIT 10;

-- On-Time Delivery: OTD metrics
SELECT
  COUNT(*) as total_with_date,
  COUNT(*) FILTER (WHERE shipped_at::date <= promised_ship_date) as on_time,
  COUNT(*) FILTER (WHERE shipped_at::date > promised_ship_date) as late,
  ROUND(
    COUNT(*) FILTER (WHERE shipped_at::date <= promised_ship_date) * 100.0 / NULLIF(COUNT(*), 0),
    2
  ) as otd_pct,
  AVG(
    CASE WHEN shipped_at::date > promised_ship_date
    THEN EXTRACT(DAY FROM shipped_at::date - promised_ship_date)
    ELSE NULL END
  ) as avg_days_late
FROM sales_orders
WHERE org_id = :org_id
  AND promised_ship_date IS NOT NULL
  AND status IN ('shipped', 'delivered')
  AND shipped_at >= :date_from
  AND shipped_at <= :date_to;

-- Backorders: Aging analysis
WITH backorder_lines AS (
  SELECT
    sol.id,
    sol.product_id,
    sol.sales_order_id,
    sol.quantity_ordered - sol.quantity_allocated as qty_backordered,
    (sol.quantity_ordered - sol.quantity_allocated) * sol.unit_price as value,
    CURRENT_DATE - so.order_date as age_days
  FROM sales_order_lines sol
  JOIN sales_orders so ON sol.sales_order_id = so.id
  WHERE so.org_id = :org_id
    AND sol.quantity_allocated < sol.quantity_ordered
    AND so.status NOT IN ('cancelled', 'shipped', 'delivered')
)
SELECT
  CASE
    WHEN age_days <= 7 THEN '0-7 days'
    WHEN age_days <= 14 THEN '8-14 days'
    WHEN age_days <= 30 THEN '15-30 days'
    ELSE '31+ days'
  END as bucket,
  COUNT(*) as lines,
  SUM(value) as total_value
FROM backorder_lines
GROUP BY bucket
ORDER BY MIN(age_days);

-- Carrier Performance: Comparison
SELECT
  carrier,
  COUNT(*) as shipments,
  ROUND(
    COUNT(*) FILTER (WHERE delivered_at IS NOT NULL AND delivered_at::date <= required_delivery_date) * 100.0 / NULLIF(COUNT(*), 0),
    2
  ) as otd_pct,
  AVG(EXTRACT(DAY FROM delivered_at - shipped_at)) as avg_transit_days,
  AVG(shipping_cost) as avg_cost,
  SUM(shipping_cost) as total_cost
FROM shipments s
JOIN sales_orders so ON s.sales_order_id = so.id
WHERE s.org_id = :org_id
  AND s.shipped_at >= :date_from
  AND s.shipped_at <= :date_to
  AND s.status = 'shipped'
GROUP BY carrier
ORDER BY shipments DESC;

-- Returns Analysis: By reason code
SELECT
  reason_code,
  CASE reason_code
    WHEN 'damaged' THEN 'Damaged in Transit'
    WHEN 'expired' THEN 'Expired Product'
    WHEN 'wrong_product' THEN 'Wrong Product Shipped'
    WHEN 'quality_issue' THEN 'Quality Issue'
    ELSE 'Other'
  END as reason_label,
  COUNT(*) as count,
  SUM(rl.quantity_received * p.default_price) as value
FROM rma_requests r
JOIN rma_lines rl ON r.id = rl.rma_request_id
JOIN products p ON rl.product_id = p.id
WHERE r.org_id = :org_id
  AND r.created_at >= :date_from
  AND r.created_at <= :date_to
GROUP BY reason_code
ORDER BY count DESC;
```

### Services

**Location:** `lib/services/shipping-reports-service.ts`

```typescript
export class ShippingReportsService {
  // Volume Report
  static async getVolumeReport(
    orgId: string,
    dateFrom: Date,
    dateTo: Date,
    aggregation: 'daily' | 'weekly' | 'monthly'
  ): Promise<ShippingVolumeReport>;

  // Fulfillment Report
  static async getFulfillmentReport(
    orgId: string,
    dateFrom: Date,
    dateTo: Date
  ): Promise<OrderFulfillmentReport>;

  // Pick Performance Report
  static async getPickPerformanceReport(
    orgId: string,
    dateFrom: Date,
    dateTo: Date,
    pickerId?: string,
    zoneId?: string
  ): Promise<PickPerformanceReport>;

  // On-Time Delivery Report
  static async getOTDReport(
    orgId: string,
    dateFrom: Date,
    dateTo: Date
  ): Promise<OnTimeDeliveryReport>;

  // Backorder Report
  static async getBackorderReport(
    orgId: string,
    dateFrom: Date,
    dateTo: Date
  ): Promise<BackorderReport>;

  // Carrier Performance Report
  static async getCarrierPerformanceReport(
    orgId: string,
    dateFrom: Date,
    dateTo: Date,
    carrier?: string
  ): Promise<CarrierPerformanceReport>;

  // Returns Analysis Report
  static async getReturnsReport(
    orgId: string,
    dateFrom: Date,
    dateTo: Date
  ): Promise<ReturnsAnalysisReport>;

  // Export helpers
  static async exportToCSV(
    reportType: ReportType,
    data: any,
    filename: string
  ): Promise<Buffer>;

  static async exportToExcel(
    reportType: ReportType,
    data: any,
    filename: string
  ): Promise<Buffer>;

  // Cache helpers
  private static getCacheKey(
    reportType: string,
    orgId: string,
    params: Record<string, any>
  ): string;

  private static readonly CACHE_TTL = 300; // 5 minutes
}
```

### Zod Validation Schemas

**Location:** `lib/validation/shipping-reports.ts`

```typescript
import { z } from 'zod';

export const reportDateRangeSchema = z.object({
  date_from: z.string().datetime().optional(),
  date_to: z.string().datetime().optional(),
}).refine((data) => {
  if (data.date_from && data.date_to) {
    const from = new Date(data.date_from);
    const to = new Date(data.date_to);
    const diffDays = (to.getTime() - from.getTime()) / (1000 * 60 * 60 * 24);
    return diffDays <= 730; // Max 2 years
  }
  return true;
}, {
  message: "Date range cannot exceed 2 years"
});

export const volumeReportQuerySchema = reportDateRangeSchema.extend({
  aggregation: z.enum(['daily', 'weekly', 'monthly']).default('daily'),
});

export const pickPerformanceQuerySchema = reportDateRangeSchema.extend({
  picker_id: z.string().uuid().optional(),
  zone_id: z.string().uuid().optional(),
});

export const carrierReportQuerySchema = reportDateRangeSchema.extend({
  carrier: z.string().optional(),
});

export const exportQuerySchema = z.object({
  format: z.enum(['csv', 'xlsx']).default('csv'),
});
```

---

## Frontend Components

### Pages

```
apps/frontend/app/(authenticated)/shipping/reports/
  page.tsx                              -- Reports index/overview
  volume/page.tsx                       -- Shipping Volume Report
  fulfillment/page.tsx                  -- Order Fulfillment Report
  pick-performance/page.tsx             -- Pick Performance Report
  otd/page.tsx                          -- On-Time Delivery Report
  backorders/page.tsx                   -- Backorder Report
  carrier-performance/page.tsx          -- Carrier Performance Report
  returns/page.tsx                      -- Returns Analysis Report
```

### Components

```
apps/frontend/components/shipping/reports/
  ReportLayout.tsx                      -- Common layout with date filter, export
  ReportDateRangePicker.tsx             -- Date range filter
  ReportExportButton.tsx                -- CSV/Excel export dropdown
  ReportRefreshButton.tsx               -- Manual refresh with cache bypass

  # Volume Report
  VolumeReportSummary.tsx               -- KPI cards
  VolumeReportChart.tsx                 -- Line chart with aggregation toggle
  VolumeByCarrierChart.tsx              -- Stacked bar chart
  VolumeByCustomerTable.tsx             -- Top customers table

  # Fulfillment Report
  FulfillmentGauge.tsx                  -- Target vs actual gauge
  FulfillmentTrendChart.tsx             -- Daily fulfillment trend
  FulfillmentByStatusPie.tsx            -- Pie chart with drill-down

  # Pick Performance Report
  PickPerformanceSummary.tsx            -- KPI cards
  PickerLeaderboard.tsx                 -- Sortable table
  PickTrendChart.tsx                    -- Picks/hour trend
  ZonePerformanceTable.tsx              -- Zone breakdown

  # On-Time Delivery Report
  OTDSummary.tsx                        -- KPI cards
  OTDTrendChart.tsx                     -- OTD % trend
  LateDistributionHistogram.tsx         -- Days late histogram
  OTDByCustomerTable.tsx                -- Worst performers
  OTDByCarrierChart.tsx                 -- Carrier comparison

  # Backorder Report
  BackorderSummary.tsx                  -- KPI cards
  BackorderAgingChart.tsx               -- Stacked bar chart
  BackorderByProductTable.tsx           -- Product breakdown
  BackorderByCustomerTable.tsx          -- Customer breakdown
  BackorderTrendChart.tsx               -- Trend line

  # Carrier Performance Report
  CarrierComparisonTable.tsx            -- All carriers comparison
  CarrierOTDChart.tsx                   -- OTD bar chart
  CarrierCostChart.tsx                  -- Cost bar chart
  CarrierTransitBoxPlot.tsx             -- Transit time distribution
  CarrierTrendChart.tsx                 -- Monthly trend stacked area

  # Returns Report
  ReturnsSummary.tsx                    -- KPI cards
  ReturnsByReasonPie.tsx                -- Reason code breakdown
  ReturnsByProductTable.tsx             -- Top returned products
  ReturnsByCustomerTable.tsx            -- Top returners
  ReturnsTrendChart.tsx                 -- Monthly trend
  ReturnsDispositionChart.tsx           -- Disposition breakdown
```

### Chart Library

**Recommended:** Recharts (consistent with dashboard story 07.15)

```tsx
import {
  LineChart, Line,
  BarChart, Bar,
  PieChart, Pie, Cell,
  AreaChart, Area,
  XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer
} from 'recharts';
```

---

## Performance Optimization

### Database Indexes

```sql
-- Report-specific indexes for performance
CREATE INDEX idx_shipments_org_shipped_status
  ON shipments(org_id, shipped_at, status);

CREATE INDEX idx_sales_orders_org_date_status
  ON sales_orders(org_id, order_date, status);

CREATE INDEX idx_sales_orders_org_promised_shipped
  ON sales_orders(org_id, promised_ship_date, shipped_at);

CREATE INDEX idx_pick_list_lines_picked
  ON pick_list_lines(picked_at, picked_by, status);

CREATE INDEX idx_rma_requests_org_created
  ON rma_requests(org_id, created_at, reason_code);

CREATE INDEX idx_sales_order_lines_allocation
  ON sales_order_lines(sales_order_id)
  WHERE quantity_allocated < quantity_ordered;
```

### Caching Strategy

```typescript
// Cache key format
const cacheKey = `reports:${reportType}:${orgId}:${hashParams(params)}`;

// TTL: 5 minutes
const CACHE_TTL = 300;

// Cache with fallback
async function getReportWithCache<T>(
  cacheKey: string,
  fetchFn: () => Promise<T>,
  bypassCache: boolean = false
): Promise<T> {
  if (!bypassCache) {
    const cached = await redis.get(cacheKey);
    if (cached) return JSON.parse(cached);
  }

  const data = await fetchFn();
  await redis.setex(cacheKey, CACHE_TTL, JSON.stringify(data));
  return data;
}
```

### Performance Targets

| Metric | Target |
|--------|--------|
| Report page load | < 3s (p95) |
| API response (30 days) | < 1s |
| API response (1 year) | < 3s |
| Export CSV (10K rows) | < 5s |
| Export Excel (10K rows) | < 10s |
| Cache hit rate | > 80% |

---

## Test Cases

### Unit Tests

**shipping-reports-service.test.ts**
```typescript
describe('ShippingReportsService', () => {
  describe('getVolumeReport', () => {
    it('aggregates daily shipments correctly');
    it('aggregates weekly shipments correctly');
    it('aggregates monthly shipments correctly');
    it('calculates carrier breakdown');
    it('returns empty data for no shipments');
  });

  describe('getFulfillmentReport', () => {
    it('calculates overall fulfillment rate');
    it('calculates complete vs partial rates');
    it('returns trend data by day');
  });

  describe('getPickPerformanceReport', () => {
    it('calculates picks per hour correctly');
    it('calculates accuracy percentage');
    it('builds picker leaderboard');
    it('filters by picker when specified');
  });

  describe('getOTDReport', () => {
    it('calculates OTD percentage');
    it('handles orders without promised date');
    it('builds late distribution histogram');
  });

  describe('getBackorderReport', () => {
    it('identifies backorder lines correctly');
    it('calculates aging buckets');
    it('excludes shipped/cancelled orders');
  });

  describe('getCarrierPerformanceReport', () => {
    it('compares all carriers');
    it('calculates transit times');
    it('handles missing delivery dates');
  });

  describe('getReturnsReport', () => {
    it('groups by reason code');
    it('calculates return rate');
    it('handles disposition breakdown');
  });
});
```

### Integration Tests

**shipping-reports-api.test.ts**
```typescript
describe('Shipping Reports API', () => {
  describe('GET /api/shipping/reports/volume', () => {
    it('returns volume data with valid date range');
    it('respects aggregation parameter');
    it('enforces org isolation');
    it('returns cached data when available');
  });

  describe('GET /api/shipping/reports/fulfillment', () => {
    it('returns fulfillment metrics');
    it('calculates rates correctly');
  });

  // Similar tests for other report endpoints...

  describe('Export endpoints', () => {
    it('exports CSV with correct headers');
    it('exports Excel with multiple sheets');
    it('respects date range in export');
  });
});
```

### E2E Tests

**shipping-reports.spec.ts**
```typescript
describe('Shipping Reports', () => {
  it('navigates to reports index');
  it('loads volume report with default date range');
  it('changes date range and refreshes data');
  it('exports CSV successfully');
  it('drill-down navigates to filtered list');
  it('displays empty state for no data');
});
```

---

## Deliverables

### Backend
- [ ] 7 API endpoints for reports
- [ ] 7 export endpoints (CSV/Excel)
- [ ] ShippingReportsService with all report methods
- [ ] Zod validation schemas
- [ ] Database indexes for report queries
- [ ] Redis caching integration

### Frontend
- [ ] Reports index page with navigation
- [ ] 7 individual report pages
- [ ] Shared ReportLayout component
- [ ] Date range picker component
- [ ] Export button component
- [ ] All chart components using Recharts
- [ ] Loading states and skeletons
- [ ] Empty states for no data
- [ ] Responsive design

### Testing
- [ ] Unit tests (> 80% coverage for service)
- [ ] Integration tests for all API endpoints
- [ ] E2E tests for report navigation and export

---

## Definition of Done

- [ ] All 7 report types display correct data
- [ ] Date range filtering works for all presets and custom
- [ ] Aggregation toggle (daily/weekly/monthly) works for volume report
- [ ] All charts render correctly with data
- [ ] Drill-down navigation works from charts to filtered lists
- [ ] CSV export downloads with correct data
- [ ] Excel export downloads with formatted sheets
- [ ] Print layout renders correctly
- [ ] Cache returns data within 200ms on cache hit
- [ ] Fresh data loads within 3 seconds (1-year range)
- [ ] RLS enforces org isolation (verified in tests)
- [ ] Responsive design works on mobile/tablet/desktop
- [ ] Empty states display when no data exists
- [ ] Error handling works for API failures
- [ ] Unit tests pass (> 80% coverage)
- [ ] Integration tests pass
- [ ] E2E tests pass
- [ ] Code reviewed and approved

---

## Future Phases (Not in This Story)

### Phase 3 Enhancements
- Scheduled report emails (daily/weekly digest)
- Custom report builder (drag-and-drop fields)
- Predictive analytics (forecasted volume, backorder risk)
- Cost optimization recommendations
- Real-time streaming analytics
- Dashboard embedding (external BI tool integration)
- Advanced filtering (multi-select products, customers, carriers)
- Report sharing (shareable links, team views)
- Comparison mode (YoY, MoM analysis)
- Custom KPI targets per organization

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-01-15 | Initial story creation | ARCHITECT-AGENT |
