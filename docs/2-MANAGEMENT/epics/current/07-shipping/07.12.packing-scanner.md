# 07.12 - Packing Scanner UI (Mobile)

| Field | Value |
|-------|-------|
| **Story ID** | 07.12 |
| **Epic** | 07 - Shipping |
| **Status** | Ready |
| **Phase** | Phase 1C (Packing + Shipment) |
| **Priority** | P1 (Enhanced) |
| **Complexity** | M (Medium) |
| **Estimate** | 3-4 days |
| **Type** | Backend + Frontend (Mobile) |
| **Model** | SONNET |

---

## PRD References

| FR ID | Requirement | Priority | Coverage |
|-------|-------------|----------|----------|
| FR-7.36 | Pack Confirmation (Scanner) | P0 | Full |
| FR-7.37 | Multi-Box Shipments | P1 | Full |
| FR-7.42 | Weight/Dimensions Capture | P1 | Full |
| FR-7.28 | Allergen Separation Alerts | P0 | Integrated |
| FR-7.34 | Packing Station Workflow | P0 | Scanner version |

**Primary PRD:** `docs/1-BASELINE/product/modules/shipping.md` (Section 5.2, lines 618-645)
**Architecture:** `docs/1-BASELINE/architecture/modules/shipping.md` (lines 507-517, 630-641)

---

## MVP Scope

### In Scope (This Story)

1. **Scanner Pack Page (`/scanner/shipping/pack`)**
   - Full-screen mobile-optimized layout
   - Step-by-step packing workflow
   - Touch-optimized UI with large buttons (min 48x48dp)
   - High contrast colors for warehouse lighting conditions
   - Portrait and landscape orientation support

2. **Packing Workflow**
   - Step 1: Scan/select shipment barcode or select from list
   - Step 2: Create or select active box
   - Step 3: Scan LP barcode to add item to box
   - Step 4: Auto-fill product info from LP
   - Step 5: Confirm quantity (with number pad)
   - Step 6: Repeat until box full
   - Step 7: Close box (capture weight if scale connected)
   - Step 8: Start new box or complete shipment

3. **Barcode Scanning Integration**
   - Shipment/SO barcode scanning to select order
   - License Plate barcode scanning to add items
   - Camera-based scanning using device camera
   - Manual barcode entry fallback

4. **Number Pad for Quantity/Weight Entry**
   - Large touch-friendly number pad
   - Decimal support for fractional quantities
   - Quick increment/decrement buttons (+1, +10, -1, -10)
   - Clear and backspace buttons
   - Weight entry mode (kg with 2 decimal places)

5. **Audio/Visual Feedback System**
   - Success tone on valid scan (200ms, high pitch)
   - Error beep on invalid scan (300ms, low pitch)
   - Confirmation chime on box closed (500ms)
   - Alert tone on allergen warning (400ms)
   - Visual indicators: green checkmarks, red X, yellow warnings
   - Haptic feedback on mobile devices (if supported)

6. **Box Management Features**
   - Create new box button
   - View current box contents (product count, estimated weight)
   - Close box with final weight entry
   - Box summary: items count, total weight
   - Box X of Y indicator

7. **Allergen Warning System**
   - Display allergen banner if customer has restrictions
   - Highlight allergen products in yellow
   - Warning sound when scanning allergen product
   - Confirmation required to pack allergen products

8. **API Endpoints for Scanner Packing**
   - `POST /api/shipping/scanner/pack` - Add item to box
   - `POST /api/shipping/scanner/pack/box/create` - Create new box
   - `POST /api/shipping/scanner/pack/box/close` - Close box with weight
   - `GET /api/shipping/scanner/pack/shipments` - List pending shipments
   - `GET /api/shipping/scanner/pack/lookup/:barcode` - Lookup shipment/LP

9. **Service Layer**
   - `PackingScannerService.addItemToBox()` - Add LP to active box
   - `PackingScannerService.createBox()` - Create new shipment box
   - `PackingScannerService.closeBox()` - Close box with weight
   - `PackingScannerService.getPendingShipments()` - Query packable shipments
   - Integration with `ShipmentService` (Story 07.11)

10. **Zod Validation Schemas**
    - Pack item request schema
    - Create/close box schema
    - Shipment lookup schema

### Out of Scope (Other Stories)

| Feature | Deferred To | Reason |
|---------|-------------|--------|
| SSCC Label Printing | 07.13 | Separate label generation story |
| Packing Slip Printing | 07.13 | Separate document generation |
| BOL Generation | 07.13 | Separate document generation |
| Weight Scale Integration | Phase 2 | Hardware integration |
| Offline Queue Support | Phase 3 | Requires sync logic |
| Carrier Label Printing | 07.24-07.26 | Carrier integration stories |

---

## Goal

Enable warehouse operators to pack shipments using handheld scanner devices with a mobile-optimized workflow that includes barcode scanning, box management, weight capture, allergen warnings, and real-time feedback.

---

## User Story

As a **Warehouse Packer using a handheld scanner**, I want to **pack sales orders by scanning license plates into boxes with audio confirmation and allergen warnings** so that **I can efficiently pack shipments on the warehouse floor without needing a desktop computer**.

---

## Dependencies

| Dependency | Story/Epic | Type | Status | Notes |
|------------|------------|------|--------|-------|
| 07.11 | Packing Station Workflow | HARD | Ready | Uses shipment, box, and contents tables |
| 07.10 | Pick Confirmation Scanner | SOFT | Ready | Reuses scanner patterns |
| 07.8 | Pick List Generation | HARD | Ready | Picked LPs available for packing |
| 07.2 | Sales Orders Core | HARD | Ready | SO data for shipment context |
| 02.3 | Allergens Management | HARD | Ready | Customer allergen restrictions |
| 05.1 | LP Table + CRUD | HARD | Ready | License plate lookup |
| 01.9 | Locations CRUD | SOFT | Ready | Staging location context |

**Dependents (What This Unblocks):**
- 07.13 (SSCC + Labels + BOL) - Uses packed shipment data
- 07.14 (Shipment + Ship Confirm) - Confirms packed shipments

---

## Acceptance Criteria (Given/When/Then)

### AC-1: Scanner Pack Page Layout (FR-7.36)

```gherkin
Scenario: Scanner pack page renders with mobile-optimized layout
  Given scanner user is authenticated
  When user navigates to /scanner/shipping/pack
  Then full-screen layout displays without browser chrome
  And header shows "Pack Shipment" title with back button
  And current step indicator shows progress
  And main content area fills available space
  And action buttons anchored to bottom of screen
  And all touch targets are minimum 48x48 pixels

Scenario: Page adapts to device orientation
  Given user on /scanner/shipping/pack
  When device rotates to landscape
  Then layout adjusts to horizontal orientation
  And barcode scan area remains easily accessible
  And number pad remains usable

Scenario: Page handles safe area insets
  Given user on device with notch/rounded corners
  Then content respects safe area insets
  And no UI elements obscured by device hardware
```

### AC-2: Step 1 - Select Shipment (FR-7.36)

```gherkin
Scenario: Display pending shipments for packing
  Given user on Step 1 "Select Shipment"
  When step loads
  Then list of packable shipments displayed
  And each shipment shows: SO Number, Customer, Picked Lines, Status
  And shipments filtered to user's assigned warehouse
  And shipments with status = 'pending' or 'packing'
  And list sorted by promised_ship_date ASC (soonest first)
  And "Scan Shipment Barcode" button prominently displayed

Scenario: Scan SO barcode to select shipment
  Given user on Step 1
  When user taps "Scan Barcode" button
  Then camera barcode scanner activates
  And scan frame displays with guide overlay
  And scanning instruction text shows "Scan Sales Order barcode"

Scenario: Valid SO barcode scanned
  Given camera scanner active
  When SO barcode "SO-2025-00001" scanned
  Then system validates barcode against pending shipments in < 500ms
  And success tone plays (200ms, high pitch)
  And green checkmark animation displays
  And workflow advances to Step 2 (Box Management)

Scenario: Invalid SO barcode scanned
  Given camera scanner active
  When unrecognized barcode scanned
  Then error beep plays (300ms, low pitch)
  And red X animation displays
  And error message shows "Shipment not found: {barcode}"
  And scanner remains active for retry

Scenario: SO not packable (wrong status)
  Given camera scanner active
  When SO barcode scanned for shipped order
  Then error beep plays
  And message shows "Order cannot be packed (status: shipped)"
  And scanner remains active for retry

Scenario: Manual shipment selection from list
  Given pending shipments displayed in list
  When user taps shipment row
  Then shipment selected with visual highlight
  And workflow advances to Step 2

Scenario: Display allergen warning on selection
  Given shipment for customer with allergen restrictions
  When shipment selected
  Then yellow banner displays "ALLERGEN ALERT: Customer restricted"
  And allergen list shows in banner
  And alert tone plays (400ms)
  And warning persists throughout packing workflow
```

### AC-3: Step 2 - Box Management (FR-7.37)

```gherkin
Scenario: Display shipment summary and box status
  Given shipment "SO-2025-00001" selected
  When Step 2 loads
  Then shipment header displays:
    | Field | Value |
    | SO Number | SO-2025-00001 |
    | Customer | Customer name |
    | Lines to Pack | 3 of 5 lines packed |
    | Status | packing |
  And active box indicator shows "Box 1 of 1"
  And box contents summary shows items count and weight
  And "Scan Item" button prominently displayed
  And "Close Box" button enabled if box has items

Scenario: Create first box automatically
  Given shipment selected with no boxes
  When Step 2 loads
  Then Box 1 auto-created
  And box status = 'open'
  And box_number = 1
  And ready to scan items

Scenario: Create additional box
  Given Box 1 has items
  When user taps "Create New Box"
  Then confirmation prompt "Close current box first?"
  When user confirms "Create Without Closing"
  Then Box 2 created
  And box_number = 2
  And Box 2 now active
  And Box 1 remains open
  And "Active Box" indicator updates to "Box 2 of 2"

Scenario: Switch between open boxes
  Given multiple open boxes exist
  When user taps box selector dropdown
  Then list of open boxes displayed with item counts
  When user selects different box
  Then active box switches
  And scan workflow routes to selected box
```

### AC-4: Step 3 - Scan and Add Item (FR-7.36)

```gherkin
Scenario: Scan LP barcode to add to box
  Given active box displayed
  When user taps "Scan Item"
  Then camera scanner activates for LP barcode
  And scan guide shows "Scan License Plate"

Scenario: Valid LP scanned - auto-fill details
  Given camera scanner active
  When LP barcode "LP00000123" scanned
  Then system looks up LP details in < 200ms
  And validates LP is allocated to this shipment
  And product details display:
    | Field | Value |
    | Product | Product name |
    | Lot Number | BATCH-001 |
    | Available Qty | 100 KG |
    | UoM | KG |
  And quantity field defaults to available qty
  And success tone plays
  And workflow advances to quantity entry

Scenario: LP not allocated to shipment
  Given camera scanner active
  When LP scanned not allocated to this SO
  Then error beep plays
  And message shows "LP not allocated to this order"
  And scanner remains active for retry

Scenario: LP already packed in this shipment
  Given LP previously added to a box
  When same LP scanned again
  Then warning beep plays
  And message shows "LP already packed in Box {box_number}"
  And "Pack Again?" confirmation displays
  When user confirms
  Then LP can be split-packed to current box

Scenario: Display allergen warning for product
  Given LP contains product with allergens
  And customer has matching allergen restriction
  When LP scanned
  Then yellow allergen banner flashes
  And alert tone plays (400ms)
  And product highlighted in yellow
  And "ALLERGEN" badge displays on product card
  And confirmation required: "Pack allergen product?"
```

### AC-5: Step 4 - Confirm Quantity (FR-7.36)

```gherkin
Scenario: Quantity entry with number pad
  Given LP details displayed
  And quantity field focused with default value
  When user interacts with number pad
  Then number pad shows digits 0-9
  And decimal point button available
  And backspace button available
  And clear button available
  And +1, +10, -1, -10 quick buttons available
  And all buttons minimum 48x48 pixels

Scenario: Quick quantity adjustment
  Given quantity = 100
  When user taps "+10" button
  Then quantity = 110
  When user taps "-1" button
  Then quantity = 109

Scenario: Quantity exceeds available
  Given LP available qty = 100
  When user enters qty = 120
  Then inline warning displays "Exceeds available by 20"
  And field highlighted in red
  And "Confirm" button disabled
  And user must adjust quantity

Scenario: Confirm pack item
  Given valid quantity entered
  When user taps "Add to Box"
  Then POST /api/shipping/scanner/pack called
  And shipment_box_contents record created
  And success tone plays
  And green checkmark animation
  And box contents summary updates
  And workflow returns to "Scan Item" for next item
  And response time < 500ms

Scenario: View current box contents
  Given items added to box
  When user taps "View Contents"
  Then box contents list displays:
    | Product | Lot | Qty | UoM |
  And items sorted by pack order
  And total item count shown
  And estimated total weight shown
  And "Remove Item" action available
```

### AC-6: Step 5 - Close Box (FR-7.42)

```gherkin
Scenario: Close box without weight
  Given box has items
  When user taps "Close Box"
  Then confirmation prompt "Close Box 1?"
  And "Enter weight" field displayed (optional)
  When user confirms without weight
  Then box status = 'closed'
  And box removed from active selection
  And success tone plays
  And message "Box 1 closed successfully"

Scenario: Close box with weight capture
  Given box has items
  When user taps "Close Box"
  Then weight entry modal displays
  And number pad in weight mode (decimal, 2 places)
  And unit shows "kg"
  When user enters weight "25.50"
  And taps "Confirm"
  Then box.weight = 25.50
  And box status = 'closed'
  And success confirmation displays

Scenario: Weight exceeds carrier limit warning
  Given warehouse_settings.max_box_weight_kg = 30
  When user enters weight = 35
  Then yellow warning displays "Weight exceeds 30kg limit"
  And "Confirm Anyway" option available
  And warning logged

Scenario: Auto-create next box after close
  Given Box 1 closed
  And shipment has unpacked lines
  When close confirmation displays
  Then "Create Next Box?" prompt shown
  When user confirms
  Then Box 2 auto-created
  And Box 2 now active
  And ready to scan next items
```

### AC-7: Step 6 - Complete or Continue (FR-7.36)

```gherkin
Scenario: Complete shipment when all packed
  Given all SO lines fully packed
  And all boxes closed
  When user taps "Complete Shipment"
  Then confirmation prompt "Mark shipment as packed?"
  When user confirms
  Then shipment status = 'packed'
  And packed_at timestamp set
  And packed_by = current user
  And success chime plays (500ms)
  And success screen displays:
    | Field | Value |
    | Shipment | SO-2025-00001 |
    | Total Boxes | 3 |
    | Total Weight | 75.5 KG |
    | Status | Packed |

Scenario: Continue packing same order
  Given boxes closed but lines remaining
  When user taps "Continue Packing"
  Then new box auto-created
  And workflow returns to scan item
  And remaining lines displayed

Scenario: Pack different order
  Given success screen displayed
  When user taps "New Order"
  Then workflow returns to Step 1 (Select Shipment)
  And shipment list refreshes

Scenario: Return to dashboard
  Given success screen displayed
  When user taps "Done"
  Then navigate to scanner dashboard
  And activity logged
```

### AC-8: Audio Feedback System (FR-NFR)

```gherkin
Scenario: Audio feedback settings
  Given warehouse_settings.scanner_sound_feedback = true
  Then all audio feedback enabled
  When warehouse_settings.scanner_sound_feedback = false
  Then audio muted (visual only)

Scenario: Success tone plays on valid scan
  Given audio enabled
  When valid barcode scanned (SO, LP)
  Then success tone plays:
    - Frequency: 880Hz (high pitch)
    - Duration: 200ms
    - Volume: Device volume level

Scenario: Error beep plays on invalid scan
  Given audio enabled
  When invalid barcode scanned
  Then error beep plays:
    - Frequency: 220Hz (low pitch)
    - Duration: 300ms
    - Volume: Device volume level

Scenario: Confirmation chime on box closed
  Given audio enabled
  When box closed successfully
  Then confirmation chime plays:
    - Dual tone: 660Hz + 880Hz
    - Duration: 500ms
    - Volume: Device volume level

Scenario: Alert tone on allergen warning
  Given audio enabled
  And customer has allergen restrictions
  When allergen product scanned
  Then alert tone plays:
    - Frequency: 440Hz (mid pitch)
    - Duration: 400ms
    - Pattern: Repeating 2x
    - Volume: Device volume level

Scenario: Haptic feedback on mobile
  Given device supports haptic feedback
  When action completed (scan, add item, close box)
  Then haptic vibration triggers
  And vibration pattern matches feedback type:
    - Success: short buzz (50ms)
    - Error: double buzz (50ms, 50ms gap, 50ms)
    - Confirm: long buzz (100ms)
    - Alert: triple buzz (allergen warning)
```

### AC-9: Visual Feedback System (FR-NFR)

```gherkin
Scenario: Success visual indicator
  When valid action completed
  Then green checkmark animation displays
  And animation duration = 500ms
  And checkmark size = 64x64 pixels minimum
  And background flashes green briefly

Scenario: Error visual indicator
  When invalid action occurs
  Then red X animation displays
  And animation duration = 500ms
  And X size = 64x64 pixels minimum
  And background flashes red briefly

Scenario: Allergen warning visual
  When allergen product detected
  Then yellow banner displays at top
  And banner text: "ALLERGEN ALERT: [allergen names]"
  And product card has yellow border
  And "ALLERGEN" badge on product
  And banner persists until item packed or dismissed

Scenario: Box contents summary indicator
  Given active box with items
  Then summary badge displays:
    - "3 items, ~25 kg"
    - Updates in real-time as items added
    - Green background
    - Prominent placement

Scenario: Loading indicator during API calls
  When API request in progress
  Then loading spinner displays
  And spinner size = 48x48 pixels
  And UI interaction disabled during load
  And timeout after 10 seconds with error

Scenario: High contrast colors for warehouse lighting
  Given warehouse lighting conditions may be poor
  Then UI uses high contrast color scheme:
    - Primary actions: #22C55E (bright green)
    - Errors: #EF4444 (bright red)
    - Warnings: #F59E0B (bright orange/yellow)
    - Allergen: #FDE047 (bright yellow)
    - Text: #111827 (near black) on #FFFFFF (white)
    - Backgrounds: High contrast for readability
```

### AC-10: API Endpoint - Pack Item (FR-7.36)

```gherkin
Scenario: POST /api/shipping/scanner/pack - Happy path
  When POST /api/shipping/scanner/pack with:
    {
      "shipment_id": "{shipment_uuid}",
      "box_id": "{box_uuid}",
      "license_plate_id": "{lp_uuid}",
      "quantity": 100,
      "so_line_id": "{line_uuid}"
    }
  Then response status = 201 Created
  And response includes:
    {
      "box_content": { "id": "...", "quantity": 100 },
      "box_summary": { "item_count": 3, "total_weight_est": 25.5 },
      "so_line_status": { "packed_qty": 100, "remaining": 0 }
    }
  And response time < 500ms

Scenario: POST /api/shipping/scanner/pack - LP not allocated
  When POST with LP not allocated to shipment
  Then response status = 400 Bad Request
  And error message = "License plate not allocated to this shipment"

Scenario: POST /api/shipping/scanner/pack - Quantity exceeds available
  When POST with qty exceeding LP available qty
  Then response status = 400 Bad Request
  And error includes available_qty and requested_qty

Scenario: POST /api/shipping/scanner/pack - Shipment not found
  When POST with invalid shipment_id
  Then response status = 404 Not Found
  And error message = "Shipment not found"
```

### AC-11: API Endpoint - Create/Close Box (FR-7.37, FR-7.42)

```gherkin
Scenario: POST /api/shipping/scanner/pack/box/create
  When POST /api/shipping/scanner/pack/box/create with:
    {
      "shipment_id": "{shipment_uuid}"
    }
  Then response status = 201 Created
  And response includes:
    {
      "box": {
        "id": "...",
        "box_number": 2,
        "status": "open"
      }
    }
  And box_number auto-increments

Scenario: POST /api/shipping/scanner/pack/box/close
  When POST /api/shipping/scanner/pack/box/close with:
    {
      "box_id": "{box_uuid}",
      "weight": 25.50,
      "length": 40,
      "width": 30,
      "height": 20
    }
  Then response status = 200 OK
  And box status = 'closed'
  And box.weight = 25.50
  And dimensions saved
  And response includes box summary

Scenario: POST box/close - Box has no items
  When POST close with empty box
  Then response status = 400 Bad Request
  And error message = "Cannot close empty box"
```

### AC-12: API Endpoint - Pending Shipments (FR-7.36)

```gherkin
Scenario: GET /api/shipping/scanner/pack/shipments
  Given user authenticated with warehouse_id in context
  When GET /api/shipping/scanner/pack/shipments
  Then response status = 200 OK
  And response includes shipments with status in ['pending', 'packing']
  And each shipment includes:
    - id, shipment_number, so_number, customer_name
    - status, promised_ship_date
    - lines_total, lines_packed
    - boxes_count
  And results filtered by user's assigned warehouse
  And sorted by promised_ship_date ASC
  And response time < 500ms

Scenario: GET pending shipments - No pending
  Given all shipments packed or shipped
  When GET /api/shipping/scanner/pack/shipments
  Then response status = 200 OK
  And response = { "data": [], "total": 0 }
  And UI shows "No pending shipments" message
```

### AC-13: API Endpoint - Lookup (FR-7.36)

```gherkin
Scenario: GET /api/shipping/scanner/pack/lookup/:barcode - SO found
  When GET /api/shipping/scanner/pack/lookup/SO-2025-00001
  Then response status = 200 OK
  And response includes shipment details with SO lines
  And allergen info included if customer has restrictions
  And response time < 200ms

Scenario: GET lookup - LP found
  Given LP barcode "LP00000123"
  When GET /api/shipping/scanner/pack/lookup/LP00000123
  Then response status = 200 OK
  And response includes LP details:
    - product info, lot, available qty
    - allocated_to_so (validation)
  And response time < 200ms

Scenario: GET lookup - Not found
  When GET /api/shipping/scanner/pack/lookup/INVALID
  Then response status = 404 Not Found
  And error message = "Barcode not found"
```

### AC-14: Touch Target Requirements (FR-NFR)

```gherkin
Scenario: All buttons meet minimum touch target
  Given scanner pack page rendered
  When measuring all interactive elements
  Then all buttons >= 48x48 pixels (48dp)
  And all tappable areas >= 48x48 pixels
  And spacing between targets >= 8 pixels

Scenario: Primary action buttons larger
  Given action buttons at bottom of screen
  Then primary action buttons >= 56x56 pixels
  And full-width buttons = 100% width, 56px height

Scenario: Number pad keys appropriately sized
  Given number pad displayed
  Then each number key >= 48x48 pixels
  And operation keys (+, -, clear) >= 48x48 pixels
  And key spacing = 4-8 pixels

Scenario: List items tappable
  Given shipment or box list displayed
  Then each list row height >= 56 pixels
  And entire row is tappable area
  And visual feedback on tap (ripple/highlight)
```

### AC-15: Error Handling and Recovery (FR-NFR)

```gherkin
Scenario: Network error during pack
  Given user adding item to box
  When network request fails (timeout/offline)
  Then alert tone plays
  And error modal displays:
    - "Network error. Please try again."
    - "Retry" button
    - "Cancel" button
  And user data preserved for retry

Scenario: Retry after network error
  Given network error modal displayed
  When user taps "Retry"
  Then request resubmitted
  And loading indicator shows
  And on success, normal flow continues

Scenario: Server error during pack
  Given user adding item
  When server returns 500 error
  Then error modal displays
  And error logged for debugging
  And "Contact Support" option available

Scenario: Session timeout
  Given warehouse_settings.scanner_idle_timeout_sec = 300
  And user idle for 300+ seconds
  Then session timeout warning displays at 4:30
  And at 5:00, session expires
  And user redirected to login
  And unsaved data preserved (if possible)

Scenario: Camera permission denied
  Given user attempts barcode scan
  When camera permission denied by device
  Then error message "Camera permission required for scanning"
  And "Open Settings" button to enable
  And "Manual Entry" fallback option
```

### AC-16: Performance Requirements (FR-NFR)

```gherkin
Scenario: Page load performance
  Given user navigates to /scanner/shipping/pack
  Then page renders within 1 second
  And interactive within 1.5 seconds
  And pending shipments list loads within 500ms

Scenario: Barcode scan response time
  Given camera scanner active
  When barcode decoded from camera feed
  Then barcode value available within 100ms
  And lookup API called within 50ms
  And total feedback within 500ms

Scenario: Pack item submission performance
  Given user taps "Add to Box"
  Then API call completes within 500ms
  And success feedback within 600ms total
  And box summary updates within 100ms

Scenario: Number pad responsiveness
  Given number pad displayed
  When user taps number key
  Then visual feedback within 50ms
  And value updated within 100ms
  And no perceptible lag
```

### AC-17: RLS and Security (FR-NFR)

```gherkin
Scenario: Org isolation on pending shipments
  Given User A from Org A, User B from Org B
  And shipments exist in both orgs
  When User A requests /api/shipping/scanner/pack/shipments
  Then only Org A shipments returned

Scenario: Cannot pack shipment from different org
  Given User A from Org A
  And shipment belongs to Org B
  When User A attempts POST /api/shipping/scanner/pack with orgB shipment
  Then 404 Not Found returned
  And no box_content created

Scenario: Warehouse access control
  Given user assigned to Warehouse A only
  And shipment for Warehouse B exists
  When user views pending shipments
  Then Warehouse B shipments not visible
  And attempts to pack to Warehouse B blocked
```

---

## Scanner UI Requirements

### Touch Targets

| Element | Minimum Size | Recommended Size |
|---------|-------------|------------------|
| Number pad keys | 48x48 dp | 56x56 dp |
| Primary action buttons | 48x48 dp | Full-width, 56dp height |
| List row items | 56dp height | 64dp height |
| Barcode scan button | 64x64 dp | 80x80 dp |
| Back/Cancel buttons | 48x48 dp | 48x48 dp |
| Icon buttons | 44x44 dp | 48x48 dp |
| Box selector | 48x48 dp | Full-width, 56dp height |

### Layout Structure

```
+------------------------------------------+
| <- Back    Pack Shipment     [?] Help    |  Header (56dp)
+------------------------------------------+
| ALLERGEN ALERT: Peanuts, Milk            |  Allergen Banner (if applicable)
+------------------------------------------+
| SO-2025-00001 | Customer Name             |  Shipment Context (48dp)
| Box 2 of 3  |  5 items, ~35.5 kg        |  Box Status (40dp)
+------------------------------------------+
|                                          |
|             Main Content                 |  Scrollable content
|       (scan prompt, LP details,          |
|        box contents summary)             |
|                                          |
+------------------------------------------+
|                                          |
|         [  SCAN LICENSE PLATE  ]         |  Primary Action (56dp)
|                                          |
|         [ Close Box ]  [ View Box ]      |  Secondary Actions (48dp)
|                                          |
+------------------------------------------+
```

### Number Pad Layout (Same as Scanner Receive)

```
+------------------------------------------+
|   [ 1 ]    [ 2 ]    [ 3 ]    [ +1 ]     |
|   [ 4 ]    [ 5 ]    [ 6 ]    [ +10 ]    |
|   [ 7 ]    [ 8 ]    [ 9 ]    [ -1 ]     |
|   [ . ]    [ 0 ]    [ <- ]   [ -10 ]    |
|                                          |
|            [ CLEAR ]                     |
+------------------------------------------+
```

### Audio Feedback Specification

| Event | Frequency | Duration | Pattern | Web Audio API |
|-------|-----------|----------|---------|---------------|
| Valid scan | 880Hz | 200ms | Single tone | OscillatorNode |
| Invalid scan | 220Hz | 300ms | Single tone | OscillatorNode |
| Box closed | 660Hz+880Hz | 500ms | Dual tone chord | 2x OscillatorNode |
| Allergen alert | 440Hz | 400ms | Repeating (2x) | OscillatorNode |

### Color Scheme (High Contrast)

| Purpose | Light Mode | Notes |
|---------|------------|-------|
| Success | #22C55E (green-500) | High visibility |
| Error | #EF4444 (red-500) | High visibility |
| Warning | #F59E0B (amber-500) | High visibility |
| Allergen Alert | #FDE047 (yellow-400) | Maximum visibility |
| Primary Action | #2563EB (blue-600) | Standard primary |
| Text Primary | #111827 (gray-900) | Near black |
| Text Secondary | #4B5563 (gray-600) | Medium gray |
| Background | #FFFFFF (white) | Maximum contrast |
| Surface | #F9FAFB (gray-50) | Cards, modals |
| Border | #D1D5DB (gray-300) | Visible borders |

---

## Technical Specification

### Database

Uses existing tables from Story 07.11:
- `shipments` (from Story 07.11)
- `shipment_boxes` (from Story 07.11)
- `shipment_box_contents` (from Story 07.11)
- `sales_orders`, `sales_order_lines` (from Story 07.2)
- `license_plates` (from Story 05.1)
- `customers` (from Story 07.1)
- `products`, `allergens` (from Epic 02)

### API Endpoints

```
# Scanner Pack Endpoints
POST   /api/shipping/scanner/pack                    - Add item to box
POST   /api/shipping/scanner/pack/box/create         - Create new box
POST   /api/shipping/scanner/pack/box/close          - Close box with weight
GET    /api/shipping/scanner/pack/shipments          - List pending shipments
GET    /api/shipping/scanner/pack/lookup/:barcode    - Lookup SO/LP
GET    /api/shipping/scanner/pack/box/:boxId         - Get box details
DELETE /api/shipping/scanner/pack/box/:boxId/item/:id - Remove item from box
```

**POST /api/shipping/scanner/pack Request:**

```typescript
interface PackItemRequest {
  shipment_id: string;              // Shipment UUID
  box_id: string;                   // Active box UUID
  license_plate_id: string;         // LP UUID to pack
  so_line_id: string;               // SO line UUID
  quantity: number;                 // Quantity to pack
  notes?: string;                   // Optional notes
}
```

**POST /api/shipping/scanner/pack Response:**

```typescript
interface PackItemResponse {
  box_content: {
    id: string;
    quantity: number;
    product_name: string;
    lot_number: string;
  };
  box_summary: {
    item_count: number;
    total_weight_est: number;
    items: Array<{
      product_name: string;
      quantity: number;
      uom: string;
    }>;
  };
  so_line_status: {
    packed_qty: number;
    remaining_qty: number;
    status: 'partial' | 'complete';
  };
  allergen_warning?: {
    customer_restrictions: string[];
    product_allergens: string[];
    matches: string[];
  };
}
```

**POST /api/shipping/scanner/pack/box/create Request:**

```typescript
interface CreateBoxRequest {
  shipment_id: string;              // Shipment UUID
}
```

**POST /api/shipping/scanner/pack/box/close Request:**

```typescript
interface CloseBoxRequest {
  box_id: string;                   // Box UUID
  weight?: number;                  // kg, optional
  length?: number;                  // cm, optional
  width?: number;                   // cm, optional
  height?: number;                  // cm, optional
}
```

### Service Layer

```typescript
// lib/services/packing-scanner-service.ts

export interface PackItemInput {
  shipmentId: string;
  boxId: string;
  licensePlateId: string;
  soLineId: string;
  quantity: number;
  notes?: string;
}

export interface PackItemResult {
  boxContent: BoxContent;
  boxSummary: BoxSummary;
  soLineStatus: SOLineStatus;
  allergenWarning?: AllergenWarning;
}

export interface BoxSummary {
  itemCount: number;
  totalWeightEst: number;
  items: Array<{
    productName: string;
    quantity: number;
    uom: string;
  }>;
}

export interface PendingShipmentSummary {
  id: string;
  shipment_number: string;
  so_number: string;
  customer_name: string;
  status: string;
  promised_ship_date: string;
  lines_total: number;
  lines_packed: number;
  boxes_count: number;
  allergen_alert: boolean;
}

export class PackingScannerService {
  /**
   * Add item to box - main packing transaction
   * - Validates LP allocated to shipment
   * - Validates quantity <= available
   * - Creates box_content record
   * - Updates SO line packed_qty
   * - Checks allergen conflicts
   * - Returns box summary
   */
  static async addItemToBox(input: PackItemInput): Promise<PackItemResult>;

  /**
   * Create new box for shipment
   * - Auto-increments box_number
   * - Sets status = 'open'
   * - Returns box record
   */
  static async createBox(shipmentId: string): Promise<ShipmentBox>;

  /**
   * Close box with optional weight/dimensions
   * - Validates box has items
   * - Sets status = 'closed'
   * - Saves weight/dimensions
   * - Returns box summary
   */
  static async closeBox(
    boxId: string,
    weight?: number,
    dimensions?: { length: number; width: number; height: number }
  ): Promise<ShipmentBox>;

  /**
   * Get pending shipments for packing
   * Returns shipments with status in ['pending', 'packing']
   */
  static async getPendingShipments(warehouseId?: string): Promise<PendingShipmentSummary[]>;

  /**
   * Lookup shipment by SO barcode
   */
  static async lookupShipment(barcode: string): Promise<Shipment | null>;

  /**
   * Lookup LP by barcode with allocation validation
   */
  static async lookupLP(barcode: string, shipmentId: string): Promise<{
    lp: LicensePlate;
    allocated: boolean;
    soLineId: string | null;
    availableQty: number;
  } | null>;

  /**
   * Get box details with contents
   */
  static async getBoxDetails(boxId: string): Promise<{
    box: ShipmentBox;
    contents: BoxContent[];
    summary: BoxSummary;
  }>;

  /**
   * Remove item from box (undo pack)
   */
  static async removeItemFromBox(boxContentId: string): Promise<void>;

  /**
   * Check allergen conflicts for customer/product
   */
  static async checkAllergenConflict(
    customerId: string,
    productId: string
  ): Promise<AllergenWarning | null>;
}
```

### Validation Schema (Zod)

```typescript
// lib/validation/packing-scanner.ts
import { z } from 'zod';

export const packItemSchema = z.object({
  shipment_id: z.string().uuid("Invalid shipment ID"),
  box_id: z.string().uuid("Invalid box ID"),
  license_plate_id: z.string().uuid("Invalid license plate ID"),
  so_line_id: z.string().uuid("Invalid SO line ID"),
  quantity: z.number()
    .positive("Quantity must be positive")
    .max(999999999, "Quantity too large"),
  notes: z.string()
    .max(500, "Notes max 500 characters")
    .optional()
    .nullable(),
});

export const createBoxSchema = z.object({
  shipment_id: z.string().uuid("Invalid shipment ID"),
});

export const closeBoxSchema = z.object({
  box_id: z.string().uuid("Invalid box ID"),
  weight: z.number()
    .positive("Weight must be positive")
    .max(1000, "Weight too large (max 1000 kg)")
    .optional()
    .nullable(),
  length: z.number()
    .positive("Length must be positive")
    .max(500, "Length too large (max 500 cm)")
    .optional()
    .nullable(),
  width: z.number()
    .positive("Width must be positive")
    .max(500, "Width too large")
    .optional()
    .nullable(),
  height: z.number()
    .positive("Height must be positive")
    .max(500, "Height too large")
    .optional()
    .nullable(),
});

export const pendingShipmentsQuerySchema = z.object({
  warehouse_id: z.string().uuid().optional(),
  search: z.string().optional(),
  limit: z.coerce.number().int().min(1).max(100).default(50),
});

export const lookupBarcodeSchema = z.object({
  barcode: z.string()
    .min(1, "Barcode required")
    .max(100, "Barcode too long"),
});

export type PackItemInput = z.infer<typeof packItemSchema>;
export type CreateBoxInput = z.infer<typeof createBoxSchema>;
export type CloseBoxInput = z.infer<typeof closeBoxSchema>;
```

---

## UI Components

```
app/(authenticated)/scanner/shipping/
  pack/
    page.tsx                              -- Scanner pack main page

components/scanner/shipping/
  pack/
    PackingScannerWizard.tsx              -- Step wizard container
    Step1SelectShipment.tsx               -- Step 1: Select shipment
    Step2BoxManagement.tsx                -- Step 2: Box management
    Step3ScanItem.tsx                     -- Step 3: Scan LP and add
    Step4QuantityEntry.tsx                -- Step 4: Confirm quantity
    Step5BoxClose.tsx                     -- Step 5: Close box
    Step6Complete.tsx                     -- Step 6: Complete shipment
    PendingShipmentsList.tsx              -- List of packable shipments
    BoxSelector.tsx                       -- Box dropdown/switcher
    BoxContentsSummary.tsx                -- Current box items summary
    LPDetailsCard.tsx                     -- LP product details
    AllergenWarningBanner.tsx             -- Allergen alert banner
    WeightEntryModal.tsx                  -- Weight capture modal

  shared/
    BarcodeScanner.tsx                    -- Camera barcode scanner (reuse)
    BarcodeScanButton.tsx                 -- Large scan trigger button (reuse)
    NumberPad.tsx                         -- Touch-friendly number pad (reuse)
    AudioFeedback.tsx                     -- Audio feedback manager (reuse)
    HapticFeedback.tsx                    -- Haptic feedback utility (reuse)
    SuccessAnimation.tsx                  -- Green checkmark animation (reuse)
    ErrorAnimation.tsx                    -- Red X animation (reuse)
    LoadingOverlay.tsx                    -- Full-screen loading (reuse)
    ScannerHeader.tsx                     -- Scanner page header (reuse)
    StepProgress.tsx                      -- Step progress indicator (reuse)
    HighContrastBadge.tsx                 -- High visibility status badge (reuse)
    LargeTouchButton.tsx                  -- 48dp+ touch target button (reuse)
    NetworkStatus.tsx                     -- Online/offline indicator (reuse)
```

### Key Component Implementations

**BoxSelector.tsx**
```tsx
interface BoxSelectorProps {
  boxes: ShipmentBox[];
  activeBoxId: string;
  onSelectBox: (boxId: string) => void;
  onCreateBox: () => void;
}

// Features:
// - Dropdown list of open boxes
// - Shows item count and weight per box
// - "Create New Box" action
// - Visual indicator for active box
```

**AllergenWarningBanner.tsx**
```tsx
interface AllergenWarningBannerProps {
  customerRestrictions: string[];
  visible: boolean;
  onDismiss?: () => void;
}

// Features:
// - Bright yellow banner
// - Allergen list display
// - Alert icon
// - Dismissible (optional)
// - Plays alert tone on appear
```

**BoxContentsSummary.tsx**
```tsx
interface BoxContentsSummaryProps {
  contents: BoxContent[];
  estimatedWeight: number;
  onViewDetails: () => void;
}

// Features:
// - Item count badge
// - Estimated weight display
// - "View Contents" action
// - Real-time updates
```

---

## Key Business Rules

1. **Scanner Authentication**: User must be authenticated with scanner session
2. **Warehouse Context**: User must have assigned warehouse; operations limited to assigned warehouse
3. **Shipment Status for Packing**: Only shipments with status in ['pending', 'packing'] can be packed
4. **LP Allocation Validation**: LP must be allocated to this shipment's SO to be packed
5. **Quantity Validation**: Cannot pack more than LP available qty
6. **Box Item Requirement**: Cannot close empty box
7. **Allergen Validation**: Display warnings if customer restrictions match product allergens
8. **Audio Feedback**: Enabled by default via `scanner_sound_feedback` setting
9. **Touch Targets**: All interactive elements minimum 48x48 pixels
10. **Response Times**: All operations < 500ms for snappy user experience
11. **Box Auto-Create**: First box auto-created on shipment selection
12. **Multi-Box Support**: Multiple boxes can be open simultaneously
13. **Weight Optional**: Weight capture optional on box close (Phase 1)

---

## Deliverables

### API Routes
- [ ] `POST /api/shipping/scanner/pack` - Add item to box
- [ ] `POST /api/shipping/scanner/pack/box/create` - Create box
- [ ] `POST /api/shipping/scanner/pack/box/close` - Close box
- [ ] `GET /api/shipping/scanner/pack/shipments` - List pending
- [ ] `GET /api/shipping/scanner/pack/lookup/:barcode` - Lookup
- [ ] `GET /api/shipping/scanner/pack/box/:boxId` - Box details
- [ ] `DELETE /api/shipping/scanner/pack/box/:boxId/item/:id` - Remove item

### Service Layer
- [ ] `PackingScannerService.addItemToBox()` - Main transaction
- [ ] `PackingScannerService.createBox()` - Create box
- [ ] `PackingScannerService.closeBox()` - Close box
- [ ] `PackingScannerService.getPendingShipments()` - Query pending
- [ ] `PackingScannerService.lookupShipment()` - SO lookup
- [ ] `PackingScannerService.lookupLP()` - LP lookup with validation
- [ ] `PackingScannerService.getBoxDetails()` - Box contents
- [ ] `PackingScannerService.removeItemFromBox()` - Undo pack
- [ ] `PackingScannerService.checkAllergenConflict()` - Allergen check

### Validation
- [ ] `packItemSchema` - Pack request validation
- [ ] `createBoxSchema` - Create box validation
- [ ] `closeBoxSchema` - Close box validation
- [ ] `pendingShipmentsQuerySchema` - Query params
- [ ] `lookupBarcodeSchema` - Barcode lookup

### Frontend Components
- [ ] Scanner pack page (`/scanner/shipping/pack`)
- [ ] 6-step wizard component
- [ ] Pending shipments list component
- [ ] Box selector/switcher
- [ ] Box contents summary
- [ ] LP details card
- [ ] Allergen warning banner
- [ ] Weight entry modal
- [ ] Number pad component (reuse from 07.10)
- [ ] Barcode scanner component (reuse from 07.10)
- [ ] Audio feedback system (reuse from 07.10)
- [ ] Success/Error animations (reuse from 07.10)

### Audio/Visual Feedback
- [ ] Success tone (880Hz, 200ms) - reuse
- [ ] Error beep (220Hz, 300ms) - reuse
- [ ] Confirmation chime (660Hz+880Hz, 500ms) - reuse
- [ ] Allergen alert tone (440Hz, 400ms, 2x)
- [ ] Green checkmark animation - reuse
- [ ] Red X animation - reuse
- [ ] Yellow allergen banner
- [ ] Loading spinner - reuse
- [ ] Haptic feedback (if supported) - reuse

### Tests
- [ ] Unit tests: Packing scanner service (>80% coverage)
- [ ] Integration tests: All scanner pack API endpoints
- [ ] Validation tests: Input validation scenarios
- [ ] Touch target tests: All elements >= 48dp
- [ ] Audio tests: Allergen alert feedback
- [ ] E2E: Full scanner pack flow
- [ ] RLS tests: Multi-tenancy isolation
- [ ] Allergen tests: Warning display and audio

---

## Test Cases

### Unit Tests

**File:** `__tests__/unit/services/packing-scanner-service.test.ts`

| Test Case | Description |
|-----------|-------------|
| `addItemToBox()` creates box_content | Success flow |
| `addItemToBox()` validates LP allocated | Allocation check |
| `addItemToBox()` validates quantity <= available | Qty validation |
| `addItemToBox()` updates SO line packed_qty | Qty accumulation |
| `addItemToBox()` detects allergen conflicts | Allergen check |
| `createBox()` auto-increments box_number | Box numbering |
| `closeBox()` validates box has items | Empty box check |
| `closeBox()` saves weight and dimensions | Data persistence |
| `getPendingShipments()` filters by status | Status filter |
| `getPendingShipments()` filters by warehouse | Warehouse context |
| `lookupShipment()` finds by SO number | Barcode match |
| `lookupLP()` validates allocation | Allocation validation |
| `getBoxDetails()` returns contents and summary | Box query |
| `checkAllergenConflict()` detects matches | Allergen logic |

### Integration Tests

**File:** `__tests__/integration/api/shipping/scanner-pack.test.ts`

| Test Case | Description |
|-----------|-------------|
| `POST /scanner/pack` creates box_content | Success response |
| `POST /scanner/pack` updates SO line | Packed qty updated |
| `POST /scanner/pack` with unallocated LP returns 400 | Validation |
| `POST /scanner/pack` with excess qty returns 400 | Qty validation |
| `POST /scanner/pack` returns allergen warning | Allergen detection |
| `POST /scanner/pack` cross-org returns 404 | RLS enforced |
| `POST /box/create` creates box | Box creation |
| `POST /box/close` closes box | Box closure |
| `POST /box/close` empty box returns 400 | Validation |
| `GET /scanner/pack/shipments` returns list | Success |
| `GET /scanner/pack/shipments` filters by warehouse | Warehouse filter |
| `GET /scanner/pack/lookup/:barcode` finds SO | Lookup success |
| `GET /scanner/pack/lookup/:barcode` finds LP | LP lookup |
| Response times < 500ms | Performance |

### E2E Tests

**File:** `__tests__/e2e/scanner/pack.spec.ts`

| Test Case | Description |
|-----------|-------------|
| Full scanner pack flow | Steps 1-6 complete |
| Select shipment from list | Manual selection works |
| Select shipment by scan (simulated) | Barcode entry works |
| Create multiple boxes | Multi-box workflow |
| Switch between open boxes | Box switcher works |
| Scan LP and add to box | Pack item works |
| Allergen warning displays | Yellow banner shown |
| Allergen alert tone plays | Audio feedback |
| Close box with weight | Weight entry works |
| Complete shipment | Status = packed |
| Touch targets >= 48dp | Accessibility compliance |
| Box contents summary updates | Real-time updates |

---

## Definition of Done

### API
- [ ] All endpoints return correct HTTP status codes
- [ ] Validation errors return 400 with detailed messages
- [ ] Cross-tenant access returns 404 (RLS enforced)
- [ ] Response times:
  - Pack item: < 500ms
  - Pending shipments list: < 500ms
  - Barcode lookups: < 200ms

### Service
- [ ] `addItemToBox()` creates box_content and updates SO line
- [ ] LP allocation validation enforced
- [ ] Quantity validation matches rules
- [ ] Box auto-create on shipment selection
- [ ] Allergen conflict detection functional
- [ ] Multi-box support working

### Frontend
- [ ] Mobile-optimized full-screen layout
- [ ] All touch targets >= 48dp
- [ ] Number pad with quick adjust buttons (reused)
- [ ] Barcode scanner with camera access (reused)
- [ ] Audio feedback (success, error, confirm, allergen alert)
- [ ] Visual feedback (animations, badges)
- [ ] Allergen warning banner prominent and persistent
- [ ] High contrast color scheme
- [ ] Step wizard navigation complete
- [ ] Box selector/switcher functional
- [ ] Box contents summary real-time updates
- [ ] Error handling with retry

### Testing
- [ ] Unit tests: >80% coverage on service
- [ ] Integration tests: All endpoints covered
- [ ] E2E tests: Full flow passing
- [ ] Touch target tests: All compliant
- [ ] Audio tests: Allergen alert working
- [ ] Allergen tests: Warning display and logic
- [ ] RLS tests: Multi-tenancy verified

---

## Future Phases (Not in This Story)

### Story 07.13 - SSCC + Labels + BOL (Next)
- SSCC generation per box
- GS1-128 label printing
- Packing slip generation
- BOL generation

### Phase 2 Enhancements
- Weight scale integration (auto-fill weight)
- Barcode printing trigger from scanner
- Offline queue support
- Catch weight handling

### Phase 3 Advanced
- GS1 barcode parsing (AI codes)
- Multi-product allergen separation logic
- Box optimization suggestions
- Packing performance metrics

---

## Risk Assessment

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Camera permission issues | HIGH | MEDIUM | Clear permission prompts, manual entry fallback |
| Barcode scanning reliability | MEDIUM | MEDIUM | Multiple barcode libraries tested, manual fallback |
| Allergen alert missed by user | HIGH | LOW | Persistent banner, audio alert, confirmation required |
| Multi-box confusion | MEDIUM | MEDIUM | Clear box selector, visual indicators, box summary |
| Network latency on warehouse floor | HIGH | MEDIUM | Loading indicators, retry logic, future offline support |
| Touch targets too small on devices | MEDIUM | LOW | Test on multiple devices, minimum 48dp enforced |
| LP allocation logic complex | MEDIUM | LOW | Reuse allocation service from 07.7, well-tested |
| Audio feedback not playing | LOW | MEDIUM | Visual feedback primary, audio secondary |

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-12-16 | Initial story creation with comprehensive mobile packing scanner workflow | PM-AGENT |
