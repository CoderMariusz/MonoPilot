# 07.11 - Packing Station + Shipment Creation

**Priority**: P0 (MVP Core)
**Complexity**: L (5-6 days)
**Type:** backend + frontend
**Phase:** 1C (After Story 07.9 - Pick Completion)

**State:** ready
**Primary PRD:** `docs/1-BASELINE/product/modules/shipping.md` (FR-7.34, FR-7.35, FR-7.37, FR-7.42)
**Architecture:** `docs/1-BASELINE/architecture/modules/shipping.md` (lines 178-232, 431-454, 599-605, 724-755)

---

## MVP Scope

This story implements the packing station workflow where picked license plates are packed into boxes to create shipments. Covers shipment creation from sales orders, box management, license plate assignment to boxes with full traceability, and weight/dimensions capture.

**What's IN scope:**
- `shipments` table with auto-generated shipment_number (SH-YYYY-NNNNN)
- `shipment_boxes` table with box_number and weight/dimensions
- `shipment_box_contents` table linking boxes to SO lines, LPs, and lot numbers
- POST /api/shipping/shipments (create from SO)
- GET /api/shipping/shipments (list with filters)
- GET /api/shipping/shipments/:id (detail with boxes and contents)
- POST /api/shipping/shipments/:id/boxes (add box)
- POST /api/shipping/shipments/:id/boxes/:boxId/contents (add LP to box)
- PUT /api/shipping/shipments/:id/boxes/:boxId (update weight/dimensions)
- Packing workflow page at /shipping/packing/:shipmentId
- Status workflow: pending → packing → packed
- Allergen separation warnings (non-blocking)
- Weight/dimension validation (must be positive)
- Cascade relationships (shipment → boxes → contents)
- LP traceability (lot_number captured in box_contents)

**What's OUT of scope (deferred to other stories):**
- SSCC barcode generation (Story 07.13)
- BOL generation (Story 07.13)
- Shipping label printing (Story 07.13)
- Packing slip generation (Story 07.13)
- Pack confirmation scanner UI (Story 07.12)
- Manifest and ship actions (Story 07.14)
- Carrier integration (Phase 2)

---

## Dependencies

### Epic Dependencies
- **Epic 01.1** - Organizations, RLS, users, roles (HARD)
- **Epic 01.8** - Warehouses (HARD)
- **Epic 01.9** - Locations (staging locations) (HARD)
- **Epic 02.1** - Products (HARD)
- **Epic 02.3** - Allergens (for separation warnings) (HARD)
- **Epic 05.1** - License Plates (HARD)

### Story Dependencies (within Epic 07)
- **07.1** - Customers CRUD (provides customers table)
- **07.2** - Customer Contacts + Addresses (provides customer_addresses table)
- **07.3** - Sales Orders CRUD (provides sales_orders table)
- **07.4** - SO Lines Management (provides sales_order_lines table)
- **07.7** - Inventory Allocation (provides allocations)
- **07.8** - Pick List Generation (provides pick lists)
- **07.9** - Pick Confirmation Desktop (provides completed picks) **[BLOCKER]**

### Provides To
- **07.12** - Pack Confirmation Scanner (consumes shipments/boxes)
- **07.13** - SSCC + Labels + BOL (consumes packed shipments)
- **07.14** - Shipment + Ship Confirm (consumes packed shipments)

---

## Goal

Enable warehouse packers to create shipments from picked sales orders, pack license plates into multiple boxes with weight/dimensions capture, and maintain full traceability of which LPs and lot numbers are in each box, while warning about potential allergen separation issues.

## User Story

As a **warehouse packer**, I want to **create shipments, organize picked license plates into boxes, and record weight/dimensions** so that **the shipment is properly documented with full traceability for each box and its contents**.

## Scope

**In scope (this story)**
- Database tables: `shipments`, `shipment_boxes`, `shipment_box_contents`
- Auto-generate shipment_number: SH-YYYY-NNNNN (sequential per org)
- Create shipment from sales order (status='pending')
- Packing workflow page at /shipping/packing/:shipmentId
- List picked LPs available for packing (from completed pick lists)
- Add boxes to shipment (box_number auto-increments)
- Assign LPs to boxes (creates box_contents records)
- Capture weight and dimensions per box (kg, cm)
- Complete packing (updates status to 'packed', calculates total_weight, total_boxes)
- Allergen separation warnings (if multiple allergen products in same box)
- Desktop UI: PackingWorkbench, BoxBuilder, LPSelector, PackingSummary
- RLS policies for multi-tenant isolation
- Cascade delete: shipment → boxes → contents

**Out of scope (this story)**
- SSCC generation (Story 07.13)
- BOL generation (Story 07.13)
- Label printing (Story 07.13)
- Packing slip generation (Story 07.13)
- Scanner UI for packing (Story 07.12)
- Manifest and ship actions (Story 07.14)
- Carrier selection/booking (Phase 2)

---

## Acceptance Criteria (Given/When/Then)

### AC-1: Auto-Generate Shipment Number

**Given** an organization with existing shipments
**When** a user creates a new shipment
**Then** the system generates a unique shipment_number in format SH-YYYY-NNNNN (e.g., SH-2025-00123)
**And** the sequence increments per org (not global)
**And** the number is stored in shipments.shipment_number

### AC-2: Create Shipment from Sales Order

**Given** a sales order with status = 'picking' or 'picked'
**And** the SO has completed pick list(s)
**When** the user clicks "Create Shipment" on the SO detail page
**Then** the system creates a new shipment record with:
- shipment_number = auto-generated (SH-YYYY-NNNNN)
- sales_order_id = SO id
- customer_id = SO customer_id
- shipping_address_id = SO shipping_address_id
- status = 'pending'
- total_weight = 0
- total_boxes = 0
**And** updates sales_order.status to 'packing'
**And** redirects to /shipping/packing/:shipmentId

### AC-3: Display Available License Plates for Packing

**Given** a shipment with status = 'pending' or 'packing'
**And** the associated sales order has completed pick list(s)
**When** the packer views the packing page
**Then** the system displays:
- Sales order header (SO#, customer, ship-to address)
- List of picked LPs (from pick_list_lines where status='picked')
- For each LP: LP#, product, lot, qty picked, location
- LPs grouped by product (collapsible)
**And** shows pack progress:
- Total LPs: 15
- Packed: 8
- Remaining: 7

### AC-4: Add Box to Shipment

**Given** a shipment with status = 'pending' or 'packing'
**When** the packer clicks "Add Box"
**Then** the system creates a new shipment_box record with:
- shipment_id = current shipment
- box_number = auto-incremented (1, 2, 3, ...)
- sscc = NULL (generated in Story 07.13)
- weight = NULL (to be entered)
- length = NULL (to be entered)
- width = NULL (to be entered)
- height = NULL (to be entered)
**And** displays the new box in the box list
**And** focuses the box for adding contents

### AC-5: Assign License Plate to Box

**Given** a shipment with at least one box
**And** unpacked LPs are available
**When** the packer scans or selects an LP and assigns it to Box 1
**Then** the system creates a shipment_box_contents record with:
- shipment_box_id = Box 1 id
- sales_order_line_id = SO line id (from pick_list_line)
- product_id = LP product_id
- license_plate_id = LP id
- lot_number = LP lot_number (for traceability)
- quantity = picked quantity from pick_list_line
**And** removes the LP from the available list
**And** displays the LP in Box 1 contents
**And** updates pack progress (Packed count +1)

### AC-6: Capture Box Weight and Dimensions

**Given** a box with at least one LP assigned
**When** the packer enters weight = 12.5 kg, length = 40 cm, width = 30 cm, height = 25 cm
**Then** the system validates:
- weight > 0
- length > 0 (optional, can be null)
- width > 0 (optional, can be null)
- height > 0 (optional, can be null)
**And** updates the shipment_box record
**And** displays the dimensions in the box summary

### AC-7: Allergen Separation Warning

**Given** a box with Product A (contains Peanuts) already assigned
**When** the packer attempts to add Product B (contains Dairy) to the same box
**And** customer has allergen_restrictions including Dairy
**Then** the system displays a warning dialog:
- "Warning: Allergen Separation"
- "Box 1 contains products with different allergens: Peanuts, Dairy"
- "Customer restrictions: Dairy"
- "Recommendation: Pack in separate boxes"
- Buttons: "Continue Anyway" | "Cancel"
**And** allows the packer to proceed (non-blocking)
**And** logs the warning in shipment notes

### AC-8: Complete Packing

**Given** a shipment with status = 'packing'
**And** at least one box with contents
**When** the packer clicks "Complete Packing"
**Then** the system validates:
- All picked LPs are assigned to boxes (or marked as exceptions)
- Each box has weight entered
**And** updates the shipment record:
- status = 'packed'
- total_boxes = count of boxes
- total_weight = sum of box weights
- packed_at = current timestamp
- packed_by = current user
**And** displays success message: "Shipment SH-2025-00123 packed successfully"
**And** redirects to shipment detail page

### AC-9: List Shipments with Filters

**Given** a warehouse with 30 shipments in various statuses
**When** the user navigates to /shipping/shipments
**Then** the system displays a ShipmentsTable with columns:
- Shipment #
- Sales Order # (link)
- Customer
- Status (badge with color)
- Total Boxes
- Total Weight (kg)
- Carrier
- Tracking Number
- Created At
- Actions (Pack, View, Manifest, Ship)
**And** supports filters:
- Status (multi-select: pending, packing, packed, manifested, shipped, delivered)
- Customer (dropdown)
- Date range (created_at)
**And** supports sorting by any column
**And** supports pagination (20 per page)

### AC-10: Shipment Detail View

**Given** a shipment with 3 boxes and 12 LPs packed
**When** the user clicks on a shipment number
**Then** the system displays shipment header:
- Shipment #, SO #, Customer, Ship-to Address
- Status, Carrier, Tracking Number
- Total Boxes, Total Weight
- Created At, Packed At, Shipped At
**And** displays BoxesTable with columns:
- Box Number
- Weight (kg)
- Dimensions (L × W × H cm)
- Contents Count
- Actions (View Contents, Edit)
**And** for each box, displays box contents (collapsible):
- Product, SKU, Lot Number, LP#, Quantity
**And** shows shipment timeline:
- Created: 2025-01-15 10:30 by John
- Packing Started: 2025-01-15 11:00
- Packed: 2025-01-15 11:45 by Jane

### AC-11: RLS Policy for Multi-Tenant Isolation

**Given** two organizations (Org A and Org B) in the database
**When** a user from Org A queries shipments
**Then** the system returns only shipments where shipments.org_id = Org A
**And** prevents access to Org B's shipments via RLS policy
**And** the same isolation applies to shipment_boxes and shipment_box_contents
**And** all INSERT operations auto-populate org_id from user's context

### AC-12: Cascade Delete on Sales Order Cancellation

**Given** a sales order with status = 'packing'
**And** an associated shipment with status = 'pending' or 'packing'
**When** the user cancels the sales order
**Then** the system deletes the shipment record (ON DELETE CASCADE)
**And** deletes associated shipment_boxes records (cascade from shipments)
**And** deletes associated shipment_box_contents records (cascade from boxes)
**And** if shipment.status = 'packed', the system blocks cancellation with error message

---

## Implementation Notes

### API Endpoints

```typescript
// Create shipment
POST /api/shipping/shipments
Body: {
  sales_order_id: string;
}
Response: { shipment_id: string; shipment_number: string; }

// List shipments
GET /api/shipping/shipments?status=pending&customer_id=abc&page=1&limit=20
Response: { shipments: Shipment[]; total: number; }

// Get shipment detail
GET /api/shipping/shipments/:id
Response: {
  shipment: Shipment;
  boxes: ShipmentBox[];
  contents: ShipmentBoxContent[];
  sales_order: SalesOrder;
}

// Get available LPs for packing
GET /api/shipping/shipments/:id/available-lps
Response: { license_plates: PickedLP[]; }

// Add box to shipment
POST /api/shipping/shipments/:id/boxes
Body: {}
Response: { box_id: string; box_number: number; }

// Update box weight/dimensions
PUT /api/shipping/shipments/:id/boxes/:boxId
Body: {
  weight?: number;
  length?: number;
  width?: number;
  height?: number;
}
Response: { success: true; }

// Add LP to box
POST /api/shipping/shipments/:id/boxes/:boxId/contents
Body: {
  license_plate_id: string;
  sales_order_line_id: string;
  quantity: number;
}
Response: { content_id: string; }

// Complete packing
POST /api/shipping/shipments/:id/complete-packing
Body: {}
Response: { success: true; }
```

### Database Schema

```sql
-- Shipments Table
CREATE TABLE shipments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id),
  shipment_number TEXT NOT NULL,  -- SH-YYYY-NNNNN
  sales_order_id UUID NOT NULL REFERENCES sales_orders(id),
  customer_id UUID NOT NULL REFERENCES customers(id),
  shipping_address_id UUID NOT NULL REFERENCES customer_addresses(id),
  status TEXT NOT NULL DEFAULT 'pending' CHECK(status IN ('pending', 'packing', 'packed', 'manifested', 'shipped', 'delivered', 'exception')),
  carrier TEXT,  -- dhl, ups, dpd, fedex, other
  service_level TEXT,  -- Ground, Express, etc.
  tracking_number TEXT,
  sscc TEXT,  -- Master SSCC (Story 07.13)
  total_weight DECIMAL(10,2),  -- kg
  total_boxes INTEGER DEFAULT 0,
  dock_door_id UUID REFERENCES dock_doors(id),
  staged_location_id UUID REFERENCES locations(id),
  packed_at TIMESTAMPTZ,
  packed_by UUID REFERENCES users(id),
  shipped_at TIMESTAMPTZ,
  delivered_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  created_by UUID NOT NULL REFERENCES users(id),

  UNIQUE(org_id, shipment_number)
);

-- Shipment Boxes Table
CREATE TABLE shipment_boxes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id),
  shipment_id UUID NOT NULL REFERENCES shipments(id) ON DELETE CASCADE,
  box_number INTEGER NOT NULL,  -- Sequential per shipment (1, 2, 3, ...)
  sscc TEXT,  -- Unique SSCC per box (Story 07.13)
  weight DECIMAL(10,3),  -- kg
  length DECIMAL(10,2),  -- cm
  width DECIMAL(10,2),  -- cm
  height DECIMAL(10,2),  -- cm
  tracking_number TEXT,  -- Individual tracking (multi-package shipments)
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),

  UNIQUE(shipment_id, box_number),
  UNIQUE(sscc),
  CHECK(weight > 0 OR weight IS NULL),
  CHECK(length > 0 OR length IS NULL),
  CHECK(width > 0 OR width IS NULL),
  CHECK(height > 0 OR height IS NULL)
);

-- Shipment Box Contents Table
CREATE TABLE shipment_box_contents (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id),
  shipment_box_id UUID NOT NULL REFERENCES shipment_boxes(id) ON DELETE CASCADE,
  sales_order_line_id UUID NOT NULL REFERENCES sales_order_lines(id),
  product_id UUID NOT NULL REFERENCES products(id),
  license_plate_id UUID NOT NULL REFERENCES license_plates(id),
  lot_number TEXT,  -- Traceability (from LP)
  quantity DECIMAL(15,4) NOT NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- Indexes
CREATE INDEX idx_shipments_org_status ON shipments(org_id, status);
CREATE INDEX idx_shipments_customer ON shipments(customer_id);
CREATE INDEX idx_shipments_so ON shipments(sales_order_id);
CREATE INDEX idx_shipments_tracking ON shipments(tracking_number);
CREATE INDEX idx_shipment_boxes_shipment ON shipment_boxes(shipment_id);
CREATE INDEX idx_shipment_box_contents_box ON shipment_box_contents(shipment_box_id);
CREATE INDEX idx_shipment_box_contents_lp ON shipment_box_contents(license_plate_id);

-- RLS Policies
ALTER TABLE shipments ENABLE ROW LEVEL SECURITY;
ALTER TABLE shipment_boxes ENABLE ROW LEVEL SECURITY;
ALTER TABLE shipment_box_contents ENABLE ROW LEVEL SECURITY;

CREATE POLICY "shipments_org_isolation" ON shipments
  FOR ALL USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

CREATE POLICY "shipment_boxes_org_isolation" ON shipment_boxes
  FOR ALL USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

CREATE POLICY "shipment_box_contents_org_isolation" ON shipment_box_contents
  FOR ALL USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

-- Auto-increment shipment_number function
CREATE OR REPLACE FUNCTION generate_shipment_number(org_uuid UUID)
RETURNS TEXT AS $$
DECLARE
  next_seq INTEGER;
  year_str TEXT;
BEGIN
  year_str := TO_CHAR(CURRENT_DATE, 'YYYY');

  -- Get next sequence for this org and year
  SELECT COALESCE(MAX(
    CAST(SUBSTRING(shipment_number FROM 9) AS INTEGER)
  ), 0) + 1 INTO next_seq
  FROM shipments
  WHERE org_id = org_uuid
    AND shipment_number LIKE 'SH-' || year_str || '-%';

  RETURN 'SH-' || year_str || '-' || LPAD(next_seq::TEXT, 5, '0');
END;
$$ LANGUAGE plpgsql;
```

### Frontend Components

```typescript
// apps/frontend/app/(authenticated)/shipping/shipments/page.tsx
// Shipments list page

// apps/frontend/app/(authenticated)/shipping/shipments/[id]/page.tsx
// Shipment detail page

// apps/frontend/app/(authenticated)/shipping/packing/[shipmentId]/page.tsx
// Packing workbench page (main packing UI)

// apps/frontend/app/(authenticated)/shipping/packing/components/PackingWorkbench.tsx
import { useState } from 'react';
import { BoxBuilder } from './BoxBuilder';
import { LPSelector } from './LPSelector';
import { PackingSummary } from './PackingSummary';
import { AllergenWarningDialog } from './AllergenWarningDialog';

export function PackingWorkbench({ shipmentId, salesOrder }: Props) {
  // State: shipment, boxes, availableLPs, selectedBox
  // Layout: 3-column grid
  //   Left: Available LPs list (grouped by product)
  //   Center: Box builder (add box, assign LPs, enter weight/dimensions)
  //   Right: Packing summary (box count, total weight, progress)
  // Actions: Add Box, Assign LP to Box, Complete Packing
}

// apps/frontend/app/(authenticated)/shipping/packing/components/BoxBuilder.tsx
export function BoxBuilder({ boxes, onAddBox, onUpdateBox, onAddContent }: Props) {
  // Tabs for each box (Box 1, Box 2, Box 3, ...)
  // Per box:
  //   - Box number, weight, dimensions inputs
  //   - Contents list (product, lot, LP#, qty)
  //   - Add LP button (opens LPSelector)
}

// apps/frontend/app/(authenticated)/shipping/packing/components/LPSelector.tsx
import { Combobox } from '@/components/ui/combobox';

export function LPSelector({ availableLPs, onSelect }: Props) {
  // Searchable dropdown of available LPs
  // Display: LP#, Product, Lot, Qty
  // On select: calls onAddContent API
}

// apps/frontend/app/(authenticated)/shipping/packing/components/PackingSummary.tsx
import { Card } from '@/components/ui/card';

export function PackingSummary({ shipment, boxes, packProgress }: Props) {
  // Summary card:
  //   - SO#, Customer
  //   - Total Boxes: 3
  //   - Total Weight: 38.5 kg
  //   - Pack Progress: 12/15 LPs (80%)
  //   - Status badge
  //   - Complete Packing button
}

// apps/frontend/app/(authenticated)/shipping/packing/components/AllergenWarningDialog.tsx
import { AlertDialog } from '@/components/ui/alert-dialog';

export function AllergenWarningDialog({ allergens, onContinue, onCancel }: Props) {
  // Warning dialog for allergen separation
  // List allergens in box + customer restrictions
  // Buttons: Continue Anyway | Cancel
}

// apps/frontend/app/(authenticated)/shipping/shipments/components/ShipmentsTable.tsx
import { DataTable } from '@/components/ui/data-table';

export function ShipmentsTable({ shipments }: { shipments: Shipment[] }) {
  // Columns: shipment_number, SO#, customer, status, boxes, weight, carrier, tracking, created_at
  // Filters: status, customer, date range
  // Actions: Pack, View, Manifest, Ship
}

// apps/frontend/app/(authenticated)/shipping/shipments/components/BoxesTable.tsx
export function BoxesTable({ boxes, contents }: Props) {
  // Table with collapsible rows
  // Row: box_number, weight, dimensions, contents_count
  // Expanded: contents list (product, lot, LP#, qty)
}
```

### Services

```typescript
// lib/services/shipment-service.ts
import { supabase } from '@/lib/supabase/client';
import { getOrgId } from '@/lib/auth/context';

export class ShipmentService {
  /**
   * Create shipment from sales order
   */
  static async createShipment(salesOrderId: string): Promise<{
    shipment_id: string;
    shipment_number: string;
  }> {
    const org_id = await getOrgId();
    const user = (await supabase.auth.getUser()).data.user;

    // 1. Fetch sales order
    const { data: salesOrder, error: soError } = await supabase
      .from('sales_orders')
      .select('customer_id, shipping_address_id')
      .eq('id', salesOrderId)
      .eq('org_id', org_id)
      .single();

    if (soError) throw soError;

    // 2. Generate shipment number
    const { data: numberData } = await supabase.rpc('generate_shipment_number', {
      org_uuid: org_id
    });

    // 3. Create shipment record
    const { data: shipment, error: shipmentError } = await supabase
      .from('shipments')
      .insert({
        org_id,
        shipment_number: numberData,
        sales_order_id: salesOrderId,
        customer_id: salesOrder.customer_id,
        shipping_address_id: salesOrder.shipping_address_id,
        status: 'pending',
        created_by: user?.id
      })
      .select()
      .single();

    if (shipmentError) throw shipmentError;

    // 4. Update sales order status to 'packing'
    await supabase
      .from('sales_orders')
      .update({ status: 'packing' })
      .eq('id', salesOrderId)
      .eq('org_id', org_id);

    return {
      shipment_id: shipment.id,
      shipment_number: shipment.shipment_number
    };
  }

  /**
   * Get available LPs for packing (from completed pick lists)
   */
  static async getAvailableLPs(shipmentId: string): Promise<PickedLP[]> {
    const org_id = await getOrgId();

    // 1. Get sales order from shipment
    const { data: shipment } = await supabase
      .from('shipments')
      .select('sales_order_id')
      .eq('id', shipmentId)
      .eq('org_id', org_id)
      .single();

    // 2. Get picked LPs from pick_list_lines
    const { data: pickLines, error } = await supabase
      .from('pick_list_lines')
      .select(`
        id,
        picked_license_plate_id,
        quantity_picked,
        sales_order_line_id,
        product:products(id, name, sku, allergens),
        license_plate:license_plates!picked_license_plate_id(
          id,
          lp_number,
          lot_number,
          location:locations(name)
        ),
        pick_list:pick_lists!inner(sales_order_id)
      `)
      .eq('pick_lists.sales_order_id', shipment.sales_order_id)
      .eq('status', 'picked')
      .eq('org_id', org_id);

    if (error) throw error;

    // 3. Filter out LPs already packed
    const { data: packedLPs } = await supabase
      .from('shipment_box_contents')
      .select('license_plate_id')
      .in('shipment_box_id', await this.getShipmentBoxIds(shipmentId))
      .eq('org_id', org_id);

    const packedLPIds = new Set(packedLPs?.map(p => p.license_plate_id) || []);

    return pickLines
      .filter(line => !packedLPIds.has(line.picked_license_plate_id))
      .map(line => ({
        id: line.picked_license_plate_id,
        lp_number: line.license_plate.lp_number,
        product: line.product,
        lot_number: line.license_plate.lot_number,
        quantity: line.quantity_picked,
        sales_order_line_id: line.sales_order_line_id,
        location: line.license_plate.location.name
      }));
  }

  /**
   * Add box to shipment
   */
  static async addBox(shipmentId: string): Promise<{
    box_id: string;
    box_number: number;
  }> {
    const org_id = await getOrgId();

    // 1. Get next box number
    const { data: boxes } = await supabase
      .from('shipment_boxes')
      .select('box_number')
      .eq('shipment_id', shipmentId)
      .eq('org_id', org_id)
      .order('box_number', { ascending: false })
      .limit(1);

    const nextBoxNumber = boxes?.length ? boxes[0].box_number + 1 : 1;

    // 2. Create box
    const { data: box, error } = await supabase
      .from('shipment_boxes')
      .insert({
        org_id,
        shipment_id: shipmentId,
        box_number: nextBoxNumber
      })
      .select()
      .single();

    if (error) throw error;

    // 3. Update shipment status to 'packing' if pending
    await supabase
      .from('shipments')
      .update({ status: 'packing' })
      .eq('id', shipmentId)
      .eq('org_id', org_id)
      .eq('status', 'pending');

    return {
      box_id: box.id,
      box_number: box.box_number
    };
  }

  /**
   * Update box weight/dimensions
   */
  static async updateBox(
    shipmentId: string,
    boxId: string,
    data: {
      weight?: number;
      length?: number;
      width?: number;
      height?: number;
    }
  ): Promise<void> {
    const org_id = await getOrgId();

    const { error } = await supabase
      .from('shipment_boxes')
      .update(data)
      .eq('id', boxId)
      .eq('shipment_id', shipmentId)
      .eq('org_id', org_id);

    if (error) throw error;
  }

  /**
   * Add LP to box
   */
  static async addContentToBox(
    shipmentId: string,
    boxId: string,
    data: {
      license_plate_id: string;
      sales_order_line_id: string;
      quantity: number;
    }
  ): Promise<string> {
    const org_id = await getOrgId();

    // 1. Fetch LP and product details
    const { data: lp } = await supabase
      .from('license_plates')
      .select('product_id, lot_number')
      .eq('id', data.license_plate_id)
      .eq('org_id', org_id)
      .single();

    // 2. Check for allergen separation (warning only)
    await this.checkAllergenSeparation(boxId, lp.product_id);

    // 3. Create box content
    const { data: content, error } = await supabase
      .from('shipment_box_contents')
      .insert({
        org_id,
        shipment_box_id: boxId,
        sales_order_line_id: data.sales_order_line_id,
        product_id: lp.product_id,
        license_plate_id: data.license_plate_id,
        lot_number: lp.lot_number,
        quantity: data.quantity
      })
      .select('id')
      .single();

    if (error) throw error;

    return content.id;
  }

  /**
   * Complete packing
   */
  static async completePacking(shipmentId: string): Promise<void> {
    const org_id = await getOrgId();
    const user = (await supabase.auth.getUser()).data.user;

    // 1. Get boxes and calculate totals
    const { data: boxes } = await supabase
      .from('shipment_boxes')
      .select('weight')
      .eq('shipment_id', shipmentId)
      .eq('org_id', org_id);

    if (!boxes || boxes.length === 0) {
      throw new Error('Cannot complete packing: No boxes found');
    }

    // 2. Validate all boxes have weight
    const missingWeight = boxes.filter(b => !b.weight);
    if (missingWeight.length > 0) {
      throw new Error('Cannot complete packing: All boxes must have weight');
    }

    const totalWeight = boxes.reduce((sum, box) => sum + (box.weight || 0), 0);
    const totalBoxes = boxes.length;

    // 3. Update shipment
    const { error } = await supabase
      .from('shipments')
      .update({
        status: 'packed',
        total_weight: totalWeight,
        total_boxes: totalBoxes,
        packed_at: new Date().toISOString(),
        packed_by: user?.id
      })
      .eq('id', shipmentId)
      .eq('org_id', org_id);

    if (error) throw error;

    // 4. Update sales order status to 'packed'
    const { data: shipment } = await supabase
      .from('shipments')
      .select('sales_order_id')
      .eq('id', shipmentId)
      .eq('org_id', org_id)
      .single();

    await supabase
      .from('sales_orders')
      .update({ status: 'packed' })
      .eq('id', shipment.sales_order_id)
      .eq('org_id', org_id);
  }

  /**
   * Check allergen separation (returns warning data if conflict)
   */
  private static async checkAllergenSeparation(
    boxId: string,
    newProductId: string
  ): Promise<{ warning: boolean; allergens: string[] }> {
    const org_id = await getOrgId();

    // 1. Get existing products in box
    const { data: contents } = await supabase
      .from('shipment_box_contents')
      .select('product_id, product:products(allergens)')
      .eq('shipment_box_id', boxId)
      .eq('org_id', org_id);

    // 2. Get new product allergens
    const { data: newProduct } = await supabase
      .from('products')
      .select('allergens')
      .eq('id', newProductId)
      .eq('org_id', org_id)
      .single();

    // 3. Collect all allergens
    const allergens = new Set<string>();
    contents?.forEach(c => {
      if (c.product?.allergens) {
        c.product.allergens.forEach((a: string) => allergens.add(a));
      }
    });
    if (newProduct?.allergens) {
      newProduct.allergens.forEach((a: string) => allergens.add(a));
    }

    // 4. Check if multiple allergens (warning only)
    return {
      warning: allergens.size > 1,
      allergens: Array.from(allergens)
    };
  }

  /**
   * Get shipment with details
   */
  static async getShipmentDetail(shipmentId: string): Promise<{
    shipment: Shipment;
    boxes: ShipmentBox[];
    contents: ShipmentBoxContent[];
    sales_order: SalesOrder;
  }> {
    const org_id = await getOrgId();

    const { data: shipment, error: shipmentError } = await supabase
      .from('shipments')
      .select(`
        *,
        customer:customers(name),
        shipping_address:customer_addresses(*),
        sales_order:sales_orders(order_number)
      `)
      .eq('id', shipmentId)
      .eq('org_id', org_id)
      .single();

    if (shipmentError) throw shipmentError;

    const { data: boxes } = await supabase
      .from('shipment_boxes')
      .select('*')
      .eq('shipment_id', shipmentId)
      .eq('org_id', org_id)
      .order('box_number', { ascending: true });

    const { data: contents } = await supabase
      .from('shipment_box_contents')
      .select(`
        *,
        product:products(name, sku),
        license_plate:license_plates(lp_number)
      `)
      .in('shipment_box_id', boxes?.map(b => b.id) || [])
      .eq('org_id', org_id);

    return {
      shipment,
      boxes: boxes || [],
      contents: contents || [],
      sales_order: shipment.sales_order
    };
  }

  /**
   * Get shipment box IDs (helper)
   */
  private static async getShipmentBoxIds(shipmentId: string): Promise<string[]> {
    const org_id = await getOrgId();

    const { data: boxes } = await supabase
      .from('shipment_boxes')
      .select('id')
      .eq('shipment_id', shipmentId)
      .eq('org_id', org_id);

    return boxes?.map(b => b.id) || [];
  }

  /**
   * Get shipments with filters
   */
  static async getShipments(filters: {
    status?: string[];
    customer_id?: string;
    page?: number;
    limit?: number;
  }): Promise<{ shipments: Shipment[]; total: number }> {
    const org_id = await getOrgId();
    const limit = filters.limit || 20;
    const offset = ((filters.page || 1) - 1) * limit;

    let query = supabase
      .from('shipments')
      .select(`
        *,
        customer:customers(name),
        sales_order:sales_orders(order_number)
      `, { count: 'exact' })
      .eq('org_id', org_id);

    if (filters.status?.length) {
      query = query.in('status', filters.status);
    }

    if (filters.customer_id) {
      query = query.eq('customer_id', filters.customer_id);
    }

    query = query
      .order('created_at', { ascending: false })
      .range(offset, offset + limit - 1);

    const { data, count, error } = await query;

    if (error) throw error;

    return { shipments: data || [], total: count || 0 };
  }
}
```

### Validation (Zod)

```typescript
// lib/validation/shipment-schema.ts
import { z } from 'zod';

export const createShipmentSchema = z.object({
  sales_order_id: z.string().uuid('Invalid sales order ID')
});

export const addBoxSchema = z.object({
  shipment_id: z.string().uuid('Invalid shipment ID')
});

export const updateBoxSchema = z.object({
  weight: z.number().positive('Weight must be positive').optional(),
  length: z.number().positive('Length must be positive').optional(),
  width: z.number().positive('Width must be positive').optional(),
  height: z.number().positive('Height must be positive').optional()
});

export const addBoxContentSchema = z.object({
  license_plate_id: z.string().uuid('Invalid license plate ID'),
  sales_order_line_id: z.string().uuid('Invalid sales order line ID'),
  quantity: z.number().positive('Quantity must be positive')
});

export const shipmentFiltersSchema = z.object({
  status: z.array(z.enum(['pending', 'packing', 'packed', 'manifested', 'shipped', 'delivered', 'exception'])).optional(),
  customer_id: z.string().uuid().optional(),
  page: z.number().int().positive().optional(),
  limit: z.number().int().positive().max(100).optional()
});

export type CreateShipmentInput = z.infer<typeof createShipmentSchema>;
export type UpdateBoxInput = z.infer<typeof updateBoxSchema>;
export type AddBoxContentInput = z.infer<typeof addBoxContentSchema>;
export type ShipmentFilters = z.infer<typeof shipmentFiltersSchema>;
```

### Key Business Rules

1. **Shipment Number Format**: SH-YYYY-NNNNN (sequential per org, resets annually)
2. **Status Workflow**: pending → packing → packed → manifested → shipped → delivered
3. **Box Number**: Auto-incremented per shipment (1, 2, 3, ...)
4. **Cascade Delete**: shipment → boxes → contents (ON DELETE CASCADE)
5. **Weight Validation**: Must be > 0 (or null before completion)
6. **Dimensions Validation**: Must be > 0 if entered (optional)
7. **LP Traceability**: lot_number captured in shipment_box_contents
8. **Allergen Separation**: Warning only (non-blocking) if multiple allergens in same box
9. **Complete Packing**: Requires all boxes to have weight entered
10. **SO Status Update**: Creating shipment updates sales_order.status to 'packing', completing updates to 'packed'
11. **RLS Enforcement**: All queries filtered by org_id
12. **Available LPs**: Only LPs with pick_list_lines.status = 'picked' and not yet packed

---

## Food Safety Rules

### Allergen Separation Alerts

- Check products in box for multiple allergens
- Display warning if box contains products with different allergens
- Cross-reference with customer.allergen_restrictions
- Warning is non-blocking (packer can continue)
- Log allergen warnings in shipment notes for audit trail
- Recommendation: Pack allergen products in separate boxes

### Lot Number Traceability

- Capture lot_number from license_plate in shipment_box_contents
- Enables full traceability: shipment → box → LP → lot → production
- Required for food safety recalls
- Lot number displayed in box contents list

---

## GS1 Compliance

Not fully implemented in this story. SSCC generation and label printing are deferred to Story 07.13. This story creates the database structure (shipments.sscc, shipment_boxes.sscc) but leaves them NULL until Story 07.13 populates them.

**Preparation for Story 07.13:**
- `shipments.sscc` column exists (NULL in this story)
- `shipment_boxes.sscc` column exists (NULL in this story)
- `shipment_boxes.sscc` has UNIQUE constraint (enforced in 07.13)

---

## Deliverables

### Database
- Migration: `supabase/migrations/YYYYMMDDHHMMSS_create_shipments_packing.sql`
  - `shipments` table
  - `shipment_boxes` table
  - `shipment_box_contents` table
  - Indexes
  - RLS policies
  - `generate_shipment_number()` function

### API Routes
- `apps/frontend/app/api/shipping/shipments/route.ts` (GET, POST)
- `apps/frontend/app/api/shipping/shipments/[id]/route.ts` (GET)
- `apps/frontend/app/api/shipping/shipments/[id]/available-lps/route.ts` (GET)
- `apps/frontend/app/api/shipping/shipments/[id]/boxes/route.ts` (POST)
- `apps/frontend/app/api/shipping/shipments/[id]/boxes/[boxId]/route.ts` (PUT)
- `apps/frontend/app/api/shipping/shipments/[id]/boxes/[boxId]/contents/route.ts` (POST)
- `apps/frontend/app/api/shipping/shipments/[id]/complete-packing/route.ts` (POST)

### Services
- `lib/services/shipment-service.ts`

### Validation
- `lib/validation/shipment-schema.ts`

### Frontend Pages
- `apps/frontend/app/(authenticated)/shipping/shipments/page.tsx`
- `apps/frontend/app/(authenticated)/shipping/shipments/[id]/page.tsx`
- `apps/frontend/app/(authenticated)/shipping/packing/[shipmentId]/page.tsx`

### Components
- `apps/frontend/app/(authenticated)/shipping/shipments/components/ShipmentsTable.tsx`
- `apps/frontend/app/(authenticated)/shipping/shipments/components/BoxesTable.tsx`
- `apps/frontend/app/(authenticated)/shipping/packing/components/PackingWorkbench.tsx`
- `apps/frontend/app/(authenticated)/shipping/packing/components/BoxBuilder.tsx`
- `apps/frontend/app/(authenticated)/shipping/packing/components/LPSelector.tsx`
- `apps/frontend/app/(authenticated)/shipping/packing/components/PackingSummary.tsx`
- `apps/frontend/app/(authenticated)/shipping/packing/components/AllergenWarningDialog.tsx`

### Tests
- `lib/services/__tests__/shipment-service.test.ts` (unit tests)
- `tests/e2e/shipping/packing-workflow.spec.ts` (E2E tests)

---

## Definition of Done

- [ ] Database migration applied (shipments, shipment_boxes, shipment_box_contents tables)
- [ ] RLS policies enabled and tested (multi-tenant isolation)
- [ ] generate_shipment_number() function working (SH-YYYY-NNNNN format)
- [ ] POST /api/shipping/shipments creates shipment from SO
- [ ] GET /api/shipping/shipments/:id/available-lps returns picked LPs
- [ ] POST /api/shipping/shipments/:id/boxes creates box with auto box_number
- [ ] PUT /api/shipping/shipments/:id/boxes/:boxId updates weight/dimensions
- [ ] POST /api/shipping/shipments/:id/boxes/:boxId/contents adds LP to box with lot_number
- [ ] POST /api/shipping/shipments/:id/complete-packing validates and updates status to 'packed'
- [ ] Allergen separation warning displayed (non-blocking)
- [ ] Weight/dimension validation enforces positive values
- [ ] PackingWorkbench component displays 3-column layout
- [ ] BoxBuilder manages boxes and contents
- [ ] LPSelector adds LPs to boxes
- [ ] PackingSummary shows pack progress
- [ ] ShipmentsTable displays shipments with filters
- [ ] BoxesTable displays boxes with collapsible contents
- [ ] SO status updates to 'packing' on shipment creation, 'packed' on completion
- [ ] Cascade delete works (cancel SO deletes pending/packing shipments)
- [ ] Unit tests pass (>80% coverage for ShipmentService)
- [ ] E2E test: Create shipment → Add boxes → Pack LPs → Complete packing
- [ ] E2E test: Allergen warning displayed when packing multiple allergens
- [ ] Multi-tenant isolation verified (Org A cannot see Org B's shipments)

---

## Future Phases (Not in This Story)

### Phase 1C (Story 07.12)
- Pack confirmation scanner UI (mobile-first)
- Barcode scanning for LPs
- Audio/visual feedback

### Phase 1C (Story 07.13)
- SSCC barcode generation (GS1-128)
- Shipping label printing (ZPL format)
- Packing slip generation (PDF)
- BOL generation (PDF)

### Phase 1C (Story 07.14)
- Manifest shipment with carrier
- Ship confirmation workflow
- Mark as delivered

### Phase 2
- Carrier integration (rate shopping, booking, tracking)
- Dock door assignment
- Load optimization
- Multi-package tracking

### Phase 3
- Automated box sizing recommendations
- Packing efficiency metrics
- Heat maps (most-packed products)

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-12-16 | Initial story creation | PM-AGENT |
