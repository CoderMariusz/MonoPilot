# 07.15 - Shipping Dashboard + KPIs

**Priority**: P1 (MVP Enhanced - Phase 1D)
**Complexity**: M (2-3 days)
**Type:** backend + frontend

**State:** ready
**Primary PRD:** `docs/1-BASELINE/product/modules/shipping.md` (FR-7.66, FR-7.67)
**Architecture:** `docs/1-BASELINE/architecture/modules/shipping.md` (lines 519-555)

---

## MVP Scope

This story implements the Shipping Dashboard, providing real-time operational visibility into the shipping module's performance through KPIs, charts, alerts, and recent activity. The dashboard serves as the primary landing page for shipping operations, enabling managers and operators to quickly assess status and identify issues.

**In scope (this story):**
- Dashboard page at `/shipping/dashboard` as default shipping module landing page
- Real-time KPI cards (Orders, Pick Lists, Shipments, Backorders)
- Two primary charts: Orders by Status (pie chart), Shipments by Date (line chart)
- Alerts section (backorders, delayed shipments, pending picks, allergen conflicts)
- Recent activity timeline (last 10 activities: SO created, confirmed, shipped, pick completed)
- Quick actions panel (Create SO, Create Pick List, View Backorders)
- Redis caching for dashboard data (1min TTL)
- Date range filter (default: last 30 days)
- Org-scoped data with RLS enforcement
- Performance target: < 500ms dashboard load time

**Out of scope (this story):**
- Advanced analytics and predictive reports (Phase 2)
- Carrier performance metrics (Phase 2 - requires carrier integration)
- Returns analysis (Phase 2 - requires RMA module)
- Pick performance metrics (Phase 2)
- Real-time updates via SSE/WebSockets (Phase 2 - polling 30s is acceptable for MVP)
- Custom dashboard widgets/layouts (Phase 3)
- Export dashboard data to PDF/Excel (Phase 2)

---

## Dependencies

### Epic Dependencies
- **Epic 01.1** - Organization context, RLS, users, roles
- **Epic 01.8/9** - Warehouses, locations (for pick location data)
- **Epic 02.1** - Products (for order line data)
- **Epic 02.3** - Allergens (for allergen conflict alerts)
- **Epic 05.1-5.4** - License plates, allocations (for inventory data)

### Story Dependencies (within Epic 07)
- **07.1** - Customers CRUD (customer data for dashboard)
- **07.2** - Sales Orders CRUD (orders data for KPIs)
- **07.3** - SO Status Workflow (status counts for charts)
- **07.7** - Inventory Allocation (backorder detection)
- **07.8** - Pick List Generation (pick list data for KPIs)
- **07.11** - Packing + Shipment Creation (shipment data for KPIs)
- **07.14** - Ship Confirmation (shipped status tracking)

### Provides To
- **07.16** - Orders by Status Report (detailed drill-down from dashboard)
- All shipping stories (primary navigation entry point)

---

## Goal

Provide shipping managers, clerks, and warehouse operators with real-time operational visibility through a comprehensive dashboard that surfaces critical KPIs, alerts, and trends to enable proactive decision-making and issue resolution.

## User Story

As a **shipping manager or warehouse supervisor**, I want to **view a real-time dashboard of shipping operations** so that **I can quickly assess current status, identify bottlenecks, respond to urgent issues, and track on-time delivery performance**.

---

## Scope

**In scope (this story)**
- GET `/api/shipping/dashboard` endpoint (KPIs aggregation)
- GET `/api/shipping/dashboard/alerts` endpoint (alerts aggregation)
- GET `/api/shipping/dashboard/recent-activity` endpoint (activity log)
- Dashboard page component with responsive layout
- KPI cards with trend indicators (vs. previous period)
- Orders by Status pie chart (draft, confirmed, allocated, picking, packing, shipped, delivered)
- Shipments by Date line chart (daily shipment count for date range)
- Alerts section with color-coded badges and clickable filters
- Recent activity timeline with icons and timestamps
- Quick actions panel with navigation shortcuts
- Date range filter (Today, Last 7 days, Last 30 days, Custom range)
- Redis caching strategy (1min TTL) for all dashboard queries
- Loading states, empty states, error handling
- Mobile-responsive design (stacked layout)

**Out of scope (this story)**
- Drill-down to detailed reports (Story 07.16)
- Advanced filters (by customer, warehouse, etc.)
- Chart customization (user-selectable chart types)
- Real-time push notifications for alerts
- Dashboard data export
- Custom date grouping (weekly, monthly)
- Comparative analytics (YoY, MoM)

---

## Acceptance Criteria (Given/When/Then)

### AC-1: Dashboard Page Load

**Given** a shipping clerk navigates to `/shipping` or `/shipping/dashboard`
**When** the page loads
**Then** the dashboard displays within 500ms with 4 KPI cards, 2 charts, alerts section, and recent activity timeline

**Given** the dashboard is loading
**When** data is being fetched
**Then** skeleton loaders display for KPI cards and charts (no blank screen)

**Given** the dashboard has cached data (< 1min old)
**When** the page loads
**Then** cached data displays immediately, and fresh data fetches in the background

### AC-2: KPI Cards

**Given** the dashboard loads for the date range "Last 30 days"
**When** the KPI cards render
**Then** 4 cards display:
1. **Orders**: Total count with breakdown (Draft: X, Confirmed: Y, Shipped: Z)
2. **Pick Lists**: Total count with breakdown (Pending: X, In Progress: Y, Completed: Z)
3. **Shipments**: Total count with breakdown (Pending: X, Packed: Y, Shipped: Z)
4. **Backorders**: Count and total value ($) of backorder lines

**Given** the clerk selects "Today" date range
**When** the KPI cards refresh
**Then** only today's data displays within 300ms

**Given** 50 sales orders exist with status breakdown: Draft (10), Confirmed (15), Shipped (25)
**When** the Orders KPI card displays
**Then** it shows:
- Total: 50
- Draft: 10 (20%)
- Confirmed: 15 (30%)
- Shipped: 25 (50%)

**Given** the previous period (last 30 days ago) had 40 orders, and current period has 50
**When** the Orders KPI card displays
**Then** a trend indicator shows "+25%" with an up arrow (green)

**Given** 5 sales order lines have `qty_allocated < qty_ordered`
**When** the Backorders KPI card displays
**Then** it shows:
- Count: 5 lines
- Total Value: $2,450.00 (sum of backorder line totals)

### AC-3: Orders by Status Chart

**Given** sales orders exist with various statuses
**When** the "Orders by Status" pie chart renders
**Then** it displays segments for each status (draft, confirmed, allocated, picking, packing, shipped, delivered) with:
- Color-coded segments (draft: gray, confirmed: blue, allocated: purple, picking: yellow, packing: orange, shipped: green, delivered: teal)
- Percentage labels on each segment
- Legend below chart
- Hover tooltip showing count and percentage

**Given** the chart has no data (0 orders)
**When** the chart area renders
**Then** an empty state displays: "No orders in selected date range"

**Given** a user clicks on the "shipped" segment of the pie chart
**When** the click event fires
**Then** the user navigates to `/shipping/sales-orders?status=shipped` (filtered list)

### AC-4: Shipments by Date Chart

**Given** shipments exist over the last 30 days
**When** the "Shipments by Date" line chart renders
**Then** it displays:
- X-axis: Dates (daily granularity)
- Y-axis: Shipment count
- Line graph with data points
- Grid lines for readability
- Hover tooltip showing exact date and count

**Given** the date range "Last 7 days" is selected
**When** the Shipments chart updates
**Then** only the last 7 days of data display with daily points

**Given** a spike in shipments occurred on Dec 15 (50 shipments vs. avg 20/day)
**When** the user hovers over Dec 15 data point
**Then** a tooltip displays: "Dec 15, 2025: 50 shipments"

**Given** the chart has no shipment data
**When** the chart area renders
**Then** an empty state displays: "No shipments in selected date range"

### AC-5: Alerts Section

**Given** the dashboard loads
**When** the alerts section renders
**Then** it displays 4 alert types with counts and color-coded badges:
1. **Backorders** (red) - Count of lines with qty_allocated < qty_ordered
2. **Delayed Shipments** (orange) - Count of orders where promised_ship_date < today AND status != shipped
3. **Pending Picks >24h** (yellow) - Count of pick lists created >24 hours ago with status = pending
4. **Allergen Conflicts** (purple) - Count of orders with allergen_validated = false

**Given** 3 backorders exist
**When** the Backorders alert displays
**Then** it shows:
- Badge: "3 Backorders" (red background)
- Icon: Alert triangle
- Clickable to filter orders

**Given** a user clicks on the "Delayed Shipments" alert badge
**When** the click event fires
**Then** the user navigates to `/shipping/sales-orders?filter=delayed` (filtered list showing only delayed orders)

**Given** no alerts exist
**When** the alerts section renders
**Then** a success message displays: "All systems operational - No active alerts"

**Given** 5 pick lists are pending >24 hours
**When** the "Pending Picks >24h" alert displays
**Then** it shows:
- Badge: "5 Overdue Pick Lists" (yellow background)
- Clickable to `/shipping/pick-lists?status=pending&overdue=true`

### AC-6: Recent Activity Timeline

**Given** the dashboard loads
**When** the Recent Activity section renders
**Then** it displays the last 10 activities with:
- Activity type icon (e.g., shopping cart for SO created, truck for shipped)
- Activity description (e.g., "SO-2025-00123 created by John Doe")
- Relative timestamp (e.g., "2 minutes ago", "1 hour ago", "Dec 15 at 2:30 PM")
- Entity link (clickable to navigate to SO detail)

**Given** recent activities include:
1. SO-2025-00123 created (2 min ago)
2. PL-2025-00045 completed (15 min ago)
3. SO-2025-00122 shipped (1 hour ago)
**When** the timeline renders
**Then** activities display in reverse chronological order (most recent first)

**Given** a user clicks on "SO-2025-00123" in the activity timeline
**When** the click event fires
**Then** the user navigates to `/shipping/sales-orders/SO-2025-00123` (sales order detail page)

**Given** no activities exist in the last 30 days
**When** the recent activity section renders
**Then** an empty state displays: "No recent activity in selected date range"

### AC-7: Quick Actions Panel

**Given** the dashboard loads
**When** the Quick Actions panel renders
**Then** it displays 3 action buttons:
1. **Create Sales Order** → `/shipping/sales-orders/new`
2. **Create Pick List** → `/shipping/pick-lists/new`
3. **View Backorders** → `/shipping/sales-orders?filter=backorders`

**Given** a user with role "VIEWER" views the dashboard
**When** the Quick Actions panel renders
**Then** all action buttons are disabled with tooltip: "Insufficient permissions"

**Given** a user with role "ADMIN" or "SALES" views the dashboard
**When** the Quick Actions panel renders
**Then** all action buttons are enabled and clickable

### AC-8: Date Range Filter

**Given** the dashboard loads
**When** the date range filter displays
**Then** preset options are available: "Today", "Last 7 days", "Last 30 days", "Custom range"

**Given** the default date range is "Last 30 days"
**When** the dashboard loads
**Then** "Last 30 days" is selected and KPIs reflect data from the last 30 days

**Given** a user selects "Today" from the date range filter
**When** the selection is made
**Then** all KPIs, charts, and alerts refresh within 300ms to show only today's data

**Given** a user selects "Custom range"
**When** the date picker modal opens
**Then** the user can select a start date and end date (max 365 days range)

**Given** a user selects a custom range of Dec 1 to Dec 15
**When** the range is applied
**Then** all dashboard data filters to Dec 1-15 date range and the filter displays "Dec 1 - Dec 15, 2025"

### AC-9: Redis Caching

**Given** the dashboard loads for the first time
**When** the API endpoints are called
**Then** results are cached in Redis with 1min TTL under keys:
- `dashboard:kpis:{org_id}:{date_range_hash}`
- `dashboard:alerts:{org_id}:{date_range_hash}`
- `dashboard:activity:{org_id}:{date_range_hash}`

**Given** cached dashboard data exists (< 1min old)
**When** a user loads the dashboard
**Then** cached data is returned within 100ms (no database queries)

**Given** cached dashboard data is > 1min old
**When** a user loads the dashboard
**Then** fresh data is fetched from database, cache is updated, and new 1min TTL is set

**Given** a new sales order is created
**When** the dashboard is loaded within the next 60 seconds
**Then** the new order may not appear immediately (cache invalidation is passive, not active)

### AC-10: Performance

**Given** the dashboard has 1,000 sales orders, 500 pick lists, 300 shipments in the date range
**When** the dashboard loads
**Then** the total load time is < 500ms (p95)

**Given** the KPIs API endpoint is called
**When** the query executes
**Then** it completes within 200ms (p95) using aggregation queries (COUNT, SUM, AVG)

**Given** the database has 10,000 total sales orders across all orgs
**When** Org A's dashboard loads
**Then** only Org A's orders are queried (RLS enforced) within performance targets

### AC-11: Multi-Tenant Isolation

**Given** Org A has 50 sales orders and Org B has 30 sales orders
**When** a user from Org A loads the dashboard
**Then** only Org A's 50 orders are included in KPIs (RLS enforced)

**Given** a user from Org A attempts to access the dashboard API with a manipulated org_id for Org B
**When** the request is processed
**Then** a 403 Forbidden error is returned (RLS blocks cross-org access)

### AC-12: Error Handling

**Given** the dashboard API endpoint fails (database timeout)
**When** the dashboard attempts to load
**Then** an error message displays: "Unable to load dashboard. Please try again." with a retry button

**Given** the Redis cache is unavailable
**When** the dashboard loads
**Then** data is fetched directly from database (fallback) with a warning banner: "Real-time data (caching unavailable)"

**Given** the user's session expires while viewing the dashboard
**When** an API call is made
**Then** the user is redirected to login page with message: "Session expired. Please log in again."

### AC-13: Responsive Design

**Given** a user views the dashboard on a mobile device (< 768px width)
**When** the page renders
**Then** KPI cards stack vertically (1 column), charts display full-width, and quick actions become a dropdown menu

**Given** a user views the dashboard on a tablet (768px - 1024px width)
**When** the page renders
**Then** KPI cards display 2 columns, charts display side-by-side (if space allows)

**Given** a user views the dashboard on desktop (> 1024px width)
**When** the page renders
**Then** KPI cards display 4 columns, charts display side-by-side, alerts and activity display in a 2-column layout

---

## Implementation Notes

### API Endpoints

```typescript
// Dashboard KPIs
GET /api/shipping/dashboard
Query params:
  - date_from: ISO date (default: 30 days ago)
  - date_to: ISO date (default: today)
Response:
{
  orders: {
    total: number,
    by_status: { draft: number, confirmed: number, allocated: number, picking: number, packing: number, shipped: number, delivered: number },
    trend: { current: number, previous: number, percentage: number }
  },
  pick_lists: {
    total: number,
    by_status: { pending: number, assigned: number, in_progress: number, completed: number },
    trend: { current: number, previous: number, percentage: number }
  },
  shipments: {
    total: number,
    by_status: { pending: number, packing: number, packed: number, shipped: number, delivered: number },
    trend: { current: number, previous: number, percentage: number }
  },
  backorders: {
    count: number,
    total_value: number
  },
  on_time_delivery_pct: number,
  avg_pick_time_hours: number,
  avg_pack_time_hours: number
}

// Dashboard Alerts
GET /api/shipping/dashboard/alerts
Query params:
  - date_from: ISO date
  - date_to: ISO date
Response:
{
  backorders: { count: number, items: Array<{ so_line_id, product_name, qty_backordered }> },
  delayed_shipments: { count: number, items: Array<{ so_id, order_number, promised_date, days_late }> },
  pending_picks_overdue: { count: number, items: Array<{ pick_list_id, created_at, hours_pending }> },
  allergen_conflicts: { count: number, items: Array<{ so_id, order_number, customer_name, conflicting_allergens }> }
}

// Recent Activity
GET /api/shipping/dashboard/recent-activity
Query params:
  - limit: number (default: 10, max: 50)
Response:
{
  activities: Array<{
    id: uuid,
    type: 'so_created' | 'so_confirmed' | 'so_shipped' | 'pick_completed' | 'shipment_packed',
    entity_type: 'sales_order' | 'pick_list' | 'shipment',
    entity_id: uuid,
    entity_number: string,
    description: string,
    created_at: timestamp,
    created_by: { id: uuid, name: string }
  }>
}
```

### Database Queries

```sql
-- KPI: Orders by Status
SELECT
  status,
  COUNT(*) as count
FROM sales_orders
WHERE org_id = :org_id
  AND order_date >= :date_from
  AND order_date <= :date_to
GROUP BY status;

-- KPI: Pick Lists by Status
SELECT
  status,
  COUNT(*) as count
FROM pick_lists
WHERE org_id = :org_id
  AND created_at >= :date_from
  AND created_at <= :date_to
GROUP BY status;

-- KPI: Shipments by Status
SELECT
  status,
  COUNT(*) as count
FROM shipments
WHERE org_id = :org_id
  AND created_at >= :date_from
  AND created_at <= :date_to
GROUP BY status;

-- KPI: Backorders
SELECT
  COUNT(*) as count,
  SUM((sol.quantity_ordered - sol.quantity_allocated) * sol.unit_price) as total_value
FROM sales_order_lines sol
JOIN sales_orders so ON sol.sales_order_id = so.id
WHERE so.org_id = :org_id
  AND sol.quantity_allocated < sol.quantity_ordered
  AND so.status NOT IN ('cancelled', 'shipped', 'delivered');

-- Alert: Delayed Shipments
SELECT
  id,
  order_number,
  promised_ship_date,
  EXTRACT(DAY FROM (CURRENT_DATE - promised_ship_date)) as days_late
FROM sales_orders
WHERE org_id = :org_id
  AND promised_ship_date < CURRENT_DATE
  AND status NOT IN ('shipped', 'delivered', 'cancelled')
ORDER BY days_late DESC;

-- Alert: Pending Picks >24h
SELECT
  id,
  pick_list_number,
  created_at,
  EXTRACT(HOUR FROM (NOW() - created_at)) as hours_pending
FROM pick_lists
WHERE org_id = :org_id
  AND status = 'pending'
  AND created_at < NOW() - INTERVAL '24 hours'
ORDER BY created_at ASC;

-- Chart: Shipments by Date
SELECT
  DATE(shipped_at) as ship_date,
  COUNT(*) as count
FROM shipments
WHERE org_id = :org_id
  AND shipped_at >= :date_from
  AND shipped_at <= :date_to
  AND status = 'shipped'
GROUP BY DATE(shipped_at)
ORDER BY ship_date ASC;

-- Recent Activity (requires audit_logs or activity_log table)
SELECT
  id,
  activity_type,
  entity_type,
  entity_id,
  entity_number,
  description,
  created_at,
  created_by,
  user_name
FROM activity_log
WHERE org_id = :org_id
  AND activity_type IN ('so_created', 'so_confirmed', 'so_shipped', 'pick_completed', 'shipment_packed')
ORDER BY created_at DESC
LIMIT :limit;
```

### Frontend Components

```
apps/frontend/app/(authenticated)/shipping/dashboard/
  page.tsx                              -- Dashboard page (server component)
  components/
    DashboardKPIs.tsx                   -- 4 KPI cards grid
    KPICard.tsx                         -- Reusable KPI card with trend
    OrdersByStatusChart.tsx             -- Pie chart
    ShipmentsByDateChart.tsx            -- Line chart
    AlertsSection.tsx                   -- Alerts panel
    AlertBadge.tsx                      -- Individual alert badge
    RecentActivityTimeline.tsx          -- Activity feed
    ActivityItem.tsx                    -- Individual activity row
    QuickActionsPanel.tsx               -- Quick action buttons
    DateRangeFilter.tsx                 -- Date range picker
    DashboardSkeleton.tsx               -- Loading state
    EmptyDashboard.tsx                  -- Empty state
```

### Services

```typescript
// lib/services/dashboard-service.ts
export class DashboardService {
  static async getKPIs(orgId: string, dateFrom: Date, dateTo: Date): Promise<DashboardKPIs> {
    // Check Redis cache first
    const cacheKey = `dashboard:kpis:${orgId}:${hashDateRange(dateFrom, dateTo)}`;
    const cached = await redis.get(cacheKey);
    if (cached) return JSON.parse(cached);

    // Fetch from database
    const kpis = await fetchKPIsFromDatabase(orgId, dateFrom, dateTo);

    // Cache for 1 minute
    await redis.setex(cacheKey, 60, JSON.stringify(kpis));

    return kpis;
  }

  static async getAlerts(orgId: string, dateFrom: Date, dateTo: Date): Promise<DashboardAlerts> {
    const cacheKey = `dashboard:alerts:${orgId}:${hashDateRange(dateFrom, dateTo)}`;
    const cached = await redis.get(cacheKey);
    if (cached) return JSON.parse(cached);

    const alerts = await fetchAlertsFromDatabase(orgId, dateFrom, dateTo);
    await redis.setex(cacheKey, 60, JSON.stringify(alerts));

    return alerts;
  }

  static async getRecentActivity(orgId: string, limit: number = 10): Promise<Activity[]> {
    const cacheKey = `dashboard:activity:${orgId}:${limit}`;
    const cached = await redis.get(cacheKey);
    if (cached) return JSON.parse(cached);

    const activities = await fetchRecentActivityFromDatabase(orgId, limit);
    await redis.setex(cacheKey, 60, JSON.stringify(activities));

    return activities;
  }

  static async calculateTrend(current: number, previous: number): Promise<{ percentage: number, direction: 'up' | 'down' | 'neutral' }> {
    if (previous === 0) return { percentage: 100, direction: 'up' };
    const percentage = ((current - previous) / previous) * 100;
    return {
      percentage: Math.abs(percentage),
      direction: percentage > 0 ? 'up' : percentage < 0 ? 'down' : 'neutral'
    };
  }
}
```

### Validation (Zod)

```typescript
// lib/validation/dashboard-schema.ts
import { z } from 'zod';

export const dashboardQuerySchema = z.object({
  date_from: z.string().datetime().optional(),
  date_to: z.string().datetime().optional(),
}).refine((data) => {
  if (data.date_from && data.date_to) {
    const from = new Date(data.date_from);
    const to = new Date(data.date_to);
    const diffDays = (to.getTime() - from.getTime()) / (1000 * 60 * 60 * 24);
    return diffDays <= 365; // Max 1 year range
  }
  return true;
}, {
  message: "Date range cannot exceed 365 days"
});

export const recentActivityQuerySchema = z.object({
  limit: z.number().int().min(1).max(50).default(10)
});
```

### Key Business Rules

1. **Date Range Default**: Dashboard defaults to "Last 30 days" if no date range is specified
2. **Cache TTL**: All dashboard data is cached in Redis for 1 minute (60 seconds)
3. **Cache Key Format**: `dashboard:{type}:{org_id}:{date_range_hash}` to ensure org isolation and date-specific caching
4. **Backorder Definition**: A line is backordered if `quantity_allocated < quantity_ordered` and order status is not 'cancelled', 'shipped', or 'delivered'
5. **Delayed Shipment Definition**: An order is delayed if `promised_ship_date < CURRENT_DATE` and status is not 'shipped', 'delivered', or 'cancelled'
6. **Overdue Pick Definition**: A pick list is overdue if created >24 hours ago and status = 'pending'
7. **Allergen Conflict Definition**: An order has an allergen conflict if `allergen_validated = false` (requires manual review)
8. **Trend Calculation**: Trend compares current period to previous period of equal length (e.g., last 30 days vs. 30 days before that)
9. **Activity Limit**: Recent activity is limited to 10 items by default, max 50
10. **Chart Empty States**: Charts display empty state message if no data exists for selected date range
11. **Alert Clickability**: All alert badges are clickable and navigate to filtered list views
12. **RLS Enforcement**: All dashboard queries are org-scoped via RLS policies

---

## Redis Caching Strategy

### Cache Structure

```typescript
// Cache keys
dashboard:kpis:{org_id}:{date_range_hash}         // KPI aggregations
dashboard:alerts:{org_id}:{date_range_hash}       // Alert counts and items
dashboard:activity:{org_id}:{limit}               // Recent activity log

// Date range hash generation
function hashDateRange(dateFrom: Date, dateTo: Date): string {
  const fromStr = dateFrom.toISOString().split('T')[0];
  const toStr = dateTo.toISOString().split('T')[0];
  return `${fromStr}_${toStr}`;
}

// Example cache key: dashboard:kpis:uuid-org-123:2025-11-16_2025-12-16
```

### Cache Invalidation Strategy

**Passive Invalidation (MVP):**
- TTL-based expiration (1 minute)
- No active cache invalidation on data changes
- Acceptable for MVP as dashboard is near-real-time, not real-time

**Future Active Invalidation (Phase 2):**
- Invalidate on SO creation, confirmation, shipment
- Invalidate on pick list completion
- Use Redis pub/sub for multi-instance cache invalidation

### Fallback Behavior

```typescript
// If Redis is unavailable, fall back to direct database queries
try {
  const cached = await redis.get(cacheKey);
  if (cached) return JSON.parse(cached);
} catch (error) {
  console.warn('Redis cache unavailable, fetching from database:', error);
}

// Always fetch from database if cache miss or error
const data = await fetchFromDatabase();

// Attempt to cache (fail silently if Redis unavailable)
try {
  await redis.setex(cacheKey, 60, JSON.stringify(data));
} catch (error) {
  console.warn('Failed to cache data:', error);
}

return data;
```

---

## Chart Library: Recharts

**Choice Rationale:**
- **Recharts** is recommended for this story (React-native, declarative API)
- Alternatives: Chart.js, Victory, Nivo (any acceptable if team preference)

**Example Usage:**

```tsx
import { PieChart, Pie, Cell, LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend } from 'recharts';

// Orders by Status Pie Chart
const orderStatusData = [
  { name: 'Draft', value: 10, color: '#9CA3AF' },
  { name: 'Confirmed', value: 15, color: '#3B82F6' },
  { name: 'Shipped', value: 25, color: '#10B981' },
];

<PieChart width={400} height={300}>
  <Pie
    data={orderStatusData}
    dataKey="value"
    nameKey="name"
    cx="50%"
    cy="50%"
    outerRadius={100}
    label
  >
    {orderStatusData.map((entry, index) => (
      <Cell key={`cell-${index}`} fill={entry.color} />
    ))}
  </Pie>
  <Tooltip />
  <Legend />
</PieChart>

// Shipments by Date Line Chart
const shipmentDateData = [
  { date: '2025-12-10', count: 15 },
  { date: '2025-12-11', count: 22 },
  { date: '2025-12-12', count: 18 },
];

<LineChart width={600} height={300} data={shipmentDateData}>
  <CartesianGrid strokeDasharray="3 3" />
  <XAxis dataKey="date" />
  <YAxis />
  <Tooltip />
  <Legend />
  <Line type="monotone" dataKey="count" stroke="#10B981" strokeWidth={2} />
</LineChart>
```

---

## Performance Optimization

### Database Indexes

```sql
-- Ensure these indexes exist for fast dashboard queries
CREATE INDEX idx_sales_orders_org_date_status ON sales_orders(org_id, order_date, status);
CREATE INDEX idx_pick_lists_org_created_status ON pick_lists(org_id, created_at, status);
CREATE INDEX idx_shipments_org_shipped_status ON shipments(org_id, shipped_at, status);
CREATE INDEX idx_sales_order_lines_allocated ON sales_order_lines(sales_order_id, quantity_allocated, quantity_ordered);
CREATE INDEX idx_sales_orders_promised_date ON sales_orders(org_id, promised_ship_date, status);
CREATE INDEX idx_activity_log_org_created ON activity_log(org_id, created_at);
```

### Query Optimization

1. **Use Aggregation Functions**: COUNT, SUM, AVG at database level (not in application)
2. **Limit Result Sets**: Use LIMIT for recent activity queries
3. **Filter Early**: Apply org_id and date filters in WHERE clause before aggregation
4. **Avoid N+1 Queries**: Use JOINs or batch queries for related data
5. **Use Database Views**: Consider materialized views for complex dashboard queries (Phase 2)

### Performance Targets

| Metric | Target | Measurement |
|--------|--------|-------------|
| Dashboard Page Load | < 500ms (p95) | Time to interactive |
| KPIs API Response | < 200ms (p95) | Server response time |
| Alerts API Response | < 150ms (p95) | Server response time |
| Activity API Response | < 100ms (p95) | Server response time |
| Chart Render Time | < 100ms | Client-side render |
| Cache Hit Rate | > 90% | Redis cache hits / total requests |

---

## Deliverables

- **API Routes**:
  - `GET /api/shipping/dashboard` (KPIs aggregation)
  - `GET /api/shipping/dashboard/alerts` (alerts aggregation)
  - `GET /api/shipping/dashboard/recent-activity` (activity log)
- **Frontend Page**:
  - Dashboard page (`/shipping/dashboard`)
- **Components**:
  - DashboardKPIs (4 KPI cards)
  - OrdersByStatusChart (Recharts pie chart)
  - ShipmentsByDateChart (Recharts line chart)
  - AlertsSection (4 alert types)
  - RecentActivityTimeline (activity feed)
  - QuickActionsPanel (3 quick actions)
  - DateRangeFilter (date picker)
- **Services**: `dashboard-service.ts` with caching logic
- **Validation**: Zod schemas for query parameters
- **Redis Integration**: Caching layer with 1min TTL
- **Tests**:
  - Unit tests for dashboard-service (>80% coverage)
  - Integration tests for all API endpoints
  - E2E test for dashboard load and interaction

---

## Definition of Done

- [ ] All 3 API endpoints functional and returning correct data
- [ ] Dashboard page loads within 500ms (p95) for typical dataset
- [ ] 4 KPI cards display with correct data and trend indicators
- [ ] Orders by Status pie chart renders correctly
- [ ] Shipments by Date line chart renders correctly
- [ ] Alerts section displays 4 alert types with correct counts
- [ ] Recent activity timeline displays last 10 activities
- [ ] Quick actions panel navigates to correct pages
- [ ] Date range filter works for all presets and custom range
- [ ] Redis caching functional with 1min TTL
- [ ] Cache hit rate > 90% in testing
- [ ] All queries are org-scoped (RLS enforced)
- [ ] Multi-tenant isolation verified (RLS tests pass)
- [ ] Skeleton loaders display during data fetch
- [ ] Empty states display when no data exists
- [ ] Error handling works for API failures
- [ ] Mobile responsive (stacked layout < 768px)
- [ ] Unit tests pass (>80% coverage for dashboard-service)
- [ ] Integration tests pass for all API endpoints
- [ ] E2E test passes for dashboard interaction
- [ ] Code reviewed and approved
- [ ] Documentation updated (API docs, component docs)

---

## Future Phases (Not in This Story)

### Phase 2 (P1 Enhanced)
- Real-time updates via SSE or WebSockets (30s polling for MVP)
- Carrier performance KPIs (requires Story 07.24-07.27)
- Returns analysis (requires Story 07.20-07.23)
- Pick performance metrics (pick time, accuracy)
- On-time delivery % calculation (requires shipment tracking data)
- Average pick/pack time calculations
- Export dashboard to PDF or Excel
- Advanced filters (by customer, warehouse, product)
- Custom date grouping (weekly, monthly aggregation)
- Drill-down reports from chart clicks

### Phase 3 (P2 Advanced)
- Customizable dashboard widgets (drag-and-drop layout)
- User-specific dashboard preferences (saved views)
- Predictive analytics (forecasted shipments, backorder risk)
- Comparative analytics (YoY, MoM, QoQ trends)
- Dashboard scheduled email reports
- Multi-warehouse dashboard (consolidated view)
- Advanced visualizations (heatmaps, sankey diagrams)
- Dashboard API webhooks (alert notifications)

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-12-16 | Initial story creation | PM-AGENT |
