# 07.6 - SO Allergen Validation + Customer Order History

**Priority**: P0 (MVP - Phase 1A)
**Complexity**: M (2-3 days)
**Type:** backend + frontend

**State:** ready
**Primary PRD:** `docs/1-BASELINE/product/modules/shipping.md` (FR-7.32 to FR-7.36)
**Architecture:** `docs/1-BASELINE/architecture/modules/shipping.md`

---

## MVP Scope

This story implements critical food safety compliance for sales orders by validating customer allergen restrictions against ordered products. It ensures orders containing allergens that conflict with customer restrictions are flagged and blocked from confirmation until reviewed by authorized personnel. Additionally, this story adds a basic customer order history view for reference during order creation.

**In scope (this story):**
- POST /api/shipping/sales-orders/:id/validate-allergens endpoint
- Allergen validation logic comparing customer.allergen_restrictions vs product.allergens
- Validation triggers: on SO confirm, on line add/edit, manual validation button
- sales_orders.allergen_validated flag (boolean, default false)
- AllergenAlert component (warning banner displaying conflicts)
- Manager+ override capability with reason capture and audit trail
- GET /api/shipping/customers/:id/orders endpoint for order history
- Customer order history tab in Customer Detail page (basic table view)

**Out of scope (this story):**
- Allergen separation in packing workflow (Story 07.11 - Phase 1C)
- Allergen labeling for shipments (Phase 2)
- Allergen cross-contamination warnings at pick/pack (Story 07.9, 07.11)
- Bulk allergen validation for multiple orders (Phase 2)
- Customer allergen history reporting (Phase 2)

---

## Dependencies

### Epic Dependencies
- **Epic 01.1** - Organization context, RLS, users, roles
- **Epic 01.6** - Role-based permissions (Manager+ role for override)
- **Epic 02.1** - Products table (product_id for SO lines)
- **Epic 02.3** - Allergens table + product_allergens (allergen data source)
- **Epic 07.1** - Customers CRUD (customer.allergen_restrictions JSONB)
- **Epic 07.2** - Sales Orders Core (sales_orders, sales_order_lines tables)

### Story Dependencies (within Epic 07)
- **07.1** - Customers CRUD (customers table with allergen_restrictions)
- **07.2** - Sales Orders Core (sales_orders, sales_order_lines tables)

### Provides To
- **07.5** - SO Confirmation (blocks confirmation if allergen conflicts exist)
- **07.9** - Pick Confirmation Desktop (displays allergen warnings)
- **07.11** - Packing Station Workflow (displays allergen warnings)

---

## Goal

Ensure food safety compliance by preventing shipment of products containing allergens to customers with documented allergen restrictions. Provide clear visibility of allergen conflicts and audit trail for override approvals. Enable sales clerks to view customer order history for reference during order creation.

## User Story

As a **shipping clerk or sales manager**, I want to **validate sales orders against customer allergen restrictions** so that **I can prevent shipping allergen-containing products to customers with allergies, ensuring food safety compliance and protecting customer health**.

As a **sales clerk**, I want to **view a customer's order history** so that **I can reference past orders when creating new orders and ensure consistency**.

---

## Scope

**In scope (this story)**
- Allergen validation endpoint: POST /api/shipping/sales-orders/:id/validate-allergens
- Validation logic: Check each SO line product against customer.allergen_restrictions
- Validation triggers:
  - Automatic on SO confirmation (before status â†’ confirmed)
  - Automatic on SO line add or edit (real-time)
  - Manual via [Validate Allergens] button on SO detail page
- Conflict response format: Array of {line_id, product_code, product_name, allergen_code, allergen_name}
- sales_orders.allergen_validated boolean flag (default false)
- Block SO confirmation if allergen_validated = false and conflicts exist
- Manager+ override capability:
  - Requires reason text (min 20 chars)
  - Creates audit_logs entry with user_id, timestamp, reason
  - Sets allergen_validated = true, allow_allergen_override = true
- AllergenAlert component (red banner with icon, conflict list, override button)
- Customer order history tab in Customer Detail page:
  - GET /api/shipping/customers/:id/orders endpoint
  - Table columns: Order Number, Date, Status, Total Amount, View button
  - Link to SO detail page
  - Pagination (20 orders per page)
- RLS policies for multi-tenant isolation

**Out of scope (this story)**
- Allergen separation alerts in pick/pack workflows (Story 07.9, 07.11)
- Allergen labeling for shipments (Phase 2)
- Customer notification of allergen conflicts (Phase 2)
- Allergen conflict resolution workflow (Phase 2)
- Advanced order history analytics (Phase 2)

---

## Acceptance Criteria (Given/When/Then)

### AC-1: Allergen Validation on SO Confirmation

**Given** a customer has allergen_restrictions = ["A05", "A07"] (Peanuts, Milk)
**And** a sales order has 3 lines:
  - Line 1: Product "Chocolate Bar" with allergens ["A07"] (Milk)
  - Line 2: Product "Granola Mix" with allergens ["A05"] (Peanuts)
  - Line 3: Product "Apple Juice" with no allergens
**When** the clerk clicks "Confirm Order"
**Then** validation runs automatically and blocks confirmation
**And** an AllergenAlert banner displays with conflicts:
  - "Line 1: Chocolate Bar contains Milk (A07) - Customer restricted"
  - "Line 2: Granola Mix contains Peanuts (A05) - Customer restricted"
**And** sales_orders.allergen_validated remains false
**And** SO status remains 'draft'

### AC-2: Allergen Validation on Line Add

**Given** a sales order is in draft status
**And** customer has allergen_restrictions = ["A03"] (Eggs)
**When** clerk adds a new line with product "Egg Noodles" (allergens: ["A03"])
**Then** validation runs automatically
**And** AllergenAlert banner appears immediately showing conflict
**And** sales_orders.allergen_validated is set to false

### AC-3: Allergen Validation on Line Edit

**Given** a sales order has existing lines with no allergen conflicts
**And** allergen_validated = true
**When** clerk edits Line 2 to change product to "Egg Pasta" (allergens: ["A03"])
**And** customer has allergen_restrictions = ["A03"]
**Then** allergen_validated is reset to false
**And** AllergenAlert banner displays with new conflict

### AC-4: Manual Allergen Validation

**Given** a sales order detail page is displayed
**And** SO has lines with products
**When** clerk clicks [Validate Allergens] button
**Then** POST /api/shipping/sales-orders/:id/validate-allergens is called
**And** validation results display within 500ms
**And** if conflicts exist, AllergenAlert banner shows conflicts
**And** if no conflicts, success message displays: "No allergen conflicts detected"

### AC-5: Manager Override with Reason

**Given** an AllergenAlert banner displays conflicts:
  - "Line 1: Chocolate Bar contains Milk (A07) - Customer restricted"
**And** user has Manager or Admin role
**When** user clicks [Override Allergen Block] button
**Then** a modal opens with fields:
  - Reason (textarea, required, min 20 chars)
  - Checkbox: "I confirm this override is authorized and documented"
**When** user enters reason: "Customer confirmed they can accept milk products for this order per phone call on 2025-12-16"
**And** clicks [Confirm Override]
**Then** sales_orders.allergen_validated is set to true
**And** sales_orders.allow_allergen_override is set to true
**And** audit_logs entry is created:
  - entity_type: 'sales_order'
  - entity_id: SO id
  - action: 'allergen_override'
  - old_value: 'validated=false, conflicts=[...]'
  - new_value: 'validated=true, override=true'
  - user_id: current user
  - reason: entered reason text
  - timestamp: now
**And** AllergenAlert banner changes to orange warning:
  - "Allergen override approved by {user_name} on {date}"
  - Show reason text
**And** SO confirmation is now unblocked

### AC-6: Override Denied for Non-Manager

**Given** an AllergenAlert banner displays conflicts
**And** user has Viewer or Sales Clerk role (not Manager+)
**When** user views the alert
**Then** [Override Allergen Block] button is disabled or hidden
**And** tooltip displays: "Manager or Admin role required to override allergen blocks"

### AC-7: Allergen Validation - No Conflicts

**Given** a sales order has 2 lines with products containing no allergens
**And** customer has allergen_restrictions = ["A05"] (Peanuts)
**When** validation runs (manual or automatic)
**Then** validation passes
**And** sales_orders.allergen_validated is set to true
**And** success message displays: "Allergen validation passed - no conflicts detected"
**And** SO confirmation is allowed

### AC-8: Allergen Validation - Customer Has No Restrictions

**Given** a sales order's customer has allergen_restrictions = null or []
**And** SO lines contain products with various allergens
**When** validation runs
**Then** validation passes automatically
**And** sales_orders.allergen_validated is set to true
**And** message displays: "Customer has no allergen restrictions - validation skipped"

### AC-9: Customer Order History - Tab Display

**Given** a clerk navigates to Customer Detail page (from Story 07.1)
**And** clicks the "Order History" tab
**When** the tab loads
**Then** GET /api/shipping/customers/:id/orders is called
**And** a table displays within 500ms with columns:
  - Order Number (e.g., "SO-2025-001")
  - Order Date
  - Status (badge: draft, confirmed, shipped, etc.)
  - Total Amount (formatted currency)
  - Actions: [View] button
**And** orders are sorted by order_date DESC (newest first)

### AC-10: Customer Order History - Pagination

**Given** a customer has 45 historical orders
**When** Order History tab loads
**Then** the first 20 orders display
**And** pagination controls show: "Page 1 of 3"
**And** clicking "Next" loads the next 20 orders

### AC-11: Customer Order History - Link to SO Detail

**Given** the Order History table displays orders
**When** clerk clicks [View] on order "SO-2025-123"
**Then** navigation occurs to /shipping/sales-orders/SO-2025-123 (SO detail page)
**And** SO detail page loads showing full order information

### AC-12: Customer Order History - Empty State

**Given** a newly created customer has no orders
**When** Order History tab loads
**Then** empty state displays:
  - Icon (inbox or shopping cart)
  - Message: "No orders yet"
  - Subtext: "Orders for this customer will appear here"

### AC-13: AllergenAlert Component - Visual Design

**Given** allergen conflicts exist on a sales order
**When** SO detail page displays AllergenAlert
**Then** the alert banner has:
  - Red background (bg-red-50)
  - Red border (border-l-4 border-red-500)
  - Alert icon (red triangle with exclamation)
  - Bold heading: "Allergen Conflict Detected"
  - List of conflicts (bullet points):
    - "Line {line_number}: {product_name} contains {allergen_name} ({allergen_code})"
  - If Manager+: [Override Allergen Block] button (red, outlined)
  - If not Manager: Info text: "Contact manager to override"

### AC-14: AllergenAlert Component - Override Success State

**Given** allergen override has been approved
**When** SO detail page displays AllergenAlert
**Then** the alert banner changes to:
  - Orange background (bg-orange-50)
  - Orange border (border-l-4 border-orange-500)
  - Info icon (orange)
  - Bold heading: "Allergen Override Approved"
  - Text: "Override approved by {user_name} on {date}"
  - Reason displayed in gray box: "{override_reason}"
  - No action buttons

### AC-15: Validation Performance

**Given** a sales order has 50 lines
**And** customer has allergen_restrictions with 5 allergens
**When** validation runs
**Then** validation completes within 1 second
**And** results display without UI blocking

---

## Implementation Notes

### API Endpoints

```typescript
// POST /api/shipping/sales-orders/:id/validate-allergens
// Validates SO lines against customer allergen restrictions
interface ValidateAllergensRequest {
  // No body required - uses SO id from URL
}

interface ValidateAllergensResponse {
  valid: boolean;
  conflicts: AllergenConflict[];
  customer_restrictions: string[]; // Allergen codes
  validated_at: string;
  validated_by: string;
}

interface AllergenConflict {
  line_id: string;
  line_number: number;
  product_id: string;
  product_code: string;
  product_name: string;
  allergen_id: string;
  allergen_code: string;
  allergen_name: string;
}

// POST /api/shipping/sales-orders/:id/override-allergen
// Manager+ only - override allergen block
interface OverrideAllergenRequest {
  reason: string; // Min 20 chars, max 500
  confirmed: boolean; // Must be true
}

interface OverrideAllergenResponse {
  success: boolean;
  allergen_validated: boolean;
  allow_allergen_override: boolean;
  overridden_by: string;
  overridden_at: string;
  audit_log_id: string;
}

// GET /api/shipping/customers/:id/orders
// Returns paginated order history for customer
interface CustomerOrdersRequest {
  page?: number; // Default 1
  limit?: number; // Default 20, max 100
  status?: string; // Optional filter: draft, confirmed, shipped, etc.
}

interface CustomerOrdersResponse {
  orders: CustomerOrder[];
  pagination: {
    page: number;
    limit: number;
    total: number;
    total_pages: number;
  };
}

interface CustomerOrder {
  id: string;
  order_number: string;
  order_date: string;
  status: string;
  total_amount: number;
  currency: string;
  line_count: number;
}
```

### Database Schema Changes

```sql
-- Add allergen validation columns to sales_orders table
ALTER TABLE sales_orders
  ADD COLUMN allergen_validated BOOLEAN DEFAULT false,
  ADD COLUMN allow_allergen_override BOOLEAN DEFAULT false,
  ADD COLUMN allergen_validation_date TIMESTAMPTZ,
  ADD COLUMN allergen_validation_user UUID REFERENCES users(id),
  ADD COLUMN allergen_override_date TIMESTAMPTZ,
  ADD COLUMN allergen_override_user UUID REFERENCES users(id),
  ADD COLUMN allergen_override_reason TEXT;

-- Create index for validation queries
CREATE INDEX idx_sales_orders_allergen_validated
  ON sales_orders(org_id, allergen_validated, status);

-- Add audit_logs table if not exists (for override tracking)
CREATE TABLE IF NOT EXISTS audit_logs (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  org_id UUID NOT NULL REFERENCES organizations(id),
  entity_type TEXT NOT NULL,
  entity_id UUID NOT NULL,
  action TEXT NOT NULL,
  old_value JSONB,
  new_value JSONB,
  user_id UUID REFERENCES users(id),
  reason TEXT,
  created_at TIMESTAMPTZ DEFAULT now()
);

CREATE INDEX idx_audit_logs_entity ON audit_logs(entity_type, entity_id);
CREATE INDEX idx_audit_logs_org ON audit_logs(org_id, created_at DESC);

-- RLS policies for audit_logs
ALTER TABLE audit_logs ENABLE ROW LEVEL SECURITY;

CREATE POLICY "audit_logs_org_isolation" ON audit_logs
  FOR ALL USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));
```

### Validation Logic (Service)

```typescript
// lib/services/allergen-validation-service.ts

import { supabase } from '@/lib/supabase';

export interface AllergenValidationResult {
  valid: boolean;
  conflicts: AllergenConflict[];
  customer_restrictions: string[];
}

export async function validateSalesOrderAllergens(
  salesOrderId: string,
  userId: string
): Promise<AllergenValidationResult> {
  // 1. Get sales order with customer and lines
  const { data: salesOrder, error: soError } = await supabase
    .from('sales_orders')
    .select(`
      id,
      customer_id,
      customers!inner (
        id,
        allergen_restrictions
      ),
      sales_order_lines!inner (
        id,
        line_number,
        product_id,
        products!inner (
          id,
          code,
          name,
          product_allergens!inner (
            allergen_id,
            relation_type,
            allergens!inner (
              id,
              code,
              name_en
            )
          )
        )
      )
    `)
    .eq('id', salesOrderId)
    .single();

  if (soError) throw soError;

  // 2. Extract customer allergen restrictions
  const customerRestrictions = salesOrder.customers.allergen_restrictions || [];

  // If no restrictions, validation passes
  if (customerRestrictions.length === 0) {
    await updateValidationStatus(salesOrderId, true, userId, []);
    return {
      valid: true,
      conflicts: [],
      customer_restrictions: [],
    };
  }

  // 3. Check each SO line for allergen conflicts
  const conflicts: AllergenConflict[] = [];

  for (const line of salesOrder.sales_order_lines) {
    const productAllergens = line.products.product_allergens
      .filter(pa => pa.relation_type === 'contains') // Only "Contains", not "May Contain"
      .map(pa => pa.allergen_id);

    // Check if any product allergen is in customer restrictions
    for (const allergenId of productAllergens) {
      if (customerRestrictions.includes(allergenId)) {
        const allergenData = line.products.product_allergens.find(
          pa => pa.allergen_id === allergenId
        )?.allergens;

        conflicts.push({
          line_id: line.id,
          line_number: line.line_number,
          product_id: line.products.id,
          product_code: line.products.code,
          product_name: line.products.name,
          allergen_id: allergenId,
          allergen_code: allergenData.code,
          allergen_name: allergenData.name_en,
        });
      }
    }
  }

  // 4. Update validation status
  const isValid = conflicts.length === 0;
  await updateValidationStatus(salesOrderId, isValid, userId, conflicts);

  return {
    valid: isValid,
    conflicts,
    customer_restrictions: customerRestrictions,
  };
}

async function updateValidationStatus(
  salesOrderId: string,
  isValid: boolean,
  userId: string,
  conflicts: AllergenConflict[]
): Promise<void> {
  await supabase
    .from('sales_orders')
    .update({
      allergen_validated: isValid,
      allergen_validation_date: new Date().toISOString(),
      allergen_validation_user: userId,
    })
    .eq('id', salesOrderId);

  // Create audit log if conflicts exist
  if (conflicts.length > 0) {
    await supabase.from('audit_logs').insert({
      entity_type: 'sales_order',
      entity_id: salesOrderId,
      action: 'allergen_validation_failed',
      old_value: { allergen_validated: null },
      new_value: { allergen_validated: false, conflicts },
      user_id: userId,
    });
  }
}

export async function overrideAllergenBlock(
  salesOrderId: string,
  userId: string,
  reason: string
): Promise<void> {
  // Verify user has Manager+ role
  const { data: user } = await supabase
    .from('users')
    .select('role')
    .eq('id', userId)
    .single();

  if (!user || !['Manager', 'Admin'].includes(user.role)) {
    throw new Error('Unauthorized: Manager or Admin role required');
  }

  // Get current validation conflicts for audit log
  const { data: salesOrder } = await supabase
    .from('sales_orders')
    .select('allergen_validated, allow_allergen_override')
    .eq('id', salesOrderId)
    .single();

  // Update sales order
  await supabase
    .from('sales_orders')
    .update({
      allergen_validated: true,
      allow_allergen_override: true,
      allergen_override_date: new Date().toISOString(),
      allergen_override_user: userId,
      allergen_override_reason: reason,
    })
    .eq('id', salesOrderId);

  // Create audit log
  await supabase.from('audit_logs').insert({
    entity_type: 'sales_order',
    entity_id: salesOrderId,
    action: 'allergen_override',
    old_value: salesOrder,
    new_value: {
      allergen_validated: true,
      allow_allergen_override: true,
    },
    user_id: userId,
    reason,
  });
}
```

### Frontend Components

```typescript
// components/shipping/AllergenAlert.tsx
import { AlertTriangle, Info } from 'lucide-react';
import { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert';
import { Button } from '@/components/ui/button';

interface AllergenAlertProps {
  conflicts: AllergenConflict[];
  overrideApproved?: boolean;
  overrideReason?: string;
  overriddenBy?: string;
  overriddenAt?: string;
  canOverride: boolean;
  onOverride: () => void;
}

export function AllergenAlert({
  conflicts,
  overrideApproved,
  overrideReason,
  overriddenBy,
  overriddenAt,
  canOverride,
  onOverride,
}: AllergenAlertProps) {
  if (overrideApproved) {
    return (
      <Alert className="border-l-4 border-orange-500 bg-orange-50">
        <Info className="h-4 w-4 text-orange-600" />
        <AlertTitle className="text-orange-800">
          Allergen Override Approved
        </AlertTitle>
        <AlertDescription className="text-orange-700">
          <p>
            Override approved by {overriddenBy} on{' '}
            {new Date(overriddenAt).toLocaleString()}
          </p>
          {overrideReason && (
            <div className="mt-2 p-3 bg-gray-100 rounded text-sm text-gray-700">
              <strong>Reason:</strong> {overrideReason}
            </div>
          )}
        </AlertDescription>
      </Alert>
    );
  }

  return (
    <Alert className="border-l-4 border-red-500 bg-red-50">
      <AlertTriangle className="h-4 w-4 text-red-600" />
      <AlertTitle className="text-red-800">
        Allergen Conflict Detected
      </AlertTitle>
      <AlertDescription className="text-red-700">
        <p className="mb-2">
          This order contains products with allergens that conflict with
          customer restrictions:
        </p>
        <ul className="list-disc list-inside space-y-1 mb-3">
          {conflicts.map((conflict) => (
            <li key={`${conflict.line_id}-${conflict.allergen_id}`}>
              Line {conflict.line_number}: {conflict.product_name} contains{' '}
              <strong>
                {conflict.allergen_name} ({conflict.allergen_code})
              </strong>
            </li>
          ))}
        </ul>
        {canOverride ? (
          <Button
            variant="outline"
            className="border-red-600 text-red-600 hover:bg-red-100"
            onClick={onOverride}
          >
            Override Allergen Block
          </Button>
        ) : (
          <p className="text-sm text-red-600 italic">
            Contact a manager to override this allergen block.
          </p>
        )}
      </AlertDescription>
    </Alert>
  );
}
```

```typescript
// components/shipping/CustomerOrderHistory.tsx
import { DataTable } from '@/components/ui/data-table';
import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
import { useRouter } from 'next/navigation';

interface CustomerOrderHistoryProps {
  customerId: string;
}

export function CustomerOrderHistory({ customerId }: CustomerOrderHistoryProps) {
  const router = useRouter();
  const { data, isLoading } = useCustomerOrders(customerId);

  const columns = [
    {
      header: 'Order Number',
      accessorKey: 'order_number',
    },
    {
      header: 'Date',
      accessorKey: 'order_date',
      cell: ({ row }) => new Date(row.order_date).toLocaleDateString(),
    },
    {
      header: 'Status',
      accessorKey: 'status',
      cell: ({ row }) => (
        <Badge variant={getStatusVariant(row.status)}>
          {row.status}
        </Badge>
      ),
    },
    {
      header: 'Total',
      accessorKey: 'total_amount',
      cell: ({ row }) => formatCurrency(row.total_amount, row.currency),
    },
    {
      header: 'Actions',
      cell: ({ row }) => (
        <Button
          variant="ghost"
          size="sm"
          onClick={() => router.push(`/shipping/sales-orders/${row.id}`)}
        >
          View
        </Button>
      ),
    },
  ];

  if (isLoading) return <div>Loading...</div>;

  if (!data?.orders.length) {
    return (
      <div className="text-center py-12">
        <ShoppingCart className="mx-auto h-12 w-12 text-gray-400" />
        <h3 className="mt-2 text-sm font-medium text-gray-900">No orders yet</h3>
        <p className="mt-1 text-sm text-gray-500">
          Orders for this customer will appear here
        </p>
      </div>
    );
  }

  return <DataTable columns={columns} data={data.orders} />;
}
```

### Validation Triggers

```typescript
// Trigger 1: On SO confirmation (before status change)
async function confirmSalesOrder(salesOrderId: string, userId: string) {
  // Run allergen validation first
  const validation = await validateSalesOrderAllergens(salesOrderId, userId);

  if (!validation.valid) {
    throw new Error(
      `Cannot confirm order: allergen conflicts detected. ${validation.conflicts.length} conflict(s) found.`
    );
  }

  // Proceed with confirmation
  await updateSalesOrderStatus(salesOrderId, 'confirmed', userId);
}

// Trigger 2: On SO line add/edit
async function addOrUpdateSalesOrderLine(
  salesOrderId: string,
  lineData: any,
  userId: string
) {
  // Save line
  await saveSalesOrderLine(lineData);

  // Reset allergen validation flag
  await supabase
    .from('sales_orders')
    .update({
      allergen_validated: false,
      allergen_validation_date: null,
    })
    .eq('id', salesOrderId);

  // Run validation (non-blocking)
  validateSalesOrderAllergens(salesOrderId, userId).catch(console.error);
}
```

### Key Business Rules

1. **Validation Scope**: Only "Contains" allergens trigger conflicts, not "May Contain"
2. **Validation Timing**: Auto-validate on line add/edit, manual validate on button click, mandatory on confirmation
3. **Override Authority**: Only Manager and Admin roles can override allergen blocks
4. **Override Audit Trail**: All overrides logged in audit_logs with user, timestamp, and reason
5. **Validation Reset**: Any line change (add/edit/delete) resets allergen_validated to false
6. **Confirmation Block**: SO confirmation blocked if allergen_validated = false, unless allow_allergen_override = true
7. **Customer No Restrictions**: If customer.allergen_restrictions is null or [], validation passes automatically

---

## Food Safety Rules

### Allergen Validation Compliance

- **Mandatory Validation**: All sales orders MUST be validated before confirmation
- **"Contains" vs "May Contain"**: Only "Contains" declarations trigger blocking conflicts
- **Override Documentation**: All overrides MUST include reason (min 20 chars) and are audited
- **Manager Approval**: Only Manager+ roles can override allergen blocks
- **Audit Trail**: All validation results and overrides logged for traceability
- **Real-time Feedback**: Validation runs automatically on line changes to provide immediate feedback

### Customer Order History

- **Data Privacy**: Order history respects RLS policies (org_id filtering)
- **Performance**: Pagination prevents large dataset performance issues
- **Reference Only**: Order history is read-only in this story (no actions beyond View)

---

## Deliverables

- POST /api/shipping/sales-orders/:id/validate-allergens endpoint
- POST /api/shipping/sales-orders/:id/override-allergen endpoint (Manager+ only)
- GET /api/shipping/customers/:id/orders endpoint
- Migration: Add allergen validation columns to sales_orders table
- Migration: Create audit_logs table (if not exists)
- allergen-validation-service.ts with validation and override functions
- AllergenAlert component (red/orange banners)
- AllergenOverrideModal component (reason input)
- CustomerOrderHistory component (table with pagination)
- Zod validation schemas for override request
- Unit tests for allergen validation logic (>90% coverage)
- Integration tests for validation and override endpoints
- E2E test: Full allergen conflict scenario with Manager override

---

## Definition of Done

- [ ] POST /api/shipping/sales-orders/:id/validate-allergens endpoint implemented
- [ ] POST /api/shipping/sales-orders/:id/override-allergen endpoint implemented (Manager+ only)
- [ ] GET /api/shipping/customers/:id/orders endpoint implemented
- [ ] Allergen validation logic correctly compares customer restrictions vs product allergens
- [ ] Validation runs on SO confirm, line add/edit, and manual trigger
- [ ] AllergenAlert component displays conflicts in red banner
- [ ] Manager override modal captures reason and creates audit log
- [ ] Override success changes alert to orange with reason displayed
- [ ] Non-Manager users cannot see/use override button
- [ ] SO confirmation blocked when allergen_validated = false (unless overridden)
- [ ] Customer order history tab displays orders with pagination
- [ ] Order history links to SO detail page
- [ ] RLS policies enforce multi-tenant isolation for audit_logs
- [ ] Validation completes within 1 second for orders with 50 lines
- [ ] Unit tests cover validation logic (>90% coverage)
- [ ] Integration tests cover all API endpoints
- [ ] E2E test: Create SO with allergen conflict, validate, override as Manager, confirm order

---

## Future Phases (Not in This Story)

### Phase 1B
- **Allergen separation alerts in pick/pack workflows** (Story 07.9, 07.11) - Display allergen warnings during picking and packing
- **Bulk allergen validation** - Validate multiple orders at once

### Phase 2
- **Allergen labeling for shipments** - Auto-generate allergen warning labels for boxes
- **Customer notification** - Email customer when allergen conflict detected
- **Allergen conflict resolution workflow** - Multi-step approval process for overrides
- **Advanced order history analytics** - Charts, trends, repeat order patterns
- **Customer allergen history reporting** - Track allergen overrides per customer over time

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-12-16 | Initial story creation | PM-AGENT |
