# 07.8 - Pick List Generation + Assignment

**Priority**: P0 (MVP Core)
**Complexity**: M (3-4 days)
**Type:** backend + frontend
**Phase:** 1B (After Story 07.7 - Inventory Allocation)

**State:** ready
**Primary PRD:** `docs/1-BASELINE/product/modules/shipping.md` (FR-7.21, FR-7.22, FR-7.23)
**Architecture:** `docs/1-BASELINE/architecture/modules/shipping.md` (lines 141-176, 335-338, 407-427)

---

## MVP Scope

This story implements pick list generation from allocated sales orders, including both single-order and wave (multi-order) picking. Covers pick list creation, pick line generation with location-based sequencing, and picker assignment workflow.

**What's IN scope:**
- `pick_lists` table with auto-generated pick_list_number (PL-YYYY-NNNNN)
- `pick_list_lines` table with license plate allocations and pick_sequence
- POST /api/shipping/pick-lists (create from single SO or wave of SOs)
- POST /api/shipping/pick-lists/:id/assign (assign to picker)
- GET /api/shipping/pick-lists (list with filters)
- GET /api/shipping/pick-lists/my-picks (picker's assigned lists)
- PickListTable component (desktop)
- PickLinesTable component (grouped by location)
- AssignPickerModal component
- Pick sequence auto-generation (sorted by zone, aisle, bin)
- Status workflow: pending → assigned → in_progress → completed

**What's OUT of scope (deferred to other stories):**
- Pick confirmation workflow (Story 07.9 Desktop, 07.10 Scanner)
- Route optimization algorithm (Phase 2, Story 07.30)
- Short pick handling (Story 07.9)
- Pick performance metrics (Phase 3, Story 07.33)

---

## Dependencies

### Epic Dependencies
- **Epic 01.1** - Organizations, RLS, users, roles (HARD)
- **Epic 01.8** - Warehouses (HARD)
- **Epic 01.9** - Locations (zone, aisle, bin hierarchy) (HARD)
- **Epic 02.1** - Products (HARD)
- **Epic 05.1** - License Plates (HARD)
- **Epic 05.3** - LP Reservations/Allocations (HARD)

### Story Dependencies (within Epic 07)
- **07.3** - Sales Orders CRUD (provides sales_orders table)
- **07.4** - SO Lines Management (provides sales_order_lines table)
- **07.5** - SO Confirmation (triggers allocation)
- **07.7** - Inventory Allocation (provides inventory_allocations records) **[BLOCKER]**

### Provides To
- **07.9** - Pick Confirmation Desktop (consumes pick lists)
- **07.10** - Pick Confirmation Scanner (consumes pick lists)
- **07.11** - Packing Station (picks feed into packing)

---

## Goal

Enable warehouse operators to generate pick lists from allocated sales orders (single or wave), assign them to pickers, and provide a structured pick route optimized by location hierarchy to minimize travel time and improve picking efficiency.

## User Story

As a **warehouse manager**, I want to **generate pick lists from allocated sales orders and assign them to pickers** so that **warehouse staff have clear picking instructions sorted by location, reducing pick time and errors**.

## Scope

**In scope (this story)**
- Database tables: `pick_lists`, `pick_list_lines`
- Auto-generate pick_list_number: PL-YYYY-NNNNN (sequential per org)
- Create pick list from single sales order
- Create wave pick list from multiple sales orders (basic consolidation)
- Generate pick lines from inventory_allocations (1 line per LP allocation)
- Auto-calculate pick_sequence by location hierarchy (zone → aisle → bin)
- Assign pick list to picker user
- List pick lists with filters (status, assigned_to, priority)
- Picker view: "My Picks" (assigned to current user)
- Desktop UI: PickListTable, PickLinesTable, AssignPickerModal
- RLS policies for multi-tenant isolation
- Cascade delete: if SO cancelled, delete associated pick lists

**Out of scope (this story)**
- Pick confirmation (scan/enter picked quantities) - Story 07.9/07.10
- Short pick handling - Story 07.9
- Pick list cancellation workflow - Story 07.9
- Advanced route optimization (TSP algorithm) - Phase 2
- Pick performance tracking - Phase 3
- Batch picking (pick-to-box) - Phase 2

---

## Acceptance Criteria (Given/When/Then)

### AC-1: Auto-Generate Pick List Number

**Given** an organization with existing pick lists
**When** a warehouse manager creates a new pick list
**Then** the system generates a unique pick_list_number in format PL-YYYY-NNNNN (e.g., PL-2025-00042)
**And** the sequence increments per org (not global)
**And** the number is stored in pick_lists.pick_list_number

### AC-2: Create Pick List from Single Sales Order

**Given** a confirmed sales order with status = 'allocated'
**And** the SO has inventory_allocations records
**When** the user clicks "Create Pick List" on the SO detail page
**Then** the system creates a new pick_list record with:
- pick_type = 'single_order'
- status = 'pending'
- priority = 'normal' (default)
- created_by = current user
**And** generates pick_list_lines from inventory_allocations (1 line per LP)
**And** each pick_list_line includes:
- sales_order_line_id
- license_plate_id (from allocation)
- location_id (from license_plates.location_id)
- product_id
- lot_number (from license_plate)
- quantity_to_pick (from allocation.quantity_allocated)
- pick_sequence (calculated by location sort)
**And** updates sales_order.status to 'picking'

### AC-3: Generate Pick Lines with Location-Based Sequencing

**Given** a pick list with multiple pick lines across different locations
**When** the system generates pick_sequence values
**Then** lines are sorted by:
1. locations.zone (alphabetical: Chilled → Dry → Frozen)
2. locations.aisle (numeric/alphabetical)
3. locations.bin (numeric/alphabetical)
**And** pick_sequence is assigned as integer (1, 2, 3, ...)
**And** the picker follows this sequence to minimize warehouse travel

### AC-4: Create Wave Pick List from Multiple Sales Orders

**Given** 3 confirmed sales orders with status = 'allocated'
**When** the warehouse manager selects all 3 SOs and clicks "Create Wave Pick List"
**Then** the system creates a new pick_list record with:
- pick_type = 'wave'
- status = 'pending'
- wave_id = unique identifier for this wave
**And** generates pick_list_lines from all SOs' allocations
**And** consolidates lines with same product + location (sum quantities)
**And** sorts by location hierarchy (pick_sequence)
**And** updates all 3 sales_orders.status to 'picking'

### AC-5: Assign Pick List to Picker

**Given** a pick list with status = 'pending'
**When** the warehouse manager clicks "Assign Picker" and selects a user
**Then** the system updates pick_list.assigned_to = selected user_id
**And** updates pick_list.status = 'assigned'
**And** the pick list appears in the picker's "My Picks" view
**And** only users with role 'Picker', 'Warehouse', 'Manager', or 'Admin' can be assigned

### AC-6: List Pick Lists with Filters

**Given** a warehouse with 20 pick lists in various statuses
**When** the user navigates to /shipping/pick-lists
**Then** the system displays a PickListTable with columns:
- Pick List #
- Type (single_order / wave)
- Status (badge with color)
- Priority
- Assigned To (user name)
- Created At
- Actions (Assign, View, Cancel)
**And** supports filters:
- Status (multi-select: pending, assigned, in_progress, completed)
- Assigned To (user dropdown)
- Priority (low, normal, high, urgent)
- Date range (created_at)
**And** supports sorting by any column
**And** supports pagination (20 per page)

### AC-7: Picker View - My Picks

**Given** a picker user with 3 assigned pick lists
**When** the picker navigates to /shipping/pick-lists/my-picks
**Then** the system displays only pick lists where assigned_to = current user_id
**And** filters to status IN ('assigned', 'in_progress')
**And** sorts by priority DESC, created_at ASC (urgent first, oldest first)
**And** shows a "Start Picking" button for assigned lists
**And** shows "Continue" button for in_progress lists

### AC-8: Pick List Detail View with Pick Lines

**Given** a pick list with 12 pick lines
**When** the user clicks on a pick list number
**Then** the system displays pick list header:
- Pick List #, Type, Status, Priority
- Assigned To (editable if pending)
- Created At, Started At, Completed At
- Associated Sales Order(s) links
**And** displays PickLinesTable grouped by location:
- Zone → Aisle → Bin (collapsible groups)
- Within each location: Product, Lot, LP#, Qty to Pick
- Pick Sequence column (numeric order)
- Status indicator (pending/picked/short)
**And** shows summary stats:
- Total lines: 12
- Total quantity: 350 units
- Locations: 8

### AC-9: RLS Policy for Multi-Tenant Isolation

**Given** two organizations (Org A and Org B) in the database
**When** a user from Org A queries pick lists
**Then** the system returns only pick lists where pick_lists.org_id = Org A
**And** prevents access to Org B's pick lists via RLS policy
**And** the same isolation applies to pick_list_lines
**And** all INSERT operations auto-populate org_id from user's context

### AC-10: Cascade Delete on Sales Order Cancellation

**Given** a sales order with status = 'picking'
**And** an associated pick list with status = 'pending' or 'assigned'
**When** the user cancels the sales order
**Then** the system deletes associated pick_lists records (ON DELETE CASCADE)
**And** deletes associated pick_list_lines records (cascade from pick_lists)
**And** releases inventory_allocations
**And** if pick_list.status = 'in_progress', the system blocks cancellation with error message

---

## Implementation Notes

### API Endpoints

```typescript
// Create pick list
POST /api/shipping/pick-lists
Body: {
  sales_order_ids: string[];  // Array (1 for single, 2+ for wave)
  priority?: 'low' | 'normal' | 'high' | 'urgent';
  assigned_to?: string;  // Optional immediate assignment
}
Response: { pick_list_id: string; pick_list_number: string; }

// Assign picker
POST /api/shipping/pick-lists/:id/assign
Body: { assigned_to: string; }
Response: { success: true; }

// List pick lists
GET /api/shipping/pick-lists?status=pending&assigned_to=user123&page=1&limit=20
Response: { pick_lists: PickList[]; total: number; }

// Get pick list detail
GET /api/shipping/pick-lists/:id
Response: { pick_list: PickList; lines: PickListLine[]; }

// Get my picks (picker view)
GET /api/shipping/pick-lists/my-picks
Response: { pick_lists: PickList[]; }

// Get pick lines for a pick list
GET /api/shipping/pick-lists/:id/lines
Response: { lines: PickListLine[]; }
```

### Database Schema

```sql
-- Pick Lists Table
CREATE TABLE pick_lists (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id),
  pick_list_number TEXT NOT NULL,  -- PL-YYYY-NNNNN
  pick_type TEXT NOT NULL CHECK(pick_type IN ('single_order', 'wave')),
  status TEXT NOT NULL DEFAULT 'pending' CHECK(status IN ('pending', 'assigned', 'in_progress', 'completed', 'cancelled')),
  priority TEXT DEFAULT 'normal' CHECK(priority IN ('low', 'normal', 'high', 'urgent')),
  assigned_to UUID REFERENCES users(id),
  wave_id UUID,  -- Optional grouping for wave picks
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  created_by UUID NOT NULL REFERENCES users(id),
  started_at TIMESTAMPTZ,
  completed_at TIMESTAMPTZ,

  UNIQUE(org_id, pick_list_number)
);

-- Pick List Lines Table
CREATE TABLE pick_list_lines (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id),
  pick_list_id UUID NOT NULL REFERENCES pick_lists(id) ON DELETE CASCADE,
  sales_order_line_id UUID NOT NULL REFERENCES sales_order_lines(id),
  license_plate_id UUID REFERENCES license_plates(id),  -- Suggested LP
  location_id UUID NOT NULL REFERENCES locations(id),
  product_id UUID NOT NULL REFERENCES products(id),
  lot_number TEXT,  -- From license plate
  quantity_to_pick DECIMAL(15,4) NOT NULL,
  quantity_picked DECIMAL(15,4) DEFAULT 0,
  pick_sequence INTEGER,  -- Route optimization
  status TEXT DEFAULT 'pending' CHECK(status IN ('pending', 'picked', 'short')),
  picked_license_plate_id UUID REFERENCES license_plates(id),  -- Actual LP picked
  picked_at TIMESTAMPTZ,
  picked_by UUID REFERENCES users(id)
);

-- Indexes
CREATE INDEX idx_pick_lists_org_status ON pick_lists(org_id, status);
CREATE INDEX idx_pick_lists_assigned ON pick_lists(assigned_to);
CREATE INDEX idx_pick_list_lines_list ON pick_list_lines(pick_list_id);
CREATE INDEX idx_pick_list_lines_status ON pick_list_lines(status);
CREATE INDEX idx_pick_list_lines_location ON pick_list_lines(location_id);

-- RLS Policies
ALTER TABLE pick_lists ENABLE ROW LEVEL SECURITY;
ALTER TABLE pick_list_lines ENABLE ROW LEVEL SECURITY;

CREATE POLICY "pick_lists_org_isolation" ON pick_lists
  FOR ALL USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

CREATE POLICY "pick_list_lines_org_isolation" ON pick_list_lines
  FOR ALL USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

-- Auto-increment pick_list_number function
CREATE OR REPLACE FUNCTION generate_pick_list_number(org_uuid UUID)
RETURNS TEXT AS $$
DECLARE
  next_seq INTEGER;
  year_str TEXT;
BEGIN
  year_str := TO_CHAR(CURRENT_DATE, 'YYYY');

  -- Get next sequence for this org and year
  SELECT COALESCE(MAX(
    CAST(SUBSTRING(pick_list_number FROM 9) AS INTEGER)
  ), 0) + 1 INTO next_seq
  FROM pick_lists
  WHERE org_id = org_uuid
    AND pick_list_number LIKE 'PL-' || year_str || '-%';

  RETURN 'PL-' || year_str || '-' || LPAD(next_seq::TEXT, 5, '0');
END;
$$ LANGUAGE plpgsql;
```

### Frontend Components

```typescript
// apps/frontend/app/(authenticated)/shipping/pick-lists/page.tsx
// Main pick list list page

// apps/frontend/app/(authenticated)/shipping/pick-lists/[id]/page.tsx
// Pick list detail page

// apps/frontend/app/(authenticated)/shipping/pick-lists/my-picks/page.tsx
// Picker view (assigned to me)

// apps/frontend/app/(authenticated)/shipping/pick-lists/components/PickListTable.tsx
import { DataTable } from '@/components/ui/data-table';

export function PickListTable({ pickLists }: { pickLists: PickList[] }) {
  // Columns: pick_list_number, type, status, priority, assigned_to, created_at
  // Filters: status, assigned_to, priority, date range
  // Actions: Assign, View, Cancel
}

// apps/frontend/app/(authenticated)/shipping/pick-lists/components/PickLinesTable.tsx
export function PickLinesTable({ lines }: { lines: PickListLine[] }) {
  // Group by location (zone → aisle → bin)
  // Columns: pick_sequence, location, product, lot, LP#, qty_to_pick, status
  // Sortable by pick_sequence
}

// apps/frontend/app/(authenticated)/shipping/pick-lists/components/AssignPickerModal.tsx
import { Dialog } from '@/components/ui/dialog';
import { Select } from '@/components/ui/select';

export function AssignPickerModal({ pickListId, onSuccess }: Props) {
  // User dropdown (filter to Picker/Warehouse roles)
  // POST /api/shipping/pick-lists/:id/assign
  // Success toast + refresh list
}

// apps/frontend/app/(authenticated)/shipping/sales-orders/[id]/page.tsx
// Add "Create Pick List" button to SO detail page
// Only enabled if status = 'allocated'
```

### Services

```typescript
// lib/services/pick-list-service.ts
import { supabase } from '@/lib/supabase/client';
import { getOrgId } from '@/lib/auth/context';

export class PickListService {
  /**
   * Create pick list from sales orders
   * Supports single-order or wave (multi-order)
   */
  static async createPickList(params: {
    sales_order_ids: string[];
    priority?: string;
    assigned_to?: string;
  }): Promise<{ pick_list_id: string; pick_list_number: string }> {
    const org_id = await getOrgId();
    const pick_type = params.sales_order_ids.length > 1 ? 'wave' : 'single_order';
    const wave_id = pick_type === 'wave' ? crypto.randomUUID() : null;

    // 1. Generate pick list number
    const { data: numberData } = await supabase.rpc('generate_pick_list_number', {
      org_uuid: org_id
    });

    // 2. Create pick list record
    const { data: pickList, error: plError } = await supabase
      .from('pick_lists')
      .insert({
        org_id,
        pick_list_number: numberData,
        pick_type,
        status: params.assigned_to ? 'assigned' : 'pending',
        priority: params.priority || 'normal',
        assigned_to: params.assigned_to || null,
        wave_id,
        created_by: (await supabase.auth.getUser()).data.user?.id
      })
      .select()
      .single();

    if (plError) throw plError;

    // 3. Fetch allocations for these sales orders
    const { data: allocations } = await supabase
      .from('inventory_allocations')
      .select(`
        id,
        sales_order_line_id,
        license_plate_id,
        quantity_allocated,
        sales_order_lines!inner(product_id),
        license_plates!inner(location_id, lot_number)
      `)
      .in('sales_order_lines.sales_order_id', params.sales_order_ids)
      .eq('released_at', null);  // Active allocations only

    // 4. Fetch locations for sorting
    const locationIds = [...new Set(allocations.map(a => a.license_plates.location_id))];
    const { data: locations } = await supabase
      .from('locations')
      .select('id, zone, aisle, bin')
      .in('id', locationIds);

    // 5. Sort allocations by location hierarchy
    const sortedAllocations = this.sortByLocation(allocations, locations);

    // 6. Create pick list lines
    const pickLines = sortedAllocations.map((alloc, index) => ({
      org_id,
      pick_list_id: pickList.id,
      sales_order_line_id: alloc.sales_order_line_id,
      license_plate_id: alloc.license_plate_id,
      location_id: alloc.license_plates.location_id,
      product_id: alloc.sales_order_lines.product_id,
      lot_number: alloc.license_plates.lot_number,
      quantity_to_pick: alloc.quantity_allocated,
      pick_sequence: index + 1,
      status: 'pending'
    }));

    const { error: linesError } = await supabase
      .from('pick_list_lines')
      .insert(pickLines);

    if (linesError) throw linesError;

    // 7. Update sales order status to 'picking'
    await supabase
      .from('sales_orders')
      .update({ status: 'picking' })
      .in('id', params.sales_order_ids);

    return {
      pick_list_id: pickList.id,
      pick_list_number: pickList.pick_list_number
    };
  }

  /**
   * Sort allocations by location hierarchy (zone → aisle → bin)
   */
  private static sortByLocation(allocations: any[], locations: any[]): any[] {
    const locationMap = new Map(locations.map(loc => [loc.id, loc]));

    return allocations.sort((a, b) => {
      const locA = locationMap.get(a.license_plates.location_id);
      const locB = locationMap.get(b.license_plates.location_id);

      // Sort by zone (alphabetical)
      if (locA.zone !== locB.zone) {
        return locA.zone.localeCompare(locB.zone);
      }

      // Sort by aisle (alphanumeric)
      if (locA.aisle !== locB.aisle) {
        return locA.aisle.localeCompare(locB.aisle, undefined, { numeric: true });
      }

      // Sort by bin (alphanumeric)
      return locA.bin.localeCompare(locB.bin, undefined, { numeric: true });
    });
  }

  /**
   * Assign pick list to picker
   */
  static async assignPicker(pickListId: string, userId: string): Promise<void> {
    const org_id = await getOrgId();

    const { error } = await supabase
      .from('pick_lists')
      .update({
        assigned_to: userId,
        status: 'assigned'
      })
      .eq('id', pickListId)
      .eq('org_id', org_id)
      .eq('status', 'pending');  // Only assign pending lists

    if (error) throw error;
  }

  /**
   * Get pick lists with filters
   */
  static async getPickLists(filters: {
    status?: string[];
    assigned_to?: string;
    priority?: string;
    page?: number;
    limit?: number;
  }): Promise<{ pick_lists: PickList[]; total: number }> {
    const org_id = await getOrgId();
    const limit = filters.limit || 20;
    const offset = ((filters.page || 1) - 1) * limit;

    let query = supabase
      .from('pick_lists')
      .select('*, assigned_user:users!assigned_to(name)', { count: 'exact' })
      .eq('org_id', org_id);

    if (filters.status?.length) {
      query = query.in('status', filters.status);
    }

    if (filters.assigned_to) {
      query = query.eq('assigned_to', filters.assigned_to);
    }

    if (filters.priority) {
      query = query.eq('priority', filters.priority);
    }

    query = query
      .order('created_at', { ascending: false })
      .range(offset, offset + limit - 1);

    const { data, count, error } = await query;

    if (error) throw error;

    return { pick_lists: data || [], total: count || 0 };
  }

  /**
   * Get pick lists assigned to current user
   */
  static async getMyPicks(): Promise<PickList[]> {
    const org_id = await getOrgId();
    const user = (await supabase.auth.getUser()).data.user;

    const { data, error } = await supabase
      .from('pick_lists')
      .select('*')
      .eq('org_id', org_id)
      .eq('assigned_to', user?.id)
      .in('status', ['assigned', 'in_progress'])
      .order('priority', { ascending: false })
      .order('created_at', { ascending: true });

    if (error) throw error;

    return data || [];
  }

  /**
   * Get pick list with lines
   */
  static async getPickListDetail(pickListId: string): Promise<{
    pick_list: PickList;
    lines: PickListLine[];
  }> {
    const org_id = await getOrgId();

    const { data: pickList, error: plError } = await supabase
      .from('pick_lists')
      .select('*, assigned_user:users!assigned_to(name)')
      .eq('id', pickListId)
      .eq('org_id', org_id)
      .single();

    if (plError) throw plError;

    const { data: lines, error: linesError } = await supabase
      .from('pick_list_lines')
      .select(`
        *,
        product:products(name, sku),
        location:locations(zone, aisle, bin, name),
        license_plate:license_plates(lp_number)
      `)
      .eq('pick_list_id', pickListId)
      .eq('org_id', org_id)
      .order('pick_sequence', { ascending: true });

    if (linesError) throw linesError;

    return { pick_list: pickList, lines: lines || [] };
  }
}
```

### Validation (Zod)

```typescript
// lib/validation/pick-list-schema.ts
import { z } from 'zod';

export const createPickListSchema = z.object({
  sales_order_ids: z.array(z.string().uuid()).min(1, 'At least one sales order required'),
  priority: z.enum(['low', 'normal', 'high', 'urgent']).optional(),
  assigned_to: z.string().uuid().optional()
});

export const assignPickerSchema = z.object({
  assigned_to: z.string().uuid('Invalid user ID')
});

export const pickListFiltersSchema = z.object({
  status: z.array(z.enum(['pending', 'assigned', 'in_progress', 'completed', 'cancelled'])).optional(),
  assigned_to: z.string().uuid().optional(),
  priority: z.enum(['low', 'normal', 'high', 'urgent']).optional(),
  page: z.number().int().positive().optional(),
  limit: z.number().int().positive().max(100).optional()
});

export type CreatePickListInput = z.infer<typeof createPickListSchema>;
export type AssignPickerInput = z.infer<typeof assignPickerSchema>;
export type PickListFilters = z.infer<typeof pickListFiltersSchema>;
```

### Key Business Rules

1. **Pick List Number Format**: PL-YYYY-NNNNN (sequential per org, resets annually)
2. **Pick Type**: 'single_order' if 1 SO, 'wave' if 2+ SOs
3. **Status Workflow**: pending → assigned → in_progress → completed (Stories 07.9/07.10 handle transitions)
4. **Location Sorting**: Zone (alpha) → Aisle (numeric) → Bin (numeric)
5. **Allocation to Pick Line**: 1 inventory_allocation = 1 pick_list_line (no consolidation in this story)
6. **Wave Grouping**: wave_id links all pick lists in a wave (future use)
7. **RLS Enforcement**: All queries filtered by org_id
8. **Cascade Delete**: Deleting sales_order deletes pick_lists (if status = pending/assigned only)
9. **Role Filter**: Only users with role 'Picker', 'Warehouse', 'Manager', or 'Admin' can be assigned
10. **SO Status Update**: Creating pick list updates sales_order.status to 'picking'

---

## Food Safety Rules

### Allergen Separation Alerts

While this story doesn't implement allergen validation (deferred to Story 07.9), the pick_list_lines table supports future allergen separation:
- Each line links to product (which has allergens)
- Future enhancement: Display allergen alerts in PickLinesTable
- Future enhancement: Suggest separate pick containers for allergen products

### FIFO/FEFO Enforcement

- Pick lines inherit lot_number from license_plates
- Story 07.7 (Allocation) already enforced FIFO/FEFO during allocation
- This story displays lot_number in pick lines for traceability
- Future: Warn picker if not picking oldest lot (Story 07.10 Scanner)

---

## GS1 Compliance

Not applicable to this story (picking workflow). GS1 SSCC labels are generated during packing (Story 07.13).

---

## Deliverables

### Database
- Migration: `supabase/migrations/YYYYMMDDHHMMSS_create_pick_lists.sql`
  - `pick_lists` table
  - `pick_list_lines` table
  - Indexes
  - RLS policies
  - `generate_pick_list_number()` function

### API Routes
- `apps/frontend/app/api/shipping/pick-lists/route.ts` (GET, POST)
- `apps/frontend/app/api/shipping/pick-lists/[id]/route.ts` (GET)
- `apps/frontend/app/api/shipping/pick-lists/[id]/assign/route.ts` (POST)
- `apps/frontend/app/api/shipping/pick-lists/[id]/lines/route.ts` (GET)
- `apps/frontend/app/api/shipping/pick-lists/my-picks/route.ts` (GET)

### Services
- `lib/services/pick-list-service.ts`

### Validation
- `lib/validation/pick-list-schema.ts`

### Frontend Pages
- `apps/frontend/app/(authenticated)/shipping/pick-lists/page.tsx`
- `apps/frontend/app/(authenticated)/shipping/pick-lists/[id]/page.tsx`
- `apps/frontend/app/(authenticated)/shipping/pick-lists/my-picks/page.tsx`

### Components
- `apps/frontend/app/(authenticated)/shipping/pick-lists/components/PickListTable.tsx`
- `apps/frontend/app/(authenticated)/shipping/pick-lists/components/PickLinesTable.tsx`
- `apps/frontend/app/(authenticated)/shipping/pick-lists/components/AssignPickerModal.tsx`

### Tests
- `lib/services/__tests__/pick-list-service.test.ts` (unit tests)
- `tests/e2e/shipping/pick-list-generation.spec.ts` (E2E tests)

---

## Definition of Done

- [ ] Database migration applied (pick_lists, pick_list_lines tables)
- [ ] RLS policies enabled and tested (multi-tenant isolation)
- [ ] generate_pick_list_number() function working (PL-YYYY-NNNNN format)
- [ ] POST /api/shipping/pick-lists creates pick list with lines
- [ ] Pick sequence auto-calculated by location hierarchy
- [ ] POST /api/shipping/pick-lists/:id/assign updates status to 'assigned'
- [ ] GET /api/shipping/pick-lists supports filters (status, assigned_to, priority)
- [ ] GET /api/shipping/pick-lists/my-picks returns current user's picks
- [ ] PickListTable component displays pick lists with filters
- [ ] PickLinesTable component groups by location (zone/aisle/bin)
- [ ] AssignPickerModal assigns picker and refreshes view
- [ ] SO status updates to 'picking' when pick list created
- [ ] Cascade delete works (cancel SO deletes pending/assigned pick lists)
- [ ] Unit tests pass (>80% coverage for PickListService)
- [ ] E2E test: Create single-order pick list → Verify lines sorted by location
- [ ] E2E test: Create wave pick list from 3 SOs → Verify all lines consolidated
- [ ] E2E test: Assign picker → Verify appears in "My Picks"
- [ ] Multi-tenant isolation verified (Org A cannot see Org B's pick lists)

---

## Future Phases (Not in This Story)

### Phase 1B (Stories 07.9/07.10)
- Pick confirmation workflow (desktop + scanner)
- Short pick handling (capture reason, create backorder)
- Pick list cancellation
- Start/Complete pick list (status transitions)

### Phase 2
- Advanced route optimization (TSP algorithm) - Story 07.30
- Batch picking (pick-to-box) - Story 07.32
- Pick performance metrics (lines/hour, accuracy) - Story 07.33

### Phase 3
- Predictive pick time estimation
- Pick list scheduling (time slots)
- Heat maps (most-picked locations)

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-12-16 | Initial story creation | PM-AGENT |
