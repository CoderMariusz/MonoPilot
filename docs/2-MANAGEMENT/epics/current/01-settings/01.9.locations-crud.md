# 01.9 - Locations CRUD (Hierarchical)

---

## ðŸš§ V2 MIGRATION - CRITICAL REWRITE

**âš ï¸ THIS STORY REQUIRES COMPLETE REWRITE (v1 code is wrong architecture)**

### **Build Location:**
```
âœ… CREATE: apps/frontend/app/(authenticated)/settings-v2/locations/
âœ… CREATE: apps/frontend/components/settings-v2/locations/
âŒ DO NOT EDIT: app/(authenticated)/settings/locations/ (v1 frozen)
```

### **Why Complete Rewrite:**
- **V1 Architecture:** Flat table with types (receiving/production/storage)
- **V2 Architecture:** Tree view with types (Zone/Aisle/Rack/Bin/Shelf/Bulk)
- **Cannot refactor:** Fundamentally different data structure and UI

### **Your Resources:**
- **Handoff:** `docs/2-MANAGEMENT/epics/current/01-settings/agent-handoffs/01-CRITICAL-locations-tree-rewrite.yaml`
- **Wireframes:** `docs/3-ARCHITECTURE/ux/wireframes/SET-014-location-hierarchy-view.md`, `SET-015-location-create-edit-modal.md`
- **Migration Plan:** `docs/2-MANAGEMENT/EPIC-01-MIGRATION-PLAN.md` (section 2.5)
- **Master Prompt:** `docs/2-MANAGEMENT/epics/current/01-settings/MASTER-PROMPT-FOR-AGENTS.md`

### **Isolation Rules:**
- âŒ DO NOT import from `@/app/(authenticated)/settings/locations/*`
- âŒ DO NOT copy UI from v1 (wrong design!)
- âœ… CAN reference v1 for API patterns only
- âœ… MUST update `lib/validation/location-schemas.ts` (change types to Zone/Aisle/Rack/Bin)

### **Verification:**
```bash
bash scripts/check-settings-v2-isolation.sh
```

**Estimated Effort:** 14-16 hours (LONGEST in Epic 1)
**Priority:** HIGHEST (validates parallel build approach)

---

_Original story content below â†“_

---

| Field | Value |
|-------|-------|
| **Story ID** | 01.9 |
| **Epic** | 01 - Settings |
| **Status** | Ready |
| **Phase** | 1B |
| **Complexity** | L |
| **Estimate** | 8-12 hours |
| **Type** | Full-stack |

## PRD References

| FR ID | Requirement | Priority | Coverage |
|-------|-------------|----------|----------|
| FR-SET-042 | Location hierarchy (zone/aisle/rack/bin) | P0 | Full |
| FR-SET-043 | Location capacity tracking | P1 | Full |
| FR-SET-044 | Location type (bulk/pallet/shelf/floor/staging) | P1 | Full |

**PRD Source:** `docs/1-BASELINE/product/modules/settings.md`

## User Story

**As a** warehouse administrator,
**I want to** create hierarchical storage locations within warehouses (zone > aisle > rack > bin),
**So that** inventory can be tracked at precise physical positions with capacity constraints.

## Dependencies

| Dependency | Type | Status | Notes |
|------------|------|--------|-------|
| Story 01.8 | Hard | Pending | Warehouses CRUD - locations belong to warehouses |
| Story 01.1 | Hard | Ready | Org context + RLS - required for multi-tenancy |
| Story 01.6 | Soft | Ready | Role permissions - Admin+ can manage locations |

## Acceptance Criteria (Gherkin)

### Location Hierarchy (FR-SET-042)

```gherkin
Feature: Location Hierarchy Management

  Scenario: Create zone under warehouse
    Given warehouse "WH-001" exists
    When admin creates location with:
      | code | ZONE-A |
      | name | Raw Materials Zone |
      | level | zone |
      | parent_id | null |
      | warehouse_id | WH-001 |
    Then location "ZONE-A" appears in location tree under WH-001
    And full_path is "WH-001/ZONE-A"

  Scenario: Create aisle under zone
    Given zone "ZONE-A" exists under warehouse "WH-001"
    When admin creates location with:
      | code | A01 |
      | name | Aisle 01 |
      | level | aisle |
      | parent_id | ZONE-A |
    Then location "A01" appears as child of ZONE-A
    And full_path is "WH-001/ZONE-A/A01"

  Scenario: Create rack under aisle
    Given aisle "A01" exists under zone "ZONE-A"
    When admin creates location with:
      | code | R01 |
      | name | Rack 01 |
      | level | rack |
      | parent_id | A01 |
    Then location "R01" appears as child of A01
    And full_path is "WH-001/ZONE-A/A01/R01"

  Scenario: Create bin under rack
    Given rack "R01" exists under aisle "A01"
    When admin creates location with:
      | code | B001 |
      | name | Bin 001 |
      | level | bin |
      | parent_id | R01 |
    Then location "B001" appears as child of R01
    And full_path is "WH-001/ZONE-A/A01/R01/B001"

  Scenario: Expand location tree node
    Given zone "ZONE-A" has 5 aisles with racks and bins
    When admin clicks expand icon on ZONE-A
    Then child locations display within 200ms
    And expand/collapse state persists during session

  Scenario: Display full path in location search
    Given location path is "WH-001/ZONE-A/A01/R01/B001"
    When location searched by code "B001"
    Then search result shows full path breadcrumb

  Scenario: Enforce level hierarchy
    Given zone "ZONE-A" exists (level=zone)
    When admin attempts to create bin directly under zone
    Then error "Bins must be under racks, not zones" displays
    And form submission is blocked
```

### Location Capacity Tracking (FR-SET-043)

```gherkin
Feature: Location Capacity Tracking

  Scenario: Set pallet capacity for location
    Given admin creates location "ZONE-A"
    When admin enters max_pallets = 50
    Then location saved with capacity 50 pallets

  Scenario: Set weight capacity for location
    Given admin creates location "R01" (rack)
    When admin enters max_weight_kg = 2000
    Then location saved with weight capacity 2000 kg

  Scenario: Display capacity indicator
    Given location "B001" has max_pallets = 4 and current_pallets = 3
    When location list viewed
    Then capacity indicator shows "3/4 pallets (75%)"
    And indicator is yellow (warning threshold 70%)

  Scenario: Capacity at 100%
    Given location "B001" has max_pallets = 4 and current_pallets = 4
    When location viewed
    Then capacity indicator shows "4/4 pallets (100%)"
    And indicator is red (full)

  Scenario: No capacity limit
    Given location created without max_pallets
    When location viewed
    Then capacity shows "Unlimited" or no indicator

  Scenario: Inherit capacity from parent
    Given zone "ZONE-A" has max_weight_kg = 10000
    When creating aisle under ZONE-A without specifying weight
    Then aisle inherits zone's weight limit for validation reference
```

### Location Types (FR-SET-044)

```gherkin
Feature: Location Types

  Scenario: Select location type from dropdown
    Given admin opens location create modal
    When admin clicks location type dropdown
    Then options display:
      | Type | Description |
      | bulk | Bulk storage area |
      | pallet | Pallet racking |
      | shelf | Shelf storage |
      | floor | Floor marking |
      | staging | Staging area |

  Scenario: Create bulk storage location
    Given admin creates zone with type "bulk"
    When zone saved
    Then zone displays with "Bulk" badge in tree view

  Scenario: Create staging area
    Given admin creates location with type "staging"
    When location saved
    Then location displays with "Staging" badge
    And location type icon is distinct from storage types

  Scenario: Filter locations by type
    Given warehouse has 20 locations of various types
    When admin filters by type "pallet"
    Then only pallet-type locations display
```

### Location CRUD Operations

```gherkin
Feature: Location CRUD

  Scenario: List locations for warehouse
    Given warehouse "WH-001" has 15 locations
    When admin opens warehouse locations tab
    Then locations display in tree structure
    And root nodes (zones) show first with expand icons

  Scenario: Create location with validation
    Given admin opens create location modal
    When admin submits form with:
      | code | (empty) |
      | name | Test Location |
    Then validation error "Code is required" displays

  Scenario: Location code uniqueness
    Given location "ZONE-A" exists in WH-001
    When admin creates another location with code "ZONE-A" in WH-001
    Then error "Location code must be unique within warehouse" displays

  Scenario: Edit location
    Given location "ZONE-A" exists with name "Zone A"
    When admin updates name to "Raw Materials Zone"
    Then location name updates successfully
    And updated_at timestamp refreshes

  Scenario: Delete empty location
    Given location "B001" exists with no inventory and no child locations
    When admin clicks delete and confirms
    Then location removed within 500ms
    And success toast displays

  Scenario: Delete location with children
    Given zone "ZONE-A" has 3 aisles underneath
    When admin attempts to delete ZONE-A
    Then error "Delete child locations first" displays
    And deletion is blocked

  Scenario: Delete location with inventory
    Given location "B001" has 5 license plates assigned
    When admin attempts to delete B001
    Then error "Location has inventory (5 items). Relocate first." displays
    And deletion is blocked
```

### Multi-tenancy

```gherkin
Feature: Location Multi-tenancy

  Scenario: Org isolation on list
    Given User A belongs to Org A with 10 locations
    And User B belongs to Org B with 8 locations
    When User A requests locations
    Then only Org A's 10 locations return

  Scenario: Cross-tenant access returns 404
    Given Location X belongs to Org B
    When User A from Org A requests Location X by ID
    Then 404 Not Found returns (not 403)
```

## Technical Specification

### Database Schema

```sql
-- Location types enum (seeded reference)
CREATE TYPE location_type AS ENUM (
  'bulk',
  'pallet',
  'shelf',
  'floor',
  'staging'
);

-- Location levels enum
CREATE TYPE location_level AS ENUM (
  'zone',
  'aisle',
  'rack',
  'bin'
);

-- locations table with self-referencing parent
CREATE TABLE locations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id),
  warehouse_id UUID NOT NULL REFERENCES warehouses(id) ON DELETE CASCADE,
  parent_id UUID REFERENCES locations(id) ON DELETE RESTRICT,

  -- Identity
  code VARCHAR(50) NOT NULL,
  name VARCHAR(255) NOT NULL,
  description TEXT,

  -- Hierarchy
  level location_level NOT NULL,
  full_path VARCHAR(500), -- Computed: WH-001/ZONE-A/A01/R01/B001
  depth INT NOT NULL DEFAULT 1, -- 1=zone, 2=aisle, 3=rack, 4=bin

  -- Type and capacity
  location_type location_type NOT NULL DEFAULT 'shelf',
  max_pallets INT,
  max_weight_kg DECIMAL(12,2),
  current_pallets INT DEFAULT 0, -- Denormalized for performance
  current_weight_kg DECIMAL(12,2) DEFAULT 0,

  -- Status
  is_active BOOLEAN DEFAULT true,

  -- Audit
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  created_by UUID REFERENCES users(id),
  updated_by UUID REFERENCES users(id),

  -- Constraints
  UNIQUE(org_id, warehouse_id, code),
  CHECK(depth BETWEEN 1 AND 4),
  CHECK(max_pallets IS NULL OR max_pallets > 0),
  CHECK(max_weight_kg IS NULL OR max_weight_kg > 0),
  CHECK(current_pallets >= 0),
  CHECK(current_weight_kg >= 0)
);

-- Indexes
CREATE INDEX idx_locations_org ON locations(org_id);
CREATE INDEX idx_locations_warehouse ON locations(warehouse_id);
CREATE INDEX idx_locations_parent ON locations(parent_id);
CREATE INDEX idx_locations_level ON locations(level);
CREATE INDEX idx_locations_type ON locations(location_type);
CREATE INDEX idx_locations_full_path ON locations(full_path);

-- Function to compute full_path
CREATE OR REPLACE FUNCTION compute_location_full_path()
RETURNS TRIGGER AS $$
DECLARE
  parent_path VARCHAR(500);
  warehouse_code VARCHAR(50);
BEGIN
  -- Get warehouse code
  SELECT code INTO warehouse_code FROM warehouses WHERE id = NEW.warehouse_id;

  IF NEW.parent_id IS NULL THEN
    -- Root level (zone)
    NEW.full_path := warehouse_code || '/' || NEW.code;
    NEW.depth := 1;
  ELSE
    -- Child location
    SELECT full_path, depth INTO parent_path, NEW.depth
    FROM locations WHERE id = NEW.parent_id;
    NEW.full_path := parent_path || '/' || NEW.code;
    NEW.depth := NEW.depth + 1;
  END IF;

  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_compute_location_path
BEFORE INSERT OR UPDATE ON locations
FOR EACH ROW EXECUTE FUNCTION compute_location_full_path();

-- Function to validate level hierarchy
CREATE OR REPLACE FUNCTION validate_location_hierarchy()
RETURNS TRIGGER AS $$
DECLARE
  parent_level location_level;
  expected_depth INT;
BEGIN
  IF NEW.parent_id IS NULL THEN
    -- Root must be zone
    IF NEW.level != 'zone' THEN
      RAISE EXCEPTION 'Root locations must be zones';
    END IF;
  ELSE
    SELECT level INTO parent_level FROM locations WHERE id = NEW.parent_id;

    -- Validate hierarchy: zone > aisle > rack > bin
    IF parent_level = 'zone' AND NEW.level != 'aisle' THEN
      RAISE EXCEPTION 'Locations under zones must be aisles';
    ELSIF parent_level = 'aisle' AND NEW.level != 'rack' THEN
      RAISE EXCEPTION 'Locations under aisles must be racks';
    ELSIF parent_level = 'rack' AND NEW.level != 'bin' THEN
      RAISE EXCEPTION 'Locations under racks must be bins';
    ELSIF parent_level = 'bin' THEN
      RAISE EXCEPTION 'Bins cannot have child locations';
    END IF;
  END IF;

  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_validate_location_hierarchy
BEFORE INSERT OR UPDATE ON locations
FOR EACH ROW EXECUTE FUNCTION validate_location_hierarchy();
```

### RLS Policies

```sql
-- Enable RLS
ALTER TABLE locations ENABLE ROW LEVEL SECURITY;

-- Select: Org isolation via users lookup
CREATE POLICY "locations_select" ON locations
FOR SELECT TO authenticated
USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

-- Insert: Org isolation with warehouse ownership check
CREATE POLICY "locations_insert" ON locations
FOR INSERT TO authenticated
WITH CHECK (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  AND warehouse_id IN (
    SELECT id FROM warehouses
    WHERE org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  )
);

-- Update: Org isolation
CREATE POLICY "locations_update" ON locations
FOR UPDATE TO authenticated
USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

-- Delete: Org isolation (deletion logic handles children/inventory checks)
CREATE POLICY "locations_delete" ON locations
FOR DELETE TO authenticated
USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));
```

### API Endpoints

Locations are nested under warehouses:

```
Base: /api/settings/warehouses/:warehouseId/locations

GET    /api/settings/warehouses/:warehouseId/locations          - List locations (tree or flat)
POST   /api/settings/warehouses/:warehouseId/locations          - Create location
GET    /api/settings/warehouses/:warehouseId/locations/:id      - Get location by ID
PUT    /api/settings/warehouses/:warehouseId/locations/:id      - Update location
DELETE /api/settings/warehouses/:warehouseId/locations/:id      - Delete location
GET    /api/settings/warehouses/:warehouseId/locations/:id/tree - Get subtree under location
```

**Query Parameters (List):**
- `view` - `tree` (default) | `flat` - Tree returns nested structure, flat returns array
- `level` - Filter by level (zone/aisle/rack/bin)
- `type` - Filter by location_type
- `parent_id` - Filter children of specific parent (null for root)
- `search` - Search by code or name
- `include_capacity` - Include current capacity stats (boolean)

**Response (Tree View):**
```typescript
interface LocationTreeResponse {
  locations: LocationNode[];
  total_count: number;
}

interface LocationNode {
  id: string;
  code: string;
  name: string;
  level: 'zone' | 'aisle' | 'rack' | 'bin';
  location_type: 'bulk' | 'pallet' | 'shelf' | 'floor' | 'staging';
  full_path: string;
  depth: number;
  max_pallets: number | null;
  max_weight_kg: number | null;
  current_pallets: number;
  current_weight_kg: number;
  capacity_percent: number | null;
  is_active: boolean;
  children: LocationNode[];
  children_count: number;
}
```

### Service Layer

**Location Service:** `lib/services/location-service.ts`

```typescript
interface LocationService {
  // CRUD
  list(warehouseId: string, params: LocationListParams): Promise<LocationTreeResponse>;
  getById(warehouseId: string, id: string): Promise<Location | null>;
  create(warehouseId: string, data: CreateLocationInput): Promise<Location>;
  update(warehouseId: string, id: string, data: UpdateLocationInput): Promise<Location>;
  delete(warehouseId: string, id: string): Promise<void>;

  // Tree operations
  getTree(warehouseId: string, parentId?: string): Promise<LocationNode[]>;
  getAncestors(locationId: string): Promise<Location[]>;
  getDescendants(locationId: string): Promise<Location[]>;
  moveLocation(locationId: string, newParentId: string): Promise<Location>;

  // Validation
  canDelete(locationId: string): Promise<{ can: boolean; reason?: string; inventory_count?: number }>;
  validateHierarchy(parentId: string | null, level: LocationLevel): Promise<boolean>;

  // Capacity
  updateCapacity(locationId: string, pallets: number, weight: number): Promise<void>;
  getCapacityStats(warehouseId: string): Promise<CapacityStats>;
}

interface LocationListParams {
  view?: 'tree' | 'flat';
  level?: LocationLevel;
  type?: LocationType;
  parent_id?: string | null;
  search?: string;
  include_capacity?: boolean;
}
```

### Zod Validation

**Location:** `lib/validation/location.ts`

```typescript
import { z } from 'zod';

const locationLevelEnum = z.enum(['zone', 'aisle', 'rack', 'bin']);
const locationTypeEnum = z.enum(['bulk', 'pallet', 'shelf', 'floor', 'staging']);

export const createLocationSchema = z.object({
  code: z.string()
    .min(1, 'Code is required')
    .max(50, 'Code max 50 characters')
    .regex(/^[A-Z0-9-]+$/, 'Code must be uppercase alphanumeric with hyphens'),
  name: z.string()
    .min(2, 'Name min 2 characters')
    .max(255, 'Name max 255 characters'),
  description: z.string().max(1000).nullable().optional(),
  parent_id: z.string().uuid().nullable().optional(),
  level: locationLevelEnum,
  location_type: locationTypeEnum.default('shelf'),
  max_pallets: z.number().int().positive().nullable().optional(),
  max_weight_kg: z.number().positive().nullable().optional(),
  is_active: z.boolean().default(true),
}).refine(data => {
  // Root locations (no parent) must be zones
  if (!data.parent_id && data.level !== 'zone') {
    return false;
  }
  return true;
}, { message: 'Root locations must be zones', path: ['level'] });

export const updateLocationSchema = createLocationSchema
  .omit({ code: true, level: true, parent_id: true }) // Immutable fields
  .partial();

export const locationQuerySchema = z.object({
  view: z.enum(['tree', 'flat']).default('tree'),
  level: locationLevelEnum.optional(),
  type: locationTypeEnum.optional(),
  parent_id: z.string().uuid().nullable().optional(),
  search: z.string().min(2).optional(),
  include_capacity: z.coerce.boolean().default(false),
});
```

## UI Components

### Location Tree View Component

**File:** `components/settings/locations/LocationTree.tsx`

```typescript
interface LocationTreeProps {
  warehouseId: string;
  locations: LocationNode[];
  selectedId?: string;
  onSelect: (location: LocationNode) => void;
  onExpand: (locationId: string) => void;
  expandedIds: Set<string>;
}
```

Features:
- Expandable/collapsible tree nodes
- Level-based indentation (16px per level)
- Location type icons (different icons per type)
- Capacity indicator bars on each node
- Click to select, double-click to edit
- Drag-and-drop for reordering (Phase 2)

### Location Form Modal

**File:** `components/settings/locations/LocationModal.tsx`

```typescript
interface LocationModalProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  warehouseId: string;
  parentLocation?: Location; // Pre-select parent if creating under existing
  location?: Location; // Edit mode if provided
  onSuccess: () => void;
}
```

Form sections:
1. **Identity** - Code (uppercase), Name, Description
2. **Hierarchy** - Parent dropdown (filtered by valid parents), Level (auto-set based on parent)
3. **Type** - Location type dropdown with descriptions
4. **Capacity** - Max pallets, Max weight (kg)
5. **Status** - Active toggle

### Capacity Indicator Component

**File:** `components/settings/locations/CapacityIndicator.tsx`

```typescript
interface CapacityIndicatorProps {
  current: number;
  max: number | null;
  unit: 'pallets' | 'kg';
  size?: 'sm' | 'md';
}
```

Visual states:
- **Green (0-69%):** Normal capacity
- **Yellow (70-89%):** Warning threshold
- **Red (90-100%):** Near/at full capacity
- **No indicator:** When max is null (unlimited)

### Breadcrumb Path Display

**File:** `components/settings/locations/LocationBreadcrumb.tsx`

```typescript
interface LocationBreadcrumbProps {
  fullPath: string; // "WH-001/ZONE-A/A01/R01/B001"
  onClick?: (segment: string, index: number) => void;
}
```

Display: `WH-001 > ZONE-A > A01 > R01 > B001`
- Each segment clickable to navigate to that level
- Current segment (last) is bold/highlighted

### Page Layout

**Page:** `app/(authenticated)/settings/warehouses/[id]/locations/page.tsx`

Layout:
- Left panel: Location tree (40% width)
- Right panel: Selected location details/form (60% width)
- Top toolbar: Create button, Type filter, Search
- Actions: Edit, Delete, Add Child

## Out of Scope

- Location barcode/label generation (Phase 2)
- Location heat maps (Phase 2)
- Bulk location import (Phase 2)
- Location reservations (Warehouse module)
- Inventory assignment to locations (Warehouse module)
- Location templates (Phase 2)
- Drag-and-drop tree reordering (Phase 2)

## Test Cases

### Unit Tests

| Test ID | Description | Expected Result |
|---------|-------------|-----------------|
| LOC-U-001 | Create location with valid data | Location created, full_path computed |
| LOC-U-002 | Create location without code | Validation error |
| LOC-U-003 | Create bin without parent | Validation error - root must be zone |
| LOC-U-004 | Create aisle under zone | Success, depth = 2 |
| LOC-U-005 | Create rack under bin | Validation error - bins have no children |
| LOC-U-006 | Duplicate code in same warehouse | Validation error |
| LOC-U-007 | Same code in different warehouses | Success (codes unique per warehouse) |
| LOC-U-008 | Capacity validation - negative pallets | Validation error |
| LOC-U-009 | Full path computation 4 levels deep | Correct path format |
| LOC-U-010 | Level hierarchy validation | Correct parent-child levels |

### Integration Tests

| Test ID | Description | Expected Result |
|---------|-------------|-----------------|
| LOC-I-001 | List locations returns tree | Nested structure with children |
| LOC-I-002 | Create via API with missing warehouse | 404 Not Found |
| LOC-I-003 | Update location name | Name updated, updated_at refreshed |
| LOC-I-004 | Delete location with children | 400 error with message |
| LOC-I-005 | Delete empty location | Success, location removed |
| LOC-I-006 | Cross-tenant access | 404 Not Found |
| LOC-I-007 | RLS filters by org | Only org locations returned |
| LOC-I-008 | Create 4-level hierarchy | All levels created correctly |

### E2E Tests

| Test ID | Description | Expected Result |
|---------|-------------|-----------------|
| LOC-E-001 | Create zone via UI | Zone appears in tree |
| LOC-E-002 | Expand/collapse tree node | Children show/hide |
| LOC-E-003 | Edit location name | Name updates in tree |
| LOC-E-004 | Delete location flow | Confirmation, removal |
| LOC-E-005 | Breadcrumb navigation | Navigates to clicked segment |
| LOC-E-006 | Capacity indicator display | Correct colors and percentages |
| LOC-E-007 | Filter by location type | Only matching types shown |
| LOC-E-008 | Search locations | Matching results with paths |

## Definition of Done

- [ ] Database migration creates `locations` table with all fields
- [ ] Full path computation trigger works correctly
- [ ] Level hierarchy validation trigger enforces zone > aisle > rack > bin
- [ ] RLS policies enforce org isolation
- [ ] API endpoints work at `/api/settings/warehouses/:warehouseId/locations`
- [ ] Tree view displays hierarchical structure
- [ ] Location modal handles create/edit with validation
- [ ] Capacity indicator shows correct colors
- [ ] Breadcrumb displays full path with navigation
- [ ] Delete blocked for locations with children
- [ ] Delete blocked for locations with inventory
- [ ] Code uniqueness enforced per warehouse
- [ ] Unit tests pass (>80% coverage)
- [ ] Integration tests pass
- [ ] E2E tests pass
- [ ] Loading states for tree expansion
- [ ] Error handling with user-friendly messages
- [ ] Toast notifications on success/error

## Version History

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| 1.0 | 2025-12-16 | ARCHITECT-AGENT | Initial story creation |
