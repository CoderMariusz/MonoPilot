# Story Context: 01.8 Warehouses CRUD
# Generated: 2025-12-16
# Purpose: AI agent context for implementing warehouse management with type classification and default assignment

story:
  id: "01.8"
  name: "Warehouses CRUD"
  epic: "01-settings"
  phase: "1B"
  complexity: "M"
  estimate_days: 4
  type: "frontend + backend"
  state: "ready"
  priority: "P0"
  story_file: "docs/2-MANAGEMENT/epics/current/01-settings/01.8.warehouses-crud.md"

dependencies:
  required:
    - story: "01.1"
      name: "Org Context + Base RLS"
      provides:
        - "organizations table"
        - "users table with org_id"
        - "RLS foundation"
        - "auth context"
    - story: "01.2"
      name: "Settings Shell + Navigation"
      provides:
        - "Settings layout"
        - "Navigation guards"
        - "Sidebar navigation structure"
    - story: "01.6"
      name: "Role Permissions"
      provides:
        - "10-role permission system"
        - "roles table with predefined roles"
        - "Permission enforcement (ADMIN, WH_MANAGER allowed)"
        - "hasPermission() helper function"
        - "usePermissions() React hook"
  dependents:
    - story: "01.9"
      name: "Locations CRUD"
      requires: "warehouses table for location hierarchy"
    - story: "01.5b"
      name: "User Warehouse Access"
      requires: "warehouses for access assignment"
    - epic: "05"
      name: "Warehouse Module"
      requires: "warehouse infrastructure for inventory operations"

files_to_read:
  prd: "docs/1-BASELINE/product/modules/settings.md"
  prd_sections:
    - "FR-SET-040"  # Warehouse CRUD (create, read, update, delete)
    - "FR-SET-041"  # Warehouse type (raw/wip/finished/quarantine/general)
    - "FR-SET-042"  # Location hierarchy (REF ONLY - Story 01.9)
    - "FR-SET-043"  # Location capacity tracking (REF ONLY - Story 01.9)
    - "FR-SET-044"  # Location type (REF ONLY - Story 01.9)
    - "FR-SET-045"  # Warehouse address and contact
    - "FR-SET-046"  # Default warehouse assignment
  architecture: "docs/1-BASELINE/architecture/modules/settings.md"
  story: "docs/2-MANAGEMENT/epics/current/01-settings/01.8.warehouses-crud.md"
  adrs:
    - "docs/1-BASELINE/architecture/decisions/ADR-013-rls-org-isolation-pattern.md"
  patterns:
    - "apps/frontend/lib/validation/*.ts"  # Existing Zod schema patterns
    - "apps/frontend/components/ui/data-table.tsx"  # ShadCN DataTable
    - "apps/frontend/components/ui/dialog.tsx"  # ShadCN Dialog for modal
    - "apps/frontend/lib/services/*.ts"  # Existing service patterns
  wireframes:
    - "docs/3-ARCHITECTURE/ux/wireframes/SET-012-warehouse-list.md"
    - "docs/3-ARCHITECTURE/ux/wireframes/SET-013-warehouse-create-edit-modal.md"

files_to_create:
  pages:
    - path: "apps/frontend/app/(authenticated)/settings/warehouses/page.tsx"
      description: "Warehouse list page with DataTable (SET-012)"
  components:
    - path: "apps/frontend/components/settings/warehouses/WarehousesDataTable.tsx"
      description: "DataTable with sorting, filtering, pagination"
    - path: "apps/frontend/components/settings/warehouses/WarehouseModal.tsx"
      description: "Create/Edit form modal (SET-013)"
    - path: "apps/frontend/components/settings/warehouses/WarehouseRow.tsx"
      description: "Single warehouse row with secondary line (address)"
    - path: "apps/frontend/components/settings/warehouses/WarehouseTypeBadge.tsx"
      description: "Type badge with color coding (5 types)"
    - path: "apps/frontend/components/settings/warehouses/WarehouseStatusBadge.tsx"
      description: "Active/Disabled status indicator badge"
    - path: "apps/frontend/components/settings/warehouses/WarehouseActionsMenu.tsx"
      description: "Row actions dropdown (edit, set default, disable/enable)"
    - path: "apps/frontend/components/settings/warehouses/WarehouseFilters.tsx"
      description: "Search + type/status filter bar"
    - path: "apps/frontend/components/settings/warehouses/SetDefaultConfirmDialog.tsx"
      description: "Confirmation dialog for default change"
    - path: "apps/frontend/components/settings/warehouses/DisableConfirmDialog.tsx"
      description: "Confirmation with inventory check warning"
    - path: "apps/frontend/components/settings/warehouses/WarehouseTypeSelect.tsx"
      description: "Dropdown with tooltips explaining each type"
    - path: "apps/frontend/components/settings/warehouses/WarehouseAddressSection.tsx"
      description: "3-line address input with char counter (max 500)"
    - path: "apps/frontend/components/settings/warehouses/WarehouseContactSection.tsx"
      description: "Email + phone inputs with validation"
  validation:
    - path: "apps/frontend/lib/validation/warehouse-schema.ts"
      description: "Zod schemas for warehouse create/update"
  api:
    - path: "apps/frontend/app/api/v1/settings/warehouses/route.ts"
      methods: ["GET", "POST"]
      description: "List warehouses (with pagination/search/filter), Create warehouse"
    - path: "apps/frontend/app/api/v1/settings/warehouses/[id]/route.ts"
      methods: ["GET", "PUT", "DELETE"]
      description: "Get warehouse, Update warehouse, Soft delete warehouse"
    - path: "apps/frontend/app/api/v1/settings/warehouses/[id]/set-default/route.ts"
      methods: ["PATCH"]
      description: "Set warehouse as default (atomic unset previous)"
    - path: "apps/frontend/app/api/v1/settings/warehouses/[id]/disable/route.ts"
      methods: ["PATCH"]
      description: "Disable warehouse (with inventory check)"
    - path: "apps/frontend/app/api/v1/settings/warehouses/[id]/enable/route.ts"
      methods: ["PATCH"]
      description: "Re-enable disabled warehouse"
    - path: "apps/frontend/app/api/v1/settings/warehouses/validate-code/route.ts"
      methods: ["GET"]
      description: "Check code uniqueness (debounce 500ms)"
  services:
    - path: "apps/frontend/lib/services/warehouse-service.ts"
      description: "Warehouse CRUD business logic with inventory check"
  database:
    - path: "supabase/migrations/054_create_warehouses_table.sql"
      type: "migration"
      description: "Create warehouses table with RLS policies"

database:
  tables:
    - name: "warehouses"
      description: "Warehouse master data with type classification"
      columns:
        - "id UUID PRIMARY KEY DEFAULT gen_random_uuid()"
        - "org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE"
        - "code VARCHAR(20) NOT NULL"
        - "name VARCHAR(100) NOT NULL"
        - "type VARCHAR(20) NOT NULL DEFAULT 'GENERAL'"
        - "address TEXT"  # max 500 chars
        - "contact_email VARCHAR(255)"  # FR-SET-045
        - "contact_phone VARCHAR(20)"  # FR-SET-045
        - "is_default BOOLEAN DEFAULT false"
        - "is_active BOOLEAN DEFAULT true"
        - "location_count INTEGER DEFAULT 0"  # denormalized for performance
        - "disabled_at TIMESTAMPTZ"
        - "disabled_by UUID REFERENCES users(id)"
        - "created_at TIMESTAMPTZ DEFAULT NOW()"
        - "updated_at TIMESTAMPTZ DEFAULT NOW()"
        - "created_by UUID REFERENCES users(id)"
        - "updated_by UUID REFERENCES users(id)"
      constraints:
        - "UNIQUE(org_id, code)"
        - "CHECK (type IN ('GENERAL', 'RAW_MATERIALS', 'WIP', 'FINISHED_GOODS', 'QUARANTINE'))"
        - "CHECK (code ~ '^[A-Z0-9-]{2,20}$')"
        - "CHECK (address IS NULL OR char_length(address) <= 500)"
        - "CHECK (contact_phone IS NULL OR char_length(contact_phone) <= 20)"
      rls: true
      rls_policies:
        - name: "warehouses_select"
          operation: "SELECT"
          using: "org_id = (SELECT org_id FROM users WHERE id = auth.uid())"
        - name: "warehouses_insert"
          operation: "INSERT"
          with_check: |
            org_id = (SELECT org_id FROM users WHERE id = auth.uid())
            AND (SELECT r.code FROM roles r JOIN users u ON u.role_id = r.id WHERE u.id = auth.uid())
            IN ('SUPER_ADMIN', 'ADMIN', 'WH_MANAGER')
        - name: "warehouses_update"
          operation: "UPDATE"
          using: |
            org_id = (SELECT org_id FROM users WHERE id = auth.uid())
            AND (SELECT r.code FROM roles r JOIN users u ON u.role_id = r.id WHERE u.id = auth.uid())
            IN ('SUPER_ADMIN', 'ADMIN', 'WH_MANAGER')
        - name: "warehouses_delete"
          operation: "DELETE"
          using: |
            org_id = (SELECT org_id FROM users WHERE id = auth.uid())
            AND (SELECT r.code FROM roles r JOIN users u ON u.role_id = r.id WHERE u.id = auth.uid())
            IN ('SUPER_ADMIN', 'ADMIN')
      indexes:
        - "org_id"
        - "(org_id, type)"
        - "(org_id, is_active)"
      triggers:
        - name: "tr_warehouses_single_default"
          timing: "BEFORE INSERT OR UPDATE OF is_default"
          condition: "NEW.is_default = true"
          action: |
            UPDATE warehouses
            SET is_default = false, updated_at = NOW()
            WHERE org_id = NEW.org_id AND id != NEW.id AND is_default = true;

api_endpoints:
  - method: "GET"
    path: "/api/v1/settings/warehouses"
    description: "List warehouses with pagination, search, and filtering"
    auth: true
    roles: ["SUPER_ADMIN", "ADMIN", "PROD_MANAGER", "QUAL_MANAGER", "WH_MANAGER", "PLANNER", "VIEWER"]
    query_params:
      - "page: number (default 1)"
      - "limit: number (default 20, max 100)"
      - "search: string (min 2 chars, searches code and name)"
      - "type: 'GENERAL' | 'RAW_MATERIALS' | 'WIP' | 'FINISHED_GOODS' | 'QUARANTINE'"
      - "status: 'active' | 'disabled'"
      - "sort: 'code' | 'name' | 'type' | 'location_count' | 'created_at'"
      - "order: 'asc' | 'desc'"
    response:
      warehouses: "Warehouse[]"
      total: "number"
      page: "number"
      limit: "number"
    performance: "< 300ms for 100 warehouses"

  - method: "POST"
    path: "/api/v1/settings/warehouses"
    description: "Create new warehouse"
    auth: true
    roles: ["SUPER_ADMIN", "ADMIN", "WH_MANAGER"]
    request_body:
      code: "string (required, 2-20 chars, uppercase alphanumeric + hyphens)"
      name: "string (required, 2-100 chars)"
      type: "string (required, one of 5 types, default 'GENERAL')"
      address: "string (optional, max 500 chars)"
      contact_email: "string (optional, valid email)"
      contact_phone: "string (optional, max 20 chars)"
      is_active: "boolean (optional, default true)"
    response:
      id: "UUID"
      code: "string"
      name: "string"
      type: "string"
      is_default: "boolean"
      is_active: "boolean"
      created_at: "timestamp"
    errors:
      409: "Warehouse code must be unique"
      400: "Invalid code format"
      400: "Invalid email format"

  - method: "GET"
    path: "/api/v1/settings/warehouses/:id"
    description: "Get warehouse by ID"
    auth: true
    roles: ["SUPER_ADMIN", "ADMIN", "PROD_MANAGER", "QUAL_MANAGER", "WH_MANAGER", "PLANNER", "VIEWER"]
    response:
      id: "UUID"
      code: "string"
      name: "string"
      type: "string"
      address: "string | null"
      contact_email: "string | null"
      contact_phone: "string | null"
      is_default: "boolean"
      is_active: "boolean"
      location_count: "number"
      created_at: "timestamp"
      updated_at: "timestamp"
    errors:
      404: "Warehouse not found"

  - method: "PUT"
    path: "/api/v1/settings/warehouses/:id"
    description: "Update warehouse"
    auth: true
    roles: ["SUPER_ADMIN", "ADMIN", "WH_MANAGER"]
    request_body:
      code: "string (optional, only if no active LPs)"
      name: "string (optional, 2-100 chars)"
      type: "string (optional, one of 5 types)"
      address: "string (optional, max 500 chars)"
      contact_email: "string (optional, valid email)"
      contact_phone: "string (optional, max 20 chars)"
    response:
      id: "UUID"
      code: "string"
      name: "string"
      type: "string"
      updated_at: "timestamp"
    errors:
      404: "Warehouse not found"
      400: "Cannot change code for warehouse with inventory"
      409: "Warehouse code must be unique"

  - method: "PATCH"
    path: "/api/v1/settings/warehouses/:id/set-default"
    description: "Set warehouse as default (atomic unset previous)"
    auth: true
    roles: ["SUPER_ADMIN", "ADMIN", "WH_MANAGER"]
    response:
      success: true
      message: "Warehouse set as default"
      previous_default: "string | null (previous default warehouse code)"
    errors:
      404: "Warehouse not found"
      400: "Cannot set disabled warehouse as default"

  - method: "PATCH"
    path: "/api/v1/settings/warehouses/:id/disable"
    description: "Disable warehouse"
    auth: true
    roles: ["SUPER_ADMIN", "ADMIN", "WH_MANAGER"]
    response:
      success: true
      message: "Warehouse disabled"
    errors:
      404: "Warehouse not found"
      400: "Cannot disable warehouse with active inventory"
      400: "Cannot disable default warehouse. Set another warehouse as default first."

  - method: "PATCH"
    path: "/api/v1/settings/warehouses/:id/enable"
    description: "Re-enable disabled warehouse"
    auth: true
    roles: ["SUPER_ADMIN", "ADMIN", "WH_MANAGER"]
    response:
      success: true
      message: "Warehouse enabled"
    errors:
      404: "Warehouse not found"

  - method: "GET"
    path: "/api/v1/settings/warehouses/validate-code"
    description: "Check code uniqueness for real-time validation"
    auth: true
    roles: ["SUPER_ADMIN", "ADMIN", "WH_MANAGER"]
    query_params:
      - "code: string (required)"
      - "excludeId: UUID (optional, for edit mode)"
    response:
      available: "boolean"
    notes: "Debounce 500ms on client side"

ux:
  wireframes:
    - id: "SET-012"
      path: "docs/3-ARCHITECTURE/ux/wireframes/SET-012-warehouse-list.md"
      description: "Warehouse List page with DataTable"
      components:
        - "DataTable with Code, Name, Type, Locations, Default, Status columns"
        - "Search bar (code/name)"
        - "Type filter dropdown (5 types + All)"
        - "Status filter dropdown (Active, Disabled, All)"
        - "Sort dropdown"
        - "Add Warehouse button (primary CTA)"
        - "Actions menu per row: Edit, Manage Locations, Set as Default, Disable/Enable"
        - "Pagination (20 per page)"
        - "Secondary row line showing address"
        - "Gold star icon for default warehouse"
    - id: "SET-013"
      path: "docs/3-ARCHITECTURE/ux/wireframes/SET-013-warehouse-create-edit-modal.md"
      description: "Warehouse Create/Edit Modal"
      components:
        - "Code input (required, 2-20 chars, auto-uppercase)"
        - "Name input (required, 2-100 chars)"
        - "Type dropdown (5 options with tooltips)"
        - "Address textarea (3 lines, max 500 chars)"
        - "Contact Email input (optional, validation)"
        - "Contact Phone input (optional, max 20 chars)"
        - "Active checkbox (default ON)"
  patterns:
    table: "ShadCN DataTable with column sorting, filtering, pagination"
    modal: "ShadCN Dialog with Form inside"
    form: "react-hook-form with Zod resolver"
    badge: "ShadCN Badge for type and status indicators"
    search: "Debounced search input (200ms)"
    confirmation: "ShadCN AlertDialog for destructive actions"
    select: "ShadCN Select with tooltip explanations"
  states:
    loading: "Skeleton rows (3) with shimmer animation"
    empty: "'No warehouses found' icon with 'Add Your First Warehouse' CTA"
    error: "'Failed to load warehouses' warning with Retry button"
    success: "Table populated with warehouse data"
  type_badges:
    GENERAL: "bg-blue-100 text-blue-800"
    RAW_MATERIALS: "bg-green-100 text-green-800"
    WIP: "bg-yellow-100 text-yellow-800"
    FINISHED_GOODS: "bg-purple-100 text-purple-800"
    QUARANTINE: "bg-red-100 text-red-800"
  status_badges:
    active: "bg-green-100 text-green-800"
    disabled: "bg-gray-100 text-gray-800"
  type_tooltips:
    GENERAL: "Multi-purpose storage for various items"
    RAW_MATERIALS: "Ingredients and packaging materials"
    WIP: "Work-in-progress, items being processed"
    FINISHED_GOODS: "Completed products ready for shipment"
    QUARANTINE: "Items on hold for quality inspection"

validation_rules:
  code:
    type: "string"
    required: true
    min: 2
    max: 20
    pattern: "^[A-Z0-9-]+$"
    transform: "toUpperCase()"
    unique_per_org: true
    immutable_with_inventory: true
    error_empty: "Code is required"
    error_min: "Code must be at least 2 characters"
    error_max: "Code must be at most 20 characters"
    error_pattern: "Code must be uppercase alphanumeric with hyphens only"
    error_duplicate: "Warehouse code must be unique"
    error_immutable: "Cannot change code for warehouse with inventory"
  name:
    type: "string"
    required: true
    min: 2
    max: 100
    error_empty: "Name is required"
    error_min: "Name must be at least 2 characters"
    error_max: "Name must be at most 100 characters"
  type:
    type: "enum"
    required: true
    values: ["GENERAL", "RAW_MATERIALS", "WIP", "FINISHED_GOODS", "QUARANTINE"]
    default: "GENERAL"
    error_invalid: "Invalid warehouse type"
  address:
    type: "string"
    required: false
    max: 500
    error_max: "Address must be at most 500 characters"
  contact_email:
    type: "string"
    required: false
    format: "email"
    max: 255
    error_format: "Invalid email format"
  contact_phone:
    type: "string"
    required: false
    max: 20
    error_max: "Phone must be at most 20 characters"

patterns:
  rls: "ADR-013 - RLS Org Isolation Pattern (users lookup)"
  api: "REST with org_id filter from auth context"
  service: "Class-based WarehouseService with static methods"
  validation: "Zod schemas in lib/validation/warehouse-schema.ts"
  default_atomicity: |
    // Database trigger ensures only one default per org
    // When setting new default, trigger auto-unsets previous default
    // Service method returns previous_default for UI feedback
  inventory_check: |
    // Check for active LPs before code change or disable
    async hasActiveInventory(warehouseId: string): Promise<boolean> {
      const { count } = await supabase
        .from('license_plates')
        .select('*', { count: 'exact', head: true })
        .eq('warehouse_id', warehouseId)
        .gt('qty', 0);
      return count > 0;
    }

acceptance_checklist:
  warehouse_list_page:
    - "GIVEN admin navigates to /settings/warehouses, WHEN page loads, THEN warehouse list displays within 300ms"
    - "GIVEN warehouse list displayed, WHEN table renders, THEN columns show: Code, Name, Type, Locations, Default, Status"
    - "GIVEN warehouse list with 10+ warehouses, WHEN admin enters search 'WH-RAW', THEN only matching warehouses display within 200ms"
    - "GIVEN warehouse list displayed, WHEN admin selects filter 'Raw Materials', THEN only raw material warehouses appear"
    - "GIVEN warehouse list displayed, WHEN admin filters by status 'active', THEN only active warehouses appear"
    - "GIVEN warehouse list displayed, WHEN admin clicks 'Name' column header, THEN list sorts alphabetically (toggle asc/desc)"
    - "GIVEN 30 warehouses exist, WHEN admin views warehouse list, THEN 20 warehouses display per page with pagination controls"

  create_warehouse:
    - "GIVEN admin clicks '+ Add Warehouse', WHEN modal opens, THEN form displays: code, name, type, address, contact email, contact phone, active checkbox"
    - "GIVEN admin enters code 'WH-001', name 'Main Warehouse', type 'General', WHEN 'Create' clicked, THEN warehouse created and appears in list within 1 second"
    - "GIVEN warehouse 'WH-001' exists, WHEN admin creates another with code 'WH-001', THEN error 'Warehouse code must be unique' displays inline"
    - "GIVEN admin enters code 'invalid code!', WHEN save attempted, THEN error 'Code must be 2-20 uppercase alphanumeric characters with hyphens only' displays"
    - "GIVEN admin leaves code field empty, WHEN save attempted, THEN error 'Code is required' displays inline"
    - "GIVEN admin enters contact email 'invalid-email', WHEN save attempted, THEN error 'Invalid email format' displays"

  warehouse_type:
    - "GIVEN warehouse create/edit modal open, WHEN admin opens type dropdown, THEN options display: General, Raw Materials, WIP, Finished Goods, Quarantine"
    - "GIVEN warehouses with different types exist, WHEN viewing warehouse list, THEN type badges display with correct colors"
    - "GIVEN warehouse modal open, WHEN admin hovers type dropdown option 'Quarantine', THEN tooltip displays 'Items on hold for quality inspection'"

  warehouse_address_contact:
    - "GIVEN warehouse create/edit modal open, WHEN form loads, THEN address section shows 3-line text area (max 500 chars)"
    - "GIVEN admin enters contact phone '+1-555-123-4567', WHEN save completed, THEN phone saved (max 20 chars)"
    - "GIVEN warehouse has address '123 Factory Rd, Springfield', WHEN viewing warehouse list, THEN second row shows truncated address under warehouse name"

  default_warehouse:
    - "GIVEN one warehouse is marked as default, WHEN viewing warehouse list, THEN default warehouse shows gold star icon in Default column"
    - "GIVEN warehouse 'WH-002' exists (not default), WHEN admin clicks actions menu > 'Set as Default', THEN confirmation dialog displays 'Set WH-002 as default warehouse?'"
    - "GIVEN 'WH-001' is current default, WHEN admin sets 'WH-002' as default, THEN 'WH-002' becomes default AND 'WH-001' loses default status (atomic operation)"
    - "GIVEN only one warehouse exists and is default, WHEN admin attempts to unset default, THEN action unavailable (hidden or disabled)"

  edit_warehouse:
    - "GIVEN admin clicks edit on warehouse 'WH-001', WHEN modal opens, THEN current warehouse data pre-populates form"
    - "GIVEN warehouse 'WH-001' has active LPs, WHEN edit modal opens, THEN code field is disabled with tooltip 'Cannot change code for warehouse with inventory'"
    - "GIVEN warehouse 'WH-NEW' has no LPs, WHEN edit modal opens, THEN code field is editable"
    - "GIVEN admin changes name from 'Warehouse A' to 'Warehouse Alpha', WHEN save completed, THEN updated name displays in list immediately"

  disable_enable:
    - "GIVEN warehouse 'WH-OLD' has no active inventory (qty = 0), WHEN admin clicks 'Disable Warehouse', THEN confirmation displays 'Disable warehouse WH-OLD?' and warehouse status changes to 'disabled' within 500ms"
    - "GIVEN warehouse 'WH-ACTIVE' has LPs with qty > 0, WHEN admin clicks 'Disable Warehouse', THEN error 'Cannot disable warehouse with active inventory' displays"
    - "GIVEN 'WH-001' is default warehouse, WHEN admin attempts to disable, THEN error 'Cannot disable default warehouse. Set another warehouse as default first.' displays"
    - "GIVEN warehouse 'WH-OLD' is disabled, WHEN admin clicks 'Enable Warehouse', THEN status changes to 'active' within 500ms"

  permission_enforcement:
    - "GIVEN user has ADMIN role, WHEN accessing /settings/warehouses, THEN all CRUD actions available"
    - "GIVEN user has WH_MANAGER role, WHEN accessing /settings/warehouses, THEN can add, edit, set default, disable warehouses"
    - "GIVEN user has PROD_MANAGER role, WHEN accessing /settings/warehouses, THEN can view list but 'Add Warehouse' button hidden and row actions hidden"
    - "GIVEN user has VIEWER role, WHEN accessing /settings/warehouses, THEN table displays but all actions hidden"

  multi_tenancy:
    - "GIVEN User A from Org A, WHEN requesting /api/settings/warehouses, THEN only Org A warehouses returned"
    - "GIVEN User A from Org A, WHEN requesting warehouse ID from Org B, THEN 404 Not Found returned (not 403)"

definition_of_done:
  - "Database migration creates warehouses table with all constraints"
  - "RLS policies enforce org isolation and role permissions"
  - "Single default warehouse trigger works atomically"
  - "All 9 API endpoints implemented and documented"
  - "Zod schemas validate all inputs (code format, email, phone)"
  - "warehouse-service.ts implements all methods"
  - "Warehouse list page renders with DataTable (SET-012)"
  - "Create/Edit modal with all fields (SET-013)"
  - "Type dropdown with tooltips and badge colors"
  - "Address section (3 lines, 500 char limit)"
  - "Contact fields (email + phone) with validation"
  - "Default warehouse star icon and 'Set as Default' action"
  - "Disable/Enable with inventory check"
  - "Code immutability enforced when LPs exist"
  - "Search, filter, sort, pagination work correctly"
  - "Permission matrix implemented (admin, wh_manager, viewer)"
  - "Multi-tenancy: cross-org returns 404"
  - "Unit tests >= 80% coverage"
  - "Integration tests for all endpoints"
  - "E2E tests for critical flows"
  - "Loading, empty, error states implemented"
  - "Toast notifications on success/error"
  - "Accessibility: keyboard nav, ARIA labels, screen reader support"

tests:
  unit:
    - "WarehouseService.list() returns org-scoped warehouses"
    - "WarehouseService.create() validates code uniqueness"
    - "WarehouseService.create() auto-uppercases code"
    - "WarehouseService.update() prevents code change with inventory"
    - "WarehouseService.setDefault() unsets previous default"
    - "WarehouseService.disable() blocks with active inventory"
    - "WarehouseService.disable() blocks default warehouse"
    - "WarehouseService.validateCode() returns availability"
    - "Zod schema rejects invalid code format"
    - "Zod schema rejects invalid email format"
    - "Zod schema rejects address > 500 chars"
    - "Type badge renders correct colors for each type"
    - "Status badge renders correct colors"
  integration:
    - "GET /api/v1/settings/warehouses returns paginated list"
    - "GET /api/v1/settings/warehouses?type=RAW_MATERIALS filters correctly"
    - "GET /api/v1/settings/warehouses?status=active filters correctly"
    - "POST /api/v1/settings/warehouses creates with validation"
    - "POST /api/v1/settings/warehouses duplicate code returns 409"
    - "PUT /api/v1/settings/warehouses/:id updates mutable fields"
    - "PUT /api/v1/settings/warehouses/:id code immutable with LPs returns 400"
    - "PATCH /api/v1/settings/warehouses/:id/set-default atomicity verified"
    - "PATCH /api/v1/settings/warehouses/:id/disable with inventory returns 400"
    - "PATCH /api/v1/settings/warehouses/:id/disable default warehouse returns 400"
    - "Cross-org access returns 404"
    - "Permission denied returns 403"
  e2e:
    - "Full warehouse creation flow: list > add button > modal > form > save > list updated"
    - "Edit warehouse flow: actions menu > edit > modify > save"
    - "Set default warehouse: actions menu > set default > confirm > star icon appears"
    - "Disable warehouse: actions menu > disable > confirm > status badge changes"
    - "Search and filter warehouse list"
    - "Permission-based UI: Viewer sees no actions"

output_artifacts:
  database:
    - "Migration: 054_create_warehouses_table.sql"
    - "RLS policies for warehouses table"
    - "Trigger for single default warehouse per org"
  backend:
    - "warehouse-service.ts with CRUD operations and inventory check"
    - "warehouse-schema.ts Zod validation schemas"
    - "API routes: GET/POST /api/v1/settings/warehouses"
    - "API routes: GET/PUT/DELETE /api/v1/settings/warehouses/:id"
    - "API routes: PATCH /api/v1/settings/warehouses/:id/set-default"
    - "API routes: PATCH /api/v1/settings/warehouses/:id/disable"
    - "API routes: PATCH /api/v1/settings/warehouses/:id/enable"
    - "API routes: GET /api/v1/settings/warehouses/validate-code"
  frontend:
    - "WarehousesDataTable.tsx component with sorting, filtering, pagination"
    - "WarehouseModal.tsx component for create/edit"
    - "WarehouseTypeBadge.tsx and WarehouseStatusBadge.tsx components"
    - "WarehouseActionsMenu.tsx component"
    - "WarehouseFilters.tsx component"
    - "SetDefaultConfirmDialog.tsx component"
    - "DisableConfirmDialog.tsx component"
    - "WarehouseTypeSelect.tsx with tooltips"
    - "WarehouseAddressSection.tsx with char counter"
    - "WarehouseContactSection.tsx with validation"
  tests:
    - "Unit tests for warehouse-service (>80% coverage)"
    - "Integration tests for API endpoints"
    - "E2E tests for warehouse CRUD flows"

implementation_notes:
  frontend:
    - "Use ShadCN DataTable for warehouse list with server-side pagination"
    - "Use ShadCN Dialog for create/edit modal"
    - "Use react-hook-form with Zod resolver for form validation"
    - "Debounce search input by 200ms to reduce API calls"
    - "Debounce code validation by 500ms on blur"
    - "Show skeleton loaders while data is loading"
    - "Display type tooltips on hover in dropdown"
    - "Auto-uppercase code input on blur"
    - "Use usePermissions() hook to conditionally render actions"
    - "Show address as secondary line in table row"
    - "Gold star icon for default warehouse in list"
  backend:
    - "Validate code uniqueness within org before create/update"
    - "Check hasActiveInventory() before code change or disable"
    - "Use database trigger for atomic default warehouse switch"
    - "Implement canDisable() check for default warehouse and inventory"
    - "Use ADR-013 RLS pattern for org isolation"
    - "Return previous_default on set-default for UI feedback"
  database:
    - "Create migration with warehouses table"
    - "Add trigger for single default per org"
    - "Verify RLS policies are active"
    - "Add indexes for query performance"
    - "location_count column maintained by triggers in Story 01.9"
