# Story 01.8 - Index File (Entry Point)
# Generated: 2025-12-16
# Purpose: Story metadata and dependencies - read this first

story:
  id: "01.8"
  name: "Warehouses CRUD"
  slug: "warehouses-crud"
  epic: "01-settings"
  phase: "1A"
  complexity: "M"
  estimate_days: 3-4
  type: "full-stack"
  state: "ready"

# Files in this context folder
context_files:
  - _index.yaml      # This file - metadata, dependencies
  - database.yaml    # Tables, RLS, seed data, triggers
  - api.yaml         # Endpoints, auth, errors
  - frontend.yaml    # Components, types, hooks, UX
  - tests.yaml       # Acceptance criteria, test specifications
  - gaps.yaml        # Readiness assessment vs codebase

# Dependencies
dependencies:
  required:
    - story: "01.1"
      name: "Org Context + Base RLS"
      provides: ["org_id context", "RLS pattern", "users table"]
    - story: "01.2"
      name: "Settings Shell Navigation"
      provides: ["Settings layout", "/settings route structure"]
    - story: "01.6"
      name: "Role Permissions"
      provides: ["Role-based access control", "Permission matrix"]
  blocked_by: []
  blocks:
    - story: "01.9"
      name: "Locations CRUD"
      reason: "Locations require warehouses to exist"
    - story: "01.5b"
      name: "User Warehouse Access"
      reason: "Cannot assign warehouse access without warehouses"
    - epic: "05"
      name: "Warehouse Module"
      reason: "Inventory operations require warehouse infrastructure"

# Reference Documents
files_to_read:
  prd:
    path: "docs/1-BASELINE/product/modules/settings.md"
    sections: ["FR-SET-040", "FR-SET-041", "FR-SET-042", "FR-SET-043", "FR-SET-044", "FR-SET-045", "FR-SET-046"]
  architecture:
    path: "docs/1-BASELINE/architecture/modules/settings.md"
    sections: ["Warehouse Management", "Location Hierarchy"]
  story:
    path: "docs/2-MANAGEMENT/epics/current/01-settings/01.8.warehouses-crud.md"
  adrs:
    - path: "docs/1-BASELINE/architecture/decisions/ADR-013-rls-org-isolation-pattern.md"
      relevance: "PRIMARY - RLS policy pattern for warehouses table"
  wireframes:
    - path: "docs/3-ARCHITECTURE/ux/wireframes/SET-012-warehouse-list.md"
      relevance: "Warehouse list page UX"
    - path: "docs/3-ARCHITECTURE/ux/wireframes/SET-013-warehouse-create-edit-modal.md"
      relevance: "Create/Edit modal UX"

# High-level deliverables
deliverables:
  - type: "migration"
    count: 2
    description: "warehouses table + RLS policies + triggers"
  - type: "service"
    count: 1
    description: "warehouse-service.ts with CRUD + business logic"
  - type: "validation"
    count: 1
    description: "warehouse.ts Zod schemas"
  - type: "api"
    count: 9
    description: "Full CRUD + set-default + disable/enable + validate-code"
  - type: "components"
    count: 11
    description: "DataTable, Modal, Badges, Filters, Actions"
  - type: "page"
    count: 1
    description: "/settings/warehouses page"
  - type: "test"
    count: 3
    description: "Unit + integration + E2E tests"

# Technical notes
technical_notes:
  - "Warehouses support 5 types: GENERAL, RAW_MATERIALS, WIP, FINISHED_GOODS, QUARANTINE"
  - "Only one default warehouse per org (enforced by trigger)"
  - "Cannot disable warehouse with active inventory (business rule)"
  - "Cannot disable default warehouse (must set new default first)"
  - "Code immutability: editable only when no inventory exists"
  - "Address field supports 3 lines, max 500 chars"
  - "Contact fields: email (validated) + phone (max 20 chars)"
  - "location_count is denormalized for performance (maintained by triggers in 01.9)"
  - "Return 404 (not 403) for cross-tenant access per ADR-013"

# Business Rules
business_rules:
  - rule: "Single Default Warehouse"
    description: "Only one warehouse can be default per org"
    enforcement: "Database trigger: ensure_single_default_warehouse()"
  - rule: "Cannot Disable With Inventory"
    description: "Cannot disable warehouse if active inventory (qty > 0) exists"
    enforcement: "API validation via hasActiveInventory() check"
  - rule: "Cannot Disable Default"
    description: "Cannot disable default warehouse, must set another as default first"
    enforcement: "API validation in disable endpoint"
  - rule: "Code Immutability"
    description: "Code cannot be changed if warehouse has license plates"
    enforcement: "API validation via hasActiveInventory() check"
