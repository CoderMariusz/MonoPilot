# Story 01.7 - Test Specification
# Purpose: Acceptance criteria, test cases, coverage requirements
# Agent: QA-AGENT / TEST-WRITER

test_files:
  - path: "apps/frontend/lib/services/__tests__/module-settings-service.test.ts"
    type: "unit"
    description: "Unit tests for module toggle logic"
  - path: "apps/frontend/components/settings/modules/__tests__/ModuleCard.test.tsx"
    type: "unit"
    description: "Unit tests for ModuleCard component"
  - path: "apps/frontend/components/settings/modules/__tests__/ModuleToggleList.test.tsx"
    type: "unit"
    description: "Unit tests for ModuleToggleList component"
  - path: "apps/frontend/components/settings/modules/__tests__/DependencyWarningModal.test.tsx"
    type: "unit"
    description: "Unit tests for DependencyWarningModal"
  - path: "apps/frontend/app/(authenticated)/settings/modules/__tests__/page.test.tsx"
    type: "integration"
    description: "Integration tests for modules page"
  - path: "tests/e2e/settings/module-toggles.spec.ts"
    type: "e2e"
    description: "E2E tests for module toggle workflows"

acceptance_criteria:
  - id: "AC-01"
    given: "admin navigates to /settings/modules"
    when: "page loads"
    then: "11 modules display with current status"
    test_type: "e2e"
    priority: "P0"

  - id: "AC-02"
    given: "Settings module displayed"
    when: "page loads"
    then: "Settings has no toggle switch (always enabled)"
    test_type: "integration"
    priority: "P0"

  - id: "AC-03"
    given: "module list displayed"
    when: "toggle switch shown"
    then: "enabled modules show ON (green), disabled show OFF (gray)"
    test_type: "integration"
    priority: "P0"

  - id: "AC-04"
    given: "admin enables Warehouse module"
    when: "toggle switched ON"
    then: "Warehouse appears in navigation within 1 second"
    test_type: "e2e"
    priority: "P0"

  - id: "AC-05"
    given: "Production requires Technical and Planning"
    when: "enabling Production while both ON"
    then: "Production enables successfully"
    test_type: "integration"
    priority: "P1"

  - id: "AC-06"
    given: "Technical is OFF"
    when: "admin tries to enable Planning"
    then: "warning displays: 'Planning requires Technical'"
    test_type: "e2e"
    priority: "P0"

  - id: "AC-07"
    given: "warning shown with Enable Both button"
    when: "clicked"
    then: "both Technical and Planning enabled"
    test_type: "e2e"
    priority: "P0"

  - id: "AC-08"
    given: "warning shown"
    when: "Cancel clicked"
    then: "no changes made"
    test_type: "e2e"
    priority: "P1"

  - id: "AC-09"
    given: "Production module is ON"
    when: "admin toggles OFF"
    then: "Production hidden from navigation within 1 second"
    test_type: "e2e"
    priority: "P0"

  - id: "AC-10"
    given: "admin disables Planning with active work orders"
    when: "toggle switched OFF"
    then: "warning displays but allows disable"
    test_type: "e2e"
    priority: "P1"

  - id: "AC-11"
    given: "Quality depends on Production"
    when: "admin disables Production while Quality is ON"
    then: "warning displays: 'Quality depends on Production'"
    test_type: "e2e"
    priority: "P0"

  - id: "AC-12"
    given: "cascade warning shown with Disable Both"
    when: "clicked"
    then: "both Production and Quality disabled"
    test_type: "e2e"
    priority: "P0"

  - id: "AC-13"
    given: "Production module disabled"
    when: "user views navigation sidebar"
    then: "Production menu item hidden"
    test_type: "e2e"
    priority: "P0"

  - id: "AC-14"
    given: "Production module disabled"
    when: "user navigates to /production/dashboard directly"
    then: "redirect to dashboard with error toast"
    test_type: "e2e"
    priority: "P1"

  - id: "AC-15"
    given: "Quality module disabled"
    when: "API call to /api/v1/quality/inspections made"
    then: "403 'Module not enabled' returns"
    test_type: "integration"
    priority: "P1"

  - id: "AC-16"
    given: "user with VIEWER role"
    when: "accessing /settings/modules"
    then: "page loads read-only (toggles disabled)"
    test_type: "e2e"
    priority: "P0"

unit_tests:
  module_service:
    - name: "getAllModules returns 11 modules"
      setup: "Mock API response with 11 modules"
      expected: "Returns Module[] with length 11"

    - name: "toggleModule validates dependencies on enable"
      setup: "Planning module, enable=true, technical disabled"
      expected: "Throws error or returns warning"

    - name: "toggleModule auto-enables deps with cascade=true"
      setup: "Planning module, enable=true, cascade=true"
      expected: "Technical also enabled"

    - name: "toggleModule validates dependents on disable"
      setup: "Technical module, enable=false, planning enabled"
      expected: "Throws error or returns warning"

    - name: "toggleModule auto-disables dependents with cascade=true"
      setup: "Technical module, enable=false, cascade=true"
      expected: "Planning also disabled"

    - name: "Settings module cannot be disabled"
      setup: "Settings module, enable=false"
      expected: "Error thrown or blocked"

  ModuleCard:
    - name: "renders module name and description"
      props: { module: { name: "Technical", description: "Products..." } }
      expected: "Displays name and description"

    - name: "toggle switch disabled for Settings module"
      props: { module: { code: "settings", can_disable: false } }
      expected: "Switch is disabled and shows 'Always Enabled'"

    - name: "shows dependencies list"
      props: { module: { code: "planning", dependencies: ["technical"] } }
      expected: "Displays 'Requires: Technical'"

    - name: "shows dependents list"
      props: { module: { code: "technical", dependents: ["planning", "warehouse"] } }
      expected: "Displays 'Required by: Planning, Warehouse'"

    - name: "premium badge shows for NPD/Finance/OEE"
      props: { module: { code: "npd" } }
      expected: "Badge shows '$50/user/month'"

  ModuleToggleList:
    - name: "groups modules by type (Core, Premium)"
      props: { modules: [core modules...premium modules] }
      expected: "Two sections visible"

    - name: "collapse/expand Core section"
      setup: "Core section expanded"
      action: "Click header"
      expected: "Core section collapses"

    - name: "shows enabled count"
      props: { modules: [6 enabled, 5 disabled] }
      expected: "Footer shows '6 enabled, 5 disabled'"

  DependencyWarningModal:
    - name: "shows enable warning for missing dependencies"
      props: { action: "enable", module: "planning", affected: ["technical"] }
      expected: "Modal shows 'Planning requires Technical. Enable both?'"

    - name: "shows disable warning for active dependents"
      props: { action: "disable", module: "technical", affected: ["planning"] }
      expected: "Modal shows 'Planning requires Technical. Disable both?'"

    - name: "cascade toggle changes button text"
      setup: "Modal open, cascade=false"
      action: "Click cascade toggle"
      expected: "Button text changes to 'Enable All' or 'Disable All'"

integration_tests:
  modules_page:
    - name: "Page loads and displays all modules"
      setup: "Mock GET /api/v1/settings/modules with 11 modules"
      action: "Render modules page"
      expected: "11 ModuleCard components visible"

    - name: "Clicking toggle calls API"
      setup: "Mock PATCH /api/v1/settings/modules/:id/toggle"
      action: "Click toggle switch"
      expected: "API called with enabled=true/false"

    - name: "Toggle with unmet dependencies shows warning"
      setup: "Technical disabled, try to enable Planning"
      action: "Click Planning toggle"
      expected: "DependencyWarningModal opens"

    - name: "Cascade toggle enables dependencies"
      setup: "Technical disabled, cascade=true"
      action: "Confirm enable Planning"
      expected: "Both Technical and Planning enabled"

    - name: "Toggle with active dependents shows warning"
      setup: "Production enabled, Quality enabled, try to disable Production"
      action: "Click Production toggle"
      expected: "DependencyWarningModal opens"

    - name: "Cascade toggle disables dependents"
      setup: "cascade=true"
      action: "Confirm disable Production"
      expected: "Both Production and Quality disabled"

    - name: "Toast shows on successful toggle"
      setup: "Toggle switch clicked"
      action: "API returns success"
      expected: "Toast shows 'Module enabled' or 'Module disabled'"

    - name: "Error toast on toggle failure"
      setup: "Toggle API returns 400"
      action: "Click toggle"
      expected: "Error toast shows with message"

    - name: "Settings module toggle switch disabled"
      setup: "Render modules page"
      expected: "Settings ModuleCard has disabled toggle"

    - name: "Navigation updates after toggle"
      setup: "Warehouse disabled, then enabled"
      action: "Check sidebar nav"
      expected: "Warehouse appears in nav within 1 second"

e2e_tests:
  module_toggle_workflow:
    - name: "Enable module without dependencies"
      steps:
        - "Login as admin"
        - "Navigate to /settings/modules"
        - "Click Warehouse toggle ON"
        - "Confirm in modal"
      expected: "Warehouse enabled, appears in nav"

    - name: "Enable module with unmet dependencies"
      steps:
        - "Disable Technical"
        - "Try to enable Planning"
        - "Modal warns about dependency"
        - "Click Cancel"
      expected: "Planning remains disabled"

    - name: "Enable module with cascade"
      steps:
        - "Disable Technical"
        - "Try to enable Planning"
        - "Modal shows 'Enable Both' option"
        - "Click 'Enable Both'"
      expected: "Both Technical and Planning enabled"

    - name: "Disable module with active dependents"
      steps:
        - "Enable Technical and Planning"
        - "Try to disable Technical"
        - "Modal warns about dependents"
      expected: "Warning displayed, option to cascade"

    - name: "Navigation enforcement after toggle"
      steps:
        - "Disable Production"
        - "Check sidebar nav"
        - "Try to access /production directly"
      expected: "Redirects to /dashboard with error"

    - name: "API enforcement for disabled modules"
      steps:
        - "Disable Quality"
        - "Call GET /api/v1/quality/inspections"
      expected: "403 'Module not enabled' response"

    - name: "Read-only for non-admin users"
      steps:
        - "Login as VIEWER"
        - "Navigate to /settings/modules"
        - "Try to click toggle"
      expected: "Toggle disabled, shows 'Admin only'"

    - name: "Module grouping and organization"
      steps:
        - "Load modules page"
        - "Check Core modules section"
        - "Check Premium modules section"
        - "Collapse Core section"
      expected: "Sections properly grouped and collapsible"

definition_of_done:
  - "modules table created with 11 modules seeded (7 core + 4 premium)"
  - "organization_modules table created with RLS policies"
  - "GET /api/v1/settings/modules returns all modules with org-specific status"
  - "PATCH /api/v1/settings/modules/:id/toggle works with dependency validation"
  - "Module toggles page displays 11 modules with correct status"
  - "Settings module always enabled, no toggle switch displayed"
  - "Enable/disable updates navigation within 1 second (no page reload)"
  - "Dependency validation shows warning before cascade"
  - "Direct URL to disabled module redirects with message"
  - "API returns 403 for disabled module endpoints"
  - "Admin+ required to toggle modules (VIEWER sees read-only)"
  - "Unit tests for module-settings-service (>85% coverage)"
  - "Integration tests for dependency scenarios"
  - "E2E tests for navigation and API enforcement"

coverage:
  unit:
    target: 85
    reason: "Service functions with complex dependency logic"
  integration:
    target: 80
    reason: "API integration and React Query mutations"
  e2e:
    target: 8
    reason: "Critical user workflows verified"

performance:
  page_load:
    target: "< 1 second"
    metric: "Time to interactive"
  toggle_response:
    target: "< 500ms"
    metric: "API response time"
  nav_update:
    target: "< 1 second"
    metric: "Navigation refresh after toggle"

accessibility:
  wcag_level: "AA"
  tests:
    - "Keyboard navigation: Tab through toggle switches"
    - "Screen reader: Module names and dependencies announced"
    - "Color contrast: Status colors meet 4.5:1 ratio"
    - "Focus indicators: Visible on all interactive elements"
    - "ARIA labels: Present on toggles and buttons"
