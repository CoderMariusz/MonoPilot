# Story 01.3 Context - Onboarding Wizard Launcher
# Generated: 2025-12-16
# Purpose: AI agent context for implementation

story:
  id: "01.3"
  name: "Onboarding Wizard Launcher"
  epic: "01-settings"
  phase: "1A"
  complexity: "M"
  estimate_days: 3
  type: "frontend + backend"

dependencies:
  required:
    - story: "01.1"
      provides:
        - "organizations table with org_id"
        - "RLS policies for org isolation"
        - "org context hook (useOrganization)"
    - story: "01.2"
      provides:
        - "settings shell layout"
        - "route guards for authenticated routes"
        - "modal mounting point"

files_to_read:
  prd: "docs/1-BASELINE/product/modules/settings.md"
  prd_sections:
    - "FR-SET-180"  # Setup wizard launcher
    - "FR-SET-186"  # Wizard progress tracking
    - "FR-SET-187"  # Skip wizard option
  architecture: "docs/1-BASELINE/architecture/modules/settings.md"
  story: "docs/2-MANAGEMENT/epics/current/01-settings/01.3.onboarding-wizard-launcher.md"
  patterns:
    - "apps/frontend/components/ui/dialog.tsx"  # ShadCN dialog pattern
    - "apps/frontend/lib/hooks/use-organization.ts"  # Org context hook
    - "apps/frontend/app/api/settings/"  # API route patterns

files_to_create:
  database:
    - path: "supabase/migrations/YYYYMMDDHHMMSS_add_onboarding_fields.sql"
      type: "migration"
      description: "Add onboarding columns to organizations table"
  api:
    - path: "apps/frontend/app/api/settings/onboarding/status/route.ts"
      methods: ["GET"]
      description: "Get current onboarding status for organization"
    - path: "apps/frontend/app/api/settings/onboarding/skip/route.ts"
      methods: ["POST"]
      description: "Skip wizard and create demo data"
  services:
    - path: "apps/frontend/lib/services/onboarding-service.ts"
      description: "Onboarding wizard business logic"
  validation:
    - path: "apps/frontend/lib/validation/onboarding.ts"
      description: "Zod schemas for onboarding API"
  pages:
    - path: "apps/frontend/app/(authenticated)/onboarding/page.tsx"
      description: "Wizard launcher page (redirect target)"
  components:
    - path: "apps/frontend/components/onboarding/OnboardingWizardModal.tsx"
      description: "Full-screen wizard modal with step navigation"
    - path: "apps/frontend/components/onboarding/OnboardingGuard.tsx"
      description: "Wrapper that checks onboarding status on authenticated routes"
    - path: "apps/frontend/components/onboarding/SkipConfirmationDialog.tsx"
      description: "Confirmation dialog for skipping wizard"
    - path: "apps/frontend/components/onboarding/SetupInProgressMessage.tsx"
      description: "Message shown to non-admin users during onboarding"
    - path: "apps/frontend/lib/hooks/use-onboarding-status.ts"
      description: "Hook for fetching/caching onboarding state"

database:
  tables:
    - name: "organizations"
      columns_to_add:
        - name: "onboarding_step"
          type: "INTEGER"
          default: 0
          description: "Current wizard step (0=not started, 1-6=in progress, 7=completed)"
        - name: "onboarding_started_at"
          type: "TIMESTAMPTZ"
          nullable: true
          description: "Timestamp when wizard was first shown"
        - name: "onboarding_completed_at"
          type: "TIMESTAMPTZ"
          nullable: true
          description: "Timestamp when wizard was completed or skipped"
        - name: "onboarding_skipped"
          type: "BOOLEAN"
          default: false
          description: "True if user skipped wizard"
      rls: true
      indexes: []

api_endpoints:
  - method: "GET"
    path: "/api/settings/onboarding/status"
    auth: true
    roles: ["*"]  # All authenticated users
    request: null
    response:
      step: "number (0-7)"
      started_at: "string | null (ISO timestamp)"
      completed_at: "string | null (ISO timestamp)"
      skipped: "boolean"
    description: "Returns current onboarding status for user's organization"
  - method: "POST"
    path: "/api/settings/onboarding/skip"
    auth: true
    roles: ["admin", "owner"]
    request: null
    response:
      success: "boolean"
      demo_data:
        warehouse_id: "string (UUID)"
        location_id: "string (UUID)"
        product_id: "string (UUID)"
    description: "Skip wizard and create demo data (warehouse + location + product)"
    side_effects:
      - "Creates warehouse: code=DEMO-WH, name=Main Warehouse, type=general, is_default=true"
      - "Creates location: code=DEFAULT, name=Default Location, type=zone"
      - "Creates product: code=SAMPLE-001, name=Sample Product, uom=EA, status=active"
      - "Sets module toggles: technical=true, others=false"
      - "Updates organizations: onboarding_skipped=true, onboarding_completed_at=now()"

ux:
  wireframes:
    - id: "SET-001"
      path: "docs/3-ARCHITECTURE/ux/wireframes/SET-001-onboarding-launcher.md"
      components:
        - "MonoPilot Logo"
        - "Wizard Overview Card (6 steps with time estimates)"
        - "Progress Status Card"
        - "Start Onboarding Wizard button (primary)"
        - "Skip Onboarding button (secondary)"
        - "Skip Confirmation Dialog"
  patterns:
    modal: "ShadCN Dialog - full-screen overlay, cannot dismiss by clicking outside"
    progress: "Step indicator showing current/total (Step 1 of 6) with checkmarks"
    navigation: "Back (disabled on step 1), Next, Skip Setup Wizard link"
    confirmation: "ShadCN AlertDialog for skip confirmation"
  states:
    - name: "loading"
      description: "Spinner with skeleton while loading organization data"
    - name: "success"
      description: "Wizard overview with Start and Skip buttons"
    - name: "error"
      description: "Error message with Try Again and Contact Support buttons"
    - name: "non_admin"
      description: "Setup in progress message for non-admin users"

validation_rules:
  onboarding_step: "Integer 0-7, where 0=not started, 1-6=current step, 7=completed"
  skip_permission: "Only admin or owner roles can skip wizard"
  wizard_visibility: "Show wizard if onboarding_completed_at is null"

patterns:
  rls: "ADR-013 - All queries filtered by org_id"
  api: "REST with org_id extracted from session/JWT"
  service: "Class-based with static methods (OnboardingService)"
  validation: "Zod schemas in lib/validation/"
  hooks: "React Query pattern with useQuery/useMutation"
  state_machine: |
    States: NOT_STARTED -> IN_PROGRESS -> COMPLETED | SKIPPED
    Transitions:
      - NOT_STARTED + start_wizard -> IN_PROGRESS(step=1)
      - IN_PROGRESS(step=N) + next -> IN_PROGRESS(step=N+1)
      - IN_PROGRESS(step=6) + complete -> COMPLETED
      - IN_PROGRESS(any) + skip -> SKIPPED (creates demo data)

acceptance_checklist:
  - "GIVEN new org with onboarding_step=0, WHEN admin logs in, THEN wizard modal appears at step 1"
  - "GIVEN org with onboarding_step=3, WHEN admin logs in, THEN wizard resumes at step 3 with steps 1-2 showing checkmarks"
  - "GIVEN org with onboarding_completed_at set, WHEN any user logs in, THEN no wizard appears"
  - "GIVEN non-admin user (Viewer, Operator), WHEN org onboarding incomplete, THEN user sees 'Setup in progress' message"
  - "GIVEN admin clicks 'Skip Setup Wizard', WHEN confirmed, THEN demo data created (warehouse DEMO-WH, location DEFAULT, product SAMPLE-001)"
  - "GIVEN admin clicks 'Skip Setup Wizard', WHEN cancelled, THEN wizard remains open"
  - "GIVEN wizard on any step 1-6, THEN 'Skip Setup Wizard' link is visible"
  - "GIVEN progress saved after step, WHEN user refreshes or logs out/in, THEN wizard resumes from saved step"

output_artifacts:
  - "Migration file adding onboarding columns to organizations table"
  - "OnboardingWizardModal.tsx with step navigation framework"
  - "useOnboardingStatus.ts hook"
  - "OnboardingGuard.tsx wrapper component"
  - "GET /api/settings/onboarding/status endpoint"
  - "POST /api/settings/onboarding/skip endpoint"
  - "SkipConfirmationDialog.tsx component"
  - "SetupInProgressMessage.tsx for non-admin users"
  - "Unit tests for hook and skip dialog"
  - "Integration tests for wizard launch, resume, and skip flows"

testing:
  unit:
    - "useOnboardingStatus hook returns correct state for various onboarding_step values"
    - "Skip confirmation dialog shows/hides correctly"
    - "Non-admin users see 'Setup in progress' message"
    - "OnboardingGuard shows wizard for incomplete orgs"
  integration:
    - "Wizard auto-launches for new org (step=0)"
    - "Wizard resumes at correct step"
    - "Skip creates demo data and closes wizard"
    - "Completed orgs bypass wizard entirely"
    - "API returns 403 for non-admin skip attempts"

demo_data_spec:
  warehouse:
    code: "DEMO-WH"
    name: "Main Warehouse"
    type: "general"
    is_default: true
  location:
    code: "DEFAULT"
    name: "Default Location"
    type: "zone"
    parent: "DEMO-WH"
  product:
    code: "SAMPLE-001"
    name: "Sample Product"
    uom: "EA"
    status: "active"
  module_toggles:
    technical: true
    planning: false
    production: false
    warehouse: false
    quality: false
    shipping: false
