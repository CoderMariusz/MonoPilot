# Story Context: 01.12 Allergens Management
# Generated: 2025-12-16
# Purpose: AI agent context for implementing EU allergen reference data (read-only, 14 mandatory allergens)

story:
  id: "01.12"
  name: "Allergens Management"
  epic: "01-settings"
  phase: "1A"
  complexity: "S"
  estimate_days: 2
  type: "frontend + backend"
  state: "ready"
  priority: "P0"
  story_file: "docs/2-MANAGEMENT/epics/current/01-settings/01.12.allergens-management.md"

dependencies:
  required:
    - story: "01.1"
      name: "Org Context + Base RLS"
      provides:
        - "organizations table"
        - "users table with org_id"
        - "RLS foundation"
        - "auth context"
        - "Authentication required to view allergens"
  dependents:
    - epic: "02"
      name: "Technical Module"
      requires: "allergens for product ingredient declarations"
    - epic: "07"
      name: "Shipping Module"
      requires: "allergens for customer allergen restrictions"
    - epic: "06"
      name: "Quality Module"
      requires: "allergens for cross-contamination checks"

files_to_read:
  prd: "docs/1-BASELINE/product/modules/settings.md"
  prd_sections:
    - "FR-SET-070"  # 14 EU allergen management
    - "FR-SET-071"  # Allergen codes (A01-A14)
    - "FR-SET-072"  # Allergen labels (multi-language PL/EN/DE/FR)
    - "FR-SET-073"  # Allergen icons/symbols
    - "FR-SET-074"  # Custom allergen addition (OUT OF SCOPE - Phase 3)
  architecture: "docs/1-BASELINE/architecture/modules/settings.md"
  story: "docs/2-MANAGEMENT/epics/current/01-settings/01.12.allergens-management.md"
  adrs:
    - "docs/1-BASELINE/architecture/decisions/ADR-013-rls-org-isolation-pattern.md"
  patterns:
    - "apps/frontend/lib/validation/*.ts"  # Existing Zod schema patterns
    - "apps/frontend/components/ui/data-table.tsx"  # ShadCN DataTable
    - "apps/frontend/lib/services/*.ts"  # Existing service patterns

files_to_create:
  pages:
    - path: "apps/frontend/app/(authenticated)/settings/allergens/page.tsx"
      description: "Allergen list page with DataTable (read-only)"
  components:
    - path: "apps/frontend/components/settings/allergens/AllergensDataTable.tsx"
      description: "DataTable with search (no sorting needed, only 14 items)"
    - path: "apps/frontend/components/settings/allergens/AllergenRow.tsx"
      description: "Single allergen row with icon and multi-language names"
    - path: "apps/frontend/components/settings/allergens/AllergenIcon.tsx"
      description: "Icon component with fallback for missing icons"
    - path: "apps/frontend/components/settings/allergens/AllergenBadge.tsx"
      description: "Code + name badge for use across modules (Technical, Shipping, Quality)"
    - path: "apps/frontend/components/settings/allergens/AllergenDetailPanel.tsx"
      description: "Detail view panel/modal showing all language translations"
    - path: "apps/frontend/components/settings/allergens/AllergenLanguageTooltip.tsx"
      description: "Multi-language tooltip on row hover"
    - path: "apps/frontend/components/settings/allergens/AllergenReadOnlyBanner.tsx"
      description: "Info banner about read-only system-managed allergens"
  validation:
    - path: "apps/frontend/lib/validation/allergen-schema.ts"
      description: "Zod schemas for allergen responses (read-only)"
  api:
    - path: "apps/frontend/app/api/v1/settings/allergens/route.ts"
      methods: ["GET"]
      description: "List all 14 EU allergens with optional search"
    - path: "apps/frontend/app/api/v1/settings/allergens/[id]/route.ts"
      methods: ["GET"]
      description: "Get single allergen by ID"
  services:
    - path: "apps/frontend/lib/services/allergen-service.ts"
      description: "Allergen read-only service (list, get, search, select options)"
  database:
    - path: "supabase/migrations/055_create_allergens_table.sql"
      type: "migration"
      description: "Create allergens table and seed 14 EU allergens"
  assets:
    - path: "public/icons/allergens/"
      description: "14 SVG allergen icons (24x24 viewbox)"

database:
  tables:
    - name: "allergens"
      description: "EU-mandated allergens (global reference data, NOT org-scoped)"
      org_scoped: false
      columns:
        - "id UUID PRIMARY KEY DEFAULT gen_random_uuid()"
        - "code VARCHAR(10) UNIQUE NOT NULL"
        - "name_en VARCHAR(100) NOT NULL"
        - "name_pl VARCHAR(100) NOT NULL"
        - "name_de VARCHAR(100)"
        - "name_fr VARCHAR(100)"
        - "icon_url TEXT"
        - "icon_svg TEXT"
        - "is_eu_mandatory BOOLEAN DEFAULT true"
        - "is_custom BOOLEAN DEFAULT false"
        - "is_active BOOLEAN DEFAULT true"
        - "display_order INTEGER NOT NULL DEFAULT 0"
        - "created_at TIMESTAMPTZ DEFAULT NOW()"
        - "updated_at TIMESTAMPTZ DEFAULT NOW()"
      constraints:
        - "UNIQUE(code)"
        - "CHECK (code ~ '^A[0-9]{2}$')"
      rls: true
      rls_policies:
        - name: "allergens_select_authenticated"
          operation: "SELECT"
          for: "authenticated"
          using: "is_active = true"
          note: "All authenticated users can read (global reference data)"
        - name: "No INSERT/UPDATE/DELETE policies"
          note: "Read-only in MVP - absence of policies blocks write operations"
      indexes:
        - name: "idx_allergens_search"
          type: "GIN"
          expression: |
            to_tsvector('simple',
              coalesce(code, '') || ' ' ||
              coalesce(name_en, '') || ' ' ||
              coalesce(name_pl, '') || ' ' ||
              coalesce(name_de, '') || ' ' ||
              coalesce(name_fr, ''))
        - name: "idx_allergens_code"
          columns: ["code"]
        - name: "idx_allergens_display_order"
          columns: ["display_order"]

  seed_data:
    description: "14 EU mandatory allergens per Regulation (EU) No 1169/2011"
    allergens:
      - code: "A01"
        name_en: "Gluten"
        name_pl: "Gluten"
        name_de: "Gluten"
        name_fr: "Gluten"
        icon_url: "/icons/allergens/gluten.svg"
        display_order: 1
        description: "Cereals containing gluten (wheat, rye, barley, oats, spelt, kamut)"

      - code: "A02"
        name_en: "Crustaceans"
        name_pl: "Skorupiaki"
        name_de: "Krebstiere"
        name_fr: "Crustaces"
        icon_url: "/icons/allergens/crustaceans.svg"
        display_order: 2
        description: "Crustaceans and products thereof (shrimp, crab, lobster)"

      - code: "A03"
        name_en: "Eggs"
        name_pl: "Jaja"
        name_de: "Eier"
        name_fr: "Oeufs"
        icon_url: "/icons/allergens/eggs.svg"
        display_order: 3
        description: "Eggs and products thereof"

      - code: "A04"
        name_en: "Fish"
        name_pl: "Ryby"
        name_de: "Fisch"
        name_fr: "Poisson"
        icon_url: "/icons/allergens/fish.svg"
        display_order: 4
        description: "Fish and products thereof"

      - code: "A05"
        name_en: "Peanuts"
        name_pl: "Orzeszki ziemne"
        name_de: "Erdnusse"
        name_fr: "Arachides"
        icon_url: "/icons/allergens/peanuts.svg"
        display_order: 5
        description: "Peanuts and products thereof"

      - code: "A06"
        name_en: "Soybeans"
        name_pl: "Soja"
        name_de: "Soja"
        name_fr: "Soja"
        icon_url: "/icons/allergens/soybeans.svg"
        display_order: 6
        description: "Soybeans and products thereof"

      - code: "A07"
        name_en: "Milk"
        name_pl: "Mleko"
        name_de: "Milch"
        name_fr: "Lait"
        icon_url: "/icons/allergens/milk.svg"
        display_order: 7
        description: "Milk and products thereof (including lactose)"

      - code: "A08"
        name_en: "Nuts"
        name_pl: "Orzechy"
        name_de: "Schalenfruchte"
        name_fr: "Fruits a coque"
        icon_url: "/icons/allergens/nuts.svg"
        display_order: 8
        description: "Tree nuts (almonds, hazelnuts, walnuts, cashews, pecans, Brazil nuts, pistachios, macadamia)"

      - code: "A09"
        name_en: "Celery"
        name_pl: "Seler"
        name_de: "Sellerie"
        name_fr: "Celeri"
        icon_url: "/icons/allergens/celery.svg"
        display_order: 9
        description: "Celery and products thereof"

      - code: "A10"
        name_en: "Mustard"
        name_pl: "Gorczyca"
        name_de: "Senf"
        name_fr: "Moutarde"
        icon_url: "/icons/allergens/mustard.svg"
        display_order: 10
        description: "Mustard and products thereof"

      - code: "A11"
        name_en: "Sesame"
        name_pl: "Sezam"
        name_de: "Sesam"
        name_fr: "Sesame"
        icon_url: "/icons/allergens/sesame.svg"
        display_order: 11
        description: "Sesame seeds and products thereof"

      - code: "A12"
        name_en: "Sulphites"
        name_pl: "Siarczyny"
        name_de: "Sulfite"
        name_fr: "Sulfites"
        icon_url: "/icons/allergens/sulphites.svg"
        display_order: 12
        description: "Sulphur dioxide and sulphites at concentrations > 10mg/kg or 10mg/litre"

      - code: "A13"
        name_en: "Lupin"
        name_pl: "Lubin"
        name_de: "Lupinen"
        name_fr: "Lupin"
        icon_url: "/icons/allergens/lupin.svg"
        display_order: 13
        description: "Lupin and products thereof"

      - code: "A14"
        name_en: "Molluscs"
        name_pl: "Mieczaki"
        name_de: "Weichtiere"
        name_fr: "Mollusques"
        icon_url: "/icons/allergens/molluscs.svg"
        display_order: 14
        description: "Molluscs and products thereof (mussels, clams, oysters, squid)"

api_endpoints:
  - method: "GET"
    path: "/api/v1/settings/allergens"
    description: "List all 14 EU allergens with optional search"
    auth: true
    roles: ["*"]  # All authenticated users can view
    query_params:
      - "search: string (optional, searches code and all name columns)"
      - "lang: 'en' | 'pl' | 'de' | 'fr' (optional, for primary name sorting)"
    response:
      allergens: "Allergen[]"
      total: "number (always 14 for EU allergens)"
    performance: "< 200ms"
    notes: "No pagination needed - only 14 items"

  - method: "GET"
    path: "/api/v1/settings/allergens/:id"
    description: "Get single allergen by ID"
    auth: true
    roles: ["*"]  # All authenticated users can view
    response:
      allergen: "Allergen"
    errors:
      404: "Allergen not found"

  - method: "POST"
    path: "/api/v1/settings/allergens"
    description: "NOT IMPLEMENTED - Read-only in MVP"
    auth: true
    response:
      status: 405
      message: "Method Not Allowed"

  - method: "PUT"
    path: "/api/v1/settings/allergens/:id"
    description: "NOT IMPLEMENTED - Read-only in MVP"
    auth: true
    response:
      status: 405
      message: "Method Not Allowed"

  - method: "DELETE"
    path: "/api/v1/settings/allergens/:id"
    description: "NOT IMPLEMENTED - Read-only in MVP"
    auth: true
    response:
      status: 405
      message: "Method Not Allowed"

ux:
  wireframes:
    - id: "SET-TBD"
      path: "TBD"
      description: "Allergen List page (pending wireframe)"
      components:
        - "DataTable with Code, Icon, Name (localized), Name EN, Name PL columns"
        - "Search input (searches code and all language name fields)"
        - "Read-only info banner"
        - "Allergen detail panel/modal on row click"
        - "Multi-language tooltip on row hover"
  patterns:
    table: "ShadCN DataTable (simple, no pagination)"
    panel: "ShadCN Sheet or Dialog for detail view"
    search: "Debounced search input (100ms)"
    tooltip: "ShadCN Tooltip for multi-language hover"
    badge: "ShadCN Badge for allergen code"
    banner: "ShadCN Alert for read-only info"
  states:
    loading: "Skeleton rows (3) with shimmer animation"
    empty: "Never empty - 14 allergens always seeded"
    error: "'Failed to load allergens' warning with Retry button"
    success: "Table with 14 allergens"
  icon_display:
    list_size: "24x24"
    detail_size: "48x48"
    fallback: "Warning triangle or generic allergen placeholder icon"
    format: "SVG with currentColor for theming"
  language_display:
    primary: "Based on user language preference (default EN)"
    hover: "Tooltip shows all 4 translations"
    columns: "Always show Code, Name (localized), Name EN, Name PL"

validation_rules:
  allergen_response:
    id:
      type: "string"
      format: "uuid"
    code:
      type: "string"
      pattern: "^A[0-9]{2}$"
      description: "A01-A14 format"
    name_en:
      type: "string"
      min: 1
      max: 100
    name_pl:
      type: "string"
      min: 1
      max: 100
    name_de:
      type: "string"
      max: 100
      nullable: true
    name_fr:
      type: "string"
      max: 100
      nullable: true
    icon_url:
      type: "string"
      format: "url"
      nullable: true
    is_eu_mandatory:
      type: "boolean"
    display_order:
      type: "integer"
      min: 0

  search_params:
    search:
      type: "string"
      max: 100
      optional: true
    lang:
      type: "enum"
      values: ["en", "pl", "de", "fr"]
      optional: true

patterns:
  rls: "ADR-013 - RLS for authenticated access (no org isolation - global data)"
  api: "REST read-only endpoints"
  service: "Class-based AllergenService with static read methods"
  validation: "Zod schemas for response validation"
  read_only: |
    // MVP is read-only - no write operations
    // POST/PUT/DELETE return 405 Method Not Allowed
    if (req.method !== 'GET') {
      return NextResponse.json(
        { error: 'Method Not Allowed' },
        { status: 405 }
      );
    }
  language_helper: |
    // Get allergen name in user's preferred language
    getName(allergen: Allergen, lang: string): string {
      const key = `name_${lang}` as keyof Allergen;
      return (allergen[key] as string) || allergen.name_en;
    }
  select_options: |
    // For product forms (Technical module)
    async getAllergensForSelect(lang?: string): Promise<AllergenSelectOption[]> {
      const allergens = await this.getAllergens();
      return allergens.map(a => ({
        value: a.id,
        label: `${a.code} - ${this.getName(a, lang || 'en')}`,
        code: a.code,
        icon_url: a.icon_url
      }));
    }

acceptance_checklist:
  allergen_list_page:
    - "GIVEN authenticated user navigates to /settings/allergens, WHEN page loads, THEN allergen list displays 14 EU allergens within 200ms"
    - "GIVEN allergen list displayed, WHEN columns rendered, THEN columns show: Code, Icon, Name (current language), Name EN, Name PL, Status"
    - "GIVEN allergen list displayed, WHEN user language preference is Polish (PL), THEN primary name column displays Polish names"
    - "GIVEN allergen list displayed, WHEN user language preference is English (EN), THEN primary name column displays English names"
    - "GIVEN allergen list displayed, WHEN allergens rendered, THEN sorted by display_order (A01 first, A14 last)"

  allergen_search:
    - "GIVEN allergen list displayed, WHEN user searches 'milk', THEN A07 (Milk/Mleko) displays within 100ms"
    - "GIVEN allergen list displayed, WHEN user searches 'gluten', THEN A01 (Gluten) displays"
    - "GIVEN allergen list displayed, WHEN user searches 'A05', THEN Peanuts (Orzeszki ziemne) displays"
    - "GIVEN allergen list displayed, WHEN user types in search box, THEN search filters across code AND all language name fields"
    - "GIVEN allergen list displayed, WHEN user searches 'orzechy' (Polish for nuts), THEN A08 Nuts displays"
    - "GIVEN allergen list displayed, WHEN user searches non-existent term 'xyz', THEN no results message displays"

  allergen_detail:
    - "GIVEN allergen list displayed, WHEN user clicks on allergen row (A01 - Gluten), THEN allergen detail panel/modal shows all fields"
    - "GIVEN allergen detail displayed, WHEN viewing A01, THEN shows: Code: A01, Icon, Name EN: Gluten, Name PL: Gluten, Name DE: Gluten, Name FR: Gluten, Status: Active"
    - "GIVEN allergen detail displayed, WHEN user views icon, THEN icon displays at 48x48 minimum size with accessible alt text"

  allergen_icons:
    - "GIVEN allergen list displayed, WHEN icon column rendered, THEN each allergen shows its unique icon at 24x24 size"
    - "GIVEN allergen icon not available (icon_url is null), WHEN row rendered, THEN placeholder icon (warning triangle or generic allergen icon) displays"
    - "GIVEN all 14 allergens, WHEN icons loaded, THEN no broken images (all load or show fallback)"

  multi_language_display:
    - "GIVEN allergen list displayed, WHEN user hovers over allergen row, THEN tooltip shows all available translations: EN, PL, DE, FR"
    - "GIVEN allergen used in product form (Technical module), WHEN allergen selector rendered, THEN allergen displays in user's language preference with code prefix"

  read_only_mode:
    - "GIVEN user is SUPER_ADMIN, WHEN viewing allergen list, THEN no Add/Edit/Delete buttons visible (read-only)"
    - "GIVEN user attempts to POST /api/v1/settings/allergens, WHEN request processed, THEN 405 Method Not Allowed returned"
    - "GIVEN user attempts to PUT /api/v1/settings/allergens/:id, WHEN request processed, THEN 405 Method Not Allowed returned"
    - "GIVEN user attempts to DELETE /api/v1/settings/allergens/:id, WHEN request processed, THEN 405 Method Not Allowed returned"
    - "GIVEN allergen list page, WHEN rendered, THEN info banner displays: 'EU-mandated allergens are system-managed. Contact support for custom allergen requests.'"

  permission_enforcement:
    - "GIVEN user has any authenticated role, WHEN /settings/allergens accessed, THEN read access granted (all roles can view allergens)"
    - "GIVEN unauthenticated request, WHEN /api/v1/settings/allergens accessed, THEN 401 Unauthorized returned"

definition_of_done:
  - "Database migration creates allergens table with all constraints"
  - "Seed migration populates 14 EU allergens with all 4 language translations"
  - "RLS policy allows authenticated read access"
  - "API endpoint GET /api/v1/settings/allergens returns all 14 allergens"
  - "API endpoint GET /api/v1/settings/allergens/:id returns single allergen"
  - "POST/PUT/DELETE endpoints return 405 Method Not Allowed"
  - "allergen-service.ts with all read methods (list, get, search, select options)"
  - "Zod validation schemas for API responses"
  - "Allergens list page displays 14 items sorted by display_order"
  - "Search filters across code and all language name fields"
  - "Allergen icons display with fallback for missing icons"
  - "Multi-language tooltip on row hover"
  - "Read-only info banner displayed"
  - "Page loads within 200ms"
  - "Unit tests for allergen-service (>80% coverage)"
  - "Integration tests for API endpoints"
  - "E2E tests for critical flows"
  - "Allergen icons added to /public/icons/allergens/ directory (14 SVG files)"

tests:
  unit:
    - "AllergenService.getAllergens() returns all 14 EU allergens"
    - "AllergenService.getAllergenById() returns single allergen"
    - "AllergenService.getAllergenByCode('A01') returns Gluten"
    - "AllergenService.getAllergenByCode('A99') returns null/throws not found"
    - "AllergenService.searchAllergens('milk') returns A07"
    - "AllergenService.searchAllergens('A05') returns Peanuts"
    - "AllergenService.searchAllergens('orzechy') returns A08 Nuts (Polish)"
    - "AllergenService.searchAllergens('xyz') returns empty array"
    - "AllergenService.getName(allergen, 'pl') returns Polish name"
    - "AllergenService.getName(allergen, 'de') returns German name"
    - "AllergenService.getName(allergen, 'invalid') falls back to English"
    - "AllergenService.getAllergensForSelect() returns 14 select options"
    - "Zod schema validates correct allergen response"
    - "Zod schema rejects invalid code format"
    - "AllergenIcon renders SVG when icon_url provided"
    - "AllergenIcon renders fallback when icon_url is null"
  integration:
    - "GET /api/v1/settings/allergens returns all 14 allergens"
    - "GET /api/v1/settings/allergens?search=gluten returns A01"
    - "GET /api/v1/settings/allergens?search=A07 returns Milk"
    - "GET /api/v1/settings/allergens/:id (valid) returns allergen detail"
    - "GET /api/v1/settings/allergens/:id (invalid) returns 404"
    - "POST /api/v1/settings/allergens returns 405 Method Not Allowed"
    - "PUT /api/v1/settings/allergens/:id returns 405 Method Not Allowed"
    - "DELETE /api/v1/settings/allergens/:id returns 405 Method Not Allowed"
    - "GET /api/v1/settings/allergens unauthenticated returns 401"
    - "Response includes all language fields (name_en, name_pl, name_de, name_fr)"
    - "Response ordered by display_order (A01 first, A14 last)"
  e2e:
    - "Navigate to allergens page, verify 14 allergens displayed"
    - "Search for 'milk', verify A07 filtered and shown"
    - "Clear search, verify all 14 shown again"
    - "Click allergen row, verify detail panel opens with all translations"
    - "Verify all icons load (no broken images)"
    - "Hover row, verify multi-language tooltip shows"
    - "Verify read-only banner visible"
    - "Verify no edit/delete buttons present"
    - "Change language preference, verify name column updates"
    - "Verify page loads under 200ms"

output_artifacts:
  database:
    - "Migration: 055_create_allergens_table.sql"
    - "RLS policy: allergens_select_authenticated"
    - "Indexes: idx_allergens_search, idx_allergens_code, idx_allergens_display_order"
    - "Seed data: 14 EU allergens with all translations"
  backend:
    - "allergen-service.ts with read-only operations"
    - "allergen-schema.ts Zod validation schemas"
    - "API route: GET /api/v1/settings/allergens"
    - "API route: GET /api/v1/settings/allergens/:id"
  frontend:
    - "AllergensDataTable.tsx component with search"
    - "AllergenRow.tsx component"
    - "AllergenIcon.tsx component with fallback"
    - "AllergenBadge.tsx component (for use across modules)"
    - "AllergenDetailPanel.tsx component"
    - "AllergenLanguageTooltip.tsx component"
    - "AllergenReadOnlyBanner.tsx component"
  assets:
    - "14 SVG allergen icons in /public/icons/allergens/"
  tests:
    - "Unit tests for allergen-service (>80% coverage)"
    - "Integration tests for API endpoints"
    - "E2E tests for allergen list flows"

implementation_notes:
  frontend:
    - "Use ShadCN DataTable for allergen list (no pagination needed)"
    - "Use ShadCN Sheet or Dialog for detail view"
    - "Debounce search input by 100ms"
    - "Show skeleton loaders while data is loading"
    - "Use AllergenIcon component with fallback for missing icons"
    - "Use Tooltip component for multi-language hover display"
    - "Use Alert component for read-only info banner"
    - "AllergenBadge component should be reusable for Technical/Shipping/Quality modules"
    - "Support user language preference for primary name display"
  backend:
    - "Allergens table is NOT org-scoped (global reference data)"
    - "RLS policy only requires authenticated user (no org check)"
    - "Return 405 for POST/PUT/DELETE (read-only MVP)"
    - "Search should use full-text search across all name columns"
    - "No pagination needed - always return all 14"
    - "Order by display_order column"
  database:
    - "Create migration with allergens table"
    - "Seed 14 EU allergens in same migration"
    - "Use ON CONFLICT (code) DO NOTHING for idempotent seeding"
    - "Verify RLS policy active"
    - "Create GIN index for full-text search"
  assets:
    - "Create 14 SVG allergen icons (24x24 viewbox)"
    - "Icons should use currentColor for theming"
    - "Include <title> element for accessibility"
    - "File names: gluten.svg, crustaceans.svg, eggs.svg, fish.svg, peanuts.svg, soybeans.svg, milk.svg, nuts.svg, celery.svg, mustard.svg, sesame.svg, sulphites.svg, lupin.svg, molluscs.svg"

out_of_scope:
  - requirement: "FR-SET-074"
    description: "Custom allergen addition"
    reason: "Requires org-scoped allergens table extension"
    target_phase: "Phase 3"
  - requirement: "Allergen editing"
    description: "Edit EU allergens"
    reason: "EU allergens are regulatory constants"
    target_phase: "Never"
  - requirement: "Allergen deletion"
    description: "Delete EU allergens"
    reason: "Regulatory compliance requirement"
    target_phase: "Never"
  - requirement: "Additional languages"
    description: "Languages beyond PL/EN/DE/FR"
    reason: "Can be added later via migration"
    target_phase: "Phase 3"
  - requirement: "Allergen severity levels"
    description: "Severity/risk levels per allergen"
    reason: "Not required by EU regulation"
    target_phase: "Phase 3"
  - requirement: "Allergen alternatives/substitutes"
    description: "Alternative ingredients for allergens"
    reason: "Product formulation feature"
    target_phase: "Phase 3"
