# Story Context: 01.7 Module Toggles
# Generated: 2025-12-16
# Purpose: AI agent context for implementing module activation/deactivation

story:
  id: "01.7"
  name: "Module Toggles"
  epic: "01-settings"
  phase: "1A"
  complexity: "M"
  estimate_days: 3
  type: "frontend + backend"
  state: "ready"

dependencies:
  required:
    - story: "01.1"
      name: "Org Context + Base RLS"
      provides:
        - "organizations table"
        - "users table with org_id"
        - "RLS foundation"
        - "auth context"
    - story: "01.2"
      name: "Settings Shell + Navigation"
      provides:
        - "Settings layout"
        - "Navigation guards"
        - "Sidebar navigation structure"
    - story: "01.6"
      name: "Role Permissions"
      provides:
        - "10-role permission system"
        - "Role-based access control"
        - "Admin+ role check"

files_to_read:
  prd: "docs/1-BASELINE/product/modules/settings.md"
  prd_sections:
    - "FR-SET-090"  # Module activation/deactivation
    - "FR-SET-091"  # Planning module toggle
    - "FR-SET-092"  # Production module toggle
    - "FR-SET-093"  # Quality module toggle
    - "FR-SET-094"  # Warehouse module toggle
    - "FR-SET-095"  # Shipping module toggle
    - "FR-SET-096"  # Technical module toggle
    - "FR-SET-097"  # Module dependency validation
  architecture:
    - "docs/1-BASELINE/architecture/decisions/ADR-011-module-toggle-storage.md"
    - "docs/1-BASELINE/architecture/decisions/ADR-013-rls-org-isolation-pattern.md"
  story: "docs/2-MANAGEMENT/epics/current/01-settings/01.7.module-toggles.md"
  patterns:
    - "apps/frontend/lib/services/*-service.ts"  # Service pattern
    - "apps/frontend/lib/validation/*.ts"  # Zod schema patterns
    - "apps/frontend/components/ui/switch.tsx"  # ShadCN Switch component

files_to_create:
  database:
    - path: "supabase/migrations/053_create_modules_tables.sql"
      type: "migration"
      description: "Create modules and organization_modules tables"
  api:
    - path: "apps/frontend/app/api/v1/settings/modules/route.ts"
      methods: ["GET"]
      description: "List all modules with org-specific status"
    - path: "apps/frontend/app/api/v1/settings/modules/[id]/toggle/route.ts"
      methods: ["PATCH"]
      description: "Toggle module enabled/disabled"
  services:
    - path: "apps/frontend/lib/services/module-settings-service.ts"
      description: "Module toggle logic with dependency validation"
  validation:
    - path: "apps/frontend/lib/validation/module-toggle.ts"
      description: "Zod schema for toggle request"
  pages:
    - path: "apps/frontend/app/(authenticated)/settings/modules/page.tsx"
      description: "Module toggles page"
  components:
    - path: "apps/frontend/components/settings/modules/ModuleCard.tsx"
      description: "Individual module card with toggle switch"
    - path: "apps/frontend/components/settings/modules/ModuleToggleList.tsx"
      description: "List of module cards grouped by type"
    - path: "apps/frontend/components/settings/modules/DependencyWarningModal.tsx"
      description: "Modal for dependency confirmation"
  middleware:
    - path: "apps/frontend/middleware/module-guard.ts"
      description: "Middleware to check module enabled status"
  hooks:
    - path: "apps/frontend/lib/hooks/use-modules.ts"
      description: "React hook for module state and toggles"

database:
  tables:
    - name: "modules"
      description: "System-defined modules (seeded, read-only)"
      columns:
        - "id UUID PRIMARY KEY DEFAULT gen_random_uuid()"
        - "code VARCHAR(50) UNIQUE NOT NULL"
        - "name VARCHAR(100) NOT NULL"
        - "description TEXT"
        - "dependencies TEXT[]"
        - "can_disable BOOLEAN DEFAULT true"
        - "display_order INT"
        - "created_at TIMESTAMPTZ DEFAULT NOW()"
      rls: true
      rls_policy: "SELECT only for all authenticated users (system data)"
      indexes:
        - "code (unique)"
        - "display_order"
      seed_data:
        - "('settings', 'Settings', 'Organization and user management', '{}', false, 0)"
        - "('technical', 'Technical', 'Products, BOMs, and routings', '{}', true, 1)"
        - "('planning', 'Planning', 'Work orders and scheduling', '{technical}', true, 2)"
        - "('production', 'Production', 'Work order execution', '{technical,planning}', true, 3)"
        - "('quality', 'Quality', 'QC holds and inspections', '{production}', true, 4)"
        - "('warehouse', 'Warehouse', 'Inventory and license plates', '{technical}', true, 5)"
        - "('shipping', 'Shipping', 'Order fulfillment and dispatch', '{warehouse}', true, 6)"

    - name: "organization_modules"
      description: "Org-specific module enabled state"
      columns:
        - "id UUID PRIMARY KEY DEFAULT gen_random_uuid()"
        - "org_id UUID NOT NULL REFERENCES organizations(id)"
        - "module_id UUID NOT NULL REFERENCES modules(id)"
        - "enabled BOOLEAN DEFAULT false"
        - "enabled_at TIMESTAMPTZ"
        - "enabled_by UUID REFERENCES users(id)"
        - "created_at TIMESTAMPTZ DEFAULT NOW()"
        - "UNIQUE(org_id, module_id)"
      rls: true
      rls_policy: "ADR-013 users lookup pattern"
      indexes:
        - "org_id"
        - "module_id"
        - "(org_id, module_id) UNIQUE"

  rls_policies:
    modules:
      - name: "modules_select"
        operation: "SELECT"
        role: "authenticated"
        using: "true"
        notes: "Read-only for all authenticated users (system data)"
    organization_modules:
      - name: "org_modules_select"
        operation: "SELECT"
        role: "authenticated"
        using: "org_id = (SELECT org_id FROM users WHERE id = auth.uid())"
      - name: "org_modules_insert"
        operation: "INSERT"
        role: "authenticated"
        with_check: "org_id = (SELECT org_id FROM users WHERE id = auth.uid())"
      - name: "org_modules_update"
        operation: "UPDATE"
        role: "authenticated"
        using: "org_id = (SELECT org_id FROM users WHERE id = auth.uid())"

api_endpoints:
  - method: "GET"
    path: "/api/v1/settings/modules"
    description: "List all modules with org-specific enabled status"
    auth: true
    roles: ["*"]
    response:
      modules:
        - id: "uuid"
          code: "string"
          name: "string"
          description: "string"
          enabled: "boolean"
          dependencies: "string[]"
          dependents: "string[]"
          can_disable: "boolean"
          display_order: "number"

  - method: "PATCH"
    path: "/api/v1/settings/modules/:id/toggle"
    description: "Enable or disable a module for the organization"
    auth: true
    roles: ["super_admin", "admin"]
    request_body:
      enabled: "boolean (required)"
      cascade: "boolean (optional, default: false) - auto-enable/disable dependencies"
    response:
      success: "boolean"
      affected_modules: "string[] - modules that were also toggled"
      warning: "string (optional) - if cascade needed but not requested"
    errors:
      - code: 400
        message: "Module dependencies not met"
        condition: "Enabling module without required dependencies (cascade=false)"
      - code: 400
        message: "Module has active dependents"
        condition: "Disabling module with active dependents (cascade=false)"
      - code: 403
        message: "Admin role required"
        condition: "Non-admin user attempts toggle"
      - code: 404
        message: "Module not found"
        condition: "Invalid module ID"

ux:
  wireframes:
    - id: "SET-022"
      path: "docs/3-ARCHITECTURE/ux/wireframes/SET-022-module-toggles.md"
      description: "Module Toggles management page"
      components:
        - "Page header with description"
        - "Module cards grouped by type (Core, Premium, New)"
        - "Toggle switches (ON/OFF visual state)"
        - "Dependency indicators (Requires: X, Required for: Y)"
        - "Premium badge with upgrade button"
        - "Status summary footer (X enabled, Y disabled)"
        - "Expand/Collapse group sections"
  patterns:
    card: "ShadCN Card with icon, name, description, toggle"
    toggle: "ShadCN Switch component for ON/OFF"
    modal: "ShadCN Dialog for dependency warnings"
    toast: "ShadCN Toast for success/error messages"
    grouping: "Collapsible sections for Core/Premium/New"
  states:
    - "loading: Skeleton cards (6 items)"
    - "success: Module cards with current status"
    - "empty: All modules disabled message with CTA"
    - "error: Failed to load with retry button"
    - "toggling: Switch disabled during API call"

module_definitions:
  core_modules:
    - code: "settings"
      name: "Settings"
      icon: "cog"
      default: "ON (always)"
      can_disable: false
      dependencies: []
      description: "Organization and user management"
      price: "Free"
    - code: "technical"
      name: "Technical"
      icon: "clipboard"
      default: "ON"
      can_disable: true
      dependencies: []
      required_by: ["planning", "warehouse", "npd"]
      description: "Products, BOMs, Routings, Allergens, Traceability"
      price: "Free"
    - code: "planning"
      name: "Planning"
      icon: "calendar"
      default: "OFF"
      can_disable: true
      dependencies: ["technical"]
      required_by: ["production", "finance"]
      description: "Purchase Orders, Transfer Orders, Work Orders, MRP"
      price: "Free"
    - code: "production"
      name: "Production"
      icon: "factory"
      default: "OFF"
      can_disable: true
      dependencies: ["technical", "planning"]
      required_by: ["quality", "oee", "finance"]
      description: "Work Order Execution, Material Consumption, Outputs"
      price: "Free"
    - code: "quality"
      name: "Quality"
      icon: "check-circle"
      default: "OFF"
      can_disable: true
      dependencies: ["production"]
      required_by: ["shipping"]
      description: "QA Status, Holds, Inspections, NCR, HACCP, CAPA"
      price: "Free"
    - code: "warehouse"
      name: "Warehouse"
      icon: "package"
      default: "OFF"
      can_disable: true
      dependencies: ["technical"]
      required_by: ["shipping", "production", "finance"]
      description: "License Plates, ASN/GRN, Stock, FIFO/FEFO, Locations"
      price: "Free"
    - code: "shipping"
      name: "Shipping"
      icon: "truck"
      default: "OFF"
      can_disable: true
      dependencies: ["warehouse"]
      required_by: []
      description: "Sales Orders, Picking, Packing, Carriers, GS1 Labels"
      price: "Free"

  premium_modules:
    - code: "npd"
      name: "NPD"
      icon: "flask"
      default: "OFF"
      can_disable: true
      dependencies: ["technical"]
      description: "Stage-Gate Workflow, Trial BOMs, Sample Management"
      price: "$50/user/mo"
    - code: "finance"
      name: "Finance"
      icon: "dollar"
      default: "OFF"
      can_disable: true
      dependencies: ["production", "warehouse"]
      description: "Production Costing, Variance, Margins"
      price: "$50/user/mo"
    - code: "oee"
      name: "OEE"
      icon: "chart"
      default: "OFF"
      can_disable: true
      dependencies: ["production"]
      description: "Real-time OEE, Machine Dashboard, Downtime, Energy"
      price: "$50/user/mo"
    - code: "integrations"
      name: "Integrations"
      icon: "link"
      default: "OFF"
      can_disable: true
      dependencies: []
      description: "Comarch Optima, EDI, Portals, Webhooks, API Access"
      price: "$50/user/mo"

dependency_matrix:
  # Module: [requires these to be enabled]
  settings: []
  technical: []
  planning: ["technical"]
  production: ["technical", "planning"]
  quality: ["production"]
  warehouse: ["technical"]
  shipping: ["warehouse"]
  npd: ["technical"]
  finance: ["production", "warehouse"]
  oee: ["production"]
  integrations: []

  # Reverse: Module is required by these
  reverse_dependencies:
    settings: []
    technical: ["planning", "warehouse", "npd", "production"]
    planning: ["production", "finance"]
    production: ["quality", "oee", "finance"]
    quality: ["shipping"]
    warehouse: ["shipping", "finance", "production"]
    shipping: []
    npd: []
    finance: []
    oee: []
    integrations: []

dependency_graph: |
  Settings (always enabled, cannot disable)

  Technical (standalone)
      |
      +---> Planning
      |       |
      |       +---> Production
      |               |
      |               +---> Quality
      |               |       |
      |               |       +---> Shipping
      |               |
      |               +---> OEE
      |               |
      |               +---> Finance (also requires Warehouse)
      |
      +---> Warehouse
      |       |
      |       +---> Shipping
      |       |
      |       +---> Finance (also requires Production)
      |
      +---> NPD

  Integrations (no dependencies, connects to all)

validation_rules:
  toggle_enable:
    description: "When enabling a module, check dependencies"
    rules:
      - "All modules in dependencies[] must be enabled"
      - "If dependencies not met, return warning with missing deps list"
      - "If cascade=true, enable all missing deps first"
  toggle_disable:
    description: "When disabling a module, check dependents"
    rules:
      - "All modules that have this module in dependencies[] must be disabled"
      - "If active dependents exist, return warning with dependents list"
      - "If cascade=true, disable all dependents first"
      - "Settings module cannot be disabled (can_disable=false)"
  active_data_warning:
    description: "When disabling, check for active data"
    rules:
      - "Planning: Check for open work orders"
      - "Production: Check for in-progress work orders"
      - "Warehouse: Check for non-zero inventory"
      - "If active data exists, show warning but allow disable"

patterns:
  rls: "ADR-013 - RLS Org Isolation Pattern (users lookup)"
  storage: "ADR-011 - Module Toggle Storage (junction table)"
  api: "REST with org_id from auth context"
  service: "Class-based ModuleSettingsService with static methods"
  validation: "Zod schemas in lib/validation/"
  middleware: "Next.js middleware for module guard on routes"

navigation_integration:
  description: "Navigation must hide disabled modules"
  implementation:
    - "Fetch enabled modules on app init"
    - "Store in React context or global state"
    - "Filter navigation items by enabled modules"
    - "Update navigation after toggle (no page reload)"
    - "Settings module always visible"
  example_code: |
    // Use in layout/navigation component
    function NavigationSidebar() {
      const { enabledModules } = useModules();

      const navItems = ALL_NAV_ITEMS.filter(item =>
        item.module === 'settings' || enabledModules.includes(item.module)
      );

      return <SideNav items={navItems} />;
    }

route_guard_integration:
  description: "Direct URL access to disabled modules must redirect"
  implementation:
    - "Use Next.js middleware to check module status"
    - "Redirect to /dashboard with error query param"
    - "Show toast: 'Module not enabled for this organization'"
  example_code: |
    // app/(authenticated)/[module]/layout.tsx
    export default async function ModuleLayout({
      children,
      params
    }: {
      children: React.ReactNode;
      params: { module: string };
    }) {
      const enabled = await isModuleEnabled(params.module);

      if (!enabled) {
        redirect('/dashboard?error=module_disabled');
      }

      return <>{children}</>;
    }

api_guard_integration:
  description: "API endpoints for disabled modules must return 403"
  implementation:
    - "Middleware checks module enabled before route handler"
    - "Return 403 with message: 'Module not enabled for this organization'"
  example_code: |
    // middleware/module-guard.ts
    export function requireModule(moduleCode: string): Middleware {
      return async (req, context) => {
        const orgId = getOrgId(req);
        const enabled = await isModuleEnabled(orgId, moduleCode);

        if (!enabled) {
          return Response.json(
            { error: "Module not enabled for this organization" },
            { status: 403 }
          );
        }

        return context.next();
      };
    }

permissions:
  view_modules:
    roles: ["super_admin", "admin", "manager", "supervisor", "quality_lead", "warehouse_lead", "production_lead", "operator", "viewer"]
    notes: "All roles can view the modules page (read-only for non-admin)"
  toggle_modules:
    roles: ["super_admin", "admin"]
    notes: "Only Admin+ can enable/disable modules"
  upgrade_premium:
    roles: ["super_admin", "admin"]
    notes: "Only Admin+ can initiate subscription upgrade"

acceptance_checklist:
  module_list_page:
    - "GIVEN admin navigates to /settings/modules, WHEN page loads, THEN 6 toggleable modules display with current status"
    - "GIVEN Settings module, WHEN toggle page loads, THEN Settings has no toggle switch (always enabled, not toggleable)"
    - "GIVEN module list displayed, WHEN toggle switch shown, THEN enabled modules show ON (green), disabled show OFF (gray)"

  enable_module:
    - "GIVEN admin enables Warehouse module, WHEN toggle switched ON, THEN 'Warehouse' appears in navigation within 1 second"
    - "GIVEN Production requires Technical and Planning, WHEN enabling Production while both ON, THEN Production enables successfully"

  enable_with_dependencies:
    - "GIVEN Technical is OFF, WHEN admin tries to enable Planning, THEN warning displays: 'Planning requires Technical. Enable Technical first?'"
    - "GIVEN warning shown with 'Enable Both' button, WHEN clicked, THEN both Technical and Planning enabled"
    - "GIVEN warning shown, WHEN 'Cancel' clicked, THEN no changes made"

  disable_module:
    - "GIVEN Production module is ON, WHEN admin toggles OFF, THEN Production hidden from navigation within 1 second"
    - "GIVEN admin disables Planning module with active work orders, WHEN toggle switched OFF, THEN warning 'Module has active data. Disable anyway?' displays"

  disable_with_dependents:
    - "GIVEN Quality depends on Production, WHEN admin disables Production while Quality is ON, THEN warning displays: 'Quality depends on Production. Disable Quality also?'"
    - "GIVEN warning shown with 'Disable Both', WHEN clicked, THEN both Production and Quality disabled"
    - "GIVEN cascade warning shown, WHEN 'Cancel' clicked, THEN no changes made"

  navigation_enforcement:
    - "GIVEN Production module disabled, WHEN user views navigation sidebar, THEN 'Production' menu item hidden"
    - "GIVEN all modules disabled except Settings, WHEN user logs in, THEN only Settings accessible in navigation"

  direct_url_enforcement:
    - "GIVEN Production module disabled, WHEN user navigates to /production/dashboard directly, THEN redirect to dashboard with toast 'Module not enabled for this organization'"
    - "GIVEN Warehouse module disabled, WHEN user bookmarks /warehouse/inventory, THEN accessing bookmark shows redirect message"

  api_enforcement:
    - "GIVEN Quality module disabled, WHEN API call to /api/v1/quality/inspections made, THEN 403 'Module not enabled for this organization' returns"
    - "GIVEN Technical module enabled, WHEN API call to /api/v1/technical/products made, THEN request proceeds normally"

  permission_enforcement:
    - "GIVEN user with VIEWER role, WHEN accessing /settings/modules, THEN page loads read-only (toggles disabled)"
    - "GIVEN user with ADMIN role, WHEN accessing /settings/modules, THEN toggles are interactive"

definition_of_done:
  - "modules table created with 7 core modules seeded (1 non-toggleable + 6 toggleable)"
  - "organization_modules table created with RLS policies (ADR-013)"
  - "GET /api/v1/settings/modules returns all modules with org-specific status"
  - "PATCH /api/v1/settings/modules/:id/toggle works with dependency validation"
  - "Module toggles page displays 6 toggleable modules with correct status"
  - "Settings module always enabled, no toggle switch displayed"
  - "Enable/disable updates navigation within 1 second (no page reload)"
  - "Dependency validation shows warning before cascade"
  - "Direct URL to disabled module redirects with message"
  - "API returns 403 for disabled module endpoints"
  - "Admin+ required to toggle modules (VIEWER sees read-only)"
  - "Unit tests for module-settings-service (>80% coverage)"
  - "Integration tests for dependency scenarios"

tests:
  unit:
    - "validateModuleToggle correctly identifies missing dependencies"
    - "validateModuleToggle correctly identifies active dependents"
    - "getAffectedModules returns correct cascade list (enable)"
    - "getAffectedModules returns correct cascade list (disable)"
    - "canDisable returns false for Settings module"
    - "Toggle switch disabled for non-admin roles"
  integration:
    - "Enable module updates organization_modules table"
    - "Enable with cascade enables all dependencies"
    - "Disable module updates organization_modules table"
    - "Disable with cascade disables all dependents"
    - "API returns 403 for disabled module endpoints"
    - "Navigation hides disabled modules"
    - "Direct URL redirect works for disabled modules"

output_artifacts:
  database:
    - "Migration: 053_create_modules_tables.sql"
    - "Seed data for 7 core modules + 4 premium modules"
    - "RLS policies for modules and organization_modules"
  backend:
    - "module-settings-service.ts with toggle logic"
    - "module-toggle.ts Zod validation schema"
    - "API routes: GET /modules, PATCH /modules/:id/toggle"
    - "module-guard.ts middleware"
  frontend:
    - "modules/page.tsx - Module toggles page"
    - "ModuleCard.tsx - Individual module card component"
    - "ModuleToggleList.tsx - Grouped module list"
    - "DependencyWarningModal.tsx - Confirmation dialog"
    - "use-modules.ts - React hook for module state"
  tests:
    - "Unit tests for ModuleSettingsService"
    - "Integration tests for toggle scenarios"
    - "E2E tests for navigation and redirect behavior"

implementation_notes:
  database:
    - "Create migration 053 with modules and organization_modules tables"
    - "Seed 11 modules (7 core + 4 premium) with dependencies"
    - "Settings module has can_disable=false"
    - "Technical module has can_disable=true but may have dependents"
  backend:
    - "ModuleSettingsService handles all toggle logic"
    - "Dependency validation is recursive (check full chain)"
    - "Use transactions for cascade operations"
    - "Cache module list per org (invalidate on toggle)"
  frontend:
    - "Use ShadCN Switch for toggle"
    - "Use ShadCN Dialog for dependency warnings"
    - "Group modules by type (Core, Premium, New)"
    - "Disable toggles for non-admin roles"
    - "Update navigation context after toggle"
  middleware:
    - "Check module enabled in route layout (not middleware.ts)"
    - "API routes use requireModule() wrapper"
    - "Redirect to /dashboard?error=module_disabled"
