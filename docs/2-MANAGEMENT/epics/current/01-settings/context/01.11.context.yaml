# Story Context: 01.11 Production Lines CRUD
# Generated: 2025-12-16
# Purpose: AI agent context for implementing production line management with machine sequence and product compatibility

story:
  id: "01.11"
  name: "Production Lines CRUD"
  epic: "01-settings"
  phase: "1B"
  complexity: "L"
  estimate_days: 5
  type: "full-stack"
  state: "ready"
  priority: "P0"
  story_file: "docs/2-MANAGEMENT/epics/current/01-settings/01.11.production-lines-crud.md"

dependencies:
  required:
    - story: "01.1"
      name: "Org Context + Base RLS"
      provides:
        - "organizations table"
        - "org_id context"
        - "RLS policies for tenant isolation"
    - story: "01.6"
      name: "Role-Based Permissions"
      provides:
        - "roles table with 10 predefined roles"
        - "permission matrix (module x CRUD)"
        - "hasPermission() helper function"
        - "usePermissions() React hook"
    - story: "01.8"
      name: "Warehouses CRUD"
      provides:
        - "warehouses table"
        - "warehouse dropdown data"
    - story: "01.9"
      name: "Locations CRUD"
      provides:
        - "locations table"
        - "default_output_location_id reference"
    - story: "01.10"
      name: "Machines CRUD"
      provides:
        - "machines table"
        - "machine data for assignment"
        - "capacity_per_hour field for bottleneck calculation"
  external:
    - name: "Products table"
      provides:
        - "products table for FR-SET-065 line-product compatibility"
      notes: "Part of Technical module (Epic 02)"

files_to_read:
  prd: "docs/1-BASELINE/product/modules/settings.md"
  prd_sections:
    - "FR-SET-060"  # Production line CRUD
    - "FR-SET-061"  # Machine assignment to lines
    - "FR-SET-062"  # Line sequence/order definition
    - "FR-SET-063"  # Line capacity calculation (bottleneck)
    - "FR-SET-064"  # Line status tracking
    - "FR-SET-065"  # Line-product compatibility
  architecture: "docs/1-BASELINE/architecture/modules/settings.md"
  story: "docs/2-MANAGEMENT/epics/current/01-settings/01.11.production-lines-crud.md"
  adrs:
    - "docs/1-BASELINE/architecture/decisions/ADR-013-rls-org-isolation-pattern.md"
  patterns:
    - "apps/frontend/lib/validation/*.ts"  # Existing Zod schema patterns
    - "apps/frontend/components/ui/data-table.tsx"  # ShadCN DataTable
    - "apps/frontend/components/ui/dialog.tsx"  # ShadCN Dialog for modal
    - "apps/frontend/lib/services/*.ts"  # Existing service patterns

files_to_create:
  database:
    - path: "supabase/migrations/YYYYMMDDHHMMSS_create_production_lines.sql"
      type: "migration"
      description: "Create production_lines, production_line_machines, production_line_products tables"
  pages:
    - path: "apps/frontend/app/(authenticated)/settings/production-lines/page.tsx"
      description: "Production Line list page with DataTable (SET-018)"
    - path: "apps/frontend/app/(authenticated)/settings/production-lines/[id]/page.tsx"
      description: "Production Line detail page with tabs (machines, products)"
  components:
    - path: "apps/frontend/components/settings/production-lines/ProductionLineDataTable.tsx"
      description: "DataTable with sorting, filtering, pagination, machine sequence preview"
    - path: "apps/frontend/components/settings/production-lines/ProductionLineModal.tsx"
      description: "Create/Edit modal with machine assignment and product compatibility (SET-019)"
    - path: "apps/frontend/components/settings/production-lines/ProductionLineRow.tsx"
      description: "Single line row component with machine flow preview"
    - path: "apps/frontend/components/settings/production-lines/ProductionLineStatusBadge.tsx"
      description: "Status indicator (Active/Maintenance/Inactive/Setup)"
    - path: "apps/frontend/components/settings/production-lines/MachineSequenceEditor.tsx"
      description: "Drag-drop machine list with sequence ordering using dnd-kit"
    - path: "apps/frontend/components/settings/production-lines/MachineSequenceItem.tsx"
      description: "Draggable machine row with handle, status badge, capacity"
    - path: "apps/frontend/components/settings/production-lines/ProductCompatibilityEditor.tsx"
      description: "Checkbox list with search, Select All/Clear All"
    - path: "apps/frontend/components/settings/production-lines/ProductCheckboxRow.tsx"
      description: "Product row with checkbox, code, name, category"
    - path: "apps/frontend/components/settings/production-lines/CapacityCalculatorDisplay.tsx"
      description: "Shows calculated capacity with bottleneck tooltip"
    - path: "apps/frontend/components/settings/production-lines/DeleteLineConfirmDialog.tsx"
      description: "Confirmation dialog with WO check"
  validation:
    - path: "apps/frontend/lib/validation/production-line-schema.ts"
      description: "Zod schemas for production line create/update with machine orders and product IDs"
  api:
    - path: "apps/frontend/app/api/v1/settings/production-lines/route.ts"
      methods: ["GET", "POST"]
      description: "List lines (with pagination/search/filter), Create line"
    - path: "apps/frontend/app/api/v1/settings/production-lines/[id]/route.ts"
      methods: ["GET", "PUT", "DELETE"]
      description: "Get line detail, Update line, Delete line (if no WOs)"
    - path: "apps/frontend/app/api/v1/settings/production-lines/[id]/machines/route.ts"
      methods: ["GET", "PUT"]
      description: "Get machines with sequence, Replace all machine assignments"
    - path: "apps/frontend/app/api/v1/settings/production-lines/[id]/machines/reorder/route.ts"
      methods: ["PATCH"]
      description: "Reorder machines by sequence"
    - path: "apps/frontend/app/api/v1/settings/production-lines/[id]/products/route.ts"
      methods: ["GET", "PUT"]
      description: "Get compatible products, Replace product compatibility"
    - path: "apps/frontend/app/api/v1/settings/production-lines/validate-code/route.ts"
      methods: ["GET"]
      description: "Check code uniqueness"
  services:
    - path: "apps/frontend/lib/services/production-line-service.ts"
      description: "Production line CRUD, machine assignment, product compatibility, capacity calculation"

database:
  tables:
    - name: "production_lines"
      columns:
        - "id UUID PRIMARY KEY DEFAULT gen_random_uuid()"
        - "org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE"
        - "code VARCHAR(50) NOT NULL"
        - "name VARCHAR(100) NOT NULL"
        - "description TEXT"
        - "warehouse_id UUID NOT NULL REFERENCES warehouses(id) ON DELETE RESTRICT"
        - "default_output_location_id UUID REFERENCES locations(id) ON DELETE SET NULL"
        - "status VARCHAR(20) NOT NULL DEFAULT 'active'"
        - "created_by UUID REFERENCES users(id)"
        - "updated_by UUID REFERENCES users(id)"
        - "created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL"
        - "updated_at TIMESTAMPTZ DEFAULT NOW() NOT NULL"
      constraints:
        - "UNIQUE(org_id, code)"
        - "CHECK (code ~ '^[A-Z0-9-]+$')"
        - "CHECK (status IN ('active', 'maintenance', 'inactive', 'setup'))"
      rls: true
      rls_policies:
        - name: "production_lines_org_isolation"
          operation: "SELECT"
          using: "org_id = (SELECT org_id FROM users WHERE id = auth.uid())"
        - name: "production_lines_admin_write"
          operation: "ALL"
          using: |
            org_id = (SELECT org_id FROM users WHERE id = auth.uid())
            AND (SELECT r.code FROM roles r JOIN users u ON u.role_id = r.id WHERE u.id = auth.uid())
            IN ('SUPER_ADMIN', 'ADMIN', 'PROD_MANAGER')
      indexes:
        - "org_id"
        - "warehouse_id"
        - "status"
        - "code"

    - name: "production_line_machines"
      columns:
        - "id UUID PRIMARY KEY DEFAULT gen_random_uuid()"
        - "org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE"
        - "line_id UUID NOT NULL REFERENCES production_lines(id) ON DELETE CASCADE"
        - "machine_id UUID NOT NULL REFERENCES machines(id) ON DELETE CASCADE"
        - "sequence_order INTEGER NOT NULL"
        - "created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL"
      constraints:
        - "UNIQUE(line_id, machine_id)"
        - "UNIQUE(line_id, sequence_order)"
        - "CHECK (sequence_order > 0)"
      rls: true
      rls_policies:
        - name: "plm_org_isolation"
          operation: "SELECT"
          using: "org_id = (SELECT org_id FROM users WHERE id = auth.uid())"
        - name: "plm_admin_write"
          operation: "ALL"
          using: |
            org_id = (SELECT org_id FROM users WHERE id = auth.uid())
            AND (SELECT r.code FROM roles r JOIN users u ON u.role_id = r.id WHERE u.id = auth.uid())
            IN ('SUPER_ADMIN', 'ADMIN', 'PROD_MANAGER')
      indexes:
        - "line_id"
        - "machine_id"
        - "(line_id, sequence_order)"

    - name: "production_line_products"
      columns:
        - "id UUID PRIMARY KEY DEFAULT gen_random_uuid()"
        - "org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE"
        - "line_id UUID NOT NULL REFERENCES production_lines(id) ON DELETE CASCADE"
        - "product_id UUID NOT NULL REFERENCES products(id) ON DELETE CASCADE"
        - "created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL"
      constraints:
        - "UNIQUE(line_id, product_id)"
      rls: true
      rls_policies:
        - name: "plp_org_isolation"
          operation: "SELECT"
          using: "org_id = (SELECT org_id FROM users WHERE id = auth.uid())"
        - name: "plp_admin_write"
          operation: "ALL"
          using: |
            org_id = (SELECT org_id FROM users WHERE id = auth.uid())
            AND (SELECT r.code FROM roles r JOIN users u ON u.role_id = r.id WHERE u.id = auth.uid())
            IN ('SUPER_ADMIN', 'ADMIN', 'PROD_MANAGER')
      indexes:
        - "line_id"
        - "product_id"

api_endpoints:
  - method: "GET"
    path: "/api/v1/settings/production-lines"
    description: "List production lines with pagination, search, and filtering"
    auth: true
    roles: ["SUPER_ADMIN", "ADMIN", "PROD_MANAGER", "QUAL_MANAGER", "WH_MANAGER", "PLANNER", "VIEWER"]
    query_params:
      - "warehouse_id: UUID (filter by warehouse)"
      - "status: 'active' | 'maintenance' | 'inactive' | 'setup'"
      - "search: string (searches code and name)"
      - "page: number (default 1)"
      - "limit: number (default 25, max 100)"
    response:
      lines: "ProductionLine[]"
      total: "number"
      page: "number"
      limit: "number"
    performance: "< 300ms for 50 lines"

  - method: "GET"
    path: "/api/v1/settings/production-lines/:id"
    description: "Get production line detail with machines and compatible products"
    auth: true
    roles: ["SUPER_ADMIN", "ADMIN", "PROD_MANAGER", "QUAL_MANAGER", "WH_MANAGER", "PLANNER", "VIEWER"]
    response:
      id: "UUID"
      code: "string"
      name: "string"
      warehouse: "{ id, code, name }"
      status: "string"
      calculated_capacity: "number | null"
      bottleneck_machine: "{ id, code, capacity } | null"
      machines: "Array<{ id, code, name, status, capacity_per_hour, sequence_order }>"
      compatible_products: "Array<{ id, code, name, category }>"

  - method: "POST"
    path: "/api/v1/settings/production-lines"
    description: "Create new production line"
    auth: true
    roles: ["SUPER_ADMIN", "ADMIN", "PROD_MANAGER", "PLANNER"]
    request_body:
      code: "string (required, 2-50 chars, uppercase, unique per org)"
      name: "string (required, 1-100 chars)"
      description: "string (optional, max 500 chars)"
      warehouse_id: "UUID (required)"
      default_output_location_id: "UUID (optional)"
      status: "string (optional, default 'active')"
      machine_ids: "UUID[] (optional, initial machine assignments)"
      product_ids: "UUID[] (optional, compatible products)"
    response:
      id: "UUID"
      code: "string"
      status: "string"
    errors:
      409: "Line code already exists"
      400: "Invalid warehouse_id or machine_id"

  - method: "PUT"
    path: "/api/v1/settings/production-lines/:id"
    description: "Update existing production line"
    auth: true
    roles: ["SUPER_ADMIN", "ADMIN", "PROD_MANAGER", "PLANNER"]
    request_body:
      code: "string (optional, read-only if WOs exist)"
      name: "string (optional)"
      description: "string (optional)"
      warehouse_id: "UUID (optional)"
      default_output_location_id: "UUID | null (optional)"
      status: "string (optional)"
      machine_ids: "UUID[] (optional, replaces all assignments)"
      product_ids: "UUID[] (optional, replaces all compatibility)"
    errors:
      404: "Line not found"
      409: "Code already exists"
      400: "Code cannot be changed while work orders exist"

  - method: "DELETE"
    path: "/api/v1/settings/production-lines/:id"
    description: "Delete production line (if no work orders)"
    auth: true
    roles: ["SUPER_ADMIN", "ADMIN"]
    errors:
      404: "Line not found"
      400: "Line has active work orders"
    side_effects:
      - "Deletes production_line_machines records"
      - "Deletes production_line_products records"
      - "Machines remain in system"

  - method: "PATCH"
    path: "/api/v1/settings/production-lines/:id/machines/reorder"
    description: "Reorder machines by sequence"
    auth: true
    roles: ["SUPER_ADMIN", "ADMIN", "PROD_MANAGER"]
    request_body:
      machine_orders: "Array<{ machine_id: UUID, sequence_order: number }>"
    response:
      success: true
    errors:
      400: "Invalid sequence (gaps or duplicates)"

  - method: "GET"
    path: "/api/v1/settings/production-lines/validate-code"
    description: "Check code uniqueness"
    auth: true
    roles: ["SUPER_ADMIN", "ADMIN", "PROD_MANAGER", "PLANNER"]
    query_params:
      - "code: string (required)"
      - "exclude_id: UUID (optional, for edit validation)"
    response:
      valid: "boolean"
      error: "string | null"

ux:
  wireframes:
    - id: "SET-018"
      path: "docs/3-ARCHITECTURE/ux/wireframes/SET-018-production-line-list.md"
      description: "Production Line List with machine flow preview"
      components:
        - "DataTable with Code, Name, Warehouse, Machine Count, Capacity, Status columns"
        - "Machine flow preview row (Mixer -> Oven -> Cooler)"
        - "Search bar (code/name)"
        - "Warehouse filter dropdown"
        - "Status filter dropdown (Active, Maintenance, Inactive, Setup, All)"
        - "Add Production Line button (primary CTA)"
        - "Actions menu: Edit, Manage Machines, View Work Orders, Disable/Enable"
    - id: "SET-019"
      path: "docs/3-ARCHITECTURE/ux/wireframes/SET-019-production-line-create-edit-modal.md"
      description: "Production Line Create/Edit Modal with machine sequence and product compatibility"
      components:
        - "Code input (auto-uppercase, unique)"
        - "Name input (required)"
        - "Warehouse dropdown (required)"
        - "Capacity input (optional, units/hour)"
        - "Machine assignment section with drag-drop reorder"
        - "Product compatibility section with checkboxes and search"
        - "Select All / Clear All buttons for products"
        - "Active checkbox"
  patterns:
    table: "ShadCN DataTable with server-side pagination, sorting, filtering"
    modal: "ShadCN Dialog with Form inside"
    form: "react-hook-form with Zod resolver"
    badge: "ShadCN Badge for status indicators"
    drag_drop: "dnd-kit for machine sequence reordering"
    checkbox_list: "Custom checkbox list with search filter"
  states:
    loading: "Skeleton rows (3) with shimmer animation"
    empty: "'No production lines found' icon with 'Add Your First Production Line' CTA"
    error: "'Failed to load production lines' warning with Retry button"
    success: "Table populated with line data and machine flow preview"
  status_badges:
    active: "bg-green-100 text-green-800"
    maintenance: "bg-yellow-100 text-yellow-800"
    inactive: "bg-gray-100 text-gray-800"
    setup: "bg-blue-100 text-blue-800"

capacity_calculation:
  formula: "Line Capacity = MIN(machine.capacity_per_hour) for all machines in line"
  algorithm: |
    function calculateBottleneckCapacity(machines: LineMachine[]): CapacityResult {
      const machinesWithCapacity = machines.filter(m =>
        m.capacity_per_hour !== null && m.capacity_per_hour > 0
      );

      if (machinesWithCapacity.length === 0) {
        return {
          capacity: null,
          bottleneck_machine_id: null,
          bottleneck_machine_code: null,
          machines_without_capacity: machines.map(m => m.code)
        };
      }

      const bottleneck = machinesWithCapacity.reduce((min, m) =>
        m.capacity_per_hour! < min.capacity_per_hour! ? m : min
      );

      return {
        capacity: bottleneck.capacity_per_hour,
        bottleneck_machine_id: bottleneck.id,
        bottleneck_machine_code: bottleneck.code,
        machines_without_capacity: machines
          .filter(m => !m.capacity_per_hour)
          .map(m => m.code)
      };
    }
  edge_cases:
    - "No machines assigned: capacity = null, display 'Not calculated' or '--'"
    - "One machine has null capacity: exclude from calculation, use min of others"
    - "All machines have null capacity: capacity = null, display 'Not calculated'"
    - "Machine added/removed: recalculate immediately"
  tooltip: "Shows 'Bottleneck: {MACHINE_CODE} ({capacity}/hr)'"

validation_rules:
  code:
    type: "string"
    required: true
    min: 2
    max: 50
    pattern: "^[A-Z0-9-]+$"
    transform: "toUpperCase()"
    unique_per_org: true
    immutable_if_wos: true
    error_empty: "Code is required"
    error_format: "Code must be uppercase letters, numbers, and hyphens only"
    error_duplicate: "Line code must be unique"
  name:
    type: "string"
    required: true
    min: 1
    max: 100
    error_empty: "Name is required"
  description:
    type: "string"
    required: false
    max: 500
  warehouse_id:
    type: "uuid"
    required: true
    references: "warehouses.id"
    error_empty: "Warehouse is required"
    error_invalid: "Invalid warehouse"
  status:
    type: "enum"
    values: ["active", "maintenance", "inactive", "setup"]
    default: "active"
  machine_ids:
    type: "array"
    items: "uuid"
    max_length: 20
    error_max: "Maximum 20 machines per line"
  product_ids:
    type: "array"
    items: "uuid"
    notes: "Empty array means line can run ANY product (no restrictions)"

patterns:
  rls: "ADR-013 - RLS Org Isolation Pattern"
  api: "REST with org_id filter from auth context"
  service: "Class-based ProductionLineService with static methods"
  validation: "Zod schemas in lib/validation/production-line-schema.ts"
  drag_drop: "dnd-kit library for accessible drag-and-drop reordering"
  sequence_renumber: |
    // On drag end, renumber all sequences starting from 1
    function renumberSequences(items: { id: string }[]): MachineOrder[] {
      return items.map((item, index) => ({
        machine_id: item.id,
        sequence_order: index + 1
      }));
    }

acceptance_checklist:
  list_page:
    - "GIVEN admin navigates to /settings/production-lines, WHEN page loads, THEN line list displays within 300ms with columns: Code, Name, Warehouse, Machine Count, Capacity, Status"
    - "GIVEN line list has 50 items, WHEN admin filters by warehouse 'MAIN', THEN only lines in MAIN warehouse display within 200ms"
    - "GIVEN line list displayed, WHEN admin searches 'PACK', THEN lines with code or name containing 'PACK' display (case-insensitive)"
    - "GIVEN line list displayed, WHEN admin filters by status 'Maintenance', THEN only lines with status 'Maintenance' appear"
    - "GIVEN line list with pagination, WHEN page 2 clicked, THEN next 25 lines display"

  create_line:
    - "GIVEN admin clicks 'Add Line', WHEN modal opens, THEN form displays: Code, Name, Warehouse dropdown, Capacity, Machine assignment section, Product compatibility section, Status toggle"
    - "GIVEN admin enters line code 'LINE-A', name 'Assembly Line A', selects warehouse 'MAIN', WHEN 'Create' clicked, THEN line created with status 'Active' and appears in list within 1 second"
    - "GIVEN line code 'LINE-A' exists, WHEN admin enters duplicate code 'LINE-A', THEN error 'Line code must be unique' displays inline"

  edit_line:
    - "GIVEN admin clicks edit on existing line 'LINE-A', WHEN modal opens, THEN current line data pre-populates: code, name, warehouse, capacity, assigned machines, compatible products, status"
    - "GIVEN admin updates line name from 'Assembly Line A' to 'Assembly Line Alpha', WHEN save completes, THEN updated name displays immediately in list"
    - "GIVEN line has active work orders, WHEN code edit attempted, THEN code field is read-only with tooltip 'Code cannot be changed while work orders exist'"

  delete_line:
    - "GIVEN line has no work orders, WHEN delete confirmed, THEN line removed within 500ms"
    - "GIVEN line has active work orders, WHEN delete attempted, THEN error 'Line has active work orders' displays and deletion blocked"
    - "GIVEN line deleted, WHEN machines checked, THEN machines remain in system (only machine_line_assignments removed)"

  machine_assignment:
    - "GIVEN production line modal open, WHEN admin clicks 'Add Machine' dropdown, THEN available machines display with code, name, status"
    - "GIVEN machine 'MIX-001' selected, WHEN 'Add' clicked, THEN machine appears in line with sequence position 1"
    - "GIVEN line already has machine 'MIX-001', WHEN same machine selected in dropdown, THEN machine is disabled in dropdown with tooltip 'Already assigned'"
    - "GIVEN machine with 'Offline' status selected, WHEN added to line, THEN warning 'Machine MIX-001 is offline' displays but assignment allowed"

  machine_sequence:
    - "GIVEN line has 3 machines: MIX-001 (seq 1), FILL-001 (seq 2), PKG-001 (seq 3), WHEN admin drags MIX-001 from position 1 to position 3, THEN sequence updates to: FILL-001 (1), PKG-001 (2), MIX-001 (3)"
    - "GIVEN drag operation in progress, WHEN machine dropped at new position, THEN all sequence numbers renumber automatically (1, 2, 3... no gaps)"
    - "GIVEN keyboard navigation active, WHEN user focuses machine row and presses Up/Down arrow + Space, THEN machine moves up/down in sequence (accessibility alternative to drag)"

  capacity_calculation:
    - "GIVEN line has machines: MIX-001 (1000/hr), FILL-001 (500/hr), PKG-001 (800/hr), WHEN capacity calculated, THEN line capacity displays as 500 units/hour (bottleneck)"
    - "GIVEN line has no machines assigned, WHEN capacity displayed, THEN capacity shows 'Not calculated' or '--'"
    - "GIVEN one machine has no capacity set (NULL), WHEN capacity calculated, THEN that machine is excluded, bottleneck from others"
    - "GIVEN line capacity displayed, WHEN hovered, THEN tooltip shows 'Bottleneck: FILL-001 (500/hr)'"

  status_tracking:
    - "GIVEN line created, WHEN no status specified, THEN default status is 'Active'"
    - "GIVEN line status is 'Active', WHEN admin changes to 'Maintenance', THEN status updates immediately with visual indicator change"
    - "GIVEN line status is 'Inactive', WHEN work order creation attempted on this line, THEN line is hidden from production line dropdown"

  product_compatibility:
    - "GIVEN production line modal open, WHEN 'Compatible Products' section viewed, THEN product list displays with checkboxes, code, name, category"
    - "GIVEN no products selected, WHEN line saved, THEN line can run ANY product (no restrictions)"
    - "GIVEN 3 products selected: WWB-001, RYE-001, MUF-001, WHEN line saved, THEN line can ONLY run those 3 products (restricted)"
    - "GIVEN product list displayed, WHEN admin enters 'wheat' in search, THEN list filters to products with 'wheat' in code or name within 300ms"
    - "GIVEN search active with 5 products visible, WHEN 'Select All' clicked, THEN only the 5 visible products are selected (not all products)"
    - "GIVEN restricted line (3 products), WHEN WO creation started, THEN product dropdown filters to only compatible products"

definition_of_done:
  - "Production line list page loads within 300ms for 50 lines"
  - "Create line with code uniqueness validation works"
  - "Edit line preserves machine sequence and products"
  - "Delete line blocked if active WOs exist"
  - "Machine assignment with drag-drop reorder functional"
  - "Sequence numbers update correctly on reorder"
  - "Capacity calculated as bottleneck (min of machines)"
  - "Capacity tooltip shows bottleneck machine"
  - "Status toggle updates immediately"
  - "Inactive lines hidden from WO dropdowns"
  - "Product compatibility editor with search works"
  - "'Select All' respects search filter"
  - "Empty compatibility = any product allowed"
  - "WO creation validates product-line compatibility"
  - "All API endpoints have integration tests"
  - "Unit tests cover capacity calculation logic (>80%)"
  - "E2E tests for create, reorder, delete flows"
  - "RLS policies verified in tests"
  - "SET-018 wireframe implemented"
  - "SET-019 wireframe implemented"
  - "Keyboard accessibility for drag-drop (arrow keys)"
  - "Mobile responsive (modal scrolls)"

tests:
  unit:
    - "calculateBottleneckCapacity returns minimum capacity"
    - "calculateBottleneckCapacity returns null for no machines"
    - "calculateBottleneckCapacity excludes null capacities"
    - "calculateBottleneckCapacity identifies bottleneck machine"
    - "Zod schema validates code format (uppercase, alphanumeric, hyphens)"
    - "Zod schema rejects code > 50 characters"
    - "Zod schema transforms code to uppercase"
    - "Zod schema validates status enum values"
    - "renumberSequences eliminates gaps"
    - "Status badge renders correct colors"
  integration:
    - "GET /api/v1/settings/production-lines returns paginated results"
    - "GET /api/v1/settings/production-lines?warehouse_id={id} filters by warehouse"
    - "GET /api/v1/settings/production-lines?status=active filters by status"
    - "POST /api/v1/settings/production-lines creates line with machine assignments"
    - "POST /api/v1/settings/production-lines returns 409 for duplicate code"
    - "PUT /api/v1/settings/production-lines/:id updates line"
    - "PUT /api/v1/settings/production-lines/:id replaces machine assignments"
    - "PATCH /api/v1/settings/production-lines/:id/machines/reorder updates sequences"
    - "DELETE /api/v1/settings/production-lines/:id returns 400 if WOs exist"
    - "RLS prevents cross-org access"
    - "Non-admin cannot create/edit"
  e2e:
    - "Create line with 2 machines, verify machine count in list"
    - "Drag machine to reorder, verify sequence visually updates"
    - "Search products, select 3, save, verify compatibility saved"
    - "Change status to Maintenance, verify badge color changes"
    - "Delete line (no WOs), verify removed from list"
    - "Filter by warehouse, verify correct lines shown"

risks:
  - risk: "Drag-drop complexity"
    probability: "Medium"
    impact: "Medium"
    mitigation: "Use proven dnd-kit library with keyboard fallback"
  - risk: "Sequence renumbering bugs"
    probability: "Medium"
    impact: "High"
    mitigation: "Comprehensive unit tests for edge cases"
  - risk: "Capacity calculation edge cases"
    probability: "Low"
    impact: "Medium"
    mitigation: "Handle null values explicitly, test all combinations"
  - risk: "Product list performance"
    probability: "Low"
    impact: "Low"
    mitigation: "Pagination, virtual scroll if needed (max ~500 products realistic)"
  - risk: "RLS policy gaps"
    probability: "Low"
    impact: "High"
    mitigation: "Integration tests per policy, security review"

output_artifacts:
  - "ProductionLineDataTable.tsx component with machine flow preview"
  - "ProductionLineModal.tsx component for create/edit with machine assignment and product compatibility"
  - "MachineSequenceEditor.tsx component with drag-drop using dnd-kit"
  - "ProductCompatibilityEditor.tsx component with search and Select All/Clear All"
  - "CapacityCalculatorDisplay.tsx component with bottleneck tooltip"
  - "ProductionLineStatusBadge.tsx component"
  - "DeleteLineConfirmDialog.tsx component with WO check"
  - "production-line-schema.ts Zod validation schemas"
  - "production-line-service.ts with CRUD, machine assignment, product compatibility, capacity calculation"
  - "API routes: GET/POST /api/v1/settings/production-lines"
  - "API routes: GET/PUT/DELETE /api/v1/settings/production-lines/:id"
  - "API routes: PATCH /api/v1/settings/production-lines/:id/machines/reorder"
  - "API routes: GET/PUT /api/v1/settings/production-lines/:id/products"
  - "API route: GET /api/v1/settings/production-lines/validate-code"
  - "Database migration for production_lines, production_line_machines, production_line_products"
  - "Unit tests for capacity calculation"
  - "Integration tests for API endpoints"

implementation_notes:
  frontend:
    - "Use ShadCN DataTable for production line list with server-side pagination"
    - "Use ShadCN Dialog for create/edit modal"
    - "Use dnd-kit for machine sequence drag-drop reordering"
    - "Implement keyboard alternative for drag (Up/Down + Space)"
    - "Use react-hook-form with Zod resolver for form validation"
    - "Debounce search inputs by 300ms"
    - "Show skeleton loaders while data loading"
    - "Display machine flow preview as 'Mixer -> Oven -> Cooler' in list"
    - "Capacity tooltip shows bottleneck machine info"
    - "Product search filters local list, Select All only selects visible"
  backend:
    - "Validate code uniqueness within org before insert/update"
    - "Check for active WOs before allowing code change or delete"
    - "Implement capacity calculation as server-side computed field"
    - "Handle machine reorder in transaction (delete all, insert new order)"
    - "Handle product compatibility as replace-all (delete existing, insert new)"
    - "Use ADR-013 RLS pattern for org isolation"
    - "Enforce permission middleware on all endpoints"
  database:
    - "Create production_lines table with warehouse FK"
    - "Create production_line_machines junction table with sequence_order"
    - "Create production_line_products junction table"
    - "Add RLS policies for all three tables"
    - "Add indexes for common query patterns"
    - "Unique constraint on (line_id, machine_id) and (line_id, sequence_order)"
