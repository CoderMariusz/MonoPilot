# Story Context: 01.4 Organization Profile Step (Wizard Step 1)
# Generated: 2025-12-16
# Purpose: AI agent context for implementing wizard step 1

story:
  id: "01.4"
  name: "Organization Profile Step (Wizard Step 1)"
  epic: "01-settings"
  phase: "1A"
  complexity: "M"
  estimate_days: 2
  type: "frontend + backend"
  state: "ready"

dependencies:
  required:
    - story: "01.3"
      name: "Onboarding Wizard Launcher"
      provides:
        - "WizardModal component"
        - "wizard shell and navigation"
        - "progress tracking framework"
    - story: "01.1"
      name: "Org Context + Base RLS"
      provides:
        - "organizations table"
        - "org_id context"
        - "RLS policies"

files_to_read:
  prd: "docs/1-BASELINE/product/modules/settings.md"
  prd_sections:
    - "FR-SET-001"  # Organization profile (name, logo, contact)
    - "FR-SET-003"  # Timezone and locale settings
    - "FR-SET-004"  # Currency configuration
    - "FR-SET-181"  # Organization profile step (wizard)
  architecture: "docs/1-BASELINE/architecture/modules/settings.md"
  story: "docs/2-MANAGEMENT/epics/current/01-settings/01.4.organization-profile-step.md"
  patterns:
    - "apps/frontend/lib/validation/*.ts"  # Existing Zod schema patterns
    - "apps/frontend/components/ui/form.tsx"  # ShadCN form component
    - "apps/frontend/components/ui/select.tsx"  # ShadCN select/dropdown

files_to_create:
  pages:
    - path: "apps/frontend/app/(authenticated)/settings/onboarding/step-1/page.tsx"
      description: "Wizard Step 1 page (if using route-based steps)"
  components:
    - path: "apps/frontend/components/settings/onboarding/OrganizationProfileStep.tsx"
      description: "Main wizard step 1 component with form"
    - path: "apps/frontend/components/settings/onboarding/TimezoneSelect.tsx"
      description: "Searchable timezone dropdown (300+ IANA timezones)"
  validation:
    - path: "apps/frontend/lib/validation/organization-profile-step.ts"
      description: "Zod schema for step 1 form data"
  api:
    - path: "apps/frontend/app/api/v1/settings/onboarding/step/1/route.ts"
      methods: ["POST"]
      description: "Save wizard step 1 data"
  services:
    - path: "apps/frontend/lib/services/onboarding-service.ts"
      description: "Onboarding business logic (may extend existing)"
  utilities:
    - path: "apps/frontend/lib/utils/browser-detection.ts"
      description: "Browser timezone and language detection utilities"

database:
  tables:
    - name: "organizations"
      columns:
        - "name VARCHAR(100) NOT NULL"
        - "timezone VARCHAR(50) NOT NULL DEFAULT 'UTC'"
        - "language VARCHAR(5) NOT NULL DEFAULT 'en'"
        - "currency VARCHAR(3) NOT NULL DEFAULT 'EUR'"
        - "onboarding_step INTEGER DEFAULT 1"
        - "onboarding_started_at TIMESTAMPTZ"
      rls: true
      notes: "Verify columns exist; add if missing via migration"

api_endpoints:
  - method: "POST"
    path: "/api/v1/settings/onboarding/step/1"
    description: "Save organization profile (wizard step 1)"
    auth: true
    roles: ["super_admin", "admin"]
    request_body:
      name: "string (required, 2-100 chars)"
      timezone: "string (required, valid IANA timezone)"
      language: "string (required, one of: pl, en, de, fr)"
      currency: "string (required, one of: PLN, EUR, USD, GBP)"
    response:
      success: true
      next_step: 2
      organization: "{ id, name, timezone, language, currency }"
    on_success:
      - "Update organizations table with provided values"
      - "Set onboarding_step = 2"
      - "Set onboarding_started_at = NOW() if null"

  - method: "GET"
    path: "/api/v1/settings/organization"
    description: "Get current organization profile (for pre-fill)"
    auth: true
    roles: ["*"]
    response:
      id: "uuid"
      name: "string"
      timezone: "string"
      language: "string"
      currency: "string"
      onboarding_step: "number"

ux:
  wireframes:
    - id: "SET-002"
      path: "docs/3-ARCHITECTURE/ux/wireframes/SET-002-onboarding-organization.md"
      description: "Onboarding Wizard - Organization Profile Step"
      components:
        - "Progress tracker (1/6, 16%)"
        - "Basic Information card (org name)"
        - "Regional Settings card (timezone, language, currency)"
        - "Skip Step button"
        - "Next: Warehouse button"
    - id: "SET-007"
      path: "docs/3-ARCHITECTURE/ux/wireframes/SET-007-organization-profile.md"
      description: "Full Organization Profile page (reference for field patterns)"
      components:
        - "Organization name input"
        - "Timezone searchable dropdown"
        - "Language dropdown"
        - "Currency dropdown"
  patterns:
    form: "ShadCN Form with react-hook-form + Zod resolver"
    dropdown: "ShadCN Select for simple dropdowns"
    searchable_dropdown: "ShadCN Combobox for timezone (300+ options)"
    validation: "Inline validation with error messages below fields"
    error_summary: "Error banner at top listing all errors"
  states:
    - "loading: Skeleton loaders for form fields"
    - "success: Form pre-filled with org name from registration"
    - "error: Red borders on invalid fields, inline error text"
    - "submitting: Disabled Next button with spinner"

validation_rules:
  name:
    type: "string"
    required: true
    min: 2
    max: 100
    error_empty: "Organization name is required"
    error_min: "Organization name must be at least 2 characters"
    error_max: "Organization name must be at most 100 characters"
  timezone:
    type: "string"
    required: true
    validation: "Must be valid IANA timezone (use Intl.supportedValuesOf('timeZone'))"
    error: "Invalid timezone"
    default: "Auto-detect from browser: Intl.DateTimeFormat().resolvedOptions().timeZone"
  language:
    type: "enum"
    required: true
    values: ["pl", "en", "de", "fr"]
    display_values:
      pl: "Polski"
      en: "English"
      de: "Deutsch"
      fr: "Francais"
    default: "Auto-detect from browser if supported, otherwise 'en'"
  currency:
    type: "enum"
    required: true
    values: ["PLN", "EUR", "USD", "GBP"]
    display_values:
      PLN: "PLN - Polish Zloty"
      EUR: "EUR - Euro"
      USD: "USD - US Dollar"
      GBP: "GBP - British Pound"
    default: "EUR"

patterns:
  rls: "ADR-013 - RLS Org Isolation Pattern"
  api: "REST with org_id filter from auth context"
  service: "Class-based with static methods"
  validation: "Zod schemas in lib/validation/"
  browser_detection: |
    // Detect browser timezone
    const browserTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;

    // Detect browser language (map to supported)
    const browserLang = navigator.language.slice(0, 2).toLowerCase();
    const supportedLang = ['pl', 'en', 'de', 'fr'].includes(browserLang)
      ? browserLang
      : 'en';

acceptance_checklist:
  - "GIVEN wizard step 1 loads, WHEN organization name was set during registration, THEN the name field is pre-filled with that value"
  - "GIVEN new organization, WHEN wizard step 1 loads, THEN timezone auto-detected from browser (editable)"
  - "GIVEN browser language is Polish, WHEN wizard step 1 loads, THEN language defaults to PL (editable)"
  - "GIVEN wizard step 1 loads, WHEN detecting browser language, THEN language dropdown defaults to browser language if supported (PL/EN/DE/FR), otherwise EN"
  - "GIVEN user enters valid data (name: 'Bakery Fresh Ltd', timezone: 'Europe/Warsaw', language: 'PL', currency: 'PLN'), WHEN 'Next' clicked, THEN organization is updated in database and wizard advances to step 2"
  - "GIVEN organization name field is empty, WHEN 'Next' clicked, THEN error message 'Organization name is required' displays and wizard does not advance"
  - "GIVEN organization name is 1 character, WHEN 'Next' clicked, THEN error message 'Organization name must be at least 2 characters' displays"
  - "GIVEN organization name is 101 characters, WHEN 'Next' clicked, THEN error message 'Organization name must be at most 100 characters' displays"
  - "GIVEN timezone dropdown is opened, WHEN user types 'war', THEN 'Europe/Warsaw' appears in filtered results"
  - "GIVEN language dropdown, WHEN opened, THEN options include: Polski (PL), English (EN), Deutsch (DE), Francais (FR)"
  - "GIVEN currency dropdown, WHEN opened, THEN options include: PLN, EUR, USD, GBP (4 currencies for MVP)"
  - "GIVEN wizard is on step 1, WHEN 'Back' button is checked, THEN it is disabled or hidden (first step)"
  - "GIVEN step 1 is completed, WHEN step 2 loads, THEN progress indicator shows 'Step 2 of 6' with step 1 checkmarked"

definition_of_done:
  - "Organization name pre-fills from registration data"
  - "Timezone defaults to browser-detected timezone"
  - "Language defaults to browser language if supported"
  - "All validation rules enforced with clear error messages"
  - "Successful save updates organization and advances to step 2"
  - "Back button is disabled on step 1"
  - "Unit and integration tests pass for all acceptance criteria"

tests:
  unit:
    - "Form validation rejects empty name"
    - "Form validation rejects name < 2 chars"
    - "Form validation rejects name > 100 chars"
    - "Browser timezone detection works"
    - "Language dropdown shows 4 options"
    - "Currency dropdown shows 4 options"
    - "Back button is disabled"
  integration:
    - "Pre-population of organization name from registration"
    - "Successful save advances to step 2"
    - "Validation errors prevent advancement"
    - "Timezone search/filter works"

output_artifacts:
  - "OrganizationProfileStep.tsx component"
  - "Zod validation schema for step 1 data"
  - "API route: POST /api/v1/settings/onboarding/step/1"
  - "Timezone searchable dropdown component (or use existing)"
  - "Browser detection utilities for timezone/language defaults"
  - "Unit tests for validation and component behavior"
  - "Integration tests for API and form submission"

implementation_notes:
  frontend:
    - "Use ShadCN Form component with react-hook-form"
    - "Use ShadCN Combobox for timezone (searchable with 300+ options)"
    - "Use ShadCN Select for language and currency (simple 4-option dropdowns)"
    - "Implement browser detection on component mount, not on every render"
    - "Pre-fill org name from existing organization data via parent component prop"
  backend:
    - "Validate timezone against Intl.supportedValuesOf('timeZone') on server"
    - "Update onboarding_step atomically with other fields"
    - "Set onboarding_started_at only if null (first step completion)"
  database:
    - "Verify organizations table has required columns"
    - "Add migration if columns are missing"
