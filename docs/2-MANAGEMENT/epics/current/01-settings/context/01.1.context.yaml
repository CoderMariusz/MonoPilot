# Story 01.1 Context File
# Generated: 2025-12-16
# Purpose: Provides complete context for DEV agents implementing this story

story:
  id: "01.1"
  name: "Org Context + Base RLS"
  slug: "org-context-base-rls"
  epic: "01-settings"
  phase: "1A"
  complexity: "M"
  estimate_days: 2
  type: "backend"
  state: "ready"

# -----------------------------------------------------------------------------
# DEPENDENCIES
# -----------------------------------------------------------------------------
dependencies:
  required: []  # Root story - no dependencies
  blocked_by: []
  blocks:
    - story: "01.2"
      name: "Settings Shell Navigation"
    - story: "01.6"
      name: "Role Permissions"
    - story: "01.8"
      name: "Warehouses CRUD"
    - story: "01.12"
      name: "Allergens Management"
    - story: "01.13"
      name: "Tax Codes CRUD"

# -----------------------------------------------------------------------------
# FILES TO READ (Context for Implementation)
# -----------------------------------------------------------------------------
files_to_read:
  prd:
    path: "docs/1-BASELINE/product/modules/settings.md"
    sections:
      - "FR-SET-002"  # Multi-tenant isolation (lines 217-240)
  architecture:
    path: "docs/1-BASELINE/architecture/modules/settings.md"
    sections:
      - "Database Schema"
      - "API Design"
      - "Row Level Security (RLS) Policies"
  story:
    path: "docs/2-MANAGEMENT/epics/current/01-settings/01.1.org-context-base-rls.md"
  adrs:
    - path: "docs/1-BASELINE/architecture/decisions/ADR-011-module-toggle-storage.md"
      relevance: "Module tables schema (modules, organization_modules)"
    - path: "docs/1-BASELINE/architecture/decisions/ADR-012-role-permission-storage.md"
      relevance: "Roles table schema with JSONB permissions"
    - path: "docs/1-BASELINE/architecture/decisions/ADR-013-rls-org-isolation-pattern.md"
      relevance: "PRIMARY - RLS policy pattern using users table lookup"

# -----------------------------------------------------------------------------
# FILES TO CREATE
# -----------------------------------------------------------------------------
files_to_create:
  database:
    migrations:
      - path: "supabase/migrations/043_create_organizations_table.sql"
        type: "migration"
        description: "Core tenant table with onboarding state"
      - path: "supabase/migrations/044_create_roles_table.sql"
        type: "migration"
        description: "10 system roles with JSONB permissions (ADR-012)"
      - path: "supabase/migrations/045_create_users_table.sql"
        type: "migration"
        description: "Users table with role_id FK"
      - path: "supabase/migrations/046_create_modules_tables.sql"
        type: "migration"
        description: "modules + organization_modules tables (ADR-011)"
      - path: "supabase/migrations/047_rls_policies.sql"
        type: "migration"
        description: "RLS policies following ADR-013 pattern"
      - path: "supabase/migrations/048_seed_system_data.sql"
        type: "seed"
        description: "Seed 10 system roles and 11 modules"

  services:
    - path: "apps/frontend/lib/services/org-context-service.ts"
      description: "getOrgContext() helper for session resolution"
    - path: "apps/frontend/lib/services/permission-service.ts"
      description: "hasPermission() helper for role checks"

  types:
    - path: "apps/frontend/lib/types/organization.ts"
      description: "Organization, OrgContext interfaces"
    - path: "apps/frontend/lib/types/user.ts"
      description: "User, Role interfaces"
    - path: "apps/frontend/lib/types/module.ts"
      description: "Module, OrganizationModule interfaces"

  api:
    - path: "apps/frontend/app/api/v1/settings/context/route.ts"
      description: "GET /api/v1/settings/context endpoint"

  tests:
    - path: "apps/frontend/lib/services/__tests__/org-context-service.test.ts"
      description: "Unit tests for org context resolution"
    - path: "apps/frontend/lib/services/__tests__/permission-service.test.ts"
      description: "Unit tests for permission checks"
    - path: "supabase/tests/rls-isolation.test.sql"
      description: "Integration tests for RLS policies"

# -----------------------------------------------------------------------------
# DATABASE SCHEMA
# -----------------------------------------------------------------------------
database:
  tables:
    - name: "organizations"
      description: "Core tenant table"
      columns:
        - name: "id"
          type: "UUID"
          constraints: "PRIMARY KEY DEFAULT gen_random_uuid()"
        - name: "name"
          type: "TEXT"
          constraints: "NOT NULL"
        - name: "slug"
          type: "TEXT"
          constraints: "UNIQUE NOT NULL"
        - name: "timezone"
          type: "TEXT"
          constraints: "DEFAULT 'UTC'"
        - name: "locale"
          type: "TEXT"
          constraints: "DEFAULT 'en'"
        - name: "currency"
          type: "TEXT"
          constraints: "DEFAULT 'PLN'"
        - name: "logo_url"
          type: "TEXT"
          constraints: ""
        - name: "onboarding_step"
          type: "INTEGER"
          constraints: "DEFAULT 0"
        - name: "onboarding_started_at"
          type: "TIMESTAMPTZ"
          constraints: ""
        - name: "onboarding_completed_at"
          type: "TIMESTAMPTZ"
          constraints: ""
        - name: "onboarding_skipped"
          type: "BOOLEAN"
          constraints: "DEFAULT false"
        - name: "is_active"
          type: "BOOLEAN"
          constraints: "DEFAULT true"
        - name: "created_at"
          type: "TIMESTAMPTZ"
          constraints: "DEFAULT NOW()"
        - name: "updated_at"
          type: "TIMESTAMPTZ"
          constraints: "DEFAULT NOW()"
      rls: true
      rls_pattern: "id = (SELECT org_id FROM users WHERE id = auth.uid())"
      indexes:
        - "idx_organizations_slug ON organizations(slug)"

    - name: "roles"
      description: "System roles with JSONB permissions (ADR-012)"
      columns:
        - name: "id"
          type: "UUID"
          constraints: "PRIMARY KEY DEFAULT gen_random_uuid()"
        - name: "code"
          type: "VARCHAR(50)"
          constraints: "UNIQUE NOT NULL"
        - name: "name"
          type: "VARCHAR(100)"
          constraints: "NOT NULL"
        - name: "description"
          type: "TEXT"
          constraints: ""
        - name: "permissions"
          type: "JSONB"
          constraints: "NOT NULL"
        - name: "is_system"
          type: "BOOLEAN"
          constraints: "DEFAULT true"
        - name: "display_order"
          type: "INT"
          constraints: ""
        - name: "created_at"
          type: "TIMESTAMPTZ"
          constraints: "DEFAULT NOW()"
      rls: true
      rls_pattern: "is_system = true (public read for system roles)"
      indexes:
        - "idx_roles_code ON roles(code)"
        - "idx_roles_system ON roles(is_system)"

    - name: "users"
      description: "User accounts with org_id and role_id"
      columns:
        - name: "id"
          type: "UUID"
          constraints: "PRIMARY KEY REFERENCES auth.users(id)"
        - name: "org_id"
          type: "UUID"
          constraints: "NOT NULL REFERENCES organizations(id)"
        - name: "email"
          type: "TEXT"
          constraints: "NOT NULL"
        - name: "first_name"
          type: "TEXT"
          constraints: "NOT NULL"
        - name: "last_name"
          type: "TEXT"
          constraints: "NOT NULL"
        - name: "role_id"
          type: "UUID"
          constraints: "NOT NULL REFERENCES roles(id)"
        - name: "language"
          type: "TEXT"
          constraints: "DEFAULT 'en'"
        - name: "is_active"
          type: "BOOLEAN"
          constraints: "DEFAULT true"
        - name: "last_login_at"
          type: "TIMESTAMPTZ"
          constraints: ""
        - name: "created_at"
          type: "TIMESTAMPTZ"
          constraints: "DEFAULT NOW()"
        - name: "updated_at"
          type: "TIMESTAMPTZ"
          constraints: "DEFAULT NOW()"
      rls: true
      rls_pattern: "org_id = (SELECT org_id FROM users WHERE id = auth.uid())"
      indexes:
        - "idx_users_org_email ON users(org_id, email)"
        - "idx_users_org_active ON users(org_id, is_active)"
        - "idx_users_role ON users(role_id)"
      constraints:
        - "UNIQUE(org_id, email)"

    - name: "modules"
      description: "Module definitions - seeded, immutable (ADR-011)"
      columns:
        - name: "id"
          type: "UUID"
          constraints: "PRIMARY KEY DEFAULT gen_random_uuid()"
        - name: "code"
          type: "VARCHAR(50)"
          constraints: "UNIQUE NOT NULL"
        - name: "name"
          type: "VARCHAR(100)"
          constraints: "NOT NULL"
        - name: "dependencies"
          type: "TEXT[]"
          constraints: ""
        - name: "can_disable"
          type: "BOOLEAN"
          constraints: "DEFAULT true"
        - name: "display_order"
          type: "INT"
          constraints: ""
      rls: true
      rls_pattern: "true (public read for all authenticated)"
      indexes:
        - "idx_modules_code ON modules(code)"

    - name: "organization_modules"
      description: "Org-specific module state (ADR-011)"
      columns:
        - name: "id"
          type: "UUID"
          constraints: "PRIMARY KEY DEFAULT gen_random_uuid()"
        - name: "org_id"
          type: "UUID"
          constraints: "NOT NULL REFERENCES organizations(id)"
        - name: "module_id"
          type: "UUID"
          constraints: "NOT NULL REFERENCES modules(id)"
        - name: "enabled"
          type: "BOOLEAN"
          constraints: "DEFAULT false"
        - name: "enabled_at"
          type: "TIMESTAMPTZ"
          constraints: ""
        - name: "enabled_by"
          type: "UUID"
          constraints: "REFERENCES users(id)"
      rls: true
      rls_pattern: "org_id = (SELECT org_id FROM users WHERE id = auth.uid())"
      indexes:
        - "idx_organization_modules_org ON organization_modules(org_id)"
        - "idx_organization_modules_module ON organization_modules(module_id)"
        - "idx_organization_modules_enabled ON organization_modules(org_id, enabled)"
      constraints:
        - "UNIQUE(org_id, module_id)"

# -----------------------------------------------------------------------------
# RLS POLICIES (ADR-013)
# -----------------------------------------------------------------------------
rls_policies:
  pattern: "Users Table Lookup"
  pattern_sql: "(SELECT org_id FROM users WHERE id = auth.uid())"
  rationale:
    - "Single source of truth (users table)"
    - "User org reassignment takes effect immediately"
    - "No custom JWT claim configuration required"
    - "Performance overhead <1ms per query"

  policies:
    - table: "organizations"
      name: "org_select_own"
      operation: "SELECT"
      using: "id = (SELECT org_id FROM users WHERE id = auth.uid())"

    - table: "users"
      name: "users_org_isolation"
      operation: "SELECT"
      using: "org_id = (SELECT org_id FROM users WHERE id = auth.uid())"

    - table: "users"
      name: "users_admin_write"
      operation: "ALL"
      using: |
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
        AND (SELECT r.code FROM roles r JOIN users u ON u.role_id = r.id WHERE u.id = auth.uid()) IN ('owner', 'admin')

    - table: "roles"
      name: "roles_select_system"
      operation: "SELECT"
      using: "is_system = true"

    - table: "modules"
      name: "modules_select_all"
      operation: "SELECT"
      using: "true"

    - table: "organization_modules"
      name: "org_modules_isolation"
      operation: "SELECT"
      using: "org_id = (SELECT org_id FROM users WHERE id = auth.uid())"

    - table: "organization_modules"
      name: "org_modules_admin_write"
      operation: "ALL"
      using: |
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
        AND (SELECT r.code FROM roles r JOIN users u ON u.role_id = r.id WHERE u.id = auth.uid()) IN ('owner', 'admin')

# -----------------------------------------------------------------------------
# API ENDPOINTS
# -----------------------------------------------------------------------------
api:
  endpoints:
    - method: "GET"
      path: "/api/v1/settings/context"
      description: "Returns org_id, user_id, role, permissions for authenticated user"
      auth: "required"
      response:
        type: "OrgContext"
        fields:
          - "org_id: UUID"
          - "user_id: UUID"
          - "role_code: string"
          - "role_name: string"
          - "permissions: Record<string, string>"
          - "organization: { name, timezone, locale, currency }"
      errors:
        - code: 401
          message: "Unauthorized"
        - code: 404
          message: "User not found"

# -----------------------------------------------------------------------------
# SEED DATA
# -----------------------------------------------------------------------------
seed_data:
  roles:
    description: "10 system roles per ADR-012"
    data:
      - code: "owner"
        name: "Owner"
        permissions: '{"settings":"CRUD","users":"CRUD","technical":"CRUD","planning":"CRUD","production":"CRUD","warehouse":"CRUD","quality":"CRUD","shipping":"CRUD","npd":"CRUD","finance":"CRUD","oee":"CRUD","integrations":"CRUD"}'
      - code: "admin"
        name: "Administrator"
        permissions: '{"settings":"CRU","users":"CRUD","technical":"CRUD","planning":"CRUD","production":"CRUD","warehouse":"CRUD","quality":"CRUD","shipping":"CRUD","npd":"CRUD","finance":"CRUD","oee":"CRUD","integrations":"CRUD"}'
      - code: "production_manager"
        name: "Production Manager"
        permissions: '{"settings":"R","users":"R","technical":"RU","planning":"CRUD","production":"CRUD","warehouse":"RU","quality":"CRUD","shipping":"R","npd":"R","finance":"R","oee":"CRUD","integrations":"R"}'
      - code: "quality_manager"
        name: "Quality Manager"
        permissions: '{"settings":"R","users":"R","technical":"R","planning":"R","production":"RU","warehouse":"R","quality":"CRUD","shipping":"R","npd":"RU","finance":"-","oee":"R","integrations":"-"}'
      - code: "warehouse_manager"
        name: "Warehouse Manager"
        permissions: '{"settings":"R","users":"R","technical":"R","planning":"R","production":"R","warehouse":"CRUD","quality":"R","shipping":"CRUD","npd":"-","finance":"-","oee":"-","integrations":"-"}'
      - code: "production_operator"
        name: "Production Operator"
        permissions: '{"settings":"-","users":"-","technical":"R","planning":"R","production":"RU","warehouse":"R","quality":"CR","shipping":"-","npd":"-","finance":"-","oee":"R","integrations":"-"}'
      - code: "warehouse_operator"
        name: "Warehouse Operator"
        permissions: '{"settings":"-","users":"-","technical":"R","planning":"-","production":"-","warehouse":"CRU","quality":"R","shipping":"RU","npd":"-","finance":"-","oee":"-","integrations":"-"}'
      - code: "quality_inspector"
        name: "Quality Inspector"
        permissions: '{"settings":"-","users":"-","technical":"R","planning":"-","production":"R","warehouse":"R","quality":"CRU","shipping":"R","npd":"-","finance":"-","oee":"-","integrations":"-"}'
      - code: "planner"
        name: "Planner"
        permissions: '{"settings":"R","users":"R","technical":"R","planning":"CRUD","production":"R","warehouse":"R","quality":"R","shipping":"R","npd":"R","finance":"R","oee":"R","integrations":"-"}'
      - code: "viewer"
        name: "Viewer"
        permissions: '{"settings":"R","users":"R","technical":"R","planning":"R","production":"R","warehouse":"R","quality":"R","shipping":"R","npd":"R","finance":"R","oee":"R","integrations":"R"}'

  modules:
    description: "11 modules per ADR-011"
    data:
      - code: "settings"
        name: "Settings"
        can_disable: false
        display_order: 1
      - code: "technical"
        name: "Technical"
        can_disable: false
        display_order: 2
      - code: "planning"
        name: "Planning"
        dependencies: ["technical"]
        can_disable: true
        display_order: 3
      - code: "production"
        name: "Production"
        dependencies: ["planning"]
        can_disable: true
        display_order: 4
      - code: "warehouse"
        name: "Warehouse"
        dependencies: ["technical"]
        can_disable: true
        display_order: 5
      - code: "quality"
        name: "Quality"
        dependencies: ["production"]
        can_disable: true
        display_order: 6
      - code: "shipping"
        name: "Shipping"
        dependencies: ["warehouse"]
        can_disable: true
        display_order: 7
      - code: "npd"
        name: "New Product Development"
        dependencies: ["technical"]
        can_disable: true
        display_order: 8
      - code: "finance"
        name: "Finance"
        dependencies: ["planning", "shipping"]
        can_disable: true
        display_order: 9
      - code: "oee"
        name: "OEE"
        dependencies: ["production"]
        can_disable: true
        display_order: 10
      - code: "integrations"
        name: "Integrations"
        dependencies: []
        can_disable: true
        display_order: 11

# -----------------------------------------------------------------------------
# ACCEPTANCE CRITERIA
# -----------------------------------------------------------------------------
acceptance_criteria:
  - id: "AC-01"
    given: "an authenticated request"
    when: "the backend resolves context"
    then: "it can derive user_id and org_id for the session"
    test_type: "unit"

  - id: "AC-02"
    given: "a user from Org B"
    when: "they request an Org A resource by ID"
    then: "the API returns 404 (not 403) and does not leak existence"
    test_type: "integration"

  - id: "AC-03"
    given: "user from Org B"
    when: "requesting resource from Org A"
    then: "response is 404 Not Found (NOT 403 Forbidden) to prevent existence leak"
    test_type: "integration"

  - id: "AC-04"
    given: "a query is executed without an explicit org_id filter"
    when: "RLS/equivalent is applied"
    then: "cross-tenant rows are not returned"
    test_type: "integration"

  - id: "AC-05"
    given: "query without explicit org_id filter"
    when: "executed via Supabase client"
    then: "RLS automatically filters to user's org_id"
    test_type: "integration"

  - id: "AC-06"
    given: "a user without admin privileges"
    when: "they attempt admin-only writes (e.g., modify org profile)"
    then: "the API rejects the request"
    test_type: "integration"

  - id: "AC-07"
    given: "test fixtures with 2 orgs"
    when: "integration tests run"
    then: "cross-tenant reads/writes are blocked consistently"
    test_type: "e2e"

# -----------------------------------------------------------------------------
# DEFINITION OF DONE
# -----------------------------------------------------------------------------
definition_of_done:
  - "Cross-tenant access is blocked by policy and tests"
  - "All new/changed endpoints use the shared org context helper"
  - "Tests pass and failures are meaningful (no false positives)"
  - "Unit test coverage >= 95% (security critical)"
  - "Integration test coverage >= 80%"
  - "404 (not 403) response verified for cross-tenant access"
  - "RLS policies follow ADR-013 users lookup pattern"

# -----------------------------------------------------------------------------
# DELIVERABLES
# -----------------------------------------------------------------------------
deliverables:
  - type: "service"
    path: "apps/frontend/lib/services/org-context-service.ts"
    description: "Shared auth/org context helper(s) used by Settings endpoints (getOrgContext())"

  - type: "migration"
    path: "supabase/migrations/047_rls_policies.sql"
    description: "Baseline RLS policies for organizations, users, roles, organization_modules"

  - type: "test"
    path: "supabase/tests/rls-isolation.test.sql"
    description: "Tests proving isolation + 404 behavior"

  - type: "api"
    path: "apps/frontend/app/api/settings/context/route.ts"
    description: "GET /api/settings/context - returns org_id, user_id, role, permissions"

# -----------------------------------------------------------------------------
# UX SECTION
# -----------------------------------------------------------------------------
ux:
  wireframes: []  # Backend-only story, no wireframes
  notes:
    - "This is a foundation/backend story with no UI components"
    - "Org context will be consumed by all subsequent Settings UI stories"

# -----------------------------------------------------------------------------
# RISKS
# -----------------------------------------------------------------------------
risks:
  - id: "RISK-01"
    description: "RLS policy misconfiguration could leak data"
    mitigation: "Comprehensive integration tests with 2+ org fixtures"
    severity: "high"

  - id: "RISK-02"
    description: "Performance impact of users table lookup on every query"
    mitigation: "PostgreSQL caches lookup efficiently, measured <1ms overhead"
    severity: "low"

# -----------------------------------------------------------------------------
# TECHNICAL NOTES
# -----------------------------------------------------------------------------
technical_notes:
  - "Use ADR-013 RLS pattern: (SELECT org_id FROM users WHERE id = auth.uid())"
  - "Never use JWT claims for org_id - use users table as single source of truth"
  - "Return 404 (not 403) for cross-tenant resource access to prevent enumeration"
  - "All tables with org_id column must have RLS enabled"
  - "Index users(id) already exists as primary key - no additional index needed for RLS"
  - "Seed data for roles and modules must be idempotent"

# -----------------------------------------------------------------------------
# HANDOFF TO DEV AGENTS
# -----------------------------------------------------------------------------
handoff:
  story: "01.1.org-context-base-rls"
  story_file: "docs/2-MANAGEMENT/epics/current/01-settings/01.1.org-context-base-rls.md"
  epic_folder: "docs/2-MANAGEMENT/epics/current/01-settings/"
  adrs:
    - "ADR-011: Module Toggle Storage"
    - "ADR-012: Role Permission Storage"
    - "ADR-013: RLS Org Isolation Pattern"
  technical_notes: "Root story establishing multi-tenant foundation. All subsequent stories depend on this."
  dependencies: []
