# Story Context: 01.15 Session & Password Management
# Generated: 2025-12-16
# Purpose: AI agent context for implementing session management and password policies

story:
  id: "01.15"
  name: "Session & Password Management"
  slug: "session-password-management"
  epic: "01-settings"
  phase: "1A"
  complexity: "M"
  estimate_days: 3
  type: "backend + frontend"
  state: "ready"
  priority: "P0"
  story_file: "docs/2-MANAGEMENT/epics/current/01-settings/01.15.session-password-management.md"

# -----------------------------------------------------------------------------
# DEPENDENCIES
# -----------------------------------------------------------------------------
dependencies:
  required:
    - story: "01.1"
      name: "Org Context + Base RLS"
      provides:
        - "organizations table"
        - "users table schema"
        - "org_id context"
        - "RLS policies for tenant isolation"
        - "auth.uid() helper"
    - story: "01.6"
      name: "Role-Based Permissions"
      provides:
        - "roles table with 10 predefined roles"
        - "permission matrix (module x CRUD)"
        - "hasPermission() helper function"
        - "ADMIN/SUPER_ADMIN role checks for admin session termination"
  blocked_by: []
  blocks: []

# -----------------------------------------------------------------------------
# FILES TO READ (Context for Implementation)
# -----------------------------------------------------------------------------
files_to_read:
  prd:
    path: "docs/1-BASELINE/product/modules/settings.md"
    sections:
      - "FR-SET-013"  # Session Management
      - "FR-SET-014"  # Password Policies
  architecture:
    path: "docs/1-BASELINE/architecture/modules/settings.md"
    sections:
      - "Authentication"
      - "Session Management"
      - "Security"
  story:
    path: "docs/2-MANAGEMENT/epics/current/01-settings/01.15.session-password-management.md"
  adrs:
    - path: "docs/1-BASELINE/architecture/decisions/ADR-013-rls-org-isolation-pattern.md"
      relevance: "RLS policy pattern for session access control"
  patterns:
    - "apps/frontend/lib/validation/*.ts"    # Existing Zod schema patterns
    - "apps/frontend/lib/services/*.ts"      # Existing service patterns
    - "apps/frontend/components/ui/dialog.tsx"  # ShadCN Dialog for confirmation
    - "apps/frontend/components/ui/card.tsx"    # ShadCN Card for session display

# -----------------------------------------------------------------------------
# UX WIREFRAMES
# -----------------------------------------------------------------------------
ux_wireframes:
  - id: "SET-015"
    name: "Active Sessions"
    path: "docs/3-ARCHITECTURE/ux/wireframes/SET-015-active-sessions.md"
    description: "Active sessions list with termination actions"
  - id: "SET-016"
    name: "Password Change"
    path: "docs/3-ARCHITECTURE/ux/wireframes/SET-016-password-change.md"
    description: "Password change form with real-time requirements validation"

# -----------------------------------------------------------------------------
# FILES TO CREATE
# -----------------------------------------------------------------------------
files_to_create:
  pages:
    - path: "apps/frontend/app/(authenticated)/settings/security/page.tsx"
      description: "Security settings page (sessions + password combined)"

  components:
    - path: "apps/frontend/components/settings/security/ActiveSessionsList.tsx"
      description: "List of active sessions with termination actions"
    - path: "apps/frontend/components/settings/security/SessionCard.tsx"
      description: "Individual session display card (device, IP, last activity)"
    - path: "apps/frontend/components/settings/security/TerminateSessionDialog.tsx"
      description: "Confirmation dialog for single session termination"
    - path: "apps/frontend/components/settings/security/TerminateAllSessionsDialog.tsx"
      description: "Confirmation dialog for bulk session termination"
    - path: "apps/frontend/components/settings/security/ChangePasswordForm.tsx"
      description: "Password change form with validation"
    - path: "apps/frontend/components/settings/security/PasswordRequirements.tsx"
      description: "Real-time password requirements checklist"
    - path: "apps/frontend/components/settings/security/PasswordStrengthIndicator.tsx"
      description: "Visual password strength meter (weak/medium/strong)"
    - path: "apps/frontend/components/settings/security/ForcePasswordChangeModal.tsx"
      description: "Modal for expired password forced change"

  validation:
    - path: "apps/frontend/lib/validation/session-schemas.ts"
      description: "Zod schemas for session operations"
    - path: "apps/frontend/lib/validation/password-schemas.ts"
      description: "Zod schemas for password validation and change"

  services:
    - path: "apps/frontend/lib/services/session-service.ts"
      description: "Session CRUD, termination, and validation logic"
    - path: "apps/frontend/lib/services/password-service.ts"
      description: "Password validation, history check, change logic"

  api:
    - path: "apps/frontend/app/api/v1/settings/sessions/route.ts"
      methods: ["GET", "DELETE"]
      description: "List user sessions, terminate all except current"
    - path: "apps/frontend/app/api/v1/settings/sessions/current/route.ts"
      methods: ["GET"]
      description: "Get current session details"
    - path: "apps/frontend/app/api/v1/settings/sessions/[id]/route.ts"
      methods: ["DELETE"]
      description: "Terminate specific session"
    - path: "apps/frontend/app/api/v1/settings/sessions/terminate-all/route.ts"
      methods: ["POST"]
      description: "Terminate all sessions including current (logout all)"
    - path: "apps/frontend/app/api/v1/settings/users/[userId]/sessions/route.ts"
      methods: ["GET", "DELETE"]
      description: "Admin: list and terminate user sessions"
    - path: "apps/frontend/app/api/v1/settings/password/change/route.ts"
      methods: ["POST"]
      description: "Change own password"
    - path: "apps/frontend/app/api/v1/settings/password/validate/route.ts"
      methods: ["POST"]
      description: "Validate password strength (no auth required)"
    - path: "apps/frontend/app/api/v1/settings/password/policy/route.ts"
      methods: ["GET"]
      description: "Get password policy configuration"
    - path: "apps/frontend/app/api/v1/settings/users/[userId]/password/reset/route.ts"
      methods: ["POST"]
      description: "Admin: force password reset for user"

  migrations:
    - path: "supabase/migrations/XXX_user_sessions.sql"
      description: "user_sessions table with indexes and RLS"
    - path: "supabase/migrations/XXX_password_history.sql"
      description: "password_history table with cleanup trigger"
    - path: "supabase/migrations/XXX_org_session_settings.sql"
      description: "Add session_timeout_hours and password settings to organizations"
    - path: "supabase/migrations/XXX_user_password_fields.sql"
      description: "Add password_changed_at, password_expires_at to users"

  tests:
    - path: "apps/frontend/lib/services/__tests__/session-service.test.ts"
      description: "Unit tests for session service"
    - path: "apps/frontend/lib/services/__tests__/password-service.test.ts"
      description: "Unit tests for password service"
    - path: "apps/frontend/app/api/v1/settings/sessions/__tests__/route.test.ts"
      description: "Integration tests for session API"
    - path: "apps/frontend/app/api/v1/settings/password/__tests__/route.test.ts"
      description: "Integration tests for password API"
    - path: "e2e/settings/session-management.spec.ts"
      description: "E2E tests for session management"
    - path: "e2e/settings/password-change.spec.ts"
      description: "E2E tests for password change"

# -----------------------------------------------------------------------------
# DATABASE SCHEMA
# -----------------------------------------------------------------------------
database:
  tables:
    - name: "user_sessions"
      description: "Tracks all active and revoked user sessions"
      columns:
        - name: "id"
          type: "UUID"
          constraints: "PRIMARY KEY DEFAULT gen_random_uuid()"
        - name: "user_id"
          type: "UUID"
          constraints: "NOT NULL REFERENCES users(id) ON DELETE CASCADE"
        - name: "org_id"
          type: "UUID"
          constraints: "NOT NULL REFERENCES organizations(id) ON DELETE CASCADE"
        - name: "session_token"
          type: "VARCHAR(255)"
          constraints: "UNIQUE NOT NULL"
        - name: "refresh_token"
          type: "VARCHAR(255)"
          constraints: "UNIQUE"
        - name: "device_type"
          type: "VARCHAR(50)"
          constraints: "NOT NULL DEFAULT 'browser'"
          notes: "'browser', 'mobile', 'api'"
        - name: "device_name"
          type: "VARCHAR(255)"
          constraints: ""
          notes: "'Chrome on Windows', 'Safari on iPhone'"
        - name: "ip_address"
          type: "INET"
          constraints: "NOT NULL"
        - name: "user_agent"
          type: "TEXT"
          constraints: ""
        - name: "created_at"
          type: "TIMESTAMPTZ"
          constraints: "DEFAULT NOW()"
        - name: "last_activity_at"
          type: "TIMESTAMPTZ"
          constraints: "DEFAULT NOW()"
        - name: "expires_at"
          type: "TIMESTAMPTZ"
          constraints: "NOT NULL"
        - name: "revoked_at"
          type: "TIMESTAMPTZ"
          constraints: ""
        - name: "revoked_by"
          type: "UUID"
          constraints: "REFERENCES users(id)"
        - name: "revocation_reason"
          type: "VARCHAR(100)"
          constraints: ""
          notes: "'user_logout', 'admin_terminate', 'password_change', 'timeout'"
      indexes:
        - "idx_user_sessions_user_id ON user_sessions(user_id)"
        - "idx_user_sessions_org_id ON user_sessions(org_id)"
        - "idx_user_sessions_expires_at ON user_sessions(expires_at)"
        - "idx_user_sessions_token ON user_sessions(session_token)"
        - "idx_user_sessions_active ON user_sessions(user_id) WHERE revoked_at IS NULL"
      rls: true
      rls_policies:
        - name: "sessions_own_read"
          operation: "SELECT"
          using: |
            user_id = auth.uid()
            OR (
              org_id = (SELECT org_id FROM users WHERE id = auth.uid())
              AND (SELECT r.code FROM roles r JOIN users u ON u.role_id = r.id WHERE u.id = auth.uid()) IN ('SUPER_ADMIN', 'ADMIN')
            )
        - name: "sessions_own_delete"
          operation: "DELETE"
          using: |
            user_id = auth.uid()
            OR (
              org_id = (SELECT org_id FROM users WHERE id = auth.uid())
              AND (SELECT r.code FROM roles r JOIN users u ON u.role_id = r.id WHERE u.id = auth.uid()) IN ('SUPER_ADMIN', 'ADMIN')
            )
        - name: "sessions_insert"
          operation: "INSERT"
          with_check: "org_id = (SELECT org_id FROM users WHERE id = auth.uid())"

    - name: "password_history"
      description: "Stores last 5 password hashes to prevent reuse"
      columns:
        - name: "id"
          type: "UUID"
          constraints: "PRIMARY KEY DEFAULT gen_random_uuid()"
        - name: "user_id"
          type: "UUID"
          constraints: "NOT NULL REFERENCES users(id) ON DELETE CASCADE"
        - name: "password_hash"
          type: "VARCHAR(255)"
          constraints: "NOT NULL"
        - name: "created_at"
          type: "TIMESTAMPTZ"
          constraints: "DEFAULT NOW()"
      indexes:
        - "idx_password_history_user_id ON password_history(user_id)"
      rls: true
      rls_policies:
        - name: "password_history_none"
          operation: "ALL"
          using: "false"
          notes: "No direct user access - handled through backend service role"
      triggers:
        - name: "password_history_cleanup"
          event: "AFTER INSERT"
          function: "maintain_password_history()"
          description: "Keeps only last 5 passwords per user"

  table_extensions:
    - table: "organizations"
      columns:
        - name: "session_timeout_hours"
          type: "INTEGER"
          constraints: "DEFAULT 24 CHECK (session_timeout_hours >= 1 AND session_timeout_hours <= 720)"
        - name: "password_expiry_days"
          type: "INTEGER"
          constraints: "DEFAULT NULL CHECK (password_expiry_days IS NULL OR password_expiry_days >= 30)"
        - name: "enforce_password_history"
          type: "BOOLEAN"
          constraints: "DEFAULT true"

    - table: "users"
      columns:
        - name: "password_changed_at"
          type: "TIMESTAMPTZ"
          constraints: "DEFAULT NOW()"
        - name: "password_expires_at"
          type: "TIMESTAMPTZ"
          constraints: ""
        - name: "force_password_change"
          type: "BOOLEAN"
          constraints: "DEFAULT false"

  functions:
    - name: "maintain_password_history"
      description: "Trigger function to keep only last 5 passwords"
      language: "plpgsql"
      implementation: |
        CREATE OR REPLACE FUNCTION maintain_password_history()
        RETURNS TRIGGER AS $$
        BEGIN
          DELETE FROM password_history
          WHERE user_id = NEW.user_id
          AND id NOT IN (
            SELECT id FROM password_history
            WHERE user_id = NEW.user_id
            ORDER BY created_at DESC
            LIMIT 5
          );
          RETURN NEW;
        END;
        $$ LANGUAGE plpgsql;

# -----------------------------------------------------------------------------
# API ENDPOINTS
# -----------------------------------------------------------------------------
api:
  endpoints:
    # Session Management - User
    - method: "GET"
      path: "/api/v1/settings/sessions"
      description: "List user's own active sessions"
      auth: true
      roles: ["all"]
      response:
        sessions: "Session[]"
        current_session_id: "string"
      performance: "< 200ms"

    - method: "GET"
      path: "/api/v1/settings/sessions/current"
      description: "Get current session details"
      auth: true
      roles: ["all"]
      response:
        id: "UUID"
        device_type: "string"
        device_name: "string"
        ip_address: "string"
        created_at: "timestamp"
        last_activity_at: "timestamp"
        expires_at: "timestamp"

    - method: "DELETE"
      path: "/api/v1/settings/sessions/:id"
      description: "Terminate specific session"
      auth: true
      roles: ["all"]
      response:
        success: true
      errors:
        404: "Session not found"
        400: "Cannot terminate current session (use logout)"

    - method: "DELETE"
      path: "/api/v1/settings/sessions"
      description: "Terminate all sessions except current"
      auth: true
      roles: ["all"]
      response:
        terminated_count: "number"

    - method: "POST"
      path: "/api/v1/settings/sessions/terminate-all"
      description: "Terminate all sessions including current (logout all devices)"
      auth: true
      roles: ["all"]
      response:
        success: true
        message: "All sessions terminated"
      side_effects:
        - "Invalidates all user sessions"
        - "User will be logged out everywhere"

    # Session Management - Admin
    - method: "GET"
      path: "/api/v1/settings/users/:userId/sessions"
      description: "Admin: list user's sessions"
      auth: true
      roles: ["SUPER_ADMIN", "ADMIN"]
      response:
        sessions: "Session[]"
      errors:
        403: "Forbidden - Admin role required"
        404: "User not found"

    - method: "DELETE"
      path: "/api/v1/settings/users/:userId/sessions"
      description: "Admin: terminate all user sessions"
      auth: true
      roles: ["SUPER_ADMIN", "ADMIN"]
      response:
        terminated_count: "number"
      side_effects:
        - "Creates audit log entry"
        - "User immediately logged out on all devices"
      errors:
        403: "Forbidden - Admin role required"
        404: "User not found"

    # Password Management
    - method: "POST"
      path: "/api/v1/settings/password/change"
      description: "Change own password"
      auth: true
      roles: ["all"]
      request_body:
        current_password: "string (required)"
        new_password: "string (required, must meet complexity)"
        confirm_password: "string (required, must match)"
      response:
        success: true
        message: "Password changed successfully"
      side_effects:
        - "Terminates all other sessions"
        - "Adds old password to history"
        - "Updates password_changed_at"
      errors:
        400: "Current password is incorrect"
        400: "Password does not meet requirements"
        400: "Cannot reuse recent passwords"
        400: "Passwords do not match"

    - method: "POST"
      path: "/api/v1/settings/password/validate"
      description: "Validate password strength (no auth required for real-time validation)"
      auth: false
      request_body:
        password: "string"
      response:
        valid: "boolean"
        errors: "string[]"
        requirements:
          minLength: "{ met: boolean, message: string }"
          uppercase: "{ met: boolean, message: string }"
          lowercase: "{ met: boolean, message: string }"
          number: "{ met: boolean, message: string }"
          special: "{ met: boolean, message: string }"
        strength: "'weak' | 'medium' | 'strong'"

    - method: "GET"
      path: "/api/v1/settings/password/policy"
      description: "Get password policy configuration"
      auth: true
      roles: ["all"]
      response:
        min_length: 8
        require_uppercase: true
        require_lowercase: true
        require_number: true
        require_special: true
        history_count: 5
        expiry_days: "number | null"

    - method: "POST"
      path: "/api/v1/settings/users/:userId/password/reset"
      description: "Admin: force password reset for user"
      auth: true
      roles: ["SUPER_ADMIN", "ADMIN"]
      response:
        success: true
        message: "Password reset initiated"
      side_effects:
        - "Sets force_password_change = true"
        - "Terminates all user sessions"
        - "Creates audit log entry"
      errors:
        403: "Forbidden - Admin role required"
        404: "User not found"

# -----------------------------------------------------------------------------
# UX COMPONENTS
# -----------------------------------------------------------------------------
ux:
  components:
    - name: "ActiveSessionsList"
      description: "List of active sessions with termination actions"
      props:
        - "sessions: Session[]"
        - "currentSessionId: string"
        - "onTerminate: (sessionId: string) => void"
        - "onTerminateAll: () => void"
        - "isLoading: boolean"
      layout: |
        +------------------------------------------+
        | Active Sessions            [Logout All] |
        +------------------------------------------+
        | Chrome on Windows              [Current] |
        | IP: 192.168.1.100                        |
        | Last active: 2 minutes ago               |
        | Started: Dec 15, 2024, 10:30 AM          |
        |                              [Revoke]    |
        +------------------------------------------+
        | Safari on iPhone                         |
        | IP: 192.168.1.101                        |
        | Last active: 1 hour ago                  |
        | Started: Dec 14, 2024, 3:00 PM           |
        |                              [Revoke]    |
        +------------------------------------------+

    - name: "SessionCard"
      description: "Individual session display"
      props:
        - "session: Session"
        - "isCurrent: boolean"
        - "onTerminate: () => void"
      states:
        - "default: Shows device info, IP, timestamps"
        - "current: Shows 'Current session' badge, no revoke button"
        - "loading: Disabled during termination"

    - name: "ChangePasswordForm"
      description: "Password change form with validation"
      props:
        - "onSuccess: () => void"
        - "forceChange?: boolean"
      fields:
        - "Current password (type=password)"
        - "New password (type=password) with PasswordRequirements"
        - "Confirm password (type=password)"
        - "Submit button"
      layout: |
        +------------------------------------------+
        | Change Password                          |
        +------------------------------------------+
        | Current Password                         |
        | [*************]                          |
        |                                          |
        | New Password                             |
        | [**********]                             |
        |                                          |
        | Password Requirements:                   |
        | [x] At least 8 characters                |
        | [x] One uppercase letter (A-Z)           |
        | [x] One lowercase letter (a-z)           |
        | [ ] One number (0-9)                     |
        | [ ] One special character (!@#$%^&*)     |
        |                                          |
        | Strength: [====----] Medium              |
        |                                          |
        | Confirm New Password                     |
        | [**********]                             |
        |                                          |
        | [     Change Password     ]              |
        +------------------------------------------+

    - name: "PasswordRequirements"
      description: "Real-time password requirements checklist"
      props:
        - "password: string"
        - "showStrength?: boolean"
      display:
        - "[x] At least 8 characters - green checkmark when met"
        - "[x] One uppercase letter - green checkmark when met"
        - "[x] One lowercase letter - green checkmark when met"
        - "[ ] One number - red X when not met"
        - "[ ] One special character - red X when not met"

    - name: "PasswordStrengthIndicator"
      description: "Visual strength meter"
      props:
        - "strength: 'weak' | 'medium' | 'strong'"
      display:
        weak: "red bar 1/4, text 'Weak'"
        medium: "yellow bar 2/4, text 'Medium'"
        strong: "green bar 4/4, text 'Strong'"

  states:
    loading: "Skeleton cards for sessions, disabled form for password"
    empty_sessions: "'No other sessions active' message"
    error: "Error alert with retry button"
    success: "Success toast on action completion"

  patterns:
    card: "ShadCN Card for session display"
    dialog: "ShadCN AlertDialog for termination confirmation"
    form: "react-hook-form with Zod resolver"
    toast: "ShadCN Toast for success/error messages"
    checkbox: "Custom checkbox list for requirements"
    progress: "ShadCN Progress for strength indicator"

# -----------------------------------------------------------------------------
# VALIDATION RULES
# -----------------------------------------------------------------------------
validation_rules:
  password:
    min_length: 8
    require_uppercase: true
    require_lowercase: true
    require_number: true
    require_special: true
    special_chars: "!@#$%^&*()_+-=[]{}|;':\",./<>?"
    history_count: 5
    error_messages:
      min_length: "Password must be at least 8 characters"
      uppercase: "Password must contain at least one uppercase letter"
      lowercase: "Password must contain at least one lowercase letter"
      number: "Password must contain at least one number"
      special: "Password must contain at least one special character (!@#$%^&*)"
      mismatch: "Passwords do not match"
      current_wrong: "Current password is incorrect"
      history: "Cannot reuse recent passwords"

  session:
    default_timeout_hours: 24
    min_timeout_hours: 1
    max_timeout_hours: 720

# -----------------------------------------------------------------------------
# PATTERNS
# -----------------------------------------------------------------------------
patterns:
  session_service:
    description: "Session management service"
    code: |
      // session-service.ts
      export interface Session {
        id: string;
        user_id: string;
        org_id: string;
        device_type: 'browser' | 'mobile' | 'api';
        device_name: string;
        ip_address: string;
        created_at: string;
        last_activity_at: string;
        expires_at: string;
        is_current?: boolean;
      }

      export class SessionService {
        async getSessions(userId: string): Promise<Session[]> {
          // Return active (non-revoked) sessions for user
        }

        async terminateSession(sessionId: string, reason: string): Promise<void> {
          // Mark session as revoked
        }

        async terminateAllSessions(userId: string, exceptCurrent?: string): Promise<number> {
          // Terminate all sessions, optionally except current
        }

        parseUserAgent(userAgent: string): { device_type: string; device_name: string } {
          // Parse UA string into device info
        }
      }

  password_service:
    description: "Password validation and change service"
    code: |
      // password-service.ts
      export interface PasswordValidationResult {
        valid: boolean;
        errors: string[];
        requirements: {
          minLength: { met: boolean; message: string };
          uppercase: { met: boolean; message: string };
          lowercase: { met: boolean; message: string };
          number: { met: boolean; message: string };
          special: { met: boolean; message: string };
        };
        strength: 'weak' | 'medium' | 'strong';
      }

      export class PasswordService {
        validatePassword(password: string): PasswordValidationResult {
          // Check all requirements, calculate strength
        }

        async checkPasswordHistory(userId: string, password: string): Promise<boolean> {
          // Returns true if password is in history (should reject)
        }

        async changePassword(userId: string, currentPassword: string, newPassword: string): Promise<void> {
          // Verify current, validate new, update, add to history, terminate sessions
        }
      }

  zod_password_schema:
    description: "Zod schema for password validation"
    code: |
      // password-schemas.ts
      const PASSWORD_PATTERNS = {
        uppercase: /[A-Z]/,
        lowercase: /[a-z]/,
        number: /[0-9]/,
        special: /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/,
      };

      export const passwordSchema = z.string()
        .min(8, 'Password must be at least 8 characters')
        .refine((val) => PASSWORD_PATTERNS.uppercase.test(val),
          'Password must contain at least one uppercase letter')
        .refine((val) => PASSWORD_PATTERNS.lowercase.test(val),
          'Password must contain at least one lowercase letter')
        .refine((val) => PASSWORD_PATTERNS.number.test(val),
          'Password must contain at least one number')
        .refine((val) => PASSWORD_PATTERNS.special.test(val),
          'Password must contain at least one special character');

      export const changePasswordSchema = z.object({
        current_password: z.string().min(1, 'Current password is required'),
        new_password: passwordSchema,
        confirm_password: z.string(),
      }).refine(
        (data) => data.new_password === data.confirm_password,
        { message: 'Passwords do not match', path: ['confirm_password'] }
      );

# -----------------------------------------------------------------------------
# ACCEPTANCE CRITERIA
# -----------------------------------------------------------------------------
acceptance_criteria:
  session_management:
    - id: "AC-01"
      given: "user logs in successfully"
      when: "session created"
      then: "session token valid for 24 hours (default)"
      test_type: "integration"

    - id: "AC-02"
      given: "session created"
      when: "session data stored"
      then: "device type, IP address, user agent, and timestamps are recorded"
      test_type: "integration"

    - id: "AC-03"
      given: "user is authenticated"
      when: "they navigate to Security settings"
      then: "list of all active sessions displays"
      test_type: "e2e"

    - id: "AC-04"
      given: "active sessions list"
      when: "rendered"
      then: "current session is marked with 'Current session' badge"
      test_type: "unit"

    - id: "AC-05"
      given: "user views session list"
      when: "they click 'Revoke' on a specific session"
      then: "confirmation dialog appears"
      test_type: "e2e"

    - id: "AC-06"
      given: "user confirms session termination"
      when: "action completes"
      then: "that session is invalidated immediately"
      test_type: "integration"

    - id: "AC-07"
      given: "terminated session"
      when: "device with that session makes request"
      then: "401 Unauthorized returns"
      test_type: "integration"

    - id: "AC-08"
      given: "user clicks 'Logout All Devices'"
      when: "confirmed"
      then: "all sessions except current are terminated"
      test_type: "integration"

  password_management:
    - id: "AC-09"
      given: "user sets password 'abc'"
      when: "form submitted"
      then: "error 'Password must be at least 8 characters' displays"
      test_type: "unit"

    - id: "AC-10"
      given: "user sets password 'Abcdefg1!'"
      when: "form submitted"
      then: "password accepted and saved"
      test_type: "integration"

    - id: "AC-11"
      given: "real-time validation enabled"
      when: "user types password"
      then: "checklist updates showing met/unmet requirements"
      test_type: "unit"

    - id: "AC-12"
      given: "user attempts to reuse one of last 5 passwords"
      when: "form submitted"
      then: "error 'Cannot reuse recent passwords' displays"
      test_type: "integration"

    - id: "AC-13"
      given: "user changes password"
      when: "password update completes"
      then: "all other sessions terminated (security)"
      test_type: "integration"

    - id: "AC-14"
      given: "current password incorrect"
      when: "form submitted"
      then: "error 'Current password is incorrect' displays"
      test_type: "integration"

  admin_session_management:
    - id: "AC-15"
      given: "admin views user detail"
      when: "sessions tab clicked"
      then: "all user sessions display"
      test_type: "e2e"

    - id: "AC-16"
      given: "admin with SUPER_ADMIN or ADMIN role"
      when: "viewing user sessions"
      then: "'Terminate All' button visible"
      test_type: "unit"

    - id: "AC-17"
      given: "non-admin user"
      when: "attempting to view other user sessions"
      then: "403 Forbidden returns"
      test_type: "integration"

  multi_tenancy:
    - id: "AC-18"
      given: "User A from Org A"
      when: "requesting sessions"
      then: "only Org A sessions returned"
      test_type: "integration"

    - id: "AC-19"
      given: "User A from Org A"
      when: "attempting to terminate Org B session"
      then: "404 Not Found returns (not 403)"
      test_type: "integration"

# -----------------------------------------------------------------------------
# DEFINITION OF DONE
# -----------------------------------------------------------------------------
definition_of_done:
  - "user_sessions table created with correct indexes and RLS"
  - "password_history table created with cleanup trigger"
  - "Organizations table extended with session/password settings"
  - "Users table extended with password fields"
  - "Sessions created on login with correct device info and expiry"
  - "Session timeout configurable per organization (default 24h)"
  - "Active sessions list displays all user sessions"
  - "Current session correctly identified and badged"
  - "Single session termination works with confirmation"
  - "'Terminate All' terminates all sessions except current"
  - "Terminated sessions return 401 on next request"
  - "Password change terminates all other sessions"
  - "Password validation enforces all complexity requirements"
  - "Real-time password requirements checklist works"
  - "Password strength indicator displays correctly"
  - "Password history prevents reuse of last 5 passwords"
  - "Admins can view and terminate user sessions"
  - "Non-admins cannot view other users' sessions"
  - "Cross-tenant session access returns 404 (not 403)"
  - "Audit log entries created for security actions"
  - "Rate limiting prevents brute force attacks"
  - "Unit test coverage >= 90% (security critical)"
  - "Integration tests pass"
  - "E2E tests pass"

# -----------------------------------------------------------------------------
# SECURITY CONSIDERATIONS
# -----------------------------------------------------------------------------
security:
  session_token:
    - "Use cryptographically secure random tokens (32+ bytes)"
    - "Store hashed tokens in database"
    - "Transmit only via HTTPS"
    - "Use HttpOnly, Secure, SameSite cookies"

  password:
    - "Hash with bcrypt (cost factor 12) or Argon2id"
    - "Never log or expose passwords"
    - "Rate limit password attempts"
    - "Constant-time comparison for password verification"

  audit:
    - "Log all session terminations with actor"
    - "Log password changes (not the password)"
    - "Log failed password attempts"

  rate_limiting:
    - "Max 5 failed password attempts per 15 minutes"
    - "Max 10 session terminations per hour"

# -----------------------------------------------------------------------------
# TESTS
# -----------------------------------------------------------------------------
tests:
  unit:
    session_service:
      - "createSession creates session with correct expiry based on org settings"
      - "parseUserAgent parses user agent into device info correctly"
      - "terminateSession marks session as revoked with reason"
      - "terminateAllSessions terminates all except current when specified"
      - "validateSession returns valid=true for active session"
      - "validateSession returns expired=true for timed out session"
      - "validateSession returns revoked=true for terminated session"
    password_service:
      - "validatePassword rejects password under 8 characters"
      - "validatePassword rejects password without uppercase"
      - "validatePassword rejects password without lowercase"
      - "validatePassword rejects password without number"
      - "validatePassword rejects password without special character"
      - "validatePassword accepts valid password meeting all requirements"
      - "validatePassword calculates strength correctly"
      - "checkPasswordHistory rejects password in last 5 history"
      - "checkPasswordHistory accepts password not in history"
      - "changePassword verifies current password before change"
      - "changePassword terminates other sessions after change"

  integration:
    session_api:
      - "GET /api/v1/settings/sessions returns only own sessions"
      - "GET /api/v1/settings/sessions marks current session correctly"
      - "GET /api/v1/settings/sessions returns 401 for unauthenticated"
      - "DELETE /api/v1/settings/sessions/:id terminates own session"
      - "DELETE /api/v1/settings/sessions/:id returns 404 for other user session"
      - "DELETE /api/v1/settings/users/:userId/sessions terminates all user sessions (admin)"
      - "DELETE /api/v1/settings/users/:userId/sessions returns 403 for non-admin"
    password_api:
      - "POST /api/v1/settings/password/change changes password with valid data"
      - "POST /api/v1/settings/password/change rejects incorrect current password"
      - "POST /api/v1/settings/password/change rejects weak new password"
      - "POST /api/v1/settings/password/change rejects password in history"
      - "POST /api/v1/settings/password/change terminates other sessions"
      - "POST /api/v1/settings/password/validate returns validation results without auth"

  e2e:
    - "Session Management: displays active sessions list"
    - "Session Management: shows current session badge"
    - "Session Management: terminates single session with confirmation"
    - "Session Management: terminates all sessions with confirmation"
    - "Password Change: displays password requirements in real-time"
    - "Password Change: shows checkmarks as requirements met"
    - "Password Change: shows strength indicator"
    - "Password Change: prevents submission until all requirements met"
    - "Password Change: shows success message after change"

# -----------------------------------------------------------------------------
# DELIVERABLES
# -----------------------------------------------------------------------------
deliverables:
  - type: "migration"
    path: "supabase/migrations/XXX_user_sessions.sql"
    description: "user_sessions table"

  - type: "migration"
    path: "supabase/migrations/XXX_password_history.sql"
    description: "password_history table with trigger"

  - type: "service"
    path: "apps/frontend/lib/services/session-service.ts"
    description: "Session CRUD and termination"

  - type: "service"
    path: "apps/frontend/lib/services/password-service.ts"
    description: "Password validation and change"

  - type: "validation"
    path: "apps/frontend/lib/validation/session-schemas.ts"
    description: "Session Zod schemas"

  - type: "validation"
    path: "apps/frontend/lib/validation/password-schemas.ts"
    description: "Password Zod schemas"

  - type: "page"
    path: "apps/frontend/app/(authenticated)/settings/security/page.tsx"
    description: "Security settings page"

  - type: "component"
    path: "apps/frontend/components/settings/security/ActiveSessionsList.tsx"
    description: "Active sessions list"

  - type: "component"
    path: "apps/frontend/components/settings/security/ChangePasswordForm.tsx"
    description: "Password change form"

  - type: "component"
    path: "apps/frontend/components/settings/security/PasswordRequirements.tsx"
    description: "Password requirements checklist"

  - type: "api"
    path: "apps/frontend/app/api/v1/settings/sessions/route.ts"
    description: "Session management API"

  - type: "api"
    path: "apps/frontend/app/api/v1/settings/password/change/route.ts"
    description: "Password change API"

  - type: "test"
    path: "apps/frontend/lib/services/__tests__/session-service.test.ts"
    description: "Session service unit tests"

  - type: "test"
    path: "apps/frontend/lib/services/__tests__/password-service.test.ts"
    description: "Password service unit tests"

# -----------------------------------------------------------------------------
# HANDOFF TO DEV AGENTS
# -----------------------------------------------------------------------------
handoff:
  story: "01.15.session-password-management"
  story_file: "docs/2-MANAGEMENT/epics/current/01-settings/01.15.session-password-management.md"
  epic_folder: "docs/2-MANAGEMENT/epics/current/01-settings/"
  adrs:
    - "ADR-013: RLS Org Isolation Pattern"
  technical_notes: |
    Implement comprehensive session management and password policy enforcement.
    Key security features:
    - Sessions tracked per device with IP and user agent
    - Configurable timeout per org (default 24h)
    - Password change terminates all other sessions
    - Password history prevents reuse of last 5 passwords
    - Admin can view/terminate user sessions
    - Rate limiting for password attempts
  dependencies:
    - "01.1: Org Context + Base RLS (provides auth context)"
    - "01.6: Role Permissions (provides admin role checks)"
  priority: "P0"
  estimated_effort: "3 days"
