# Story 01.1 - Test Results (RED Phase)

**Story:** 01.1 - Org Context + Base RLS
**Phase:** RED (Tests Written, All Failing)
**Date:** 2025-12-16
**Test Engineer:** TEST-ENGINEER
**Status:** READY FOR DEV (GREEN Phase)

---

## Test Summary

### Overall Status: ALL TESTS FAILING ✓ (Expected)

This is the RED phase of TDD - all tests are designed to fail because the implementation does not exist yet. This is the correct state before handing off to DEV.

---

## Test Files Created

### 1. Unit Tests

#### a) Org Context Service Tests
**File:** `apps/frontend/lib/services/__tests__/org-context-service.test.ts`
**Test Count:** 24 test cases
**Coverage Target:** 95% (security critical)

**Test Categories:**
- AC-01: Context resolution (6 tests)
- Error handling (5 tests)
- Performance (2 tests)
- Edge cases (3 tests)
- Context validation (5 tests)
- Session resolution (3 tests)

**Status:** All 24 tests FAIL
**Reason:** Functions not implemented:
- `getOrgContext(userId)` - not defined
- `validateOrgContext(context)` - not defined
- `deriveUserIdFromSession()` - not defined

#### b) Permission Service Tests
**File:** `apps/frontend/lib/services/__tests__/permission-service.test.ts`
**Test Count:** 25 test cases
**Coverage Target:** 90% (security critical)

**Test Categories:**
- AC-06: Admin role checks (6 tests)
- Edge cases - invalid roles (5 tests)
- Organization modification (4 tests)
- User modification (4 tests)
- System role validation (3 tests)
- Integration scenarios (3 tests)

**Status:** All 25 tests FAIL
**Reason:** Functions not implemented:
- `hasAdminAccess(roleCode)` - not defined
- `canModifyOrganization(roleCode)` - not defined
- `canModifyUsers(roleCode)` - not defined
- `isSystemRole(roleCode)` - not defined

### 2. Integration Tests

#### RLS Isolation Tests (SQL)
**File:** `supabase/tests/rls-isolation.test.sql`
**Test Count:** 19 test scenarios
**Coverage Target:** 80% (integration)

**Test Categories:**
- AC-02/AC-03: Cross-tenant 404 (1 test)
- AC-04/AC-05: Auto-filtering (1 test)
- AC-06: Admin-only writes (4 tests)
- AC-07: 2-org fixture isolation (2 tests)
- Users table RLS (4 tests)
- Roles table RLS (1 test)
- Modules table RLS (1 test)
- Organization_modules RLS (4 tests)
- Performance (ADR-013) (1 test)

**Status:** All tests will FAIL
**Reason:** Database tables not created:
- `organizations` table - does not exist
- `users` table - does not exist
- `roles` table - does not exist
- `modules` table - does not exist
- `organization_modules` table - does not exist
- RLS policies not implemented

#### API Endpoint Tests
**File:** `apps/frontend/__tests__/api/settings/context.test.ts`
**Test Count:** 22 test cases
**Coverage Target:** 80% (integration)

**Test Categories:**
- AC-01: Context resolution (5 tests)
- Error handling (4 tests)
- AC-02/AC-03: Cross-tenant isolation (2 tests)
- Response format validation (3 tests)
- Performance (2 tests)
- Edge cases (4 tests)
- Caching (2 tests)

**Status:** All tests will FAIL
**Reason:** API endpoint not implemented:
- `GET /api/v1/settings/context` - route does not exist

### 3. Test Fixtures

#### Organizations Fixture
**File:** `apps/frontend/lib/services/__tests__/fixtures/organizations.ts`
**Contents:**
- 4 test organizations (Org A, B, C, D)
- Helper functions for filtering/querying
- Realistic test data with different states

#### Users Fixture
**File:** `apps/frontend/lib/services/__tests__/fixtures/users.ts`
**Contents:**
- 10 test users across 3 organizations
- All 10 system roles represented
- Helper functions for filtering by org/role
- Cross-tenant test scenarios

---

## Test Execution Results

### Run Command
```bash
npm test -- lib/services/__tests__/org-context-service.test.ts --run
```

### Sample Output
```
FAIL lib/services/__tests__/org-context-service.test.ts
  × 01.1 getOrgContext - User Context Resolution
    × should return org_id and user_id for valid authenticated user
      ReferenceError: getOrgContext is not defined
    × should return user role information
      ReferenceError: getOrgContext is not defined
    × should return role permissions as JSONB object
      ReferenceError: getOrgContext is not defined
    ...

Failed Tests: 24
Test Files: 1 failed (1)
Tests: 24 failed (24)
```

**Verification:** All tests fail for the RIGHT reason - missing implementation.

---

## Acceptance Criteria Coverage

### AC-01: Derive user_id and org_id from authenticated request
**Tests:** 6 unit + 5 integration = 11 tests
**Files:**
- `org-context-service.test.ts` (lines 55-117)
- `context.test.ts` (lines 24-97)
**Status:** Comprehensive coverage ✓

### AC-02 & AC-03: Cross-tenant access returns 404 (not 403)
**Tests:** 1 SQL + 2 API = 3 tests
**Files:**
- `rls-isolation.test.sql` (lines 64-75)
- `context.test.ts` (lines 153-182)
**Status:** Comprehensive coverage ✓
**Critical:** Tests verify 404 (not 403) response

### AC-04 & AC-05: Query without org_id filter auto-filtered by RLS
**Tests:** 1 SQL + 4 unit = 5 tests
**Files:**
- `rls-isolation.test.sql` (lines 77-91)
**Status:** Comprehensive coverage ✓

### AC-06: Non-admin cannot perform admin-only writes
**Tests:** 6 unit + 4 SQL = 10 tests
**Files:**
- `permission-service.test.ts` (lines 24-73)
- `rls-isolation.test.sql` (lines 144-198)
**Status:** Comprehensive coverage ✓

### AC-07: 2-org fixtures prove cross-tenant isolation
**Tests:** 2 SQL scenarios
**Files:**
- `rls-isolation.test.sql` (lines 200-265)
**Status:** Comprehensive coverage ✓

---

## Handoff to DEV

### Phase: RED → GREEN Transition

**Current State:** RED (all tests fail)
**Target State:** GREEN (all tests pass)

### Files DEV Must Create

#### 1. Database Migrations (6 files)
```
supabase/migrations/043_create_organizations_table.sql
supabase/migrations/044_create_roles_table.sql
supabase/migrations/045_create_users_table.sql
supabase/migrations/046_create_modules_tables.sql
supabase/migrations/047_rls_policies.sql
supabase/migrations/048_seed_system_data.sql
```

**Reference:** Context file lines 61-81

#### 2. Services (2 files)
```
apps/frontend/lib/services/org-context-service.ts
apps/frontend/lib/services/permission-service.ts
```

**Functions to implement:**
- `getOrgContext(userId: string): Promise<OrgContext>`
- `validateOrgContext(context: OrgContext): boolean`
- `deriveUserIdFromSession(): Promise<string>`
- `hasAdminAccess(roleCode: string): boolean`
- `canModifyOrganization(roleCode: string): boolean`
- `canModifyUsers(roleCode: string): boolean`
- `isSystemRole(roleCode: string): boolean`

#### 3. Types (3 files)
```
apps/frontend/lib/types/organization.ts
apps/frontend/lib/types/user.ts
apps/frontend/lib/types/module.ts
```

**Key interfaces:**
- `OrgContext` - see org-context-service.test.ts lines 14-34
- `User` - see users.ts fixture
- `Organization` - see organizations.ts fixture

#### 4. API Route (1 file)
```
apps/frontend/app/api/v1/settings/context/route.ts
```

**Endpoint:** `GET /api/v1/settings/context`
**Response format:** See context.test.ts lines 36-55

#### 5. Error Classes (2 files)
```
apps/frontend/lib/errors/unauthorized-error.ts
apps/frontend/lib/errors/not-found-error.ts
```

---

## Critical Implementation Notes

### 1. RLS Pattern (ADR-013)
All RLS policies MUST use this pattern:
```sql
USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()))
```

**DO NOT use JWT claims for org_id** - use users table as single source of truth.

### 2. 404 vs 403 Behavior
Cross-tenant resource access MUST return **404 (Not Found)**, NOT 403 (Forbidden).

**Reason:** Prevents existence enumeration attacks.

**Example:**
```typescript
// BAD - leaks existence
if (!hasAccess) throw new ForbiddenError() // 403

// GOOD - no leak
if (!found) throw new NotFoundError() // 404
```

### 3. Performance Requirements
- Context resolution: < 50ms
- RLS lookup overhead: < 1ms (per ADR-013)
- Use single JOIN query (no N+1)

### 4. Security Checklist
- [ ] All tables have RLS enabled (`ALTER TABLE ... ENABLE ROW LEVEL SECURITY`)
- [ ] All org-scoped tables use ADR-013 RLS pattern
- [ ] `users(id)` indexed (already exists as PRIMARY KEY)
- [ ] Check `is_active` for both user and organization
- [ ] Return 404 for cross-tenant access (not 403)
- [ ] Admin roles: only 'owner' and 'admin'

---

## Test Execution Guide for DEV

### Run Unit Tests
```bash
# All org context tests
npm test -- lib/services/__tests__/org-context-service.test.ts

# All permission tests
npm test -- lib/services/__tests__/permission-service.test.ts

# With coverage
npm test -- lib/services/__tests__/ --coverage
```

### Run Integration Tests (SQL)
```bash
# Run against test database
psql -h localhost -U postgres -d monopilot_test -f supabase/tests/rls-isolation.test.sql
```

### Run API Tests
```bash
npm test -- __tests__/api/settings/context.test.ts
```

### Expected Progression
1. **After migrations:** SQL tests pass
2. **After services:** Unit tests pass
3. **After API route:** Integration tests pass
4. **Final state:** All 90 tests passing

---

## Quality Gates

### Before Marking Story Complete:
- [ ] All 24 org-context-service tests PASS
- [ ] All 25 permission-service tests PASS
- [ ] All 19 RLS isolation tests PASS
- [ ] All 22 API context tests PASS
- [ ] Unit test coverage >= 95%
- [ ] Integration test coverage >= 80%
- [ ] All 7 acceptance criteria verified
- [ ] RLS policies follow ADR-013 pattern
- [ ] 404 (not 403) behavior confirmed

---

## Coverage Targets

| Test Type | Target | Current | Status |
|-----------|--------|---------|--------|
| Unit | 95% | 0% (no impl) | RED ✓ |
| Integration | 80% | 0% (no impl) | RED ✓ |
| E2E | N/A | N/A | N/A |

---

## Test Files Summary

| File | Tests | Type | Status |
|------|-------|------|--------|
| org-context-service.test.ts | 24 | Unit | 24 FAIL ✓ |
| permission-service.test.ts | 25 | Unit | 25 FAIL ✓ |
| rls-isolation.test.sql | 19 | Integration | Will FAIL ✓ |
| context.test.ts | 22 | Integration | Will FAIL ✓ |
| **TOTAL** | **90** | **Mixed** | **90 FAIL ✓** |

---

## Next Steps

1. **DEV receives this document** + test files
2. **DEV implements:** Migrations → Services → API → Types
3. **DEV runs tests:** Watch tests turn GREEN
4. **DEV verifies:** Coverage targets met
5. **CODE-REVIEWER:** Reviews implementation + test pass status
6. **Story 01.1:** Marked DONE

---

## References

- **Context File:** `docs/2-MANAGEMENT/epics/current/01-settings/context/01.1.context.yaml`
- **Story:** `docs/2-MANAGEMENT/epics/current/01-settings/01.1.org-context-base-rls.md`
- **Test Strategy:** `docs/2-MANAGEMENT/epics/current/01-settings/01.0.test-strategy.md`
- **ADR-013:** `docs/1-BASELINE/architecture/decisions/ADR-013-rls-org-isolation-pattern.md`

---

**RED Phase Complete ✓**
**Status:** READY FOR GREEN PHASE (DEV Implementation)
**Test Engineer:** TEST-ENGINEER
**Date:** 2025-12-16
