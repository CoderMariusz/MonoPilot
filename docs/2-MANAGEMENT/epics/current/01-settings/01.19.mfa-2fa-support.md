# 01.19 - MFA/2FA Support

**Story ID:** 01.19
**Epic:** 01 - Settings
**Phase:** 1B (Polish)
**Complexity:** M (Medium)
**Estimate:** 2-3 days
**Type:** Backend + Frontend
**State:** ready

**Primary PRD:** `docs/1-BASELINE/product/modules/settings.md` (FR-SET-015)
**UX Wireframes:** SET-026 (Security Settings - 2FA Section)

## PRD References

| FR ID | Requirement | Priority | Phase | Covered |
|-------|-------------|----------|-------|---------|
| FR-SET-015 | MFA/2FA support (TOTP/SMS) | P1 | 1B | Yes |

## User Story

**As a** user,
**I want** to enable two-factor authentication on my account,
**So that** I can protect my account with an additional security layer beyond my password.

**As an** administrator,
**I want** to see which users have 2FA enabled,
**So that** I can monitor security compliance across my organization.

## Goal

Implement TOTP-based two-factor authentication using Supabase Auth MFA APIs. Users can enroll authenticator apps (Google Authenticator, Authy, etc.), generate backup codes for recovery, and verify 2FA during login. Leverages built-in Supabase MFA functionality for secure, standards-compliant implementation.

## Scope

**In scope:**
- TOTP enrollment via QR code (authenticator apps)
- Supabase Auth MFA API integration (`auth.mfa.*`)
- QR code generation for setup (otpauth:// URI)
- Manual secret entry fallback
- Backup codes (10 single-use codes)
- Per-user enablement (voluntary)
- MFA challenge during login (AAL1 -> AAL2)
- Disable 2FA with verification
- Recovery flow via backup codes

**Out of scope:**
- SMS-based 2FA (future enhancement)
- Email-based 2FA (security concerns)
- Org-wide MFA enforcement (Phase 2)
- WebAuthn/passkeys (future)
- Trusted device management

## Dependencies

| Story | Requirement | Status |
|-------|-------------|--------|
| 01.1 | Org Context + Base RLS | Required - provides auth context |
| 01.15 | Session & Password Management | Required - session handling |

## Acceptance Criteria (Given/When/Then)

### MFA Enrollment

#### Initiate Enrollment
- GIVEN user navigates to Security settings, WHEN 2FA is disabled, THEN "Enable 2FA" button displays.
- GIVEN user clicks "Enable 2FA", WHEN modal opens, THEN QR code displays with authenticator app instructions.
- GIVEN QR code displayed, WHEN modal renders, THEN manual secret entry option shown below QR code.
- GIVEN enrollment started, WHEN `supabase.auth.mfa.enroll()` called, THEN TOTP factor created with unverified status.

#### QR Code & Secret
- GIVEN QR code displayed, WHEN user scans with Google Authenticator, THEN 6-digit code generates in app.
- GIVEN manual entry preferred, WHEN user clicks "Can't scan?", THEN base32 secret displays for manual input.
- GIVEN QR code URI, WHEN generated, THEN follows otpauth:// format with issuer "MonoPilot".

#### Verify Enrollment
- GIVEN user enters 6-digit code from authenticator, WHEN code valid, THEN factor verified and 2FA enabled.
- GIVEN user enters incorrect code, WHEN form submitted, THEN error "Invalid verification code" displays.
- GIVEN code valid, WHEN `supabase.auth.mfa.verify()` succeeds, THEN AAL upgraded to aal2.
- GIVEN enrollment verified, WHEN success, THEN backup codes modal displays automatically.

### Backup Codes

#### Generate Backup Codes
- GIVEN 2FA just enabled, WHEN verification succeeds, THEN 10 backup codes generate automatically.
- GIVEN backup codes generated, WHEN displayed, THEN each code is 8 characters (alphanumeric, grouped 4-4).
- GIVEN backup codes modal, WHEN displayed, THEN "Download" and "Copy" buttons present.
- GIVEN user clicks "Download", WHEN action completes, THEN `.txt` file downloads with codes.

#### Backup Code Storage
- GIVEN backup codes generated, WHEN stored, THEN codes hashed (bcrypt) in database.
- GIVEN user dismisses modal, WHEN 2FA complete, THEN success toast "2FA enabled successfully" displays.
- GIVEN backup codes modal, WHEN shown, THEN warning "Save these codes securely. They won't be shown again."

#### Regenerate Backup Codes
- GIVEN user with 2FA enabled, WHEN they click "Regenerate Backup Codes", THEN verification code required.
- GIVEN valid verification code entered, WHEN confirmed, THEN 10 new codes generated, old codes invalidated.
- GIVEN regeneration complete, WHEN modal closes, THEN toast "New backup codes generated" displays.

### MFA Login Flow

#### Challenge Required
- GIVEN user with 2FA enabled logs in, WHEN password verified, THEN MFA challenge screen displays.
- GIVEN MFA challenge screen, WHEN displayed, THEN input field for 6-digit code shows.
- GIVEN `getAuthenticatorAssuranceLevel()` returns `currentLevel: aal1, nextLevel: aal2`, THEN redirect to MFA.
- GIVEN MFA challenge, WHEN "Use backup code" clicked, THEN input field switches to backup code entry.

#### Verify Challenge
- GIVEN valid 6-digit code entered on challenge, WHEN submitted, THEN login completes, redirect to dashboard.
- GIVEN invalid code entered, WHEN submitted, THEN error "Invalid code" displays, attempts remaining shown.
- GIVEN valid backup code entered, WHEN submitted, THEN login completes, backup code marked as used.
- GIVEN backup code used, WHEN same code entered again, THEN error "Code already used" displays.

#### Challenge Timeout
- GIVEN MFA challenge screen, WHEN 5 minutes elapse without verification, THEN session expires, redirect to login.
- GIVEN rate limiting, WHEN 5 failed attempts in 15 minutes, THEN temporary lockout with countdown.

### Disable MFA

#### Disable Flow
- GIVEN user with 2FA enabled, WHEN they click "Disable 2FA", THEN confirmation modal displays.
- GIVEN confirmation modal, WHEN displayed, THEN current TOTP code required to confirm.
- GIVEN valid TOTP code entered, WHEN confirmed, THEN `supabase.auth.mfa.unenroll()` called.
- GIVEN unenroll succeeds, WHEN complete, THEN 2FA disabled, backup codes invalidated.
- GIVEN 2FA disabled, WHEN complete, THEN toast "2FA disabled" displays.

### Admin Visibility

#### 2FA Status Display
- GIVEN admin views user list, WHEN rendered, THEN "2FA" column shows enabled/disabled status per user.
- GIVEN admin views user detail, WHEN security tab opened, THEN 2FA status and enrolled date displays.
- GIVEN admin on Security Settings page, WHEN viewing 2FA section, THEN "X/Y users have 2FA enabled" displays.

### Multi-tenancy

- GIVEN User A from Org A, WHEN viewing 2FA stats, THEN only Org A user stats returned.
- GIVEN MFA factors, WHEN enrolled, THEN associated with user only (no org_id needed - Supabase manages).

## Technical Specification

### Database Schema

#### user_mfa_backup_codes table

```sql
-- Backup codes stored separately (Supabase handles TOTP factors internally)
CREATE TABLE user_mfa_backup_codes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  code_hash VARCHAR(255) NOT NULL, -- bcrypt hashed backup code
  used_at TIMESTAMPTZ, -- NULL if unused
  created_at TIMESTAMPTZ DEFAULT NOW(),

  CONSTRAINT unique_user_code UNIQUE (user_id, code_hash)
);

-- Index for lookup
CREATE INDEX idx_mfa_backup_codes_user_id ON user_mfa_backup_codes(user_id);
CREATE INDEX idx_mfa_backup_codes_unused ON user_mfa_backup_codes(user_id) WHERE used_at IS NULL;
```

#### users table extension

```sql
-- Track 2FA enablement at user level for querying
ALTER TABLE users ADD COLUMN IF NOT EXISTS
  mfa_enabled BOOLEAN DEFAULT false;

ALTER TABLE users ADD COLUMN IF NOT EXISTS
  mfa_enabled_at TIMESTAMPTZ;
```

### RLS Policies

```sql
-- user_mfa_backup_codes: Users can only access their own codes
CREATE POLICY "backup_codes_own_access" ON user_mfa_backup_codes
FOR ALL USING (user_id = auth.uid());

-- Service role can manage codes (for generation/verification)
-- No additional policy needed - service role bypasses RLS
```

### API Endpoints

```
# MFA Enrollment
POST   /api/v1/settings/mfa/enroll          - Start TOTP enrollment (returns QR + secret)
POST   /api/v1/settings/mfa/verify          - Verify TOTP code, complete enrollment
DELETE /api/v1/settings/mfa/unenroll        - Disable 2FA (requires TOTP verification)
GET    /api/v1/settings/mfa/status          - Get current MFA status

# Backup Codes
POST   /api/v1/settings/mfa/backup-codes    - Generate new backup codes (requires TOTP)
GET    /api/v1/settings/mfa/backup-codes/count - Get remaining unused backup codes count

# Login MFA Challenge
POST   /api/v1/auth/mfa/challenge           - Create MFA challenge
POST   /api/v1/auth/mfa/verify              - Verify MFA challenge (TOTP or backup code)
```

### Service Methods

**Location:** `lib/services/mfa-service.ts`

```typescript
interface MfaService {
  // Enrollment
  startEnrollment(userId: string): Promise<EnrollmentResult>;
  verifyEnrollment(userId: string, factorId: string, code: string): Promise<void>;
  unenroll(userId: string, code: string): Promise<void>;

  // Status
  getMfaStatus(userId: string): Promise<MfaStatus>;
  getOrgMfaStats(orgId: string): Promise<MfaOrgStats>;

  // Backup codes
  generateBackupCodes(userId: string): Promise<string[]>;
  verifyBackupCode(userId: string, code: string): Promise<boolean>;
  getBackupCodesCount(userId: string): Promise<number>;

  // Challenge (login flow)
  createChallenge(factorId: string): Promise<Challenge>;
  verifyChallenge(challengeId: string, code: string): Promise<void>;
}

interface EnrollmentResult {
  factorId: string;
  qrCode: string; // Base64 data URL
  secret: string; // Base32 for manual entry
  uri: string;    // otpauth:// URI
}

interface MfaStatus {
  enabled: boolean;
  enabledAt: string | null;
  factorId: string | null;
  backupCodesRemaining: number;
}

interface MfaOrgStats {
  totalUsers: number;
  enabledUsers: number;
  percentage: number;
}

interface Challenge {
  id: string;
  expiresAt: string;
}
```

### Zod Validation Schemas

**Location:** `lib/validation/mfa.ts`

```typescript
import { z } from 'zod';

// TOTP code validation (6 digits)
export const totpCodeSchema = z.string()
  .length(6, 'Code must be 6 digits')
  .regex(/^\d{6}$/, 'Code must contain only digits');

// Backup code validation (8 chars, alphanumeric)
export const backupCodeSchema = z.string()
  .length(8, 'Backup code must be 8 characters')
  .regex(/^[A-Z0-9]{8}$/i, 'Invalid backup code format');

// Verify enrollment request
export const verifyEnrollmentSchema = z.object({
  factor_id: z.string().uuid(),
  code: totpCodeSchema,
});

// Unenroll request
export const unenrollSchema = z.object({
  code: totpCodeSchema,
});

// MFA challenge verify request
export const verifyChallengeSchema = z.object({
  challenge_id: z.string().uuid(),
  code: z.union([totpCodeSchema, backupCodeSchema]),
});

// Generate backup codes request
export const generateBackupCodesSchema = z.object({
  code: totpCodeSchema, // Require TOTP verification
});
```

## UI Components

### Pages

- `app/(authenticated)/settings/security/page.tsx` - Security page (add 2FA section)

### Components

**Location:** `components/settings/security/`

```
MfaSetupModal.tsx           - Enrollment wizard (QR + verify)
MfaQrCode.tsx               - QR code display with manual secret
BackupCodesModal.tsx        - Display/download/copy backup codes
MfaDisableDialog.tsx        - Confirmation dialog with TOTP entry
MfaChallengeForm.tsx        - Login MFA verification form
MfaStatusBadge.tsx          - Enabled/Disabled badge for user lists
```

### Component Details

**MfaSetupModal.tsx**
```tsx
interface MfaSetupModalProps {
  open: boolean;
  onClose: () => void;
  onSuccess: () => void;
}

// Steps:
// 1. Show QR code + instructions
// 2. Verify code input
// 3. Success -> BackupCodesModal
```

**BackupCodesModal.tsx**
```tsx
interface BackupCodesModalProps {
  codes: string[];
  open: boolean;
  onClose: () => void;
}

// Features:
// - Display 10 codes in 2 columns
// - "Download as .txt" button
// - "Copy to clipboard" button
// - Warning: "Save securely, won't show again"
// - Checkbox: "I have saved my backup codes"
```

**MfaChallengeForm.tsx**
```tsx
interface MfaChallengeFormProps {
  factorId: string;
  onSuccess: () => void;
  onCancel: () => void;
}

// Features:
// - 6-digit code input (auto-focus, auto-submit)
// - "Use backup code instead" link
// - Error display with attempts remaining
// - 5-minute timeout countdown
```

### UI Patterns

**2FA Setup Modal:**
```
+------------------------------------------+
| Enable Two-Factor Authentication          |
+------------------------------------------+
| 1. Scan this QR code with your           |
|    authenticator app:                     |
|                                          |
|    [=======QR CODE=======]               |
|                                          |
| Can't scan? Enter this code manually:    |
| JBSWY3DPEHPK3PXP                          |
|                                          |
| 2. Enter the 6-digit code from your app: |
| [______] [______] [______]               |
| [______] [______] [______]               |
|                                          |
| [Cancel]              [Verify & Enable]  |
+------------------------------------------+
```

**Backup Codes Display:**
```
+------------------------------------------+
| Save Your Backup Codes                    |
+------------------------------------------+
| Use these codes if you lose access to    |
| your authenticator app.                  |
|                                          |
| ABCD-1234    EFGH-5678                   |
| IJKL-9012    MNOP-3456                   |
| QRST-7890    UVWX-1234                   |
| YZAB-5678    CDEF-9012                   |
| GHIJ-3456    KLMN-7890                   |
|                                          |
| [Download .txt] [Copy All]               |
|                                          |
| ! Save these codes securely.             |
|   They won't be shown again.             |
|                                          |
| [ ] I have saved my backup codes         |
|                                          |
| [Done]                                   |
+------------------------------------------+
```

**MFA Challenge Screen:**
```
+------------------------------------------+
| Two-Factor Authentication                 |
+------------------------------------------+
| Enter the 6-digit code from your         |
| authenticator app.                       |
|                                          |
| [_ _ _ _ _ _]                            |
|                                          |
| [Use a backup code instead]              |
|                                          |
| [Cancel]               [Verify]          |
+------------------------------------------+
```

## Test Cases

### Unit Tests

**mfa-service.test.ts**
```typescript
describe('MfaService', () => {
  describe('startEnrollment', () => {
    it('calls supabase.auth.mfa.enroll with TOTP');
    it('returns QR code data URL');
    it('returns base32 secret for manual entry');
    it('returns otpauth:// URI');
  });

  describe('verifyEnrollment', () => {
    it('calls supabase.auth.mfa.verify');
    it('updates user mfa_enabled flag on success');
    it('throws on invalid code');
  });

  describe('generateBackupCodes', () => {
    it('generates 10 unique 8-character codes');
    it('stores hashed codes in database');
    it('invalidates previous codes');
  });

  describe('verifyBackupCode', () => {
    it('verifies valid unused backup code');
    it('marks code as used after verification');
    it('rejects already-used codes');
    it('rejects invalid codes');
  });
});
```

### Integration Tests

**mfa-api.test.ts**
```typescript
describe('MFA API', () => {
  describe('POST /api/v1/settings/mfa/enroll', () => {
    it('returns enrollment data for authenticated user');
    it('returns 401 for unauthenticated');
    it('returns 400 if MFA already enabled');
  });

  describe('POST /api/v1/settings/mfa/verify', () => {
    it('completes enrollment with valid code');
    it('returns 400 with invalid code');
    it('generates backup codes on success');
  });

  describe('DELETE /api/v1/settings/mfa/unenroll', () => {
    it('disables MFA with valid TOTP');
    it('returns 403 with invalid TOTP');
    it('invalidates backup codes on disable');
  });

  describe('POST /api/v1/auth/mfa/verify', () => {
    it('completes login with valid TOTP');
    it('completes login with valid backup code');
    it('returns 400 with invalid code');
    it('enforces rate limiting');
  });
});
```

### E2E Tests

**mfa-setup.spec.ts**
```typescript
describe('MFA Setup', () => {
  it('displays QR code in setup modal');
  it('shows manual secret entry option');
  it('enables MFA after valid code entry');
  it('displays backup codes after setup');
  it('allows backup code download');
});
```

**mfa-login.spec.ts**
```typescript
describe('MFA Login', () => {
  it('redirects to MFA challenge after password');
  it('completes login with valid TOTP');
  it('allows backup code login');
  it('shows error for invalid code');
  it('enforces rate limiting');
});
```

## Security Considerations

1. **TOTP Security**
   - Use Supabase Auth MFA (secure secret storage)
   - 30-second code validity with 1-interval skew
   - Rate limit verification attempts (5/15min)

2. **Backup Code Security**
   - Hash codes with bcrypt before storage
   - One-time use only, mark as used immediately
   - Generate cryptographically secure codes
   - Limit to 10 codes per user

3. **Session Security**
   - Challenge expires after 5 minutes
   - AAL2 required for sensitive operations
   - Log all MFA events to audit trail

4. **Recovery**
   - Multiple backup codes reduce lockout risk
   - Admin cannot bypass user MFA (by design)
   - Support flow for lost device: backup codes only

## Supabase MFA Integration

**Key APIs Used:**
- `supabase.auth.mfa.enroll({ factorType: 'totp' })`
- `supabase.auth.mfa.challenge({ factorId })`
- `supabase.auth.mfa.verify({ factorId, challengeId, code })`
- `supabase.auth.mfa.unenroll({ factorId })`
- `supabase.auth.mfa.getAuthenticatorAssuranceLevel()`

**Config Required (supabase/config.toml):**
```toml
[auth.mfa.totp]
enroll_enabled = true
verify_enabled = true
```

## Deliverables

- [ ] Enable TOTP in Supabase config
- [ ] `user_mfa_backup_codes` table migration
- [ ] Users table extension (mfa_enabled, mfa_enabled_at)
- [ ] RLS policies for backup codes
- [ ] MFA service (`lib/services/mfa-service.ts`)
- [ ] Zod schemas (`lib/validation/mfa.ts`)
- [ ] API routes for MFA management
- [ ] API routes for login MFA challenge
- [ ] MfaSetupModal component
- [ ] MfaQrCode component
- [ ] BackupCodesModal component
- [ ] MfaDisableDialog component
- [ ] MfaChallengeForm component
- [ ] MfaStatusBadge component
- [ ] Security page 2FA section integration
- [ ] Unit tests (>80% coverage)
- [ ] Integration tests
- [ ] E2E tests

## Definition of Done

- [ ] TOTP enrollment via QR code works with Google Authenticator/Authy
- [ ] Manual secret entry option available
- [ ] 6-digit TOTP verification completes enrollment
- [ ] 10 backup codes generated and displayed after setup
- [ ] Backup codes downloadable as .txt file
- [ ] Backup codes work for login when device unavailable
- [ ] MFA challenge screen displays after password on login
- [ ] Valid TOTP completes login successfully
- [ ] Invalid codes show appropriate error messages
- [ ] Rate limiting prevents brute force (5 attempts/15 min)
- [ ] Disable 2FA requires TOTP verification
- [ ] Admin can view user 2FA status
- [ ] Supabase MFA config enabled in config.toml
- [ ] Unit test coverage >= 80%
- [ ] Integration tests pass
- [ ] E2E tests pass

## References

- [Supabase MFA Documentation](https://supabase.com/docs/guides/auth/auth-mfa)
- [Supabase TOTP Guide](https://supabase.com/docs/guides/auth/auth-mfa/totp)
- [Supabase MFA JavaScript API](https://supabase.com/docs/reference/javascript/auth-mfa-api)
