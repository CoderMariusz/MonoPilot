# 01.25 - Import/Export & Configuration Backup

**Story ID:** 01.25
**Epic:** 01 - Settings
**Phase:** 3 (Enterprise)
**Complexity:** L (Large)
**Estimate:** 2-3 days
**Type:** Backend + Frontend
**State:** ready

**Primary PRD:** `docs/1-BASELINE/product/modules/settings.md` (FR-SET-150 to FR-SET-155)

## PRD References

| FR ID | Requirement Name | Priority | Phase | Covered |
|-------|------------------|----------|-------|---------|
| FR-SET-150 | Master data CSV import | P2 | 3 | Yes |
| FR-SET-151 | Master data CSV export | P2 | 3 | Yes |
| FR-SET-152 | Excel template download | P2 | 3 | Yes |
| FR-SET-153 | Import validation errors | P2 | 3 | Yes |
| FR-SET-154 | Bulk user import | P2 | 3 | Yes |
| FR-SET-155 | Configuration backup/restore | P2 | 3 | Yes |

## User Story

**As a** system administrator,
**I want** to import and export master data (users, warehouses, locations, machines, tax codes) via CSV files,
**So that** I can quickly onboard bulk data and maintain backups of my configuration.

**As an** organization owner,
**I want** to create full configuration backups and restore from them,
**So that** I can recover from accidental changes or migrate settings between environments.

## Goal

Implement comprehensive import/export functionality for Settings master data entities. Provide CSV import with validation preview, export to CSV/Excel, downloadable templates, and full configuration backup/restore capability. All operations must be transaction-safe with rollback on error.

## Scope

**In scope:**
- CSV import for: Users, Warehouses, Locations, Machines, Tax Codes
- CSV export for all importable entities
- Excel template download (.xlsx) for each entity type
- Import validation with error preview before commit
- Bulk import with transaction support (all-or-nothing)
- Full configuration backup to JSON (all settings tables)
- Restore from backup with validation
- Import/export audit logging

**Out of scope:**
- Import of products/BOMs (Technical module)
- Import of work orders (Planning module)
- Scheduled automatic backups
- Cloud backup storage
- Partial restore (restore all or nothing)

## Dependencies

| Story | Requirement | Status |
|-------|-------------|--------|
| 01.5 | Users CRUD | Required - user import target |
| 01.8 | Warehouses CRUD | Required - warehouse import target |
| 01.9 | Locations CRUD | Required - location import target |
| 01.10 | Machines CRUD | Required - machine import target |
| 01.13 | Tax Codes CRUD | Required - tax code import target |
| 01.17 | Audit Trail | Required - log import/export actions |

## Acceptance Criteria (Given/When/Then)

### CSV Import (FR-SET-150, FR-SET-154)

#### File Upload
- GIVEN admin on import page, WHEN file input clicked, THEN file picker opens accepting .csv files only.
- GIVEN admin selects CSV file >10MB, WHEN file selected, THEN error "File size must be under 10MB" displays.
- GIVEN admin selects non-CSV file, WHEN file selected, THEN error "Only CSV files are accepted" displays.
- GIVEN admin uploads valid CSV, WHEN upload completes, THEN validation step begins within 2 seconds.

#### Validation Preview
- GIVEN CSV uploaded, WHEN validation runs, THEN preview table shows first 10 rows with status.
- GIVEN CSV with missing required field, WHEN validated, THEN row marked RED with "Missing: [field]" error.
- GIVEN CSV with duplicate email (users), WHEN validated, THEN row marked RED with "Duplicate email" error.
- GIVEN CSV with invalid foreign key (e.g., bad warehouse_code), WHEN validated, THEN row marked RED with "Invalid reference" error.
- GIVEN validation completes, WHEN displayed, THEN summary shows: "X valid, Y errors, Z warnings".
- GIVEN any row has errors, WHEN import button shown, THEN button disabled with "Fix errors to import" tooltip.

#### Import Execution
- GIVEN all rows valid, WHEN admin clicks "Import", THEN confirmation dialog appears.
- GIVEN admin confirms import, WHEN import runs, THEN progress bar shows percentage complete.
- GIVEN import of 100 rows, WHEN all successful, THEN success message "100 records imported" displays.
- GIVEN import fails at row 50, WHEN error occurs, THEN all rows rolled back (transaction).
- GIVEN rollback occurs, WHEN displayed, THEN error message "Import failed at row 50: [reason]. No records imported." shows.

### CSV Export (FR-SET-151)

#### Export Execution
- GIVEN admin on export page, WHEN entity type selected (users/warehouses/etc.), THEN "Export CSV" button enabled.
- GIVEN admin clicks "Export CSV" for users, WHEN export completes, THEN browser downloads `users_YYYY-MM-DD.csv`.
- GIVEN organization has 500 users, WHEN export requested, THEN export completes within 10 seconds.
- GIVEN exported CSV, WHEN opened, THEN headers match import template format.
- GIVEN active and inactive records exist, WHEN exported, THEN all records included with status column.

#### Export Filters
- GIVEN admin exporting users, WHEN filter dropdown shown, THEN can select: All, Active only, Inactive only.
- GIVEN admin exports with "Active only" filter, WHEN downloaded, THEN only active=true records included.

### Excel Templates (FR-SET-152)

#### Template Download
- GIVEN admin on import page, WHEN "Download Template" clicked, THEN entity selection dropdown appears.
- GIVEN admin selects "Users" template, WHEN download initiated, THEN `users_template.xlsx` downloads.
- GIVEN downloaded template, WHEN opened, THEN contains header row with all required/optional columns.
- GIVEN template, WHEN examined, THEN includes instruction sheet with field descriptions.

#### Template Contents
- GIVEN users template, WHEN downloaded, THEN columns are: email, first_name, last_name, role_code, language, active.
- GIVEN warehouses template, WHEN downloaded, THEN columns are: code, name, type, address_line1, address_line2, city, postal_code, country.
- GIVEN locations template, WHEN downloaded, THEN columns are: code, warehouse_code, type, zone, aisle, rack, bin, parent_code.
- GIVEN machines template, WHEN downloaded, THEN columns are: code, name, type, capacity_per_hour, status, location_code.
- GIVEN tax_codes template, WHEN downloaded, THEN columns are: code, name, rate, jurisdiction, valid_from, valid_to.

### Configuration Backup (FR-SET-155)

#### Backup Creation
- GIVEN admin on backup page, WHEN "Create Backup" clicked, THEN backup generation starts.
- GIVEN backup generating, WHEN running, THEN progress indicator shows "Backing up: [table_name]".
- GIVEN backup completes, WHEN done, THEN JSON file downloads as `backup_[org_name]_YYYY-MM-DD_HHMMSS.json`.
- GIVEN backup file, WHEN examined, THEN contains: organization, users, roles, warehouses, locations, machines, tax_codes, module_toggles, settings.

#### Backup Metadata
- GIVEN backup file, WHEN opened, THEN header includes: backup_version, created_at, org_id, org_name, record_counts.
- GIVEN backup file, WHEN record_counts checked, THEN each table shows count of records backed up.

#### Restore from Backup
- GIVEN admin uploads backup JSON, WHEN file selected, THEN validation runs automatically.
- GIVEN backup from different org_id, WHEN validated, THEN warning "Backup from different organization. Restore will replace all settings." displays.
- GIVEN backup version newer than system, WHEN validated, THEN error "Backup version not supported" displays.
- GIVEN valid backup, WHEN "Restore" clicked, THEN confirmation dialog with "This will replace ALL settings. Continue?" appears.
- GIVEN admin confirms restore, WHEN restore runs, THEN existing data deleted and backup data inserted (transaction).
- GIVEN restore completes, WHEN done, THEN success message "Restored X records across Y tables" displays.
- GIVEN restore fails mid-process, WHEN error occurs, THEN full rollback to pre-restore state.

### Multi-tenancy & Security
- GIVEN User A from Org A exports, WHEN export runs, THEN only Org A data included.
- GIVEN User A attempts to import backup from Org B, WHEN importing, THEN data isolated to Org A (org_id overwritten).
- GIVEN non-admin user, WHEN accessing import/export, THEN 403 Forbidden returned.
- GIVEN import/export action, WHEN completed, THEN audit log entry created with action details.

## Technical Specification

### API Endpoints

```
# Import Endpoints
POST   /api/v1/settings/import/validate          - Validate CSV before import
POST   /api/v1/settings/import/users             - Import users from CSV
POST   /api/v1/settings/import/warehouses        - Import warehouses from CSV
POST   /api/v1/settings/import/locations         - Import locations from CSV
POST   /api/v1/settings/import/machines          - Import machines from CSV
POST   /api/v1/settings/import/tax-codes         - Import tax codes from CSV

# Export Endpoints
GET    /api/v1/settings/export/users             - Export users to CSV
GET    /api/v1/settings/export/warehouses        - Export warehouses to CSV
GET    /api/v1/settings/export/locations         - Export locations to CSV
GET    /api/v1/settings/export/machines          - Export machines to CSV
GET    /api/v1/settings/export/tax-codes         - Export tax codes to CSV

# Template Endpoints
GET    /api/v1/settings/export/template/:type    - Download Excel template

# Backup Endpoints
POST   /api/v1/settings/backup/create            - Create full configuration backup
POST   /api/v1/settings/backup/validate          - Validate backup file
POST   /api/v1/settings/backup/restore           - Restore from backup
```

### Service Methods

**Location:** `lib/services/import-export-service.ts`

```typescript
interface ImportExportService {
  // CSV Validation
  validateCSV(file: File, entityType: EntityType): Promise<ValidationResult>;

  // CSV Import
  importUsers(data: UserImportRow[], orgId: string): Promise<ImportResult>;
  importWarehouses(data: WarehouseImportRow[], orgId: string): Promise<ImportResult>;
  importLocations(data: LocationImportRow[], orgId: string): Promise<ImportResult>;
  importMachines(data: MachineImportRow[], orgId: string): Promise<ImportResult>;
  importTaxCodes(data: TaxCodeImportRow[], orgId: string): Promise<ImportResult>;

  // CSV Export
  exportUsers(orgId: string, filter?: ExportFilter): Promise<string>;
  exportWarehouses(orgId: string, filter?: ExportFilter): Promise<string>;
  exportLocations(orgId: string, filter?: ExportFilter): Promise<string>;
  exportMachines(orgId: string, filter?: ExportFilter): Promise<string>;
  exportTaxCodes(orgId: string, filter?: ExportFilter): Promise<string>;

  // Templates
  getTemplate(entityType: EntityType): Promise<Buffer>;

  // Backup
  createBackup(orgId: string): Promise<BackupFile>;
  validateBackup(file: File): Promise<BackupValidation>;
  restoreBackup(backup: BackupFile, orgId: string): Promise<RestoreResult>;
}

type EntityType = 'users' | 'warehouses' | 'locations' | 'machines' | 'tax_codes';

interface ValidationResult {
  valid: boolean;
  total_rows: number;
  valid_rows: number;
  error_rows: number;
  warning_rows: number;
  rows: ValidationRow[];
}

interface ValidationRow {
  row_number: number;
  status: 'valid' | 'error' | 'warning';
  data: Record<string, unknown>;
  errors: string[];
  warnings: string[];
}

interface ImportResult {
  success: boolean;
  imported_count: number;
  failed_at_row?: number;
  error?: string;
}

interface BackupFile {
  version: string;
  created_at: string;
  org_id: string;
  org_name: string;
  record_counts: Record<string, number>;
  data: {
    organization: Organization;
    users: User[];
    warehouses: Warehouse[];
    locations: Location[];
    machines: Machine[];
    tax_codes: TaxCode[];
    module_toggles: ModuleToggle[];
  };
}
```

### Zod Validation Schemas

**Location:** `lib/validation/import-export.ts`

```typescript
import { z } from 'zod';

// User Import Row
export const userImportRowSchema = z.object({
  email: z.string().email(),
  first_name: z.string().min(1).max(100),
  last_name: z.string().min(1).max(100),
  role_code: z.enum(['SUPER_ADMIN', 'ADMIN', 'PRODUCTION_MANAGER', 'QUALITY_MANAGER',
    'WAREHOUSE_MANAGER', 'PRODUCTION_OPERATOR', 'QUALITY_INSPECTOR',
    'WAREHOUSE_OPERATOR', 'PLANNER', 'VIEWER']),
  language: z.enum(['en', 'pl', 'de', 'fr']).default('en'),
  active: z.boolean().default(true),
});

// Warehouse Import Row
export const warehouseImportRowSchema = z.object({
  code: z.string().min(1).max(20).regex(/^[A-Z0-9-]+$/),
  name: z.string().min(1).max(100),
  type: z.enum(['raw', 'wip', 'finished', 'quarantine']),
  address_line1: z.string().max(200).optional(),
  city: z.string().max(100).optional(),
  postal_code: z.string().max(20).optional(),
  country: z.string().length(2).optional(),
});

// Location Import Row
export const locationImportRowSchema = z.object({
  code: z.string().min(1).max(30).regex(/^[A-Z0-9-]+$/),
  warehouse_code: z.string().min(1),
  type: z.enum(['bulk', 'pallet', 'shelf', 'bin']),
  zone: z.string().max(10).optional(),
  aisle: z.string().max(10).optional(),
  rack: z.string().max(10).optional(),
  bin: z.string().max(10).optional(),
  parent_code: z.string().optional(),
});

// Machine Import Row
export const machineImportRowSchema = z.object({
  code: z.string().min(1).max(20).regex(/^[A-Z0-9-]+$/),
  name: z.string().min(1).max(100),
  type: z.enum(['mixer', 'oven', 'filler', 'packaging', 'other']),
  capacity_per_hour: z.number().positive().optional(),
  status: z.enum(['active', 'maintenance', 'offline']).default('active'),
  location_code: z.string().optional(),
});

// Tax Code Import Row
export const taxCodeImportRowSchema = z.object({
  code: z.string().min(1).max(10),
  name: z.string().min(1).max(100),
  rate: z.number().min(0).max(100),
  jurisdiction: z.string().max(50).optional(),
  valid_from: z.string().datetime().optional(),
  valid_to: z.string().datetime().optional(),
});

// Backup File Schema
export const backupFileSchema = z.object({
  version: z.string(),
  created_at: z.string().datetime(),
  org_id: z.string().uuid(),
  org_name: z.string(),
  record_counts: z.record(z.number()),
  data: z.object({
    organization: z.any(),
    users: z.array(z.any()),
    warehouses: z.array(z.any()),
    locations: z.array(z.any()),
    machines: z.array(z.any()),
    tax_codes: z.array(z.any()),
    module_toggles: z.array(z.any()),
  }),
});
```

## UI Components

### Pages

- `app/(authenticated)/settings/data-management/page.tsx` - Import/Export hub
- `app/(authenticated)/settings/data-management/import/page.tsx` - Import wizard
- `app/(authenticated)/settings/data-management/backup/page.tsx` - Backup/Restore

### Components

**Location:** `components/settings/data-management/`

```
ImportWizard.tsx            - Multi-step import wizard
ImportFileUpload.tsx        - CSV file upload with drag-drop
ImportValidationPreview.tsx - Table showing validation results
ImportProgressBar.tsx       - Import progress indicator
ExportPanel.tsx             - Export entity selector and buttons
TemplateDownloadButton.tsx  - Download template button
BackupPanel.tsx             - Create backup section
RestorePanel.tsx            - Upload and restore backup
ValidationStatusBadge.tsx   - Row status indicator (valid/error/warning)
```

### UI Layout

**Import Flow:**
```
Step 1: Select Entity        Step 2: Upload File         Step 3: Validate
+-------------------+       +-------------------+       +-------------------+
| O Users           |       | [Drag & Drop]     |       | Row | Status      |
| O Warehouses      |   ->  | or click to       |   ->  | 1   | [Valid]     |
| O Locations       |       | browse            |       | 2   | [Error]     |
| O Machines        |       |                   |       | 3   | [Valid]     |
| O Tax Codes       |       | users.csv         |       +-------------------+
+-------------------+       +-------------------+       | Valid: 8 Error: 2 |
                                                       | [Import] disabled |
                                                       +-------------------+

Step 4: Import
+-------------------+
| Importing...      |
| [=========>    ]  |
| 45/100 records    |
+-------------------+
```

**Export Panel:**
```
+------------------------------------------+
| Export Data                              |
|                                          |
| Entity: [Users        v]                 |
| Filter: [All records  v]                 |
|                                          |
| [Download CSV]  [Download Template]      |
+------------------------------------------+
```

## Test Cases

### Unit Tests

**import-export-service.test.ts**
```typescript
describe('ImportExportService', () => {
  describe('validateCSV', () => {
    it('validates user CSV with correct columns');
    it('detects missing required fields');
    it('detects duplicate emails');
    it('validates foreign key references');
    it('returns row-by-row validation results');
  });

  describe('importUsers', () => {
    it('imports valid users in transaction');
    it('rolls back all on single failure');
    it('overwrites org_id from CSV with current org');
    it('creates audit log entry');
  });

  describe('createBackup', () => {
    it('includes all settings tables');
    it('adds metadata header');
    it('excludes sensitive data (passwords)');
  });

  describe('restoreBackup', () => {
    it('validates backup version');
    it('restores all tables in transaction');
    it('rolls back on failure');
    it('creates audit log entry');
  });
});
```

### Integration Tests

**import-api.test.ts**
```typescript
describe('Import API', () => {
  describe('POST /api/v1/settings/import/validate', () => {
    it('returns validation results for valid CSV');
    it('returns errors for invalid CSV');
    it('requires admin role');
  });

  describe('POST /api/v1/settings/import/users', () => {
    it('imports users successfully');
    it('returns 400 for validation errors');
    it('returns 403 for non-admin');
  });
});
```

### E2E Tests

**import-export.spec.ts**
```typescript
describe('Import/Export', () => {
  it('uploads CSV and shows validation preview');
  it('prevents import when errors exist');
  it('imports successfully and shows count');
  it('exports to CSV with correct data');
  it('downloads Excel template');
  it('creates and downloads backup');
  it('restores from backup with confirmation');
});
```

## Deliverables

- [ ] Import/Export service (`lib/services/import-export-service.ts`)
- [ ] Zod schemas (`lib/validation/import-export.ts`)
- [ ] API routes for import (5 entity types)
- [ ] API routes for export (5 entity types)
- [ ] API route for template download
- [ ] API routes for backup create/validate/restore
- [ ] ImportWizard component
- [ ] ImportFileUpload component
- [ ] ImportValidationPreview component
- [ ] ExportPanel component
- [ ] BackupPanel component
- [ ] RestorePanel component
- [ ] Excel templates (5 files)
- [ ] Data management pages
- [ ] Unit tests (>80% coverage)
- [ ] Integration tests
- [ ] E2E tests

## Definition of Done

- [ ] CSV import works for all 5 entity types
- [ ] Validation preview shows errors before import
- [ ] Import is transactional (all-or-nothing)
- [ ] CSV export works for all 5 entity types
- [ ] Excel templates downloadable for all entity types
- [ ] Templates include instruction sheet
- [ ] Full configuration backup creates valid JSON
- [ ] Restore from backup works with transaction safety
- [ ] Backup from different org warns but allows (with org_id override)
- [ ] All operations require ADMIN or SUPER_ADMIN role
- [ ] All operations create audit log entries
- [ ] Import of 100+ rows completes in <30 seconds
- [ ] Export of 500+ rows completes in <10 seconds
- [ ] Unit test coverage >= 80%
- [ ] Integration tests pass
- [ ] E2E tests pass
