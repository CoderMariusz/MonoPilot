# 01.11 - Production Lines CRUD

**Priority:** P0 (MVP - Phase 1B)
**Story Points:** L (Large)
**Type:** Full-stack (backend + frontend)

**State:** ready
**Primary PRD:** `docs/1-BASELINE/product/modules/settings.md`
**UX Wireframes:** SET-019 (Production Line Create/Edit Modal)

---

## PRD Requirements Coverage

| Req ID | Requirement | Priority | Phase | Status |
|--------|-------------|----------|-------|--------|
| FR-SET-060 | Production line CRUD | P0 | 1B | This Story |
| FR-SET-061 | Machine assignment to lines | P0 | 1B | This Story |
| FR-SET-062 | Line sequence/order definition | P0 | 1B | This Story |
| FR-SET-063 | Line capacity calculation (bottleneck) | P1 | 1B | This Story |
| FR-SET-064 | Line status tracking | P1 | 1B | This Story |
| FR-SET-065 | Line-product compatibility | P1 | 1B | This Story |

---

## User Story

As a **Production Manager or Administrator**, I want to **create and configure production lines with assigned machines in sequence order, set capacity based on bottleneck machine, and define product compatibility** so that **I can organize my manufacturing floor and ensure proper scheduling and work order assignment**.

---

## Dependencies

| Dependency | Type | Status | Notes |
|------------|------|--------|-------|
| 01.1 | Story | Required | Org context + RLS foundation |
| 01.10 (Machines CRUD) | Story | **Required** | Machines must exist before assignment to lines |
| 01.8 (Warehouses CRUD) | Story | Required | Lines belong to warehouses |
| Products table | Table | Required | For product compatibility (FR-SET-065) |

**Critical Path:** 01.1 -> Warehouses -> 01.10 (Machines) -> **01.11 (Production Lines)**

---

## Acceptance Criteria (Given/When/Then)

### AC-1: Production Line List Page (FR-SET-060)

**Given** admin navigates to `/settings/production-lines`
**When** page loads
**Then** line list displays within 300ms with columns: Code, Name, Warehouse, Machine Count, Capacity, Status

**Given** line list has 50 items
**When** admin filters by warehouse "MAIN"
**Then** only lines in MAIN warehouse display within 200ms

**Given** line list displayed
**When** admin searches "PACK"
**Then** lines with code or name containing "PACK" display (case-insensitive)

**Given** line list displayed
**When** admin filters by status "Maintenance"
**Then** only lines with status "Maintenance" appear

**Given** line list with pagination
**When** page 2 clicked
**Then** next 25 lines display

---

### AC-2: Create Production Line (FR-SET-060)

**Given** admin clicks "Add Line"
**When** modal opens
**Then** form displays: Code, Name, Warehouse dropdown, Capacity, Machine assignment section, Product compatibility section, Status toggle

**Given** admin enters line code "LINE-A", name "Assembly Line A", selects warehouse "MAIN"
**When** "Create" clicked
**Then** line created with status "Active" and appears in list within 1 second

**Given** line code "LINE-A" exists
**When** admin enters duplicate code "LINE-A"
**Then** error "Line code must be unique" displays inline

**Given** valid line data entered
**When** save clicked
**Then** line created and toast "Production Line LINE-A created" appears

---

### AC-3: Edit Production Line (FR-SET-060)

**Given** admin clicks edit on existing line "LINE-A"
**When** modal opens
**Then** current line data pre-populates: code, name, warehouse, capacity, assigned machines, compatible products, status

**Given** admin updates line name from "Assembly Line A" to "Assembly Line Alpha"
**When** save completes
**Then** updated name displays immediately in list

**Given** line has active work orders
**When** code edit attempted
**Then** code field is read-only with tooltip "Code cannot be changed while work orders exist"

---

### AC-4: Delete Production Line (FR-SET-060)

**Given** line has no work orders
**When** delete confirmed
**Then** line removed within 500ms

**Given** line has active work orders
**When** delete attempted
**Then** error "Line has active work orders" displays and deletion blocked

**Given** line deleted
**When** machines checked
**Then** machines remain in system (only machine_line_assignments removed)

---

### AC-5: Machine Assignment to Lines (FR-SET-061)

**Given** production line modal open
**When** admin clicks "Add Machine" dropdown
**Then** available machines display with code, name, status

**Given** machine "MIX-001" selected
**When** "Add" clicked
**Then** machine appears in line with sequence position 1

**Given** line already has machine "MIX-001"
**When** same machine selected in dropdown
**Then** machine is disabled in dropdown with tooltip "Already assigned"

**Given** machine with "Offline" status selected
**When** added to line
**Then** warning "Machine MIX-001 is offline" displays but assignment allowed

**Given** machine assigned to LINE-A
**When** same machine assigned to LINE-B
**Then** assignment succeeds (machine can belong to multiple lines)

**Given** machine "PKG-001" in line
**When** remove button ([x]) clicked
**Then** machine removed from line (machine stays in machines table)

---

### AC-6: Machine Sequence/Order Definition (FR-SET-062)

**Given** line has 3 machines: MIX-001 (seq 1), FILL-001 (seq 2), PKG-001 (seq 3)
**When** admin drags MIX-001 from position 1 to position 3
**Then** sequence updates to: FILL-001 (1), PKG-001 (2), MIX-001 (3)

**Given** drag operation in progress
**When** machine dropped at new position
**Then** all sequence numbers renumber automatically (1, 2, 3... no gaps)

**Given** machine removed from middle of sequence
**When** removal confirmed
**Then** remaining machines renumber: 1, 2 (gaps eliminated)

**Given** keyboard navigation active
**When** user focuses machine row and presses Up/Down arrow + Space
**Then** machine moves up/down in sequence (accessibility alternative to drag)

**Given** machine list displayed
**When** rendering
**Then** drag handle icon (triple horizontal lines) appears left of each row

---

### AC-7: Line Capacity Calculation - Bottleneck (FR-SET-063)

**Given** line has machines: MIX-001 (capacity 1000/hr), FILL-001 (capacity 500/hr), PKG-001 (capacity 800/hr)
**When** capacity calculated
**Then** line capacity displays as 500 units/hour (minimum of all machines = bottleneck)

**Given** line has no machines assigned
**When** capacity displayed
**Then** capacity shows "Not calculated" or "--"

**Given** one machine has no capacity set (NULL)
**When** capacity calculated
**Then** that machine is excluded from calculation, bottleneck from others

**Given** all machines have no capacity set
**When** capacity displayed
**Then** capacity shows "Not calculated"

**Given** machine added or removed from line
**When** list refreshes
**Then** calculated capacity updates immediately

**Given** line capacity displayed
**When** hovered
**Then** tooltip shows "Bottleneck: FILL-001 (500/hr)"

---

### AC-8: Line Status Tracking (FR-SET-064)

**Given** line created
**When** no status specified
**Then** default status is "Active"

**Given** line status is "Active"
**When** admin changes to "Maintenance"
**Then** status updates immediately with visual indicator change

**Given** line status is "Inactive"
**When** work order creation attempted on this line
**Then** line is hidden from production line dropdown

**Given** line status is "Setup"
**When** WO scheduling viewed
**Then** line shown with "Setup" badge (available but being configured)

**Status Values:**
- **Active**: Line is operational, available for WO scheduling
- **Maintenance**: Line under planned maintenance, warning on WO assignment
- **Inactive**: Line not operational, hidden from WO dropdowns
- **Setup**: Line being configured, visible with badge

**Given** line has active WOs
**When** status changed to "Inactive"
**Then** warning "Line has X active WOs. Changing status will not cancel them." displays, change allowed

---

### AC-9: Line-Product Compatibility (FR-SET-065)

**Given** production line modal open
**When** "Compatible Products" section viewed
**Then** product list displays with checkboxes, code, name, category

**Given** no products selected
**When** line saved
**Then** line can run ANY product (no restrictions)

**Given** 3 products selected: WWB-001, RYE-001, MUF-001
**When** line saved
**Then** line can ONLY run those 3 products (restricted)

**Given** product list displayed
**When** admin enters "wheat" in search
**Then** list filters to products with "wheat" in code or name within 300ms

**Given** search active with 5 products visible
**When** "Select All" clicked
**Then** only the 5 visible products are selected (not all products)

**Given** 10 products selected
**When** "Clear All" clicked
**Then** all products deselected, counter shows "0 products selected"

**Given** restricted line (3 products)
**When** WO creation started
**Then** product dropdown filters to only compatible products

**Given** WO created with product not in line's compatibility list
**When** validation runs
**Then** error "Product [CODE] cannot run on line [LINE-CODE]" displays

---

## Technical Specification

### Database Schema

#### Table: `production_lines`

```sql
CREATE TABLE production_lines (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,

  -- Basic Data
  code VARCHAR(50) NOT NULL,
  name VARCHAR(100) NOT NULL,
  description TEXT,

  -- Warehouse Assignment
  warehouse_id UUID NOT NULL REFERENCES warehouses(id) ON DELETE RESTRICT,

  -- Default Output Location (optional)
  default_output_location_id UUID REFERENCES locations(id) ON DELETE SET NULL,

  -- Status (FR-SET-064)
  status VARCHAR(20) NOT NULL DEFAULT 'active',

  -- Audit Trail
  created_by UUID REFERENCES users(id),
  updated_by UUID REFERENCES users(id),
  created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
  updated_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,

  -- Constraints
  CONSTRAINT production_lines_org_code_unique UNIQUE (org_id, code),
  CONSTRAINT production_lines_code_format_check CHECK (code ~ '^[A-Z0-9-]+$'),
  CONSTRAINT production_lines_status_check CHECK (status IN ('active', 'maintenance', 'inactive', 'setup'))
);
```

#### Table: `production_line_machines` (Junction with Sequence)

```sql
CREATE TABLE production_line_machines (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  line_id UUID NOT NULL REFERENCES production_lines(id) ON DELETE CASCADE,
  machine_id UUID NOT NULL REFERENCES machines(id) ON DELETE CASCADE,

  -- Sequence Order (FR-SET-062)
  sequence_order INTEGER NOT NULL,

  created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,

  -- Constraints
  CONSTRAINT plm_unique_machine_line UNIQUE (line_id, machine_id),
  CONSTRAINT plm_unique_sequence UNIQUE (line_id, sequence_order),
  CONSTRAINT plm_sequence_positive CHECK (sequence_order > 0)
);

-- Indexes
CREATE INDEX idx_plm_line_id ON production_line_machines(line_id);
CREATE INDEX idx_plm_machine_id ON production_line_machines(machine_id);
CREATE INDEX idx_plm_sequence ON production_line_machines(line_id, sequence_order);
```

#### Table: `production_line_products` (Junction for Compatibility)

```sql
CREATE TABLE production_line_products (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  line_id UUID NOT NULL REFERENCES production_lines(id) ON DELETE CASCADE,
  product_id UUID NOT NULL REFERENCES products(id) ON DELETE CASCADE,

  created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,

  -- Constraints
  CONSTRAINT plp_unique UNIQUE (line_id, product_id)
);

-- Indexes
CREATE INDEX idx_plp_line_id ON production_line_products(line_id);
CREATE INDEX idx_plp_product_id ON production_line_products(product_id);
```

### RLS Policies

```sql
-- production_lines policies (per ADR-013 pattern)
CREATE POLICY "production_lines_org_isolation" ON production_lines
  FOR SELECT USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

CREATE POLICY "production_lines_admin_write" ON production_lines
  FOR ALL USING (
    org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    AND EXISTS (
      SELECT 1 FROM users u
      JOIN roles r ON u.role_id = r.id
      WHERE u.id = auth.uid()
      AND r.code IN ('SUPER_ADMIN', 'ADMIN', 'PROD_MANAGER')
    )
  );

-- production_line_machines policies
CREATE POLICY "plm_org_isolation" ON production_line_machines
  FOR SELECT USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

CREATE POLICY "plm_admin_write" ON production_line_machines
  FOR ALL USING (
    org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    AND EXISTS (
      SELECT 1 FROM users u
      JOIN roles r ON u.role_id = r.id
      WHERE u.id = auth.uid()
      AND r.code IN ('SUPER_ADMIN', 'ADMIN', 'PROD_MANAGER')
    )
  );

-- production_line_products policies
CREATE POLICY "plp_org_isolation" ON production_line_products
  FOR SELECT USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

CREATE POLICY "plp_admin_write" ON production_line_products
  FOR ALL USING (
    org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    AND EXISTS (
      SELECT 1 FROM users u
      JOIN roles r ON u.role_id = r.id
      WHERE u.id = auth.uid()
      AND r.code IN ('SUPER_ADMIN', 'ADMIN', 'PROD_MANAGER')
    )
  );
```

### API Endpoints

| Method | Endpoint | Description | Request Body |
|--------|----------|-------------|--------------|
| GET | `/api/settings/production-lines` | List lines with filters | Query: `warehouse_id`, `status`, `search`, `page`, `limit` |
| GET | `/api/settings/production-lines/:id` | Get line detail with machines and products | - |
| POST | `/api/settings/production-lines` | Create line | `CreateProductionLineRequest` |
| PUT | `/api/settings/production-lines/:id` | Update line | `UpdateProductionLineRequest` |
| DELETE | `/api/settings/production-lines/:id` | Delete line (if no WOs) | - |
| GET | `/api/settings/production-lines/:id/machines` | Get machines with sequence | - |
| PUT | `/api/settings/production-lines/:id/machines` | Replace all machine assignments | `{ machine_ids: string[] }` |
| PATCH | `/api/settings/production-lines/:id/machines/reorder` | Reorder machines | `{ machine_orders: { machine_id: string, sequence_order: number }[] }` |
| GET | `/api/settings/production-lines/:id/products` | Get compatible products | - |
| PUT | `/api/settings/production-lines/:id/products` | Replace product compatibility | `{ product_ids: string[] }` |
| GET | `/api/settings/production-lines/validate-code` | Check code uniqueness | Query: `code` |

### Request/Response Schemas

```typescript
// GET /api/settings/production-lines response
interface ProductionLineListResponse {
  lines: ProductionLine[];
  total: number;
  page: number;
  limit: number;
}

interface ProductionLine {
  id: string;
  code: string;
  name: string;
  description: string | null;
  warehouse_id: string;
  warehouse: { id: string; code: string; name: string };
  default_output_location_id: string | null;
  status: 'active' | 'maintenance' | 'inactive' | 'setup';
  calculated_capacity: number | null;
  bottleneck_machine: { id: string; code: string; capacity: number } | null;
  machine_count: number;
  product_count: number;
  created_at: string;
  updated_at: string;
}

// POST /api/settings/production-lines request
interface CreateProductionLineRequest {
  code: string;
  name: string;
  description?: string;
  warehouse_id: string;
  default_output_location_id?: string;
  status?: 'active' | 'maintenance' | 'inactive' | 'setup';
  machine_ids?: string[];         // Initial machine assignments
  product_ids?: string[];         // Compatible products
}

// PUT /api/settings/production-lines/:id request
interface UpdateProductionLineRequest {
  code?: string;
  name?: string;
  description?: string;
  warehouse_id?: string;
  default_output_location_id?: string | null;
  status?: 'active' | 'maintenance' | 'inactive' | 'setup';
  machine_ids?: string[];         // Replace all assignments
  product_ids?: string[];         // Replace all compatibilities
}

// PATCH /api/settings/production-lines/:id/machines/reorder
interface ReorderMachinesRequest {
  machine_orders: Array<{
    machine_id: string;
    sequence_order: number;
  }>;
}

// GET /api/settings/production-lines/:id response (detail)
interface ProductionLineDetail extends ProductionLine {
  machines: Array<{
    id: string;
    code: string;
    name: string;
    status: string;
    capacity_per_hour: number | null;
    sequence_order: number;
  }>;
  compatible_products: Array<{
    id: string;
    code: string;
    name: string;
    category: string | null;
  }>;
}
```

### Service Layer

```typescript
// lib/services/production-line-service.ts

export class ProductionLineService {
  // CRUD Operations
  async listProductionLines(params: ListParams): Promise<ProductionLineListResult>;
  async getProductionLineById(id: string): Promise<ProductionLineDetail>;
  async createProductionLine(input: CreateProductionLineRequest): Promise<ProductionLine>;
  async updateProductionLine(id: string, input: UpdateProductionLineRequest): Promise<ProductionLine>;
  async deleteProductionLine(id: string): Promise<void>;

  // Machine Assignments (FR-SET-061, FR-SET-062)
  async getLineMachines(lineId: string): Promise<LineMachine[]>;
  async updateLineMachines(lineId: string, machineIds: string[]): Promise<void>;
  async reorderLineMachines(lineId: string, orders: MachineOrder[]): Promise<void>;

  // Product Compatibility (FR-SET-065)
  async getLineProducts(lineId: string): Promise<LineProduct[]>;
  async updateLineProducts(lineId: string, productIds: string[]): Promise<void>;

  // Capacity Calculation (FR-SET-063)
  async calculateLineCapacity(lineId: string): Promise<CapacityResult>;

  // Validation
  async validateCode(code: string, excludeId?: string): Promise<{ valid: boolean; error?: string }>;
  async canDelete(lineId: string): Promise<{ allowed: boolean; reason?: string }>;
}

// Capacity calculation logic
interface CapacityResult {
  capacity: number | null;
  bottleneck_machine_id: string | null;
  bottleneck_machine_code: string | null;
  machines_without_capacity: string[];
}

function calculateBottleneckCapacity(machines: LineMachine[]): CapacityResult {
  const machinesWithCapacity = machines.filter(m => m.capacity_per_hour !== null && m.capacity_per_hour > 0);

  if (machinesWithCapacity.length === 0) {
    return {
      capacity: null,
      bottleneck_machine_id: null,
      bottleneck_machine_code: null,
      machines_without_capacity: machines.map(m => m.code)
    };
  }

  const bottleneck = machinesWithCapacity.reduce((min, m) =>
    m.capacity_per_hour! < min.capacity_per_hour! ? m : min
  );

  return {
    capacity: bottleneck.capacity_per_hour,
    bottleneck_machine_id: bottleneck.id,
    bottleneck_machine_code: bottleneck.code,
    machines_without_capacity: machines.filter(m => !m.capacity_per_hour).map(m => m.code)
  };
}
```

### Zod Validation Schemas

```typescript
// lib/validation/production-line-schema.ts

export const productionLineCodeSchema = z
  .string()
  .min(2, "Code must be at least 2 characters")
  .max(50, "Code must be at most 50 characters")
  .regex(/^[A-Z0-9-]+$/, "Code must be uppercase letters, numbers, and hyphens only")
  .transform(v => v.toUpperCase());

export const productionLineStatusSchema = z.enum(['active', 'maintenance', 'inactive', 'setup']);

export const createProductionLineSchema = z.object({
  code: productionLineCodeSchema,
  name: z.string().min(1, "Name is required").max(100),
  description: z.string().max(500).optional(),
  warehouse_id: z.string().uuid("Invalid warehouse"),
  default_output_location_id: z.string().uuid().optional().nullable(),
  status: productionLineStatusSchema.default('active'),
  machine_ids: z.array(z.string().uuid()).optional(),
  product_ids: z.array(z.string().uuid()).optional(),
});

export const updateProductionLineSchema = z.object({
  code: productionLineCodeSchema.optional(),
  name: z.string().min(1).max(100).optional(),
  description: z.string().max(500).optional().nullable(),
  warehouse_id: z.string().uuid().optional(),
  default_output_location_id: z.string().uuid().optional().nullable(),
  status: productionLineStatusSchema.optional(),
  machine_ids: z.array(z.string().uuid()).optional(),
  product_ids: z.array(z.string().uuid()).optional(),
});

export const reorderMachinesSchema = z.object({
  machine_orders: z.array(z.object({
    machine_id: z.string().uuid(),
    sequence_order: z.number().int().positive(),
  })),
});
```

---

## UI Components

### File Structure

```
app/(authenticated)/settings/production-lines/
  page.tsx                          -- Line list page
  [id]/page.tsx                     -- Line detail page (tabs)

components/settings/production-lines/
  ProductionLineDataTable.tsx       -- List with sorting, filtering, pagination
  ProductionLineModal.tsx           -- Create/Edit modal (SET-019)
  ProductionLineRow.tsx             -- Single line row
  ProductionLineStatusBadge.tsx     -- Status indicator with color
  MachineSequenceEditor.tsx         -- Drag-drop machine list with sequence
  MachineSequenceItem.tsx           -- Draggable machine row with handle
  ProductCompatibilityEditor.tsx    -- Checkbox list with search
  ProductCheckboxRow.tsx            -- Product row with checkbox
  CapacityCalculatorDisplay.tsx     -- Shows calculated capacity + bottleneck
  DeleteLineConfirmDialog.tsx       -- Confirmation with WO check
```

### Key UI Behaviors

#### MachineSequenceEditor Component

```tsx
// Uses dnd-kit for drag-and-drop
// Renders ordered list with drag handles
// On drop: recalculates sequence_order for all items
// Shows machine code, name, status badge, capacity
// Remove button per item
// "Add Machine" dropdown at bottom

interface MachineSequenceEditorProps {
  machines: LineMachine[];
  availableMachines: Machine[];
  onChange: (machines: LineMachine[]) => void;
  maxMachines?: number; // Default 20
}
```

#### ProductCompatibilityEditor Component

```tsx
// Checkbox list with search
// Select All / Clear All buttons
// Shows product code, name, category
// Counter: "X products selected"
// Empty: "0 products selected (Line can run any product)"

interface ProductCompatibilityEditorProps {
  selectedProductIds: string[];
  allProducts: Product[];
  onChange: (productIds: string[]) => void;
}
```

#### CapacityCalculatorDisplay Component

```tsx
// Shows calculated capacity value
// Tooltip with bottleneck machine info
// Warning icon if machines missing capacity

interface CapacityDisplayProps {
  capacity: number | null;
  bottleneckMachine: { code: string; capacity: number } | null;
  machinesWithoutCapacity: string[];
}
```

---

## Out of Scope

| Feature | Reason | Future Story |
|---------|--------|--------------|
| Scheduling integration | Epic 3 | Planning module |
| OEE calculations | Epic 10 | OEE module |
| Real-time machine status | Epic 4 | Production module |
| Line templates | Phase 2 | Infrastructure |
| Import/export lines | Phase 3 | Utilities |
| Line capacity planning | Epic 3 | Planning module |
| Machine maintenance scheduling | Phase 2 | FR-SET-054 |

---

## Test Cases

### Unit Tests

| Test ID | Description | Expected Result |
|---------|-------------|-----------------|
| UT-01 | Create line with valid data | Line created, returns ID |
| UT-02 | Create line with duplicate code | Error: code must be unique |
| UT-03 | Calculate capacity with 3 machines | Returns minimum (bottleneck) |
| UT-04 | Calculate capacity with no machines | Returns null |
| UT-05 | Calculate capacity with one null | Excludes null, returns min of others |
| UT-06 | Reorder machines 1,2,3 -> 2,3,1 | Sequence updates correctly |
| UT-07 | Add product compatibility | Junction record created |
| UT-08 | Clear product compatibility | All junction records removed |
| UT-09 | Delete line with no WOs | Line deleted successfully |
| UT-10 | Delete line with active WOs | Error: has active WOs |
| UT-11 | Validate status transition | All status values accepted |

### Integration Tests

| Test ID | Description | Expected Result |
|---------|-------------|-----------------|
| IT-01 | GET /production-lines returns org-scoped data | Only current org lines |
| IT-02 | POST /production-lines with machine_ids | Line + assignments created |
| IT-03 | PUT /production-lines/:id updates machines | Old assignments removed, new added |
| IT-04 | PATCH /machines/reorder updates sequences | Sequences match request |
| IT-05 | PUT /products replaces compatibility | Junction table updated |
| IT-06 | RLS prevents cross-org access | 404 for other org lines |
| IT-07 | Non-admin cannot create/edit | 403 Forbidden |

### E2E Tests

| Test ID | Description | Expected Result |
|---------|-------------|-----------------|
| E2E-01 | Create line with 2 machines | Line appears in list with machine count 2 |
| E2E-02 | Drag machine to reorder | Sequence visually updates |
| E2E-03 | Search products, select 3, save | Compatibility saved |
| E2E-04 | Change status to Maintenance | Badge color changes |
| E2E-05 | Delete line (no WOs) | Line removed from list |
| E2E-06 | Filter by warehouse | Correct lines shown |

---

## Definition of Done

- [ ] Production line list page loads within 300ms for 50 lines
- [ ] Create line with code uniqueness validation works
- [ ] Edit line preserves machine sequence and products
- [ ] Delete line blocked if active WOs exist
- [ ] Machine assignment with drag-drop reorder functional
- [ ] Sequence numbers update correctly on reorder
- [ ] Capacity calculated as bottleneck (min of machines)
- [ ] Capacity tooltip shows bottleneck machine
- [ ] Status toggle updates immediately
- [ ] Inactive lines hidden from WO dropdowns
- [ ] Product compatibility editor with search works
- [ ] "Select All" respects search filter
- [ ] Empty compatibility = any product allowed
- [ ] WO creation validates product-line compatibility
- [ ] All API endpoints have integration tests
- [ ] Unit tests cover capacity calculation logic (>80%)
- [ ] E2E tests for create, reorder, delete flows
- [ ] RLS policies verified in tests
- [ ] SET-019 wireframe implemented
- [ ] Keyboard accessibility for drag-drop (arrow keys)
- [ ] Mobile responsive (modal scrolls)

---

## Risks

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| Drag-drop complexity | Medium | Medium | Use proven dnd-kit library |
| Sequence renumbering bugs | Medium | High | Comprehensive unit tests |
| Capacity calculation edge cases | Low | Medium | Handle null values explicitly |
| Product list performance | Low | Low | Pagination, virtual scroll if needed |
| RLS policy gaps | Low | High | Integration tests per policy |

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-12-16 | Initial story creation | ARCHITECT-AGENT |
