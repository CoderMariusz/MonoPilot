# 01.15 - Session & Password Management

**Story ID:** 01.15
**Epic:** 01 - Settings
**Phase:** 1A (MVP)
**Complexity:** M (Medium)
**Estimate:** 2-3 days
**Type:** Backend + Frontend
**State:** ready

**Primary PRD:** `docs/1-BASELINE/product/modules/settings.md` (FR-SET-013, FR-SET-014)
**UX Wireframes:** SET-015 (Active Sessions), SET-016 (Password Change)

## PRD References

| FR ID | Requirement | Priority | Phase | Covered |
|-------|-------------|----------|-------|---------|
| FR-SET-013 | Session Management | P0 | 1A | Yes |
| FR-SET-014 | Password Policies | P1 | 1A | Yes |

## User Story

**As a** user,
**I want** to manage my active sessions and set a secure password,
**So that** I can maintain control over my account security and ensure unauthorized access is prevented.

**As an** administrator,
**I want** to view and terminate user sessions,
**So that** I can respond to security incidents and manage user access across devices.

## Goal

Implement comprehensive session management and password policy enforcement to ensure account security. Users can view their active sessions, terminate sessions from other devices, and set passwords that meet security requirements. Password changes automatically invalidate other sessions for security.

## Scope

**In scope:**
- Session creation and tracking on login
- Configurable session timeout (default 24 hours)
- Active sessions list (device, IP, last activity)
- Terminate single session
- Terminate all sessions
- Auto-logout on password change
- Multi-device support
- Password complexity validation (8+ chars, uppercase, lowercase, number, special)
- Password history (cannot reuse last 5)
- Real-time password validation feedback
- Password expiry (optional, configurable)

**Out of scope:**
- MFA/2FA support (FR-SET-015, Phase 1B)
- User activity tracking (FR-SET-016, Phase 2)
- IP geolocation for sessions
- Device fingerprinting

## Dependencies

| Story | Requirement | Status |
|-------|-------------|--------|
| 01.1 | Org Context + Base RLS | Required - provides auth context |
| 01.6 | Role Permissions | Required - admin session termination |

## Acceptance Criteria (Given/When/Then)

### Session Management (FR-SET-013)

#### Session Creation
- GIVEN user logs in successfully, WHEN session created, THEN session token valid for 24 hours (default).
- GIVEN session created, WHEN session data stored, THEN device type, IP address, user agent, and timestamps are recorded.
- GIVEN user logs in from new device, WHEN session created, THEN previous sessions remain valid (multi-device support).
- GIVEN organization has custom timeout (e.g., 8 hours), WHEN user logs in, THEN session expires at configured timeout.

#### Session Timeout
- GIVEN user inactive for session timeout period, WHEN next request made, THEN redirect to login with "Session expired" message.
- GIVEN session timeout set to 8 hours, WHEN user inactive for 8 hours, THEN automatic logout on next interaction.
- GIVEN user makes API request, WHEN session valid, THEN `last_activity_at` timestamp updated.
- GIVEN session expires_at passed, WHEN API request made, THEN 401 Unauthorized returns with `SESSION_EXPIRED` code.

#### View Active Sessions
- GIVEN user is authenticated, WHEN they navigate to Security settings, THEN list of all active sessions displays.
- GIVEN user logged in on 3 devices, WHEN admin views user's sessions, THEN all 3 sessions display with device info.
- GIVEN active sessions list, WHEN rendered, THEN each session shows: device type, IP address, last activity, created at.
- GIVEN current session in list, WHEN displayed, THEN marked with "Current session" badge.
- GIVEN session list, WHEN sorted, THEN sessions ordered by last_activity_at descending (most recent first).

#### Terminate Single Session
- GIVEN user views session list, WHEN they click "Revoke" on a specific session, THEN confirmation dialog appears.
- GIVEN confirmation dialog, WHEN user confirms, THEN that session is invalidated immediately.
- GIVEN terminated session, WHEN device with that session makes request, THEN 401 Unauthorized returns.
- GIVEN user terminates session, WHEN list refreshes, THEN terminated session no longer appears.

#### Terminate All Sessions
- GIVEN admin clicks "Terminate All Sessions" for a user, WHEN confirmed, THEN all user sessions invalidated within 1 second.
- GIVEN user clicks "Logout All Devices", WHEN confirmed, THEN all sessions except current are terminated.
- GIVEN user clicks "Logout", WHEN logout completes, THEN current session token invalidated.
- GIVEN user with terminated session makes API request, WHEN request processed, THEN 401 Unauthorized returns.

#### Security: Password Change Session Handling
- GIVEN user changes password, WHEN password update completes, THEN all other sessions terminated (security).
- GIVEN user changes password, WHEN complete, THEN only current session remains active.
- GIVEN admin resets user password, WHEN complete, THEN all user sessions terminated.

### Password Policies (FR-SET-014)

#### Password Complexity
- GIVEN user sets password "abc", WHEN form submitted, THEN error "Password must be at least 8 characters" displays.
- GIVEN user sets password "abcdefgh", WHEN form submitted, THEN error "Password must contain at least one uppercase letter" displays.
- GIVEN user sets password "Abcdefgh", WHEN form submitted, THEN error "Password must contain at least one number" displays.
- GIVEN user sets password "Abcdefg1", WHEN form submitted, THEN error "Password must contain at least one special character" displays.
- GIVEN user sets password "Abcdefg1!", WHEN form submitted, THEN password accepted and saved.

#### Password History
- GIVEN user attempts to reuse one of last 5 passwords, WHEN form submitted, THEN error "Cannot reuse recent passwords" displays.
- GIVEN user changes password 6 times, WHEN attempting to use original password, THEN password accepted (rotated out of history).
- GIVEN new user, WHEN setting first password, THEN no history check (first password always accepted).

#### Real-Time Validation
- GIVEN real-time validation enabled, WHEN user types password, THEN checklist updates showing met/unmet requirements.
- GIVEN password field focused, WHEN requirements panel visible, THEN each requirement shows checkmark (green) or X (red).
- GIVEN all requirements met, WHEN requirements panel visible, THEN "Strong password" indicator displays.

#### Password Expiry (Optional)
- GIVEN password expires in 90 days (if enabled), WHEN user logs in after 90 days, THEN forced password change screen displays.
- GIVEN password expiry disabled (default), WHEN user logs in, THEN no expiry check performed.
- GIVEN forced password change screen, WHEN user sets new password, THEN redirected to original destination.
- GIVEN forced password change screen, WHEN user attempts to navigate away, THEN blocked until password changed.

#### Password Change Flow
- GIVEN user on change password form, WHEN form loads, THEN requires: current password, new password, confirm password.
- GIVEN new password entered, WHEN confirm password differs, THEN error "Passwords do not match" displays.
- GIVEN current password incorrect, WHEN form submitted, THEN error "Current password is incorrect" displays.
- GIVEN password change successful, WHEN complete, THEN success toast "Password changed successfully" displays.

### Admin Session Management
- GIVEN admin views user detail, WHEN sessions tab clicked, THEN all user sessions display.
- GIVEN admin with SUPER_ADMIN or ADMIN role, WHEN viewing user sessions, THEN "Terminate All" button visible.
- GIVEN admin terminates user sessions, WHEN confirmed, THEN audit log entry created.
- GIVEN non-admin user, WHEN attempting to view other user sessions, THEN 403 Forbidden returns.

### Multi-tenancy
- GIVEN User A from Org A, WHEN requesting sessions, THEN only Org A sessions returned.
- GIVEN User A from Org A, WHEN attempting to terminate Org B session, THEN 404 Not Found returns (not 403).

## Technical Specification

### Database Schema

#### user_sessions table

```sql
CREATE TABLE user_sessions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,

  -- Session identification
  session_token VARCHAR(255) UNIQUE NOT NULL,
  refresh_token VARCHAR(255) UNIQUE,

  -- Device information
  device_type VARCHAR(50) NOT NULL DEFAULT 'browser', -- 'browser', 'mobile', 'api'
  device_name VARCHAR(255), -- 'Chrome on Windows', 'Safari on iPhone'
  ip_address INET NOT NULL,
  user_agent TEXT,

  -- Timestamps
  created_at TIMESTAMPTZ DEFAULT NOW(),
  last_activity_at TIMESTAMPTZ DEFAULT NOW(),
  expires_at TIMESTAMPTZ NOT NULL,
  revoked_at TIMESTAMPTZ,

  -- Revocation tracking
  revoked_by UUID REFERENCES users(id),
  revocation_reason VARCHAR(100), -- 'user_logout', 'admin_terminate', 'password_change', 'timeout'

  -- Indexes
  CONSTRAINT user_sessions_user_id_idx UNIQUE (user_id, session_token)
);

-- Indexes for performance
CREATE INDEX idx_user_sessions_user_id ON user_sessions(user_id);
CREATE INDEX idx_user_sessions_org_id ON user_sessions(org_id);
CREATE INDEX idx_user_sessions_expires_at ON user_sessions(expires_at);
CREATE INDEX idx_user_sessions_token ON user_sessions(session_token);
CREATE INDEX idx_user_sessions_active ON user_sessions(user_id) WHERE revoked_at IS NULL;

-- Cleanup: Auto-delete sessions older than 90 days (via cron job or scheduled function)
```

#### password_history table

```sql
CREATE TABLE password_history (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  password_hash VARCHAR(255) NOT NULL, -- Hashed password (bcrypt/argon2)
  created_at TIMESTAMPTZ DEFAULT NOW(),

  -- Indexes
  CONSTRAINT password_history_user_idx UNIQUE (user_id, password_hash)
);

-- Index for lookup
CREATE INDEX idx_password_history_user_id ON password_history(user_id);

-- Cleanup function to keep only last 5
CREATE OR REPLACE FUNCTION maintain_password_history()
RETURNS TRIGGER AS $$
BEGIN
  DELETE FROM password_history
  WHERE user_id = NEW.user_id
  AND id NOT IN (
    SELECT id FROM password_history
    WHERE user_id = NEW.user_id
    ORDER BY created_at DESC
    LIMIT 5
  );
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER password_history_cleanup
AFTER INSERT ON password_history
FOR EACH ROW EXECUTE FUNCTION maintain_password_history();
```

#### organization_settings extension

```sql
-- Add session and password settings to organization
ALTER TABLE organizations ADD COLUMN IF NOT EXISTS
  session_timeout_hours INTEGER DEFAULT 24 CHECK (session_timeout_hours >= 1 AND session_timeout_hours <= 720);

ALTER TABLE organizations ADD COLUMN IF NOT EXISTS
  password_expiry_days INTEGER DEFAULT NULL CHECK (password_expiry_days IS NULL OR password_expiry_days >= 30);

ALTER TABLE organizations ADD COLUMN IF NOT EXISTS
  enforce_password_history BOOLEAN DEFAULT true;
```

#### users table extension

```sql
-- Add password-related fields to users
ALTER TABLE users ADD COLUMN IF NOT EXISTS
  password_changed_at TIMESTAMPTZ DEFAULT NOW();

ALTER TABLE users ADD COLUMN IF NOT EXISTS
  password_expires_at TIMESTAMPTZ;

ALTER TABLE users ADD COLUMN IF NOT EXISTS
  force_password_change BOOLEAN DEFAULT false;
```

### RLS Policies

```sql
-- user_sessions: Users can see their own sessions, admins can see org sessions
CREATE POLICY "sessions_own_read" ON user_sessions
FOR SELECT USING (
  user_id = auth.uid()
  OR (
    org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    AND (SELECT r.code FROM roles r JOIN users u ON u.role_id = r.id WHERE u.id = auth.uid()) IN ('SUPER_ADMIN', 'ADMIN')
  )
);

CREATE POLICY "sessions_own_delete" ON user_sessions
FOR DELETE USING (
  user_id = auth.uid()
  OR (
    org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    AND (SELECT r.code FROM roles r JOIN users u ON u.role_id = r.id WHERE u.id = auth.uid()) IN ('SUPER_ADMIN', 'ADMIN')
  )
);

CREATE POLICY "sessions_insert" ON user_sessions
FOR INSERT WITH CHECK (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
);

-- password_history: Only system can read/write (via service role)
-- No direct user access - handled through backend service
CREATE POLICY "password_history_none" ON password_history
FOR ALL USING (false);
```

### API Endpoints

```
# Session Management
GET    /api/v1/settings/sessions                    - List user's own active sessions
GET    /api/v1/settings/sessions/current            - Get current session details
DELETE /api/v1/settings/sessions/:id                - Terminate specific session
DELETE /api/v1/settings/sessions                    - Terminate all sessions except current
POST   /api/v1/settings/sessions/terminate-all      - Terminate all sessions (including current = logout)

# Admin Session Management
GET    /api/v1/settings/users/:userId/sessions      - List user's sessions (admin only)
DELETE /api/v1/settings/users/:userId/sessions      - Terminate all user sessions (admin only)

# Password Management
POST   /api/v1/settings/password/change             - Change own password
POST   /api/v1/settings/password/validate           - Validate password strength (no auth required)
GET    /api/v1/settings/password/policy             - Get password policy config

# Admin Password Management
POST   /api/v1/settings/users/:userId/password/reset - Force password reset (admin only)
```

### Service Methods

**Location:** `lib/services/session-service.ts`

```typescript
interface SessionService {
  // Session CRUD
  createSession(userId: string, deviceInfo: DeviceInfo): Promise<Session>;
  getSession(sessionToken: string): Promise<Session | null>;
  getSessions(userId: string): Promise<Session[]>;
  getCurrentSession(sessionToken: string): Promise<Session | null>;

  // Session termination
  terminateSession(sessionId: string, reason: string): Promise<void>;
  terminateAllSessions(userId: string, exceptCurrent?: string): Promise<number>;
  terminateSessionsByUser(userId: string): Promise<number>; // Admin use

  // Session validation
  validateSession(sessionToken: string): Promise<SessionValidation>;
  refreshSession(sessionToken: string): Promise<Session>;
  updateLastActivity(sessionId: string): Promise<void>;

  // Helpers
  parseUserAgent(userAgent: string): DeviceInfo;
  isSessionExpired(session: Session): boolean;
}

interface DeviceInfo {
  device_type: 'browser' | 'mobile' | 'api';
  device_name: string;
  ip_address: string;
  user_agent: string;
}

interface Session {
  id: string;
  user_id: string;
  org_id: string;
  device_type: string;
  device_name: string;
  ip_address: string;
  created_at: string;
  last_activity_at: string;
  expires_at: string;
  is_current?: boolean;
}

interface SessionValidation {
  valid: boolean;
  expired: boolean;
  revoked: boolean;
  session?: Session;
}
```

**Location:** `lib/services/password-service.ts`

```typescript
interface PasswordService {
  // Password operations
  changePassword(userId: string, currentPassword: string, newPassword: string): Promise<void>;
  validatePassword(password: string): PasswordValidationResult;
  checkPasswordHistory(userId: string, password: string): Promise<boolean>;

  // Password policy
  getPasswordPolicy(orgId: string): Promise<PasswordPolicy>;
  isPasswordExpired(user: User): boolean;

  // Admin operations
  forcePasswordReset(userId: string, adminId: string): Promise<void>;

  // Internal
  hashPassword(password: string): Promise<string>;
  verifyPassword(password: string, hash: string): Promise<boolean>;
  addToHistory(userId: string, passwordHash: string): Promise<void>;
}

interface PasswordValidationResult {
  valid: boolean;
  errors: string[];
  requirements: {
    minLength: { met: boolean; message: string };
    uppercase: { met: boolean; message: string };
    lowercase: { met: boolean; message: string };
    number: { met: boolean; message: string };
    special: { met: boolean; message: string };
  };
  strength: 'weak' | 'medium' | 'strong';
}

interface PasswordPolicy {
  min_length: number;
  require_uppercase: boolean;
  require_lowercase: boolean;
  require_number: boolean;
  require_special: boolean;
  history_count: number;
  expiry_days: number | null;
}
```

### Zod Validation Schemas

**Location:** `lib/validation/session.ts`

```typescript
import { z } from 'zod';

// Session response schema
export const sessionSchema = z.object({
  id: z.string().uuid(),
  user_id: z.string().uuid(),
  device_type: z.enum(['browser', 'mobile', 'api']),
  device_name: z.string().nullable(),
  ip_address: z.string(),
  created_at: z.string().datetime(),
  last_activity_at: z.string().datetime(),
  expires_at: z.string().datetime(),
  is_current: z.boolean().optional(),
});

export const sessionsListSchema = z.array(sessionSchema);

// Terminate session request
export const terminateSessionSchema = z.object({
  session_id: z.string().uuid(),
});

export const terminateAllSessionsSchema = z.object({
  except_current: z.boolean().default(true),
});
```

**Location:** `lib/validation/password.ts`

```typescript
import { z } from 'zod';

// Password complexity regex patterns
const PASSWORD_PATTERNS = {
  uppercase: /[A-Z]/,
  lowercase: /[a-z]/,
  number: /[0-9]/,
  special: /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/,
};

// Password schema with comprehensive validation
export const passwordSchema = z.string()
  .min(8, 'Password must be at least 8 characters')
  .refine(
    (val) => PASSWORD_PATTERNS.uppercase.test(val),
    'Password must contain at least one uppercase letter'
  )
  .refine(
    (val) => PASSWORD_PATTERNS.lowercase.test(val),
    'Password must contain at least one lowercase letter'
  )
  .refine(
    (val) => PASSWORD_PATTERNS.number.test(val),
    'Password must contain at least one number'
  )
  .refine(
    (val) => PASSWORD_PATTERNS.special.test(val),
    'Password must contain at least one special character (!@#$%^&*)'
  );

// Change password request
export const changePasswordSchema = z.object({
  current_password: z.string().min(1, 'Current password is required'),
  new_password: passwordSchema,
  confirm_password: z.string(),
}).refine(
  (data) => data.new_password === data.confirm_password,
  { message: 'Passwords do not match', path: ['confirm_password'] }
);

// Validate password request (no auth, for real-time validation)
export const validatePasswordSchema = z.object({
  password: z.string(),
});

// Password policy response
export const passwordPolicySchema = z.object({
  min_length: z.number(),
  require_uppercase: z.boolean(),
  require_lowercase: z.boolean(),
  require_number: z.boolean(),
  require_special: z.boolean(),
  history_count: z.number(),
  expiry_days: z.number().nullable(),
});
```

## UI Components

### Pages

- `app/(authenticated)/settings/security/page.tsx` - Security settings page (sessions + password)
- `app/(authenticated)/settings/security/sessions/page.tsx` - Active sessions (optional separate page)

### Components

**Location:** `components/settings/security/`

```
ActiveSessionsList.tsx       - List of active sessions with actions
SessionCard.tsx              - Individual session display card
TerminateSessionDialog.tsx   - Confirmation dialog for session termination
TerminateAllSessionsDialog.tsx - Confirmation for bulk termination
ChangePasswordForm.tsx       - Password change form with validation
PasswordRequirements.tsx     - Real-time password requirements checklist
PasswordStrengthIndicator.tsx - Visual strength meter
ForcePasswordChangeModal.tsx - Modal for expired password
```

### Component Details

**ActiveSessionsList.tsx**
```tsx
interface ActiveSessionsListProps {
  sessions: Session[];
  currentSessionId: string;
  onTerminate: (sessionId: string) => void;
  onTerminateAll: () => void;
  isLoading: boolean;
}
```

**ChangePasswordForm.tsx**
```tsx
interface ChangePasswordFormProps {
  onSuccess: () => void;
  forceChange?: boolean; // For expired password flow
}

// Form fields:
// - Current password (type="password")
// - New password (type="password") with PasswordRequirements
// - Confirm password (type="password")
// - Submit button
```

**PasswordRequirements.tsx**
```tsx
interface PasswordRequirementsProps {
  password: string;
  showStrength?: boolean;
}

// Displays:
// [x] At least 8 characters
// [x] One uppercase letter
// [x] One lowercase letter
// [x] One number
// [x] One special character (!@#$%^&*)
//
// Strength: Strong
```

### UI Patterns

**Session Card Layout:**
```
+------------------------------------------+
| Chrome on Windows              [Current] |
| IP: 192.168.1.100                        |
| Last active: 2 minutes ago               |
| Started: Dec 15, 2024, 10:30 AM          |
|                              [Revoke]    |
+------------------------------------------+
```

**Password Requirements Checklist:**
```
Password Requirements:
[x] At least 8 characters
[x] One uppercase letter (A-Z)
[x] One lowercase letter (a-z)
[ ] One number (0-9)
[ ] One special character (!@#$%^&*)

Strength: [====----] Medium
```

## Test Cases

### Unit Tests

**session-service.test.ts**
```typescript
describe('SessionService', () => {
  describe('createSession', () => {
    it('creates session with correct expiry based on org settings');
    it('parses user agent into device info correctly');
    it('stores IP address from request');
  });

  describe('terminateSession', () => {
    it('marks session as revoked with reason');
    it('prevents already revoked session from being revoked again');
  });

  describe('terminateAllSessions', () => {
    it('terminates all sessions except current when specified');
    it('terminates all sessions including current');
    it('returns count of terminated sessions');
  });

  describe('validateSession', () => {
    it('returns valid=true for active session');
    it('returns expired=true for timed out session');
    it('returns revoked=true for terminated session');
  });
});
```

**password-service.test.ts**
```typescript
describe('PasswordService', () => {
  describe('validatePassword', () => {
    it('rejects password under 8 characters');
    it('rejects password without uppercase');
    it('rejects password without lowercase');
    it('rejects password without number');
    it('rejects password without special character');
    it('accepts valid password meeting all requirements');
    it('calculates strength correctly');
  });

  describe('checkPasswordHistory', () => {
    it('rejects password in last 5 history');
    it('accepts password not in history');
    it('accepts any password for new user');
  });

  describe('changePassword', () => {
    it('verifies current password before change');
    it('rejects if current password wrong');
    it('adds old password to history');
    it('terminates other sessions after change');
  });
});
```

### Integration Tests

**session-api.test.ts**
```typescript
describe('Session API', () => {
  describe('GET /api/v1/settings/sessions', () => {
    it('returns only own sessions');
    it('marks current session correctly');
    it('returns 401 for unauthenticated');
  });

  describe('DELETE /api/v1/settings/sessions/:id', () => {
    it('terminates own session successfully');
    it('returns 404 for other user session');
    it('admin can terminate user session in same org');
    it('admin cannot terminate session in other org');
  });

  describe('DELETE /api/v1/settings/users/:userId/sessions', () => {
    it('admin can terminate all user sessions');
    it('non-admin gets 403');
    it('creates audit log entry');
  });
});
```

**password-api.test.ts**
```typescript
describe('Password API', () => {
  describe('POST /api/v1/settings/password/change', () => {
    it('changes password with valid data');
    it('rejects incorrect current password');
    it('rejects weak new password');
    it('rejects password in history');
    it('terminates other sessions after change');
  });

  describe('POST /api/v1/settings/password/validate', () => {
    it('returns validation results without auth');
    it('returns requirement status for each rule');
    it('returns strength calculation');
  });
});
```

### E2E Tests

**session-management.spec.ts**
```typescript
describe('Session Management', () => {
  it('displays active sessions list');
  it('shows current session badge');
  it('terminates single session with confirmation');
  it('terminates all sessions with confirmation');
  it('redirects to login after current session terminated');
});
```

**password-change.spec.ts**
```typescript
describe('Password Change', () => {
  it('displays password requirements in real-time');
  it('shows checkmarks as requirements met');
  it('shows strength indicator');
  it('prevents submission until all requirements met');
  it('shows success message after change');
  it('logs out other devices after change');
});
```

## Security Considerations

1. **Session Token Security**
   - Use cryptographically secure random tokens (32+ bytes)
   - Store hashed tokens in database
   - Transmit only via HTTPS
   - Use HttpOnly, Secure, SameSite cookies

2. **Password Security**
   - Hash with bcrypt (cost factor 12) or Argon2id
   - Never log or expose passwords
   - Rate limit password attempts
   - Constant-time comparison for password verification

3. **Audit Trail**
   - Log all session terminations with actor
   - Log password changes (not the password)
   - Log failed password attempts

4. **Rate Limiting**
   - Max 5 failed password attempts per 15 minutes
   - Max 10 session terminations per hour

## Deliverables

- [ ] `user_sessions` table migration
- [ ] `password_history` table migration
- [ ] Organizations table extension (timeout, expiry settings)
- [ ] Users table extension (password_changed_at, etc.)
- [ ] RLS policies for sessions and password_history
- [ ] Session service (`lib/services/session-service.ts`)
- [ ] Password service (`lib/services/password-service.ts`)
- [ ] Zod schemas (`lib/validation/session.ts`, `lib/validation/password.ts`)
- [ ] API routes for session management
- [ ] API routes for password management
- [ ] ActiveSessionsList component
- [ ] SessionCard component
- [ ] TerminateSessionDialog component
- [ ] ChangePasswordForm component
- [ ] PasswordRequirements component
- [ ] PasswordStrengthIndicator component
- [ ] Security settings page
- [ ] Unit tests (>90% coverage - security critical)
- [ ] Integration tests
- [ ] E2E tests

## Definition of Done

- [ ] Sessions created on login with correct device info and expiry
- [ ] Session timeout configurable per organization (default 24h)
- [ ] Active sessions list displays all user sessions
- [ ] Current session correctly identified and badged
- [ ] Single session termination works with confirmation
- [ ] "Terminate All" terminates all sessions except current
- [ ] Terminated sessions return 401 on next request
- [ ] Password change terminates all other sessions
- [ ] Password validation enforces all complexity requirements
- [ ] Real-time password requirements checklist works
- [ ] Password strength indicator displays correctly
- [ ] Password history prevents reuse of last 5 passwords
- [ ] Admins can view and terminate user sessions
- [ ] Non-admins cannot view other users' sessions
- [ ] Cross-tenant session access returns 404 (not 403)
- [ ] Audit log entries created for security actions
- [ ] Rate limiting prevents brute force attacks
- [ ] Unit test coverage >= 90% (security critical)
- [ ] Integration tests pass
- [ ] E2E tests pass
- [ ] Security review completed
