# 01.18 - Security Policies

**Story ID:** 01.18
**Epic:** 01 - Settings
**Phase:** 1B (Polish)
**Complexity:** M (Medium)
**Estimate:** 1-2 days
**Type:** Backend + Frontend
**State:** ready

**Primary PRD:** `docs/1-BASELINE/product/modules/settings.md` (FR-SET-171, FR-SET-172, FR-SET-173)
**UX Wireframes:** SET-026-security-settings.md

## PRD References

| FR ID | Requirement | Priority | Phase | Covered |
|-------|-------------|----------|-------|---------|
| FR-SET-171 | Session Timeout Configuration | P1 | 1B | Yes |
| FR-SET-172 | Password Complexity Rules | P1 | 1B | Yes |
| FR-SET-173 | Failed Login Attempt Limits | P1 | 1B | Yes |

## User Story

**As an** administrator,
**I want** to configure organization-wide security policies for session timeout, password complexity, and failed login protection,
**So that** I can enforce security standards appropriate for my organization's risk profile.

## Goal

Implement configurable security policies at the organization level. Administrators can set session timeout duration, password complexity requirements, and failed login lockout settings. These policies are enforced on user login and password changes.

## Scope

**In scope:**
- Session timeout configuration (1h, 4h, 8h, 24h, Never)
- Password complexity rules (min length 8-16, uppercase/lowercase/number/special toggles)
- Failed login attempt limits (default 5)
- Lockout duration configuration (15, 30, 60 min)
- Email notification on account lockout
- Security policies stored in organizations table as JSONB

**Out of scope:**
- 2FA enforcement (separate story)
- IP whitelist management (Phase 2)
- GDPR compliance features (Phase 3)
- Active sessions management (covered in 01.15)

## Dependencies

| Story | Requirement | Status |
|-------|-------------|--------|
| 01.1 | Org Context + Base RLS | Required - provides auth context |
| 01.6 | Role Permissions | Required - admin-only access |
| 01.15 | Session & Password Management | Required - provides session/password tables |

## Acceptance Criteria (Given/When/Then)

### Session Timeout Configuration (FR-SET-171)

- GIVEN admin navigates to security settings, WHEN timeout options viewed, THEN options display: 1h, 4h, 8h, 24h, Never.
- GIVEN timeout set to 8 hours, WHEN user inactive for 8 hours, THEN session expires on next request.
- GIVEN timeout set to 24 hours (default), WHEN user active within 24 hours, THEN session remains valid.
- GIVEN timeout changed from 24h to 1h, WHEN existing sessions checked, THEN existing sessions use old timeout until refresh.
- GIVEN "Never" selected, WHEN configuration saved, THEN warning "Sessions will never expire. This is not recommended." displays.
- GIVEN session expired, WHEN user makes request, THEN redirect to login with "Session expired" message.

### Password Complexity Rules (FR-SET-172)

- GIVEN admin navigates to security settings, WHEN password rules viewed, THEN current requirements display.
- GIVEN minimum length set to 12, WHEN user creates 8-character password, THEN error "Password must be at least 12 characters" displays.
- GIVEN "require special character" enabled, WHEN password without special char submitted, THEN error displays.
- GIVEN password complexity increased, WHEN existing users login, THEN no immediate impact (enforced on password change only).
- GIVEN password rules changed, WHEN next password reset, THEN new rules enforced.
- GIVEN rules allow minimum 8 chars, WHEN admin sets minimum to 6, THEN warning "Minimum 8 characters recommended for security" displays.

### Failed Login Attempt Limits (FR-SET-173)

- GIVEN failed attempt limit set to 5, WHEN 5 incorrect passwords entered, THEN account locked for configured duration.
- GIVEN account locked, WHEN correct password entered, THEN error "Account temporarily locked. Try again in X minutes" displays.
- GIVEN account locked, WHEN lockout duration passes, THEN account unlocks automatically.
- GIVEN account locked, WHEN admin manually unlocks, THEN user can login immediately.
- GIVEN failed attempt occurred, WHEN correct password entered before limit, THEN login succeeds and counter resets.
- GIVEN lockout notification enabled, WHEN account locked, THEN email sent to user "Your account has been temporarily locked".
- GIVEN admin views user, WHEN user is locked, THEN "Locked" status and "Unlock" button display.

## Technical Specification

### Database Schema

#### organizations table extension

```sql
-- Add security_policies JSONB column to organizations
ALTER TABLE organizations ADD COLUMN IF NOT EXISTS security_policies JSONB DEFAULT '{
  "session_timeout_hours": 24,
  "password_min_length": 8,
  "password_require_uppercase": true,
  "password_require_lowercase": true,
  "password_require_number": true,
  "password_require_special": true,
  "failed_login_limit": 5,
  "lockout_duration_minutes": 15,
  "notify_user_on_lockout": true
}'::jsonb;

-- Add constraint to validate JSONB structure
ALTER TABLE organizations ADD CONSTRAINT security_policies_valid CHECK (
  security_policies IS NULL OR (
    (security_policies->>'session_timeout_hours')::int BETWEEN 1 AND 720 OR
    security_policies->>'session_timeout_hours' = 'never'
  ) AND
  (security_policies->>'password_min_length')::int BETWEEN 8 AND 16 AND
  (security_policies->>'failed_login_limit')::int BETWEEN 3 AND 15 AND
  (security_policies->>'lockout_duration_minutes')::int BETWEEN 15 AND 120
);
```

#### users table extension

```sql
-- Add lockout tracking fields to users
ALTER TABLE users ADD COLUMN IF NOT EXISTS failed_login_count INTEGER DEFAULT 0;
ALTER TABLE users ADD COLUMN IF NOT EXISTS locked_until TIMESTAMPTZ;
ALTER TABLE users ADD COLUMN IF NOT EXISTS last_failed_login_at TIMESTAMPTZ;
```

### API Endpoints

```
# Security Policies Management
GET    /api/v1/settings/security/policies    - Get current security policies
PUT    /api/v1/settings/security/policies    - Update security policies (admin only)

# User Lockout Management (Admin)
GET    /api/v1/settings/users/:userId/lockout-status   - Get user lockout status
POST   /api/v1/settings/users/:userId/unlock           - Manually unlock user
```

### Request/Response Schemas

**GET /api/v1/settings/security/policies**
```json
{
  "session_timeout_hours": 24,
  "password_min_length": 8,
  "password_require_uppercase": true,
  "password_require_lowercase": true,
  "password_require_number": true,
  "password_require_special": true,
  "failed_login_limit": 5,
  "lockout_duration_minutes": 15,
  "notify_user_on_lockout": true
}
```

**PUT /api/v1/settings/security/policies**
```json
{
  "session_timeout_hours": 8,
  "password_min_length": 12,
  "password_require_uppercase": true,
  "password_require_lowercase": true,
  "password_require_number": true,
  "password_require_special": true,
  "failed_login_limit": 5,
  "lockout_duration_minutes": 30,
  "notify_user_on_lockout": true
}
```

### Service Methods

**Location:** `lib/services/security-policy-service.ts`

```typescript
interface SecurityPolicyService {
  // Policy CRUD
  getPolicies(orgId: string): Promise<SecurityPolicies>;
  updatePolicies(orgId: string, policies: Partial<SecurityPolicies>): Promise<SecurityPolicies>;

  // Validation
  validateSessionTimeout(timeoutHours: number | 'never'): boolean;
  validatePasswordPolicy(policy: PasswordPolicy): ValidationResult;

  // Lockout management
  recordFailedLogin(userId: string): Promise<LockoutStatus>;
  resetFailedLoginCount(userId: string): Promise<void>;
  isUserLocked(userId: string): Promise<boolean>;
  unlockUser(userId: string, adminId: string): Promise<void>;
  getLockoutStatus(userId: string): Promise<LockoutStatus>;

  // Notification
  sendLockoutNotification(userId: string): Promise<void>;
}

interface SecurityPolicies {
  session_timeout_hours: number | 'never';
  password_min_length: number;
  password_require_uppercase: boolean;
  password_require_lowercase: boolean;
  password_require_number: boolean;
  password_require_special: boolean;
  failed_login_limit: number;
  lockout_duration_minutes: number;
  notify_user_on_lockout: boolean;
}

interface LockoutStatus {
  is_locked: boolean;
  failed_attempts: number;
  locked_until: string | null;
  can_retry_at: string | null;
  minutes_remaining: number | null;
}
```

### Zod Validation Schemas

**Location:** `lib/validation/security-policy.ts`

```typescript
import { z } from 'zod';

export const securityPoliciesSchema = z.object({
  session_timeout_hours: z.union([
    z.number().int().min(1).max(720),
    z.literal('never')
  ]).default(24),
  password_min_length: z.number().int().min(8).max(16).default(8),
  password_require_uppercase: z.boolean().default(true),
  password_require_lowercase: z.boolean().default(true),
  password_require_number: z.boolean().default(true),
  password_require_special: z.boolean().default(true),
  failed_login_limit: z.number().int().min(3).max(15).default(5),
  lockout_duration_minutes: z.number().int().min(15).max(120).default(15),
  notify_user_on_lockout: z.boolean().default(true),
});

export const updateSecurityPoliciesSchema = securityPoliciesSchema.partial();

export const lockoutStatusSchema = z.object({
  is_locked: z.boolean(),
  failed_attempts: z.number(),
  locked_until: z.string().datetime().nullable(),
  can_retry_at: z.string().datetime().nullable(),
  minutes_remaining: z.number().nullable(),
});
```

## UI Components

### Pages

- `app/(authenticated)/settings/security/policies/page.tsx` - Security policies configuration

### Components

**Location:** `components/settings/security/`

```
SecurityPoliciesForm.tsx       - Main form for all security policies
SessionTimeoutSelect.tsx       - Dropdown for session timeout
PasswordPolicySection.tsx      - Password complexity configuration
FailedLoginSection.tsx         - Lockout settings configuration
LockoutWarningBanner.tsx       - Warning when "Never" timeout selected
```

### Component Details

**SecurityPoliciesForm.tsx**
```tsx
interface SecurityPoliciesFormProps {
  policies: SecurityPolicies;
  onSave: (policies: SecurityPolicies) => Promise<void>;
  isLoading: boolean;
}

// Form sections:
// - Session Timeout (select: 1h, 4h, 8h, 24h, Never)
// - Password Policy (min length select, 4 requirement checkboxes)
// - Failed Login Protection (limit select, duration select, notification toggle)
// - Save button
```

**SessionTimeoutSelect.tsx**
```tsx
interface SessionTimeoutSelectProps {
  value: number | 'never';
  onChange: (value: number | 'never') => void;
  showWarning?: boolean;
}

// Options: 1 hour, 4 hours, 8 hours, 24 hours (default), Never
// Shows warning banner when "Never" selected
```

## Test Cases

### Unit Tests

**security-policy-service.test.ts**
```typescript
describe('SecurityPolicyService', () => {
  describe('validateSessionTimeout', () => {
    it('accepts valid timeout values (1-720)');
    it('accepts "never" as valid value');
    it('rejects invalid timeout values');
  });

  describe('recordFailedLogin', () => {
    it('increments failed login count');
    it('locks account when limit reached');
    it('sends notification if enabled');
  });

  describe('isUserLocked', () => {
    it('returns true when locked_until is in future');
    it('returns false when lockout expired');
    it('auto-resets count when lockout expires');
  });

  describe('unlockUser', () => {
    it('clears locked_until and failed_login_count');
    it('creates audit log entry');
  });
});
```

### Integration Tests

**security-policies-api.test.ts**
```typescript
describe('Security Policies API', () => {
  describe('GET /api/v1/settings/security/policies', () => {
    it('returns current policies for org');
    it('returns default policies if none set');
    it('requires admin role');
  });

  describe('PUT /api/v1/settings/security/policies', () => {
    it('updates policies successfully');
    it('validates min password length >= 8');
    it('validates lockout duration >= 15 minutes');
    it('creates audit log entry');
    it('rejects non-admin users');
  });

  describe('POST /api/v1/settings/users/:userId/unlock', () => {
    it('unlocks user account');
    it('resets failed login count');
    it('requires admin role');
    it('creates audit log entry');
  });
});
```

### E2E Tests

**security-policies.spec.ts**
```typescript
describe('Security Policies', () => {
  it('displays current security policies');
  it('updates session timeout with warning for "Never"');
  it('updates password complexity requirements');
  it('updates failed login protection settings');
  it('shows success toast on save');
});
```

## Deliverables

- [ ] Organizations table migration (security_policies JSONB column)
- [ ] Users table migration (lockout fields)
- [ ] Security policy service (`lib/services/security-policy-service.ts`)
- [ ] Zod schemas (`lib/validation/security-policy.ts`)
- [ ] API route: GET /api/v1/settings/security/policies
- [ ] API route: PUT /api/v1/settings/security/policies
- [ ] API route: POST /api/v1/settings/users/:userId/unlock
- [ ] SecurityPoliciesForm component
- [ ] SessionTimeoutSelect component
- [ ] PasswordPolicySection component
- [ ] FailedLoginSection component
- [ ] Integration with login flow (check lockout)
- [ ] Integration with password change (check policy)
- [ ] Unit tests (>85% coverage)
- [ ] Integration tests
- [ ] E2E tests

## Definition of Done

- [ ] Security policies stored in organizations.security_policies JSONB
- [ ] Session timeout configurable (1h, 4h, 8h, 24h, Never) with warning for "Never"
- [ ] Password policy configurable (min length 8-16, complexity toggles)
- [ ] Failed login limit configurable (3-15 attempts, default 5)
- [ ] Lockout duration configurable (15-120 minutes, default 15)
- [ ] Account locks after reaching failed login limit
- [ ] Account auto-unlocks after lockout duration
- [ ] Admin can manually unlock accounts
- [ ] Email notification sent on lockout (if enabled)
- [ ] Login flow checks and enforces lockout
- [ ] Password change enforces current policy
- [ ] Audit log entries for policy changes and manual unlocks
- [ ] Only admins can view/edit security policies
- [ ] Unit test coverage >= 85%
- [ ] Integration tests pass
- [ ] E2E tests pass
