# 01.5a - User Management CRUD (MVP)

---

## üöß V2 MIGRATION - REFACTOR (Add Actions Menu)

**‚ö†Ô∏è V1 has inline buttons, v2 needs Actions menu [‚ãÆ] + 10 PRD roles**

### **Build Location:**
```
‚úÖ CREATE: apps/frontend/app/(authenticated)/settings-v2/users/
‚úÖ CREATE: apps/frontend/components/settings-v2/users/
‚ùå DO NOT EDIT: app/(authenticated)/settings/users/ (v1 frozen)
```

### **What to Keep from V1:**
- ‚úÖ **Tabs pattern** (Users + Invitations) - GOOD addition, keep it!

### **What to Change:**
- Replace: Inline buttons (Edit, Delete) ‚Üí Actions menu [‚ãÆ]
- Replace: Simplified roles (admin/manager) ‚Üí 10 PRD roles (Super Admin, Production Manager, etc.)
- Add: Activity Log panel, Change Role modal

### **Your Resources:**
- **Handoff:** `docs/2-MANAGEMENT/epics/current/01-settings/agent-handoffs/04-users-actions-menu.yaml`
- **Wireframes:** `SET-008-user-list.md`, `SET-009-user-create-edit-modal.md`, `SET-010-user-invitations.md`
- **Migration Plan:** `docs/2-MANAGEMENT/EPIC-01-MIGRATION-PLAN.md` (section 2.3)

**Estimated Effort:** 8-10 hours
**Priority:** HIGH

---

_Original story content below ‚Üì_

---

**Priority:** P0 (MVP - Phase 1A)
**Story Points:** L (Large)
**Type:** frontend + backend

**State:** ready
**Primary PRD:** `docs/1-BASELINE/product/modules/settings.md` (FR-SET-010, FR-SET-012, FR-SET-017)
**UX Wireframes:** SET-008 (User List), SET-009 (User Modal - MVP subset)

---

## MVP Scope

This story implements Phase 1A (MVP) functionality only. FR-SET-018 (User Warehouse Access Restrictions) is deferred to Story 01.5b.

---

## Architecture Decisions

| ADR | Decision | Impact on This Story |
|-----|----------|---------------------|
| ADR-012 | Role Permission Storage | `users.role_id` references `roles(id)` - FK pattern for role assignment |
| ADR-013 | RLS Org Isolation Pattern | Users table uses `(SELECT org_id FROM users WHERE id = auth.uid())` for org isolation |

## Goal

Implement core user management CRUD operations including user list page with search/pagination, create/edit modal with role assignment, and user deactivation functionality. This is the essential user administration for MVP.

## User Story

As an **Administrator**, I want to **create, view, edit, and deactivate users with role assignments** so that **I can manage who has access to the system and what they can do**.

## Scope

**In scope (MVP)**
- GET /api/v1/settings/users (list with pagination, search, filtering)
- POST /api/v1/settings/users (create new user)
- PUT /api/v1/settings/users/:id (update existing user)
- PATCH /api/v1/settings/users/:id/deactivate (deactivate user)
- PATCH /api/v1/settings/users/:id/activate (reactivate user)
- Users list page at `/settings/users` with DataTable
- Create/Edit user modal with form validation (MVP fields only)
- Role assignment dropdown (10 roles from 01.6)
- User status management (active/inactive)
- Search by name/email
- Filter by role, status
- Pagination for large user lists
- Self-protection (cannot delete self, last Super Admin)
- Permission enforcement (hide actions from unauthorized users)

**Out of scope (this story)**
- FR-SET-018: User warehouse access restrictions (covered in 01.5b)
- User invitation flow with email (deferred - requires email integration)
- Password reset functionality
- MFA/2FA configuration
- Session management UI
- Bulk user import/export

## Dependencies

- **01.1** - Org context + RLS (required for tenant isolation)
- **01.2** - Settings shell with navigation guards
- **01.6** - Role-based permissions (required for role dropdown and enforcement)

## Acceptance Criteria (Given/When/Then)

### AC-1: User List Page

**Given** admin navigates to `/settings/users`
**When** page loads
**Then** user list displays within 500ms for up to 1000 users

**Given** user list has 500 users
**When** admin applies search "john"
**Then** filtered results display within 300ms

**Given** user list displayed
**When** admin filters by role "PROD_OPERATOR"
**Then** only Production Operators appear

**Given** user list displayed
**When** admin filters by status "inactive"
**Then** only deactivated users appear

**Given** user list with pagination
**When** page 2 clicked
**Then** next 25 users display

**Given** user list displayed
**When** role column rendered
**Then** role name (not code) displays (e.g., "Production Manager" not "PROD_MANAGER")

### AC-2: Create User

**Given** admin clicks "Add User"
**When** modal opens
**Then** form displays: email, first name, last name, role fields (NO warehouse access in MVP)

**Given** valid user data (email: "new@company.com", name: "John Doe", role: "VIEWER")
**When** "Create" clicked
**Then** user created and appears in list within 1 second

**Given** duplicate email "existing@company.com"
**When** save attempted
**Then** error "Email already exists" displays inline

**Given** invalid email format "invalid@"
**When** save attempted
**Then** error "Invalid email format" displays inline

**Given** required field (email) empty
**When** save attempted
**Then** error "Email is required" displays inline

### AC-3: Edit User

**Given** admin clicks edit on existing user
**When** modal opens
**Then** current user data pre-populates form (NO warehouse access field in MVP)

**Given** admin updates user name from "John" to "Jonathan"
**When** save completes
**Then** updated name displays immediately in list

**Given** admin changes user role from "VIEWER" to "ADMIN"
**When** save completes
**Then** new role displays in list

### AC-4: Deactivation

**Given** admin clicks "Deactivate" on active user
**When** confirmation dialog accepted
**Then** user status changes to "inactive" within 500ms

**Given** user is deactivated
**When** that user attempts login
**Then** error "Account is deactivated. Contact administrator." displays

**Given** deactivated user has active sessions
**When** deactivation completes
**Then** all sessions terminated immediately

**Given** admin views deactivated user
**When** "Reactivate" clicked
**Then** user status changes to "active" and can login

### AC-5: Self-Protection

**Given** admin attempts to delete/deactivate self
**When** action attempted
**Then** error "Cannot delete your own account" displays

**Given** only 1 Super Admin exists
**When** deactivation attempted on that user
**Then** error "Cannot deactivate the only Super Admin" displays

### AC-6: Permission Enforcement

**Given** user has no permission to manage users (e.g., PROD_OPERATOR)
**When** `/settings/users` accessed
**Then** redirect to dashboard with "Access Denied"

**Given** user with VIEWER role
**When** users page loaded
**Then** "Add User" button hidden, edit/deactivate actions hidden

### AC-7: Future Features (Phase 1B)

Features deferred to Phase 1B (Story 01.5b):
- **FR-SET-018: Warehouse Access** - Multi-select hidden in modal, column hidden in table
- Database column `warehouse_access_ids` exists but is NULL for all MVP users

**Developer**: Hide warehouse access section in SET-009 wireframe (lines 49-117).

## Implementation Notes

### API Endpoints

```typescript
// GET /api/v1/settings/users
// Query params: page, limit, search, role, status, sortBy, sortOrder
interface UsersListResponse {
  users: User[];
  total: number;
  page: number;
  limit: number;
}

// POST /api/v1/settings/users
interface CreateUserRequest {
  email: string;
  first_name: string;
  last_name: string;
  role_id: UUID; // REFERENCES roles(id) per ADR-012
  // warehouse_access_ids: NOT INCLUDED in MVP
}

// PUT /api/v1/settings/users/:id
interface UpdateUserRequest {
  first_name?: string;
  last_name?: string;
  role_id?: UUID; // REFERENCES roles(id) per ADR-012
  // warehouse_access_ids: NOT INCLUDED in MVP
}

// PATCH /api/v1/settings/users/:id/deactivate
// PATCH /api/v1/settings/users/:id/activate
// No body required
```

### Database

**Reference:** ADR-012 (Role FK), ADR-013 (RLS Pattern)

```sql
CREATE TABLE users (
  id UUID PRIMARY KEY REFERENCES auth.users(id),
  org_id UUID NOT NULL REFERENCES organizations(id),
  email TEXT NOT NULL,
  first_name TEXT NOT NULL,
  last_name TEXT NOT NULL,
  role_id UUID NOT NULL REFERENCES roles(id),
  language TEXT DEFAULT 'en',
  is_active BOOLEAN DEFAULT true,
  last_login_at TIMESTAMPTZ,

  -- Phase 1B column (present in schema, NULL in MVP)
  -- NULL = all warehouses access (default for admin/super_admin)
  -- Story 01.5b will enable this field
  warehouse_access_ids UUID[],

  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(org_id, email)
);

-- RLS Policy (per ADR-013)
CREATE POLICY "users_org_isolation" ON users
FOR SELECT USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

CREATE POLICY "users_admin_write" ON users
FOR ALL USING (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  AND (SELECT r.code FROM roles r JOIN users u ON u.role_id = r.id WHERE u.id = auth.uid()) IN ('SUPER_ADMIN', 'ADMIN')
);
```

### Frontend Components

```
app/(authenticated)/settings/users/page.tsx    -- Users list page
components/settings/users/
  UsersDataTable.tsx      -- Table with sorting, filtering, pagination
  UserModal.tsx           -- Create/Edit form modal (MVP fields only)
  UserRow.tsx             -- Single user row
  UserStatusBadge.tsx     -- Active/Inactive status indicator
  DeactivateConfirmDialog.tsx  -- Confirmation dialog
```

### Services

```typescript
// lib/services/user-service.ts
export class UserService {
  async getUsers(params: UsersListParams): Promise<UsersListResponse>;
  async createUser(data: CreateUserRequest): Promise<User>;
  async updateUser(id: string, data: UpdateUserRequest): Promise<User>;
  async deactivateUser(id: string): Promise<void>;
  async activateUser(id: string): Promise<void>;

  // Self-protection helpers
  async canDeactivate(userId: string, currentUserId: string): Promise<{ allowed: boolean; reason?: string }>;
}
```

### Validation (Zod)

```typescript
const createUserSchema = z.object({
  email: z.string().email("Invalid email format"),
  first_name: z.string().min(1, "First name is required").max(100),
  last_name: z.string().min(1, "Last name is required").max(100),
  role_id: z.string().uuid("Invalid role"), // Must reference roles(id) per ADR-012
  // warehouse_access_ids: NOT INCLUDED in MVP schema
});

const updateUserSchema = z.object({
  first_name: z.string().min(1).max(100).optional(),
  last_name: z.string().min(1).max(100).optional(),
  role_id: z.string().uuid().optional(),
  // warehouse_access_ids: NOT INCLUDED in MVP schema
});
```

## Deliverables

- API routes for user CRUD operations
- Users list page with DataTable (SET-008)
- Create/Edit user modal with validation (SET-009 MVP subset)
- Deactivate/Activate functionality
- Permission-based UI rendering
- Zod validation schemas
- `user-service.ts` with self-protection logic
- Integration tests for API endpoints
- Unit tests for user-service

## Definition of Done

- [ ] User list page loads within 500ms for 1000 users
- [ ] Create user with role assignment works end-to-end
- [ ] Edit user updates immediately in UI
- [ ] Deactivate blocks login, terminates sessions
- [ ] Self-deletion/deactivation prevented
- [ ] Last Super Admin deactivation prevented
- [ ] Role names (not codes) display in user list
- [ ] Permission checks hide unauthorized actions
- [ ] Search and filter work within 300ms
- [ ] Warehouse access field HIDDEN in modal (Phase 1B)
- [ ] All API endpoints have integration tests
- [ ] Unit tests cover user-service (>80% coverage)
- [ ] SET-008 wireframe implemented (user list)
- [ ] SET-009 wireframe implemented (MVP subset - no warehouse access)

---

## Future Phases (Not in MVP)

### Phase 1B (Story 01.5b)

- **FR-SET-018: User Warehouse Access Restrictions**
  - Enable warehouse access multi-select in SET-009 (lines 49-117)
  - API endpoints for warehouse assignment
  - RLS enforcement on warehouse-level operations

**Dependencies:** 01.5a merged, Epic 01b.1 (Warehouse CRUD)

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-12-16 | Split from 01.5, MVP scope only | ARCHITECT-AGENT |
