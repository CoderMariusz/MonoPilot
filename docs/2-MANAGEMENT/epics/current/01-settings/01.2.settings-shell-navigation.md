# 01.2 - Settings Shell: Navigation + Role Guards

**State:** ready
**Type:** frontend
**Estimate:** S
**Primary PRD:** `docs/1-BASELINE/product/modules/settings.md` (implicit settings shell)
**Primary Architecture:** `docs/1-BASELINE/architecture/modules/settings.md`

## Goal
Provide the Settings module shell (routes + navigation + access guards) so individual pages can be delivered independently without re-implementing layout/guard logic.

## Scope

**In scope**
- Settings layout component with consistent styling.
- Navigation sidebar with section groupings (Organization, Users, Infrastructure, etc.).
- Route guards with role-based access control (RBAC).
- Standard UI state handling (loading/error/empty/success) for Settings entry points.

**Out of scope**
- Implementing any specific Settings page content (each is a separate story).
- Full permission matrix (handled by later stories).

## Dependencies
- 01.1 (org context and baseline RBAC info available server-side)

## Acceptance Criteria (Given/When/Then)

- GIVEN user navigates to `/settings`, WHEN user has Admin role, THEN all settings sections are visible in navigation.
- GIVEN user has Viewer role, WHEN accessing `/settings/users`, THEN redirect to dashboard with "insufficient permissions" toast.
- GIVEN an authenticated user, WHEN they open Settings, THEN a Settings landing page loads with navigation items for implemented pages.
- GIVEN a non-admin user, WHEN they navigate to an admin-only Settings route, THEN they are blocked (redirect or "no access" message).
- GIVEN a navigation item points to an unimplemented route, WHEN clicked, THEN a clear "coming soon" state is shown (or link is visually disabled).
- GIVEN module toggles exist (later), WHEN toggles are disabled, THEN navigation can hide/disable related sections without breaking routing.

## Implementation Notes

### Frontend
- Create the Settings route group (`app/(authenticated)/settings/`) and layout consistent with the architecture component map.
- Implement a reusable guard wrapper/hook for role checks used by all Settings pages:
  ```typescript
  // Example: useSettingsGuard(requiredRole: Role)
  // Returns { allowed: boolean, loading: boolean }
  ```
- Navigation sidebar sections:
  - Organization (profile, localization)
  - Users & Roles (users, roles, invitations)
  - Infrastructure (warehouses, locations, machines, lines)
  - Master Data (allergens, tax codes)
  - Integrations (API keys, webhooks)
  - System (audit logs, security, modules)
- Enforce "4 required states" per UI spec conventions:
  - loading (skeleton)
  - error (retry option)
  - empty (call to action)
  - success (content)

### Tests (RED)
- Unit tests for guard logic (role matrix).
- Integration tests for routing/redirect behavior for protected routes.

## Deliverables
- Settings layout component (`SettingsLayout.tsx`).
- Settings navigation sidebar component (`SettingsNav.tsx`).
- Reusable guard utility for Settings pages (`useSettingsGuard` hook or HOC).
- Minimal tests for navigation + access enforcement.

## Definition of Done
- [ ] Settings shell exists and can host later pages without refactor.
- [ ] Protected routes are enforced in UI and backed by server-side checks.
- [ ] Navigation renders correctly for different role types.
- [ ] Loading, error, and empty states are implemented.
- [ ] Tests pass for guard logic and redirect behavior.
- [ ] Unit test coverage â‰¥ 80%.
- [ ] Settings page loads within 300ms (performance target).
