# 01.13 - Tax Codes CRUD

| Field | Value |
|-------|-------|
| **Story ID** | 01.13 |
| **Epic** | 01 - Settings |
| **Status** | Ready |
| **Phase** | 2 |
| **Complexity** | M (Medium) |
| **Estimate** | 2-3 days |
| **Type** | Full-stack |

---

## PRD References

| FR ID | Requirement | Priority | Covered |
|-------|-------------|----------|---------|
| FR-SET-080 | Tax code CRUD (create, read, update, delete) | P1 | YES |
| FR-SET-081 | Tax rate configuration (percentage) | P1 | YES |
| FR-SET-082 | Tax jurisdiction (country/region) | P1 | YES |
| FR-SET-083 | Effective date ranges | P1 | YES |
| FR-SET-084 | Default tax code assignment | P1 | YES |

**Primary PRD:** `docs/1-BASELINE/product/modules/settings.md`
**UX Wireframes:** TBD (Tax Code List, Tax Code Modal)

---

## User Story

As a **Finance Administrator**, I want to **create, view, edit, and manage tax codes with rates, jurisdictions, and effective date ranges** so that **the organization can properly configure tax calculations for suppliers, products, and financial transactions across different countries**.

---

## Dependencies

| Dependency | Story/Epic | Type | Reason |
|------------|------------|------|--------|
| 01.1 | Org Context + Base RLS | HARD | Requires org_id context and RLS patterns |
| 01.2 | Settings Shell Navigation | HARD | Requires settings navigation structure |
| 01.6 | Role Permissions | HARD | Permission enforcement for tax code management |

**Dependents:**
- Epic 03 (Planning Module) - Suppliers use default tax codes
- Epic 09 (Finance Module) - All financial calculations reference tax codes

---

## Acceptance Criteria (Gherkin)

### AC-1: Tax Code List Page (FR-SET-080)

```gherkin
Scenario: View tax code list
  Given admin navigates to `/settings/tax-codes`
  When page loads
  Then tax code list displays within 300ms
  And table shows columns: Code, Name, Rate, Jurisdiction, Valid From, Valid To, Default, Status

Scenario: Search tax codes by code or name
  Given tax code list with 10+ tax codes
  When admin enters search "VAT"
  Then only tax codes matching code or name display within 200ms

Scenario: Filter by jurisdiction
  Given tax code list displayed
  When admin selects filter country "PL"
  Then only Polish tax codes appear

Scenario: Filter by status
  Given tax code list displayed
  When admin filters by status "active"
  Then only currently active tax codes appear (valid_from <= today <= valid_to)

Scenario: Sort tax code list
  Given tax code list displayed
  When admin clicks "Rate" column header
  Then list sorts by rate (toggle asc/desc)

Scenario: Pagination
  Given 30 tax codes exist
  When admin views tax code list
  Then 20 tax codes display per page with pagination controls
```

### AC-2: Create Tax Code (FR-SET-080, FR-SET-081)

```gherkin
Scenario: Open create modal
  Given admin clicks "+ Add Tax Code"
  When modal opens
  Then form displays: code, name, rate (percentage), country dropdown, valid_from, valid_to, is_default checkbox

Scenario: Create tax code with required fields
  Given admin enters code "VAT23", name "VAT 23%", rate "23.00", country "PL"
  When "Create" clicked
  Then tax code created and appears in list within 1 second
  And toast "Tax code created successfully" displays

Scenario: Code uniqueness validation
  Given tax code "VAT23" exists for country "PL"
  When admin creates another with code "VAT23" for "PL"
  Then error "Tax code must be unique within jurisdiction" displays inline
  And form submission blocked

Scenario: Code format validation
  Given admin enters code "invalid code!"
  When save attempted
  Then error "Code must be 2-20 uppercase alphanumeric characters" displays

Scenario: Required field validation
  Given admin leaves code field empty
  When save attempted
  Then error "Code is required" displays inline
```

### AC-3: Tax Rate Configuration (FR-SET-081)

```gherkin
Scenario: Rate percentage input
  Given tax code create/edit modal open
  When admin enters rate field
  Then input accepts decimal values with 2 decimal places (e.g., 23.00)

Scenario: Rate minimum validation
  Given admin enters rate "-5"
  When save attempted
  Then error "Rate must be between 0 and 100" displays

Scenario: Rate maximum validation
  Given admin enters rate "150"
  When save attempted
  Then error "Rate must be between 0 and 100" displays

Scenario: Rate display format
  Given tax codes with different rates exist
  When viewing tax code list
  Then rate displays as percentage with % symbol (e.g., "23.00%")

Scenario: Zero rate allowed
  Given admin enters rate "0.00" for tax-exempt code
  When save completed
  Then tax code created with 0% rate (valid for exempt categories)
```

### AC-4: Tax Jurisdiction (FR-SET-082)

```gherkin
Scenario: Country dropdown options
  Given tax code create/edit modal open
  When admin opens country dropdown
  Then options display with country code and name:
    | Code | Name |
    | PL | Poland |
    | DE | Germany |
    | GB | United Kingdom |
    | US | United States |
    | (other ISO countries) |

Scenario: Country flag display in list
  Given tax codes with different countries exist
  When viewing tax code list
  Then jurisdiction column shows country code (e.g., "PL", "DE")

Scenario: Country filter dropdown
  Given multiple tax codes for different countries
  When admin opens jurisdiction filter
  Then only countries with existing tax codes appear as options

Scenario: Tax code display format
  Given tax code "VAT23" for Poland exists
  When viewing tax code list
  Then display format shows "VAT 23% (PL)" in combined column or tooltip
```

### AC-5: Effective Date Ranges (FR-SET-083)

```gherkin
Scenario: Date range fields display
  Given tax code create/edit modal open
  When form loads
  Then "Valid From" and "Valid To" date pickers display

Scenario: Valid from date required
  Given admin leaves valid_from empty
  When save attempted
  Then error "Valid from date is required" displays

Scenario: Valid to date optional
  Given admin leaves valid_to empty
  When save completed
  Then tax code created with no expiration (indefinitely valid)

Scenario: Date range validation
  Given admin enters valid_from "2025-12-01" and valid_to "2025-06-01"
  When save attempted
  Then error "Valid to must be after valid from" displays

Scenario: Expired tax codes display
  Given tax code with valid_to "2024-01-01" exists
  When viewing tax code list
  Then status shows "Expired" badge in red

Scenario: Future tax codes display
  Given tax code with valid_from "2026-01-01" exists
  When viewing tax code list
  Then status shows "Scheduled" badge in yellow

Scenario: Active tax codes display
  Given tax code with valid_from past and valid_to future exists
  When viewing tax code list
  Then status shows "Active" badge in green
```

### AC-6: Default Tax Code Assignment (FR-SET-084)

```gherkin
Scenario: View default tax code
  Given one tax code is marked as default for org
  When viewing tax code list
  Then default tax code shows gold star icon in Default column

Scenario: Set as default from actions menu
  Given tax code "VAT23" exists (not default)
  When admin clicks actions menu > "Set as Default"
  Then confirmation dialog displays "Set VAT23 as default tax code?"

Scenario: Default assignment atomicity
  Given "VAT8" is current default
  When admin sets "VAT23" as default
  Then "VAT23" becomes default
  And "VAT8" loses default status (atomic operation)

Scenario: Only one default per organization
  Given admin sets "VAT23" as default
  When checking database
  Then exactly one tax code has is_default=true for org

Scenario: Default used for new suppliers
  Given "VAT23" is default tax code
  When creating new supplier without specifying tax
  Then supplier auto-assigned "VAT23" as default tax code
```

### AC-7: Edit Tax Code (FR-SET-080)

```gherkin
Scenario: Open edit modal
  Given admin clicks edit on tax code "VAT23"
  When modal opens
  Then current tax code data pre-populates form

Scenario: Code immutability
  Given tax code "VAT23" is referenced by suppliers
  When edit modal opens
  Then code field is disabled with tooltip "Cannot change code for referenced tax code"

Scenario: Code editable without references
  Given tax code "TEST" has no supplier references
  When edit modal opens
  Then code field is editable

Scenario: Update tax rate
  Given admin changes rate from "23.00" to "22.00"
  When save completed
  Then updated rate displays in list immediately

Scenario: Extend valid_to date
  Given tax code valid_to is "2025-12-31"
  When admin changes to "2026-12-31"
  Then tax code validity extended successfully
```

### AC-8: Delete Tax Code (FR-SET-080)

```gherkin
Scenario: Delete unused tax code
  Given tax code "TEST" has no references
  When admin clicks "Delete Tax Code"
  Then confirmation displays "Delete tax code TEST?"
  And tax code removed within 500ms

Scenario: Delete referenced tax code blocked
  Given tax code "VAT23" is referenced by suppliers
  When admin clicks "Delete Tax Code"
  Then error "Cannot delete tax code referenced by 5 suppliers" displays
  And deletion blocked

Scenario: Soft delete for historical data
  Given tax code "OLD-VAT" has historical transaction references
  When admin confirms delete
  Then tax code soft-deleted (is_deleted=true)
  And tax code hidden from active list but preserved in database
```

### AC-9: Permission Enforcement

```gherkin
Scenario: Admin can manage tax codes
  Given user has ADMIN role
  When accessing /settings/tax-codes
  Then all CRUD actions available

Scenario: Finance Manager can manage tax codes
  Given user has FINANCE_MANAGER role (if exists, otherwise ADMIN)
  When accessing /settings/tax-codes
  Then can add, edit, set default, delete tax codes

Scenario: Production Manager view only
  Given user has PROD_MANAGER role
  When accessing /settings/tax-codes
  Then can view list but "Add Tax Code" button hidden
  And row actions hidden

Scenario: Viewer read only
  Given user has VIEWER role
  When accessing /settings/tax-codes
  Then table displays but all actions hidden
```

### AC-10: Multi-tenancy

```gherkin
Scenario: Org isolation on list
  Given User A from Org A
  When requesting /api/settings/tax-codes
  Then only Org A tax codes returned

Scenario: Cross-tenant access returns 404
  Given User A from Org A
  When requesting tax code ID from Org B
  Then 404 Not Found returned (not 403)
```

---

## Technical Specification

### Database Schema

```sql
-- Tax codes table
CREATE TABLE tax_codes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  code VARCHAR(20) NOT NULL,
  name VARCHAR(100) NOT NULL,
  rate DECIMAL(5,2) NOT NULL,           -- 0.00 to 100.00
  country_code CHAR(2) NOT NULL,        -- ISO 3166-1 alpha-2 (PL, DE, GB, US)
  valid_from DATE NOT NULL,
  valid_to DATE,                        -- NULL = no expiration
  is_default BOOLEAN DEFAULT false,
  is_deleted BOOLEAN DEFAULT false,
  deleted_at TIMESTAMPTZ,
  deleted_by UUID REFERENCES users(id),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  created_by UUID REFERENCES users(id),
  updated_by UUID REFERENCES users(id),

  -- Constraints
  CONSTRAINT tax_codes_org_code_country_unique UNIQUE(org_id, code, country_code) WHERE (is_deleted = false),
  CONSTRAINT tax_codes_code_format CHECK (code ~ '^[A-Z0-9-]{2,20}$'),
  CONSTRAINT tax_codes_rate_range CHECK (rate >= 0 AND rate <= 100),
  CONSTRAINT tax_codes_country_format CHECK (country_code ~ '^[A-Z]{2}$'),
  CONSTRAINT tax_codes_valid_dates CHECK (valid_to IS NULL OR valid_to > valid_from)
);

-- Indexes
CREATE INDEX idx_tax_codes_org_id ON tax_codes(org_id);
CREATE INDEX idx_tax_codes_org_country ON tax_codes(org_id, country_code);
CREATE INDEX idx_tax_codes_org_active ON tax_codes(org_id, is_deleted) WHERE is_deleted = false;
CREATE INDEX idx_tax_codes_valid_dates ON tax_codes(org_id, valid_from, valid_to);

-- Trigger: Ensure only one default per org
CREATE OR REPLACE FUNCTION ensure_single_default_tax_code()
RETURNS TRIGGER AS $$
BEGIN
  IF NEW.is_default = true AND NEW.is_deleted = false THEN
    UPDATE tax_codes
    SET is_default = false, updated_at = NOW()
    WHERE org_id = NEW.org_id
      AND id != NEW.id
      AND is_default = true
      AND is_deleted = false;
  END IF;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER tr_tax_codes_single_default
BEFORE INSERT OR UPDATE OF is_default ON tax_codes
FOR EACH ROW
WHEN (NEW.is_default = true)
EXECUTE FUNCTION ensure_single_default_tax_code();
```

### Seed Migration (Polish Tax Codes)

```sql
-- Seed common Polish tax codes
-- Run after tax_codes table creation

INSERT INTO tax_codes (org_id, code, name, rate, country_code, valid_from, is_default, created_by)
SELECT
  o.id AS org_id,
  t.code,
  t.name,
  t.rate,
  t.country_code,
  t.valid_from,
  t.is_default,
  (SELECT id FROM users WHERE org_id = o.id AND role_id IN (SELECT id FROM roles WHERE code = 'SUPER_ADMIN') LIMIT 1)
FROM organizations o
CROSS JOIN (
  VALUES
    ('VAT23', 'VAT 23%', 23.00, 'PL', '2011-01-01'::DATE, true),
    ('VAT8', 'VAT 8%', 8.00, 'PL', '2011-01-01'::DATE, false),
    ('VAT5', 'VAT 5%', 5.00, 'PL', '2011-01-01'::DATE, false),
    ('VAT0', 'VAT 0%', 0.00, 'PL', '2011-01-01'::DATE, false),
    ('ZW', 'Zwolniony (Exempt)', 0.00, 'PL', '2011-01-01'::DATE, false)
) AS t(code, name, rate, country_code, valid_from, is_default)
WHERE NOT EXISTS (
  SELECT 1 FROM tax_codes tc WHERE tc.org_id = o.id AND tc.code = t.code AND tc.country_code = t.country_code
);
```

### RLS Policies

```sql
-- Enable RLS
ALTER TABLE tax_codes ENABLE ROW LEVEL SECURITY;

-- Select: Org isolation (per ADR-013 pattern)
CREATE POLICY "tax_codes_select" ON tax_codes
FOR SELECT TO authenticated
USING (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  AND is_deleted = false
);

-- Insert: Org isolation + permission check
CREATE POLICY "tax_codes_insert" ON tax_codes
FOR INSERT TO authenticated
WITH CHECK (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  AND (
    (SELECT r.code FROM roles r JOIN users u ON u.role_id = r.id WHERE u.id = auth.uid())
    IN ('SUPER_ADMIN', 'ADMIN')
  )
);

-- Update: Org isolation + permission check
CREATE POLICY "tax_codes_update" ON tax_codes
FOR UPDATE TO authenticated
USING (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  AND (
    (SELECT r.code FROM roles r JOIN users u ON u.role_id = r.id WHERE u.id = auth.uid())
    IN ('SUPER_ADMIN', 'ADMIN')
  )
);

-- Delete: Org isolation + admin only (soft delete)
CREATE POLICY "tax_codes_delete" ON tax_codes
FOR DELETE TO authenticated
USING (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  AND (
    (SELECT r.code FROM roles r JOIN users u ON u.role_id = r.id WHERE u.id = auth.uid())
    IN ('SUPER_ADMIN', 'ADMIN')
  )
);
```

### API Endpoints

```
GET    /api/v1/settings/tax-codes                    - List tax codes (paginated, filtered)
POST   /api/v1/settings/tax-codes                    - Create tax code
GET    /api/v1/settings/tax-codes/:id                - Get tax code by ID
PUT    /api/v1/settings/tax-codes/:id                - Update tax code
DELETE /api/v1/settings/tax-codes/:id                - Soft delete tax code
PATCH  /api/v1/settings/tax-codes/:id/set-default    - Set as default tax code
GET    /api/v1/settings/tax-codes/validate-code      - Check code uniqueness (debounce)
GET    /api/v1/settings/tax-codes/default            - Get default tax code for org
```

**Query Parameters (List):**
- `search` - Filter by code or name (min 2 chars)
- `country_code` - Filter by country (ISO 2-letter code)
- `status` - Filter by status (active, expired, scheduled, all)
- `sort` - Sort field (code, name, rate, country_code, valid_from, created_at)
- `order` - Sort order (asc, desc)
- `page` - Page number (default 1)
- `limit` - Items per page (default 20, max 100)

### Service Layer

```typescript
// lib/services/tax-code-service.ts
export interface TaxCodeService {
  list(params: TaxCodeListParams): Promise<PaginatedResult<TaxCode>>;
  getById(id: string): Promise<TaxCode | null>;
  getDefault(): Promise<TaxCode | null>;
  create(data: CreateTaxCodeInput): Promise<TaxCode>;
  update(id: string, data: UpdateTaxCodeInput): Promise<TaxCode>;
  delete(id: string): Promise<void>; // soft delete
  setDefault(id: string): Promise<TaxCode>;
  validateCode(code: string, countryCode: string, excludeId?: string): Promise<{ available: boolean }>;
  hasReferences(id: string): Promise<{ count: number; entities: string[] }>;
  canDelete(id: string): Promise<{ allowed: boolean; reason?: string }>;
}

// Type definitions
export type TaxCodeStatus = 'active' | 'expired' | 'scheduled';

export interface TaxCode {
  id: string;
  org_id: string;
  code: string;
  name: string;
  rate: number;              // Decimal as number
  country_code: string;
  valid_from: string;        // ISO date string
  valid_to: string | null;
  is_default: boolean;
  is_deleted: boolean;
  created_at: string;
  updated_at: string;
  created_by: string;
  updated_by: string;
}

export interface TaxCodeListParams {
  search?: string;
  country_code?: string;
  status?: TaxCodeStatus | 'all';
  sort?: 'code' | 'name' | 'rate' | 'country_code' | 'valid_from' | 'created_at';
  order?: 'asc' | 'desc';
  page?: number;
  limit?: number;
}

// Computed status helper
export function getTaxCodeStatus(taxCode: TaxCode): TaxCodeStatus {
  const today = new Date().toISOString().split('T')[0];
  if (taxCode.valid_from > today) return 'scheduled';
  if (taxCode.valid_to && taxCode.valid_to < today) return 'expired';
  return 'active';
}
```

### Validation Schema (Zod)

```typescript
// lib/validation/tax-code.ts
import { z } from 'zod';

export const taxCodeSchema = z.object({
  code: z.string()
    .min(2, "Code must be at least 2 characters")
    .max(20, "Code must be at most 20 characters")
    .regex(/^[A-Z0-9-]+$/, "Code must be uppercase alphanumeric with hyphens only")
    .transform(val => val.toUpperCase()),
  name: z.string()
    .min(2, "Name must be at least 2 characters")
    .max(100, "Name must be at most 100 characters"),
  rate: z.number()
    .min(0, "Rate must be between 0 and 100")
    .max(100, "Rate must be between 0 and 100")
    .multipleOf(0.01, "Rate must have at most 2 decimal places"),
  country_code: z.string()
    .length(2, "Country code must be 2 characters")
    .regex(/^[A-Z]{2}$/, "Country code must be 2 uppercase letters")
    .transform(val => val.toUpperCase()),
  valid_from: z.string()
    .regex(/^\d{4}-\d{2}-\d{2}$/, "Valid from must be YYYY-MM-DD format")
    .refine(val => !isNaN(Date.parse(val)), "Invalid date"),
  valid_to: z.string()
    .regex(/^\d{4}-\d{2}-\d{2}$/, "Valid to must be YYYY-MM-DD format")
    .refine(val => !isNaN(Date.parse(val)), "Invalid date")
    .nullable()
    .optional(),
  is_default: z.boolean().default(false),
});

export const createTaxCodeSchema = taxCodeSchema.refine(
  data => !data.valid_to || data.valid_to > data.valid_from,
  { message: "Valid to must be after valid from", path: ["valid_to"] }
);

export const updateTaxCodeSchema = taxCodeSchema
  .partial()
  .omit({ code: true, country_code: true }) // code/country handled separately
  .extend({
    code: z.string()
      .min(2)
      .max(20)
      .regex(/^[A-Z0-9-]+$/)
      .transform(val => val.toUpperCase())
      .optional(),
    country_code: z.string()
      .length(2)
      .regex(/^[A-Z]{2}$/)
      .transform(val => val.toUpperCase())
      .optional(),
  })
  .refine(
    data => !data.valid_to || !data.valid_from || data.valid_to > data.valid_from,
    { message: "Valid to must be after valid from", path: ["valid_to"] }
  );

export const setDefaultSchema = z.object({
  tax_code_id: z.string().uuid(),
});

export type CreateTaxCodeInput = z.infer<typeof createTaxCodeSchema>;
export type UpdateTaxCodeInput = z.infer<typeof updateTaxCodeSchema>;
```

---

## UI Components

### File Structure

```
app/(authenticated)/settings/tax-codes/
  page.tsx                            -- Tax code list page

components/settings/tax-codes/
  TaxCodesDataTable.tsx               -- Table with sorting, filtering, pagination
  TaxCodeModal.tsx                    -- Create/Edit form modal
  TaxCodeRow.tsx                      -- Single tax code row
  TaxCodeRateBadge.tsx                -- Rate badge with percentage display
  TaxCodeStatusBadge.tsx              -- Active/Expired/Scheduled status indicator
  TaxCodeCountryBadge.tsx             -- Country code display (flag optional)
  TaxCodeActionsMenu.tsx              -- Row actions dropdown (edit, set default, delete)
  TaxCodeFilters.tsx                  -- Search + country/status filter bar
  SetDefaultConfirmDialog.tsx         -- Confirmation for default change
  DeleteConfirmDialog.tsx             -- Confirmation with reference check warning
  TaxCodeCountrySelect.tsx            -- Country dropdown with ISO codes
  TaxCodeDateRangePicker.tsx          -- Valid from/to date inputs
```

### Component Specifications

**TaxCodeRateBadge.tsx**
```tsx
interface TaxCodeRateBadgeProps {
  rate: number;
}

// Display format: "23.00%" with color based on rate
// 0%: gray (exempt)
// 1-10%: green (reduced)
// 11-20%: blue (standard low)
// 21-100%: purple (standard/high)
```

**TaxCodeStatusBadge.tsx**
```tsx
const STATUS_CONFIG = {
  active: { label: 'Active', color: 'bg-green-100 text-green-800' },
  expired: { label: 'Expired', color: 'bg-red-100 text-red-800' },
  scheduled: { label: 'Scheduled', color: 'bg-yellow-100 text-yellow-800' },
};
```

**TaxCodeCountryBadge.tsx**
```tsx
// Display country code with optional flag emoji
// PL -> "PL" or flag emoji
// Tooltip shows full country name
```

**TaxCodeModal.tsx**
- Form sections:
  - Basic Info: Code, Name
  - Rate: Percentage input (0-100, 2 decimal places)
  - Jurisdiction: Country dropdown
  - Validity: Date range picker (from required, to optional)
  - Options: Is Default checkbox
- Validation on blur and submit
- Loading state during save

---

## Out of Scope

| Feature | Reason | Future Story |
|---------|--------|--------------|
| Regional/state tax codes | Complex US state tax handling | Phase 3 |
| Tax rate history tracking | Separate audit feature | Phase 2 |
| Automatic tax rate updates | External integration needed | Phase 3 |
| Tax calculation engine | Finance module responsibility | Epic 09 |
| Tax reporting | Finance module feature | Epic 09 |
| Multi-tier tax (GST/PST) | Complex Canadian tax model | Future |

---

## Test Cases

### Unit Tests

**File:** `__tests__/unit/services/tax-code-service.test.ts`

| Test Case | Description |
|-----------|-------------|
| `list()` returns org-scoped tax codes | Verify RLS filtering |
| `list()` filters by country_code | Country filter works |
| `list()` filters by status | Active/expired/scheduled filter |
| `create()` validates code uniqueness per country | Duplicate code+country rejected |
| `create()` auto-uppercases code and country | "vat23", "pl" becomes "VAT23", "PL" |
| `create()` validates rate range | Rate 0-100 enforced |
| `create()` validates date range | valid_to > valid_from check |
| `update()` prevents code change with references | hasReferences check |
| `setDefault()` unsets previous default | Atomic transaction |
| `delete()` blocks with references | canDelete validation |
| `getTaxCodeStatus()` returns correct status | Active/expired/scheduled logic |
| `validateCode()` returns availability | Real-time validation |

### Integration Tests

**File:** `__tests__/integration/api/settings/tax-codes.test.ts`

| Test Case | Description |
|-----------|-------------|
| GET `/tax-codes` returns paginated list | Pagination, sorting |
| GET `/tax-codes?country_code=PL` filters | Country filter works |
| GET `/tax-codes?status=active` filters | Status filter works |
| POST `/tax-codes` creates with validation | All fields validated |
| POST `/tax-codes` duplicate code+country 400 | Uniqueness enforced |
| POST `/tax-codes` invalid rate 400 | Rate validation |
| POST `/tax-codes` invalid date range 400 | Date validation |
| PUT `/tax-codes/:id` updates mutable fields | Name, rate, dates |
| PUT `/tax-codes/:id` code immutable with refs | Returns 400 |
| PATCH `/tax-codes/:id/set-default` atomicity | Previous default unset |
| DELETE `/tax-codes/:id` with references | Returns 400 |
| GET `/tax-codes/default` returns default | Default retrieval |
| Cross-org access returns 404 | Multi-tenancy enforced |
| Permission denied returns 403 | Role enforcement |

### E2E Tests

**File:** `__tests__/e2e/settings/tax-codes.spec.ts`

| Test Case | Description |
|-----------|-------------|
| Create tax code flow | Modal > form > save > list updated |
| Edit tax code flow | Actions > edit > modify > save |
| Set default tax code | Actions > set default > confirm > star icon |
| Delete tax code | Actions > delete > confirm > removed |
| Search and filter | Search box, dropdowns, results |
| Date range validation | Invalid dates show error |
| Rate input validation | Out of range shows error |
| Permission-based UI | Viewer sees no actions |

---

## Definition of Done

- [ ] Database migration creates `tax_codes` table with all constraints
- [ ] Seed migration creates common Polish tax codes (VAT23, VAT8, VAT5, VAT0, ZW)
- [ ] RLS policies enforce org isolation and role permissions
- [ ] Single default tax code trigger works atomically
- [ ] All 8 API endpoints implemented and documented
- [ ] Zod schemas validate all inputs (rate range, date range, code format)
- [ ] `tax-code-service.ts` implements all methods
- [ ] Tax code list page renders with DataTable
- [ ] Create/Edit modal with all fields
- [ ] Rate badge displays with percentage and color coding
- [ ] Status badge shows Active/Expired/Scheduled
- [ ] Country badge/code displays correctly
- [ ] Date range picker validates from < to
- [ ] Default tax code star icon and "Set as Default" action
- [ ] Delete blocked for referenced tax codes
- [ ] Code immutability enforced when referenced
- [ ] Search, filter, sort, pagination work correctly
- [ ] Permission matrix implemented (admin, viewer)
- [ ] Multi-tenancy: cross-org returns 404
- [ ] Unit tests >= 80% coverage
- [ ] Integration tests for all endpoints
- [ ] E2E tests for critical flows
- [ ] Loading, empty, error states implemented
- [ ] Toast notifications on success/error
- [ ] Accessibility: keyboard nav, ARIA labels, screen reader support

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-12-16 | Initial story creation | ARCHITECT-AGENT |
