# 01.4 - Organization Profile Step (Wizard Step 1)

**State:** ready
**Type:** frontend + backend
**Estimate:** M
**Primary PRD:** `docs/1-BASELINE/product/modules/settings.md` (FR-SET-001, FR-SET-003, FR-SET-004, FR-SET-181)
**Primary Architecture:** `docs/1-BASELINE/architecture/modules/settings.md`

## Goal
Implement the first wizard step that collects essential organization information: name, timezone, language, and currency. Pre-populate fields from registration data where available and validate inputs before advancing.

## Scope

**In scope**
- Organization profile form within wizard step 1.
- Fields: organization name (required), timezone (required), language (required), currency (required).
- Pre-populate organization name from registration data.
- Browser-detected timezone as default.
- Browser-detected language as default (if supported).
- Validation (name required, 2-100 characters).
- Save to organizations table on "Next" click.
- Advance to step 2 after successful save.
- "Back" button disabled (first step).

**Out of scope**
- Logo upload (deferred to full Epic 01 - requires file storage setup).
- Address fields (simplified for wizard; available in full settings later).
- Contact email/phone (deferred to full organization profile).
- Full organization profile page (separate story).

## Dependencies
- 01.3 (wizard launcher framework and modal shell)
- 01.1 (org context and RLS for organizations table)

## Acceptance Criteria (Given/When/Then)

- GIVEN wizard step 1 loads, WHEN organization name was set during registration, THEN the name field is pre-filled with that value.
- GIVEN new organization, WHEN wizard step 1 loads, THEN timezone auto-detected from browser (editable).
- GIVEN browser language is Polish, WHEN wizard step 1 loads, THEN language defaults to PL (editable).
- GIVEN wizard step 1 loads, WHEN detecting browser language, THEN language dropdown defaults to browser language if supported (PL/EN/DE/FR), otherwise EN.
- GIVEN user enters valid data (name: "Bakery Fresh Ltd", timezone: "Europe/Warsaw", language: "PL", currency: "PLN"), WHEN "Next" clicked, THEN organization is updated in database and wizard advances to step 2.
- GIVEN organization name field is empty, WHEN "Next" clicked, THEN error message "Organization name is required" displays and wizard does not advance.
- GIVEN organization name is 1 character, WHEN "Next" clicked, THEN error message "Organization name must be at least 2 characters" displays.
- GIVEN organization name is 101 characters, WHEN "Next" clicked, THEN error message "Organization name must be at most 100 characters" displays.
- GIVEN timezone dropdown is opened, WHEN user types "war", THEN "Europe/Warsaw" appears in filtered results.
- GIVEN language dropdown, WHEN opened, THEN options include: Polski (PL), English (EN), Deutsch (DE), Francais (FR).
- GIVEN currency dropdown, WHEN opened, THEN options include: PLN, EUR, USD, GBP (4 currencies for MVP).
- GIVEN wizard is on step 1, WHEN "Back" button is checked, THEN it is disabled or hidden (first step).
- GIVEN step 1 is completed, WHEN step 2 loads, THEN progress indicator shows "Step 2 of 6" with step 1 checkmarked.

## Implementation Notes

### Database

Ensure organizations table has these columns (verify/add if missing):
```sql
name VARCHAR(100) NOT NULL,
timezone VARCHAR(50) NOT NULL DEFAULT 'UTC',
language VARCHAR(5) NOT NULL DEFAULT 'en',
currency VARCHAR(3) NOT NULL DEFAULT 'EUR'
```

### Backend

API endpoint for saving step 1:
```
POST /api/v1/settings/onboarding/step/1
Body: {
  name: string,        // required, 2-100 chars
  timezone: string,    // required, valid IANA timezone
  language: string,    // required, one of: pl, en, de, fr
  currency: string     // required, one of: PLN, EUR, USD, GBP
}
Response: {
  success: true,
  next_step: 2,
  organization: { id, name, timezone, language, currency }
}
```

Validation (Zod schema):
```typescript
const organizationProfileStepSchema = z.object({
  name: z.string()
    .min(2, 'Organization name must be at least 2 characters')
    .max(100, 'Organization name must be at most 100 characters'),
  timezone: z.string().refine(
    (tz) => Intl.supportedValuesOf('timeZone').includes(tz),
    'Invalid timezone'
  ),
  language: z.enum(['pl', 'en', 'de', 'fr']),
  currency: z.enum(['PLN', 'EUR', 'USD', 'GBP'])
});
```

On success:
- Update organizations table with provided values.
- Set `onboarding_step = 2`.
- Set `onboarding_started_at = NOW()` if null.

### Frontend

- Create `OrganizationProfileStep.tsx` component:
  ```typescript
  interface OrganizationProfileStepProps {
    onNext: () => void;
    onBack: () => void;  // disabled for step 1
    initialData?: {
      name?: string;
      timezone?: string;
      language?: string;
      currency?: string;
    };
  }
  ```

- Form fields:
  - Organization Name: Text input with inline validation.
  - Timezone: Searchable dropdown (300+ IANA timezones).
  - Language: Dropdown with 4 options (PL/EN/DE/FR).
  - Currency: Dropdown with 4 options (PLN/EUR/USD/GBP).

- Browser detection utilities:
  ```typescript
  // Detect browser timezone
  const browserTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;

  // Detect browser language (map to supported)
  const browserLang = navigator.language.slice(0, 2).toLowerCase();
  const supportedLang = ['pl', 'en', 'de', 'fr'].includes(browserLang)
    ? browserLang
    : 'en';
  ```

- Timezone dropdown implementation:
  - Use `Intl.supportedValuesOf('timeZone')` for full list.
  - Searchable/filterable (typing "war" shows "Europe/Warsaw").
  - Show friendly format: "Europe/Warsaw (UTC+1)" when possible.

- Language dropdown display:
  | Value | Display |
  |-------|---------|
  | pl | Polski |
  | en | English |
  | de | Deutsch |
  | fr | Francais |

- Currency dropdown display:
  | Value | Display |
  |-------|---------|
  | PLN | PLN - Polish Zloty |
  | EUR | EUR - Euro |
  | USD | USD - US Dollar |
  | GBP | GBP - British Pound |

### Tests (RED)

- Unit tests:
  - Form validation rejects empty name.
  - Form validation rejects name < 2 chars.
  - Form validation rejects name > 100 chars.
  - Browser timezone detection works.
  - Language dropdown shows 4 options.
  - Currency dropdown shows 4 options.
  - "Back" button is disabled.

- Integration tests:
  - Pre-population of organization name from registration.
  - Successful save advances to step 2.
  - Validation errors prevent advancement.
  - Timezone search/filter works.

## Deliverables

- `OrganizationProfileStep.tsx` component.
- Zod validation schema for step 1 data.
- API route: `POST /api/v1/settings/onboarding/step/1`.
- Timezone searchable dropdown component (or use existing).
- Browser detection utilities for timezone/language defaults.

## Definition of Done

- [ ] Organization name pre-fills from registration data.
- [ ] Timezone defaults to browser-detected timezone.
- [ ] Language defaults to browser language if supported.
- [ ] All validation rules enforced with clear error messages.
- [ ] Successful save updates organization and advances to step 2.
- [ ] "Back" button is disabled on step 1.
- [ ] Unit and integration tests pass for all acceptance criteria.
