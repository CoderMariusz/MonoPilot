# 01.6 - Role-Based Permissions (10 Roles)

**State:** ready
**Type:** backend + frontend
**Estimate:** M
**Primary PRD:** `docs/1-BASELINE/product/modules/settings.md` (FR-SET-011, FR-SET-020-029, FR-SET-030, FR-SET-031)
**UX Wireframes:** SET-011
**Architecture:** ADR-012 (Role-Based Permissions Schema)

## Goal
Implement the 10 predefined role system with RBAC enforcement. Roles are system-defined (not editable). Permissions control module access and CRUD operations across the application.

## Scope

**In scope**
- 10 predefined roles with fixed permissions
- Permission matrix (module x CRUD)
- `hasPermission()` helper function for backend/frontend
- `usePermissions()` React hook for UI
- Role enforcement on API endpoints (middleware)
- Role display in user modal dropdown
- Permission-based UI element visibility
- Role validation on assignment

**Out of scope**
- Custom role creation
- Role editing/modification
- Granular per-entity permissions
- Permission delegation

## Dependencies
- **01.1** - Org context + RLS (required for user context)

## 10 Role Definitions

| Role Code | Role Name | Description |
|-----------|-----------|-------------|
| owner | Owner | Full system access, can assign any role |
| admin | Administrator | Organization-wide access, cannot assign Owner |
| production_manager | Production Manager | Full Production, Planning, Quality access |
| quality_manager | Quality Manager | Full Quality, read Production |
| warehouse_manager | Warehouse Manager | Full Warehouse and Shipping access |
| production_operator | Production Operator | CRU Production, read Quality |
| quality_inspector | Quality Inspector | CRU Quality only |
| warehouse_operator | Warehouse Operator | CRU Warehouse and Shipping |
| planner | Planner | Full Planning, read Production |
| viewer | Viewer | Read-only all modules |

## Permission Matrix

| Role | Settings | Users | Technical | Planning | Production | Quality | Warehouse | Shipping | NPD | Finance | OEE | Integrations |
|------|----------|-------|-----------|----------|------------|---------|-----------|----------|-----|---------|-----|--------------|
| owner | CRUD | CRUD | CRUD | CRUD | CRUD | CRUD | CRUD | CRUD | CRUD | CRUD | CRUD | CRUD |
| admin | CRU | CRUD | CRUD | CRUD | CRUD | CRUD | CRUD | CRUD | CRUD | CRUD | CRUD | CRUD |
| production_manager | R | R | RU | CRUD | CRUD | CRUD | RU | R | R | R | CRUD | R |
| quality_manager | R | R | R | R | RU | CRUD | R | R | RU | - | R | - |
| warehouse_manager | R | R | R | R | R | R | CRUD | CRUD | - | - | - | - |
| production_operator | - | - | R | R | RU | CR | R | - | - | - | R | - |
| quality_inspector | - | - | R | - | R | CRU | R | R | - | - | - | - |
| warehouse_operator | - | - | R | - | - | R | CRU | RU | - | - | - | - |
| planner | R | R | R | CRUD | R | R | R | R | R | R | R | - |
| viewer | R | R | R | R | R | R | R | R | R | R | R | R |

**Legend:**
- C = Create
- R = Read
- U = Update
- D = Delete
- `-` = No access

## Acceptance Criteria (Given/When/Then)

### Role Assignment
- GIVEN role dropdown in user modal, WHEN opened, THEN exactly 10 roles display with names.
- GIVEN role dropdown in user modal, WHEN roles listed, THEN display name shown (not code): "Production Manager" not "production_manager".
- GIVEN owner assigning role to user, WHEN any of 10 roles selected, THEN role assignment succeeds.
- GIVEN non-owner (e.g., admin), WHEN attempting to assign owner role, THEN error "Only owner can assign owner role" displays.
- GIVEN role changed from viewer to admin, WHEN user's next request made, THEN new permissions active immediately.

### Permission Enforcement - Module Level
- GIVEN user with owner role, WHEN accessing any module, THEN full CRUD access granted.
- GIVEN user with viewer role, WHEN attempting to create anything, THEN action blocked, create button hidden.
- GIVEN user with production_operator role, WHEN accessing Quality module, THEN CR access (create and read, no update/delete).
- GIVEN user with quality_inspector role, WHEN accessing Warehouse module, THEN read-only access granted.
- GIVEN user with warehouse_operator role, WHEN accessing Settings module, THEN access denied (redirect).

### Permission Enforcement - API Level
- GIVEN API request to `/api/v1/production/work-orders` by viewer, WHEN POST attempted, THEN 403 Forbidden returns.
- GIVEN API request to `/api/v1/quality/inspections` by production_operator, WHEN DELETE attempted, THEN 403 Forbidden returns.
- GIVEN API request to `/api/v1/warehouse/locations` by quality_inspector, WHEN GET attempted, THEN 200 OK returns (quality_inspector has read access to warehouse).

### UI Permission Rendering
- GIVEN user with CRU permission (no Delete), WHEN delete button rendered, THEN button hidden or disabled.
- GIVEN user with R permission only, WHEN page loads, THEN "Create" and "Edit" buttons hidden.
- GIVEN user with CRUD permission, WHEN page loads, THEN all action buttons visible.

### Permission Caching
- GIVEN user permissions cached, WHEN admin updates user's role, THEN user's next request uses updated permissions (no stale cache beyond 1 minute).

## Implementation Notes

### Permission Data Structure

```typescript
// Permission levels
type Permission = 'C' | 'R' | 'U' | 'D' | '-';
type PermissionSet = string; // e.g., "CRUD", "CRU", "R", "-"

// Module permissions for a role
interface RolePermissions {
  role_code: string;
  role_name: string;
  modules: {
    settings: PermissionSet;
    users: PermissionSet;
    technical: PermissionSet;
    planning: PermissionSet;
    production: PermissionSet;
    quality: PermissionSet;
    warehouse: PermissionSet;
    shipping: PermissionSet;
    npd: PermissionSet;
    finance: PermissionSet;
    oee: PermissionSet;
    integrations: PermissionSet;
  };
}

// Permission matrix (static data, seeded in DB)
const ROLE_PERMISSIONS: Record<string, RolePermissions> = {
  owner: { ... },
  admin: { ... },
  // ... etc
};
```

### Permission Helper Functions

```typescript
// Backend
function hasPermission(
  user: User,
  module: string,
  action: 'C' | 'R' | 'U' | 'D'
): boolean;

function requirePermission(
  module: string,
  action: 'C' | 'R' | 'U' | 'D'
): Middleware;

// Frontend
function usePermissions(): {
  can: (module: string, action: 'C' | 'R' | 'U' | 'D') => boolean;
  canAny: (module: string) => boolean;
  role: string;
};
```

### API Middleware

```typescript
// Usage in API routes
export async function POST(req: Request) {
  const user = await getAuthUser(req);
  if (!hasPermission(user, 'production', 'C')) {
    return Response.json(
      { error: "You don't have permission to perform this action" },
      { status: 403 }
    );
  }
  // ... proceed with creation
}
```

### Database Schema (ADR-012)

```sql
-- roles table (seeded, immutable)
CREATE TABLE roles (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  code VARCHAR(50) UNIQUE NOT NULL,
  name VARCHAR(100) NOT NULL,
  description TEXT,
  permissions JSONB NOT NULL,  -- module permission matrix
  is_system BOOLEAN DEFAULT true,
  display_order INT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Seed 10 roles
INSERT INTO roles (code, name, description, permissions, display_order) VALUES
  ('owner', 'Owner', 'Full system access, can assign any role', '{"settings":"CRUD","users":"CRUD","technical":"CRUD","planning":"CRUD","production":"CRUD","quality":"CRUD","warehouse":"CRUD","shipping":"CRUD","npd":"CRUD","finance":"CRUD","oee":"CRUD","integrations":"CRUD"}', 1),
  ('admin', 'Administrator', 'Organization-wide access, cannot assign Owner', '{"settings":"CRU","users":"CRUD","technical":"CRUD","planning":"CRUD","production":"CRUD","quality":"CRUD","warehouse":"CRUD","shipping":"CRUD","npd":"CRUD","finance":"CRUD","oee":"CRUD","integrations":"CRUD"}', 2),
  ('production_manager', 'Production Manager', 'Full Production, Planning, Quality access', '{"settings":"R","users":"R","technical":"RU","planning":"CRUD","production":"CRUD","quality":"CRUD","warehouse":"RU","shipping":"R","npd":"R","finance":"R","oee":"CRUD","integrations":"R"}', 3),
  ('quality_manager', 'Quality Manager', 'Full Quality, read Production', '{"settings":"R","users":"R","technical":"R","planning":"R","production":"RU","quality":"CRUD","warehouse":"R","shipping":"R","npd":"RU","finance":"-","oee":"R","integrations":"-"}', 4),
  ('warehouse_manager', 'Warehouse Manager', 'Full Warehouse and Shipping access', '{"settings":"R","users":"R","technical":"R","planning":"R","production":"R","quality":"R","warehouse":"CRUD","shipping":"CRUD","npd":"-","finance":"-","oee":"-","integrations":"-"}', 5),
  ('production_operator', 'Production Operator', 'CRU Production, read Quality', '{"settings":"-","users":"-","technical":"R","planning":"R","production":"RU","quality":"CR","warehouse":"R","shipping":"-","npd":"-","finance":"-","oee":"R","integrations":"-"}', 6),
  ('quality_inspector', 'Quality Inspector', 'CRU Quality only', '{"settings":"-","users":"-","technical":"R","planning":"-","production":"R","quality":"CRU","warehouse":"R","shipping":"R","npd":"-","finance":"-","oee":"-","integrations":"-"}', 7),
  ('warehouse_operator', 'Warehouse Operator', 'CRU Warehouse and Shipping', '{"settings":"-","users":"-","technical":"R","planning":"-","production":"-","quality":"R","warehouse":"CRU","shipping":"RU","npd":"-","finance":"-","oee":"-","integrations":"-"}', 8),
  ('planner', 'Planner', 'Full Planning, read Production', '{"settings":"R","users":"R","technical":"R","planning":"CRUD","production":"R","quality":"R","warehouse":"R","shipping":"R","npd":"R","finance":"R","oee":"R","integrations":"-"}', 9),
  ('viewer', 'Viewer', 'Read-only all modules', '{"settings":"R","users":"R","technical":"R","planning":"R","production":"R","quality":"R","warehouse":"R","shipping":"R","npd":"R","finance":"R","oee":"R","integrations":"R"}', 10);
```

### Frontend Hook Usage

```tsx
function UserActionsCell({ user }: { user: User }) {
  const { can } = usePermissions();

  return (
    <div>
      {can('users', 'U') && <EditButton user={user} />}
      {can('users', 'D') && <DeleteButton user={user} />}
    </div>
  );
}
```

## Deliverables
- `roles` table with 10 seeded roles and permission matrix
- `permission-service.ts` with hasPermission, requirePermission
- `usePermissions` React hook
- Permission middleware for API routes
- Role dropdown component for user forms
- Integration tests for permission enforcement
- Unit tests for permission-service

## Definition of Done
- [ ] 10 roles seeded in database with correct permissions
- [ ] hasPermission() correctly checks module + action
- [ ] API middleware enforces permissions, returns 403
- [ ] usePermissions hook works for UI conditional rendering
- [ ] Role dropdown displays names (not codes) in user modal
- [ ] Owner role assignment restricted to Owners
- [ ] Role changes take effect within 1 minute
- [ ] Integration tests cover all role x module x action combinations
- [ ] Unit tests for permission-service (>80% coverage)
