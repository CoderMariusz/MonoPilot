# 01.5 - Users: List + Create/Edit Modal (ORIGINAL - BEFORE SPLIT)

**ARCHIVED:** This is the original story before split on 2025-12-16.
**Replacement:** See `01.5a.user-management-crud-mvp.md` and `01.5b.user-warehouse-access-phase1b.md`

---

**State:** ready
**Type:** frontend + backend
**Estimate:** L (largest story)
**Primary PRD:** `docs/1-BASELINE/product/modules/settings.md` (FR-SET-010, FR-SET-012, FR-SET-017)
**UX Wireframes:** SET-008, SET-009

## Architecture Decisions

| ADR | Decision | Impact on This Story |
|-----|----------|---------------------|
| ADR-012 | Role Permission Storage | `users.role_id` references `roles(id)` - FK pattern for role assignment |
| ADR-013 | RLS Org Isolation Pattern | Users table uses `(SELECT org_id FROM users WHERE id = auth.uid())` for org isolation |

## Goal
Implement complete user management CRUD operations including user list page with search/pagination, create/edit modal with role assignment, and user deactivation functionality.

## Scope

**In scope**
- GET /api/v1/settings/users (list with pagination, search, filtering)
- POST /api/v1/settings/users (create new user)
- PUT /api/v1/settings/users/:id (update existing user)
- PATCH /api/v1/settings/users/:id/deactivate (deactivate user)
- PATCH /api/v1/settings/users/:id/activate (reactivate user)
- Users list page at `/settings/users` with DataTable
- Create/Edit user modal with form validation
- Role assignment dropdown (10 roles from 01.6)
- User status management (active/inactive)
- Search by name/email
- Filter by role, status
- Pagination for large user lists

**Out of scope**
- User invitation flow with email (deferred - requires email integration)
- Password reset functionality
- MFA/2FA configuration
- Session management UI
- Bulk user import/export

## Dependencies
- **01.1** - Org context + RLS (required for tenant isolation)
- **01.2** - Settings shell with navigation guards
- **01.6** - Role-based permissions (required for role dropdown and enforcement)

## Acceptance Criteria (Given/When/Then)

### User List Page
- GIVEN admin navigates to `/settings/users`, WHEN page loads, THEN user list displays within 500ms for up to 1000 users.
- GIVEN user list has 500 users, WHEN admin applies search "john", THEN filtered results display within 300ms.
- GIVEN user list displayed, WHEN admin filters by role "PROD_OPERATOR", THEN only Production Operators appear.
- GIVEN user list displayed, WHEN admin filters by status "inactive", THEN only deactivated users appear.
- GIVEN user list with pagination, WHEN page 2 clicked, THEN next 25 users display.
- GIVEN user list displayed, WHEN role column rendered, THEN role name (not code) displays (e.g., "Production Manager" not "PROD_MANAGER").

### Create User
- GIVEN admin clicks "Add User", WHEN modal opens, THEN form displays email, first name, last name, role fields.
- GIVEN valid user data (email: "new@company.com", name: "John Doe", role: "VIEWER"), WHEN "Create" clicked, THEN user created and appears in list within 1 second.
- GIVEN duplicate email "existing@company.com", WHEN save attempted, THEN error "Email already exists" displays inline.
- GIVEN invalid email format "invalid@", WHEN save attempted, THEN error "Invalid email format" displays inline.
- GIVEN required field (email) empty, WHEN save attempted, THEN error "Email is required" displays inline.

### Edit User
- GIVEN admin clicks edit on existing user, WHEN modal opens, THEN current user data pre-populates form.
- GIVEN admin updates user name from "John" to "Jonathan", WHEN save completes, THEN updated name displays immediately in list.
- GIVEN admin changes user role from "VIEWER" to "ADMIN", WHEN save completes, THEN new role displays in list.

### Deactivation
- GIVEN admin clicks "Deactivate" on active user, WHEN confirmation dialog accepted, THEN user status changes to "inactive" within 500ms.
- GIVEN user is deactivated, WHEN that user attempts login, THEN error "Account is deactivated. Contact administrator." displays.
- GIVEN deactivated user has active sessions, WHEN deactivation completes, THEN all sessions terminated immediately.
- GIVEN admin views deactivated user, WHEN "Reactivate" clicked, THEN user status changes to "active" and can login.

### Self-Protection
- GIVEN admin attempts to delete/deactivate self, WHEN action attempted, THEN error "Cannot delete your own account" displays.
- GIVEN only 1 Super Admin exists, WHEN deactivation attempted on that user, THEN error "Cannot deactivate the only Super Admin" displays.

### Permission Enforcement
- GIVEN admin has no permission to manage users (e.g., PROD_OPERATOR), WHEN `/settings/users` accessed, THEN redirect to dashboard with "Access Denied".
- GIVEN user with VIEWER role, WHEN users page loaded, THEN "Add User" button hidden, edit/deactivate actions hidden.

## Implementation Notes

### API Endpoints

```typescript
// GET /api/v1/settings/users
// Query params: page, limit, search, role, status, sortBy, sortOrder
interface UsersListResponse {
  users: User[];
  total: number;
  page: number;
  limit: number;
}

// POST /api/v1/settings/users
interface CreateUserRequest {
  email: string;
  first_name: string;
  last_name: string;
  role_id: UUID; // REFERENCES roles(id) per ADR-012
}

// PUT /api/v1/settings/users/:id
interface UpdateUserRequest {
  first_name?: string;
  last_name?: string;
  role_id?: UUID; // REFERENCES roles(id) per ADR-012
}

// PATCH /api/v1/settings/users/:id/deactivate
// PATCH /api/v1/settings/users/:id/activate
// No body required
```

### Database

**Reference:** ADR-012 (Role FK), ADR-013 (RLS Pattern)

- Uses existing `users` table with RLS policies from 01.1
- `role_id` is a foreign key: `role_id UUID REFERENCES roles(id)` (per ADR-012)
- Queries must include `org_id` filter via RLS (per ADR-013)
- Status field: `is_active` (boolean)

**RLS Policy (per ADR-013):**
```sql
CREATE POLICY "users_org_isolation" ON users
FOR SELECT USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));
```

### Frontend Components
- `UsersListPage` - Main page component
- `UsersDataTable` - Table with sorting, filtering, pagination
- `UserModal` - Create/Edit form modal
- `UserStatusBadge` - Active/Inactive status indicator
- `DeactivateConfirmDialog` - Confirmation dialog

### Services
- `user-service.ts` - User CRUD operations
- Reuse `permission-service.ts` from 01.6 for role validation

### Validation (Zod)
```typescript
const createUserSchema = z.object({
  email: z.string().email("Invalid email format"),
  first_name: z.string().min(1, "First name is required").max(100),
  last_name: z.string().min(1, "Last name is required").max(100),
  role_id: z.string().uuid("Invalid role"), // Must reference roles(id) per ADR-012
});
```

## Deliverables
- API routes for user CRUD operations
- Users list page with DataTable
- Create/Edit user modal with validation
- Deactivate/Activate functionality
- Permission-based UI rendering
- Zod validation schemas
- Integration tests for API endpoints
- Unit tests for user-service

## Definition of Done
- [ ] User list page loads within 500ms for 1000 users
- [ ] Create user with role assignment works end-to-end
- [ ] Edit user updates immediately in UI
- [ ] Deactivate blocks login, terminates sessions
- [ ] Self-deletion/deactivation prevented
- [ ] Last Super Admin deactivation prevented
- [ ] Role names (not codes) display in user list
- [ ] Permission checks hide unauthorized actions
- [ ] Search and filter work within 300ms
- [ ] All API endpoints have integration tests
- [ ] Unit tests cover user-service (>80% coverage)
