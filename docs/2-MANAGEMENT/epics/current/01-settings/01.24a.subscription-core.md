# 01.24a - Subscription Core (Plan Selection & Seat Management)

**Story ID:** 01.24a
**Epic:** 01 - Settings
**Phase:** 3 (Enterprise)
**Complexity:** M (Medium)
**Estimate:** 2-3 days
**Type:** Backend + Frontend
**State:** ready

**Primary PRD:** `docs/1-BASELINE/product/modules/settings.md` (FR-SET-100 to FR-SET-103)

## PRD References

| FR ID | Requirement | Priority | Phase | Covered |
|-------|-------------|----------|-------|---------|
| FR-SET-100 | Subscription plan selection | P1 | 3 | Yes |
| FR-SET-101 | User seat management | P1 | 3 | Yes |
| FR-SET-102 | Billing cycle configuration | P1 | 3 | Yes |
| FR-SET-103 | Payment method management | P1 | 3 | Yes |

## User Story

**As an** organization admin,
**I want** to select a subscription plan and manage user seats,
**So that** I can choose the right plan for my team size and control billing costs.

**As a** super admin,
**I want** to upgrade or downgrade the subscription plan,
**So that** I can scale the organization's access as business needs change.

## Goal

Implement subscription management with Stripe integration. Organizations can select from three plans (Free, Starter, Professional), manage user seats within plan limits, choose billing cycles (monthly/annual), and configure payment methods.

## Scope

**In scope:**
- Subscription plans: Free (5 users), Starter ($50/user/month), Professional ($100/user/month)
- Seat management: add/remove seats within plan limits
- Billing cycles: monthly, annual (16% discount)
- Payment method management via Stripe (credit card)
- Plan upgrade/downgrade with proration
- Subscription status tracking (active, past_due, canceled)
- Current subscription display

**Out of scope:**
- Invoice history (01.24b - FR-SET-104)
- Usage metrics tracking (FR-SET-105, Phase 3)
- Custom enterprise plans
- Multiple payment methods per org
- PayPal or other payment providers

## Dependencies

| Story | Requirement | Status |
|-------|-------------|--------|
| 01.1 | Org Context + Base RLS | Required - provides org_id context |
| 01.5 | Users CRUD | Required - user count for seat validation |
| 01.6 | Role Permissions | Required - admin-only access |

## Acceptance Criteria (Given/When/Then)

### Plan Selection (FR-SET-100)

#### View Available Plans
- GIVEN admin navigates to `/settings/billing`, WHEN page loads, THEN three plans display: Free, Starter, Professional.
- GIVEN plans displayed, WHEN viewed, THEN each plan shows: name, price per user, features, seat limits.
- GIVEN current plan is Starter, WHEN plans viewed, THEN Starter shows "Current Plan" badge.

#### Plan Features Display
- GIVEN Free plan shown, WHEN features displayed, THEN shows: 5 users max, core modules, community support.
- GIVEN Starter plan shown, WHEN features displayed, THEN shows: unlimited users, all modules, email support.
- GIVEN Professional plan shown, WHEN features displayed, THEN shows: unlimited users, all modules, priority support, API access.

### Seat Management (FR-SET-101)

#### View Current Seats
- GIVEN org has 8 users, WHEN billing page loads, THEN displays "8 seats used".
- GIVEN org on Free plan with 5 users, WHEN seat count shown, THEN displays "5/5 seats used" with warning.

#### Add Seats
- GIVEN org on Starter plan with 10 seats, WHEN admin adds 5 seats, THEN total seats becomes 15.
- GIVEN admin adds seats, WHEN confirmed, THEN prorated charge applied via Stripe.
- GIVEN org on Free plan, WHEN admin attempts to add seats beyond 5, THEN upgrade prompt displays.

#### Remove Seats
- GIVEN org has 15 seats and 10 active users, WHEN admin reduces to 12 seats, THEN change accepted.
- GIVEN org has 15 seats and 10 active users, WHEN admin attempts to reduce to 8 seats, THEN error "Cannot reduce below active user count (10)" displays.
- GIVEN admin removes seats, WHEN confirmed, THEN credit applied to next billing cycle.

### Billing Cycle (FR-SET-102)

#### View Billing Cycle
- GIVEN org on monthly billing, WHEN billing page loads, THEN "Monthly" displays as current cycle.
- GIVEN org on annual billing, WHEN billing page loads, THEN "Annual (16% off)" displays with badge.

#### Change Billing Cycle
- GIVEN org on monthly billing, WHEN admin switches to annual, THEN confirmation shows annual price with savings.
- GIVEN admin switches to annual, WHEN confirmed, THEN billing_cycle updates and next charge is annual.
- GIVEN org on annual billing mid-term, WHEN admin switches to monthly, THEN change takes effect at renewal.

### Payment Methods (FR-SET-103)

#### View Payment Method
- GIVEN org has Stripe card ending 4242, WHEN billing page loads, THEN displays "Visa ending in 4242".
- GIVEN org has no payment method (Free plan), WHEN billing page loads, THEN "No payment method" displays.

#### Add/Update Payment Method
- GIVEN admin clicks "Add Payment Method", WHEN Stripe Elements modal opens, THEN user can enter card details.
- GIVEN valid card entered, WHEN saved, THEN card attached to Stripe customer.
- GIVEN admin updates payment method, WHEN new card saved, THEN old card replaced.

### Upgrade/Downgrade (FR-SET-106 partial)

#### Upgrade Plan
- GIVEN org on Free plan, WHEN admin selects Starter, THEN payment method required before upgrade.
- GIVEN org on Starter plan, WHEN admin selects Professional, THEN prorated charge calculated and shown.
- GIVEN admin confirms upgrade, WHEN processed, THEN subscription updates immediately.

#### Downgrade Plan
- GIVEN org on Professional with 50 users, WHEN admin selects Free, THEN error "Reduce to 5 users before downgrading to Free" displays.
- GIVEN org on Starter with 3 users, WHEN admin selects Free, THEN downgrade scheduled for end of billing period.
- GIVEN downgrade scheduled, WHEN billing page viewed, THEN shows "Downgrading to Free on [date]".

### Multi-tenancy
- GIVEN User A from Org A, WHEN viewing subscription, THEN only Org A subscription data returns.
- GIVEN User A from Org A, WHEN attempting to modify Org B subscription, THEN 404 Not Found returns.

## Technical Specification

### Database Schema

#### subscriptions table

```sql
CREATE TABLE subscriptions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL UNIQUE REFERENCES organizations(id) ON DELETE CASCADE,

  -- Plan details
  plan VARCHAR(50) NOT NULL DEFAULT 'free', -- 'free', 'starter', 'professional'
  seats INT NOT NULL DEFAULT 5 CHECK (seats >= 1),
  billing_cycle VARCHAR(20) DEFAULT 'monthly' CHECK (billing_cycle IN ('monthly', 'annual')),

  -- Stripe integration
  stripe_customer_id VARCHAR(100),
  stripe_subscription_id VARCHAR(100),
  stripe_payment_method_id VARCHAR(100),

  -- Status
  status VARCHAR(20) DEFAULT 'active' CHECK (status IN ('active', 'past_due', 'canceled', 'trialing')),
  current_period_start TIMESTAMPTZ,
  current_period_end TIMESTAMPTZ,
  cancel_at_period_end BOOLEAN DEFAULT false,

  -- Metadata
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Indexes
CREATE INDEX idx_subscriptions_org_id ON subscriptions(org_id);
CREATE INDEX idx_subscriptions_stripe_customer ON subscriptions(stripe_customer_id);
CREATE INDEX idx_subscriptions_status ON subscriptions(status);

-- Trigger for updated_at
CREATE TRIGGER set_subscriptions_updated_at
  BEFORE UPDATE ON subscriptions
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
```

#### Plan pricing reference (no table, constants in code)

```typescript
export const SUBSCRIPTION_PLANS = {
  free: {
    name: 'Free',
    maxSeats: 5,
    pricePerSeat: 0,
    features: ['Core modules', '5 users max', 'Community support'],
  },
  starter: {
    name: 'Starter',
    maxSeats: null, // unlimited
    pricePerSeat: 50, // USD/month
    features: ['All modules', 'Unlimited users', 'Email support'],
  },
  professional: {
    name: 'Professional',
    maxSeats: null,
    pricePerSeat: 100,
    features: ['All modules', 'Unlimited users', 'Priority support', 'API access'],
  },
} as const;

export const ANNUAL_DISCOUNT = 0.16; // 16% off
```

### RLS Policies

```sql
-- Subscriptions: Only admins can view/modify their org's subscription
CREATE POLICY "subscriptions_read" ON subscriptions
FOR SELECT USING (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  AND (SELECT r.code FROM roles r JOIN users u ON u.role_id = r.id WHERE u.id = auth.uid())
      IN ('SUPER_ADMIN', 'ADMIN')
);

CREATE POLICY "subscriptions_update" ON subscriptions
FOR UPDATE USING (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  AND (SELECT r.code FROM roles r JOIN users u ON u.role_id = r.id WHERE u.id = auth.uid())
      IN ('SUPER_ADMIN', 'ADMIN')
);

-- Insert handled via service role (Stripe webhook creates subscription)
CREATE POLICY "subscriptions_insert" ON subscriptions
FOR INSERT WITH CHECK (false); -- Only via service role
```

### API Endpoints

```
# Subscription Management
GET    /api/v1/settings/subscription              - Get current subscription
PUT    /api/v1/settings/subscription              - Update subscription (seats, cycle)
GET    /api/v1/settings/subscription/plans        - Get available plans
POST   /api/v1/settings/subscription/upgrade      - Upgrade to higher plan
POST   /api/v1/settings/subscription/downgrade    - Downgrade to lower plan

# Payment Methods (Stripe)
GET    /api/v1/settings/subscription/payment-method    - Get current payment method
POST   /api/v1/settings/subscription/payment-method    - Create setup intent for new card
DELETE /api/v1/settings/subscription/payment-method    - Remove payment method

# Stripe Webhooks
POST   /api/v1/webhooks/stripe                    - Handle Stripe events
```

### Service Methods

**Location:** `lib/services/subscription-service.ts`

```typescript
interface SubscriptionService {
  // Subscription CRUD
  getSubscription(orgId: string): Promise<Subscription>;
  updateSubscription(orgId: string, data: UpdateSubscriptionDto): Promise<Subscription>;

  // Plan management
  getPlans(): Plan[];
  upgradePlan(orgId: string, newPlan: PlanType): Promise<Subscription>;
  downgradePlan(orgId: string, newPlan: PlanType): Promise<Subscription>;

  // Seat management
  updateSeats(orgId: string, seats: number): Promise<Subscription>;
  validateSeatChange(orgId: string, newSeats: number): Promise<SeatValidation>;

  // Billing cycle
  updateBillingCycle(orgId: string, cycle: BillingCycle): Promise<Subscription>;

  // Stripe integration
  createStripeCustomer(orgId: string, email: string): Promise<string>;
  createSetupIntent(orgId: string): Promise<string>;
  attachPaymentMethod(orgId: string, paymentMethodId: string): Promise<void>;
  createStripeSubscription(orgId: string, plan: PlanType): Promise<string>;
  updateStripeSubscription(subscriptionId: string, data: StripeUpdateDto): Promise<void>;
  cancelStripeSubscription(subscriptionId: string, atPeriodEnd: boolean): Promise<void>;

  // Webhook handlers
  handleSubscriptionUpdated(event: Stripe.Event): Promise<void>;
  handlePaymentFailed(event: Stripe.Event): Promise<void>;
  handleSubscriptionDeleted(event: Stripe.Event): Promise<void>;
}

type PlanType = 'free' | 'starter' | 'professional';
type BillingCycle = 'monthly' | 'annual';
type SubscriptionStatus = 'active' | 'past_due' | 'canceled' | 'trialing';
```

### Zod Validation Schemas

**Location:** `lib/validation/subscription.ts`

```typescript
import { z } from 'zod';

export const planSchema = z.enum(['free', 'starter', 'professional']);
export const billingCycleSchema = z.enum(['monthly', 'annual']);
export const subscriptionStatusSchema = z.enum(['active', 'past_due', 'canceled', 'trialing']);

export const subscriptionSchema = z.object({
  id: z.string().uuid(),
  org_id: z.string().uuid(),
  plan: planSchema,
  seats: z.number().int().min(1),
  billing_cycle: billingCycleSchema,
  status: subscriptionStatusSchema,
  current_period_end: z.string().datetime().nullable(),
  cancel_at_period_end: z.boolean(),
});

export const updateSubscriptionSchema = z.object({
  seats: z.number().int().min(1).optional(),
  billing_cycle: billingCycleSchema.optional(),
});

export const upgradePlanSchema = z.object({
  plan: planSchema,
  seats: z.number().int().min(1).optional(),
});

export const downgradePlanSchema = z.object({
  plan: planSchema,
});
```

## UI Components

### Pages

- `app/(authenticated)/settings/billing/page.tsx` - Billing dashboard

### Components

**Location:** `components/settings/billing/`

```
SubscriptionCard.tsx          - Current subscription summary
PlanSelector.tsx              - Plan comparison and selection
SeatManager.tsx               - Add/remove seats interface
BillingCycleToggle.tsx        - Monthly/annual switch
PaymentMethodCard.tsx         - Display current payment method
StripePaymentForm.tsx         - Stripe Elements for card input
UpgradeConfirmDialog.tsx      - Confirm plan upgrade with pricing
DowngradeConfirmDialog.tsx    - Confirm downgrade with warnings
```

### UI Patterns

**Subscription Card:**
```
+------------------------------------------+
| Current Plan: Starter                    |
| $50/user/month (billed monthly)          |
|------------------------------------------|
| Seats: 10 used / 15 purchased            |
| [============================    ] 67%   |
| Next billing: Jan 15, 2026 - $750        |
|                                          |
| Payment: Visa ending in 4242             |
|         [Update Payment Method]          |
+------------------------------------------+
```

**Plan Selector:**
```
+-------------+  +-------------+  +----------------+
|    FREE     |  |   STARTER   |  | PROFESSIONAL   |
|             |  | [CURRENT]   |  |                |
|   $0/mo     |  |  $50/user   |  |   $100/user    |
|             |  |             |  |                |
| 5 users max |  | Unlimited   |  | Unlimited      |
| Core modules|  | All modules |  | All modules    |
| Community   |  | Email       |  | Priority       |
|             |  | support     |  | support + API  |
|             |  |             |  |                |
| [Downgrade] |  |  Selected   |  |   [Upgrade]    |
+-------------+  +-------------+  +----------------+
```

## Test Cases

### Unit Tests

**subscription-service.test.ts**
```typescript
describe('SubscriptionService', () => {
  describe('validateSeatChange', () => {
    it('allows increasing seats on paid plans');
    it('allows decreasing seats above active user count');
    it('rejects decreasing seats below active user count');
    it('rejects seats > 5 on free plan');
  });

  describe('upgradePlan', () => {
    it('upgrades from free to starter');
    it('requires payment method for paid plan');
    it('calculates prorated amount correctly');
  });

  describe('downgradePlan', () => {
    it('schedules downgrade at period end');
    it('rejects downgrade if too many users for target plan');
  });
});
```

### Integration Tests

**subscription-api.test.ts**
```typescript
describe('Subscription API', () => {
  describe('GET /api/v1/settings/subscription', () => {
    it('returns subscription for admin');
    it('returns 403 for non-admin');
    it('returns 401 for unauthenticated');
  });

  describe('POST /api/v1/settings/subscription/upgrade', () => {
    it('upgrades plan with valid payment method');
    it('rejects upgrade without payment method');
    it('creates Stripe subscription on first paid plan');
  });
});
```

## Deliverables

- [ ] `subscriptions` table migration
- [ ] RLS policies for subscriptions
- [ ] Subscription service (`lib/services/subscription-service.ts`)
- [ ] Zod schemas (`lib/validation/subscription.ts`)
- [ ] API routes for subscription management
- [ ] Stripe webhook handler
- [ ] SubscriptionCard component
- [ ] PlanSelector component
- [ ] SeatManager component
- [ ] BillingCycleToggle component
- [ ] PaymentMethodCard component
- [ ] StripePaymentForm component (Stripe Elements)
- [ ] Billing settings page
- [ ] Unit tests (>80% coverage)
- [ ] Integration tests

## Definition of Done

- [ ] Three plans display correctly with features and pricing
- [ ] Current plan shows "Current Plan" badge
- [ ] Seat count displays correctly and updates on change
- [ ] Cannot reduce seats below active user count
- [ ] Free plan enforces 5 user maximum
- [ ] Billing cycle toggle works (monthly/annual)
- [ ] Annual discount (16%) displays correctly
- [ ] Payment method displays last 4 digits
- [ ] Stripe Elements form collects card securely
- [ ] Plan upgrade works with proration
- [ ] Plan downgrade schedules for period end
- [ ] Downgrade blocked if user count exceeds target plan limit
- [ ] Stripe webhook updates subscription status correctly
- [ ] RLS prevents cross-org subscription access
- [ ] Only admins can access billing page
- [ ] Unit tests pass (>80% coverage)
- [ ] Integration tests pass
