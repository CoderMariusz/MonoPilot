# Story 01.3 - Onboarding Wizard Launcher - Implementation Plan

**Created**: 2025-12-17
**Story**: 01.3 - Onboarding Wizard Launcher
**Status**: PENDING APPROVAL
**Epic**: 01-Settings (Phase 1A)

---

## Executive Summary

**Story Goal**: Detect first-time login for new organizations and launch the onboarding wizard modal. Enable progress tracking and resumption across sessions, with an option to skip wizard and create demo data.

**Complexity**: M (Medium)
**Estimated Duration**: 3-4 days
**Team Size**: Up to 4 agents in GREEN phase (parallel tracks)

**Type**: Frontend + Backend (Full-stack)
**UI Required**: Yes (Onboarding launcher modal + skip confirmation)
**Test Strategy**: TDD (RED → GREEN → REFACTOR)

---

## Story Overview

### Dependencies
- ✅ **01.1** - Org Context + Base RLS (COMPLETE)
- ✅ **01.2** - Settings Shell Navigation (COMPLETE)

### Acceptance Criteria (8 total)

| AC ID | Description | Type | Priority |
|-------|-------------|------|----------|
| AC-1 | Wizard launches automatically for new orgs (step=0) | Functional | P0 |
| AC-2 | Wizard resumes at correct step for returning users | Functional | P0 |
| AC-3 | Completed orgs bypass wizard | Functional | P0 |
| AC-4 | Non-admin users see "Setup in progress" message | Functional | P0 |
| AC-5 | Skip wizard creates demo data (warehouse + location + product) | Functional | P1 |
| AC-6 | Skip confirmation can be cancelled | Functional | P1 |
| AC-7 | Skip button visible on all wizard steps | UI | P1 |
| AC-8 | Progress saved after step completion, survives logout | Functional | P0 |

### Wireframes
- **SET-001**: Onboarding Launcher (primary)
- References: SET-002 (Step 1), SET-003 (Warehouse), SET-004 (Location)

---

## Implementation Approach

### Architecture Pattern
- **Pattern**: Multi-layered with modal guard
- **Layers**:
  1. **OnboardingGuard** - Wraps authenticated routes, checks wizard status
  2. **OnboardingWizardModal** - Full-screen modal with step navigation
  3. **useOnboardingStatus** - Hook for wizard state management
  4. **API Layer** - Backend endpoints for status/skip

### Database Schema Updates

Add to `organizations` table (verify/add if missing):

```sql
-- Migration 060: Add onboarding wizard fields
ALTER TABLE organizations ADD COLUMN IF NOT EXISTS onboarding_step INTEGER DEFAULT 0;
ALTER TABLE organizations ADD COLUMN IF NOT EXISTS onboarding_started_at TIMESTAMPTZ;
ALTER TABLE organizations ADD COLUMN IF NOT EXISTS onboarding_completed_at TIMESTAMPTZ;
ALTER TABLE organizations ADD COLUMN IF NOT EXISTS onboarding_skipped BOOLEAN DEFAULT false;

COMMENT ON COLUMN organizations.onboarding_step IS '0=not started, 1-6=current step, 6=complete';
COMMENT ON COLUMN organizations.onboarding_started_at IS 'Timestamp when wizard first shown';
COMMENT ON COLUMN organizations.onboarding_completed_at IS 'Timestamp when wizard completed or skipped';
COMMENT ON COLUMN organizations.onboarding_skipped IS 'True if user chose Skip Wizard option';
```

### API Endpoints

#### 1. GET /api/v1/settings/onboarding/status
**Purpose**: Retrieve current onboarding status for logged-in org

**Request**: None (uses session org_id)

**Response**:
```typescript
{
  step: number;              // 0-6
  started_at: string | null; // ISO timestamp
  completed_at: string | null;
  skipped: boolean;
  can_skip: boolean;         // True if admin role
}
```

**Security**: Requires authenticated session, org_id from session

#### 2. POST /api/v1/settings/onboarding/skip
**Purpose**: Skip wizard and create demo data

**Request**: `{}`

**Response**:
```typescript
{
  success: true;
  demo_data: {
    warehouse_id: string;
    location_id: string;
    product_id: string;
  };
  redirect: "/dashboard";
}
```

**Business Logic**:
1. Verify user is admin
2. Create demo warehouse: `{ code: 'DEMO-WH', name: 'Main Warehouse', type: 'general', is_default: true }`
3. Create default location: `{ code: 'DEFAULT', name: 'Default Location', type: 'zone' }`
4. Create sample product: `{ code: 'SAMPLE-001', name: 'Sample Product', uom: 'EA', status: 'active' }`
5. Set module toggles: `{ technical: true, others: false }`
6. Update org: `{ onboarding_completed_at: NOW(), onboarding_skipped: true }`

**Security**: Requires admin role

#### 3. PUT /api/v1/settings/onboarding/progress
**Purpose**: Update wizard progress (step number)

**Request**:
```typescript
{
  step: number; // 1-6
}
```

**Response**:
```typescript
{
  success: true;
  step: number;
}
```

**Security**: Requires admin role

---

## 7-Phase TDD Implementation Plan

### Phase 1: UX Design [MANDATORY - UI Story]

**Agent**: UX-DESIGNER
**Duration**: SKIP (Wireframe already exists: SET-001)
**Decision**: Use existing SET-001 wireframe (95% quality)

**Deliverables**:
- ✅ SET-001-onboarding-launcher.md (already complete)
- Component specs verified against story requirements

**Checkpoint**:
- [ ] SET-001 covers all acceptance criteria
- [ ] All UI states defined (loading, success, error, empty)
- [ ] Skip confirmation dialog specified

---

### Phase 2: RED (Test First) [MANDATORY]

**Agent**: TEST-WRITER
**Duration**: 4-6 hours
**Test Coverage Target**: 80% (Standard)

**Test Categories**:

#### Unit Tests (15 test cases)
**File**: `apps/frontend/lib/hooks/__tests__/useOnboardingStatus.test.ts`
```typescript
describe('useOnboardingStatus', () => {
  // 5 tests
  it('returns step=0 for new org')
  it('returns step=3 for org with progress')
  it('returns isComplete=true when completed_at set')
  it('returns isSkipped=true when onboarding_skipped=true')
  it('handles loading and error states')
});
```

**File**: `apps/frontend/components/onboarding/__tests__/OnboardingGuard.test.tsx`
```typescript
describe('OnboardingGuard', () => {
  // 5 tests
  it('shows wizard for admin when step < 6')
  it('shows "Setup in progress" for non-admin when incomplete')
  it('renders children when onboarding complete')
  it('handles loading state')
  it('handles error state')
});
```

**File**: `apps/frontend/components/onboarding/__tests__/OnboardingWizardModal.test.tsx`
```typescript
describe('OnboardingWizardModal', () => {
  // 5 tests
  it('displays launcher view for step 0')
  it('shows skip button on all steps')
  it('opens confirmation dialog on skip click')
  it('resumes at correct step')
  it('shows progress indicator (Step X of 6)')
});
```

#### Integration Tests (8 test cases)
**File**: `apps/frontend/__tests__/integration/onboarding-flow.test.ts`
```typescript
describe('Onboarding Flow', () => {
  // 8 tests
  it('wizard launches for new org on login')
  it('wizard resumes at saved step')
  it('skip creates demo data and redirects to dashboard')
  it('skip confirmation can be cancelled')
  it('non-admin sees setup message')
  it('completed org bypasses wizard')
  it('progress persists across logout/login')
  it('admin can navigate between steps')
});
```

#### E2E Tests (3 test cases)
**File**: `apps/frontend/__tests__/e2e/onboarding.spec.ts`
```typescript
describe('Onboarding E2E', () => {
  // 3 critical scenarios
  it('full wizard flow: launch → complete all steps')
  it('skip wizard flow: launch → skip → demo data created')
  it('resume wizard flow: start → logout → login → resume')
});
```

**Total**: 26 test cases (15 unit + 8 integration + 3 E2E)

**Checkpoint**:
- [ ] All 26 tests written and failing (RED)
- [ ] Tests cover all 8 acceptance criteria
- [ ] Test strategy documented
- [ ] Coverage targets defined (80%)

---

### Phase 3: GREEN (Implementation) [MANDATORY]

**Approach**: Parallel tracks (up to 4 agents)
**Duration**: 8-12 hours
**Target**: All tests passing (GREEN)

#### Track A: Database (BACKEND-DEV)
**Duration**: 1-2 hours

**Deliverables**:
1. `supabase/migrations/060_add_onboarding_fields.sql`
   - Add onboarding_step, onboarding_started_at, onboarding_completed_at, onboarding_skipped
   - Migration with comments

**Checkpoint**:
- [ ] Migration file created
- [ ] Fields added to organizations table
- [ ] Migration tested locally

---

#### Track B: API Endpoints (BACKEND-DEV)
**Duration**: 3-4 hours

**Deliverables**:
1. `apps/frontend/app/api/v1/settings/onboarding/status/route.ts`
   - GET handler
   - Uses org-context-service
   - Returns onboarding status

2. `apps/frontend/app/api/v1/settings/onboarding/skip/route.ts`
   - POST handler
   - Admin role check
   - Creates demo data (warehouse, location, product)
   - Updates org onboarding_skipped + onboarding_completed_at

3. `apps/frontend/app/api/v1/settings/onboarding/progress/route.ts`
   - PUT handler
   - Updates onboarding_step
   - Admin role check

**Checkpoint**:
- [ ] 3 API endpoints implemented
- [ ] Role guards applied (admin only for skip/progress)
- [ ] Error handling complete
- [ ] Demo data creation tested

---

#### Track C: Services (BACKEND-DEV)
**Duration**: 2-3 hours

**Deliverables**:
1. `apps/frontend/lib/services/onboarding-service.ts`
   ```typescript
   class OnboardingService {
     static async getStatus(orgId: string): Promise<OnboardingStatus>
     static async skipWizard(orgId: string): Promise<DemoDataResult>
     static async updateProgress(orgId: string, step: number): Promise<void>
     static async createDemoData(orgId: string): Promise<DemoDataResult>
   }
   ```

**Checkpoint**:
- [ ] Service class created
- [ ] 4 methods implemented
- [ ] Unit tests passing (from Track RED)

---

#### Track D: Frontend (FRONTEND-DEV)
**Duration**: 4-6 hours

**Deliverables**:
1. `apps/frontend/lib/hooks/useOnboardingStatus.ts`
   - Fetches onboarding status
   - Caches with SWR or React Query
   - Returns { step, isComplete, isSkipped, loading, error, refresh }

2. `apps/frontend/components/onboarding/OnboardingGuard.tsx`
   - Wraps authenticated routes
   - Shows wizard for admin if incomplete
   - Shows "Setup in progress" for non-admin

3. `apps/frontend/components/onboarding/OnboardingWizardModal.tsx`
   - Full-screen modal
   - Step indicator (Step X of 6)
   - Back/Next navigation
   - Skip button
   - Renders child step components

4. `apps/frontend/components/onboarding/OnboardingLauncher.tsx`
   - Step 0 view (SET-001)
   - Overview of 6 steps
   - Start/Skip buttons

5. `apps/frontend/components/onboarding/SkipConfirmationDialog.tsx`
   - Modal dialog
   - Explains demo data creation
   - Skip/Continue buttons

6. `apps/frontend/components/onboarding/SetupInProgressMessage.tsx`
   - Non-admin view
   - Message: "Organization setup in progress. Contact your administrator."

**Checkpoint**:
- [ ] 6 components created
- [ ] 1 hook created
- [ ] All components tested (unit tests passing)

---

**Phase 3 Complete When**:
- [ ] All 4 tracks complete
- [ ] All 26 tests passing (GREEN)
- [ ] Build succeeds
- [ ] No TypeScript errors

---

### Phase 4: REFACTOR (Clean Up) [MANDATORY]

**Agent**: SENIOR-DEV
**Duration**: 2-3 hours

**Refactoring Checklist**:
- [ ] Extract common wizard navigation logic
- [ ] Remove code duplication
- [ ] Improve component naming
- [ ] Optimize re-renders (React.memo where needed)
- [ ] Clean up error handling
- [ ] Improve JSDoc comments
- [ ] Follow MonoPilot patterns (ADR-011, ADR-012, ADR-013)

**Checkpoint**:
- [ ] No code duplication (DRY)
- [ ] Clear naming throughout
- [ ] All tests still passing (GREEN)
- [ ] No code smells

---

### Phase 5: CODE REVIEW [MANDATORY]

**Agent**: CODE-REVIEWER
**Duration**: 1-2 hours

**Review Checklist**:

#### Security
- [ ] Admin role checks on skip/progress endpoints
- [ ] Org context properly validated (ADR-013)
- [ ] No SQL injection vulnerabilities
- [ ] Session validation present

#### Quality
- [ ] Follows MonoPilot coding standards
- [ ] No code smells
- [ ] Performance acceptable
- [ ] Error handling comprehensive

#### Tests
- [ ] Tests are meaningful
- [ ] Coverage adequate (80%+)
- [ ] Tests are maintainable

#### Documentation
- [ ] Components documented (JSDoc)
- [ ] API endpoints documented
- [ ] Complex logic commented

**Checkpoint**:
- [ ] Review feedback provided
- [ ] Must Fix items addressed
- [ ] Review APPROVED

---

### Phase 6: QA VALIDATION [MANDATORY]

**Agent**: QA-AGENT
**Duration**: 2-3 hours

**Test Scenarios**:

#### Critical (P0)
1. New org (step=0) → Wizard launches automatically
2. Org with step=3 → Wizard resumes at step 3
3. Completed org → No wizard, lands on dashboard
4. Non-admin user → Sees "Setup in progress" message
5. Skip wizard → Demo data created (verify warehouse, location, product exist)

#### High (P1)
6. Skip confirmation → Can cancel and return to wizard
7. Skip button → Visible on all wizard steps
8. Progress → Saved after step completion, survives logout

**Manual Testing**:
- [ ] Test all 8 acceptance criteria
- [ ] Test edge cases (network failure, timeout)
- [ ] Test browser compatibility (Chrome, Firefox, Safari)
- [ ] Test responsive behavior (desktop, tablet, mobile)
- [ ] Test accessibility (keyboard navigation, screen reader)

**Checkpoint**:
- [ ] All 8 acceptance criteria validated
- [ ] No critical/high bugs
- [ ] Performance acceptable (<300ms load time)
- [ ] Accessibility validated (WCAG AA)

---

### Phase 7: DOCUMENTATION [MANDATORY]

**Agent**: TECH-WRITER
**Duration**: 1-2 hours

**Deliverables**:

1. **Component Documentation** (`apps/frontend/components/onboarding/README.md`)
   - OnboardingGuard usage
   - OnboardingWizardModal props
   - useOnboardingStatus hook API
   - Example code snippets

2. **API Documentation** (`docs/3-ARCHITECTURE/api/settings/onboarding.md`)
   - GET /api/v1/settings/onboarding/status
   - POST /api/v1/settings/onboarding/skip
   - PUT /api/v1/settings/onboarding/progress
   - Request/response schemas
   - Error codes

3. **Developer Guide** (`docs/3-ARCHITECTURE/guides/onboarding-wizard.md`)
   - How to add new wizard steps
   - How to customize demo data
   - How to extend onboarding flow

4. **Changelog Entry** (`CHANGELOG.md`)
   ```markdown
   ### Added
   - Onboarding Wizard Launcher for new organizations (Story 01.3)
   - Skip wizard option with demo data creation
   - Non-admin "Setup in progress" message
   - Wizard progress tracking and resumption
   ```

**Checkpoint**:
- [ ] Component docs complete
- [ ] API docs complete
- [ ] Developer guide complete
- [ ] Changelog entry added

---

## Files Summary

### Database (1 file)
- `supabase/migrations/060_add_onboarding_fields.sql`

### Backend Services (1 file)
- `apps/frontend/lib/services/onboarding-service.ts`

### API Endpoints (3 files)
- `apps/frontend/app/api/v1/settings/onboarding/status/route.ts`
- `apps/frontend/app/api/v1/settings/onboarding/skip/route.ts`
- `apps/frontend/app/api/v1/settings/onboarding/progress/route.ts`

### Frontend Components (6 files)
- `apps/frontend/components/onboarding/OnboardingGuard.tsx`
- `apps/frontend/components/onboarding/OnboardingWizardModal.tsx`
- `apps/frontend/components/onboarding/OnboardingLauncher.tsx`
- `apps/frontend/components/onboarding/SkipConfirmationDialog.tsx`
- `apps/frontend/components/onboarding/SetupInProgressMessage.tsx`
- `apps/frontend/components/onboarding/OnboardingStepIndicator.tsx`

### Frontend Hooks (1 file)
- `apps/frontend/lib/hooks/useOnboardingStatus.ts`

### Tests (4 files)
- `apps/frontend/lib/hooks/__tests__/useOnboardingStatus.test.ts`
- `apps/frontend/components/onboarding/__tests__/OnboardingGuard.test.tsx`
- `apps/frontend/components/onboarding/__tests__/OnboardingWizardModal.test.tsx`
- `apps/frontend/__tests__/integration/onboarding-flow.test.ts`
- `apps/frontend/__tests__/e2e/onboarding.spec.ts`

### Documentation (4 files)
- `apps/frontend/components/onboarding/README.md`
- `docs/3-ARCHITECTURE/api/settings/onboarding.md`
- `docs/3-ARCHITECTURE/guides/onboarding-wizard.md`
- `CHANGELOG.md` (entry)

**Total**: 24 files (1 migration + 1 service + 3 API + 7 components + 5 tests + 4 docs)

---

## Success Metrics

| Metric | Target | Measurement |
|--------|--------|-------------|
| Test Coverage | 80%+ | Vitest coverage report |
| Test Pass Rate | 100% | All 26 tests passing |
| Build Success | 100% | No TypeScript errors |
| Code Review | APPROVED | CODE-REVIEWER approval |
| QA Pass Rate | 100% | All 8 AC validated |
| Performance | <300ms | Wizard launch time |
| Accessibility | WCAG AA | Keyboard nav + screen reader |

---

## Risk Assessment

| Risk | Impact | Mitigation |
|------|--------|------------|
| Demo data creation fails | HIGH | Rollback transaction, show error message |
| Wizard state lost on logout | MEDIUM | Persist to DB (onboarding_step), not session |
| Non-admin sees wizard | HIGH | Guard with role check in OnboardingGuard |
| Skip confirmation dismissed accidentally | LOW | Clear dialog with 2 buttons (no outside click) |

---

## Definition of Done

- [ ] All 8 acceptance criteria validated
- [ ] All 26 tests passing (100%)
- [ ] Code review APPROVED
- [ ] QA validation PASSED
- [ ] Documentation complete
- [ ] Migration tested locally
- [ ] Demo data creation tested
- [ ] Performance target met (<300ms)
- [ ] Accessibility validated (WCAG AA)
- [ ] Changelog updated
- [ ] Story marked DONE in PROJECT-STATE.md

---

## Next Steps After Approval

1. **Phase 1: UX Design** - SKIP (use SET-001)
2. **Phase 2: RED** - TEST-WRITER agent (4-6 hours)
3. **Phase 3: GREEN** - 4 parallel agents (8-12 hours)
   - Track A: BACKEND-DEV (Database)
   - Track B: BACKEND-DEV (API Endpoints)
   - Track C: BACKEND-DEV (Services)
   - Track D: FRONTEND-DEV (Components + Hooks)
4. **Phase 4: REFACTOR** - SENIOR-DEV (2-3 hours)
5. **Phase 5: CODE REVIEW** - CODE-REVIEWER (1-2 hours)
6. **Phase 6: QA VALIDATION** - QA-AGENT (2-3 hours)
7. **Phase 7: DOCUMENTATION** - TECH-WRITER (1-2 hours)

**Total Estimated Duration**: 20-30 hours (3-4 days)

---

**Status**: ⏳ PENDING USER APPROVAL
**Created by**: ORCHESTRATOR
**Created at**: 2025-12-17
