# 01.5b - User Warehouse Access Restrictions (Phase 1B)

**Priority:** P1 (Phase 1B - Infrastructure)
**Story Points:** M (Medium)
**Type:** frontend + backend

**State:** planned (Q1 2026)
**Primary PRD:** `docs/1-BASELINE/product/modules/settings.md` (FR-SET-018)
**UX Wireframes:** SET-009 (User Modal - Warehouse Access section, lines 49-117)

---

## Phase 1B Scope

This story implements FR-SET-018 (User Warehouse Access Restrictions) which was deferred from the MVP to Phase 1B. It extends the user management functionality from Story 01.5a.

---

## Goal

Implement user-level warehouse access restrictions. Users can only view and modify inventory in warehouses they have been granted access to. Super admins and admins have access to all warehouses by default.

## User Story

As an **Administrator**, I want to **restrict which warehouses a user can access** so that **multi-warehouse operations maintain proper data isolation and users only see relevant inventory**.

## Scope

**In scope (Phase 1B)**
- Warehouse access multi-select UI in user modal (SET-009, lines 49-117)
- "All Warehouses" checkbox (default ON for admin/super_admin)
- API endpoints for warehouse access assignment:
  - GET /api/v1/settings/users/:id/warehouse-access
  - PUT /api/v1/settings/users/:id/warehouse-access
- RLS enforcement on warehouse-level operations
- Warehouse access column in users table (enable existing column)
- Audit trail for access changes

**Out of scope (this story)**
- User CRUD (implemented in 01.5a)
- Role assignment (implemented in 01.5a)
- Warehouse CRUD (implemented in Epic 01b.1)
- Per-warehouse permission levels (read/write/admin) - future enhancement

## Dependencies

- **01.5a** - User Management CRUD (must be merged to main)
- **Epic 01b.1** - Warehouse CRUD (warehouses must exist to assign)

## Acceptance Criteria (Given/When/Then)

### AC-1: Warehouse Access Multi-Select

**Given** admin opens user create/edit modal
**When** modal loads
**Then** warehouse access section displays with:
  - "All Warehouses" checkbox (default ON for new users)
  - Multi-select dropdown for specific warehouses

**Given** "All Warehouses" checkbox is checked
**When** user views dropdown
**Then** dropdown is disabled (all warehouses implied)

**Given** "All Warehouses" checkbox is unchecked
**When** user views dropdown
**Then** dropdown is enabled, showing all available warehouses

**Given** user unchecks "All Warehouses" and selects WH-001, WH-002
**When** save clicked
**Then** user's warehouse_access_ids = ['WH-001-UUID', 'WH-002-UUID']

### AC-2: RLS Enforcement (FR-SET-018)

**Given** user has access to WH-001 only
**When** viewing inventory module
**Then** only WH-001 inventory displays

**Given** user has no warehouse access assigned
**When** accessing warehouse-dependent modules
**Then** error message "No warehouse access configured" displays

**Given** super_admin or admin role
**When** accessing any module
**Then** all warehouses are accessible (bypass restriction)

**Given** user warehouse access is changed
**When** user refreshes page
**Then** new access permissions apply immediately

### AC-3: Warehouse Dropdown in Modules

**Given** admin assigns warehouse access in user profile
**When** user logs in
**Then** only assigned warehouses appear in warehouse dropdown filters

**Given** user has access to WH-001, WH-003
**When** viewing inventory filter dropdown
**Then** only WH-001 and WH-003 appear as options

### AC-4: Default Behavior

**Given** new user is created (01.5a)
**When** warehouse_access_ids is NULL
**Then** for admin/super_admin: interpret as "all warehouses"
**Then** for other roles: interpret as "no warehouses" (must be explicitly granted)

**Given** existing user has warehouse_access_ids = NULL
**When** admin opens edit modal
**Then** "All Warehouses" checkbox is checked for admin/super_admin roles
**Then** "All Warehouses" checkbox is unchecked for other roles (warning shown)

### AC-5: API Endpoints

**Given** GET /api/v1/settings/users/:id/warehouse-access called
**When** user has specific warehouses assigned
**Then** response includes: `{ warehouse_ids: ['id1', 'id2'], all_warehouses: false }`

**Given** PUT /api/v1/settings/users/:id/warehouse-access called
**When** body = `{ warehouse_ids: ['id1', 'id2'], all_warehouses: false }`
**Then** user's warehouse_access_ids updated

**Given** PUT with `{ all_warehouses: true }`
**When** request processed
**Then** user's warehouse_access_ids set to NULL (all access)

### AC-6: Audit Trail

**Given** admin changes user's warehouse access
**When** change is saved
**Then** audit log entry created with:
  - Who made the change (admin user ID)
  - What changed (old warehouse list -> new warehouse list)
  - When (timestamp)

### AC-7: Cascading Delete

**Given** warehouse WH-001 is deleted (Epic 01b.1)
**When** user had access to WH-001
**Then** WH-001 is removed from user's warehouse_access_ids automatically

## Implementation Notes

### API Endpoints

```typescript
// GET /api/v1/settings/users/:id/warehouse-access
interface WarehouseAccessResponse {
  user_id: string;
  all_warehouses: boolean;
  warehouse_ids: string[];
  warehouses: { id: string; code: string; name: string }[];
}

// PUT /api/v1/settings/users/:id/warehouse-access
interface UpdateWarehouseAccessRequest {
  all_warehouses: boolean;
  warehouse_ids?: string[]; // Required if all_warehouses = false
}
```

### Database

**NO MIGRATION NEEDED** - Column exists from 01.5a (nullable)

```sql
-- Existing column in users table (from 01.5a):
warehouse_access_ids UUID[]  -- NULL = all warehouses (for admin/super_admin)

-- Business logic interpretation:
-- NULL + role IN (SUPER_ADMIN, ADMIN) = all warehouses
-- NULL + role NOT IN (SUPER_ADMIN, ADMIN) = no warehouses (warning)
-- [...ids] = specific warehouses only
```

**Optional: Junction table for audit (recommended)**

```sql
-- For detailed audit trail
CREATE TABLE user_warehouse_access_log (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id),
  user_id UUID NOT NULL REFERENCES users(id),
  warehouse_id UUID REFERENCES warehouses(id), -- NULL for "all warehouses" changes
  action TEXT NOT NULL, -- 'granted', 'revoked', 'all_warehouses_enabled', 'all_warehouses_disabled'
  changed_by UUID NOT NULL REFERENCES users(id),
  changed_at TIMESTAMPTZ DEFAULT NOW()
);
```

### Service Extension Pattern

```typescript
// lib/services/user-warehouse-service.ts
import { UserService } from './user-service';

export class UserWarehouseService extends UserService {
  // Extend base UserService, don't modify it

  async getWarehouseAccess(userId: string): Promise<WarehouseAccessResponse> {
    const user = await this.getUser(userId);
    const role = await this.getUserRole(userId);

    if (user.warehouse_access_ids === null) {
      const isAdmin = ['SUPER_ADMIN', 'ADMIN'].includes(role.code);
      return {
        user_id: userId,
        all_warehouses: isAdmin,
        warehouse_ids: [],
        warehouses: isAdmin ? await this.getAllWarehouses() : []
      };
    }

    const warehouses = await this.getWarehousesByIds(user.warehouse_access_ids);
    return {
      user_id: userId,
      all_warehouses: false,
      warehouse_ids: user.warehouse_access_ids,
      warehouses
    };
  }

  async updateWarehouseAccess(
    userId: string,
    data: UpdateWarehouseAccessRequest
  ): Promise<void> {
    const currentAccess = await this.getWarehouseAccess(userId);

    if (data.all_warehouses) {
      await db.users.update(userId, { warehouse_access_ids: null });
    } else {
      await db.users.update(userId, { warehouse_access_ids: data.warehouse_ids });
    }

    // Audit log
    await this.logAccessChange(userId, currentAccess, data);
  }

  private async logAccessChange(
    userId: string,
    oldAccess: WarehouseAccessResponse,
    newAccess: UpdateWarehouseAccessRequest
  ): Promise<void> {
    // Insert audit log entries
  }
}
```

### RLS Policy Extension

```sql
-- Example: Inventory items filtered by user warehouse access
CREATE POLICY "inventory_warehouse_access" ON inventory_items
FOR SELECT USING (
  -- Check if user has access to the warehouse
  warehouse_id IN (
    SELECT unnest(warehouse_access_ids)
    FROM users
    WHERE id = auth.uid()
  )
  OR
  -- OR user is admin/super_admin with NULL (all access)
  (
    (SELECT warehouse_access_ids FROM users WHERE id = auth.uid()) IS NULL
    AND
    (SELECT r.code FROM roles r JOIN users u ON u.role_id = r.id WHERE u.id = auth.uid()) IN ('SUPER_ADMIN', 'ADMIN')
  )
);
```

### Frontend Components

```
components/settings/users/
  WarehouseAccessSection.tsx    -- Multi-select with "All Warehouses" checkbox
  WarehouseAccessBadge.tsx      -- Badge showing access status in user list
```

**Enable SET-009 warehouse access section (lines 49-117):**

```tsx
// UserModal.tsx - Phase 1B update
{/* Previously hidden, now enabled */}
<WarehouseAccessSection
  value={formData.warehouse_access_ids}
  allWarehousesChecked={formData.all_warehouses}
  onChange={(ids, allWarehouses) => {
    setFormData({
      ...formData,
      warehouse_access_ids: ids,
      all_warehouses: allWarehouses
    });
  }}
  availableWarehouses={warehouses}
  disabled={!can('users', 'U')}
/>
```

### Validation (Zod)

```typescript
const warehouseAccessSchema = z.object({
  all_warehouses: z.boolean(),
  warehouse_ids: z.array(z.string().uuid()).optional()
}).refine(data => {
  // If not all warehouses, must have at least one warehouse
  if (!data.all_warehouses && (!data.warehouse_ids || data.warehouse_ids.length === 0)) {
    return false;
  }
  return true;
}, {
  message: "At least one warehouse must be selected when 'All Warehouses' is unchecked"
});
```

## Deliverables

- API routes: GET/PUT `/api/v1/settings/users/:id/warehouse-access`
- WarehouseAccessSection component
- UserWarehouseService extending UserService
- RLS policy updates for warehouse-scoped tables
- Audit logging for access changes
- Integration tests for warehouse access assignment
- Unit tests for user-warehouse-service

## Definition of Done

- [ ] Warehouse access multi-select displays in user modal
- [ ] "All Warehouses" checkbox works correctly
- [ ] API endpoints for warehouse access work end-to-end
- [ ] RLS enforcement filters inventory by user access
- [ ] Admin/Super Admin bypass works (all warehouses)
- [ ] Audit log captures access changes
- [ ] Cascading delete removes user from deleted warehouse
- [ ] SET-009 wireframe fully implemented (lines 49-117 enabled)
- [ ] All API endpoints have integration tests
- [ ] Unit tests cover user-warehouse-service (>80% coverage)

---

## Testing Strategy

### Test File

**File:** `__tests__/01-settings/01.5b.warehouse-access.test.ts`

**Coverage:**
- Warehouse assignment (single, multiple)
- "All Warehouses" checkbox behavior
- Admin/Super Admin bypass
- RLS enforcement on warehouse operations
- Warehouse access removal
- Cascading delete (if warehouse deleted)
- Audit log creation

### Integration Test (runs both 01.5a + 01.5b)

**File:** `__tests__/01-settings/01.5.integration.test.ts`

```typescript
describe('User Management Integration', () => {
  it('creates user, assigns role, assigns warehouses, verifies RLS', async () => {
    // 1. Create user (01.5a)
    // 2. Assign role (01.5a)
    // 3. Assign warehouses (01.5b)
    // 4. Verify RLS filters inventory (01.5b)
  });
});
```

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-12-16 | Created from 01.5 split, FR-SET-018 scope | ARCHITECT-AGENT |
