# Epic 01 - Settings Module (Full MVP)

**Epic ID:** 01
**Module:** Settings
**Status:** READY FOR DEVELOPMENT
**Type:** Full MVP (Functional System)
**Last Updated:** 2025-12-16

**Primary References:**
- PRD: `docs/1-BASELINE/product/modules/settings.md`
- Architecture: `docs/1-BASELINE/architecture/modules/settings.md`
- UX Wireframes: `docs/3-ARCHITECTURE/ux/wireframes/SET-001` to `SET-029`
- Dependency Analysis: `MVP-DEPENDENCY-ANALYSIS.md`

---

## Architecture Decisions (ADRs)

| ADR | Decision | Stories |
|-----|----------|---------|
| ADR-011 | Module Toggle Storage | 01.1, 01.7 |
| ADR-012 | Role Permission Storage | 01.1, 01.5, 01.6 |
| ADR-013 | RLS Org Isolation Pattern | 01.1, 01.5-01.14 |

**ADR Locations:** `docs/1-BASELINE/architecture/decisions/`

---

## Goal

Deliver a **fully functional Settings module** that enables:
- Multi-tenant organization configuration with RLS foundation
- User management with 10-role permission system
- **Complete infrastructure setup** (warehouses, locations, machines, production lines)
- **Master data management** (allergens, tax codes)
- **Full 15-minute onboarding wizard** (competitive differentiator)
- Module activation/deactivation toggles

This epic provides **everything needed** for Technical, Planning, Production, Warehouse, Quality, and Shipping modules to function.

---

## MVP Philosophy Change (2025-12-16)

**Previous approach:** Settings "foundation only" → Operational modules blocked
**New approach:** Settings "functional system" → All modules can operate

See `MVP-DEPENDENCY-ANALYSIS.md` for full dependency matrix proving this change.

---

## Story Index (Phase 1A - Full MVP)

### Foundation (Stories 01.1 - 01.7)

| Story | Name | PRD FRs | Dependencies | Complexity |
|------:|------|---------|--------------|------------|
| 01.1 | Org context + base RLS | FR-SET-002 | -- | M |
| 01.2 | Settings shell: navigation + guards | FR-SET-030/031 | 01.1 | S |
| 01.3 | Onboarding wizard framework | FR-SET-180/186/187 | 01.2 | M |
| 01.4 | Organization profile (Wizard Step 1) | FR-SET-001/003/004/181 | 01.3 | M |
| 01.5 | Users CRUD | FR-SET-010/012/017 | 01.6 | L |
| 01.6 | Role-based permissions (10 roles) | FR-SET-011/020-031 | 01.1 | M |
| 01.7 | Module toggles | FR-SET-090-097 | 01.6 | M |

### Infrastructure (Stories 01.8 - 01.11)

| Story | Name | PRD FRs | Dependencies | Complexity |
|------:|------|---------|--------------|------------|
| 01.8 | Warehouses CRUD | FR-SET-040-046 | 01.1, 01.6 | M |
| 01.9 | Locations CRUD | FR-SET-042-044 | 01.8 | M |
| 01.10 | Machines CRUD | FR-SET-050-055 | 01.1, 01.6, 01.8, 01.9 | M |
| 01.11 | Production Lines CRUD | FR-SET-060-065 | 01.10 | L |

### Master Data (Stories 01.12 - 01.13)

| Story | Name | PRD FRs | Dependencies | Complexity |
|------:|------|---------|--------------|------------|
| 01.12 | Allergens (14 EU) | FR-SET-070-073 | 01.1 | S |
| 01.13 | Tax Codes CRUD | FR-SET-080-084 | 01.1 | S |
| 01.15 | Session + Password Management | FR-SET-013/014 | 01.1, 01.6 | M |
| 01.16 | User Invitations | FR-SET-012 | 01.5, 01.1 | M |

### Onboarding Complete (Story 01.14)

| Story | Name | PRD FRs | Dependencies | Complexity |
|------:|------|---------|--------------|------------|
| 01.14 | Wizard Steps 2-6 | FR-SET-182-185/188 | 01.3, 01.4, 01.8, 01.9 | L |

---

## Summary

| Phase | Stories | Estimated Days |
|-------|---------|----------------|
| **Phase 1A (MVP)** | **16 stories** | **18-21 days** |
| Phase 1B (Polish) | 4 stories | 5-7 days |
| Phase 2 (Integrations) | 3 stories | 5-7 days |
| Phase 3 (Enterprise) | 3 stories | 5-7 days |

---

## Story Dependency Graph

```
01.1 (Org Context + RLS)
  │
  ├──► 01.2 (Settings Shell)
  │      │
  │      └──► 01.3 (Wizard Framework)
  │             │
  │             ├──► 01.4 (Org Profile - Step 1)
  │             │
  │             └──► 01.14 (Wizard Steps 2-6) ◄── 01.8, 01.9
  │
  ├──► 01.6 (Roles & Permissions)
  │      │
  │      ├──► 01.5 (Users CRUD)
  │      │
  │      └──► 01.7 (Module Toggles)
  │
  ├──► 01.8 (Warehouses CRUD)
  │      │
  │      └──► 01.9 (Locations CRUD)
  │             │
  │             └──► 01.10 (Machines CRUD)
  │                    │
  │                    └──► 01.11 (Production Lines CRUD)
  │
  ├──► 01.12 (Allergens) ── no deps, seeded data
  │
  └──► 01.13 (Tax Codes) ── no deps
```

**Critical Path:** 01.1 → 01.8 → 01.9 → 01.10 → 01.11

---

## PRD Requirements Coverage (Phase 1A MVP)

### Organization & Users (01.1 - 01.7)

| Req ID | Requirement | Story |
|--------|-------------|-------|
| FR-SET-001 | Organization profile | 01.4 |
| FR-SET-002 | Multi-tenant isolation | 01.1 |
| FR-SET-003 | Timezone and locale | 01.4 |
| FR-SET-004 | Currency configuration | 01.4 |
| FR-SET-010 | User CRUD operations | 01.5 |
| FR-SET-011 | 10-role permission system | 01.6 |
| FR-SET-017 | User deactivation/archiving | 01.5 |
| FR-SET-020-029 | Role definitions (10 roles) | 01.6 |
| FR-SET-030/031 | Module/CRUD permissions | 01.6 |
| FR-SET-012 | User invitations | 01.16 |
| FR-SET-013 | Session management | 01.15 |
| FR-SET-014 | Password policies | 01.15 |
| FR-SET-090-097 | Module toggles | 01.7 |
| FR-SET-180/186/187 | Wizard framework | 01.3 |
| FR-SET-181 | Org profile step | 01.4 |

### Infrastructure (01.8 - 01.11)

| Req ID | Requirement | Story |
|--------|-------------|-------|
| FR-SET-040 | Warehouse CRUD | 01.8 |
| FR-SET-041 | Warehouse types | 01.8 |
| FR-SET-042 | Location hierarchy | 01.9 |
| FR-SET-043 | Location capacity | 01.9 |
| FR-SET-044 | Location types | 01.9 |
| FR-SET-045 | Warehouse address/contact | 01.8 |
| FR-SET-046 | Default warehouse | 01.8 |
| FR-SET-050 | Machine CRUD | 01.10 |
| FR-SET-051 | Machine types | 01.10 |
| FR-SET-052 | Machine status | 01.10 |
| FR-SET-053 | Machine capacity | 01.10 |
| FR-SET-055 | Machine location | 01.10 |
| FR-SET-060 | Production line CRUD | 01.11 |
| FR-SET-061 | Machine assignment | 01.11 |
| FR-SET-062 | Line sequence | 01.11 |
| FR-SET-063 | Line capacity (bottleneck) | 01.11 |
| FR-SET-064 | Line status | 01.11 |
| FR-SET-065 | Line-product compatibility | 01.11 |

### Master Data (01.12 - 01.13)

| Req ID | Requirement | Story |
|--------|-------------|-------|
| FR-SET-070 | 14 EU allergens | 01.12 |
| FR-SET-071 | Allergen codes | 01.12 |
| FR-SET-072 | Multi-language labels | 01.12 |
| FR-SET-073 | Allergen icons | 01.12 |
| FR-SET-080 | Tax code CRUD | 01.13 |
| FR-SET-081 | Tax rate configuration | 01.13 |
| FR-SET-082 | Tax jurisdiction | 01.13 |
| FR-SET-083 | Effective date ranges | 01.13 |
| FR-SET-084 | Default tax code | 01.13 |

### Onboarding Wizard Complete (01.14)

| Req ID | Requirement | Story |
|--------|-------------|-------|
| FR-SET-182 | First warehouse step | 01.14 |
| FR-SET-183 | First location step | 01.14 |
| FR-SET-184 | First product step | 01.14 |
| FR-SET-185 | First work order step | 01.14 |
| FR-SET-188 | Wizard completion | 01.14 |

---

## Phase 1B (Polish) - Deferred

| Story | Name | PRD FRs |
|------:|------|---------|
| 01.15 | User Warehouse Access | FR-SET-018 |
| 01.16 | Audit Trail | FR-SET-140-146 |
| 01.17 | Security Policies | FR-SET-171-173 |
| 01.18 | Multi-language UI | FR-SET-110-116 |

## Phase 2 (Integrations) - Deferred

| Story | Name | PRD FRs |
|------:|------|---------|
| 01.19 | API Keys | FR-SET-120-125 |
| 01.20 | Webhooks | FR-SET-130-135 |
| 01.21 | Notifications | FR-SET-160-163 |

## Phase 3 (Enterprise) - Deferred

| Story | Name | PRD FRs |
|------:|------|---------|
| 01.22 | Billing & Subscription | FR-SET-100-106 |
| 01.23 | Import/Export | FR-SET-150-155 |
| 01.24 | IP Whitelist + GDPR | FR-SET-170/174 |

---

## Database Tables (Created in Phase 1A MVP)

| Table | Story | Notes |
|-------|-------|-------|
| `organizations` | 01.1 | Core org data + onboarding state |
| `users` | 01.1 | User accounts with role assignment |
| `roles` | 01.1 | 10 predefined roles (ADR-012) |
| `modules` | 01.1 | Module definitions (ADR-011) |
| `organization_modules` | 01.1 | Org-specific module state |
| `warehouses` | 01.8 | Warehouse master data |
| `locations` | 01.9 | Location hierarchy |
| `machines` | 01.10 | Machine configuration |
| `production_lines` | 01.11 | Production line definitions |
| `production_line_machines` | 01.11 | Machine-to-line assignments |
| `production_line_products` | 01.11 | Line-product compatibility |
| `allergens` | 01.12 | 14 EU allergens (seeded) |
| `tax_codes` | 01.13 | Tax code master data |
| `user_sessions` | 01.15 | Session tracking |
| `user_invitations` | 01.16 | Pending invitations |

---

## UI Pages (Created in Phase 1A MVP)

```
apps/frontend/app/(authenticated)/settings/
├── page.tsx                    -- 01.2 Dashboard
├── organization/page.tsx       -- 01.4 Org profile
├── users/page.tsx              -- 01.5 User list
├── warehouses/
│   ├── page.tsx               -- 01.8 Warehouse list
│   └── [id]/page.tsx          -- 01.8 + 01.9 Detail + locations
├── machines/page.tsx           -- 01.10 Machine list
├── production-lines/
│   ├── page.tsx               -- 01.11 Line list
│   └── [id]/page.tsx          -- 01.11 Line detail
├── allergens/page.tsx          -- 01.12 Allergen list (read-only)
├── tax-codes/page.tsx          -- 01.13 Tax code list
├── security/page.tsx           -- 01.15 Session + Password
└── modules/page.tsx            -- 01.7 Module toggles
```

---

## Definition of Done (Epic 01 Phase 1A)

### Foundation
- [ ] Organization context established with RLS on all tables
- [ ] Settings shell with navigation and route guards
- [ ] 10 roles with correct permission matrix enforced
- [ ] Module toggles with dependency validation
- [ ] User CRUD with role assignment

### Infrastructure
- [ ] Warehouse CRUD with type/status management
- [ ] Location hierarchy with capacity tracking
- [ ] Machine CRUD with status management
- [ ] Production line configuration with machine assignments

### Master Data
- [ ] 14 EU allergens seeded and displayed
- [ ] Tax code CRUD with effective dates

### Onboarding
- [ ] Complete 6-step wizard flow
- [ ] "15-minute onboarding" achievable
- [ ] Skip creates demo data

### Quality
- [ ] All stories have unit tests (>80% coverage)
- [ ] Integration tests for API endpoints
- [ ] E2E smoke tests for critical flows

---

## Success Metrics

- [ ] Demo: Full onboarding wizard completion <15 minutes
- [ ] All 10 roles enforced correctly
- [ ] Module toggles hide/show navigation items
- [ ] Production module can assign WO to line
- [ ] Warehouse module can receive to location
- [ ] Response time <500ms for all Settings APIs

---

## Handoff to DEV Agents

```yaml
epic: "01-settings"
epic_folder: docs/2-MANAGEMENT/epics/current/01-settings/
stories_phase_1a: 16
estimated_days: 18-21
start_story: "01.1.org-context-base-rls"

story_files:
  foundation:
    - 01.1.org-context-base-rls.md
    - 01.2.settings-shell-navigation.md
    - 01.3.onboarding-wizard-launcher.md
    - 01.4.organization-profile-step.md
    - 01.5.users-crud.md (or 01.5a + 01.5b)
    - 01.6.role-permissions.md
    - 01.7.module-toggles.md
  infrastructure:
    - 01.8.warehouses-crud.md
    - 01.9.locations-crud.md
    - 01.10.machines-crud.md
    - 01.11.production-lines-crud.md
  master_data:
    - 01.12.allergens-management.md
    - 01.13.tax-codes-crud.md
    - 01.15.session-password-management.md
    - 01.16.user-invitations.md
  onboarding:
    - 01.14.wizard-steps-complete.md

parallel_tracks:
  track_1: [01.1, 01.2, 01.3, 01.4, 01.14]  # Wizard flow
  track_2: [01.1, 01.6, 01.5, 01.7]          # Users/Roles
  track_3: [01.1, 01.8, 01.9, 01.10, 01.11]  # Infrastructure
  track_4: [01.1, 01.12, 01.13]              # Master data

adrs:
  - ADR-011: Module Toggle Storage
  - ADR-012: Role Permission Storage
  - ADR-013: RLS Org Isolation Pattern
```

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-12-15 | Initial epic overview (7 stories) | ARCHITECT-AGENT |
| 2.0 | 2025-12-16 | Split 01.5 into 01.5a + 01.5b | ARCHITECT-AGENT |
| **3.0** | **2025-12-16** | **Expanded MVP: 14 stories (infrastructure + master data + wizard)** | **ORCHESTRATOR** |
