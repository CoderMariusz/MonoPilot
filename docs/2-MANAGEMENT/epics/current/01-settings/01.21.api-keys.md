# 01.21 - API Keys Management

**Story ID:** 01.21
**Epic:** 01 - Settings
**Phase:** 2 (Integrations)
**Complexity:** M (Medium)
**Estimate:** 2-3 days
**Type:** Backend + Frontend
**State:** ready

**Primary PRD:** `docs/1-BASELINE/product/modules/settings.md` (FR-SET-120 to FR-SET-125)
**UX Wireframes:** SET-021 (API Keys List), SET-022 (Create API Key)

## PRD References

| FR ID | Requirement | Priority | Phase | Covered |
|-------|-------------|----------|-------|---------|
| FR-SET-120 | API key generation | P1 | 2 | Yes |
| FR-SET-121 | API key revocation | P1 | 2 | Yes |
| FR-SET-122 | API key expiration dates | P1 | 2 | Yes |
| FR-SET-123 | API key permissions/scopes | P1 | 2 | Yes |
| FR-SET-124 | API key usage tracking | P2 | 2 | Yes |
| FR-SET-125 | API key rate limiting | P2 | 2 | Yes |

## User Story

**As an** administrator,
**I want** to generate and manage API keys for external integrations,
**So that** third-party systems can securely access MonoPilot data programmatically.

**As a** developer,
**I want** API keys with specific scopes and rate limits,
**So that** I can control access levels and prevent abuse.

## Goal

Implement secure API key management allowing organizations to generate, track, and revoke API keys for external integrations. Keys are stored hashed (never plain text), support granular scopes, optional expiration, and usage tracking with configurable rate limiting.

## Scope

**In scope:**
- Generate 256-bit random API keys (prefixed "mpk_")
- Store hashed (SHA-256), display only key prefix
- Show full key once at creation (copy to clipboard)
- Optional expiration date
- Scopes: read_only, read_write, admin
- Track last_used_at on every API call
- Request count tracking
- Rate limiting per key (configurable, default 100/min)
- Revoke/delete keys
- Usage statistics dashboard

**Out of scope:**
- IP whitelisting per key (Phase 3)
- Key rotation automation
- OAuth2 / JWT tokens (separate feature)
- Per-endpoint rate limiting

## Dependencies

| Story | Requirement | Status |
|-------|-------------|--------|
| 01.1 | Org Context + Base RLS | Required - provides org_id |
| 01.6 | Role Permissions | Required - admin-only access |

## Acceptance Criteria (Given/When/Then)

### API Key Generation (FR-SET-120)

#### Key Creation
- GIVEN admin navigates to Settings > API Keys, WHEN they click "Create API Key", THEN creation modal opens.
- GIVEN creation modal, WHEN admin enters name "Production API" and scope "read_write", THEN key is generated.
- GIVEN key generated, WHEN modal displays result, THEN full key shown once with "Copy" button.
- GIVEN key displayed, WHEN admin closes modal, THEN full key never shown again (only prefix).
- GIVEN key created, WHEN stored in database, THEN SHA-256 hash stored (never plain text).

#### Key Format
- GIVEN key generation, WHEN key created, THEN format is "mpk_" + 43 random alphanumeric characters (256-bit).
- GIVEN key stored, WHEN prefix displayed, THEN shows "mpk_" + first 8 characters (e.g., "mpk_abc12345...").

### API Key Revocation (FR-SET-121)

#### Revoke Key
- GIVEN API keys list, WHEN admin clicks "Revoke" on a key, THEN confirmation dialog appears.
- GIVEN confirmation dialog, WHEN admin confirms, THEN key marked as revoked with timestamp.
- GIVEN revoked key, WHEN external system uses it, THEN 401 Unauthorized returns.
- GIVEN revoked key, WHEN displayed in list, THEN shows "Revoked" badge with revocation date.
- GIVEN revoked key, WHEN admin clicks "Delete", THEN key permanently removed from database.

### API Key Expiration (FR-SET-122)

#### Expiration Date
- GIVEN key creation modal, WHEN admin sets expiration date, THEN expires_at stored.
- GIVEN key with expiration, WHEN current time past expires_at, THEN key returns 401 on use.
- GIVEN expired key, WHEN displayed in list, THEN shows "Expired" badge.
- GIVEN key without expiration, WHEN created, THEN expires_at is NULL (never expires).

### API Key Scopes (FR-SET-123)

#### Scope Assignment
- GIVEN key creation, WHEN admin selects "read_only", THEN key can only access GET endpoints.
- GIVEN key creation, WHEN admin selects "read_write", THEN key can access GET, POST, PUT, PATCH endpoints.
- GIVEN key creation, WHEN admin selects "admin", THEN key can access all endpoints including DELETE.
- GIVEN key with "read_only" scope, WHEN POST request made, THEN 403 Forbidden returns.

#### Scope Validation
- GIVEN API request with key, WHEN endpoint requires write access, THEN scope checked before processing.
- GIVEN scope check fails, WHEN response sent, THEN error includes "INSUFFICIENT_SCOPE" code.

### API Key Usage Tracking (FR-SET-124)

#### Usage Metrics
- GIVEN API key used, WHEN request processed, THEN last_used_at updated to current timestamp.
- GIVEN API key used, WHEN request processed, THEN request_count incremented by 1.
- GIVEN key usage view, WHEN admin clicks "View Usage", THEN usage statistics displayed.
- GIVEN usage statistics, WHEN displayed, THEN shows: total requests, last used, requests per day chart.

### Rate Limiting (FR-SET-125)

#### Rate Limit Enforcement
- GIVEN key with rate_limit_per_minute = 100, WHEN 101st request in minute, THEN 429 Too Many Requests returns.
- GIVEN rate limit exceeded, WHEN response sent, THEN includes Retry-After header.
- GIVEN key creation, WHEN rate limit not specified, THEN default 100 requests/minute applied.
- GIVEN key creation, WHEN admin sets custom rate limit, THEN specified limit enforced.

#### Rate Limit Headers
- GIVEN API request processed, WHEN response sent, THEN includes X-RateLimit-Limit header.
- GIVEN API request processed, WHEN response sent, THEN includes X-RateLimit-Remaining header.
- GIVEN API request processed, WHEN response sent, THEN includes X-RateLimit-Reset header.

### Multi-tenancy
- GIVEN User A from Org A creates key, WHEN key used, THEN only accesses Org A data.
- GIVEN User A from Org A, WHEN viewing keys, THEN only Org A keys displayed.
- GIVEN User A from Org A, WHEN attempting to revoke Org B key, THEN 404 Not Found returns.

## Technical Specification

### Database Schema

#### api_keys table

```sql
CREATE TABLE api_keys (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,

  -- Key identification
  name VARCHAR(100) NOT NULL,
  key_hash VARCHAR(64) NOT NULL UNIQUE, -- SHA-256 hash of full key
  key_prefix VARCHAR(16) NOT NULL, -- 'mpk_abc12345' for display

  -- Permissions
  scopes TEXT[] NOT NULL DEFAULT ARRAY['read_only'], -- ['read_only', 'read_write', 'admin']

  -- Lifecycle
  expires_at TIMESTAMPTZ, -- NULL = never expires
  revoked_at TIMESTAMPTZ,

  -- Usage tracking
  last_used_at TIMESTAMPTZ,
  request_count BIGINT DEFAULT 0,

  -- Rate limiting
  rate_limit_per_minute INT DEFAULT 100 CHECK (rate_limit_per_minute >= 1 AND rate_limit_per_minute <= 10000),

  -- Audit
  created_by UUID NOT NULL REFERENCES users(id),
  created_at TIMESTAMPTZ DEFAULT NOW(),

  -- Indexes
  CONSTRAINT api_keys_org_name_unique UNIQUE (org_id, name)
);

-- Indexes for performance
CREATE INDEX idx_api_keys_org_id ON api_keys(org_id);
CREATE INDEX idx_api_keys_key_hash ON api_keys(key_hash);
CREATE INDEX idx_api_keys_active ON api_keys(org_id) WHERE revoked_at IS NULL AND (expires_at IS NULL OR expires_at > NOW());
```

#### api_key_usage table (optional, for detailed analytics)

```sql
CREATE TABLE api_key_usage (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  api_key_id UUID NOT NULL REFERENCES api_keys(id) ON DELETE CASCADE,

  -- Request info
  endpoint VARCHAR(255) NOT NULL,
  method VARCHAR(10) NOT NULL,
  status_code INT NOT NULL,
  response_time_ms INT,

  -- Metadata
  ip_address INET,
  user_agent TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Index for analytics queries
CREATE INDEX idx_api_key_usage_key_date ON api_key_usage(api_key_id, created_at DESC);

-- Auto-cleanup: Keep last 30 days
CREATE INDEX idx_api_key_usage_cleanup ON api_key_usage(created_at);
```

### RLS Policies

```sql
-- api_keys: Only admins can manage keys
CREATE POLICY "api_keys_admin_all" ON api_keys
FOR ALL USING (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  AND (SELECT r.code FROM roles r JOIN users u ON u.role_id = r.id WHERE u.id = auth.uid()) IN ('SUPER_ADMIN', 'ADMIN')
);

-- api_key_usage: Same as api_keys
CREATE POLICY "api_key_usage_admin_read" ON api_key_usage
FOR SELECT USING (
  api_key_id IN (
    SELECT id FROM api_keys WHERE org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  )
  AND (SELECT r.code FROM roles r JOIN users u ON u.role_id = r.id WHERE u.id = auth.uid()) IN ('SUPER_ADMIN', 'ADMIN')
);
```

### API Endpoints

```
# API Key Management
GET    /api/v1/settings/api-keys              - List organization API keys
POST   /api/v1/settings/api-keys              - Create new API key
DELETE /api/v1/settings/api-keys/:id          - Revoke/delete API key
GET    /api/v1/settings/api-keys/:id/usage    - Get key usage statistics

# API Authentication (middleware)
# All /api/v1/* endpoints accept Authorization: Bearer mpk_xxx header
```

### Service Methods

**Location:** `lib/services/api-key-service.ts`

```typescript
interface ApiKeyService {
  // Key CRUD
  createKey(data: CreateKeyInput): Promise<{ key: string; apiKey: ApiKey }>;
  listKeys(orgId: string): Promise<ApiKey[]>;
  getKey(keyId: string): Promise<ApiKey | null>;
  revokeKey(keyId: string): Promise<void>;
  deleteKey(keyId: string): Promise<void>;

  // Key validation (for middleware)
  validateKey(keyHash: string): Promise<KeyValidation>;
  checkScope(keyId: string, requiredScope: string): Promise<boolean>;

  // Usage tracking
  recordUsage(keyId: string, usage: UsageRecord): Promise<void>;
  getUsageStats(keyId: string, days?: number): Promise<UsageStats>;

  // Rate limiting
  checkRateLimit(keyId: string): Promise<RateLimitResult>;
  incrementRequestCount(keyId: string): Promise<void>;

  // Helpers
  generateKey(): string;
  hashKey(key: string): string;
  extractPrefix(key: string): string;
}

interface CreateKeyInput {
  name: string;
  scopes: ('read_only' | 'read_write' | 'admin')[];
  expires_at?: string;
  rate_limit_per_minute?: number;
}

interface ApiKey {
  id: string;
  org_id: string;
  name: string;
  key_prefix: string;
  scopes: string[];
  expires_at: string | null;
  revoked_at: string | null;
  last_used_at: string | null;
  request_count: number;
  rate_limit_per_minute: number;
  created_at: string;
  created_by: string;
  status: 'active' | 'expired' | 'revoked';
}

interface KeyValidation {
  valid: boolean;
  expired: boolean;
  revoked: boolean;
  rateLimited: boolean;
  apiKey?: ApiKey;
}

interface RateLimitResult {
  allowed: boolean;
  limit: number;
  remaining: number;
  resetAt: number;
}

interface UsageStats {
  total_requests: number;
  last_used_at: string | null;
  requests_by_day: { date: string; count: number }[];
  requests_by_endpoint: { endpoint: string; count: number }[];
}
```

### Zod Validation Schemas

**Location:** `lib/validation/api-key.ts`

```typescript
import { z } from 'zod';

// Scope enum
export const apiKeyScopeSchema = z.enum(['read_only', 'read_write', 'admin']);

// Create API key request
export const createApiKeySchema = z.object({
  name: z.string()
    .min(1, 'Name is required')
    .max(100, 'Name must be 100 characters or less')
    .regex(/^[a-zA-Z0-9\s\-_]+$/, 'Name can only contain letters, numbers, spaces, hyphens, and underscores'),
  scopes: z.array(apiKeyScopeSchema)
    .min(1, 'At least one scope is required')
    .default(['read_only']),
  expires_at: z.string().datetime().optional().nullable(),
  rate_limit_per_minute: z.number()
    .int()
    .min(1, 'Rate limit must be at least 1')
    .max(10000, 'Rate limit cannot exceed 10,000')
    .default(100),
});

// API key response schema
export const apiKeySchema = z.object({
  id: z.string().uuid(),
  org_id: z.string().uuid(),
  name: z.string(),
  key_prefix: z.string(),
  scopes: z.array(apiKeyScopeSchema),
  expires_at: z.string().datetime().nullable(),
  revoked_at: z.string().datetime().nullable(),
  last_used_at: z.string().datetime().nullable(),
  request_count: z.number(),
  rate_limit_per_minute: z.number(),
  created_at: z.string().datetime(),
  created_by: z.string().uuid(),
  status: z.enum(['active', 'expired', 'revoked']),
});

export const apiKeysListSchema = z.array(apiKeySchema);

// Usage stats response
export const usageStatsSchema = z.object({
  total_requests: z.number(),
  last_used_at: z.string().datetime().nullable(),
  requests_by_day: z.array(z.object({
    date: z.string(),
    count: z.number(),
  })),
  requests_by_endpoint: z.array(z.object({
    endpoint: z.string(),
    count: z.number(),
  })),
});
```

### API Key Middleware

**Location:** `lib/middleware/api-key-auth.ts`

```typescript
import { NextRequest, NextResponse } from 'next/server';
import { ApiKeyService } from '@/lib/services/api-key-service';

export async function apiKeyAuthMiddleware(req: NextRequest) {
  const authHeader = req.headers.get('Authorization');

  if (!authHeader?.startsWith('Bearer mpk_')) {
    return null; // Not an API key request, fall through to session auth
  }

  const apiKey = authHeader.substring(7); // Remove 'Bearer '
  const keyHash = ApiKeyService.hashKey(apiKey);

  const validation = await ApiKeyService.validateKey(keyHash);

  if (!validation.valid) {
    if (validation.expired) {
      return NextResponse.json(
        { error: 'API_KEY_EXPIRED', message: 'API key has expired' },
        { status: 401 }
      );
    }
    if (validation.revoked) {
      return NextResponse.json(
        { error: 'API_KEY_REVOKED', message: 'API key has been revoked' },
        { status: 401 }
      );
    }
    if (validation.rateLimited) {
      return NextResponse.json(
        { error: 'RATE_LIMIT_EXCEEDED', message: 'Too many requests' },
        { status: 429, headers: { 'Retry-After': '60' } }
      );
    }
    return NextResponse.json(
      { error: 'INVALID_API_KEY', message: 'Invalid API key' },
      { status: 401 }
    );
  }

  // Check scope for request method
  const method = req.method;
  const requiredScope = getRequiredScope(method);

  if (!validation.apiKey!.scopes.includes(requiredScope) &&
      !validation.apiKey!.scopes.includes('admin')) {
    return NextResponse.json(
      { error: 'INSUFFICIENT_SCOPE', message: `Scope '${requiredScope}' required` },
      { status: 403 }
    );
  }

  // Record usage and continue
  await ApiKeyService.recordUsage(validation.apiKey!.id, {
    endpoint: req.nextUrl.pathname,
    method,
    ip_address: req.ip,
  });

  return validation.apiKey;
}

function getRequiredScope(method: string): string {
  switch (method) {
    case 'GET': return 'read_only';
    case 'POST':
    case 'PUT':
    case 'PATCH': return 'read_write';
    case 'DELETE': return 'admin';
    default: return 'admin';
  }
}
```

## UI Components

### Pages

- `app/(authenticated)/settings/api-keys/page.tsx` - API keys management page

### Components

**Location:** `components/settings/api-keys/`

```
ApiKeysList.tsx              - List of API keys with actions
ApiKeyCard.tsx               - Individual key display card
CreateApiKeyModal.tsx        - Modal for creating new key
KeyCreatedDialog.tsx         - Shows full key once after creation
RevokeKeyDialog.tsx          - Confirmation dialog for revocation
ApiKeyUsageModal.tsx         - Usage statistics display
ScopesBadge.tsx              - Visual scope indicator
```

### Component Details

**ApiKeysList.tsx**
```tsx
interface ApiKeysListProps {
  keys: ApiKey[];
  onCreateKey: () => void;
  onRevokeKey: (keyId: string) => void;
  onViewUsage: (keyId: string) => void;
  isLoading: boolean;
}
```

**CreateApiKeyModal.tsx**
```tsx
interface CreateApiKeyModalProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  onKeyCreated: (key: string, apiKey: ApiKey) => void;
}

// Form fields:
// - Name (text input)
// - Scopes (checkbox group: read_only, read_write, admin)
// - Expiration (date picker, optional)
// - Rate limit (number input, default 100)
```

**KeyCreatedDialog.tsx**
```tsx
interface KeyCreatedDialogProps {
  open: boolean;
  apiKey: string; // Full key shown once
  onClose: () => void;
}

// Shows warning: "This key will only be shown once!"
// Copy to clipboard button
// Key displayed in monospace with mask option
```

### UI Patterns

**API Key Card Layout:**
```
+--------------------------------------------------+
| Production API                        [Active]   |
| mpk_abc12345...                                  |
| Scopes: read_write                               |
| Rate Limit: 100/min                              |
| Last used: 2 hours ago | Requests: 1,234         |
| Expires: Never                                   |
|                        [View Usage] [Revoke]     |
+--------------------------------------------------+
```

**Key Created Dialog:**
```
+--------------------------------------------------+
|                   API Key Created                |
+--------------------------------------------------+
| Your new API key has been created.               |
|                                                  |
| [!] Copy this key now. It will not be shown      |
|     again after you close this dialog.           |
|                                                  |
| +----------------------------------------------+ |
| | mpk_a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6q7r8s9t0 | |
| +----------------------------------------------+ |
|                               [Copy to Clipboard]|
|                                                  |
|                                         [Done]   |
+--------------------------------------------------+
```

## Test Cases

### Unit Tests

**api-key-service.test.ts**
```typescript
describe('ApiKeyService', () => {
  describe('generateKey', () => {
    it('generates key with mpk_ prefix');
    it('generates 256-bit random key (43 chars after prefix)');
    it('generates unique keys on each call');
  });

  describe('hashKey', () => {
    it('returns SHA-256 hash of key');
    it('returns consistent hash for same key');
  });

  describe('createKey', () => {
    it('stores hashed key, not plain text');
    it('stores key prefix for display');
    it('sets default rate limit when not provided');
  });

  describe('validateKey', () => {
    it('returns valid=true for active key');
    it('returns expired=true for expired key');
    it('returns revoked=true for revoked key');
  });

  describe('checkScope', () => {
    it('allows read_only for GET requests');
    it('denies read_only for POST requests');
    it('allows admin for all requests');
  });

  describe('checkRateLimit', () => {
    it('allows request under limit');
    it('denies request over limit');
    it('resets after minute passes');
  });
});
```

### Integration Tests

**api-keys-api.test.ts**
```typescript
describe('API Keys API', () => {
  describe('GET /api/v1/settings/api-keys', () => {
    it('returns only org keys');
    it('returns 403 for non-admin');
    it('includes status for each key');
  });

  describe('POST /api/v1/settings/api-keys', () => {
    it('creates key and returns full key once');
    it('stores hashed key in database');
    it('validates name uniqueness per org');
    it('returns 403 for non-admin');
  });

  describe('DELETE /api/v1/settings/api-keys/:id', () => {
    it('revokes key successfully');
    it('returns 404 for other org key');
    it('creates audit log entry');
  });

  describe('API Key Authentication', () => {
    it('authenticates valid key');
    it('rejects expired key');
    it('rejects revoked key');
    it('enforces scope restrictions');
    it('enforces rate limiting');
    it('includes rate limit headers');
  });
});
```

### E2E Tests

**api-keys.spec.ts**
```typescript
describe('API Keys Management', () => {
  it('displays API keys list');
  it('creates new API key and shows once');
  it('copies key to clipboard');
  it('revokes key with confirmation');
  it('shows usage statistics');
  it('filters by status');
});
```

## Security Considerations

1. **Key Storage Security**
   - Never store plain text keys
   - Use SHA-256 for hashing (fast lookup)
   - Show full key only once at creation
   - Log key creation/revocation (not the key)

2. **Key Transmission**
   - Require HTTPS for all API requests
   - Keys in Authorization header only (not query params)
   - Clear key from memory after use

3. **Rate Limiting**
   - Use Redis for distributed rate limiting
   - Include rate limit headers in responses
   - Log rate limit violations

4. **Audit Trail**
   - Log all key management actions
   - Log API key usage (endpoint, status)
   - Retain logs for compliance

## Deliverables

- [ ] `api_keys` table migration
- [ ] `api_key_usage` table migration (optional)
- [ ] RLS policies for api_keys
- [ ] API key service (`lib/services/api-key-service.ts`)
- [ ] API key middleware (`lib/middleware/api-key-auth.ts`)
- [ ] Zod schemas (`lib/validation/api-key.ts`)
- [ ] GET /api/v1/settings/api-keys endpoint
- [ ] POST /api/v1/settings/api-keys endpoint
- [ ] DELETE /api/v1/settings/api-keys/:id endpoint
- [ ] GET /api/v1/settings/api-keys/:id/usage endpoint
- [ ] ApiKeysList component
- [ ] ApiKeyCard component
- [ ] CreateApiKeyModal component
- [ ] KeyCreatedDialog component
- [ ] RevokeKeyDialog component
- [ ] ApiKeyUsageModal component
- [ ] API keys settings page
- [ ] Unit tests (>85% coverage)
- [ ] Integration tests
- [ ] E2E tests

## Definition of Done

- [ ] API keys generated with correct format (mpk_ + 43 chars)
- [ ] Keys stored as SHA-256 hash (never plain text)
- [ ] Full key shown only once at creation
- [ ] Key prefix displayed for identification
- [ ] Scopes enforced on API requests
- [ ] Expired keys return 401
- [ ] Revoked keys return 401
- [ ] Rate limiting enforced per key
- [ ] Rate limit headers included in responses
- [ ] Usage tracking updates on each request
- [ ] Usage statistics display correctly
- [ ] Only admins can manage API keys
- [ ] Cross-tenant access returns 404
- [ ] Audit log entries created for key actions
- [ ] Unit test coverage >= 85%
- [ ] Integration tests pass
- [ ] E2E tests pass
