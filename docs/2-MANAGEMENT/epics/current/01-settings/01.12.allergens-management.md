# 01.12 - Allergens Management

**Priority:** P0 (MVP - Phase 2)
**Story Points:** S (Small)
**Type:** backend + frontend

**State:** ready
**Primary PRD:** `docs/1-BASELINE/product/modules/settings.md` (FR-SET-070 to FR-SET-074)
**UX Wireframes:** TBD (Allergen List)

---

## PRD Requirements Coverage

| Req ID | Requirement | Priority | Phase | In Scope |
|--------|-------------|----------|-------|----------|
| FR-SET-070 | 14 EU allergen management | P0 | 2 | Yes |
| FR-SET-071 | Allergen codes (A01-A14) | P0 | 2 | Yes |
| FR-SET-072 | Allergen labels (multi-language PL/EN/DE/FR) | P1 | 2 | Yes |
| FR-SET-073 | Allergen icons/symbols | P2 | 2 | Yes |
| FR-SET-074 | Custom allergen addition | P2 | **3** | **No** |

---

## Context

The European Union mandates disclosure of **14 allergens** in food products per Regulation (EU) No 1169/2011. This story implements the allergen master data as read-only reference data, seeded via database migration.

**Usage across modules:**
- **Technical Module:** Products reference allergens for ingredient declarations
- **Shipping Module:** Customer allergen restrictions for order validation
- **Quality Module:** Allergen cross-contamination checks

**Key Design Decision:** Allergens are **system-seeded, not user-created** in MVP. Custom allergens (FR-SET-074) are deferred to Phase 3.

---

## User Story

As a **Food Safety Manager**, I want to **view the EU-mandated 14 allergens with their codes, multi-language labels, and icons** so that **I can reference them when configuring products and understand which allergens apply to our manufacturing processes**.

---

## Dependencies

| Story | Name | Reason |
|-------|------|--------|
| **01.1** | Org context + RLS | Required for tenant isolation (even though allergens are global) |

**Note:** Allergens table is **NOT org-scoped** - it contains global EU reference data. However, the settings module requires authentication to view.

---

## Acceptance Criteria (Given/When/Then)

### AC-1: Allergen List Page

**Given** authenticated user navigates to `/settings/allergens`
**When** page loads
**Then** allergen list displays 14 EU allergens within 200ms

**Given** allergen list displayed
**When** columns rendered
**Then** columns show: Code, Icon, Name (current language), Name EN, Name PL, Status

**Given** allergen list displayed
**When** user language preference is Polish (PL)
**Then** primary name column displays Polish names

**Given** allergen list displayed
**When** user language preference is English (EN)
**Then** primary name column displays English names

### AC-2: Allergen Search and Filter

**Given** allergen list displayed
**When** user searches "milk"
**Then** A07 (Milk/Mleko) displays within 100ms

**Given** allergen list displayed
**When** user searches "gluten"
**Then** A01 (Gluten) displays

**Given** allergen list displayed
**When** user searches "A05"
**Then** Peanuts (Orzeszki ziemne) displays

**Given** allergen list displayed
**When** user types in search box
**Then** search filters across code AND all language name fields

### AC-3: Allergen Detail View

**Given** allergen list displayed
**When** user clicks on allergen row (A01 - Gluten)
**Then** allergen detail panel/modal shows:
- Code: A01
- Icon: allergen icon image
- Name EN: Gluten
- Name PL: Gluten
- Name DE: Gluten
- Name FR: Gluten
- Status: Active

**Given** allergen detail displayed
**When** user views icon
**Then** icon displays at 48x48 minimum size with accessible alt text

### AC-4: Allergen Icon Display

**Given** allergen list displayed
**When** icon column rendered
**Then** each allergen shows its unique icon at 24x24 size

**Given** allergen icon not available (icon_url is null)
**When** row rendered
**Then** placeholder icon (warning triangle or generic allergen icon) displays

### AC-5: Multi-Language Label Display

**Given** allergen list displayed
**When** user hovers over allergen row
**Then** tooltip shows all available translations:
- EN: {name_en}
- PL: {name_pl}
- DE: {name_de}
- FR: {name_fr}

**Given** allergen used in product form (Technical module)
**When** allergen selector rendered
**Then** allergen displays in user's language preference with code prefix

### AC-6: Read-Only Mode (MVP)

**Given** user is SUPER_ADMIN
**When** viewing allergen list
**Then** no Add/Edit/Delete buttons visible (read-only)

**Given** user attempts to POST/PUT/DELETE via API
**When** request processed
**Then** 405 Method Not Allowed returned

**Given** allergen list page
**When** rendered
**Then** info banner displays: "EU-mandated allergens are system-managed. Contact support for custom allergen requests."

### AC-7: Permission Enforcement

**Given** user has any authenticated role
**When** `/settings/allergens` accessed
**Then** read access granted (all roles can view allergens)

**Given** unauthenticated request
**When** `/api/v1/settings/allergens` accessed
**Then** 401 Unauthorized returned

---

## Technical Specification

### Database Schema

```sql
-- Allergens table (global reference data, NOT org-scoped)
CREATE TABLE allergens (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  code VARCHAR(10) UNIQUE NOT NULL,              -- A01, A02, etc.

  -- Multi-language labels (FR-SET-072)
  name_en VARCHAR(100) NOT NULL,                 -- English name
  name_pl VARCHAR(100) NOT NULL,                 -- Polish name
  name_de VARCHAR(100),                          -- German name
  name_fr VARCHAR(100),                          -- French name

  -- Alternative: JSONB for flexible languages
  -- labels JSONB NOT NULL DEFAULT '{}'::jsonb,  -- {"en": "Gluten", "pl": "Gluten", ...}

  -- Icon (FR-SET-073)
  icon_url TEXT,                                 -- URL to allergen icon
  icon_svg TEXT,                                 -- Or inline SVG for offline use

  -- Metadata
  is_eu_mandatory BOOLEAN DEFAULT true,          -- EU Regulation 1169/2011
  is_custom BOOLEAN DEFAULT false,               -- Future: custom allergens (Phase 3)
  is_active BOOLEAN DEFAULT true,
  display_order INTEGER NOT NULL DEFAULT 0,

  -- Timestamps
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Index for search across all name columns
CREATE INDEX idx_allergens_search ON allergens
USING gin (to_tsvector('simple',
  coalesce(code, '') || ' ' ||
  coalesce(name_en, '') || ' ' ||
  coalesce(name_pl, '') || ' ' ||
  coalesce(name_de, '') || ' ' ||
  coalesce(name_fr, '')
));

CREATE INDEX idx_allergens_code ON allergens(code);
CREATE INDEX idx_allergens_display_order ON allergens(display_order);
```

### Seed Migration (14 EU Allergens)

```sql
-- Migration: seed_eu_allergens.sql
-- Seeds the 14 EU mandatory allergens per Regulation (EU) No 1169/2011

INSERT INTO allergens (code, name_en, name_pl, name_de, name_fr, is_eu_mandatory, display_order, icon_url)
VALUES
  ('A01', 'Gluten', 'Gluten', 'Gluten', 'Gluten', true, 1, '/icons/allergens/gluten.svg'),
  ('A02', 'Crustaceans', 'Skorupiaki', 'Krebstiere', 'Crustaces', true, 2, '/icons/allergens/crustaceans.svg'),
  ('A03', 'Eggs', 'Jaja', 'Eier', 'Oeufs', true, 3, '/icons/allergens/eggs.svg'),
  ('A04', 'Fish', 'Ryby', 'Fisch', 'Poisson', true, 4, '/icons/allergens/fish.svg'),
  ('A05', 'Peanuts', 'Orzeszki ziemne', 'Erdnusse', 'Arachides', true, 5, '/icons/allergens/peanuts.svg'),
  ('A06', 'Soybeans', 'Soja', 'Soja', 'Soja', true, 6, '/icons/allergens/soybeans.svg'),
  ('A07', 'Milk', 'Mleko', 'Milch', 'Lait', true, 7, '/icons/allergens/milk.svg'),
  ('A08', 'Nuts', 'Orzechy', 'Schalenfruchte', 'Fruits a coque', true, 8, '/icons/allergens/nuts.svg'),
  ('A09', 'Celery', 'Seler', 'Sellerie', 'Celeri', true, 9, '/icons/allergens/celery.svg'),
  ('A10', 'Mustard', 'Gorczyca', 'Senf', 'Moutarde', true, 10, '/icons/allergens/mustard.svg'),
  ('A11', 'Sesame', 'Sezam', 'Sesam', 'Sesame', true, 11, '/icons/allergens/sesame.svg'),
  ('A12', 'Sulphites', 'Siarczyny', 'Sulfite', 'Sulfites', true, 12, '/icons/allergens/sulphites.svg'),
  ('A13', 'Lupin', 'Lubin', 'Lupinen', 'Lupin', true, 13, '/icons/allergens/lupin.svg'),
  ('A14', 'Molluscs', 'Mieczaki', 'Weichtiere', 'Mollusques', true, 14, '/icons/allergens/molluscs.svg')
ON CONFLICT (code) DO NOTHING;
```

### RLS Policies

```sql
-- Enable RLS (even for global data, enforce authentication)
ALTER TABLE allergens ENABLE ROW LEVEL SECURITY;

-- Select: All authenticated users can read (global reference data)
CREATE POLICY "allergens_select_authenticated" ON allergens
FOR SELECT TO authenticated
USING (is_active = true);

-- No INSERT/UPDATE/DELETE policies - read-only in MVP
-- INSERT/UPDATE/DELETE operations blocked by absence of policies
```

### API Endpoints

```typescript
// GET /api/v1/settings/allergens
// Query params: search, lang (optional - for primary name sorting)
interface AllergensListParams {
  search?: string;
  lang?: 'en' | 'pl' | 'de' | 'fr';
}

interface AllergensListResponse {
  allergens: Allergen[];
  total: number;
}

interface Allergen {
  id: string;
  code: string;
  name_en: string;
  name_pl: string;
  name_de: string | null;
  name_fr: string | null;
  icon_url: string | null;
  is_eu_mandatory: boolean;
  display_order: number;
}

// GET /api/v1/settings/allergens/:id
interface AllergenResponse {
  allergen: Allergen;
}

// POST, PUT, DELETE - Not implemented in MVP
// Returns 405 Method Not Allowed
```

### Service Methods

```typescript
// lib/services/allergen-service.ts
export class AllergenService {
  // Read operations only (MVP)
  async getAllergens(params?: AllergensListParams): Promise<AllergensListResponse>;
  async getAllergenById(id: string): Promise<Allergen>;
  async getAllergenByCode(code: string): Promise<Allergen>;

  // Search helper (searches across all language fields)
  async searchAllergens(query: string): Promise<Allergen[]>;

  // Language helper
  getName(allergen: Allergen, lang: string): string;

  // For product forms (Technical module)
  async getAllergensForSelect(lang?: string): Promise<AllergenSelectOption[]>;
}

interface AllergenSelectOption {
  value: string;  // allergen.id
  label: string;  // e.g., "A01 - Gluten"
  code: string;
  icon_url: string | null;
}
```

### Zod Validation Schema

```typescript
// lib/validation/allergen-schema.ts
import { z } from 'zod';

export const allergenSchema = z.object({
  id: z.string().uuid(),
  code: z.string().regex(/^A[0-9]{2}$/, "Code must be format A01-A14"),
  name_en: z.string().min(1).max(100),
  name_pl: z.string().min(1).max(100),
  name_de: z.string().max(100).nullable(),
  name_fr: z.string().max(100).nullable(),
  icon_url: z.string().url().nullable(),
  is_eu_mandatory: z.boolean(),
  display_order: z.number().int().min(0),
});

export const allergensListParamsSchema = z.object({
  search: z.string().max(100).optional(),
  lang: z.enum(['en', 'pl', 'de', 'fr']).optional(),
});

export type Allergen = z.infer<typeof allergenSchema>;
export type AllergensListParams = z.infer<typeof allergensListParamsSchema>;
```

---

## UI Components

### File Structure

```
app/(authenticated)/settings/allergens/
  page.tsx                              -- Allergens list page

components/settings/allergens/
  AllergensDataTable.tsx                -- Table with search
  AllergenRow.tsx                       -- Single allergen row
  AllergenIcon.tsx                      -- Icon component with fallback
  AllergenBadge.tsx                     -- Code + name badge for use across modules
  AllergenDetailPanel.tsx               -- Detail view panel/modal
  AllergenLanguageTooltip.tsx           -- Multi-language tooltip
  AllergenReadOnlyBanner.tsx            -- Info banner about read-only status
```

### Component Specifications

**AllergensDataTable.tsx**
- Columns: Code, Icon, Name (localized), Name EN, Name PL
- Search input: filters across code and all name columns
- No pagination needed (only 14 items)
- Sorted by display_order (A01 first)
- Clickable rows to show detail panel

**AllergenIcon.tsx**
```tsx
interface AllergenIconProps {
  iconUrl: string | null;
  code: string;
  size?: 'sm' | 'md' | 'lg';  // 16px, 24px, 48px
  className?: string;
}

// Renders icon from URL or fallback
// Falls back to code-based placeholder icon
// Includes accessible alt text
```

**AllergenBadge.tsx**
```tsx
interface AllergenBadgeProps {
  allergen: Allergen;
  lang?: string;
  showIcon?: boolean;
  showCode?: boolean;
}

// Displays: [Icon] A01 - Gluten
// Used in product forms, shipping restrictions, etc.
```

**AllergenReadOnlyBanner.tsx**
```tsx
// Info banner at top of list page
// "EU-mandated allergens are system-managed.
//  Custom allergen requests available in Enterprise plan."
```

---

## Out of Scope

| Req ID | Requirement | Reason | Target Phase |
|--------|-------------|--------|--------------|
| FR-SET-074 | Custom allergen addition | Requires org-scoped allergens table extension | Phase 3 |
| -- | Allergen editing | EU allergens are regulatory constants | Never (for EU allergens) |
| -- | Allergen deletion | Regulatory compliance requirement | Never (for EU allergens) |
| -- | Additional languages beyond PL/EN/DE/FR | Can be added later via migration | Phase 3 |
| -- | Allergen severity levels | Not required by EU regulation | Phase 3 |
| -- | Allergen alternatives/substitutes | Product formulation feature | Phase 3 |

---

## Test Cases

### Unit Tests (allergen-service.ts)

| Test ID | Description | Expected Result |
|---------|-------------|-----------------|
| UT-01 | Get all allergens | Returns 14 EU allergens |
| UT-02 | Get allergen by code A01 | Returns Gluten allergen |
| UT-03 | Get allergen by invalid code | Returns null/throws not found |
| UT-04 | Search "milk" | Returns A07 Milk |
| UT-05 | Search "A05" | Returns Peanuts |
| UT-06 | Search "orzechy" (Polish) | Returns A08 Nuts |
| UT-07 | Search non-existent term | Returns empty array |
| UT-08 | getName with lang='pl' | Returns Polish name |
| UT-09 | getName with lang='de' | Returns German name |
| UT-10 | getAllergensForSelect | Returns 14 select options |

### Integration Tests (API)

| Test ID | Description | Expected Result |
|---------|-------------|-----------------|
| IT-01 | GET /allergens returns all 14 | 200 with 14 allergens |
| IT-02 | GET /allergens?search=gluten | 200 with A01 |
| IT-03 | GET /allergens/:id (valid) | 200 with allergen detail |
| IT-04 | GET /allergens/:id (invalid) | 404 not found |
| IT-05 | POST /allergens | 405 Method Not Allowed |
| IT-06 | PUT /allergens/:id | 405 Method Not Allowed |
| IT-07 | DELETE /allergens/:id | 405 Method Not Allowed |
| IT-08 | GET /allergens unauthenticated | 401 Unauthorized |
| IT-09 | Response includes all language fields | name_en, name_pl, name_de, name_fr present |
| IT-10 | Response ordered by display_order | A01 first, A14 last |

### E2E Tests (Playwright)

| Test ID | Description | Expected Result |
|---------|-------------|-----------------|
| E2E-01 | Navigate to allergens page | 14 allergens displayed |
| E2E-02 | Search for "milk" | A07 filtered and shown |
| E2E-03 | Clear search | All 14 shown again |
| E2E-04 | Click allergen row | Detail panel opens |
| E2E-05 | Verify all icons load | No broken images |
| E2E-06 | Hover row shows tooltip | Multi-language names visible |
| E2E-07 | Read-only banner visible | Info message displayed |
| E2E-08 | No edit/delete buttons | Actions column empty |
| E2E-09 | Change language preference | Name column updates |
| E2E-10 | Page loads under 200ms | Performance check passes |

---

## Definition of Done

- [ ] Database migration creates `allergens` table
- [ ] Seed migration populates 14 EU allergens with all translations
- [ ] RLS policy allows authenticated read access
- [ ] API endpoint `GET /api/v1/settings/allergens` returns all allergens
- [ ] API endpoint `GET /api/v1/settings/allergens/:id` returns single allergen
- [ ] POST/PUT/DELETE endpoints return 405 Method Not Allowed
- [ ] `allergen-service.ts` with all read methods
- [ ] Zod validation schemas for API responses
- [ ] Allergens list page displays 14 items sorted by display_order
- [ ] Search filters across code and all language name fields
- [ ] Allergen icons display with fallback for missing icons
- [ ] Multi-language tooltip on row hover
- [ ] Read-only info banner displayed
- [ ] Page loads within 200ms
- [ ] Unit tests for allergen-service (>80% coverage)
- [ ] Integration tests for API endpoints
- [ ] E2E tests for critical flows
- [ ] Allergen icons added to `/public/icons/allergens/` directory

---

## Assets Required

### Allergen Icons

14 SVG icons required in `/public/icons/allergens/`:
- `gluten.svg`
- `crustaceans.svg`
- `eggs.svg`
- `fish.svg`
- `peanuts.svg`
- `soybeans.svg`
- `milk.svg`
- `nuts.svg`
- `celery.svg`
- `mustard.svg`
- `sesame.svg`
- `sulphites.svg`
- `lupin.svg`
- `molluscs.svg`

**Icon specifications:**
- Format: SVG (for scalability)
- Viewbox: 24x24
- Single color (inherits currentColor)
- Accessible: includes `<title>` element

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-12-16 | Initial story creation | ARCHITECT-AGENT |
