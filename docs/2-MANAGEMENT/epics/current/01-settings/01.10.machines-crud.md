# 01.10 - Machines CRUD

---

## ðŸš§ V2 MIGRATION - ADD 2ND ROW & MAINTENANCE

**âš ï¸ V1 missing 2nd row details and maintenance actions**

### **Build Location:**
```
âœ… CREATE: apps/frontend/app/(authenticated)/settings-v2/machines/
âœ… CREATE: apps/frontend/components/settings-v2/machines/
âŒ DO NOT EDIT: app/(authenticated)/settings/machines/ (v1 frozen)
```

### **What to Add:**
- âœ… 2nd row details (Capacity: 500L â€¢ Installed: 2023-01-15)
- âœ… Maintenance actions (Set to Maintenance, View History)
- âœ… Actions menu with 8 options

### **Can Migrate from V1:**
- âœ… `MachineTypeBadge.tsx`
- âœ… `MachineStatusBadge.tsx`
- âœ… `MachineCapacityDisplay.tsx`

### **Your Resources:**
- **Handoff:** `docs/2-MANAGEMENT/epics/current/01-settings/agent-handoffs/05-machines-2nd-row-maintenance.yaml`
- **Wireframes:** `SET-016-machine-list.md`, `SET-017-machine-create-edit-modal.md`

**Estimated Effort:** 8-10 hours

---

_Original story content below â†“_

---

**Priority:** P0 (MVP - Phase 1B)
**Story Points:** M (Medium)
**Type:** frontend + backend

**State:** ready
**Primary PRD:** `docs/1-BASELINE/product/modules/settings.md` (FR-SET-050 to FR-SET-056)
**UX Wireframes:** TBD (Machine List, Machine Modal)

---

## PRD Requirements Coverage

| Req ID | Requirement | Priority | In Scope |
|--------|-------------|----------|----------|
| FR-SET-050 | Machine CRUD | P0 | Yes |
| FR-SET-051 | Machine type (mixer/oven/filler/packaging/conveyor) | P0 | Yes |
| FR-SET-052 | Machine status (active/maintenance/offline/decommissioned) | P0 | Yes |
| FR-SET-053 | Machine capacity (units/hour) | P1 | Yes |
| FR-SET-054 | Maintenance schedule configuration | P2 | **No** (Phase 2) |
| FR-SET-055 | Machine location assignment | P1 | Yes |
| FR-SET-056 | Machine-specific parameters | P2 | **No** (Phase 2) |

---

## User Story

As a **Production Manager**, I want to **register and manage production machines with their types, statuses, capacities, and locations** so that **I can configure the production infrastructure and track equipment availability for work order scheduling**.

---

## Dependencies

| Story | Name | Reason |
|-------|------|--------|
| **01.8** | Warehouses CRUD | Locations belong to warehouses; warehouse must exist first |
| **01.9** | Locations CRUD | `location_id` FK references locations table |
| **01.1** | Org context + RLS | Required for tenant isolation |
| **01.6** | Role-based permissions | Required for permission enforcement |

**Critical Path:** 01.1 -> 01.6 -> 01.8 -> 01.9 -> **01.10**

---

## Acceptance Criteria (Given/When/Then)

### AC-1: Machine List Page

**Given** admin navigates to `/settings/machines`
**When** page loads
**Then** machine list displays within 300ms

**Given** machine list has 50 items
**When** admin filters by type "Mixer"
**Then** only mixer machines display within 200ms

**Given** machine list displayed
**When** admin filters by status "Maintenance"
**Then** only machines in maintenance status appear

**Given** machine list displayed
**When** admin filters by location "WH-001/ZONE-A"
**Then** only machines in that location appear

**Given** machine list displayed
**When** admin searches "MIX"
**Then** machines with code or name matching "MIX" display within 200ms

**Given** machine list with pagination
**When** page 2 clicked
**Then** next 25 machines display

**Given** machine list displayed
**When** columns rendered
**Then** columns show: Code, Name, Type (badge), Status (badge), Capacity, Location, Actions

### AC-2: Create Machine

**Given** admin clicks "Add Machine"
**When** modal opens
**Then** form displays: code, name, type (dropdown), status (dropdown), capacity fields, location (dropdown)

**Given** admin enters machine code "MIX-001"
**When** save clicked with valid data
**Then** machine created with default status "Active" within 500ms

**Given** machine code "MIX-001" exists in organization
**When** duplicate code entered
**Then** error "Machine code must be unique" displays inline

**Given** required field (code or name) empty
**When** save attempted
**Then** validation error "Field is required" displays inline

**Given** admin selects type "Mixer"
**When** form submitted
**Then** machine created with type "MIXER"

**Given** admin sets capacity fields (units_per_hour: 500, setup_time: 30, max_batch_size: 1000)
**When** form submitted
**Then** machine created with all capacity values stored

**Given** admin selects location "WH-001/ZONE-A/RACK-01"
**When** form submitted
**Then** machine created with location_id reference

**Given** admin leaves location unselected
**When** form submitted
**Then** machine created with location_id NULL (valid - machine not yet assigned)

### AC-3: Edit Machine

**Given** admin clicks edit on existing machine "MIX-001"
**When** modal opens
**Then** current machine data pre-populates all form fields

**Given** admin updates machine name from "Primary Mixer" to "Main Mixer"
**When** save completes
**Then** updated name displays immediately in list

**Given** admin changes machine type from "MIXER" to "BLENDER"
**When** save completes
**Then** new type badge displays in list

**Given** admin changes location assignment
**When** save completes
**Then** new location displays in list

### AC-4: Machine Status Management

**Given** machine status is "Active"
**When** admin changes to "Maintenance"
**Then** status updates immediately with yellow "Maintenance" badge

**Given** machine status is "Maintenance"
**When** admin changes to "Offline"
**Then** status updates immediately with red "Offline" badge

**Given** machine status is "Offline"
**When** admin changes to "Active"
**Then** status updates immediately with green "Active" badge

**Given** machine status is "Active"
**When** admin changes to "Decommissioned"
**Then** status updates with gray "Decommissioned" badge and machine excluded from active lists

**Given** machine status changed
**When** production dashboard viewed
**Then** machine availability reflects new status

### AC-5: Machine Type Badges

**Given** machine list displayed
**When** type column rendered
**Then** each type shows distinct icon/badge:
- Mixer: blue badge with mixer icon
- Oven: orange badge with flame icon
- Filler: purple badge with fill icon
- Packaging: green badge with box icon
- Conveyor: gray badge with belt icon

### AC-6: Capacity Display

**Given** machine has capacity values set
**When** list viewed
**Then** capacity displays as "{units_per_hour} u/hr"

**Given** machine form open
**When** capacity section displayed
**Then** fields show:
- Units per hour (number input, min: 0)
- Setup time in minutes (number input, min: 0)
- Max batch size (number input, min: 0)

**Given** capacity field left empty
**When** form submitted
**Then** field saved as NULL (optional field)

### AC-7: Location Assignment

**Given** admin opens machine form
**When** location dropdown loaded
**Then** locations display as hierarchical path (e.g., "WH-001 > ZONE-A > RACK-01")

**Given** location dropdown open
**When** typing to filter
**Then** locations filter by name/code within 200ms

**Given** machine assigned to location "RACK-01"
**When** machine list viewed
**Then** location column shows full path "WH-001/ZONE-A/RACK-01"

**Given** machine has no location assigned
**When** machine list viewed
**Then** location column shows "--" or "Unassigned"

### AC-8: Delete Machine

**Given** machine has no assignments (not on any production line)
**When** delete confirmed
**Then** machine removed within 500ms

**Given** machine is assigned to production line "LINE-001"
**When** delete attempted
**Then** error "Machine is assigned to line [LINE-001]. Remove from line first." displays

**Given** machine has historical work order references
**When** delete attempted
**Then** soft-delete performed (is_deleted=true) instead of hard delete

### AC-9: Permission Enforcement

**Given** user has PROD_MANAGER role or higher
**When** `/settings/machines` accessed
**Then** full CRUD access available

**Given** user has VIEWER role
**When** `/settings/machines` accessed
**Then** "Add Machine" button hidden, edit/delete actions hidden (read-only)

**Given** user has PROD_OPERATOR role
**When** `/settings/machines` accessed
**Then** read-only access (can view but not modify)

---

## Technical Specification

### Database Schema

```sql
-- Machine type enum
CREATE TYPE machine_type AS ENUM (
  'MIXER',
  'OVEN',
  'FILLER',
  'PACKAGING',
  'CONVEYOR',
  'BLENDER',
  'CUTTER',
  'LABELER',
  'OTHER'
);

-- Machine status enum
CREATE TYPE machine_status AS ENUM (
  'ACTIVE',
  'MAINTENANCE',
  'OFFLINE',
  'DECOMMISSIONED'
);

-- Machines table
CREATE TABLE machines (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id),
  code VARCHAR(50) NOT NULL,
  name VARCHAR(100) NOT NULL,
  description TEXT,
  type machine_type NOT NULL DEFAULT 'OTHER',
  status machine_status NOT NULL DEFAULT 'ACTIVE',

  -- Capacity fields (FR-SET-053)
  units_per_hour INTEGER,
  setup_time_minutes INTEGER,
  max_batch_size INTEGER,

  -- Location assignment (FR-SET-055) - nullable
  location_id UUID REFERENCES locations(id) ON DELETE SET NULL,

  -- Soft delete for historical references
  is_deleted BOOLEAN DEFAULT false,
  deleted_at TIMESTAMPTZ,

  -- Timestamps
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  created_by UUID REFERENCES users(id),
  updated_by UUID REFERENCES users(id),

  -- Constraints
  UNIQUE(org_id, code)
);

-- Indexes
CREATE INDEX idx_machines_org_id ON machines(org_id);
CREATE INDEX idx_machines_type ON machines(type);
CREATE INDEX idx_machines_status ON machines(status);
CREATE INDEX idx_machines_location_id ON machines(location_id);
CREATE INDEX idx_machines_code ON machines(org_id, code);
```

### RLS Policies (ADR-013)

```sql
-- Enable RLS
ALTER TABLE machines ENABLE ROW LEVEL SECURITY;

-- Select: Org-scoped read access
CREATE POLICY "machines_select" ON machines
FOR SELECT TO authenticated
USING (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  AND is_deleted = false
);

-- Insert: Admin/Manager write access
CREATE POLICY "machines_insert" ON machines
FOR INSERT TO authenticated
WITH CHECK (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  AND (SELECT r.code FROM roles r JOIN users u ON u.role_id = r.id WHERE u.id = auth.uid())
      IN ('SUPER_ADMIN', 'ADMIN', 'PROD_MANAGER')
);

-- Update: Admin/Manager write access
CREATE POLICY "machines_update" ON machines
FOR UPDATE TO authenticated
USING (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  AND (SELECT r.code FROM roles r JOIN users u ON u.role_id = r.id WHERE u.id = auth.uid())
      IN ('SUPER_ADMIN', 'ADMIN', 'PROD_MANAGER')
);

-- Delete: Admin only (soft delete)
CREATE POLICY "machines_delete" ON machines
FOR DELETE TO authenticated
USING (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  AND (SELECT r.code FROM roles r JOIN users u ON u.role_id = r.id WHERE u.id = auth.uid())
      IN ('SUPER_ADMIN', 'ADMIN')
);
```

### API Endpoints

```typescript
// GET /api/v1/settings/machines
// Query params: page, limit, search, type, status, location_id, sortBy, sortOrder
interface MachinesListParams {
  page?: number;
  limit?: number;
  search?: string;
  type?: MachineType;
  status?: MachineStatus;
  location_id?: string;
  sortBy?: 'code' | 'name' | 'type' | 'status' | 'created_at';
  sortOrder?: 'asc' | 'desc';
}

interface MachinesListResponse {
  machines: Machine[];
  total: number;
  page: number;
  limit: number;
}

// GET /api/v1/settings/machines/:id
interface MachineResponse {
  machine: Machine;
}

// POST /api/v1/settings/machines
interface CreateMachineRequest {
  code: string;
  name: string;
  description?: string;
  type: MachineType;
  status?: MachineStatus; // defaults to ACTIVE
  units_per_hour?: number;
  setup_time_minutes?: number;
  max_batch_size?: number;
  location_id?: string;
}

// PUT /api/v1/settings/machines/:id
interface UpdateMachineRequest {
  code?: string;
  name?: string;
  description?: string;
  type?: MachineType;
  status?: MachineStatus;
  units_per_hour?: number;
  setup_time_minutes?: number;
  max_batch_size?: number;
  location_id?: string | null; // null to unassign
}

// PATCH /api/v1/settings/machines/:id/status
interface UpdateMachineStatusRequest {
  status: MachineStatus;
}

// DELETE /api/v1/settings/machines/:id
// Returns 204 on success, 409 if machine has line assignments
```

### Service Methods

```typescript
// lib/services/machine-service.ts
export class MachineService {
  async getMachines(params: MachinesListParams): Promise<MachinesListResponse>;
  async getMachineById(id: string): Promise<Machine>;
  async createMachine(data: CreateMachineRequest): Promise<Machine>;
  async updateMachine(id: string, data: UpdateMachineRequest): Promise<Machine>;
  async updateMachineStatus(id: string, status: MachineStatus): Promise<Machine>;
  async deleteMachine(id: string): Promise<void>;

  // Validation helpers
  async isCodeUnique(code: string, excludeId?: string): Promise<boolean>;
  async canDelete(id: string): Promise<{ allowed: boolean; reason?: string }>;
  async getLineAssignments(id: string): Promise<ProductionLine[]>;

  // Location helpers
  async getLocationPath(locationId: string): Promise<string>;
  async getAvailableLocations(): Promise<Location[]>;
}
```

### Zod Validation Schema

```typescript
// lib/validation/machine-schema.ts
import { z } from 'zod';

export const machineTypeSchema = z.enum([
  'MIXER',
  'OVEN',
  'FILLER',
  'PACKAGING',
  'CONVEYOR',
  'BLENDER',
  'CUTTER',
  'LABELER',
  'OTHER'
]);

export const machineStatusSchema = z.enum([
  'ACTIVE',
  'MAINTENANCE',
  'OFFLINE',
  'DECOMMISSIONED'
]);

export const createMachineSchema = z.object({
  code: z.string()
    .min(1, "Machine code is required")
    .max(50, "Code must be 50 characters or less")
    .regex(/^[A-Z0-9-]+$/, "Code must be uppercase alphanumeric with hyphens"),
  name: z.string()
    .min(1, "Machine name is required")
    .max(100, "Name must be 100 characters or less"),
  description: z.string().max(500).optional(),
  type: machineTypeSchema,
  status: machineStatusSchema.default('ACTIVE'),
  units_per_hour: z.number().int().min(0).optional().nullable(),
  setup_time_minutes: z.number().int().min(0).optional().nullable(),
  max_batch_size: z.number().int().min(0).optional().nullable(),
  location_id: z.string().uuid().optional().nullable(),
});

export const updateMachineSchema = createMachineSchema.partial();

export const updateMachineStatusSchema = z.object({
  status: machineStatusSchema,
});

export type CreateMachineInput = z.infer<typeof createMachineSchema>;
export type UpdateMachineInput = z.infer<typeof updateMachineSchema>;
export type MachineType = z.infer<typeof machineTypeSchema>;
export type MachineStatus = z.infer<typeof machineStatusSchema>;
```

---

## UI Components

### File Structure

```
app/(authenticated)/settings/machines/
  page.tsx                          -- Machines list page

components/settings/machines/
  MachinesDataTable.tsx             -- Table with sorting, filtering, pagination
  MachineModal.tsx                  -- Create/Edit form modal
  MachineRow.tsx                    -- Single machine row
  MachineTypeBadge.tsx              -- Type badge with icon
  MachineStatusBadge.tsx            -- Status badge with color
  MachineCapacityDisplay.tsx        -- Capacity info display
  MachineLocationSelect.tsx         -- Hierarchical location dropdown
  DeleteMachineDialog.tsx           -- Confirmation dialog with assignment check
  MachineFilters.tsx                -- Filter controls (type, status, location)
```

### Component Specifications

**MachinesDataTable.tsx**
- Columns: Code, Name, Type, Status, Capacity, Location, Actions
- Sortable columns: Code, Name, Type, Status, Created At
- Filter dropdowns: Type, Status, Location
- Search input: filters by code and name
- Pagination: 25 items per page

**MachineTypeBadge.tsx**
```tsx
const TYPE_CONFIG: Record<MachineType, { label: string; color: string; icon: Icon }> = {
  MIXER: { label: 'Mixer', color: 'blue', icon: MixerIcon },
  OVEN: { label: 'Oven', color: 'orange', icon: FlameIcon },
  FILLER: { label: 'Filler', color: 'purple', icon: FillIcon },
  PACKAGING: { label: 'Packaging', color: 'green', icon: PackageIcon },
  CONVEYOR: { label: 'Conveyor', color: 'gray', icon: BeltIcon },
  BLENDER: { label: 'Blender', color: 'cyan', icon: BlenderIcon },
  CUTTER: { label: 'Cutter', color: 'red', icon: ScissorsIcon },
  LABELER: { label: 'Labeler', color: 'yellow', icon: TagIcon },
  OTHER: { label: 'Other', color: 'slate', icon: SettingsIcon },
};
```

**MachineStatusBadge.tsx**
```tsx
const STATUS_CONFIG: Record<MachineStatus, { label: string; color: string }> = {
  ACTIVE: { label: 'Active', color: 'green' },
  MAINTENANCE: { label: 'Maintenance', color: 'yellow' },
  OFFLINE: { label: 'Offline', color: 'red' },
  DECOMMISSIONED: { label: 'Decommissioned', color: 'gray' },
};
```

**MachineLocationSelect.tsx**
- Hierarchical dropdown showing location tree
- Format: "WH-001 > ZONE-A > RACK-01"
- Typeahead filtering
- Optional "Unassigned" option for null location

**MachineModal.tsx**
- Form fields organized in sections:
  - Basic Info: Code, Name, Description
  - Classification: Type (dropdown), Status (dropdown)
  - Capacity: Units/Hour, Setup Time, Max Batch Size
  - Location: Location dropdown (optional)
- Validation on blur and submit
- Loading state during save

---

## Out of Scope

| Req ID | Requirement | Reason | Target Phase |
|--------|-------------|--------|--------------|
| FR-SET-054 | Maintenance schedule configuration | Complex scheduling feature | Phase 2 |
| FR-SET-056 | Machine-specific parameters | Custom fields per machine type | Phase 2 |
| -- | Machine OEE tracking | Separate OEE module (Epic 10) | Phase 2 |
| -- | Machine downtime logging | Requires maintenance module | Phase 2 |
| -- | Machine documentation/manuals | Document management feature | Phase 3 |

---

## Test Cases

### Unit Tests (machine-service.ts)

| Test ID | Description | Expected Result |
|---------|-------------|-----------------|
| UT-01 | Create machine with valid data | Machine created with all fields |
| UT-02 | Create machine with duplicate code | Throws "Code already exists" error |
| UT-03 | Update machine status from ACTIVE to MAINTENANCE | Status updated successfully |
| UT-04 | Delete machine with no line assignments | Machine soft-deleted |
| UT-05 | Delete machine with line assignments | Throws "Machine assigned to line" error |
| UT-06 | Get machines with type filter | Only matching type returned |
| UT-07 | Get machines with status filter | Only matching status returned |
| UT-08 | Get machines with location filter | Only machines in location returned |
| UT-09 | Search machines by code | Matching machines returned |
| UT-10 | Validate code format (uppercase, alphanumeric, hyphens) | Invalid codes rejected |

### Integration Tests (API)

| Test ID | Description | Expected Result |
|---------|-------------|-----------------|
| IT-01 | GET /machines returns org-scoped list | Only org machines returned |
| IT-02 | POST /machines creates with valid data | 201 with machine object |
| IT-03 | POST /machines with duplicate code | 409 conflict error |
| IT-04 | PUT /machines/:id updates machine | 200 with updated machine |
| IT-05 | PATCH /machines/:id/status updates status | 200 with new status |
| IT-06 | DELETE /machines/:id with no assignments | 204 no content |
| IT-07 | DELETE /machines/:id with assignments | 409 conflict error |
| IT-08 | GET /machines with VIEWER role | 200 read-only access |
| IT-09 | POST /machines with VIEWER role | 403 forbidden |
| IT-10 | RLS prevents cross-org access | Empty results for other org |

### E2E Tests (Playwright)

| Test ID | Description | Expected Result |
|---------|-------------|-----------------|
| E2E-01 | Create new machine end-to-end | Machine appears in list |
| E2E-02 | Edit existing machine | Changes reflected immediately |
| E2E-03 | Change machine status | Status badge updates |
| E2E-04 | Filter by type | Only filtered machines shown |
| E2E-05 | Filter by status | Only filtered machines shown |
| E2E-06 | Search by code | Matching machines displayed |
| E2E-07 | Assign location to machine | Location displayed in list |
| E2E-08 | Delete machine (no assignments) | Machine removed from list |
| E2E-09 | Delete machine (with assignments) | Error dialog shown |
| E2E-10 | Permission: VIEWER sees read-only | Add/Edit/Delete hidden |

---

## Definition of Done

- [ ] Database migration creates `machines` table with enums
- [ ] RLS policies enforce org isolation (ADR-013 pattern)
- [ ] API endpoints for CRUD operations implemented
- [ ] `machine-service.ts` with all service methods
- [ ] Zod validation schemas for all inputs
- [ ] Machine list page loads within 300ms for 100 machines
- [ ] Create/Edit modal with all form fields working
- [ ] Machine type badges display with correct colors/icons
- [ ] Machine status badges display with correct colors
- [ ] Status updates reflect immediately in UI
- [ ] Capacity fields save and display correctly
- [ ] Location assignment works with hierarchical dropdown
- [ ] Soft delete for machines with historical references
- [ ] Delete blocked for machines assigned to production lines
- [ ] Search and filter work within 200ms
- [ ] Permission enforcement hides unauthorized actions
- [ ] Unit tests for machine-service (>80% coverage)
- [ ] Integration tests for all API endpoints
- [ ] E2E tests for critical flows

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-12-16 | Initial story creation | ARCHITECT-AGENT |
