# 01.8 - Warehouses CRUD

| Field | Value |
|-------|-------|
| **Story ID** | 01.8 |
| **Epic** | 01 - Settings |
| **Status** | Ready |
| **Phase** | 1B |
| **Complexity** | M (Medium) |
| **Estimate** | 3-4 days |
| **Type** | Full-stack |

---

## PRD References

| FR ID | Requirement | Priority | Covered |
|-------|-------------|----------|---------|
| FR-SET-040 | Warehouse CRUD (create, read, update, delete) | P0 | YES |
| FR-SET-041 | Warehouse type (raw/wip/finished/quarantine/general) | P0 | YES |
| FR-SET-042 | Location hierarchy (zone/aisle/rack/bin) | P0 | REF ONLY (Story 01.9) |
| FR-SET-043 | Location capacity tracking | P1 | REF ONLY (Story 01.9) |
| FR-SET-044 | Location type (bulk/pallet/shelf) | P1 | REF ONLY (Story 01.9) |
| FR-SET-045 | Warehouse address and contact | P2 | YES |
| FR-SET-046 | Default warehouse assignment | P1 | YES |

**Primary PRD:** `docs/1-BASELINE/product/modules/settings.md`
**UX Wireframes:** SET-012 (Warehouse List), SET-013 (Warehouse Create/Edit Modal)

---

## User Story

As a **Warehouse Manager or Administrator**, I want to **create, view, edit, and manage warehouses with type classification, address details, and default assignment** so that **the organization can track inventory across multiple physical storage locations with proper categorization**.

---

## Dependencies

| Dependency | Story/Epic | Type | Reason |
|------------|------------|------|--------|
| 01.1 | Org Context + Base RLS | HARD | Requires org_id context and RLS patterns |
| 01.2 | Settings Shell Navigation | HARD | Requires settings navigation structure |
| 01.6 | Role Permissions | HARD | Permission enforcement for warehouse management |

**Dependents:**
- 01.9 (Locations CRUD) - Requires warehouses to exist
- 01.5b (User Warehouse Access) - Requires warehouses for access assignment
- Epic 05 (Warehouse Module) - Inventory operations require warehouse infrastructure

---

## Acceptance Criteria (Gherkin)

### AC-1: Warehouse List Page (FR-SET-040)

```gherkin
Scenario: View warehouse list
  Given admin navigates to `/settings/warehouses`
  When page loads
  Then warehouse list displays within 300ms
  And table shows columns: Code, Name, Type, Locations, Default, Status

Scenario: Search warehouses by code or name
  Given warehouse list with 10+ warehouses
  When admin enters search "WH-RAW"
  Then only warehouses matching code or name display within 200ms

Scenario: Filter by warehouse type
  Given warehouse list displayed
  When admin selects filter "Raw Materials"
  Then only raw material warehouses appear

Scenario: Filter by status
  Given warehouse list displayed
  When admin filters by status "active"
  Then only active warehouses appear

Scenario: Sort warehouse list
  Given warehouse list displayed
  When admin clicks "Name" column header
  Then list sorts alphabetically by name (toggle asc/desc)

Scenario: Pagination
  Given 30 warehouses exist
  When admin views warehouse list
  Then 20 warehouses display per page with pagination controls
```

### AC-2: Create Warehouse (FR-SET-040, FR-SET-041, FR-SET-045)

```gherkin
Scenario: Open create modal
  Given admin clicks "+ Add Warehouse"
  When modal opens
  Then form displays: code, name, type, address (3 lines), contact email, contact phone, active checkbox

Scenario: Create warehouse with required fields
  Given admin enters code "WH-001", name "Main Warehouse", type "General"
  When "Create" clicked
  Then warehouse created and appears in list within 1 second
  And toast "Warehouse created successfully" displays

Scenario: Code uniqueness validation
  Given warehouse "WH-001" exists
  When admin creates another with code "WH-001"
  Then error "Warehouse code must be unique" displays inline
  And form submission blocked

Scenario: Code format validation
  Given admin enters code "invalid code!"
  When save attempted
  Then error "Code must be 2-20 uppercase alphanumeric characters with hyphens only" displays

Scenario: Required field validation
  Given admin leaves code field empty
  When save attempted
  Then error "Code is required" displays inline
```

### AC-3: Warehouse Type (FR-SET-041)

```gherkin
Scenario: Type dropdown options
  Given warehouse create/edit modal open
  When admin opens type dropdown
  Then options display: General, Raw Materials, WIP, Finished Goods, Quarantine

Scenario: Type badge display
  Given warehouses with different types exist
  When viewing warehouse list
  Then type badges display with colors:
    | Type | Color |
    | General | Blue |
    | Raw Materials | Green |
    | WIP | Yellow |
    | Finished Goods | Purple |
    | Quarantine | Red |

Scenario: Type tooltip explanation
  Given warehouse modal open
  When admin hovers type dropdown option "Quarantine"
  Then tooltip displays "Items on hold for quality inspection"
```

### AC-4: Warehouse Address and Contact (FR-SET-045)

```gherkin
Scenario: Address fields display
  Given warehouse create/edit modal open
  When form loads
  Then address section shows 3-line text area (max 500 chars)

Scenario: Contact email validation
  Given admin enters contact email "invalid-email"
  When save attempted
  Then error "Invalid email format" displays

Scenario: Contact phone field
  Given admin enters contact phone "+1-555-123-4567"
  When save completed
  Then phone saved (max 20 chars)

Scenario: Address in list view
  Given warehouse has address "123 Factory Rd, Springfield"
  When viewing warehouse list
  Then second row shows truncated address under warehouse name
```

### AC-5: Default Warehouse Assignment (FR-SET-046)

```gherkin
Scenario: View default warehouse
  Given one warehouse is marked as default
  When viewing warehouse list
  Then default warehouse shows gold star icon in Default column

Scenario: Set as default from actions menu
  Given warehouse "WH-002" exists (not default)
  When admin clicks actions menu > "Set as Default"
  Then confirmation dialog displays "Set WH-002 as default warehouse?"

Scenario: Default assignment atomicity
  Given "WH-001" is current default
  When admin sets "WH-002" as default
  Then "WH-002" becomes default
  And "WH-001" loses default status (atomic operation)

Scenario: Cannot unset last default
  Given only one warehouse exists and is default
  When admin attempts to unset default
  Then action unavailable (hidden or disabled)
```

### AC-6: Edit Warehouse (FR-SET-040)

```gherkin
Scenario: Open edit modal
  Given admin clicks edit on warehouse "WH-001"
  When modal opens
  Then current warehouse data pre-populates form

Scenario: Code immutability with inventory
  Given warehouse "WH-001" has active LPs
  When edit modal opens
  Then code field is disabled with tooltip "Cannot change code for warehouse with inventory"

Scenario: Code editable without inventory
  Given warehouse "WH-NEW" has no LPs
  When edit modal opens
  Then code field is editable

Scenario: Update warehouse name
  Given admin changes name from "Warehouse A" to "Warehouse Alpha"
  When save completed
  Then updated name displays in list immediately
```

### AC-7: Disable/Enable Warehouse (FR-SET-040)

```gherkin
Scenario: Disable warehouse without inventory
  Given warehouse "WH-OLD" has no active inventory (qty = 0)
  When admin clicks "Disable Warehouse"
  Then confirmation displays "Disable warehouse WH-OLD?"
  And warehouse status changes to "disabled" within 500ms

Scenario: Disable warehouse with active inventory blocked
  Given warehouse "WH-ACTIVE" has LPs with qty > 0
  When admin clicks "Disable Warehouse"
  Then error "Cannot disable warehouse with active inventory" displays
  And status remains "active"

Scenario: Disable default warehouse blocked
  Given "WH-001" is default warehouse
  When admin attempts to disable
  Then error "Cannot disable default warehouse. Set another warehouse as default first." displays

Scenario: Enable disabled warehouse
  Given warehouse "WH-OLD" is disabled
  When admin clicks "Enable Warehouse"
  Then status changes to "active" within 500ms
```

### AC-8: Permission Enforcement

```gherkin
Scenario: Admin can manage warehouses
  Given user has ADMIN role
  When accessing /settings/warehouses
  Then all CRUD actions available

Scenario: Warehouse Manager can manage warehouses
  Given user has WH_MANAGER role
  When accessing /settings/warehouses
  Then can add, edit, set default, disable warehouses

Scenario: Production Manager view only
  Given user has PROD_MANAGER role
  When accessing /settings/warehouses
  Then can view list but "Add Warehouse" button hidden
  And row actions hidden

Scenario: Viewer read only
  Given user has VIEWER role
  When accessing /settings/warehouses
  Then table displays but all actions hidden
```

### AC-9: Multi-tenancy

```gherkin
Scenario: Org isolation on list
  Given User A from Org A
  When requesting /api/settings/warehouses
  Then only Org A warehouses returned

Scenario: Cross-tenant access returns 404
  Given User A from Org A
  When requesting warehouse ID from Org B
  Then 404 Not Found returned (not 403)
```

---

## Technical Specification

### Database Schema

```sql
CREATE TABLE warehouses (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  code VARCHAR(20) NOT NULL,
  name VARCHAR(100) NOT NULL,
  type VARCHAR(20) NOT NULL DEFAULT 'GENERAL',
  address TEXT,                    -- max 500 chars
  contact_email VARCHAR(255),      -- FR-SET-045
  contact_phone VARCHAR(20),       -- FR-SET-045
  is_default BOOLEAN DEFAULT false,
  is_active BOOLEAN DEFAULT true,
  location_count INTEGER DEFAULT 0, -- denormalized for performance
  disabled_at TIMESTAMPTZ,
  disabled_by UUID REFERENCES users(id),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  created_by UUID REFERENCES users(id),
  updated_by UUID REFERENCES users(id),

  CONSTRAINT warehouses_org_code_unique UNIQUE(org_id, code),
  CONSTRAINT warehouses_type_check CHECK (type IN ('GENERAL', 'RAW_MATERIALS', 'WIP', 'FINISHED_GOODS', 'QUARANTINE')),
  CONSTRAINT warehouses_code_format CHECK (code ~ '^[A-Z0-9-]{2,20}$'),
  CONSTRAINT warehouses_address_length CHECK (address IS NULL OR char_length(address) <= 500),
  CONSTRAINT warehouses_phone_length CHECK (contact_phone IS NULL OR char_length(contact_phone) <= 20)
);

-- Indexes
CREATE INDEX idx_warehouses_org_id ON warehouses(org_id);
CREATE INDEX idx_warehouses_org_type ON warehouses(org_id, type);
CREATE INDEX idx_warehouses_org_active ON warehouses(org_id, is_active);

-- Trigger: Ensure only one default per org
CREATE OR REPLACE FUNCTION ensure_single_default_warehouse()
RETURNS TRIGGER AS $$
BEGIN
  IF NEW.is_default = true THEN
    UPDATE warehouses
    SET is_default = false, updated_at = NOW()
    WHERE org_id = NEW.org_id
      AND id != NEW.id
      AND is_default = true;
  END IF;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER tr_warehouses_single_default
BEFORE INSERT OR UPDATE OF is_default ON warehouses
FOR EACH ROW
WHEN (NEW.is_default = true)
EXECUTE FUNCTION ensure_single_default_warehouse();

-- Trigger: Update location_count (maintained by locations table triggers)
-- See Story 01.9 for location_count maintenance
```

### RLS Policies

```sql
-- Enable RLS
ALTER TABLE warehouses ENABLE ROW LEVEL SECURITY;

-- Select: Org isolation (per ADR-013 pattern)
CREATE POLICY "warehouses_select" ON warehouses
FOR SELECT TO authenticated
USING (org_id = (SELECT org_id FROM users WHERE id = auth.uid()));

-- Insert: Org isolation + permission check
CREATE POLICY "warehouses_insert" ON warehouses
FOR INSERT TO authenticated
WITH CHECK (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  AND (
    (SELECT r.code FROM roles r JOIN users u ON u.role_id = r.id WHERE u.id = auth.uid())
    IN ('SUPER_ADMIN', 'ADMIN', 'WH_MANAGER')
  )
);

-- Update: Org isolation + permission check
CREATE POLICY "warehouses_update" ON warehouses
FOR UPDATE TO authenticated
USING (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  AND (
    (SELECT r.code FROM roles r JOIN users u ON u.role_id = r.id WHERE u.id = auth.uid())
    IN ('SUPER_ADMIN', 'ADMIN', 'WH_MANAGER')
  )
);

-- Delete: Org isolation + admin only (soft delete preferred)
CREATE POLICY "warehouses_delete" ON warehouses
FOR DELETE TO authenticated
USING (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  AND (
    (SELECT r.code FROM roles r JOIN users u ON u.role_id = r.id WHERE u.id = auth.uid())
    IN ('SUPER_ADMIN', 'ADMIN')
  )
);
```

### API Endpoints

```
GET    /api/v1/settings/warehouses                    - List warehouses (paginated, filtered)
POST   /api/v1/settings/warehouses                    - Create warehouse
GET    /api/v1/settings/warehouses/:id                - Get warehouse by ID
PUT    /api/v1/settings/warehouses/:id                - Update warehouse
DELETE /api/v1/settings/warehouses/:id                - Soft delete warehouse
PATCH  /api/v1/settings/warehouses/:id/set-default    - Set as default warehouse
PATCH  /api/v1/settings/warehouses/:id/disable        - Disable warehouse
PATCH  /api/v1/settings/warehouses/:id/enable         - Enable warehouse
GET    /api/v1/settings/warehouses/validate-code      - Check code uniqueness (debounce)
```

**Query Parameters (List):**
- `search` - Filter by code or name (min 2 chars)
- `type` - Filter by warehouse type (GENERAL, RAW_MATERIALS, WIP, FINISHED_GOODS, QUARANTINE)
- `status` - Filter by status (active, disabled)
- `sort` - Sort field (code, name, type, location_count, created_at)
- `order` - Sort order (asc, desc)
- `page` - Page number (default 1)
- `limit` - Items per page (default 20, max 100)

### Service Layer

```typescript
// lib/services/warehouse-service.ts
export interface WarehouseService {
  list(params: WarehouseListParams): Promise<PaginatedResult<Warehouse>>;
  getById(id: string): Promise<Warehouse | null>;
  create(data: CreateWarehouseInput): Promise<Warehouse>;
  update(id: string, data: UpdateWarehouseInput): Promise<Warehouse>;
  delete(id: string): Promise<void>; // soft delete
  setDefault(id: string): Promise<Warehouse>;
  disable(id: string): Promise<Warehouse>;
  enable(id: string): Promise<Warehouse>;
  validateCode(code: string, excludeId?: string): Promise<{ available: boolean }>;
  hasActiveInventory(id: string): Promise<boolean>;
  canDisable(id: string): Promise<{ allowed: boolean; reason?: string }>;
}

// Type definitions
export type WarehouseType = 'GENERAL' | 'RAW_MATERIALS' | 'WIP' | 'FINISHED_GOODS' | 'QUARANTINE';

export interface Warehouse {
  id: string;
  org_id: string;
  code: string;
  name: string;
  type: WarehouseType;
  address: string | null;
  contact_email: string | null;
  contact_phone: string | null;
  is_default: boolean;
  is_active: boolean;
  location_count: number;
  disabled_at: string | null;
  disabled_by: string | null;
  created_at: string;
  updated_at: string;
  created_by: string;
  updated_by: string;
}
```

### Validation Schema (Zod)

```typescript
// lib/validation/warehouse.ts
import { z } from 'zod';

export const warehouseTypeEnum = z.enum([
  'GENERAL',
  'RAW_MATERIALS',
  'WIP',
  'FINISHED_GOODS',
  'QUARANTINE'
]);

export const createWarehouseSchema = z.object({
  code: z.string()
    .min(2, "Code must be at least 2 characters")
    .max(20, "Code must be at most 20 characters")
    .regex(/^[A-Z0-9-]+$/, "Code must be uppercase alphanumeric with hyphens only")
    .transform(val => val.toUpperCase()),
  name: z.string()
    .min(2, "Name must be at least 2 characters")
    .max(100, "Name must be at most 100 characters"),
  type: warehouseTypeEnum.default('GENERAL'),
  address: z.string()
    .max(500, "Address must be at most 500 characters")
    .nullable()
    .optional(),
  contact_email: z.string()
    .email("Invalid email format")
    .max(255)
    .nullable()
    .optional()
    .or(z.literal('')),
  contact_phone: z.string()
    .max(20, "Phone must be at most 20 characters")
    .nullable()
    .optional(),
  is_active: z.boolean().default(true),
});

export const updateWarehouseSchema = createWarehouseSchema
  .partial()
  .omit({ code: true }) // code handled separately based on inventory
  .extend({
    code: z.string()
      .min(2)
      .max(20)
      .regex(/^[A-Z0-9-]+$/)
      .transform(val => val.toUpperCase())
      .optional(),
  });

export const setDefaultSchema = z.object({
  warehouse_id: z.string().uuid(),
});

export type CreateWarehouseInput = z.infer<typeof createWarehouseSchema>;
export type UpdateWarehouseInput = z.infer<typeof updateWarehouseSchema>;
```

---

## UI Components

```
app/(authenticated)/settings/warehouses/
  page.tsx                          -- Warehouse list page

components/settings/warehouses/
  WarehousesDataTable.tsx           -- Table with sorting, filtering, pagination
  WarehouseModal.tsx                -- Create/Edit form modal (SET-013)
  WarehouseRow.tsx                  -- Single warehouse row with secondary line
  WarehouseTypeBadge.tsx            -- Type badge with color coding
  WarehouseStatusBadge.tsx          -- Active/Disabled status indicator
  WarehouseActionsMenu.tsx          -- Row actions dropdown (edit, set default, disable)
  WarehouseFilters.tsx              -- Search + type/status filter bar
  SetDefaultConfirmDialog.tsx       -- Confirmation for default change
  DisableConfirmDialog.tsx          -- Confirmation with inventory check warning
  WarehouseTypeSelect.tsx           -- Dropdown with tooltips explaining each type
  WarehouseAddressSection.tsx       -- 3-line address input with char counter
  WarehouseContactSection.tsx       -- Email + phone inputs with validation
```

### Badge Colors (TailwindCSS)

| Type | Badge Class |
|------|-------------|
| General | `bg-blue-100 text-blue-800` |
| Raw Materials | `bg-green-100 text-green-800` |
| WIP | `bg-yellow-100 text-yellow-800` |
| Finished Goods | `bg-purple-100 text-purple-800` |
| Quarantine | `bg-red-100 text-red-800` |

| Status | Badge Class |
|--------|-------------|
| Active | `bg-green-100 text-green-800` |
| Disabled | `bg-gray-100 text-gray-800` |

---

## Wireframe References

- **SET-012**: Warehouse List - `/docs/3-ARCHITECTURE/ux/wireframes/SET-012-warehouse-list.md`
- **SET-013**: Warehouse Create/Edit Modal - `/docs/3-ARCHITECTURE/ux/wireframes/SET-013-warehouse-create-edit-modal.md`

---

## Out of Scope

| Feature | Reason | Future Story |
|---------|--------|--------------|
| Location hierarchy (zone/aisle/rack/bin) | FR-SET-042/043/044 | Story 01.9 |
| Location capacity tracking | Separate concern | Story 01.9 |
| Location types (bulk/pallet/shelf) | Separate concern | Story 01.9 |
| Warehouse floor plan visualization | Phase 2 feature | Future |
| Warehouse performance metrics | OEE module | Epic 10 |
| Multi-warehouse transfers | Warehouse module | Epic 05 |

---

## Test Cases

### Unit Tests

**File:** `__tests__/unit/services/warehouse-service.test.ts`

| Test Case | Description |
|-----------|-------------|
| `list()` returns org-scoped warehouses | Verify RLS filtering |
| `create()` validates code uniqueness | Duplicate code rejected |
| `create()` auto-uppercases code | "wh-001" becomes "WH-001" |
| `update()` prevents code change with inventory | hasActiveInventory check |
| `setDefault()` unsets previous default | Atomic transaction |
| `disable()` blocks with active inventory | canDisable validation |
| `disable()` blocks default warehouse | Must set new default first |
| `validateCode()` returns availability | Real-time validation |

### Integration Tests

**File:** `__tests__/integration/api/settings/warehouses.test.ts`

| Test Case | Description |
|-----------|-------------|
| GET `/warehouses` returns paginated list | Pagination, sorting |
| GET `/warehouses?type=RAW_MATERIALS` filters | Type filter works |
| POST `/warehouses` creates with validation | All fields validated |
| POST `/warehouses` duplicate code 400 | Uniqueness enforced |
| PUT `/warehouses/:id` updates mutable fields | Name, address, contact |
| PUT `/warehouses/:id` code immutable with LPs | Returns 400 |
| PATCH `/warehouses/:id/set-default` atomicity | Previous default unset |
| PATCH `/warehouses/:id/disable` with inventory | Returns 400 |
| Cross-org access returns 404 | Multi-tenancy enforced |
| Permission denied returns 403 | Role enforcement |

### E2E Tests

**File:** `__tests__/e2e/settings/warehouses.spec.ts`

| Test Case | Description |
|-----------|-------------|
| Create warehouse flow | Modal > form > save > list updated |
| Edit warehouse flow | Actions > edit > modify > save |
| Set default warehouse | Actions > set default > confirm > star icon |
| Disable warehouse | Actions > disable > confirm > status badge |
| Search and filter | Search box, dropdowns, results |
| Permission-based UI | Viewer sees no actions |

---

## Definition of Done

- [ ] Database migration creates `warehouses` table with all constraints
- [ ] RLS policies enforce org isolation and role permissions
- [ ] Single default warehouse trigger works atomically
- [ ] All 8 API endpoints implemented and documented
- [ ] Zod schemas validate all inputs (code format, email, phone)
- [ ] `warehouse-service.ts` implements all methods
- [ ] Warehouse list page renders with DataTable (SET-012)
- [ ] Create/Edit modal with all fields (SET-013)
- [ ] Type dropdown with tooltips and badge colors
- [ ] Address section (3 lines, 500 char limit)
- [ ] Contact fields (email + phone) with validation
- [ ] Default warehouse star icon and "Set as Default" action
- [ ] Disable/Enable with inventory check
- [ ] Code immutability enforced when LPs exist
- [ ] Search, filter, sort, pagination work correctly
- [ ] Permission matrix implemented (admin, wh_manager, viewer)
- [ ] Multi-tenancy: cross-org returns 404
- [ ] Unit tests >= 80% coverage
- [ ] Integration tests for all endpoints
- [ ] E2E tests for critical flows
- [ ] Loading, empty, error states implemented
- [ ] Toast notifications on success/error
- [ ] Accessibility: keyboard nav, ARIA labels, screen reader support

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-12-16 | Initial story creation | ARCHITECT-AGENT |
