# 08.8 - Compliance Documents Upload

**Priority**: P1 (Phase 1 MVP)
**Story Points**: M (Medium)
**Type**: fullstack
**Phase**: 1 (Core NPD)
**Model**: OPUS

**State:** ready
**Estimate:** M (3-4 days)
**Primary PRD:** `docs/1-BASELINE/product/modules/npd.md` (Section 7, FR-NPD-31-35)
**Architecture:** `docs/1-BASELINE/architecture/modules/npd.md` (npd_compliance_docs table)

---

## Goal

Implement compliance document upload and management system for NPD projects. Enable NPD teams to upload, categorize, preview, and manage critical compliance documents (HACCP plans, label proofs, nutritional info, CoA, SDS) required for handoff to production. Validate all required documents before allowing project handoff.

---

## Premium Module Notice

NPD is a **premium add-on** module for Growth/Enterprise tiers.

**Module Activation:**
- Feature flag: `org_settings.enabled_modules` includes `'npd'`
- Per-organization activation
- Free tier: Module disabled, navigation hidden
- Growth/Enterprise: Module available after activation

**Key Value Propositions:**
- Regulatory compliance documentation management
- Traceability of all compliance artifacts
- Handoff validation (ensures required docs complete)
- Integration with Supabase Storage + CDN

---

## Food Safety Compliance

This story is **critical for regulatory compliance**:

- [x] **HACCP** - HACCP plan documentation required for Gate G4 approval
- [x] **FDA 21 CFR 101** - Nutritional information and label proof required
- [x] **Allergen Labeling** - Allergen declaration documentation
- [x] **Supplier Compliance** - Certificate of Analysis (CoA), SDS storage
- [x] **Audit Trail** - Document upload history for regulatory audits

**Regulatory Context:**
- HACCP plan must be documented before commercial production
- Label proof ensures compliance with FDA labeling requirements
- Nutritional info required for all packaged food products
- CoA and SDS required for supplier traceability
- Document metadata (uploaded by, uploaded at) provides audit trail

---

## MVP Scope

This story implements Phase 1 (Core NPD) functionality. Compliance Documents are critical for Gate G4 approval and handoff validation.

**MVP Includes**:
- `npd_compliance_docs` table with RLS policies
- Document upload to Supabase Storage
- Document categorization (HACCP, label, nutritional, CoA, SDS)
- Document metadata: filename, file size, upload date, uploaded_by
- Document preview (PDF/image inline viewer)
- Document download (signed URLs with 1-hour expiry)
- Document deletion (soft delete with `deleted_at` timestamp)
- Required documents checklist (validates before handoff)
- GET /api/npd/projects/:id/documents
- POST /api/npd/projects/:id/documents (multipart upload)
- DELETE /api/npd/documents/:id (soft delete)
- GET /api/npd/documents/:id/download (signed URL)
- Drag-and-drop upload UI
- Document list with preview thumbnails
- File type validation (PDF, DOCX, XLSX, PNG, JPG)
- File size limit: 50 MB per file

**Deferred to Phase 2**: Document versioning, collaborative editing, OCR search, e-signature integration.

---

## Future Phases (Not in MVP)

### Phase 2 (Story 08.8b - Document Versioning)
- **Version control** - Track document versions (v1.0, v2.0)
- **Version history** - View all versions with change reasons
- **Compare versions** - Diff between document versions
- **Rollback** - Restore previous version

### Phase 3
- **E-signature integration** - 21 CFR Part 11 compliant signatures
- **Collaborative editing** - Multiple users editing same doc
- **OCR full-text search** - Search within PDF content
- **Document templates** - Pre-filled compliance forms

### Deferred to Other Stories
- **Gate approvals** - Story 08.6 (Gate approval workflow)
- **Handoff wizard** - Story 08.9 (Handoff validation uses these docs)
- **Document control** - Quality Module (quality_documents table)

---

## User Story

As an **NPD Lead**, I want to **upload and organize compliance documents for NPD projects** so that **all required documentation is centralized and ready for handoff**.

As a **Regulatory Specialist**, I want to **validate that all required compliance documents are present** so that **projects cannot proceed to production without proper documentation**.

As an **Auditor**, I want to **view the complete document upload history with metadata** so that **I can verify regulatory compliance**.

---

## Scope

**In scope (this story)**
- `npd_compliance_docs` table with soft delete
- Document upload to Supabase Storage bucket `npd-compliance-docs`
- Document types: haccp_plan, label_proof, nutritional_info, coa, sds, trial_report, sensory_eval, other
- Document metadata: filename, file_size, mime_type, uploaded_by, uploaded_at
- Drag-and-drop upload with progress indicator
- Document list with preview thumbnails (PDF first page, image thumbnail)
- Document preview modal (PDF inline viewer, image viewer)
- Document download (signed URL with 1-hour expiry)
- Soft delete (sets deleted_at timestamp, retains record)
- Required documents checklist (HACCP required for G4)
- File type validation: PDF, DOCX, XLSX, PNG, JPG, JPEG
- File size limit: 50 MB
- GET /api/npd/projects/:id/documents
- POST /api/npd/projects/:id/documents (multipart)
- DELETE /api/npd/documents/:id
- GET /api/npd/documents/:id/download

**Out of scope (this story)**
- Document versioning (Phase 2)
- Document approval workflow (Phase 2)
- OCR full-text search (Phase 3)
- E-signature integration (Phase 3)
- Document templates (Phase 3)
- Integration with external document systems (SharePoint, Dropbox)

---

## Dependencies

### Cross-Epic Dependencies

| Dependency | Story/Epic | Type | What It Provides | Status |
|------------|------------|------|------------------|--------|
| 01.1 | Org Context + RLS | HARD | organizations, users tables | Ready |
| 08.2 | NPD Projects CRUD | HARD | npd_projects table | Ready |

### Within Epic Dependencies

| Dependency | Story | Type | What It Provides |
|------------|-------|------|------------------|
| None | - | - | This is independent of other NPD stories |

### Provides To (Downstream)

| Story | What This Provides |
|-------|-------------------|
| 08.9 | Handoff Wizard - Validates required docs before handoff |
| 08.6 | Gate Approvals - Documents used in gate approval decisions |

---

## Database Migration

### Migration: Create npd_compliance_docs table

```sql
-- Migration: YYYYMMDDHHMMSS_create_npd_compliance_docs.sql

CREATE TABLE npd_compliance_docs (
    -- Identity
    id                      UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id                  UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    npd_project_id          UUID NOT NULL REFERENCES npd_projects(id) ON DELETE CASCADE,

    -- Document Type
    doc_type                TEXT NOT NULL
                            CHECK (doc_type IN (
                                'haccp_plan',
                                'label_proof',
                                'nutritional_info',
                                'allergen_declaration',
                                'coa',
                                'sds',
                                'trial_report',
                                'sensory_eval',
                                'shelf_life',
                                'other'
                            )),

    -- File Metadata
    file_name               TEXT NOT NULL,
    file_size_bytes         BIGINT NOT NULL,
    mime_type               TEXT NOT NULL,
    storage_path            TEXT NOT NULL, -- Supabase Storage path

    -- Optional Fields
    version                 TEXT, -- Document version (e.g., "v1.2")
    description             TEXT,
    notes                   TEXT,

    -- Audit Trail
    uploaded_by             UUID NOT NULL REFERENCES users(id),
    uploaded_at             TIMESTAMPTZ NOT NULL DEFAULT now(),
    updated_at              TIMESTAMPTZ NOT NULL DEFAULT now(),

    -- Soft Delete
    deleted_at              TIMESTAMPTZ,
    deleted_by              UUID REFERENCES users(id)
);

-- =============================================================================
-- Indexes for Performance
-- =============================================================================

CREATE INDEX idx_npd_docs_org ON npd_compliance_docs(org_id);
CREATE INDEX idx_npd_docs_project ON npd_compliance_docs(npd_project_id)
    WHERE deleted_at IS NULL;
CREATE INDEX idx_npd_docs_type ON npd_compliance_docs(npd_project_id, doc_type)
    WHERE deleted_at IS NULL;
CREATE INDEX idx_npd_docs_uploaded ON npd_compliance_docs(uploaded_at DESC);

-- =============================================================================
-- RLS Policies
-- =============================================================================

ALTER TABLE npd_compliance_docs ENABLE ROW LEVEL SECURITY;

CREATE POLICY "npd_docs_select" ON npd_compliance_docs
    FOR SELECT USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
        AND deleted_at IS NULL
    );

CREATE POLICY "npd_docs_insert" ON npd_compliance_docs
    FOR INSERT WITH CHECK (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

CREATE POLICY "npd_docs_update" ON npd_compliance_docs
    FOR UPDATE USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

-- Soft delete only (no hard delete policy)
CREATE POLICY "npd_docs_delete" ON npd_compliance_docs
    FOR UPDATE USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
        AND deleted_at IS NULL
    );

-- =============================================================================
-- Triggers
-- =============================================================================

CREATE TRIGGER update_npd_compliance_docs_updated_at
    BEFORE UPDATE ON npd_compliance_docs
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- =============================================================================
-- Function: Check Required Documents
-- =============================================================================

CREATE OR REPLACE FUNCTION check_required_documents(p_project_id UUID)
RETURNS JSONB AS $$
DECLARE
    v_gate TEXT;
    v_result JSONB := '{"is_valid": true, "missing": []}'::JSONB;
    v_missing TEXT[] := ARRAY[]::TEXT[];
BEGIN
    -- Get current gate
    SELECT current_gate INTO v_gate
    FROM npd_projects
    WHERE id = p_project_id;

    -- Gate G4 requires HACCP plan
    IF v_gate = 'G4' THEN
        IF NOT EXISTS (
            SELECT 1
            FROM npd_compliance_docs
            WHERE npd_project_id = p_project_id
              AND doc_type = 'haccp_plan'
              AND deleted_at IS NULL
        ) THEN
            v_missing := array_append(v_missing, 'HACCP Plan');
        END IF;
    END IF;

    -- Build result
    IF array_length(v_missing, 1) > 0 THEN
        v_result := jsonb_build_object(
            'is_valid', false,
            'missing', v_missing
        );
    END IF;

    RETURN v_result;
END;
$$ LANGUAGE plpgsql;
```

---

## Acceptance Criteria (Given/When/Then)

### AC-1: Database Table Creation

```gherkin
Scenario: npd_compliance_docs table created
  Given database migration runs
  When schema inspected
  Then npd_compliance_docs table exists with all columns
  And FK constraints for org_id, npd_project_id, uploaded_by, deleted_by
  And CHECK constraint on doc_type enum
  And RLS policies enforce org isolation
  And soft delete support via deleted_at column
```

### AC-2: Document Upload

```gherkin
Scenario: Upload compliance document
  Given NPD project NPD-2025-00001 exists
  And user with NPD_LEAD role
  When navigating to NPD > Projects > NPD-2025-00001 > Documents
  And clicking [+ Upload Document]
  Then upload modal opens with:
    | Field | Required | Type |
    | Document Type | Yes | Dropdown (HACCP, Label, Nutritional, CoA, SDS, etc.) |
    | File | Yes | Drag-and-drop or browse |
    | Version | No | Text input |
    | Description | No | Textarea |
  And user selects doc_type = 'haccp_plan'
  And uploads PDF file "HACCP_Plan_v1.2.pdf" (2.5 MB)
  And clicks [Upload]
  Then file uploaded to Supabase Storage:
    - Bucket: npd-compliance-docs
    - Path: {org_id}/{project_id}/haccp_plan/{file_id}_{filename}
  And document record created:
    - doc_type = 'haccp_plan'
    - file_name = 'HACCP_Plan_v1.2.pdf'
    - file_size_bytes = 2621440
    - mime_type = 'application/pdf'
    - uploaded_by = current user
    - uploaded_at = now
    - deleted_at = NULL
  And success toast: "Document uploaded successfully"
  And document appears in list

Scenario: Upload with progress indicator
  Given user uploading 25 MB PDF file
  When upload initiated
  Then progress bar displays percentage (0% → 100%)
  And estimated time remaining shown
  And cancel button available during upload

Scenario: File type validation
  Given user uploading file
  When file type is .exe
  Then error: "Invalid file type. Allowed: PDF, DOCX, XLSX, PNG, JPG"
  And upload prevented

Scenario: File size validation
  Given user uploading 75 MB PDF
  When file size exceeds 50 MB
  Then error: "File size exceeds limit (50 MB)"
  And upload prevented
```

### AC-3: Document List View

```gherkin
Scenario: Display document list
  Given project NPD-2025-00001 has 5 documents
  When viewing Documents tab
  Then document list displays:
    | Column | Content |
    | Thumbnail | Preview image (PDF first page or image thumbnail) |
    | File Name | Original filename |
    | Type | Badge (HACCP, Label, CoA, SDS, etc.) |
    | Version | Version number (if set) |
    | Size | File size (2.5 MB) |
    | Uploaded By | User name |
    | Uploaded At | Date/time |
    | Actions | [Preview] [Download] [Delete] |
  And documents ordered by uploaded_at DESC
  And deleted documents not shown

Scenario: Empty state
  Given project has no documents
  When viewing Documents tab
  Then empty state displays:
    - Icon: document icon
    - Message: "No compliance documents yet"
    - Action: [+ Upload Document] button
```

### AC-4: Document Preview

```gherkin
Scenario: Preview PDF document
  Given document "HACCP_Plan_v1.2.pdf" exists
  When clicking [Preview]
  Then modal opens with:
    - PDF inline viewer (iframe or PDF.js)
    - Navigation controls (page up/down)
    - Zoom controls (+/-)
    - Full-screen button
    - [Download] button
    - [Close] button

Scenario: Preview image document
  Given document "Label_Proof.png" exists
  When clicking [Preview]
  Then modal opens with:
    - Image displayed full size
    - Zoom controls
    - [Download] button
    - [Close] button

Scenario: Preview unsupported file type
  Given document "Data.xlsx" exists
  When clicking [Preview]
  Then modal shows:
    - Message: "Preview not available for this file type"
    - [Download] button to download file
```

### AC-5: Document Download

```gherkin
Scenario: Download document
  Given document "HACCP_Plan_v1.2.pdf" exists
  When clicking [Download]
  Then GET /api/npd/documents/:id/download called
  And API returns signed URL (expires in 1 hour)
  And browser downloads file:
    - Filename: "HACCP_Plan_v1.2.pdf"
    - Content-Type: application/pdf

Scenario: Signed URL expiry
  Given signed URL generated at 10:00 AM
  When accessing URL at 11:01 AM (61 minutes later)
  Then error: "Download link expired"
  And user must request new download link
```

### AC-6: Document Deletion (Soft Delete)

```gherkin
Scenario: Delete document
  Given document "Old_Label_v1.pdf" exists
  And user is owner or NPD_LEAD
  When clicking [Delete] icon
  Then confirmation dialog displays:
    - Message: "Delete 'Old_Label_v1.pdf'?"
    - Warning: "This document will be removed from the project"
    - [Cancel] [Delete] buttons
  And user clicks [Delete]
  Then document soft deleted:
    - deleted_at = now
    - deleted_by = current user
  And document removed from list
  And success toast: "Document deleted"

Scenario: Prevent hard delete
  Given deleted document exists in database
  When querying npd_compliance_docs
  Then deleted documents retained with deleted_at IS NOT NULL
  And RLS policy excludes deleted documents from SELECT

Scenario: Permission check
  Given document uploaded by User A
  And current user is User B (not NPD_LEAD)
  When User B attempts to delete document
  Then error: "Insufficient permissions to delete document"
  And delete prevented
```

### AC-7: Required Documents Checklist

```gherkin
Scenario: Check required documents for G4
  Given project at Gate G4
  When viewing Documents tab
  Then required documents checklist displays:
    | Document Type | Status |
    | HACCP Plan | ✅ Uploaded (or ❌ Missing) |
  And missing documents highlighted in red
  And warning banner: "Required documents missing: HACCP Plan"

Scenario: Validate before handoff
  Given project at Gate G4
  And HACCP Plan missing
  When attempting to initiate handoff
  Then validation function check_required_documents() called
  And returns:
    {
      "is_valid": false,
      "missing": ["HACCP Plan"]
    }
  And handoff blocked with error: "Cannot handoff: Missing required documents"
```

### AC-8: Document Type Categorization

```gherkin
Scenario: Filter documents by type
  Given project has 10 documents (3 HACCP, 2 CoA, 5 other)
  When filtering by doc_type = 'haccp_plan'
  Then only 3 HACCP documents displayed

Scenario: Type badge display
  Given document with doc_type = 'label_proof'
  When viewing document list
  Then badge displays "Label Proof" with icon
  And badge color matches type (e.g., blue for labels)
```

### AC-9: Document Metadata Display

```gherkin
Scenario: View document metadata
  Given document with version = "v1.2" and description = "Updated allergen info"
  When viewing document detail or hovering over info icon
  Then tooltip/panel displays:
    | Field | Value |
    | File Name | HACCP_Plan_v1.2.pdf |
    | Type | HACCP Plan |
    | Version | v1.2 |
    | Size | 2.5 MB |
    | Description | Updated allergen info |
    | Uploaded By | Jane Doe |
    | Uploaded At | 2025-01-15 14:30 |
```

### AC-10: RLS Policy Enforcement

```gherkin
Scenario: Org isolation on documents
  Given User A from Org A and User B from Org B
  When User A queries documents
  Then sees only Org A documents
  And User B sees only Org B documents

Scenario: Cross-org document access blocked
  Given document belongs to Org B project
  When User A (Org A) attempts to access document
  Then API returns 404 Not Found
  And download link denied

Scenario: Soft-deleted documents excluded
  Given document with deleted_at = 2025-01-10
  When querying documents via RLS policy
  Then deleted document not returned
  And only active documents (deleted_at IS NULL) shown
```

### AC-11: Supabase Storage Integration

```gherkin
Scenario: Upload to Supabase Storage
  Given user uploading "HACCP_Plan.pdf"
  When upload initiated
  Then file uploaded to bucket 'npd-compliance-docs'
  And path = '{org_id}/{project_id}/{doc_type}/{uuid}_{filename}'
  And storage_path saved in npd_compliance_docs table
  And file accessible via signed URL

Scenario: Storage path organization
  Given org_id = 'abc123', project_id = 'proj456', doc_type = 'haccp_plan'
  When uploading "HACCP_Plan.pdf"
  Then storage_path = 'abc123/proj456/haccp_plan/{uuid}_HACCP_Plan.pdf'
  And organized by org > project > type for easy browsing

Scenario: CDN delivery
  Given document stored in Supabase Storage
  When generating download URL
  Then URL served via Supabase CDN
  And response time < 200ms (CDN cached)
```

### AC-12: Permission Enforcement

```gherkin
Scenario: NPD Lead can upload/delete
  Given user with NPD_LEAD role
  Then can upload documents
  And can delete any document in project

Scenario: R&D can upload but not delete others
  Given user with R&D role
  Then can upload documents
  And can delete own documents
  And cannot delete documents uploaded by others

Scenario: Regulatory can upload
  Given user with REGULATORY role
  Then can upload compliance documents
  And can view all documents

Scenario: Viewer can view/download only
  Given user with VIEWER role
  Then can view document list
  And can download documents
  And cannot upload or delete
```

### AC-13: Performance Requirements

```gherkin
Scenario: Document list load time
  Given project with 50 documents
  When loading Documents tab
  Then response time < 500ms
  And thumbnails lazy-loaded
  And pagination available (20 per page)

Scenario: Upload performance
  Given user uploading 10 MB PDF
  When upload initiated
  Then upload completes within 15 seconds
  And progress updates every 200ms
```

---

## Implementation Notes

### API Endpoints

```typescript
// =============================================================================
// Compliance Document Endpoints
// =============================================================================

// GET /api/npd/projects/:id/documents
interface DocumentListRequest {
  doc_type?: 'haccp_plan' | 'label_proof' | 'nutritional_info' | 'coa' | 'sds' | 'trial_report' | 'sensory_eval' | 'shelf_life' | 'other';
  sort_by?: 'uploaded_at' | 'file_name' | 'file_size_bytes';
  sort_order?: 'asc' | 'desc';
  page?: number;
  limit?: number;
}

interface DocumentListResponse {
  documents: ComplianceDocument[];
  pagination: {
    total: number;
    page: number;
    limit: number;
    pages: number;
  };
}

interface ComplianceDocument {
  id: string;
  npd_project_id: string;
  doc_type: string;
  file_name: string;
  file_size_bytes: number;
  mime_type: string;
  storage_path: string;
  version?: string;
  description?: string;
  notes?: string;
  uploaded_by: string;
  uploaded_by_name: string;
  uploaded_at: string;
  thumbnail_url?: string; // Signed URL for preview thumbnail
}

// POST /api/npd/projects/:id/documents
interface UploadDocumentRequest {
  doc_type: string;
  file: File; // Multipart form data
  version?: string;
  description?: string;
  notes?: string;
}

interface UploadDocumentResponse {
  document: ComplianceDocument;
}

// DELETE /api/npd/documents/:id
// Soft delete (sets deleted_at timestamp)
interface DeleteDocumentResponse {
  success: boolean;
  message: string;
}

// GET /api/npd/documents/:id/download
// Returns signed URL for file download
interface DocumentDownloadResponse {
  download_url: string; // Signed URL (expires in 1 hour)
  filename: string;
  mime_type: string;
}

// GET /api/npd/projects/:id/documents/validate
// Checks required documents for current gate
interface ValidateDocumentsResponse {
  is_valid: boolean;
  missing: string[]; // Array of missing document type names
}
```

### Service Layer

```typescript
// lib/services/npd-document-service.ts

export class NPDDocumentService {
  // CRUD
  static async list(projectId: string, params: DocumentListParams): Promise<PaginatedResult<ComplianceDocument>>;
  static async getById(id: string): Promise<ComplianceDocument | null>;
  static async upload(
    projectId: string,
    file: File,
    docType: string,
    metadata: { version?: string; description?: string; notes?: string }
  ): Promise<ComplianceDocument>;
  static async delete(id: string): Promise<void>; // Soft delete

  // File Management
  static async uploadToStorage(
    file: File,
    orgId: string,
    projectId: string,
    docType: string
  ): Promise<string>; // Returns storage_path
  static async generateDownloadUrl(id: string): Promise<string>; // Returns signed URL
  static async generateThumbnail(documentId: string): Promise<string>; // For PDF/images

  // Validation
  static async validateRequiredDocuments(projectId: string): Promise<{ is_valid: boolean; missing: string[] }>;
  static async checkFileType(file: File): Promise<boolean>;
  static async checkFileSize(file: File, maxSizeMB: number): Promise<boolean>;

  // Utility
  static async getDocumentTypeLabel(docType: string): string;
  static async formatFileSize(bytes: number): string;
}
```

### Frontend Components

```
apps/frontend/app/(authenticated)/npd/
  projects/
    [id]/
      documents/
        page.tsx                          -- Documents tab page

components/npd/documents/
  DocumentUploadModal.tsx                 -- Upload form with drag-and-drop
  DocumentList.tsx                        -- Document list with thumbnails
  DocumentCard.tsx                        -- Individual document card
  DocumentPreviewModal.tsx                -- PDF/image preview
  DocumentTypeBadge.tsx                   -- Type badge component
  RequiredDocsChecklist.tsx               -- Required documents validation
  DocumentActionsMenu.tsx                 -- Download/delete actions
  UploadProgress.tsx                      -- Upload progress indicator
```

### Supabase Storage Setup

```typescript
// Create bucket (admin)
await supabase.storage.createBucket('npd-compliance-docs', {
  public: false,
  fileSizeLimit: 52428800, // 50 MB
  allowedMimeTypes: [
    'application/pdf',
    'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
    'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
    'image/png',
    'image/jpeg',
    'image/jpg'
  ]
});

// Storage path pattern
const storagePath = `${org_id}/${project_id}/${doc_type}/${uuid}_${filename}`;

// Upload file
const { data, error } = await supabase.storage
  .from('npd-compliance-docs')
  .upload(storagePath, file);

// Generate signed URL (1 hour expiry)
const { data: urlData } = await supabase.storage
  .from('npd-compliance-docs')
  .createSignedUrl(storagePath, 3600);
```

---

## Key Business Rules

1. **Soft Delete Only**: Documents are never hard deleted (sets deleted_at timestamp)
2. **File Type Whitelist**: Only PDF, DOCX, XLSX, PNG, JPG allowed
3. **File Size Limit**: Maximum 50 MB per file
4. **Signed URL Expiry**: Download URLs expire after 1 hour
5. **Required Documents (G4)**: HACCP Plan mandatory for Gate G4
6. **Org Isolation**: RLS policies enforce org_id filtering
7. **Storage Path Organization**: Files organized by org > project > type
8. **Audit Trail**: uploaded_by, uploaded_at, deleted_by tracked
9. **Version Optional**: Document version is optional metadata
10. **Thumbnail Generation**: PDF first page and images generate preview thumbnails

---

## Deliverables

### Database
- [ ] Migration: `npd_compliance_docs` table
- [ ] Function: `check_required_documents(project_id)` validation
- [ ] RLS policies for npd_compliance_docs
- [ ] Indexes for performance

### API Routes
- [ ] `GET /api/npd/projects/:id/documents` - List documents
- [ ] `POST /api/npd/projects/:id/documents` - Upload document (multipart)
- [ ] `DELETE /api/npd/documents/:id` - Soft delete document
- [ ] `GET /api/npd/documents/:id/download` - Download (signed URL)
- [ ] `GET /api/npd/projects/:id/documents/validate` - Validate required docs

### Service Layer
- [ ] All NPDDocumentService methods
- [ ] File upload to Supabase Storage
- [ ] Signed URL generation
- [ ] File type and size validation
- [ ] Thumbnail generation

### Frontend
- [ ] Documents tab page
- [ ] Upload modal with drag-and-drop
- [ ] Document list with thumbnails
- [ ] Preview modal (PDF/image viewer)
- [ ] Download functionality
- [ ] Delete confirmation
- [ ] Required documents checklist

### Supabase Storage
- [ ] Create `npd-compliance-docs` bucket
- [ ] Configure bucket policies (private, 50 MB limit, allowed MIME types)
- [ ] Storage path organization

### Tests
- [ ] Unit tests: NPDDocumentService (>80% coverage)
- [ ] Integration tests: All API endpoints
- [ ] E2E: Full upload → preview → download → delete workflow
- [ ] File upload/download tests
- [ ] RLS tests: Org isolation
- [ ] Validation tests: Required documents check

---

## Definition of Done

### Database
- [ ] `npd_compliance_docs` table created
- [ ] RLS policies enforce org isolation
- [ ] Soft delete mechanism works (deleted_at)
- [ ] check_required_documents() function works

### API
- [ ] All 5 endpoints work correctly
- [ ] File upload (multipart) successful
- [ ] Signed URL generation works (1-hour expiry)
- [ ] Response times < 500ms
- [ ] RLS policies prevent cross-org access

### Service
- [ ] All service methods work
- [ ] File type/size validation accurate
- [ ] Thumbnail generation works (PDF/images)
- [ ] Soft delete logic correct

### Frontend
- [ ] Document upload modal works (drag-and-drop)
- [ ] Document list displays with thumbnails
- [ ] Preview modal works (PDF/image)
- [ ] Download functionality works
- [ ] Delete confirmation works
- [ ] Required docs checklist displays

### Supabase Storage
- [ ] Bucket created with correct policies
- [ ] Files upload successfully
- [ ] Signed URLs work
- [ ] CDN delivery functional

### Testing
- [ ] Unit tests: >80% coverage
- [ ] Integration tests: All endpoints
- [ ] E2E tests: Full workflow
- [ ] File upload/download verified

---

## Risk Assessment

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| File upload timeout | MEDIUM | MEDIUM | 50 MB limit, progress indicator, chunked upload |
| Storage costs | MEDIUM | LOW | Monitor usage, implement retention policy |
| Signed URL abuse | LOW | LOW | 1-hour expiry, rate limiting |
| File type spoofing | MEDIUM | LOW | MIME type validation, file header check |
| Thumbnail generation failure | LOW | MEDIUM | Graceful fallback to generic icon |

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-01-15 | Initial story creation for Compliance Documents Upload | ARCHITECT-AGENT |

---

**Document Status**: Ready for Implementation
**Created**: 2025-01-15
**Lines**: ~800
**Complexity**: M (Medium)
**Phase**: 1 (Core NPD)
