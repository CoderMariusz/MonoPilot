# API Context: 08.16 - Timeline View & Reporting
# 4 endpoints: timeline, CSV projects, CSV cost history, PDF compliance checklist

endpoints:
  - method: "GET"
    path: "/api/npd/timeline"
    description: "Fetch timeline data with filters"
    auth: true
    roles: ["NPD_LEAD", "R&D", "REGULATORY", "FINANCE", "PRODUCTION", "ADMIN"]
    request:
      query_params:
        - name: "gate"
          type: "string"
          required: false
          description: "Filter by gate (G1-G5)"
        - name: "category"
          type: "string"
          required: false
          description: "Filter by category"
        - name: "owner_id"
          type: "string (UUID)"
          required: false
          description: "Filter by owner"
        - name: "status"
          type: "string"
          required: false
          description: "Filter by status"
        - name: "date_from"
          type: "string (ISO date)"
          required: false
          description: "Show projects starting after date"
        - name: "date_to"
          type: "string (ISO date)"
          required: false
          description: "Show projects ending before date"
    response:
      success:
        status: 200
        body:
          projects:
            - id: 1
              project_number: "NPD-001"
              name: "Vegan Protein Bar"
              status: "development"
              current_gate: "G3"
              category: "Snack"
              owner_id: "uuid-123"
              owner_name: "Jane Doe"
              created_at: "2025-01-05T00:00:00Z"
              target_launch_date: "2025-06-15"
              is_overdue: false
              duration_days: 161
      errors:
        - status: 401
          message: "Unauthorized"
        - status: 403
          message: "Insufficient permissions"

  - method: "GET"
    path: "/api/npd/export/projects"
    description: "Export projects to CSV (respects filters)"
    auth: true
    roles: ["NPD_LEAD", "R&D", "REGULATORY", "FINANCE", "ADMIN"]
    request:
      query_params:
        - name: "gate"
          type: "string"
          required: false
        - name: "category"
          type: "string"
          required: false
        - name: "owner_id"
          type: "string"
          required: false
        - name: "status"
          type: "string"
          required: false
    response:
      success:
        status: 200
        content_type: "text/csv"
        headers:
          Content-Disposition: 'attachment; filename="NPD-Projects-2025-01-15.csv"'
        body: |
          project_number,name,status,current_gate,category,owner,created_at,target_launch_date,actual_launch_date
          NPD-001,Vegan Protein Bar,development,G3,Snack,Jane Doe,2025-01-05,2025-06-15,
          NPD-002,Gluten-Free Bread,feasibility,G2,Bakery,John Smith,2025-01-10,2025-07-01,
      errors:
        - status: 401
          message: "Unauthorized"

  - method: "GET"
    path: "/api/npd/export/cost-history"
    description: "Export cost history to CSV (all formulation versions)"
    auth: true
    roles: ["NPD_LEAD", "FINANCE", "ADMIN"]
    request:
      query_params:
        - name: "project_id"
          type: "integer"
          required: false
          description: "Optional: filter to single project"
    response:
      success:
        status: 200
        content_type: "text/csv"
        headers:
          Content-Disposition: 'attachment; filename="NPD-Cost-History-2025-01-15.csv"'
        body: |
          project_number,formulation_number,target_cost,estimated_cost,actual_cost,variance,variance_pct,created_at,approved_at,approved_by
          NPD-001,v1.0,10.00,10.50,10.80,0.80,8.00%,2025-01-05,2025-01-10,Jane Doe
          NPD-001,v2.0,10.00,11.20,11.50,1.50,15.00%,2025-01-12,2025-01-18,Jane Doe
      errors:
        - status: 401
          message: "Unauthorized"
        - status: 403
          message: "Finance role required for cost history export"

  - method: "POST"
    path: "/api/npd/export/compliance-checklist"
    description: "Generate compliance checklist PDF"
    auth: true
    roles: ["NPD_LEAD", "REGULATORY", "QUALITY_DIRECTOR", "ADMIN"]
    request:
      body:
        project_id: 1
    response:
      success:
        status: 200
        body:
          pdf_url: "https://storage.supabase.co/npd-exports/NPD-001-Compliance-Checklist-2025-01-15.pdf?signed=..."
          filename: "NPD-001-Compliance-Checklist-2025-01-15.pdf"
          generated_at: "2025-01-15T14:30:00Z"
      errors:
        - status: 400
          message: "Project ID required"
        - status: 404
          message: "Project not found"
        - status: 500
          message: "PDF generation failed"

service_methods:
  - name: "NPDTimelineService.getTimeline(filters)"
    description: "Fetch timeline data with filters"
    returns: "TimelineProject[]"
  - name: "NPDTimelineService.exportProjectsCSV(filters)"
    description: "Generate CSV string of projects"
    returns: "string (CSV)"
  - name: "NPDTimelineService.exportCostHistoryCSV(projectId?)"
    description: "Generate CSV string of cost history"
    returns: "string (CSV)"
  - name: "NPDTimelineService.exportComplianceChecklistPDF(projectId)"
    description: "Generate PDF and upload to Supabase Storage"
    returns: "{ url: string, filename: string }"
  - name: "NPDTimelineService.generateCSV(headers, rows)"
    description: "CSV utility function"
    returns: "string (CSV)"
  - name: "NPDTimelineService.generateCompliancePDF(project)"
    description: "Generate PDF using Puppeteer"
    returns: "Buffer"

validation:
  - field: "project_id"
    rules: ["required for PDF export", "must be integer", "must exist in npd_projects"]
  - field: "filters"
    rules: ["gate must be G1-G5", "dates must be ISO format"]

error_handling:
  - scenario: "PDF generation timeout"
    action: "Return 500 after 30 seconds, log error, retry via background job"
  - scenario: "CSV too large (>10MB)"
    action: "Limit to 10,000 rows, suggest filtered export"
  - scenario: "Project not found"
    action: "Return 404 with message"
