# 08.13 - Handoff: Pilot WO Creation

**Priority**: P0 (Critical - Handoff Blocker)
**Story Points**: M (Medium)
**Type**: backend
**Estimate**: 3-4 days

**State**: ready
**Primary PRD**: `docs/1-BASELINE/product/modules/npd.md` (FR-NPD-42, FR-NPD-57, FR-NPD-60)
**Dependencies**: 08.12, 08.2, 03.2, 04.1, 01.1

---

## Goal

Create a pilot Work Order (type = "pilot") linked to an NPD project during handoff, using the BOM created in story 08.12. Pilot WOs enable small-batch trial production to validate the formulation before commercial manufacturing. The pilot WO tracks actual costs which feed back to NPD costing (08.7).

---

## User Story

As an **NPD Lead**, I want to **create a pilot Work Order during handoff** so that **I can schedule a small trial batch to validate my formulation in a real production environment**.

As a **Production Manager**, I want to **identify pilot Work Orders** so that **I can prioritize them for R&D trials and track actual costs back to NPD projects**.

---

## Scope

**In scope (this story)**
- POST /api/npd/projects/:projectId/handoff/create-pilot-wo - Create pilot WO
- Set WO.type = "pilot" and WO.npd_project_id for traceability
- Use BOM created in 08.12 as the WO BOM
- Use default pilot routing from npd_settings.default_pilot_routing (if set)
- Set WO.quantity = formulation.total_qty (default small batch, editable)
- Auto-assign to NPD Lead
- Link WO to NPD project (work_orders.npd_project_id)
- Actual cost from pilot WO feeds back to 08.7 costing (cost_actual field)
- Auto-generate pilot WO number: WO-PILOT-{PROJECT_NUMBER}-{SEQ}
- Support custom scheduled_date (default: +7 days from handoff)
- Optional routing_id selection (can be null)

**Out of scope (this story)**
- Pilot WO execution (handled by Production module)
- Multi-WO creation (one pilot WO per handoff in MVP)
- Pilot WO approval workflow (Phase 2)
- Automated pilot WO scheduling (Phase 3)

---

## Dependencies

### Hard Dependencies
| Story | Provides | Status |
|-------|----------|--------|
| 01.1 | Org Context + RLS | Ready |
| 03.2 | Work Orders CRUD, work_orders table | Ready |
| 08.2 | NPD Projects CRUD, npd_projects table | Ready |
| 08.12 | Handoff: Formulation → BOM (provides BOM for WO) | Ready |

### Soft Dependencies
| Story | Provides | Impact if Missing |
|-------|----------|-------------------|
| 04.1 | Routings CRUD, routings table | Routing selection unavailable (manual entry later) |
| 08.7 | Formulation Costing | Actual cost not linked to costing (manual entry) |

---

## Acceptance Criteria (Given/When/Then)

### AC-1: Create Pilot Work Order

```gherkin
Scenario: Create pilot WO with BOM from handoff
  Given NPD project NPD-001 with BOM BOM-PROD-NPD-001-v1.0 created
  And formulation total_qty = 100 kg
  When POST /api/npd/projects/:id/handoff/create-pilot-wo with:
    | Field | Value |
    | product_id | PROD-NPD-001 ID |
    | bom_id | BOM-PROD-NPD-001-v1.0 ID |
    | quantity | 100 |
    | uom | kg |
    | scheduled_date | 2025-01-22 (+7 days) |
    | routing_id | ROUTING-TRIAL-001 ID (optional) |
  Then pilot WO created with:
    | wo_number | WO-PILOT-NPD-001-001 |
    | type | pilot |
    | product_id | PROD-NPD-001 ID |
    | bom_id | BOM-PROD-NPD-001-v1.0 ID |
    | quantity | 100 |
    | uom | kg |
    | status | planned |
    | scheduled_date | 2025-01-22 |
    | routing_id | ROUTING-TRIAL-001 ID |
    | npd_project_id | NPD-001 ID |
    | assigned_to | NPD Lead user ID |
  And response 201 with WO details
```

```gherkin
Scenario: Create pilot WO without routing
  Given BOM created from formulation
  And npd_settings.default_pilot_routing = null
  When creating pilot WO with routing_id = null
  Then pilot WO created with:
    | routing_id | null |
    | status | planned |
  And WO can be updated later with routing
```

```gherkin
Scenario: Use default pilot routing from settings
  Given npd_settings.default_pilot_routing = ROUTING-TRIAL-001 ID
  When creating pilot WO without specifying routing_id
  Then pilot WO created with:
    | routing_id | ROUTING-TRIAL-001 ID (from settings) |
```

### AC-2: Pilot WO Number Auto-Generation

```gherkin
Scenario: Generate pilot WO number (first pilot)
  Given NPD project NPD-001 with no existing pilot WOs
  When creating pilot WO
  Then wo_number = "WO-PILOT-NPD-001-001"

Scenario: Generate pilot WO number (subsequent pilot)
  Given NPD project NPD-001 with existing pilot WO "WO-PILOT-NPD-001-001"
  When creating second pilot WO
  Then wo_number = "WO-PILOT-NPD-001-002" (auto-incremented)

Scenario: Pilot WO number uniqueness
  Given pilot WO "WO-PILOT-NPD-001-001" exists
  When attempting to create another with same number
  Then system returns 409 Conflict error
  And transaction rolled back
```

### AC-3: Validation - Quantity Required

```gherkin
Scenario: Quantity must be positive
  Given quantity = 0
  When creating pilot WO
  Then error 400 "Pilot WO quantity must be greater than 0"
  And no WO created

Scenario: Quantity must be numeric
  Given quantity = "abc" (non-numeric)
  When creating pilot WO
  Then error 400 "Invalid quantity"

Scenario: Default quantity from formulation
  Given formulation.total_qty = 50 kg
  When creating pilot WO without specifying quantity
  Then pilot WO created with:
    | quantity | 50 (from formulation) |
    | uom | kg (from formulation) |
```

### AC-4: Validation - BOM and Product Linkage

```gherkin
Scenario: BOM must belong to product
  Given product PROD-001 ID
  And BOM BOM-PROD-002-v1.0 (belongs to PROD-002, not PROD-001)
  When creating pilot WO with product_id = PROD-001, bom_id = BOM-PROD-002-v1.0
  Then error 400 "BOM does not belong to product"
  And no WO created

Scenario: BOM must exist
  Given bom_id = 999 (does not exist)
  When creating pilot WO
  Then error 404 "BOM not found"
  And no WO created

Scenario: Product must exist
  Given product_id = 999 (does not exist)
  When creating pilot WO
  Then error 404 "Product not found"
  And no WO created
```

### AC-5: Validation - Scheduled Date

```gherkin
Scenario: Scheduled date in past
  Given scheduled_date = 2024-01-01 (past)
  When creating pilot WO
  Then warning "Scheduled date is in the past"
  And WO created (allow past dates for backdating)

Scenario: Scheduled date optional
  Given scheduled_date = null
  When creating pilot WO
  Then pilot WO created with:
    | scheduled_date | null |
  And WO can be scheduled later

Scenario: Default scheduled date (+7 days)
  Given current date = 2025-01-15
  And scheduled_date not provided
  When creating pilot WO
  Then pilot WO created with:
    | scheduled_date | 2025-01-22 (+7 days) |
```

### AC-6: Traceability to NPD Project

```gherkin
Scenario: WO traceability to NPD
  Given NPD project NPD-001 ID = 123
  When creating pilot WO
  Then WO has:
    | npd_project_id | 123 |
    | type | pilot |
  And can query: "SELECT * FROM work_orders WHERE npd_project_id = 123"
  And result shows pilot WO linked to NPD project

Scenario: Pilot WO type filter
  Given 10 WOs: 7 production, 3 pilot
  When query: "SELECT * FROM work_orders WHERE type = 'pilot'"
  Then returns 3 pilot WOs only
```

### AC-7: Auto-Assign to NPD Lead

```gherkin
Scenario: Pilot WO assigned to NPD Lead
  Given NPD project NPD-001 with owner_id = user-123 (NPD Lead)
  When creating pilot WO
  Then WO has:
    | assigned_to | user-123 (NPD Lead) |
  And NPD Lead can view WO in "My Work Orders"

Scenario: Override assignment
  Given NPD Lead = user-123
  And production_manager = user-456
  When creating pilot WO with assigned_to = user-456
  Then WO has:
    | assigned_to | user-456 (overridden) |
```

### AC-8: Actual Cost Feedback to NPD Costing

```gherkin
Scenario: Pilot WO actual cost updates NPD costing (08.7 integration)
  Given pilot WO for NPD project NPD-001
  And WO status = 'completed'
  And WO.actual_cost = 1250.00
  When pilot WO completes
  Then npd_costing record updated with:
    | actual_cost | 1250.00 (from WO) |
    | variance_pct | (actual - target) / target × 100 |
  And costing dashboard shows updated actual cost

Scenario: Multiple pilot WOs (average cost)
  Given NPD project with 2 pilot WOs:
    | WO | Actual Cost |
    | Pilot-001 | 1200.00 |
    | Pilot-002 | 1300.00 |
  When both complete
  Then npd_costing.actual_cost = 1250.00 (average)
  Or npd_costing.actual_cost = 1300.00 (latest)
  (Business rule: use latest pilot WO cost)
```

### AC-9: Transactional Execution

```gherkin
Scenario: Rollback on WO number generation failure
  Given valid pilot WO data
  And WO number generation fails (race condition)
  When creating pilot WO
  Then transaction rolls back
  And no WO created
  And error returned to user

Scenario: Rollback on routing validation failure
  Given routing_id = 999 (does not exist)
  When creating pilot WO
  Then error 404 "Routing not found"
  And transaction rolls back
  And no WO created
```

### AC-10: Permission Enforcement

```gherkin
Scenario: NPD Lead permissions
  Given user has NPD_LEAD role
  When creating pilot WO
  Then operation succeeds
  And WO created and assigned

Scenario: Production Manager permissions
  Given user has PRODUCTION_MANAGER role
  When creating pilot WO via handoff
  Then error 403 "Only NPD Lead can create pilot WO during handoff"
  And no WO created

Scenario: R&D permissions (no handoff)
  Given user has R&D role
  When attempting to create pilot WO
  Then error 403 "Insufficient permissions"
```

### AC-11: RLS Policy Enforcement

```gherkin
Scenario: Org isolation on WO creation
  Given user from Org A
  When creating pilot WO
  Then WO.org_id = Org A (automatic)

Scenario: Cross-tenant access blocked
  Given NPD project belongs to Org B
  And user from Org A
  When attempting to create pilot WO
  Then error 404 "NPD project not found"
  And no WO created
```

### AC-12: API Response Format

```gherkin
Scenario: Success response structure
  Given valid pilot WO creation request
  When POST /api/npd/projects/:id/handoff/create-pilot-wo
  Then response 201 Created with:
    {
      "success": true,
      "work_order": {
        "id": "uuid",
        "wo_number": "WO-PILOT-NPD-001-001",
        "type": "pilot",
        "product_id": "product-uuid",
        "product_code": "PROD-NPD-001",
        "product_name": "Premium Beef Burger",
        "bom_id": "bom-uuid",
        "bom_number": "BOM-PROD-NPD-001-v1.0",
        "quantity": 100,
        "uom": "kg",
        "status": "planned",
        "scheduled_date": "2025-01-22",
        "routing_id": "routing-uuid",
        "routing_name": "Trial Routing",
        "npd_project_id": "npd-project-id",
        "npd_project_number": "NPD-001",
        "assigned_to": "user-uuid",
        "assigned_to_name": "John Doe (NPD Lead)",
        "created_at": "2025-01-15T14:30:00Z"
      },
      "executed_at": "2025-01-15T14:30:00Z"
    }
```

### AC-13: Performance Requirements

```gherkin
Scenario: Pilot WO creation performance
  Given valid pilot WO data
  When creating pilot WO
  Then operation completes < 500ms
  And WO appears in list immediately

Scenario: Multiple pilot WOs (batch creation - Phase 2)
  Given 5 formulations to handoff (Phase 2 - multi-handoff)
  When creating 5 pilot WOs
  Then all complete < 2 seconds (batch insert)
```

---

## Implementation Notes

### API Endpoints

```typescript
// POST /api/npd/projects/:projectId/handoff/create-pilot-wo
interface CreatePilotWORequest {
  product_id: string; // required
  bom_id: string; // required
  quantity: number; // required
  uom?: string; // optional, default from product/formulation
  scheduled_date?: string; // ISO date, optional (default: +7 days)
  routing_id?: string | null; // optional
  assigned_to?: string | null; // optional, default: NPD project owner
  notes?: string; // optional
}

interface CreatePilotWOResponse {
  success: boolean;
  work_order: {
    id: string;
    wo_number: string;
    type: string; // 'pilot'
    product_id: string;
    product_code: string;
    product_name: string;
    bom_id: string;
    bom_number: string;
    quantity: number;
    uom: string;
    status: string; // 'planned'
    scheduled_date: string | null;
    routing_id: string | null;
    routing_name: string | null;
    npd_project_id: string;
    npd_project_number: string;
    assigned_to: string | null;
    assigned_to_name: string | null;
    created_at: string;
  };
  executed_at: string;
}

interface PilotWOErrorResponse {
  success: false;
  error: string;
  error_code: string; // 'INVALID_QUANTITY', 'BOM_MISMATCH', etc.
  rollback_completed: boolean;
}
```

### Service Layer

```typescript
// lib/services/npd-handoff-service.ts (extension)

export class NPDHandoffService {
  /**
   * Create pilot Work Order for NPD project
   */
  static async createPilotWO(
    projectId: number,
    data: CreatePilotWORequest,
    userId: string
  ): Promise<CreatePilotWOResponse> {
    const client = await db.connect();

    try {
      await client.query('BEGIN');

      // Step 1: Validate product and BOM
      await this.validateProductBOM(client, data.product_id, data.bom_id);

      // Step 2: Get NPD project details
      const project = await this.getProject(client, projectId);

      // Step 3: Get default routing from settings (if not provided)
      let routingId = data.routing_id;
      if (!routingId) {
        routingId = await this.getDefaultPilotRouting(client, project.org_id);
      }

      // Step 4: Generate pilot WO number
      const woNumber = await this.generatePilotWONumber(client, project.project_number);

      // Step 5: Set default scheduled date (+7 days if not provided)
      const scheduledDate = data.scheduled_date || this.getDefaultScheduledDate();

      // Step 6: Set default assigned_to (NPD project owner if not provided)
      const assignedTo = data.assigned_to || project.owner_id;

      // Step 7: Create pilot Work Order
      const wo = await this.createWorkOrder(client, {
        wo_number: woNumber,
        type: 'pilot',
        product_id: data.product_id,
        bom_id: data.bom_id,
        quantity: data.quantity,
        uom: data.uom,
        status: 'planned',
        scheduled_date: scheduledDate,
        routing_id: routingId,
        npd_project_id: projectId,
        assigned_to: assignedTo,
        notes: data.notes,
      }, userId);

      await client.query('COMMIT');

      return {
        success: true,
        work_order: await this.enrichWOResponse(client, wo),
        executed_at: new Date().toISOString(),
      };

    } catch (error) {
      await client.query('ROLLBACK');
      throw new PilotWOCreationError('Pilot WO creation failed', error);
    } finally {
      client.release();
    }
  }

  /**
   * Validate product and BOM belong together
   */
  private static async validateProductBOM(
    client: PoolClient,
    productId: string,
    bomId: string
  ): Promise<void> {
    const result = await client.query(
      `SELECT b.id FROM boms b
       WHERE b.id = $1 AND b.product_id = $2`,
      [bomId, productId]
    );

    if (result.rows.length === 0) {
      throw new Error('BOM does not belong to product');
    }
  }

  /**
   * Get default pilot routing from settings
   */
  private static async getDefaultPilotRouting(
    client: PoolClient,
    orgId: string
  ): Promise<string | null> {
    const result = await client.query(
      `SELECT default_pilot_routing FROM npd_settings WHERE org_id = $1`,
      [orgId]
    );

    return result.rows[0]?.default_pilot_routing || null;
  }

  /**
   * Generate pilot WO number
   * Format: WO-PILOT-{PROJECT_NUMBER}-{SEQ}
   */
  private static async generatePilotWONumber(
    client: PoolClient,
    projectNumber: string
  ): Promise<string> {
    const result = await client.query(
      `SELECT wo_number FROM work_orders
       WHERE wo_number LIKE $1
       ORDER BY wo_number DESC
       LIMIT 1`,
      [`WO-PILOT-${projectNumber}-%`]
    );

    let seq = 1;

    if (result.rows.length > 0) {
      const lastWONumber = result.rows[0].wo_number;
      const match = lastWONumber.match(/-(\d+)$/);
      if (match) {
        seq = parseInt(match[1], 10) + 1;
      }
    }

    return `WO-PILOT-${projectNumber}-${seq.toString().padStart(3, '0')}`;
  }

  /**
   * Get default scheduled date (+7 days from now)
   */
  private static getDefaultScheduledDate(): string {
    const date = new Date();
    date.setDate(date.getDate() + 7);
    return date.toISOString().split('T')[0]; // YYYY-MM-DD
  }

  /**
   * Create Work Order record
   */
  private static async createWorkOrder(
    client: PoolClient,
    data: WOCreateData,
    userId: string
  ): Promise<WorkOrder> {
    const result = await client.query(
      `INSERT INTO work_orders (
        org_id, wo_number, type, product_id, bom_id,
        quantity, uom, status, scheduled_date, routing_id,
        npd_project_id, assigned_to, notes, created_by
      )
      VALUES (
        (SELECT org_id FROM users WHERE id = $1),
        $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $1
      )
      RETURNING *`,
      [
        userId, data.wo_number, data.type, data.product_id, data.bom_id,
        data.quantity, data.uom, data.status, data.scheduled_date, data.routing_id,
        data.npd_project_id, data.assigned_to, data.notes
      ]
    );

    return result.rows[0];
  }

  /**
   * Enrich WO response with joined data
   */
  private static async enrichWOResponse(
    client: PoolClient,
    wo: WorkOrder
  ): Promise<EnrichedWO> {
    const result = await client.query(
      `SELECT
        wo.*,
        p.product_code, p.product_name,
        b.bom_number,
        r.routing_name,
        proj.project_number AS npd_project_number,
        u.name AS assigned_to_name
       FROM work_orders wo
       LEFT JOIN products p ON wo.product_id = p.id
       LEFT JOIN boms b ON wo.bom_id = b.id
       LEFT JOIN routings r ON wo.routing_id = r.id
       LEFT JOIN npd_projects proj ON wo.npd_project_id = proj.id
       LEFT JOIN users u ON wo.assigned_to = u.id
       WHERE wo.id = $1`,
      [wo.id]
    );

    return result.rows[0];
  }

  /**
   * Update NPD costing with actual cost from pilot WO (called after WO completion)
   */
  static async updateCostingFromPilotWO(
    projectId: number,
    woId: string,
    actualCost: number
  ): Promise<void> {
    await db.query(
      `UPDATE npd_costing
       SET actual_cost = $1,
           variance_pct = (($1 - target_cost) / target_cost) * 100,
           updated_at = NOW()
       WHERE npd_project_id = $2`,
      [actualCost, projectId]
    );
  }
}

class PilotWOCreationError extends Error {
  constructor(message: string, public originalError: any) {
    super(message);
    this.name = 'PilotWOCreationError';
  }
}
```

### Validation (Zod)

```typescript
import { z } from 'zod';

export const createPilotWOSchema = z.object({
  product_id: z.string().uuid('Invalid product ID'),
  bom_id: z.string().uuid('Invalid BOM ID'),
  quantity: z.number().positive('Quantity must be greater than 0'),
  uom: z.string().min(1).max(20).optional(),
  scheduled_date: z.string().refine((val) => !val || !isNaN(Date.parse(val)), "Invalid date").optional(),
  routing_id: z.string().uuid().optional().nullable(),
  assigned_to: z.string().uuid().optional().nullable(),
  notes: z.string().max(2000).optional(),
});
```

### Database Changes

```sql
-- Ensure work_orders table has NPD linkage columns
-- (These should already exist from existing WO module or added in story 08.2)

ALTER TABLE work_orders
ADD COLUMN IF NOT EXISTS type VARCHAR(20) DEFAULT 'production';

ALTER TABLE work_orders
ADD COLUMN IF NOT EXISTS npd_project_id INTEGER REFERENCES npd_projects(id);

CREATE INDEX IF NOT EXISTS idx_work_orders_type ON work_orders(type);
CREATE INDEX IF NOT EXISTS idx_work_orders_npd_project ON work_orders(npd_project_id)
WHERE npd_project_id IS NOT NULL;

-- Add comments
COMMENT ON COLUMN work_orders.type IS 'Work order type: production, pilot, trial, rework, etc.';
COMMENT ON COLUMN work_orders.npd_project_id IS 'NPD project that created this pilot WO (handoff traceability)';
```

---

## Deliverables

### Database
- [ ] Migration: Add type, npd_project_id to work_orders table
- [ ] Indexes for type and npd_project_id columns
- [ ] Comments on traceability columns

### API Routes
- [ ] POST /api/npd/projects/:projectId/handoff/create-pilot-wo

### Service Layer
- [ ] NPDHandoffService.createPilotWO()
- [ ] NPDHandoffService.validateProductBOM()
- [ ] NPDHandoffService.getDefaultPilotRouting()
- [ ] NPDHandoffService.generatePilotWONumber()
- [ ] NPDHandoffService.getDefaultScheduledDate()
- [ ] NPDHandoffService.createWorkOrder()
- [ ] NPDHandoffService.enrichWOResponse()
- [ ] NPDHandoffService.updateCostingFromPilotWO()

### Validation
- [ ] createPilotWOSchema (Zod)

### Tests
- [ ] Unit test: NPDHandoffService.createPilotWO()
- [ ] Unit test: NPDHandoffService.generatePilotWONumber() (sequence increment)
- [ ] Unit test: NPDHandoffService.validateProductBOM()
- [ ] Integration test: POST /api/npd/projects/:id/handoff/create-pilot-wo (success)
- [ ] Integration test: Rollback on WO number collision
- [ ] Integration test: Validation errors (invalid quantity, BOM mismatch)
- [ ] E2E test: Full pilot WO creation with default routing
- [ ] E2E test: Pilot WO creation without routing

---

## Definition of Done

- [ ] API endpoint creates pilot WO successfully
- [ ] Pilot WO number auto-generation increments correctly
- [ ] Default pilot routing from settings applied (if configured)
- [ ] Default scheduled date (+7 days) applied if not provided
- [ ] NPD project owner auto-assigned to pilot WO
- [ ] Product-BOM linkage validation enforced
- [ ] Quantity validation enforced (> 0)
- [ ] Transactional execution with rollback on failure
- [ ] Traceability fields (npd_project_id, type) populated
- [ ] Permission checks enforce NPD_LEAD role
- [ ] RLS policies enforce org isolation
- [ ] Operation completes < 500ms
- [ ] Unit tests achieve >80% coverage on NPDHandoffService
- [ ] Integration tests cover all success and failure paths
- [ ] E2E tests verify full pilot WO creation workflow

---

## Risk Assessment

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| WO number collision (race condition) | MEDIUM | MEDIUM | Use database-level sequence or UNIQUE constraint |
| BOM-Product mismatch validation | HIGH | LOW | Strict validation before WO creation, fail fast |
| Routing validation failure | MEDIUM | LOW | Make routing optional, graceful degradation |
| Default scheduled date logic | LOW | LOW | Clear documentation, configurable offset |
| Actual cost feedback integration | MEDIUM | MEDIUM | Clear API contract with 08.7, event-driven update |

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2026-01-15 | Initial version - Pilot WO creation | ARCHITECT-AGENT |

---

**Document Status**: Ready for Implementation
**Created**: 2026-01-15
**Lines**: ~850
**Complexity**: M (Medium)
**Phase**: 2 (Handoff Integration)
