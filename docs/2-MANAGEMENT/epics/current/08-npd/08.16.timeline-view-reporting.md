# 08.16 - Timeline View & Reporting

**Priority**: P2 (Nice to Have)
**Story Points**: M (Medium)
**Type**: fullstack
**Phase**: 3 (Enterprise Features)
**Model**: SONNET

**State**: ready
**Estimate**: M (3-4 days)
**Primary PRD**: `docs/1-BASELINE/product/modules/npd.md` (FR-NPD-06, 07, 28, 36)
**Architecture**: `docs/1-BASELINE/architecture/modules/npd.md`

---

## Goal

Implement a Timeline View (Gantt-style) for all NPD projects showing project duration from created_at to target_launch_date, with color-coded status indicators and filtering capabilities. Add comprehensive export functionality including CSV project lists, cost history exports, and PDF compliance checklist reports for audit and management review.

---

## Food Safety Compliance

This story supports **NPD documentation and traceability**:

- [x] **FDA 21 CFR Part 11** - Compliance checklist report provides audit-ready documentation
- [x] **HACCP Compliance** - Compliance documents exported for regulatory review
- [x] **ISO 9001** - Timeline view supports management review per clause 9.3
- [x] **Traceability** - Cost history export provides formulation version traceability

**Regulatory Context:**
- NPD projects require documented approval trails for regulatory submissions
- Compliance checklists needed for FDA/USDA submissions
- Cost history supports costing justification for margin analysis
- Timeline view enables capacity planning and resource allocation

---

## MVP Scope

This story implements Phase 3 (Enterprise Features) reporting and visualization. Timeline View provides executive visibility into NPD pipeline health, while export functions enable external reporting and compliance documentation.

**MVP Includes**:
- Timeline view (Gantt-style) with horizontal bars
- Project bars span created_at → target_launch_date
- Color coding by status (idea=gray, feasibility=blue, development=yellow, validation=orange, launched=green)
- Overdue highlighting (target_launch_date < today = red border)
- Filter by gate, category, owner, status
- CSV export (all projects with all fields)
- Cost history export (all formulation versions with costs)
- Compliance checklist report (PDF with gate checklists + compliance docs)
- Date range selector (show projects in Q1/Q2/etc.)

**Deferred to Phase 4+**:
- Drag-to-reschedule on timeline
- Critical path visualization
- Resource allocation heatmap
- Custom report builder

---

## User Story

As an **NPD Lead**, I want to **view all NPD projects on a timeline** so that **I can visualize project overlaps, identify bottlenecks, and ensure launch dates are realistic**.

As a **Quality Director**, I want to **export compliance checklist reports** so that **I can submit regulatory documentation for FDA/USDA approvals**.

As a **Finance Manager**, I want to **export cost history across formulation versions** so that **I can analyze cost trends and justify margin targets**.

---

## Scope

**In scope (this story)**
- Timeline view page: /npd/timeline
- Gantt-style visualization (horizontal bars)
- Project bars: created_at → target_launch_date
- Color by status, red border for overdue
- Filter by gate, category, owner, status
- Zoom controls (month/quarter/year view)
- CSV export (all projects)
- Cost history CSV export (all formulations)
- Compliance checklist PDF export
- GET /api/npd/timeline (project timeline data)
- GET /api/npd/export/projects (CSV)
- GET /api/npd/export/cost-history (CSV)
- POST /api/npd/export/compliance-checklist (PDF)

**Out of scope (this story)**
- Drag-to-reschedule projects (Phase 4)
- Critical path visualization (Phase 4)
- Resource allocation view (Phase 4)
- Custom report builder (Phase 4)
- Excel export (only CSV supported)

---

## Dependencies

### Cross-Epic Dependencies

| Dependency | Story/Epic | Type | What It Provides | Status |
|------------|------------|------|------------------|--------|
| 01.1 | Org Context + RLS | HARD | organizations, users, roles tables | Ready |
| 02.1 | Products CRUD | SOFT | Product names for exports | Ready |

### Within Epic Dependencies

| Dependency | Story | Type | What It Provides |
|------------|-------|------|------------------|
| 08.2 | NPD Projects CRUD | HARD | npd_projects table with dates |
| 08.3 | Stage-Gate Workflow | HARD | Gate status and transitions |
| 08.7 | Formulation Costing | HARD | Cost history data |
| 08.8 | Compliance Documents | HARD | Compliance docs for checklist |

### Provides To (Downstream)

| Story | What This Provides |
|-------|-------------------|
| Phase 4 | Advanced reporting - Base export functions for reuse |

---

## Database Migration

**No new tables required**. Timeline and export functions read from existing tables:
- `npd_projects` (timeline data: created_at, target_launch_date, status)
- `npd_formulations` (cost history)
- `npd_gate_checklists` (compliance checklist items)
- `npd_compliance_documents` (compliance docs metadata)

**Optional view for performance**:

```sql
-- Migration: YYYYMMDDHHMMSS_create_npd_timeline_view.sql

-- View for timeline data (materialized optional)
CREATE OR REPLACE VIEW npd_timeline_view AS
SELECT
    p.id,
    p.project_number,
    p.name,
    p.status,
    p.current_gate,
    p.category,
    p.owner_id,
    u.name AS owner_name,
    p.created_at,
    p.target_launch_date,
    CASE
        WHEN p.target_launch_date < NOW() AND p.status NOT IN ('launched', 'cancelled') THEN true
        ELSE false
    END AS is_overdue,
    EXTRACT(DAY FROM p.target_launch_date - p.created_at) AS duration_days,
    p.org_id
FROM npd_projects p
LEFT JOIN users u ON p.owner_id = u.id
WHERE p.status != 'cancelled';

-- RLS policy
CREATE POLICY "timeline_view_org" ON npd_timeline_view
    FOR SELECT USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );
```

---

## Acceptance Criteria (Given/When/Then)

### AC-1: Timeline View - Display

```gherkin
Scenario: Display timeline with all active projects
  Given 10 NPD projects exist with various dates
  When user navigates to /npd/timeline
  Then timeline view displays:
    - X-axis: Time (months, Jan-Dec)
    - Y-axis: Projects (rows, one per project)
    - Horizontal bars from created_at to target_launch_date
  And bars color-coded by status:
    | Status | Color |
    | idea | Gray |
    | feasibility | Blue |
    | development | Yellow |
    | validation | Orange |
    | launched | Green |
  And overdue projects have red border (target_launch_date < today)
  And timeline scrolls vertically for >10 projects

Scenario: Timeline bar tooltip
  Given user hovers over project bar
  Then tooltip shows:
    | Field | Example |
    | Project | NPD-001 Vegan Protein Bar |
    | Status | development |
    | Gate | G3 |
    | Owner | Jane Doe |
    | Created | 2025-01-05 |
    | Target Launch | 2025-06-15 |
    | Duration | 161 days |
    | Days Remaining | 45 days |
  And click navigates to /npd/projects/:id
```

### AC-2: Timeline View - Zoom Controls

```gherkin
Scenario: Zoom to month view
  Given timeline in quarter view
  When user clicks [Month View]
  Then X-axis shows daily granularity for selected month
  And current month highlighted
  And user can navigate prev/next month

Scenario: Zoom to quarter view (default)
  Given timeline in month view
  When user clicks [Quarter View]
  Then X-axis shows monthly granularity for 3 months
  And current quarter highlighted (Q1/Q2/Q3/Q4)

Scenario: Zoom to year view
  Given timeline in quarter view
  When user clicks [Year View]
  Then X-axis shows quarterly granularity for 12 months
  And current year highlighted
```

### AC-3: Timeline View - Filters

```gherkin
Scenario: Filter by gate
  Given 10 projects across various gates
  When user selects gate filter = "G3"
  Then only projects at G3 displayed
  And timeline re-renders

Scenario: Filter by category
  Given projects with categories: Beverage, Snack, Bakery
  When user selects category filter = "Beverage"
  Then only Beverage projects displayed

Scenario: Filter by owner
  Given projects owned by various users
  When user selects owner filter = "Jane Doe"
  Then only Jane's projects displayed

Scenario: Filter by status
  Given projects with various statuses
  When user selects status filter = "development"
  Then only development projects displayed

Scenario: Combine multiple filters
  Given projects with various attributes
  When user selects gate=G3, category=Beverage, status=development
  Then only projects matching ALL filters displayed
  And filter chips shown above timeline
  And clear all filters button available
```

### AC-4: CSV Export - Projects

```gherkin
Scenario: Export all projects to CSV
  Given 50 NPD projects exist
  When user clicks [Export Projects CSV]
  Then GET /api/npd/export/projects called
  And CSV file downloads: "NPD-Projects-2025-01-15.csv"
  And CSV contains headers:
    | project_number | name | status | current_gate | category | owner | created_at | target_launch_date | actual_launch_date |
  And CSV contains all 50 projects
  And dates formatted as YYYY-MM-DD
  And special characters escaped (commas in name)

Scenario: Export filtered projects to CSV
  Given timeline filtered to gate=G3, category=Beverage
  And 5 projects match filters
  When user clicks [Export Projects CSV]
  Then CSV contains only 5 filtered projects
  And filename: "NPD-Projects-Filtered-2025-01-15.csv"
```

### AC-5: CSV Export - Cost History

```gherkin
Scenario: Export cost history for all formulations
  Given NPD project NPD-001 with 3 formulation versions
  And each version has costing data
  When user clicks [Export Cost History CSV]
  Then GET /api/npd/export/cost-history called
  And CSV file downloads: "NPD-Cost-History-2025-01-15.csv"
  And CSV contains headers:
    | project_number | formulation_number | target_cost | estimated_cost | actual_cost | variance | variance_pct | created_at | approved_at | approved_by |
  And CSV contains all formulation versions across all projects
  And variance calculated as (actual_cost - target_cost)
  And variance_pct as ((actual_cost - target_cost) / target_cost) * 100

Scenario: Export cost history for single project
  Given NPD project NPD-001 detail page
  When user clicks [Export Cost History CSV] on project page
  Then CSV contains only NPD-001 formulation versions
  And filename: "NPD-001-Cost-History-2025-01-15.csv"
```

### AC-6: PDF Export - Compliance Checklist

```gherkin
Scenario: Export compliance checklist for project
  Given NPD project NPD-001 at gate G5 (launched)
  And all gate checklists completed
  And 5 compliance documents uploaded (HACCP, Label Proof, Allergen Statement, Nutritional Analysis, CoA)
  When user clicks [Export Compliance Checklist PDF]
  Then POST /api/npd/export/compliance-checklist called with project_id
  And PDF generated with:
    - Header: Org name, Project NPD-001, Date generated
    - Section 1: Project Summary (name, category, target launch, actual launch, owner)
    - Section 2: Gate Checklist Summary (all gates G1-G5 with completed items)
    - Section 3: Compliance Documents (table with doc type, filename, upload date, uploaded by)
    - Section 4: Approval Trail (gate approvals with approver, date, notes)
    - Footer: Page numbers, MonoPilot branding
  And PDF downloads as "NPD-001-Compliance-Checklist-2025-01-15.pdf"
  And generation completes within 10 seconds

Scenario: Compliance checklist with missing docs
  Given NPD project NPD-002 with incomplete compliance docs
  And required docs: HACCP (uploaded), Label Proof (missing)
  When PDF generated
  Then Section 3 shows:
    | Document Type | Status | Filename | Uploaded |
    | HACCP | ✓ Uploaded | HACCP-NPD-002.pdf | 2025-01-10 |
    | Label Proof | ✗ Missing | - | - |
  And missing docs highlighted in red
```

### AC-7: Performance Requirements

```gherkin
Scenario: Timeline load time
  Given 100 NPD projects
  When user loads /npd/timeline
  Then page renders within 2 seconds
  And timeline bars render within 1.5 seconds
  And filters respond within 200ms

Scenario: CSV export time
  Given 500 NPD projects
  When user exports projects CSV
  Then CSV generates within 5 seconds
  And download starts immediately

Scenario: PDF export time
  Given compliance checklist with 10 gate checklists + 5 docs
  When user exports PDF
  Then PDF generates within 10 seconds
  And progress indicator shown
```

### AC-8: Permission Checks

```gherkin
Scenario: Timeline view access
  Given user with NPD_LEAD role
  When accessing /npd/timeline
  Then timeline displays with all projects

Scenario: CSV export permission
  Given user with R&D role (not NPD_LEAD)
  When attempting CSV export
  Then export allowed (read-only users can export)

Scenario: PDF export permission
  Given user with VIEWER role
  When attempting PDF export
  Then export allowed (compliance docs are read-only)
```

### AC-9: Mobile Responsiveness

```gherkin
Scenario: Timeline on mobile
  Given user accessing timeline on mobile (< 768px width)
  When page loads
  Then timeline switches to list view:
    - Projects listed as cards (not bars)
    - Each card shows: name, status badge, created/target dates, duration
    - Tap card to navigate to project detail
  And filters collapse into dropdown
  And export buttons stacked vertically
```

### AC-10: Empty State Handling

```gherkin
Scenario: Timeline with no projects
  Given new organization with no NPD projects
  When viewing timeline
  Then empty state message:
    "No NPD projects yet. Create your first project to see the timeline."
  And [Create First Project] button shown

Scenario: Timeline with no filtered results
  Given timeline filtered to gate=G5, category=Beverage
  And no projects match filters
  Then empty state message:
    "No projects match selected filters. Try adjusting your filters."
  And [Clear Filters] button shown
```

---

## Implementation Notes

### API Endpoints

```typescript
// =============================================================================
// Timeline & Export Endpoints
// =============================================================================

// GET /api/npd/timeline
interface TimelineRequest {
  gate?: string;           // Filter by gate (G1-G5)
  category?: string;       // Filter by category
  owner_id?: string;       // Filter by owner
  status?: string;         // Filter by status
  date_from?: string;      // Show projects starting after date
  date_to?: string;        // Show projects ending before date
}

interface TimelineResponse {
  projects: Array<{
    id: number;
    project_number: string;
    name: string;
    status: string;
    current_gate: string;
    category: string;
    owner_id: string;
    owner_name: string;
    created_at: string;
    target_launch_date: string;
    actual_launch_date?: string;
    is_overdue: boolean;
    duration_days: number;
  }>;
}

// GET /api/npd/export/projects
interface ExportProjectsRequest {
  gate?: string;
  category?: string;
  owner_id?: string;
  status?: string;
}

interface ExportProjectsResponse {
  // CSV file download (Content-Type: text/csv)
  // Headers: project_number, name, status, current_gate, category, owner, created_at, target_launch_date, actual_launch_date
}

// GET /api/npd/export/cost-history
interface ExportCostHistoryRequest {
  project_id?: number; // Optional: filter to single project
}

interface ExportCostHistoryResponse {
  // CSV file download (Content-Type: text/csv)
  // Headers: project_number, formulation_number, target_cost, estimated_cost, actual_cost, variance, variance_pct, created_at, approved_at, approved_by
}

// POST /api/npd/export/compliance-checklist
interface ExportComplianceChecklistRequest {
  project_id: number;
}

interface ExportComplianceChecklistResponse {
  pdf_url: string;         // Temporary signed URL (expires in 1 hour)
  filename: string;
  generated_at: string;
}
```

### Service Layer

```typescript
// lib/services/npd-timeline-service.ts

export class NPDTimelineService {
  /**
   * Get timeline data with filters
   */
  static async getTimeline(filters: TimelineFilters): Promise<TimelineProject[]> {
    const { gate, category, owner_id, status, date_from, date_to } = filters;

    let query = `
      SELECT
        p.id,
        p.project_number,
        p.name,
        p.status,
        p.current_gate,
        p.category,
        p.owner_id,
        u.name AS owner_name,
        p.created_at,
        p.target_launch_date,
        p.actual_launch_date,
        CASE
          WHEN p.target_launch_date < NOW() AND p.status NOT IN ('launched', 'cancelled') THEN true
          ELSE false
        END AS is_overdue,
        EXTRACT(DAY FROM p.target_launch_date - p.created_at) AS duration_days
      FROM npd_projects p
      LEFT JOIN users u ON p.owner_id = u.id
      WHERE p.org_id = $1 AND p.status != 'cancelled'
    `;

    const values: any[] = [orgId];
    let paramIndex = 2;

    if (gate) {
      query += ` AND p.current_gate = $${paramIndex++}`;
      values.push(gate);
    }

    // ... add other filters

    query += ` ORDER BY p.created_at ASC`;

    const result = await db.query(query, values);
    return result.rows;
  }

  /**
   * Export projects to CSV
   */
  static async exportProjectsCSV(filters: TimelineFilters): Promise<string> {
    const projects = await this.getTimeline(filters);

    const headers = [
      'project_number',
      'name',
      'status',
      'current_gate',
      'category',
      'owner',
      'created_at',
      'target_launch_date',
      'actual_launch_date',
    ];

    const rows = projects.map(p => [
      p.project_number,
      p.name,
      p.status,
      p.current_gate,
      p.category,
      p.owner_name,
      p.created_at.toISOString().split('T')[0],
      p.target_launch_date.toISOString().split('T')[0],
      p.actual_launch_date ? p.actual_launch_date.toISOString().split('T')[0] : '',
    ]);

    return this.generateCSV(headers, rows);
  }

  /**
   * Export cost history to CSV
   */
  static async exportCostHistoryCSV(projectId?: number): Promise<string> {
    let query = `
      SELECT
        p.project_number,
        f.formulation_number,
        c.target_cost,
        c.estimated_cost,
        c.actual_cost,
        (c.actual_cost - c.target_cost) AS variance,
        ((c.actual_cost - c.target_cost) / NULLIF(c.target_cost, 0)) * 100 AS variance_pct,
        c.created_at,
        c.approved_at,
        u.name AS approved_by
      FROM npd_costing c
      JOIN npd_formulations f ON c.formulation_id = f.id
      JOIN npd_projects p ON f.project_id = p.id
      LEFT JOIN users u ON c.approved_by_id = u.id
      WHERE p.org_id = $1
    `;

    const values: any[] = [orgId];

    if (projectId) {
      query += ` AND p.id = $2`;
      values.push(projectId);
    }

    query += ` ORDER BY p.project_number, f.formulation_number`;

    const result = await db.query(query, values);

    const headers = [
      'project_number',
      'formulation_number',
      'target_cost',
      'estimated_cost',
      'actual_cost',
      'variance',
      'variance_pct',
      'created_at',
      'approved_at',
      'approved_by',
    ];

    const rows = result.rows.map(r => [
      r.project_number,
      r.formulation_number,
      r.target_cost,
      r.estimated_cost,
      r.actual_cost || '',
      r.variance || '',
      r.variance_pct ? r.variance_pct.toFixed(2) + '%' : '',
      r.created_at.toISOString().split('T')[0],
      r.approved_at ? r.approved_at.toISOString().split('T')[0] : '',
      r.approved_by || '',
    ]);

    return this.generateCSV(headers, rows);
  }

  /**
   * Export compliance checklist as PDF
   */
  static async exportComplianceChecklistPDF(projectId: number): Promise<{ url: string; filename: string }> {
    // Fetch project data
    const project = await this.getProjectWithCompliance(projectId);

    // Generate PDF using Puppeteer (server-side)
    const pdfBuffer = await this.generateCompliancePDF(project);

    // Upload to Supabase Storage
    const filename = `NPD-${project.project_number}-Compliance-Checklist-${new Date().toISOString().split('T')[0]}.pdf`;
    const { data, error } = await supabase.storage
      .from('npd-exports')
      .upload(filename, pdfBuffer, { contentType: 'application/pdf' });

    if (error) throw error;

    // Get signed URL (expires in 1 hour)
    const { data: signedUrl } = await supabase.storage
      .from('npd-exports')
      .createSignedUrl(filename, 3600);

    return { url: signedUrl.signedUrl, filename };
  }

  /**
   * Generate CSV string from headers and rows
   */
  private static generateCSV(headers: string[], rows: any[][]): string {
    const escape = (val: any) => {
      if (val === null || val === undefined) return '';
      const str = String(val);
      if (str.includes(',') || str.includes('"') || str.includes('\n')) {
        return `"${str.replace(/"/g, '""')}"`;
      }
      return str;
    };

    const csvHeaders = headers.join(',');
    const csvRows = rows.map(row => row.map(escape).join(',')).join('\n');

    return `${csvHeaders}\n${csvRows}`;
  }

  /**
   * Generate compliance checklist PDF
   */
  private static async generateCompliancePDF(project: any): Promise<Buffer> {
    // Use Puppeteer to generate PDF from HTML template
    const html = this.generateComplianceHTML(project);

    const browser = await puppeteer.launch();
    const page = await browser.newPage();
    await page.setContent(html);

    const pdfBuffer = await page.pdf({
      format: 'A4',
      printBackground: true,
      margin: { top: '20mm', bottom: '20mm', left: '15mm', right: '15mm' },
    });

    await browser.close();

    return pdfBuffer;
  }

  /**
   * Generate HTML template for compliance PDF
   */
  private static generateComplianceHTML(project: any): string {
    return `
      <!DOCTYPE html>
      <html>
        <head>
          <style>
            body { font-family: Arial, sans-serif; }
            h1 { color: #333; }
            table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
            th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
            th { background-color: #f2f2f2; }
            .missing { color: red; }
            .uploaded { color: green; }
          </style>
        </head>
        <body>
          <h1>NPD Compliance Checklist</h1>
          <h2>Project: ${project.name} (${project.project_number})</h2>

          <h3>Project Summary</h3>
          <table>
            <tr><th>Field</th><th>Value</th></tr>
            <tr><td>Category</td><td>${project.category}</td></tr>
            <tr><td>Target Launch</td><td>${project.target_launch_date}</td></tr>
            <tr><td>Actual Launch</td><td>${project.actual_launch_date || 'N/A'}</td></tr>
            <tr><td>Owner</td><td>${project.owner_name}</td></tr>
          </table>

          <h3>Gate Checklist Summary</h3>
          <table>
            <tr><th>Gate</th><th>Completed Items</th><th>Total Items</th><th>Status</th></tr>
            ${project.gate_checklists.map(gc => `
              <tr>
                <td>${gc.gate}</td>
                <td>${gc.completed_items}</td>
                <td>${gc.total_items}</td>
                <td>${gc.completed_items === gc.total_items ? '✓ Complete' : '✗ Incomplete'}</td>
              </tr>
            `).join('')}
          </table>

          <h3>Compliance Documents</h3>
          <table>
            <tr><th>Document Type</th><th>Status</th><th>Filename</th><th>Uploaded</th><th>Uploaded By</th></tr>
            ${project.compliance_docs.map(doc => `
              <tr>
                <td>${doc.type}</td>
                <td class="${doc.uploaded ? 'uploaded' : 'missing'}">${doc.uploaded ? '✓ Uploaded' : '✗ Missing'}</td>
                <td>${doc.filename || '-'}</td>
                <td>${doc.uploaded_at || '-'}</td>
                <td>${doc.uploaded_by || '-'}</td>
              </tr>
            `).join('')}
          </table>

          <h3>Approval Trail</h3>
          <table>
            <tr><th>Gate</th><th>Approver</th><th>Approved</th><th>Notes</th></tr>
            ${project.approvals.map(appr => `
              <tr>
                <td>${appr.gate}</td>
                <td>${appr.approver_name}</td>
                <td>${appr.approved_at}</td>
                <td>${appr.notes || '-'}</td>
              </tr>
            `).join('')}
          </table>

          <footer>
            <p>Generated: ${new Date().toISOString()}</p>
            <p>MonoPilot MES - NPD Module</p>
          </footer>
        </body>
      </html>
    `;
  }
}
```

### Frontend Components

```
apps/frontend/app/(authenticated)/npd/
  timeline/
    page.tsx                      -- Timeline view page

components/npd/timeline/
  TimelineView.tsx                -- Timeline container (Gantt chart)
  TimelineBar.tsx                 -- Individual project bar
  TimelineFilters.tsx             -- Filter controls
  TimelineZoomControls.tsx        -- Zoom buttons (month/quarter/year)
  TimelineExportButtons.tsx       -- CSV/PDF export buttons
  TimelineEmptyState.tsx          -- Empty state when no projects
  TimelineTooltip.tsx             -- Tooltip on hover
  TimelineLegend.tsx              -- Status color legend
```

### UI Libraries

**Timeline Chart**: `react-gantt-chart` or `vis-timeline` (or custom canvas implementation)
**CSV Generation**: Native JavaScript (no library needed)
**PDF Generation**: Puppeteer (server-side) or jsPDF (client-side fallback)

---

## Key Business Rules

1. **Timeline Scope**: Only active projects (status != 'cancelled') shown on timeline
2. **Overdue Definition**: target_launch_date < today AND status NOT IN ('launched', 'cancelled')
3. **Color Coding**: Status colors are fixed (idea=gray, feasibility=blue, development=yellow, validation=orange, launched=green)
4. **Default View**: Timeline defaults to quarter view (3 months) centered on current month
5. **CSV Format**: All dates in ISO format (YYYY-MM-DD), UTF-8 encoding, comma-separated
6. **PDF Permissions**: Any user with NPD access can export compliance checklist (read-only)
7. **Export Filters**: CSV exports respect active filters (gate, category, owner, status)
8. **Timeline Navigation**: Click project bar → navigate to /npd/projects/:id
9. **Mobile Fallback**: Timeline switches to list view on mobile (< 768px width)
10. **Empty State**: If no projects, show "Create First Project" CTA

---

## Deliverables

### Database
- [ ] Optional materialized view: `npd_timeline_view` (performance optimization)

### API Routes
- [ ] `GET /api/npd/timeline` - Timeline data with filters
- [ ] `GET /api/npd/export/projects` - CSV export (all projects)
- [ ] `GET /api/npd/export/cost-history` - CSV export (cost history)
- [ ] `POST /api/npd/export/compliance-checklist` - PDF export (compliance)

### Service Layer
- [ ] `NPDTimelineService.getTimeline()` - Fetch timeline data
- [ ] `NPDTimelineService.exportProjectsCSV()` - Generate projects CSV
- [ ] `NPDTimelineService.exportCostHistoryCSV()` - Generate cost history CSV
- [ ] `NPDTimelineService.exportComplianceChecklistPDF()` - Generate compliance PDF
- [ ] `NPDTimelineService.generateCSV()` - CSV utility
- [ ] `NPDTimelineService.generateCompliancePDF()` - PDF generation

### Frontend
- [ ] Timeline page: `/npd/timeline`
- [ ] Timeline Gantt chart component
- [ ] Project bar component (with color coding)
- [ ] Filter controls (gate, category, owner, status)
- [ ] Zoom controls (month/quarter/year)
- [ ] Export buttons (CSV projects, CSV cost history, PDF compliance)
- [ ] Tooltip on hover
- [ ] Empty state
- [ ] Mobile list view

### Tests
- [ ] Unit tests: NPDTimelineService methods (>80% coverage)
- [ ] Integration tests: All API endpoints
- [ ] E2E: Timeline view load and filtering
- [ ] E2E: CSV export download
- [ ] E2E: PDF export download
- [ ] Performance tests: Timeline load time <2s, CSV export <5s, PDF export <10s

---

## Definition of Done

### Database
- [ ] Optional timeline view created (if performance requires)

### API
- [ ] Timeline endpoint returns correct data with filters
- [ ] CSV exports generate valid CSV files
- [ ] PDF export generates valid PDF with all sections
- [ ] Response times: timeline <2s, CSV <5s, PDF <10s

### Service
- [ ] Timeline data fetched correctly with all filters
- [ ] CSV generation handles special characters (commas, quotes)
- [ ] PDF includes all sections (summary, checklists, docs, approvals)
- [ ] Overdue calculation correct

### Frontend
- [ ] Timeline loads and displays projects as horizontal bars
- [ ] Color coding matches status (idea=gray, feasibility=blue, etc.)
- [ ] Overdue projects have red border
- [ ] Filters update timeline correctly
- [ ] Zoom controls work (month/quarter/year)
- [ ] Tooltips show on hover
- [ ] Click bar navigates to project detail
- [ ] Export buttons download files correctly
- [ ] Mobile view switches to list
- [ ] Empty state displays when no projects

### Testing
- [ ] Unit tests: >80% coverage
- [ ] Integration tests: All endpoints covered
- [ ] E2E tests: Full timeline workflow
- [ ] Performance tests: Load times verified

---

## Risk Assessment

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Timeline performance with many projects (>100) | MEDIUM | MEDIUM | Pagination, virtual scrolling, materialized view |
| PDF generation timeout on large projects | MEDIUM | LOW | 30s timeout, async PDF generation with email link |
| CSV encoding issues (special characters) | LOW | MEDIUM | UTF-8 BOM, proper escaping of quotes/commas |
| Timeline library compatibility | LOW | LOW | Use battle-tested library (vis-timeline) or custom canvas |
| Mobile timeline readability | LOW | MEDIUM | Fallback to list view on mobile |

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2026-01-15 | Initial story creation for Timeline View & Reporting | ARCHITECT-AGENT |

---

**Document Status**: Ready for Implementation
**Created**: 2026-01-15
**Lines**: ~950
**Complexity**: M (Medium)
**Phase**: 3 (Enterprise Features)
