# 08.3 - Stage-Gate Workflow

**Story ID:** 08.3
**Epic:** 08 - NPD
**Phase:** 1 (MVP)
**Complexity:** L (Large)
**Estimate:** 5-6 days
**Type:** Fullstack (backend + frontend)
**State:** ready

**Primary PRD:** `docs/1-BASELINE/product/modules/npd.md` (Section 2.3-2.4, FR-NPD-03, 17-21)
**Architecture:** TBD - `docs/1-BASELINE/architecture/modules/npd.md`
**UX Wireframes:** TBD - `docs/3-ARCHITECTURE/ux/wireframes/NPD-003-*`

## PRD References

| FR ID | Requirement | Priority | Phase | Covered |
|-------|-------------|----------|-------|---------|
| NPD-FR-03 | Enforce gate entry criteria | Must | 1 | Yes |
| NPD-FR-17 | Display gate checklists | Must | 1 | Yes |
| NPD-FR-18 | Mark checklist items complete | Must | 1 | Yes |
| NPD-FR-19 | Support gate approvals | Must | 1 | Yes |
| NPD-FR-20 | Block advancement for incomplete items | Must | 1 | Yes |
| NPD-FR-21 | Log approvals | Must | 1 | Yes |

---

## User Story

**As a** NPD Lead,
**I want** to manage NPD project lifecycle through Stage-Gate workflow with proper approvals,
**So that** product development follows structured methodology and meets quality/compliance requirements before launch.

**As a** NPD Project Manager,
**I want** to see clear gate progress and validation requirements,
**So that** I know what tasks are blocking advancement and can address them proactively.

**As a** Director,
**I want** to approve critical gates (G3+) with clear justification,
**So that** high-risk decisions have executive oversight before proceeding.

---

## Goal

Implement a **complete Stage-Gate Workflow State Machine** for NPD projects. This provides:

- **Full workflow gates**: G0 (Idea) → G1 (Feasibility) → G2 (Business Case) → G3 (Development) → G4 (Testing) → Launched
- **Gate transition validation**: Cannot skip gates, proper sequence enforcement
- **Gate checklists**: Default checklists per gate with completion tracking
- **Entry criteria validation**: Must complete required checklist items before advancing
- **Approval workflow**: NPD Lead → QA Manager → Director for G3+ gates
- **Approval history**: Immutable audit trail via `npd_gate_transitions` table
- **Reopen capability**: Can move back to previous gate with justification
- **Notification triggers**: Alert stakeholders on gate transitions

---

## Food Safety / Compliance Context

This story is **important for regulatory compliance**:

- [x] **Stage-Gate Best Practice** - Structured product development methodology
- [x] **HACCP Compliance** - Ensure safety plans completed before launch
- [x] **FDA 21 CFR Part 11** - Immutable audit trail for gate approvals
- [x] **ISO 9001** - Quality management system documentation

**Regulatory Context:**
- G4 gate requires HACCP plan approval before handoff
- Allergen validation must complete before G4
- Label approval required for commercial launch
- All gate approvals must be signed and timestamped
- Audit trail retained for regulatory inspection

---

## Scope

**In scope (this story)**
- Extend `npd_projects.current_gate` with full gate states
- Create `npd_gate_checklists` table (default checklists per org)
- Create `npd_project_checklist_completion` table (completion tracking)
- Create `npd_gate_transitions` table (immutable audit trail)
- Add workflow fields to `npd_projects` (gate_entered_at, approver_id)
- Gate transition validation (cannot skip gates)
- POST /api/npd/projects/:id/advance-gate (state change endpoint)
- GET /api/npd/projects/:id/checklist (get checklist for current gate)
- POST /api/npd/projects/:id/checklist/:itemId/complete (mark item complete)
- GET /api/npd/projects/:id/gate-history (gate transition history)
- Permission-based gate approvals (NPD Lead vs Director)
- Checklist completion tracking
- Gate timeline component (horizontal stepper)
- Gate transition modal (with notes + approval)

**Out of scope (this story)**
- Formulation approval workflow (story 08.5)
- Costing approval workflow (story 08.6)
- Compliance document validation (story 08.7)
- Handoff wizard (story 08.8)
- Email notification sending (future - Notifications module)
- Custom checklist admin UI (future - Phase 3)

---

## Stage-Gate States

### Gate Definitions

| Gate | Code | Description | Entry Criteria | Approver |
|------|------|-------------|----------------|----------|
| Idea | `G0` | Initial concept, problem statement | None (entry point) | NPD Lead |
| Feasibility | `G1` | Technical & resource feasibility | G0 checklist complete | NPD Lead |
| Business Case | `G2` | Financial & market validation | G1 approval + feasibility confirmed | NPD Lead + Finance |
| Development | `G3` | Product formulation & testing | G2 approval + business case approved | QA Manager + Director |
| Testing | `G4` | Compliance & final validation | G3 approval + formulation locked | QA Manager + Director |
| Launched | `launched` | Commercial production | G4 approval + compliance complete | Director |

### Gate Transitions

```
G0 (Idea) ----[approve_g0]----> G1 (Feasibility)
G1 (Feasibility) ----[approve_g1]----> G2 (Business Case)
G2 (Business Case) ----[approve_g2]----> G3 (Development)
G3 (Development) ----[approve_g3]----> G4 (Testing)
G4 (Testing) ----[approve_g4]----> Launched
Any Gate ----[move_back]----> Previous Gate (with justification)
```

### Gate Approval Authorization

| Transition | From | To | Allowed Roles | Requires Approval |
|------------|------|-----|---------------|-------------------|
| approve_g0 | G0 | G1 | NPD_LEAD, ADMIN | No |
| approve_g1 | G1 | G2 | NPD_LEAD, ADMIN | No |
| approve_g2 | G2 | G3 | NPD_LEAD, FINANCE, ADMIN | Yes |
| approve_g3 | G3 | G4 | QA_MANAGER, DIRECTOR, ADMIN | Yes (Director) |
| approve_g4 | G4 | launched | QA_MANAGER, DIRECTOR, ADMIN | Yes (Director) |
| move_back | Any | Previous | NPD_LEAD, DIRECTOR, ADMIN | Yes (justification) |

---

## Dependencies

### Cross-Epic Dependencies

| Dependency | Story/Epic | Type | What It Provides | Status |
|------------|------------|------|------------------|--------|
| 01.1 | Org Context + RLS | HARD | organizations, users, roles tables | Ready |
| 01.6 | Role Permissions | HARD | Role-based access control | Ready |
| 08.1 | NPD Projects CRUD | HARD | npd_projects table | Ready |

### Within Epic Dependencies

| Dependency | Story | Type | What It Provides |
|------------|-------|------|------------------|
| 08.1 | NPD Projects CRUD | HARD | npd_projects table with basic status |

### Provides To (Downstream)

| Story | What This Provides |
|-------|-------------------|
| 08.5 | Formulation Management - gate progression logic |
| 08.6 | Costing & Approvals - G2/G3 approval gates |
| 08.7 | Compliance Documents - G4 validation |
| 08.8 | Handoff Wizard - launched gate requirement |

---

## Database Migration

### Migration 1: Extend npd_projects with gate tracking

```sql
-- Migration: YYYYMMDDHHMMSS_extend_npd_projects_workflow.sql

-- =============================================================================
-- Extend npd_projects with full Stage-Gate workflow (Story 08.3)
-- =============================================================================

-- Step 1: Drop old constraint if exists
ALTER TABLE npd_projects DROP CONSTRAINT IF EXISTS npd_projects_current_gate_check;

-- Step 2: Add new constraint with all gates
ALTER TABLE npd_projects
ADD CONSTRAINT npd_projects_current_gate_check
CHECK (current_gate IN ('G0', 'G1', 'G2', 'G3', 'G4', 'launched', 'cancelled'));

-- Step 3: Add workflow tracking columns
ALTER TABLE npd_projects
ADD COLUMN IF NOT EXISTS gate_entered_at TIMESTAMPTZ DEFAULT now(),
ADD COLUMN IF NOT EXISTS approved_by UUID REFERENCES users(id),
ADD COLUMN IF NOT EXISTS approved_at TIMESTAMPTZ,
ADD COLUMN IF NOT EXISTS move_back_count INTEGER DEFAULT 0,
ADD COLUMN IF NOT EXISTS last_moved_back_at TIMESTAMPTZ,
ADD COLUMN IF NOT EXISTS last_moved_back_by UUID REFERENCES users(id),
ADD COLUMN IF NOT EXISTS move_back_reason TEXT;

-- Step 4: Create indexes for workflow queries
CREATE INDEX IF NOT EXISTS idx_npd_projects_gate ON npd_projects(org_id, current_gate)
    WHERE current_gate != 'cancelled';
CREATE INDEX IF NOT EXISTS idx_npd_projects_approver ON npd_projects(approved_by)
    WHERE approved_by IS NOT NULL;

-- Comments
COMMENT ON COLUMN npd_projects.current_gate IS 'Current Stage-Gate: G0, G1, G2, G3, G4, launched, cancelled';
COMMENT ON COLUMN npd_projects.gate_entered_at IS 'Timestamp when entered current gate';
COMMENT ON COLUMN npd_projects.approved_by IS 'User who approved current gate';
COMMENT ON COLUMN npd_projects.approved_at IS 'Timestamp of gate approval';
COMMENT ON COLUMN npd_projects.move_back_count IS 'Number of times project has moved back';
```

### Migration 2: Create npd_gate_checklists table

```sql
-- Migration: YYYYMMDDHHMMSS_create_npd_gate_checklists.sql

-- =============================================================================
-- NPD Gate Checklists (Default Checklists per Org)
-- =============================================================================

CREATE TABLE npd_gate_checklists (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,

    -- Gate & checklist
    gate TEXT NOT NULL CHECK (gate IN ('G0', 'G1', 'G2', 'G3', 'G4')),
    item_description TEXT NOT NULL,
    is_required BOOLEAN DEFAULT true,
    sequence INTEGER DEFAULT 0, -- Display order

    -- Display
    category TEXT, -- e.g., "Technical", "Compliance", "Business"

    -- Status
    is_active BOOLEAN DEFAULT true,

    -- Audit
    created_at TIMESTAMPTZ DEFAULT now(),
    updated_at TIMESTAMPTZ DEFAULT now(),

    -- Constraints
    UNIQUE(org_id, gate, item_description)
);

-- Index for checklist lookups
CREATE INDEX idx_npd_checklists_lookup ON npd_gate_checklists(org_id, gate, is_active)
    WHERE is_active = true;

-- RLS
ALTER TABLE npd_gate_checklists ENABLE ROW LEVEL SECURITY;

CREATE POLICY "npd_checklists_select" ON npd_gate_checklists
    FOR SELECT USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

CREATE POLICY "npd_checklists_admin" ON npd_gate_checklists
    FOR ALL USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
        AND (SELECT r.code FROM roles r JOIN users u ON u.role_id = r.id WHERE u.id = auth.uid()) IN ('SUPER_ADMIN', 'ADMIN')
    );

-- =============================================================================
-- Seed Default Checklists (per org)
-- =============================================================================

-- Function to seed default checklists for an org
CREATE OR REPLACE FUNCTION seed_npd_gate_checklists(p_org_id UUID)
RETURNS void AS $$
BEGIN
    INSERT INTO npd_gate_checklists (org_id, gate, item_description, is_required, category, sequence)
    VALUES
        -- G0: Idea (3 items)
        (p_org_id, 'G0', 'Initial concept documented', true, 'Technical', 1),
        (p_org_id, 'G0', 'Target market identified', true, 'Business', 2),
        (p_org_id, 'G0', 'Preliminary resource estimate', false, 'Business', 3),

        -- G1: Feasibility (4 items)
        (p_org_id, 'G1', 'Technical feasibility confirmed', true, 'Technical', 1),
        (p_org_id, 'G1', 'Key ingredients identified', true, 'Technical', 2),
        (p_org_id, 'G1', 'Initial allergen assessment', true, 'Compliance', 3),
        (p_org_id, 'G1', 'Rough cost estimate', false, 'Business', 4),

        -- G2: Business Case (5 items)
        (p_org_id, 'G2', 'Business case documented', true, 'Business', 1),
        (p_org_id, 'G2', 'Target cost approved by Finance', true, 'Business', 2),
        (p_org_id, 'G2', 'Target margin confirmed', true, 'Business', 3),
        (p_org_id, 'G2', 'Resource plan approved', true, 'Business', 4),
        (p_org_id, 'G2', 'Market research completed', false, 'Business', 5),

        -- G3: Development (6 items)
        (p_org_id, 'G3', 'Formulation created and locked', true, 'Technical', 1),
        (p_org_id, 'G3', 'Trial batches executed', true, 'Technical', 2),
        (p_org_id, 'G3', 'Allergen declaration validated', true, 'Compliance', 3),
        (p_org_id, 'G3', 'Sensory evaluation passed', true, 'Technical', 4),
        (p_org_id, 'G3', 'Packaging design approved', false, 'Business', 5),
        (p_org_id, 'G3', 'Supplier agreements in place', false, 'Business', 6),

        -- G4: Testing (7 items)
        (p_org_id, 'G4', 'Shelf-life testing complete', true, 'Compliance', 1),
        (p_org_id, 'G4', 'HACCP plan approved', true, 'Compliance', 2),
        (p_org_id, 'G4', 'Label proof approved', true, 'Compliance', 3),
        (p_org_id, 'G4', 'Compliance documents uploaded', true, 'Compliance', 4),
        (p_org_id, 'G4', 'Costing approved by Finance', true, 'Business', 5),
        (p_org_id, 'G4', 'Production routing defined', true, 'Technical', 6),
        (p_org_id, 'G4', 'Marketing materials ready', false, 'Business', 7)
    ON CONFLICT (org_id, gate, item_description) DO NOTHING;
END;
$$ LANGUAGE plpgsql;

COMMENT ON TABLE npd_gate_checklists IS 'Default gate checklists per organization';
```

### Migration 3: Create npd_project_checklist_completion table

```sql
-- Migration: YYYYMMDDHHMMSS_create_npd_checklist_completion.sql

-- =============================================================================
-- NPD Project Checklist Completion (Track which items completed per project)
-- =============================================================================

CREATE TABLE npd_project_checklist_completion (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    project_id UUID NOT NULL REFERENCES npd_projects(id) ON DELETE CASCADE,
    checklist_id UUID NOT NULL REFERENCES npd_gate_checklists(id) ON DELETE CASCADE,

    -- Completion
    is_completed BOOLEAN DEFAULT false,
    completed_by UUID REFERENCES users(id),
    completed_at TIMESTAMPTZ,

    -- Notes
    completion_notes TEXT,
    attachment_url TEXT, -- Supporting document (Supabase Storage path)

    -- Audit
    created_at TIMESTAMPTZ DEFAULT now(),
    updated_at TIMESTAMPTZ DEFAULT now(),

    -- Constraints
    UNIQUE(project_id, checklist_id)
);

-- Indexes
CREATE INDEX idx_npd_completion_project ON npd_project_checklist_completion(project_id, is_completed);
CREATE INDEX idx_npd_completion_user ON npd_project_checklist_completion(completed_by, completed_at DESC);

-- RLS
ALTER TABLE npd_project_checklist_completion ENABLE ROW LEVEL SECURITY;

CREATE POLICY "npd_completion_select" ON npd_project_checklist_completion
    FOR SELECT USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

CREATE POLICY "npd_completion_insert" ON npd_project_checklist_completion
    FOR INSERT WITH CHECK (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

CREATE POLICY "npd_completion_update" ON npd_project_checklist_completion
    FOR UPDATE USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

COMMENT ON TABLE npd_project_checklist_completion IS 'Checklist item completion tracking per NPD project';
```

### Migration 4: Create npd_gate_transitions audit table

```sql
-- Migration: YYYYMMDDHHMMSS_create_npd_gate_transitions.sql

-- =============================================================================
-- NPD Gate Transitions (Immutable Audit Trail)
-- =============================================================================

CREATE TABLE npd_gate_transitions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    project_id UUID NOT NULL REFERENCES npd_projects(id) ON DELETE CASCADE,

    -- Transition
    from_gate TEXT NOT NULL,
    to_gate TEXT NOT NULL,
    transition_type TEXT NOT NULL CHECK (transition_type IN ('advance', 'move_back', 'cancel')),

    -- Actor
    transitioned_by UUID NOT NULL REFERENCES users(id),
    transitioned_at TIMESTAMPTZ NOT NULL DEFAULT now(),

    -- Approval (for G2+)
    requires_approval BOOLEAN DEFAULT false,
    approved_by UUID REFERENCES users(id),
    approved_at TIMESTAMPTZ,
    approval_notes TEXT,

    -- Notes
    transition_notes TEXT,

    -- Metadata
    checklist_completion_pct DECIMAL(5,2), -- % of required items completed
    blocking_items INTEGER, -- Count of required items incomplete

    -- Immutable (no updated_at - records never change)
    created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- Index for history queries
CREATE INDEX idx_npd_transitions_project ON npd_gate_transitions(project_id, transitioned_at DESC);
CREATE INDEX idx_npd_transitions_org ON npd_gate_transitions(org_id, transitioned_at DESC);
CREATE INDEX idx_npd_transitions_user ON npd_gate_transitions(transitioned_by, transitioned_at DESC);

-- RLS
ALTER TABLE npd_gate_transitions ENABLE ROW LEVEL SECURITY;

CREATE POLICY "npd_transitions_select" ON npd_gate_transitions
    FOR SELECT USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

-- INSERT only (no UPDATE or DELETE - immutable audit trail)
CREATE POLICY "npd_transitions_insert" ON npd_gate_transitions
    FOR INSERT WITH CHECK (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
    );

-- Explicitly deny UPDATE and DELETE
CREATE POLICY "npd_transitions_no_update" ON npd_gate_transitions
    FOR UPDATE USING (false);

CREATE POLICY "npd_transitions_no_delete" ON npd_gate_transitions
    FOR DELETE USING (false);

COMMENT ON TABLE npd_gate_transitions IS 'Immutable audit trail for NPD gate transitions (FDA 21 CFR Part 11)';
```

---

## Acceptance Criteria (Given/When/Then)

### AC-1: Gate Transition Validation

```gherkin
Scenario: Valid gate transition (G0 -> G1)
  Given NPD project exists with current_gate = 'G0'
  And all G0 required checklist items are complete
  When user with NPD_LEAD role executes advance_gate
  Then project current_gate changes to 'G1'
  And gate_entered_at = now()
  And transition recorded in npd_gate_transitions

Scenario: Invalid gate transition (skip gate)
  Given NPD project with current_gate = 'G1'
  When user attempts to advance to 'G3' (skipping G2)
  Then transition rejected with error "Cannot skip gates: must advance sequentially"
  And current_gate remains 'G1'

Scenario: Block advancement for incomplete required items
  Given NPD project with current_gate = 'G0'
  And 2 of 3 required G0 checklist items complete
  When user attempts advance_gate
  Then transition rejected with error "Cannot advance: 1 required checklist item incomplete"
  And current_gate remains 'G0'
```

### AC-2: Permission-Based Gate Approvals

```gherkin
Scenario: NPD Lead can approve G0 and G1
  Given NPD project with current_gate = 'G0'
  And user has role NPD_LEAD
  And all G0 checklist complete
  When user executes advance_gate
  Then transition succeeds to G1

Scenario: G3 requires Director approval
  Given NPD project with current_gate = 'G2'
  And user has role NPD_LEAD
  When user attempts advance to G3
  Then transition rejected with error "G3 requires Director approval"

Scenario: Director approves G3 transition
  Given NPD project with current_gate = 'G2'
  And user has role DIRECTOR
  And all G2 checklist complete
  When user executes advance_gate with approval notes
  Then transition succeeds to G3
  And approved_by = director user
  And approved_at = now()
```

### AC-3: Checklist Item Completion

```gherkin
Scenario: Mark checklist item complete
  Given NPD project in G0
  And checklist item "Initial concept documented"
  When user marks item complete with notes
  Then npd_project_checklist_completion record created
  And is_completed = true
  And completed_by = current user
  And completed_at = now()

Scenario: Completion percentage calculation
  Given NPD project in G1 with 4 checklist items
  And 2 items are required, 2 are optional
  And 1 required item complete, 1 optional complete
  When viewing project detail
  Then checklist shows "50% required items complete (1/2)"
  And shows "50% overall complete (2/4)"

Scenario: Attach document to checklist item
  Given checklist item "HACCP plan approved"
  When user marks complete and uploads document
  Then attachment_url stored in completion record
  And document accessible from checklist view
```

### AC-4: Gate Entry Criteria Validation

```gherkin
Scenario: Validate G0 entry (no prerequisites)
  Given new NPD project created
  Then current_gate = 'G0'
  And can immediately start working on G0 checklist

Scenario: Validate G2 entry criteria
  Given NPD project in G1
  When validating advance to G2
  Then system checks:
    - All G1 required items complete
    - NPD_LEAD approval recorded
    - Feasibility confirmed in notes

Scenario: Validate G4 entry criteria
  Given NPD project in G3
  When validating advance to G4
  Then system checks:
    - All G3 required items complete
    - Director approval recorded
    - Formulation locked (from story 08.5)
    - Trial batches completed
```

### AC-5: Move Back Logic

```gherkin
Scenario: Move back to previous gate
  Given NPD project with current_gate = 'G3'
  And user is DIRECTOR
  When user executes move_back to 'G2'
  And provides justification (min 50 chars)
  Then current_gate = 'G2'
  And move_back_count incremented
  And last_moved_back_at = now()
  And last_moved_back_by = current user
  And move_back_reason stored

Scenario: Move back requires justification
  Given NPD project in G3
  When user attempts move_back without notes
  Then error "Move back reason required (minimum 50 characters)"

Scenario: Only Director can move back from G3+
  Given NPD project in G4
  And user is NPD_LEAD
  When user attempts move_back
  Then 403 Forbidden returned
```

### AC-6: Gate History Audit Trail

```gherkin
Scenario: History record created on transition
  Given NPD project transitions from 'G1' to 'G2'
  Then npd_gate_transitions record created with:
    | Field | Value |
    | project_id | project UUID |
    | from_gate | G1 |
    | to_gate | G2 |
    | transition_type | advance |
    | transitioned_by | current user |
    | transitioned_at | now() |
    | checklist_completion_pct | 100.00 |

Scenario: History is immutable
  Given npd_gate_transitions record exists
  When attempting to UPDATE or DELETE
  Then operation rejected (RLS policy)
  And record remains unchanged

Scenario: History includes checklist metadata
  Given gate transition with 3/5 required items complete
  Then npd_gate_transitions.checklist_completion_pct = 60.00
  And blocking_items = 2
```

### AC-7: Gate Timeline UI

```gherkin
Scenario: Timeline displays gate progress
  Given NPD project in 'G3' gate
  When viewing project detail page
  Then horizontal timeline stepper shows:
    | Gate | Status |
    | G0 | completed (green check) |
    | G1 | completed (green check) |
    | G2 | completed (green check) |
    | G3 | current (highlighted) |
    | G4 | pending (gray) |
    | Launched | pending (gray) |

Scenario: Timeline shows timestamps
  Given NPD project has gate history
  When viewing timeline
  Then each completed gate shows:
    - Gate name
    - Completion date
    - Who approved
    - Days spent in gate

Scenario: Timeline shows blocking items
  Given NPD project in G2 with 1 required item incomplete
  When viewing timeline
  Then G2 gate shows warning indicator
  And tooltip "1 required item incomplete - cannot advance"
```

### AC-8: Gate Transition Modal

```gherkin
Scenario: Transition modal opens
  Given NPD project in G1 with all required items complete
  When user clicks "Advance to G2" button
  Then modal opens with:
    - Title: "Advance to G2: Business Case"
    - Current gate -> New gate display
    - Checklist completion summary
    - Notes textarea (optional for G0-G1)
    - [Cancel] button
    - [Advance to G2] button

Scenario: Approval required for G3+
  Given NPD project in G2
  When modal displays for G3 advance
  Then approval section shown
  And "Requires Director approval" warning
  And approval notes required (min 50 chars)

Scenario: Validation warnings in modal
  Given NPD project in G0
  And 1 required checklist item incomplete
  When user clicks advance button
  Then modal shows validation error
  And "Cannot advance: Initial concept documented - incomplete"
  And [Advance] button disabled
```

### AC-9: Default Checklist Seeding

```gherkin
Scenario: Seed default checklists on org creation
  Given new organization created
  When seed_npd_gate_checklists(org_id) called
  Then npd_gate_checklists populated with:
    - G0: 3 items (all required)
    - G1: 4 items (3 required, 1 optional)
    - G2: 5 items (4 required, 1 optional)
    - G3: 6 items (4 required, 2 optional)
    - G4: 7 items (6 required, 1 optional)

Scenario: Checklist items have categories
  Given default G4 checklist
  Then items grouped by category:
    - Compliance: 4 items
    - Business: 2 items
    - Technical: 1 item
```

### AC-10: API Endpoints

```gherkin
Scenario: POST /api/npd/projects/:id/advance-gate
  Given NPD project in G1
  And all G1 checklist complete
  When POST with body: { notes: "Feasibility confirmed" }
  Then 200 OK returned
  And response includes updated project with current_gate = 'G2'
  And gate_entered_at updated

Scenario: GET /api/npd/projects/:id/checklist
  Given NPD project in G2
  When GET checklist
  Then returns G2 checklist items with completion status
  And each item includes:
    | Field | Present |
    | id | Yes |
    | item_description | Yes |
    | is_required | Yes |
    | category | Yes |
    | is_completed | Yes |
    | completed_by_name | Yes (if complete) |
    | completed_at | Yes (if complete) |

Scenario: POST /api/npd/projects/:id/checklist/:itemId/complete
  Given checklist item exists
  When POST with body: { notes: "Completed", attachment_url: "..." }
  Then item marked complete
  And completion record created
  And 200 OK returned

Scenario: GET /api/npd/projects/:id/gate-history
  Given NPD project has transitioned 3 times
  When GET gate-history
  Then returns array of 3 transition records
  And ordered by transitioned_at DESC (newest first)
```

### AC-11: RLS Enforcement

```gherkin
Scenario: Cross-tenant checklist isolation
  Given User A from Org A
  And NPD project belongs to Org B
  When User A requests GET /api/npd/projects/:id/checklist
  Then 404 Not Found returned

Scenario: Checklist completion isolation
  Given Org A has NPD project
  And Org B has same checklist template
  When User A completes checklist item
  Then completion only visible to Org A
  And Org B sees their own completion records
```

---

## API Endpoints

```typescript
// =============================================================================
// NPD Gate Workflow Endpoints (Story 08.3)
// =============================================================================

// POST /api/npd/projects/:id/advance-gate
// Advance project to next gate
interface AdvanceGateRequest {
  notes?: string;
  approval_notes?: string; // Required for G3+
}

interface AdvanceGateResponse {
  project: NPDProject;
  transition: {
    from_gate: string;
    to_gate: string;
    transitioned_at: string;
    requires_approval: boolean;
    approved_by?: string;
  };
}

// POST /api/npd/projects/:id/move-back
// Move project back to previous gate
interface MoveBackRequest {
  target_gate: string;
  justification: string; // Min 50 chars
}

interface MoveBackResponse {
  project: NPDProject;
  transition: {
    from_gate: string;
    to_gate: string;
    transitioned_at: string;
    justification: string;
  };
}

// GET /api/npd/projects/:id/checklist
// Get checklist for current gate
interface ChecklistResponse {
  project_id: string;
  current_gate: string;
  items: ChecklistItem[];
  summary: {
    total_items: number;
    required_items: number;
    completed_items: number;
    required_completed: number;
    completion_pct: number;
    required_completion_pct: number;
    can_advance: boolean;
    blocking_items: string[];
  };
}

interface ChecklistItem {
  id: string;
  item_description: string;
  is_required: boolean;
  category: string;
  sequence: number;
  is_completed: boolean;
  completed_by?: string;
  completed_by_name?: string;
  completed_at?: string;
  completion_notes?: string;
  attachment_url?: string;
}

// POST /api/npd/projects/:id/checklist/:itemId/complete
// Mark checklist item complete
interface CompleteChecklistItemRequest {
  notes?: string;
  attachment_url?: string; // Supabase Storage path
}

interface CompleteChecklistItemResponse {
  item: ChecklistItem;
  completion: {
    completed_by: string;
    completed_at: string;
  };
}

// POST /api/npd/projects/:id/checklist/:itemId/uncomplete
// Mark checklist item incomplete (allow re-work)
interface UncompleteChecklistItemResponse {
  item: ChecklistItem;
  is_completed: false;
}

// GET /api/npd/projects/:id/gate-history
// Get gate transition history
interface GateHistoryResponse {
  project_id: string;
  project_number: string;
  current_gate: string;
  gate_entered_at: string;
  history: GateTransitionEntry[];
}

interface GateTransitionEntry {
  id: string;
  from_gate: string;
  to_gate: string;
  transition_type: 'advance' | 'move_back' | 'cancel';
  transitioned_by: string;
  transitioned_by_name: string;
  transitioned_at: string;
  transition_notes: string | null;
  requires_approval: boolean;
  approved_by: string | null;
  approved_by_name: string | null;
  approved_at: string | null;
  approval_notes: string | null;
  checklist_completion_pct: number;
  blocking_items: number;
  days_in_previous_gate: number | null;
}

// GET /api/npd/projects/:id/validate-advance
// Validate if project can advance to next gate (read-only check)
interface ValidateAdvanceResponse {
  can_advance: boolean;
  next_gate: string;
  requires_approval: boolean;
  required_roles: string[];
  blocking_reasons: string[];
  checklist_summary: {
    required_completed: number;
    required_total: number;
    blocking_items: string[];
  };
}
```

---

## Service Layer

```typescript
// lib/services/npd-gate-workflow-service.ts

export class NPDGateWorkflowService {
  /**
   * Advance project to next gate
   */
  static async advanceGate(
    projectId: string,
    notes: string | null,
    approvalNotes: string | null,
    userId: string
  ): Promise<AdvanceGateResult>;

  /**
   * Move project back to previous gate
   */
  static async moveBack(
    projectId: string,
    targetGate: string,
    justification: string,
    userId: string
  ): Promise<MoveBackResult>;

  /**
   * Get checklist for project's current gate
   */
  static async getChecklist(projectId: string): Promise<ChecklistResponse>;

  /**
   * Mark checklist item complete
   */
  static async completeChecklistItem(
    projectId: string,
    checklistItemId: string,
    notes: string | null,
    attachmentUrl: string | null,
    userId: string
  ): Promise<ChecklistItem>;

  /**
   * Mark checklist item incomplete
   */
  static async uncompleteChecklistItem(
    projectId: string,
    checklistItemId: string,
    userId: string
  ): Promise<ChecklistItem>;

  /**
   * Get gate transition history
   */
  static async getGateHistory(projectId: string): Promise<GateTransitionEntry[]>;

  /**
   * Validate if project can advance
   */
  static async validateAdvance(
    projectId: string,
    userId: string
  ): Promise<ValidateAdvanceResponse>;

  /**
   * Calculate checklist completion percentage
   */
  static async calculateCompletionPct(projectId: string): Promise<number>;

  /**
   * Get blocking checklist items
   */
  static async getBlockingItems(projectId: string): Promise<string[]>;

  /**
   * Check if user can approve gate transition
   */
  static async canApproveGate(
    gate: string,
    userId: string
  ): Promise<boolean>;

  /**
   * Get next gate in sequence
   */
  static getNextGate(currentGate: string): string | null;

  /**
   * Get previous gate in sequence
   */
  static getPreviousGate(currentGate: string): string | null;

  /**
   * Seed default checklists for organization
   */
  static async seedDefaultChecklists(orgId: string): Promise<void>;
}

interface AdvanceGateResult {
  success: boolean;
  project: NPDProject;
  transition: GateTransitionEntry;
  error?: string;
}

interface MoveBackResult {
  success: boolean;
  project: NPDProject;
  transition: GateTransitionEntry;
  error?: string;
}
```

---

## Frontend Components

```
apps/frontend/app/(authenticated)/npd/
  projects/
    [id]/
      page.tsx                         -- NPD project detail (add gate workflow)
      gate-history/
        page.tsx                       -- Full gate history page

components/npd/
  NPDGateTimeline.tsx                  -- Horizontal stepper showing gates
  NPDGateProgress.tsx                  -- Compact progress bar
  NPDAdvanceGateModal.tsx              -- Modal to advance gate
  NPDMoveBackModal.tsx                 -- Modal to move back gate
  NPDChecklistPanel.tsx                -- Checklist for current gate
  NPDChecklistItem.tsx                 -- Single checklist item row
  NPDGateHistory.tsx                   -- Table of gate transitions
  NPDGateHistoryCard.tsx               -- Card for single transition
  NPDGateBadge.tsx                     -- Badge for gate (G0-G4, Launched)
  NPDValidationWarning.tsx             -- Warning for blocking items
```

### NPDGateTimeline.tsx

Horizontal stepper component showing gate progress:
- All gates listed horizontally (G0 -> G1 -> G2 -> G3 -> G4 -> Launched)
- Completed gates: green check, date
- Current gate: highlighted, checklist completion %
- Future gates: grayed out
- Blocking indicator: red warning if required items incomplete

### NPDAdvanceGateModal.tsx

Modal for advancing gates:
- Title: "Advance to [Next Gate]"
- Current gate -> Target gate visual
- Checklist completion summary
- Notes textarea (required for G3+)
- Approval section (for G3+)
- [Cancel] and [Advance Gate] buttons
- Loading state during submission
- Error display inline

### NPDChecklistPanel.tsx

Collapsible panel showing checklist:
- Header: "G2 Checklist - 4/5 items complete (80%)"
- Category grouping (Technical, Business, Compliance)
- Required items highlighted
- Completion checkboxes
- Notes/attachment per item
- Mark complete button per item

---

## UI Styling

```typescript
// Gate colors
const gateColors = {
  G0: 'bg-gray-100 text-gray-800 border-gray-300',
  G1: 'bg-blue-100 text-blue-800 border-blue-300',
  G2: 'bg-purple-100 text-purple-800 border-purple-300',
  G3: 'bg-orange-100 text-orange-800 border-orange-300',
  G4: 'bg-yellow-100 text-yellow-800 border-yellow-300',
  launched: 'bg-green-100 text-green-800 border-green-300',
  cancelled: 'bg-red-100 text-red-800 border-red-300',
};

// Timeline step status
const stepStatus = {
  completed: 'border-green-500 bg-green-50',
  current: 'border-blue-500 bg-blue-50 ring-2 ring-blue-500',
  pending: 'border-gray-300 bg-gray-50',
  blocked: 'border-red-500 bg-red-50 ring-2 ring-red-500',
};

// Checklist item status
const itemStatus = {
  required_incomplete: 'border-red-300 bg-red-50',
  required_complete: 'border-green-300 bg-green-50',
  optional_incomplete: 'border-gray-200 bg-white',
  optional_complete: 'border-green-200 bg-green-50',
};
```

---

## Test Cases

### Unit Tests

```typescript
describe('NPDGateWorkflowService', () => {
  describe('advanceGate', () => {
    it('advances from G0 to G1', async () => {});
    it('rejects advance with incomplete required items', async () => {});
    it('requires Director approval for G3+', async () => {});
    it('creates transition history record', async () => {});
    it('updates gate_entered_at timestamp', async () => {});
  });

  describe('moveBack', () => {
    it('moves project back to previous gate', async () => {});
    it('requires justification (min 50 chars)', async () => {});
    it('increments move_back_count', async () => {});
    it('only Director can move back from G3+', async () => {});
  });

  describe('getChecklist', () => {
    it('returns checklist for current gate', async () => {});
    it('includes completion status per item', async () => {});
    it('calculates summary statistics', async () => {});
    it('identifies blocking items', async () => {});
  });

  describe('completeChecklistItem', () => {
    it('marks item complete', async () => {});
    it('stores completion notes', async () => {});
    it('stores attachment URL', async () => {});
    it('updates completion timestamp', async () => {});
  });

  describe('validateAdvance', () => {
    it('allows advance when all required complete', async () => {});
    it('blocks advance with incomplete required items', async () => {});
    it('checks user role for G3+', async () => {});
    it('returns blocking reasons', async () => {});
  });

  describe('getNextGate', () => {
    it('returns G1 for G0', async () => {});
    it('returns G2 for G1', async () => {});
    it('returns launched for G4', async () => {});
    it('returns null for launched', async () => {});
  });
});
```

### Integration Tests

```typescript
describe('NPD Gate Workflow API', () => {
  describe('POST /api/npd/projects/:id/advance-gate', () => {
    it('advances gate with valid checklist', async () => {});
    it('returns 400 for incomplete checklist', async () => {});
    it('returns 403 for unauthorized role', async () => {});
    it('creates transition history record', async () => {});
    it('returns 404 for other org project', async () => {});
  });

  describe('GET /api/npd/projects/:id/checklist', () => {
    it('returns current gate checklist', async () => {});
    it('includes completion summary', async () => {});
    it('filters by active items only', async () => {});
  });

  describe('POST /api/npd/projects/:id/checklist/:itemId/complete', () => {
    it('marks item complete', async () => {});
    it('stores attachment URL', async () => {});
    it('updates completion percentage', async () => {});
  });

  describe('GET /api/npd/projects/:id/gate-history', () => {
    it('returns transition history', async () => {});
    it('orders by transitioned_at DESC', async () => {});
    it('includes approval metadata', async () => {});
  });
});
```

### E2E Tests

```typescript
describe('NPD Gate Workflow E2E', () => {
  it('complete workflow: G0 -> G1 -> G2 -> G3 -> G4 -> Launched', async () => {
    // 1. Login as NPD Lead
    // 2. Create NPD project (starts at G0)
    // 3. Complete G0 checklist items
    // 4. Advance to G1
    // 5. Complete G1 checklist
    // 6. Advance to G2
    // 7. Switch to Director
    // 8. Complete G2 checklist
    // 9. Advance to G3 with approval
    // 10. Complete G3 checklist
    // 11. Advance to G4 with approval
    // 12. Complete G4 checklist
    // 13. Advance to Launched
    // 14. Verify gate history shows all transitions
  });

  it('move back workflow: G3 -> G2 with justification', async () => {
    // 1. Login as Director
    // 2. Open project in G3
    // 3. Click 'Move Back to G2'
    // 4. Fill justification (min 50 chars)
    // 5. Confirm
    // 6. Verify current_gate = 'G2'
    // 7. Verify move_back_count incremented
    // 8. Verify can re-advance
  });

  it('timeline displays gate progress', async () => {
    // 1. Open project in G3
    // 2. Verify timeline stepper
    // 3. G0-G2 have green checks
    // 4. G3 is highlighted
    // 5. G4 and Launched are gray
    // 6. Checklist completion % shown
  });

  it('checklist blocking prevents advance', async () => {
    // 1. Open project in G1
    // 2. Complete 2 of 3 required items
    // 3. Click 'Advance to G2'
    // 4. Modal shows validation error
    // 5. Error lists incomplete required item
    // 6. [Advance] button disabled
    // 7. Complete remaining item
    // 8. [Advance] button enabled
  });
});
```

---

## Deliverables

### Database
- [ ] Migration: Extend `npd_projects` with gate tracking columns
- [ ] Migration: Create `npd_gate_checklists` table
- [ ] Migration: Create `npd_project_checklist_completion` table
- [ ] Migration: Create `npd_gate_transitions` table
- [ ] Function: `seed_npd_gate_checklists(org_id)` for default checklists
- [ ] RLS policies for all new tables
- [ ] All performance indexes

### API Routes
- [ ] `POST /api/npd/projects/:id/advance-gate` - Advance to next gate
- [ ] `POST /api/npd/projects/:id/move-back` - Move back to previous gate
- [ ] `GET /api/npd/projects/:id/checklist` - Get current gate checklist
- [ ] `POST /api/npd/projects/:id/checklist/:itemId/complete` - Mark item complete
- [ ] `POST /api/npd/projects/:id/checklist/:itemId/uncomplete` - Mark incomplete
- [ ] `GET /api/npd/projects/:id/gate-history` - Get transition history
- [ ] `GET /api/npd/projects/:id/validate-advance` - Validate if can advance

### Service Layer
- [ ] `NPDGateWorkflowService.advanceGate()`
- [ ] `NPDGateWorkflowService.moveBack()`
- [ ] `NPDGateWorkflowService.getChecklist()`
- [ ] `NPDGateWorkflowService.completeChecklistItem()`
- [ ] `NPDGateWorkflowService.uncompleteChecklistItem()`
- [ ] `NPDGateWorkflowService.getGateHistory()`
- [ ] `NPDGateWorkflowService.validateAdvance()`
- [ ] `NPDGateWorkflowService.calculateCompletionPct()`
- [ ] `NPDGateWorkflowService.getBlockingItems()`
- [ ] `NPDGateWorkflowService.canApproveGate()`
- [ ] `NPDGateWorkflowService.getNextGate()`
- [ ] `NPDGateWorkflowService.seedDefaultChecklists()`

### Validation
- [ ] `advanceGateSchema` - gate advance request validation
- [ ] `moveBackSchema` - move back request validation
- [ ] `completeChecklistItemSchema` - checklist completion validation
- [ ] `gateHistoryQuerySchema`

### Frontend
- [ ] NPDGateTimeline component (horizontal stepper)
- [ ] NPDAdvanceGateModal component
- [ ] NPDMoveBackModal component
- [ ] NPDChecklistPanel component
- [ ] NPDChecklistItem component
- [ ] NPDGateHistory component
- [ ] NPDGateHistoryCard component
- [ ] NPDGateBadge component
- [ ] NPDValidationWarning component
- [ ] Integration in NPD project detail page
- [ ] Hooks: useNPDGateWorkflow, useChecklist

### Tests
- [ ] Unit tests: NPDGateWorkflowService (>80% coverage)
- [ ] Integration tests: All 7 workflow endpoints
- [ ] RLS tests: Multi-tenancy isolation
- [ ] Permission tests: Role-based gate approvals
- [ ] E2E: Complete gate workflow (G0 -> Launched)
- [ ] E2E: Move back workflow
- [ ] E2E: Checklist blocking validation

---

## Definition of Done

### Database
- [ ] All migrations applied successfully
- [ ] `npd_gate_checklists` seeded with default checklists per org
- [ ] `npd_gate_transitions` enforces immutability (no UPDATE/DELETE)
- [ ] RLS policies enforce org isolation
- [ ] Performance indexes created

### API
- [ ] POST advance-gate endpoint validates and executes correctly
- [ ] GET checklist returns completion summary
- [ ] POST complete-item updates completion status
- [ ] GET gate-history returns ordered transitions
- [ ] All endpoints return correct HTTP status codes
- [ ] Response times < 500ms

### Service
- [ ] Gate sequence validated (no skipping gates)
- [ ] Checklist completion blocking works
- [ ] Director approval required for G3+
- [ ] Move back logic works with count tracking
- [ ] History records immutable
- [ ] Default checklists seeded on org creation

### Frontend
- [ ] Gate timeline displays correctly
- [ ] Advance gate modal validates and submits
- [ ] Checklist panel shows completion status
- [ ] Blocking items prevent advance
- [ ] Gate badges have correct colors
- [ ] Gate history displays all transitions

### Testing
- [ ] Unit tests: >80% coverage on workflow service
- [ ] Integration tests: All endpoints covered
- [ ] E2E: Full gate workflow (G0 -> Launched) passing
- [ ] E2E: Move back flow passing
- [ ] Permission tests: Role restrictions enforced

---

## Risk Assessment

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Complex gate state machine logic | HIGH | MEDIUM | Comprehensive validation, unit tests |
| Checklist completion edge cases | MEDIUM | MEDIUM | Clear blocking logic, validation tests |
| History immutability bypass | HIGH | LOW | RLS + no UPDATE/DELETE policies |
| Permission edge cases (G3+ approval) | HIGH | MEDIUM | Clear role checks, permission tests |
| Default checklist not seeded | MEDIUM | LOW | Seed function called on org creation |
| Move back logic abuse | MEDIUM | LOW | Director-only, justification required |

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-01-15 | Initial story creation - Stage-Gate Workflow | ARCHITECT-AGENT |

---

**Document Status**: Ready for Implementation
**Created**: 2025-01-15
**Lines**: ~1300
**Complexity**: L (Large)
**Phase**: 1 (MVP)
