# 08.5 - Allergen Aggregation & Display

**Priority:** P0 (MVP - Phase 1)
**Story Points:** M (Medium)
**Type:** backend + frontend

**State:** ready
**Primary PRD:** `docs/1-BASELINE/product/modules/npd.md` (Section 3.5, FR-NPD-10, 30, 61)
**UX Wireframes:** TBD (Allergen Declaration Panel)

---

## PRD Requirements Coverage

| Req ID | Requirement | Priority | Phase | In Scope |
|--------|-------------|----------|-------|----------|
| NPD-FR-10 | System shall auto-aggregate allergens | Must | 1 | Yes |
| NPD-FR-30 | System shall display allergen declaration | Must | 1 | Yes |
| NPD-FR-61 | System shall reuse allergens table | Must | 1 | Yes |

---

## Context

NPD formulations are composed of ingredient products (from Technical module). Each ingredient may contain allergens. This story implements **automatic allergen aggregation** from all formulation items, displaying a combined allergen declaration compliant with EU Regulation 1169/2011 (14 mandatory allergens).

**Usage across NPD workflow:**
- **G1 Feasibility:** Initial allergen assessment from early formulation
- **G3 Development:** Allergen validation during formulation lock
- **G4 Testing:** Final allergen declaration review before handoff
- **Handoff:** Allergen data inherited by Product and BOM

**Key Design Decision:** Allergens are **read-only reference data** from Epic 01 (Settings module). NPD formulations **aggregate** allergens from linked ingredient products via `product_allergens` junction table.

---

## User Story

As an **R&D Formulator**, I want to **automatically see all allergens present in my formulation based on the ingredients I've added** so that **I can validate allergen declarations before locking the formulation and ensure compliance with food labeling regulations**.

---

## Dependencies

| Story | Name | Reason |
|-------|------|--------|
| **01.12** | Allergens Management | Provides `allergens` and `product_allergens` tables |
| **08.4** | Formulations CRUD & Versioning | Provides `npd_formulations` and `npd_formulation_items` tables |
| **02.1** | Products CRUD | Ingredient products with allergen associations |

---

## Acceptance Criteria (Given/When/Then)

### AC-1: Allergen Aggregation Function

**Given** formulation with 3 items: Product A (contains A01-Gluten, A07-Milk), Product B (contains A03-Eggs), Product C (no allergens)
**When** allergen aggregation function called
**Then** function returns: [A01-Gluten, A03-Eggs, A07-Milk] sorted by code

**Given** formulation with duplicate allergen (2 items both contain A07-Milk)
**When** aggregation function called
**Then** allergen A07 appears only once in result (deduplicated)

**Given** formulation with 0 items (empty formulation)
**When** aggregation function called
**Then** function returns empty array

**Given** formulation items updated (item added/removed)
**When** allergen panel refreshed
**Then** allergen list updates within 200ms

### AC-2: Allergen Declaration Panel (Formulation Detail Page)

**Given** formulation detail page displayed
**When** "Allergen Declaration" section rendered
**Then** panel shows:
- Section header "Allergen Declaration"
- List of present allergens with code and name (user language)
- Each allergen displays icon (24x24 size)
- Total allergen count badge
- "No allergens detected" message if empty

**Given** formulation contains allergens [A01, A03, A07]
**When** panel rendered with user language = English
**Then** allergens display as:
- A01 - Gluten
- A03 - Eggs
- A07 - Milk

**Given** formulation contains allergens [A01, A03, A07]
**When** panel rendered with user language = Polish
**Then** allergens display as:
- A01 - Gluten
- A03 - Jaja
- A07 - Mleko

**Given** allergen panel displayed
**When** allergen has icon_url defined
**Then** icon displays from allergen.icon_url

**Given** allergen panel displayed
**When** allergen has icon_url = null
**Then** fallback icon (warning triangle) displays

### AC-3: Allergen Warning Badge

**Given** formulation with 0 allergens
**When** allergen badge displayed
**Then** badge shows: "No Allergens" with green background

**Given** formulation with 1-5 allergens
**When** allergen badge displayed
**Then** badge shows: "5 Allergens" with yellow background

**Given** formulation with >5 allergens
**When** allergen badge displayed
**Then** badge shows: "8 Allergens" with orange background

### AC-4: Cross-Contamination Warning (Out of Scope Phase 1)

**NOTE:** Cross-contamination warnings based on production line history are deferred to Phase 2 (Story 08.19). Phase 1 only displays **direct ingredient allergens**.

**Given** formulation allergen declaration
**When** panel rendered in Phase 1
**Then** cross-contamination section NOT displayed

### AC-5: API Endpoint - Get Formulation Allergens

**Given** valid formulation ID
**When** GET `/api/npd/formulations/:id/allergens`
**Then** response returns:
- 200 OK
- JSON: `{ allergens: Allergen[], total: number }`
- Allergens sorted by code (A01, A02, etc.)

**Given** invalid formulation ID
**When** GET `/api/npd/formulations/:id/allergens`
**Then** response returns 404 Not Found

**Given** unauthenticated request
**When** GET `/api/npd/formulations/:id/allergens`
**Then** response returns 401 Unauthorized

**Given** formulation belongs to different org
**When** authenticated user requests allergens
**Then** response returns 403 Forbidden (RLS enforced)

### AC-6: Performance Requirements

**Given** formulation with 20 items
**When** allergen aggregation executed
**Then** query completes within 200ms

**Given** allergen panel displayed
**When** formulation items updated
**Then** panel refreshes within 300ms

---

## Technical Specification

### Database Function

```sql
-- Aggregate allergens from all formulation items
CREATE OR REPLACE FUNCTION aggregate_formulation_allergens(
  p_formulation_id UUID
) RETURNS TABLE (
  allergen_id UUID,
  code VARCHAR(10),
  name_en VARCHAR(100),
  name_pl VARCHAR(100),
  name_de VARCHAR(100),
  name_fr VARCHAR(100),
  icon_url TEXT
) AS $$
BEGIN
  RETURN QUERY
  SELECT DISTINCT
    a.id AS allergen_id,
    a.code,
    a.name_en,
    a.name_pl,
    a.name_de,
    a.name_fr,
    a.icon_url
  FROM npd_formulation_items fi
  INNER JOIN product_allergens pa ON fi.product_id = pa.product_id
  INNER JOIN allergens a ON pa.allergen_id = a.id
  WHERE fi.formulation_id = p_formulation_id
    AND fi.is_active = true
    AND a.is_active = true
  ORDER BY a.code ASC;
END;
$$ LANGUAGE plpgsql STABLE;

-- Usage:
-- SELECT * FROM aggregate_formulation_allergens('formulation-uuid-here');
```

### API Endpoints

```typescript
// GET /api/npd/formulations/:id/allergens
// Query params: lang (optional - for primary name)
interface FormulationAllergensParams {
  lang?: 'en' | 'pl' | 'de' | 'fr';
}

interface FormulationAllergensResponse {
  allergens: Allergen[];
  total: number;
}

interface Allergen {
  id: string;
  code: string;
  name_en: string;
  name_pl: string;
  name_de: string | null;
  name_fr: string | null;
  icon_url: string | null;
}
```

### Service Methods

```typescript
// lib/services/npd-formulation-service.ts
export class NPDFormulationService {
  // Get aggregated allergens for a formulation
  async getFormulationAllergens(
    formulationId: string,
    orgId: string
  ): Promise<Allergen[]> {
    const { data, error } = await supabase
      .rpc('aggregate_formulation_allergens', {
        p_formulation_id: formulationId
      });

    if (error) throw error;
    return data || [];
  }

  // Get allergen count (for badge)
  async getAllergenCount(formulationId: string, orgId: string): Promise<number> {
    const allergens = await this.getFormulationAllergens(formulationId, orgId);
    return allergens.length;
  }

  // Helper: Get localized allergen name
  getAllergenName(allergen: Allergen, lang: string): string {
    switch (lang) {
      case 'pl': return allergen.name_pl;
      case 'de': return allergen.name_de || allergen.name_en;
      case 'fr': return allergen.name_fr || allergen.name_en;
      default: return allergen.name_en;
    }
  }
}
```

### Zod Validation Schema

```typescript
// lib/validation/npd-allergen-schema.ts
import { z } from 'zod';
import { allergenSchema } from './allergen-schema'; // Reuse from Epic 01

export const formulationAllergensResponseSchema = z.object({
  allergens: z.array(allergenSchema),
  total: z.number().int().min(0).max(14),
});

export type FormulationAllergensResponse = z.infer<typeof formulationAllergensResponseSchema>;
```

---

## UI Components

### File Structure

```
app/(authenticated)/npd/formulations/[id]/
  page.tsx                              -- Formulation detail page (includes allergen panel)

app/api/npd/formulations/[id]/allergens/
  route.ts                              -- GET allergens endpoint

components/npd/allergens/
  FormulationAllergenPanel.tsx          -- Allergen declaration panel
  FormulationAllergenBadge.tsx          -- Allergen count badge
  AllergenIcon.tsx                      -- Icon component (reuse from Epic 01)
  AllergenList.tsx                      -- List of allergens with icons
```

### Component Specifications

**FormulationAllergenPanel.tsx**
```tsx
interface FormulationAllergenPanelProps {
  formulationId: string;
  lang?: string;
  showBadge?: boolean;
}

// Displays:
// - Section header "Allergen Declaration"
// - Allergen count badge (optional)
// - List of allergens with icons and localized names
// - "No allergens detected" empty state
// - Auto-refreshes when formulation items change
```

**FormulationAllergenBadge.tsx**
```tsx
interface FormulationAllergenBadgeProps {
  count: number;
  size?: 'sm' | 'md' | 'lg';
}

// Color coding:
// - 0 allergens: green ("No Allergens")
// - 1-5 allergens: yellow ("{count} Allergens")
// - >5 allergens: orange ("{count} Allergens")
```

**AllergenList.tsx**
```tsx
interface AllergenListProps {
  allergens: Allergen[];
  lang?: string;
  showIcon?: boolean;
  showCode?: boolean;
}

// Displays allergens sorted by code
// Each item: [Icon] A01 - Gluten
// Uses AllergenIcon from Epic 01
```

---

## Out of Scope

| Req ID | Requirement | Reason | Target Phase |
|--------|-------------|--------|--------------|
| -- | Cross-contamination warnings | Requires production line history analysis | Phase 2 (Story 08.19) |
| -- | Allergen editing | Allergens are read-only reference data | Never (maintained in Settings) |
| -- | Custom allergen addition | NPD uses only EU-mandated allergens | Phase 3 |
| -- | Allergen severity levels | Not required by EU regulation | Phase 3 |
| -- | Precautionary allergen statements | Manual entry in compliance docs | Phase 2 |
| -- | Allergen substitution suggestions | R&D feature | Phase 3 |

---

## Test Cases

### Unit Tests (npd-formulation-service.ts)

| Test ID | Description | Expected Result |
|---------|-------------|-----------------|
| UT-01 | Get allergens for formulation with 3 items | Returns 3 unique allergens |
| UT-02 | Get allergens for formulation with duplicate allergens | Deduplicates and returns unique allergens |
| UT-03 | Get allergens for empty formulation | Returns empty array |
| UT-04 | Get allergens for invalid formulation ID | Throws not found error |
| UT-05 | Get allergen count | Returns correct count |
| UT-06 | Get allergen name with lang='pl' | Returns Polish name |
| UT-07 | Get allergen name with lang='de' | Returns German name or falls back to English |
| UT-08 | Get allergens sorted by code | Returns allergens in A01, A02, A03... order |

### Integration Tests (API)

| Test ID | Description | Expected Result |
|---------|-------------|-----------------|
| IT-01 | GET /formulations/:id/allergens (valid) | 200 with allergen array |
| IT-02 | GET /formulations/:id/allergens (invalid ID) | 404 not found |
| IT-03 | GET /formulations/:id/allergens (unauthenticated) | 401 Unauthorized |
| IT-04 | GET /formulations/:id/allergens (different org) | 403 Forbidden (RLS) |
| IT-05 | Response includes all language fields | name_en, name_pl, name_de, name_fr present |
| IT-06 | Response ordered by code | A01 first, A14 last |
| IT-07 | Allergens deduplicated | No duplicate allergen IDs |
| IT-08 | Performance: 20 items | Query completes <200ms |

### E2E Tests (Playwright)

| Test ID | Description | Expected Result |
|---------|-------------|-----------------|
| E2E-01 | Navigate to formulation detail | Allergen panel displayed |
| E2E-02 | Formulation with 3 allergens | Shows 3 allergens in panel |
| E2E-03 | Formulation with 0 allergens | Shows "No allergens detected" message |
| E2E-04 | Allergen badge displays count | Badge shows "3 Allergens" with yellow background |
| E2E-05 | Allergen icons load | All icons display or fallback shown |
| E2E-06 | Add formulation item with allergen | Allergen panel auto-refreshes |
| E2E-07 | Remove formulation item | Allergen count decreases |
| E2E-08 | Language change (EN → PL) | Allergen names update to Polish |
| E2E-09 | Panel loads under 300ms | Performance check passes |

---

## Definition of Done

- [ ] Database function `aggregate_formulation_allergens()` created
- [ ] Function deduplicates allergens across multiple items
- [ ] Function returns allergens sorted by code
- [ ] API endpoint `GET /api/npd/formulations/:id/allergens` returns allergen array
- [ ] RLS enforced (403 for different org)
- [ ] `npd-formulation-service.ts` with allergen methods
- [ ] Zod validation schemas for API responses
- [ ] Formulation detail page displays allergen panel
- [ ] Allergen panel shows icons with fallback
- [ ] Allergen count badge with color coding (green/yellow/orange)
- [ ] Panel auto-refreshes when formulation items change
- [ ] Multi-language name display based on user preference
- [ ] "No allergens detected" empty state
- [ ] Panel loads within 300ms
- [ ] Unit tests for formulation service (>80% coverage)
- [ ] Integration tests for API endpoint
- [ ] E2E tests for allergen panel rendering and updates

---

## Integration Points

### Upstream Dependencies (Reads From)

| Module | Table/Function | Usage |
|--------|----------------|-------|
| Settings (Epic 01) | `allergens` | Reference data for allergen names/icons |
| Settings (Epic 01) | `product_allergens` | Junction table linking products to allergens |
| Technical (Epic 02) | `products` | Ingredient products used in formulation items |
| NPD (Story 08.4) | `npd_formulation_items` | Items to aggregate allergens from |

### Downstream Dependencies (Provides To)

| Story | Usage |
|-------|-------|
| **08.11** | Handoff Wizard - validates allergen declaration complete |
| **08.12** | Handoff: Formulation → BOM - inherits allergen data |
| **08.3** | Gate Checklists - G3 checklist item "Allergen declaration validated" |

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2026-01-15 | Initial story creation | ARCHITECT-AGENT |
