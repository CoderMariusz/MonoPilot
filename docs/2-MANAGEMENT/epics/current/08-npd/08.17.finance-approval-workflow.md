# 08.17 - Finance Approval Workflow

**Priority**: P1 (High - Approval Required)
**Story Points**: M (Medium)
**Type**: fullstack
**Phase**: 3 (Enterprise Features)
**Model**: SONNET

**State**: ready
**Estimate**: M (3-4 days)
**Primary PRD**: `docs/1-BASELINE/product/modules/npd.md` (FR-NPD-29, 66, 71, 72)
**Architecture**: `docs/1-BASELINE/architecture/modules/npd.md`
**Dependencies**: 08.2, 08.7, 01.1

---

## Goal

Implement Finance role approval workflow for NPD formulation costing before handoff to production. Finance users review and approve/reject costing submissions with variance analysis, auto-approve thresholds, and email notifications to maintain cost control and budget compliance.

---

## Food Safety Compliance

This story supports **cost control and budget compliance**:

- [x] **ISO 9001** - Financial approval required for quality management system
- [x] **Traceability** - Costing approval trail provides audit evidence
- [x] **Governance** - Finance gatekeeping ensures margin targets met

**Regulatory Context:**
- Cost approval ensures products meet profitability targets before launch
- Variance thresholds prevent budget overruns
- Approval trail required for internal audit and management review
- Finance oversight reduces financial risk in NPD investments

---

## MVP Scope

This story implements Phase 3 (Enterprise Features) finance governance. Finance approval workflow adds cost control gatekeeping to NPD handoff process, ensuring only financially viable products reach production.

**MVP Includes**:
- Finance role approval for costing (before handoff)
- Costing submission workflow (NPD Lead submits → Finance approves/rejects)
- Approval modal (costing data, variance %, approve/reject buttons)
- Auto-approve if variance < threshold (configurable, default 10%)
- Rejection requires reason
- Email notification to Finance on submission
- Email notification to NPD Lead on approval/rejection
- Costing status: draft → submitted → approved/rejected
- Variance threshold configurable in npd_settings

**Deferred to Phase 4+**:
- Multi-level approval (e.g., CFO approval for >$50k variance)
- Approval delegation
- Approval SLA tracking
- Approval history audit log (covered in 08.18)

---

## User Story

As a **Finance Manager**, I want to **review and approve NPD costing submissions** so that **I can ensure products meet margin targets before production handoff**.

As an **NPD Lead**, I want to **submit costing for Finance approval** so that **I can get cost sign-off before handing off to production**.

As a **System Admin**, I want to **configure auto-approve variance threshold** so that **low-variance projects don't require manual Finance review**.

---

## Scope

**In scope (this story)**
- Finance approval workflow (submit → approve/reject)
- Costing status: draft → submitted → approved → rejected
- Approval modal (variance analysis, approve/reject)
- Auto-approve logic (variance < threshold)
- Rejection reason required
- Email notifications (submission, approval, rejection)
- Variance threshold configurable per org (npd_settings)
- GET /api/npd/costing/:id/approval (approval details)
- POST /api/npd/costing/:id/submit (submit for approval)
- POST /api/npd/costing/:id/approve (Finance approves)
- POST /api/npd/costing/:id/reject (Finance rejects)

**Out of scope (this story)**
- Multi-level approval workflow (Phase 4)
- Approval delegation (Phase 4)
- Approval SLA tracking (Phase 4)
- Approval history audit log (08.18 covers this)
- Approval via mobile app (Phase 4)

---

## Dependencies

### Cross-Epic Dependencies

| Dependency | Story/Epic | Type | What It Provides | Status |
|------------|------------|------|------------------|--------|
| 01.1 | Org Context + RLS | HARD | organizations, users, roles tables | Ready |

### Within Epic Dependencies

| Dependency | Story | Type | What It Provides |
|------------|-------|------|------------------|
| 08.2 | NPD Projects CRUD | HARD | npd_projects table |
| 08.7 | Formulation Costing | HARD | npd_costing table with variance |

### Provides To (Downstream)

| Story | What This Provides |
|-------|-------------------|
| 08.11 | Handoff Wizard - Blocks handoff until costing approved |
| 08.18 | Audit Trail - Approval events logged |

---

## Database Migration

```sql
-- Migration: YYYYMMDDHHMMSS_add_costing_approval_workflow.sql

-- Add costing approval fields to npd_costing table
ALTER TABLE npd_costing
    ADD COLUMN status VARCHAR(20) DEFAULT 'draft'
        CHECK (status IN ('draft', 'submitted', 'approved', 'rejected')),
    ADD COLUMN submitted_at TIMESTAMPTZ,
    ADD COLUMN submitted_by_id UUID REFERENCES auth.users(id),
    ADD COLUMN approved_at TIMESTAMPTZ,
    ADD COLUMN approved_by_id UUID REFERENCES auth.users(id),
    ADD COLUMN rejected_at TIMESTAMPTZ,
    ADD COLUMN rejected_by_id UUID REFERENCES auth.users(id),
    ADD COLUMN rejection_reason TEXT,
    ADD COLUMN auto_approved BOOLEAN DEFAULT false;

-- Add variance threshold to npd_settings
ALTER TABLE npd_settings
    ADD COLUMN cost_variance_auto_approve_pct NUMERIC(5, 2) DEFAULT 10.00
        CHECK (cost_variance_auto_approve_pct >= 0 AND cost_variance_auto_approve_pct <= 100);

-- Index for pending approvals
CREATE INDEX idx_npd_costing_status ON npd_costing(status)
    WHERE status = 'submitted';

-- =============================================================================
-- RLS Policies for Costing Approval
-- =============================================================================

-- Finance users can view submitted costing
CREATE POLICY "costing_finance_select" ON npd_costing
    FOR SELECT USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
        AND (
            status IN ('submitted', 'approved', 'rejected')
            AND EXISTS (
                SELECT 1 FROM user_roles
                WHERE user_id = auth.uid()
                AND role = 'FINANCE'
            )
        )
    );

-- Finance users can update costing (approve/reject)
CREATE POLICY "costing_finance_update" ON npd_costing
    FOR UPDATE USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
        AND status = 'submitted'
        AND EXISTS (
            SELECT 1 FROM user_roles
            WHERE user_id = auth.uid()
            AND role = 'FINANCE'
        )
    );

-- NPD Lead can submit costing
CREATE POLICY "costing_npd_lead_submit" ON npd_costing
    FOR UPDATE USING (
        org_id = (SELECT org_id FROM users WHERE id = auth.uid())
        AND status = 'draft'
        AND EXISTS (
            SELECT 1 FROM npd_projects p
            WHERE p.id = npd_costing.project_id
            AND p.owner_id = auth.uid()
        )
    );
```

---

## Acceptance Criteria (Given/When/Then)

### AC-1: Costing Submission

```gherkin
Scenario: NPD Lead submits costing for approval
  Given NPD project NPD-001 with costing status = 'draft'
  And target_cost = $10.00
  And estimated_cost = $11.50
  And variance = 15%
  When NPD Lead calls POST /api/npd/costing/:id/submit
  Then costing.status = 'submitted'
  And costing.submitted_at = now
  And costing.submitted_by_id = NPD Lead user ID
  And email sent to all Finance users:
    | Subject | Costing Approval Required: NPD-001 |
    | Body | NPD project NPD-001 costing submitted for approval. Target: $10.00, Estimated: $11.50, Variance: 15%. |
    | Link | /npd/projects/:id/costing |
  And response 200 { success: true, status: 'submitted' }

Scenario: Cannot submit costing with missing data
  Given costing with target_cost = null
  When NPD Lead attempts submit
  Then error 400 "Target cost required before submission"
  And costing.status remains 'draft'

Scenario: Cannot submit already approved costing
  Given costing.status = 'approved'
  When NPD Lead attempts submit
  Then error 400 "Costing already approved"
```

### AC-2: Auto-Approve Logic

```gherkin
Scenario: Auto-approve when variance below threshold
  Given npd_settings.cost_variance_auto_approve_pct = 10%
  And target_cost = $10.00
  And estimated_cost = $10.80
  And variance = 8% (below 10% threshold)
  When NPD Lead submits costing
  Then costing.status = 'approved'
  And costing.approved_at = now
  And costing.auto_approved = true
  And costing.approved_by_id = null (auto-approved)
  And email sent to NPD Lead:
    | Subject | Costing Auto-Approved: NPD-001 |
    | Body | Costing automatically approved (variance 8% < threshold 10%). You may proceed to handoff. |
  And no email sent to Finance (auto-approved)

Scenario: Manual approval required when variance exceeds threshold
  Given npd_settings.cost_variance_auto_approve_pct = 10%
  And variance = 15% (exceeds 10% threshold)
  When NPD Lead submits costing
  Then costing.status = 'submitted' (not auto-approved)
  And costing.auto_approved = false
  And email sent to Finance for manual review

Scenario: Auto-approve threshold = 0 (all require approval)
  Given npd_settings.cost_variance_auto_approve_pct = 0%
  And variance = 2%
  When NPD Lead submits costing
  Then costing.status = 'submitted'
  And costing.auto_approved = false
  And manual Finance approval required
```

### AC-3: Finance Approval

```gherkin
Scenario: Finance approves costing
  Given costing.status = 'submitted'
  And Finance user logged in
  When Finance user calls POST /api/npd/costing/:id/approve
  Then costing.status = 'approved'
  And costing.approved_at = now
  And costing.approved_by_id = Finance user ID
  And costing.auto_approved = false
  And email sent to NPD Lead:
    | Subject | Costing Approved: NPD-001 |
    | Body | Finance approved costing for NPD-001. You may proceed to handoff. Approved by: Jane Doe (Finance). |
    | Link | /npd/projects/:id |
  And response 200 { success: true, status: 'approved' }

Scenario: Finance approval modal displays variance analysis
  Given Finance user views approval modal
  Then modal displays:
    | Field | Value |
    | Project | NPD-001 Vegan Protein Bar |
    | Formulation | v2.0 |
    | Target Cost | $10.00 |
    | Estimated Cost | $11.50 |
    | Variance | $1.50 (15%) |
    | Variance Status | ⚠️ Exceeds threshold (10%) |
    | Notes | (optional text area) |
  And buttons: [Approve] [Reject]
  And Approve button is green, Reject button is red

Scenario: Non-Finance user cannot approve
  Given costing.status = 'submitted'
  And R&D user (not Finance) logged in
  When R&D user attempts POST /api/npd/costing/:id/approve
  Then error 403 "Finance role required to approve costing"
```

### AC-4: Finance Rejection

```gherkin
Scenario: Finance rejects costing with reason
  Given costing.status = 'submitted'
  And Finance user logged in
  When Finance user calls POST /api/npd/costing/:id/reject
  With body: { reason: "Variance too high. Rework formulation to reduce cost by 5%." }
  Then costing.status = 'rejected'
  And costing.rejected_at = now
  And costing.rejected_by_id = Finance user ID
  And costing.rejection_reason = "Variance too high..."
  And email sent to NPD Lead:
    | Subject | Costing Rejected: NPD-001 |
    | Body | Finance rejected costing for NPD-001. Reason: Variance too high. Rework formulation to reduce cost by 5%. Rejected by: John Smith (Finance). |
    | Link | /npd/projects/:id/costing |
  And response 200 { success: true, status: 'rejected', reason: "..." }

Scenario: Rejection requires reason
  Given costing.status = 'submitted'
  When Finance user attempts reject without reason
  Then error 400 "Rejection reason required"
  And costing.status remains 'submitted'

Scenario: Rejected costing can be resubmitted
  Given costing.status = 'rejected'
  And NPD Lead updates costing (reduces estimated_cost)
  When NPD Lead submits again
  Then costing.status = 'submitted'
  And previous rejection_reason cleared
  And submitted_at updated to new timestamp
```

### AC-5: Approval Required for Handoff

```gherkin
Scenario: Handoff blocked until costing approved
  Given NPD project at G5 ready for handoff
  And costing.status = 'submitted' (pending approval)
  When NPD Lead attempts handoff
  Then error 400 "Finance approval required before handoff"
  And handoff wizard disabled

Scenario: Handoff allowed after costing approved
  Given costing.status = 'approved'
  When NPD Lead accesses handoff wizard
  Then wizard displays "✓ Finance Approved" badge
  And handoff proceeds normally
```

### AC-6: Email Notifications

```gherkin
Scenario: Finance receives email on costing submission
  Given NPD Lead submits costing
  When submission completes
  Then email sent to all users with FINANCE role:
    | To | finance1@example.com, finance2@example.com |
    | Subject | Costing Approval Required: NPD-001 |
    | Body | NPD project NPD-001 (Vegan Protein Bar) costing submitted for approval. |
    |      | Target Cost: $10.00 |
    |      | Estimated Cost: $11.50 |
    |      | Variance: $1.50 (15%) |
    |      | Click here to review: [Link] |
    | Link | https://app.monopilot.com/npd/projects/123/costing |

Scenario: NPD Lead receives email on approval
  Given Finance approves costing
  When approval completes
  Then email sent to NPD Lead:
    | To | npdlead@example.com |
    | Subject | Costing Approved: NPD-001 |
    | Body | Finance approved costing for NPD-001. You may proceed to handoff. Approved by: Jane Doe (Finance). |
    | Link | https://app.monopilot.com/npd/projects/123 |

Scenario: NPD Lead receives email on rejection
  Given Finance rejects costing
  When rejection completes
  Then email sent to NPD Lead:
    | To | npdlead@example.com |
    | Subject | Costing Rejected: NPD-001 |
    | Body | Finance rejected costing for NPD-001. Reason: Variance too high. Rework formulation. Rejected by: John Smith (Finance). |
    | Link | https://app.monopilot.com/npd/projects/123/costing |
```

### AC-7: Variance Threshold Configuration

```gherkin
Scenario: Admin configures variance threshold
  Given Admin user at NPD Settings page
  When Admin sets cost_variance_auto_approve_pct = 15%
  And saves settings
  Then npd_settings.cost_variance_auto_approve_pct = 15.00
  And subsequent submissions with variance < 15% auto-approve
  And submissions with variance >= 15% require manual approval

Scenario: Default variance threshold
  Given new organization
  When npd_settings created
  Then cost_variance_auto_approve_pct = 10.00 (default)
```

### AC-8: Approval Dashboard for Finance

```gherkin
Scenario: Finance views pending approvals
  Given Finance user navigates to /npd/approvals
  When page loads
  Then displays table:
    | Project | Formulation | Target Cost | Estimated Cost | Variance | Submitted | Actions |
    | NPD-001 | v2.0 | $10.00 | $11.50 | 15% | 2 hours ago | [Approve] [Reject] |
    | NPD-003 | v1.0 | $5.00 | $6.00 | 20% | 1 day ago | [Approve] [Reject] |
  And only costing with status = 'submitted' shown
  And sorted by submitted_at DESC (oldest first)
  And variance column color-coded (green <10%, yellow 10-20%, red >20%)

Scenario: Finance filters approvals
  Given multiple pending approvals
  When Finance user filters by variance > 20%
  Then only high-variance submissions shown
```

### AC-9: Performance Requirements

```gherkin
Scenario: Submission performance
  Given costing ready for submission
  When NPD Lead submits
  Then operation completes < 500ms
  And email queued for async delivery

Scenario: Approval performance
  Given Finance user approves costing
  When approval submitted
  Then operation completes < 300ms
  And email queued for async delivery

Scenario: Auto-approve performance
  Given variance below threshold
  When NPD Lead submits
  Then auto-approve logic executes < 200ms
  And response returns immediately
```

### AC-10: Permission Checks

```gherkin
Scenario: Only NPD Lead can submit costing
  Given costing.status = 'draft'
  And R&D user (not project owner)
  When R&D user attempts submit
  Then error 403 "Only project owner can submit costing"

Scenario: Only Finance can approve/reject
  Given costing.status = 'submitted'
  And NPD Lead (not Finance)
  When NPD Lead attempts approve
  Then error 403 "Finance role required"

Scenario: RLS enforces org isolation
  Given User A from Org A
  And costing from Org B
  When User A attempts approve costing from Org B
  Then error 404 Not Found (RLS blocks access)
```

---

## Implementation Notes

### API Endpoints

```typescript
// =============================================================================
// Costing Approval Endpoints
// =============================================================================

// GET /api/npd/costing/:id/approval
interface CostingApprovalResponse {
  costing: {
    id: number;
    project_id: number;
    project_number: string;
    formulation_number: string;
    target_cost: number;
    estimated_cost: number;
    actual_cost?: number;
    variance: number;
    variance_pct: number;
    status: 'draft' | 'submitted' | 'approved' | 'rejected';
    submitted_at?: string;
    submitted_by?: { id: string; name: string };
    approved_at?: string;
    approved_by?: { id: string; name: string };
    rejected_at?: string;
    rejected_by?: { id: string; name: string };
    rejection_reason?: string;
    auto_approved: boolean;
  };
  variance_threshold: number; // org setting
  requires_approval: boolean;  // variance >= threshold
}

// POST /api/npd/costing/:id/submit
interface SubmitCostingRequest {
  // No body required (costing already has all data)
}

interface SubmitCostingResponse {
  success: boolean;
  status: 'submitted' | 'approved'; // 'approved' if auto-approved
  auto_approved: boolean;
  message: string;
}

// POST /api/npd/costing/:id/approve
interface ApproveCostingRequest {
  notes?: string; // Optional approval notes
}

interface ApproveCostingResponse {
  success: boolean;
  status: 'approved';
  approved_at: string;
  approved_by: { id: string; name: string };
}

// POST /api/npd/costing/:id/reject
interface RejectCostingRequest {
  reason: string; // Required rejection reason
}

interface RejectCostingResponse {
  success: boolean;
  status: 'rejected';
  rejected_at: string;
  rejected_by: { id: string; name: string };
  reason: string;
}

// GET /api/npd/approvals (Finance pending approvals)
interface PendingApprovalsResponse {
  approvals: Array<{
    costing_id: number;
    project_id: number;
    project_number: string;
    project_name: string;
    formulation_number: string;
    target_cost: number;
    estimated_cost: number;
    variance: number;
    variance_pct: number;
    submitted_at: string;
    submitted_by: { id: string; name: string };
  }>;
  total: number;
}
```

### Service Layer

```typescript
// lib/services/npd-costing-approval-service.ts

export class NPDCostingApprovalService {
  /**
   * Submit costing for Finance approval
   */
  static async submitCosting(costingId: number, userId: string): Promise<SubmitCostingResult> {
    // 1. Fetch costing data
    const costing = await this.getCostingById(costingId);

    if (!costing) throw new Error('Costing not found');
    if (costing.status !== 'draft') throw new Error('Costing already submitted');
    if (!costing.target_cost || !costing.estimated_cost) {
      throw new Error('Target cost and estimated cost required');
    }

    // 2. Calculate variance
    const variance = costing.estimated_cost - costing.target_cost;
    const variancePct = (variance / costing.target_cost) * 100;

    // 3. Get org variance threshold
    const settings = await this.getOrgSettings(costing.org_id);
    const threshold = settings.cost_variance_auto_approve_pct;

    // 4. Auto-approve if variance below threshold
    if (Math.abs(variancePct) < threshold) {
      await db.query(
        `UPDATE npd_costing
         SET status = 'approved',
             submitted_at = NOW(),
             submitted_by_id = $1,
             approved_at = NOW(),
             auto_approved = true
         WHERE id = $2`,
        [userId, costingId]
      );

      // Send auto-approve email to NPD Lead
      await this.sendAutoApproveEmail(costing, userId);

      return { status: 'approved', auto_approved: true };
    }

    // 5. Otherwise, submit for manual Finance approval
    await db.query(
      `UPDATE npd_costing
       SET status = 'submitted',
           submitted_at = NOW(),
           submitted_by_id = $1
       WHERE id = $2`,
      [userId, costingId]
    );

    // Send submission email to Finance
    await this.sendSubmissionEmail(costing, variance, variancePct);

    return { status: 'submitted', auto_approved: false };
  }

  /**
   * Finance approves costing
   */
  static async approveCosting(costingId: number, userId: string, notes?: string): Promise<void> {
    // 1. Verify Finance role
    const hasFinanceRole = await this.userHasRole(userId, 'FINANCE');
    if (!hasFinanceRole) throw new Error('Finance role required');

    // 2. Fetch costing
    const costing = await this.getCostingById(costingId);
    if (!costing) throw new Error('Costing not found');
    if (costing.status !== 'submitted') throw new Error('Costing not submitted for approval');

    // 3. Update status to approved
    await db.query(
      `UPDATE npd_costing
       SET status = 'approved',
           approved_at = NOW(),
           approved_by_id = $1
       WHERE id = $2`,
      [userId, costingId]
    );

    // 4. Send approval email to NPD Lead
    await this.sendApprovalEmail(costing, userId, notes);
  }

  /**
   * Finance rejects costing
   */
  static async rejectCosting(costingId: number, userId: string, reason: string): Promise<void> {
    if (!reason || reason.trim().length === 0) {
      throw new Error('Rejection reason required');
    }

    // 1. Verify Finance role
    const hasFinanceRole = await this.userHasRole(userId, 'FINANCE');
    if (!hasFinanceRole) throw new Error('Finance role required');

    // 2. Fetch costing
    const costing = await this.getCostingById(costingId);
    if (!costing) throw new Error('Costing not found');
    if (costing.status !== 'submitted') throw new Error('Costing not submitted for approval');

    // 3. Update status to rejected
    await db.query(
      `UPDATE npd_costing
       SET status = 'rejected',
           rejected_at = NOW(),
           rejected_by_id = $1,
           rejection_reason = $2
       WHERE id = $3`,
      [userId, reason, costingId]
    );

    // 4. Send rejection email to NPD Lead
    await this.sendRejectionEmail(costing, userId, reason);
  }

  /**
   * Get pending approvals for Finance
   */
  static async getPendingApprovals(orgId: string): Promise<PendingApproval[]> {
    const result = await db.query(
      `SELECT
        c.id AS costing_id,
        p.id AS project_id,
        p.project_number,
        p.name AS project_name,
        f.formulation_number,
        c.target_cost,
        c.estimated_cost,
        (c.estimated_cost - c.target_cost) AS variance,
        ((c.estimated_cost - c.target_cost) / NULLIF(c.target_cost, 0)) * 100 AS variance_pct,
        c.submitted_at,
        u.id AS submitted_by_id,
        u.name AS submitted_by_name
       FROM npd_costing c
       JOIN npd_formulations f ON c.formulation_id = f.id
       JOIN npd_projects p ON f.project_id = p.id
       LEFT JOIN users u ON c.submitted_by_id = u.id
       WHERE c.org_id = $1
       AND c.status = 'submitted'
       ORDER BY c.submitted_at ASC`,
      [orgId]
    );

    return result.rows;
  }

  /**
   * Send submission email to Finance
   */
  private static async sendSubmissionEmail(
    costing: any,
    variance: number,
    variancePct: number
  ): Promise<void> {
    // Get all Finance users
    const financeUsers = await this.getUsersByRole(costing.org_id, 'FINANCE');

    for (const user of financeUsers) {
      await sendEmail({
        to: user.email,
        subject: `Costing Approval Required: ${costing.project_number}`,
        body: `
          NPD project ${costing.project_number} (${costing.project_name}) costing submitted for approval.

          Target Cost: $${costing.target_cost.toFixed(2)}
          Estimated Cost: $${costing.estimated_cost.toFixed(2)}
          Variance: $${variance.toFixed(2)} (${variancePct.toFixed(2)}%)

          Click here to review and approve: ${APP_URL}/npd/projects/${costing.project_id}/costing
        `,
        link: `${APP_URL}/npd/projects/${costing.project_id}/costing`,
      });
    }
  }

  /**
   * Send approval email to NPD Lead
   */
  private static async sendApprovalEmail(
    costing: any,
    approverUserId: string,
    notes?: string
  ): Promise<void> {
    const approver = await this.getUserById(approverUserId);

    await sendEmail({
      to: costing.owner_email,
      subject: `Costing Approved: ${costing.project_number}`,
      body: `
        Finance approved costing for ${costing.project_number}.
        You may proceed to handoff.

        Approved by: ${approver.name} (Finance)
        ${notes ? `Notes: ${notes}` : ''}

        Click here to view project: ${APP_URL}/npd/projects/${costing.project_id}
      `,
      link: `${APP_URL}/npd/projects/${costing.project_id}`,
    });
  }

  /**
   * Send rejection email to NPD Lead
   */
  private static async sendRejectionEmail(
    costing: any,
    rejecterUserId: string,
    reason: string
  ): Promise<void> {
    const rejecter = await this.getUserById(rejecterUserId);

    await sendEmail({
      to: costing.owner_email,
      subject: `Costing Rejected: ${costing.project_number}`,
      body: `
        Finance rejected costing for ${costing.project_number}.

        Reason: ${reason}

        Rejected by: ${rejecter.name} (Finance)

        Please update costing and resubmit: ${APP_URL}/npd/projects/${costing.project_id}/costing
      `,
      link: `${APP_URL}/npd/projects/${costing.project_id}/costing`,
    });
  }

  /**
   * Send auto-approve email to NPD Lead
   */
  private static async sendAutoApproveEmail(costing: any, userId: string): Promise<void> {
    await sendEmail({
      to: costing.owner_email,
      subject: `Costing Auto-Approved: ${costing.project_number}`,
      body: `
        Costing automatically approved for ${costing.project_number}.
        Variance is below the auto-approve threshold.

        You may proceed to handoff.

        Click here to view project: ${APP_URL}/npd/projects/${costing.project_id}
      `,
      link: `${APP_URL}/npd/projects/${costing.project_id}`,
    });
  }
}
```

### Frontend Components

```
components/npd/costing/
  CostingApprovalModal.tsx        -- Finance approval modal (variance analysis, approve/reject)
  CostingSubmitButton.tsx         -- NPD Lead submit button
  CostingApprovalBadge.tsx        -- Status badge (draft/submitted/approved/rejected)
  PendingApprovalsTable.tsx       -- Finance dashboard (pending approvals)
  CostingApprovalHistory.tsx      -- Approval history display
```

---

## Key Business Rules

1. **Auto-Approve Threshold**: Configurable per org, default 10%. Variance < threshold = auto-approve.
2. **Rejection Reason Mandatory**: Finance must provide reason when rejecting costing.
3. **Resubmission Allowed**: Rejected costing can be updated and resubmitted by NPD Lead.
4. **Finance Role Required**: Only users with FINANCE role can approve/reject.
5. **Email Notifications**: All Finance users notified on submission, NPD Lead notified on approval/rejection.
6. **Handoff Blocked**: Handoff wizard disabled until costing.status = 'approved'.
7. **Org Isolation**: RLS policies enforce costing approval within org only.
8. **Status Transitions**: draft → submitted → approved/rejected (rejected can revert to draft for resubmission).
9. **Auto-Approve Logging**: Auto-approved costing sets auto_approved = true, approved_by_id = null.
10. **Approval Dashboard**: Finance users see dedicated /npd/approvals page with pending submissions.

---

## Deliverables

### Database
- [ ] Migration: Add approval fields to npd_costing table
- [ ] Migration: Add variance threshold to npd_settings
- [ ] Indexes for pending approvals
- [ ] RLS policies for Finance approval

### API Routes
- [ ] `GET /api/npd/costing/:id/approval` - Get approval details
- [ ] `POST /api/npd/costing/:id/submit` - Submit for approval
- [ ] `POST /api/npd/costing/:id/approve` - Finance approves
- [ ] `POST /api/npd/costing/:id/reject` - Finance rejects
- [ ] `GET /api/npd/approvals` - Finance pending approvals dashboard

### Service Layer
- [ ] `NPDCostingApprovalService.submitCosting()` - Submit with auto-approve logic
- [ ] `NPDCostingApprovalService.approveCosting()` - Finance approve
- [ ] `NPDCostingApprovalService.rejectCosting()` - Finance reject
- [ ] `NPDCostingApprovalService.getPendingApprovals()` - Fetch pending
- [ ] Email notification functions

### Frontend
- [ ] Submit button on costing page
- [ ] Approval modal for Finance
- [ ] Pending approvals dashboard (/npd/approvals)
- [ ] Approval status badge
- [ ] Approval history display
- [ ] Handoff wizard approval check

### Tests
- [ ] Unit tests: NPDCostingApprovalService methods (>80% coverage)
- [ ] Integration tests: All API endpoints
- [ ] E2E: Full approval workflow (submit → approve)
- [ ] E2E: Rejection and resubmission
- [ ] E2E: Auto-approve logic
- [ ] Performance tests: Submit <500ms, approve <300ms

---

## Definition of Done

### Database
- [ ] Approval fields added to npd_costing table
- [ ] Variance threshold added to npd_settings
- [ ] RLS policies enforce Finance role permissions

### API
- [ ] All endpoints return correct data
- [ ] Auto-approve logic works correctly
- [ ] Rejection requires reason
- [ ] Permission checks enforce Finance role
- [ ] Response times: submit <500ms, approve <300ms

### Service
- [ ] Submit costing with auto-approve
- [ ] Finance approve/reject
- [ ] Email notifications sent on all events
- [ ] Variance calculation correct

### Frontend
- [ ] Submit button updates status
- [ ] Approval modal displays variance analysis
- [ ] Pending approvals dashboard functional
- [ ] Approval badge shows correct status
- [ ] Handoff blocked until approved

### Testing
- [ ] Unit tests: >80% coverage
- [ ] Integration tests: All endpoints covered
- [ ] E2E tests: Full workflow verified
- [ ] Performance tests: Response times verified

---

## Risk Assessment

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Email delivery failure | MEDIUM | LOW | Retry mechanism, in-app notifications as backup |
| Auto-approve logic error | HIGH | LOW | Comprehensive unit tests, manual Finance review option |
| Finance role missing | MEDIUM | LOW | Setup wizard ensures Finance role created on org setup |
| Approval bottleneck (too many pending) | MEDIUM | MEDIUM | SLA tracking (Phase 4), auto-approve for low variance |
| Variance calculation bug | HIGH | LOW | Unit tests, manual variance display in approval modal |

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2026-01-15 | Initial story creation for Finance Approval Workflow | ARCHITECT-AGENT |

---

**Document Status**: Ready for Implementation
**Created**: 2026-01-15
**Lines**: ~970
**Complexity**: M (Medium)
**Phase**: 3 (Enterprise Features)
