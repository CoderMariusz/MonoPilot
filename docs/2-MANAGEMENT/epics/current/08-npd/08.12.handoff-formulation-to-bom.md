# 08.12 - Handoff: Formulation → BOM

**Priority**: P0 (Critical - Handoff Blocker)
**Story Points**: M (Medium)
**Type**: backend
**Estimate**: 3-4 days

**State**: ready
**Primary PRD**: `docs/1-BASELINE/product/modules/npd.md` (FR-NPD-41, FR-NPD-58, FR-NPD-59)
**Dependencies**: 08.2, 08.4, 02.2, 01.1

---

## Goal

Convert an approved and locked NPD formulation into a production BOM by mapping formulation_items to bom_items 1:1, linking the BOM to the source formulation, and optionally creating a new Product or updating an existing Product with a new BOM version. This establishes full traceability from NPD to Production.

---

## User Story

As an **NPD Lead**, I want to **convert my approved formulation into a production BOM** so that **the recipe I developed becomes executable in production with full traceability back to NPD**.

As a **Production Manager**, I want to **see which BOMs originated from NPD projects** so that **I can reference the development history and compliance documentation**.

---

## Scope

**In scope (this story)**
- POST /api/npd/projects/:projectId/handoff/create-bom - Convert formulation to BOM
- POST /api/npd/projects/:projectId/handoff/create-product - Create new product OR update existing
- Map formulation_items → bom_items (1:1, same qty, uom, percentage)
- Set BOM.source = "npd" and BOM.npd_formulation_id for traceability
- Set Product.npd_origin = true and Product.npd_project_id for lineage
- Validate: formulation locked, all items have valid product_id
- Auto-generate BOM number format: BOM-{PRODUCT_CODE}-v{VERSION}
- Support effective_from and effective_to dates for BOM
- Copy formulation notes to BOM description
- Transactional execution (rollback on failure)

**Out of scope (this story)**
- Pilot WO creation (08.13)
- Allergen transfer from formulation to BOM (08.5 integration - Phase 2)
- Multi-formulation handoff (Phase 3)
- BOM approval workflow (handled by existing BOM module)
- Cost data transfer (08.7 handles costing separately)

---

## Dependencies

### Hard Dependencies
| Story | Provides | Status |
|-------|----------|--------|
| 01.1 | Org Context + RLS | Ready |
| 02.2 | BOMs CRUD, boms table, bom_items table | Ready |
| 02.1 | Products CRUD, products table | Ready |
| 08.2 | NPD Projects CRUD, npd_projects table | Ready |
| 08.4 | Formulations CRUD, npd_formulations table | Ready |

### Soft Dependencies
| Story | Provides | Impact if Missing |
|-------|----------|-------------------|
| 08.5 | Allergen Aggregation | Allergens not transferred to BOM (manual entry required) |
| 08.7 | Formulation Costing | No cost linkage to BOM (minor) |

---

## Acceptance Criteria (Given/When/Then)

### AC-1: Convert Formulation to BOM (New Product)

```gherkin
Scenario: Convert formulation to BOM with new product
  Given NPD project NPD-001 with formulation v2.0 status = 'locked'
  And formulation has 15 items (ingredients)
  When POST /api/npd/projects/:id/handoff/create-bom with:
    | Field | Value |
    | product_action | create |
    | product_code | PROD-NPD-001 |
    | product_name | Premium Beef Burger |
    | product_type | finished_good |
    | uom | kg |
    | formulation_id | 123 |
    | bom_effective_from | 2025-01-01 |
  Then new product created with:
    | product_code | PROD-NPD-001 |
    | npd_origin | true |
    | npd_project_id | NPD-001 ID |
    | source | npd |
  And new BOM created with:
    | bom_number | BOM-PROD-NPD-001-v1.0 |
    | product_id | PROD-NPD-001 ID |
    | status | draft |
    | source | npd |
    | npd_formulation_id | 123 |
    | effective_from | 2025-01-01 |
  And 15 bom_items created (copied from formulation_items)
  And each bom_item has:
    | product_id | Same as formulation_item.product_id |
    | quantity | Same as formulation_item.quantity |
    | uom | Same as formulation_item.uom |
    | percentage | Same as formulation_item.percentage |
    | item_type | input (default) |
    | notes | Copied from formulation_item.notes |
  And response 201 with created BOM details
```

```gherkin
Scenario: Convert formulation to BOM (Update Existing Product)
  Given existing product PROD-001 with current BOM v1.2
  And NPD project NPD-002 with formulation v1.0 locked
  When POST /api/npd/projects/:id/handoff/create-bom with:
    | product_action | update |
    | product_id | PROD-001 ID |
    | formulation_id | 456 |
    | bom_effective_from | 2025-02-01 |
  Then no new product created (existing product used)
  And product updated with:
    | npd_project_id | NPD-002 ID (latest NPD project) |
    | source | npd (updated) |
  And new BOM created with:
    | bom_number | BOM-PROD-001-v1.3 (next version) |
    | product_id | PROD-001 ID (existing) |
    | npd_formulation_id | 456 |
    | effective_from | 2025-02-01 |
  And bom_items copied from formulation_items
```

### AC-2: BOM Number Auto-Generation

```gherkin
Scenario: Generate BOM number for new product
  Given product_code = "PROD-NPD-001"
  And no existing BOMs for this product
  When creating BOM
  Then bom_number = "BOM-PROD-NPD-001-v1.0"

Scenario: Generate BOM number for existing product (new version)
  Given product PROD-001 has existing BOM "BOM-PROD-001-v1.2"
  When creating new BOM for same product
  Then bom_number = "BOM-PROD-001-v1.3" (auto-incremented)

Scenario: BOM number uniqueness
  Given BOM "BOM-PROD-001-v1.0" exists
  When attempting to create another with same number
  Then system returns 409 Conflict error
  And rollback transaction
```

### AC-3: Formulation Item to BOM Item Mapping

```gherkin
Scenario: Map formulation items to BOM items 1:1
  Given formulation with items:
    | Product | Quantity | UoM | Percentage | Notes |
    | Beef Mince | 50 | kg | 50.0 | 80/20 blend |
    | Onion | 10 | kg | 10.0 | Diced |
    | Breadcrumbs | 15 | kg | 15.0 | Panko style |
  When converting to BOM
  Then bom_items created with exact copy:
    | Product | Quantity | UoM | Percentage | Item Type | Notes |
    | Beef Mince | 50 | kg | 50.0 | input | 80/20 blend |
    | Onion | 10 | kg | 10.0 | input | Diced |
    | Breadcrumbs | 15 | kg | 15.0 | input | Panko style |
  And all percentages sum to 100.0

Scenario: Validate formulation items have valid product_id
  Given formulation with item.product_id = 999 (does not exist)
  When attempting conversion
  Then error "Invalid product ID in formulation items"
  And transaction rolled back
```

### AC-4: Validation - Formulation Locked

```gherkin
Scenario: Cannot convert unlocked formulation
  Given formulation status = 'draft'
  When attempting conversion
  Then error 400 "Formulation must be locked before conversion"
  And no BOM created

Scenario: Cannot convert approved (not locked) formulation
  Given formulation status = 'approved'
  When attempting conversion
  Then error 400 "Formulation must be locked. Approve and lock first."
  And no BOM created

Scenario: Convert locked formulation
  Given formulation status = 'locked'
  When converting to BOM
  Then BOM created successfully
```

### AC-5: Validation - Product Code Uniqueness

```gherkin
Scenario: Duplicate product code error
  Given product "PROD-NPD-001" already exists
  When creating BOM with product_action = 'create' and product_code = "PROD-NPD-001"
  Then error 409 "Product code PROD-NPD-001 already exists"
  And transaction rolled back
  And no BOM or product created

Scenario: Product code validation
  Given product_code = "" (empty)
  When creating BOM
  Then error 400 "Product code is required"

Scenario: Product code format validation
  Given product_code = "PROD NPD 001" (spaces)
  When creating BOM
  Then error 400 "Product code must not contain spaces"
```

### AC-6: Effective Date Validation

```gherkin
Scenario: Effective date range validation
  Given bom_effective_from = 2025-01-01
  And bom_effective_to = 2024-12-31 (before effective_from)
  When creating BOM
  Then error 400 "Effective To must be after Effective From"

Scenario: Effective date optional
  Given bom_effective_from = 2025-01-01
  And bom_effective_to = null
  When creating BOM
  Then BOM created with effective_to = null (no end date)

Scenario: Both dates optional
  Given bom_effective_from = null
  And bom_effective_to = null
  When creating BOM
  Then BOM created (dates optional for draft BOMs)
```

### AC-7: Traceability Fields

```gherkin
Scenario: BOM traceability to NPD
  Given formulation ID = 123 from NPD project NPD-001
  When creating BOM
  Then BOM has:
    | npd_formulation_id | 123 |
    | source | npd |
  And can query: "SELECT * FROM boms WHERE npd_formulation_id = 123"
  And result shows full lineage back to NPD

Scenario: Product traceability to NPD
  Given NPD project ID = 456
  When creating product from NPD handoff
  Then product has:
    | npd_project_id | 456 |
    | npd_origin | true |
    | source | npd |
  And can query: "SELECT * FROM products WHERE npd_origin = true"
  And result shows all NPD-originated products
```

### AC-8: Notes and Description Transfer

```gherkin
Scenario: Copy formulation notes to BOM description
  Given formulation.notes = "Premium burger blend with special seasoning"
  When creating BOM
  Then BOM.description = "Premium burger blend with special seasoning"

Scenario: Copy formulation item notes to BOM item notes
  Given formulation_item.notes = "80/20 lean-to-fat ratio"
  When creating bom_items
  Then bom_item.notes = "80/20 lean-to-fat ratio"
```

### AC-9: Transactional Execution

```gherkin
Scenario: Rollback on product creation failure
  Given valid formulation
  And product_code = "PROD-001" (already exists)
  When executing handoff
  Then product creation fails
  And transaction rolls back
  And no BOM created
  And no bom_items created
  And formulation remains locked
  And error returned to user

Scenario: Rollback on BOM creation failure
  Given product created successfully
  And BOM number generation fails (race condition)
  When executing handoff
  Then BOM creation fails
  And transaction rolls back
  And product creation reverted (if new product)
  And error returned to user

Scenario: Rollback on BOM item copy failure
  Given product and BOM created successfully
  And formulation_item.product_id = 999 (invalid)
  When copying bom_items
  Then bom_item creation fails
  And transaction rolls back
  And product and BOM creation reverted
  And error returned to user
```

### AC-10: Permission Enforcement

```gherkin
Scenario: NPD Lead permissions
  Given user has NPD_LEAD role
  When creating BOM from formulation
  Then operation succeeds
  And audit log records user

Scenario: R&D permissions (no handoff)
  Given user has R&D role (not NPD_LEAD)
  When attempting BOM conversion
  Then error 403 "Only NPD Lead can execute handoff"
  And no BOM created

Scenario: Production Manager permissions (read-only)
  Given user has PRODUCTION_MANAGER role
  When attempting BOM conversion
  Then error 403 "Insufficient permissions"
```

### AC-11: RLS Policy Enforcement

```gherkin
Scenario: Org isolation on BOM creation
  Given user from Org A with formulation in Org A
  When creating BOM
  Then BOM.org_id = Org A (automatic)
  And product.org_id = Org A
  And bom_items.org_id = Org A (if org_id column exists)

Scenario: Cross-tenant access blocked
  Given formulation belongs to Org B
  And user from Org A
  When attempting BOM conversion
  Then error 404 "Formulation not found"
  And no BOM created
```

### AC-12: API Response Format

```gherkin
Scenario: Success response structure
  Given valid BOM creation request
  When POST /api/npd/projects/:id/handoff/create-bom
  Then response 201 Created with:
    {
      "success": true,
      "product": {
        "id": "uuid",
        "product_code": "PROD-NPD-001",
        "product_name": "Premium Beef Burger",
        "npd_origin": true,
        "npd_project_id": "npd-project-id"
      },
      "bom": {
        "id": "uuid",
        "bom_number": "BOM-PROD-NPD-001-v1.0",
        "product_id": "product-uuid",
        "npd_formulation_id": 123,
        "source": "npd",
        "effective_from": "2025-01-01",
        "items_count": 15,
        "status": "draft"
      },
      "items_created": 15,
      "executed_at": "2025-01-15T14:30:00Z"
    }
```

### AC-13: Performance Requirements

```gherkin
Scenario: BOM creation performance
  Given formulation with 50 items
  When converting to BOM
  Then operation completes < 3 seconds (p95)
  And uses batch insert for bom_items

Scenario: Large formulation handling
  Given formulation with 100 items (max)
  When converting to BOM
  Then operation completes < 5 seconds
  And no timeout error
```

---

## Implementation Notes

### API Endpoints

```typescript
// POST /api/npd/projects/:projectId/handoff/create-bom
interface CreateBOMFromFormulationRequest {
  // Product action: create new or update existing
  product_action: 'create' | 'update';

  // For creating new product
  product_code?: string; // required if product_action = 'create'
  product_name?: string; // required if product_action = 'create'
  product_type?: string; // default: 'finished_good'
  product_description?: string;
  product_uom?: string; // required if product_action = 'create'

  // For updating existing product
  product_id?: string; // required if product_action = 'update'

  // BOM configuration
  formulation_id: number; // required
  bom_effective_from?: string; // ISO date, optional
  bom_effective_to?: string; // ISO date, optional
  bom_notes?: string; // optional override of formulation.notes
}

interface CreateBOMFromFormulationResponse {
  success: boolean;
  product: {
    id: string;
    product_code: string;
    product_name: string;
    npd_origin: boolean;
    npd_project_id: string;
    source: string;
    created_at: string;
  };
  bom: {
    id: string;
    bom_number: string;
    product_id: string;
    npd_formulation_id: number;
    source: string;
    status: string;
    effective_from: string | null;
    effective_to: string | null;
    items_count: number;
    description: string;
    created_at: string;
  };
  items_created: number;
  executed_at: string;
}

interface BOMCreationErrorResponse {
  success: false;
  error: string;
  error_code: string; // 'FORMULATION_NOT_LOCKED', 'DUPLICATE_PRODUCT_CODE', etc.
  rollback_completed: boolean;
  step_failed: string; // 'create_product', 'create_bom', 'copy_items'
}
```

### Service Layer

```typescript
// lib/services/npd-handoff-service.ts

export class NPDHandoffService {
  /**
   * Convert formulation to BOM with product creation/update
   */
  static async createBOMFromFormulation(
    projectId: number,
    data: CreateBOMFromFormulationRequest,
    userId: string
  ): Promise<CreateBOMFromFormulationResponse> {
    const client = await db.connect();

    try {
      await client.query('BEGIN');

      // Step 1: Validate formulation is locked
      const formulation = await this.validateFormulation(client, data.formulation_id, projectId);

      // Step 2: Create or update product
      let product: Product;
      if (data.product_action === 'create') {
        product = await this.createProduct(client, {
          product_code: data.product_code!,
          product_name: data.product_name!,
          product_type: data.product_type || 'finished_good',
          description: data.product_description || formulation.notes,
          uom: data.product_uom!,
          npd_project_id: projectId,
          npd_origin: true,
          source: 'npd',
        }, userId);
      } else {
        product = await this.updateProduct(client, data.product_id!, {
          npd_project_id: projectId,
          source: 'npd',
        }, userId);
      }

      // Step 3: Generate BOM number
      const bomNumber = await this.generateBOMNumber(client, product.product_code);

      // Step 4: Create BOM
      const bom = await this.createBOM(client, {
        bom_number: bomNumber,
        product_id: product.id,
        npd_formulation_id: data.formulation_id,
        source: 'npd',
        status: 'draft',
        effective_from: data.bom_effective_from,
        effective_to: data.bom_effective_to,
        description: data.bom_notes || formulation.notes,
      }, userId);

      // Step 5: Copy formulation items to bom_items (batch insert)
      const itemsCreated = await this.copyFormulationItemsToBOM(
        client,
        data.formulation_id,
        bom.id
      );

      await client.query('COMMIT');

      return {
        success: true,
        product: product,
        bom: {
          ...bom,
          items_count: itemsCreated,
        },
        items_created: itemsCreated,
        executed_at: new Date().toISOString(),
      };

    } catch (error) {
      await client.query('ROLLBACK');
      throw new BOMCreationError('BOM creation failed', error);
    } finally {
      client.release();
    }
  }

  /**
   * Validate formulation is locked and belongs to project
   */
  private static async validateFormulation(
    client: PoolClient,
    formulationId: number,
    projectId: number
  ): Promise<Formulation> {
    const result = await client.query(
      `SELECT * FROM npd_formulations
       WHERE id = $1 AND npd_project_id = $2`,
      [formulationId, projectId]
    );

    if (result.rows.length === 0) {
      throw new Error('Formulation not found or does not belong to project');
    }

    const formulation = result.rows[0];

    if (formulation.status !== 'locked') {
      throw new Error('Formulation must be locked before conversion');
    }

    return formulation;
  }

  /**
   * Create new product
   */
  private static async createProduct(
    client: PoolClient,
    data: ProductCreateData,
    userId: string
  ): Promise<Product> {
    const result = await client.query(
      `INSERT INTO products (
        org_id, product_code, product_name, product_type,
        description, uom, npd_project_id, npd_origin, source,
        status, created_by
      )
      VALUES (
        (SELECT org_id FROM users WHERE id = $1),
        $2, $3, $4, $5, $6, $7, $8, $9, 'draft', $1
      )
      RETURNING *`,
      [
        userId, data.product_code, data.product_name, data.product_type,
        data.description, data.uom, data.npd_project_id, data.npd_origin, data.source
      ]
    );

    return result.rows[0];
  }

  /**
   * Update existing product with NPD linkage
   */
  private static async updateProduct(
    client: PoolClient,
    productId: string,
    data: ProductUpdateData,
    userId: string
  ): Promise<Product> {
    const result = await client.query(
      `UPDATE products
       SET npd_project_id = $1, source = $2, updated_by = $3, updated_at = NOW()
       WHERE id = $4
       RETURNING *`,
      [data.npd_project_id, data.source, userId, productId]
    );

    return result.rows[0];
  }

  /**
   * Generate next BOM number for product
   * Format: BOM-{PRODUCT_CODE}-v{VERSION}
   */
  private static async generateBOMNumber(
    client: PoolClient,
    productCode: string
  ): Promise<string> {
    const result = await client.query(
      `SELECT bom_number FROM boms
       WHERE bom_number LIKE $1
       ORDER BY bom_number DESC
       LIMIT 1`,
      [`BOM-${productCode}-v%`]
    );

    let version = 1.0;

    if (result.rows.length > 0) {
      const lastBOMNumber = result.rows[0].bom_number;
      const match = lastBOMNumber.match(/v(\d+\.\d+)$/);
      if (match) {
        version = parseFloat(match[1]) + 0.1;
      }
    }

    return `BOM-${productCode}-v${version.toFixed(1)}`;
  }

  /**
   * Create BOM record
   */
  private static async createBOM(
    client: PoolClient,
    data: BOMCreateData,
    userId: string
  ): Promise<BOM> {
    const result = await client.query(
      `INSERT INTO boms (
        org_id, bom_number, product_id, npd_formulation_id,
        source, status, effective_from, effective_to,
        description, created_by
      )
      VALUES (
        (SELECT org_id FROM users WHERE id = $1),
        $2, $3, $4, $5, $6, $7, $8, $9, $1
      )
      RETURNING *`,
      [
        userId, data.bom_number, data.product_id, data.npd_formulation_id,
        data.source, data.status, data.effective_from, data.effective_to, data.description
      ]
    );

    return result.rows[0];
  }

  /**
   * Copy formulation items to BOM items (batch insert)
   */
  private static async copyFormulationItemsToBOM(
    client: PoolClient,
    formulationId: number,
    bomId: string
  ): Promise<number> {
    const result = await client.query(
      `INSERT INTO bom_items (
        bom_id, product_id, quantity, uom, percentage, item_type, notes
      )
      SELECT
        $1, product_id, quantity, uom, percentage, 'input', notes
      FROM npd_formulation_items
      WHERE formulation_id = $2
      RETURNING id`,
      [bomId, formulationId]
    );

    return result.rowCount || 0;
  }
}

class BOMCreationError extends Error {
  constructor(message: string, public originalError: any) {
    super(message);
    this.name = 'BOMCreationError';
  }
}
```

### Validation (Zod)

```typescript
import { z } from 'zod';

export const createBOMFromFormulationSchema = z.object({
  product_action: z.enum(['create', 'update']),

  // Product creation fields
  product_code: z.string().min(1).max(50).optional(),
  product_name: z.string().min(1).max(200).optional(),
  product_type: z.string().min(1).max(50).default('finished_good'),
  product_description: z.string().max(2000).optional(),
  product_uom: z.string().min(1).max(20).optional(),

  // Product update field
  product_id: z.string().uuid().optional(),

  // BOM configuration
  formulation_id: z.number().int().positive('Invalid formulation ID'),
  bom_effective_from: z.string().refine((val) => !val || !isNaN(Date.parse(val)), "Invalid date").optional(),
  bom_effective_to: z.string().refine((val) => !val || !isNaN(Date.parse(val)), "Invalid date").optional(),
  bom_notes: z.string().max(2000).optional(),
}).refine((data) => {
  if (data.product_action === 'create') {
    return data.product_code && data.product_name && data.product_uom;
  }
  if (data.product_action === 'update') {
    return data.product_id;
  }
  return false;
}, {
  message: "Missing required fields for product action",
  path: ["product_action"],
}).refine((data) => {
  if (data.bom_effective_to && data.bom_effective_from) {
    return new Date(data.bom_effective_to) >= new Date(data.bom_effective_from);
  }
  return true;
}, {
  message: "Effective To must be after Effective From",
  path: ["bom_effective_to"],
});
```

### Database Changes

```sql
-- Ensure foreign key columns exist in existing tables
-- (These should already exist from stories 02.2, 08.2, 08.4)

-- Products table (add NPD linkage if not exists)
ALTER TABLE products
ADD COLUMN IF NOT EXISTS npd_project_id INTEGER REFERENCES npd_projects(id);

ALTER TABLE products
ADD COLUMN IF NOT EXISTS npd_origin BOOLEAN DEFAULT false;

ALTER TABLE products
ADD COLUMN IF NOT EXISTS source VARCHAR(30);

CREATE INDEX IF NOT EXISTS idx_products_npd_project ON products(npd_project_id)
WHERE npd_project_id IS NOT NULL;

CREATE INDEX IF NOT EXISTS idx_products_npd_origin ON products(npd_origin)
WHERE npd_origin = true;

-- BOMs table (add NPD formulation linkage if not exists)
ALTER TABLE boms
ADD COLUMN IF NOT EXISTS npd_formulation_id INTEGER REFERENCES npd_formulations(id);

ALTER TABLE boms
ADD COLUMN IF NOT EXISTS source VARCHAR(30);

CREATE INDEX IF NOT EXISTS idx_boms_npd_formulation ON boms(npd_formulation_id)
WHERE npd_formulation_id IS NOT NULL;

CREATE INDEX IF NOT EXISTS idx_boms_source ON boms(source)
WHERE source = 'npd';

-- Add comments for traceability
COMMENT ON COLUMN products.npd_project_id IS 'NPD project that originated this product (handoff traceability)';
COMMENT ON COLUMN products.npd_origin IS 'True if product originated from NPD module';
COMMENT ON COLUMN products.source IS 'Source of product creation: npd, manual, import, etc.';
COMMENT ON COLUMN boms.npd_formulation_id IS 'NPD formulation that was converted to this BOM (handoff traceability)';
COMMENT ON COLUMN boms.source IS 'Source of BOM creation: npd, manual, clone, etc.';
```

---

## Deliverables

### Database
- [ ] Migration: Add npd_project_id, npd_origin, source to products table
- [ ] Migration: Add npd_formulation_id, source to boms table
- [ ] Indexes for NPD linkage columns
- [ ] Comments on traceability columns

### API Routes
- [ ] POST /api/npd/projects/:projectId/handoff/create-bom
- [ ] POST /api/npd/projects/:projectId/handoff/create-product (internal, called by create-bom)

### Service Layer
- [ ] NPDHandoffService.createBOMFromFormulation()
- [ ] NPDHandoffService.validateFormulation()
- [ ] NPDHandoffService.createProduct()
- [ ] NPDHandoffService.updateProduct()
- [ ] NPDHandoffService.generateBOMNumber()
- [ ] NPDHandoffService.createBOM()
- [ ] NPDHandoffService.copyFormulationItemsToBOM()

### Validation
- [ ] createBOMFromFormulationSchema (Zod)

### Tests
- [ ] Unit test: NPDHandoffService.createBOMFromFormulation()
- [ ] Unit test: NPDHandoffService.generateBOMNumber() (version increment)
- [ ] Unit test: NPDHandoffService.copyFormulationItemsToBOM() (batch insert)
- [ ] Integration test: POST /api/npd/projects/:id/handoff/create-bom (success)
- [ ] Integration test: Rollback on product creation failure
- [ ] Integration test: Rollback on BOM creation failure
- [ ] Integration test: Validation errors (formulation not locked, duplicate product code)
- [ ] E2E test: Full formulation → BOM conversion with new product
- [ ] E2E test: Update existing product with new BOM version

---

## Definition of Done

- [ ] API endpoint creates BOM from formulation successfully
- [ ] Product creation (new) works with correct NPD linkage
- [ ] Product update (existing) works with NPD linkage
- [ ] BOM number auto-generation increments correctly
- [ ] Formulation items copied 1:1 to bom_items (batch insert)
- [ ] Formulation locked validation enforced
- [ ] Product code uniqueness validation enforced
- [ ] Effective date range validation enforced
- [ ] Transactional execution with rollback on failure
- [ ] Traceability fields (npd_formulation_id, npd_project_id, source) populated
- [ ] Notes and description transferred from formulation
- [ ] Permission checks enforce NPD_LEAD role
- [ ] RLS policies enforce org isolation
- [ ] Operation completes < 3 seconds for 50-item formulation
- [ ] Unit tests achieve >80% coverage on NPDHandoffService
- [ ] Integration tests cover all success and failure paths
- [ ] E2E tests verify full conversion workflow

---

## Risk Assessment

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Transaction rollback failure (data inconsistency) | CRITICAL | LOW | Comprehensive transaction tests, database constraints |
| BOM number collision (race condition) | MEDIUM | MEDIUM | Use database-level sequence or UNIQUE constraint, retry on collision |
| Formulation items reference invalid products | HIGH | LOW | Validate all product_ids before batch insert, fail fast |
| Large formulation performance (100+ items) | MEDIUM | LOW | Batch insert optimization, query performance tuning |
| Product code format inconsistency | LOW | MEDIUM | Strict validation schema, clear error messages |
| Allergen data loss (08.5 not available) | LOW | HIGH | Graceful degradation, manual allergen entry via BOM module |

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2026-01-15 | Initial version - Formulation to BOM conversion | ARCHITECT-AGENT |

---

**Document Status**: Ready for Implementation
**Created**: 2026-01-15
**Lines**: ~950
**Complexity**: M (Medium)
**Phase**: 2 (Handoff Integration)
