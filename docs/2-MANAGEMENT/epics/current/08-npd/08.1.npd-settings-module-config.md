# 08.1 - NPD Settings & Module Config

**Story ID:** 08.1
**Epic:** 08 - NPD
**Phase:** 1 (MVP)
**Complexity:** S (Small)
**Estimate:** 1-2 days
**Type:** Backend
**State:** ready

**Primary PRD:** `docs/1-BASELINE/product/modules/npd.md` (Section 1, FR-NPD-01)

## PRD References

| FR ID | Requirement | Priority | Phase | Covered |
|-------|-------------|----------|-------|---------|
| FR-NPD-01 | NPD module configuration and settings | Must | 1 | Yes |

## User Story

**As an** administrator,
**I want** to configure NPD module settings for my organization,
**So that** I can enable NPD functionality and control how it operates (NPD-only mode, pilot WOs, costing thresholds, compliance requirements).

**As a** system administrator,
**I want** to toggle NPD module activation,
**So that** only organizations paying for the premium NPD add-on can access NPD features.

## Goal

Implement configuration table and API endpoints for NPD module settings. Enable per-organization activation of NPD functionality with granular control over:
- Module enablement (feature flag)
- NPD-only mode (R&D consultancies without production)
- Pilot Work Order settings
- Costing variance thresholds (warning/blocker)
- Compliance document requirements
- Formulation versioning limits
- Event retention policies

## Scope

**In scope:**
- `npd_settings` table with org-level configuration
- Module activation toggle (`enable_npd_module`)
- NPD-only mode toggle (`npd_only_mode`)
- Pilot WO settings (enable toggle, default routing)
- Costing thresholds (warning 20%, blocker 50%)
- Compliance document requirements toggle
- Max formulation versions (default 10)
- Event retention days (default 90)
- GET/PUT API endpoints for settings
- RLS policies for multi-tenancy
- Zod validation schemas
- Default settings on org creation

**Out of scope:**
- NPD module UI/dashboard (Story 08.2)
- Project creation (Story 08.3)
- Formulation management (Story 08.4)
- Gate checklists (Story 08.5)
- Stage-Gate workflow (Story 08.6)
- User role permissions for NPD roles (handled in existing role system)

## Dependencies

| Story | Requirement | Status |
|-------|-------------|--------|
| 01.1 | Org Context + Base RLS | Required - provides org_id context |
| 02.3 | Routings (default_pilot_routing FK) | Optional - soft dependency |

## Acceptance Criteria (Given/When/Then)

### Module Activation (FR-NPD-01.1)

#### Enable NPD Module
- GIVEN admin creates organization, WHEN org created, THEN `npd_settings` record auto-created with `enable_npd_module = false`.
- GIVEN admin with paid NPD license, WHEN they toggle `enable_npd_module = true`, THEN NPD module becomes accessible.
- GIVEN free-tier organization, WHEN attempting to enable NPD, THEN system blocks action with "NPD is a premium add-on" message.
- GIVEN NPD module disabled, WHEN user navigates to /npd/*, THEN redirect to 403 Forbidden with "Module not enabled" message.

#### NPD-Only Mode
- GIVEN R&D consultancy (no production module), WHEN admin enables `npd_only_mode = true`, THEN NPD operates standalone.
- GIVEN NPD-only mode enabled, WHEN handoff wizard runs, THEN export to PDF/Excel option displays (no production records created).
- GIVEN NPD-only mode disabled (integrated), WHEN handoff wizard runs, THEN creates Product + BOM + Pilot WO in production tables.

### Pilot WO Settings (FR-NPD-01.2)

#### Enable Pilot WOs
- GIVEN `enable_pilot_wo = true`, WHEN handoff wizard runs, THEN offers to create pilot WO.
- GIVEN `enable_pilot_wo = false`, WHEN handoff wizard runs, THEN skips pilot WO creation step.
- GIVEN pilot WO enabled, WHEN pilot WO created, THEN WO marked as `type = 'pilot'` and links to `npd_project_id`.

#### Default Pilot Routing
- GIVEN admin sets `default_pilot_routing` to Routing X, WHEN pilot WO created, THEN Routing X auto-selected.
- GIVEN `default_pilot_routing = null`, WHEN pilot WO created, THEN user manually selects routing.
- GIVEN default routing deleted, WHEN pilot WO created, THEN fallback to manual selection.

### Costing Settings (FR-NPD-01.3)

#### Variance Thresholds
- GIVEN `cost_variance_warning_pct = 20`, WHEN actual cost exceeds target by 20%, THEN yellow warning displays in costing section.
- GIVEN `cost_variance_blocker_pct = 50`, WHEN actual cost exceeds target by 50%, THEN red blocker displays and handoff wizard blocked.
- GIVEN variance = 25% (warning level), WHEN Finance reviews, THEN can approve with override.
- GIVEN variance = 60% (blocker level), WHEN handoff attempted, THEN validation fails with "Cost variance exceeds blocker threshold (50%)".

#### Costing Approval
- GIVEN `require_costing_approval = true`, WHEN handoff validation runs, THEN checks if Finance approved costing.
- GIVEN `require_costing_approval = false`, WHEN handoff validation runs, THEN skips costing approval check.

### Compliance Settings (FR-NPD-01.4)

#### Required Documents for Handoff
- GIVEN `require_compliance_docs = true`, WHEN handoff validation runs, THEN checks for HACCP plan, label proof, allergen declaration.
- GIVEN `require_compliance_docs = false`, WHEN handoff validation runs, THEN skips document check.
- GIVEN compliance required and docs missing, WHEN handoff attempted, THEN validation fails with "Missing required compliance documents".

### Formulation Versioning (FR-NPD-01.5)

#### Max Versions Limit
- GIVEN `max_formulation_versions = 10`, WHEN creating 11th version, THEN error "Maximum 10 versions allowed per project" displays.
- GIVEN admin increases limit to 20, WHEN creating 11th version, THEN version created successfully.

### Event Retention (FR-NPD-01.6)

#### Retention Policy
- GIVEN `event_retention_days = 90`, WHEN scheduled job runs daily, THEN deletes events older than 90 days.
- GIVEN admin sets retention to 180 days, WHEN job runs, THEN deletes events older than 180 days.
- GIVEN event_retention_days = 0, WHEN job runs, THEN skips deletion (infinite retention).

### Settings API (FR-NPD-01.7)

#### GET /api/npd/settings
- GIVEN authenticated user, WHEN GET /api/npd/settings, THEN returns org's NPD settings.
- GIVEN user from Org A, WHEN requesting settings, THEN only Org A settings returned (RLS).
- GIVEN NPD settings not yet created, WHEN GET /api/npd/settings, THEN creates defaults and returns.

#### PUT /api/npd/settings
- GIVEN admin updates `cost_variance_warning_pct = 25`, WHEN PUT /api/npd/settings, THEN setting saved and returns updated settings.
- GIVEN non-admin user, WHEN attempting PUT /api/npd/settings, THEN 403 Forbidden returns.
- GIVEN invalid data (e.g., `cost_variance_warning_pct = -10`), WHEN PUT, THEN Zod validation fails with error details.

### Multi-tenancy (FR-NPD-01.8)

- GIVEN User A from Org A, WHEN GET /api/npd/settings, THEN only Org A settings returned.
- GIVEN User A from Org A, WHEN attempting to update Org B settings, THEN 404 Not Found returns.
- GIVEN `npd_settings` table, WHEN queried, THEN RLS enforces org_id isolation.

## Technical Specification

### Database Schema

#### npd_settings table

```sql
CREATE TABLE npd_settings (
  id SERIAL PRIMARY KEY,
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,

  -- Module activation
  enable_npd_module BOOLEAN DEFAULT false NOT NULL,
  npd_only_mode BOOLEAN DEFAULT false NOT NULL,

  -- Pilot WO settings
  enable_pilot_wo BOOLEAN DEFAULT true NOT NULL,
  default_pilot_routing INTEGER REFERENCES routings(id) ON DELETE SET NULL,

  -- Costing settings
  require_costing_approval BOOLEAN DEFAULT true NOT NULL,
  cost_variance_warning_pct DECIMAL(5,2) DEFAULT 20.00 NOT NULL CHECK (cost_variance_warning_pct >= 0),
  cost_variance_blocker_pct DECIMAL(5,2) DEFAULT 50.00 NOT NULL CHECK (cost_variance_blocker_pct >= 0),

  -- Compliance settings
  require_compliance_docs BOOLEAN DEFAULT true NOT NULL,

  -- Formulation settings
  max_formulation_versions INTEGER DEFAULT 10 NOT NULL CHECK (max_formulation_versions > 0),
  enable_formulation_export BOOLEAN DEFAULT true NOT NULL,

  -- Event sourcing settings
  event_retention_days INTEGER DEFAULT 90 NOT NULL CHECK (event_retention_days >= 0),

  -- Timestamps
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),

  -- Constraints
  CONSTRAINT npd_settings_org_unique UNIQUE (org_id),
  CONSTRAINT cost_variance_order CHECK (cost_variance_warning_pct <= cost_variance_blocker_pct)
);

-- Indexes
CREATE INDEX idx_npd_settings_org_id ON npd_settings(org_id);
CREATE INDEX idx_npd_settings_enabled ON npd_settings(org_id) WHERE enable_npd_module = true;

-- Updated_at trigger
CREATE TRIGGER npd_settings_updated_at
BEFORE UPDATE ON npd_settings
FOR EACH ROW EXECUTE FUNCTION update_updated_at();
```

#### Extensions to existing tables

```sql
-- work_orders table (already exists)
ALTER TABLE work_orders ADD COLUMN IF NOT EXISTS type VARCHAR(20) DEFAULT 'production';
ALTER TABLE work_orders ADD COLUMN IF NOT EXISTS npd_project_id INTEGER;

-- products table (already exists)
ALTER TABLE products ADD COLUMN IF NOT EXISTS npd_project_id INTEGER;
ALTER TABLE products ADD COLUMN IF NOT EXISTS source VARCHAR(30);

-- boms table (already exists)
ALTER TABLE boms ADD COLUMN IF NOT EXISTS npd_formulation_id INTEGER;
ALTER TABLE boms ADD COLUMN IF NOT EXISTS source VARCHAR(30);

-- Future foreign keys (added when NPD tables created)
-- ALTER TABLE work_orders ADD CONSTRAINT fk_wo_npd_project FOREIGN KEY (npd_project_id) REFERENCES npd_projects(id);
-- ALTER TABLE products ADD CONSTRAINT fk_product_npd_project FOREIGN KEY (npd_project_id) REFERENCES npd_projects(id);
-- ALTER TABLE boms ADD CONSTRAINT fk_bom_npd_formulation FOREIGN KEY (npd_formulation_id) REFERENCES npd_formulations(id);
```

### RLS Policies

```sql
-- npd_settings: Users can read own org settings, only admins can update
CREATE POLICY "npd_settings_org_read" ON npd_settings
FOR SELECT USING (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
);

CREATE POLICY "npd_settings_admin_update" ON npd_settings
FOR UPDATE USING (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  AND (
    SELECT r.code FROM roles r
    JOIN users u ON u.role_id = r.id
    WHERE u.id = auth.uid()
  ) IN ('SUPER_ADMIN', 'ADMIN')
);

CREATE POLICY "npd_settings_admin_insert" ON npd_settings
FOR INSERT WITH CHECK (
  org_id = (SELECT org_id FROM users WHERE id = auth.uid())
  AND (
    SELECT r.code FROM roles r
    JOIN users u ON u.role_id = r.id
    WHERE u.id = auth.uid()
  ) IN ('SUPER_ADMIN', 'ADMIN')
);

-- Enable RLS
ALTER TABLE npd_settings ENABLE ROW LEVEL SECURITY;
```

### API Endpoints

```
# NPD Settings
GET    /api/npd/settings                    - Get org NPD settings (creates if not exists)
PUT    /api/npd/settings                    - Update NPD settings (admin only)
```

### Service Methods

**Location:** `lib/services/npd-settings-service.ts`

```typescript
interface NPDSettingsService {
  // Settings CRUD
  getSettings(orgId: string): Promise<NPDSettings>;
  updateSettings(orgId: string, updates: Partial<NPDSettings>): Promise<NPDSettings>;
  createDefaultSettings(orgId: string): Promise<NPDSettings>;

  // Validation helpers
  isNPDEnabled(orgId: string): Promise<boolean>;
  isNPDOnlyMode(orgId: string): Promise<boolean>;
  canEnableNPD(orgId: string): Promise<{ allowed: boolean; reason?: string }>;

  // Costing helpers
  getCostVarianceThresholds(orgId: string): Promise<{ warning: number; blocker: number }>;
  evaluateCostVariance(orgId: string, variance: number): Promise<CostVarianceLevel>;

  // Validation
  validateHandoffEligibility(orgId: string, projectData: any): Promise<HandoffValidation>;
}

interface NPDSettings {
  id: number;
  org_id: string;
  enable_npd_module: boolean;
  npd_only_mode: boolean;
  enable_pilot_wo: boolean;
  default_pilot_routing: number | null;
  require_costing_approval: boolean;
  cost_variance_warning_pct: number;
  cost_variance_blocker_pct: number;
  require_compliance_docs: boolean;
  max_formulation_versions: number;
  enable_formulation_export: boolean;
  event_retention_days: number;
  created_at: string;
  updated_at: string;
}

interface CostVarianceLevel {
  level: 'ok' | 'warning' | 'blocker';
  message?: string;
  blocking: boolean;
}

interface HandoffValidation {
  eligible: boolean;
  errors: string[];
  warnings: string[];
  blockers: string[];
}
```

### Zod Validation Schemas

**Location:** `lib/validation/npd-settings.ts`

```typescript
import { z } from 'zod';

// NPD Settings schema
export const npdSettingsSchema = z.object({
  id: z.number().int().positive().optional(),
  org_id: z.string().uuid(),
  enable_npd_module: z.boolean(),
  npd_only_mode: z.boolean(),
  enable_pilot_wo: z.boolean(),
  default_pilot_routing: z.number().int().positive().nullable(),
  require_costing_approval: z.boolean(),
  cost_variance_warning_pct: z.number()
    .min(0, 'Warning threshold must be >= 0')
    .max(100, 'Warning threshold must be <= 100'),
  cost_variance_blocker_pct: z.number()
    .min(0, 'Blocker threshold must be >= 0')
    .max(100, 'Blocker threshold must be <= 100'),
  require_compliance_docs: z.boolean(),
  max_formulation_versions: z.number().int().positive()
    .min(1, 'Must allow at least 1 version'),
  enable_formulation_export: z.boolean(),
  event_retention_days: z.number().int().min(0),
  created_at: z.string().datetime().optional(),
  updated_at: z.string().datetime().optional(),
}).refine(
  (data) => data.cost_variance_warning_pct <= data.cost_variance_blocker_pct,
  {
    message: 'Warning threshold must be <= blocker threshold',
    path: ['cost_variance_warning_pct'],
  }
);

// Update settings request
export const updateNPDSettingsSchema = npdSettingsSchema.partial().omit({
  id: true,
  org_id: true,
  created_at: true,
  updated_at: true,
});

// Response schema
export const npdSettingsResponseSchema = npdSettingsSchema;
```

## UI Components

**Note:** This story is backend-only. UI components will be added in Story 08.2 (NPD Dashboard) and Epic 01 Settings pages.

### Future UI (Story 08.2)
- Settings page at `/settings/npd`
- Toggle switches for boolean settings
- Number inputs for thresholds and limits
- Routing selector for default_pilot_routing
- Save button (admin only)

## Test Cases

### Unit Tests

**npd-settings-service.test.ts**
```typescript
describe('NPDSettingsService', () => {
  describe('getSettings', () => {
    it('returns existing settings for org');
    it('creates default settings if none exist');
    it('throws error for invalid org_id');
  });

  describe('updateSettings', () => {
    it('updates settings with valid data');
    it('rejects invalid cost variance thresholds');
    it('rejects warning > blocker threshold');
    it('enforces RLS (cannot update other org settings)');
  });

  describe('isNPDEnabled', () => {
    it('returns true when enable_npd_module = true');
    it('returns false when enable_npd_module = false');
  });

  describe('canEnableNPD', () => {
    it('allows paid tier orgs to enable NPD');
    it('blocks free tier orgs with reason message');
  });

  describe('evaluateCostVariance', () => {
    it('returns "ok" when variance < warning threshold');
    it('returns "warning" when variance >= warning && < blocker');
    it('returns "blocker" when variance >= blocker threshold');
  });

  describe('validateHandoffEligibility', () => {
    it('passes validation when all requirements met');
    it('fails when costing not approved (require_costing_approval = true)');
    it('fails when compliance docs missing (require_compliance_docs = true)');
    it('fails when cost variance exceeds blocker');
  });
});
```

### Integration Tests

**npd-settings-api.test.ts**
```typescript
describe('NPD Settings API', () => {
  describe('GET /api/npd/settings', () => {
    it('returns org settings for authenticated user');
    it('creates defaults if settings not exist');
    it('returns 401 for unauthenticated');
    it('returns only own org settings (RLS)');
  });

  describe('PUT /api/npd/settings', () => {
    it('admin can update settings');
    it('non-admin gets 403');
    it('validates cost variance threshold order');
    it('validates max_formulation_versions > 0');
    it('updates updated_at timestamp');
  });
});
```

### E2E Tests

**npd-settings.spec.ts**
```typescript
describe('NPD Settings', () => {
  it('admin can toggle NPD module');
  it('free tier org blocked from enabling NPD');
  it('settings persist after page reload');
  it('cost variance thresholds enforce validation');
  it('default pilot routing selector shows existing routings');
});
```

## Security Considerations

1. **Module Activation Control**
   - Only paid tier orgs can enable NPD module
   - Check billing tier before allowing `enable_npd_module = true`
   - Feature flag middleware for /npd/* routes

2. **Admin-Only Updates**
   - RLS enforces only SUPER_ADMIN and ADMIN can update settings
   - API validates user role before PUT operations

3. **RLS Enforcement**
   - All queries filtered by org_id
   - Prevent cross-tenant access to settings

4. **Audit Trail**
   - Log all settings changes with user_id and timestamp
   - Track who enabled/disabled NPD module

5. **Validation**
   - Zod schemas validate all input data
   - Database constraints prevent invalid states (e.g., warning > blocker)

## Deliverables

- [ ] `npd_settings` table migration with constraints and indexes
- [ ] RLS policies for npd_settings table
- [ ] Extensions to work_orders, products, boms tables (type, npd_project_id, source)
- [ ] NPD Settings service (`lib/services/npd-settings-service.ts`)
- [ ] Zod schemas (`lib/validation/npd-settings.ts`)
- [ ] GET /api/npd/settings endpoint
- [ ] PUT /api/npd/settings endpoint
- [ ] Unit tests for service methods
- [ ] Integration tests for API endpoints
- [ ] E2E tests for settings management
- [ ] Default settings auto-creation on org creation

## Definition of Done

- [ ] `npd_settings` table created with all fields and constraints
- [ ] RLS policies enforce org isolation
- [ ] GET /api/npd/settings returns org settings or creates defaults
- [ ] PUT /api/npd/settings updates settings (admin only)
- [ ] Zod validation enforces data integrity
- [ ] Cost variance threshold validation works (warning <= blocker)
- [ ] NPD module toggle controls access to /npd/* routes
- [ ] Default settings created automatically for new orgs
- [ ] Unit test coverage >= 90%
- [ ] Integration tests pass
- [ ] E2E tests pass
- [ ] Multi-tenancy verified (RLS working)
- [ ] Documentation updated
