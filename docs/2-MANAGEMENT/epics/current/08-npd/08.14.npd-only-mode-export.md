# 08.14 - NPD-Only Mode & Export

**Priority**: P1 (High - Market Differentiator)
**Story Points**: M (Medium)
**Type**: fullstack
**Estimate**: 2-3 days

**State**: ready
**Primary PRD**: `docs/1-BASELINE/product/modules/npd.md` (FR-NPD-47)
**Dependencies**: 08.2, 08.4, 08.7, 08.8, 01.1

---

## Goal

Enable NPD-only mode for R&D consultancies and standalone innovation teams who develop formulations without integrated production. In this mode, users can export formulations to PDF (recipe card) or Excel (ingredient list) instead of handing off to production. This unlocks a new customer segment: R&D firms who need formulation management without manufacturing execution.

---

## User Story

As an **R&D Consultant**, I want to **use NPD module without production integration** so that **I can develop formulations for clients and export them as professional deliverables (PDF/Excel)**.

As a **Food Startup**, I want to **manage recipe development internally before partnering with a co-packer** so that **I can iterate formulations and export them for external manufacturing**.

---

## Scope

**In scope (this story)**
- NPD-only mode toggle in npd_settings (npd_only_mode: boolean)
- GET /api/npd/formulations/:id/export/pdf - Export formulation as PDF recipe card
- GET /api/npd/formulations/:id/export/excel - Export formulation as Excel ingredient list
- PDF includes: Project info, formulation items, allergens, costing summary, compliance status
- Excel includes: Items table (product, qty, uom, %), allergen declaration, costing
- Download endpoint with Content-Disposition header
- NPD-only mode disables handoff wizard (shows export buttons instead)
- Export audit logging (who exported, when, formulation ID)

**Out of scope (this story)**
- Multi-formulation export (batch export - Phase 2)
- Custom PDF templates (Phase 2)
- Branded PDF with org logo (Phase 2)
- Email export directly to client (Phase 3)
- Export history dashboard (Phase 3)

---

## Dependencies

### Hard Dependencies
| Story | Provides | Status |
|-------|----------|--------|
| 01.1 | Org Context + RLS | Ready |
| 08.2 | NPD Projects CRUD, npd_projects table | Ready |
| 08.4 | Formulations CRUD, npd_formulations table | Ready |

### Soft Dependencies
| Story | Provides | Impact if Missing |
|-------|----------|-------------------|
| 08.5 | Allergen Aggregation | Allergens not included in export (manual entry) |
| 08.7 | Formulation Costing | Costing not included in export (optional section) |
| 08.8 | Compliance Documents | Compliance status not shown in PDF (minor) |

---

## Acceptance Criteria (Given/When/Then)

### AC-1: NPD-Only Mode Toggle

```gherkin
Scenario: Enable NPD-only mode
  Given user is Admin in Org A
  When navigating to Settings > NPD Settings
  And toggles npd_only_mode = true
  Then npd_settings.npd_only_mode = true
  And handoff wizard disabled for all NPD projects
  And export buttons appear on formulation detail pages

Scenario: Disable NPD-only mode (default)
  Given npd_settings.npd_only_mode = false (default)
  When viewing formulation detail
  Then handoff wizard enabled
  And export buttons hidden
```

```gherkin
Scenario: NPD-only mode hides handoff wizard
  Given npd_settings.npd_only_mode = true
  And NPD project NPD-001 at gate G4
  When user views project detail
  Then [Start Handoff] button hidden
  And [Export Formulation] button shown instead
```

### AC-2: Export Formulation to PDF

```gherkin
Scenario: Export formulation to PDF
  Given formulation v2.0 for project NPD-001
  And formulation has 15 items
  When GET /api/npd/formulations/:id/export/pdf
  Then PDF generated with sections:
    | Section | Content |
    | Header | Org name, formulation number, version |
    | Project Info | Project name, owner, gate, status |
    | Formulation Details | Total qty, UoM, effective dates |
    | Ingredient List | Product name, quantity, UoM, percentage (15 rows) |
    | Allergen Declaration | Contains: X, Y, Z / May Contain: A, B |
    | Costing Summary | Target cost, estimated cost, variance (if 08.7 available) |
    | Compliance Status | HACCP: ✅, Label: ✅ (if 08.8 available) |
    | Footer | Exported by: John Doe, Date: 2025-01-15 |
  And Content-Type: application/pdf
  And Content-Disposition: attachment; filename="NPD-001_v2.0.pdf"
  And response 200 with PDF binary
```

```gherkin
Scenario: PDF layout (recipe card format)
  Given formulation exported to PDF
  Then PDF has:
    - Page size: A4 portrait
    - Font: Arial, 10pt body, 14pt headers
    - Logo placeholder (top-left)
    - Table layout for ingredients
    - Color scheme: Blue headers, white background
    - Page numbers if multi-page
```

```gherkin
Scenario: PDF without allergens (08.5 not available)
  Given formulation without allergen aggregation
  When exporting to PDF
  Then allergen section shows:
    | Allergen Declaration | Not Available |
  And PDF generated successfully (graceful degradation)

Scenario: PDF without costing (08.7 not available)
  Given formulation without costing
  When exporting to PDF
  Then costing section omitted
  And PDF generated successfully
```

### AC-3: Export Formulation to Excel

```gherkin
Scenario: Export formulation to Excel
  Given formulation v2.0 for project NPD-001
  And formulation has 15 items
  When GET /api/npd/formulations/:id/export/excel
  Then Excel generated with sheets:
    | Sheet Name | Content |
    | Formulation Info | Project name, formulation number, version, total qty, UoM |
    | Ingredients | Product Code, Product Name, Quantity, UoM, Percentage (15 rows) |
    | Allergens | Allergen, Status (Contains/May Contain) |
    | Costing | Target Cost, Estimated Cost, Actual Cost, Variance % |
  And Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet
  And Content-Disposition: attachment; filename="NPD-001_v2.0.xlsx"
  And response 200 with Excel binary
```

```gherkin
Scenario: Excel formatting
  Given formulation exported to Excel
  Then Excel has:
    - Header row with bold font and freeze pane
    - Column widths auto-sized
    - Percentage column formatted as %
    - Cost columns formatted as currency
    - Borders on all cells
```

```gherkin
Scenario: Excel with formulas (percentage column)
  Given formulation item with quantity = 50 kg
  And total_qty = 100 kg
  When exporting to Excel
  Then percentage cell has formula: =(B2/B$1)*100
  And displays 50.0%
```

### AC-4: Download Endpoint

```gherkin
Scenario: Download PDF via browser
  Given user clicks [Export PDF] button
  When browser requests GET /api/npd/formulations/:id/export/pdf
  Then browser downloads file "NPD-001_v2.0.pdf"
  And file opens in PDF viewer

Scenario: Download Excel via browser
  Given user clicks [Export Excel] button
  When browser requests GET /api/npd/formulations/:id/export/excel
  Then browser downloads file "NPD-001_v2.0.xlsx"
  And file opens in Excel/Sheets
```

### AC-5: Export Audit Logging

```gherkin
Scenario: Log PDF export
  Given user exports formulation to PDF
  When export completes
  Then audit log created with:
    | entity_type | npd_formulation |
    | entity_id | Formulation ID |
    | action | export_pdf |
    | user_id | Current user |
    | timestamp | Now |
    | metadata | { format: 'pdf', file_name: 'NPD-001_v2.0.pdf' } |

Scenario: Log Excel export
  Given user exports formulation to Excel
  When export completes
  Then audit log created with action = 'export_excel'
```

### AC-6: Validation - Formulation Must Be Locked

```gherkin
Scenario: Cannot export draft formulation
  Given formulation status = 'draft'
  When attempting PDF export
  Then error 400 "Formulation must be locked before export"
  And no PDF generated

Scenario: Cannot export approved (not locked) formulation
  Given formulation status = 'approved'
  When attempting export
  Then error 400 "Lock formulation before export"

Scenario: Export locked formulation
  Given formulation status = 'locked'
  When exporting to PDF
  Then PDF generated successfully
```

### AC-7: Permission Enforcement

```gherkin
Scenario: NPD Lead can export
  Given user has NPD_LEAD role
  When exporting formulation
  Then operation succeeds
  And PDF/Excel downloaded

Scenario: R&D can export
  Given user has R&D role
  When exporting formulation
  Then operation succeeds
  And export logged

Scenario: Viewer cannot export
  Given user has VIEWER role
  When attempting export
  Then error 403 "Insufficient permissions to export formulation"
```

### AC-8: RLS Policy Enforcement

```gherkin
Scenario: Org isolation on export
  Given formulation belongs to Org B
  And user from Org A
  When attempting export
  Then error 404 "Formulation not found"
  And no export generated

Scenario: Export only own org formulations
  Given user from Org A
  And formulations exist in Org A and Org B
  When exporting formulation from Org A
  Then export succeeds
```

### AC-9: UI Integration

```gherkin
Scenario: Export buttons on formulation detail (NPD-only mode)
  Given npd_settings.npd_only_mode = true
  When viewing formulation detail page
  Then buttons displayed:
    | Button | Icon | Action |
    | Export PDF | PDF icon | GET /export/pdf |
    | Export Excel | Excel icon | GET /export/excel |
  And buttons enabled if formulation locked
  And buttons disabled if formulation draft

Scenario: Export buttons hidden (integrated mode)
  Given npd_settings.npd_only_mode = false
  When viewing formulation detail
  Then export buttons hidden
  And handoff wizard button shown
```

### AC-10: Performance Requirements

```gherkin
Scenario: PDF generation performance
  Given formulation with 50 items
  When exporting to PDF
  Then PDF generates < 2 seconds
  And file size < 500KB

Scenario: Excel generation performance
  Given formulation with 100 items
  When exporting to Excel
  Then Excel generates < 3 seconds
  And file size < 1MB
```

---

## Implementation Notes

### API Endpoints

```typescript
// GET /api/npd/formulations/:id/export/pdf
interface ExportPDFResponse {
  // Binary PDF stream
  // Headers:
  // Content-Type: application/pdf
  // Content-Disposition: attachment; filename="{PROJECT_NUMBER}_{VERSION}.pdf"
}

// GET /api/npd/formulations/:id/export/excel
interface ExportExcelResponse {
  // Binary Excel stream
  // Headers:
  // Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet
  // Content-Disposition: attachment; filename="{PROJECT_NUMBER}_{VERSION}.xlsx"
}
```

### Service Layer

```typescript
// lib/services/npd-export-service.ts

import PDFDocument from 'pdfkit';
import ExcelJS from 'exceljs';

export class NPDExportService {
  /**
   * Export formulation to PDF
   */
  static async exportToPDF(formulationId: number, userId: string): Promise<Buffer> {
    // 1. Get formulation with items, project, allergens, costing
    const formulation = await this.getFormulationForExport(formulationId);

    // 2. Validate formulation is locked
    if (formulation.status !== 'locked') {
      throw new Error('Formulation must be locked before export');
    }

    // 3. Generate PDF
    const doc = new PDFDocument({ size: 'A4', margin: 50 });
    const chunks: Buffer[] = [];

    doc.on('data', (chunk) => chunks.push(chunk));

    // Header
    doc.fontSize(20).text('Formulation Recipe Card', { align: 'center' });
    doc.moveDown();

    // Project Info
    doc.fontSize(12).text(`Project: ${formulation.project_name}`);
    doc.text(`Formulation: ${formulation.formulation_number}`);
    doc.text(`Total Quantity: ${formulation.total_qty} ${formulation.uom}`);
    doc.moveDown();

    // Ingredient Table
    doc.fontSize(14).text('Ingredients:', { underline: true });
    doc.moveDown(0.5);
    doc.fontSize(10);

    const tableTop = doc.y;
    const itemX = 50;
    const qtyX = 300;
    const uomX = 380;
    const pctX = 450;

    // Table headers
    doc.text('Product', itemX, tableTop, { bold: true });
    doc.text('Quantity', qtyX, tableTop);
    doc.text('UoM', uomX, tableTop);
    doc.text('%', pctX, tableTop);

    let y = tableTop + 20;
    formulation.items.forEach((item) => {
      doc.text(item.product_name, itemX, y);
      doc.text(item.quantity.toFixed(2), qtyX, y);
      doc.text(item.uom, uomX, y);
      doc.text(item.percentage.toFixed(1), pctX, y);
      y += 15;
    });

    // Allergens section (if available)
    if (formulation.allergens) {
      doc.moveDown(2);
      doc.fontSize(12).text('Allergen Declaration:', { underline: true });
      doc.fontSize(10).text(`Contains: ${formulation.allergens.contains.join(', ')}`);
      doc.text(`May Contain: ${formulation.allergens.may_contain.join(', ')}`);
    }

    // Costing section (if available)
    if (formulation.costing) {
      doc.moveDown(2);
      doc.fontSize(12).text('Costing Summary:', { underline: true });
      doc.fontSize(10).text(`Target Cost: $${formulation.costing.target_cost.toFixed(2)}`);
      doc.text(`Estimated Cost: $${formulation.costing.estimated_cost.toFixed(2)}`);
      if (formulation.costing.variance_pct) {
        doc.text(`Variance: ${formulation.costing.variance_pct.toFixed(1)}%`);
      }
    }

    // Footer
    doc.moveDown(3);
    doc.fontSize(8).text(`Exported by: ${userId}`, { align: 'right' });
    doc.text(`Export Date: ${new Date().toLocaleDateString()}`, { align: 'right' });

    doc.end();

    // 4. Log export
    await this.logExport(formulationId, userId, 'pdf');

    // 5. Return PDF buffer
    return new Promise((resolve) => {
      doc.on('end', () => {
        resolve(Buffer.concat(chunks));
      });
    });
  }

  /**
   * Export formulation to Excel
   */
  static async exportToExcel(formulationId: number, userId: string): Promise<Buffer> {
    // 1. Get formulation with items
    const formulation = await this.getFormulationForExport(formulationId);

    // 2. Validate formulation is locked
    if (formulation.status !== 'locked') {
      throw new Error('Formulation must be locked before export');
    }

    // 3. Generate Excel
    const workbook = new ExcelJS.Workbook();

    // Sheet 1: Formulation Info
    const infoSheet = workbook.addWorksheet('Formulation Info');
    infoSheet.columns = [
      { header: 'Field', key: 'field', width: 30 },
      { header: 'Value', key: 'value', width: 50 },
    ];
    infoSheet.addRow({ field: 'Project Name', value: formulation.project_name });
    infoSheet.addRow({ field: 'Formulation Number', value: formulation.formulation_number });
    infoSheet.addRow({ field: 'Version', value: formulation.version });
    infoSheet.addRow({ field: 'Total Quantity', value: `${formulation.total_qty} ${formulation.uom}` });

    // Sheet 2: Ingredients
    const itemsSheet = workbook.addWorksheet('Ingredients');
    itemsSheet.columns = [
      { header: 'Product Code', key: 'product_code', width: 20 },
      { header: 'Product Name', key: 'product_name', width: 40 },
      { header: 'Quantity', key: 'quantity', width: 15 },
      { header: 'UoM', key: 'uom', width: 10 },
      { header: 'Percentage (%)', key: 'percentage', width: 15 },
    ];
    formulation.items.forEach((item) => {
      itemsSheet.addRow({
        product_code: item.product_code,
        product_name: item.product_name,
        quantity: item.quantity,
        uom: item.uom,
        percentage: item.percentage,
      });
    });

    // Format percentage column
    itemsSheet.getColumn('percentage').numFmt = '0.0%';

    // Sheet 3: Allergens (if available)
    if (formulation.allergens) {
      const allergensSheet = workbook.addWorksheet('Allergens');
      allergensSheet.columns = [
        { header: 'Allergen', key: 'allergen', width: 30 },
        { header: 'Status', key: 'status', width: 20 },
      ];
      formulation.allergens.contains.forEach((allergen) => {
        allergensSheet.addRow({ allergen, status: 'Contains' });
      });
      formulation.allergens.may_contain.forEach((allergen) => {
        allergensSheet.addRow({ allergen, status: 'May Contain' });
      });
    }

    // Sheet 4: Costing (if available)
    if (formulation.costing) {
      const costingSheet = workbook.addWorksheet('Costing');
      costingSheet.columns = [
        { header: 'Cost Type', key: 'type', width: 30 },
        { header: 'Amount', key: 'amount', width: 20 },
      ];
      costingSheet.addRow({ type: 'Target Cost', amount: formulation.costing.target_cost });
      costingSheet.addRow({ type: 'Estimated Cost', amount: formulation.costing.estimated_cost });
      if (formulation.costing.actual_cost) {
        costingSheet.addRow({ type: 'Actual Cost', amount: formulation.costing.actual_cost });
      }
      costingSheet.getColumn('amount').numFmt = '$#,##0.00';
    }

    // 4. Log export
    await this.logExport(formulationId, userId, 'excel');

    // 5. Return Excel buffer
    return await workbook.xlsx.writeBuffer() as Buffer;
  }

  /**
   * Get formulation with all export data
   */
  private static async getFormulationForExport(formulationId: number): Promise<FormulationExportData> {
    const result = await db.query(
      `SELECT
        f.*,
        p.project_name, p.project_number,
        array_agg(json_build_object(
          'product_code', prod.product_code,
          'product_name', prod.product_name,
          'quantity', fi.quantity,
          'uom', fi.uom,
          'percentage', fi.percentage
        )) AS items
       FROM npd_formulations f
       JOIN npd_projects p ON f.npd_project_id = p.id
       LEFT JOIN npd_formulation_items fi ON f.id = fi.formulation_id
       LEFT JOIN products prod ON fi.product_id = prod.id
       WHERE f.id = $1
       GROUP BY f.id, p.id`,
      [formulationId]
    );

    if (result.rows.length === 0) {
      throw new Error('Formulation not found');
    }

    return result.rows[0];
  }

  /**
   * Log export action to audit log
   */
  private static async logExport(
    formulationId: number,
    userId: string,
    format: 'pdf' | 'excel'
  ): Promise<void> {
    await db.query(
      `INSERT INTO audit_log (entity_type, entity_id, action, user_id, metadata)
       VALUES ('npd_formulation', $1, $2, $3, $4)`,
      [formulationId, `export_${format}`, userId, JSON.stringify({ format })]
    );
  }
}
```

### Dependencies

```json
{
  "dependencies": {
    "pdfkit": "^0.13.0",
    "exceljs": "^4.3.0"
  }
}
```

---

## Deliverables

### API Routes
- [ ] GET /api/npd/formulations/:id/export/pdf
- [ ] GET /api/npd/formulations/:id/export/excel

### Service Layer
- [ ] NPDExportService.exportToPDF()
- [ ] NPDExportService.exportToExcel()
- [ ] NPDExportService.getFormulationForExport()
- [ ] NPDExportService.logExport()

### Frontend
- [ ] Export buttons on formulation detail page (NPD-only mode)
- [ ] Toggle npd_only_mode in Settings
- [ ] Export loading states
- [ ] Error handling for export failures

### Tests
- [ ] Unit test: NPDExportService.exportToPDF()
- [ ] Unit test: NPDExportService.exportToExcel()
- [ ] Integration test: GET /export/pdf (success)
- [ ] Integration test: GET /export/excel (success)
- [ ] Integration test: Validation errors (formulation not locked)
- [ ] E2E test: Full PDF export and download
- [ ] E2E test: Full Excel export and download

---

## Definition of Done

- [ ] NPD-only mode toggle in settings works
- [ ] PDF export generates correctly with all sections
- [ ] Excel export generates correctly with all sheets
- [ ] Download endpoints set correct Content-Type and Content-Disposition headers
- [ ] Export buttons shown in NPD-only mode, hidden in integrated mode
- [ ] Formulation locked validation enforced
- [ ] Export audit logging works
- [ ] Permission checks enforce R&D/NPD_LEAD roles
- [ ] RLS policies enforce org isolation
- [ ] PDF generates < 2 seconds for 50-item formulation
- [ ] Excel generates < 3 seconds for 100-item formulation
- [ ] Unit tests achieve >80% coverage on NPDExportService
- [ ] Integration tests cover all export scenarios
- [ ] E2E tests verify download workflow

---

## Risk Assessment

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| PDF library performance (large formulations) | MEDIUM | MEDIUM | Optimize PDF generation, paginate if needed |
| Excel library memory usage | MEDIUM | LOW | Stream Excel generation for large datasets |
| Missing allergen/costing data | LOW | HIGH | Graceful degradation, omit sections if unavailable |
| Export file naming conflicts | LOW | MEDIUM | Include timestamp in filename if needed |
| Audit log overflow | LOW | LOW | Retain exports for 90 days, auto-cleanup |

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2026-01-15 | Initial version - NPD-only mode & export | ARCHITECT-AGENT |

---

**Document Status**: Ready for Implementation
**Created**: 2026-01-15
**Lines**: ~750
**Complexity**: M (Medium)
**Phase**: 2 (Export & Standalone Mode)
