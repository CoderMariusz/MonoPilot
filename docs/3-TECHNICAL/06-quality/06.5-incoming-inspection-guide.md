# Story 06.5: Incoming Inspection - Implementation Guide

**Status**: DEPLOYED (2026-01-22)
**Version**: 1.0
**Last Updated**: 2026-01-22

---

## Overview

Story 06.5 implements the incoming inspection workflow for goods received via GRN (Good Receipt Note). This enables QA teams to inspect raw materials, packaging, and ingredients upon receipt, determine pass/fail/conditional results, and update License Plate QA status accordingly. Incoming inspection is a critical quality gate ensuring only approved materials enter production.

**Key Features**:
- Auto-create inspection on GRN completion (configurable)
- Manual inspection creation from pending queue
- Inspection workflow: scheduled → in_progress → completed
- Inspector assignment and reassignment
- Test results recording per specification parameter
- Result determination: pass/fail/conditional
- LP QA status update on inspection completion
- Inspection queue dashboard with filters
- Complete audit trail and compliance tracking

---

## Architecture

### Database Schema

**Table: quality_inspections**

```sql
CREATE TABLE quality_inspections (
    id                      UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id                  UUID NOT NULL REFERENCES organizations(id),
    inspection_number       TEXT NOT NULL,

    -- Type and Classification
    inspection_type         TEXT NOT NULL
                            CHECK (inspection_type IN ('incoming', 'in_process', 'final')),

    -- Source Reference
    reference_type          TEXT NOT NULL
                            CHECK (reference_type IN ('po', 'grn', 'wo', 'lp', 'batch')),
    reference_id            UUID NOT NULL,

    -- Product and Specification
    product_id              UUID NOT NULL REFERENCES products(id),
    spec_id                 UUID REFERENCES quality_specifications(id),

    -- LP Reference
    lp_id                   UUID REFERENCES license_plates(id),
    grn_id                  UUID REFERENCES grns(id),
    po_id                   UUID REFERENCES purchase_orders(id),

    -- Batch Tracking
    batch_number            TEXT,
    lot_size                INTEGER,
    sample_size             INTEGER,
    sampling_plan_id        UUID REFERENCES sampling_plans(id),

    -- Assignment
    inspector_id            UUID REFERENCES users(id),
    assigned_by             UUID REFERENCES users(id),
    assigned_at             TIMESTAMPTZ,

    -- Workflow Status
    status                  TEXT NOT NULL DEFAULT 'scheduled'
                            CHECK (status IN ('scheduled', 'in_progress', 'completed', 'cancelled')),

    -- Scheduling
    scheduled_date          DATE,
    priority                TEXT DEFAULT 'normal'
                            CHECK (priority IN ('low', 'normal', 'high', 'urgent')),

    -- Execution
    started_at              TIMESTAMPTZ,
    completed_at            TIMESTAMPTZ,
    completed_by            UUID REFERENCES users(id),

    -- Results
    result                  TEXT
                            CHECK (result IN ('pass', 'fail', 'conditional', NULL)),
    result_notes            TEXT,

    -- Defect Counts
    defects_found           INTEGER DEFAULT 0,
    major_defects           INTEGER DEFAULT 0,
    minor_defects           INTEGER DEFAULT 0,
    critical_defects        INTEGER DEFAULT 0,

    -- Conditional Approval
    conditional_reason      TEXT,
    conditional_restrictions TEXT,
    conditional_approved_by UUID REFERENCES users(id),
    conditional_expires_at  TIMESTAMPTZ,

    -- NCR Linkage
    ncr_id                  UUID REFERENCES ncr_reports(id),

    -- Audit
    created_at              TIMESTAMPTZ NOT NULL DEFAULT now(),
    created_by              UUID REFERENCES users(id),
    updated_at              TIMESTAMPTZ NOT NULL DEFAULT now(),
    updated_by              UUID REFERENCES users(id),

    CONSTRAINT uq_inspection_number UNIQUE (org_id, inspection_number)
);
```

**Key Indexes**:
- `idx_inspections_org_status` - Status filtering
- `idx_inspections_org_type` - Inspection type filtering
- `idx_inspections_type_status` - Combined filtering
- `idx_inspections_lp` - LP lookup
- `idx_inspections_grn` - GRN reference
- `idx_inspections_pending` - Pending queue (scheduled + in_progress)

**RLS Policies**:
All policies enforce `org_id` isolation. Only scheduled inspections can be deleted.

### Inspection Number Sequences

**Table: inspection_number_sequences**

Tracks inspection number sequences per org and year.

```sql
CREATE TABLE inspection_number_sequences (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id UUID NOT NULL REFERENCES organizations(id),
    year INTEGER NOT NULL,
    inspection_type TEXT NOT NULL,
    current_value BIGINT NOT NULL DEFAULT 0,
    updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
    UNIQUE(org_id, year, inspection_type)
);
```

### Database Functions

**`generate_inspection_number(p_org_id, p_type)`**

Generates inspection numbers with type-specific prefixes:
- Incoming: `INS-INC-2025-00001`
- In-Process: `INS-IPR-2025-00001`
- Final: `INS-FIN-2025-00001`

**`create_incoming_inspection_on_grn()`** (Trigger)

Automatically creates inspections for each LP item on GRN completion (if enabled).

**`update_lp_qa_status_on_inspection()`** (Trigger)

Updates LP QA status when inspection completes:
- Pass → `qa_status = 'passed'`
- Fail → `qa_status = 'failed'`
- Conditional → `qa_status = 'conditional'`

---

## API Endpoints

### List Inspections

**`GET /api/quality/inspections`**

List all inspections with extensive filtering.

**Query Parameters**:
- `inspection_type` (string) - Filter by type: incoming, in_process, final
- `status` (string) - Filter by status: scheduled, in_progress, completed, cancelled
- `priority` (string) - Filter by priority: low, normal, high, urgent
- `inspector_id` (uuid) - Filter by assigned inspector
- `product_id` (uuid) - Filter by product
- `lp_id` (uuid) - Filter by license plate
- `grn_id` (uuid) - Filter by GRN
- `po_id` (uuid) - Filter by purchase order
- `date_from` (date) - Scheduled date range start
- `date_to` (date) - Scheduled date range end
- `search` (string) - Search by inspection#, LP#, or product name
- `sort_by` (string) - Sort field (default: scheduled_date)
- `sort_order` (string) - asc or desc (default: desc)
- `page` (number, default: 1) - Pagination
- `limit` (number, default: 20) - Page size

**Example Response** (200 OK):
```json
{
  "inspections": [
    {
      "id": "insp-001",
      "org_id": "org-001",
      "inspection_number": "INS-INC-2025-00001",
      "inspection_type": "incoming",
      "product_id": "prod-001",
      "product_code": "SKU-001",
      "product_name": "Flour - Wheat",
      "lp_id": "lp-001",
      "lp_number": "LP00000001",
      "grn_id": "grn-001",
      "grn_number": "GRN-2025-0001",
      "batch_number": "BATCH-2025-001",
      "status": "scheduled",
      "priority": "normal",
      "scheduled_date": "2026-01-22",
      "inspector_id": "user-qa-1",
      "inspector_name": "John Inspector",
      "assigned_at": "2026-01-22T08:00:00Z",
      "defects_found": 0,
      "created_at": "2026-01-22T07:00:00Z"
    }
  ],
  "pagination": {
    "total": 127,
    "page": 1,
    "limit": 20,
    "pages": 7
  }
}
```

---

### Get Inspection Detail

**`GET /api/quality/inspections/:id`**

Retrieve complete inspection details with test results summary.

**Example Response** (200 OK):
```json
{
  "inspection": {
    "id": "insp-001",
    "inspection_number": "INS-INC-2025-00001",
    "inspection_type": "incoming",
    "product_name": "Flour - Wheat",
    "spec_id": "spec-001",
    "spec_name": "Wheat Flour - Standard Grade",
    "lp_id": "lp-001",
    "batch_number": "BATCH-2025-001",
    "status": "in_progress",
    "started_at": "2026-01-22T10:30:00Z",
    "inspector_name": "John Inspector"
  },
  "test_results": [
    {
      "id": "result-001",
      "parameter_id": "param-001",
      "parameter_name": "Ash Content",
      "spec_min": 0.5,
      "spec_max": 1.5,
      "unit": "%",
      "recorded_value": 1.2,
      "status": "pass",
      "tested_by": "John Inspector",
      "tested_at": "2026-01-22T10:45:00Z"
    }
  ],
  "test_result_summary": {
    "total_parameters": 8,
    "tested_count": 5,
    "passed_count": 5,
    "failed_count": 0,
    "marginal_count": 0,
    "untested_count": 3
  },
  "can_complete": false,
  "suggested_result": "pass"
}
```

---

### Create Inspection

**`POST /api/quality/inspections`**

Create a new manual inspection.

**Request Body**:
```json
{
  "product_id": "prod-001",
  "lp_id": "lp-001",
  "grn_id": "grn-001",
  "spec_id": "spec-001",
  "batch_number": "BATCH-2025-001",
  "lot_size": 500,
  "priority": "normal",
  "scheduled_date": "2026-01-22"
}
```

**Response** (201 Created):
```json
{
  "inspection": {
    "id": "insp-001",
    "inspection_number": "INS-INC-2025-00001",
    "status": "scheduled",
    "product_id": "prod-001",
    "lp_id": "lp-001"
  }
}
```

**Validation**:
- At least one reference (LP, GRN, or PO) required
- Product must exist
- LP must exist if provided
- Spec must exist if provided

---

### Assign Inspector

**`POST /api/quality/inspections/:id/assign`**

Assign or reassign inspector to inspection.

**Request Body**:
```json
{
  "inspector_id": "user-qa-1"
}
```

**Response** (200 OK):
```json
{
  "inspection": {
    "id": "insp-001",
    "inspector_id": "user-qa-1",
    "inspector_name": "John Inspector",
    "assigned_by": "user-qa-mgr",
    "assigned_at": "2026-01-22T11:00:00Z"
  }
}
```

**Constraints**:
- Cannot reassign completed inspections
- Inspector must have QA_INSPECTOR or QA_MANAGER role

---

### Start Inspection

**`POST /api/quality/inspections/:id/start`**

Begin an inspection (scheduled → in_progress).

**Request Body**:
```json
{
  "take_over": false
}
```

**Response** (200 OK):
```json
{
  "inspection": {
    "id": "insp-001",
    "status": "in_progress",
    "started_at": "2026-01-22T11:00:00Z"
  }
}
```

**Constraints**:
- Inspector must be assigned
- If different user starts: `take_over=true` required
- Cannot start already in-progress inspection

---

### Complete Inspection

**`POST /api/quality/inspections/:id/complete`**

Complete inspection with result determination.

**Request Body**:
```json
{
  "result": "pass",
  "result_notes": "All tests passed successfully",
  "defects_found": 0,
  "major_defects": 0,
  "minor_defects": 0,
  "critical_defects": 0,
  "create_ncr": false
}
```

**For Conditional Result**:
```json
{
  "result": "conditional",
  "conditional_reason": "Marginal ash content",
  "conditional_restrictions": "Use only for non-critical applications",
  "conditional_expires_at": "2026-01-29T00:00:00Z"
}
```

**Response** (200 OK):
```json
{
  "inspection": {
    "id": "insp-001",
    "status": "completed",
    "result": "pass",
    "completed_at": "2026-01-22T12:30:00Z",
    "completed_by": "user-qa-1"
  },
  "lp_status_updated": true
}
```

**Effects**:
- Updates inspection result and completion info
- Updates LP QA status automatically
- Creates audit log entry
- Optional: Creates NCR if result is fail and requested

---

### Cancel Inspection

**`POST /api/quality/inspections/:id/cancel`**

Cancel a scheduled inspection.

**Request Body**:
```json
{
  "cancellation_reason": "Supplier cancelled delivery due to weather"
}
```

**Response** (200 OK):
```json
{
  "inspection": {
    "id": "insp-001",
    "status": "cancelled",
    "updated_at": "2026-01-22T14:00:00Z"
  }
}
```

**Constraints**:
- Only scheduled inspections can be cancelled
- In-progress inspections must be completed or reset
- Reason required (min 10 chars)

---

### Get Pending Inspections

**`GET /api/quality/inspections/pending`**

Get all pending inspections (scheduled + in_progress).

**Response**:
```json
{
  "inspections": [...],
  "counts": {
    "scheduled": 15,
    "in_progress": 3,
    "total": 18
  }
}
```

---

### Get Incoming Queue

**`GET /api/quality/inspections/incoming`**

Shortcut for `GET /api/quality/inspections?inspection_type=incoming`

---

## Service Layer

### InspectionService

Located at: `lib/services/inspection-service.ts`

**Key Methods**:

```typescript
// CRUD Operations
static async list(params: InspectionListParams): Promise<PaginatedResult<QualityInspection>>;
static async getById(id: string): Promise<InspectionDetail | null>;
static async getByNumber(inspectionNumber: string): Promise<QualityInspection | null>;
static async create(input: CreateInspectionInput, userId: string): Promise<QualityInspection>;
static async update(id: string, input: UpdateInspectionInput, userId: string): Promise<QualityInspection>;

// Workflow Operations
static async assign(id: string, inspectorId: string, assignedBy: string): Promise<QualityInspection>;
static async start(id: string, userId: string, takeOver?: boolean): Promise<QualityInspection>;
static async complete(id: string, input: CompleteInspectionInput, userId: string): Promise<{
  inspection: QualityInspection;
  ncrId?: string;
}>;
static async cancel(id: string, reason: string, userId: string): Promise<QualityInspection>;

// Result Determination
static async getSuggestedResult(inspectionId: string): Promise<{
  suggested: 'pass' | 'fail' | 'conditional';
  reason: string;
  testSummary: TestResultSummary;
}>;
static async canComplete(inspectionId: string): Promise<{
  canComplete: boolean;
  missingTests: string[];
  untestedCritical: string[];
}>;

// LP Integration
static async updateLPStatus(lpId: string, result: 'pass' | 'fail' | 'conditional'): Promise<void>;

// Auto-Creation
static async createForGRN(grnId: string, userId: string): Promise<QualityInspection[]>;

// Utilities
static async generateInspectionNumber(type: string): Promise<string>;
static async hasActiveInspection(lpId: string): Promise<{ has: boolean; inspectionId?: string }>;
```

---

## Frontend Implementation

### Pages

**Inspections Queue Page** (`/quality/inspections`)
- Tab navigation: All / Incoming / In-Process / Final
- DataTable with filters
- Columns: Inspection#, LP, Product, Batch, Status, Priority, Scheduled, Inspector, Actions
- Row click navigates to detail
- Inline actions: Start, Assign, View

**Incoming Inspection Queue** (`/quality/inspections/incoming`)
- Same DataTable filtered to incoming type
- Prominent [+ New Inspection] button
- Summary cards: Pending count, Overdue count

**Inspection Detail Page** (`/quality/inspections/:id`)
- Three-column layout (responsive stacked)
- Left: Header, Status, Actions
- Center: Product info, Test Results grid
- Right: Source info, Timeline, Assignment
- Action buttons based on status and role

### Components

**InspectionDataTable.tsx**
- ShadCN DataTable pattern
- Responsive columns
- Configurable filters sidebar
- Multi-select support (future)
- Priority/Status badge colors

**InspectionFilters.tsx**
- Status filter dropdown
- Priority filter dropdown
- Inspector multi-select
- Date range picker
- Product search
- Clear filters button

**InspectionStatusBadge.tsx**
- Scheduled: Yellow
- In-Progress: Blue
- Completed: Green
- Cancelled: Gray

**InspectionPriorityBadge.tsx**
- Urgent: Red
- High: Orange
- Normal: Blue
- Low: Gray

**InspectionResultBadge.tsx**
- Pass: Green
- Fail: Red
- Conditional: Yellow

**InspectionDetail.tsx**
- Container component
- Manages detail view lifecycle
- Handles updates and refreshes

**InspectionHeader.tsx**
- Inspection number, status, priority
- Action buttons based on status
- Last updated info

**InspectionSourceInfo.tsx**
- GRN link and details
- PO link and details
- Supplier name
- Reference type

**InspectionProductInfo.tsx**
- Product name and code
- LP link
- Batch number
- Lot size

**InspectionTestResults.tsx**
- Table of test parameters and results
- Shows spec min/max vs recorded value
- Pass/fail status per parameter
- Inspector and timestamp

**CompleteInspectionModal.tsx**
- Test result summary at top
- Suggested result with explanation
- Result selector (pass/fail/conditional)
- Notes field
- Defect counts input
- Conditional fields (for conditional result)
- NCR creation checkbox
- Loading state on submit

---

## Business Rules

1. **Inspection Required for QA Release**: LP with `qa_status='pending'` cannot be consumed until inspection completes with pass/conditional

2. **One Active Inspection per LP**: Warn if creating duplicate inspection for same LP

3. **Inspector Assignment Required**: Cannot start inspection without assigned inspector

4. **Specification Optional**: Inspection can complete without linked specification (manual pass/fail)

5. **Auto-Fail on Critical Defect**: If `quality_settings.auto_fail_on_critical=true`, any critical defect = automatic fail suggestion

6. **Conditional Requires Manager**: Conditional approval requires QA_MANAGER role

7. **LP Status Auto-Update**: Completing inspection automatically updates LP QA status via trigger

8. **Audit Trail Required**: All status changes, assignments, results logged

9. **Cancel Only Scheduled**: Only scheduled inspections can be cancelled

10. **Inspection Number Uniqueness**: `(org_id, inspection_number)` must be unique

---

## Permission Model

| Role | View | Create | Assign | Start | Complete | Approve Conditional |
|------|------|--------|--------|-------|----------|---------------------|
| VIEWER | ✓ | ✗ | ✗ | ✗ | ✗ | ✗ |
| QA_INSPECTOR | ✓ | ✓ | ✗ | ✓ | ✓ | ✗ |
| QA_MANAGER | ✓ | ✓ | ✓ | ✓ | ✓ | ✓ |
| ADMIN | ✓ | ✓ | ✓ | ✓ | ✓ | ✓ |

---

## Usage Workflow

### Complete Incoming Inspection Workflow

1. **GRN Completes** → Auto-creates inspections (if enabled)
2. **QA Manager Reviews Queue** → Sees pending inspections
3. **QA Manager Assigns Inspector** → Inspector notified
4. **QA Inspector Starts Inspection** → Status: in_progress
5. **QA Inspector Records Test Results** → Via story 06.6
6. **QA Inspector Completes Inspection** → Selects result
7. **LP QA Status Updated** → Automatically via trigger
8. **LP Available for Production** → Only if passed/conditional

### Manual Inspection Creation

1. Navigate to Inspections > Incoming
2. Click [+ New Inspection]
3. Select Product, LP, GRN/PO
4. Optionally select Specification
5. Set Priority (normal/high/urgent)
6. Click [Create]
7. Assign inspector
8. Follow workflow above

---

## Integration with Other Components

### Story 06.3 - Product Specifications

Inspection references active specification for the product. Specification provides parameter definitions.

### Story 06.4 - Test Parameters

Inspection displays parameters from specification. Inspector records results per parameter.

### Story 06.6 - Test Results Recording

Inspector records test results through separate UI, linked to inspection. Results feed into result determination logic.

### Epic 05 - Warehouse (LP)

Inspection updates LP QA status on completion. LP must pass inspection before consumption in production.

### Epic 03 - Planning (GRN/PO)

Inspection references GRN and PO for traceability. Auto-created on GRN completion.

---

## Performance Considerations

- **List performance**: < 500ms for 1000+ inspections
- **Detail performance**: < 500ms including test results
- **Create/Update**: < 300ms
- **LP status update**: < 200ms (database trigger)
- **Pagination**: 20 per page default
- **Indexes**: Extensive indexing for filtering and sorting

---

## Testing Summary

**Tests Created**: 307 tests passing

**Coverage Areas**:
- Inspection CRUD (create, read, update, delete)
- Workflow states (scheduled → in_progress → completed)
- Auto-creation on GRN completion
- Inspector assignment and reassignment
- Result determination logic
- LP QA status updates
- Permission enforcement
- RLS multi-tenancy isolation
- Audit trail creation
- API error handling
- Validation schemas

---

## Migration Information

**Migration File**: `supabase/migrations/141_create_quality_inspections.sql`

**Tables Created**:
- `quality_inspections`
- `inspection_number_sequences`

**Functions Created**:
- `generate_inspection_number()`
- `create_incoming_inspection_on_grn()` (trigger)
- `update_lp_qa_status_on_inspection()` (trigger)

**Status**: Deployed and applied to cloud database

---

## Regulatory Compliance

This story implements critical food safety compliance features:

- **HACCP**: Receiving temperature verification records
- **FDA 21 CFR Part 11**: Audit trail for all inspection actions
- **FDA FSMA**: Documented receiving inspections
- **Traceability**: Inspection linked to PO, GRN, LP, product, and batch
- **Retention**: Records retained per org configuration (min 2 years)

---

## Related Stories

- **06.3** - Product Specifications: Defines inspection criteria
- **06.4** - Test Parameters: Parameters within specifications
- **06.6** - Test Results Recording: Records results against parameters
- **06.7** - Sampling Plans: AQL-based sampling (future)
- **06.9** - NCR Creation: Auto-create on failed inspection (future)
- **06.10** - In-Process Inspection: Uses same patterns as incoming
- **06.11** - Final Inspection: Uses same patterns as incoming

---

## Troubleshooting

### Issue: Cannot start inspection without inspector

**Solution**: Use [Assign] button to assign inspector first, then start inspection.

### Issue: LP QA status not updating

**Solution**: Check trigger `update_lp_qa_status_on_inspection()` is active. Verify inspection.status = 'completed'.

### Issue: Auto-create not triggering on GRN completion

**Solution**: Check `quality_settings.auto_create_inspection_on_grn = true`. Ensure `create_incoming_inspection_on_grn()` trigger is active.

### Issue: Cannot find inspection by number

**Solution**: Inspection numbers are org-specific. Verify you're in correct org and check exact inspection number format.

---

## Next Steps

After 06.5, proceed with:

1. **06.6** - Test Results Recording: Record actual test results
2. **06.7** - Sampling Plans AQL: Advanced sampling strategies
3. **06.10** - In-Process Inspection: Inspections during production

---

**Document Status**: COMPLETE
**Deployed**: 2026-01-22
**Quality Gate**: PASSED
