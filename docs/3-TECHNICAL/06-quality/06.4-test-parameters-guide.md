# Story 06.4: Test Parameters - Implementation Guide

**Status**: DEPLOYED (2026-01-22)
**Version**: 1.0
**Last Updated**: 2026-01-22

---

## Overview

Story 06.4 implements test parameters for quality specifications with drag-to-reorder sequencing, four parameter types (numeric, text, boolean, range), critical parameter flagging, and test method configuration. This enables QA teams to define detailed acceptance criteria and test procedures for each product specification.

**Key Features**:
- Four parameter types: numeric, text, boolean, range
- Drag-to-reorder functionality with optimistic updates
- Critical parameter flagging
- Test method autocomplete with common methods
- Unit of measure support
- Acceptance criteria and sampling instructions
- Parameter validation per type
- Auto-sequence numbering

---

## Architecture

### Database Schema

**Table: quality_spec_parameters**

```sql
CREATE TABLE quality_spec_parameters (
    id                      UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    spec_id                 UUID NOT NULL REFERENCES quality_specifications(id) ON DELETE CASCADE,
    sequence                INTEGER NOT NULL,
    parameter_name          TEXT NOT NULL,
    parameter_type          TEXT NOT NULL
                            CHECK (parameter_type IN ('numeric', 'text', 'boolean', 'range')),
    target_value            TEXT,                    -- Target value (all types)
    min_value               DECIMAL(15,6),           -- For numeric/range types
    max_value               DECIMAL(15,6),           -- For numeric/range types
    unit                    TEXT,                    -- e.g., "°C", "kg", "pH", "%"
    test_method             TEXT,                    -- e.g., "AOAC 942.15", "Visual"
    instrument_required     BOOLEAN DEFAULT false,
    instrument_id           UUID REFERENCES machines(id),
    is_critical             BOOLEAN DEFAULT false,
    acceptance_criteria     TEXT,                    -- Additional criteria text
    sampling_instructions   TEXT,                    -- How to sample for this test
    created_at              TIMESTAMPTZ NOT NULL DEFAULT now(),
    created_by              UUID REFERENCES users(id),
    updated_at              TIMESTAMPTZ NOT NULL DEFAULT now(),
    updated_by              UUID REFERENCES users(id),

    CONSTRAINT uq_spec_sequence UNIQUE (spec_id, sequence),
    CONSTRAINT chk_numeric_values CHECK (
        parameter_type NOT IN ('numeric', 'range') OR
        (min_value IS NOT NULL OR max_value IS NOT NULL)
    )
);
```

**Key Indexes**:
- `idx_spec_parameters_spec` - Spec lookup
- `idx_spec_parameters_sequence` - Sequence ordering
- `idx_spec_parameters_critical` - Critical parameter filtering

**RLS Policies**:
- SELECT: Access via spec ownership
- INSERT/UPDATE: Only on draft specs (enforced by trigger)
- DELETE: Only on draft specs (RLS policy)

### Database Functions

**`get_next_parameter_sequence(p_spec_id)`**

Returns the next sequence number for a specification.

**`reorder_spec_parameters(p_spec_id, p_parameter_ids[])`**

Updates sequence numbers based on provided parameter ID order.

**`check_spec_draft_status()`** (Trigger)

Prevents parameter modification on non-draft specifications.

---

## API Endpoints

### List Parameters for Specification

**`GET /api/quality/specifications/:specId/parameters`**

List all parameters for a specification in sequence order.

**Example Response** (200 OK):
```json
{
  "parameters": [
    {
      "id": "param-001",
      "spec_id": "spec-001",
      "sequence": 1,
      "parameter_name": "Ash Content",
      "parameter_type": "numeric",
      "target_value": null,
      "min_value": 0.5,
      "max_value": 1.5,
      "unit": "%",
      "test_method": "AOAC 942.15",
      "instrument_required": false,
      "is_critical": true,
      "acceptance_criteria": "Ash content must be within limits",
      "sampling_instructions": "Sample from top, middle, bottom layers",
      "created_by": "user-qa-1",
      "created_at": "2025-12-15T08:00:00Z"
    },
    {
      "id": "param-002",
      "sequence": 2,
      "parameter_name": "Color",
      "parameter_type": "text",
      "target_value": "Golden Brown",
      "unit": null,
      "test_method": "Visual Inspection",
      "is_critical": false,
      "acceptance_criteria": "Uniform golden brown, no dark spots"
    }
  ],
  "spec": {
    "id": "spec-001",
    "spec_number": "QS-202512-001",
    "name": "Wheat Flour - Standard Grade",
    "status": "draft"
  }
}
```

---

### Add Parameter

**`POST /api/quality/specifications/:specId/parameters`**

Add a new parameter to a specification.

**Request Body**:
```json
{
  "parameter_name": "Ash Content",
  "parameter_type": "numeric",
  "min_value": 0.5,
  "max_value": 1.5,
  "unit": "%",
  "test_method": "AOAC 942.15",
  "is_critical": true,
  "acceptance_criteria": "Ash content must be within limits",
  "sampling_instructions": "Sample from multiple layers",
  "instrument_required": false
}
```

**Response** (201 Created):
```json
{
  "id": "param-001",
  "sequence": 1,
  "parameter_name": "Ash Content",
  "parameter_type": "numeric",
  "min_value": 0.5,
  "max_value": 1.5
}
```

**Validation**:
- For numeric/range: At least one of min_value or max_value required
- For range: Both min_value and max_value required
- min_value must be < max_value
- Only on draft specifications

---

### Update Parameter

**`PUT /api/quality/specifications/:specId/parameters/:id`**

Update an existing parameter.

**Request Body**: Same as create (partial fields allowed)

**Response** (200 OK): Updated parameter

**Constraints**:
- Only on draft specifications
- Cannot change spec_id
- Type changes clear incompatible fields

---

### Delete Parameter

**`DELETE /api/quality/specifications/:specId/parameters/:id`**

Delete a parameter.

**Response** (204 No Content)

**Constraints**:
- Only on draft specifications
- RLS policy enforces draft-only deletion

---

### Reorder Parameters

**`PATCH /api/quality/specifications/:specId/parameters/reorder`**

Reorder parameters by providing new sequence.

**Request Body**:
```json
{
  "parameter_ids": [
    "param-004",
    "param-001",
    "param-002",
    "param-003"
  ]
}
```

**Response** (200 OK):
```json
{
  "updated_count": 4,
  "parameters": [
    { "id": "param-004", "sequence": 1 },
    { "id": "param-001", "sequence": 2 },
    { "id": "param-002", "sequence": 3 },
    { "id": "param-003", "sequence": 4 }
  ]
}
```

**Constraints**:
- Only on draft specifications
- All parameter IDs must belong to the spec
- Optimistic updates recommended

---

## Service Layer

### SpecParameterService

Located at: `lib/services/spec-parameter-service.ts`

**Key Methods**:

```typescript
// Get parameters for a specification
static async getBySpecId(specId: string): Promise<QualitySpecParameter[]>;

// Create parameter with auto-sequence
static async create(
  specId: string,
  data: CreateParameterRequest,
  userId: string
): Promise<QualitySpecParameter>;

// Update parameter
static async update(
  parameterId: string,
  data: UpdateParameterRequest,
  userId: string
): Promise<QualitySpecParameter>;

// Delete parameter
static async delete(parameterId: string): Promise<void>;

// Reorder parameters
static async reorder(
  specId: string,
  parameterIds: string[]
): Promise<QualitySpecParameter[]>;

// Clone parameters to new spec version
static async cloneToNewSpec(
  sourceSpecId: string,
  targetSpecId: string,
  userId: string
): Promise<void>;

// Validate parameter value (for test results recording)
static validateValue(
  parameter: QualitySpecParameter,
  value: string | number | boolean
): { valid: boolean; reason?: string };
```

---

## Frontend Implementation

### Components

**ParameterEditor.tsx** (Main Container)
- Integrated into Specification Detail page
- Shows parameter list if parameters exist
- Empty state with [+ Add Parameter] button
- Summary: "X parameters (Y critical)"
- Type breakdown: "3 numeric, 2 text, 1 boolean"

**ParameterTable.tsx** (Draggable List)
- React DnD or @dnd-kit for drag-to-reorder
- Columns: Drag Handle, Sequence, Name, Type, Target/Range, Unit, Critical, Actions
- Drag handles visible only on draft specs
- Responsive: Mobile shows simplified view
- Optimistic update on drop

**ParameterForm.tsx** (Add/Edit Dialog)
- Modal with form fields
- Parameter name input (required)
- Type selector with conditional field visibility:
  - **Numeric**: Min, Max (at least one required), Target (optional), Unit
  - **Text**: Target (optional), Acceptance Criteria
  - **Boolean**: Target dropdown (Yes/No)
  - **Range**: Min & Max (both required), Target (optional), Unit
- Test method autocomplete
- Critical toggle
- Instrument dropdown (if instrument_required checked)
- Acceptance criteria textarea
- Sampling instructions textarea
- Save/Cancel buttons

**ParameterRow.tsx** (List Item)
- Drag handle (if draft)
- Sequence badge
- Parameter name (bold if critical)
- Type badge (color-coded):
  - Numeric: Blue
  - Text: Green
  - Boolean: Purple
  - Range: Orange
- Value display (Min/Max, Target, etc.)
- Test method (truncated with tooltip)
- Critical badge (red) if applicable
- Edit/Delete actions (draft only)

**CriticalBadge.tsx**
- Red badge with "Critical" text
- Tooltip: "Critical parameter - must pass for overall inspection pass"
- Icon: AlertCircle

**TestMethodAutocomplete.tsx**
- Combobox with common test methods
- Grouped by category: AOAC, ISO, Visual, Equipment
- Recently used methods
- Custom entry support
- Common methods:
  - AOAC 942.15 (Ash)
  - AOAC 990.03 (Protein)
  - ISO 5509 (Fatty Acids)
  - ISO 6579 (Salmonella)
  - Visual Inspection
  - pH Meter
  - Thermometer
  - Weighing
  - Calipers

**UnitSelector.tsx**
- Unit dropdown with common units
- Grouped by category:
  - Temperature: °C, °F, K
  - Weight: g, kg, lb, oz
  - Volume: mL, L, gal
  - Dimension: mm, cm, m, in, ft
  - pH: pH
  - Percentage: %
  - Concentration: ppm, ppb, mg/L
  - Time: s, min, h
- Custom entry support

---

## Parameter Types

### Numeric Type

Parameters with single min/max values and optional target.

```json
{
  "parameter_type": "numeric",
  "parameter_name": "Ash Content",
  "min_value": 0.5,
  "max_value": 1.5,
  "unit": "%",
  "target_value": null
}
```

**Validation**: `min_value < test_value < max_value`

---

### Range Type

Parameters with required min and max range.

```json
{
  "parameter_type": "range",
  "parameter_name": "Temperature",
  "min_value": 18.0,
  "max_value": 22.0,
  "unit": "°C",
  "target_value": 20.0
}
```

**Validation**: Both min and max required. `min < max`

---

### Text Type

Parameters with text acceptance criteria.

```json
{
  "parameter_type": "text",
  "parameter_name": "Color",
  "target_value": "Golden Brown",
  "acceptance_criteria": "Uniform golden brown, no dark spots"
}
```

**Validation**: Manual evaluation by inspector

---

### Boolean Type

Parameters with yes/no target.

```json
{
  "parameter_type": "boolean",
  "parameter_name": "No Foreign Material",
  "target_value": "Yes"
}
```

**Validation**: Result must match target value exactly

---

## Validation Rules

### Field Validation

| Field | Rules | Example |
|-------|-------|---------|
| Parameter Name | 2-200 chars, required | "Ash Content" |
| Type | Required, one of four types | "numeric" |
| Target Value | Optional, max 500 chars | "1.0" or "Golden Brown" |
| Min Value | Numeric, optional for numeric/range | 0.5 |
| Max Value | Numeric, optional for numeric/range | 1.5 |
| Unit | Optional, max 50 chars | "%", "°C", "kg" |
| Test Method | Optional, max 200 chars | "AOAC 942.15" |
| Acceptance Criteria | Optional, max 1000 chars | Multiline text |
| Sampling Instructions | Optional, max 1000 chars | Multiline text |

### Type-Specific Validation

**Numeric/Range Types**:
- At least one of min_value or max_value required
- If both provided: min < max
- Unit field recommended

**Range Type**:
- Both min_value and max_value required

**Boolean Type**:
- target_value must be "Yes" or "No"

**Text Type**:
- No numeric validation
- Manual evaluation by inspector

---

## Permission Model

| Role | View | Add | Edit Draft | Delete Draft | Reorder Draft |
|------|------|-----|-----------|--------------|---------------|
| VIEWER | ✓ | ✗ | ✗ | ✗ | ✗ |
| QA_INSPECTOR | ✓ | ✓ | ✓ | ✓ | ✓ |
| QA_MANAGER | ✓ | ✓ | ✓ | ✓ | ✓ |
| ADMIN | ✓ | ✓ | ✓ | ✓ | ✓ |

**Note**: Parameters on active/expired/superseded specs are always read-only.

---

## Usage Examples

### Adding a Numeric Parameter

1. Open specification detail page
2. Click [+ Add Parameter]
3. Enter parameter name: "Ash Content"
4. Select type: "Numeric"
5. Enter min value: 0.5
6. Enter max value: 1.5
7. Select unit: "%"
8. Select test method: "AOAC 942.15"
9. Check "Critical parameter"
10. Enter acceptance criteria
11. Click [Save]

### Reordering Parameters

1. Open draft specification with parameters
2. Drag parameter to new position
3. Drop to reorder
4. System updates sequence automatically
5. Changes persist on page reload

### Validating Parameter Values (Test Results)

```typescript
const parameter = {
  parameter_type: 'numeric',
  min_value: 0.5,
  max_value: 1.5
};

// Pass: value within range
const result1 = SpecParameterService.validateValue(parameter, 1.0);
// { valid: true }

// Fail: value above maximum
const result2 = SpecParameterService.validateValue(parameter, 2.0);
// { valid: false, reason: 'Above maximum (1.5)' }
```

---

## Integration with Other Stories

### Story 06.3 - Product Specifications

Parameters are created within a specification context. When a spec is cloned:
- All parameters are cloned to new version
- Parameter IDs are regenerated
- Sequence order is preserved

### Story 06.6 - Test Results Recording

Parameters are used to validate test results:
- Test result recorded against parameter ID
- Validation uses `validateValue()` method
- Critical parameters must pass for overall pass

---

## Performance Considerations

- **Load time**: Parameter list loads within 100ms
- **Reorder optimization**: Optimistic UI update, background sync
- **Search**: Test method autocomplete filters in real-time
- **Caching**: Recent test methods cached locally

---

## Testing Summary

**Tests Created**: 181 tests passing

**Coverage Areas**:
- Parameter CRUD (create, read, update, delete)
- Type-specific validation (numeric, text, boolean, range)
- Drag-to-reorder and sequence management
- Critical parameter marking
- Permission enforcement
- RLS isolation on draft-only edits
- Value validation for test results
- Spec cloning with parameter inheritance

---

## Migration Information

**Migration File**: `supabase/migrations/141_create_quality_spec_parameters.sql`

**Tables Created**:
- `quality_spec_parameters`

**Functions Created**:
- `get_next_parameter_sequence()`
- `reorder_spec_parameters()`
- `check_spec_draft_status()` (trigger)

**Status**: Deployed and applied to cloud database

---

## Related Stories

- **06.3** - Product Specifications: Parameters added to specs
- **06.5** - Incoming Inspection: Uses parameters for inspection
- **06.6** - Test Results Recording: Records results against parameters
- **06.10** - In-Process Inspection: Uses same parameter patterns
- **06.11** - Final Inspection: Uses same parameter patterns

---

## Troubleshooting

### Issue: Cannot add parameters to active spec

**Solution**: Parameters can only be added/edited on draft specs. Clone the spec as a new version to add parameters.

### Issue: Reorder not updating

**Solution**: Ensure optimistic UI is reverted on error. Check network tab for failed reorder request.

### Issue: Validation failing for numeric values

**Solution**: Check that min_value < max_value in parameter definition.

### Issue: Test method not appearing in autocomplete

**Solution**: Recently used methods are cached. Enter exact test method name or check database for existing values.

---

## Next Steps

After 06.4, proceed with:

1. **06.5** - Incoming Inspection: Create incoming inspections using specs with parameters
2. **06.6** - Test Results Recording: Record test results against parameters

---

**Document Status**: COMPLETE
**Deployed**: 2026-01-22
**Quality Gate**: PASSED
