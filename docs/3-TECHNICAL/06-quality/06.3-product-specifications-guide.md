# Story 06.3: Product Specifications - Implementation Guide

**Status**: DEPLOYED (2026-01-22)
**Version**: 1.0
**Last Updated**: 2026-01-22

---

## Overview

Story 06.3 implements versioned product quality specifications with approval workflows and active spec resolution. This enables QA teams to define test parameters and acceptance criteria per product with full version control and audit trails.

**Key Features**:
- Versioned specifications with effective/expiry dates
- Status workflow: draft → active → expired/superseded
- Approval workflow with role-based access
- Active specification auto-resolution
- Review frequency tracking and alerts
- Specification cloning for new versions
- Complete audit trail

---

## Architecture

### Database Schema

**Table: quality_specifications**

```sql
CREATE TABLE quality_specifications (
    id                      UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id                  UUID NOT NULL REFERENCES organizations(id),
    product_id              UUID NOT NULL REFERENCES products(id),
    spec_number             TEXT NOT NULL,           -- QS-YYYYMM-NNN format
    version                 INTEGER NOT NULL DEFAULT 1,
    name                    TEXT NOT NULL,
    description             TEXT,
    effective_date          DATE NOT NULL,
    expiry_date             DATE,                    -- NULL = no expiry
    status                  TEXT NOT NULL DEFAULT 'draft'
                            CHECK (status IN ('draft', 'active', 'expired', 'superseded')),
    approved_by             UUID REFERENCES users(id),
    approved_at             TIMESTAMPTZ,
    superseded_by           UUID REFERENCES quality_specifications(id),
    superseded_at           TIMESTAMPTZ,
    review_frequency_days   INTEGER DEFAULT 365,
    next_review_date        DATE,
    last_review_date        DATE,
    notes                   TEXT,
    created_at              TIMESTAMPTZ NOT NULL DEFAULT now(),
    created_by              UUID REFERENCES users(id),
    updated_at              TIMESTAMPTZ NOT NULL DEFAULT now(),
    updated_by              UUID REFERENCES users(id),

    CONSTRAINT uq_spec_number_version UNIQUE (org_id, spec_number, version)
);
```

**Key Indexes**:
- `idx_quality_specs_org_id` - Org filtering
- `idx_quality_specs_product` - Product lookup
- `idx_quality_specs_status` - Status filtering
- `idx_quality_specs_effective` - Effective date range queries
- `idx_quality_specs_review` - Next review date tracking (active specs only)
- `idx_quality_specs_number` - Spec number lookup

**RLS Policies**:
All policies enforce `org_id` isolation. Only draft specifications can be deleted.

### Database Functions

**`get_active_specification(p_org_id, p_product_id, p_as_of_date)`**

Returns the active specification for a product as of a given date.

```sql
SELECT id FROM quality_specifications
WHERE org_id = p_org_id
  AND product_id = p_product_id
  AND status = 'active'
  AND effective_date <= p_as_of_date
  AND (expiry_date IS NULL OR expiry_date >= p_as_of_date)
ORDER BY effective_date DESC, version DESC
LIMIT 1;
```

**`supersede_previous_spec()`** (Trigger)

Automatically marks previous active specs as superseded when a new version is activated.

---

## API Endpoints

### List Specifications

**`GET /api/quality/specifications`**

List all specifications with filtering and pagination.

**Query Parameters**:
- `status` (string) - Filter by status: draft, active, expired, superseded
- `product_id` (uuid) - Filter by product
- `search` (string) - Search by spec_number or name
- `page` (number, default: 1) - Pagination
- `limit` (number, default: 20) - Page size
- `sort_by` (string, default: created_at) - Sort field
- `sort_order` (string, default: desc) - asc or desc

**Example Request**:
```bash
curl "https://api.monopilot.io/api/quality/specifications?status=active&limit=20"
```

**Response** (200 OK):
```json
{
  "specifications": [
    {
      "id": "spec-001",
      "org_id": "org-001",
      "product_id": "prod-001",
      "product_name": "Flour - Wheat",
      "product_code": "SKU-001",
      "spec_number": "QS-202501-001",
      "version": 2,
      "name": "Wheat Flour - Standard Grade",
      "status": "active",
      "effective_date": "2025-12-15",
      "expiry_date": null,
      "approved_by": "user-qa-mgr",
      "approved_by_name": "Jane QA Manager",
      "approved_at": "2025-12-15T10:30:00Z",
      "review_frequency_days": 365,
      "next_review_date": "2026-12-15",
      "last_review_date": null,
      "review_status": "ok",
      "days_until_review": 327,
      "version_count": 2,
      "created_at": "2025-12-15T08:00:00Z",
      "created_by": "user-qa-1",
      "updated_at": "2025-12-15T10:30:00Z",
      "updated_by": "user-qa-mgr"
    }
  ],
  "pagination": {
    "total": 45,
    "page": 1,
    "limit": 20,
    "pages": 3
  }
}
```

---

### Get Specification Detail

**`GET /api/quality/specifications/:id`**

Retrieve full specification details including version history.

**Example Response** (200 OK):
```json
{
  "specification": {
    "id": "spec-001",
    "spec_number": "QS-202501-001",
    "version": 2,
    "name": "Wheat Flour - Standard Grade",
    "description": "High-quality wheat flour for baking applications",
    "status": "active",
    "effective_date": "2025-12-15",
    "approved_at": "2025-12-15T10:30:00Z",
    "review_frequency_days": 365,
    "next_review_date": "2026-12-15"
  },
  "version_history": [
    {
      "id": "spec-001",
      "version": 2,
      "status": "active",
      "effective_date": "2025-12-15",
      "approved_by_name": "Jane QA Manager",
      "approved_at": "2025-12-15T10:30:00Z"
    },
    {
      "id": "spec-old-001",
      "version": 1,
      "status": "superseded",
      "effective_date": "2025-10-01",
      "approved_by_name": "Jane QA Manager",
      "approved_at": "2025-10-01T09:00:00Z"
    }
  ],
  "parameters_count": 8
}
```

---

### Create Specification (Draft)

**`POST /api/quality/specifications`**

Create a new draft specification.

**Request Body**:
```json
{
  "product_id": "prod-001",
  "name": "Wheat Flour - Standard Grade",
  "description": "High-quality wheat flour for baking applications",
  "effective_date": "2025-12-15",
  "expiry_date": null,
  "review_frequency_days": 365,
  "notes": "Updated ash content limits"
}
```

**Response** (201 Created):
```json
{
  "id": "spec-001",
  "spec_number": "QS-202512-001",
  "version": 1,
  "status": "draft",
  "product_id": "prod-001",
  "name": "Wheat Flour - Standard Grade",
  "effective_date": "2025-12-15"
}
```

---

### Update Specification (Draft Only)

**`PUT /api/quality/specifications/:id`**

Update a draft specification. Cannot be used on approved specs.

**Request Body**:
```json
{
  "name": "Wheat Flour - Premium Grade",
  "description": "Updated description",
  "review_frequency_days": 180
}
```

**Response** (200 OK):
```json
{
  "id": "spec-001",
  "spec_number": "QS-202512-001",
  "version": 1,
  "status": "draft",
  "name": "Wheat Flour - Premium Grade",
  "updated_at": "2026-01-22T14:30:00Z"
}
```

**Error Responses**:
- `400` - If attempting to update active/expired spec
- `404` - Spec not found
- `403` - Org isolation violation

---

### Approve Specification

**`POST /api/quality/specifications/:id/approve`**

Approve a draft specification. Changes status to active and supersedes any previous active specs.

**Request Body**:
```json
{
  "approval_notes": "Meets all QA requirements"
}
```

**Response** (200 OK):
```json
{
  "specification": {
    "id": "spec-001",
    "spec_number": "QS-202512-001",
    "version": 1,
    "status": "active",
    "approved_by": "user-qa-mgr",
    "approved_by_name": "Jane QA Manager",
    "approved_at": "2026-01-22T14:35:00Z",
    "next_review_date": "2027-01-22"
  },
  "superseded_specs": [
    {
      "id": "spec-old-001",
      "spec_number": "QS-202510-001",
      "version": 1
    }
  ]
}
```

**Permission Check**: Requires `QA_MANAGER` role. Users with `QA_INSPECTOR` role cannot approve.

---

### Clone as New Version

**`POST /api/quality/specifications/:id/clone`**

Create a new draft version of an existing specification.

**Request Body**: Empty

**Response** (201 Created):
```json
{
  "specification": {
    "id": "spec-new-001",
    "spec_number": "QS-202512-001",
    "version": 2,
    "status": "draft",
    "name": "Wheat Flour - Standard Grade (copied from v1)",
    "effective_date": "2026-01-22",
    "notes": "Cloned from version 1"
  }
}
```

---

### Get Active Specification for Product

**`GET /api/quality/specifications/product/:productId/active`**

Resolve the active specification for a product on a given date (default: today).

**Query Parameters**:
- `as_of_date` (date, ISO format) - Optional date to check (defaults to today)

**Example Response** (200 OK):
```json
{
  "specification": {
    "id": "spec-001",
    "spec_number": "QS-202512-001",
    "version": 2,
    "status": "active",
    "name": "Wheat Flour - Standard Grade"
  }
}
```

**Error Responses**:
- `404` - No active specification found for product

---

### Complete Review

**`POST /api/quality/specifications/:id/complete-review`**

Mark a specification as reviewed and recalculate next review date.

**Request Body**:
```json
{
  "review_notes": "All parameters reviewed and approved"
}
```

**Response** (200 OK):
```json
{
  "specification": {
    "id": "spec-001",
    "last_review_date": "2026-01-22",
    "next_review_date": "2027-01-22"
  },
  "previous_review_date": "2025-01-22"
}
```

---

## Service Layer

### SpecificationService

Located at: `lib/services/specification-service.ts`

**Key Methods**:

```typescript
// Get specification by ID
static async getById(specId: string): Promise<QualitySpecification>;

// List specifications with filtering
static async list(params: ListParams): Promise<PaginatedResult>;

// Create draft specification
static async create(input: CreateInput, userId: string): Promise<QualitySpecification>;

// Update draft specification
static async update(specId: string, input: UpdateInput, userId: string): Promise<QualitySpecification>;

// Approve specification
static async approve(specId: string, userId: string, notes?: string): Promise<{
  spec: QualitySpecification;
  superseded: string[];
}>;

// Clone as new version
static async cloneAsNewVersion(specId: string, userId: string): Promise<QualitySpecification>;

// Get active spec for product
static async getActiveForProduct(
  orgId: string,
  productId: string,
  asOfDate?: Date
): Promise<QualitySpecification | null>;

// Complete review cycle
static async completeReview(
  specId: string,
  userId: string,
  notes?: string
): Promise<QualitySpecification>;

// Delete draft specification
static async delete(specId: string): Promise<void>;
```

---

## Frontend Implementation

### Pages

**Specifications List Page** (`/quality/specifications`)
- DataTable with columns: Spec#, Name, Product, Version, Status, Effective Date, Review Status
- Filters: Status, Product, Date Range
- Search: By spec_number or name
- Sort: All columns
- Actions: View, Edit (draft), Approve (draft), Clone

**Specification Detail Page** (`/quality/specifications/:id`)
- Header: Spec number, status badge, version badge
- Product information with link
- All specification fields in read-only or edit mode
- Version history timeline
- Action buttons based on status and role
- Review status with alert badges

**Create Specification Page** (`/quality/specifications/new`)
- Product dropdown (required, searchable)
- Name input (required)
- Description textarea
- Effective date picker (required)
- Expiry date picker (optional)
- Review frequency input
- Notes textarea
- Save Draft button

### Components

**SpecificationTable.tsx**
- ShadCN DataTable pattern
- Configurable columns
- Responsive design
- Built-in filters sidebar
- Quick actions menu

**SpecificationForm.tsx**
- Reactive form with Zod validation
- Product search with autocomplete
- Date pickers with validation
- Auto-generated spec number preview
- Field-level error messages

**SpecificationDetail.tsx**
- Read-only or edit mode based on status
- Version history sidebar
- Status badges with appropriate styling
- Action buttons based on permissions and status

**ApproveModal.tsx**
- Confirmation message with product name
- Warning about superseding existing specs
- Optional approval notes
- Role-based visibility

**VersionHistory.tsx**
- Timeline of all specification versions
- Status, effective date, approved by info
- Clickable to view any version

**ReviewStatusBadge.tsx**
- Green: Reviewed, no action needed
- Yellow: Review due within 30 days
- Red: Review overdue

**CloneVersionDialog.tsx**
- Confirmation with details of new version
- Auto-filled new version number
- Effective date set to today

---

## Validation Rules

### Field Validation

| Field | Rules | Example |
|-------|-------|---------|
| Product | Required, must exist | Must select from dropdown |
| Name | 3-200 chars, required | "Wheat Flour Standard" |
| Description | Max 2000 chars | Optional, up to 2000 chars |
| Effective Date | Required, valid date | 2025-12-15 |
| Expiry Date | Optional, must be > effective | 2026-12-15 |
| Review Frequency | 1-3650 days, default 365 | 180, 365, 730 |
| Notes | Max 2000 chars | Optional notes |

### Business Rules

1. **Version Uniqueness**: `(org_id, spec_number, version)` must be unique
2. **Status Workflow**: draft → active → expired/superseded (no reversal)
3. **Single Active**: Only one active spec per product at a time
4. **Immutability**: Active specs cannot be edited (must clone)
5. **Draft Deletion**: Only draft specs can be deleted
6. **Review Calculation**: `next_review_date = effective_date + review_frequency_days`
7. **Expiry Check**: Specs with `expiry_date` in past are marked as 'expired'

---

## Permission Model

| Role | List | View | Create | Edit Draft | Approve | Delete Draft |
|------|------|------|--------|-----------|---------|--------------|
| VIEWER | ✓ | ✓ | ✗ | ✗ | ✗ | ✗ |
| QA_INSPECTOR | ✓ | ✓ | ✓ | ✓ | ✗ | ✓ |
| QA_MANAGER | ✓ | ✓ | ✓ | ✓ | ✓ | ✓ |
| ADMIN | ✓ | ✓ | ✓ | ✓ | ✓ | ✓ |

---

## Usage Examples

### Creating a New Specification

1. Navigate to Quality > Specifications
2. Click [+ New Specification]
3. Select product: "Wheat Flour - Type 55"
4. Enter name: "Wheat Flour - Standard Grade"
5. Set effective date: 2025-12-15
6. Set review frequency: 365 days
7. Click [Save Draft]

### Approving a Specification

1. Find draft specification in list
2. Click to open detail page
3. Verify all information
4. Click [Approve]
5. Review warning about superseding existing specs
6. Click [Confirm]
7. Spec is now active and available for inspections

### Creating a New Version

1. Open active specification
2. Click [Clone as New Version]
3. Review new version details
4. Make edits as needed
5. Click [Save Draft]
6. When ready, click [Approve] to activate new version

---

## Audit Trail

All specification changes are logged with:
- Entity type: 'specification'
- Action: 'create', 'update', 'approve', 'supersede', 'review_completed', 'delete'
- User ID and timestamp
- Old and new values for updates
- Approval notes

---

## Performance Considerations

- **List performance**: < 500ms for 1000+ specs with pagination
- **Queries indexed**: org_id, product_id, status, effective_date
- **Active resolution**: Uses database function for consistent logic
- **Caching**: Frontend caches active spec list (5-minute TTL)

---

## Testing Summary

**Tests Created**: 103 tests passing

**Coverage Areas**:
- Specification CRUD (create, read, update, delete)
- Approval workflow and superseding
- Version cloning
- Active spec resolution
- Review date tracking
- Permission enforcement
- RLS multi-tenancy isolation
- API error handling
- Validation schemas

---

## Migration Information

**Migration File**: `supabase/migrations/139_create_quality_specifications.sql`

**Tables Created**:
- `quality_specifications` (main table)

**Migrations Applied**:
- 139: quality_specifications table

**Status**: Deployed and applied to cloud database

---

## Related Stories

- **06.4** - Test Parameters: Defines parameters within specifications
- **06.5** - Incoming Inspection: Uses specifications for inspection criteria
- **06.6** - Test Results Recording: Records results against spec parameters

---

## Troubleshooting

### Issue: Cannot edit approved specification

**Solution**: Approved specs are immutable. Clone as new version to make changes.

### Issue: New spec not appearing in active resolution

**Solution**: Ensure effective_date is today or in the past, and status is 'active'.

### Issue: Previous spec not being superseded

**Solution**: Database trigger automatically handles superseding on approval. Check trigger status.

---

## Next Steps

After 06.3, proceed with:

1. **06.4** - Test Parameters: Add test parameters to specifications
2. **06.5** - Incoming Inspection: Create incoming inspections using specs
3. **06.6** - Test Results Recording: Record test results against parameters

---

**Document Status**: COMPLETE
**Deployed**: 2026-01-22
**Quality Gate**: PASSED
