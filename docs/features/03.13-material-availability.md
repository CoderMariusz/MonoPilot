# Material Availability Check

**Story ID:** 03.13
**Module:** `lib/services/material-availability-service`

## Overview

The Material Availability Check feature provides real-time inventory insights for Work Orders (WOs). It calculates the net available quantity of materials required for a WO by aggregating License Plate (LP) quantities, excluding expired stock, and deducting stock reserved by other active Work Orders.

The system visualizes availability status using a traffic light system:

| Status | Coverage | Description |
|--------|----------|-------------|
| `sufficient` | â‰¥ 100% | All required material is available. |
| `low_stock` | 50% - 99% | Material is available, but below required quantity. |
| `shortage` | 1% - 49% | Critical shortage of material. |
| `no_stock` | 0% | No available stock found. |

## Core Logic

### 1. Net Available Calculation

The core availability metric is calculated as:

```text
Net Available = (Sum of Available LPs) - (Reserved by other WOs)
```

*   **Available LPs:** Sums `quantity` from `license_plates` where `status = 'available'`.
*   **Expiry Filtering:** LPs with `expiry_date < today` are excluded from the available sum.
*   **Reservation Deduction:** Active reservations (`status = 'active'`) from `lp_reservations` linked to other WOs are subtracted. The calculation uses `reserved_qty - consumed_qty` to determine the net reserved amount.

### 2. Caching Strategy

To optimize performance, availability results are cached in-memory using a Map structure with a 30-second TTL (Time To Live). This reduces database load for frequent checks on the same Work Order.

*   **Cache Key:** `org:{orgId}:wo:{woId}:availability`
*   **TTL:** 30 seconds

### 3. Service API

The `MaterialAvailabilityService` class exposes static methods for checking availability.

#### `checkWOAvailability`

Main entry point to check materials for a specific Work Order.

```typescript
import { MaterialAvailabilityService } from '@/lib/services/material-availability-service'

const response = await MaterialAvailabilityService.checkWOAvailability(
  supabase, // SupabaseClient
  woId,     // string
  orgId,    // string
  { skipCache: false, settingEnabled: true }
)
```

**Returns:** `AvailabilityResponse`

```typescript
interface AvailabilityResponse {
  wo_id: string
  checked_at: string
  overall_status: 'sufficient' | 'low_stock' | 'shortage' | 'no_stock'
  materials: MaterialAvailability[]
  summary: AvailabilitySummary
  enabled: boolean
  cached: boolean
  cache_expires_at?: string
}
```

### 4. Pure Functions

The service exports pure utility functions for unit testing calculations:

*   `calculateCoveragePercent(available, required)`: Returns percentage (0-100).
*   `calculateAvailabilityStatus(percent)`: Returns status string.
*   `calculateShortageQty(required, available)`: Returns deficit quantity.
*   `calculateOverallStatus(statuses[])`: Returns worst-case status from an array.

## Integration with Supabase

The service relies on specific database schema structures:

1.  **`work_orders`**: Verified to exist and belong to the organization.
2.  **`wo_materials`**: Joined with `products` to get requirements.
3.  **`license_plates`**: Aggregated for physical stock.
4.  **`lp_reservations`**: Joined with `license_plates` to calculate reserved stock.

Ensure Row Level Security (RLS) policies allow the service role (or user role via client) to read from these tables.
