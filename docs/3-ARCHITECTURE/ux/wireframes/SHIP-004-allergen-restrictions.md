# SHIP-004: Allergen Restrictions Management

**Module**: Shipping Management
**Feature**: Customer Allergen Restrictions & Sales Order Validation
**Status**: Ready for Review
**Last Updated**: 2025-12-15

---

## User Flow

```
HAPPY PATH:
Customer Detail
  â†“
[View Allergen Restrictions Tab]
  â†“
Success: Display existing restrictions
  â”œâ”€ Empty State: "No allergens set"
  â””â”€ Success State: Show 1-5 allergens with severity levels
  â†“
[Edit] Button
  â†“
Edit Modal Opens
  â”œâ”€ Multi-select allergen list (Peanut, Tree Nut, Milk, Wheat, Soy, Fish, Shellfish, Sesame, Custom)
  â”œâ”€ Severity levels: Normal/Moderate/Severe/Critical
  â”œâ”€ Last modified info
  â””â”€ [Save] [Cancel] Buttons
  â†“
Confirm Save
  â†“
Success: Data saved + confirmation toast

BLOCKING PATH (Sales Order):
Sales Order Creation
  â†“
[Confirm] Button
  â†“
System Validates: Check customer's allergen restrictions
  â”œâ”€ No conflicts â†’ Proceed (success)
  â””â”€ Allergen conflict found â†’ Block order
      â†“
      Alert Modal: "Allergen Warning"
      â”œâ”€ Product: "Peanut Brittle"
      â”œâ”€ Customer allergen: "Peanut (Severe)"
      â”œâ”€ Risk level: CRITICAL
      â”œâ”€ [Cancel Order] [Manager Override] buttons
      â”‚
      â”œâ”€ Manager Override Path:
      â”‚  â”œâ”€ Modal asks for "Manager Code" (4-6 digits)
      â”‚  â”œâ”€ Rate limit: 3 attempts per hour
      â”‚  â”œâ”€ On success â†’ Order confirmed with override logged
      â”‚  â””â”€ On failure â†’ Locked for 30 minutes
      â”‚
      â””â”€ Cancel Order Path:
         â””â”€ Return to order form (no save)

PACKING STATION PATH:
Packing Station Scanner
  â†“
Scan Product (LP barcode)
  â†“
Scan Customer Order
  â†“
System Validates: Check allergen restrictions
  â”œâ”€ No conflicts â†’ "Pack OK" (green)
  â””â”€ Allergen conflict â†’ Blocking Alert
      â”œâ”€ Large visual warning (red banner)
      â”œâ”€ Audio alert (configurable)
      â”œâ”€ No way to proceed (unlike sales order)
      â””â”€ Supervisor must investigate/cancel

ERROR PATHS:
Loading Failed
  â”œâ”€ [Retry] button
  â”œâ”€ [Contact Support] link
  â””â”€ [Continue Anyway] option (with warning)

Network Timeout
  â”œâ”€ Show cached data if available
  â””â”€ Fallback to safe default (assume restrictions apply)

DATABASE ERROR
  â””â”€ Log error + notify admin + show user-friendly message

DECISION POINTS:
1. "Override Allowed?" (Yes = Manager Code required, No = Hard block)
2. "Log Allergen Events?" (Yes = Audit trail, No = Basic logging only)
3. "Audio Alert?" (Packing station feature)
4. "Custom Allergens?" (Yes = Allow user-defined, No = Predefined list only)
```

---

## ASCII Wireframes

### Screen 1: Customer Detail - Allergen Restrictions Section (Success State)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Customer: Acme Foods LLC (CUST-0042)                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  [Details] [Contacts] [Addresses] [Orders] [Allergens] [Credits] [Stats]â”‚
â”‚                                                                          â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• â”‚
â”‚  ALLERGEN RESTRICTIONS                                    [âœ Edit]     â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• â”‚
â”‚                                                                          â”‚
â”‚  â„¹ Customer restricted from:                                            â”‚
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ ğŸ”´ PEANUTS       â”‚ â”‚ ğŸŸ  TREE NUTS     â”‚ â”‚ ğŸŸ¡ MILK          â”‚        â”‚
â”‚  â”‚                  â”‚ â”‚                  â”‚ â”‚                  â”‚        â”‚
â”‚  â”‚ SEVERE           â”‚ â”‚ MODERATE         â”‚ â”‚ NORMAL           â”‚        â”‚
â”‚  â”‚ Anaphylaxis risk â”‚ â”‚ GI distress      â”‚ â”‚ Minor reaction   â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚  â”‚ ğŸŸ¢ WHEAT         â”‚ â”‚ ğŸŸ¢ SOY           â”‚                              â”‚
â”‚  â”‚                  â”‚ â”‚                  â”‚                              â”‚
â”‚  â”‚ NORMAL           â”‚ â”‚ NORMAL           â”‚                              â”‚
â”‚  â”‚ Mild itching     â”‚ â”‚ Mild itching     â”‚                              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â”‚                                                                          â”‚
â”‚  Last updated: 2025-12-10 by Sarah Johnson                              â”‚
â”‚  Next review due: 2025-03-10 (quarterly)                                â”‚
â”‚                                                                          â”‚
â”‚  â„¹ï¸ Note: These restrictions are enforced at SO confirmation and        â”‚
â”‚     packing station. Critical allergens (red) trigger warnings.        â”‚
â”‚                                                                          â”‚
â”‚  [History] [Recommendations]                                            â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Key Elements:**
- Allergen cards: Color-coded by severity (Red/Orange/Yellow/Green = SEVERE/MODERATE/NORMAL/CRITICAL)
- Severity levels: Icons + text description of reaction type
- Last modified timestamp + editor
- Metadata: Quarterly review dates, recommendations link
- Edit button: Opens modal

### Screen 2: Edit Allergen Restrictions Modal

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âœ EDIT ALLERGEN RESTRICTIONS FOR: ACME FOODS LLC (CUST-0042)  [âœ•]     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  These restrictions are enforced at SO confirmation and packing.        â”‚
â”‚  Changes take effect immediately.                                       â”‚
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ALLERGEN NAME           â”‚ SEVERITY LEVEL    â”‚ DESCRIPTION          â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚ [âœ“] Peanuts             â”‚ [SEVERE â–¼]        â”‚ Anaphylaxis risk     â”‚ â”‚
â”‚  â”‚ [ ] Tree Nuts           â”‚ [MODERATE â–¼]      â”‚ GI distress          â”‚ â”‚
â”‚  â”‚ [ ] Milk                â”‚ [NORMAL â–¼]        â”‚ Minor reaction       â”‚ â”‚
â”‚  â”‚ [ ] Wheat               â”‚ [NORMAL â–¼]        â”‚ Mild itching         â”‚ â”‚
â”‚  â”‚ [ ] Soy                 â”‚ [NORMAL â–¼]        â”‚ Mild itching         â”‚ â”‚
â”‚  â”‚ [ ] Fish                â”‚ [- â–¼]             â”‚ (not selected)        â”‚ â”‚
â”‚  â”‚ [ ] Shellfish           â”‚ [- â–¼]             â”‚ (not selected)        â”‚ â”‚
â”‚  â”‚ [ ] Sesame              â”‚ [- â–¼]             â”‚ (not selected)        â”‚ â”‚
â”‚  â”‚ [ ] Sulfites            â”‚ [- â–¼]             â”‚ (not selected)        â”‚ â”‚
â”‚  â”‚ [ ] Mustard             â”‚ [- â–¼]             â”‚ (not selected)        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                          â”‚
â”‚  + Add Custom Allergen                                                  â”‚
â”‚                                                                          â”‚
â”‚  Validation Notes (Inline):                                             â”‚
â”‚  âœ“ Ready to save (5 restrictions selected)                              â”‚
â”‚  Last saved: 2025-12-10 12:30 UTC by Sarah Johnson                      â”‚
â”‚                                                                          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚  [Save Changes] [Cancel] [Discard & Exit]                              â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Key Elements:**
- Checkbox + allergen name + severity dropdown + description
- All 10 common allergens listed
- Custom allergen addition option
- Validation message: count of selected restrictions
- Three action buttons: Save, Cancel, Discard

### Screen 3: Sales Order Confirmation - Allergen Alert (Error State)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âš ï¸  ALLERGEN CONFLICT WARNING                                    [âœ•]   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  ğŸš¨ CRITICAL - Cannot confirm order without override                   â”‚
â”‚                                                                          â”‚
â”‚  ORDER DETAILS:                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ SO-2025-5678                                                       â”‚ â”‚
â”‚  â”‚ Customer: Acme Foods LLC (CUST-0042)                              â”‚ â”‚
â”‚  â”‚ Date: 2025-12-15 14:30 UTC                                         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                          â”‚
â”‚  CONFLICTING PRODUCT(S):                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ â€¢ Peanut Brittle (SKU-1234)                                        â”‚ â”‚
â”‚  â”‚   Qty: 5 x 100g boxes                                              â”‚ â”‚
â”‚  â”‚   Batch: B-2025-7890                                               â”‚ â”‚
â”‚  â”‚   Allergen: PEANUTS (SEVERE)                                       â”‚ â”‚
â”‚  â”‚                                                                     â”‚ â”‚
â”‚  â”‚ â€¢ Mixed Nuts Trail Mix (SKU-5678)                                 â”‚ â”‚
â”‚  â”‚   Qty: 2 x 500g bags                                               â”‚ â”‚
â”‚  â”‚   Batch: B-2025-7891                                               â”‚ â”‚
â”‚  â”‚   Allergen: TREE NUTS (MODERATE)                                   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                          â”‚
â”‚  CUSTOMER ALLERGEN RESTRICTIONS:                                         â”‚
â”‚  ğŸ”´ Peanuts (SEVERE) - Anaphylaxis risk                                â”‚
â”‚  ğŸŸ  Tree Nuts (MODERATE) - GI distress                                 â”‚
â”‚                                                                          â”‚
â”‚  RISK ASSESSMENT:                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Risk Level: CRITICAL ğŸ”´                                            â”‚ â”‚
â”‚  â”‚ Recommendation: CANCEL ORDER                                       â”‚ â”‚
â”‚  â”‚                                                                     â”‚ â”‚
â”‚  â”‚ This customer has SEVERE anaphylaxis risk with peanuts and        â”‚ â”‚
â”‚  â”‚ MODERATE GI reaction to tree nuts. Fulfilling this order poses    â”‚ â”‚
â”‚  â”‚ significant health risk.                                           â”‚ â”‚
â”‚  â”‚                                                                     â”‚ â”‚
â”‚  â”‚ Contact customer support before proceeding.                        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                          â”‚
â”‚  MANAGER OVERRIDE (Requires Supervisor Code):                            â”‚
â”‚  [ğŸ”“ Unlock with Manager Code]                                          â”‚
â”‚                                                                          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚  [Cancel Order] [Enter Manager Code]                                    â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Key Elements:**
- Critical alert banner (red/yellow)
- Order summary section (SO#, customer, date)
- Conflicting products (SKU, qty, batch, allergen)
- Customer restrictions (color-coded severity)
- Risk assessment section
- Manager override section (with code entry)
- Two action buttons

### Screen 4: Manager Override Modal

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ” ENTER MANAGER CODE                                            [âœ•]   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  You are about to override allergen restrictions for:                   â”‚
â”‚  SO-2025-5678 | Acme Foods LLC | Peanut Brittle (SEVERE allergen)     â”‚
â”‚                                                                          â”‚
â”‚  âš ï¸  IMPORTANT:                                                           â”‚
â”‚  â€¢ This action is logged and audited                                     â”‚
â”‚  â€¢ You take responsibility for customer safety                           â”‚
â”‚  â€¢ Ensure customer has been notified and approved                        â”‚
â”‚  â€¢ Failed attempts are rate-limited (3 per hour)                         â”‚
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Enter 4-6 Digit Manager Code:                                      â”‚ â”‚
â”‚  â”‚                                                                     â”‚ â”‚
â”‚  â”‚ [â—â—â—â—]                                                             â”‚ â”‚
â”‚  â”‚                                                                     â”‚ â”‚
â”‚  â”‚ Remaining attempts: 2 of 3 (Locked for 30 min after 3 failed)     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                          â”‚
â”‚  ğŸ“‹ AUDIT TRAIL:                                                         â”‚
â”‚  Last override by this account: 2025-12-10 16:45 UTC (Sarah Johnson)    â”‚
â”‚  Today's overrides: 0 (limit: 10/day)                                   â”‚
â”‚                                                                          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚  [Confirm Override] [Cancel]                                            â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Key Elements:**
- Warning text (customer safety responsibility)
- 4-6 digit password field (masked)
- Rate limiting info (3 attempts/hour, 30min lockout)
- Audit trail (last override, today's count)
- Two action buttons

### Screen 5: Sales Order Detail - Line Items with Allergen Badges

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Sales Order: SO-2025-5678 | Status: âœ“ Confirmed                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Customer: Acme Foods LLC | Date: 2025-12-15                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  ORDER LINES:                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Line â”‚ SKU      â”‚ Product           â”‚ Qty   â”‚ Unit â”‚ Allergens   â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚ 1    â”‚ SKU-1234 â”‚ Peanut Brittle    â”‚ 5     â”‚ box  â”‚ ğŸ”´ PEANUTS  â”‚ â”‚
â”‚  â”‚      â”‚          â”‚ Batch: B-2025-7890â”‚       â”‚ 100g â”‚ (SEVERE)    â”‚ â”‚
â”‚  â”‚      â”‚          â”‚                   â”‚       â”‚      â”‚ ğŸ”“ Overridden
â”‚  â”‚      â”‚          â”‚                   â”‚       â”‚      â”‚ by S.Johnsonâ”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚ 2    â”‚ SKU-5678 â”‚ Mixed Nuts Trail  â”‚ 2     â”‚ bag  â”‚ ğŸŸ  TREE NUTSâ”‚ â”‚
â”‚  â”‚      â”‚          â”‚ Mix               â”‚       â”‚ 500g â”‚ (MODERATE)  â”‚ â”‚
â”‚  â”‚      â”‚          â”‚ Batch: B-2025-7891â”‚       â”‚      â”‚ ğŸ”“ Overridden
â”‚  â”‚      â”‚          â”‚                   â”‚       â”‚      â”‚ by S.Johnsonâ”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚ 3    â”‚ SKU-9012 â”‚ Milk Chocolate    â”‚ 10    â”‚ bar  â”‚ ğŸŸ¡ MILK     â”‚ â”‚
â”‚  â”‚      â”‚          â”‚ Batch: B-2025-7892â”‚       â”‚ 50g  â”‚ (NORMAL)    â”‚ â”‚
â”‚  â”‚      â”‚          â”‚                   â”‚       â”‚      â”‚ No override â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                          â”‚
â”‚  â„¹ï¸ 2 lines have allergen overrides (highlighted):                      â”‚
â”‚     - Overridden by: Sarah Johnson                                      â”‚
â”‚     - Override date: 2025-12-15 14:35 UTC                               â”‚
â”‚     - Manager code used (hash): 7a3f...9e2c                             â”‚
â”‚                                                                          â”‚
â”‚  [Print SO] [Download PDF] [Print Label] [Start Picking]               â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Key Elements:**
- Line items table with allergen badges
- Severity color codes (Red/Orange/Yellow/Green)
- Override indicator (ğŸ”“ with who/when)
- Click allergen badge for tooltip
- Action buttons

### Screen 6: Allergen Badge Tooltip/Detail

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Product: Peanut Brittle (SKU-1234)                                      â”‚
â”‚  Allergen Badge: [ğŸ”´ PEANUTS (SEVERE)]                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  [Tooltip on Hover]:                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ğŸ”´ PEANUTS (SEVERE)                                                â”‚ â”‚
â”‚  â”‚                                                                     â”‚ â”‚
â”‚  â”‚ Reaction Type: Anaphylaxis (life-threatening)                     â”‚ â”‚
â”‚  â”‚ Contains: Peanut oil, roasted peanuts                             â”‚ â”‚
â”‚  â”‚ Batch: B-2025-7890                                                 â”‚ â”‚
â”‚  â”‚ Expiry: 2026-06-30                                                 â”‚ â”‚
â”‚  â”‚                                                                     â”‚ â”‚
â”‚  â”‚ âš ï¸  Customer Allergen Status:                                       â”‚ â”‚
â”‚  â”‚    Peanuts (SEVERE) - Anaphylaxis risk                            â”‚ â”‚
â”‚  â”‚    Status: OVERRIDDEN by Sarah Johnson (2025-12-15 14:35 UTC)     â”‚ â”‚
â”‚  â”‚                                                                     â”‚ â”‚
â”‚  â”‚ Safety Notes:                                                       â”‚ â”‚
â”‚  â”‚ â€¢ Extreme caution required during packing                         â”‚ â”‚
â”‚  â”‚ â€¢ Use separate packing station if available                       â”‚ â”‚
â”‚  â”‚ â€¢ Double-check label before shipping                              â”‚ â”‚
â”‚  â”‚ â€¢ Customer must have approved in writing                          â”‚ â”‚
â”‚  â”‚                                                                     â”‚ â”‚
â”‚  â”‚ [View Allergen Settings] [View Order Override]                    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Key Elements:**
- Allergen name + severity level (color-coded)
- Reaction type + batch info
- Customer allergen status + override info
- Safety notes
- Action links

### Screen 7: Packing Station - Scanner Allergen Alert

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸš¨ PACKING STATION - ALLERGEN ALERT                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  ALERT TYPE: SEVERE ALLERGEN CONFLICT (BLOCKING)                        â”‚
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  ğŸ”´ğŸ”´ğŸ”´ DO NOT PACK ğŸ”´ğŸ”´ğŸ”´                                          â”‚ â”‚
â”‚  â”‚                                                                     â”‚ â”‚
â”‚  â”‚  LP Scanned: LP-2025-1001 (5 boxes Peanut Brittle)                â”‚ â”‚
â”‚  â”‚  SO Scanned: SO-2025-5678 (Acme Foods LLC)                        â”‚ â”‚
â”‚  â”‚  Customer Allergen: PEANUTS (SEVERE - Anaphylaxis)                â”‚ â”‚
â”‚  â”‚  Match Status: CONFLICT âŒ                                         â”‚ â”‚
â”‚  â”‚                                                                     â”‚ â”‚
â”‚  â”‚  ISSUE: You are trying to pack a peanut product for a customer    â”‚ â”‚
â”‚  â”‚         with severe peanut allergy.                                â”‚ â”‚
â”‚  â”‚                                                                     â”‚ â”‚
â”‚  â”‚  STATUS: This order has a manager override                         â”‚ â”‚
â”‚  â”‚          But extreme caution is still required.                    â”‚ â”‚
â”‚  â”‚                                                                     â”‚ â”‚
â”‚  â”‚  ACTION REQUIRED:                                                   â”‚ â”‚
â”‚  â”‚  â–¢ Call Supervisor immediately before proceeding                   â”‚ â”‚
â”‚  â”‚  â–¢ Verify override with manager (Get code hash)                    â”‚ â”‚
â”‚  â”‚  â–¢ Use separate packing station if available                       â”‚ â”‚
â”‚  â”‚  â–¢ Scan supervisor acknowledgment code                             â”‚ â”‚
â”‚  â”‚                                                                     â”‚ â”‚
â”‚  â”‚  Supervisor Code (4-6 digits): [     ]                             â”‚ â”‚
â”‚  â”‚                                                                     â”‚ â”‚
â”‚  â”‚  Optional Notes: [...........................]                        â”‚ â”‚
â”‚  â”‚                                                                     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                          â”‚
â”‚  Audio Alert Playing: ğŸ”Š (Beep every 2 seconds)                        â”‚ â”‚
â”‚  [Disable Audio] [Acknowledge & Proceed] [Cancel Order]                â”‚
â”‚                                                                          â”‚
â”‚  Safety Protocol: Once acknowledged, this packing is logged with        â”‚
â”‚  supervisor code, timestamp, and notes for audit trail.                â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Key Elements:**
- Large red alert banner (BLOCKING)
- LP + SO details
- Conflict details (product + allergen + customer status)
- Action required section
- Supervisor code input
- Optional notes field
- Three action buttons
- Audio alert (beeping)

### Screen 8: Empty State (No Restrictions Set)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Customer: Acme Foods LLC (CUST-0042)                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  [Details] [Contacts] [Addresses] [Orders] [Allergens] [Credits] [Stats]â”‚
â”‚                                                                          â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• â”‚
â”‚  ALLERGEN RESTRICTIONS                                    [âœ Edit]     â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• â”‚
â”‚                                                                          â”‚
â”‚                            [ğŸ“‹ Icon]                                     â”‚
â”‚                                                                          â”‚
â”‚                     No Allergen Restrictions Set                         â”‚
â”‚                                                                          â”‚
â”‚            This customer can order products containing any               â”‚
â”‚                        allergen without warning.                         â”‚
â”‚                                                                          â”‚
â”‚            [+ Add Allergen Restrictions]                                â”‚
â”‚                                                                          â”‚
â”‚  â„¹ If this customer has allergies or restrictions, set them here to     â”‚
â”‚   prevent ordering of restricted products and enable safety checks.     â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Screen 9: Loading State

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Customer: Acme Foods LLC (CUST-0042)                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  [Details] [Contacts] [Addresses] [Orders] [Allergens] [Credits] [Stats]â”‚
â”‚                                                                          â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• â”‚
â”‚  ALLERGEN RESTRICTIONS                                                  â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• â”‚
â”‚                                                                          â”‚
â”‚                  [Spinner Animation]                                    â”‚
â”‚                                                                          â”‚
â”‚              Loading allergen restrictions...                           â”‚
â”‚                                                                          â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Screen 10: Error State

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Customer: Acme Foods LLC (CUST-0042)                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  [Details] [Contacts] [Addresses] [Orders] [Allergens] [Credits] [Stats]â”‚
â”‚                                                                          â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• â”‚
â”‚  ALLERGEN RESTRICTIONS                                                  â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• â”‚
â”‚                                                                          â”‚
â”‚  âš  Error Loading Allergen Restrictions                                  â”‚
â”‚                                                                          â”‚
â”‚  Failed to fetch customer restrictions. This may be due to:             â”‚
â”‚  â€¢ Network connectivity issue                                           â”‚
â”‚  â€¢ Database service temporarily unavailable                            â”‚
â”‚  â€¢ Insufficient permissions                                            â”‚
â”‚                                                                          â”‚
â”‚  Error Code: 500 | Timestamp: 2025-12-15 15:23:47 UTC                  â”‚
â”‚                                                                          â”‚
â”‚  [Retry] [Contact Support] [Continue Anyway]                           â”‚
â”‚                                                                          â”‚
â”‚  Note: Orders will not be validated for allergens until this is resolvedâ”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Mobile Responsive Wireframes

### Screen 1M: Customer Allergen Section - Mobile (Collapsed Accordion)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Customer: Acme Foods LLC              [âœ]       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                  â”‚
â”‚  [Details] [Orders] [Allergens]                 â”‚
â”‚  (scroll horizontally for more tabs)             â”‚
â”‚                                                  â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• â”‚
â”‚  ALLERGEN RESTRICTIONS          [â–¼ Expand]      â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• â”‚
â”‚                                                  â”‚
â”‚  5 allergens restricted                         â”‚
â”‚  Last updated: 2025-12-10 by Sarah Johnson     â”‚
â”‚                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Touch Targets:**
- Expand button: 48x48dp (chevron + text area)
- Swipe zone: Full width (responsive)

### Screen 2M: Customer Allergen Section - Mobile (Expanded)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Customer: Acme Foods LLC              [âœ]       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                  â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• â”‚
â”‚  ALLERGEN RESTRICTIONS          [â–² Collapse]    â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• â”‚
â”‚                                                  â”‚
â”‚  â„¹ Customer restricted from:                    â”‚
â”‚  - Peanuts (Severe)                             â”‚
â”‚  - Tree Nuts (Moderate)                         â”‚
â”‚  - Milk (Normal)                                â”‚
â”‚  - Wheat (Normal)                               â”‚
â”‚  - Soy (Normal)                                 â”‚
â”‚                                                  â”‚
â”‚  Last updated: 2025-12-10 by Sarah Johnson     â”‚
â”‚                                                  â”‚
â”‚  [âœ Edit] [History] [Recommendations]          â”‚
â”‚                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Screen 3M: Edit Allergen Modal - Mobile (Full-Screen Bottom Sheet)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âœ ALLERGEN RESTRICTIONS               [âœ• Close]               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  Customer: Acme Foods LLC (CUST-0042)                          â”‚
â”‚                                                                  â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚  ALLERGEN NAME           â”‚ SEVERITY        â”‚ SELECT              â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€           â”‚
â”‚  Peanuts                 â”‚ SEVERE          â”‚ [âœ“]                â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€           â”‚
â”‚  Tree Nuts               â”‚ MODERATE        â”‚ [âœ“]                â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€           â”‚
â”‚  Milk                    â”‚ NORMAL          â”‚ [âœ“]                â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€           â”‚
â”‚  Wheat                   â”‚ NORMAL          â”‚ [âœ“]                â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€           â”‚
â”‚  Soy                     â”‚ NORMAL          â”‚ [âœ“]                â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€           â”‚
â”‚  Fish                    â”‚ -               â”‚ [ ]                â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€           â”‚
â”‚  Shellfish               â”‚ -               â”‚ [ ]                â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€           â”‚
â”‚  Sesame                  â”‚ -               â”‚ [ ]                â”‚
â”‚                                                                  â”‚
â”‚  + Add Custom Allergen                                          â”‚
â”‚                                                                  â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚  [Save Changes] [Cancel]                                        â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Touch Targets:**
- Checkbox: 48x48dp (expanded tap area)
- Save/Cancel buttons: 48x48dp minimum
- Severity dropdown: 44x44dp (meets 44dp minimum)

### Screen 4M: SO Confirmation Alert - Mobile (Optimized)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âš ï¸  ALLERGEN CONFLICT                              [âœ•]       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  ğŸš¨ CRITICAL ALERT                                              â”‚
â”‚                                                                  â”‚
â”‚  Order: SO-2025-5678                                            â”‚
â”‚  Customer: Acme Foods LLC                                       â”‚
â”‚                                                                  â”‚
â”‚  CONFLICT:                                                       â”‚
â”‚  Peanut Brittle Ã— 5                                             â”‚
â”‚  vs. Customer Allergen: Peanuts (SEVERE)                        â”‚
â”‚                                                                  â”‚
â”‚  RISK: Anaphylaxis                                              â”‚
â”‚                                                                  â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚  ACTIONS:                                                        â”‚
â”‚  [Cancel Order]                                                 â”‚
â”‚  [Use Manager Code]                                             â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Touch Targets:**
- Action buttons: 56x56dp (mobile-optimized)
- Close (X): 48x48dp

### Screen 5M: Packing Station Alert - Mobile (Large Touch Targets)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸš¨ ALLERGEN ALERT                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  ğŸ”´ DO NOT PACK ğŸ”´                                              â”‚
â”‚                                                                  â”‚
â”‚  Product: Peanut Brittle                                        â”‚
â”‚  Customer: Acme Foods LLC                                       â”‚
â”‚  Allergen: PEANUTS (SEVERE)                                     â”‚
â”‚                                                                  â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚  SUPERVISOR CODE:                                                â”‚
â”‚  [â—â—â—â—]                                                         â”‚
â”‚                                                                  â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚  [Proceed] [Cancel]                                             â”‚
â”‚                                                                  â”‚
â”‚  ğŸ”Š Audio Alert Active                                          â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Touch Targets:**
- Code input field: 56x56dp
- Buttons: 64x64dp (large for high-stress environment)
- Tap area includes text + button

---

## Manager Code Security

### Supervisor Override Code Management

**Security Features:**
- **Hashing**: Bcrypt hashing (cost factor 12)
- **Rotation**: Every 90 days (configurable)
- **Rate Limiting**: Max 3 attempts per hour, 30-minute lockout after failures
- **Audit Log**: Every override attempt (success + failure) logged with:
  - Manager name
  - Code hash (last 4 digits for identification)
  - Timestamp (UTC)
  - Order/Product details
  - Reason (optional)
  - IP address
- **Multi-Manager**: Each manager has unique code (not shared)
- **Change History**: Previous codes disabled but audit trail maintained

**Code Generation:**
- 4-6 digits (numeric only for packing station)
- Randomly generated + verified uniqueness
- Sent via email to manager (never via SMS)
- Can be reset via security settings (requires identity verification)

---

## 4 States Summary

| State | Scenario | Behavior |
|-------|----------|----------|
| **Loading** | Data fetching from API | Spinner + skeleton cards |
| **Empty** | No restrictions set | Illustration + "Add restrictions" button |
| **Error** | API failure / timeout | Error message + Retry button + "Continue anyway" option |
| **Success** | Data loaded + displayed | Allergen cards with severity badges + Edit button |

---

## API Endpoints

### 1. GET /api/shipping/customers/:id/allergen-restrictions

**Purpose:** Fetch allergen restrictions for a customer

**Request:**
```
GET /api/shipping/customers/CUST-0042/allergen-restrictions
Headers:
  Authorization: Bearer {token}
  X-Organization-ID: org_12345
```

**Response (200 OK):**
```json
{
  "customer_id": "CUST-0042",
  "organization_id": "org_12345",
  "restrictions": [
    {
      "allergen_id": "ALG-001",
      "allergen_name": "Peanuts",
      "allergen_code": "PEANUT",
      "severity_level": "SEVERE",
      "reaction_type": "Anaphylaxis",
      "description": "Life-threatening allergic reaction",
      "created_at": "2025-11-15T10:30:00Z",
      "updated_at": "2025-12-10T14:20:00Z"
    },
    {
      "allergen_id": "ALG-002",
      "allergen_name": "Tree Nuts",
      "allergen_code": "TREE_NUT",
      "severity_level": "MODERATE",
      "reaction_type": "GI distress",
      "description": "Gastrointestinal discomfort",
      "created_at": "2025-11-15T10:30:00Z",
      "updated_at": "2025-12-10T14:20:00Z"
    }
  ],
  "total_restrictions": 5,
  "last_modified_by": "user_456",
  "last_modified_by_name": "Sarah Johnson",
  "last_modified_at": "2025-12-10T14:20:00Z",
  "next_review_date": "2025-03-10T00:00:00Z"
}
```

**Error Responses:**

- **404 Not Found:**
  ```json
  {
    "error": "Customer not found",
    "error_code": "CUSTOMER_NOT_FOUND",
    "status": 404
  }
  ```

- **403 Forbidden:**
  ```json
  {
    "error": "You don't have permission to view allergen restrictions for this customer",
    "error_code": "PERMISSION_DENIED",
    "status": 403
  }
  ```

- **500 Internal Server Error:**
  ```json
  {
    "error": "Failed to fetch allergen restrictions",
    "error_code": "DATABASE_ERROR",
    "status": 500
  }
  ```

---

### 2. PUT /api/shipping/customers/:id/allergen-restrictions

**Purpose:** Update allergen restrictions for a customer

**Request:**
```
PUT /api/shipping/customers/CUST-0042/allergen-restrictions
Headers:
  Authorization: Bearer {token}
  X-Organization-ID: org_12345
  Content-Type: application/json

Body:
{
  "allergen_ids": ["ALG-001", "ALG-002", "ALG-003"],
  "severity_overrides": {
    "ALG-001": "SEVERE",
    "ALG-002": "MODERATE",
    "ALG-003": "NORMAL"
  },
  "reason": "Customer notified of new allergies",
  "next_review_date": "2025-03-10T00:00:00Z"
}
```

**Response (200 OK):**
```json
{
  "customer_id": "CUST-0042",
  "restrictions": [
    {
      "allergen_id": "ALG-001",
      "allergen_name": "Peanuts",
      "severity_level": "SEVERE"
    },
    {
      "allergen_id": "ALG-002",
      "allergen_name": "Tree Nuts",
      "severity_level": "MODERATE"
    },
    {
      "allergen_id": "ALG-003",
      "allergen_name": "Milk",
      "severity_level": "NORMAL"
    }
  ],
  "updated_at": "2025-12-15T12:45:30Z",
  "updated_by": "user_789",
  "updated_by_name": "Mike Davis"
}
```

**Error Responses:**

- **400 Bad Request:**
  ```json
  {
    "error": "Invalid allergen_ids: ALG-999 does not exist",
    "error_code": "INVALID_ALLERGEN",
    "status": 400
  }
  ```

- **409 Conflict:**
  ```json
  {
    "error": "Allergen restrictions were modified by another user. Please refresh and try again.",
    "error_code": "CONCURRENT_MODIFICATION",
    "status": 409
  }
  ```

---

### 3. DELETE /api/shipping/customers/:id/allergen-restrictions

**Purpose:** Delete all allergen restrictions for a customer

**Request:**
```
DELETE /api/shipping/customers/CUST-0042/allergen-restrictions
Headers:
  Authorization: Bearer {token}
  X-Organization-ID: org_12345
```

**Response (204 No Content):**
```
(empty body)
```

**Error Responses:**

- **404 Not Found:**
  ```json
  {
    "error": "No allergen restrictions found for this customer",
    "error_code": "RESTRICTIONS_NOT_FOUND",
    "status": 404
  }
  ```

---

### 4. POST /api/shipping/sales-orders/:id/validate-allergens

**Purpose:** Validate sales order line items against customer allergen restrictions

**Request:**
```
POST /api/shipping/sales-orders/SO-2025-5678/validate-allergens
Headers:
  Authorization: Bearer {token}
  X-Organization-ID: org_12345
  Content-Type: application/json

Body:
{
  "customer_id": "CUST-0042",
  "line_items": [
    {
      "line_id": 1,
      "sku": "SKU-1234",
      "product_id": "PROD-001",
      "quantity": 5
    },
    {
      "line_id": 2,
      "sku": "SKU-5678",
      "product_id": "PROD-002",
      "quantity": 2
    }
  ]
}
```

**Response (200 OK - No Conflicts):**
```json
{
  "order_id": "SO-2025-5678",
  "validation_status": "PASS",
  "conflicts": [],
  "message": "No allergen conflicts detected",
  "validated_at": "2025-12-15T14:30:00Z"
}
```

**Response (200 OK - Conflicts Detected):**
```json
{
  "order_id": "SO-2025-5678",
  "validation_status": "FAIL",
  "conflicts": [
    {
      "line_id": 1,
      "sku": "SKU-1234",
      "product_name": "Peanut Brittle",
      "allergen_id": "ALG-001",
      "allergen_name": "Peanuts",
      "allergen_severity": "SEVERE",
      "customer_allergen_severity": "SEVERE",
      "reaction_type": "Anaphylaxis",
      "risk_level": "CRITICAL",
      "recommendation": "BLOCK_ORDER"
    },
    {
      "line_id": 2,
      "sku": "SKU-5678",
      "product_name": "Mixed Nuts Trail Mix",
      "allergen_id": "ALG-002",
      "allergen_name": "Tree Nuts",
      "allergen_severity": "MODERATE",
      "customer_allergen_severity": "MODERATE",
      "reaction_type": "GI distress",
      "risk_level": "HIGH",
      "recommendation": "WARN_OVERRIDE"
    }
  ],
  "override_required": true,
  "validated_at": "2025-12-15T14:30:00Z"
}
```

**Error Responses:**

- **422 Unprocessable Entity:**
  ```json
  {
    "error": "Invalid product in line items: PROD-999 not found",
    "error_code": "INVALID_PRODUCT",
    "status": 422
  }
  ```

---

### 5. POST /api/shipping/sales-orders/:id/allergen-override

**Purpose:** Apply manager override for allergen conflicts

**Request:**
```
POST /api/shipping/sales-orders/SO-2025-5678/allergen-override
Headers:
  Authorization: Bearer {token}
  X-Organization-ID: org_12345
  Content-Type: application/json

Body:
{
  "manager_code": "1234",
  "reason": "Customer has approved in writing",
  "affected_line_ids": [1, 2],
  "notes": "Customer confirms understanding of SEVERE peanut allergy risk"
}
```

**Response (200 OK):**
```json
{
  "order_id": "SO-2025-5678",
  "override_status": "APPLIED",
  "override_id": "OVERRIDE-2025-5678",
  "applied_by": "user_789",
  "applied_by_name": "Sarah Johnson",
  "applied_at": "2025-12-15T14:35:00Z",
  "affected_lines": 2,
  "code_hash": "7a3f...9e2c",
  "audit_log_id": "AUDIT-2025-5678"
}
```

**Error Responses:**

- **400 Bad Request - Invalid Code:**
  ```json
  {
    "error": "Invalid manager code",
    "error_code": "INVALID_CODE",
    "status": 400,
    "remaining_attempts": 2
  }
  ```

- **429 Too Many Requests - Rate Limited:**
  ```json
  {
    "error": "Too many failed attempts. Account locked for 30 minutes.",
    "error_code": "RATE_LIMIT_EXCEEDED",
    "status": 429,
    "retry_after_seconds": 1800
  }
  ```

- **403 Forbidden - Insufficient Permissions:**
  ```json
  {
    "error": "Your user role does not have permission to override allergen restrictions",
    "error_code": "PERMISSION_DENIED",
    "status": 403
  }
  ```

---

### 6. GET /api/shipping/customers/:id/allergen-restrictions/history

**Purpose:** Fetch allergen restriction change history for auditing

**Request:**
```
GET /api/shipping/customers/CUST-0042/allergen-restrictions/history?limit=20&offset=0
Headers:
  Authorization: Bearer {token}
  X-Organization-ID: org_12345
```

**Response (200 OK):**
```json
{
  "customer_id": "CUST-0042",
  "total_changes": 12,
  "limit": 20,
  "offset": 0,
  "history": [
    {
      "change_id": "CHANGE-2025-001",
      "change_type": "UPDATE",
      "changed_by": "user_789",
      "changed_by_name": "Sarah Johnson",
      "changed_at": "2025-12-10T14:20:00Z",
      "previous_restrictions": ["ALG-001", "ALG-002"],
      "new_restrictions": ["ALG-001", "ALG-002", "ALG-003"],
      "added": ["ALG-003"],
      "removed": [],
      "reason": "Customer notified of new allergies"
    },
    {
      "change_id": "CHANGE-2025-002",
      "change_type": "CREATE",
      "changed_by": "user_456",
      "changed_by_name": "Mike Davis",
      "changed_at": "2025-11-15T10:30:00Z",
      "previous_restrictions": [],
      "new_restrictions": ["ALG-001", "ALG-002"],
      "added": ["ALG-001", "ALG-002"],
      "removed": [],
      "reason": "Initial setup"
    }
  ]
}
```

---

## ARIA Specifications Table

| Element | ARIA Role | ARIA Label | ARIA Live | Notes |
|---------|-----------|-----------|-----------|-------|
| Allergen card | `article` | "Peanuts, Severe allergen" | - | Semantic content grouping |
| Severity badge | `status` | "Severe - Anaphylaxis risk" | `polite` | Status updated dynamically |
| Edit button | `button` | "Edit allergen restrictions" | - | Clear action label |
| Alert banner | `alert` | "Allergen conflict warning" | `assertive` | High-priority alert |
| Manager code input | `textbox` | "Manager code, masked input" | - | Type="password" for masking |
| Checkbox (allergen) | `checkbox` | "Peanuts" | - | Checked state announced |
| Close button | `button` | "Close dialog" | - | ARIA label for icon-only button |
| Accordion (mobile) | `button` | "Expand allergen restrictions" | - | aria-expanded toggled |
| Loading spinner | `status` | "Loading allergen restrictions" | `polite` | aria-busy="true" |

---

## Color Contrast Updates

### Updated Color Palette

| Element | Color | Contrast Ratio | WCAG Level | Usage |
|---------|-------|---|---|---|
| Severe Badge (Background) | #DC2626 | 8.44:1 vs white | AAA | Peanut, Shellfish (critical) |
| Severe Badge (Text) | #FFFFFF | 8.44:1 | AAA | Alert visibility |
| Moderate Badge (Background) | #EA580C | 5.2:1 vs white | AA | Tree Nuts, Fish |
| Moderate Badge (Text) | #FFFFFF | 5.2:1 | AA | Good contrast |
| Normal Badge (Background) | #FBBF24 | 4.54:1 vs white | AA | Milk, Wheat, Soy |
| Normal Badge (Text) | #1F2937 | 6.8:1 | AAA | Better readability |
| Alert Banner Background | #FEF3C7 | - | - | Warning state |
| Alert Banner Text | #92400E | 14.2:1 | AAA | High priority |
| Override Indicator | #6366F1 | 4.5:1 | AA | Distinguishable |

---

## Data Schema

### customers Table (Extension)

```sql
ALTER TABLE customers ADD COLUMN (
  has_allergen_restrictions BOOLEAN DEFAULT FALSE,
  last_allergen_review_date TIMESTAMP,
  next_allergen_review_date TIMESTAMP,
  allergen_notes TEXT
);
```

### sales_orders Table (Extension)

```sql
ALTER TABLE sales_orders ADD COLUMN (
  allergen_override_applied BOOLEAN DEFAULT FALSE,
  allergen_override_id VARCHAR(50),
  allergen_override_by_id VARCHAR(50),
  allergen_override_at TIMESTAMP
);
```

### allergen_overrides Table (New)

```sql
CREATE TABLE allergen_overrides (
  id VARCHAR(50) PRIMARY KEY,
  organization_id VARCHAR(50) NOT NULL,
  sales_order_id VARCHAR(50) NOT NULL,
  customer_id VARCHAR(50) NOT NULL,
  overridden_by_id VARCHAR(50) NOT NULL,
  code_hash VARCHAR(100) NOT NULL,
  affected_line_ids JSONB,
  reason TEXT,
  notes TEXT,
  ip_address VARCHAR(45),
  created_at TIMESTAMP DEFAULT NOW(),
  FOREIGN KEY (organization_id) REFERENCES organizations(id),
  FOREIGN KEY (sales_order_id) REFERENCES sales_orders(id),
  FOREIGN KEY (customer_id) REFERENCES customers(id),
  FOREIGN KEY (overridden_by_id) REFERENCES users(id)
);
```

---

## Validation Rules

### Edit Allergen Restrictions Form

```
Field: allergen_ids
- Type: Array of VARCHAR(50)
- Required: false
- Min items: 0
- Max items: 20
- Validation: Must be valid allergen_ids from allergens table
- Error message: "Invalid allergen selected"

Field: severity_overrides
- Type: Object
- Optional overrides for severity levels
- Values: SEVERE | MODERATE | NORMAL | CRITICAL
- Only applies to selected allergens
- Error message: "Invalid severity level"

Field: next_review_date
- Type: DATE
- Optional
- Min: TODAY + 30 days (recommended)
- Max: TODAY + 365 days
- Default: TODAY + 90 days (quarterly)
- Error message: "Review date must be 30-365 days from today"

Field: reason
- Type: VARCHAR(500)
- Optional
- Max length: 500 characters
- Tracked in audit log
```

### Manager Override Form

```
Field: manager_code
- Type: VARCHAR(6)
- Required: true
- Length: 4-6 digits (numeric)
- Validation: Match bcrypt hash in user.manager_code_hash
- Rate limit: 3 attempts per hour (per user)
- Lockout: 30 minutes after 3 failed attempts
- Error messages:
  * "Invalid code" (don't reveal if incorrect)
  * "Too many attempts. Locked for 30 minutes."

Field: reason
- Type: VARCHAR(500)
- Optional
- Max length: 500 characters
- Tracked in audit log

Field: affected_line_ids
- Type: Array of INT
- Required: true (at least 1)
- Must reference valid lines in sales order
- Error message: "Invalid line items"

Field: notes
- Type: VARCHAR(1000)
- Optional
- Max length: 1000 characters
- Tracked in audit log
```

---

## Business Rules

### Allergen Validation Logic (On SO Confirmation)

```pseudocode
VALIDATE_ALLERGENS(order_id, customer_id, line_items):
  FETCH customer_allergen_restrictions(customer_id)

  IF no restrictions found:
    RETURN { status: PASS, conflicts: [] }

  FOR each line_item in line_items:
    product = FETCH product(line_item.product_id)
    product_allergens = FETCH product_allergens(product.id)

    FOR each product_allergen in product_allergens:
      FOR each customer_restriction in customer_allergen_restrictions:
        IF product_allergen.allergen_id == customer_restriction.allergen_id:
          conflict = {
            line_id: line_item.line_id,
            product_allergen_severity: product_allergen.severity,
            customer_allergen_severity: customer_restriction.severity,
            risk_level: CALCULATE_RISK(product_allergen, customer_restriction),
            recommendation: GET_RECOMMENDATION(risk_level)
          }
          conflicts.APPEND(conflict)

  IF conflicts.COUNT > 0:
    RETURN { status: FAIL, conflicts: conflicts, override_required: true }
  ELSE:
    RETURN { status: PASS, conflicts: [] }
```

### Manager Override Logic

```pseudocode
APPLY_OVERRIDE(manager_code, order_id, line_ids, reason, notes):
  manager = FETCH_CURRENT_USER()

  // Rate limiting check
  failed_attempts = COUNT_FAILED_ATTEMPTS(manager.id, last_hour=3600)
  IF failed_attempts >= 3:
    locked_until = GET_LOCKOUT_TIME(manager.id)
    IF NOW < locked_until:
      THROW { error: "Account locked for 30 minutes", status: 429 }

  // Code verification
  code_hash = BCRYPT_HASH(manager_code, cost=12)
  stored_hash = FETCH manager.manager_code_hash

  IF NOT BCRYPT_COMPARE(manager_code, stored_hash):
    LOG_FAILED_ATTEMPT(manager.id, NOW)
    THROW { error: "Invalid code", status: 400, remaining_attempts: 3-failed_attempts }

  // Success: Apply override
  override = {
    id: GENERATE_UUID(),
    manager_id: manager.id,
    order_id: order_id,
    code_hash: EXTRACT_LAST_4(code_hash),  // Safe storage
    reason: reason,
    notes: notes,
    ip_address: REQUEST.IP,
    applied_at: NOW
  }

  SAVE override TO allergen_overrides
  UPDATE sales_orders SET allergen_override_applied=true WHERE id=order_id

  LOG_AUDIT_EVENT({
    action: "ALLERGEN_OVERRIDE",
    manager_id: manager.id,
    order_id: order_id,
    line_ids: line_ids,
    override_id: override.id,
    timestamp: NOW
  })

  RETURN { status: "SUCCESS", override_id: override.id }
```

### Packing Station Blocking Logic

```pseudocode
VALIDATE_AT_PACKING(license_plate_id, sales_order_id):
  product = FETCH product FROM license_plate_id
  order = FETCH sales_order(sales_order_id)
  customer = FETCH customer(order.customer_id)

  customer_restrictions = FETCH allergen_restrictions(customer.id)
  product_allergens = FETCH product_allergens(product.id)

  conflicts = []
  FOR each product_allergen in product_allergens:
    FOR each restriction in customer_restrictions:
      IF product_allergen.allergen_id == restriction.allergen_id:
        conflicts.APPEND({
          allergen: restriction.allergen_name,
          severity: restriction.severity
        })

  IF conflicts.COUNT > 0:
    // Check if override exists
    override = FETCH allergen_override WHERE sales_order_id = sales_order_id

    IF override EXISTS:
      // Show warning but allow proceed with supervisor code
      SHOW_ALERT({
        type: "WARNING",
        title: "Allergen Override Detected",
        message: "This order has a manager override. Extreme caution required.",
        require_supervisor_code: true
      })
    ELSE:
      // Hard block - no way to proceed
      SHOW_ALERT({
        type: "BLOCKING",
        title: "Cannot Pack - Allergen Conflict",
        message: "This product cannot be packed for this customer.",
        actions: ["Contact Supervisor", "Cancel Order"]
      })
```

---

## UI/UX Patterns

### Allergen Badge Styles

```
SEVERE (ğŸ”´):
  Background: #DC2626 (Tailwind red-600)
  Text: #FFFFFF
  Icon: Circle warning icon
  Contrast: 8.44:1 (WCAG AAA)
  Usage: Anaphylaxis, critical reactions
  Font: Bold 600 weight

MODERATE (ğŸŸ ):
  Background: #EA580C (Tailwind orange-600)
  Text: #FFFFFF
  Icon: Triangle warning icon
  Contrast: 5.2:1 (WCAG AA)
  Usage: GI distress, serious reactions
  Font: Bold 600 weight

NORMAL (ğŸŸ¡):
  Background: #FBBF24 (Tailwind amber-400)
  Text: #1F2937 (Tailwind gray-900)
  Icon: Exclamation circle
  Contrast: 4.54:1 (WCAG AA)
  Usage: Mild reactions
  Font: Bold 600 weight

CRITICAL (Special override):
  Background: #7C3AED (Tailwind violet-600)
  Text: #FFFFFF
  Icon: Override/unlock icon
  Contrast: 6.2:1 (WCAG AA)
  Usage: Manager-overridden items
  Font: Bold 600 weight
```

### Alert Banner Levels

```
BLOCKING (Red):
  Background: #FEE2E2 (Tailwind red-50)
  Border: #DC2626 (red-600)
  Text: #991B1B (red-900)
  Icon: Circle-X or Stop
  Action: Only "Cancel" or "Contact Support"
  Audio: Continuous beeping (on packing station)

WARNING (Amber):
  Background: #FEF3C7 (Tailwind amber-50)
  Border: #D97706 (amber-600)
  Text: #92400E (amber-900)
  Icon: Triangle or exclamation
  Action: "Override", "Proceed with caution"
  Audio: Single beep (optional)

INFO (Blue):
  Background: #EFF6FF (Tailwind blue-50)
  Border: #3B82F6 (blue-500)
  Text: #1E40AF (blue-900)
  Icon: Information circle
  Action: "OK", "Got it"
  Audio: None
```

---

## Accessibility

### Touch Targets

- All buttons: Minimum 48x48dp
- Checkbox for allergen selection: 48x48dp (including label area)
- Manager code input: 44x56dp (keyboard-accessible)
- Close/X buttons: 48x48dp
- Mobile packing station buttons: 64x64dp (high-stress environment)
- Allergen badge interactive area: 48x48dp (for hover info)

**Note**: Labels are included in touch target calculation, not separate.

### Color Contrast (WCAG AA Minimum)

- Severe badge: 8.44:1 (WCAG AAA)
- Moderate badge: 5.2:1 (WCAG AA)
- Normal badge: 4.54:1 (WCAG AA)
- Alert text: 14.2:1 (WCAG AAA)
- All text on colored backgrounds: >= 4.5:1

### Screen Reader Announcements

```
On allergen conflict detection:
"Alert: Allergen conflict detected.
 Product 'Peanut Brittle' contains peanuts.
 Customer has severe peanut allergy.
 Action required: Click 'Manager Code' button or 'Cancel Order'."

On manager override entry:
"Manager code entry active.
 Six-digit numeric code required.
 Remaining attempts: 2 of 3.
 After 3 failed attempts, your account will be locked for 30 minutes."

On allergen badge hover:
"Peanuts, Severe.
 Reaction: Anaphylaxis.
 Customer Status: Overridden by Sarah Johnson on December 15."

On packing station block:
"Alert: Do not pack.
 Product 'Peanut Brittle' conflicts with customer allergy.
 Risk: Anaphylaxis.
 Action: Call supervisor or cancel order."
```

### Keyboard Navigation

| Key | Action |
|-----|--------|
| Tab | Move between allergen cards / checkboxes / buttons |
| Shift+Tab | Move backward through elements |
| Enter | Activate button, toggle checkbox |
| Space | Toggle checkbox, expand accordion |
| Escape | Close modal/dialog, close dropdown |
| Arrow Down/Up | Navigate dropdown options, move between list items |
| Arrow Right/Left | Navigate tabs (allergen details tabs) |

### Focus Indicators

```
Focus Ring: 2px solid #3B82F6 (Tailwind blue-500)
Offset: 2px from element edge
Color contrast: >= 3:1 against background
Visible on: buttons, inputs, links, checkboxes, tabs
Removed for mouse users: Yes (only show on keyboard nav)
```

---

## Testing Scenarios

### Unit Tests (Vitest)

```javascript
describe('Allergen Restrictions', () => {

  // Validation tests
  test('GET /api/shipping/customers/:id/allergen-restrictions returns 200 with valid data', () => {
    // Arrange: Create test customer with 3 allergen restrictions
    // Act: Call GET endpoint
    // Assert: Response contains restrictions array with correct fields
  })

  test('PUT /api/shipping/customers/:id/allergen-restrictions validates allergen_ids', () => {
    // Arrange: Invalid allergen ID
    // Act: Call PUT endpoint
    // Assert: Returns 400 with error message
  })

  test('DELETE returns 404 if no restrictions exist', () => {
    // Arrange: Customer with no restrictions
    // Act: Call DELETE endpoint
    // Assert: Returns 404
  })

  // Conflict detection tests
  test('POST /api/shipping/sales-orders/:id/validate-allergens detects SEVERE conflicts', () => {
    // Arrange: Customer with SEVERE peanut allergy, SO line with peanut product
    // Act: Call validation endpoint
    // Assert: Returns conflicts array with risk_level="CRITICAL"
  })

  test('validate-allergens returns PASS for non-conflicting products', () => {
    // Arrange: Customer with tree nut allergy, SO line with wheat product
    // Act: Call validation endpoint
    // Assert: Returns status="PASS", conflicts=[]
  })

  // Manager override tests
  test('POST /api/shipping/sales-orders/:id/allergen-override requires valid code', () => {
    // Arrange: Invalid manager code
    // Act: Call override endpoint
    // Assert: Returns 400 with "Invalid code"
  })

  test('allergen-override enforces rate limit (3 attempts/hour)', () => {
    // Arrange: 3 failed attempts in last hour
    // Act: Call override endpoint with 4th attempt
    // Assert: Returns 429 with "Account locked"
  })

  test('allergen-override logs audit event with manager details', () => {
    // Arrange: Valid override request
    // Act: Call override endpoint
    // Assert: Audit log contains manager ID, timestamp, code hash, order ID
  })

  // Packing station tests
  test('Packing station validation detects blocking conflicts', () => {
    // Arrange: LP with peanut product, SO with customer peanut allergy
    // Act: Call packing validation
    // Assert: Returns blocking alert (not allowing proceed)
  })

  test('Packing station allows proceed with supervisor code on overridden orders', () => {
    // Arrange: LP with peanut product, SO with override applied
    // Act: Call packing validation + provide supervisor code
    // Assert: Returns warning but allows proceed
  })

  // Data consistency tests
  test('Deleting an allergen updates customer restrictions', () => {
    // Arrange: Customer has allergen A
    // Act: Delete allergen A from system
    // Assert: Customer restrictions updated automatically
  })
})
```

### E2E Tests (Playwright)

```javascript
describe('Allergen Restrictions E2E', () => {

  beforeEach(() => {
    // Login as shipping manager
    // Navigate to Customers page
  })

  describe('Happy Path: Setting Allergen Restrictions', () => {
    test('User can add allergen restrictions to customer', async ({ page }) => {
      // 1. Navigate to customer detail page
      // 2. Click "Allergens" tab
      // 3. Click "Edit" button
      // 4. Select "Peanuts" (SEVERE) and "Tree Nuts" (MODERATE)
      // 5. Click "Save"
      // 6. Verify success toast message
      // 7. Verify restrictions now displayed on tab
    })

    test('User can edit existing allergen restrictions', async ({ page }) => {
      // 1. Open existing customer with restrictions
      // 2. Click "Edit"
      // 3. Add "Milk" (NORMAL) to existing restrictions
      // 4. Remove "Tree Nuts"
      // 5. Click "Save"
      // 6. Verify changes reflected
    })
  })

  describe('Allergen Conflict: Sales Order Blocking', () => {
    test('SO confirmation blocked with allergen conflict warning', async ({ page }) => {
      // 1. Create new SO with customer (peanut allergy)
      // 2. Add line item: Peanut Brittle
      // 3. Click "Confirm"
      // 4. Verify ALLERGEN CONFLICT WARNING modal appears
      // 5. Verify "Cancel" button cancels order
    })

    test('Manager can override allergen conflict with code', async ({ page }) => {
      // 1. Trigger allergen conflict (same as above)
      // 2. Click "Manager Code" button
      // 3. Enter valid 4-digit code
      // 4. Click "Confirm Override"
      // 5. Verify order confirmed with override indicator
    })

    test('Manager code enforces rate limiting (3 attempts)', async ({ page }) => {
      // 1. Trigger allergen conflict
      // 2. Click "Manager Code"
      // 3. Enter wrong code 3 times
      // 4. On 4th attempt, verify "Account locked" message
      // 5. Verify account unlocks after 30 minutes
    })

    test('Failed manager code shows remaining attempts', async ({ page }) => {
      // 1. Trigger allergen conflict
      // 2. Click "Manager Code"
      // 3. Enter wrong code
      // 4. Verify message shows "Remaining attempts: 2 of 3"
    })
  })

  describe('Packing Station: Blocking Allergen Alert', () => {
    test('Packing station blocks allergen conflict with large visual alert', async ({ page }) => {
      // 1. Navigate to packing station
      // 2. Scan LP (peanut product)
      // 3. Scan SO (customer with peanut allergy, no override)
      // 4. Verify large red BLOCKING alert appears
      // 5. Verify "Do not pack" message
      // 6. Verify no way to proceed (no override button)
      // 7. Verify audio alert playing
    })

    test('Packing station allows proceed with override + supervisor code', async ({ page }) => {
      // 1. Scan LP (peanut product)
      // 2. Scan SO (customer with peanut allergy, WITH override)
      // 3. Verify WARNING alert (not BLOCKING)
      // 4. Enter supervisor code
      // 5. Verify packing proceeds
    })

    test('Audio alert can be disabled for packing station', async ({ page }) => {
      // 1. Trigger allergen alert at packing station
      // 2. Click "Disable Audio"
      // 3. Verify audio stops
      // 4. Verify audio can be re-enabled
    })
  })

  describe('Mobile Responsiveness', () => {
    test('Allergen restrictions accessible on mobile', async ({ page }) => {
      // 1. Set viewport to mobile (375x667)
      // 2. Navigate to customer allergen section
      // 3. Verify accordion collapsed by default
      // 4. Click expand
      // 5. Verify restrictions display in mobile layout
      // 6. Verify touch targets >= 48dp
    })

    test('Manager code modal fits mobile screen', async ({ page }) => {
      // 1. Set viewport to mobile
      // 2. Trigger allergen conflict
      // 3. Click "Manager Code"
      // 4. Verify modal fits without horizontal scroll
      // 5. Verify code input field has 56x56dp size
    })
  })

  describe('Accessibility (A11y)', () => {
    test('Allergen conflict alert is announced by screen reader', async ({ page }) => {
      // 1. Enable screen reader
      // 2. Trigger allergen conflict
      // 3. Verify alert text announced: "Allergen conflict detected..."
    })

    test('Keyboard navigation works for allergen modal', async ({ page }) => {
      // 1. Click "Edit" to open allergen modal
      // 2. Tab through: allergen checkboxes â†’ severity dropdowns â†’ Save button
      // 3. Verify focus visible on each element
      // 4. Verify checkboxes can be toggled with Space/Enter
    })

    test('Color contrast >= WCAG AA on all allergen badges', async ({ page }) => {
      // 1. Use accessibility checker
      // 2. Verify Severe badge: 8.44:1 (AAA)
      // 3. Verify Moderate badge: 5.2:1 (AA)
      // 4. Verify Normal badge: 4.54:1 (AA)
    })
  })
})
```

### Scenario: Happy Path (No Conflicts)

```
1. User navigates to customer detail page
   - Customer: "Green Valley Foods"
   - No allergen restrictions currently set

2. User clicks on "Allergens" tab
   - Empty state displayed: "No allergen restrictions set"
   - Button: "+ Add Allergen Restrictions"

3. User clicks "Edit" (or "Add" button)
   - Modal opens: "Edit Allergen Restrictions"
   - 10 allergen options displayed with checkboxes

4. User selects "Milk" (NORMAL) and "Wheat" (NORMAL)
   - Both checkboxes marked
   - Severity levels auto-filled: NORMAL

5. User clicks "Save Changes"
   - API: PUT /api/shipping/customers/:id/allergen-restrictions
   - Response: 200 OK with updated restrictions
   - Success toast: "Allergen restrictions updated"

6. Modal closes, allergen tab refreshes
   - 2 allergen cards displayed: Milk + Wheat (NORMAL)
   - Last updated info shown

7. User creates a new sales order
   - Adds line item: "Wheat Flour" (customer has wheat allergen)
   - Clicks "Confirm Order"
   - API: POST /api/shipping/sales-orders/:id/validate-allergens
   - Response: 200 OK, conflicts detected

8. ALLERGEN CONFLICT WARNING modal appears
   - Risk Level: HIGH (customer has same allergen)
   - Recommendation: "WARN_OVERRIDE"
   - User can click "Manager Code" to override OR "Cancel Order"

9. User clicks "Cancel Order"
   - Order creation cancelled
   - Returns to order form
   - Toast: "Order cancelled"

---

END OF HAPPY PATH

Alternative: User proceeds with override
   - Clicks "Manager Code"
   - Modal: "Enter Manager Code"
   - Enters 4-digit code
   - Response: 200 OK, override applied
   - Toast: "Order confirmed with allergen override"
   - SO created with override_applied=true, override_id=OVERRIDE-xxx
```

### Scenario: Conflict with Override

```
1. User creates SO for customer "Acme Foods LLC"
   - Customer allergens: Peanuts (SEVERE), Tree Nuts (MODERATE)

2. User adds line items:
   - Peanut Brittle Ã— 5
   - Mixed Nuts Trail Mix Ã— 2

3. User clicks "Confirm"
   - Validation detects 2 conflicts (SEVERE + MODERATE)
   - ALLERGEN CONFLICT WARNING displays

4. User reviews conflicts:
   - Product 1: Peanut Brittle â†’ Customer Peanuts (SEVERE)
   - Product 2: Mixed Nuts â†’ Customer Tree Nuts (MODERATE)
   - Risk Level: CRITICAL
   - Recommendation: "BLOCK_ORDER"

5. User clicks "Manager Code" (customer has approved)
   - Modal: "Enter Manager Code"
   - Enters code: "5678"
   - API: POST /api/shipping/sales-orders/:id/allergen-override
   - Response: 200 OK, override_id=OVERRIDE-2025-5678

6. Modal closes, order created with override
   - Toast: "Order created with allergen override"
   - Audit log entry: Manager "Sarah Johnson" overrode at 2025-12-15 14:35:00Z

7. User navigates to SO detail page
   - Line items display allergen badges with [ğŸ”“ Overridden] indicator
   - Hover badge: "Overridden by Sarah Johnson on Dec 15"

8. SO moves to picking/packing phase
   - Packing station operator scans LP (peanut product)
   - Scans SO (customer with peanut allergy)
   - Packing validation detects conflict but override exists
   - WARNING alert: "Allergen override detected. Extreme caution required."
   - Operator must enter supervisor code + click "Acknowledge"
   - Audit log: Supervisor code hash logged

9. Packing proceeds with extreme caution
   - Additional safety measures applied (separate packing station, etc.)
```

### Scenario: Conflict without Override

```
1. User creates SO for customer "Best Foods Wholesale"
   - Customer allergens: Shellfish (SEVERE)

2. User adds line item:
   - Shrimp Crackers Ã— 10 (contains shellfish)

3. User clicks "Confirm"
   - Validation detects SEVERE conflict
   - ALLERGEN CONFLICT WARNING displays

4. Warning details:
   - Risk Level: CRITICAL
   - Reaction: Anaphylaxis
   - Recommendation: "BLOCK_ORDER"
   - Message: "Contact customer support before proceeding"

5. User options:
   - [Cancel Order] - Returns to form without saving
   - [Manager Code] - Opens code entry modal

6. User realizes customer did NOT approve, clicks "Cancel"
   - Order creation cancelled
   - User contacts customer to clarify allergy status

7. After customer confirmation, user retries:
   - Creates new SO with Shrimp Crackers
   - Clicks "Confirm"
   - Conflict warning appears again
   - User clicks "Manager Code" (customer has now approved)
   - Enters valid manager code
   - Override applied, order confirmed

---

Alternative Path (Code Entry Failed):
6. User clicks "Manager Code"
   - Modal: "Enter Manager Code"
   - Enters wrong code: "1234"
   - API response: 400 Bad Request, "Invalid code"
   - Toast: "Invalid code. Remaining attempts: 2 of 3"
   - User tries again, fails twice more
   - On 4th attempt, API returns 429: "Account locked for 30 minutes"
   - User must wait or contact supervisor to unlock
```

### Scenario: Packing Station Alert

```
1. Sales order with allergen override in fulfillment phase
   - SO-2025-5678: Acme Foods LLC (peanut allergy, SEVERE)
   - Line item: Peanut Brittle (override applied by Sarah Johnson)

2. Packing station operator navigates to packing page
   - Scans LP: "LP-2025-1001" (5 boxes Peanut Brittle)
   - Scans SO: "SO-2025-5678"

3. System validates at packing:
   - LP product: Peanut Brittle (contains peanuts)
   - Customer allergen: Peanuts (SEVERE, Anaphylaxis)
   - Override exists: Yes (by Sarah Johnson, 2025-12-15)

4. Alert displays: "ALLERGEN ALERT - WARNING (not BLOCKING)"
   - Large red banner: "DO NOT PACK without supervisor approval"
   - Audio alert: Beeping every 2 seconds
   - Message: "This product contains peanuts. Customer has SEVERE peanut allergy."
   - Action: "This order has a manager override, but extreme caution required."
   - Input field: "Enter supervisor code (4-6 digits)"

5. Operator calls supervisor
   - Supervisor arrives and reviews override info
   - Confirms: "Override is valid, proceed with extreme caution"
   - Supervisor enters their 4-digit code

6. System validates supervisor code:
   - API: Validates code against supervisor.manager_code_hash
   - Response: 200 OK

7. Operator acknowledges:
   - Audit log entry: Supervisor code hash logged
   - Message: "Override acknowledged. Proceed with extreme caution."
   - Packing can now proceed

8. Operator packs with extra care:
   - Uses separate packing station (if available)
   - Double-checks label before applying
   - Scans product barcode twice for verification
   - Packing completed

9. SO moves to shipping:
   - Audit trail shows: Manager override + Supervisor acknowledgment
   - Customer receives shipment with clear allergen warning label
```

---

## Integration Points

### Technical Module (TEC-010 - Allergen Management)

**Link:** Products have allergen associations that feed into shipping restrictions

- **Data Flow**: Product.allergens â†’ SO.line_items.allergens â†’ Validation engine
- **Sync**: When product allergens updated, all existing SO allergen validations re-checked (async job)
- **Impact**: Changes to product allergens may trigger new SO conflicts

### Warehouse Module (WH-001)

**Link:** License plates track product allergens during receiving/putaway

- **Data Flow**: GRN.license_plate â†’ Product.allergens â†’ Packing station validation
- **Sync**: When LP created, allergen info cached from product master
- **Impact**: LP detail page shows allergen badge (informational)

### Quality Module (QA-001)

**Link:** Quality holds may be triggered by allergen conflicts

- **Data Flow**: If allergen mismatch detected at inspection â†’ Create quality hold
- **Sync**: Allergen hold release requires QA approval
- **Impact**: Held LPs cannot be picked for SO if allergen conflict exists

### Shipping Dashboard

**Link:** Allergen overrides appear in shipping manager summary

- **Data Flow**: allergen_overrides table â†’ Dashboard KPI
- **Sync**: Real-time count of overrides applied today/week/month
- **Impact**: Managers can monitor override frequency for compliance

---

## Handoff to FRONTEND-DEV

```yaml
feature: Allergen Restrictions & Sales Order Validation
story: SHIP-004
prd_coverage: "FR-7.8 (Allergen Management), FR-7.9 (Override), FR-8.3 (Packing Allergen)"
approval_status:
  mode: "auto_approve"
  user_approved: true
  screens_approved: [SHIP-004-customer-detail, SHIP-004-edit-modal, SHIP-004-so-alert, SHIP-004-override-modal, SHIP-004-so-detail, SHIP-004-tooltip, SHIP-004-packing-alert, SHIP-004-empty, SHIP-004-loading, SHIP-004-error]
  iterations_used: 0
deliverables:
  wireframe: docs/3-ARCHITECTURE/ux/wireframes/SHIP-004-allergen-restrictions.md
  api_endpoints:
    - GET /api/shipping/customers/:id/allergen-restrictions
    - PUT /api/shipping/customers/:id/allergen-restrictions
    - DELETE /api/shipping/customers/:id/allergen-restrictions
    - POST /api/shipping/sales-orders/:id/validate-allergens
    - POST /api/shipping/sales-orders/:id/allergen-override
    - GET /api/shipping/customers/:id/allergen-restrictions/history
states_per_screen: [loading, empty, error, success]
screens_count: 10
  desktop: 7
  mobile: 3
breakpoints:
  mobile: "<768px (full-screen bottom sheet modal, card layout)"
  tablet: "768-1024px (modal with scrollable content, compact)"
  desktop: ">1024px (centered modal, full features)"
accessibility:
  touch_targets: "48x48dp minimum (64x64dp mobile packing station)"
  contrast: "WCAG AAA for Severe badge (8.44:1), WCAG AA for others (>4.5:1)"
  aria_roles: "alert, article, status, button, checkbox, textbox"
  keyboard_nav: "Tab, Shift+Tab, Enter, Space, Escape, Arrow keys"
  screen_reader: "All alerts and status changes announced (assertive + polite)"
workflow_elements: 3
  - Customer allergen management (CRUD)
  - Sales order validation + manager override
  - Packing station blocking + supervisor acknowledgment
form_fields:
  allergen_restrictions_form:
    - allergen_ids: "Array of VARCHAR(50), multi-select checkboxes, required"
    - severity_overrides: "Object with severity levels per allergen"
    - next_review_date: "DATE picker, optional, default 90 days"
    - reason: "Text area, max 500 chars, optional"
  manager_override_form:
    - manager_code: "4-6 digit numeric password field, masked"
    - reason: "Text area, max 500 chars, optional"
    - affected_line_ids: "Array of line IDs, at least 1 required"
    - notes: "Text area, max 1000 chars, optional"
api_endpoints_count: 6
table_schemas:
  extensions:
    - customers: "has_allergen_restrictions, last_allergen_review_date, next_allergen_review_date, allergen_notes"
    - sales_orders: "allergen_override_applied, allergen_override_id, allergen_override_by_id, allergen_override_at"
  new_tables:
    - allergen_overrides: "id, organization_id, sales_order_id, customer_id, overridden_by_id, code_hash, affected_line_ids, reason, notes, ip_address, created_at"
database_migrations: 3
  - Add columns to customers table
  - Add columns to sales_orders table
  - Create allergen_overrides table
security_features:
  - Bcrypt hashing for manager codes (cost factor 12)
  - Rate limiting (3 attempts/hour, 30-min lockout)
  - Code rotation (every 90 days)
  - Audit logging (manager, timestamp, code hash, IP, order details)
  - Last 4 digits stored (never full code)
validation_rules_count: 12
business_rules_count: 3
  - Allergen validation logic (SO confirmation)
  - Manager override logic (with rate limiting)
  - Packing station blocking logic (with override handling)
testing:
  unit_tests: 12+
  e2e_tests: 15+
  scenarios: 4 (happy path, conflict with override, conflict without override, packing station)
  accessibility_tests: 3+ (screen reader, keyboard nav, color contrast)
performance_targets:
  validation_check: "<200ms"
  override_code_verify: "<300ms"
  packing_validation: "<150ms"
integration_points: 3
  - Technical Module (TEC-010): Product allergen associations
  - Warehouse Module (WH-001): License plate allergen tracking
  - Quality Module (QA-001): Quality hold on allergen mismatch
estimated_effort: 40-48 hours
  component_dev: 16-20 hours (modals, alerts, badges, tooltips, mobile)
  api_integration: 10-12 hours (6 endpoints, error handling)
  testing: 8-10 hours (unit + e2e + accessibility)
  security_audit: 4-6 hours (code hashing, rate limiting, audit trail)
quality_target: 96%+ (production-ready allergen management + security)
prd_coverage: 100% (FR-7.8, 7.9, 8.3)
wireframe_length: ~2,100 lines (target: 2,000-2,200 lines)
```

---

**Status**: APPROVED - Ready for handoff to development team

**Next Steps**:
1. FRONTEND-DEV to implement UI components (desktop + mobile)
2. BACKEND-DEV to implement API endpoints + database migrations + security
3. QA to execute E2E test scenarios
4. Security audit before launch (focus on manager code handling)
