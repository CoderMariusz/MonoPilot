# NPD-007: Formulation Editor

**Module**: NPD (New Product Development)
**Feature**: Formulation Create/Edit with Ingredient Management (FR-NPD-08 to FR-NPD-16)
**Type**: Full Page / Modal (Context-dependent)
**Path**: `/npd/projects/{projectId}/formulations/{id}` or Modal from NPD-002
**ID**: NPD-007
**Parent**: NPD-002 (Project Detail Page - Formulations Tab)
**Status**: Ready for Review
**Last Updated**: 2026-01-15

---

## Overview

The Formulation Editor is the primary interface for creating and managing recipe versions during NPD development. It allows R&D users to define ingredients, quantities, and track allergens before handoff to production as a BOM.

**Business Context:**
- Formulation = Recipe version during development (precursor to BOM)
- Each formulation has: version, status, effective dates, output qty, ingredients
- Allergens auto-aggregate from ingredient products
- Percentage auto-calculates based on total quantity
- Versioning with lineage tracking (parent_formulation_id)
- Draft -> Approved -> Locked lifecycle

**Critical PRD Coverage:**
- NPD-FR-08: Create formulations with versioning - Must
- NPD-FR-09: Add formulation items with product search - Must
- NPD-FR-10: Auto-aggregate allergens - Must
- NPD-FR-11: Support effective dates - Must
- NPD-FR-12: Prevent overlapping versions - Must
- NPD-FR-13: Lock formulation on approval - Must
- NPD-FR-14: Track formulation lineage - Must

**Page Purpose:**
- Create new formulation with version number
- Edit draft formulations
- View approved/locked formulations (read-only)
- Manage formulation items (ingredients)
- Preview allergen aggregation
- Track version history

---

## ASCII Wireframe

### Create Mode (New Formulation)

```
+-----------------------------------------------------------------------------+
|  NPD > Project > NPD-2025-00001 > New Formulation                      [X]  |
+-----------------------------------------------------------------------------+
|                                                                             |
|  +-------------------------------- HEADER ---------------------------------+|
|  |                                                                         ||
|  |  Version *                       Status                                 ||
|  |  +---------------------------+   +---------------------------+          ||
|  |  | v2.0                      |   | [Draft]                   |          ||
|  |  +---------------------------+   +---------------------------+          ||
|  |  Auto-suggested: next major      Read-only during create                ||
|  |                                                                         ||
|  |  +------------------------------------------+  +---------------------+  ||
|  |  | Effective From                           |  | Effective To        |  ||
|  |  | +--------------------------------------+ |  | +-----------------+ |  ||
|  |  | |                               [cal]  | |  | |           [cal] | |  ||
|  |  | +--------------------------------------+ |  | +-----------------+ |  ||
|  |  +------------------------------------------+  +---------------------+  ||
|  |  Optional: Set when approving                  Optional                 ||
|  |                                                                         ||
|  |  +------------------------------------------+  +---------------------+  ||
|  |  | Output Quantity *                        |  | Unit of Measure *   |  ||
|  |  | +--------------------------------------+ |  | +-----------------+ |  ||
|  |  | | 100.000                              | |  | | kg          [v] | |  ||
|  |  | +--------------------------------------+ |  | +-----------------+ |  ||
|  |  +------------------------------------------+  +---------------------+  ||
|  |  Total batch output quantity                    kg, L, pcs, etc.        ||
|  |                                                                         ||
|  +-------------------------------------------------------------------------+|
|                                                                             |
|  +-------------------------------- ITEMS TABLE ----------------------------+|
|  |                                                                         ||
|  |  Ingredients (0)                                        [+ Add Item]    ||
|  |  -------------------------------------------------------------------    ||
|  |                                                                         ||
|  |  +-------------------------------------------------------------------+  ||
|  |  |                                                                   |  ||
|  |  |                          [beaker icon]                            |  ||
|  |  |                                                                   |  ||
|  |  |                   No ingredients added yet                        |  ||
|  |  |                                                                   |  ||
|  |  |       Add ingredients to define your formulation recipe.          |  ||
|  |  |                                                                   |  ||
|  |  |                      [+ Add First Ingredient]                     |  ||
|  |  |                                                                   |  ||
|  |  +-------------------------------------------------------------------+  ||
|  |                                                                         ||
|  +-------------------------------------------------------------------------+|
|                                                                             |
|  +-------------------------------- ALLERGEN PREVIEW -----------------------+|
|  |                                                                         ||
|  |  Allergen Declaration                                                   ||
|  |  +-------------------------------------------------------------------+  ||
|  |  |  No allergens detected                                            |  ||
|  |  |  Add ingredients to see allergen aggregation                      |  ||
|  |  +-------------------------------------------------------------------+  ||
|  |                                                                         ||
|  +-------------------------------------------------------------------------+|
|                                                                             |
|  +-------------------------------- NOTES ----------------------------------+|
|  |                                                                         ||
|  |  Notes (Optional)                                                       ||
|  |  +-------------------------------------------------------------------+  ||
|  |  |                                                                   |  ||
|  |  |                                                                   |  ||
|  |  +-------------------------------------------------------------------+  ||
|  |  Formulation notes, special instructions (max 1000 chars)               ||
|  |                                                                         ||
|  +-------------------------------------------------------------------------+|
|                                                                             |
+-----------------------------------------------------------------------------+
|                                                                             |
|  [Cancel]                                                   [Save Draft]   |
|                                                                             |
+-----------------------------------------------------------------------------+
```

### Edit Draft Mode (With Items)

```
+-----------------------------------------------------------------------------+
|  NPD > Project > NPD-2025-00001 > Formulation v2.0                     [X]  |
+-----------------------------------------------------------------------------+
|                                                                             |
|  +-------------------------------- HEADER ---------------------------------+|
|  |                                                                         ||
|  |  Version                         Status                                 ||
|  |  +---------------------------+   +---------------------------+          ||
|  |  | v2.0                      |   | [Draft]                   |          ||
|  |  +---------------------------+   +---------------------------+          ||
|  |  Read-only (version locked)      Editable until approved                ||
|  |                                                                         ||
|  |  +------------------------------------------+  +---------------------+  ||
|  |  | Effective From                           |  | Effective To        |  ||
|  |  | +--------------------------------------+ |  | +-----------------+ |  ||
|  |  | | 2025-02-15                    [cal]  | |  | | -         [cal] | |  ||
|  |  | +--------------------------------------+ |  | +-----------------+ |  ||
|  |  +------------------------------------------+  +---------------------+  ||
|  |                                                                         ||
|  |  +------------------------------------------+  +---------------------+  ||
|  |  | Output Quantity *                        |  | Unit of Measure *   |  ||
|  |  | +--------------------------------------+ |  | +-----------------+ |  ||
|  |  | | 100.000                              | |  | | kg          [v] | |  ||
|  |  | +--------------------------------------+ |  | +-----------------+ |  ||
|  |  +------------------------------------------+  +---------------------+  ||
|  |                                                                         ||
|  +-------------------------------------------------------------------------+|
|                                                                             |
|  +-------------------------------- ITEMS TABLE ----------------------------+|
|  |                                                                         ||
|  |  Ingredients (5)                                        [+ Add Item]    ||
|  |  -------------------------------------------------------------------    ||
|  |                                                                         ||
|  |  +-------------------------------------------------------------------+  ||
|  |  | Product              | Qty      | UoM  | %      | Notes   | Act   |  ||
|  |  +-------------------------------------------------------------------+  ||
|  |  | ING-001              | 45.000   | kg   | 45.00% |         | [X]   |  ||
|  |  | Pea Protein Isolate  |          |      |        |         |       |  ||
|  |  +-------------------------------------------------------------------+  ||
|  |  | ING-002              | 25.000   | kg   | 25.00% |         | [X]   |  ||
|  |  | Water                |          |      |        |         |       |  ||
|  |  +-------------------------------------------------------------------+  ||
|  |  | ING-003              | 15.000   | kg   | 15.00% | Organic | [X]   |  ||
|  |  | Coconut Oil          |          |      |        |         |       |  ||
|  |  +-------------------------------------------------------------------+  ||
|  |  | ING-004              |  8.000   | kg   |  8.00% |         | [X]   |  ||
|  |  | Methylcellulose      |          |      |        |         |       |  ||
|  |  +-------------------------------------------------------------------+  ||
|  |  | ING-005              |  7.000   | kg   |  7.00% |         | [X]   |  ||
|  |  | Seasoning Blend      |          |      |        |         |       |  ||
|  |  +-------------------------------------------------------------------+  ||
|  |                                                                         ||
|  |  Total: 100.000 kg                              100.00%                 ||
|  |  [i] Percentages auto-calculate based on output quantity                ||
|  |                                                                         ||
|  +-------------------------------------------------------------------------+|
|                                                                             |
|  +-------------------------------- ALLERGEN PREVIEW -----------------------+|
|  |                                                                         ||
|  |  Allergen Declaration                                    [i Details v]  ||
|  |  +-------------------------------------------------------------------+  ||
|  |  |  Contains: Soy (from ING-001 Pea Protein Isolate)                 |  ||
|  |  |                                                                   |  ||
|  |  |  May Contain: Wheat (shared production line)                      |  ||
|  |  +-------------------------------------------------------------------+  ||
|  |                                                                         ||
|  +-------------------------------------------------------------------------+|
|                                                                             |
|  +-------------------------------- NOTES ----------------------------------+|
|  |                                                                         ||
|  |  Notes (Optional)                                                       ||
|  |  +-------------------------------------------------------------------+  ||
|  |  | Reformulated to reduce cost. Replaced sunflower oil with coconut |  ||
|  |  | oil for better texture. Increased protein content to 22%.         |  ||
|  |  +-------------------------------------------------------------------+  ||
|  |                                                                         ||
|  +-------------------------------------------------------------------------+|
|                                                                             |
+-----------------------------------------------------------------------------+
|                                                                             |
|  [Cancel]                        [Save Draft]  [Save & Approve]            |
|                                                                             |
+-----------------------------------------------------------------------------+
```

### View Approved Mode (Read-Only)

```
+-----------------------------------------------------------------------------+
|  NPD > Project > NPD-2025-00001 > Formulation v1.1           [Clone] [Lock] |
+-----------------------------------------------------------------------------+
|                                                                             |
|  +-------------------------------- HEADER ---------------------------------+|
|  |                                                                         ||
|  |  Version                         Status                                 ||
|  |  +---------------------------+   +---------------------------+          ||
|  |  | v1.1                      |   | [Approved]                |          ||
|  |  +---------------------------+   +---------------------------+          ||
|  |                                                                         ||
|  |  +------------------------------------------+  +---------------------+  ||
|  |  | Effective From                           |  | Effective To        |  ||
|  |  | +--------------------------------------+ |  | +-----------------+ |  ||
|  |  | | 2025-01-25                           | |  | | 2025-02-14      | |  ||
|  |  | +--------------------------------------+ |  | +-----------------+ |  ||
|  |  +------------------------------------------+  +---------------------+  ||
|  |                                                                         ||
|  |  +------------------------------------------+  +---------------------+  ||
|  |  | Output Quantity                          |  | Unit of Measure     |  ||
|  |  | +--------------------------------------+ |  | +-----------------+ |  ||
|  |  | | 100.000                              | |  | | kg              | |  ||
|  |  | +--------------------------------------+ |  | +-----------------+ |  ||
|  |  +------------------------------------------+  +---------------------+  ||
|  |                                                                         ||
|  |  Approved by: Jane Doe on Feb 08, 2025 14:30                           ||
|  |                                                                         ||
|  +-------------------------------------------------------------------------+|
|                                                                             |
|  +-------------------------------- ITEMS TABLE ----------------------------+|
|  |                                                                         ||
|  |  Ingredients (5)                                          Read-Only     ||
|  |  -------------------------------------------------------------------    ||
|  |                                                                         ||
|  |  +-------------------------------------------------------------------+  ||
|  |  | Product              | Qty      | UoM  | %      | Notes   |       |  ||
|  |  +-------------------------------------------------------------------+  ||
|  |  | ING-001              | 42.000   | kg   | 42.00% |         |       |  ||
|  |  | Pea Protein Isolate  |          |      |        |         |       |  ||
|  |  +-------------------------------------------------------------------+  ||
|  |  | ING-002              | 28.000   | kg   | 28.00% |         |       |  ||
|  |  | Water                |          |      |        |         |       |  ||
|  |  +-------------------------------------------------------------------+  ||
|  |  | ING-006              | 15.000   | kg   | 15.00% |         |       |  ||
|  |  | Sunflower Oil        |          |      |        |         |       |  ||
|  |  +-------------------------------------------------------------------+  ||
|  |  | ING-004              |  8.000   | kg   |  8.00% |         |       |  ||
|  |  | Methylcellulose      |          |      |        |         |       |  ||
|  |  +-------------------------------------------------------------------+  ||
|  |  | ING-005              |  7.000   | kg   |  7.00% |         |       |  ||
|  |  | Seasoning Blend      |          |      |        |         |       |  ||
|  |  +-------------------------------------------------------------------+  ||
|  |                                                                         ||
|  |  Total: 100.000 kg                              100.00%                 ||
|  |                                                                         ||
|  +-------------------------------------------------------------------------+|
|                                                                             |
|  +-------------------------------- ALLERGEN PREVIEW -----------------------+|
|  |                                                                         ||
|  |  Allergen Declaration                                    [i Details v]  ||
|  |  +-------------------------------------------------------------------+  ||
|  |  |  Contains: Soy (from ING-001 Pea Protein Isolate)                 |  ||
|  |  |            Sunflower (from ING-006 Sunflower Oil)                 |  ||
|  |  |                                                                   |  ||
|  |  |  May Contain: Wheat (shared production line)                      |  ||
|  |  +-------------------------------------------------------------------+  ||
|  |                                                                         ||
|  +-------------------------------------------------------------------------+|
|                                                                             |
|  +-------------------------------- NOTES ----------------------------------+|
|  |                                                                         ||
|  |  Notes                                                                  ||
|  |  +-------------------------------------------------------------------+  ||
|  |  | Original approved formulation. Passed sensory evaluation with     |  ||
|  |  | 87% approval rate. Ready for trial production.                    |  ||
|  |  +-------------------------------------------------------------------+  ||
|  |                                                                         ||
|  +-------------------------------------------------------------------------+|
|                                                                             |
+-----------------------------------------------------------------------------+
|                                                                             |
|  [Back to Project]                                   [Clone]  [Lock Version]|
|                                                                             |
+-----------------------------------------------------------------------------+
```

### View Locked Mode (Immutable)

```
+-----------------------------------------------------------------------------+
|  NPD > Project > NPD-2025-00001 > Formulation v1.0                   [Clone]|
+-----------------------------------------------------------------------------+
|                                                                             |
|  +-------------------------------- HEADER ---------------------------------+|
|  |                                                                         ||
|  |  +-------------------------------------------------------------------+  ||
|  |  | [Lock Icon] This formulation is LOCKED and cannot be modified.   |  ||
|  |  | Locked formulations are immutable for audit and traceability.    |  ||
|  |  |                                               [Clone to New Version]||
|  |  +-------------------------------------------------------------------+  ||
|  |                                                                         ||
|  |  Version                         Status                                 ||
|  |  +---------------------------+   +---------------------------+          ||
|  |  | v1.0                      |   | [Locked]                  |          ||
|  |  +---------------------------+   +---------------------------+          ||
|  |                                                                         ||
|  |  +------------------------------------------+  +---------------------+  ||
|  |  | Effective From                           |  | Effective To        |  ||
|  |  | +--------------------------------------+ |  | +-----------------+ |  ||
|  |  | | 2025-01-15                           | |  | | 2025-01-24      | |  ||
|  |  | +--------------------------------------+ |  | +-----------------+ |  ||
|  |  +------------------------------------------+  +---------------------+  ||
|  |                                                                         ||
|  |  +------------------------------------------+  +---------------------+  ||
|  |  | Output Quantity                          |  | Unit of Measure     |  ||
|  |  | +--------------------------------------+ |  | +-----------------+ |  ||
|  |  | | 100.000                              | |  | | kg              | |  ||
|  |  | +--------------------------------------+ |  | +-----------------+ |  ||
|  |  +------------------------------------------+  +---------------------+  ||
|  |                                                                         ||
|  |  Approved by: Jane Doe | Locked on: Jan 25, 2025 10:00                 ||
|  |                                                                         ||
|  +-------------------------------------------------------------------------+|
|                                                                             |
|  (Items table and allergen preview same as approved mode - all read-only)  |
|                                                                             |
+-----------------------------------------------------------------------------+
|                                                                             |
|  [Back to Project]                                              [Clone]     |
|                                                                             |
+-----------------------------------------------------------------------------+
```

### Add Item Modal

```
+-------------------------------------------------------------------+
|  Add Ingredient                                                 [X]|
+-------------------------------------------------------------------+
|                                                                   |
|  Ingredient * (Required)                                          |
|  +-------------------------------------------------------------+  |
|  | Search ingredients by code or name...                     v |  |
|  +-------------------------------------------------------------+  |
|  Type to search (ING, RM types only)                              |
|                                                                   |
|  +-------------------------------------------------------------+  |
|  | Selected: ING-001 - Pea Protein Isolate                     |  |
|  |   Type: Ingredient | Base UoM: kg | Stock: 250 kg           |  |
|  |   Allergens: Soy | Cost: 12.50 PLN/kg                       |  |
|  +-------------------------------------------------------------+  |
|                                                                   |
|  -----------------------------------------------------------------|
|                                                                   |
|  Quantity * (Required)                                            |
|  +--------------------------+                                     |
|  | 45.000                   |                                     |
|  +--------------------------+                                     |
|  Amount in formulation batch                                      |
|                                                                   |
|  Unit of Measure                                                  |
|  +--------------------------+                                     |
|  | kg (from product)        |                                     |
|  +--------------------------+                                     |
|  Auto-filled from selected product base UoM                       |
|                                                                   |
|  Calculated Percentage (Read-Only)                                |
|  +--------------------------+                                     |
|  | 45.00%                   |  (45 kg / 100 kg x 100)             |
|  +--------------------------+                                     |
|  Auto-calculated: (quantity / output_qty) x 100                   |
|                                                                   |
|  Notes (Optional)                                                 |
|  +-------------------------------------------------------------+  |
|  | Use organic certified source only.                          |  |
|  |                                                             |  |
|  +-------------------------------------------------------------+  |
|  Max 500 characters                                               |
|                                                                   |
+-------------------------------------------------------------------+
|                                                                   |
|  [Cancel]                    [Save Item]  [Save & Add Another]    |
|                                                                   |
+-------------------------------------------------------------------+
```

### Loading State

```
+-----------------------------------------------------------------------------+
|  NPD > Project > ... > Formulation                                     [...]|
+-----------------------------------------------------------------------------+
|                                                                             |
|  +-------------------------------- HEADER ---------------------------------+|
|  |                                                                         ||
|  |  [===================]           [===================]                  ||
|  |  [===========]                   [===========]                          ||
|  |                                                                         ||
|  |  [===========================]  [===================]                   ||
|  |  [===============]              [===============]                       ||
|  |                                                                         ||
|  +-------------------------------------------------------------------------+|
|                                                                             |
|  +-------------------------------- ITEMS TABLE ----------------------------+|
|  |                                                                         ||
|  |                        [Spinner]                                        ||
|  |                                                                         ||
|  |                  Loading formulation items...                           ||
|  |                                                                         ||
|  +-------------------------------------------------------------------------+|
|                                                                             |
|  +-------------------------------- ALLERGEN PREVIEW -----------------------+|
|  |                                                                         ||
|  |  [=========================================================]            ||
|  |  [=====================================]                                ||
|  |                                                                         ||
|  +-------------------------------------------------------------------------+|
|                                                                             |
+-----------------------------------------------------------------------------+
```

### Validation Error State

```
+-----------------------------------------------------------------------------+
|  NPD > Project > NPD-2025-00001 > New Formulation                      [X]  |
+-----------------------------------------------------------------------------+
|                                                                             |
|  +-------------------------------------------------------------------+     |
|  | [!] Validation Errors                                              |     |
|  |                                                                    |     |
|  | - Output Quantity is required                                      |     |
|  | - Formulation must have at least one ingredient                    |     |
|  | - Effective From date overlaps with v1.1 (Jan 25 - Feb 14)        |     |
|  |                                                                    |     |
|  | [Dismiss]                                                          |     |
|  +-------------------------------------------------------------------+     |
|                                                                             |
|  +-------------------------------- HEADER ---------------------------------+|
|  |                                                                         ||
|  |  Version *                       Status                                 ||
|  |  +---------------------------+   +---------------------------+          ||
|  |  | v2.0                      |   | [Draft]                   |          ||
|  |  +---------------------------+   +---------------------------+          ||
|  |                                                                         ||
|  |  +------------------------------------------+  +---------------------+  ||
|  |  | Effective From (ERROR)                   |  | Effective To        |  ||
|  |  | +--------------------------------------+ |  | +-----------------+ |  ||
|  |  | | 2025-01-30                    [cal]  | |  | |           [cal] | |  ||
|  |  | +--------------------------------------+ |  | +-----------------+ |  ||
|  |  | [!] Date overlaps with v1.1                                      |  ||
|  |  +------------------------------------------+  +---------------------+  ||
|  |                                                                         ||
|  |  +------------------------------------------+  +---------------------+  ||
|  |  | Output Quantity * (ERROR)                |  | Unit of Measure *   |  ||
|  |  | +--------------------------------------+ |  | +-----------------+ |  ||
|  |  | |                                  [!] | |  | | kg          [v] | |  ||
|  |  | +--------------------------------------+ |  | +-----------------+ |  ||
|  |  | [!] Output Quantity is required                                  |  ||
|  |  +------------------------------------------+  +---------------------+  ||
|  |                                                                         ||
|  +-------------------------------------------------------------------------+|
|                                                                             |
|  +-------------------------------- ITEMS TABLE ----------------------------+|
|  |                                                                         ||
|  |  Ingredients (0) - (ERROR)                              [+ Add Item]    ||
|  |  -------------------------------------------------------------------    ||
|  |  [!] Formulation must have at least one ingredient                      ||
|  |                                                                         ||
|  |  +-------------------------------------------------------------------+  ||
|  |  |                   No ingredients added yet                        |  ||
|  |  |                      [+ Add First Ingredient]                     |  ||
|  |  +-------------------------------------------------------------------+  ||
|  |                                                                         ||
|  +-------------------------------------------------------------------------+|
|                                                                             |
+-----------------------------------------------------------------------------+
|                                                                             |
|  [Cancel]                                               [Save Draft]       |
|                                                                             (disabled)
+-----------------------------------------------------------------------------+
```

### Mobile View (< 768px)

```
+----------------------------------+
|  < Formulation v2.0              |
|  [Actions v]                     |
+----------------------------------+
|                                  |
|  Status: [Draft]                 |
|                                  |
|  +----------------------------+  |
|  | Version                    |  |
|  | v2.0                       |  |
|  +----------------------------+  |
|  | Output Quantity            |  |
|  | 100.000 kg                 |  |
|  +----------------------------+  |
|  | Effective From             |  |
|  | 2025-02-15                 |  |
|  +----------------------------+  |
|  | Effective To               |  |
|  | -                          |  |
|  +----------------------------+  |
|                                  |
|  Ingredients (5)   [+ Add]       |
|  +----------------------------+  |
|  | ING-001                    |  |
|  | Pea Protein Isolate        |  |
|  | 45.000 kg | 45.00%    [X]  |  |
|  +----------------------------+  |
|  | ING-002                    |  |
|  | Water                      |  |
|  | 25.000 kg | 25.00%    [X]  |  |
|  +----------------------------+  |
|  | ING-003                    |  |
|  | Coconut Oil                |  |
|  | 15.000 kg | 15.00%    [X]  |  |
|  +----------------------------+  |
|  | ING-004                    |  |
|  | Methylcellulose            |  |
|  | 8.000 kg | 8.00%      [X]  |  |
|  +----------------------------+  |
|  | ING-005                    |  |
|  | Seasoning Blend            |  |
|  | 7.000 kg | 7.00%      [X]  |  |
|  +----------------------------+  |
|                                  |
|  Total: 100.000 kg | 100.00%     |
|                                  |
|  Allergens                       |
|  +----------------------------+  |
|  | Contains: Soy              |  |
|  | May Contain: Wheat         |  |
|  +----------------------------+  |
|                                  |
|  Notes                           |
|  +----------------------------+  |
|  | Reformulated to reduce     |  |
|  | cost...                    |  |
|  +----------------------------+  |
|                                  |
|  [Save Draft]                    |
|  [Save & Approve]                |
|                                  |
+----------------------------------+
```

---

## Key Components

### 1. Header Section

| Field | Type | Required | Editable When | Description |
|-------|------|----------|---------------|-------------|
| version | Text (Read-only) | Yes | Create only | Version number (v1.0, v2.0) |
| status | Badge (Read-only) | Yes | Never | Draft, Approved, Locked |
| effective_from | Date Picker | No | Draft | Start date for version |
| effective_to | Date Picker | No | Draft | End date for version |
| output_qty | Decimal Input | Yes | Draft | Total batch quantity |
| uom | Select | Yes | Draft | Unit of measure |

**Status Display:**
- Draft: Yellow badge, editable
- Approved: Green badge, read-only
- Locked: Gray badge with lock icon, immutable

### 2. Items Table

| Column | Description | Width | Sortable |
|--------|-------------|-------|----------|
| Product | Product code + name (2 lines) | 40% | Yes |
| Qty | Quantity (decimal, 6 places) | 15% | Yes |
| UoM | Unit of measure | 10% | No |
| % | Auto-calculated percentage | 15% | Yes |
| Notes | Item notes (truncated) | 15% | No |
| Actions | [X] delete button | 5% | No |

**Table Footer:**
- Total quantity with UoM
- Total percentage (should equal 100%)
- Info message about auto-calculation

### 3. Allergen Preview Panel

| Section | Description |
|---------|-------------|
| Contains | Definite allergens from ingredients |
| May Contain | Cross-contamination risks |
| Source | Which ingredient contributes each allergen |

**Expandable Details:**
- Click "[i Details v]" to see full breakdown
- Lists each allergen with source product

### 4. Notes Section

| Field | Type | Max Length | Placeholder |
|-------|------|------------|-------------|
| notes | Textarea | 1000 chars | "Formulation notes, special instructions..." |

---

## Main Actions

### Header Actions (Status-Dependent)

| Action | Button | Visible When | Result |
|--------|--------|--------------|--------|
| Close | [X] | Always | Close editor, return to project |
| Clone | [Clone] | status = approved OR locked | Opens clone confirmation |
| Lock | [Lock Version] | status = approved | Locks formulation permanently |

### Footer Actions

| Action | Button | Visible When | Result |
|--------|--------|--------------|--------|
| Cancel | [Cancel] | status = draft | Discard changes, close |
| Save Draft | [Save Draft] | status = draft | Save without approval |
| Save & Approve | [Save & Approve] | status = draft, items > 0 | Save and set status to approved |
| Back | [Back to Project] | status != draft | Return to project detail |

### Item Actions

| Action | Button | Visible When | Result |
|--------|--------|--------------|--------|
| Add Item | [+ Add Item] | status = draft | Opens Add Item modal |
| Delete Item | [X] | status = draft | Remove item from list |

---

## States

| State | Description | Elements Shown |
|-------|-------------|----------------|
| **create-mode** | Creating new formulation | Empty form, version auto-suggested |
| **edit-draft** | Editing draft formulation | Full form, all fields editable |
| **view-approved** | Viewing approved formulation | Read-only, Clone/Lock buttons |
| **view-locked** | Viewing locked formulation | Read-only with lock banner, Clone only |
| **loading** | Initial load | Skeleton UI |
| **validation-error** | Form has errors | Error banner, inline errors |

---

## State Transitions

```
New Formulation
  |
  v
CREATE-MODE (Form empty)
  | [Save Draft]
  v
EDIT-DRAFT (status = draft)
  | [Save & Approve]
  v
VIEW-APPROVED (status = approved)
  | [Lock Version]
  v
VIEW-LOCKED (status = locked)

----------------------------------------------

VIEW-APPROVED or VIEW-LOCKED
  | [Clone]
  v
CREATE-MODE (pre-filled from source, new version)

----------------------------------------------

Any State
  | [Cancel] or [X] or [Back]
  v
NPD-002 Project Detail (Formulations Tab)
```

---

## Validation

### Formulation Fields

```typescript
{
  formulation_number: {
    required: "Version number is required",
    pattern: {
      value: /^v\d+\.\d+$/,
      message: "Version must be in format vX.Y (e.g., v1.0, v2.1)"
    }
  },
  total_qty: {
    required: "Output quantity is required",
    min: { value: 0.000001, message: "Quantity must be greater than 0" },
    validate: (value) => {
      const decimals = (value.toString().split('.')[1] || '').length
      if (decimals > 4) {
        return "Maximum 4 decimal places allowed"
      }
      return true
    }
  },
  uom: {
    required: "Unit of measure is required"
  },
  effective_from: {
    validate: (value, formValues) => {
      // Check for overlapping versions
      if (value && overlapsExistingVersion(value, formValues.effective_to)) {
        return "Effective dates overlap with another version"
      }
      return true
    }
  },
  effective_to: {
    validate: (value, formValues) => {
      if (value && formValues.effective_from && value < formValues.effective_from) {
        return "Effective To must be after Effective From"
      }
      return true
    }
  },
  notes: {
    maxLength: { value: 1000, message: "Notes must be less than 1000 characters" }
  }
}
```

### Formulation Item Fields

```typescript
{
  product_id: {
    required: "Ingredient is required",
    validate: (value) => {
      if (existingItems.includes(value)) {
        return "Ingredient already exists in this formulation"
      }
      return true
    }
  },
  quantity: {
    required: "Quantity is required",
    min: { value: 0.000001, message: "Quantity must be greater than 0" },
    validate: (value) => {
      const decimals = (value.toString().split('.')[1] || '').length
      if (decimals > 4) {
        return "Maximum 4 decimal places allowed"
      }
      return true
    }
  },
  notes: {
    maxLength: { value: 500, message: "Notes must be less than 500 characters" }
  }
}
```

### Approval Validation

```typescript
{
  // Required before Save & Approve
  items: {
    validate: () => {
      if (items.length === 0) {
        return "Formulation must have at least one ingredient"
      }
      return true
    }
  },
  total_percentage: {
    validate: () => {
      const total = items.reduce((sum, item) => sum + item.percentage, 0)
      if (Math.abs(total - 100) > 0.01) {
        // Warning only, not blocking
        console.warn(`Total percentage is ${total.toFixed(2)}%, not 100%`)
      }
      return true
    }
  }
}
```

### Error Messages

```typescript
{
  "DUPLICATE_INGREDIENT": "Ingredient already exists in this formulation. Edit the existing item instead.",
  "INVALID_QUANTITY": "Quantity must be greater than 0 and have max 4 decimal places.",
  "DATE_OVERLAP": "Effective dates overlap with another version. Adjust dates or close existing version first.",
  "NO_INGREDIENTS": "Formulation must have at least one ingredient before approval.",
  "FORMULATION_LOCKED": "Cannot modify a locked formulation. Clone to create a new version.",
  "FORMULATION_NOT_FOUND": "Formulation not found or you don't have permission to view it.",
  "PERMISSION_DENIED": "You do not have permission to modify this formulation."
}
```

---

## Data Required

### API Endpoints

#### Get Formulation Detail

```
GET /api/npd/formulations/:id

Response:
{
  "success": true,
  "data": {
    "formulation": {
      "id": "uuid-form-1",
      "org_id": "uuid-org",
      "npd_project_id": "uuid-npd-001",
      "formulation_number": "v2.0",
      "status": "draft",
      "effective_from": "2025-02-15",
      "effective_to": null,
      "parent_formulation_id": "uuid-form-prev",
      "total_qty": 100.000,
      "uom": "kg",
      "notes": "Reformulated to reduce cost...",
      "approved_by": null,
      "approved_at": null,
      "created_at": "2025-02-10T09:00:00Z",
      "updated_at": "2025-02-14T15:30:00Z"
    },
    "items": [
      {
        "id": "uuid-item-1",
        "formulation_id": "uuid-form-1",
        "product_id": "uuid-prod-1",
        "product_code": "ING-001",
        "product_name": "Pea Protein Isolate",
        "product_type": "ING",
        "quantity": 45.000,
        "uom": "kg",
        "percentage": 45.00,
        "notes": null,
        "allergens": ["Soy"],
        "cost_per_unit": 12.50
      }
    ],
    "allergens": {
      "contains": [
        { "allergen": "Soy", "source": "ING-001 Pea Protein Isolate" }
      ],
      "may_contain": [
        { "allergen": "Wheat", "source": "Shared production line" }
      ]
    },
    "summary": {
      "total_items": 5,
      "total_qty": 100.000,
      "total_percentage": 100.00,
      "estimated_cost": 4.72
    }
  }
}
```

#### Create Formulation

```
POST /api/npd/formulations

Request:
{
  "npd_project_id": "uuid-npd-001",
  "formulation_number": "v2.0",
  "total_qty": 100.000,
  "uom": "kg",
  "effective_from": "2025-02-15",
  "effective_to": null,
  "parent_formulation_id": "uuid-form-prev",
  "notes": "Reformulated to reduce cost..."
}

Response:
{
  "success": true,
  "data": {
    "id": "uuid-form-new",
    "formulation_number": "v2.0",
    "status": "draft",
    ...
  }
}
```

#### Update Formulation

```
PUT /api/npd/formulations/:id

Request:
{
  "total_qty": 100.000,
  "uom": "kg",
  "effective_from": "2025-02-15",
  "effective_to": null,
  "notes": "Updated notes..."
}

Response:
{
  "success": true,
  "data": { ... }
}
```

#### Approve Formulation

```
POST /api/npd/formulations/:id/approve

Request:
{
  "effective_from": "2025-02-15"
}

Response:
{
  "success": true,
  "data": {
    "id": "uuid-form-1",
    "status": "approved",
    "approved_by": "uuid-user",
    "approved_at": "2025-02-14T16:00:00Z"
  }
}
```

#### Lock Formulation

```
POST /api/npd/formulations/:id/lock

Response:
{
  "success": true,
  "data": {
    "id": "uuid-form-1",
    "status": "locked"
  }
}
```

#### Clone Formulation

```
POST /api/npd/formulations/:id/clone

Request:
{
  "new_version": "v2.1"
}

Response:
{
  "success": true,
  "data": {
    "id": "uuid-form-new",
    "formulation_number": "v2.1",
    "status": "draft",
    "parent_formulation_id": "uuid-form-1"
  }
}
```

#### Get Formulation Items

```
GET /api/npd/formulations/:id/items

Response:
{
  "success": true,
  "data": [
    {
      "id": "uuid-item-1",
      "product_id": "uuid-prod-1",
      "product_code": "ING-001",
      "product_name": "Pea Protein Isolate",
      "quantity": 45.000,
      "uom": "kg",
      "percentage": 45.00,
      "notes": null,
      "allergens": ["Soy"]
    }
  ]
}
```

#### Create Formulation Item

```
POST /api/npd/formulations/:id/items

Request:
{
  "product_id": "uuid-prod-1",
  "quantity": 45.000,
  "uom": "kg",
  "notes": null
}

Response:
{
  "success": true,
  "data": {
    "id": "uuid-item-new",
    "product_id": "uuid-prod-1",
    "quantity": 45.000,
    "percentage": 45.00
  }
}
```

#### Delete Formulation Item

```
DELETE /api/npd/formulations/:formId/items/:itemId

Response:
{
  "success": true,
  "message": "Item deleted successfully"
}
```

#### Get Allergen Aggregation

```
GET /api/npd/formulations/:id/allergens

Response:
{
  "success": true,
  "data": {
    "contains": [
      { "allergen": "Soy", "source": "ING-001 Pea Protein Isolate" },
      { "allergen": "Sunflower", "source": "ING-006 Sunflower Oil" }
    ],
    "may_contain": [
      { "allergen": "Wheat", "source": "Shared production line" }
    ]
  }
}
```

---

## Technical Notes

### Version Auto-Suggestion

```typescript
const suggestNextVersion = (existingVersions: string[]): string => {
  // Find highest version number
  const versions = existingVersions
    .map(v => {
      const match = v.match(/^v(\d+)\.(\d+)$/)
      return match ? { major: parseInt(match[1]), minor: parseInt(match[2]) } : null
    })
    .filter(Boolean)
    .sort((a, b) => b.major - a.major || b.minor - a.minor)

  if (versions.length === 0) return 'v1.0'

  const latest = versions[0]
  // Suggest next major version
  return `v${latest.major + 1}.0`
}
```

### Percentage Calculation

```typescript
const calculatePercentage = (itemQty: number, totalQty: number): number => {
  if (totalQty === 0) return 0
  return Math.round((itemQty / totalQty) * 10000) / 100 // 2 decimal places
}

// Recalculate all percentages when output_qty changes
const recalculateAllPercentages = (items: FormulationItem[], totalQty: number) => {
  return items.map(item => ({
    ...item,
    percentage: calculatePercentage(item.quantity, totalQty)
  }))
}
```

### Allergen Aggregation

```typescript
const aggregateAllergens = (items: FormulationItem[]): AllergenDeclaration => {
  const contains: AllergenSource[] = []
  const mayContain: AllergenSource[] = []

  items.forEach(item => {
    // Definite allergens from product
    item.allergens?.forEach(allergen => {
      if (!contains.find(a => a.allergen === allergen)) {
        contains.push({
          allergen,
          source: `${item.product_code} ${item.product_name}`
        })
      }
    })

    // May contain from cross-contamination (from product metadata)
    item.may_contain_allergens?.forEach(allergen => {
      if (!mayContain.find(a => a.allergen === allergen)) {
        mayContain.push({
          allergen,
          source: item.cross_contamination_source || 'Shared production line'
        })
      }
    })
  })

  return { contains, mayContain }
}
```

### Date Overlap Detection

```typescript
const checkDateOverlap = (
  newFrom: Date | null,
  newTo: Date | null,
  existingVersions: { effective_from: Date | null, effective_to: Date | null }[]
): boolean => {
  if (!newFrom) return false

  return existingVersions.some(version => {
    const vFrom = version.effective_from
    const vTo = version.effective_to

    if (!vFrom) return false

    // Open-ended ranges
    if (!newTo && !vTo) {
      return true // Both open-ended, always overlap
    }

    if (!newTo) {
      return newFrom <= (vTo || new Date('9999-12-31'))
    }

    if (!vTo) {
      return vFrom <= newTo
    }

    // Both have end dates
    return newFrom <= vTo && newTo >= vFrom
  })
}
```

---

## Accessibility (WCAG 2.1 AA)

### Touch Targets
- All buttons: 48x48dp minimum
- [X] delete buttons in table: 48x48dp
- Date picker icons: 48x48dp
- Dropdown triggers: 48dp height

### Contrast
- Text: 4.5:1 minimum
- Status badges: WCAG AA compliant colors
- Error text: 4.5:1 on white background
- Locked banner: 4.5:1

### Screen Reader
- Page title: "Create Formulation for NPD-2025-00001" or "Formulation v2.0 - Draft"
- Status: "Status: Draft, editable"
- Items table: "Ingredients table, 5 items"
- Allergen panel: "Allergen declaration: Contains Soy from Pea Protein Isolate"
- Delete button: aria-label="Delete ingredient [product_name]"
- Save button: aria-label="Save formulation as draft"

### Keyboard Navigation
- Tab: Navigate between form fields, buttons, table rows
- Enter: Submit forms, activate buttons
- Escape: Close modal
- Arrow keys: Navigate within table

### Focus Management
- On modal open: Focus on first input
- On item add: Focus returns to Add Item button
- On item delete: Focus moves to next row or Add Item button
- On validation error: Focus on first error field

---

## Responsive Breakpoints

| Breakpoint | Layout |
|------------|--------|
| Desktop (>1024px) | Full layout with side-by-side date pickers |
| Tablet (768-1024px) | Stacked date pickers, condensed table |
| Mobile (<768px) | Full vertical stack, card-style items list |

---

## Permissions

| Role | Create | Edit Draft | View Approved | Approve | Lock | Clone |
|------|--------|------------|---------------|---------|------|-------|
| Admin | Yes | Yes | Yes | Yes | Yes | Yes |
| NPD Lead | Yes | Yes | Yes | Yes | Yes | Yes |
| R&D | Yes (assigned project) | Yes (assigned) | Yes | No | No | Yes |
| Regulatory | No | No | Yes | No | No | No |
| Finance | No | No | Yes | No | No | No |

---

## Related Screens

- **Parent**: NPD-002 (Project Detail Page - Formulations Tab)
- **Related**: NPD-003 (Stage-Gate Timeline)
- **Related**: TEC-006a (BOM Items Detail - reference pattern)
- **Next**: NPD-006 (Handoff Wizard - uses approved formulation)

---

## Handoff to FRONTEND-DEV

```yaml
feature: NPD Formulation Editor
story: NPD-007
fr_coverage: NPD-FR-08 to NPD-FR-16
approval_status:
  mode: "review_each"
  user_approved: false  # PENDING USER REVIEW
deliverables:
  wireframe: docs/3-ARCHITECTURE/ux/wireframes/NPD-007-formulation-editor.md
  api_endpoints:
    - GET /api/npd/formulations/:id
    - POST /api/npd/formulations
    - PUT /api/npd/formulations/:id
    - POST /api/npd/formulations/:id/approve
    - POST /api/npd/formulations/:id/lock
    - POST /api/npd/formulations/:id/clone
    - GET /api/npd/formulations/:id/items
    - POST /api/npd/formulations/:id/items
    - DELETE /api/npd/formulations/:formId/items/:itemId
    - GET /api/npd/formulations/:id/allergens
states_per_screen: [create-mode, edit-draft, view-approved, view-locked, loading, validation-error]
components:
  - Header (version, status dropdown, effective from/to dates, output qty + uom)
  - Items table (product selector autocomplete, quantity, uom, percentage auto-calc, [X] delete)
  - Add Item button
  - Allergen preview panel (aggregated allergens from items)
  - Notes textarea
  - Footer buttons ([Save Draft], [Save & Approve], [Lock Version])
breakpoints:
  mobile: "<768px"
  tablet: "768-1024px"
  desktop: ">1024px"
accessibility:
  touch_targets: "48dp minimum"
  contrast: "4.5:1 minimum"
  screen_reader: "Full ARIA support"
related_screens:
  - NPD-002: Project Detail Page
  - NPD-003: Stage-Gate Timeline
  - NPD-006: Handoff Wizard
  - TEC-006a: BOM Items Detail (pattern reference)
critical_ux_requirements:
  - Auto-calculate percentages from quantity
  - Real-time allergen aggregation
  - Date overlap prevention
  - Status-based action visibility
  - Clone workflow for new versions
  - Lock confirmation for immutability
libraries:
  - ShadCN Dialog (for Add Item modal)
  - ShadCN Table (for items list)
  - ShadCN Combobox (for product search)
  - ShadCN Badge (for status display)
  - ShadCN DatePicker (for effective dates)
  - react-hook-form + Zod (for validation)
```

---

## Quality Gates

Before handoff to FRONTEND-DEV:
- [x] All states defined (create-mode, edit-draft, view-approved, view-locked, loading, validation-error)
- [x] All components specified (Header, Items Table, Add Item Modal, Allergen Panel, Notes, Footer)
- [x] API endpoints documented
- [x] Status-based action visibility defined
- [x] Accessibility requirements met
- [x] Responsive design documented
- [x] Validation rules specified
- [x] Percentage calculation logic documented
- [x] Allergen aggregation logic documented
- [x] Date overlap detection specified
- [x] Permission matrix defined

---

**Status**: Ready for User Review
**Approval Mode**: review_each (default)
**User Approved**: Pending
**Iterations**: 0 of 3
**PRD Coverage**: NPD-FR-08 to NPD-FR-16 (100%)
**Estimated Effort**: 8-10 hours implementation
**Quality Target**: 95/100
