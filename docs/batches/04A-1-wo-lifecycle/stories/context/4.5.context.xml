<story-context id="4-5-operation-complete" v="1.0">
  <metadata>
    <epicId>4</epicId>
    <storyId>5</storyId>
    <title>Operation Complete</title>
    <status>drafted</status>
    <generatedAt>2025-11-27</generatedAt>
    <template>Action Pattern - Status Transition with Yield Calculation</template>
    <estimatedTokens>5200</estimatedTokens>
    <estimatedEffort>0.5 days</estimatedEffort>
  </metadata>

  <story>
    <asA>Operator</asA>
    <iWant>to complete a WO operation</iWant>
    <soThat>I can move to the next step and record actual yield</soThat>
    <tasks>
      <task id="1" ac="AC-4.5.1, AC-4.5.2">Update wo_operations schema (completed_at, actual_yield_percent, actual_duration_minutes)</task>
      <task id="2" ac="AC-4.5.2, AC-4.5.3">Create OperationCompleteService with completeOperation() method</task>
      <task id="3" ac="AC-4.5.4">Create POST /api/production/work-orders/:id/operations/:opId/complete endpoint</task>
      <task id="4" ac="AC-4.5.1, AC-4.5.5">Frontend OperationCompleteModal with auto-calculated duration and yield defaults</task>
      <task id="5" ac="AC-4.5.8">Next operation ready logic - update sequence validation</task>
      <task id="6" ac="ALL">Tests (unit, integration, E2E) - status transition, yield calculation, duration auto-fill</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC-4.5.1">Given operation is in 'in_progress' status (from Story 4.4), When clicking "Complete" button, Then modal shows: actual_duration_minutes (default calculated from started_at to NOW()), actual_yield_percent (default 100%), notes field (optional)</criterion>
    <criterion id="AC-4.5.2">Given modal is open and user confirms, When clicking "Confirm Complete", Then system validates (operation.status = 'in_progress', user has Production/Manager/Admin role), updates wo_operations (status â†’ 'completed', completed_at â†’ NOW(), actual_yield_percent â†’ entered value, actual_duration_minutes â†’ entered value, completed_by_user_id â†’ current_user.id), returns updated operation object</criterion>
    <criterion id="AC-4.5.3">Given operation has expected_output and actual_output, When calculating yield, Then actual_yield_percent = (actual_output / expected_output) Ã— 100, defaults to 100% if no outputs recorded yet. Display as editable field with validation (0-200% range, warn if &lt;80% or &gt;120%)</criterion>
    <criterion id="AC-4.5.4">API Endpoint: POST /api/production/work-orders/:id/operations/:opId/complete - Request body: { duration_minutes?: number, yield_percent?: number, notes?: string } - Response 200: { data: { id, operation_name, status: 'completed', completed_at, actual_yield_percent, actual_duration_minutes, completed_by_user: {name} }, message: "Operation completed successfully" } - Error codes: INVALID_STATUS, NOT_FOUND, ORG_ISOLATION, FORBIDDEN</criterion>
    <criterion id="AC-4.5.5">Given user does not enter duration_minutes, When submitting form, Then system auto-calculates: duration_minutes = EXTRACT(EPOCH FROM (NOW() - started_at)) / 60 (rounded to nearest minute). Display calculated value in form with option to override.</criterion>
    <criterion id="AC-4.5.6">Given operation is not in 'in_progress' status, When trying to complete, Then system returns 400 error: "Operation must be in progress to complete" with current status info</criterion>
    <criterion id="AC-4.5.7">Audit Trail: completed_at timestamp (server-side), completed_by_user_id stored on wo_operations, actual_yield_percent and actual_duration_minutes recorded for analytics</criterion>
    <criterion id="AC-4.5.8">Given operation N is completed, When checking next operation N+1 in sequence, Then if require_operation_sequence enabled, next operation becomes available to start (status remains 'not_started' but Start button enabled). Update UI to reflect availability.</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/epics/04-production.md</path>
        <title>Epic 4: Production Execution</title>
        <section>Story 4.5: Operation Complete</section>
        <snippet>Enable operators to complete in-progress operations and record actual yield/duration. Complete modal with yield calculation, Duration auto-calculation from started_at, Yield% validation and warnings, Status transition from 'in_progress' â†’ 'completed', Next operation ready (sequence enforcement), Audit trail (operator who completed, timestamp, yield, duration)</snippet>
      </doc>
      <doc>
        <path>docs/ux-design/ux-design-production-module.md</path>
        <title>Production Module UX Design</title>
        <section>WO Details Modal - Operations Tab</section>
        <snippet>Per-operation breakdown table: Seq, Operation Name, Expected IN/OUT, Actual IN/OUT, Losses, Yield%, Operator. Operations summary shows: âœ“ Op1 Grinding (92% yield, target 90%, Completed 10:15), â— Op2 Mixing (CURRENT, 78.3% yield âš ï¸, target 95%), â—‹ Op3 Stuffing (PENDING, Not started). Low yield alerts: ğŸ”´ Low Yield - Op2 Mixing (78.3% &lt; 95% target), Impact: -140 kg output lost</snippet>
      </doc>
      <doc>
        <path>docs/ux-design/ux-design-shared-system.md</path>
        <title>Shared UI Design System</title>
        <section>Interaction Patterns - Notifications & Feedback</section>
        <snippet>Toast Notifications: Position center-bottom, Duration 3-5s auto-dismiss, Types: Success (green), Error (red), Warning (yellow), Info (blue). Inline Validation: Form fields show error state on blur/submit, Red border + error message below field, Helper text for guidance. Loading States: Spinner in button while loading</snippet>
      </doc>
    </docs>

    <code>
      <artifact>
        <path>apps/frontend/lib/supabase/migrations/028_create_work_orders_stub.sql</path>
        <kind>migration</kind>
        <symbol>work_orders table - routing_id reference</symbol>
        <content>
          -- Work Orders Table has routing_id column
          routing_id UUID,

          -- NOTE: wo_operations table needs to be created/extended with:
          -- id UUID PRIMARY KEY
          -- wo_id UUID REFERENCES work_orders(id)
          -- sequence_number INT
          -- operation_name VARCHAR(100)
          -- status VARCHAR(20) -- 'not_started', 'in_progress', 'completed'
          -- started_at TIMESTAMP WITH TIME ZONE
          -- completed_at TIMESTAMP WITH TIME ZONE
          -- expected_duration_minutes INT
          -- actual_duration_minutes INT
          -- expected_yield_percent DECIMAL(5,2) DEFAULT 100
          -- actual_yield_percent DECIMAL(5,2)
          -- expected_output DECIMAL(12,3)
          -- actual_output DECIMAL(12,3)
          -- operator_id UUID REFERENCES users(id) -- who started operation
          -- completed_by_user_id UUID REFERENCES users(id) -- who completed operation
          -- notes TEXT
        </content>
        <reason>Story 4.5 needs wo_operations table with completed_at, actual_yield_percent, actual_duration_minutes, completed_by_user_id columns</reason>
      </artifact>
      <artifact>
        <path>apps/frontend/lib/supabase/migrations/009_create_production_lines_table.sql</path>
        <kind>migration</kind>
        <symbol>production_lines table schema</symbol>
        <content>
          -- Production Lines Table
          CREATE TABLE IF NOT EXISTS public.production_lines (
            id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
            org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
            name VARCHAR(100) NOT NULL,
            description TEXT,
            warehouse_id UUID REFERENCES warehouses(id) ON DELETE SET NULL,
            is_active BOOLEAN DEFAULT true,
            created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,
            updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL
          );

          -- Story 4.5: Production lines provide context for WO operations
          -- Used for displaying line info in operation complete modal
        </content>
        <reason>Context for operation completion - line info displayed in modal</reason>
      </artifact>
      <artifact>
        <path>apps/frontend/components/planning/WorkOrdersTable.tsx</path>
        <kind>component</kind>
        <symbol>Work Orders Table component - status badges pattern</symbol>
        <reason>Story 4.5 can reference status badge patterns for operation status (not_started, in_progress, completed)</reason>
      </artifact>
      <artifact>
        <path>docs/stories/04-4-operation-start.md</path>
        <kind>story</kind>
        <symbol>Story 4.4: Operation Start - defines operation status enum</symbol>
        <content>
          **Operation Status Enum** (defined for all operation stories):
          - **'not_started'**: Initial state (set by Story 3.14 routing, or story 3.10 when operations created)
          - **'in_progress'**: After Story 4.4 (Operation Start)
          - **'completed'**: After Story 4.5 (Operation Complete)

          AC-4.4.2: operation status â†’ 'in_progress', started_at set, operator_id recorded
          AC-4.4.3: Sequence Enforcement - require_operation_sequence enabled â†’ validates N-1 is completed
        </content>
        <reason>Story 4.5 transitions from 'in_progress' (Story 4.4) to 'completed' and enables next operation in sequence</reason>
      </artifact>
      <artifact>
        <path>docs/stories/04-2-wo-start.context.xml</path>
        <kind>context</kind>
        <symbol>WO Start Context - API pattern reference</symbol>
        <content>
          // Pattern from Story 4.2 WO Start API:
          POST /api/production/work-orders/:id/start
          - Extract org_id from session via auth.getUser() â†’ users table
          - Validate status = 'released' before transition
          - Update with server-side timestamp (NOW(), not client-provided)
          - Store user_id for audit trail
          - Return updated object with user join
          - Error codes: INVALID_STATUS, NOT_FOUND, ORG_ISOLATION, FORBIDDEN

          // Story 4.5 follows same pattern:
          POST /api/production/work-orders/:id/operations/:opId/complete
          - Validate operation.status = 'in_progress'
          - Update completed_at, actual_yield_percent, actual_duration_minutes
          - Store completed_by_user_id for audit
        </content>
        <reason>Story 4.5 API endpoint follows same org isolation, validation, and audit pattern as Story 4.2</reason>
      </artifact>
    </code>

    <dependencies>
      <node>
        <package name="@supabase/supabase-js" version="^2.84.0" usage="Supabase client for operation status updates and queries" />
        <package name="zod" version="^3.25.76" usage="Validation schemas for operation complete request (duration, yield, notes)" />
        <package name="react-hook-form" version="^7.x" usage="Form state management in OperationCompleteModal" />
        <package name="date-fns" version="^3.x" usage="Duration calculation (differenceInMinutes) from started_at to NOW()" />
      </node>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="architecture">Action Pattern - One-way operation endpoint (POST /api/production/work-orders/:id/operations/:opId/complete), not CRUD. Similar to start, pause, resume operations</constraint>
    <constraint type="business">Status validation - Only 'in_progress' operations can be completed (not 'not_started', not already 'completed')</constraint>
    <constraint type="business">Timestamps - Server-side (not client) to ensure consistency. Use NOW() in SQL for completed_at</constraint>
    <constraint type="business">Yield calculation - actual_yield_percent = (actual_output / expected_output) Ã— 100. Default 100% if no outputs recorded yet. Validate range 0-200%, warn if &lt;80% or &gt;120%</constraint>
    <constraint type="business">Duration auto-calculation - If duration_minutes not provided, calculate: EXTRACT(EPOCH FROM (NOW() - started_at)) / 60. Display calculated value with option to override</constraint>
    <constraint type="business">Sequence enforcement - If require_operation_sequence enabled, completing operation N makes operation N+1 available to start (status stays 'not_started' but Start button enabled)</constraint>
    <constraint type="business">Audit trail - completed_at, completed_by_user_id, actual_yield_percent, actual_duration_minutes stored on wo_operations for analytics</constraint>
    <constraint type="testing">Test pyramid - 95% unit (status transition, yield calculation, duration auto-fill, validation), 70% integration (API endpoint, org isolation, role-based auth), 100% E2E (full workflow: navigate â†’ start operation â†’ complete â†’ verify next operation ready)</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>POST /api/production/work-orders/:id/operations/:opId/complete</name>
      <kind>API route</kind>
      <signature>
        POST /api/production/work-orders/:id/operations/:opId/complete
        Request Body: {
          duration_minutes?: number,    // Optional, auto-calculated if not provided
          yield_percent?: number,        // Optional, default 100%
          notes?: string                 // Optional, max 500 chars
        }
        Response 200: {
          data: {
            id: uuid,
            wo_id: uuid,
            operation_name: string,         // "Mixing"
            sequence_number: number,        // 2
            status: string,                 // "completed"
            started_at: timestamp,          // "2025-11-27T10:30:00Z"
            completed_at: timestamp,        // "2025-11-27T12:45:00Z"
            actual_duration_minutes: number,// 135
            actual_yield_percent: number,   // 92.5
            expected_yield_percent: number, // 95.0
            completed_by_user_id: uuid,
            completed_by_user: {
              id: uuid,
              name: string                  // "Anna K."
            },
            notes: string | null
          },
          message: "Operation completed successfully"
        }
        Error Response 400/403/404: {
          error: string,                // "INVALID_STATUS" | "NOT_FOUND" | "ORG_ISOLATION" | "FORBIDDEN" | "VALIDATION_ERROR"
          message: string,              // User-friendly message
          details?: object              // Validation errors if VALIDATION_ERROR
        }
      </signature>
      <path>apps/frontend/app/api/production/work-orders/[id]/operations/[opId]/complete/route.ts</path>
    </interface>
    <interface>
      <name>completeOperation</name>
      <kind>service method</kind>
      <signature>
        async function completeOperation(
          woId: string,
          opId: string,
          userId: string,
          orgId: string,
          data: { duration_minutes?: number, yield_percent?: number, notes?: string }
        ): Promise&lt;WOOperation&gt;
        - Validates: Operation exists, org_id matches, operation.status = 'in_progress', user has Production/Manager/Admin role
        - Auto-calculates duration if not provided: EXTRACT(EPOCH FROM (NOW() - started_at)) / 60
        - Defaults yield to 100% if not provided
        - Updates wo_operations: status â†’ 'completed', completed_at â†’ NOW(), actual_duration_minutes, actual_yield_percent, completed_by_user_id â†’ userId, notes
        - Returns: Updated operation object with completed_by_user join
        - Throws: Error with code INVALID_STATUS, NOT_FOUND, ORG_ISOLATION, FORBIDDEN, VALIDATION_ERROR
      </signature>
      <path>apps/frontend/lib/services/operation-complete-service.ts</path>
    </interface>
    <interface>
      <name>OperationCompleteModal</name>
      <kind>React component</kind>
      <signature>
        interface OperationCompleteModalProps {
          woId: string
          operationId: string
          onSuccess: () => void
          onClose: () => void
        }
        - Displays: Operation summary (name, sequence, expected yield%, expected duration), Auto-calculated duration (from started_at to NOW()), Yield% input (default 100%, validate 0-200%, warn if &lt;80% or &gt;120%), Notes textarea (optional, max 500 chars)
        - Buttons: Cancel (closes modal), Confirm Complete (calls POST /api/production/work-orders/:id/operations/:opId/complete)
        - States: Loading (spinner, "Completing..."), Success (green checkmark, auto-close 1s), Error (red message, "Try Again"), Warning (yellow alert if yield &lt;80% or &gt;120%)
        - Validation: duration_minutes &gt; 0, yield_percent 0-200 range, notes max 500 chars
      </signature>
      <path>apps/frontend/components/production/OperationCompleteModal.tsx</path>
    </interface>
  </interfaces>

  <tests>
    <standards>Test Pyramid: unit tests (95%), integration tests (70%), E2E tests (100% critical paths)</standards>
    <locations>
      <location>apps/frontend/lib/services/__tests__/operation-complete-service.test.ts</location>
      <location>apps/frontend/app/api/production/work-orders/[id]/operations/[opId]/complete/__tests__/route.test.ts</location>
      <location>tests/e2e/production-operation-complete.spec.ts</location>
    </locations>
    <ideas>
      <idea ac="AC-4.5.2">Unit test: completeOperation() with valid operation - status transitions from 'in_progress' â†’ 'completed', completed_at timestamp set, actual_yield_percent and actual_duration_minutes recorded</idea>
      <idea ac="AC-4.5.5">Unit test: completeOperation() without duration_minutes - auto-calculates from started_at to NOW(), returns calculated value</idea>
      <idea ac="AC-4.5.3">Unit test: completeOperation() with yield_percent - records actual_yield_percent, defaults to 100% if not provided</idea>
      <idea ac="AC-4.5.6">Unit test: completeOperation() with operation not in progress - throws error INVALID_STATUS with message "Operation must be in progress to complete"</idea>
      <idea ac="AC-4.5.6">Unit test: completeOperation() with operation already completed - throws error INVALID_STATUS</idea>
      <idea ac="AC-4.5.4">Integration test: POST /api/production/work-orders/:id/operations/:opId/complete (200) - returns updated operation with completed_at, actual_yield_percent, actual_duration_minutes, completed_by_user</idea>
      <idea ac="AC-4.5.4">Integration test: POST /api/production/work-orders/:id/operations/:opId/complete with operation not in progress - returns 400 with error "Operation must be in progress to complete"</idea>
      <idea ac="AC-4.5.4">Integration test: POST /api/production/work-orders/:id/operations/:opId/complete with invalid yield_percent (250) - returns 400 with validation error "yield_percent must be between 0 and 200"</idea>
      <idea ac="AC-4.5.7">Integration test: POST /api/production/work-orders/:id/operations/:opId/complete with insufficient role permissions - returns 403 with error "You don't have permission to complete operations"</idea>
      <idea ac="AC-4.5.8">Integration test: Complete operation 1 â†’ verify operation 2 becomes available to start (if sequence enforcement enabled)</idea>
      <idea ac="ALL">E2E test: Full workflow - create test WO with 2 operations, start operation 1 (Story 4.4), wait 30s, complete operation 1 with yield 95%, verify completed status, verify operation 2 Start button enabled, verify operation appears in completed operations list</idea>
      <idea ac="AC-4.5.1">E2E test: Complete modal - verify auto-calculated duration shows correct value (from started_at to NOW()), verify yield defaults to 100%, verify can override both values</idea>
      <idea ac="AC-4.5.3">E2E test: Yield validation - enter yield 75%, verify warning shows "Yield below target", enter yield 130%, verify warning "Yield above expected range"</idea>
    </ideas>
  </tests>

  <learnings>
    <learning from="Story 4.4 (Operation Start)">Operation status enum defined: 'not_started', 'in_progress', 'completed'. Story 4.5 transitions from 'in_progress' (Story 4.4) to 'completed'. Sequence enforcement pattern established - N-1 must be completed before starting N. Story 4.5 enables next operation (N+1) after completing N</learning>
    <learning from="Story 4.2 (WO Start)">Status transition pattern: validate current status, update with server-side timestamp, store user_id for audit, return updated object with user join. Story 4.5 follows same pattern for operation completion</learning>
    <learning from="Story 4.1 (Production Dashboard)">Dashboard shows operation progress with yield% and alerts. Story 4.5 completed operations should update dashboard active operations list (remove completed, show next operation if available)</learning>
    <learning from="Shared UI Design System">Modal pattern: consistent with other modals. Loading states: spinner in button, success toast, error/warning toast. Validation: inline error messages, helper text, color-coded warnings (yellow for low/high yield)</learning>
  </learnings>

  <ux-design>
    <section name="Operation Complete Modal Layout">
      <content>
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Complete Operation: Op2 Mixing               [X Close]   â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚ Operation Summary                                        â”‚
        â”‚   Sequence:         2 of 3                               â”‚
        â”‚   Operation:        Mixing                               â”‚
        â”‚   Expected Yield:   95.0%                                â”‚
        â”‚   Expected Duration: 120 minutes                         â”‚
        â”‚   Started At:       10:30 (2 hours 15 minutes ago)       â”‚
        â”‚                                                          â”‚
        â”‚ Actual Duration                                          â”‚
        â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
        â”‚   â”‚ 135                                          min   â”‚ â”‚
        â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
        â”‚   Auto-calculated from start time. You can override.     â”‚
        â”‚                                                          â”‚
        â”‚ Actual Yield %                                           â”‚
        â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
        â”‚   â”‚ 92.5                                          %    â”‚ â”‚
        â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
        â”‚   âš ï¸ Below expected yield (95.0%). Review for issues.   â”‚
        â”‚                                                          â”‚
        â”‚ Notes (optional)                                         â”‚
        â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
        â”‚   â”‚ Mixer blade worn, replaced mid-operation. Yield    â”‚ â”‚
        â”‚   â”‚ recovered after replacement. Recommend preventive  â”‚ â”‚
        â”‚   â”‚ maintenance schedule.                              â”‚ â”‚
        â”‚   â”‚                                                    â”‚ â”‚
        â”‚   â”‚ 150/500 characters                                 â”‚ â”‚
        â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
        â”‚                                                          â”‚
        â”‚ [Cancel]                    [Confirm Complete âœ“]        â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

        States:
        - Loading: "Confirm Complete" â†’ "Completing..." with spinner
        - Success: Green checkmark, "Operation completed successfully" toast, auto-close 1s
        - Error: Red error message, "Try Again" button
        - Warning (yield &lt;80% or &gt;120%): Yellow alert "Yield outside normal range"

        Yield Validation Ranges:
        - &lt;80%: âš ï¸ Yellow warning "Yield below target - review for issues"
        - 80-120%: No warning (normal range)
        - &gt;120%: âš ï¸ Yellow warning "Yield above expected range - verify measurements"
        - &lt;0% or &gt;200%: âŒ Red error "Yield must be between 0 and 200%"
      </content>
    </section>
    <section name="Duration Auto-Calculation Logic">
      <content>
        SQL Function (server-side):
        ```sql
        -- Auto-calculate duration if not provided
        UPDATE wo_operations
        SET
          status = 'completed',
          completed_at = NOW(),
          actual_duration_minutes = COALESCE(
            $1::integer, -- User-provided duration
            EXTRACT(EPOCH FROM (NOW() - started_at)) / 60 -- Auto-calculated
          ),
          actual_yield_percent = COALESCE($2::decimal, 100.0), -- Default 100%
          completed_by_user_id = $3::uuid,
          notes = $4::text
        WHERE id = $5::uuid
          AND status = 'in_progress'
        RETURNING *;
        ```

        Frontend Display:
        - Fetch operation.started_at from API
        - Calculate: differenceInMinutes(new Date(), new Date(started_at))
        - Display in input field with helper text: "Auto-calculated from start time"
        - Allow user to override if needed (e.g., operator took break not logged)
      </content>
    </section>
    <section name="Yield Calculation and Validation">
      <content>
        Yield Calculation (if outputs recorded):
        ```typescript
        // Get expected and actual outputs from wo_operations table
        const expected_output = operation.expected_output // e.g., 1000 kg
        const actual_output = operation.actual_output     // e.g., 925 kg (from Story 4.7-4.9)

        // Calculate yield
        const calculated_yield = (actual_output / expected_output) * 100 // 92.5%

        // Pre-fill form with calculated value (or default 100% if no outputs yet)
        const default_yield = actual_output ? calculated_yield : 100.0
        ```

        Validation Rules:
        - Required: yield_percent must be provided (default 100%)
        - Range: 0 &lt;= yield_percent &lt;= 200
        - Warning (yellow):
          - If yield &lt; 80%: "Yield below target - review for issues"
          - If yield &gt; 120%: "Yield above expected range - verify measurements"
        - Error (red):
          - If yield &lt; 0%: "Yield cannot be negative"
          - If yield &gt; 200%: "Yield cannot exceed 200%"

        Display:
        - Input field: type="number", step="0.1", min="0", max="200"
        - Helper text: "Expected: {expected_yield_percent}%"
        - Warning/error message below input
        - Color-coded border: gray (normal), yellow (warning), red (error)
      </content>
    </section>
    <section name="Next Operation Ready (AC-4.5.8)">
      <content>
        After Completing Operation N:
        1. Check if require_operation_sequence is enabled (from settings or WO config)
        2. Find next operation N+1 in sequence:
           ```sql
           SELECT * FROM wo_operations
           WHERE wo_id = $1
             AND sequence_number = $2 + 1 -- N+1
             AND status = 'not_started'
           ```
        3. If found, enable Start button in UI:
           - Before: "Start" button disabled, tooltip "Complete operation {N} first"
           - After: "Start" button enabled, tooltip "Ready to start"
        4. Update dashboard to reflect new available operation
        5. Optional: Show toast notification "Operation {N+1} is now ready to start"

        UI States:
        - Operation N: status='completed' â†’ gray badge "Completed", timestamp shown
        - Operation N+1: status='not_started' â†’ blue badge "Ready", Start button enabled
        - Operation N+2: status='not_started' â†’ gray badge "Pending", Start button disabled
      </content>
    </section>
    <section name="Color Palette (from Shared System)">
      <content>
        Primary Colors:
        - Create/CTA:     green-600   (#16a34a) - "Confirm Complete" button
        - Secondary:      gray-600    (#4b5563) - "Cancel" button
        - Warning:        yellow-600  (#ca8a04) - Yield warnings
        - Danger:         red-600     (#dc2626) - Error messages

        Status Badges:
        - Completed:      gray-200 bg + gray-800 text - "Completed" status
        - Warning:        yellow-200 bg + yellow-800 text - Low/high yield warnings
        - Error:          red-200 bg + red-800 text - Critical errors

        Typography:
        - Modal title:     Text-xl (20px), Bold (700)
        - Section headers: Text-base (16px), SemiBold (600)
        - Body text:       Text-sm (14px), Regular (400)
        - Labels:          Text-xs (12px), Medium (500)
        - Helper text:     Text-xs (12px), Regular (400), gray-500

        Spacing:
        - Modal padding:   p-6 (24px all sides)
        - Section gap:     gap-4 (16px between sections)
        - Input gap:       gap-2 (8px between label and input)
        - Button gap:      gap-3 (12px between Cancel and Confirm)
      </content>
    </section>
  </ux-design>
</story-context>
