# Story 4.5: Operation Complete

**Epic:** 4 - Production Execution
**Status:** Todo
**Priority:** P0 (MVP)
**Story Points:** 2
**Created:** 2025-11-27
**Updated:** 2025-11-28 (detailed ACs, yield calculation from BOM, next op sequencing)
**Effort Estimate:** 1 day

---

## Goal

Enable operators to complete operations, with automatic yield calculation from BOM and next operation readiness.

## User Story

**As an** Operator
**I want** to complete a WO operation
**So that** the system calculates yield and moves to the next step

---

## Acceptance Criteria

### AC-4.5.1: Operation Complete Modal
**Given** operation is in 'in_progress' status
**When** operator clicks "Complete" on operation
**Then** modal opens showing:
- WO number (read-only)
- Operation name (read-only)
- Operation sequence (read-only, e.g., "Operation 1 of 3")
- **actual_duration_minutes**: Auto-calculated from (NOW() - started_at) / 60, operator can override
- **actual_yield_percent**: CALCULATED from BOM (read-only, shows calculated value)
  - Formula per material: (actual_consumed_qty / required_qty) × 100
  - Shows breakdown: "RM-001 yield: 90%, ING-002 yield: 98.9%"
- Notes field (optional, text area)
- "Cancel" and "Confirm Complete" buttons

**Yield Calculation Example:**
```
BOM says: 1kg RM-001 + 0.1kg ING-002 → 1kg WIP-001
Operation produced: 90kg WIP-001
Consumed: 100kg RM-001 + 8.9kg ING-002

YIELDS:
- RM-001: 90/100 = 90% ✅ (read-only, calculated)
- ING-002: 8.9/9 = 98.9% ✅ (read-only, calculated)
```

**Success Criteria:**
- ✅ Modal shows operation details
- ✅ Duration auto-calculated and editable
- ✅ Yield calculated from BOM (not editable by operator, read-only display)
- ✅ Operator can add notes
- ✅ Clear success/cancel buttons

---

### AC-4.5.2: Operation Complete Transition (Atomic)
**Given** operator confirms complete in modal
**When** confirming
**Then** system performs atomic update:
```
1. VALIDATE:
   - Operation status = 'in_progress'
   - Operation exists and belongs to WO
   - org_id matches

2. UPDATE wo_operations:
   - status → 'completed'
   - completed_at → current_timestamp
   - actual_duration_minutes → (duration provided or auto-calculated)
   - actual_yield_percent → (calculated from BOM consumption)
   - notes → (provided notes)
   - updated_at → current_timestamp

3. EMIT EVENT: "operation.completed" (for dashboard/next op readiness)

4. RETURN: Updated operation object with next operation status (if exists)
```

**Success Criteria:**
- ✅ Status transitions: in_progress → completed
- ✅ completed_at timestamp recorded
- ✅ Duration and yield recorded
- ✅ No partial updates (atomic)
- ✅ Event emitted

---

### AC-4.5.3: Yield Calculation from BOM

**Yield Formula:**
```
For each material in BOM:
  yield_percent = (actual_consumed_qty / required_qty) × 100
```

**Data Source:**
- required_qty: From wo_materials (BOM snapshot created in Story 3.10)
- actual_consumed_qty: From consumption records (Story 4.7/4.12)

**Display:**
```
YIELD BREAKDOWN:
├─ RM-001 (Flour): 90/100 kg = 90%
├─ ING-002 (Yeast): 8.9/9 kg = 98.9%
└─ TOTAL: (90% + 98.9%) / 2 = 94.45% (average)

Or maybe: Only show individual yields, no average?
```

**Success Criteria:**
- ✅ Yield calculated correctly per material
- ✅ Display shows breakdown by material
- ✅ Read-only (operator cannot edit)

---

### AC-4.5.4: Duration Handling

**Duration Calculation:**
```
DEFAULT: (NOW() - operation.started_at) / 60 = minutes
EDITABLE: Operator can override if different (e.g., system downtime not counted)
```

**Example:**
```
Operation started: 10:00
Operation completed (modal opened): 10:45
Default duration: 45 minutes
Operator can change to: 40 minutes (if 5 min was break not counted)
```

**Success Criteria:**
- ✅ Duration auto-calculated and shown
- ✅ Operator can override if needed
- ✅ Value stored on complete

---

### AC-4.5.5: API Endpoint

**POST /api/production/work-orders/:id/operations/:opId/complete**

```typescript
Request: {
  actual_duration_minutes?: number,  // optional (uses auto-calc if not provided)
  notes?: string                     // optional
}

Response (200): {
  data: {
    id: uuid,
    wo_id: uuid,
    operation_sequence: number,
    status: string,                  // "completed"
    completed_at: timestamp,
    actual_duration_minutes: number,
    actual_yield_percent: DECIMAL,
    notes: string,
    next_operation?: {               // if exists
      id: uuid,
      operation_sequence: number,
      operation_name: string,
      status: string                 // "not_started" (ready to start)
    }
  },
  message: "Operation completed successfully"
}

Error (400/403/404): {
  error: string,                     // Error code
  message: string                    // User-friendly message
}
```

**Success Criteria:**
- ✅ POST endpoint at `/api/production/work-orders/:id/operations/:opId/complete`
- ✅ Returns 200 with updated operation + next operation info
- ✅ Returns 400/403/404 with error details
- ✅ Auth & org isolation enforced

---

### AC-4.5.6: Error Handling

| Condition | Error Code | HTTP | Message |
|-----------|-----------|------|---------|
| Not in progress | INVALID_STATUS | 400 | "Operation must be in 'in progress' status to complete" |
| Already completed | ALREADY_COMPLETED | 400 | "Operation is already completed" |
| Operation not found | NOT_FOUND | 404 | "Operation not found" |
| Wrong org_id | ORG_ISOLATION | 403 | (no details) |
| Not authenticated | UNAUTHORIZED | 401 | (standard) |
| Insufficient role | FORBIDDEN | 403 | "Insufficient permissions" |

**Success Criteria:**
- ✅ Specific error codes and messages
- ✅ No partial updates on error

---

### AC-4.5.7: Next Operation Sequencing

**When** operation is completed
**Then** system handles next operation:

```
IF operation.operation_sequence < total_operations:
  next_op = operation where operation_sequence = current + 1
  next_op.status remains 'not_started' (already ready)
  Emit event: "operation.ready_for_start" (for dashboard)
ELSE:
  No next operation (last in sequence)
```

**UI Behavior (in modal response):**
```
Response includes: next_operation {id, name, status: 'not_started'}
Dashboard listens to "operation.ready_for_start" event
UI shows: "Next operation ready: Fermentation"
Operator can click to navigate to next operation
```

**Success Criteria:**
- ✅ Next operation identified and returned
- ✅ Event emitted for dashboard
- ✅ UI can show "Next op ready" indicator

---

### AC-4.5.8: Role-Based Access

| Role | Can Complete | Notes |
|------|--------------|-------|
| Production Manager | ✅ Yes | |
| Operator | ✅ Yes | |
| Planner | ❌ No | |
| Quality Manager | ❌ No | |
| Admin | ✅ Yes | |

**Success Criteria:**
- ✅ Role check on API
- ✅ 403 error if unauthorized
- ✅ Button hidden in UI for non-authorized

---

### AC-4.5.9: Modal Validation States

| State | Trigger | UI | Button |
|-------|---------|----|----|
| Loading | API call | Spinner, disabled | "Completing..." |
| Success | Op completed | Green check, auto-close | N/A |
| Error | API error | Red message | "Try Again" |

**Success Criteria:**
- ✅ Loading, success, error states
- ✅ Success toast: "Operation completed successfully"
- ✅ Auto-close on success

---

## Technical Tasks

### Backend

- [ ] Task 1: Verify wo_operations schema
  - [ ] Subtask 1.1: Verify columns: completed_at, actual_duration_minutes, actual_yield_percent
  - [ ] Subtask 1.2: Verify RLS policy

- [ ] Task 2: Create OperationCompleteService
  - [ ] Subtask 2.1: Implement completeOperation(woId, opId, durationMin, notes, userId, orgId)
  - [ ] Subtask 2.2: Validate operation status = 'in_progress'
  - [ ] Subtask 2.3: Calculate yield from BOM consumption
  - [ ] Subtask 2.4: Calculate/use provided duration
  - [ ] Subtask 2.5: Atomic transaction wrapper
  - [ ] Subtask 2.6: Find & return next operation (if exists)
  - [ ] Subtask 2.7: Error handling (all codes from AC 4.5.6)
  - [ ] Subtask 2.8: Emit "operation.completed" event

- [ ] Task 3: Create yield calculation logic
  - [ ] Subtask 3.1: Query BOM requirements from wo_materials
  - [ ] Subtask 3.2: Query actual consumption from consumption records
  - [ ] Subtask 3.3: Calculate yield percent per material
  - [ ] Subtask 3.4: Return yield details

- [ ] Task 4: Create API endpoint
  - [ ] Subtask 4.1: POST /api/production/work-orders/:id/operations/:opId/complete
  - [ ] Subtask 4.2: Auth & role checks
  - [ ] Subtask 4.3: Error handling
  - [ ] Subtask 4.4: Response format with next operation

### Frontend

- [ ] Task 5: Create OperationCompleteModal component
  - [ ] Subtask 5.1: Display operation details
  - [ ] Subtask 5.2: Show auto-calculated duration (editable)
  - [ ] Subtask 5.3: Show yield breakdown (read-only)
  - [ ] Subtask 5.4: Notes field (optional)
  - [ ] Subtask 5.5: Loading/success/error states
  - [ ] Subtask 5.6: Auto-close on success

- [ ] Task 6: Integrate with WO detail page
  - [ ] Subtask 6.1: "Complete" button on in-progress operations
  - [ ] Subtask 6.2: Show completed operations status
  - [ ] Subtask 6.3: Show next operation indicator (if ready)

### Testing

- [ ] Task 7: Unit tests - OperationCompleteService
  - [ ] Subtask 7.1: Test complete with valid operation
  - [ ] Subtask 7.2: Test status transition: in_progress → completed
  - [ ] Subtask 7.3: Test duration auto-calculation
  - [ ] Subtask 7.4: Test yield calculation (various scenarios)
  - [ ] Subtask 7.5: Test error: not in progress
  - [ ] Subtask 7.6: Test next operation identification
  - [ ] Subtask 7.7: Test org_id isolation
  - [ ] Subtask 7.8: Target 95% coverage

- [ ] Task 8: Integration tests - API endpoint
  - [ ] Subtask 8.1: Test POST /api/production/work-orders/:id/operations/:opId/complete (200)
  - [ ] Subtask 8.2: Test with auto-duration
  - [ ] Subtask 8.3: Test with custom duration
  - [ ] Subtask 8.4: Test yield calculation
  - [ ] Subtask 8.5: Test 400 if not in progress
  - [ ] Subtask 8.6: Test 403 if wrong org
  - [ ] Subtask 8.7: Test 401 if not auth
  - [ ] Subtask 8.8: Target 70% coverage

- [ ] Task 9: E2E tests - Operation completion workflow
  - [ ] Subtask 9.1: Create WO with operations
  - [ ] Subtask 9.2: Start Operation 1
  - [ ] Subtask 9.3: Complete Operation 1
  - [ ] Subtask 9.4: Verify modal shows yield breakdown
  - [ ] Subtask 9.5: Verify operation status = completed
  - [ ] Subtask 9.6: Verify next operation ready
  - [ ] Subtask 9.7: Start Operation 2
  - [ ] Subtask 9.8: Complete Operation 2
  - [ ] Subtask 9.9: Verify all history displayed
  - [ ] Subtask 9.10: Target 100% critical

---

## Dev Notes

- **Yield Calculated from BOM**: Not operator-editable, auto-calculated from consumption
- **Duration Override**: Allowed for system downtime/breaks not counted
- **Next Operation**: Auto-identified and returned in response
- **Event-Driven**: Emit events for dashboard real-time updates

---

## Status

- **Created:** 2025-11-27
- **Updated:** 2025-11-28 (expanded with BOM-based yield, duration, next op sequencing)
- **Current Status:** Todo
- **Target Status:** Done
