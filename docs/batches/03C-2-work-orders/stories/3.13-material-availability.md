# Story 3.13: Material Availability Check

**ID:** 3.13
**Batch:** 03C-2
**Story Points:** 5
**Effort:** 4-6 hours
**Status:** Todo

## User Story

> As a **Planner**,
> I want to see material availability when creating WO,
> So that I know if production can proceed.

## Acceptance Criteria

### AC 1: Availability Calculation

**Given** material check enabled in Settings
**When** WO is being created
**Then** system calculates required materials from BOM
**And** checks available LP qty per material

### AC 2: Visual Indicators

**And** shows indicators:
- ğŸŸ¢ Green: `available >= required Ã— 1.2` (120% coverage)
- ğŸŸ¡ Yellow: `available >= required` but `< required Ã— 1.2`
- ğŸ”´ Red: `available < required`

### AC 3: Non-Blocking Warning

**When** user sees warnings (yellow/red)
**Then** can still proceed with WO creation
**And** confirmation modal: "Some materials are low/unavailable. Proceed anyway?"

### AC 4: Availability Summary

**Then** shows summary card:
- Total materials: X
- Available (green): Y
- Low (yellow): Z
- Missing (red): W

## Technical Tasks

### Backend
- [ ] API: `GET /api/planning/work-orders/availability-check`
- [ ] Query available LPs: `SUM(qty) WHERE product_id = X AND status = 'available'`
- [ ] Return per-material: `{ product_id, required_qty, available_qty, status }`
- [ ] Toggle check in `planning_settings.wo_material_check`

### Frontend
- [ ] Add availability panel to WO create modal
- [ ] Color-coded indicators per material
- [ ] Summary card with totals
- [ ] Confirmation dialog for low availability
- [ ] Settings toggle in Planning Settings

### Database
- [ ] Add `wo_material_check` boolean to `planning_settings`

## Testing

### Unit Tests
- [ ] Availability calculation correct
- [ ] Threshold calculations (120%, 100%)
- [ ] Status assignment logic

### Integration Tests
- [ ] API returns correct availability
- [ ] Handles zero stock
- [ ] Settings toggle works

### E2E Tests
- [ ] Create WO with green availability
- [ ] Create WO with yellow warning â†’ confirm
- [ ] Create WO with red warning â†’ confirm

## Dependencies

- **Requires:** Story 3.12 (WO Materials Snapshot), Epic 5 (LP tables)
- **Blocks:** None (optional enhancement)

## Notes

- This is a **planning aid**, not a blocking constraint
- Actual material reservation happens in Epic 4
- Consider caching availability (short TTL - 1 min)
