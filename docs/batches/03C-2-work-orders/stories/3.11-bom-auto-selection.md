# Story 3.11: BOM Auto-Selection for WO

**ID:** 3.11
**Batch:** 03C-2
**Story Points:** 5
**Effort:** 4-6 hours
**Status:** Todo

## User Story

> As a **Planner**,
> I want the system to auto-select the correct BOM,
> So that the right recipe is used.

## Acceptance Criteria

### AC 1: Auto-Selection Based on Date

**Given** user selects product and scheduled_date
**When** system searches for BOM
**Then** finds BOM where: `effective_from <= date <= effective_to`
**And** selects most recent if multiple match

### AC 2: BOM Required (No BOM Found)

**Given** no active BOM found for the date
**Then** shows error: "No active BOM for this date"
**And** blocks WO creation - BOM is REQUIRED
**And** user must select valid date range or create BOM first

### AC 3: Manual Override

**When** user wants different BOM
**Then** can override with dropdown showing all valid BOMs
**And** dropdown shows: BOM version, effective dates, status

## Technical Tasks

### Backend
- [ ] Create BOM lookup service: `getBOMForProduct(productId, date)`
- [ ] Query: `SELECT * FROM boms WHERE product_id = ? AND status = 'active' AND effective_from <= ? AND (effective_to IS NULL OR effective_to >= ?)`
- [ ] Return most recent BOM if multiple match (ORDER BY effective_from DESC LIMIT 1)
- [ ] API endpoint: `GET /api/planning/products/:id/active-bom?date=YYYY-MM-DD`

### Frontend
- [ ] Add BOM selection to WO create modal
- [ ] Auto-trigger BOM lookup on product + date change
- [ ] Show BOM details: version, effective dates
- [ ] Add dropdown for manual override
- [ ] Show error state when no BOM found

### Database
- [ ] Index: `idx_boms_product_effective` on (product_id, status, effective_from)

## Testing

### Unit Tests
- [ ] BOM lookup returns correct BOM for date
- [ ] Returns null when no matching BOM
- [ ] Handles multiple BOMs (picks most recent)
- [ ] Handles null effective_to (open-ended BOM)

### Integration Tests
- [ ] API returns active BOM for product
- [ ] API returns 404 when no BOM found
- [ ] BOM dropdown populated correctly

### E2E Tests
- [ ] Create WO with auto-selected BOM
- [ ] Create WO with manual BOM override
- [ ] Error shown when no BOM available

## Dependencies

- **Requires:** Story 3.10 (WO CRUD), Story 2.6 (BOM CRUD)
- **Blocks:** Story 3.12 (WO Materials Snapshot)

## Notes

- **BOM is REQUIRED** - Work Order cannot be created without valid BOM
- BOM selection critical for material snapshot (Story 3.12)
- Consider caching BOM lookup results (5 min TTL)
- Migration: work_orders.bom_id is NOT NULL after materials snapshot implementation
