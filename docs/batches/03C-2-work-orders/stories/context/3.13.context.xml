<?xml version="1.0" encoding="UTF-8"?>
<story>
  <metadata>
    <id>3.13</id>
    <title>Material Availability Check</title>
    <batch>03C-2</batch>
    <points>5</points>
    <effort_hours>4-6</effort_hours>
    <status>todo</status>
  </metadata>

  <description>
    Display material availability indicators when creating WO.
    Shows green/yellow/red status per material based on available LP quantities.
    Non-blocking - user can proceed with warnings.
  </description>

  <dependencies>
    <blocks/>
    <requires>
      <story id="3.12">WO Materials Snapshot</story>
      <epic id="5">LP Tables (license_plates)</epic>
    </requires>
  </dependencies>

  <technical_context>
    <tables>
      <table>
        <name>planning_settings</name>
        <columns>
          <column name="wo_material_check" type="BOOLEAN" default="true"/>
        </columns>
      </table>
    </tables>

    <api_endpoints>
      <endpoint method="POST" path="/api/planning/work-orders/availability-check">
        <request>
          <field name="product_id" type="string"/>
          <field name="quantity" type="number"/>
          <field name="bom_id" type="string"/>
        </request>
        <response type="array">
          <field name="product_id" type="string"/>
          <field name="product_name" type="string"/>
          <field name="required_qty" type="number"/>
          <field name="available_qty" type="number"/>
          <field name="status" type="enum" values="green,yellow,red"/>
        </response>
      </endpoint>
    </api_endpoints>

    <services>
      <service name="AvailabilityService">
        <method name="checkMaterialAvailability">
          <param name="materials" type="MaterialRequirement[]"/>
          <returns>AvailabilityResult[]</returns>
        </method>
        <method name="getAvailableLPQuantity">
          <param name="productId" type="string"/>
          <param name="orgId" type="string"/>
          <returns>number</returns>
          <query>SUM(qty) FROM license_plates WHERE product_id = ? AND status = 'available'</query>
        </method>
      </service>
    </services>

    <components_to_create>
      <component name="AvailabilityPanel" path="components/planning/AvailabilityPanel.tsx">
        <props>
          <prop name="materials" type="AvailabilityResult[]"/>
          <prop name="onProceed" type="() => void"/>
        </props>
      </component>
      <component name="AvailabilitySummary" path="components/planning/AvailabilitySummary.tsx">
        <props>
          <prop name="green" type="number"/>
          <prop name="yellow" type="number"/>
          <prop name="red" type="number"/>
        </props>
      </component>
    </components_to_create>
  </technical_context>

  <acceptance_criteria>
    <criterion id="AC-1">
      <description>Availability Calculation</description>
      <given>material check enabled in Settings</given>
      <when>WO is being created</when>
      <then>system calculates required materials and checks available LP qty</then>
    </criterion>
    <criterion id="AC-2">
      <description>Visual Indicators</description>
      <rules>
        <rule status="green">available &gt;= required × 1.2</rule>
        <rule status="yellow">available &gt;= required AND available &lt; required × 1.2</rule>
        <rule status="red">available &lt; required</rule>
      </rules>
    </criterion>
    <criterion id="AC-3">
      <description>Non-Blocking Warning</description>
      <when>user sees warnings (yellow/red)</when>
      <then>can still proceed with confirmation dialog</then>
    </criterion>
    <criterion id="AC-4">
      <description>Availability Summary</description>
      <then>shows summary card with totals per status</then>
    </criterion>
  </acceptance_criteria>

  <test_plan>
    <unit_tests>
      <test>Availability calculation correct</test>
      <test>Threshold calculations (120%, 100%)</test>
      <test>Status assignment logic</test>
    </unit_tests>
    <integration_tests>
      <test>API returns correct availability</test>
      <test>Handles zero stock</test>
      <test>Settings toggle works</test>
    </integration_tests>
    <e2e_tests>
      <test>Create WO with green availability</test>
      <test>Create WO with yellow warning → confirm</test>
      <test>Create WO with red warning → confirm</test>
    </e2e_tests>
  </test_plan>

  <implementation_notes>
    <note priority="medium">This is a planning aid, not a blocking constraint</note>
    <note priority="medium">Actual material reservation happens in Epic 4</note>
    <note priority="low">Consider caching availability with 1 min TTL</note>
  </implementation_notes>
</story>
