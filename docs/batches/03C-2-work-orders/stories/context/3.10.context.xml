<?xml version="1.0" encoding="UTF-8"?>
<story_context version="1.0">
  <metadata>
    <story_id>3.10</story_id>
    <title>Work Order CRUD</title>
    <batch>03C-2-work-orders</batch>
    <priority>P0</priority>
    <story_points>5</story_points>
  </metadata>

  <dependencies>
    <database_tables>
      <table name="work_orders" status="to_create"/>
      <table name="products" status="exists"/>
      <table name="production_lines" status="exists"/>
      <table name="organizations" status="exists"/>
    </database_tables>
    <existing_components>
      <component path="apps/frontend/components/ui/*"/>
      <component path="apps/frontend/lib/supabase/client.ts"/>
    </existing_components>
  </dependencies>

  <technical_context>
    <database_schema>
      <table name="work_orders">
        <columns>
          id UUID PK DEFAULT gen_random_uuid(),
          organization_id UUID FK NOT NULL,
          wo_number VARCHAR(20) UNIQUE NOT NULL,
          product_id UUID FK NOT NULL,
          production_line_id UUID FK,
          planned_qty DECIMAL(10,3) NOT NULL,
          produced_qty DECIMAL(10,3) DEFAULT 0,
          status VARCHAR(20) DEFAULT 'draft',
          priority INTEGER DEFAULT 0,
          planned_start TIMESTAMPTZ,
          planned_end TIMESTAMPTZ,
          actual_start TIMESTAMPTZ,
          actual_end TIMESTAMPTZ,
          notes TEXT,
          created_at TIMESTAMPTZ DEFAULT NOW(),
          updated_at TIMESTAMPTZ DEFAULT NOW(),
          created_by UUID FK
        </columns>
        <rls_policies>Standard authenticated CRUD</rls_policies>
        <indexes>
          CREATE INDEX idx_wo_org ON work_orders(organization_id);
          CREATE INDEX idx_wo_status ON work_orders(status);
          CREATE INDEX idx_wo_line ON work_orders(production_line_id);
        </indexes>
      </table>
    </database_schema>

    <api_endpoints>
      <endpoint method="GET" path="/api/planning/work-orders"/>
      <endpoint method="POST" path="/api/planning/work-orders"/>
      <endpoint method="GET" path="/api/planning/work-orders/[id]"/>
      <endpoint method="PUT" path="/api/planning/work-orders/[id]"/>
      <endpoint method="DELETE" path="/api/planning/work-orders/[id]"/>
    </api_endpoints>

    <wo_statuses>draft, released, in_progress, completed, cancelled</wo_statuses>
  </technical_context>

  <test_plan>
    <unit_tests>
      <test>WO CRUD operations</test>
      <test>WO number auto-generation</test>
      <test>Status transitions validation</test>
      <test>Quantity validation</test>
    </unit_tests>
    <e2e_tests>
      <test>Create work order flow</test>
      <test>Release work order</test>
      <test>Update progress</test>
      <test>Complete work order</test>
    </e2e_tests>
  </test_plan>
</story_context>
