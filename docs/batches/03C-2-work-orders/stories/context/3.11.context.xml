<?xml version="1.0" encoding="UTF-8"?>
<story>
  <metadata>
    <id>3.11</id>
    <title>BOM Auto-Selection for WO</title>
    <batch>03C-2</batch>
    <points>5</points>
    <effort_hours>4-6</effort_hours>
    <status>todo</status>
  </metadata>

  <description>
    Automatically select the correct BOM based on product and scheduled date when creating a Work Order.
    Finds BOM where effective_from <= date <= effective_to, selects most recent if multiple match.
    Allows manual override if needed.
  </description>

  <dependencies>
    <blocks>
      <story id="3.12">WO Materials Snapshot</story>
    </blocks>
    <requires>
      <story id="3.10">Work Order CRUD</story>
      <story id="2.6">BOM CRUD</story>
    </requires>
  </dependencies>

  <technical_context>
    <tables>
      <table>
        <name>boms</name>
        <columns>
          <column name="id" type="UUID" pk="true"/>
          <column name="product_id" type="UUID" fk="products.id"/>
          <column name="version" type="VARCHAR(20)"/>
          <column name="status" type="VARCHAR(50)"/>
          <column name="effective_from" type="DATE"/>
          <column name="effective_to" type="DATE" nullable="true"/>
          <column name="output_qty" type="NUMERIC(15,3)"/>
        </columns>
        <indexes>
          <index name="idx_boms_product_effective" columns="product_id, status, effective_from"/>
        </indexes>
      </table>
    </tables>

    <api_endpoints>
      <endpoint method="GET" path="/api/planning/products/:id/active-bom">
        <query_params>
          <param name="date" type="string" format="YYYY-MM-DD" required="true"/>
        </query_params>
        <response>
          <field name="id" type="string"/>
          <field name="version" type="string"/>
          <field name="effective_from" type="date"/>
          <field name="effective_to" type="date" nullable="true"/>
          <field name="output_qty" type="number"/>
          <field name="items" type="array"/>
        </response>
      </endpoint>
    </api_endpoints>

    <services>
      <service name="BOMSelectionService">
        <method name="getBOMForProduct">
          <param name="productId" type="string"/>
          <param name="date" type="Date"/>
          <returns>BOM | null</returns>
        </method>
        <method name="getAvailableBOMs">
          <param name="productId" type="string"/>
          <returns>BOM[]</returns>
        </method>
      </service>
    </services>

    <components_to_create>
      <component name="BOMSelector" path="components/planning/BOMSelector.tsx">
        <props>
          <prop name="productId" type="string"/>
          <prop name="scheduledDate" type="Date"/>
          <prop name="onBOMSelected" type="(bom: BOM) => void"/>
        </props>
      </component>
    </components_to_create>
  </technical_context>

  <acceptance_criteria>
    <criterion id="AC-1">
      <description>Auto-Selection Based on Date</description>
      <given>user selects product and scheduled_date</given>
      <when>system searches for BOM</when>
      <then>finds BOM where effective_from &lt;= date &lt;= effective_to</then>
    </criterion>
    <criterion id="AC-2">
      <description>No BOM Found Error</description>
      <given>no active BOM found for the date</given>
      <then>shows error: "No active BOM for this date"</then>
    </criterion>
    <criterion id="AC-3">
      <description>Manual Override</description>
      <when>user wants different BOM</when>
      <then>can override with dropdown showing all valid BOMs</then>
    </criterion>
  </acceptance_criteria>

  <test_plan>
    <unit_tests>
      <test>BOM lookup returns correct BOM for date</test>
      <test>Returns null when no matching BOM</test>
      <test>Handles multiple BOMs (picks most recent)</test>
      <test>Handles null effective_to (open-ended BOM)</test>
    </unit_tests>
    <integration_tests>
      <test>API returns active BOM for product</test>
      <test>API returns 404 when no BOM found</test>
      <test>BOM dropdown populated correctly</test>
    </integration_tests>
    <e2e_tests>
      <test>Create WO with auto-selected BOM</test>
      <test>Create WO with manual BOM override</test>
      <test>Error shown when no BOM available</test>
    </e2e_tests>
  </test_plan>

  <implementation_notes>
    <note priority="high">BOM selection is prerequisite for Story 3.12 (materials snapshot)</note>
    <note priority="medium">Consider caching BOM lookup results with 5 min TTL</note>
    <note priority="medium">Query must handle NULL effective_to as open-ended</note>
  </implementation_notes>
</story>
