<?xml version="1.0" encoding="UTF-8"?>
<story>
  <metadata>
    <id>3.14</id>
    <title>Routing Copy to WO</title>
    <batch>03C-2</batch>
    <points>5</points>
    <effort_hours>4-6</effort_hours>
    <status>todo</status>
  </metadata>

  <description>
    Copy routing operations to wo_operations when creating WO.
    Operations include sequence, name, machine, duration, and yield.
    Optional feature controlled by Settings toggle.
  </description>

  <dependencies>
    <blocks>
      <epic id="4">Production - Operation Execution</epic>
    </blocks>
    <requires>
      <story id="3.10">Work Order CRUD</story>
      <story id="2.15">Routings</story>
    </requires>
  </dependencies>

  <technical_context>
    <tables>
      <table>
        <name>wo_operations</name>
        <columns>
          <column name="id" type="UUID" pk="true"/>
          <column name="org_id" type="UUID" fk="organizations.id"/>
          <column name="wo_id" type="UUID" fk="work_orders.id" on_delete="CASCADE"/>
          <column name="routing_operation_id" type="UUID" fk="routing_operations.id" nullable="true"/>
          <column name="sequence" type="INTEGER"/>
          <column name="operation_name" type="VARCHAR(100)"/>
          <column name="machine_id" type="UUID" fk="machines.id" nullable="true"/>
          <column name="line_id" type="UUID" fk="production_lines.id" nullable="true"/>
          <column name="expected_duration_minutes" type="INTEGER" nullable="true"/>
          <column name="expected_yield_percent" type="NUMERIC(5,2)" default="100"/>
          <column name="status" type="VARCHAR(50)" default="not_started"/>
          <column name="actual_start_time" type="TIMESTAMPTZ" nullable="true"/>
          <column name="actual_end_time" type="TIMESTAMPTZ" nullable="true"/>
          <column name="actual_duration_minutes" type="INTEGER" nullable="true"/>
          <column name="operator_id" type="UUID" fk="users.id" nullable="true"/>
          <column name="notes" type="TEXT" nullable="true"/>
          <column name="created_at" type="TIMESTAMPTZ"/>
          <column name="updated_at" type="TIMESTAMPTZ"/>
        </columns>
        <indexes>
          <index name="idx_wo_operations_wo_id" columns="wo_id"/>
          <index name="idx_wo_operations_sequence" columns="wo_id, sequence" unique="true"/>
        </indexes>
        <rls_policies>
          <policy name="Enable read for authenticated" operation="SELECT"/>
          <policy name="Enable insert for authenticated" operation="INSERT"/>
          <policy name="Enable update for authenticated" operation="UPDATE"/>
        </rls_policies>
      </table>
      <table>
        <name>planning_settings</name>
        <columns>
          <column name="wo_copy_routing" type="BOOLEAN" default="true"/>
        </columns>
      </table>
    </tables>

    <api_endpoints>
      <endpoint method="GET" path="/api/planning/work-orders/:id/operations">
        <response type="array">
          <field name="id" type="string"/>
          <field name="sequence" type="number"/>
          <field name="operation_name" type="string"/>
          <field name="machine_name" type="string" nullable="true"/>
          <field name="expected_duration_minutes" type="number"/>
          <field name="status" type="string"/>
        </response>
      </endpoint>
    </api_endpoints>

    <services>
      <service name="WOOperationsService">
        <method name="copyRoutingToWO">
          <param name="woId" type="string"/>
          <param name="routingId" type="string"/>
          <returns>WOOperation[]</returns>
        </method>
      </service>
    </services>

    <components_to_create>
      <component name="WOOperationsList" path="components/planning/WOOperationsList.tsx">
        <props>
          <prop name="woId" type="string"/>
          <prop name="operations" type="WOOperation[]"/>
          <prop name="onMachineOverride" type="(opId: string, machineId: string) => void"/>
        </props>
      </component>
    </components_to_create>
  </technical_context>

  <acceptance_criteria>
    <criterion id="AC-1">
      <description>Routing Copy on WO Creation</description>
      <given>product has routing assigned AND copy_routing enabled</given>
      <when>WO is created</when>
      <then>routing operations copied to wo_operations</then>
    </criterion>
    <criterion id="AC-2">
      <description>Initial Status</description>
      <then>all operations start with status = 'not_started'</then>
    </criterion>
    <criterion id="AC-3">
      <description>Operations Display</description>
      <when>viewing WO detail</when>
      <then>operations shown in sequence order</then>
    </criterion>
    <criterion id="AC-4">
      <description>Override Capability</description>
      <when>creating WO</when>
      <then>can override machine/line per operation</then>
    </criterion>
  </acceptance_criteria>

  <test_plan>
    <unit_tests>
      <test>Operations copied in correct sequence</test>
      <test>All fields copied correctly</test>
      <test>Status initialized to 'not_started'</test>
    </unit_tests>
    <integration_tests>
      <test>API creates wo_operations with WO</test>
      <test>Settings toggle enables/disables copy</test>
      <test>Machine override persisted</test>
    </integration_tests>
    <e2e_tests>
      <test>Create WO → operations copied from routing</test>
      <test>View WO → operations displayed in order</test>
      <test>Override machine → saved correctly</test>
    </e2e_tests>
  </test_plan>

  <implementation_notes>
    <note priority="high">Operations form basis for Epic 4 production tracking</note>
    <note priority="medium">Routing copy is optional (toggle in settings)</note>
    <note priority="medium">Can override machine/line per operation for flexibility</note>
  </implementation_notes>
</story>
