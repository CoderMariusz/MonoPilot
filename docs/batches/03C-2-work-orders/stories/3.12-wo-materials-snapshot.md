# Story 3.12: WO Materials Snapshot

**ID:** 3.12
**Batch:** 03C-2
**Story Points:** 8
**Effort:** 6-8 hours
**Status:** Todo

## User Story

> As a **Planner**,
> I want WO to capture BOM at creation time,
> So that recipe is immutable during production.

## Acceptance Criteria

### AC 1: BOM Items Copied on WO CREATE (Atomic)

**Given** user creates new Work Order
**When** WO is saved with selected BOM
**Then** in SAME TRANSACTION:
  1. WO record is created
  2. All BOM items copied to `wo_materials`:
- product_id, quantity (scaled to WO qty), uom
- scrap_percent, consume_whole_lp
- is_by_product, yield_percent
- condition_flags

### AC 2: Quantity Scaling

**Given** BOM has output_qty of 10
**And** WO quantity is 50
**When** copying materials
**Then** each material qty = `bom_item.qty × (wo.qty / bom.output_qty)`

### AC 3: Immutability After Release

**And** `wo_materials` cannot change after WO status = 'Released'
**And** attempting to edit shows error: "Cannot modify materials: WO is Released"

### AC 4: BOM Update Warning

**Given** WO created with BOM v1
**When** BOM is updated to v2 after WO creation
**Then** WO shows warning: "⚠️ BOM updated after WO creation. WO using snapshot v1."

## Technical Tasks

### Backend
- [ ] Create `wo_materials` table (see schema below)
- [ ] Service: `copyBOMToWOMaterials(woId, bomId, woQty)`
- [ ] Calculate scaled quantities per material
- [ ] Track `bom_version` in wo_materials for audit
- [ ] Validate: Cannot update wo_materials if WO status = 'Released'

### Frontend
- [ ] Display materials list on WO detail page
- [ ] Show scaled quantities with BOM reference
- [ ] Add warning indicator when BOM updated
- [ ] Lock edit controls when WO released

### Database

```sql
CREATE TABLE wo_materials (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  org_id UUID NOT NULL REFERENCES organizations(id),
  wo_id UUID NOT NULL REFERENCES work_orders(id) ON DELETE CASCADE,
  product_id UUID NOT NULL REFERENCES products(id),
  bom_item_id UUID REFERENCES bom_items(id), -- snapshot reference
  quantity NUMERIC(15,3) NOT NULL,
  uom VARCHAR(20) NOT NULL,
  scrap_percent NUMERIC(5,2) DEFAULT 0,
  consume_whole_lp BOOLEAN DEFAULT false,
  is_by_product BOOLEAN DEFAULT false,
  yield_percent NUMERIC(5,2) DEFAULT 100,
  condition_flags JSONB,
  consumed_qty NUMERIC(15,3) DEFAULT 0, -- updated during production
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_wo_materials_wo_id ON wo_materials(wo_id);
CREATE INDEX idx_wo_materials_product ON wo_materials(product_id);
```

## Testing

### Unit Tests
- [ ] Quantity scaling calculation correct
- [ ] All BOM item fields copied
- [ ] Scrap percent applied correctly

### Integration Tests
- [ ] wo_materials created with WO
- [ ] Cannot update materials after release
- [ ] BOM change detection works

### E2E Tests
- [ ] Create WO → verify materials copied
- [ ] Release WO → verify materials locked
- [ ] Update BOM → verify warning shown

## Dependencies

- **Requires:** Story 3.10 (WO CRUD), Story 3.11 (BOM Auto-Selection)
- **Blocks:** Story 3.13 (Material Availability Check)

## Notes

- **Materials copied on CREATE** - NOT on BOM select, but when WO is saved
- **Atomic transaction**: WO INSERT + wo_materials INSERT in single DB transaction
- Critical for FDA traceability (Gap 3 resolution)
- NO FK CASCADE UPDATE from bom_items to wo_materials
- If WO creation fails, no orphan materials remain
