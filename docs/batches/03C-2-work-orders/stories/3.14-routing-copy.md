# Story 3.14: Routing Copy to WO

**ID:** 3.14
**Batch:** 03C-2
**Story Points:** 5
**Effort:** 4-6 hours
**Status:** Todo

## User Story

> As a **Planner**,
> I want WO to include routing operations,
> So that operators know what steps to perform.

## Acceptance Criteria

### AC 1: Routing Copy on WO Creation

**Given** product has routing assigned
**When** WO is created and `copy_routing` enabled in Settings
**Then** routing operations copied to `wo_operations`:
- sequence, operation_name
- machine_id, line_id
- expected_duration_minutes
- expected_yield_percent

### AC 2: Initial Status

**And** all operations start with `status = 'not_started'`

### AC 3: Operations Display

**When** viewing WO detail
**Then** operations shown in sequence order
**And** shows: #, Name, Machine, Duration, Status

### AC 4: Override Capability

**When** creating WO
**Then** can override machine/line per operation
**And** can add/remove operations manually

## Technical Tasks

### Backend
- [ ] Create `wo_operations` table (see schema below)
- [ ] Service: `copyRoutingToWO(woId, routingId)`
- [ ] Copy all routing operations with sequence
- [ ] Toggle in `planning_settings.wo_copy_routing`

### Frontend
- [ ] Display operations list on WO detail
- [ ] Show sequence, name, machine, duration, status
- [ ] Add override controls for machine/line
- [ ] Settings toggle in Planning Settings

### Database

```sql
CREATE TABLE wo_operations (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  org_id UUID NOT NULL REFERENCES organizations(id),
  wo_id UUID NOT NULL REFERENCES work_orders(id) ON DELETE CASCADE,
  routing_operation_id UUID REFERENCES routing_operations(id),
  sequence INTEGER NOT NULL,
  operation_name VARCHAR(100) NOT NULL,
  machine_id UUID REFERENCES machines(id),
  line_id UUID REFERENCES production_lines(id),
  expected_duration_minutes INTEGER,
  expected_yield_percent NUMERIC(5,2) DEFAULT 100,
  status VARCHAR(50) DEFAULT 'not_started',
  actual_start_time TIMESTAMPTZ,
  actual_end_time TIMESTAMPTZ,
  actual_duration_minutes INTEGER,
  operator_id UUID REFERENCES users(id),
  notes TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_wo_operations_wo_id ON wo_operations(wo_id);
CREATE UNIQUE INDEX idx_wo_operations_sequence ON wo_operations(wo_id, sequence);
```

## Testing

### Unit Tests
- [ ] Operations copied in correct sequence
- [ ] All fields copied correctly
- [ ] Status initialized to 'not_started'

### Integration Tests
- [ ] API creates wo_operations with WO
- [ ] Settings toggle enables/disables copy
- [ ] Machine override persisted

### E2E Tests
- [ ] Create WO → operations copied from routing
- [ ] View WO → operations displayed in order
- [ ] Override machine → saved correctly

## Dependencies

- **Requires:** Story 3.10 (WO CRUD), Story 2.15 (Routings)
- **Blocks:** Epic 4 (Production - operation execution)

## Notes

- Routing copy optional (toggle in settings)
- Operations form basis for Epic 4 production tracking
- Can override machine/line per operation for flexibility
- **WO has line_id** (FK to production_lines) - used for Gantt grouping (Story 3.21)
- Machine is per-operation level, Line is per-WO level
