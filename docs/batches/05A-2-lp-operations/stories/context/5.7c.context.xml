<?xml version="1.0" encoding="UTF-8"?>
<story>
  <id>5.7c</id>
  <name>Advanced Genealogy & FDA Compliance</name>
  <batch>5A-2 (LP Operations) - SPLIT from 5.7</batch>
  <part>3 of 3</part>
  <updated>2025-11-28</updated>
  <status>Todo</status>

  <context>
    <description>
      Part 3 of genealogy implementation. Adds orphan detection, FDA compliance
      guarantees, trace verification, and recall simulation (forward+backward combined).
    </description>

    <scope>
      - Orphan detection (deleted parent warning)
      - Post-insert trace verification (all descendants and ancestors reachable)
      - FDA compliance validation (immutable genealogy, complete traceability)
      - Recall simulation (forward trace for impact, backward for root cause)
    </scope>

    <what-is-already-done>
      - Basic genealogy recording (5.7a)
      - Validation and atomicity (5.7b)
    </what-is-already-done>

    <critical-requirements>
      FDA COMPLIANCE:
      ✅ Every consumed LP → linked to output LP via genealogy
      ✅ Every output LP → linked to all input LPs (backward complete)
      ✅ LP split → all children linked to parent
      ✅ LP merge → all parents linked to merged child
      ✅ Genealogy immutable (no DELETE/UPDATE)
      ✅ No circular dependencies
      ✅ No cross-org genealogy
      ❌ FORBIDDEN: Output LP without input genealogy
      ❌ FORBIDDEN: Genealogy without valid parent AND child
      ❌ FORBIDDEN: Broken traces

      ORPHAN DETECTION:
      If parent LP deleted (deleted_at IS NOT NULL):
      Show warning: "⚠️ Parent LP-001 (deleted on 2025-01-27)"
      Still fully traceable (genealogy intact)

      RECALL SIMULATION:
      Forward trace: Find all descendants (downstream products affected)
      Backward trace: Find all ancestors (root cause materials)
      Combined: Report "15 final products affected by contaminated flour"
    </critical-requirements>

    <related-stories>
      <requires>5.7a (Genealogy Recording), 5.7b (Genealogy Validation)</requires>
      <enables>5.28 (Traceability Dashboard)</enables>
    </related-stories>

    <effort-estimate>
      <hours>3-4</hours>
      <points>2</points>
    </effort-estimate>

    <implementation-notes>
      - Orphan detection: Query genealogy where parent_lp_id has deleted_at IS NOT NULL
      - Show warning in LP detail: "Parent deleted on [date], but genealogy preserved"
      - Trace verification post-insert: Run forward + backward trace, verify all reachable
      - FDA compliance checks: Validate every path in genealogy is complete
      - Recall simulation: Use combined forward+backward trace
      - Impact analysis: Count affected final products
      - Root cause analysis: Find all upstream ingredients
    </implementation-notes>
  </context>
</story>
