<?xml version="1.0" encoding="UTF-8"?>
<story>
  <id>5.7a</id>
  <name>Genealogy Basic Recording</name>
  <batch>5A-2 (LP Operations) - SPLIT from 5.7</batch>
  <part>1 of 3</part>
  <updated>2025-11-28</updated>
  <status>Todo</status>

  <context>
    <description>
      Part 1 of genealogy implementation. Records parent-child relationships
      during split/merge/consume operations. Implements forward and backward
      tracing using recursive CTEs.
    </description>

    <scope>
      - Record genealogy during split/merge operations
      - Implement forward trace (descendants) recursive CTE
      - Implement backward trace (ancestors) recursive CTE
      - Display operation types (split, merge, consume, produce)
      - Basic genealogy tree UI
    </scope>

    <what-is-not-included>
      - Circular dependency detection (see 5.7b)
      - Transaction atomicity (see 5.7b)
      - Orphan detection (see 5.7c)
      - FDA compliance checks (see 5.7c)
      - Recall simulation (see 5.7c)
    </what-is-not-included>

    <critical-requirements>
      Genealogy records created after split/merge operations complete.
      Format: parent_lp_id, child_lp_id, operation_type, created_by, org_id
      Forward trace: Find all descendants (children of children, etc.)
      Backward trace: Find all ancestors (parents of parents, etc.)
      Recursive CTE max depth = 10 levels
    </critical-requirements>

    <related-stories>
      <requires>5.1 (LP Creation), 5.5 (Split), 5.6 (Merge)</requires>
      <followed-by>5.7b (Genealogy Validation), 5.7c (Advanced Genealogy)</followed-by>
    </related-stories>

    <effort-estimate>
      <hours>4-5</hours>
      <points>3</points>
    </effort-estimate>

    <implementation-notes>
      - Genealogy table: lp_genealogy (parent_lp_id, child_lp_id, operation_type, created_by_user_id, org_id)
      - Recursive CTE for forward trace (descendants)
      - Recursive CTE for backward trace (ancestors)
      - GenealogyTreeView component: displays parent and child LPs
      - "Trace Forward" button: expand tree to show all descendants
      - "Trace Backward" button: expand tree to show all ancestors
      - Operation type labeling: "split", "merge", "consume", "produce"
    </implementation-notes>
  </context>
</story>
