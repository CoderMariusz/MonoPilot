<?xml version="1.0" encoding="UTF-8"?>
<story>
  <id>5.7b</id>
  <name>Genealogy Validation & Atomicity</name>
  <batch>5A-2 (LP Operations) - SPLIT from 5.7</batch>
  <part>2 of 3</part>
  <updated>2025-11-28</updated>
  <status>Todo</status>
  <priority>ðŸ”´ CRITICAL (Gap 2 Sprint 0)</priority>

  <context>
    <description>
      Part 2 of genealogy implementation. CRITICAL: Adds validation, circular
      dependency detection, and transaction atomicity. Required for Gap 2 Sprint 0.
    </description>

    <scope>
      - FK validation in atomic transaction (all IDs exist)
      - Circular dependency detection (prevent cycles)
      - Duplicate genealogy detection (idempotent)
      - Full transaction atomicity (rollback on error)
      - Specific error messages per failure
    </scope>

    <what-is-not-included>
      - Orphan detection (see 5.7c)
      - FDA compliance (see 5.7c)
      - Recall simulation (see 5.7c)
    </what-is-not-included>

    <critical-requirements>
      TRANSACTION ATOMICITY: All-or-nothing guarantee.
      If ANY validation fails: entire genealogy insert ROLLBACK.
      No partial genealogy records.

      CIRCULAR DEPENDENCY CHECK: Prevent cycles (Aâ†’Bâ†’Câ†’A).
      Use recursive CTE to find all ancestors of parent.
      If child is ancestor of parent: reject with error.

      FK VALIDATION: All IDs must exist (parent, child, wo_id, user_id).
      Same org_id validation.

      DUPLICATE DETECTION: If genealogy already exists (same parentâ†’child, same op),
      silent success (idempotent).
    </critical-requirements>

    <related-stories>
      <requires>5.7a (Genealogy Recording)</requires>
      <followed-by>5.7c (Advanced Genealogy)</followed-by>
      <used-by>5.11c (Transaction Atomicity - shares atomicity pattern)</used-by>
    </related-stories>

    <effort-estimate>
      <hours>4-5</hours>
      <points>3</points>
      <reason>Circular detection + transaction handling + error messages</reason>
    </effort-estimate>

    <implementation-notes>
      - Wrap genealogy INSERT in database transaction
      - Recursive CTE for circular dependency check (max 10 levels)
      - Check: SELECT COUNT(*) FROM ancestors_of_parent WHERE parent_lp_id = child_id
      - If count > 0: circular dependency detected, ROLLBACK
      - FK validation before INSERT (product exists, user exists, org_id matches)
      - Specific error messages: "Circular dependency detected", "Invalid parent LP", etc.
      - Gap 2 Sprint 0: This is CRITICAL for production data integrity
    </implementation-notes>
  </context>
</story>
