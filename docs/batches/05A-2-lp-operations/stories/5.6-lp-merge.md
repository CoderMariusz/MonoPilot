# Story 5.6: LP Merge

**ID:** 5.6
**Batch:** 5A-2 (LP Operations)
**Story Points:** 5
**Effort:** 5-6 hours
**Status:** Todo
**Updated:** 2025-11-28 (supplier validation added - cannot merge different suppliers)

---

## User Story

> As a **Warehouse user**, I want to merge LPs of same product/batch, so that I can consolidate inventory.

---

## Acceptance Criteria

### AC 1: Multi-Select Mode
- **Given** LP list view
- **When** clicking checkbox next to multiple LPs
- **Then**:
  - Checkboxes appear next to all LPs
  - Selected count shown: "2 LPs selected"
  - "Merge" button appears (disabled if < 2 selected)
  - "Clear Selection" button appears

### AC 2: Merge Modal
- **Given** 2+ LPs selected
- **When** clicking "Merge" button
- **Then** modal opens showing:
  - List of selected LPs: LP number, qty, product, supplier_batch_number
  - Total qty to merge: SUM(all qty)
  - Target LP selector: Radio buttons for each selected LP
  - Merge button

### AC 3: Compatibility Validation (STRICT RULES)
- **Given** multiple LPs selected
- **When** opening merge modal
- **Then** validate all MUST match:
  - ✅ All LPs have same `product_id`
  - ✅ All LPs have same `supplier_batch_number` (supplier's lot number)
  - ✅ All LPs have same `expiry_date` (if filled)
  - ✅ All LPs from same supplier (different prices/allergens = must keep separate)
  - If ANY mismatch: Show error: "Cannot merge: LPs have different products, suppliers, or batch numbers. Possible issues: different supplier batches, different allergens, or different prices"

### AC 4: Merge Execution
- **Given** valid LPs and target LP selected
- **When** confirming merge
- **Then**:
  - Target LP qty += SUM(source_lp_qty)
  - All source LPs status → 'merged' (immutable)
  - Genealogy records created for each source:
    - `parent_lp_id` = source LP
    - `child_lp_id` = target LP
    - `operation_type` = 'merge'
  - Source LPs remain visible in history but marked 'merged'

### AC 5: Success Feedback
- **Given** merge completes
- **When** operation finishes
- **Then** show success message:
  - "Merged 3 LPs into LP-20250120-0001 (300 kg total)"
  - Close modal and refresh LP list
  - Target LP updated with new qty

---

## Technical Tasks

### Backend

- [ ] Create `POST /api/warehouse/license-plates/merge` endpoint
  - Accept `source_lp_ids` (array), `target_lp_id`
  - Validate all source LPs exist and belong to org_id
  - **Validate compatibility (MUST ALL MATCH):**
    - Same `product_id`
    - Same `supplier_batch_number` (supplier's lot)
    - Same `expiry_date` (if filled)
    - **Same supplier** (derived from supplier_batch_number or GRN source) ⭐ CRITICAL
  - Verify target LP in source list (target must be one of sources)
  - Sum source quantities
  - Update target LP: `qty += total_qty`, status = 'available' (after merge)
  - Update source LPs: status → 'merged' (immutable)
  - Create genealogy records for each source → target (relationship_type = 'merge')
  - Return: target LP with merged qty, genealogy IDs

- [ ] Add status validation: Cannot merge 'consumed', 'shipped', 'merged' LPs

- [ ] Implement transaction: If ANY validation fails, rollback all changes

### Database

- [ ] Ensure `license_plates.status` supports 'merged' value
- [ ] Add CHECK constraint: Cannot change status from 'merged' (immutable)
- [ ] Ensure lp_genealogy table supports bulk inserts

### Frontend

- [ ] Update LP list page: Add checkbox column for multi-select
  - Checkbox in header for "select all"
  - Checkboxes in each row
  - Selection counter: "{N} LPs selected"

- [ ] Create `MergeLPsModal` component
  - Display selected LPs with qty summary
  - Radio buttons: Select target LP (default = largest qty)
  - Validation: Show error if incompatible
  - Button: "Merge" (enabled only if valid)

- [ ] Update LP list: Show "Merge" button in toolbar (when 2+ selected)

- [ ] Add "merged" badge to list: Grayed out, shows "Merged" label

- [ ] Add success toast: "Merged 3 LPs into LP-0001 (300 kg)"

---

## Testing

### Unit Tests
- Compatibility validation: same product, batch, expiry → pass
- Compatibility validation: different products → fail
- Compatibility validation: different batch → fail
- Qty calculation: 50 + 75 + 25 = 150 ✓
- Status update: source LPs set to 'merged'

### Integration Tests
- POST /api/warehouse/license-plates/merge with 3 LPs
- Verify target LP qty updated
- Verify source LPs status = 'merged'
- Verify genealogy records created for all sources

### E2E Tests
- Create 3 LPs with same product/batch
- Select all 3 in LP list
- Click "Merge", select target, confirm
- Verify: target qty = 300, sources marked 'merged'
- Verify genealogy: 3 records created (source1→target, source2→target, source3→target)

---

## Acceptance Criteria Checklist

- ✅ Multi-select checkboxes in LP list
- ✅ Merge button appears when 2+ selected
- ✅ Compatibility validation prevents incompatible merges
- ✅ Target LP qty updated to total
- ✅ Source LPs status → 'merged'
- ✅ Genealogy records created for each source-target pair
- ✅ Success message shown

---

## Dependencies

**Requires:** Story 5.1 (License Plate Creation)

**Enables:** Story 5.7 (LP Genealogy), Story 5.28 (Forward/Backward Traceability)

---

## Notes

- Merge is **irreversible**: source LPs permanently marked 'merged'
- Target LP can be any of the selected LPs (user chooses)
- Merge requires all LPs to be compatible (same product/batch)
- Genealogy records: Each source → target (not source1 → source2)
- Merged LPs remain in history for traceability purposes
