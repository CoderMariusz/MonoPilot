# Story 5.5: LP Split

**ID:** 5.5
**Batch:** 5A-2 (LP Operations)
**Story Points:** 5
**Effort:** 5-6 hours
**Status:** Todo

---

## User Story

> As a **Warehouse user**, I want to split an LP into smaller quantities, so that I can partially use inventory.

---

## Acceptance Criteria

### AC 1: Split Modal
- **Given** LP detail view
- **When** clicking "Split" button
- **Then** modal opens with:
  - Current LP number (read-only)
  - Current qty and UoM (read-only)
  - "Split qty" input field
  - "Location" dropdown (optional, defaults to parent LP location)
  - "Split" button

### AC 2: Quantity Validation
- **Given** split qty provided
- **When** validating
- **Then**:
  - `split_qty > 0` (must be positive)
  - `split_qty < parent_qty` (must be less than parent)
  - `split_qty <= parent_qty` (cannot exceed parent)
  - Show error if invalid: "Split qty must be between 1 and {parent_qty}"

### AC 3: Split Creation
- **Given** valid split qty
- **When** confirming split
- **Then**:
  - Original LP qty decreased: `parent.qty -= split_qty`
  - New LP created with: `child.qty = split_qty`
  - New LP auto-numbered: `child.lp_number = next auto-generated number`
  - Child LP inherits: `product_id`, `batch_number`, `supplier_batch_number`, `manufacture_date`, `expiry_date`, `uom`
  - Child LP gets location: parent location (or override if provided)
  - Child LP status: 'available'

### AC 4: Genealogy Recording
- **Given** split is confirmed
- **When** split operation completes
- **Then** genealogy record created:
  - `parent_lp_id` = original LP
  - `child_lp_id` = new split LP
  - `operation_type` = 'split'
  - `created_by_user_id` = current user
  - `created_at` = current timestamp

### AC 5: Success Feedback
- **Given** split completes successfully
- **When** operation finishes
- **Then** show success message:
  - Original: "LP-20250120-0001 (100 kg) → 50 kg remaining"
  - New: "New LP-20250120-0002 (50 kg) created"
  - Close modal and refresh LP list

---

## Technical Tasks

### Backend

- [ ] Create/update `POST /api/warehouse/license-plates/:id/split` endpoint
  - Accept `split_qty`, `location_id` (optional)
  - Validate split qty > 0 and < parent qty
  - Validate parent LP exists and belongs to org_id
  - Decrement parent LP qty
  - Create child LP with split qty
  - Auto-generate child LP number (use lp_number_sequence)
  - Create genealogy record (operation_type = 'split')
  - Return parent + child LP details

- [ ] Add status validation: Cannot split 'merged', 'consumed', 'shipped' LPs

- [ ] Implement transaction: If ANY step fails, rollback all changes

### Database

- [ ] Ensure `license_plates.qty` is updatable (decimal type)
- [ ] Ensure `lp_genealogy` table exists with indexes on parent_lp_id, child_lp_id
- [ ] Verify RLS policies allow INSERT on lp_genealogy

### Frontend

- [ ] Create `SplitLPModal` component
  - Display: LP number, current qty, UoM
  - Input: split qty (numeric)
  - Dropdown: location (optional)
  - Validation: Show error if split_qty invalid
  - Button: "Split" (disabled if qty invalid)

- [ ] Update LP detail page: Add "Split" button in actions

- [ ] Update LP list: Show "Split" context menu for each LP

- [ ] Add success toast: "LP split: LP-0001 (50 kg) → LP-0002 (50 kg)"

---

## Testing

### Unit Tests
- Split qty validation: 0, negative, > parent qty → error
- Parent qty decrement: 100 - 50 = 50 ✓
- Child LP created with correct qty
- Genealogy record created with correct fields

### Integration Tests
- POST /api/warehouse/license-plates/:id/split with valid qty
- Verify parent updated, child created, genealogy recorded
- Verify child LP auto-numbered correctly

### E2E Tests
- Create LP with 100 qty
- Click "Split", enter 50
- Verify: parent 50, child 50, genealogy recorded
- Click "Trace Forward" on parent → shows child

---

## Acceptance Criteria Checklist

- ✅ Split modal shows current LP details
- ✅ Quantity validation prevents invalid splits
- ✅ New LP created with auto-generated number
- ✅ Child inherits product, batch, expiry, UoM
- ✅ Genealogy recorded with operation_type = 'split'
- ✅ Parent qty updated correctly
- ✅ Success message shown

---

## Dependencies

**Requires:** Story 5.1 (License Plate Creation), Story 5.4 (LP Number Generation)

**Enables:** Story 5.7 (LP Genealogy), Story 5.16 (Partial Move)

---

## Notes

- Split is **non-destructive**: original LP remains with reduced qty
- New LP gets new LP number (not a copy)
- Genealogy is permanent (no delete allowed)
- Split can be reversed only by merge operation
