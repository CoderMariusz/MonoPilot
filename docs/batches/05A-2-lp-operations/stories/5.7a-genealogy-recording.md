# Story 5.7a: Genealogy Basic Recording & Tracing

**ID:** 5.7a
**Batch:** 5A-2 (LP Operations) - SPLIT from 5.7
**Story Points:** 3
**Effort:** 4-5 hours
**Status:** Todo
**Created:** 2025-11-28 (split story - part 1 of 3)

---

## User Story

> As a **System**, I want to record LP relationships (parent-child), so that basic traceability is available.

---

## Goal

Implement **basic genealogy recording** for split/merge operations and implement **forward/backward trace** (simple recursive queries).

This story implements the foundation. Complex validation and atomicity moved to 5.7b.

---

## Acceptance Criteria

### AC 1: Genealogy Recording During Operations
- **Given** LP split/merge operation completes
- **When** operation finishes
- **Then** lp_genealogy record created:
  - `parent_lp_id` = source LP
  - `child_lp_id` = result LP
  - `relationship_type` = 'split', 'merge', 'consume', 'produce'
  - `created_at` = timestamp
  - `created_by_user_id` = current user
  - `org_id` = org context

### AC 2: Forward Trace (Descendants)
- **Given** LP detail view
- **When** clicking "Trace Forward" button
- **Then** modal shows:
  - Direct children (depth 1)
  - Grandchildren (depth 2)
  - Up to max_depth = 10
  - Shows: LP number, operation type, timestamp
  - Expandable tree view

### AC 3: Backward Trace (Ancestors)
- **Given** LP detail view
- **When** clicking "Trace Backward" button
- **Then** modal shows:
  - Direct parent (depth 1)
  - Grandparent (depth 2)
  - Up to max_depth = 10
  - Shows: LP number, operation type, timestamp
  - Expandable tree view

### AC 4: Operation Type Display
- **Given** viewing genealogy records
- **When** checking relationship_type
- **Then** shows human-readable operation:
  - 'split' = "Split from parent"
  - 'merge' = "Merged with others"
  - 'consume' = "Consumed in WO"
  - 'produce' = "Produced from WO"

---

## Technical Tasks

### Backend

- [ ] Implement genealogy recording function:
  - `recordGenealogy(parent_lp_id, child_lp_id, operation_type, user_id, org_id)`
  - Insert lp_genealogy record
  - Basic validation (IDs not NULL)

- [ ] Implement forward trace endpoint: `GET /api/warehouse/license-plates/:id/genealogy/descendants`
  - Accept: max_depth (default 10)
  - Recursive CTE: descendants starting from parent
  - Return: tree structure with LP details

- [ ] Implement backward trace endpoint: `GET /api/warehouse/license-plates/:id/genealogy/ancestors`
  - Accept: max_depth (default 10)
  - Recursive CTE: ancestors starting from child
  - Return: tree structure with LP details

### Database

- [ ] Verify lp_genealogy table exists with:
  - id, org_id, parent_lp_id, child_lp_id, relationship_type
  - created_at, created_by_user_id
  - Indexes: org_id, parent_lp_id, child_lp_id

- [ ] Create recursive CTE queries:
  - Forward trace (descendants)
  - Backward trace (ancestors)

### Frontend

- [ ] Add "Trace Forward" button to LP detail modal
  - Opens modal with tree view
  - Shows descendants

- [ ] Add "Trace Backward" button to LP detail modal
  - Opens modal with tree view
  - Shows ancestors

- [ ] Create `GenealogyTreeView` component
  - Visual tree of parent-child relationships
  - Nodes: LP number, operation type, timestamp
  - Expandable/collapsible nodes

---

## Testing

### Unit Tests
- Genealogy record creation
- Forward trace with various depths
- Backward trace with various depths

### Integration Tests
- Split LP → create genealogy → forward trace shows child
- Merge LPs → create genealogy → backward trace shows parents
- Deep genealogy (3+ levels)

### E2E Tests
- Create split → trace forward → see child
- Create merge → trace backward → see parents
- Multiple generations genealogy

---

## Acceptance Criteria Checklist

- ✅ Genealogy records created for split/merge operations
- ✅ Forward trace returns descendants
- ✅ Backward trace returns ancestors
- ✅ Operation types displayed correctly
- ✅ Depth limit enforced (max 10)

---

## Dependencies

**Requires:** Story 5.1 (LP Creation), Story 5.5 (LP Split), Story 5.6 (LP Merge)

**Blocks:** Story 5.7b (Validation & Atomicity)

**Related:** Story 5.28 (Traceability UI)

---

## Notes

- **Part 1 of 3:** Basic recording and tracing
- Part 2 (5.7b): Validation, atomicity, circular dependency detection
- Part 3 (5.7c): Advanced features, FDA compliance, recall simulation
- Genealogy immutable (INSERT-only)
- Recursive CTEs can be slow with deep genealogy (>10 levels)

