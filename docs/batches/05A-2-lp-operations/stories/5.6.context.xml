<?xml version="1.0" encoding="UTF-8"?>
<story>
  <id>5.6</id>
  <name>LP Merge (with Supplier Validation)</name>
  <batch>5A-2 (LP Operations)</batch>
  <updated>2025-11-28</updated>
  <status>Todo</status>

  <context>
    <description>
      Merge multiple LPs of same product into single LP. NEW: Supplier validation
      prevents merging LPs from different suppliers (different prices/allergens).
    </description>

    <key-changes>
      <change type="ADDED">supplier_batch_number validation (MUST MATCH for merge)</change>
      <change type="ADDED">supplier validation (MUST be SAME supplier)</change>
      <change type="CLARIFIED">error message includes supplier mismatch details</change>
      <change type="UPDATED">merge target LP status = 'available' after merge (can be split/merged again)</change>
      <change type="UPDATED">source LPs status = 'merged' (immutable, archived)</change>
    </key-changes>

    <critical-requirements>
      STRICT VALIDATION: All LPs being merged MUST have:
      ✅ Same product_id
      ✅ Same supplier_batch_number (supplier's lot number)
      ✅ Same expiry_date (if filled)
      ✅ Same supplier (for prices and allergens)

      Any mismatch → Error: "Cannot merge: LPs have different products, suppliers, or batch numbers"

      Source LPs become immutable (status='merged') after merge.
      Result LP can be further split/merged (normal operations allowed).
    </critical-requirements>

    <related-stories>
      <requires>5.1 (LP Creation), 5.2 (Status Tracking), 5.3 (Batch/Expiry)</requires>
      <enables>5.7a (Genealogy Recording), 5.7b (Genealogy Validation)</enables>
    </related-stories>

    <effort-estimate>
      <hours>5-6</hours>
      <points>5</points>
    </effort-estimate>

    <implementation-notes>
      - Merge validation checks 4 criteria (product, batch, expiry, supplier)
      - Multi-select UI: checkboxes on LP list, "Merge" button appears when 2+ selected
      - MergeLPsModal: shows selected LPs, radio buttons to select target
      - Genealogy: creates one record per source → target (merge relationship)
      - Transaction: if ANY validation fails, ROLLBACK all changes
      - Target LP gets merged qty, source LPs marked 'merged'
    </implementation-notes>
  </context>
</story>
