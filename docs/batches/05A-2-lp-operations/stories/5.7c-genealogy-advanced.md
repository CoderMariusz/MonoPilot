# Story 5.7c: Advanced Genealogy Features & FDA Compliance

**ID:** 5.7c
**Batch:** 5A-2 (LP Operations) - SPLIT from 5.7 (Part 3)
**Story Points:** 2
**Effort:** 3-4 hours
**Status:** Todo
**Created:** 2025-11-28 (advanced features + FDA)

---

## User Story

> As a **System**, I want orphan detection, FDA compliance checks, and recall simulation, so that traceability meets regulatory requirements.

---

## Goal

Implement **orphan detection**, **post-insert trace verification**, **FDA compliance checks**, and **recall simulation** (forward+backward combined).

---

## Acceptance Criteria

### AC 1: Orphan Detection

**Given** parent LP with children genealogy is deleted
**When** checking genealogy
**Then**:
- Display warning: "⚠️ Parent LP-001 (deleted on 2025-01-27)"
- Still fully traceable (genealogy intact)
- Show last known parent details

### AC 2: Trace Verification (Post-Insert)

**Given** genealogy record inserted
**When** operation completes
**Then** system verifies:
- Forward trace: all descendants reachable
- Backward trace: all ancestors reachable
- No broken links or orphans (unless parent soft-deleted)

### AC 3: FDA Compliance Guarantees

- ✅ Every consumed LP → linked to output LP via genealogy
- ✅ Every output LP → linked to all input LPs (backward trace complete)
- ✅ LP split → all children linked to parent
- ✅ LP merge → all parents linked to merged child
- ✅ Genealogy records immutable (no DELETE/UPDATE)
- ✅ No circular dependencies (enforced)
- ✅ No cross-org genealogy (org isolation)

**What's FORBIDDEN:**
- ❌ Output LP without input genealogy
- ❌ Genealogy without valid parent AND child
- ❌ Circular dependencies
- ❌ Broken traces

### AC 4: Recall Simulation

**Scenario:** "Flour batch LP-001 contaminated. Find all affected products."

**Forward Trace (Impact Analysis):**
- Use recursive CTE → find all descendants of LP-001
- Result: All downstream LPs (Bread, Pastry, Cookies, etc.)
- Impact: "15 final products affected by contaminated flour"

**Backward Trace (Root Cause Analysis):**
- Use recursive CTE → find all ancestors of affected Bread LP
- Result: All upstream LPs (Flour, Yeast, Salt, etc.)
- Root cause: "Contaminated Flour (LOT-2025-001)"

**Combined (Full Recall):**
- Identify contaminated source (LP-001)
- Forward trace → all downstream affected
- Backward trace on each downstream → all contributors
- Report: "Recall all 15 products. Root: LP-001. Affected batches: [list]"

---

## Technical Tasks

### Backend

- [ ] Implement orphan detection:
  - Query: parent LP where deleted_at IS NOT NULL
  - Check in genealogy: parent_lp_id = deleted LP
  - UI: show warning with deleted timestamp

- [ ] Implement trace verification (post-insert):
  - After INSERT genealogy: run forward + backward trace
  - Verify all results are reachable
  - Log any broken links for audit

- [ ] Implement recall simulation:
  - `GET /api/warehouse/genealogy/recall-impact?lp_id=XXX`
  - Forward trace: get all affected products
  - Count affected: "15 final products affected"
  - Return: list with impact details

- [ ] FDA compliance validation:
  - Check: consumed LP has genealogy record
  - Check: output LP has input genealogy
  - Log: any compliance violations
  - Report: compliance summary

### Database

- [ ] Ensure genealogy immutability:
  - No UPDATE POLICY on lp_genealogy
  - No DELETE POLICY on lp_genealogy
  - INSERT-only design

- [ ] Create archive strategy for deleted LPs:
  - Soft delete: deleted_at timestamp
  - Keep genealogy intact
  - Archive parent info (Option B from decisions)

---

## Testing

### Unit Tests
- Orphan detection with deleted parent
- Trace verification (forward + backward)
- Recall simulation (2-3 level genealogy)

### Integration Tests
- Complex genealogy: 5-level tree
- Recall simulation with 10+ affected LPs
- Deleted parent detection

### E2E Tests
- Create genealogy → verify traces complete
- Delete parent LP → orphan warning shows
- Simulate recall → correct affected count

---

## Notes

- Part 3 of 3: Advanced features
- FDA compliance is **critical** for food/pharma industry
- Recall simulation is **regulatory requirement**
- Orphan detection prevents data loss visibility

