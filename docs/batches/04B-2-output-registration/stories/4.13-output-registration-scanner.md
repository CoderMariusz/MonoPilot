# Story 4.13: Output Registration (Scanner)

**Epic:** 4 - Production Execution | **Status:** To Be Designed | **Priority:** P0 | **Story Points:** 2 | **Effort:** 1 day

## User Story

**As an** Operator (using handheld scanner/tablet device)
**I want** to register production output via barcode scanning
**So that** I can efficiently capture output data directly at the production line

---

## Purpose

Story 4.13 is the **scanner/mobile variant** of Story 4.12 (Desktop Output Registration). Both stories use the **same API endpoint** and the **same sequential LP consumption algorithm** (Story 4.12a). The difference is UI: Story 4.13 optimizes for touch-based mobile workflow, barcode scanning, and label printing instead of desktop keyboard/mouse.

---

## Acceptance Criteria

### AC-4.13.1: Scanner Output Registration Entry Point

**Given** operator navigates to /scanner/output on mobile/tablet device

**When** arriving at scanner output screen

**Then** show:
- Large "Scan WO Barcode" button
- Barcode scanner input field (auto-focused for scanning)
- Quick reference: WO number, product, planned qty

### AC-4.13.2: WO Barcode Scanning

**Given** barcode scanner ready

**When** operator scans WO barcode

**Then** system:
1. Looks up WO by barcode
2. Validates WO status (must be in_progress)
3. Retrieves WO details and reserved LPs
4. Shows WO summary screen

```
WO Summary:
├─ WO Number
├─ Product name
├─ Planned output: 200 kg
├─ Current output tracked: 70 kg
├─ Remaining to produce: 130 kg
├─ Reserved materials:
│  ├─ LP-A: 50 kg (unused)
│  ├─ LP-B: 40 kg (unused)
│  └─ LP-C: 80 kg (unused)
└─ [Enter Output Qty] button
```

### AC-4.13.3: Output Quantity Entry (Touch-Optimized)

**Given** WO summary shown

**When** operator enters output qty

**Then** show large input field with numpad-style keyboard:

```
┌─────────────────────────────┐
│ Qty: [____________] kg      │
│                             │
│  [ 1 ] [ 2 ] [ 3 ] [ C ]   │
│  [ 4 ] [ 5 ] [ 6 ] [ ← ]   │
│  [ 7 ] [ 8 ] [ 9 ] [ . ]   │
│  [ 0 ] [ + ] [ - ]          │
│                             │
│         [ Continue ]        │
└─────────────────────────────┘
```

Button sizes: minimum 44px (iOS) / 48px (Android) for touch accessibility

### AC-4.13.4: QA Status Selection (Large Buttons)

**Given** qty entered

**When** continuing

**Then** show QA status selection (if required by Settings):

```
┌───────────────────────────────┐
│ QA Status?                    │
│                               │
│      [ ✓ PASS ]              │
│      [ ✗ FAIL ]              │
│      [ ? PENDING ]           │
│                               │
│      [ Continue ]            │
└───────────────────────────────┘
```

All buttons: Large (>50px), high contrast colors
- PASS: Green
- FAIL: Red
- PENDING: Yellow/Orange

### AC-4.13.5: Sequential LP Consumption (via Story 4.12a)

**Given** qty and QA status entered

**When** confirming output registration

**Then** system uses sequential LP consumption algorithm from **Story 4.12a**:

```
Backend automatically handles:
1. Calculate consumption allocation (Story 4.12a)
2. Create wo_consumption records
3. Update LP current_qty
4. Create genealogy records (Story 4.19)
5. Handle over-consumption if needed (Story 4.12b)
```

**Scanner does NOT show consumption details** - this is handled server-side. Scanner focus: qty + QA status + label printing.

### AC-4.13.6: Over-Consumption Warning (Scanner Variant)

**Given** consumption would exceed reserved LPs (from 4.12a)

**When** over-consumption detected

**Then** show scanner-optimized warning:

```
┌────────────────────────────────┐
│ ⚠️  Over-Consumption Detected │
├────────────────────────────────┤
│ Reserved: 200 kg              │
│ Already used: 170 kg          │
│ Requested: 30 kg              │
│ Total: 200 kg (at limit)     │
│                               │
│  Do you want to proceed?      │
│                               │
│    [ YES ]    [ NO ]         │
└────────────────────────────────┘
```

Uses same Over-Production logic from Story 4.12b if exceeding reserved qty

### AC-4.13.7: Over-Production Handling (Scanner Variant)

**Given** output exceeds all reserved LPs (true over-production)

**When** operator confirms

**Then** show material source selection (Story 4.12b):

```
┌────────────────────────────────┐
│ ⚠️  Over-Production Detected  │
├────────────────────────────────┤
│ Which material source?         │
│                               │
│  [ ] LP-A (50 kg)            │
│  [ ] LP-B (40 kg)            │
│  [ ] LP-C (80 kg)            │
│                               │
│   [ CONFIRM ]  [ CANCEL ]   │
└────────────────────────────────┘
```

Use radio buttons (single select) for touch - operator selects parent LP

### AC-4.13.8: Output Registration Confirmation

**Given** all data entered and over-consumption handled

**When** confirming

**Then** register output via API and create LP + genealogy:

```
API Call (same as 4.12):
POST /api/production/work-orders/:id/outputs
{
  "qty": 70,
  "qa_status": "pass",
  "location_id": "LOC-1",
  "is_over_production": false,
  "over_production_parent_lp_id": null
}

Response:
{
  "success": true,
  "output_lp": {
    "id": "LP-OUTPUT-1",
    "product_id": "PROD-1",
    "batch_number": "WO-001",
    "quantity": 70,
    "status": "available"
  }
}
```

### AC-4.13.9: Label Printing (ZPL Format)

**Given** output LP created

**When** output registered successfully

**Then** automatically print ZPL label to configured printer:

```
Printer Configuration:
- Read from production_settings.printer_network_address (Story 4.17)
- Method: POST to /api/printer/print with ZPL content
- Alternative: Socket connection to printer if available

ZPL Label Template:
^XA
^MMT
^PW812
^LL406
^LS0
^LH0,0
^LT0
^MNW
^MTT
^BY3,3,100^FO50,50^BC^FD${LP_NUMBER}^FS
^FO50,170^A0N,28,28^FD${PRODUCT_NAME}^FS
^FO50,210^A0N,24,24^FD${QUANTITY} ${UOM}^FS
^FO50,250^A0N,20,20^FDBatch: ${BATCH_NUMBER}^FS
^FO50,290^A0N,20,20^FDExp: ${EXPIRY_DATE}^FS
^FO50,330^A0N,16,16^FD${TIMESTAMP}^FS
^XZ

Variables:
- LP_NUMBER: e.g., "LP-001-2025"
- PRODUCT_NAME: e.g., "Flour - Premium"
- QUANTITY: e.g., "70"
- UOM: e.g., "kg"
- BATCH_NUMBER: e.g., "WO-001"
- EXPIRY_DATE: e.g., "2026-05-28"
- TIMESTAMP: e.g., "2025-11-28 14:30"

Printer Error Handling:
- If printer unreachable: Show warning "Label print failed" but allow continuation
- Log error for IT support
- Operator can retry printing from WO detail later
```

### AC-4.13.10: Success Feedback

**Given** output registered and label printed (or attempted)

**When** registration completes

**Then** show success screen:

```
┌────────────────────────────────┐
│          ✅  SUCCESS           │
├────────────────────────────────┤
│ Output registered: 70 kg       │
│ LP: LP-OUTPUT-1               │
│ Label printed                  │
│                               │
│  [ Scan Next ]  [ Go to WO ] │
└────────────────────────────────┘
```

Options:
- **Scan Next**: Clear screen, ready for next output (same WO or new WO)
- **Go to WO**: Return to WO detail screen

### AC-4.13.11: By-Product Registration Prompt (After Main Output)

**Given** output registration completes

**When** WO has by-products defined

**Then** trigger by-product prompt (Story 4.14):

```
Dialog shows (same as desktop):
├─ By-product name
├─ Expected qty (from BOM yield %)
├─ Actual qty input field
└─ [Register] [Skip] [Skip All] buttons

Process:
- One by-product at a time
- Operator enters qty or skips
- After all processed: Return to success screen
```

**See Story 4.14** for complete by-product flow details

### AC-4.13.12: Offline Support (Queuing)

**Given** network unavailable

**When** operator attempts to register output

**Then** queue operation for later sync (Story 5.36):

```
If offline:
1. User enters qty + QA status
2. System stores in IndexedDB offline queue
3. Show: "⚠️ Offline - saved locally, will sync when online"
4. Continue button available (don't block)

When back online:
- Automatically sync queued operations
- Or operator can manually trigger sync
- Sync uses same POST /api/production/work-orders/:id/outputs
```

### AC-4.13.13: Same API as Desktop

**Then** Uses identical POST /api/production/work-orders/:id/outputs endpoint:

```
Desktop (Story 4.12) → Same endpoint
Scanner (Story 4.13) → Same endpoint
By-Product (Story 4.14) → Same endpoint POST /by-products

All use sequential consumption from Story 4.12a internally
```

### AC-4.13.14: Prerequisites & Dependencies

**Requires:**
- Story 4.12: Output Registration (same API endpoint)
- Story 4.12a: Sequential LP Consumption (same algorithm)
- Story 4.12b: Over-Production Handling (same over-production logic)
- Story 4.19: Genealogy Recording (genealogy creation)
- Story 4.14: By-Product Registration (by-product prompt flow)
- Story 4.17: Production Settings (printer_network_address)

---

## Technical Implementation

### Scanner UI Architecture

**Technology Stack:**
- Mobile-friendly responsive UI (works on tablets and large phones)
- Touch-optimized buttons (>44px minimum)
- Barcode scanning: Native device camera (HTML5 Barcode API) or hardware scanner input
- Label printing: REST API to printer or direct socket

**UI States:**
1. Idle: "Scan WO Barcode"
2. WO Found: WO summary + "Enter Output Qty"
3. Qty Entered: "Select QA Status" (if required)
4. Over-Consumption: Warning dialog
5. Over-Production: Parent LP selection
6. Success: Green checkmark + next actions

### API Integration

Uses **same endpoint as Story 4.12**:
```
POST /api/production/work-orders/:id/outputs

All sequential consumption, genealogy, over-consumption logic
handled server-side (Story 4.12a, 4.12b, 4.19)
```

### Label Printing Integration

```typescript
// After output LP created, print label
const printLabel = async (outputLp: LicensePlate) => {
  const zpl = generateZPL(outputLp);  // Generate ZPL from template

  try {
    await fetch('/api/printer/print', {
      method: 'POST',
      body: JSON.stringify({ zpl }),
      headers: { 'Content-Type': 'application/json' }
    });
  } catch (error) {
    // Printer unreachable - show warning but allow continuation
    console.warn('Label print failed:', error);
    showWarning('Label print failed. Operator can retry from WO detail');
  }
};
```

---

## Testing Strategy

### Unit Tests

- Barcode parsing (validate WO ID extraction)
- Qty input validation (numeric, positive, decimal support)
- ZPL template generation (correct variable substitution)
- Offline queue storage (IndexedDB write/read)

### Integration Tests

- End-to-end scanner workflow: scan WO → enter qty → QA status → print label
- Over-consumption detection and warning flow
- Over-production: operator selects parent LP
- By-product prompting after main output
- Offline workflow: queue operations, sync when online

### E2E Tests

**Test Scenario 1: Simple Output**
1. Open scanner app
2. Scan WO barcode
3. See WO summary
4. Enter 70 kg
5. Select QA status: PASS
6. Confirm → Output registered
7. Label printed
8. Success screen → "Scan Next"

**Test Scenario 2: Over-Consumption**
1. Repeat steps 1-4
2. Qty 150 kg (exceeds reserved 200 kg, but within limit)
3. Over-consumption warning shown
4. Operator confirms "YES"
5. Output registered
6. Verify wo_consumption records created
7. Verify genealogy linked

**Test Scenario 3: Over-Production**
1. Repeat steps 1-4
2. Qty 250 kg (exceeds all 200 kg reserved)
3. Over-production dialog: "Which material source?"
4. Operator selects LP-A
5. Output registered with is_over_production=true
6. Verify genealogy: LP-A → Output with is_over_production flag

**Test Scenario 4: By-Products**
1. Main output 70 kg registered
2. By-product dialog shown: "Scrap (expected 7 kg)"
3. Operator enters 8 kg
4. Scrap LP created
5. Next by-product dialog (if exists)
6. Operator clicks [Skip All]
7. Return to success

**Test Scenario 5: Offline**
1. Network disabled
2. Scan WO, enter qty, confirm
3. Message: "⚠️ Offline - saved locally"
4. Continue button available
5. Re-enable network
6. Auto-sync (or manual sync trigger)
7. Verify output registered on server

---

## Acceptance Criteria Checklist

- ✅ Scanner entry point with WO barcode scanning
- ✅ Touch-optimized UI with large buttons (>44px)
- ✅ Qty input with numpad-style keyboard
- ✅ QA status selection (large colored buttons)
- ✅ Sequential LP consumption via Story 4.12a
- ✅ Over-consumption warning and operator confirmation
- ✅ Over-production handling with parent LP selection
- ✅ ZPL label printing to configured printer
- ✅ Success feedback with next action options
- ✅ By-product registration prompting (Story 4.14)
- ✅ Offline support with operation queuing
- ✅ Uses same API endpoint as Desktop (4.12)

---

## Dependencies

**Requires:**
- Story 4.12: Output Registration (same API, same flow structure)
- Story 4.12a: Sequential LP Consumption (same algorithm)
- Story 4.12b: Over-Production Handling (same over-production logic)
- Story 4.19: Genealogy Recording (genealogy creation)
- Story 4.14: By-Product Registration (by-product prompting)
- Story 4.17: Production Settings (printer_network_address configuration)
- Story 5.36: Scanner Offline Queue (offline operation support)

**Used by:**
- Story 5.36: Offline Queue (scanner output queuing when offline)

---

## Notes

- **Same API as Desktop**: Both Story 4.12 (Desktop) and 4.13 (Scanner) use identical POST /api/production/work-orders/:id/outputs endpoint
- **Backend Logic**: Sequential consumption, genealogy, over-production handling all on server side (Story 4.12a, 4.12b, 4.19)
- **Scanner Focus**: Touch-optimized UI, barcode scanning, label printing - not business logic
- **Label Printing**: Gracefully handles printer failures (warning, not blocking)
- **Offline Priority**: Scanner typically used in warehouse floor areas with spotty network - offline queuing essential

---

## Status

- **Created:** 2025-11-27
- **Updated:** 2025-12-03
- **Current Status:** Done
- **Completed:** 2025-12-03

## Implementation Notes (2025-12-03)

### Files Implemented

**Scanner Page:**
- `app/(authenticated)/scanner/output/page.tsx`
  - Touch-optimized scanner UI
  - WO barcode scanning (AC-4.13.2)
  - Numpad qty input (AC-4.13.3)
  - Large QA status buttons (AC-4.13.4)
  - Over-consumption/over-production handling (AC-4.13.6, AC-4.13.7)
  - Success screen with next actions (AC-4.13.10)

**Scanner Menu Update:**
- `app/(authenticated)/scanner/page.tsx`
  - Added "Output Registration" module card

**Print API:**
- `app/api/printer/print/route.ts`
  - ZPL label generation (AC-4.13.9)
  - Printer network communication
  - Graceful failure handling

**Database:**
- Added `printer_network_address` column to production_settings

**Tests:**
- `e2e/story-4.13-scanner-output.spec.ts`

### AC Coverage

| AC# | Description | Evidence |
|-----|-------------|----------|
| AC-4.13.1 | Scanner entry point | `scanner/output/page.tsx` |
| AC-4.13.2 | WO barcode scanning | `handleBarcodeScan()` |
| AC-4.13.3 | Touch numpad | `handleNumpadPress()` |
| AC-4.13.4 | QA status buttons | Large colored buttons (h-16) |
| AC-4.13.5 | Sequential consumption | Uses 4.12a via API |
| AC-4.13.6 | Over-consumption warning | `state === 'over_consumption'` |
| AC-4.13.7 | Over-production handling | `state === 'over_production'` |
| AC-4.13.8 | Output confirmation | `handleSubmit()` |
| AC-4.13.9 | ZPL label printing | `api/printer/print/route.ts` |
| AC-4.13.10 | Success feedback | Success state with Scan Next |
| AC-4.13.11 | By-product prompt | ByProductRegistrationDialog integrated |
| AC-4.13.12 | Offline support | Deferred to Story 5.36 |
| AC-4.13.13 | Same API as desktop | Uses same `/outputs` endpoint |
| AC-4.13.14 | Prerequisites | All dependencies met |
