# Story 4.14: By-Product Registration

**Epic:** 4 - Production Execution | **Status:** To Be Designed | **Priority:** P0 | **Story Points:** 2 | **Effort:** 1 day

## User Story

**As an** Operator
**I want** to register by-products (if any) after main output
**So that** all production outputs including by-products are tracked with full genealogy

---

## Purpose

By-product registration happens **after** main output (Story 4.12) is completed. Unlike main output which uses sequential LP consumption (Story 4.12a), by-products are registered via **manual operator entry** - operator directly enters the actual qty produced for each by-product.

---

## Acceptance Criteria

### AC-4.14.1: By-Product Registration Trigger

**Given** main output registration (Story 4.12) completes successfully

**When** output LP is created and genealogy linked

**Then** system checks if WO has by-products defined (in wo_materials with product_type='by-product'):

```
If by-products exist:
  ├─ Show by-product registration dialog
  ├─ Display each by-product sequentially
  └─ Operator can register qty OR skip all

If no by-products:
  └─ Return to WO detail
```

**Note**: This is triggered by AC 4.12.9 (Story 4.12) which automatically shows by-product prompt after main output

### AC-4.14.2: By-Product Registration Dialog (Sequential)

**Given** by-products exist for this WO

**When** operator enters by-product registration

**Then** show dialog with fields for each by-product (one at a time):

```
Dialog shows:
├─ By-product name (from BOM)
├─ Expected qty: calculated from BOM yield % × main output qty
│  Example: Main output 100kg + yield 30% = expected 30kg by-product
├─ Actual qty input field (required, > 0)
├─ QA status dropdown (if required in Settings)
├─ Location dropdown (optional, default from line)
├─ Notes field (optional)
└─ [Register] [Skip This] [Skip All] buttons

After operator registers or skips:
├─ Move to next by-product
└─ If all processed or [Skip All] clicked: Return to WO detail
```

### AC-4.14.3: By-Product Registration - Manual Entry (Not Automatic Consumption)

**Given** operator enters actual by-product qty

**When** confirming registration

**Then** by-product registered with entered qty (no sequential consumption):

```
Key Difference from Main Output (Story 4.12):
- Main output: Uses sequential LP consumption from 4.12a
- By-product: Manual operator entry of qty

Example:
- Main output registered: 70 kg
- By-product expected: 30% of 70kg = 21 kg (from BOM)
- Operator enters actual: "25 kg" (adjusted due to actual yield)
- System creates by-product LP: 25 kg (uses entered qty, not calculated)

No consumption from reserved LPs happens for by-products
- Operator enters qty → By-product LP created → Done
- By-products do NOT consume reserved material LPs
```

### AC-4.14.4: By-Product LP Creation

**Then** by-product LP created same as main output:

```
By-product LP:
├─ product: the by-product product (from wo_materials)
├─ batch_number: from WO.wo_number
├─ expiry_date: calculated from product.shelf_life
├─ quantity: entered qty (from AC-4.14.3)
├─ status: 'available'
├─ location_id: from dialog (default from line)
├─ qa_status: from dialog (if required)
└─ created_by_user_id: operator

Storage location: Same as main output LP (determined by production line default)
```

### AC-4.14.5: By-Product Genealogy Linking

**Given** by-product LP created

**When** genealogy records created

**Then** by-product LP links to same parent LPs as main output (via Story 4.19):

```
Example Genealogy:
Main output flow consumed: LP-A (70kg) + LP-B (20kg)
├─ Genealogy: LP-A → Output-1
└─ Genealogy: LP-B → Output-1

By-product (scrap/trim):
├─ By-product LP: Scrap-LP-1 (25 kg)
├─ Genealogy created: LP-A → Scrap-LP-1 (10kg)
├─ Genealogy created: LP-B → Scrap-LP-1 (15kg)

OR if operator selects primary source:
├─ Genealogy created: LP-A → Scrap-LP-1 (25kg)
│  (marking LP-A as primary source for by-product)

Question for Implementation:
- Option A: Create genealogy to ALL parent LPs (shared parent)
- Option B: Operator selects primary parent LP
Implementation: Start with Option A (simpler), track parentage to all consumed LPs
```

### AC-4.14.6: Skip By-Products Option

**Given** by-product dialog shown

**When** operator clicks [Skip This] or [Skip All]

**Then** by-product not registered:

```
[Skip This]:
- Current by-product skipped
- Move to next by-product (if exists)
- WO can complete without this by-product

[Skip All]:
- All remaining by-products skipped
- Return to WO detail immediately
- WO can complete without any by-products

Note: WO does NOT require by-products to be registered
Operator can choose to register none, some, or all by-products
```

### AC-4.14.7: Expected Qty Calculation (For Reference)

**Then** system displays expected by-product qty based on BOM:

```
Calculation:
expected_qty = main_output_qty × by_product_yield_percent / 100

Example:
- Main output registered: 100 kg
- BOM by-product (scrap) yield: 10%
- Expected by-product: 100 × 10% = 10 kg (shown as reference)

Display:
├─ "Expected: 10 kg" (informational, not enforced)
├─ "Enter actual qty: [input field]"
└─ Operator can enter any qty, expected is just reference

Purpose: Help operator estimate, not enforce
```

### AC-4.14.8: Error Handling

**When** qty <= 0
**Then** validation error: "By-product quantity must be > 0"

**When** WO not in progress
**Then** error: "WO not in progress, cannot register by-products"

**When** by-product registration API called with invalid by-product_id
**Then** 400 error: "By-product not found in WO"

### AC-4.14.9: Multiple By-Products Sequential Registration

**Given** WO has multiple by-products (example: main product + scrap + trim)

**When** operator completes main output registration

**Then** by-products registered one at a time:

```
Example Flow:
WO: 200kg main product with 2 by-products
├─ By-product-1: Scrap (expected 10%)
├─ By-product-2: Trim (expected 5%)

Process:
1. Main output (200kg) registered
   └─ Sequential consumption from LP-A, LP-B, LP-C
2. Dialog shows "By-Product-1: Scrap"
   ├─ Operator enters: 22 kg
   ├─ Creates LP: Scrap-LP-1 (22kg)
   └─ Genealogy: LP-A, LP-B, LP-C → Scrap-LP-1
3. Dialog shows "By-Product-2: Trim"
   ├─ Operator enters: 8 kg
   ├─ Creates LP: Trim-LP-1 (8kg)
   └─ Genealogy: LP-A, LP-B, LP-C → Trim-LP-1
4. No more by-products, return to WO detail
```

### AC-4.14.10: By-Product Registration API Endpoint

**Then** POST `/api/production/work-orders/:id/by-products` with:

```json
{
  "by_product_id": "UUID",           // from wo_materials
  "qty": 25,                         // operator-entered quantity
  "qa_status": "pass|fail|pending",  // optional, if required
  "location_id": "UUID",             // optional, default from line
  "notes": "Operator notes"          // optional
}
```

Response: Created by-product LP object

### AC-4.14.11: Prerequisites & Dependencies

**Requires:**
- Story 4.12: Main Output Registration (triggers by-product prompt via AC 4.12.9)
- Story 4.19: Genealogy Recording (genealogy linking to parent LPs)
- Story 3.10: WO BOM Snapshot with by-products (wo_materials with product_type='by-product')

**Used by:**
- Story 4.16: Multiple Outputs per WO (multiple outputs → multiple by-product registrations)

---

## Technical Implementation

### By-Product Registration Flow (Not Automatic Consumption)

Key architectural difference from main output:

```
Main Output (Story 4.12):
1. User enters qty
2. System calculates consumption via sequential allocation (4.12a)
3. Consumes from reserved LP inventory
4. Creates output LP + genealogy

By-Product (Story 4.14):
1. User enters qty directly
2. No consumption from reserved LPs
3. Creates by-product LP with entered qty
4. Links genealogy to same parent LPs as main output
5. NO sequential allocation involved
```

### Database Schema (No changes needed)

By-products use existing tables:
- **license_plates**: By-product LPs created same as main output
- **lp_genealogy**: Links by-product LP to parent LPs
- **wo_materials**: By-products identified by product_type='by-product'

No new tables required for by-product tracking.

### Genealogy Linking Strategy

For by-product genealogy (AC-4.14.5), recommend:

**Option A (Simpler - Recommended):**
```typescript
// When by-product registered, link to ALL consumed LPs from main output
const mainOutputGenealogyRecords = await genealogyService.getBackwardTrace(main_output_lp_id);
// For each parent LP that contributed to main output:
for (const parentLp of mainOutputGenealogyRecords) {
  // Create genealogy: parent → by-product LP
  await genealogyService.recordConsumption(
    parent_lp_id: parentLp.parent_lp_id,
    child_lp_id: by_product_lp_id,
    wo_id: wo_id,
    consumed_qty: by_product_qty,
    user_id: operator_id
  );
}
```

**Option B (Operator Choice - Future):**
- Operator selects primary parent LP for by-product
- Create genealogy to only selected LP
- More control but requires additional dialog

---

## Testing Strategy

### Unit Tests

- Expected qty calculation: BOM yield % applied correctly
- Qty validation: positive number, non-empty
- By-product detection: correctly identifies by-products from wo_materials

### Integration Tests

- By-product prompt shown after main output registration
- Operator can register single by-product with genealogy
- Operator can skip all by-products and complete WO
- Multiple by-products registered sequentially
- Each by-product LP created with correct genealogy links

### E2E Tests

1. Main output (70kg) registered
   - Sequential consumption: LP-A (50kg) + LP-B (20kg)
   - Output LP created, genealogy linked to LP-A and LP-B
2. By-product dialog shown
3. Operator registers Scrap (22kg)
   - Scrap LP created
   - Genealogy: LP-A → Scrap-LP (11kg), LP-B → Scrap-LP (11kg)
4. Next by-product dialog (if exists)
5. Operator clicks [Skip All]
6. Return to WO detail
7. Verify: Main output + 1 by-product registered, genealogy complete

---

## Acceptance Criteria Checklist

- ✅ By-product registration triggered after main output (AC 4.12.9)
- ✅ Manual operator entry of by-product qty (not automatic consumption)
- ✅ By-product LP created with entered qty
- ✅ Expected qty shown from BOM yield % (for reference only)
- ✅ Sequential prompting for multiple by-products
- ✅ Skip option (individual or all)
- ✅ Genealogy linking to parent LPs from main output
- ✅ API endpoint POST /api/production/work-orders/:id/by-products
- ✅ Error handling (qty validation, WO status checks)
- ✅ By-products optional (WO can complete without any)

---

## Dependencies

**Requires:**
- Story 4.12: Output Registration (main output, by-product prompt trigger)
- Story 4.19: Genealogy Recording (genealogy service for linking)
- Story 3.10: WO BOM Snapshot (by-products defined in wo_materials)

**Used by:**
- Story 4.16: Multiple Outputs per WO (multiple main outputs, multiple by-product flows)

---

## Notes

- **Manual Entry**: By-products registered manually by operator, not automatically consumed
- **No Sequential Consumption**: By-product registration does NOT use sequential LP allocation from 4.12a
- **Optional**: By-products are optional - WO can complete without registering any by-products
- **Genealogy**: By-product LP genealogy links to same parent LPs as main output
- **BOM Yield %**: Used for expected qty reference only, operator can override
- **Compliance**: All genealogy records created for traceability, even for skipped by-products (if none registered, no genealogy)

---

## Status

- **Created:** 2025-11-27
- **Current Status:** Refactored (AC clarified: manual entry, not automatic consumption; by-product prompt moved to AC 4.12.9)
