# Story 4.12b: Over-Production Handling

**Epic:** 4 - Production Execution | **Status:** To Be Designed | **Story Points:** 2 | **Effort:** 2-3 hours

---

## User Story

> As an **Operator**, I want to handle over-production scenarios where output exceeds reserved materials, so that I can accurately track genealogy even when producing more than planned.

---

## Acceptance Criteria

### AC 4.12b.1: Over-Production Detection and Operator Selection

**Given** output registration would consume all reserved LPs and additional output remains

**When** operator registers output that exceeds available reserved materials

**Then** system shows material source selection dialog:

```
Example Scenario:
- WO: 200 kg planned
- Reserved: LP-A (80kg) + LP-B (40kg) + LP-C (80kg) = 200 kg total
- Outputs 1-3 have consumed all 200 kg
- Output-4: 30 kg registered (over-production)

Dialog shown:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âš ï¸  Over-Production Detected                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Registered output: 30 kg                     â”‚
â”‚ All reserved materials consumed.             â”‚
â”‚ This output (30 kg) is OVER-PRODUCTION      â”‚
â”‚                                              â”‚
â”‚ Which reserved LP is source for 30 kg?      â”‚
â”‚                                              â”‚
â”‚ [ ] LP-A (80 kg total, fully consumed)     â”‚
â”‚ [ ] LP-B (40 kg total, fully consumed)     â”‚
â”‚ [ ] LP-C (80 kg total, fully consumed)     â”‚
â”‚                                              â”‚
â”‚ Selected LP will be marked as parent to     â”‚
â”‚ over-production output (genealogy)          â”‚
â”‚                                              â”‚
â”‚ [ Cancel ]  [ Confirm Selection ]           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### AC 4.12b.2: Operator Selection of Parent LP(s) for Over-Production

**Given** over-production dialog shown

**When** operator selects parent LP

**Then** system records genealogy relationship:

```
Operator selects: LP-A

Backend creates:
â”Œâ”€ lp_genealogy record:
â”‚  parent_lp_id: LP-A
â”‚  child_lp_id: Output-4 LP
â”‚  operation_type: 'consume'
â”‚  consumed_qty: 30 kg
â”‚  wo_id: WO-1
â”‚  is_over_production: true
â”‚  produced_at: timestamp
â”‚
â””â”€ wo_consumption record:
   wo_id: WO-1
   material_id: MAT-1 (Flour)
   lp_id: LP-A
   qty: 30 kg
   output_id: Output-4
   is_over_production: true
```

### AC 4.12b.3: All Reserved LPs as Shared Parents

**Given** over-production output created

**When** output genealogy marked for multi-output tracing

**Then** ALL reserved LPs for this material marked as contributors:

```
Optional Extension: System can track that Output-4 (30kg over-production)
has potential contribution from ALL LPs because:
- LP-A contributed 70 kg to Output-1
- LP-B contributed 40 kg to Outputs 1-2
- LP-C contributed 80 kg to Output-3
- Output-4 could theoretically use material from any/all

Approach A (Simple): Use operator-selected LP only
Approach B (Complete): Create genealogy to ALL LPs that were used for this WO

Implementation: Use Approach A (operator selection), but comment in code
that if complete traceability needed, all LPs could be marked.
```

### AC 4.12b.4: Over-Production Tracking in WO

**Given** over-production output registered

**When** WO detail viewed

**Then** show over-production indicator:

```
WO Detail Card:
â”œâ”€ Planned Output: 200 kg
â”œâ”€ Actual Output: 230 kg (3 outputs 70+20+80 + 1 over-production 30)
â”œâ”€ Status: ðŸ”´ OVER-PRODUCTION
â”œâ”€ Reserved Consumed: 200 kg âœ…
â””â”€ Over-Production: 30 kg âš ï¸

Over-Production Summary:
â”œâ”€ Output-1: 70 kg âœ…
â”œâ”€ Output-2: 20 kg âœ…
â”œâ”€ Output-3: 80 kg âœ…
â””â”€ Output-4: 30 kg ðŸ”´ (Over-Production from LP-A)
```

### AC 4.12b.5: BOM Integration - Scrap as Over-Production

**Given** WO BOM with scrap percentage

**When** operator completes WO without registering by-products for scrap

**Then** over-production handled as scrap loss:

```
Example BOM Calculation:
- WO planned: 10 boxes Ã— 10 kg = 100 kg output
- Material required: 1 kg per 1 kg output
- Scrap %: 10%
- Expected consumed: 100 kg output + 10 kg scrap = 110 kg

Operator registered outputs: 110 kg total
- All 110 kg is consumed (no scrap by-product created)

In WO:
â”œâ”€ Planned: 100 kg
â”œâ”€ Actual Output: 110 kg (exactly matching consumption)
â”œâ”€ Status: âœ… COMPLETE (no true over-production)
â”œâ”€ Scrap: Not registered as by-product
â””â”€ Note: Scrap consumed but not created as LP

Scenario B (True Over-Production):
- Operator registers: 120 kg output
- All 110 kg from reserved consumed
- 10 kg is over-production
- System prompts: "Over-production 10 kg. Which LP source?"
- Operator selects LP-C
- Output-4 genealogy: LP-C â†’ Output-4 (over-production)
```

### AC 4.12b.6: Over-Production in Output History

**Given** WO with over-production completed

**When** viewing output history

**Then** show over-production flag on each output:

```
Output History Table:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Output # â”‚ Qty   â”‚ Operator â”‚ Status       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1        â”‚ 70 kg â”‚ John     â”‚ âœ… Normal   â”‚
â”‚ 2        â”‚ 20 kg â”‚ John     â”‚ âœ… Normal   â”‚
â”‚ 3        â”‚ 80 kg â”‚ Mary     â”‚ âœ… Normal   â”‚
â”‚ 4        â”‚ 30 kg â”‚ John     â”‚ ðŸ”´ Over-Prod â”‚
â”‚          â”‚       â”‚          â”‚  (from LP-A) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### AC 4.12b.7: Prevent False Over-Production (Within Scrap %

)

**Given** WO with scrap % defined in BOM

**When** total output = planned + scrap

**Then** NOT marked as over-production:

```
WO:
â”œâ”€ Planned: 100 kg
â”œâ”€ Scrap %: 10%
â”œâ”€ Reserved: 110 kg

Outputs registered: 110 kg exactly
â”œâ”€ Output-1: 70 kg
â”œâ”€ Output-2: 20 kg
â”œâ”€ Output-3: 20 kg
â””â”€ Total: 110 kg

System determines: This is NOT over-production (within scrap %)
Status: âœ… Complete (scrap consumed)
```

### AC 4.12b.8: Error Handling

**When** over-production dialog shown but no LP selected

**Then** 400 error: "Must select parent LP for over-production"

**When** operator cancels over-production dialog

**Then** 400 error: "Over-production requires parent LP selection to proceed"

**When** WO already closed/completed

**Then** prevent any new outputs (including over-production)

### AC 4.12b.9: API Endpoint Integration

**Then** POST `/api/production/work-orders/:id/outputs` with optional:

```json
{
  "qty": 30,
  "qa_status": "pass",
  "location_id": "uuid",
  "is_over_production": true,
  "over_production_parent_lp_id": "LP-A",
  "notes": "Operator error - produced extra"
}
```

Backend validation:
- If `is_over_production=true`: `over_production_parent_lp_id` required
- If `is_over_production=false`: ignore parent_lp_id field

### AC 4.12b.10: Genealogy for Over-Production

**Then** genealogy record includes over-production flag:

```sql
INSERT INTO lp_genealogy (
  parent_lp_id,
  child_lp_id,
  operation_type,
  consumed_qty,
  is_over_production,  -- true
  over_production_source, -- 'operator_selected'
  wo_id
) VALUES (...);
```

---

## Technical Implementation

### State Machine for Over-Production

```
[Output Registration with Over-Production Check]
    â†“
[Sequential Consumption (AC 4.12a) Exhausts All Reserved LPs]
    â†“
[Remaining Output Qty > 0?]
    â”œâ”€ NO â†’ Output registration complete (AC 4.12)
    â””â”€ YES â†’ Over-Production Detected
            â†“
        [Show Material Source Selection Dialog]
            â”œâ”€ Display all reserved LPs
            â”œâ”€ Operator selects parent LP
            â””â”€ Confirm selection
            â†“
        [Create Over-Production Genealogy]
            â”œâ”€ lp_genealogy with is_over_production=true
            â”œâ”€ Parent LP: operator-selected
            â”œâ”€ Child LP: new output LP
            â””â”€ consumed_qty: remaining output qty
            â†“
        [Register Output with Over-Production Flag]
            â”œâ”€ production_outputs.is_over_production = true
            â”œâ”€ production_outputs.over_production_parent_lp_id = selected_lp
            â””â”€ Create wo_consumption record
            â†“
        [Update WO Over-Production Status]
            â”œâ”€ work_orders.output_qty += qty
            â”œâ”€ work_orders.is_over_produced = true
            â””â”€ work_orders.over_production_qty += qty
            â†“
        [Output Registration Complete - Over-Production Handled]
```

### Database Schema

Add to `production_outputs` table:
```sql
ALTER TABLE production_outputs ADD COLUMN IF NOT EXISTS is_over_production BOOLEAN DEFAULT false;
ALTER TABLE production_outputs ADD COLUMN IF NOT EXISTS over_production_parent_lp_id UUID REFERENCES license_plates(id);
```

Add to `work_orders` table:
```sql
ALTER TABLE work_orders ADD COLUMN IF NOT EXISTS is_over_produced BOOLEAN DEFAULT false;
ALTER TABLE work_orders ADD COLUMN IF NOT EXISTS over_production_qty DECIMAL(15,4) DEFAULT 0;
```

Add to `lp_genealogy` table:
```sql
ALTER TABLE lp_genealogy ADD COLUMN IF NOT EXISTS is_over_production BOOLEAN DEFAULT false;
ALTER TABLE lp_genealogy ADD COLUMN IF NOT EXISTS over_production_source VARCHAR(50); -- 'operator_selected'
```

---

## Testing Strategy

### Unit Tests

- Over-production detection: identifies when output > reserved
- Parent LP selection: only reserved LPs shown
- Genealogy creation: over-production flag set correctly

### Integration Tests

- Full over-production flow: outputs 1-3 consume all reserved, output-4 triggers over-production
- Operator selects parent LP: genealogy created with correct parent
- WO status updated: is_over_produced=true, over_production_qty tracked

### E2E Tests

1. Register Output-1 (70kg) - normal
2. Register Output-2 (20kg) - normal
3. Register Output-3 (80kg) - normal (all reserved consumed)
4. Register Output-4 (30kg) - over-production dialog shown
5. Operator selects LP-A as parent
6. Output-4 registered
7. Verify genealogy: LP-A â†’ Output-4, is_over_production=true
8. Verify WO status: is_over_produced=true, over_production_qty=30

---

## Acceptance Criteria Checklist

- âœ… Over-production detection when remaining output after all reserved consumed
- âœ… Material source selection dialog shows all reserved LPs
- âœ… Operator selects parent LP for over-production
- âœ… Genealogy created with is_over_production flag
- âœ… WO tracks over-production status and quantity
- âœ… Output history shows over-production flag
- âœ… Within scrap % NOT marked as over-production
- âœ… Error handling for missing parent LP selection
- âœ… API endpoint accepts over-production parameters

---

## Dependencies

**Requires:**
- Story 4.12a: Output-Driven Sequential Consumption (uses allocation algorithm)
- Story 4.12: Output Registration (parent story)

**Used by:**
- Story 4.16: Multiple Outputs per WO (uses over-production logic)

---

## Notes

- Over-production is **operator-selected** parent LP, not automatic
- Genealogy maintains full traceability even for over-production
- Over-production can be legitimate (process improvements, estimation errors)
- BOM scrap % helps distinguish scrap loss from true over-production
- Operator responsible for accurate parent LP selection (audit trail preserved)
