# Story 4.12: Output Registration (Desktop)

**Epic:** 4 - Production Execution | **Status:** Done | **Priority:** P0 | **Story Points:** 2 | **Effort:** 1 day

## User Story

**As an** Operator
**I want** to register production output
**So that** finished goods are tracked

## Acceptance Criteria

### AC-4.12.1: Main Output Registration Modal
**Given** WO is In Progress
**When** clicking "Register Output"
**Then** modal opens with fields for **main output only**: quantity (required), qa_status (if required), location_id (default from line), notes
- **Note**: By-product registration is separate (Story 4.14), comes AFTER main output

### AC-4.12.2: Output LP Creation
**When** confirming
**Then** output LP created:
- product from WO
- batch_number from WO.wo_number
- expiry_date calculated from product.shelf_life
- status = 'available'
- quantity = entered value

### AC-4.12.3: Automatic Material Consumption (via Story 4.12a)
**Then** system automatically consumes reserved LPs using sequential allocation algorithm:

**See Story 4.12a** (Technical Foundation) for complete algorithm:
- Sequential LP consumption tracking
- Partial LP consumption across multiple outputs
- Over-consumption detection and warning
- Consume whole LP enforcement (Story 4.9)

**Result**: wo_consumption records created automatically, genealogy created (Story 4.19)

### AC-4.12.4: WO Output Tracking & Genealogy Update
**Then**:
- **Output tracking**: work_orders.output_qty += registered_qty
- **Genealogy linking** (Story 4.19 integration):
  - Update consumed lp_genealogy records (from AC-4.12.3) by setting:
    - child_lp_id = output LP (now that output LP exists)
    - produced_at = current timestamp
    - consumed_qty = actual qty consumed per LP
  - Result: Each consumed input LP (parent) now links to this output LP (child)

### AC-4.12.5: Progress Tracking
**Then** Cumulative output tracked, progress = output_qty / planned_qty × 100%

### AC-4.12.6: QA Status Recording
**Given** qa_status required in Settings
**When** confirming output
**Then** license_plates.qa_status set to entered value

### AC-4.12.7: API Endpoint
**Then** POST /api/production/work-orders/:id/outputs with {qty, qa_status, location_id, notes}

### AC-4.12.8: Error Handling
**When** qty <= 0
**Then** 400 error: "Output quantity must be > 0"

**When** WO not in progress
**Then** 400 error: "WO not in progress"

**When** over-production (output_qty > total_reserved_qty) AND allow_over_consumption=false
**Then** warn: "Output would consume all reserved materials. Continue?" (proceed if confirm)

### AC-4.12.9: By-Product Registration Prompting (After Main Output)
**Given** main output registered successfully

**When** output registration completes

**Then** system checks if WO has by-products defined in BOM:

```
If by-products exist (from wo_materials):
  ├─ Show by-product registration dialog
  ├─ Each by-product shows:
  │  ├─ Product name
  │  ├─ Expected qty (calculated from yield %)
  │  ├─ Input field for actual qty
  │  └─ [Register] button per by-product
  ├─ Dialog flows through each by-product sequentially
  └─ Operator can [Skip All] or skip individual by-products

If no by-products:
  └─ Return to WO detail
```

**See Story 4.14** (By-Product Registration) for complete by-product flow

**Note**: Operator can skip by-product registration entirely. WO completes without by-products if operator chooses.

### AC-4.12.10: Prerequisites
**Then** Requires:
- Story 4.7: Material Reservation (reserved LPs)
- Story 4.12a: Output-Driven Sequential Consumption (sequential allocation algorithm)
- Story 4.12b: Over-Production Handling (over-production material source selection)
- Story 4.19: Genealogy Recording (genealogy creation)

## Tasks / Subtasks

- [ ] Task 1: Create production_outputs table
- [ ] Task 2: OutputService implementation
- [ ] Task 3: Output registration modal
- [ ] Task 4: LP auto-generation logic
- [ ] Task 5: Genealogy integration
- [ ] Task 6: Tests

## Dependencies

**Requires:**
- Story 4.7: Material Consumption & Reservation (reserved LPs)
- Story 4.12a: Output-Driven Sequential Consumption (allocation algorithm)
- Story 4.12b: Over-Production Handling (over-production material selection)
- Story 4.19: Genealogy Recording (genealogy creation)

**Enables:**
- Story 4.13: Output Registration (Scanner) - uses same API
- Story 4.14: By-Product Registration - triggered after 4.12
- Story 4.16: Multiple Outputs per WO - uses sequential allocation

## Acceptance Criteria Checklist

- ✅ Main output registration modal with qty, qa_status, location
- ✅ Output LP creation (product, batch_number, expiry, status=available)
- ✅ Automatic material consumption via Story 4.12a
- ✅ WO output tracking and progress calculation
- ✅ Over-consumption warning with operator confirmation
- ✅ By-product prompting after main output registered
- ✅ API endpoint POST /api/production/work-orders/:id/outputs
- ✅ Error handling (qty validation, WO status check)
- ✅ QA status recording
- ✅ Over-consumption handling via Story 4.12b

## Status

- **Created:** 2025-11-27
- **Updated:** 2025-12-03
- **Current Status:** Done
- **Completed:** 2025-12-03

## Implementation Notes (2025-12-03)

### Files Implemented

**Database (Migration 041):**
- `lib/supabase/migrations/041_create_production_outputs.sql`
  - Extended production_outputs table with output_number, registered_by_user_id, registered_at
  - Added output_id, is_over_production to wo_consumption
  - Added is_over_produced, over_production_qty to work_orders
  - Added is_over_production, over_production_source to lp_genealogy

**API:**
- `app/api/production/work-orders/[id]/outputs/route.ts` - POST/GET outputs
- `app/api/production/work-orders/[id]/outputs/preview/route.ts` - Preview allocation

**Services:**
- `lib/services/output-registration-service.ts`
  - `calculateConsumptionAllocation()` - Sequential LP allocation (4.12a)
  - `registerOutput()` - Output registration with consumption
  - `getWOOutputs()` - Get output history
- `lib/services/genealogy-service.ts`
  - `createOutputGenealogy()` - Link consumed LPs to output LP

**Frontend:**
- `components/production/OutputRegistrationModal.tsx`
  - Main output form (qty, QA status, notes)
  - Allocation preview with debounce
  - Over-production LP selection dialog (4.12b)

**Tests:**
- `e2e/story-4.12-output-registration.spec.ts`

### AC Coverage

| AC# | Description | Evidence |
|-----|-------------|----------|
| AC-4.12.1 | Output modal | `OutputRegistrationModal.tsx` |
| AC-4.12.2 | LP creation | `output-registration-service.ts:264-285` |
| AC-4.12.3 | Auto consumption | `output-registration-service.ts:323-399` |
| AC-4.12.4 | WO tracking | `output-registration-service.ts:434-449` |
| AC-4.12.5 | Progress tracking | `outputs/route.ts:202-215` |
| AC-4.12.6 | QA status | `OutputRegistrationModal.tsx:262-277` |
| AC-4.12.7 | API endpoint | `outputs/route.ts:17-143` |
| AC-4.12.8 | Error handling | `outputs/route.ts:63-68, service:171-189` |
| AC-4.12.9 | By-product prompt | Ready for Story 4.14 |
| AC-4.12.10 | Prerequisites | All dependencies met |

### Stories 4.12a and 4.12b

**4.12a: Sequential Consumption Algorithm**
- Implemented in `calculateConsumptionAllocation()`
- Sequential LP allocation by reservation order
- Partial LP consumption tracking
- Over-consumption detection

**4.12b: Over-Production Handling**
- Parent LP selection dialog in modal
- Genealogy with is_over_production flag
- WO over_production_qty tracking
