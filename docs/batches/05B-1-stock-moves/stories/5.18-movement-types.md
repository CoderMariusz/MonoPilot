# Story 5.18: Movement Types

**ID:** 5.18
**Batch:** 5B-1 (Stock Moves)
**Story Points:** 3
**Effort:** 3-4 hours
**Status:** Todo

---

## User Story

> As a **Warehouse Manager**, I want to categorize movements, so that I can analyze flow.

---

## Acceptance Criteria

### AC 1: Movement Type Selection
- **Given** moving LP
- **When** opening move modal
- **Then** movement_type dropdown shows options:
  - receiving
  - put_away
  - pick
  - transfer
  - adjustment

### AC 2: Movement Type Descriptions
- **Given** selecting movement_type
- **When** choosing option
- **Then** show description/help text:
  - **receiving**: LP arriving from supplier (dock → storage)
  - **put_away**: LP placed in storage after receiving
  - **pick**: LP allocated for WO or shipment (storage → production/shipping)
  - **transfer**: LP moved between storage locations (reorganization)
  - **adjustment**: Quantity correction (damage, sample, recount)

### AC 3: Type-Specific Validation
- **Given** selecting movement_type
- **When** choosing type
- **Then** validate constraints per type:
  - **receiving**: From = receiving dock, To = storage
  - **put_away**: From = receiving, To = storage (automatic on GRN)
  - **pick**: From = storage, To = production/shipping
  - **transfer**: From = storage, To = storage (same warehouse)
  - **adjustment**: Any location (qty correction)

### AC 4: Type-Specific Fields
- **Given** selecting specific movement_type
- **When** type affects required fields
- **Then**:
  - **adjustment**: Reason field REQUIRED (explain correction)
  - **pick**: Optional: WO number or TO number (link to source)
  - **transfer**: Reason optional (reorganization note)
  - **receiving**: Auto-filled from GRN
  - **put_away**: Auto-filled from GRN

### AC 5: Movement Type Reporting
- **Given** viewing movement audit trail
- **When** filtering or reporting
- **Then** breakdown by movement type shows:
  - Receiving: 45 movements (inbound)
  - Put-away: 128 movements (storage placement)
  - Pick: 234 movements (outbound for WO/TO)
  - Transfer: 67 movements (internal reorganization)
  - Adjustment: 12 movements (corrections)

### AC 6: Auto-Assignment
- **Given** GRN created during receiving
- **When** LP created and initially placed
- **Then** stock_moves auto-created with:
  - movement_type = 'put_away' (automatic)
  - from_location = receiving dock
  - to_location = default storage location per warehouse
  - reason = "Auto-placed on receipt"

### AC 7: Movement Type Statistics
- **Given** warehouse manager viewing dashboard
- **When** loading movement statistics
- **Then** show metrics per type:
  - Total movements by type (pie chart)
  - Trend over time (receiving ↑, pick ↑, transfer →)
  - Cost per movement type (e.g., put-away labor cost)
  - Average time per movement (put-away: 2 min, pick: 1 min)

---

## Technical Tasks

### Backend

- [ ] Define movement_type enum in database
  ```sql
  CREATE TYPE movement_type_enum AS ENUM (
    'receiving',
    'put_away',
    'pick',
    'transfer',
    'adjustment'
  );
  ALTER TABLE stock_moves ADD COLUMN movement_type movement_type_enum;
  ```

- [ ] Create movement_type validation logic
  - Validate enum value
  - Enforce type-specific constraints (from/to location types)
  - Enforce required fields per type

- [ ] Auto-assign movement_type in GRN endpoint
  - When LP created during receiving: auto-set movement_type = 'put_away'
  - Set from_location = receiving dock, to_location = default storage
  - Create stock_moves record automatically

- [ ] Create movement statistics endpoints:
  - `GET /api/warehouse/stock-moves/stats?date_from=...&date_to=...`
    - Return: breakdown by type, trend data, cost per type
  - `GET /api/warehouse/stock-moves/stats/by-type`
    - Return: detailed stats per movement type

### Database

- [ ] Add stock_moves column: movement_type (enum)
- [ ] Add index on movement_type for efficient filtering
- [ ] Verify constraints per type work correctly

### Frontend

- [ ] Update MoveLocationModal movement_type selector
  - Radio buttons or dropdown
  - Show description for each type
  - Display icon per type (receiving icon, put-away icon, etc)
  - Highlight "pick" and "transfer" as most common

- [ ] Add type-specific form fields
  - adjustment: Show reason field as REQUIRED (red asterisk)
  - pick: Optional WO/TO number lookup
  - transfer: Optional reason (collapsed by default)

- [ ] Create movement type dashboard widget
  - Pie chart: breakdown by type
  - Bar chart: trend (last 30 days)
  - Table: stats per type (count, %, avg time)

- [ ] Add movement type filter to audit trail
  - Checkboxes: receiving, put_away, pick, transfer, adjustment
  - Multi-select (default: all selected)

---

## Testing

### Unit Tests
- Type validation: valid enum values accepted
- Type validation: invalid values rejected
- Constraint validation: pick with wrong from_location → error

### Integration Tests
- POST /api/warehouse/stock-moves with movement_type='pick' validates pick constraints
- Auto-assignment during GRN: stock_moves created with movement_type='put_away'
- GET /api/warehouse/stock-moves/stats returns breakdown by type

### E2E Tests
- Move modal: Select different movement types, see descriptions
- Adjustment type: Reason field marked required, can't submit without
- GRN creation: Auto-assigned stock_move has movement_type='put_away'
- Audit trail: Filter by movement_type='pick' shows only pick movements
- Dashboard: Pie chart shows all 5 types with correct proportions

---

## Acceptance Criteria Checklist

- ✅ Movement type dropdown with 5 options
- ✅ Type-specific descriptions shown
- ✅ Type-specific validation enforced
- ✅ Type-specific required fields (adjustment: reason required)
- ✅ Type-specific link fields (pick: WO/TO optional)
- ✅ Breakdown by type in audit trail reporting
- ✅ Auto-assignment for GRN receiving
- ✅ Statistics dashboard per movement type

---

## Dependencies

**Requires:** Story 5.14 (LP Location Move), Story 5.11 (GRN Creation)

**Enables:** Story 5.35 (Inventory Count), Story 5.15 (Movement Audit Trail)

---

## Notes

- Movement types enable workflow-specific logic and reporting
- receiving/put_away are inbound flows
- pick/transfer are internal flows
- adjustment is correction flow
- Type taxonomy helps with KPI tracking (labor cost, throughput, etc)
- Auto-assignment on GRN simplifies user workflow (don't need to manually select type)
