# Story 5.18: Movement Types

**ID:** 5.18
**Batch:** 5B-1 (Stock Moves)
**Story Points:** 2
**Effort:** 2-3 hours
**Status:** Todo
**Updated**: Cleaned up - removed GRN auto-assignment (Story 5.11) and statistics (Story 5.15b)

---

## User Story

> As a **Warehouse Manager**, I want to categorize movements, so that I can analyze flow.

---

## Acceptance Criteria

### AC 1: Movement Type Selection
- **Given** moving LP
- **When** opening move modal
- **Then** movement_type dropdown shows options:
  - receiving
  - put_away
  - pick
  - transfer
  - adjustment

### AC 2: Movement Type Descriptions
- **Given** selecting movement_type
- **When** choosing option
- **Then** show description/help text:
  - **receiving**: LP arriving from supplier (dock → storage)
  - **put_away**: LP placed in storage after receiving
  - **pick**: LP allocated for WO or shipment (storage → production/shipping)
  - **transfer**: LP moved between storage locations (reorganization)
  - **adjustment**: Quantity correction (damage, sample, recount)

### AC 3: Type-Specific Validation
- **Given** selecting movement_type
- **When** choosing type
- **Then** validate constraints per type:
  - **receiving**: From = receiving dock, To = storage
  - **put_away**: From = receiving, To = storage (automatic on GRN)
  - **pick**: From = storage, To = production/shipping
  - **transfer**: From = storage, To = storage (same warehouse)
  - **adjustment**: Any location (qty correction)

### AC 4: Type-Specific Fields
- **Given** selecting specific movement_type
- **When** type affects required fields
- **Then**:
  - **adjustment**: Reason field REQUIRED (explain correction)
  - **pick**: Optional: WO number or TO number (link to source)
  - **transfer**: Reason optional (reorganization note)
  - **receiving**: Auto-filled from GRN
  - **put_away**: Auto-filled from GRN

### AC 5: Movement Type Reporting
- **Given** viewing movement audit trail
- **When** filtering or reporting
- **Then** breakdown by movement type shows:
  - Receiving: 45 movements (inbound)
  - Put-away: 128 movements (storage placement)
  - Pick: 234 movements (outbound for WO/TO)
  - Transfer: 67 movements (internal reorganization)
  - Adjustment: 12 movements (corrections)

### AC 6: Type-Specific Reason Field Requirements
- **Given** selecting specific movement_type
- **When** creating movement
- **Then** enforce type-specific field requirements:
  - **adjustment**: Reason field REQUIRED (must explain correction)
  - **pick**: Optional: WO number or TO number (for traceability)
  - **transfer**: Reason optional (reorganization note)
  - **put_away**: Auto-populated reason (no user input needed)

**Note**: Statistics dashboard is in Story 5.15b (Movement Audit Trail - Statistics & Reporting)

---

## Technical Tasks

### Backend

- [ ] Define movement_type enum in database
  ```sql
  CREATE TYPE movement_type_enum AS ENUM (
    'receiving',
    'put_away',
    'pick',
    'transfer',
    'adjustment'
  );
  ALTER TABLE stock_moves ADD COLUMN movement_type movement_type_enum;
  ```

- [ ] Create movement_type validation logic
  - Validate enum value
  - Enforce type-specific constraints (from/to location types)
  - Enforce required fields per type (adjustment: reason required, pick: optional WO/TO)

**Note**: GRN auto-assignment (put_away on receipt) is in Story 5.11 (GRN Creation)
**Note**: Movement statistics endpoints are in Story 5.15b (Audit Trail Statistics)

### Database

- [ ] Add stock_moves column: movement_type (enum)
- [ ] Add index on movement_type for efficient filtering
- [ ] Verify constraints per type work correctly

### Frontend

- [ ] Update MoveLocationModal movement_type selector
  - Radio buttons or dropdown
  - Show description for each type
  - Display icon per type (receiving icon, put-away icon, etc)
  - Highlight "pick" and "transfer" as most common

- [ ] Add type-specific form fields
  - adjustment: Show reason field as REQUIRED (red asterisk)
  - pick: Optional WO/TO number lookup
  - transfer: Optional reason (collapsed by default)

- [ ] Add movement type filter to audit trail
  - Checkboxes: receiving, put_away, pick, transfer, adjustment
  - Multi-select (default: all selected)

---

## Testing

### Unit Tests
- Type validation: valid enum values accepted
- Type validation: invalid values rejected
- Constraint validation: pick with wrong from_location → error

### Integration Tests
- POST /api/warehouse/stock-moves with movement_type='pick' validates pick constraints
- Auto-assignment during GRN: stock_moves created with movement_type='put_away'
- GET /api/warehouse/stock-moves/stats returns breakdown by type

### E2E Tests
- Move modal: Select different movement types, see descriptions
- Adjustment type: Reason field marked required, can't submit without
- GRN creation: Auto-assigned stock_move has movement_type='put_away'
- Audit trail: Filter by movement_type='pick' shows only pick movements
- Dashboard: Pie chart shows all 5 types with correct proportions

---

## Acceptance Criteria Checklist

- ✅ Movement type dropdown with 5 options
- ✅ Type-specific descriptions shown
- ✅ Type-specific validation enforced
- ✅ Type-specific required fields (adjustment: reason required)
- ✅ Type-specific link fields (pick: WO/TO optional)
- ✅ Breakdown by type in audit trail reporting
- ✅ Auto-assignment for GRN receiving
- ✅ Statistics dashboard per movement type

---

## Dependencies

**Requires:** Story 5.14 (LP Location Move), Story 5.11 (GRN Creation)

**Enables:** Story 5.35 (Inventory Count), Story 5.15 (Movement Audit Trail)

---

## Notes

- Movement types enable workflow-specific logic and reporting
- receiving/put_away are inbound flows
- pick/transfer are internal flows
- adjustment is correction flow
- Type taxonomy helps with KPI tracking (labor cost, throughput, etc)
- Auto-assignment on GRN simplifies user workflow (don't need to manually select type)
