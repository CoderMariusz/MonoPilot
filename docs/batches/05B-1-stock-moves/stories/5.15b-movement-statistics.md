# Story 5.15b: Movement Audit Trail - Statistics & Reporting

**ID:** 5.15b
**Batch:** 5B-1 (Stock Moves)
**Story Points:** 3
**Effort:** 3-4 hours
**Status:** Todo
**Predecessor:** Story 5.15a (Movement Audit Trail - List & Filters)

---

## User Story

> As a **Warehouse Manager**, I want to see movement statistics and trends, so that I can analyze inventory flow, identify bottlenecks, and measure warehouse productivity.

---

## Acceptance Criteria

### AC 1: Movement Statistics Dashboard
- **Given** Warehouse Manager navigates to /warehouse/stock-moves/statistics
- **When** page loads
- **Then** displays dashboard with:
  - Total movements count (all time or selected period)
  - Movements count by selected date range
  - Filter controls at top (same as 5.15a: date, type, user, location)

### AC 2: Breakdown by Movement Type
- **Given** viewing statistics dashboard
- **When** page loads with data
- **Then** show breakdown section with:
  - Pie chart: all 5 movement types with percentages
  - Table with columns: Type | Count | % | Avg Time Per Movement
  - Color-coded by type (receiving=blue, put_away=green, pick=orange, transfer=purple, adjustment=red)

### AC 3: Top Movers (Users)
- **Given** viewing statistics dashboard
- **When** data loaded
- **Then** show "Most Active Users" card:
  - Bar chart: Top 10 users by movement count
  - Table: User | Movements | % of Total
  - Hover shows user details (name, department, last activity)

### AC 4: Most Moved Locations
- **Given** viewing statistics dashboard
- **When** data loaded
- **Then** show "Most Moved Locations" card:
  - Bar chart: Top 10 locations (from or to)
  - Table: Location | Movements | In/Out ratio
  - Identifies bottleneck locations (high activity)

### AC 5: Trend Analysis
- **Given** selected date range
- **When** viewing trend section
- **Then** show trend chart:
  - Line chart: movements per day (last 30/60/90 days selected)
  - Breakdown by movement_type (stacked area or legend)
  - Shows: Daily total, breakdown by type, trend direction
  - Highlights: peaks, valleys, anomalies

### AC 6: Movement Type Statistics
- **Given** statistics dashboard loaded
- **When** viewing per-type metrics
- **Then** show table:
  - Type | Count | % | Avg Duration | Cost (if available)
  - **receiving**: LP receiving operations
  - **put_away**: Storage placement operations
  - **pick**: Allocation for WO/TO
  - **transfer**: Internal reorganizations
  - **adjustment**: Quantity corrections

### AC 7: Average LP Movements
- **Given** viewing statistics
- **When** page loads
- **Then** show metrics card:
  - Average movements per LP: "2.5 moves per LP"
  - Most moved LP number (link to detail)
  - Least moved LPs (unused inventory candidates)
  - Range: min → max movements per LP

### AC 8: Export & Reporting
- **Given** statistics dashboard
- **When** clicking "Export" button
- **Then** provide options:
  - Export to CSV: All statistics data (filtered by current params)
  - Export to PDF: Dashboard printable format
  - Email report: Schedule automated daily/weekly/monthly reports
  - Share report: Generate shareable link with timestamp

---

## Technical Tasks

### Backend

- [ ] Create `GET /api/warehouse/stock-moves/stats` endpoint
  - Query parameters: date_from, date_to, movement_type, user_id, location_id
  - Return: total_count, counts_by_type, top_users, top_locations, trends
  - Response includes: summary metrics and detailed breakdowns

- [ ] Create `GET /api/warehouse/stock-moves/stats/by-type` endpoint
  - Return: detailed stats per movement_type
  - Include: count, percentage, average duration, cost

- [ ] Create `GET /api/warehouse/stock-moves/stats/trends?days=30` endpoint
  - Return: daily movement counts and breakdown by type
  - Support: 7, 14, 30, 60, 90 day ranges
  - Include: daily array with date, total, and type breakdowns

- [ ] Create `GET /api/warehouse/stock-moves/stats/users` endpoint
  - Return: top 10 users by movement count
  - Include: user_id, name, count, last_activity

- [ ] Create `GET /api/warehouse/stock-moves/stats/locations` endpoint
  - Return: top 10 locations (from or to)
  - Include: location_id, code, name, in_count, out_count

- [ ] Create `GET /api/warehouse/stock-moves/stats/lp-movements` endpoint
  - Return: average, min, max movements per LP
  - Include: most_moved_lp, least_moved_lps (potential obsolete inventory)

- [ ] Create export endpoints:
  - `POST /api/warehouse/stock-moves/export/csv` - returns CSV file
  - `POST /api/warehouse/stock-moves/export/pdf` - returns PDF report
  - `POST /api/warehouse/stock-moves/schedule-report` - schedule recurring exports

### Database

- [ ] Verify indexes on stock_moves (from 5.15a):
  - idx_stock_moves_org_id
  - idx_stock_moves_movement_type
  - idx_stock_moves_moved_at
  - idx_stock_moves_moved_by_user_id

- [ ] Create materialized view (optional for performance):
  - mv_stock_moves_daily_summary
  - Pre-aggregated daily counts by type, user, location

### Frontend

- [ ] Create `/warehouse/stock-moves/statistics` page
  - Full-width dashboard layout
  - Filter bar at top (same as 5.15a)
  - Multiple cards for different stats sections

- [ ] Create StatisticsFilter component
  - Reuse from 5.15a or shared component
  - Date range, type, user, location filters
  - Apply button updates all charts

- [ ] Create MovementTypeBreakdown component
  - Pie chart: all 5 types with percentages
  - Table: detailed breakdown
  - Color-coded by type
  - Click type → drill down in 5.15a

- [ ] Create TopUsersChart component
  - Bar chart: top 10 users
  - Hover shows user info
  - Click user → filter 5.15a by user

- [ ] Create TopLocationsChart component
  - Bar chart: top 10 locations (in/out)
  - Color: in=green, out=red
  - Identify bottleneck locations

- [ ] Create TrendChart component
  - Line chart: daily movements trend
  - Dropdown: select 7/14/30/60/90 days
  - Stacked area (optional) by movement type
  - Show peaks/valleys

- [ ] Create StatisticsCards component
  - Card: Total movements count
  - Card: Average movements per LP
  - Card: Most moved LP (link to detail)
  - Card: Period summary

- [ ] Create ExportButton component
  - Dropdown: CSV, PDF, Email
  - Modal for email scheduling
  - Shows export status/confirmation

- [ ] Implement CSV export function
  - Format: all statistics with headers
  - Include: timestamp, filters applied, summary

- [ ] Implement PDF export function
  - Use library: jsPDF, html2pdf, or similar
  - Format: dashboard printable layout
  - Include: charts, tables, timestamp

---

## Testing

### Unit Tests
- Stats calculation: count, percentage, average correct
- Trend calculation: daily aggregation correct
- Filter logic: multi-filter combinations
- Export formatting: CSV, PDF well-formed

### Integration Tests
- GET /api/warehouse/stock-moves/stats with various filters
- GET /api/warehouse/stock-moves/stats/by-type
- GET /api/warehouse/stock-moves/stats/trends?days=30
- GET /api/warehouse/stock-moves/stats/users
- GET /api/warehouse/stock-moves/stats/locations
- POST export/csv → CSV file generated with correct data
- POST export/pdf → PDF generated and downloadable

### E2E Tests
- Open /warehouse/stock-moves/statistics
- Pie chart displays all 5 types with percentages
- Filter by date range → pie chart updates
- Filter by movement_type → only selected type shown
- Click user in chart → drill down to 5.15a with filter
- Export to CSV → file downloads with correct format
- Export to PDF → PDF opens with all charts
- Schedule email report → confirmation shown

---

## Acceptance Criteria Checklist

- ✅ Movement type breakdown displayed (pie chart)
- ✅ Top users chart with count and activity
- ✅ Top locations chart with in/out breakdown
- ✅ Trend analysis (7/14/30/60/90 days)
- ✅ Average LP movements metrics
- ✅ Statistics cards with summary numbers
- ✅ Export to CSV with filtered data
- ✅ Export to PDF with charts
- ✅ Email scheduling for recurring reports
- ✅ Filters work on all statistics (date, type, user, location)

---

## Dependencies

**Requires:** Story 5.15a (Movement Audit Trail - List & Filters)

**Enables:** None directly (reporting feature)

---

## Notes

- Statistics help identify warehouse efficiency and bottlenecks
- Trends show seasonal patterns and workload variations
- Cost metrics (if available) help with labor optimization
- Export/email enables management reporting and compliance
- Materialized view recommended if 100k+ movements and query performance issues
- Can be enhanced with ML for anomaly detection (future)
