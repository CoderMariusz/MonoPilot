# Story 5.15: Movement Audit Trail

**ID:** 5.15
**Batch:** 5B-1 (Stock Moves)
**Story Points:** 3
**Effort:** 3-4 hours
**Status:** Todo

---

## User Story

> As a **Warehouse Manager**, I want to see movement history, so that I can track where things went.

---

## Acceptance Criteria

### AC 1: Movement History Page
- **Given** Warehouse Manager navigates to /warehouse/stock-moves
- **When** page loads
- **Then** displays movement history table with columns:
  - LP number
  - From location (code and name)
  - To location (code and name)
  - Movement type (receiving, put_away, pick, transfer, adjustment)
  - Quantity and UoM
  - Timestamp (moved_at)
  - User name (who moved)
  - Reason (if provided)

### AC 2: Movement History Detail
- **Given** viewing stock-moves list
- **When** clicking on a movement row
- **Then** shows detail panel with:
  - Full movement record
  - LP detail link (can navigate to LP)
  - User information (name, department)
  - Timestamp (moved_at, moved_by_user_id)
  - Before/after state (from location → to location)

### AC 3: Filter by LP
- **Given** movement history page
- **When** searching or filtering by LP number
- **Then**:
  - Show only movements for that LP
  - Display chronological history (oldest → newest)
  - Show all locations LP visited

### AC 4: Filter by Location
- **Given** movement history page
- **When** filtering by location
- **Then**:
  - Show movements FROM or TO that location
  - Display all LPs that passed through that location
  - Useful for tracking inventory in specific bin

### AC 5: Filter by Date Range
- **Given** movement history page
- **When** selecting date range (from_date, to_date)
- **Then**:
  - Show only movements within date range
  - Default: last 7 days
  - Allow custom date picker

### AC 6: Filter by User
- **Given** movement history page
- **When** filtering by user
- **Then** show movements performed by that user
- Useful for: quality audits, user activity tracking

### AC 7: Filter by Movement Type
- **Given** movement history page
- **When** selecting movement type
- **Then** show only movements of that type:
  - receiving: LP arrivals
  - put_away: LP storage placement
  - pick: LP allocation to WO/TO
  - transfer: LP relocations
  - adjustment: qty corrections

### AC 8: Movement Statistics
- **Given** viewing movement history
- **When** page loads with filters applied
- **Then** show statistics:
  - Total movements (filtered): 347
  - Movement breakdown by type (pie chart or summary)
  - Most active users (top movers)
  - Most moved locations
  - Average movements per LP

---

## Technical Tasks

### Backend

- [ ] Create `GET /api/warehouse/stock-moves` endpoint (enhanced)
  - Query parameters:
    - lp_id (filter by specific LP)
    - location_id (filter by from or to location)
    - movement_type (filter by type)
    - user_id (filter by user)
    - date_from, date_to (date range)
    - limit, offset (pagination)
  - Return: Array of stock_moves with related data (locations, users, LPs)
  - Order by: moved_at DESC (newest first)

- [ ] Create movement summary endpoints:
  - `GET /api/warehouse/stock-moves/summary?date_from=...&date_to=...`
    - Return: Total count, breakdown by type, breakdown by user
  - `GET /api/warehouse/stock-moves/lp/:id/history`
    - Return: Full movement history for specific LP

- [ ] Implement filtering logic
  - Support multiple filters simultaneously
  - Efficient queries with proper joins and indexes

### Database

- [ ] Verify indexes on stock_moves:
  - idx_stock_moves_org_id
  - idx_stock_moves_lp_id
  - idx_stock_moves_from_location_id
  - idx_stock_moves_to_location_id
  - idx_stock_moves_movement_type
  - idx_stock_moves_moved_at
  - idx_stock_moves_moved_by_user_id
  - Composite index: (org_id, moved_at DESC) for efficient range queries

### Frontend

- [ ] Create `/warehouse/stock-moves` page
  - Table with sortable columns (click column header to sort)
  - Default sort: moved_at DESC (newest first)

- [ ] Create filter panel (left sidebar or top bar):
  - LP number search (auto-complete)
  - Location dropdown (multi-select)
  - Movement type checkboxes
  - User dropdown
  - Date range pickers (from_date, to_date, presets like "Last 7 days")

- [ ] Create movement detail panel:
  - Shows when row clicked
  - Can be modal or side panel
  - LP detail link
  - User info
  - Before/after state visualization (location icons with arrow)

- [ ] Add movement statistics section:
  - Total count card
  - Pie chart: breakdown by movement_type
  - Bar chart: movements by user (top 10)
  - Bar chart: movements by location (top 10)

- [ ] Add export feature:
  - "Export to CSV" button
  - Exports filtered results with all columns

---

## Testing

### Unit Tests
- Filtering logic: lp_id, location_id, date range
- Sorting: moved_at ascending/descending
- Pagination: limit, offset

### Integration Tests
- GET /api/warehouse/stock-moves with various filters
- GET /api/warehouse/stock-moves/lp/:id/history
- GET /api/warehouse/stock-moves/summary
- Verify: correct results, correct ordering, correct statistics

### E2E Tests
- Open /warehouse/stock-moves
- Filter by LP: LP-20250120-0001 → shows all movements of that LP
- Filter by location: WH-B-05 → shows all LPs moved to/from that location
- Filter by date: Last 7 days → shows only recent movements
- Filter by user: John Doe → shows only movements by John
- Sort by timestamp (ascending) → verify oldest first
- Click movement row → detail panel shows full record
- Export to CSV → download succeeds with filtered data

---

## Acceptance Criteria Checklist

- ✅ Movement history page shows all movements with LP, locations, timestamp, user
- ✅ Detail view available for each movement
- ✅ Filter by LP: shows movement history for that LP
- ✅ Filter by location: shows movements to/from that location
- ✅ Filter by date range: show movements within range
- ✅ Filter by user: show movements by that user
- ✅ Filter by movement type: show specific operation types
- ✅ Statistics dashboard: counts, breakdowns, top movers
- ✅ Multiple filters work together (AND logic)

---

## Dependencies

**Requires:** Story 5.14 (LP Location Move)

**Enables:** Story 5.16 (Partial Move), Story 5.35 (Inventory Count)

---

## Notes

- Stock_moves is **immutable audit trail** - no updates or deletes
- Indexes critical for performance (many rows over time)
- Statistics help warehouse managers understand inventory flow
- Export to CSV useful for reporting to executives
- User activity tracking helps with training and performance reviews
