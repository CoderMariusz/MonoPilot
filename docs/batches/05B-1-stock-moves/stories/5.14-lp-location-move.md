# Story 5.14: LP Location Move

**ID:** 5.14
**Batch:** 5B-1 (Stock Moves)
**Story Points:** 5
**Effort:** 5-6 hours
**Status:** Todo

---

## User Story

> As a **Warehouse user**, I want to move LPs between locations, so that inventory is in the right place.

---

## Acceptance Criteria

### AC 1: Move LP Modal
- **Given** viewing LP detail page
- **When** clicking "Move" button
- **Then** modal opens with:
  - Current LP number (read-only)
  - Current location (read-only)
  - Destination location dropdown (required)
  - Movement type selector (receiving, put_away, pick, transfer, adjustment)
  - Reason field (optional, text)
  - Move button

### AC 2: Location Validation
- **Given** selecting destination location
- **When** choosing location
- **Then** validate:
  - Location exists and is active
  - Location type allows as destination (not receiving dock)
  - Location belongs to same warehouse (optional: allow cross-warehouse via TO)
  - Location has available space/capacity (optional check)

### AC 3: Stock Move Record Creation
- **Given** valid move parameters
- **When** confirming move
- **Then** stock_moves record created with:
  - lp_id: LP being moved
  - from_location_id: Current location
  - to_location_id: Destination location
  - movement_type: Selected type (put_away, pick, transfer, adjustment)
  - quantity: Full LP quantity (or split qty if partial move - Story 5.16)
  - uom: LP's UOM (inherited from LP record, not changed on move)
  - reason: User-provided reason
  - moved_by_user_id: Current user
  - moved_at: Current timestamp

### AC 4: LP Location Update
- **Given** stock_moves record created
- **When** move completes
- **Then**:
  - LP.location_id updated to new location (source of truth for current location)
  - LP still marked as 'available' (unless picked for WO)
  - Stock_moves table is audit trail only (immutable history of movements)

### AC 5: Success Feedback
- **Given** move completes successfully
- **When** operation finishes
- **Then** show success message:
  - "LP-20250120-0001 moved from WH-A-01 to WH-B-05"
  - Show movement type: "Put-away"
  - Close modal and refresh LP list/detail

### AC 6: Movement Type Specific Logic (Delegates to Story 5.17)
- **Given** selecting different movement_type
- **When** choosing type
- **Then** system validates movement constraints via Story 5.17 validation:
  - **put_away**: Source is receiving/dock, destination must be storage
  - **pick**: Source is storage, destination must be production/shipping
  - **transfer**: Both source and destination must be storage
  - **adjustment**: Source and destination can be any (qty correction)
  - **receiving**: Not used in LP moves (used only for initial GRN placement in Story 5.11)

**Note**: For detailed validation rules and cross-warehouse checks, see Story 5.17 AC3.

---

## Technical Tasks

### Backend

- [ ] Create `POST /api/warehouse/stock-moves` endpoint
  - Accept: lp_id, to_location_id, movement_type, reason (optional)
  - Validate LP exists and belongs to org_id
  - Validate to_location exists, is active, allows destination type
  - Validate movement_type is valid enum
  - INSERT stock_moves record
  - UPDATE license_plates.location_id = to_location_id (optional, track via stock_moves)
  - Return: Stock_move record with from/to location details

- [ ] Create `POST /api/warehouse/license-plates/:id/move` endpoint (alternative)
  - Wrapper around stock-moves endpoint
  - Accept: to_location_id, movement_type, reason
  - Return: Stock_move record

- [ ] Create movement_type validation logic
  - Validate destination location type matches movement_type
  - receiving: to_location.type != 'receiving'
  - put_away: to_location.type = 'storage'
  - pick: to_location.type IN ('production', 'shipping')
  - transfer: from_location.type = 'storage' AND to_location.type = 'storage'
  - adjustment: any location type allowed

- [ ] Add location validation function
  - Check: location exists, is_active = true, allows_storage = true (except receiving)

### Database

- [ ] Create stock_moves table (per tech-spec)
  - Columns: id, org_id, lp_id, from_location_id, to_location_id, movement_type, quantity, uom, reason, moved_at, moved_by_user_id
  - Indexes on: org_id, lp_id, from_location_id, to_location_id, movement_type, moved_at

- [ ] Verify locations table has:
  - location_type (enum: receiving, storage, production, shipping, quarantine)
  - is_active (boolean)
  - allows_storage (boolean)

- [ ] Create RLS policies for stock_moves table
  - Standard org_id isolation (SELECT, INSERT, UPDATE policies)

### Frontend

- [ ] Update LP detail page: Add "Move" button in actions
  - Button visible for LPs with status 'available' or 'reserved'

- [ ] Create `MoveLocationModal` component
  - Display: Current LP, current location (read-only)
  - Dropdown: Destination locations (filtered by is_active = true)
  - Selector: Movement type (radio buttons or dropdown)
  - TextField: Reason (optional)
  - Validation: Show error if destination not selected
  - Actions: Move button (enabled when valid), Cancel

- [ ] Create LP list context menu: "Move" option
  - Opens MoveLocationModal for selected LP

- [ ] Update LP detail page: Show "Last Moved" info
  - Display: Last movement timestamp, from location, to location, moved by user

---

## Testing

### Unit Tests
- Movement type validation: each type validates destination location correctly
- Location validation: active check, storage check
- Stock_move record structure: all fields populated correctly

### Integration Tests
- POST /api/warehouse/stock-moves with valid lp_id and to_location_id
- Verify: stock_moves record created with correct details
- Verify: license_plates.location_id updated (if tracking via LP)
- POST with invalid to_location_id → 400 error, no record created
- POST with wrong location_type for movement_type → error

### E2E Tests
- Open LP detail page
- Click "Move" button
- Select destination location (WH-B-05)
- Select movement_type "put_away"
- Enter reason: "Organizing for picking"
- Click Move
- Verify: Modal closes, success message shown
- Verify: LP list updates location
- Verify: Stock_move record visible in audit trail

---

## Acceptance Criteria Checklist

- ✅ Move modal opens from LP detail
- ✅ Destination location validated (exists, active, correct type)
- ✅ Stock_moves record created with all required fields
- ✅ LP location updated to destination
- ✅ Movement type-specific validation enforced
- ✅ Success message shown with movement details
- ✅ Audit trail entry created (stock_moves)

---

## Dependencies

**Requires:** Story 5.1 (License Plate Creation), Story 5.11 (GRN Creation)

**Enables:** Story 5.15 (Movement Audit Trail), Story 5.16 (Partial Move), Story 5.21 (Pallet Move)

---

## Notes

- Stock_moves is **immutable audit trail** (insert-only, no deletes)
- Movement type constrains valid destination locations
- Reason field helps warehouse understand why LP moved
- Current location can be tracked via LP.location_id OR via last stock_move (recommend latter for audit trail)
- Partial moves (less than full qty) handled by Story 5.16 (split then move)
