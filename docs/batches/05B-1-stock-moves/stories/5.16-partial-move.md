# Story 5.16: Partial Move (Split on Move)

**ID:** 5.16
**Batch:** 5B-1 (Stock Moves)
**Story Points:** 5
**Effort:** 5-6 hours
**Status:** Todo

---

## User Story

> As a **Warehouse user**, I want to move partial quantity, so that I can split during movement.

---

## Acceptance Criteria

### AC 1: Partial Move Option
- **Given** viewing move modal
- **When** LP quantity > move quantity
- **Then** system shows option:
  - "Move full LP (100 kg)"
  - "Move partial qty: ___ kg"
- **And** allows user to select which option

### AC 2: Split on Move
- **Given** user selects partial qty move
- **When** confirming move with qty < current LP qty
- **Then** system performs:
  1. Split LP: create new LP with split qty
  2. Move new LP: move split LP to destination
  3. Keep original: original LP remains at source location
- **Example:** LP-001 has 100 kg at WH-A-01
  - User moves 40 kg to WH-B-05
  - Result: LP-001 remains at WH-A-01 (60 kg), LP-002 created and moved to WH-B-05 (40 kg)

### AC 3: Genealogy & Movement Records
- **Given** partial move completed
- **When** split occurs
- **Then**:
  - LP genealogy record created: parent (original) → child (split)
  - Two stock_moves created:
    - stock_move_1: Child LP with split_qty, from source → destination, movement_type=specified
    - stock_move_2: Parent LP with remaining_qty, same location (qty adjustment recorded for audit)
  - Both records have same timestamp (atomic operation)
  - UOM remains unchanged (inherited from original LP)

### AC 4: Validation
- **Given** partial qty provided
- **When** validating move
- **Then** validate:
  - split_qty > 0
  - split_qty < current_lp_qty
  - split_qty <= current_lp_qty (no over-move)
  - Destination valid for split LP

### AC 5: Success Message
- **Given** partial move completes
- **When** move succeeds
- **Then** show success message:
  - "LP-001 (100 kg) split into:"
  - "  - LP-001 remains at WH-A-01 (60 kg)"
  - "  - LP-002 created and moved to WH-B-05 (40 kg)"

---

## Technical Tasks

### Backend

- [ ] Enhance `POST /api/warehouse/stock-moves` endpoint
  - Add parameter: quantity (optional, default = full LP qty)
  - If quantity < LP.quantity:
    - Call LP split operation (Story 5.5)
    - Create stock_moves for both LPs
    - Return both LP details and moves
  - If quantity == LP.quantity:
    - Normal move (no split)

- [ ] Update move logic:
  ```
  IF quantity < current_lp_qty:
    1. Split LP: parent → child with split_qty
    2. Create stock_move for child LP with quantity=split_qty
    3. Update parent LP qty: parent.qty -= split_qty
    4. Optional: Create stock_move for parent showing qty adjustment
  ELSE:
    1. Normal move: create stock_move with full qty
  ```

- [ ] Ensure genealogy created on split (Story 5.5 dependency)

### Database

- [ ] Verify stock_moves can have same LP in multiple moves
  - Multiple stock_moves per LP over time
  - Useful for tracking: move → split → move chain

### Frontend

- [ ] Enhance `MoveLocationModal` component
  - Add option to select: full move or partial move
  - If partial: numeric input for qty
  - Show: "Current: 100 kg" and "Moving: ___ kg"
  - Validation: qty < current_qty, qty > 0

- [ ] After move: Show split result
  - If split occurred: Display both LP numbers
  - Show before/after quantities
  - Links to both LPs

---

## Testing

### Unit Tests
- Split qty validation: 0, negative, > current_qty → error
- Qty remaining calculation: 100 - 40 = 60 ✓
- Child LP created with split qty

### Integration Tests
- POST /api/warehouse/stock-moves with quantity < LP.qty
- Verify: parent LP qty reduced, child LP created, moves recorded
- Verify: genealogy created (parent → child)
- Verify: two stock_moves created (or one with split flag)

### E2E Tests
- Open LP with 100 kg
- Click Move
- Select "Move partial qty"
- Enter 40 kg
- Select destination
- Click Move
- Verify: Original LP at source (60 kg), new LP at destination (40 kg)
- Verify: Both LP numbers shown in success message
- Verify: Stock move history shows both movements

---

## Acceptance Criteria Checklist

- ✅ Partial qty move option available
- ✅ Split LP when moving partial qty
- ✅ Original LP remains with remaining qty
- ✅ New LP created with split qty and moved to destination
- ✅ Genealogy link created (parent → child)
- ✅ Two stock_moves recorded (or one with split tracking)
- ✅ Validation prevents invalid qty

---

## Dependencies

**Requires:** Story 5.14 (LP Location Move), Story 5.5 (LP Split)

**Enables:** None directly (enhances move operation)

---

## Notes

- Combines split (Story 5.5) and move (Story 5.14) in single operation
- Useful for: splitting orders, partial allocation to different locations
- Genealogy tracks relationship between original and split LP
- Can be repeated (split → move → split → move)
