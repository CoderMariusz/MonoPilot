# Story 5.29: Genealogy Recording

**ID:** 5.29
**Batch:** 5C-2 (Traceability & Workflows)
**Story Points:** 5
**Effort:** 5-6 hours
**Status:** Todo

---

## User Story

> As a **System**, I want to record all LP relationships, so that traceability is complete.

---

## Acceptance Criteria

### AC 1: Record Split Genealogy
- **Given** LP split operation (Story 5.5)
- **When** original LP split into 2+ new LPs
- **Then** lp_genealogy records created:
  - parent_lp_id = original LP
  - child_lp_id = new LP (for each split)
  - operation_type = 'split'
  - created_at, created_by_user_id populated

### AC 2: Record Merge Genealogy
- **Given** LP merge operation (Story 5.6)
- **When** multiple LPs merged into target LP
- **Then** lp_genealogy records created:
  - parent_lp_id = each source LP
  - child_lp_id = target (merged) LP
  - operation_type = 'merge'

### AC 3: Record Consume Genealogy
- **Given** Work Order consumes input LPs (Story 4.7)
- **When** WO material consumption recorded
- **Then** lp_genealogy records created:
  - parent_lp_id = consumed input LP
  - child_lp_id = output LP (from production)
  - operation_type = 'consume'
  - wo_id populated

### AC 4: Record Produce Genealogy
- **Given** Work Order produces output LPs (Story 4.12)
- **When** WO output recorded
- **Then** lp_genealogy records created:
  - parent_lp_id = input LPs
  - child_lp_id = output LP
  - operation_type = 'produce' (alias for consume)
  - wo_id populated

### AC 5: Genealogy Immutability
- **Given** genealogy record created
- **When** attempting to update or delete
- **Then** operation blocked (no UPDATE, no DELETE)
- **And** audit log shows attempt if applicable

### AC 6: Genealogy Transaction
- **Given** LP operation requires genealogy recording
- **When** operation and genealogy creation attempted
- **Then** both succeed or both fail (atomic)
- **And** no partial genealogy records on failure

---

## Technical Tasks

### Database

**Task 1:** Genealogy recording trigger/function
```sql
-- Insert genealogy record atomically with LP operation
CREATE OR REPLACE FUNCTION record_lp_genealogy(
  p_parent_id UUID,
  p_child_id UUID,
  p_operation_type VARCHAR,
  p_wo_id UUID DEFAULT NULL
)
RETURNS UUID AS $$
DECLARE
  v_genealogy_id UUID;
BEGIN
  INSERT INTO lp_genealogy (
    parent_lp_id, child_lp_id, operation_type, wo_id, org_id, created_by_user_id
  )
  SELECT p_parent_id, p_child_id, p_operation_type, p_wo_id,
         (SELECT org_id FROM license_plates WHERE id = p_parent_id),
         auth.uid()
  RETURNING id INTO v_genealogy_id;

  RETURN v_genealogy_id;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

### Backend

**Task 1:** GenealoggyService
```typescript
export class GenealoggyService {
  async recordSplit(parent_id: UUID, child_ids: UUID[]): Promise<void>
  async recordMerge(parent_ids: UUID[], child_id: UUID): Promise<void>
  async recordConsume(input_id: UUID, output_id: UUID, wo_id: UUID): Promise<void>
  async recordProduce(input_id: UUID, output_id: UUID, wo_id: UUID): Promise<void>
}
```

### Frontend

**Task 1:** Update LP service calls
- Story 5.5 (Split): Call `genealogyService.recordSplit()` after split
- Story 5.6 (Merge): Call `genealogyService.recordMerge()` after merge
- Story 4.7 (Consume): Call `genealogyService.recordConsume()` after consumption
- Story 4.12 (Produce): Call `genealogyService.recordProduce()` after output

---

## Testing

### Unit Tests
- Record split: verify parent-child links created
- Record merge: verify all source-target links created
- Record consume: verify WO linkage
- Immutability: verify UPDATE/DELETE blocked

### Integration Tests
- Split then trace: verify genealogy readable
- Merge then trace: verify genealogy readable
- Full transaction: operation + genealogy both succeed or both fail

### E2E Tests
- Perform split → verify genealogy recorded → trace forward
- Perform merge → verify genealogy recorded → trace forward

---

## Dependencies

### Requires
- Story 5.1: LP Creation
- Story 5.5: LP Split (genealogy source)
- Story 5.6: LP Merge (genealogy source)
- Story 4.7: WO Material Consumption (genealogy source)
- Story 4.12: WO Output Recording (genealogy source)

### Blocks
- Story 5.28: Traceability (depends on genealogy records)
- Story 5.30: Source Document Linking

---

## Notes

- Genealogy records are **audit trail**: immutable, never deleted
- Operation atomicity critical: if operation fails, genealogy not created
- FDA compliance: Complete genealogy required for food safety recalls
