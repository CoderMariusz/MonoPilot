# Story 5.32a: Shared Receiving Service - Technical Foundation

**ID:** 5.32a
**Batch:** 5C-2 (Traceability & Workflows)
**Type:** Technical Foundation Story
**Story Points:** 5
**Effort:** 5-6 hours
**Status:** Todo

---

## Purpose

This Technical Foundation Story defines a shared `ReceivingService` that consolidates receiving logic used by three separate stories:
- Story 5.32: Receive from PO (Desktop)
- Story 5.33: Receive from TO (Desktop)
- Story 5.34: Scanner Receive Workflow

Instead of duplicating validation and GRN/LP creation logic in each story, all three use the same service. This reduces code duplication, ensures consistency, and simplifies maintenance.

**Used by:**
- Story 5.32: Receive from PO
- Story 5.33: Receive from TO
- Story 5.34: Scanner Receive Workflow

---

## Receiving Operations

### Core Receiving Flows

The ReceivingService supports three types of receiving operations:

#### 1. Receive from Purchase Order (PO)

**Flow:**
```
1. Validate PO exists (status = Confirmed or PartiallyReceived)
2. Validate product matches PO line item
3. Validate quantity (allow over-receipt if configured)
4. Validate location is active and storage-capable
5. Create GRN record
6. Create LP for each line item
7. Update PO line received_qty
8. Update PO status if fully received
9. Return: GRN + LP numbers
```

**Key Constraints:**
- PO must be in Confirmed or PartiallyReceived status
- Product must match PO line
- Qty can't exceed capacity (unless over-receipt allowed)
- Location must be active storage location
- All updates atomic (GRN + LPs all succeed or all fail)

#### 2. Receive from Transfer Order (TO)

**Flow:**
```
1. Validate TO exists (status = Shipped)
2. Validate destination location matches TO destination
3. Validate location is active and storage-capable
4. For each LP in TO:
   a. Validate LP exists and is in transit
   b. Update LP.location_id to destination
   c. Create stock_move (movement_type='transfer')
5. Update TO status = Received
6. Return: count of LPs moved
```

**Key Constraints:**
- TO must be in Shipped status
- LPs already exist (don't create new ones)
- Location must match TO destination
- All LP updates atomic
- Creates stock_move per LP for audit trail

#### 3. Manual Receive

**Flow:**
```
1. User provides: product_id, qty, batch, expiry, location_id
2. Validate product exists
3. Validate location is active and storage-capable
4. Create standalone GRN record (no source document)
5. Create LP for inventory adjustment
6. Return: GRN + LP
```

**Key Constraints:**
- No source document required
- Used for: inventory adjustments, direct receipts, ad-hoc receives
- Same GRN/LP creation as PO receive
- Must specify batch number (FDA compliance)

---

## ReceivingService Interface

### TypeScript Definition

```typescript
export interface ReceivingService {
  /**
   * Receive goods against Purchase Order
   * Creates GRN + LPs, updates PO status
   */
  receiveFromPO(
    org_id: UUID,
    po_id: UUID,
    items: ReceiveLineItem[]
  ): Promise<ReceiveFromPOResult>;

  /**
   * Receive goods from Transfer Order
   * Updates existing LP locations, creates stock_moves
   */
  receiveFromTO(
    org_id: UUID,
    to_id: UUID,
    location_id: UUID
  ): Promise<ReceiveFromTOResult>;

  /**
   * Manual receive (no source document)
   * Creates GRN + LP for ad-hoc receives
   */
  manualReceive(
    org_id: UUID,
    item: ManualReceiveItem
  ): Promise<ManualReceiveResult>;

  /**
   * Validate receive parameters before submission
   * Returns: validation errors or success
   */
  validateReceive(
    org_id: UUID,
    operation: ReceiveOperation
  ): Promise<ValidationResult>;

  /**
   * Get source document (PO/TO) for receiving
   * Used to pre-populate forms
   */
  getSourceDocument(
    org_id: UUID,
    doc_type: 'po' | 'to',
    doc_id: UUID
  ): Promise<SourceDocument>;

  /**
   * List documents ready for receiving
   */
  listDocumentsForReceiving(
    org_id: UUID,
    doc_type: 'po' | 'to',
    filters?: ReceivingFilters
  ): Promise<SourceDocument[]>;
}
```

### Request/Response Types

```typescript
// Receive from PO
interface ReceiveLineItem {
  po_line_id: UUID;
  qty_received: number;
  batch_number: string; // Required, FDA compliance
  manufacture_date?: Date;
  expiry_date?: Date;
  location_id: UUID;
}

interface ReceiveFromPOResult {
  grn_id: UUID;
  grn_number: string; // Auto-generated: GRN-20250120-001
  lp_ids: UUID[];
  lp_numbers: string[]; // LP-20250120-0001, LP-20250120-0002, etc.
  po_status_changed: boolean;
  po_new_status?: 'PartiallyReceived' | 'Closed';
}

// Receive from TO
interface ReceiveFromTOResult {
  lp_count: number; // How many LPs moved
  stock_moves_created: number; // Audit trail records
  to_status: 'Received';
}

// Manual receive
interface ManualReceiveItem {
  product_id: UUID;
  qty: number;
  uom: string;
  batch_number: string; // Required
  manufacture_date?: Date;
  expiry_date?: Date;
  location_id: UUID;
  reason?: string; // Why receiving manually
}

interface ManualReceiveResult {
  grn_id: UUID;
  grn_number: string;
  lp_id: UUID;
  lp_number: string;
}

// Validation
interface ReceiveOperation {
  type: 'from_po' | 'from_to' | 'manual';
  po_id?: UUID;
  to_id?: UUID;
  items?: ReceiveLineItem[];
  product_id?: UUID;
  qty?: number;
  location_id: UUID;
}

interface ValidationResult {
  valid: boolean;
  errors: ValidationError[]; // Empty if valid
  warnings?: ValidationWarning[];
}

interface ValidationError {
  field: string;
  code: string; // 'product_mismatch', 'qty_exceeds', 'location_inactive', etc.
  message: string;
}

interface ValidationWarning {
  code: string; // 'over_receipt', 'partial_receive', etc.
  message: string;
  allow_proceed: boolean;
}

// Source documents
interface SourceDocument {
  id: UUID;
  number: string; // PO-001234 or TO-005678
  status: string;
  supplier_or_source?: string;
  destination_location?: string;
  lines: SourceDocumentLine[];
  total_items: number;
  received_count?: number;
  remaining_count?: number;
}

interface SourceDocumentLine {
  id: UUID;
  product_id: UUID;
  product_name: string;
  sku: string;
  ordered_qty: number;
  received_qty?: number;
  remaining_qty?: number;
  unit_price?: number;
  uom: string;
}

interface ReceivingFilters {
  supplier?: string;
  location?: string;
  status?: string;
  date_from?: Date;
  date_to?: Date;
  limit?: number;
  offset?: number;
}
```

---

## Validation Rules

### Common Validations (all receiving types)

1. **Location Validation**
   ```
   - Location must exist in org
   - Location.is_active = true
   - Location.type IN ('receiving', 'storage')
   - Location has capacity (if capacity tracking enabled)
   ```

2. **Organization Isolation**
   ```
   - All data must belong to same org (RLS enforced)
   - User must have 'receive' permission
   - Cross-org receiving blocked
   ```

3. **Batch Number**
   ```
   - Required (FDA traceability compliance)
   - Alphanumeric + special chars allowed
   - Max 50 characters
   - Unique per product (optional setting)
   ```

### PO Receive Specific

1. **PO Status**
   ```
   Valid: status IN ('Confirmed', 'PartiallyReceived')
   Invalid: status IN ('Open', 'Closed', 'Cancelled')
   Error: "PO must be Confirmed to receive"
   ```

2. **Product Match**
   ```
   - Scanned product must match PO line product
   - If mismatch:
     Error: "Expected {expected_product}, scanned {actual_product}"
   ```

3. **Quantity Validation**
   ```
   - qty_received > 0 (can't receive 0)
   - qty_received ≤ remaining (by default)
   - If qty_received > remaining AND allow_over_receipt=false:
     Error: "Can't receive more than ordered. Remaining: {remaining}"
   - If qty_received > remaining AND allow_over_receipt=true:
     Warning: "Receiving {qty} but only {remaining} ordered (+{diff}%)"
   - Allow proceed after confirming warning
   ```

4. **Status Transition**
   ```
   After full receipt (remaining = 0):
   - PO status changes: Confirmed → Closed
   - After partial receipt:
   - PO status: Confirmed (or stays PartiallyReceived)
   ```

### TO Receive Specific

1. **TO Status**
   ```
   Valid: status = 'Shipped'
   Invalid: other statuses
   Error: "Transfer Order must be in Shipped status to receive"
   ```

2. **Location Match**
   ```
   - Destination location must match TO.to_location_id
   - If different:
     Warning: "Location differs from transfer destination"
     Allow: proceed (in case destination changed)
   ```

3. **LP Status**
   ```
   - LPs must be in 'in_transit' or 'stored' status
   - Can't receive LPs already received
   - Error: "LP already received"
   ```

### Manual Receive Specific

1. **Product Validation**
   ```
   - Product must exist in org
   - Product must be active
   - Error: "Product not found or inactive"
   ```

2. **Reason Field**
   ```
   - Optional but recommended
   - Helps with auditing why manual receive needed
   ```

---

## Database Operations

### GRN Creation

```sql
INSERT INTO grns (
  id, org_id, grn_number, po_id, to_id,
  received_at, received_by_user_id, notes
) VALUES (...)

-- GRN number format: GRN-YYYYMMDD-NNNN
-- Example: GRN-20250120-0001
-- Daily sequence per org
```

### LP Creation (from PO receive)

```sql
INSERT INTO license_plates (
  id, org_id, lp_number, product_id, qty, uom,
  batch_number, manufacture_date, expiry_date,
  location_id, status, grn_id, created_at, created_by_user_id
) VALUES (...)

-- LP number format: LP-YYYYMMDD-NNNN
-- Status: 'received' initially (not 'stored')
-- GRN reference for traceability
```

### Stock Move Creation (for TO receive)

```sql
INSERT INTO stock_moves (
  id, org_id, lp_id, from_location_id, to_location_id,
  movement_type, qty, moved_at, moved_by_user_id
) VALUES (...)

-- movement_type: 'transfer' (for TO receives)
-- from_location_id: LP's current location
-- to_location_id: TO's destination location
-- Creates audit trail of LP movement
```

### PO Status Update

```sql
UPDATE purchase_orders SET
  status = CASE
    WHEN remaining_qty = 0 THEN 'Closed'
    ELSE 'PartiallyReceived'
  END,
  updated_at = NOW()
WHERE id = po_id
```

### TO Status Update

```sql
UPDATE transfer_orders SET
  status = 'Received',
  received_at = NOW()
WHERE id = to_id
```

---

## Error Handling

### Non-Recoverable Errors

**Status Codes: 400 Bad Request**

- Product mismatch: "Expected {product}, scanned {product}"
- Qty exceeds without override: "Can't receive {qty}, only {remaining} ordered"
- PO closed: "PO is closed, can't receive"
- Location inactive: "Location is not active"
- Batch required: "Batch number is required"

**Status Code: 404 Not Found**

- PO not found
- TO not found
- Product not found
- Location not found
- LP not found (TO receive)

**Status Code: 409 Conflict**

- PO already fully received
- TO already received
- LP already assigned to another TO

### Recoverable Errors (Warnings)

**Status Code: 200 with warning flag**

- Over-receipt: "Receiving {qty} but only {remaining} ordered"
  - User can confirm to proceed

- Partial receive: "This is a partial receive, remaining available later"
  - User can proceed (PO stays open)

- Location capacity: "Location is at {capacity}%, may be full"
  - User can choose different location or proceed

---

## API Endpoints

All endpoints enforce RLS (org_id isolation):

### Receiving Operations

**POST `/api/warehouse/receiving/from-po`**
```typescript
Request: {
  po_id: UUID,
  items: ReceiveLineItem[] // qty, batch, location per line
}
Response: ReceiveFromPOResult // GRN + LP numbers
```

**POST `/api/warehouse/receiving/from-to`**
```typescript
Request: {
  to_id: UUID,
  location_id: UUID // must match or confirm override
}
Response: ReceiveFromTOResult // LP count, movement count
```

**POST `/api/warehouse/receiving/manual`**
```typescript
Request: ManualReceiveItem // product, qty, batch, location
Response: ManualReceiveResult // GRN + LP
```

### Validation Endpoint

**POST `/api/warehouse/receiving/validate`**
```typescript
Request: ReceiveOperation
Response: ValidationResult // errors[] or warnings[]
```

### Document Retrieval

**GET `/api/warehouse/source-documents/:type`**
```
Query: ?status=Confirmed&limit=50&offset=0
Response: SourceDocument[]
```

**GET `/api/warehouse/source-documents/:type/:id`**
```
Response: SourceDocument with full line details
```

---

## Implementation Strategy

### Service Layer Architecture

```typescript
class ReceivingService {
  private grnService: GRNService;        // Delegates GRN creation (Story 5.11)
  private lpService: LPService;          // Delegates LP creation (Story 5.1)
  private stockMoveService: StockMoveService; // Creates audit records

  async receiveFromPO(org_id, po_id, items) {
    // 1. Validate PO
    const po = await this.validatePO(org_id, po_id);

    // 2. Validate items
    const validations = await Promise.all(
      items.map(item => this.validateLineItem(org_id, po, item))
    );

    // 3. Create GRN + LPs (atomic transaction)
    const grn = await this.grnService.createGRN({
      org_id, po_id,
      items: items.map(i => ({...}))
    });

    // 4. Update PO status
    await this.updatePOStatus(po_id);

    return { grn_id: grn.id, lp_numbers: grn.lp_numbers };
  }

  // Similar methods for receiveFromTO, manualReceive
}
```

### Atomicity Guarantee

All receive operations use database transactions:

```typescript
async receiveFromPO(...) {
  return await db.transaction(async (trx) => {
    // All operations within transaction
    const grn = await trx.insert('grns', {...});
    const lps = await Promise.all(
      items.map(item => trx.insert('license_plates', {...}))
    );
    await trx.update('purchase_orders', {...});

    // If any operation fails, entire transaction rolls back
    return { grn_id: grn.id, lp_ids: lps.map(lp => lp.id) };
  });
}
```

---

## Usage by Consuming Stories

### Story 5.32 (Desktop PO Receive)

```typescript
// In ReceiveModalComponent
const result = await receivingService.receiveFromPO(org_id, po_id, [
  {
    po_line_id: 'uuid-1',
    qty_received: 100,
    batch_number: 'BATCH-001',
    location_id: 'uuid-loc'
  }
]);

// Display: "GRN-20250120-001 created with LP-20250120-0001"
```

### Story 5.33 (Desktop TO Receive)

```typescript
// In TransferOrderReceiveModal
const result = await receivingService.receiveFromTO(org_id, to_id, location_id);

// Display: "15 LPs moved to {location}"
```

### Story 5.34 (Scanner Receive)

```typescript
// In ScannerReceiveWorkflow, step 7 (confirm)
const result = await receivingService.receiveFromPO(org_id, po_id, [{
  po_line_id: scannerContext.po_line_id,
  qty_received: scannerContext.qty,
  batch_number: scannerContext.batch,
  location_id: scannerContext.location_id
}]);

// Display: "✅ LP-{lp_number} created"
```

---

## Configuration & Customization

### Warehouse Settings Integration (Story 5.31)

The ReceivingService respects these settings:

```typescript
interface ReceivingSettings {
  allow_over_receipt: boolean;           // Allow receiving more than ordered
  over_receipt_tolerance: number;        // Max percentage over (e.g., 5%)
  require_batch_number: boolean;         // FDA compliance (default: true)
  auto_create_stock_moves: boolean;      // Auto-create movement records
  grn_number_prefix: string;             // "GRN-" (customizable)
  lp_number_prefix: string;              // "LP-" (customizable)
  auto_print_labels: boolean;            // Print after receive
  location_capacity_check: boolean;      // Enforce location max qty
}

// Load on service init:
const settings = await warehouseSettingsService.getReceivingSettings(org_id);
```

---

## Testing Strategy

### Unit Tests

- Validation logic: PO status, product match, qty check, location check
- Status transitions: Confirmed → Closed, Shipped → Received
- Over-receipt handling: allow vs. block based on setting
- Batch number validation

### Integration Tests

- Receive from PO: GRN + LPs created, PO status updated
- Receive from TO: LP locations updated, stock_moves created
- Manual receive: GRN + LP created standalone
- Validation endpoint: errors vs warnings
- Atomicity: if LP creation fails, GRN rollback

### API Tests

- POST `/api/warehouse/receiving/from-po` success/failure
- POST `/api/warehouse/receiving/validate` returns errors
- POST `/api/warehouse/receiving/from-to` moves all LPs atomically
- GET `/api/warehouse/source-documents/po` returns ready docs

---

## Acceptance Criteria Checklist

- ✅ ReceivingService interface defined (3 operations: PO, TO, Manual)
- ✅ Request/response types specified
- ✅ Validation rules documented per receive type
- ✅ API endpoints defined (validate, from-po, from-to, manual)
- ✅ Database operations documented (GRN, LP, stock_move creation)
- ✅ Error handling: non-recoverable vs. warnings
- ✅ Atomicity: all-or-nothing transactions
- ✅ Configuration: respects warehouse settings
- ✅ Used by Stories 5.32, 5.33, 5.34 (no duplication)

---

## Dependencies

**Used by:**
- Story 5.32: Receive from PO (Desktop)
- Story 5.33: Receive from TO (Desktop)
- Story 5.34: Scanner Receive Workflow

**Requires:**
- Story 5.11: GRN & LP Creation (delegates to these services)
- Story 5.1: License Plate (LP operations)
- Story 5.31: Warehouse Settings (configuration)
- Story 5.14: LP Location Move (for TO receives)

---

## Notes

- This is a **Technical Foundation Story** - provides shared service for 5.32, 5.33, 5.34
- Eliminates code duplication across three receiving implementations
- Enforces consistent validation and error handling
- Supports three receiving patterns: PO, TO, and ad-hoc manual
- Atomic transactions ensure data consistency (GRN + all LPs succeed together)
- All operations enforce org_id isolation (RLS)
- Configuration-driven: respects warehouse_settings for flexibility
- Performance: indexes on po_id, to_id, product_id for fast lookups
