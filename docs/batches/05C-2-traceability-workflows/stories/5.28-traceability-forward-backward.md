# Story 5.28: Forward/Backward Traceability

**ID:** 5.28
**Batch:** 5C-2 (Traceability & Workflows)
**Story Points:** 8
**Effort:** 8-10 hours
**Status:** Todo

---

## User Story

> As a **QC Manager**, I want to trace LP relationships, so that I can investigate issues.

---

## Acceptance Criteria

### AC 1: View LP Detail with Trace Buttons
- **Given** navigating to LP detail page
- **When** viewing license plate information
- **Then** see action buttons:
  - "Trace Forward" (shows children/downstream)
  - "Trace Backward" (shows parents/upstream)
  - Both buttons visible and enabled

### AC 2: Trace Forward (Downstream)
- **Given** clicking "Trace Forward" on LP detail
- **When** forward trace executes
- **Then** display tree/timeline showing:
  - All child LPs (direct children)
  - All grandchildren, great-grandchildren, etc.
  - Operation type for each link (split, merge, consume, produce)
  - Work Order ID if applicable
  - Timestamps for genealogy records
  - Max depth: 10 levels
  - Tree visualization or list format

### AC 3: Trace Backward (Upstream)
- **Given** clicking "Trace Backward" on LP detail
- **When** backward trace executes
- **Then** display tree/timeline showing:
  - All parent LPs (direct parents)
  - All grandparents, great-grandparents, etc.
  - Operation type for each link (split, merge, consume, produce)
  - Work Order ID if applicable
  - Timestamps for genealogy records
  - Max depth: 10 levels
  - Tree visualization or list format

### AC 4: Trace Performance
- **Given** tracing an LP with deep genealogy (>100 relationships)
- **When** forward/backward trace executes
- **Then** complete within 2 seconds
- **And** show loading indicator during query

### AC 5: Empty Trace Handling
- **Given** LP with no genealogy records
- **When** tracing forward/backward
- **Then** show message:
  - Forward: "No child LPs. This LP was not split or used in production."
  - Backward: "No parent LPs. This LP was created from receiving or manually."

### AC 6: Circular Dependency Prevention
- **Given** genealogy data exists
- **When** tracing forward/backward
- **Then** prevent infinite loops:
  - System detects circular references and stops (should never happen with RLS)
  - Log warning if detected
  - Show user-friendly message if anomaly detected

### AC 7: Source Document Links in Trace
- **Given** viewing LP in genealogy tree
- **When** LP has source document (PO, GRN, WO)
- **Then** show link to source:
  - "From GRN #12345" (if received)
  - "From WO #98765" (if produced)
  - Clickable to view document

### AC 8: Export Trace
- **Given** viewing trace tree
- **When** clicking "Export" button
- **Then** download as:
  - CSV: parent_lp, child_lp, operation_type, timestamp
  - PDF: formatted trace diagram (optional, for reports)

---

## Technical Tasks

### Database - Recursive CTEs

**Task 1:** Create SQL functions for trace queries
- Function: `get_lp_descendants(lp_id, max_depth)`
  - Returns all child/grandchild LPs
  - WITH RECURSIVE query
  - Depth limit to prevent infinite loops

- Function: `get_lp_ancestors(lp_id, max_depth)`
  - Returns all parent/grandparent LPs
  - WITH RECURSIVE query
  - Depth limit enforcement

**Task 2:** Optimize indexes for genealogy queries
- Index: `lp_genealogy(parent_lp_id, operation_type, created_at)`
- Index: `lp_genealogy(child_lp_id, operation_type, created_at)`

### Backend - API Endpoints

**Task 1:** GET `/api/warehouse/license-plates/:id/trace/forward`
- Query `get_lp_descendants(id, 10)`
- Format as tree structure or flat list with depth
- Include operation_type, created_at, created_by_user_id
- Include source document links from lp_genealogy.wo_id

**Task 2:** GET `/api/warehouse/license-plates/:id/trace/backward`
- Query `get_lp_ancestors(id, 10)`
- Same format as forward trace
- Include source document links

**Task 3:** TraceabilityService
```typescript
// apps/frontend/lib/services/traceability-service.ts
export class TraceabilityService {
  async getForwardTrace(lp_id: string): Promise<LPTrace[]>
  async getBackwardTrace(lp_id: string): Promise<LPTrace[]>
  async validateNoCycle(parent_id: string, child_id: string): Promise<boolean>
}
```

### Frontend - Components

**Task 1:** `TraceabilityViewer.tsx`
- Props: `lp_id`, `direction` ('forward' | 'backward')
- Display tree/timeline of genealogy
- Use React Tree or custom recursive component
- Show operation_type badges with colors
- Include source document links

**Task 2:** Modify `LPDetailPage.tsx`
- Add "Trace Forward" button
- Add "Trace Backward" button
- Show loading state during trace query
- Display trace result in modal or side panel

**Task 3:** `useTraceability` Hook
```typescript
const { trace, loading, error } = useTraceability(lp_id, direction);
```

### Frontend - UI/UX

**Task 1:** Tree Visualization
- Use library: `react-tree-graph` or `react-complex-tree` (or custom)
- Nodes: LP numbers with status badges
- Edges: Operation type labels (split, merge, consume)
- Colors: Green (split), Blue (merge), Orange (consume), Purple (produce)

**Task 2:** Export Functionality
- Button: "Export Trace"
- Format: CSV with columns (parent_lp, child_lp, operation_type, timestamp)
- Use: `papaparse` library for CSV generation

---

## Testing

### Unit Tests
```typescript
// tests/unit/services/traceability.test.ts
- getForwardTrace: returns correct descendants
- getBackwardTrace: returns correct ancestors
- Depth limit: stops at max 10 levels
- Empty trace: returns empty array (not error)
- Circular dependency: detects and prevents (with RLS, should not occur)
```

### Integration Tests
```typescript
// tests/integration/traceability.spec.ts
- Create LP genealogy: A → B (split) → C,D (split)
- Forward trace from A: includes B, C, D
- Backward trace from D: includes B, A
- Performance: 1000 genealogy records traced in <2s
```

### E2E Tests
```typescript
// tests/e2e/warehouse/traceability.spec.ts
- Navigate to LP detail
- Click "Trace Forward"
- Verify genealogy tree displays with children
- Click "Trace Backward"
- Verify genealogy tree displays with parents
- Click source document link and navigate
- Click "Export" and verify CSV download
```

---

## Acceptance Criteria Checklist

- [ ] Forward trace displays all child LPs with operation types
- [ ] Backward trace displays all parent LPs with operation types
- [ ] Trace completes within 2 seconds for large genealogies
- [ ] Empty trace shows user-friendly message
- [ ] Source document links are clickable
- [ ] Export to CSV works correctly
- [ ] Unit tests cover all trace scenarios
- [ ] Integration tests verify genealogy correctness
- [ ] E2E test covers full user workflow
- [ ] Performance tested with 1000+ genealogy records

---

## Dependencies

### Requires
- Story 5.1: LP Creation (LP must exist)
- Story 5.7: LP Genealogy (lp_genealogy table must exist)

### Blocks
- None

### Related
- Story 5.5: LP Split (creates parent-child genealogy)
- Story 5.6: LP Merge (creates parent-child genealogy)

---

## Notes

- Recursive CTEs must have depth limit to prevent infinite loops (PostgreSQL optimization)
- Consider caching trace results (Redis) if very frequent queries
- FDA compliance: Genealogy is immutable audit trail - never update/delete records
- Performance critical: Index optimization essential for large genealogy tables
