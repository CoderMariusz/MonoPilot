# Story 5.31: Warehouse Settings Configuration

**ID:** 5.31
**Batch:** 5C-2 (Traceability & Workflows)
**Story Points:** 5
**Effort:** 5-6 hours
**Status:** Todo

---

## User Story

> As an **Admin**, I want to configure Warehouse module settings, so that operations match our process.

---

## Acceptance Criteria

### AC 1: Access Settings Page
- **Given** Admin user navigates to `/settings/warehouse`
- **When** page loads
- **Then** display warehouse settings form with sections:
  - LP Configuration
  - Scanner Configuration
  - Barcode Configuration

### AC 2: LP Number Format
- **Given** LP Configuration section
- **When** viewing format field
- **Then** show current format and options:
  - Default: `LP-{WH}-YYYYMMDD-NNNN`
  - Custom: text field to enter pattern
  - Include variables: {WH}, {YYYY}, {MM}, {DD}, {NNNN}
  - Preview: show example LP number with current format

### AC 3: Auto-Print Labels
- **Given** LP Configuration section
- **When** toggling auto-print
- **Then** can enable/disable:
  - When disabled: print button optional on LP creation
  - When enabled: automatically print ZPL label to configured printer

### AC 4: Over-Receipt Tolerance
- **Given** LP Configuration section
- **When** setting over-receipt percentage
- **Then** allow value 0-100%:
  - Example: 5% allows receiving 5% more than ordered
  - 0% blocks any over-receipt

### AC 5: Scanner Configuration
- **Given** Scanner Configuration section
- **When** viewing timeout settings
- **Then** configure:
  - Session timeout: 1-60 minutes (default: 5)
  - Warning timeout: 1-60 seconds (default: 30)
  - Max offline operations: 50-500 (default: 100)
  - Offline warning threshold: 50-90% (default: 80%)

### AC 6: Barcode Formats
- **Given** Barcode Configuration section
- **When** selecting barcode types
- **Then** can configure format for:
  - LP barcodes: EAN128, CODE128, QR
  - Product barcodes: EAN128, CODE128, EAN13
  - Location barcodes: CODE128, QR

### AC 7: Save Settings
- **Given** modifying any setting
- **When** clicking "Save"
- **Then**:
  - Validate all inputs
  - Save to warehouse_settings table
  - Show success message: "Settings saved"
  - Changes apply immediately to warehouse operations

### AC 8: Settings Validation
- **Given** invalid settings
- **When** attempting to save
- **Then** show validation errors:
  - Timeout: must be 1-60
  - Tolerance %: must be 0-100
  - Offline operations: must be 50-500
  - Invalid barcode format: show allowed values

---

## Technical Tasks

### Database

**Task 1:** warehouse_settings table (already in tech-spec)
- Create table if not exists
- Set defaults as per AC 2-6
- Create unique index on org_id

### Backend

**Task 1:** API: GET `/api/warehouse/settings`
- Return current settings for org
- Return defaults if not configured

**Task 2:** API: PUT `/api/warehouse/settings`
- Validate input
- Update warehouse_settings
- Broadcast change to all users in org (via WebSocket)

**Task 3:** WarehouseSettingsService
```typescript
export class WarehouseSettingsService {
  async getSettings(org_id: UUID): Promise<WarehouseSettings>
  async updateSettings(org_id: UUID, settings: Partial<WarehouseSettings>): Promise<void>
  async validateSettings(settings: Partial<WarehouseSettings>): Promise<ValidationError[]>
}
```

### Frontend

**Task 1:** Create `WarehouseSettingsPage.tsx`
- Form sections: LP Config, Scanner Config, Barcode Config
- Input validation on change
- Show preview for LP format
- Save/Cancel buttons

**Task 2:** Create `LPFormatPreview.tsx` component
- Show example LP numbers with different formats
- Real-time preview as format changes

**Task 3:** Update scanner UI
- Read scanner timeout settings on init
- Apply timeout to session
- Use offline threshold for queue warnings

---

## Testing

### Unit Tests
- LP format validation (required variables, length)
- Timeout range validation (1-60)
- Barcode format validation (allowed values)
- Over-receipt % validation (0-100)

### Integration Tests
- Save settings → verify in DB
- Retrieve settings → match saved values
- Invalid settings → validation error

### E2E Tests
- Navigate to settings page
- Modify LP format → see preview update
- Save settings → success message
- Reload page → settings persisted
- Invalid input → validation error shown

---

## Dependencies

### Requires
- Story 1.1: Admin users and permissions (Epic 1)

### Blocks
- Story 5.1: LP creation (uses lp_number_format)
- Story 5.12: Auto-print labels (uses auto_print_labels)
- Story 5.23: Scanner (uses timeout settings)
- Story 5.36: Offline queue (uses queue settings)

---

## Notes

- Settings apply immediately without restart
- Each org can have different settings
- Settings should be cached on frontend to reduce API calls
- Broadcasting changes via WebSocket ensures all users see updates
