# Story 5.31: Warehouse Settings Configuration

**ID:** 5.31
**Batch:** 5C-2 (Traceability & Workflows)
**Story Points:** 5
**Effort:** 5-6 hours
**Status:** Todo

---

## User Story

> As an **Admin**, I want to configure Warehouse module settings, so that operations match our process.

---

## Acceptance Criteria

### AC 1: Access Settings Page
- **Given** Admin user navigates to `/settings/warehouse`
- **When** page loads
- **Then** display warehouse settings form with sections:
  - LP Configuration
  - Scanner Configuration
  - Barcode Configuration

### AC 2: LP Number Format
- **Given** LP Configuration section
- **When** viewing format field
- **Then** show current format and options:
  - Default: `LP-{WH}-YYYYMMDD-NNNN`
  - Custom: text field to enter pattern
  - Include variables: {WH}, {YYYY}, {MM}, {DD}, {NNNN}
  - Preview: show example LP number with current format

### AC 3: Auto-Print Labels
- **Given** LP Configuration section
- **When** toggling auto-print
- **Then** can enable/disable:
  - When disabled: print button optional on LP creation
  - When enabled: automatically print ZPL label to configured printer

### AC 4: Over-Receipt Tolerance
- **Given** LP Configuration section
- **When** setting over-receipt percentage
- **Then** allow value 0-100%:
  - Example: 5% allows receiving 5% more than ordered
  - 0% blocks any over-receipt

### AC 5: Scanner Configuration
- **Given** Scanner Configuration section
- **When** viewing timeout settings
- **Then** configure:
  - Session timeout: 1-60 minutes (default: 5)
  - Warning timeout: 1-60 seconds (default: 30)
  - Max offline operations: 50-500 (default: 100)
  - Offline warning threshold: 50-90% (default: 80%)

### AC 6: Barcode Formats
- **Given** Barcode Configuration section
- **When** selecting barcode types
- **Then** can configure format for:
  - LP barcodes: EAN128, CODE128, QR
  - Product barcodes: EAN128, CODE128, EAN13
  - Location barcodes: CODE128, QR

### AC 7: Printer Configuration
- **Given** LP Configuration section with auto-print enabled
- **When** clicking "Configure Printer"
- **Then** show printer settings:
  - Printer name/IP address (required when auto-print=true)
  - Port (default: 9100 for Zebra)
  - Printer type (dropdown: Zebra ZD-series, Datamax, etc.)
  - Connection type (USB, Network, Serial)
  - Label width/height (in mm, default: 100x150)
  - DPI (dots per inch, default: 203)
  - Test button: "Print Test Label"
  - Show status: "✅ Printer connected" or "❌ Unreachable"

- **When** clicking "Test Print":
  - Send test ZPL label to printer
  - Show confirmation: "✅ Test label sent to printer"
  - If failed: "❌ Failed to connect. Check IP and port."

- **When** saving printer settings:
  - Validate IP/hostname format
  - Test connection before saving
  - Store in warehouse_settings.printer_config JSON

### AC 8: ZPL Label Template Customization
- **Given** printer configured for Zebra
- **When** clicking "Customize Label Template"
- **Then** show ZPL editor with:
  - Pre-defined template variables:
    - {LP_NUMBER} - License plate barcode
    - {PRODUCT_NAME} - Product name
    - {PRODUCT_SKU} - Product SKU
    - {BATCH_NUMBER} - Batch number
    - {EXPIRY_DATE} - Expiry date (YYYY-MM-DD)
    - {MANUFACTURE_DATE} - Manufacture date
    - {LOCATION_CODE} - Location barcode
    - {QUANTITY} - LP quantity
    - {UOM} - Unit of measure
    - {RECEIVED_DATE} - Received date/time
    - {PRINT_TIME} - Current timestamp

  - ZPL code editor (textarea)
  - Default template (standard 4"×6" label)
  - Preview button: "Preview Label"
  - Show generated image of label
  - Save/Reset buttons

- **When** customizing:
  - Variables substituted at print time
  - Validate ZPL syntax (basic check: no unmatched brackets)
  - Show error if invalid

- **Example default template:**
  ```
  ^XA
  ^FO10,10^BY2,2,50^BC^FD{LP_NUMBER}^FS
  ^FO10,100^AAN,20,10^FD{PRODUCT_NAME}^FS
  ^FO10,150^AAN,15,10^FD{BATCH_NUMBER}^FS
  ^FO10,200^AAN,15,10^FDEXP: {EXPIRY_DATE}^FS
  ^XZ
  ```

### AC 9: Barcode Validation Patterns
- **Given** Barcode Configuration section
- **When** clicking "Validation Patterns"
- **Then** show barcode format patterns:

  **LP Barcode Pattern:**
  - Prefix: `LP-` (fixed)
  - Format: `LP-YYYYMMDD-NNNN` (regex: `^LP-\d{8}-\d{4}$`)
  - Example: `LP-20250120-0001`
  - Editable: allow custom prefix (e.g., `WH1-` instead of `LP-`)

  **Product Barcode Pattern:**
  - Type: EAN128, CODE128, or custom
  - Length: varies by type
  - Custom pattern text field (regex)
  - Example: `^[A-Z]{3}\d{10}$` for SKU format

  **Location Barcode Pattern:**
  - Prefix: `LOC-` (default, customizable)
  - Format: `LOC-{location_code}` (regex: `^LOC-[A-Z0-9]+$`)
  - Example: `LOC-A-01-01` or custom hierarchy

  **PO Barcode Pattern:**
  - Prefix: `PO-` (fixed)
  - Format: `PO-{number}` (regex: `^PO-\d+$`)
  - Example: `PO-001234`

  **TO Barcode Pattern:**
  - Prefix: `TO-` (fixed)
  - Format: `TO-{number}` (regex: `^TO-\d+$`)
  - Example: `TO-005678`

  **WO Barcode Pattern:**
  - Prefix: `WO-` (fixed)
  - Format: `WO-{number}` (regex: `^WO-\d+$`)
  - Example: `WO-009012`

- **When** barcode scanned:
  - System matches prefix to determine type
  - Validates against pattern
  - If invalid: show error "Invalid barcode format. Expected: {expected_pattern}"
  - If valid: proceed with operation

- **When** customizing patterns:
  - Each field has regex validator
  - Test button: "Test Barcode" - validates sample input
  - Show match result: "✅ Matches LP pattern" or "❌ Does not match"

### AC 10: Save Settings
- **Given** modifying any setting
- **When** clicking "Save"
- **Then**:
  - Validate all inputs
  - Save to warehouse_settings table
  - Show success message: "Settings saved"
  - Changes apply immediately to warehouse operations

### AC 11: Settings Validation
- **Given** invalid settings
- **When** attempting to save
- **Then** show validation errors:
  - Timeout: must be 1-60
  - Tolerance %: must be 0-100
  - Offline operations: must be 50-500
  - Invalid barcode format: show allowed values
  - Printer IP: must be valid IP or hostname
  - Barcode regex patterns: must be valid regex
  - ZPL template: must have valid syntax

### AC 12: Barcode Pattern Testing
- **Given** barcode validation patterns section
- **When** user enters a test barcode in "Test Barcode" field
- **Then**:
  - System checks against each pattern in order (LP, Product, PO, TO, WO, Location)
  - Displays first matching pattern: "✅ Matches LP pattern"
  - If no match: "❌ No matching pattern found"
  - Allows quick validation before enabling patterns

---

## Technical Tasks

### Database

**Task 1:** warehouse_settings table (already in tech-spec)
- Create table if not exists
- Set defaults as per AC 2-6
- Create unique index on org_id

### Backend

**Task 1:** API: GET `/api/warehouse/settings`
- Return current settings for org
- Return defaults if not configured

**Task 2:** API: PUT `/api/warehouse/settings`
- Validate input
- Update warehouse_settings
- Broadcast change to all users in org (via WebSocket)

**Task 3:** WarehouseSettingsService
```typescript
export class WarehouseSettingsService {
  async getSettings(org_id: UUID): Promise<WarehouseSettings>
  async updateSettings(org_id: UUID, settings: Partial<WarehouseSettings>): Promise<void>
  async validateSettings(settings: Partial<WarehouseSettings>): Promise<ValidationError[]>
}
```

### Frontend

**Task 1:** Create `WarehouseSettingsPage.tsx`
- Form sections: LP Config, Scanner Config, Barcode Config
- Input validation on change
- Show preview for LP format
- Save/Cancel buttons

**Task 2:** Create `LPFormatPreview.tsx` component
- Show example LP numbers with different formats
- Real-time preview as format changes

**Task 3:** Update scanner UI
- Read scanner timeout settings on init
- Apply timeout to session
- Use offline threshold for queue warnings

**Task 4:** Create `PrinterConfigurationModal.tsx` component
- Form fields: IP, Port, Printer type, Connection type, Label dimensions, DPI
- Test button triggers printer test
- Validate IP format before saving
- Show connection status

**Task 5:** Create `ZPLTemplateEditor.tsx` component
- Code editor (textarea with syntax highlighting)
- Variable hints/autocomplete: {LP_NUMBER}, {PRODUCT_NAME}, etc.
- Preview button generates label preview image
- Test template variables substitution
- ZPL syntax validation (basic bracket matching)

**Task 6:** Create `BarcodePatternConfigPanel.tsx` component
- Show 6 barcode type patterns (LP, Product, Location, PO, TO, WO)
- Each with: Prefix, Format, Regex, Example
- "Test Barcode" field to validate input
- Real-time pattern matching feedback

**Task 7:** Create `PrinterConnectionService`
```typescript
export class PrinterConnectionService {
  async testPrinterConnection(config: PrinterConfig): Promise<boolean>
  async printTestLabel(config: PrinterConfig, template: string): Promise<void>
  async printLabel(config: PrinterConfig, template: string, variables: Record<string, string>): Promise<void>
}
```

**Task 8:** Create `BarcodeValidationService`
```typescript
export class BarcodeValidationService {
  validateBarcode(barcode: string, patterns: BarcodePatterns): {type: string, valid: boolean}
  testPattern(barcode: string, pattern: string): boolean
  substituteTemplate(template: string, variables: Record<string, string>): string
}
```

---

## Testing

### Unit Tests
- LP format validation (required variables, length)
- Timeout range validation (1-60)
- Barcode format validation (allowed values)
- Over-receipt % validation (0-100)
- Printer IP validation (valid IP or hostname format)
- ZPL template validation (basic syntax check)
- Barcode regex validation (valid regex patterns)
- Barcode pattern matching (LP, Product, Location, PO, TO, WO)

### Integration Tests
- Save settings → verify in DB
- Retrieve settings → match saved values
- Invalid settings → validation error
- Printer test connection → success/failure
- Barcode pattern matching: test various barcode inputs
- ZPL template substitution: verify variables replaced correctly

### E2E Tests
- Navigate to settings page
- Modify LP format → see preview update
- Save settings → success message
- Reload page → settings persisted
- Invalid input → validation error shown
- Configure printer:
  1. Enter IP and port
  2. Click "Test Connection"
  3. Verify "Connected" status
  4. Click "Print Test Label"
  5. Verify test label sent successfully
- Customize ZPL template:
  1. Edit template code
  2. Click "Preview"
  3. See generated label image
  4. Modify and preview again
- Test barcode patterns:
  1. Enter test barcode "LP-20250120-0001"
  2. Verify matches LP pattern
  3. Try "INVALID"
  4. Verify no match found

---

## Acceptance Criteria Checklist

- ✅ Access settings page with all sections (LP, Scanner, Barcode, Printer)
- ✅ LP format configurable with preview
- ✅ Auto-print toggle for labels
- ✅ Over-receipt tolerance setting
- ✅ Scanner timeout and offline settings
- ✅ Barcode format selection
- ✅ Printer configuration (IP, port, type, dimensions, DPI)
- ✅ Printer connection test
- ✅ Print test label functionality
- ✅ ZPL template editor with variable substitution
- ✅ Barcode validation patterns for all types (LP, Product, Location, PO, TO, WO)
- ✅ Barcode pattern test/validation
- ✅ Save settings with validation
- ✅ Settings validation errors displayed
- ✅ Barcode pattern testing (AC 12)
- ✅ All settings cached and applied immediately

---

## Dependencies

### Requires
- Story 1.1: Admin users and permissions (Epic 1)

### Blocks
- Story 5.1: LP creation (uses lp_number_format)
- Story 5.12: Auto-print labels (uses auto_print_labels)
- Story 5.23: Scanner (uses timeout settings)
- Story 5.36: Offline queue (uses queue settings)

---

## Notes

- Settings apply immediately without restart
- Each org can have different settings
- Settings should be cached on frontend to reduce API calls
- Broadcasting changes via WebSocket ensures all users see updates
