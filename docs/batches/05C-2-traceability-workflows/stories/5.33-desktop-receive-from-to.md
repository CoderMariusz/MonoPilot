# Story 5.33: Receive from TO (Desktop)

**ID:** 5.33
**Batch:** 5C-2 (Traceability & Workflows)
**Story Points:** 5
**Effort:** 5-6 hours
**Status:** Todo

---

## User Story

> As a **Warehouse user**, I want to receive goods from transfer order, so that inter-warehouse transfers complete.

---

## Acceptance Criteria

### AC 1: Navigate to Transfer Order Receiving
- **Given** navigating to `/warehouse/receiving/transfer-orders`
- **When** page loads
- **Then** show:
  - List of TOs in "Shipped" status
  - Columns: TO#, From Location, To Location, Items, Status

### AC 2: Select Transfer Order
- **Given** viewing TO list
- **When** clicking on TO
- **Then** expand to show:
  - TO details (from/to location, date, etc.)
  - Line items with: product, shipped qty, received qty, remaining
  - "Receive All" button

### AC 3: Receive Transfer Order
- **Given** TO in Shipped status
- **When** clicking "Receive All"
- **Then** show confirmation:
  - Display items: product, qty to receive
  - Show current location vs expected location
  - "Receive" button to confirm

### AC 4: Update LP Locations
- **Given** confirming TO receipt
- **When** operation processes
- **Then**:
  - For each LP in TO:
    - Update LP.location_id to TO destination location
    - Create stock_move record (movement_type='transfer')
  - All LPs move atomically (all or nothing)
  - Show success: "Transfer received. 15 LPs moved to {location}"

### AC 5: Update TO Status
- **Given** TO receipt completes
- **When** all items received
- **Then**:
  - Update TO.status = 'Received'
  - Set received_at timestamp
  - Show TO as completed in list

### AC 6: Partial Receive
- **Given** TO with multiple items
- **When** only some LPs arrived
- **Then**:
  - Allow selecting specific LPs to receive
  - Update selected LP locations only
  - Leave TO in "Shipped" status
  - Show received vs remaining counts

### AC 7: Location Validation
- **Given** receiving LPs
- **When** destination location shown
- **Then** validate:
  - Location matches TO destination
  - Location is active
  - Location type allows storage

---

## Technical Tasks

### Backend

**Task 1:** API: GET `/api/warehouse/transfer-orders-for-receiving`
- Return TOs with status = 'Shipped'
- Include: to_number, from_location, to_location, to_lines with shipped/received
- Filter by org_id (RLS)

**Task 2:** API: POST `/api/warehouse/receiving/from-to`
- Request:
  ```json
  {
    "to_id": "uuid",
    "location_id": "uuid"
  }
  ```
- Update all LP locations to destination
- Create stock_move records for each LP
- Update TO status = 'Received'
- Return: success with moved LP count

**Task 3:** ReceivingService method
```typescript
async receiveFromTO(to_id, location_id): Promise<void>
```

### Frontend

**Task 1:** Create `TransferOrderReceivingPage.tsx`
- List TOs in Shipped status
- Expand TO to show lines
- "Receive All" button per TO

**Task 2:** Create `ReceiveTransferOrderModal.tsx`
- Show items to be moved
- Confirm destination location
- "Receive" button

**Task 3:** Call ReceivingService
- Load TOs: `getTOsForReceiving()`
- Receive: `receiveFromTO(to_id, location_id)`

---

## Testing

### Unit Tests
- TO status validation (Shipped only)
- Location validation

### Integration Tests
- Receive TO â†’ all LPs moved to new location
- stock_move records created for each LP
- TO status updated to Received

### E2E Tests
- Navigate to TO receiving
- Click on shipped TO
- Receive all items
- Verify LPs moved to new location
- Verify TO marked as Received

---

## Dependencies

### Requires
- Story 3.6: Transfer Order (TO must exist)
- Story 5.14: LP Location Move (for moving LPs)
- Story 5.1: License Plate (LPs must exist)

### Blocks
- None

---

## Notes

- LPs already exist (transferred from source warehouse)
- Only update location_id (not create new LPs)
- Atomic operation: all LPs move or none
- Transfer movement counted as 'transfer' type
