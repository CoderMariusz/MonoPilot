# Story 5.35: Inventory Count

**ID:** 5.35
**Batch:** 5C-2 (Traceability & Workflows)
**Story Points:** 8
**Effort:** 8-10 hours
**Status:** Todo

---

## User Story

> As a **Warehouse user**, I want to perform inventory counts, so that I can verify accuracy.

---

## Acceptance Criteria

### AC 1: Initiate Inventory Count
- **Given** navigating to `/warehouse/inventory-count`
- **When** clicking "Start Count"
- **Then** show dialog:
  - Location selector (required)
  - Count reason (optional: cycle count, audit, recount)
  - "Start" button
- **When** selecting location and starting:
  - Create inventory_counts record
  - Set status = 'pending'
  - Load expected LPs for location
  - Show count ID: "Count #001234"

### AC 2: Scanner Mode - Location Scan
- **Given** count initiated for location
- **When** on scanner at location
- **Then** show: "Scan Location Barcode"
- **When** scanning location:
  - Confirm location matches
  - Show expected LP count: "15 LPs expected"
  - Proceed to "Scan LP"

### AC 3: Scanner Mode - LP Scan
- **Given** location confirmed
- **When** showing "Scan LP Barcode"
- **Then**:
  - Show current scan progress: "5/15 scanned"
  - Barcode input field (auto-focus)
- **When** scanning expected LP:
  - Show ✅ green: "{LP} ✓ present"
  - Mark LP as found
  - Auto-advance to next scan
- **When** scanning unexpected LP:
  - Show ⚠️ warning: "{LP} extra (not in location)"
  - Log as found extra LP
  - Continue counting
- **When** finishing scans:
  - Button: "Done Counting"

### AC 4: Desktop Mode - LP List
- **Given** count initiated
- **When** using desktop (not scanner)
- **Then** show:
  - List of expected LPs in location
  - Checkboxes for each LP
  - "Mark as present" button
  - Search/filter by LP number
- **When** checking boxes:
  - Mark LPs as found
- **When** adding extra LPs:
  - Text input: "Found LP number"
  - "Add" button to log extra

### AC 5: Missing LPs Detection
- **Given** scan/desktop count in progress
- **When** operator finishes scanning
- **Then** system identifies:
  - LPs expected but not scanned = MISSING
  - Show list of missing LPs
  - Ask: "Recount missing?" or "Confirm missing?"

### AC 6: Complete Count
- **Given** all scans done
- **When** clicking "Complete Count"
- **Then** calculate variance:
  - Expected count: (LPs in location)
  - Scanned count: (actual scanned)
  - Missing count: (expected - scanned)
  - Found count: (extra scanned)
  - Variance %: ((missing + found) / expected) * 100
  - Status = 'completed'

### AC 7: Variance Report
- **Given** count completed
- **When** viewing results
- **Then** display:
  - Summary: "15 expected, 14 found, 1 missing, 0 extra"
  - Variance: "-6.67%" (negative = shortage)
  - List of missing LPs (with details)
  - List of extra LPs (with details)
  - Download report (PDF or CSV)

### AC 8: Recount
- **Given** variance detected
- **When** clicking "Recount Missing"
- **Then**:
  - Clear found flags for missing LPs only
  - Resume count for those LPs
  - Update scan progress
  - Recalculate variance

### AC 9: Variance Reconciliation & Auto-Adjustment
- **Given** count completed with variance
- **When** reviewing variance report
- **Then** show reconciliation options:
  - "Accept as Loss" (for missing LPs)
    - Creates adjustment stock_move with movement_type='adjustment'
    - Updates LP quantities to match physical count
    - Sets reason: "Inventory count variance"
  - "Investigate" (mark as needs review)
    - Flags for manager review
    - Keeps LPs in original state
  - "Recount" (re-initiate partial count)
    - Clears and allows re-scanning
  - "Schedule Physical Investigation"
    - Creates task for warehouse team

- **When** "Accept as Loss" selected:
  - For each missing LP:
    - Create stock_move record (movement_type='adjustment')
    - Set qty = (system_qty - physical_qty)
    - Set reason = "Inventory count variance - missing"
    - Update LP status based on qty (if qty=0, mark as obsolete)
  - For each extra LP (if qty scanned > system):
    - Create stock_move record (movement_type='adjustment')
    - Set qty = (physical_qty - system_qty)
    - Set reason = "Inventory count variance - extra"
  - Update inventory_counts.status = 'adjusted'
  - Generate audit trail showing what was adjusted

- **When** adjustment completed:
  - Show: "✅ Variances reconciled. X adjustments created."
  - Display adjustment records for audit
  - Option to print reconciliation report

---

## Technical Tasks

### Database

**Task 1:** Create inventory_counts and inventory_count_items tables (in tech-spec)
- inventory_counts: count summary
- inventory_count_items: individual LP entries

**Task 2:** Create counting views/functions
```sql
-- Get expected LPs for location
SELECT lp.* FROM license_plates lp
WHERE lp.location_id = $1 AND lp.status IN ('available', 'reserved')

-- Variance calculation
SELECT COUNT(*) as expected, COUNT(CASE WHEN scanned THEN 1 END) as scanned
FROM inventory_count_items
WHERE count_id = $1
```

### Backend

**Task 1:** API: POST `/api/warehouse/inventory-counts`
- Request: { location_id, reason }
- Create inventory_counts record
- Load expected LPs
- Return: count_id, expected_lps, location details

**Task 2:** API: POST `/api/warehouse/inventory-counts/:id/scan`
- Request: { lp_id }
- Mark LP as scanned
- Validate location_id matches
- Return: found flag, current progress

**Task 3:** API: POST `/api/warehouse/inventory-counts/:id/complete`
- Calculate variance
- Set status = 'completed'
- Generate variance report
- Return: summary with missing/extra LPs

**Task 4:** API: GET `/api/warehouse/inventory-counts/:id/report`
- Return variance report details

**Task 5:** InventoryCountService
```typescript
export class InventoryCountService {
  async initiateCount(location_id, reason): Promise<InventoryCount>
  async scanLP(count_id, lp_id): Promise<ScanResult>
  async completeCount(count_id): Promise<VarianceReport>
  async recountMissing(count_id): Promise<void>
  async reconcileVariance(count_id, action: 'accept_loss' | 'investigate' | 'recount'): Promise<ReconciliationResult>
}
```

**Task 6:** API: POST `/api/warehouse/inventory-counts/:id/reconcile`
- Request: { action, notes? }
- If action='accept_loss':
  - Create stock_move for each missing/extra LP (movement_type='adjustment')
  - Update LP quantities
  - Record adjustment audit trail
- If action='investigate':
  - Flag count for manager review
  - Send notification
- If action='recount':
  - Reset count state
- Return: reconciliation summary and adjustment records

**Task 7:** Create variance reconciliation components
```typescript
// New frontend components:
- VarianceReconciliationModal.tsx
  - Show options: Accept/Investigate/Recount
  - Display impact of accepting loss
  - Optional notes field

- AdjustmentPreviewComponent.tsx
  - Show what stock_moves will be created
  - List of LPs affected and qty changes
  - Confirm before applying

- ReconciliationReportComponent.tsx
  - Display reconciliation results
  - List adjustments made
  - Audit trail
  - Download option
```

### Frontend

**Task 1:** Create `InventoryCountPage.tsx`
- Show initiate dialog
- Show count progress
- Display results/variance

**Task 2:** Create `ScannerCountMode.tsx`
- Barcode input
- Progress counter
- Green/yellow/red feedback

**Task 3:** Create `DesktopCountMode.tsx`
- LP list with checkboxes
- Search/filter
- Add extra LP input

**Task 4:** Create `VarianceReportComponent.tsx`
- Summary statistics
- Missing LP list
- Extra LP list
- Download report button

---

## Testing

### Unit Tests
- Variance calculation (expected vs scanned)
- Missing/extra LP identification

### Integration Tests
- Initiate count → load expected LPs
- Scan LP → mark found
- Complete count → variance calculated
- Recount missing → progress resets for missing only
- Variance reconciliation:
  - Complete count with 1 missing, 1 extra
  - Call reconcile(action='accept_loss')
  - Verify 2 stock_moves created (adjustment type)
  - Verify LP quantities updated
  - Verify count.status = 'adjusted'

### E2E Tests
- Full count workflow:
  1. Initiate count for location (15 LPs expected)
  2. Scan 14 LPs correctly
  3. Complete count
  4. Verify variance: 1 missing (-6.67%)
  5. Recount missing LP
  6. Scan missing LP
  7. Complete recount
  8. Verify variance: 0 missing (0%)

- Variance reconciliation workflow:
  1. Complete count with variance (1 missing, 1 extra)
  2. View variance report
  3. Click "Accept as Loss"
  4. Verify stock_moves created for adjustments
  5. Verify adjustment audit trail recorded
  6. Verify count status = 'adjusted'
  7. Download reconciliation report

---

## Acceptance Criteria Checklist

- ✅ Initiate inventory count with location selection
- ✅ Scan/confirm location
- ✅ Scanner mode: barcode input with progress
- ✅ Desktop mode: LP list with checkboxes
- ✅ Missing LP detection
- ✅ Variance calculation
- ✅ Variance report display (AC 7)
- ✅ Recount functionality (AC 8)
- ✅ Variance reconciliation options: Accept/Investigate/Recount/Schedule (AC 9)
- ✅ Auto-create adjustment stock_moves for accepted losses (AC 9)
- ✅ Adjustment audit trail generated (AC 9)
- ✅ Reconciliation report available (AC 9)

---

## Dependencies

### Requires
- Story 5.1: LP Creation (LPs must exist)
- Story 5.11: GRN & LP Creation (LPs created from receiving)
- Story 5.23: Scanner Guided Workflows (scanner mode uses base workflow)

### Blocks
- None

---

## Notes

- Inventory count critical for accuracy/compliance
- Variance can indicate:
  - Shrinkage (missing)
  - Receiving errors (extra)
  - Data entry errors
- Recount feature helps resolve discrepancies
- Report useful for management review
- Future: Cycle counting (count subset regularly instead of full counts)
