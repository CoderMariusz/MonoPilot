# Story 5.30: Source Document Linking

**ID:** 5.30
**Batch:** 5C-2 (Traceability & Workflows)
**Story Points:** 5
**Effort:** 5-6 hours
**Status:** Todo

---

## User Story

> As a **Warehouse user**, I want LPs linked to source documents, so that I can trace origin.

---

## Acceptance Criteria

### AC 1: Store Source Type
- **Given** LP created
- **When** creation completes
- **Then** store source_type:
  - 'receiving' (from GRN)
  - 'production' (from WO output)
  - 'transfer' (from TO)
  - 'manual' (created manually)

### AC 2: Store Source Document ID
- **Given** LP with source_type set
- **When** LP created/produced
- **Then** store applicable ID:
  - source_grn_id (if receiving)
  - source_wo_id (if production)
  - source_to_id (if transfer)
  - source_po_id (if received from PO)
  - All NULL for manual creation

### AC 3: Source Link in LP Detail
- **Given** viewing LP detail page
- **When** LP has source_type set
- **Then** display source info:
  - "Received from GRN #12345" (link to GRN)
  - "Produced by WO #98765" (link to WO)
  - "Transferred from TO #54321" (link to TO)
  - "Manually created" (no link)

### AC 4: Source Link Navigation
- **Given** clicking on source link
- **When** link clicked
- **Then** navigate to source document detail
- **And** highlight this LP in source document

### AC 5: Reverse Traceability
- **Given** viewing source document (GRN, WO, TO)
- **When** source displayed
- **Then** show list of LPs created from this source
- **Example:** GRN #12345 → shows all LPs created from this GRN

### AC 6: LP with Multiple Sources
- **Given** LP created from merge operation
- **When** merge creates LP from multiple source LPs
- **Then** genealogy links to parent LPs
- **And** source_* fields reference final source (GRN, WO, etc.) if traceable

---

## Technical Tasks

### Database

**Task 1:** Extend license_plates table (already in tech-spec)
- Add columns: source_type, source_grn_id, source_wo_id, source_to_id, source_po_id
- Create indexes on source columns for filtering

### Backend

**Task 1:** Update GRN creation (Story 5.11)
- When LP created from GRN, set:
  - source_type = 'receiving'
  - source_grn_id = grn.id
  - source_po_id = grn.po_id (if from PO)

**Task 2:** Update WO output (Story 4.12)
- When LP produced, set:
  - source_type = 'production'
  - source_wo_id = wo.id

**Task 3:** Update TO receiving (Story 5.33)
- When LP received from TO, set:
  - source_type = 'transfer'
  - source_to_id = to.id

**Task 4:** LPService methods
```typescript
export class LPService {
  async getLPsFromSource(source_type: string, source_id: UUID): Promise<LP[]>
  async getLPSource(lp_id: UUID): Promise<SourceDocument>
}
```

### Frontend

**Task 1:** Modify `LPDetailPage.tsx`
- Display source info section
- Show link based on source_type
- Handle null sources (manual creation)

**Task 2:** Update GRN/WO/TO detail pages
- Add section: "LPs created from this document"
- List all LPs with their source_* columns matching

**Task 3:** Create `SourceDocumentLink.tsx` component
```typescript
interface Props {
  lp_id: UUID;
}
// Displays: "Received from GRN #12345" as link
```

---

## Testing

### Unit Tests
- Source type assignment for each scenario (GRN, WO, TO, manual)
- Source ID correctly stored
- Reverse lookup: find all LPs from source

### Integration Tests
- GRN → LP creation → source_type='receiving', source_grn_id set
- WO → LP production → source_type='production', source_wo_id set
- Merge LP → genealogy shows parents → sources traced

### E2E Tests
- Create GRN → LPs created → view LP detail → see "Received from GRN #X"
- Click source link → navigate to GRN
- View GRN → see list of created LPs

---

## Dependencies

### Requires
- Story 5.1: LP Creation
- Story 5.11: GRN & LP Creation
- Story 4.12: WO Output Recording
- Story 5.33: Receive from TO

### Blocks
- Story 5.28: Traceability (uses source info)

---

## Notes

- Source linking critical for FDA traceability chain
- Polymorphic FK: source_type determines which source_*_id to use
- Never update source_* fields after creation (immutable origin)
