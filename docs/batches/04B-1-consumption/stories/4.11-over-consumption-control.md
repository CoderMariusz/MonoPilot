# Story 4.11: Over-Consumption Control (Settings)

**Epic:** 4 - Production Execution | **Status:** To Be Designed | **Priority:** P0 | **Story Points:** 1 | **Effort:** 0.5 day

## User Story

**As an** Admin
**I want** to configure over-consumption policy
**So that** operators know whether over-consumption is allowed in their facility

---

## Purpose

Story 4.11 defines the **settings configuration** for over-consumption control. The actual over-consumption detection, warning dialogs, and operator confirmation logic is implemented in **Story 4.12a** (Sequential LP Consumption - Technical Foundation). Story 4.11 is about the setting that controls whether the warning is shown or blocking.

---

## Acceptance Criteria

### AC-4.11.1: Over-Consumption Setting Configuration

**Given** production_settings table

**When** admin configures over-consumption policy

**Then** setting stored: `allow_over_consumption` (boolean, default=false)

```
production_settings row:
├─ allow_over_consumption: true  (or false)
└─ Purpose: controls warning behavior during output registration
```

### AC-4.11.2: Over-Consumption Behavior (Story 4.12a Integration)

**Then** behavior depends on this setting during output registration:

```
If allow_over_consumption = false (default):
  ├─ Sequential consumption calculates allocation (Story 4.12a)
  ├─ Over-consumption detected? (consumption > reserved)
  ├─ SHOW warning dialog: "Over-Consumption Detected"
  ├─ Operator must confirm "Do you want to over-consume? YES/NO"
  └─ If NO: cancel output registration (no data written)
  └─ If YES: proceed with output registration

If allow_over_consumption = true:
  ├─ Same process as above (warning shown)
  ├─ But allows operator to confirm "YES"
  ├─ More permissive, still warns
  └─ Operator choice respected either way
```

**Key**: `allow_over_consumption=false` does NOT block - it shows warning and asks for confirmation. Both true/false allow operator to decide.

**See Story 4.12a (AC 4.12a.4-4.12a.5)** for complete over-consumption warning logic

### AC-4.11.3: Over-Production vs Over-Consumption

**Important distinction:**

```
Over-Consumption (Story 4.12a/4.11):
  - Total output quantity exceeds reserved materials
  - Example: 200kg reserved, output 180kg + 30kg = 210kg total
  - Handled: Warning dialog, operator confirms "yes/no"
  - Setting: allow_over_consumption

Over-Production (Story 4.12b):
  - Output qty exceeds reserved + all material exhausted
  - Example: 200kg reserved all consumed, output 30kg more
  - Handled: Dialog asks "Which LP is source for this over-production?"
  - No setting needed - always asks operator for parent LP
```

### AC-4.11.4: Settings API (Story 4.17 Integration)

**Then** production_settings configured via admin API:

```
PUT /api/production/settings

Request:
{
  "allow_over_consumption": true
}

Response:
{
  "success": true,
  "settings": {
    "allow_over_consumption": true
  }
}
```

### AC-4.11.5: Default Setting

**Then** default production_settings when organization created:

```sql
INSERT INTO production_settings (org_id, allow_over_consumption, ...)
VALUES ($org_id, false, ...);
```

Default is **false** (conservative - warn and require confirmation)

### AC-4.11.6: Settings UI (Admin)

**Then** production settings page shows toggle:

```
Production Settings
├─ Over-Consumption Policy:
│  ├─ □ Allow over-consumption (currently: OFF)
│  │  ℹ️  When OFF: operators see warning and must confirm to over-consume
│  │  ℹ️  When ON: operators still see warning, can confirm or cancel
│  └─ [Save]
└─ (other settings...)
```

### AC-4.11.7: Prerequisites & Dependencies

**Requires:**
- Story 4.17: Production Settings (settings configuration)
- Story 4.12a: Sequential LP Consumption (uses this setting during output registration)
- Story 4.12: Output Registration (calls 4.12a which checks setting)

**Used by:**
- Story 4.12a: Sequential Consumption algorithm (checks allow_over_consumption flag)
- Story 4.12: Output Registration (via 4.12a)

---

## Technical Implementation

### Database Schema (Already defined in Story 4.17)

```sql
-- No new tables needed - add to production_settings table
ALTER TABLE production_settings ADD COLUMN IF NOT EXISTS allow_over_consumption BOOLEAN DEFAULT false;
```

### Service Implementation

```typescript
interface ProductionSettingsService {
  /**
   * Get current allow_over_consumption setting for org
   */
  getAllowOverConsumption(org_id: UUID): Promise<boolean>;

  /**
   * Set allow_over_consumption setting
   */
  setAllowOverConsumption(org_id: UUID, allow: boolean): Promise<void>;
}

// Usage in Story 4.12a (Sequential Consumption Service)
const allow = await settingsService.getAllowOverConsumption(org_id);

if (allocation.is_over_consumption && !allow) {
  // Show warning, require confirmation
  // (handled in Story 4.12a)
}
```

---

## Testing Strategy

### Unit Tests

- Get allow_over_consumption setting: returns correct boolean
- Set allow_over_consumption setting: updates correctly
- Default value: false when new org created

### Integration Tests

- When allow_over_consumption=false, over-consumption shows warning
- When allow_over_consumption=true, over-consumption still shows warning (not blocked)
- Settings persist across requests

---

## Acceptance Criteria Checklist

- ✅ allow_over_consumption setting defined in production_settings
- ✅ Default value: false (conservative)
- ✅ API endpoint to configure setting (via Story 4.17)
- ✅ Setting controls warning behavior (not blocking behavior)
- ✅ Clear distinction between over-consumption (this) and over-production (4.12b)
- ✅ Settings UI toggle (admin page)

---

## Dependencies

**Requires:**
- Story 4.17: Production Settings infrastructure
- Story 4.12a: Sequential LP Consumption (reads this setting)

**Used by:**
- Story 4.12a: Sequential Consumption (checks allow_over_consumption during allocation)
- Story 4.12: Output Registration (indirectly via 4.12a)

---

## Notes

- **Not a blocker**: Setting doesn't block over-consumption, just controls warning messaging
- **Warning always shown**: Regardless of setting value, warning dialog shown to operator
- **Operator decides**: Operator has choice to proceed or cancel (both when true/false)
- **Simple setting**: Just one boolean flag - no complex policy rules needed
- **Distinction from 4.12b**: Over-production is different (operator selects parent LP)

---

## Status

- **Created:** 2025-11-27
- **Current Status:** Refactored (Simplified to settings-only; over-consumption logic moved to 4.12a)
