# Story 4.10: Consumption Correction

**Epic:** 4 - Production Execution | **Status:** Done | **Priority:** P0 | **Story Points:** 1 | **Effort:** 0.5 day

## User Story

**As a** Manager
**I want** to correct consumption errors
**So that** inventory stays accurate

## Acceptance Criteria

### AC-4.10.1: Reverse Consumption Modal
**Given** consumption was recorded incorrectly
**When** Manager clicks "Reverse"
**Then** modal confirms: "Reverse consumption of X kg of Y?"

### AC-4.10.2: Reverse Consumption & LP Restoration
**When** confirming reversal

**Then**:
- **Consumption marked as reversed**: wo_consumption.status = 'reversed'
  - reversed_by, reversed_at, reverse_reason recorded
- **LP status restored**: license_plates.status = 'reserved' (returned to reserved for WO)
- **LP qty restored**: license_plates.current_qty += reversed_qty
- **Genealogy handling** (delegated to Story 4.19):
  - Genealogy records remain (never deleted - compliance requirement)
  - Story 4.19 defines how to mark genealogy as reversed
- **Audit trail preserved**: wo_consumption record remains with status='reversed' for compliance

### AC-4.10.3: Audit Trail
**Then** Audit entry created: operation="consume_reverse", wo_id, material_id, lp_id, qty_reversed, reversed_by, reversed_at

### AC-4.10.4: Role-Based Access
**Then** Only Manager and Admin roles can reverse (not Operator)

### AC-4.10.5: LP Qty Restoration
**Then** license_plates.current_qty += reversed_qty, status updated if needed

### AC-4.10.6: API Endpoint
**Then** POST /api/production/work-orders/:id/consume/reverse with {consumption_record_id}

### AC-4.10.7: Error Handling
**When** consumption record not found
**Then** 404 error

**When** insufficient permissions
**Then** 403 error

### AC-4.10.8: Consumption History
**Then** Reversed record still visible in consumption history (marked as "Reversed on X by Y")

## Tasks / Subtasks

- [x] Task 1: Add reversed flag to wo_consumption table
- [x] Task 2: Create ReverseConsumptionService (in API route)
- [x] Task 3: API endpoint for reverse operation
- [x] Task 4: Frontend reverse button + modal
- [x] Task 5: Audit trail logging
- [x] Task 6: Tests

## Status

- **Created:** 2025-11-27
- **Updated:** 2025-12-03
- **Current Status:** Done
- **Completed:** 2025-12-03

## Implementation Notes (2025-12-03)

### Files Implemented/Modified

**Database (Migration 039):**
- `lib/supabase/migrations/039_create_wo_consumption_and_lp_movements.sql`
  - Creates `wo_consumption` table with status, reversed_at, reversed_by_user_id, reverse_reason
  - Creates `lp_movements` table for full audit trail
  - Adds reversed fields to `lp_genealogy` (status, reversed_at, reversed_by, reverse_reason)
  - Adds consumed_by_wo_id, consumed_at to `license_plates`

**API:**
- `app/api/production/work-orders/[id]/consume/route.ts` - POST creates consumption, GET lists history
- `app/api/production/work-orders/[id]/consume/reverse/route.ts` - POST reverses consumption

**Frontend:**
- `components/production/ReverseConsumptionDialog.tsx` - Confirmation modal (AC-4.10.1)
- `components/production/ConsumptionHistoryTable.tsx` - History table with reverse button
- `app/(authenticated)/planning/work-orders/[id]/page.tsx` - Integrated ConsumptionHistoryTable

**Tests:**
- `e2e/story-4.10-consumption-correction.spec.ts` - E2E tests for all ACs

### Key Implementation Details

**Reverse API (reverse/route.ts):**
- Role check (lines 59-69): Only Manager/Admin can reverse
- Updates wo_consumption.status to 'reversed' with timestamp and reason
- Restores LP qty and status to 'reserved'
- Updates wo_materials.consumed_qty
- Creates lp_movements record for audit
- Marks lp_genealogy as reversed (compliance)
- Creates activity_log entry

**ConsumptionHistoryTable:**
- Fetches user role via /api/auth/me
- Shows Reverse button only for Manager/Admin when WO in_progress
- Displays reversed records with strike-through and "Reversed" badge
- Tooltip shows reversed date and reason

### AC Coverage

| AC# | Description | Evidence |
|-----|-------------|----------|
| AC-4.10.1 | Reverse Modal | `ReverseConsumptionDialog.tsx:113-191` |
| AC-4.10.2 | LP Restoration | `reverse/route.ts:136-164` |
| AC-4.10.3 | Audit Trail | `reverse/route.ts:214-227` |
| AC-4.10.4 | Role-Based | `reverse/route.ts:59-69` |
| AC-4.10.5 | LP Qty Restore | `reverse/route.ts:152-164` |
| AC-4.10.6 | API Endpoint | `reverse/route.ts:26-241` |
| AC-4.10.7 | Error Handling | `reverse/route.ts:92-123` |
| AC-4.10.8 | History Display | `ConsumptionHistoryTable.tsx:193-269` |
