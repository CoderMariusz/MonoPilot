# Story 5.19: Pallet Creation

**ID:** 5.19
**Batch:** 5B-2 (Pallet Management)
**Story Points:** 3
**Effort:** 3-4 hours
**Status:** Todo

---

## User Story

> As a **Warehouse user**, I want to create pallets, so that I can group LPs for organization and shipment.

---

## Acceptance Criteria

### AC 1: Pallet Creation Modal
- **Given** Warehouse Manager navigates to /warehouse/pallets
- **When** clicking "Create Pallet" button
- **Then** modal opens with:
  - Pallet number (read-only, auto-generated): P-20250127-0001
  - Location selector (required, dropdown)
  - Notes field (optional, textarea)
  - Create button

### AC 2: Auto-Generated Pallet Number
- **Given** creating pallet
- **When** modal opens
- **Then** system auto-generates pallet_number:
  - Format: P-YYYYMMDD-NNNN (e.g., P-20250127-0001)
  - Daily sequence: resets at midnight per warehouse timezone
  - Unique per organization

### AC 3: Location Validation
- **Given** pallet creation modal
- **When** selecting location
- **Then** show only active locations filtered by `is_active=true`
- **And** validate location exists and belongs to current org

### AC 4: Pallet Record Creation
- **Given** user fills location and submits
- **When** clicking Create button
- **Then** pallet created with:
  - status = 'open' (default)
  - created_at = now
  - created_by_user_id = current_user.id
  - lp_count = 0 (no items initially)

### AC 5: Success Feedback
- **Given** pallet created successfully
- **When** operation completes
- **Then** show success toast:
  - "Pallet P-20250127-0001 created successfully"
  - Dismiss automatically or with close button
  - Redirect to pallet detail page

---

## Technical Tasks

### Backend

- [ ] Create `POST /api/warehouse/pallets` endpoint
  - Accept: location_id (required), notes (optional)
  - Validate: location exists and is active
  - Generate: pallet_number using pallet_number_sequence table
  - Insert: pallets record with status='open'
  - Return: Created pallet with id, number, location, status

- [ ] Create pallet number generation function
  - Query pallet_number_sequence by (org_id, current_date)
  - Increment next_sequence (daily counter)
  - Format: P-YYYYMMDD-NNNN (same as LP format)
    - Example: P-20250127-0001 = Pallet created 2025-01-27, sequence 0001
  - UPSERT: Update sequence on conflict if date exists (resets at midnight)
  - **Note**: Use warehouse timezone for date boundary (not UTC)

- [ ] Create `GET /api/warehouse/pallets` endpoint
  - Support filters: status, location_id, warehouse_id
  - Support pagination: limit (50 default), offset
  - Return: List of pallets with summary (LP count, location)

- [ ] Create `GET /api/warehouse/pallets/:id` endpoint
  - Return: Pallet details with items list

### Database

- [ ] Create `pallets` table with:
  - id (UUID, PK)
  - org_id (UUID, FK organizations)
  - pallet_number (VARCHAR(50), UNIQUE with org_id)
  - location_id (UUID, FK locations)
  - status (VARCHAR(20), CHECK IN ('open', 'closed', 'shipped'), DEFAULT 'open')
  - notes (TEXT, nullable)
  - created_at, created_by_user_id
  - updated_at, updated_by_user_id
  - shipped_at (nullable)

- [ ] Create `pallet_number_sequence` table with:
  - org_id (UUID)
  - sequence_date (DATE)
  - next_sequence (INTEGER, default 1)
  - PRIMARY KEY (org_id, sequence_date)

- [ ] Create indexes:
  - idx_pallets_org_id
  - idx_pallets_location_id
  - idx_pallets_status
  - idx_pallets_created_at

- [ ] Create `pallet_items` table (for Story 5.20):
  - id (UUID, PK)
  - org_id (UUID, FK)
  - pallet_id (UUID, FK pallets, ON DELETE CASCADE)
  - lp_id (UUID, FK license_plates)
  - position_order (INTEGER, default 0)
  - added_at, added_by_user_id
  - UNIQUE(pallet_id, lp_id)

### Frontend

- [ ] Create `/warehouse/pallets` page
  - Table showing: Pallet #, Location, Status, LP Count, Created, Actions
  - "Create Pallet" button

- [ ] Create CreatePalletModal component
  - Location dropdown (filtered to active locations)
  - Notes textarea
  - Display auto-generated pallet number
  - Create button with loading state
  - Success/error toast

- [ ] Create PalletListPage component
  - Fetch pallets with pagination
  - Show filter options (status, location)
  - Link to detail page on pallet row click

- [ ] Create PalletDetail page (for future stories)
  - Show pallet info, items, actions

---

## Testing

### Unit Tests
- Pallet number generation: daily sequence, format validation
- Location validation: active check, org check
- Status default: status='open' on creation

### Integration Tests
- POST /api/warehouse/pallets with valid location → 201, pallet created
- POST with invalid location → 400 error
- GET /api/warehouse/pallets → returns paginated list
- Pallet number uniqueness: same number on same org rejected

### E2E Tests
- Navigate to /warehouse/pallets
- Click "Create Pallet" → modal opens
- Pallet number auto-filled (read-only)
- Select location from dropdown
- Submit → pallet created, toast shown
- Redirect to detail page
- Pallet appears in list

---

## Acceptance Criteria Checklist

- ✅ Pallet creation modal with location selector
- ✅ Auto-generated pallet number (P-YYYYMMDD-NNNN format)
- ✅ Pallet created with status='open' and default values
- ✅ Location validation (active, org-scoped)
- ✅ Success feedback and redirect
- ✅ Pallet list page with pagination

---

## Dependencies

**Requires:** Story 5.1 (License Plates exist), Epic 1 (Locations, Users)

**Enables:** Story 5.20 (Add LP to pallet), Story 5.21 (Move pallet), Story 5.22 (Pallet status)

---

## Notes

- Pallet numbers follow same pattern as LP numbers (P-YYYYMMDD-NNNN)
- Daily reset per warehouse timezone (consider TZ when generating)
- Pallets start with status='open' for adding items
- Notes field helps track pallet purpose/customer/order
- Pallet detail page will be created in Story 5.20 (add items)
