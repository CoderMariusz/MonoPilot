# Story 5.20: Pallet LP Management

**ID:** 5.20
**Batch:** 5B-2 (Pallet Management)
**Story Points:** 5
**Effort:** 5-6 hours
**Status:** Todo

---

## User Story

> As a **Warehouse user**, I want to add and remove LPs from pallets, so that I can organize inventory into shipments.

---

## Acceptance Criteria

### AC 1: Add LP to Pallet
- **Given** pallet detail page with status='open'
- **When** clicking "Add LP" button
- **Then** modal opens with:
  - LP search/autocomplete dropdown
  - Position order field (optional)
  - Add button

### AC 2: LP Assignment
- **Given** selecting LP and submitting
- **When** adding to pallet
- **Then**:
  - LP assigned to pallet (pallet_items record created)
  - LP.location_id updated to pallet's location
  - Pallet item count incremented
  - Total quantity updated

### AC 3: Remove LP from Pallet
- **Given** viewing pallet items
- **When** clicking "Remove" button on item
- **Then**:
  - LP unassigned from pallet (pallet_items deleted)
  - LP.location_id NOT changed (remains at pallet location)
  - Pallet item count decremented
  - Confirmation dialog shown

### AC 4: Validation
- **Given** pallet with items
- **When** adding LP
- **Then** validate:
  - LP exists and belongs to same org
  - LP not already on another pallet
  - Pallet status='open' (cannot modify if closed/shipped)
  - LP not already on this pallet

### AC 5: Pallet Summary
- **Given** viewing pallet detail
- **When** items changed
- **Then** show summary:
  - LP count: "3 items"
  - Total quantity: "450.50 kg"
  - Total UoM: "kg"
  - Estimated weight (if available)

### AC 6: Item Ordering
- **Given** items on pallet
- **When** viewing list
- **Then** show position_order (1, 2, 3... for loading sequence)
- **And** allow drag-to-reorder or manual position edit

### AC 7: Pallet Item List
- **Given** pallet detail page
- **When** viewing items
- **Then** show table:
  - Position | LP Number | Product | Qty | UoM | Added By | Added At | Remove

---

## Technical Tasks

### Backend

- [ ] Create `POST /api/warehouse/pallets/:id/items` endpoint
  - Accept: lp_id (required), position_order (optional)
  - Validate: pallet exists, pallet.status='open', LP exists, not on another pallet
  - Check: LP not already on pallet (UNIQUE constraint)
  - Insert: pallet_items record
  - Update: LP.location_id = pallet.location_id
  - Return: Created item with pallet summary

- [ ] Create `DELETE /api/warehouse/pallets/:id/items/:item_id` endpoint
  - Validate: pallet.status='open'
  - Delete: pallet_items record
  - NOTE: Do NOT update LP.location_id (remains at pallet location)
  - Return: Success with updated pallet summary

- [ ] Create `PUT /api/warehouse/pallets/:id/items/:item_id/reorder` endpoint
  - Update: position_order
  - Validate: new position is valid

- [ ] Create `GET /api/warehouse/pallets/:id` enhancement
  - Return pallet with items list ordered by position_order
  - Include: LP details (lp_number, product_name, qty, uom)
  - Include: Item metadata (added_at, added_by)
  - Calculate: Total quantity, total UoM, LP count

- [ ] Create LP validation function
  - Check LP exists and org matches
  - Check LP not on another pallet (query pallet_items for lp_id)
  - Return: LP details or error

### Database

- [ ] Create pallet_items table (if not in 5.19):
  - id (UUID, PK)
  - org_id (UUID, FK)
  - pallet_id (UUID, FK pallets, ON DELETE CASCADE)
  - lp_id (UUID, FK license_plates)
  - position_order (INTEGER, default 0)
  - added_at, added_by_user_id
  - UNIQUE(pallet_id, lp_id)

- [ ] Create indexes:
  - idx_pallet_items_pallet_id (critical)
  - idx_pallet_items_lp_id (for finding which pallet LP is on)
  - idx_pallet_items_org_id

### Frontend

- [ ] Enhance `/warehouse/pallets/:id` detail page
  - Show pallet summary section: number, location, status, notes
  - Show items section: table of LPs on pallet
  - "Add LP" button (enabled if status='open')
  - For each item: position, LP#, product, qty, remove button

- [ ] Create AddLPToPalletModal component
  - LP autocomplete search
  - Position order input (optional, default to next sequence)
  - Loading state
  - Validation feedback (LP already on pallet, LP not found, etc)

- [ ] Create PalletSummaryCard component
  - Pallet number, location, status badge
  - LP count and total quantity display
  - Edit button for notes

- [ ] Create PalletItemsTable component
  - Row per item: position, LP#, product, qty, UoM, added by, added at, remove button
  - Remove button triggers confirmation dialog
  - Drag-to-reorder feature (optional for this story)

- [ ] Implement LP search/autocomplete
  - Query LPs by search text (lp_number or product_name)
  - Show results: LP#, Product, Qty, Current Location
  - Disable LPs already on pallets

---

## Testing

### Unit Tests
- LP validation: exists check, org check, on-pallet check
- Pallet status check: only add/remove if status='open'
- Position order calculation
- Duplicate LP prevention

### Integration Tests
- POST /api/warehouse/pallets/:id/items with valid LP → 201, pallet_items created
- LP.location_id updated to pallet location
- POST with LP already on pallet → 400 error
- POST with closed pallet → 400 error
- DELETE /api/warehouse/pallets/:id/items/:item_id → 200, item deleted
- LP.location_id NOT changed on removal
- GET /api/warehouse/pallets/:id returns items in position order

### E2E Tests
- Open pallet detail page
- Click "Add LP" → modal opens
- Search LP by number → results shown
- Select LP → autocomplete closes
- Submit → pallet items list updates
- Show success toast with item count
- LP appears in items table
- Click Remove on item → confirmation
- Confirm → item removed, count decremented
- Pallet summary updates (LP count, total quantity)

---

## Acceptance Criteria Checklist

- ✅ Add LP to pallet with validation
- ✅ Remove LP from pallet
- ✅ LP location updated to pallet location on add
- ✅ LP location NOT changed on remove
- ✅ Pallet summary (count, quantity, UoM)
- ✅ Item ordering with position_order
- ✅ Validation: only modify if status='open'
- ✅ Validation: LP not already on another pallet
- ✅ Item list with LP details (product, qty, added by)

---

## Dependencies

**Requires:** Story 5.19 (Pallet Creation), Story 5.1 (License Plates)

**Enables:** Story 5.21 (Pallet Move), Story 5.22 (Pallet Status)

---

## Notes

- Pallet items are ordered by position_order (loading sequence)
- LP.location_id updated to pallet location on ADD, NOT changed on REMOVE
- Cannot modify pallet contents if status != 'open'
- Each LP can only be on one pallet (enforced by unique constraint + validation)
- Total quantity calculated from SUM of LP quantities in pallet_items
- Future enhancement: drag-to-reorder items for physical loading optimization
