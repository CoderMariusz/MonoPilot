# Story 5.22: Pallet Status

**ID:** 5.22
**Batch:** 5B-2 (Pallet Management)
**Story Points:** 3
**Effort:** 3-4 hours
**Status:** Todo

---

## User Story

> As a **Warehouse user**, I want to track pallet status (open, closed, shipped), so that I know which pallets are ready for shipping.

---

## Acceptance Criteria

### AC 1: Status Display
- **Given** viewing pallet detail
- **When** page loads
- **Then** show pallet status badge:
  - "open" (blue): Can add/remove items
  - "closed" (yellow): Ready for shipping, cannot modify
  - "shipped" (green): Sent out, final state

### AC 2: Status Transitions
- **Given** pallet in 'open' status
- **When** closing pallet
- **Then**:
  - open → closed (allowed)
  - open → shipped (allowed, skip closed)

- **Given** pallet in 'closed' status
- **When** changing status
- **Then**:
  - closed → shipped (allowed)
  - closed → open (NOT allowed)

- **Given** pallet in 'shipped' status
- **When** trying to change
- **Then** status locked (no transitions allowed)

### AC 3: Close Pallet Modal
- **Given** 'open' pallet
- **When** clicking "Close Pallet" button
- **Then** confirmation modal opens:
  - "Are you sure?"
  - Show LP count: "Contains 5 items"
  - "Close" and "Cancel" buttons

### AC 4: Ship Pallet Modal
- **Given** 'closed' pallet
- **When** clicking "Ship Pallet" button
- **Then** modal opens:
  - Optional shipping notes/reference
  - Ship Date selector (default: today)
  - "Ship" and "Cancel" buttons

### AC 5: Lock Contents When Closed
- **Given** pallet status='closed'
- **When** on detail page
- **Then**:
  - "Add LP" button disabled
  - "Remove LP" button disabled
  - Items section shows "Locked" warning
  - Cannot edit notes

### AC 6: Shipped Pallet Lock
- **Given** pallet status='shipped'
- **When** viewing detail
- **Then**:
  - All modification buttons disabled
  - Show "shipped_at" timestamp
  - Show "Final state - cannot modify" warning

### AC 7: Status Filter
- **Given** viewing pallet list
- **When** filtering by status
- **Then** show checkboxes:
  - ☑ Open (count: 12)
  - ☑ Closed (count: 5)
  - ☑ Shipped (count: 3)

---

## Technical Tasks

### Backend

- [ ] Create `PUT /api/warehouse/pallets/:id/status` endpoint
  - Accept: status (required) - one of: 'open', 'closed', 'shipped'
  - Validate current status and allow transition
  - Validate: open → closed/shipped, closed → shipped, shipped → locked
  - If shipped: set shipped_at = now
  - Update: pallets.status, updated_at
  - Return: Updated pallet with new status

- [ ] Create status transition validation logic
  - open: can transition to closed OR shipped
  - closed: can transition to shipped ONLY
  - shipped: NO transitions (locked)
  - Return: True/False or specific error message

- [ ] Create `PUT /api/warehouse/pallets/:id` endpoint (update notes)
  - Accept: notes (optional)
  - Only allow if status='open'
  - Reject if status='closed' or 'shipped'
  - Update: pallets.notes, updated_at

- [ ] Create `GET /api/warehouse/pallets` filter enhancement
  - Support status query param: status=open or status=closed,shipped
  - Return counts per status

### Database

- [ ] No schema changes required
- [ ] Verify pallets table has:
  - status (VARCHAR(20) CHECK IN (...))
  - shipped_at (TIMESTAMP, nullable)

### Frontend

- [ ] Enhance pallet detail page
  - Status badge at top (blue/yellow/green)
  - Show status-dependent buttons:
    - If open: "Close Pallet" and "Move Pallet" buttons
    - If closed: "Ship Pallet" and "Move Pallet" buttons
    - If shipped: Show "View Details" only (locked)
  - Show "Locked" warning if closed/shipped

- [ ] Create ClosePaletModal component
  - Confirmation: "Close pallet P-20250127-0001?"
  - Show LP count
  - Close and Cancel buttons
  - On submit: PUT /api/warehouse/pallets/:id/status with status='closed'

- [ ] Create ShipPaletModal component
  - Optional shipping notes/reference
  - Ship date picker (default: today)
  - Ship and Cancel buttons
  - On submit: PUT /api/warehouse/pallets/:id/status with status='shipped'

- [ ] Create PalletStatusBadge component
  - Color: open=blue, closed=yellow, shipped=green
  - Text: "OPEN", "CLOSED", "SHIPPED"
  - Optional: Show shipped_at timestamp for shipped status

- [ ] Create StatusFilter component in list page
  - Checkboxes for each status
  - Show count per status
  - Support multi-select: status=open,closed

- [ ] Update pallet detail actions
  - "Edit Notes" button only if status='open'
  - Disable: "Add LP", "Remove LP" buttons if not open
  - Disable all if shipped

---

## Testing

### Unit Tests
- Status transition validation: open → closed OK, closed → open FAIL
- Shipped state locked: no transitions allowed
- Shipped_at set only when transitioned to shipped

### Integration Tests
- PUT /api/warehouse/pallets/:id/status with status='closed' → 200 OK
- Status updated to 'closed', updated_at changed
- PUT with invalid transition → 400 error
- PUT with status='shipped' → shipped_at populated
- GET with status filter → returns only matching pallets

### E2E Tests
- Open 'open' pallet → see "Close Pallet" button
- Click "Close Pallet" → confirmation modal
- Confirm → status changed to "CLOSED" (yellow badge)
- "Add LP" button now disabled
- Click "Ship Pallet" → modal opens
- Enter optional notes
- Submit → status "SHIPPED" (green), shipped_at shown
- All buttons now disabled, "Final state" message shown
- List page: filter by status, counts updated

---

## Acceptance Criteria Checklist

- ✅ Status display with color-coded badges
- ✅ Status transitions validated (open → closed/shipped, closed → shipped, shipped locked)
- ✅ Close pallet confirmation modal
- ✅ Ship pallet modal with optional notes
- ✅ Lock contents when closed (disable add/remove)
- ✅ Shipped state fully locked (no modifications)
- ✅ Shipped_at timestamp recorded
- ✅ Status filter in list view with counts

---

## Dependencies

**Requires:** Story 5.19 (Pallet Creation), Story 5.20 (LP Management)

**Enables:** Shipping workflows, reporting

---

## Notes

- Status transitions are **unidirectional** (cannot go backwards)
- Shipped state is **final** (cannot revert)
- Closing pallet prevents item modifications (add/remove blocked)
- Notes can only be edited while status='open'
- Shipped_at timestamp helps with logistics tracking
- Status affects permissions: open (full), closed (view/ship), shipped (view only)
- Future enhancement: Bulk status changes (multiple pallets at once)
