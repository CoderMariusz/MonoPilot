<?xml version="1.0" encoding="UTF-8"?>
<story>
  <metadata>
    <id>2.7</id>
    <title>BOM Items Management</title>
    <batch>02B-1</batch>
    <points>5</points>
    <effort_hours>6-8</effort_hours>
    <status>pending</status>
  </metadata>

  <description>Add, edit, delete, and reorder BOM items (components) with quantity, scrap, and sequencing.</description>

  <dependencies>
    <requires>
      <story id="2.6">BOM CRUD</story>
    </requires>
  </dependencies>

  <technical_context>
    <tables>
      <table>
        <name>bom_items</name>
        <columns>
          <column name="id" type="UUID" pk="true"/>
          <column name="bom_id" type="UUID" fk="boms.id" cascade="true"/>
          <column name="product_id" type="UUID" fk="products.id">Component product</column>
          <column name="quantity" type="NUMERIC" required="true"/>
          <column name="uom" type="TEXT"/>
          <column name="scrap_percent" type="NUMERIC" default="0"/>
          <column name="sequence" type="INTEGER">Display order</column>
          <column name="consume_whole_lp" type="BOOLEAN" default="false"/>
          <column name="is_by_product" type="BOOLEAN" default="false"/>
          <column name="yield_percent" type="NUMERIC"/>
          <column name="condition_flags" type="TEXT[]"/>
          <column name="condition_logic" type="TEXT">AND | OR</column>
          <column name="notes" type="TEXT"/>
        </columns>
      </table>
    </tables>

    <api_endpoints>
      <endpoint method="GET" path="/api/technical/boms/:id/items">List items sorted by sequence</endpoint>
      <endpoint method="POST" path="/api/technical/boms/:id/items">Add item</endpoint>
      <endpoint method="PUT" path="/api/technical/boms/:bomId/items/:itemId">Update item</endpoint>
      <endpoint method="DELETE" path="/api/technical/boms/:bomId/items/:itemId">Delete item</endpoint>
      <endpoint method="PUT" path="/api/technical/boms/:id/items/reorder">Batch update sequences</endpoint>
    </api_endpoints>

    <calculations>
      <calc name="effective_qty">quantity * (1 + scrap_percent/100)</calc>
    </calculations>
  </technical_context>

  <acceptance_criteria>
    <ac id="2.7.1">Add Item modal with product dropdown, quantity, scrap, UoM</ac>
    <ac id="2.7.2">Items table shows component, qty, effective_qty, UoM, scrap%, sequence</ac>
    <ac id="2.7.3">Drag-drop reorder updates sequence</ac>
    <ac id="2.7.4">Edit/delete items with confirmation</ac>
  </acceptance_criteria>
</story>
