# Story 5.26: Scanner Operations Menu

**ID:** 5.26
**Batch:** 5C-1 (Scanner Core)
**Story Points:** 2
**Effort:** 2-3 hours
**Status:** Todo

---

## User Story

> As a **Warehouse user**, I want quick access to common operations from a dedicated menu, so that I can switch between receive, pick, and move workflows without navigating through multiple screens.

---

## Acceptance Criteria

### AC 1: Operations Menu Layout
- **Given** viewing scanner home screen
- **When** page loads
- **Then** display operations menu with buttons (full screen):
  - Top row: Receive, Put Away, Pick
  - Middle row: Consume, Output, Move
  - Bottom row: Count, Settings
  - Each button: 60px × 60px minimum (48px touch target + padding)

### AC 2: Button Design
- **Given** viewing operations menu buttons
- **When** displaying UI
- **Then** each button shows:
  - Large icon (32px × 32px, center aligned)
  - Text label below icon (14px font, bold)
  - Background color per operation:
    - Receive: blue
    - Put Away: green
    - Pick: orange
    - Consume: red
    - Output: purple
    - Move: cyan
    - Count: gray
    - Settings: dark gray
  - Rounded corners (12px border-radius)

### AC 3: Touch Optimization
- **Given** operating scanner with gloved hand
- **When** tapping button
- **Then**:
  - Button feedback: press-in animation (scale 0.95)
  - Ripple effect on tap (Material Design)
  - Large padding between buttons (16px margin)
  - No hover states (mobile only)
  - Button stays pressable while active

### AC 4: Active Workflow Indicator
- **Given** user has active scanner session
- **When** returning to home screen
- **Then**:
  - Show session status banner at top: "Receive in progress (5 items)"
  - Highlight active operation button with border: "Resume"
  - Show "Resume" option on active button
  - Show "Cancel Session" option (confirmation required)

### AC 5: Operations Selection
- **Given** clicking operation button
- **When** selecting workflow
- **Then**:
  - Disable other buttons (0.3 opacity)
  - Show loading state on selected button
  - Call POST /api/scanner/sessions with workflow_type
  - Navigate to workflow guide page on success
  - Show error toast if session creation fails

### AC 6: Settings Access
- **Given** clicking Settings button
- **When** opening settings
- **Then**:
  - Navigate to /scanner/settings
  - Show panels:
    - Haptic Feedback (toggle + pattern selector)
    - Audio Feedback (toggle + tone selector + volume)
    - Auto-advance Delay
    - Device Info (device_id, offline status)
    - About (version, support link)

### AC 7: Offline Indicator
- **Given** offline or low connectivity
- **When** viewing operations menu
- **Then**:
  - Show status badge: "Offline Mode"
  - Color: orange/yellow warning color
  - Tooltip: "Pending validations will sync when online"
  - Operations still available (offline-capable)

### AC 8: Activity Timeout Indicator
- **Given** user idle for 4.5 minutes
- **When** approaching session timeout
- **Then**:
  - Show warning banner: "Session expiring in 30 seconds"
  - Offer: "Extend Session" button
  - Auto-logout if not extended
  - Show logout message: "Session expired"

---

## Technical Tasks

### Backend

- [ ] Create `GET /api/scanner/operations` endpoint
  - Return: list of available operations per org
  - Include: operation_name, icon_name, color, workflow_type
  - Allow orgs to customize enabled operations
  - Return: {operations: [{name, icon, color, workflow_type}]}

- [ ] Create `GET /api/scanner/active-session` endpoint
  - Return: current active session if exists
  - Include: session_id, workflow_type, current_step, steps_completed
  - Return: null if no active session

- [ ] Create `PATCH /api/scanner/sessions/:id/resume` endpoint
  - Resume paused session
  - Return: session_id, current_step, workflow_config

- [ ] Create `DELETE /api/scanner/sessions/:id/cancel` endpoint
  - Cancel active session with confirmation
  - Return: cancelled_at, summary (items processed before cancel)

### Frontend

- [ ] Create OperationsMenu component
  - Display 8 buttons in 3-row grid
  - Buttons: Receive, Put Away, Pick, Consume, Output, Move, Count, Settings
  - Use icons from lucide-react or similar
  - Colors: blue, green, orange, red, purple, cyan, gray, dark-gray
  - Responsive layout (full screen, landscape primary)

- [ ] Create OperationButton component
  - Props: operation_name, icon, color, onClick, disabled, loading
  - Show icon (32px) + label (14px) centered
  - Press animation on tap (scale 0.95)
  - Ripple effect (Material Design)
  - Loading spinner if loading=true

- [ ] Create ActiveSessionBanner component
  - Show if active session exists
  - Display: "Workflow in progress (5 items)"
  - Actions: "Resume" button, "Cancel" button (confirm modal)
  - Color: yellow/warning if approaching timeout

- [ ] Create OfflineIndicator component
  - Show if navigator.onLine = false
  - Display: "Offline Mode"
  - Tooltip: "Validations queued for sync"
  - Color: orange warning

- [ ] Create SessionTimeoutWarning component
  - Show when 30 seconds remain before timeout
  - Display: "Session expiring in 30s"
  - Button: "Extend Session" (extends idle_duration)
  - Auto-dismiss if extended

- [ ] Implement operations menu navigation
  - Hook: useOperationsMenu
    - Fetch active session on mount
    - Check offline status
    - Check session timeout
  - On operation click: create new session → navigate to workflow guide
  - On "Resume": fetch session → navigate to current step
  - On "Cancel": delete session → show confirmation → return to menu

- [ ] Create scanner/settings page
  - Layout: form with sections
  - Haptic settings: toggle + pattern selector + test button
  - Audio settings: toggle + tone selector + volume slider + test button
  - Auto-advance: toggle + delay selector
  - Device info: device_id (readonly), offline status
  - About: version, support link, feedback form
  - Save button: update configs

- [ ] Implement device detection
  - Detect if running on mobile device
  - Detect if PWA installed or web browser
  - Store device_id in localStorage (persistent)
  - Use device_id in scanner_sessions

### Database

- [ ] Ensure scanner_operations table (or static config)
  - name, icon, color, workflow_type, enabled (per org)

---

## Testing

### Unit Tests
- Operations list rendering: 8 buttons displayed
- Button colors: each operation has correct color
- Active session detection: shows banner if session exists
- Offline detection: shows indicator if offline

### Integration Tests
- GET /api/scanner/operations returns 8 operations
- GET /api/scanner/active-session returns null if no session
- GET /api/scanner/active-session returns session if exists
- POST /api/scanner/sessions on operation click creates session
- PATCH /api/scanner/sessions/:id/resume resumes session

### E2E Tests
- Open scanner app → operations menu displayed
- 8 operation buttons visible: Receive, Put Away, Pick, Consume, Output, Move, Count, Settings
- Click "Receive" → session created → navigates to workflow guide
- Click "Put Away" → different session created → navigates to put away workflow
- Cancel session mid-workflow → return to menu → no active session banner
- Active session exists → menu shows "Receive in progress (5 items)"
- Click "Resume" on active session → navigates to workflow at current step
- Click "Settings" → navigates to /scanner/settings
- Offline mode: disconnect internet → offline indicator shown
- Session timeout: idle 4.5+ min → warning banner shown
- Click "Extend Session" → warning dismissed, timeout reset

---

## Acceptance Criteria Checklist

- ✅ Operations menu: 8 buttons (Receive, Put Away, Pick, Consume, Output, Move, Count, Settings)
- ✅ Button design: icons + labels, color-coded, 60px minimum
- ✅ Touch optimization: 16px margins, press animation, ripple
- ✅ Active workflow indicator: banner + resume option
- ✅ Operation selection: loading state, navigation on success
- ✅ Settings access: dedicated page with all configuration options
- ✅ Offline indicator: shows when offline
- ✅ Timeout indicator: shows when 30s remaining

---

## Dependencies

**Requires:** Story 5.23 (Guided Workflows), Story 5.24 (Barcode Validation), Story 5.25 (Feedback)

**Enables:** Story 5.27 (Session Timeout)

---

## Notes

- **Operations menu is the home screen**: Every workflow starts here
- **Large buttons**: Designed for gloved hands and fast tapping
- **Color coding**: Helps user quickly identify operations visually
- **Resume functionality**: User can pause and return to workflow later
- **Offline capability**: All operations work offline (validations queued)
- **Settings persistence**: Haptic/audio settings saved locally (IndexedDB)
- **Accessibility**: Color-blind friendly (icons + text labels, not just colors)
- **Performance**: Menu loads instantly from cache (< 200ms)
- **Future enhancement**: Bulk operations (receive 10 pallets at once)
