# Story 5.23: Scanner Guided Workflows

**ID:** 5.23
**Batch:** 5C-1 (Scanner Core)
**Story Points:** 5
**Effort:** 5-6 hours
**Status:** Todo

---

## User Story

> As a **Warehouse user**, I want step-by-step guided workflows on a mobile device, so that I can complete operations (receive, pick, move) without memorizing steps or switching between screens.

---

## Acceptance Criteria

### AC 1: Workflow Selection Modal
- **Given** entering scanner mode
- **When** opening scanner app
- **Then** show workflow selection modal with options:
  - Receive (icon: package down)
  - Put Away (icon: storage)
  - Pick (icon: package up)
  - Consume (icon: minus)
  - Output (icon: plus)
  - Move (icon: arrows)
  - Count (icon: list)

### AC 2: Workflow State Machine
- **Given** selecting workflow type
- **When** confirming selection
- **Then**:
  - Create scanner_session with workflow_type
  - Initialize current_step = 1
  - Display first step instruction (e.g., "Scan Purchase Order Barcode")
  - Show progress bar: Step 1 of 5

### AC 3: Step Progression
- **Given** completing step validation
- **When** validation succeeds
- **Then**:
  - Display success feedback (green, beep, vibration)
  - Auto-advance to next step after 1.5 seconds
  - Update progress bar: Step 2 of 5

### AC 4: Validation-First Flow
- **Given** step requires barcode scan
- **When** step loads
- **Then**:
  - Focus hidden input field (keyboard visible on mobile)
  - Show expected input hint: "Scan LP Barcode"
  - Validate input against pattern on every keystroke
  - Block progress until validation succeeds

### AC 5: Touchscreen Optimization
- **Given** viewing workflow step on mobile
- **When** displaying UI
- **Then**:
  - All touch targets >= 44px × 44px (WCAG 2.1 AAA)
  - No hover states (touch only)
  - Landscape orientation for scanning comfort
  - Large readable font (18px+ for instructions)
  - High contrast text (color-blind friendly)

### AC 6: Error Recovery
- **Given** step validation fails
- **When** scanned barcode doesn't match
- **Then**:
  - Display error: "Invalid barcode. Try again."
  - Show red feedback
  - Trigger error haptic (longer vibration)
  - Stay on same step, don't advance
  - Clear input for next attempt

### AC 7: Workflow Completion
- **Given** all steps completed
- **When** final step validated
- **Then**:
  - Show completion screen: "Receive Completed! 5 items processed."
  - Show summary: items count, timestamp, operator name
  - Offer actions: "Start New Workflow" or "Back to Menu"
  - Close scanner_session with status='completed'

---

## Technical Tasks

### Backend

- [ ] Create `POST /api/scanner/sessions` endpoint
  - Accept: workflow_type, device_id, idle_duration_seconds (optional)
  - Create scanner_sessions record with status='active'
  - Fetch workflow_config for this workflow_type
  - Return: session_id, session_key, workflow_config, expires_at

- [ ] Create `PATCH /api/scanner/sessions/:id/step` endpoint
  - Accept: step_number, step_data (context specific)
  - Validate step_number is next valid step
  - Update scanner_sessions.current_step
  - Return: next step details, validation rules

- [ ] Create `GET /api/scanner/workflow-config/:type` endpoint
  - Return: steps array with action, validation, feedback_type per step
  - Include UI hints and expected patterns

- [ ] Create state machine validation logic
  - Per workflow type: define step sequence
  - Validate step progression (can't skip steps)
  - Return validation rules for each step

- [ ] Create `DELETE /api/scanner/sessions/:id` endpoint
  - Mark session status='completed'
  - Return summary: steps_completed, timestamp

### Frontend

- [ ] Create WorkflowSelectionModal component
  - Display 7 workflow type options with icons
  - Large 60px buttons for touch
  - On selection: call POST /api/scanner/sessions

- [ ] Create WorkflowGuidePanel component
  - Display current step instruction (centered, large font)
  - Show progress bar: "Step X of Y"
  - Render step-specific input component based on action type
  - Auto-advance on validation success

- [ ] Create BarcodeInputField component
  - Hidden HTML input with autocomplete=off
  - Auto-focus on mount (keyboard shown)
  - On scan event: validate against pattern
  - Emit validation result to parent

- [ ] Create StepProgressBar component
  - Visual progress: completed steps (green), current (blue), remaining (gray)
  - Text: "Step 2 of 5 - Confirm Location"
  - Update on step_number change

- [ ] Create WorkflowCompletionScreen component
  - Show checkmark icon
  - Display summary: item count, timestamp, operator
  - Buttons: "Start New Workflow" (reset to modal), "Back to Menu" (logout)

- [ ] Implement state machine executor
  - useWorkflowState hook: manages current step, validates progression
  - Prevents backwards navigation
  - Validates step prerequisites

### Database

- [ ] No schema changes (scanner_sessions, barcode_validations, scanner_workflow_configs created in tech-spec)

---

## Testing

### Unit Tests
- State machine transitions: valid paths only
- Step validation: barcode pattern matching
- Progress tracking: step numbers increment correctly
- Completion detection: all steps checked

### Integration Tests
- POST /api/scanner/sessions creates session with correct workflow_type
- PATCH /api/scanner/sessions/:id/step increments step correctly
- Step progression blocked if validation fails
- DELETE /api/scanner/sessions/:id closes session

### E2E Tests
- Open scanner app → select "Receive" → modal closes
- Step 1: "Scan Purchase Order" shown
- Scan valid PO barcode → success feedback → auto-advance
- Step 2: "Confirm Location" shown with dropdown
- Select location → success feedback → auto-advance
- Step 3: "Scan LP Barcode" shown
- Scan invalid barcode → error feedback, stay on step
- Scan valid LP → success → auto-advance
- Continue through all 5 steps
- Completion screen shown with summary
- Progress bar shows 5/5 steps completed

---

## Acceptance Criteria Checklist

- ✅ Workflow selection modal with 7 types
- ✅ State machine initialization (step 1 on start)
- ✅ Step progression on validation success
- ✅ Auto-advance after 1.5 seconds success feedback
- ✅ Validation-first: can't advance until valid
- ✅ Touch targets >= 44px
- ✅ Landscape orientation support
- ✅ Error recovery: stay on step, show error
- ✅ Workflow completion screen with summary
- ✅ Session closed on completion

---

## Dependencies

**Requires:** Story 5.1 (License Plates), Story 5.24 (Barcode Validation)

**Enables:** Story 5.24 (Barcode Validation), Story 5.25 (Feedback), Story 5.26 (Operations Menu), Story 5.27 (Session Timeout)

---

## Notes

- State machine definition per workflow type must be configurable (allow orgs to customize steps)
- Barcode scan events triggered by hardware scanner (not typed input)
- Auto-advance delay (1.5s) allows user to perceive feedback
- Step-specific validation rules prevent invalid state transitions
- Offline mode: workflow steps cached in IndexedDB, validations queued for sync
- Multi-language support: step instructions translated per org locale
- Touch optimization critical for warehouse environment (gloves, wet fingers, fast pace)
