# Story 3.18: Supplier-Product Assignments

**ID:** 3.18
**Batch:** 03C-1
**Story Points:** 3
**Effort:** 3-4 hours
**Status:** Todo

## User Story

> As a **Purchasing user**,
> I want to assign products to suppliers,
> So that I know where to order each product.

## Acceptance Criteria

### AC 1: View Assigned Products

**Given** a supplier exists
**When** viewing supplier detail
**Then** see Products tab with assigned products

### AC 2: Assign Products Modal

**When** clicking "Assign Products"
**Then** modal shows available products
**And** can set per product:
- is_default (only one default per product)
- supplier_product_code
- lead_time_days (override)
- unit_price
- moq

### AC 3: Default Supplier Constraint

**Given** product X assigned to Supplier A as default
**When** assigning product X to Supplier B as default
**Then** Supplier A is_default automatically set to false
**And** only one is_default per product across all suppliers

### AC 4: Bulk PO Integration

**When** bulk creating PO
**Then** uses default supplier per product
**And** inherits unit_price, lead_time from assignment

## Technical Tasks

### Backend
- [ ] Create `supplier_products` table (if not exists)
- [ ] API: `GET /api/planning/suppliers/:id/products`
- [ ] API: `PUT /api/planning/suppliers/:id/products`
- [ ] Enforce unique default per product (partial unique index)
- [ ] Auto-unset previous default when setting new one

### Frontend
- [ ] Products tab in Supplier detail page
- [ ] Assign Products modal with multi-select
- [ ] Per-product fields: is_default, code, price, lead_time, moq
- [ ] Default indicator badge on products list

### Database

```sql
CREATE TABLE IF NOT EXISTS supplier_products (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  org_id UUID NOT NULL REFERENCES organizations(id),
  supplier_id UUID NOT NULL REFERENCES suppliers(id) ON DELETE CASCADE,
  product_id UUID NOT NULL REFERENCES products(id) ON DELETE CASCADE,
  is_default BOOLEAN DEFAULT false,
  supplier_product_code VARCHAR(100),
  unit_price NUMERIC(15,2),
  lead_time_days INTEGER,
  moq NUMERIC(15,2),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE UNIQUE INDEX idx_supplier_products_unique ON supplier_products(supplier_id, product_id);
CREATE UNIQUE INDEX idx_supplier_products_default ON supplier_products(org_id, product_id) WHERE is_default = true;
```

## Testing

### Unit Tests
- [ ] Default supplier enforcement logic
- [ ] Assignment validation

### Integration Tests
- [ ] API creates/updates assignments
- [ ] Unique default constraint works
- [ ] Auto-unset previous default

### E2E Tests
- [ ] Assign products to supplier
- [ ] Set default supplier for product
- [ ] Verify bulk PO uses default supplier

## Dependencies

- **Requires:** Story 3.17 (Supplier Management), Story 2.1 (Products)
- **Blocks:** Story 3.3 (Bulk PO Creation)

## Notes

- Critical for Bulk PO creation workflow
- Default supplier determines auto-grouping in bulk PO
