<?xml version="1.0" encoding="UTF-8"?>
<story>
  <metadata>
    <id>3.18</id>
    <title>Supplier-Product Assignments</title>
    <batch>03C-1</batch>
    <points>3</points>
    <effort_hours>3-4</effort_hours>
    <status>todo</status>
  </metadata>

  <description>
    Assign products to suppliers with default supplier flag, override pricing, and lead times.
    Critical for Bulk PO creation which uses default supplier per product.
  </description>

  <dependencies>
    <blocks>
      <story id="3.3">Bulk PO Creation</story>
    </blocks>
    <requires>
      <story id="3.17">Supplier Management</story>
      <story id="2.1">Products</story>
    </requires>
  </dependencies>

  <technical_context>
    <tables>
      <table>
        <name>supplier_products</name>
        <columns>
          <column name="id" type="UUID" pk="true"/>
          <column name="org_id" type="UUID" fk="organizations.id"/>
          <column name="supplier_id" type="UUID" fk="suppliers.id" on_delete="CASCADE"/>
          <column name="product_id" type="UUID" fk="products.id" on_delete="CASCADE"/>
          <column name="is_default" type="BOOLEAN" default="false"/>
          <column name="supplier_product_code" type="VARCHAR(100)" nullable="true"/>
          <column name="unit_price" type="NUMERIC(15,2)" nullable="true"/>
          <column name="lead_time_days" type="INTEGER" nullable="true"/>
          <column name="moq" type="NUMERIC(15,2)" nullable="true"/>
          <column name="created_at" type="TIMESTAMPTZ"/>
          <column name="updated_at" type="TIMESTAMPTZ"/>
        </columns>
        <indexes>
          <index name="idx_supplier_products_unique" columns="supplier_id, product_id" unique="true"/>
          <index name="idx_supplier_products_default" columns="org_id, product_id" unique="true" where="is_default = true"/>
        </indexes>
      </table>
    </tables>

    <api_endpoints>
      <endpoint method="GET" path="/api/planning/suppliers/:id/products">
        <response type="array">
          <field name="product_id" type="string"/>
          <field name="product_name" type="string"/>
          <field name="is_default" type="boolean"/>
          <field name="supplier_product_code" type="string"/>
          <field name="unit_price" type="number"/>
          <field name="lead_time_days" type="number"/>
          <field name="moq" type="number"/>
        </response>
      </endpoint>
      <endpoint method="PUT" path="/api/planning/suppliers/:id/products">
        <request type="array">
          <field name="product_id" type="string"/>
          <field name="is_default" type="boolean"/>
          <field name="supplier_product_code" type="string" optional="true"/>
          <field name="unit_price" type="number" optional="true"/>
          <field name="lead_time_days" type="number" optional="true"/>
          <field name="moq" type="number" optional="true"/>
        </request>
      </endpoint>
    </api_endpoints>

    <components_to_create>
      <component name="SupplierProductsTab" path="components/planning/SupplierProductsTab.tsx"/>
      <component name="AssignProductsModal" path="components/planning/AssignProductsModal.tsx"/>
    </components_to_create>
  </technical_context>

  <acceptance_criteria>
    <criterion id="AC-1">
      <description>View Assigned Products</description>
      <given>a supplier exists</given>
      <when>viewing supplier detail</when>
      <then>see Products tab with assigned products</then>
    </criterion>
    <criterion id="AC-2">
      <description>Assign Products Modal</description>
      <when>clicking "Assign Products"</when>
      <then>modal shows available products with per-product settings</then>
    </criterion>
    <criterion id="AC-3">
      <description>Default Supplier Constraint</description>
      <then>only one is_default per product across all suppliers</then>
    </criterion>
    <criterion id="AC-4">
      <description>Bulk PO Integration</description>
      <when>bulk creating PO</when>
      <then>uses default supplier per product</then>
    </criterion>
  </acceptance_criteria>

  <test_plan>
    <unit_tests>
      <test>Default supplier enforcement logic</test>
      <test>Assignment validation</test>
    </unit_tests>
    <integration_tests>
      <test>API creates/updates assignments</test>
      <test>Unique default constraint works</test>
      <test>Auto-unset previous default</test>
    </integration_tests>
    <e2e_tests>
      <test>Assign products to supplier</test>
      <test>Set default supplier for product</test>
      <test>Verify bulk PO uses default supplier</test>
    </e2e_tests>
  </test_plan>

  <implementation_notes>
    <note priority="high">Critical for Bulk PO creation workflow</note>
    <note priority="high">Partial unique index enforces one default per product</note>
  </implementation_notes>
</story>
