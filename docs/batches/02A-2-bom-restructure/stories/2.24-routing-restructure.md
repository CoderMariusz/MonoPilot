# Story 2.24: Routing Restructure

**Epic:** 2 - Technical/Products
**Batch:** 02A-2-bom-restructure
**Status:** Todo
**Priority:** P0 (Breaking change, required before Epic 4 WO)
**Story Points:** 3
**Created:** 2025-11-30
**Effort Estimate:** 1-2 days

---

## Goal

Restructure the routing system by removing product binding and adding labor cost per operation. Routings become reusable templates that can be assigned to multiple BOMs.

## User Story

**As a** Production Engineer
**I want** to create routings as standalone templates with labor costs per operation
**So that** I can reuse the same routing across multiple products/BOMs and accurately track labor costs

---

## Problem Statement

Current routing system is tightly coupled to products:
1. One routing per product limits flexibility
2. No labor cost tracking per operation
3. Cannot share routings between similar products
4. Makes BOM management more complex

New structure:
1. Routings are independent entities (no product FK)
2. BOMs reference routings (many-to-one)
3. Each operation has optional labor_cost_per_hour
4. Routings have org-level unique names

---

## Breaking Changes

**CRITICAL:** This story involves DROP and CREATE operations:
- DROP existing `routing_operations` table CASCADE
- DROP existing `routings` table CASCADE
- CREATE new `routings` table (without product_id)
- CREATE new `routing_operations` table (with labor_cost)
- **All existing routing data will be lost** (acceptable for dev)

---

## Acceptance Criteria

### AC-2.24.1: Drop Existing Tables (Migration)
**Given** existing routings and routing_operations tables exist
**When** migration runs
**Then** system performs:
```sql
DROP TABLE IF EXISTS routing_operations CASCADE;
DROP TABLE IF EXISTS routings CASCADE;
```

**Success Criteria:**
- ✅ Old tables dropped without errors
- ✅ CASCADE removes dependent constraints
- ✅ Migration is idempotent (can run multiple times)

---

### AC-2.24.2: Create New Routings Table
**Given** old tables are dropped
**When** migration creates new schema
**Then** `routings` table is created:
```sql
CREATE TABLE routings (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id),
  name TEXT NOT NULL,
  description TEXT,
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now(),
  UNIQUE(org_id, name)
);

CREATE INDEX idx_routings_org ON routings(org_id);
```

**Success Criteria:**
- ✅ Table created with all columns
- ✅ org_id FK to organizations enforced
- ✅ UNIQUE constraint on (org_id, name)
- ✅ Index on org_id for performance
- ✅ **No product_id column** (key difference from old schema)

---

### AC-2.24.3: Create New Routing Operations Table
**Given** routings table is created
**When** migration creates operations table
**Then** `routing_operations` table is created:
```sql
CREATE TABLE routing_operations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  routing_id UUID NOT NULL REFERENCES routings(id) ON DELETE CASCADE,
  sequence INTEGER NOT NULL,
  name TEXT NOT NULL,
  description TEXT,
  machine_id UUID REFERENCES machines(id),
  estimated_duration_minutes INTEGER,
  labor_cost_per_hour DECIMAL(10,2),
  created_at TIMESTAMPTZ DEFAULT now(),
  UNIQUE(routing_id, sequence)
);

CREATE INDEX idx_routing_operations_routing ON routing_operations(routing_id);
```

**Success Criteria:**
- ✅ Table created with all columns
- ✅ routing_id FK with ON DELETE CASCADE
- ✅ UNIQUE constraint on (routing_id, sequence)
- ✅ **New column: labor_cost_per_hour** (key addition)
- ✅ machine_id FK optional (nullable)
- ✅ estimated_duration_minutes optional

---

### AC-2.24.4: RLS Policies
**Given** tables are created
**When** RLS is configured
**Then** policies enable authenticated access:
```sql
ALTER TABLE routings ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Enable all for authenticated" ON routings
  FOR ALL TO authenticated USING (true) WITH CHECK (true);

ALTER TABLE routing_operations ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Enable all for authenticated" ON routing_operations
  FOR ALL TO authenticated USING (true) WITH CHECK (true);
```

**Success Criteria:**
- ✅ RLS enabled on both tables
- ✅ Authenticated users have full CRUD
- ✅ Anonymous users blocked

---

### AC-2.24.5: Routing CRUD API Endpoints
**Given** schema is ready
**When** API endpoints are created
**Then** following endpoints available:

**GET /api/technical/routings**
```typescript
Request: Query params: ?org_id=uuid&is_active=true
Response (200): {
  data: [{
    id: uuid,
    org_id: uuid,
    name: string,
    description: string | null,
    is_active: boolean,
    created_at: timestamp,
    updated_at: timestamp,
    operations_count: number  // Computed: count of operations
  }]
}
```

**POST /api/technical/routings**
```typescript
Request: {
  name: string,             // Required, unique per org
  description?: string,
  is_active?: boolean       // Default: true
}
Response (201): {
  data: { id: uuid, name: string, ... }
}
Error (400): { error: "DUPLICATE_NAME", message: "Routing with this name already exists" }
```

**GET /api/technical/routings/:id**
```typescript
Response (200): {
  data: {
    id: uuid,
    name: string,
    description: string | null,
    is_active: boolean,
    operations: [{           // Eager load operations
      id: uuid,
      sequence: number,
      name: string,
      description: string | null,
      machine_id: uuid | null,
      machine: { id: uuid, name: string } | null,
      estimated_duration_minutes: number | null,
      labor_cost_per_hour: number | null
    }]
  }
}
Error (404): { error: "NOT_FOUND" }
```

**PUT /api/technical/routings/:id**
```typescript
Request: {
  name?: string,
  description?: string,
  is_active?: boolean
}
Response (200): { data: { ... } }
Error (400): { error: "DUPLICATE_NAME" }
Error (404): { error: "NOT_FOUND" }
```

**DELETE /api/technical/routings/:id**
```typescript
Response (200): { message: "Routing deleted successfully" }
Error (404): { error: "NOT_FOUND" }
Error (400): { error: "IN_USE", message: "Routing is used by X BOMs" }
```

**Success Criteria:**
- ✅ All 5 endpoints implemented
- ✅ org_id automatically set from auth context
- ✅ Validation: name required, unique per org
- ✅ Cascade delete removes operations
- ✅ Cannot delete if routing is used by BOMs

---

### AC-2.24.6: Routing Operations API Endpoints
**Given** routing exists
**When** managing operations
**Then** following endpoints available:

**GET /api/technical/routings/:id/operations**
```typescript
Response (200): {
  data: [{
    id: uuid,
    sequence: number,
    name: string,
    description: string | null,
    machine_id: uuid | null,
    machine: { id: uuid, name: string } | null,
    estimated_duration_minutes: number | null,
    labor_cost_per_hour: number | null
  }]
}
// Ordered by sequence ASC
```

**POST /api/technical/routings/:id/operations**
```typescript
Request: {
  sequence: number,                    // Required, unique per routing
  name: string,                        // Required
  description?: string,
  machine_id?: uuid,
  estimated_duration_minutes?: number,
  labor_cost_per_hour?: number         // NEW: labor cost tracking
}
Response (201): { data: { id: uuid, ... } }
Error (400): { error: "DUPLICATE_SEQUENCE" }
Error (400): { error: "INVALID_MACHINE" }
```

**PUT /api/technical/routings/:id/operations/:opId**
```typescript
Request: {
  sequence?: number,
  name?: string,
  description?: string,
  machine_id?: uuid | null,            // null to unassign
  estimated_duration_minutes?: number | null,
  labor_cost_per_hour?: number | null
}
Response (200): { data: { ... } }
Error (400): { error: "DUPLICATE_SEQUENCE" }
Error (404): { error: "NOT_FOUND" }
```

**DELETE /api/technical/routings/:id/operations/:opId**
```typescript
Response (200): { message: "Operation deleted" }
Error (404): { error: "NOT_FOUND" }
```

**Success Criteria:**
- ✅ All 4 endpoints implemented
- ✅ Sequence uniqueness enforced per routing
- ✅ machine_id validated against machines table
- ✅ labor_cost_per_hour accepts decimal (10,2)
- ✅ Operations ordered by sequence

---

### AC-2.24.7: Validation Rules
**Given** API receives requests
**When** validating data
**Then** following rules enforced:

| Field | Rule | Error Code |
|-------|------|------------|
| name | Required, 1-100 chars | INVALID_NAME |
| name | Unique per org_id | DUPLICATE_NAME |
| sequence | Required, positive integer | INVALID_SEQUENCE |
| sequence | Unique per routing_id | DUPLICATE_SEQUENCE |
| machine_id | Must exist if provided | INVALID_MACHINE |
| labor_cost_per_hour | 0-9999.99 | INVALID_LABOR_COST |
| estimated_duration_minutes | 0-10000 | INVALID_DURATION |

**Success Criteria:**
- ✅ All validations return specific error codes
- ✅ User-friendly error messages
- ✅ Validation happens before DB write

---

### AC-2.24.8: RoutingService Implementation
**Given** API routes exist
**When** business logic needed
**Then** RoutingService provides:

```typescript
// lib/services/routing-service.ts
class RoutingService {
  // CRUD operations
  async list(orgId: string, filters?: { is_active?: boolean }): Promise<Routing[]>
  async getById(id: string, orgId: string): Promise<Routing | null>
  async create(data: CreateRoutingInput, orgId: string): Promise<Routing>
  async update(id: string, data: UpdateRoutingInput, orgId: string): Promise<Routing>
  async delete(id: string, orgId: string): Promise<void>

  // Operations management
  async listOperations(routingId: string): Promise<RoutingOperation[]>
  async addOperation(routingId: string, data: CreateOperationInput): Promise<RoutingOperation>
  async updateOperation(routingId: string, opId: string, data: UpdateOperationInput): Promise<RoutingOperation>
  async deleteOperation(routingId: string, opId: string): Promise<void>

  // Helpers
  async checkRoutingInUse(routingId: string): Promise<{ inUse: boolean, bomCount: number }>
  async calculateTotalLaborCost(routingId: string, batchSize: number): Promise<number>
}
```

**Success Criteria:**
- ✅ Service encapsulates all DB operations
- ✅ org_id isolation enforced
- ✅ Error handling with specific codes
- ✅ Transaction support for complex ops

---

### AC-2.24.9: TypeScript Types
**Given** schema is defined
**When** types are generated
**Then** following types exist:

```typescript
// types/routing.ts
interface Routing {
  id: string
  org_id: string
  name: string
  description: string | null
  is_active: boolean
  created_at: string
  updated_at: string
  operations?: RoutingOperation[]
}

interface RoutingOperation {
  id: string
  routing_id: string
  sequence: number
  name: string
  description: string | null
  machine_id: string | null
  machine?: { id: string; name: string } | null
  estimated_duration_minutes: number | null
  labor_cost_per_hour: number | null
  created_at: string
}

interface CreateRoutingInput {
  name: string
  description?: string
  is_active?: boolean
}

interface UpdateRoutingInput {
  name?: string
  description?: string
  is_active?: boolean
}

interface CreateOperationInput {
  sequence: number
  name: string
  description?: string
  machine_id?: string
  estimated_duration_minutes?: number
  labor_cost_per_hour?: number
}

interface UpdateOperationInput {
  sequence?: number
  name?: string
  description?: string
  machine_id?: string | null
  estimated_duration_minutes?: number | null
  labor_cost_per_hour?: number | null
}
```

**Success Criteria:**
- ✅ All types defined
- ✅ Types match DB schema
- ✅ Optional fields properly typed
- ✅ Generated from Supabase or manually maintained

---

### AC-2.24.10: Zod Validation Schemas
**Given** API needs validation
**When** Zod schemas defined
**Then** following schemas exist:

```typescript
// lib/validation/routing-schemas.ts
import { z } from 'zod'

export const createRoutingSchema = z.object({
  name: z.string().min(1).max(100),
  description: z.string().max(500).optional(),
  is_active: z.boolean().optional().default(true)
})

export const updateRoutingSchema = z.object({
  name: z.string().min(1).max(100).optional(),
  description: z.string().max(500).nullable().optional(),
  is_active: z.boolean().optional()
})

export const createOperationSchema = z.object({
  sequence: z.number().int().positive(),
  name: z.string().min(1).max(100),
  description: z.string().max(500).optional(),
  machine_id: z.string().uuid().optional(),
  estimated_duration_minutes: z.number().int().min(0).max(10000).optional(),
  labor_cost_per_hour: z.number().min(0).max(9999.99).optional()
})

export const updateOperationSchema = z.object({
  sequence: z.number().int().positive().optional(),
  name: z.string().min(1).max(100).optional(),
  description: z.string().max(500).nullable().optional(),
  machine_id: z.string().uuid().nullable().optional(),
  estimated_duration_minutes: z.number().int().min(0).max(10000).nullable().optional(),
  labor_cost_per_hour: z.number().min(0).max(9999.99).nullable().optional()
})
```

**Success Criteria:**
- ✅ All input schemas defined
- ✅ Validation messages user-friendly
- ✅ Schemas used in API routes

---

## Technical Tasks

### Database

- [ ] Task 1: Create migration for schema restructure
  - [ ] Subtask 1.1: DROP routing_operations CASCADE
  - [ ] Subtask 1.2: DROP routings CASCADE
  - [ ] Subtask 1.3: CREATE routings table (new schema)
  - [ ] Subtask 1.4: CREATE routing_operations table (with labor_cost)
  - [ ] Subtask 1.5: CREATE indexes
  - [ ] Subtask 1.6: Enable RLS and create policies

### Backend

- [ ] Task 2: Create RoutingService
  - [ ] Subtask 2.1: Implement list() with filters
  - [ ] Subtask 2.2: Implement getById() with operations eager load
  - [ ] Subtask 2.3: Implement create() with duplicate check
  - [ ] Subtask 2.4: Implement update() with validation
  - [ ] Subtask 2.5: Implement delete() with in-use check
  - [ ] Subtask 2.6: Implement operations CRUD methods
  - [ ] Subtask 2.7: Implement checkRoutingInUse()
  - [ ] Subtask 2.8: Add error handling with specific codes

- [ ] Task 3: Create TypeScript types
  - [ ] Subtask 3.1: Define Routing interface
  - [ ] Subtask 3.2: Define RoutingOperation interface
  - [ ] Subtask 3.3: Define input/update types
  - [ ] Subtask 3.4: Export from types/index.ts

- [ ] Task 4: Create Zod validation schemas
  - [ ] Subtask 4.1: createRoutingSchema
  - [ ] Subtask 4.2: updateRoutingSchema
  - [ ] Subtask 4.3: createOperationSchema
  - [ ] Subtask 4.4: updateOperationSchema

- [ ] Task 5: Create API endpoints - Routings
  - [ ] Subtask 5.1: GET /api/technical/routings
  - [ ] Subtask 5.2: POST /api/technical/routings
  - [ ] Subtask 5.3: GET /api/technical/routings/:id
  - [ ] Subtask 5.4: PUT /api/technical/routings/:id
  - [ ] Subtask 5.5: DELETE /api/technical/routings/:id

- [ ] Task 6: Create API endpoints - Operations
  - [ ] Subtask 6.1: GET /api/technical/routings/:id/operations
  - [ ] Subtask 6.2: POST /api/technical/routings/:id/operations
  - [ ] Subtask 6.3: PUT /api/technical/routings/:id/operations/:opId
  - [ ] Subtask 6.4: DELETE /api/technical/routings/:id/operations/:opId

### Testing

- [ ] Task 7: Unit tests - RoutingService
  - [ ] Subtask 7.1: Test list() with filters
  - [ ] Subtask 7.2: Test create() success
  - [ ] Subtask 7.3: Test create() duplicate name error
  - [ ] Subtask 7.4: Test update() success
  - [ ] Subtask 7.5: Test delete() success
  - [ ] Subtask 7.6: Test delete() when in use
  - [ ] Subtask 7.7: Test operations CRUD
  - [ ] Subtask 7.8: Test sequence uniqueness
  - [ ] Subtask 7.9: Test labor_cost_per_hour handling
  - [ ] Subtask 7.10: Target 95% coverage

- [ ] Task 8: Integration tests - API endpoints
  - [ ] Subtask 8.1: Test all routing endpoints (200, 400, 404)
  - [ ] Subtask 8.2: Test all operation endpoints (200, 400, 404)
  - [ ] Subtask 8.3: Test org_id isolation
  - [ ] Subtask 8.4: Test auth required (401)
  - [ ] Subtask 8.5: Target 70% coverage

- [ ] Task 9: E2E tests - Full workflow
  - [ ] Subtask 9.1: Create routing via API
  - [ ] Subtask 9.2: Add operations to routing
  - [ ] Subtask 9.3: Update operation with labor_cost
  - [ ] Subtask 9.4: Verify operations ordered by sequence
  - [ ] Subtask 9.5: Delete routing
  - [ ] Subtask 9.6: Verify cascade delete of operations

---

## Dependencies

### Requires (must exist before this story)
- Epic 1: Organizations, Users, Auth
- Story 1.7: Machine Configuration (machines table for FK)
- Batch 01B: Production Lines (for later BOM-line relationship)

### Blocks (cannot start until this story done)
- Story 2.25: BOM Production Lines
- Story 2.26: BOM Items with Operation Assignment
- Story 2.29: Update existing BOM/Routing UI
- Epic 4: Production Execution (needs routing for WO operations)

---

## Dev Notes

### Architecture Patterns
- **Breaking migration**: DROP + CREATE approach (dev environment only)
- **Service layer**: RoutingService encapsulates all DB operations
- **Eager loading**: getById loads operations in single query
- **Cascade delete**: routing_operations deleted with routing

### Key Decisions
- **No product_id**: Routings are templates, assigned via BOM.routing_id
- **labor_cost_per_hour**: Per operation, not per routing
- **machine_id optional**: Operations can be manual (no machine)
- **sequence uniqueness**: Per routing, allows reordering

### Constraints
- org_id required for multi-tenant isolation
- Name must be unique within organization
- Cannot delete routing if used by BOMs
- Labor cost precision: 2 decimal places

### Migration Safety
```sql
-- Check for existing data before drop (warning only)
SELECT COUNT(*) FROM routings; -- Log this before drop
SELECT COUNT(*) FROM routing_operations; -- Log this before drop

-- Then proceed with DROP CASCADE
```

---

## Status

- **Created:** 2025-11-30
- **Current Status:** Todo
- **Blocked By:** Nothing (first story in batch)
