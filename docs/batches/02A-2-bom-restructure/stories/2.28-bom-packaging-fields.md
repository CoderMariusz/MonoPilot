# Story 2.28: BOM Packaging Fields

**Epic:** 2 - Technical/Products
**Batch:** 02A-2-bom-restructure
**Status:** Todo
**Priority:** P2 (Important for logistics)
**Story Points:** 1
**Created:** 2025-11-30
**Effort Estimate:** 0.5 day

---

## Goal

Add packaging configuration fields to BOMs to define how finished products are packaged (units per box, boxes per pallet).

## User Story

**As a** Production Engineer
**I want** to specify packaging configuration on each BOM
**So that** production knows how to package finished goods and warehouse can plan pallet storage

---

## Problem Statement

Current BOM structure lacks packaging information:
1. No standard units per box definition
2. No boxes per pallet configuration
3. Manual packaging decisions on production floor
4. Inconsistent palletization

New structure enables:
1. `units_per_box` - how many units fit in one box/case
2. `boxes_per_pallet` - how many boxes per pallet
3. Consistent packaging across production runs
4. Warehouse planning for storage

---

## Acceptance Criteria

### AC-2.28.1: BOM Table Packaging Columns
**Given** boms table restructure (Story 2.24 creates new schema)
**When** checking boms table
**Then** packaging columns exist:
```sql
-- Already in CREATE TABLE from Story 2.24/tech-spec
CREATE TABLE boms (
  -- ... existing columns ...
  units_per_box INTEGER,
  boxes_per_pallet INTEGER,
  -- ... other columns ...
);
```

**If not already added, migration:**
```sql
ALTER TABLE boms ADD COLUMN IF NOT EXISTS units_per_box INTEGER;
ALTER TABLE boms ADD COLUMN IF NOT EXISTS boxes_per_pallet INTEGER;
```

**Success Criteria:**
- ✅ units_per_box column exists (nullable INTEGER)
- ✅ boxes_per_pallet column exists (nullable INTEGER)
- ✅ Both nullable (packaging optional)

---

### AC-2.28.2: Validation Rules
**Given** API receives BOM data with packaging fields
**When** validating
**Then** following rules enforced:

| Field | Rule | Error Code |
|-------|------|------------|
| units_per_box | Positive integer if provided | INVALID_UNITS_PER_BOX |
| units_per_box | Max 10000 | INVALID_UNITS_PER_BOX |
| boxes_per_pallet | Positive integer if provided | INVALID_BOXES_PER_PALLET |
| boxes_per_pallet | Max 200 | INVALID_BOXES_PER_PALLET |

**Success Criteria:**
- ✅ Both fields optional (null allowed)
- ✅ Positive integers when provided
- ✅ Reasonable max limits

---

### AC-2.28.3: Create BOM with Packaging
**Given** creating new BOM
**When** POST /api/technical/boms with packaging fields
**Then** BOM created with packaging:

**POST /api/technical/boms**
```typescript
Request: {
  product_id: uuid,
  routing_id?: uuid,
  // ... existing fields ...
  units_per_box?: number,              // NEW
  boxes_per_pallet?: number            // NEW
}

Response (201): {
  data: {
    id: uuid,
    // ... other fields ...
    units_per_box: number | null,
    boxes_per_pallet: number | null
  }
}

Error (400): { error: "INVALID_UNITS_PER_BOX", message: "Must be positive integer <= 10000" }
Error (400): { error: "INVALID_BOXES_PER_PALLET", message: "Must be positive integer <= 200" }
```

**Success Criteria:**
- ✅ Packaging fields accepted in create
- ✅ Validation applied
- ✅ Null stored if not provided

---

### AC-2.28.4: Update BOM Packaging
**Given** BOM exists
**When** PUT /api/technical/boms/:id with packaging fields
**Then** packaging updated:

**PUT /api/technical/boms/:id**
```typescript
Request: {
  // ... other fields ...
  units_per_box?: number | null,       // Can clear to null
  boxes_per_pallet?: number | null     // Can clear to null
}

Response (200): {
  data: {
    id: uuid,
    units_per_box: number | null,
    boxes_per_pallet: number | null,
    // ... other fields ...
  }
}
```

**Success Criteria:**
- ✅ Can update packaging fields
- ✅ Can clear to null
- ✅ Validation applied on update

---

### AC-2.28.5: Include Packaging in BOM Response
**Given** BOM has packaging configured
**When** GET /api/technical/boms/:id
**Then** packaging fields included:
```typescript
Response (200): {
  data: {
    id: uuid,
    product_id: uuid,
    routing_id: uuid | null,
    // ... other fields ...
    units_per_box: number | null,
    boxes_per_pallet: number | null,
    // Calculated fields (optional)
    units_per_pallet: number | null    // units_per_box * boxes_per_pallet
  }
}
```

**Success Criteria:**
- ✅ Packaging fields in response
- ✅ Optional calculated units_per_pallet

---

### AC-2.28.6: Packaging Calculation Helpers
**Given** BOM has packaging set
**When** calculating packaging quantities
**Then** helpers available:

```typescript
// lib/services/bom-service.ts (additions)
class BomService {
  // Calculate units per pallet
  calculateUnitsPerPallet(bom: Bom): number | null {
    if (bom.units_per_box && bom.boxes_per_pallet) {
      return bom.units_per_box * bom.boxes_per_pallet
    }
    return null
  }

  // Calculate boxes needed for quantity
  calculateBoxesNeeded(quantity: number, unitsPerBox: number): number {
    return Math.ceil(quantity / unitsPerBox)
  }

  // Calculate pallets needed for quantity
  calculatePalletsNeeded(quantity: number, bom: Bom): number | null {
    const unitsPerPallet = this.calculateUnitsPerPallet(bom)
    if (!unitsPerPallet) return null
    return Math.ceil(quantity / unitsPerPallet)
  }

  // Calculate full vs partial pallets
  calculatePackaging(quantity: number, bom: Bom): PackagingBreakdown | null {
    if (!bom.units_per_box || !bom.boxes_per_pallet) return null

    const unitsPerPallet = bom.units_per_box * bom.boxes_per_pallet
    const fullPallets = Math.floor(quantity / unitsPerPallet)
    const remainingUnits = quantity % unitsPerPallet
    const remainingBoxes = Math.ceil(remainingUnits / bom.units_per_box)

    return {
      total_units: quantity,
      units_per_box: bom.units_per_box,
      boxes_per_pallet: bom.boxes_per_pallet,
      units_per_pallet: unitsPerPallet,
      full_pallets: fullPallets,
      partial_pallet_boxes: remainingBoxes,
      partial_pallet_units: remainingUnits,
      total_boxes: (fullPallets * bom.boxes_per_pallet) + remainingBoxes
    }
  }
}
```

**Success Criteria:**
- ✅ Calculation helpers implemented
- ✅ Handle null values gracefully
- ✅ Return breakdown for planning

---

### AC-2.28.7: TypeScript Types
**Given** packaging fields exist
**When** types defined
**Then** following types include packaging:

```typescript
// types/bom.ts (additions)
interface Bom {
  // ... existing fields ...
  units_per_box: number | null
  boxes_per_pallet: number | null
}

interface CreateBomInput {
  // ... existing fields ...
  units_per_box?: number
  boxes_per_pallet?: number
}

interface UpdateBomInput {
  // ... existing fields ...
  units_per_box?: number | null
  boxes_per_pallet?: number | null
}

interface PackagingBreakdown {
  total_units: number
  units_per_box: number
  boxes_per_pallet: number
  units_per_pallet: number
  full_pallets: number
  partial_pallet_boxes: number
  partial_pallet_units: number
  total_boxes: number
}
```

**Success Criteria:**
- ✅ Bom interface includes packaging
- ✅ Input types include packaging
- ✅ PackagingBreakdown type defined

---

### AC-2.28.8: Zod Validation Schema Updates
**Given** Zod schemas exist for BOM
**When** adding packaging validation
**Then** schemas updated:

```typescript
// lib/validation/bom-schemas.ts (additions)
import { z } from 'zod'

// Add to createBomSchema
export const createBomSchema = z.object({
  // ... existing fields ...
  units_per_box: z.number().int().positive().max(10000).optional(),
  boxes_per_pallet: z.number().int().positive().max(200).optional()
})

// Add to updateBomSchema
export const updateBomSchema = z.object({
  // ... existing fields ...
  units_per_box: z.number().int().positive().max(10000).nullable().optional(),
  boxes_per_pallet: z.number().int().positive().max(200).nullable().optional()
})
```

**Success Criteria:**
- ✅ Validation in create schema
- ✅ Nullable in update schema

---

### AC-2.28.9: Packaging Display Formatting
**Given** packaging values exist
**When** displaying in UI
**Then** consistent formatting:

```typescript
// lib/utils/packaging-format.ts
export function formatPackaging(bom: Bom): string | null {
  if (!bom.units_per_box && !bom.boxes_per_pallet) {
    return null
  }

  const parts: string[] = []
  if (bom.units_per_box) {
    parts.push(`${bom.units_per_box} units/box`)
  }
  if (bom.boxes_per_pallet) {
    parts.push(`${bom.boxes_per_pallet} boxes/pallet`)
  }

  const unitsPerPallet = bom.units_per_box && bom.boxes_per_pallet
    ? bom.units_per_box * bom.boxes_per_pallet
    : null

  if (unitsPerPallet) {
    parts.push(`(${unitsPerPallet} units/pallet)`)
  }

  return parts.join(' • ')
}

// Example output: "24 units/box • 40 boxes/pallet (960 units/pallet)"
```

**Success Criteria:**
- ✅ Formatting utility function
- ✅ Handles partial data gracefully
- ✅ Shows calculated units/pallet

---

## Technical Tasks

### Database

- [ ] Task 1: Verify/add packaging columns
  - [ ] Subtask 1.1: Check if units_per_box exists (should be in Story 2.24 migration)
  - [ ] Subtask 1.2: Check if boxes_per_pallet exists
  - [ ] Subtask 1.3: Add ALTER TABLE migration if needed

### Backend

- [ ] Task 2: Update BomService
  - [ ] Subtask 2.1: Add calculateUnitsPerPallet()
  - [ ] Subtask 2.2: Add calculateBoxesNeeded()
  - [ ] Subtask 2.3: Add calculatePalletsNeeded()
  - [ ] Subtask 2.4: Add calculatePackaging()
  - [ ] Subtask 2.5: Ensure create/update handle packaging fields

- [ ] Task 3: Update TypeScript types
  - [ ] Subtask 3.1: Add packaging to Bom interface
  - [ ] Subtask 3.2: Add packaging to input types
  - [ ] Subtask 3.3: Add PackagingBreakdown type

- [ ] Task 4: Update Zod schemas
  - [ ] Subtask 4.1: Add packaging to createBomSchema
  - [ ] Subtask 4.2: Add packaging to updateBomSchema

- [ ] Task 5: Create formatting utility
  - [ ] Subtask 5.1: Create formatPackaging() function
  - [ ] Subtask 5.2: Export from utils

### Testing

- [ ] Task 6: Unit tests - Packaging calculations
  - [ ] Subtask 6.1: Test calculateUnitsPerPallet() with values
  - [ ] Subtask 6.2: Test calculateUnitsPerPallet() with nulls
  - [ ] Subtask 6.3: Test calculateBoxesNeeded()
  - [ ] Subtask 6.4: Test calculatePalletsNeeded()
  - [ ] Subtask 6.5: Test calculatePackaging() full breakdown
  - [ ] Subtask 6.6: Test calculatePackaging() with partial data
  - [ ] Subtask 6.7: Test formatPackaging() variations
  - [ ] Subtask 6.8: Target 95% coverage

- [ ] Task 7: Integration tests - API
  - [ ] Subtask 7.1: Test POST BOM with packaging (201)
  - [ ] Subtask 7.2: Test POST BOM without packaging (201)
  - [ ] Subtask 7.3: Test PUT BOM update packaging (200)
  - [ ] Subtask 7.4: Test PUT BOM clear packaging to null (200)
  - [ ] Subtask 7.5: Test invalid units_per_box (400)
  - [ ] Subtask 7.6: Test invalid boxes_per_pallet (400)
  - [ ] Subtask 7.7: Test GET BOM includes packaging
  - [ ] Subtask 7.8: Target 70% coverage

- [ ] Task 8: E2E tests - Full workflow
  - [ ] Subtask 8.1: Create BOM with packaging: 24 units/box, 40 boxes/pallet
  - [ ] Subtask 8.2: Verify response includes packaging
  - [ ] Subtask 8.3: Update to different values
  - [ ] Subtask 8.4: Clear packaging (set to null)
  - [ ] Subtask 8.5: Verify null values in response

---

## Dependencies

### Requires (must exist before this story)
- Story 2.24: Routing Restructure (creates boms table with packaging columns)

### Blocks (cannot start until this story done)
- Story 2.29: Update existing BOM/Routing UI (UI for packaging fields)
- Epic 4: Production Execution (packaging during output registration)
- Epic 5: License Plates (LP labeling with packaging info)

---

## Dev Notes

### Architecture Patterns
- **Simple extension**: Just adding columns and validation
- **Nullable fields**: Packaging is optional
- **Calculated fields**: units_per_pallet computed, not stored

### Key Decisions
- **Nullable**: Both fields optional (not all products need packaging info)
- **Integer only**: No fractional units/boxes
- **Max limits**: Reasonable practical limits (10000 units, 200 boxes)
- **No product inheritance**: Packaging per BOM, not per product

### Constraints
- units_per_box: 1-10000
- boxes_per_pallet: 1-200
- Both nullable (packaging optional)
- Integer values only

### Example Packaging Configurations
```
Product A (Bottles):
- units_per_box: 24 (24 bottles per case)
- boxes_per_pallet: 40 (40 cases per pallet)
- units_per_pallet: 960 (calculated)

Product B (Bulk Bags):
- units_per_box: 1 (1 bag = 1 unit)
- boxes_per_pallet: 48 (48 bags per pallet)
- units_per_pallet: 48

Product C (No packaging defined):
- units_per_box: null
- boxes_per_pallet: null
```

### Production Use Case
```
Work Order: Produce 1000 units of Product A
Packaging config: 24 units/box, 40 boxes/pallet

calculatePackaging(1000, bom):
{
  total_units: 1000,
  units_per_pallet: 960,
  full_pallets: 1,           // 960 units
  partial_pallet_boxes: 2,   // 40 remaining units = 2 boxes
  partial_pallet_units: 40,
  total_boxes: 42            // 40 + 2
}

Output: 1 full pallet + 2 boxes
```

---

## Status

- **Created:** 2025-11-30
- **Current Status:** Todo
- **Blocked By:** Story 2.24 (BOM table schema)
