# Story 2.29: Update Existing BOM/Routing UI

**Epic:** 2 - Technical/Products
**Batch:** 02A-2-bom-restructure
**Status:** Todo
**Priority:** P0 (Required for usability)
**Story Points:** 5
**Created:** 2025-11-30
**Effort Estimate:** 2-3 days

---

## Goal

Update the existing BOM and Routing UI components to support all new schema features from Stories 2.24-2.28.

## User Story

**As a** Production Engineer
**I want** to manage routings, BOMs, items, alternatives, and packaging through the UI
**So that** I can configure complete production specifications without direct database access

---

## Problem Statement

Current UI needs updates for:
1. **Routing Form** - Remove product selector, add labor_cost per operation
2. **BOM Form** - Add routing selector, production lines multi-select, packaging fields
3. **BOM Item Modal** - Add operation_seq dropdown, is_output checkbox, sequence, line_ids
4. **BOM Items Table** - Group items by operation, show inputs/outputs separately
5. **Alternatives UI** - Manage alternative components per item

---

## Acceptance Criteria

### AC-2.29.1: Routing List Page Updates
**Given** /technical/routings page exists
**When** viewing routing list
**Then** display updated columns:

| Column | Description |
|--------|-------------|
| Name | Routing name (link to detail) |
| Description | Truncated description |
| Operations | Count of operations |
| Status | Active/Inactive badge |
| Created | Date created |
| Actions | Edit, Delete buttons |

**Changes from current:**
- ✅ Remove "Product" column (routings no longer product-bound)
- ✅ Add "Operations" count column
- ✅ Add "Status" badge column

**Success Criteria:**
- ✅ List loads without product column
- ✅ Operations count displayed
- ✅ Active/Inactive status badge

---

### AC-2.29.2: Routing Form Updates
**Given** creating/editing a routing
**When** form is displayed
**Then** show updated fields:

**Form Fields:**
```
┌─────────────────────────────────────────────────┐
│ Routing Form                                     │
├─────────────────────────────────────────────────┤
│ Name*: [________________]                        │
│ Description: [________________]                  │
│ Active: [✓]                                     │
│                                                  │
│ ───────── Operations ─────────                  │
│ [+ Add Operation]                               │
│                                                  │
│ ┌───┬──────────┬──────────┬──────────┬─────┐   │
│ │Seq│ Name*    │ Machine  │ Duration │Labor│   │
│ ├───┼──────────┼──────────┼──────────┼─────┤   │
│ │ 1 │ Mixing   │ Mixer A  │ 30 min   │$25  │   │
│ │ 2 │ Baking   │ Oven 1   │ 45 min   │$20  │   │
│ │ 3 │ Packing  │ (none)   │ 15 min   │$15  │   │
│ └───┴──────────┴──────────┴──────────┴─────┘   │
│                                                  │
│ [Cancel] [Save Routing]                         │
└─────────────────────────────────────────────────┘
```

**Changes from current:**
- ✅ **Remove** Product selector (routing independent)
- ✅ **Add** Labor Cost per Hour column in operations table
- ✅ **Add** inline editing for operations

**Success Criteria:**
- ✅ No product field in form
- ✅ Labor cost editable per operation
- ✅ Operations managed inline (add/edit/delete/reorder)

---

### AC-2.29.3: Routing Operation Row Component
**Given** managing routing operations
**When** adding/editing operation
**Then** show fields:

```typescript
interface RoutingOperationRowProps {
  operation: RoutingOperation
  onUpdate: (data: UpdateOperationInput) => void
  onDelete: () => void
  machines: Machine[]
}

// Fields displayed:
// - Sequence (number input, auto-increment)
// - Name (text input, required)
// - Machine (dropdown, optional)
// - Duration (number input, minutes)
// - Labor Cost/Hour (currency input, optional)
// - Delete button
```

**UI Behavior:**
- Sequence auto-assigned on add (next available)
- Machine dropdown loads from /api/settings/machines
- Duration shows "min" suffix
- Labor cost shows currency symbol
- Delete shows confirmation

**Success Criteria:**
- ✅ All fields editable inline
- ✅ Machine dropdown populated
- ✅ Proper input types (number, currency)
- ✅ Delete confirmation

---

### AC-2.29.4: BOM List Page Updates
**Given** /technical/boms page exists
**When** viewing BOM list
**Then** display updated columns:

| Column | Description |
|--------|-------------|
| Product | Product name/SKU |
| Version | BOM version number |
| Name | BOM name (optional) |
| Routing | Assigned routing name (NEW) |
| Lines | Count of production lines (NEW) |
| Items | Count of BOM items |
| Status | Default/Active badges |
| Actions | Edit, Clone, Delete |

**Changes from current:**
- ✅ Add "Routing" column
- ✅ Add "Lines" count column

**Success Criteria:**
- ✅ Routing name displayed
- ✅ Production lines count shown
- ✅ Click routing name navigates to routing

---

### AC-2.29.5: BOM Form Updates
**Given** creating/editing a BOM
**When** form is displayed
**Then** show updated fields:

**Form Fields:**
```
┌─────────────────────────────────────────────────┐
│ BOM Form                                         │
├─────────────────────────────────────────────────┤
│ Product*: [Dropdown_____________▼]              │
│ Version*: [1__] Name: [________________]        │
│                                                  │
│ Routing: [Select routing...____▼]  (NEW)        │
│                                                  │
│ ───────── Production Lines ─────────  (NEW)     │
│ [Multi-select checkboxes/tags]                  │
│ ☑ Line 1 - Warehouse A                          │
│ ☑ Line 2 - Warehouse A  [Labor: $22/hr]        │
│ ☐ Line 3 - Warehouse B                          │
│                                                  │
│ ───────── Batch Size ─────────                  │
│ Batch Size*: [100___] UOM: [kg_▼]              │
│                                                  │
│ ───────── Packaging ─────────  (NEW)            │
│ Units/Box: [24__] Boxes/Pallet: [40__]         │
│ → 960 units per pallet                          │
│                                                  │
│ ───────── Validity ─────────                    │
│ Effective From: [____/____/____]               │
│ Effective To:   [____/____/____]               │
│ ☑ Default BOM   ☑ Active                       │
│                                                  │
│ Notes: [________________________]               │
│                                                  │
│ [Cancel] [Save BOM]                             │
└─────────────────────────────────────────────────┘
```

**New/Changed Fields:**
- ✅ **Add** Routing selector dropdown
- ✅ **Add** Production Lines multi-select with labor cost override
- ✅ **Add** Packaging section (units_per_box, boxes_per_pallet)
- ✅ **Add** Calculated units_per_pallet display

**Success Criteria:**
- ✅ Routing dropdown populated from /api/technical/routings
- ✅ Production lines multi-select with optional labor cost per line
- ✅ Packaging fields with calculated display
- ✅ All fields saved correctly

---

### AC-2.29.6: Production Lines Multi-Select Component
**Given** assigning production lines to BOM
**When** selecting lines
**Then** component provides:

```typescript
interface ProductionLinesSelectProps {
  selectedLines: Array<{
    line_id: string
    labor_cost_per_hour?: number
  }>
  onChange: (lines: ProductionLinesSelectProps['selectedLines']) => void
  availableLines: ProductionLine[]
}

// UI Features:
// - Checkbox list or tag-style multi-select
// - Each line shows: Line Name, Warehouse Name
// - Optional labor cost input per selected line
// - "Select All" / "Clear All" buttons
```

**Success Criteria:**
- ✅ Lines grouped by warehouse (optional)
- ✅ Labor cost override per line
- ✅ Clear visual selection state

---

### AC-2.29.7: BOM Items Table Grouped by Operation
**Given** BOM has items assigned to operations
**When** viewing BOM items
**Then** display grouped by operation:

```
┌─────────────────────────────────────────────────┐
│ BOM Items                        [+ Add Item]   │
├─────────────────────────────────────────────────┤
│                                                  │
│ ▼ Operation 1: Mixing                           │
│   INPUTS:                                        │
│   ┌──────┬──────────────┬───────┬───────┬────┐ │
│   │ Seq  │ Component    │ Qty   │ Scrap │ ▤  │ │
│   ├──────┼──────────────┼───────┼───────┼────┤ │
│   │ 1    │ Flour        │ 10 kg │ 2%    │ ✎ │ │
│   │ 2    │ Sugar        │ 5 kg  │ 0%    │ ✎ │ │
│   └──────┴──────────────┴───────┴───────┴────┘ │
│   OUTPUTS: (none)                               │
│                                                  │
│ ▼ Operation 2: Baking                           │
│   INPUTS:                                        │
│   ┌──────┬──────────────┬───────┬───────┬────┐ │
│   │ 1    │ Dough (op 1) │ 15 kg │ 5%    │ ✎ │ │
│   └──────┴──────────────┴───────┴───────┴────┘ │
│   OUTPUTS:                                       │
│   ┌──────┬──────────────┬───────┬───────┬────┐ │
│   │ 1    │ Crumbs (by)  │ 0.5kg │ -     │ ✎ │ │
│   └──────┴──────────────┴───────┴───────┴────┘ │
│                                                  │
│ ▼ Operation 3: Packaging                        │
│   INPUTS:                                        │
│   │ 1    │ Boxes        │ 10 ea │ 0%    │ ✎ │ │
│   OUTPUTS:                                       │
│   │ 1    │ Cookies (FG) │ 10 kg │ -     │ ✎ │ │
│                                                  │
└─────────────────────────────────────────────────┘
```

**Features:**
- ✅ Collapsible operation sections
- ✅ Inputs and Outputs separated
- ✅ Operation name from routing (if assigned)
- ✅ Sequence within operation
- ✅ Byproduct indicator "(by)" for outputs

**Success Criteria:**
- ✅ Items grouped by operation_seq
- ✅ Inputs/outputs visually separated
- ✅ Operation names from routing displayed
- ✅ Edit/delete actions per item

---

### AC-2.29.8: BOM Item Modal Updates
**Given** adding/editing BOM item
**When** modal is displayed
**Then** show all new fields:

**Modal Fields:**
```
┌─────────────────────────────────────────────────┐
│ Add/Edit BOM Item                               │
├─────────────────────────────────────────────────┤
│ Component*: [Search products...____▼]           │
│                                                  │
│ ───────── Assignment ─────────                  │
│ Operation*: [Op 1: Mixing_________▼]  (NEW)    │
│ Sequence:   [1__] (order within operation)     │
│                                                  │
│ ───────── Quantity ─────────                    │
│ Quantity*: [10____] UOM*: [kg_▼]               │
│ Scrap %:   [2__]%                               │
│                                                  │
│ ───────── Type ─────────  (NEW)                 │
│ ○ Input (material to consume)                   │
│ ● Output (byproduct/co-product)                │
│                                                  │
│ ───────── Line Assignment ─────────  (NEW)      │
│ ○ All production lines                          │
│ ● Specific lines:                               │
│   ☑ Line 1 - Warehouse A                        │
│   ☐ Line 2 - Warehouse A                        │
│                                                  │
│ ───────── Options ─────────  (NEW)              │
│ ☐ Consume whole License Plate                   │
│                                                  │
│ Notes: [________________________]               │
│                                                  │
│ ───────── Alternatives ─────────  (NEW)         │
│ [+ Add Alternative]                             │
│ 1. Alt Flour (ratio: 1.0)  [Edit] [×]          │
│ 2. Generic Flour (ratio: 1.1) [Edit] [×]       │
│                                                  │
│ [Cancel] [Save Item]                            │
└─────────────────────────────────────────────────┘
```

**New Fields:**
- ✅ **Operation** dropdown (from routing operations)
- ✅ **Sequence** within operation
- ✅ **Input/Output** radio buttons (is_output)
- ✅ **Line Assignment** (all or specific lines)
- ✅ **Consume Whole LP** checkbox
- ✅ **Alternatives** section (inline management)

**Success Criteria:**
- ✅ Operation dropdown populated from BOM's routing
- ✅ Line options from BOM's production lines
- ✅ Alternatives manageable inline
- ✅ All fields save correctly

---

### AC-2.29.9: Alternative Component Management
**Given** BOM item has/needs alternatives
**When** managing alternatives
**Then** inline UI provides:

```typescript
interface AlternativesManagerProps {
  alternatives: BomItemAlternative[]
  onAdd: (alt: CreateAlternativeInput) => void
  onUpdate: (altId: string, data: UpdateAlternativeInput) => void
  onDelete: (altId: string) => void
  primaryComponentId: string  // To prevent adding primary as alt
}

// UI Features:
// - List of alternatives with priority numbers
// - Add button opens product search
// - Quantity ratio input per alternative
// - Delete button per alternative
// - Drag to reorder (updates priority)
```

**Success Criteria:**
- ✅ Add alternative via product search
- ✅ Edit ratio inline
- ✅ Delete with confirmation
- ✅ Reorder changes priority

---

### AC-2.29.10: Operation Dropdown Component
**Given** BOM has routing assigned
**When** selecting operation for item
**Then** dropdown shows routing operations:

```typescript
interface OperationDropdownProps {
  routingId: string | null
  value: number  // operation_seq
  onChange: (seq: number) => void
}

// If no routing: Show "Default (1)" option only
// If routing: Show all operations from routing
//   Format: "1: Mixing" | "2: Baking" | "3: Packaging"
```

**Success Criteria:**
- ✅ Shows routing operations if routing assigned
- ✅ Shows default option if no routing
- ✅ Format: "Seq: Name"

---

### AC-2.29.11: BOM Detail Page Updates
**Given** viewing BOM detail page
**When** page loads
**Then** display all new information:

**Sections:**
1. **Header** - Product, Version, Name, Status badges
2. **Routing** (NEW) - Linked routing with operations preview
3. **Production Lines** (NEW) - Assigned lines with labor costs
4. **Packaging** (NEW) - Units/box, boxes/pallet, calculated
5. **Validity** - Effective dates, default flag
6. **Items** - Grouped by operation (AC-2.29.7)
7. **Notes**

**Success Criteria:**
- ✅ All sections display correctly
- ✅ Routing clickable to navigate
- ✅ Lines show labor cost overrides
- ✅ Packaging shows calculated units/pallet

---

### AC-2.29.12: Validation & Error Handling
**Given** user makes invalid input
**When** submitting forms
**Then** clear error messages shown:

| Error | Message |
|-------|---------|
| Duplicate routing name | "A routing with this name already exists" |
| Invalid operation sequence | "Operation sequence {seq} not found in routing" |
| Line not in BOM | "Line must be assigned to this BOM first" |
| Self-reference input | "Cannot use the BOM's product as an input" |
| Duplicate alternative | "This component is already an alternative" |

**Success Criteria:**
- ✅ Field-level validation errors
- ✅ Form-level error messages
- ✅ Toast notifications for API errors

---

## Technical Tasks

### Frontend Components

- [ ] Task 1: Update RoutingForm component
  - [ ] Subtask 1.1: Remove product selector field
  - [ ] Subtask 1.2: Add labor_cost_per_hour to operation rows
  - [ ] Subtask 1.3: Create inline operation editor
  - [ ] Subtask 1.4: Add drag-to-reorder operations
  - [ ] Subtask 1.5: Update form validation

- [ ] Task 2: Update RoutingList component
  - [ ] Subtask 2.1: Remove product column
  - [ ] Subtask 2.2: Add operations count column
  - [ ] Subtask 2.3: Add status badge column

- [ ] Task 3: Create ProductionLinesSelect component
  - [ ] Subtask 3.1: Multi-select checkbox UI
  - [ ] Subtask 3.2: Labor cost override input per line
  - [ ] Subtask 3.3: Group by warehouse option
  - [ ] Subtask 3.4: Select all / clear all buttons

- [ ] Task 4: Update BOMForm component
  - [ ] Subtask 4.1: Add routing dropdown
  - [ ] Subtask 4.2: Add ProductionLinesSelect
  - [ ] Subtask 4.3: Add packaging fields section
  - [ ] Subtask 4.4: Add calculated units_per_pallet display
  - [ ] Subtask 4.5: Update form state and validation

- [ ] Task 5: Update BOMList component
  - [ ] Subtask 5.1: Add routing column
  - [ ] Subtask 5.2: Add production lines count column

- [ ] Task 6: Create BOMItemsGrouped component
  - [ ] Subtask 6.1: Group items by operation_seq
  - [ ] Subtask 6.2: Separate inputs/outputs sections
  - [ ] Subtask 6.3: Collapsible operation headers
  - [ ] Subtask 6.4: Operation name from routing

- [ ] Task 7: Update BOMItemModal component
  - [ ] Subtask 7.1: Add operation dropdown
  - [ ] Subtask 7.2: Add sequence field
  - [ ] Subtask 7.3: Add is_output radio buttons
  - [ ] Subtask 7.4: Add line assignment selector
  - [ ] Subtask 7.5: Add consume_whole_lp checkbox
  - [ ] Subtask 7.6: Add alternatives section
  - [ ] Subtask 7.7: Update form validation

- [ ] Task 8: Create OperationDropdown component
  - [ ] Subtask 8.1: Load operations from routing
  - [ ] Subtask 8.2: Handle no routing case
  - [ ] Subtask 8.3: Format options

- [ ] Task 9: Create AlternativesManager component
  - [ ] Subtask 9.1: List view with priority
  - [ ] Subtask 9.2: Add alternative modal/inline
  - [ ] Subtask 9.3: Edit ratio inline
  - [ ] Subtask 9.4: Delete confirmation
  - [ ] Subtask 9.5: Reorder functionality

- [ ] Task 10: Update BOMDetail page
  - [ ] Subtask 10.1: Add routing section
  - [ ] Subtask 10.2: Add production lines section
  - [ ] Subtask 10.3: Add packaging section
  - [ ] Subtask 10.4: Integrate BOMItemsGrouped

### Testing

- [ ] Task 11: Unit tests - Components
  - [ ] Subtask 11.1: Test RoutingForm without product field
  - [ ] Subtask 11.2: Test ProductionLinesSelect multi-select
  - [ ] Subtask 11.3: Test BOMItemsGrouped grouping logic
  - [ ] Subtask 11.4: Test OperationDropdown states
  - [ ] Subtask 11.5: Test AlternativesManager CRUD
  - [ ] Subtask 11.6: Test BOMItemModal new fields
  - [ ] Subtask 11.7: Target 80% coverage

- [ ] Task 12: Integration tests - Forms
  - [ ] Subtask 12.1: Test routing create/edit flow
  - [ ] Subtask 12.2: Test BOM create with all new fields
  - [ ] Subtask 12.3: Test BOM item create with operation/lines
  - [ ] Subtask 12.4: Test alternatives management
  - [ ] Subtask 12.5: Target 70% coverage

- [ ] Task 13: E2E tests - Full workflows
  - [ ] Subtask 13.1: Create routing with 3 operations + labor costs
  - [ ] Subtask 13.2: Create BOM with routing and 2 production lines
  - [ ] Subtask 13.3: Add item to operation 1 with line assignment
  - [ ] Subtask 13.4: Add output item (byproduct) to operation 2
  - [ ] Subtask 13.5: Add 2 alternatives to an item
  - [ ] Subtask 13.6: Verify grouped display on BOM detail
  - [ ] Subtask 13.7: Update BOM packaging fields
  - [ ] Subtask 13.8: Verify all data persists correctly

---

## Dependencies

### Requires (must exist before this story)
- Story 2.24: Routing Restructure (new routing schema + API)
- Story 2.25: BOM Production Lines (junction table + API)
- Story 2.26: BOM Items with Operation Assignment (new item schema + API)
- Story 2.27: BOM Item Alternatives (alternatives table + API)
- Story 2.28: BOM Packaging Fields (packaging columns + API)

### Blocks (cannot start until this story done)
- Epic 4: Production Execution (needs UI to create BOMs with operations)
- User acceptance testing for batch 02A-2

---

## Dev Notes

### Architecture Patterns
- **Component composition**: Small reusable components (OperationDropdown, ProductionLinesSelect)
- **Grouped display**: BOMItemsGrouped handles operation grouping logic
- **Inline editing**: Operations and alternatives editable without separate pages
- **State management**: React Query for API data, local state for form edits

### Key Decisions
- **Inline alternatives**: Manage alternatives within item modal, not separate page
- **Grouped items**: Visual grouping by operation improves UX
- **Multi-select pattern**: Checkboxes with optional per-item overrides (labor cost)
- **Collapsible sections**: Operations collapsible for large BOMs

### Constraints
- Operation dropdown requires BOM routing to be selected first
- Line assignment requires BOM production lines to be assigned first
- Output items cannot have alternatives (only inputs)

### Component Hierarchy
```
BOMDetail
├── BOMHeader (product, version, status)
├── BOMRoutingSection (routing link, operations preview)
├── BOMProductionLinesSection (lines with labor costs)
├── BOMPackagingSection (packaging fields)
├── BOMItemsGrouped
│   ├── OperationGroup (per operation_seq)
│   │   ├── InputItemsTable
│   │   │   └── ItemRow (with alternatives indicator)
│   │   └── OutputItemsTable
│   │       └── ItemRow
│   └── ...more operations
└── BOMNotesSection

BOMItemModal
├── ComponentSearch
├── OperationDropdown
├── QuantityInputs
├── TypeRadio (input/output)
├── LineAssignmentSelect
├── ConsumeWholeLPCheckbox
└── AlternativesManager
    ├── AlternativesList
    └── AddAlternativeButton
```

### Existing Components to Modify
- `apps/frontend/components/technical/RoutingForm.tsx`
- `apps/frontend/components/technical/RoutingList.tsx`
- `apps/frontend/components/technical/BOMForm.tsx`
- `apps/frontend/components/technical/BOMList.tsx`
- `apps/frontend/components/technical/BOMItemModal.tsx`
- `apps/frontend/app/(authenticated)/technical/boms/[id]/page.tsx`

### New Components to Create
- `apps/frontend/components/technical/ProductionLinesSelect.tsx`
- `apps/frontend/components/technical/OperationDropdown.tsx`
- `apps/frontend/components/technical/BOMItemsGrouped.tsx`
- `apps/frontend/components/technical/AlternativesManager.tsx`
- `apps/frontend/components/technical/OperationRow.tsx`

---

## Status

- **Created:** 2025-11-30
- **Current Status:** Todo
- **Blocked By:** Stories 2.24-2.28 (all backend stories in batch)
