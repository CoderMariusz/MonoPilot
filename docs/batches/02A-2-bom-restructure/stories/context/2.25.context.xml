<?xml version="1.0" encoding="UTF-8"?>
<story>
  <metadata>
    <id>2.25</id>
    <title>BOM Production Lines</title>
    <batch>02A-2-bom-restructure</batch>
    <points>3</points>
    <effort_hours>8-16</effort_hours>
    <priority>P0</priority>
    <status>todo</status>
  </metadata>

  <description>
    Enable BOMs to be assigned to multiple production lines with optional labor cost overrides per line.
    Creates many-to-many relationship via bom_production_lines junction table.
  </description>

  <dependencies>
    <blocks>
      <story id="2.26">BOM Items with Operation Assignment (uses line_ids)</story>
      <story id="2.29">Update existing BOM/Routing UI</story>
    </blocks>
    <requires>
      <story id="2.24">Routing Restructure (creates boms table)</story>
      <story id="1.8">Production Line Configuration</story>
    </requires>
  </dependencies>

  <technical_context>
    <tables>
      <table>
        <name>bom_production_lines</name>
        <action>CREATE (junction table)</action>
        <columns>
          <column name="id" type="UUID" nullable="false" default="gen_random_uuid()" pk="true"/>
          <column name="bom_id" type="UUID" nullable="false" fk="boms(id) ON DELETE CASCADE"/>
          <column name="line_id" type="UUID" nullable="false" fk="production_lines(id)"/>
          <column name="labor_cost_per_hour" type="DECIMAL(10,2)" nullable="true"/>
          <column name="created_at" type="TIMESTAMPTZ" nullable="false" default="now()"/>
        </columns>
        <constraints>
          <unique columns="bom_id, line_id"/>
        </constraints>
        <indexes>
          <index name="idx_bom_production_lines_bom" columns="bom_id"/>
          <index name="idx_bom_production_lines_line" columns="line_id"/>
        </indexes>
        <rls enabled="true">
          <policy name="Enable all for authenticated" operation="ALL" role="authenticated"/>
        </rls>
        <notes>labor_cost_per_hour overrides routing operation default</notes>
      </table>
    </tables>

    <api_endpoints>
      <endpoint method="GET" path="/api/technical/boms/:id/lines">
        <description>Get production lines assigned to BOM</description>
        <response status="200">
          <field name="data" type="array">
            <item>
              <field name="id" type="uuid"/>
              <field name="bom_id" type="uuid"/>
              <field name="line_id" type="uuid"/>
              <field name="line" type="object">
                <field name="id" type="uuid"/>
                <field name="name" type="string"/>
                <field name="warehouse_id" type="uuid"/>
                <field name="warehouse" type="object"/>
              </field>
              <field name="labor_cost_per_hour" type="number | null"/>
              <field name="created_at" type="timestamp"/>
            </item>
          </field>
        </response>
        <errors>
          <error code="BOM_NOT_FOUND" status="404"/>
        </errors>
      </endpoint>

      <endpoint method="PUT" path="/api/technical/boms/:id/lines">
        <description>Bulk replace all line assignments for BOM</description>
        <body>
          <field name="lines" type="array" required="true">
            <item>
              <field name="line_id" type="uuid" required="true"/>
              <field name="labor_cost_per_hour" type="decimal" required="false"/>
            </item>
          </field>
        </body>
        <response status="200">Updated array of BomProductionLine objects</response>
        <errors>
          <error code="INVALID_LINE" status="400" message="Line {id} not found"/>
          <error code="DUPLICATE_LINE" status="400" message="Line {id} appears multiple times"/>
          <error code="INVALID_LINE_ORG" status="400" message="Line belongs to different org"/>
          <error code="BOM_NOT_FOUND" status="404"/>
        </errors>
        <notes>Bulk replace approach: DELETE all existing, INSERT new from request</notes>
      </endpoint>
    </api_endpoints>

    <services>
      <service name="BomService" path="lib/services/bom-service.ts">
        <method name="getProductionLines" params="bomId: string" returns="Promise&lt;BomProductionLine[]&gt;"/>
        <method name="setProductionLines" params="bomId: string, lines: Array&lt;{ line_id: string; labor_cost_per_hour?: number }&gt;" returns="Promise&lt;BomProductionLine[]&gt;"/>
        <method name="getLaborCostForLine" params="bomId: string, lineId: string" returns="Promise&lt;number | null&gt;"/>
        <method name="getAvailableLines" params="orgId: string" returns="Promise&lt;ProductionLine[]&gt;"/>
        <method name="calculateLaborCost" params="bomId: string, lineId: string, batchSize: number" returns="Promise&lt;LaborCostBreakdown&gt;"/>
      </service>
    </services>

    <types>
      <type name="BomProductionLine">
        <field name="id" type="string"/>
        <field name="bom_id" type="string"/>
        <field name="line_id" type="string"/>
        <field name="line" type="ProductionLine" optional="true"/>
        <field name="labor_cost_per_hour" type="number | null"/>
        <field name="created_at" type="string"/>
      </type>

      <type name="SetBomLinesInput">
        <field name="lines" type="Array&lt;{ line_id: string; labor_cost_per_hour?: number }&gt;"/>
      </type>

      <type name="BomWithLines">
        <extends>Bom</extends>
        <field name="production_lines" type="BomProductionLine[]"/>
      </type>

      <type name="LaborCostBreakdown">
        <field name="total_labor_cost" type="number"/>
        <field name="breakdown" type="Array&lt;{ operation_seq: number; operation_name: string; duration_minutes: number; cost_per_hour: number; cost: number }&gt;"/>
      </type>
    </types>

    <validation_schemas>
      <schema name="bomProductionLineItemSchema">
        <field name="line_id" rule="z.string().uuid()"/>
        <field name="labor_cost_per_hour" rule="z.number().min(0).max(9999.99).optional()"/>
      </schema>

      <schema name="setBomLinesSchema">
        <field name="lines" rule="z.array(bomProductionLineItemSchema).refine(noDuplicateLineIds)"/>
      </schema>
    </validation_schemas>
  </technical_context>

  <acceptance_criteria>
    <ac id="2.25.1">Create bom_production_lines junction table with all columns</ac>
    <ac id="2.25.2">Enable RLS with authenticated policy</ac>
    <ac id="2.25.3">GET /api/technical/boms/:id/lines returns lines with joined data</ac>
    <ac id="2.25.4">PUT /api/technical/boms/:id/lines bulk replaces all assignments</ac>
    <ac id="2.25.5">Validation: line_ids must exist, no duplicates, same org</ac>
    <ac id="2.25.6">Include production_lines in GET /api/technical/boms/:id response</ac>
    <ac id="2.25.7">Implement BomService line management methods</ac>
    <ac id="2.25.8">Define TypeScript types for BomProductionLine</ac>
    <ac id="2.25.9">Create Zod validation schemas with duplicate check</ac>
    <ac id="2.25.10">Implement calculateLaborCost() with line override priority</ac>
  </acceptance_criteria>

  <test_plan>
    <unit_tests target="95%">
      <test>getProductionLines() returns correct data</test>
      <test>setProductionLines() replaces all lines</test>
      <test>setProductionLines() with empty array clears all</test>
      <test>setProductionLines() with labor_cost override</test>
      <test>Invalid line_id returns error</test>
      <test>Duplicate line_id returns error</test>
      <test>Cross-org line assignment blocked</test>
      <test>calculateLaborCost() uses line override when set</test>
      <test>calculateLaborCost() uses routing default as fallback</test>
    </unit_tests>

    <integration_tests target="70%">
      <test>GET /api/technical/boms/:id/lines (200)</test>
      <test>PUT /api/technical/boms/:id/lines (200)</test>
      <test>PUT with invalid line_id (400)</test>
      <test>PUT with duplicate line_id (400)</test>
      <test>BOM not found (404)</test>
      <test>org_id isolation enforced</test>
      <test>Auth required (401)</test>
    </integration_tests>

    <e2e_tests>
      <test>Create BOM</test>
      <test>Assign 2 production lines via PUT</test>
      <test>Verify GET returns both lines</test>
      <test>Update to 1 line (remove one)</test>
      <test>Verify only 1 line remains</test>
      <test>Clear all lines (empty array)</test>
      <test>Verify no lines assigned</test>
      <test>Test labor_cost_per_hour override</test>
    </e2e_tests>
  </test_plan>

  <implementation_notes>
    <note type="pattern">Bulk replace pattern - simpler than add/remove individual</note>
    <note type="cascade">Lines removed when BOM deleted (ON DELETE CASCADE)</note>
    <note type="cost_priority">Labor cost hierarchy: line override > routing default > 0</note>
    <note type="validation">Empty lines array allowed (clears all assignments)</note>
    <note type="validation">line_ids must belong to same org as BOM</note>
  </implementation_notes>
</story>
