<?xml version="1.0" encoding="UTF-8"?>
<story>
  <metadata>
    <id>2.24</id>
    <title>Routing Restructure</title>
    <batch>02A-2-bom-restructure</batch>
    <points>3</points>
    <effort_hours>8-16</effort_hours>
    <priority>P0</priority>
    <status>todo</status>
  </metadata>

  <description>
    Restructure routing system by removing product binding and adding labor cost per operation.
    Routings become reusable templates assigned via BOM.routing_id.
    BREAKING CHANGE: Drops existing routing tables and recreates with new schema.
  </description>

  <dependencies>
    <blocks>
      <story id="2.25">BOM Production Lines</story>
      <story id="2.26">BOM Items with Operation Assignment</story>
      <story id="2.29">Update existing BOM/Routing UI</story>
    </blocks>
    <requires>
      <epic id="1">Organizations, Users, Auth</epic>
      <story id="1.7">Machine Configuration</story>
    </requires>
  </dependencies>

  <technical_context>
    <tables>
      <table>
        <name>routings</name>
        <action>DROP CASCADE then CREATE</action>
        <columns>
          <column name="id" type="UUID" nullable="false" default="gen_random_uuid()" pk="true"/>
          <column name="org_id" type="UUID" nullable="false" fk="organizations(id)"/>
          <column name="name" type="TEXT" nullable="false"/>
          <column name="description" type="TEXT" nullable="true"/>
          <column name="is_active" type="BOOLEAN" nullable="false" default="true"/>
          <column name="created_at" type="TIMESTAMPTZ" nullable="false" default="now()"/>
          <column name="updated_at" type="TIMESTAMPTZ" nullable="false" default="now()"/>
        </columns>
        <constraints>
          <unique columns="org_id, name"/>
        </constraints>
        <indexes>
          <index name="idx_routings_org" columns="org_id"/>
        </indexes>
        <rls enabled="true">
          <policy name="Enable all for authenticated" operation="ALL" role="authenticated"/>
        </rls>
        <notes>NO product_id column - routings are independent templates</notes>
      </table>

      <table>
        <name>routing_operations</name>
        <action>DROP CASCADE then CREATE</action>
        <columns>
          <column name="id" type="UUID" nullable="false" default="gen_random_uuid()" pk="true"/>
          <column name="routing_id" type="UUID" nullable="false" fk="routings(id) ON DELETE CASCADE"/>
          <column name="sequence" type="INTEGER" nullable="false"/>
          <column name="name" type="TEXT" nullable="false"/>
          <column name="description" type="TEXT" nullable="true"/>
          <column name="machine_id" type="UUID" nullable="true" fk="machines(id)"/>
          <column name="estimated_duration_minutes" type="INTEGER" nullable="true"/>
          <column name="labor_cost_per_hour" type="DECIMAL(10,2)" nullable="true"/>
          <column name="created_at" type="TIMESTAMPTZ" nullable="false" default="now()"/>
        </columns>
        <constraints>
          <unique columns="routing_id, sequence"/>
        </constraints>
        <indexes>
          <index name="idx_routing_operations_routing" columns="routing_id"/>
        </indexes>
        <rls enabled="true">
          <policy name="Enable all for authenticated" operation="ALL" role="authenticated"/>
        </rls>
        <notes>NEW column: labor_cost_per_hour for cost tracking</notes>
      </table>
    </tables>

    <api_endpoints>
      <endpoint method="GET" path="/api/technical/routings">
        <description>List all routings for organization</description>
        <query_params>
          <param name="org_id" type="uuid" required="false"/>
          <param name="is_active" type="boolean" required="false"/>
        </query_params>
        <response status="200">Array of Routing objects with operations_count</response>
      </endpoint>

      <endpoint method="POST" path="/api/technical/routings">
        <description>Create new routing</description>
        <body>
          <field name="name" type="string" required="true" max="100"/>
          <field name="description" type="string" required="false" max="500"/>
          <field name="is_active" type="boolean" required="false" default="true"/>
        </body>
        <response status="201">Created Routing object</response>
        <errors>
          <error code="DUPLICATE_NAME" status="400"/>
        </errors>
      </endpoint>

      <endpoint method="GET" path="/api/technical/routings/:id">
        <description>Get routing with operations</description>
        <response status="200">Routing object with operations array</response>
        <errors>
          <error code="NOT_FOUND" status="404"/>
        </errors>
      </endpoint>

      <endpoint method="PUT" path="/api/technical/routings/:id">
        <description>Update routing</description>
        <body>
          <field name="name" type="string" required="false"/>
          <field name="description" type="string" required="false"/>
          <field name="is_active" type="boolean" required="false"/>
        </body>
        <response status="200">Updated Routing object</response>
        <errors>
          <error code="DUPLICATE_NAME" status="400"/>
          <error code="NOT_FOUND" status="404"/>
        </errors>
      </endpoint>

      <endpoint method="DELETE" path="/api/technical/routings/:id">
        <description>Delete routing (fails if used by BOMs)</description>
        <response status="200">Success message</response>
        <errors>
          <error code="NOT_FOUND" status="404"/>
          <error code="IN_USE" status="400" message="Routing is used by X BOMs"/>
        </errors>
      </endpoint>

      <endpoint method="GET" path="/api/technical/routings/:id/operations">
        <description>List operations for routing</description>
        <response status="200">Array of RoutingOperation objects ordered by sequence</response>
      </endpoint>

      <endpoint method="POST" path="/api/technical/routings/:id/operations">
        <description>Add operation to routing</description>
        <body>
          <field name="sequence" type="integer" required="true" min="1"/>
          <field name="name" type="string" required="true" max="100"/>
          <field name="description" type="string" required="false"/>
          <field name="machine_id" type="uuid" required="false"/>
          <field name="estimated_duration_minutes" type="integer" required="false" max="10000"/>
          <field name="labor_cost_per_hour" type="decimal" required="false" max="9999.99"/>
        </body>
        <response status="201">Created RoutingOperation object</response>
        <errors>
          <error code="DUPLICATE_SEQUENCE" status="400"/>
          <error code="INVALID_MACHINE" status="400"/>
        </errors>
      </endpoint>

      <endpoint method="PUT" path="/api/technical/routings/:id/operations/:opId">
        <description>Update operation</description>
        <response status="200">Updated RoutingOperation object</response>
      </endpoint>

      <endpoint method="DELETE" path="/api/technical/routings/:id/operations/:opId">
        <description>Delete operation</description>
        <response status="200">Success message</response>
      </endpoint>
    </api_endpoints>

    <services>
      <service name="RoutingService" path="lib/services/routing-service.ts">
        <method name="list" params="orgId: string, filters?: { is_active?: boolean }" returns="Promise&lt;Routing[]&gt;"/>
        <method name="getById" params="id: string, orgId: string" returns="Promise&lt;Routing | null&gt;"/>
        <method name="create" params="data: CreateRoutingInput, orgId: string" returns="Promise&lt;Routing&gt;"/>
        <method name="update" params="id: string, data: UpdateRoutingInput, orgId: string" returns="Promise&lt;Routing&gt;"/>
        <method name="delete" params="id: string, orgId: string" returns="Promise&lt;void&gt;"/>
        <method name="listOperations" params="routingId: string" returns="Promise&lt;RoutingOperation[]&gt;"/>
        <method name="addOperation" params="routingId: string, data: CreateOperationInput" returns="Promise&lt;RoutingOperation&gt;"/>
        <method name="updateOperation" params="routingId: string, opId: string, data: UpdateOperationInput" returns="Promise&lt;RoutingOperation&gt;"/>
        <method name="deleteOperation" params="routingId: string, opId: string" returns="Promise&lt;void&gt;"/>
        <method name="checkRoutingInUse" params="routingId: string" returns="Promise&lt;{ inUse: boolean, bomCount: number }&gt;"/>
      </service>
    </services>

    <types>
      <type name="Routing">
        <field name="id" type="string"/>
        <field name="org_id" type="string"/>
        <field name="name" type="string"/>
        <field name="description" type="string | null"/>
        <field name="is_active" type="boolean"/>
        <field name="created_at" type="string"/>
        <field name="updated_at" type="string"/>
        <field name="operations" type="RoutingOperation[]" optional="true"/>
      </type>

      <type name="RoutingOperation">
        <field name="id" type="string"/>
        <field name="routing_id" type="string"/>
        <field name="sequence" type="number"/>
        <field name="name" type="string"/>
        <field name="description" type="string | null"/>
        <field name="machine_id" type="string | null"/>
        <field name="machine" type="{ id: string; name: string } | null" optional="true"/>
        <field name="estimated_duration_minutes" type="number | null"/>
        <field name="labor_cost_per_hour" type="number | null"/>
        <field name="created_at" type="string"/>
      </type>
    </types>

    <validation_schemas>
      <schema name="createRoutingSchema">
        <field name="name" rule="z.string().min(1).max(100)"/>
        <field name="description" rule="z.string().max(500).optional()"/>
        <field name="is_active" rule="z.boolean().optional().default(true)"/>
      </schema>

      <schema name="createOperationSchema">
        <field name="sequence" rule="z.number().int().positive()"/>
        <field name="name" rule="z.string().min(1).max(100)"/>
        <field name="description" rule="z.string().max(500).optional()"/>
        <field name="machine_id" rule="z.string().uuid().optional()"/>
        <field name="estimated_duration_minutes" rule="z.number().int().min(0).max(10000).optional()"/>
        <field name="labor_cost_per_hour" rule="z.number().min(0).max(9999.99).optional()"/>
      </schema>
    </validation_schemas>
  </technical_context>

  <acceptance_criteria>
    <ac id="2.24.1">Drop existing routing_operations and routings tables CASCADE</ac>
    <ac id="2.24.2">Create new routings table WITHOUT product_id, with UNIQUE(org_id, name)</ac>
    <ac id="2.24.3">Create new routing_operations table WITH labor_cost_per_hour</ac>
    <ac id="2.24.4">Enable RLS with authenticated policies on both tables</ac>
    <ac id="2.24.5">Implement all 5 routing CRUD endpoints</ac>
    <ac id="2.24.6">Implement all 4 operation CRUD endpoints</ac>
    <ac id="2.24.7">Enforce validation rules (name unique, sequence unique, etc.)</ac>
    <ac id="2.24.8">Implement RoutingService with all methods</ac>
    <ac id="2.24.9">Define TypeScript interfaces for Routing and RoutingOperation</ac>
    <ac id="2.24.10">Create Zod validation schemas</ac>
  </acceptance_criteria>

  <test_plan>
    <unit_tests target="95%">
      <test>list() with filters returns correct routings</test>
      <test>create() success with valid data</test>
      <test>create() fails with duplicate name</test>
      <test>update() success with partial data</test>
      <test>delete() success when not in use</test>
      <test>delete() fails when used by BOMs</test>
      <test>addOperation() success with valid sequence</test>
      <test>addOperation() fails with duplicate sequence</test>
      <test>labor_cost_per_hour stored correctly</test>
    </unit_tests>

    <integration_tests target="70%">
      <test>All routing endpoints return correct status codes</test>
      <test>All operation endpoints return correct status codes</test>
      <test>org_id isolation enforced</test>
      <test>Auth required (401 without token)</test>
    </integration_tests>

    <e2e_tests>
      <test>Create routing via API</test>
      <test>Add 3 operations with labor costs</test>
      <test>Update operation labor cost</test>
      <test>Verify operations ordered by sequence</test>
      <test>Delete routing cascades operations</test>
    </e2e_tests>
  </test_plan>

  <implementation_notes>
    <note type="breaking">This is a BREAKING migration - all existing routing data will be lost</note>
    <note type="pattern">No product_id - routings assigned via boms.routing_id instead</note>
    <note type="validation">Sequence must be unique per routing</note>
    <note type="deletion">Cannot delete routing if used by any BOM</note>
    <note type="cascade">Operations deleted when routing deleted (ON DELETE CASCADE)</note>
  </implementation_notes>
</story>
