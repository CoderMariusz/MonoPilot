<?xml version="1.0" encoding="UTF-8"?>
<story>
  <metadata>
    <id>2.28</id>
    <title>BOM Packaging Fields</title>
    <batch>02A-2-bom-restructure</batch>
    <points>1</points>
    <effort_hours>4</effort_hours>
    <priority>P2</priority>
    <status>todo</status>
  </metadata>

  <description>
    Add packaging configuration fields (units_per_box, boxes_per_pallet) to BOMs
    to define how finished products are packaged for warehouse storage.
  </description>

  <dependencies>
    <blocks>
      <story id="2.29">Update existing BOM/Routing UI</story>
    </blocks>
    <requires>
      <story id="2.24">Routing Restructure (creates boms table with packaging columns)</story>
    </requires>
  </dependencies>

  <technical_context>
    <tables>
      <table>
        <name>boms</name>
        <action>ALTER (add columns if not in initial migration)</action>
        <columns_to_add>
          <column name="units_per_box" type="INTEGER" nullable="true"/>
          <column name="boxes_per_pallet" type="INTEGER" nullable="true"/>
        </columns_to_add>
        <notes>
          Both columns nullable - packaging info is optional
          Should already be in Story 2.24 migration per tech-spec
        </notes>
      </table>
    </tables>

    <api_updates>
      <endpoint method="POST" path="/api/technical/boms">
        <new_fields>
          <field name="units_per_box" type="integer" required="false" min="1" max="10000"/>
          <field name="boxes_per_pallet" type="integer" required="false" min="1" max="200"/>
        </new_fields>
        <errors>
          <error code="INVALID_UNITS_PER_BOX" status="400"/>
          <error code="INVALID_BOXES_PER_PALLET" status="400"/>
        </errors>
      </endpoint>

      <endpoint method="PUT" path="/api/technical/boms/:id">
        <new_fields>
          <field name="units_per_box" type="integer | null" required="false"/>
          <field name="boxes_per_pallet" type="integer | null" required="false"/>
        </new_fields>
        <notes>Can set to null to clear packaging config</notes>
      </endpoint>

      <endpoint method="GET" path="/api/technical/boms/:id">
        <response_additions>
          <field name="units_per_box" type="number | null"/>
          <field name="boxes_per_pallet" type="number | null"/>
          <field name="units_per_pallet" type="number | null" computed="true"/>
        </response_additions>
      </endpoint>
    </api_updates>

    <services>
      <service name="BomService" path="lib/services/bom-service.ts">
        <new_methods>
          <method name="calculateUnitsPerPallet" params="bom: Bom" returns="number | null">
            <logic>
              if (bom.units_per_box &amp;&amp; bom.boxes_per_pallet) {
                return bom.units_per_box * bom.boxes_per_pallet
              }
              return null
            </logic>
          </method>

          <method name="calculateBoxesNeeded" params="quantity: number, unitsPerBox: number" returns="number">
            <logic>return Math.ceil(quantity / unitsPerBox)</logic>
          </method>

          <method name="calculatePalletsNeeded" params="quantity: number, bom: Bom" returns="number | null">
            <logic>
              const unitsPerPallet = this.calculateUnitsPerPallet(bom)
              if (!unitsPerPallet) return null
              return Math.ceil(quantity / unitsPerPallet)
            </logic>
          </method>

          <method name="calculatePackaging" params="quantity: number, bom: Bom" returns="PackagingBreakdown | null">
            <logic>
              if (!bom.units_per_box || !bom.boxes_per_pallet) return null

              const unitsPerPallet = bom.units_per_box * bom.boxes_per_pallet
              const fullPallets = Math.floor(quantity / unitsPerPallet)
              const remainingUnits = quantity % unitsPerPallet
              const remainingBoxes = Math.ceil(remainingUnits / bom.units_per_box)

              return {
                total_units: quantity,
                units_per_box: bom.units_per_box,
                boxes_per_pallet: bom.boxes_per_pallet,
                units_per_pallet: unitsPerPallet,
                full_pallets: fullPallets,
                partial_pallet_boxes: remainingBoxes,
                partial_pallet_units: remainingUnits,
                total_boxes: (fullPallets * bom.boxes_per_pallet) + remainingBoxes
              }
            </logic>
          </method>
        </new_methods>
      </service>
    </services>

    <types>
      <type name="Bom" update="true">
        <add_fields>
          <field name="units_per_box" type="number | null"/>
          <field name="boxes_per_pallet" type="number | null"/>
        </add_fields>
      </type>

      <type name="CreateBomInput" update="true">
        <add_fields>
          <field name="units_per_box" type="number" optional="true"/>
          <field name="boxes_per_pallet" type="number" optional="true"/>
        </add_fields>
      </type>

      <type name="UpdateBomInput" update="true">
        <add_fields>
          <field name="units_per_box" type="number | null" optional="true"/>
          <field name="boxes_per_pallet" type="number | null" optional="true"/>
        </add_fields>
      </type>

      <type name="PackagingBreakdown">
        <field name="total_units" type="number"/>
        <field name="units_per_box" type="number"/>
        <field name="boxes_per_pallet" type="number"/>
        <field name="units_per_pallet" type="number"/>
        <field name="full_pallets" type="number"/>
        <field name="partial_pallet_boxes" type="number"/>
        <field name="partial_pallet_units" type="number"/>
        <field name="total_boxes" type="number"/>
      </type>
    </types>

    <validation_schemas>
      <schema name="createBomSchema" update="true">
        <add_fields>
          <field name="units_per_box" rule="z.number().int().positive().max(10000).optional()"/>
          <field name="boxes_per_pallet" rule="z.number().int().positive().max(200).optional()"/>
        </add_fields>
      </schema>

      <schema name="updateBomSchema" update="true">
        <add_fields>
          <field name="units_per_box" rule="z.number().int().positive().max(10000).nullable().optional()"/>
          <field name="boxes_per_pallet" rule="z.number().int().positive().max(200).nullable().optional()"/>
        </add_fields>
      </schema>
    </validation_schemas>

    <utilities>
      <utility name="formatPackaging" path="lib/utils/packaging-format.ts">
        <input>bom: Bom</input>
        <output>string | null</output>
        <example_output>"24 units/box â€¢ 40 boxes/pallet (960 units/pallet)"</example_output>
      </utility>
    </utilities>
  </technical_context>

  <acceptance_criteria>
    <ac id="2.28.1">BOM table has units_per_box and boxes_per_pallet columns</ac>
    <ac id="2.28.2">Validation: positive integers within limits (10000, 200)</ac>
    <ac id="2.28.3">POST BOM accepts packaging fields</ac>
    <ac id="2.28.4">PUT BOM updates packaging (can clear to null)</ac>
    <ac id="2.28.5">GET BOM includes packaging with calculated units_per_pallet</ac>
    <ac id="2.28.6">Implement packaging calculation helpers</ac>
    <ac id="2.28.7">Update TypeScript Bom interface</ac>
    <ac id="2.28.8">Update Zod schemas with packaging validation</ac>
    <ac id="2.28.9">Create formatPackaging utility function</ac>
  </acceptance_criteria>

  <test_plan>
    <unit_tests target="95%">
      <test>calculateUnitsPerPallet() with both values set</test>
      <test>calculateUnitsPerPallet() returns null if missing values</test>
      <test>calculateBoxesNeeded() correct ceiling</test>
      <test>calculatePalletsNeeded() correct calculation</test>
      <test>calculatePackaging() full breakdown</test>
      <test>calculatePackaging() returns null if partial config</test>
      <test>formatPackaging() various scenarios</test>
    </unit_tests>

    <integration_tests target="70%">
      <test>POST BOM with packaging (201)</test>
      <test>POST BOM without packaging (201)</test>
      <test>PUT BOM update packaging (200)</test>
      <test>PUT BOM clear packaging to null (200)</test>
      <test>Invalid units_per_box (400)</test>
      <test>Invalid boxes_per_pallet (400)</test>
      <test>GET BOM includes packaging fields</test>
    </integration_tests>

    <e2e_tests>
      <test>Create BOM with packaging: 24 units/box, 40 boxes/pallet</test>
      <test>Verify response includes packaging</test>
      <test>Update to different values</test>
      <test>Clear packaging (set to null)</test>
      <test>Verify null values in response</test>
    </e2e_tests>
  </test_plan>

  <implementation_notes>
    <note type="simple">Simple column additions + validation + helpers</note>
    <note type="nullable">Both fields optional - not all products need packaging</note>
    <note type="integers">Integer values only - no fractional units</note>
    <note type="limits">Reasonable max: 10000 units, 200 boxes</note>
    <note type="calculated">units_per_pallet is computed, not stored</note>
  </implementation_notes>

  <examples>
    <example name="Bottles">
      <units_per_box>24</units_per_box>
      <boxes_per_pallet>40</boxes_per_pallet>
      <units_per_pallet>960</units_per_pallet>
    </example>

    <example name="Bulk Bags">
      <units_per_box>1</units_per_box>
      <boxes_per_pallet>48</boxes_per_pallet>
      <units_per_pallet>48</units_per_pallet>
    </example>

    <example name="Production calculation">
      <quantity>1000</quantity>
      <config>24 units/box, 40 boxes/pallet</config>
      <result>
        <full_pallets>1</full_pallets>
        <partial_pallet_boxes>2</partial_pallet_boxes>
        <partial_pallet_units>40</partial_pallet_units>
        <total_boxes>42</total_boxes>
      </result>
    </example>
  </examples>
</story>
