# Story 5.11b: GRN Integration (ASN/PO Updates)

**ID:** 5.11b
**Batch:** 5A-3 (Receiving) - SPLIT from 5.11 (Part 2)
**Story Points:** 3
**Effort:** 4-5 hours
**Status:** Todo
**Created:** 2025-11-28 (split from complex 5.11)

---

## User Story

> As a **System**, I want to update ASN and PO status when GRNs are received, so that procurement status reflects actual inventory.

---

## Goal

Implement **ASN status updates**, **PO received quantity tracking**, **PO completion logic**, and **TO status updates** (Transfer Order).

---

## Acceptance Criteria

### AC 1: ASN Status Update (From ASN Receiving)

**Given** GRN created from ASN
**When** receiving completes (GRN created)
**Then**:
- ASN status updated based on receipt quantity:
  - If all items received (received_qty = ordered_qty for all items): asn.status â†’ 'completed'
  - If partial items received (any received_qty < ordered_qty): asn.status â†’ 'received'
- ASN completion_date set to receiving_date
- ASN can still be updated with additional receipts if status = 'received'

### AC 2: PO Line Received Quantity Update

**Given** GRN created from PO (or ad-hoc with PO reference)
**When** processing grn_items
**Then** for each item linked to PO:
- UPDATE po_line.received_qty += grn_item_qty
- Example: PO line ordered 100kg, receive 30kg â†’ received_qty = 30
- Can receive in multiple GRNs: 30kg + 40kg + 30kg = 100kg total

### AC 3: PO Line Status Update

**Given** PO line received
**When** received_qty updated
**Then** update po_line status:
- If received_qty >= ordered_qty: po_line.status â†’ 'received'
- If received_qty = 0: po_line.status â†’ 'pending'
- If 0 < received_qty < ordered_qty: po_line.status â†’ 'partial'

### AC 4: PO Header Status Update (Completion Check)

**Given** PO line status updated
**When** checking all lines in PO
**Then** update PO header status:
- If ALL lines have status = 'received': po.status â†’ 'received'
- If ANY line has status = 'pending': po.status â†’ 'open' (not completed)
- If ALL lines have status != 'pending': po.status â†’ 'received'
- Update po.received_date = current receiving_date

### AC 5: TO (Transfer Order) Status Update

**Given** GRN created from TO (if applicable)
**When** receiving completes
**Then** update TO status:
- If all items received: to.status â†’ 'received'
- If partial items: to.status â†’ 'partial'
- Set to.received_date = receiving_date

### AC 6: Status Update Audit Trail

**Given** status changes occur
**When** ASN/PO/TO updated
**Then** record:
- updated_by_user_id = current user
- updated_at = current timestamp
- operation_type = 'grn_received' (for audit log)

---

## Technical Tasks

### Backend

- [ ] Extend GRN endpoint (from 5.11a) with integration logic:
  - After INSERT grn and grn_items
  - Check source_type:

    **If source_type = 'asn':**
    - Query ASN to get all ordered items
    - Calculate total received vs ordered per line
    - Update asn.status:
      - 'completed' if all items fully received
      - 'received' if partial items
    - Set asn.completion_date = receiving_date

    **If source_type = 'po':**
    - For each grn_item with product_id:
      - Find PO lines with same product_id and po_id
      - UPDATE po_line.received_qty += grn_qty
      - UPDATE po_line.status based on new received_qty
    - Check all PO lines:
      - If ALL lines 'received': UPDATE po.status â†’ 'received'
      - Update po.received_date
    - Log: "PO updated: 3 lines, 1 complete, 2 partial"

    **If source_type = 'to':**
    - Find TO and update status
    - Similar to ASN logic
    - Set to.received_date

  - Transaction: These updates still within GRN creation transaction (added in 5.11c)

- [ ] Implement PO completion calculation:
  - Query: SELECT COUNT(*) WHERE po_id = X AND status != 'received'
  - If count = 0: po is complete
  - Update po.status â†’ 'received'

- [ ] Add status update logging (audit trail):
  - When ASN/PO/TO status changes
  - Log operation_type, old_status, new_status, user_id, timestamp

### Database

- [ ] Verify PO fields exist:
  - po_line.received_qty (default 0)
  - po_line.status (default 'pending')
  - po.received_date (nullable)
  - po.status (default 'open')

- [ ] Verify TO fields exist:
  - to.status (default 'open')
  - to.received_date (nullable)

- [ ] Verify ASN fields exist:
  - asn.status (default 'open')
  - asn.completion_date (nullable)

- [ ] Create status_history table (optional, for audit):
  ```sql
  CREATE TABLE status_history (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    entity_type VARCHAR(20) NOT NULL, -- 'asn', 'po', 'po_line', 'to'
    entity_id UUID NOT NULL,
    old_status VARCHAR(20),
    new_status VARCHAR(20) NOT NULL,
    operation_type VARCHAR(50), -- 'grn_received', 'manual_update', etc
    changed_by_user_id UUID REFERENCES users(id),
    changed_at TIMESTAMPTZ DEFAULT now(),
    org_id UUID NOT NULL REFERENCES organizations(id)
  );
  ```

- [ ] Add indexes:
  - status_history: (entity_type, entity_id), (changed_at)

### Frontend

- [ ] Update GRN receive modal:
  - When selecting "From ASN": Show ASN number autocomplete
  - After GRN created:
    - Show success message with ASN status update info
    - Example: "GRN-20250127-0001 created. ASN-12345 marked as completed."

- [ ] Update GRN detail page:
  - Show source info: "From ASN-12345" with link to ASN detail
  - Display PO reference (if from PO): "From PO-67890"
  - Show impact: "Updated 3 PO lines: 1 received, 2 partial"

- [ ] Update ASN detail page:
  - Show ASN status (updated when GRN received)
  - Display received items list:
    - Item, Ordered Qty, Received Qty, % Complete
  - Show GRN list (all GRNs created from this ASN)

- [ ] Update PO detail page:
  - Show PO status (updated when GRN received)
  - For each line:
    - Product, Ordered Qty, Received Qty, Status, % Complete
    - Link to GRN that partially/fully received this line
  - Show "Received Date" when all lines complete

- [ ] Display status badges:
  - ASN: open=ðŸŸ¡, completed=ðŸŸ¢, partial=ðŸŸ 
  - PO: open=ðŸŸ¡, received=ðŸŸ¢, partial=ðŸŸ 
  - PO Line: pending=âšª, partial=ðŸŸ , received=ðŸŸ¢

---

## Testing

### Unit Tests

- ASN status calculation:
  - All items received â†’ 'completed'
  - Some items received â†’ 'received'
  - No items received â†’ 'open'

- PO line received_qty:
  - First receipt: 30kg â†’ received_qty = 30
  - Second receipt: 40kg â†’ received_qty = 70
  - Verify arithmetic

- PO status calculation:
  - 3 lines, all 'received' â†’ PO 'received'
  - 3 lines, 1 'pending', 2 'received' â†’ PO 'open'
  - All lines 'partial' â†’ PO 'open'

- TO status: similar to ASN

### Integration Tests

- GRN creation from ASN:
  - Verify ASN status updated
  - Verify asn.completion_date set

- GRN creation from PO:
  - Verify po_line.received_qty incremented
  - Verify po_line.status updated
  - Verify PO status updated if all lines complete

- Partial PO receiving:
  - Create PO: 100kg
  - First GRN: 30kg â†’ po_line status = 'partial'
  - Second GRN: 70kg â†’ po_line status = 'received', PO status = 'received'

- Status history logging:
  - Verify status_history records created
  - Verify old_status, new_status, user_id logged

### E2E Tests

- Create ASN with 2 items
- Create GRN from ASN, receive all items
- Navigate to ASN detail â†’ verify status = 'completed'
- Go back to GRN detail â†’ shows "ASN marked completed"

- Create PO with 2 lines: 100kg each
- Create first GRN with 50kg
- Verify: PO line status = 'partial', PO status = 'open'
- Create second GRN with 50kg
- Verify: PO line status = 'received', PO status = 'received'
- Verify: PO received_date populated

---

## Acceptance Criteria Checklist

- âœ… ASN status updated to 'completed' on full receipt
- âœ… ASN status = 'received' on partial receipt
- âœ… PO line received_qty incremented with each GRN
- âœ… PO line status updated (pending/partial/received)
- âœ… PO header status updated when all lines received
- âœ… TO status updated (if applicable)
- âœ… Audit trail records status changes
- âœ… Status badges display correctly

---

## Dependencies

**Requires:**
- Story 5.1 (LP Creation)
- Story 5.11a (GRN & LP Creation)
- Story 5.8 (ASN Creation - if using ASN)
- Story 5.4 (PO Management - if using PO)

**Enables:**
- Story 5.11c (Transaction Atomicity - wraps this logic)
- Story 5.13 (PO Dashboard - displays updated statuses)

**Blocked By:** None

---

## Notes

- Part 2 of 3: Focus on status update logic
- Integration with existing ASN/PO/TO workflows
- Audit trail helps track receiving history
- Transaction atomicity for all updates added in 5.11c
- PO completion check critical for procurement closing
