# Story 5.13: Update PO/TO Received Qty

**ID:** 5.13
**Batch:** 5A-3 (Receiving)
**Story Points:** 3
**Effort:** 3-4 hours
**Status:** Todo

---

## User Story

> As a **System**, I want to update PO/TO quantities on receiving, so that status is accurate.

---

## Acceptance Criteria

### AC 1: PO received_qty Update
- **Given** GRN created from PO
- **When** goods received
- **Then** po_line.received_qty updated:
  - received_qty += grn_item.received_qty
  - Example: PO ordered 100 kg, receive 50 kg → received_qty becomes 50

### AC 2: PO Status Transition
- **Given** PO with multiple lines
- **When** all lines received >= ordered_qty
- **Then** PO status automatically transitions:
  - pending → confirmed → received
  - Example: 3 lines, ordered [100, 50, 75] kg
    - Receive [100, 0, 0] → 1 line done, PO still pending
    - Receive [0, 50, 75] → all lines done, PO → 'closed'

### AC 3: Partial Receives
- **Given** PO line with 100 kg ordered
- **When** receiving multiple times:
  - Receive 1: 50 kg → received_qty = 50
  - Receive 2: 40 kg → received_qty = 90
  - Receive 3: 10 kg → received_qty = 100, line complete
- **Then** each receive accumulates in received_qty

### AC 4: Transfer Order Updates
- **Given** TO linked to GRN
- **When** receiving goods
- **Then** to_line.received_qty updated same as PO
- **And** TO status transitions: pending → shipped → received

### AC 5: Over-Receipt Handling
- **Given** PO line ordered 100 kg
- **When** receiving 110 kg (over-receipt allowed)
- **Then**:
  - po_line.received_qty = 110 (exceeds ordered)
  - PO marked with warning: "⚠️ Over-receipt detected on line"
  - PO status still updates to 'closed'

---

## Technical Tasks

### Backend

- [ ] Update GRN creation endpoint
  - After grn_items inserted: Update po_lines
  - For each grn_item with po_line_id:
    - UPDATE po_lines SET received_qty = received_qty + grn_item.received_qty
  - For each PO: Check if all lines complete
  - If all lines: UPDATE po SET status = 'closed'
  - Same logic for Transfer Orders (TO)

- [ ] Create helper function: `finalize_po_status(po_id)`
  - Check if all po_lines have received_qty >= ordered_qty
  - If yes: UPDATE po.status → 'closed', po.closed_at = now()
  - If no: Keep status as is

- [ ] Same for TO: `finalize_to_status(to_id)`

- [ ] Add audit fields (optional):
  - po.closed_at: TIMESTAMP (when PO closed)
  - po_line.completed_at: TIMESTAMP (when line complete)

### Database

- [ ] Verify po_lines table has:
  - received_qty: DECIMAL (initially 0)
  - ordered_qty: DECIMAL
  - completed_date: TIMESTAMP (nullable, set when line complete)

- [ ] Verify po table has:
  - status: VARCHAR (pending, confirmed, received, closed)
  - closed_at: TIMESTAMP (nullable)

- [ ] Verify to_lines table has received_qty
- [ ] Verify to table has status transitions

### Frontend

- [ ] Update PO detail page
  - Show received_qty for each line
  - Progress bar: received / ordered
  - Example: "50 / 100 kg (50%)"

- [ ] Update GRN detail page
  - Show PO link with status update confirmation
  - Message: "PO ABC123 updated: Line 1 (100 kg received)"

- [ ] Update PO list page
  - Show status: pending, confirmed, received, closed
  - Color coding: pending=yellow, confirmed=blue, closed=green

---

## Testing

### Unit Tests
- Qty accumulation: 50 + 40 + 10 = 100 ✓
- Status transition: pending → closed when all lines received
- Over-receipt: received > ordered, status still closes
- Partial receive: not all lines complete, PO stays pending

### Integration Tests
- POST /api/warehouse/grns with po_id
- Verify: po_line.received_qty incremented
- Verify: po.status = 'closed' if all lines complete
- POST another GRN to same PO
- Verify: received_qty accumulates correctly
- Test TO updates same as PO

### E2E Tests
- Create PO with 2 lines (100 kg and 50 kg)
- View PO detail: both lines show 0 received
- Receive 100 kg for line 1 → PO detail updates to show 100 received, line 1 progress 100%
- Line 2 still 0 → PO status still pending
- Receive 50 kg for line 2 → PO status → 'closed'
- View PO list: PO shows as closed (green)

---

## Acceptance Criteria Checklist

- ✅ po_line.received_qty updated on GRN creation
- ✅ PO status automatically closed when all lines received
- ✅ Partial receives accumulate correctly
- ✅ Transfer Order updates same as PO
- ✅ Over-receipt handled correctly
- ✅ Progress shown in UI (received / ordered)

---

## Dependencies

**Requires:** Story 5.11 (GRN and LP Creation)

**Enables:** None directly (closing receiving workflow)

---

## Notes

- Automatic status update simplifies PO tracking
- Accumulation of received_qty allows multiple receives per line
- Over-receipt allowed (configurable) but qty still accumulated
- Audit trail: Can see when PO closed and by whom (from grn.created_by_user_id)
