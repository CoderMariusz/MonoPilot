# Story 5.10: Over-Receipt Validation

**ID:** 5.10
**Batch:** 5A-3 (Receiving)
**Story Points:** 3
**Effort:** 3-4 hours
**Status:** Todo

---

## User Story

> As a **System**, I want to validate receiving against PO, so that we don't receive more than ordered.

---

## Acceptance Criteria

### AC 1: Over-Receipt Detection
- **Given** receiving against PO line
- **When** received_qty would exceed ordered_qty
- **Then** system detects over-receipt
- **And** shows summary: "Ordered: 100 kg, Already Received: 50 kg, Receiving: 60 kg = 110 kg (Over by 10 kg)"

### AC 2: Over-Receipt Action
- **Given** over-receipt detected
- **When** checking warehouse_settings.allow_over_receipt
- **Then**:
  - If allow_over_receipt = false: Block receipt with error message
  - If allow_over_receipt = true: Warn user but allow proceeding

### AC 3: Warning Message
- **Given** over-receipt allowed but flagged
- **When** receiving
- **Then** show warning banner: "⚠️ Over-receipt detected: Ordered 100 kg, receiving 110 kg"

### AC 4: Validation Per Line
- **Given** GRN with multiple items
- **When** checking over-receipt
- **Then** validate each line independently
- **And** allow partial lines to be valid while others flagged

### AC 5: Configuration Setting
- **Given** Admin navigates to /settings/warehouse
- **When** viewing settings
- **Then** can toggle: "Allow Over-Receipt" (default: false)

---

## Technical Tasks

### Backend

- [ ] Create validation function: `check_over_receipt(po_line_id, received_qty)`
  - Query: SUM(received_qty) from grn_items WHERE po_line_id
  - Calculate: total_received + received_qty
  - Compare: total_received + received_qty > ordered_qty
  - Return: boolean over_receipt_detected

- [ ] Update receiving endpoint to call validation
  - Call check_over_receipt for each grn_item
  - If over-receipt and allow_over_receipt = false: Return 400 error
  - If over-receipt and allow_over_receipt = true: Log warning, allow proceed

- [ ] Add warehouse_settings column: allow_over_receipt (boolean, default false)

### Database

- [ ] Add allow_over_receipt column to warehouse_settings table
  - Type: BOOLEAN DEFAULT false
  - Index: warehouse_id (for quick lookup)

### Frontend

- [ ] Update receiving form: Add validation warning
  - Before submit, calculate over-receipt status
  - If over-receipt and allowed: Show warning banner
  - If over-receipt and not allowed: Show error, disable submit button

- [ ] Create settings toggle in `/settings/warehouse`
  - Toggle: "Allow Over-Receipt"
  - Help text: "If enabled, warehouse users can receive more than ordered quantity"

---

## Testing

### Unit Tests
- Over-receipt calculation: 100 ordered, 50 received, receiving 60 → over by 10
- Over-receipt blocked when setting = false
- Over-receipt allowed when setting = true
- Per-line validation: mix of valid and over-receipt lines

### Integration Tests
- POST /api/warehouse/grns with over-receipt, setting false → 400 error
- POST /api/warehouse/grns with over-receipt, setting true → 200 success with warning
- Verify grn_items created correctly despite over-receipt

### E2E Tests
- Create PO with 100 kg ordered
- Receive 50 kg (OK)
- Try to receive 60 kg (over by 10)
- With allow_over_receipt = false: Error message shown, cannot proceed
- Change setting to true
- Try again: Warning shown, allowed to proceed
- Verify both receives recorded in GRN

---

## Acceptance Criteria Checklist

- ✅ Over-receipt detected when received > ordered
- ✅ Action based on warehouse_settings.allow_over_receipt
- ✅ Clear warning message with quantities shown
- ✅ Per-line validation
- ✅ Admin configurable toggle

---

## Dependencies

**Requires:** Story 5.8 (ASN Creation), Story 5.11 (GRN Creation)

**Enables:** Story 5.13 (Update PO/TO Received Qty)

---

## Notes

- Over-receipt validation important for inventory accuracy
- Configurable toggle allows flexibility per warehouse
- Per-line validation allows partial receipts
- Should integrate with PO received_qty tracking
