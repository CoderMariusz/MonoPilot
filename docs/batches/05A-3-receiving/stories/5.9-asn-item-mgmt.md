# Story 5.9: ASN Item Management

**ID:** 5.9
**Batch:** 5A-3 (Receiving)
**Story Points:** 3
**Effort:** 3-4 hours
**Status:** Todo

---

## User Story

> As a **Warehouse user**, I want to manage ASN items, so that I know what's arriving.

---

## Acceptance Criteria

### AC 1: Edit ASN Items
- **Given** ASN detail page
- **When** clicking "Edit" on asn_items table
- **Then** inline edit mode enables fields:
  - supplier_batch_number (text)
  - manufacture_date (date picker)
  - expiry_date (date picker)
  - quantity (numeric, editable for partial shipments)

### AC 2: Batch and Expiry Fields
- **Given** editing asn_item
- **When** entering batch and expiry dates
- **Then** fields store:
  - supplier_batch_number: From supplier's packing slip
  - manufacture_date: Product manufacturing date
  - expiry_date: Product expiration date

### AC 3: Quantity Adjustment
- **Given** ASN item quantity differs from PO
- **When** editing quantity (partial shipment expected)
- **Then** system allows adjustment
- **And** warning shown if adjusted < PO ordered qty

### AC 4: Pre-fill from Supplier Metadata
- **Given** PO has supplier linked
- **When** creating ASN
- **Then** system pre-fills (if available):
  - supplier_batch_number: From supplier catalog
  - manufacture_date: Default if applicable
  - expiry_date: From supplier metadata

### AC 5: Validation on Save
- **Given** editing asn_items
- **When** clicking "Save"
- **Then** validate:
  - quantity > 0
  - if manufacture_date filled: manufacture_date < expiry_date
  - fields required per product type (perishables require expiry)

---

## Technical Tasks

### Backend

- [ ] Create `PUT /api/warehouse/asns/:id/items` endpoint
  - Accept: asn_items array with updates
  - Validate: quantity > 0, manufacture_date < expiry_date
  - Update asn_items table
  - Return: Updated ASN with items

- [ ] Add supplier metadata service
  - Get supplier batch/manufacture date info if available
  - Use for pre-fill during ASN creation

- [ ] Add validation: manufacture_date < expiry_date

### Database

- [ ] Verify asn_items columns exist:
  - supplier_batch_number
  - manufacture_date
  - expiry_date
  - quantity (allow updates)

### Frontend

- [ ] Update ASN items table: Add inline edit mode
  - Click row to edit
  - Show date pickers for dates
  - Numeric input for quantity
  - Save/Cancel buttons

- [ ] Add validation feedback:
  - Highlight invalid cells (red border)
  - Show error message: "Manufacture date must be before expiry date"

- [ ] Add "Save Changes" button at table footer
  - Disabled if no changes
  - Shows confirmation after save

---

## Testing

### Unit Tests
- Quantity validation: 0, negative → error
- Date validation: manufacture > expiry → error
- Valid updates: all fields updated correctly

### Integration Tests
- PUT /api/warehouse/asns/:id/items with valid updates
- Verify asn_items updated in database
- Verify quantity constraints respected

### E2E Tests
- Open ASN detail
- Click edit on first item
- Change supplier_batch_number, expiry_date
- Click Save
- Verify changes persisted and displayed

---

## Acceptance Criteria Checklist

- ✅ ASN items editable inline
- ✅ Batch number, manufacture date, expiry date updatable
- ✅ Quantity adjustable for partial shipments
- ✅ Validation: manufacture < expiry
- ✅ Pre-fill from supplier metadata

---

## Dependencies

**Requires:** Story 5.8 (ASN Creation)

**Enables:** Story 5.11 (GRN Creation)

---

## Notes

- Batch and expiry tracking critical for perishables
- Quantity edit allows handling partial/split shipments
- Pre-fill reduces manual data entry
