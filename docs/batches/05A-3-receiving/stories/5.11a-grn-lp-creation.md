# Story 5.11a: GRN & LP Creation (Basic)

**ID:** 5.11a
**Batch:** 5A-3 (Receiving) - SPLIT from 5.11 (Part 1)
**Story Points:** 3
**Effort:** 4-5 hours
**Status:** Todo
**Created:** 2025-11-28 (split from complex 5.11)

---

## User Story

> As a **Warehouse user**, I want to create GRNs and auto-generate LPs, so that received goods are recorded with inventory tracking numbers.

---

## Goal

Implement **GRN creation**, **GRN number auto-generation**, and **LP auto-creation from GRN items** (happy path only).

---

## Acceptance Criteria

### AC 1: GRN Creation Modal

**Given** warehouse user ready to receive goods
**When** opening receive modal
**Then**:
- Form shows:
  - GRN source selector: "From ASN" / "From PO" / "Ad-hoc"
  - ASN/PO number field (if selected)
  - GRN items table (editable):
    - Product (dropdown/autocomplete)
    - Received quantity (number)
    - Supplier batch number (text, pre-filled if from ASN/PO)
    - Manufacture date (optional)
    - Expiry date (optional)
    - Location (dropdown, defaults to default warehouse location)
    - QA Status (dropdown, defaults to warehouse default)
  - Notes field (optional, text)
  - "Create GRN" and "Cancel" buttons

### AC 2: Auto-generate GRN Number

**Given** valid GRN form submitted
**When** creating GRN
**Then**:
- GRN number auto-generated:
  - Format: `GRN-YYYYMMDD-NNNN` (e.g., GRN-20250127-0001)
  - YYYYMMDD = receiving date (today)
  - NNNN = daily sequence counter (resets at midnight)
  - Example: GRN-20250127-0001, GRN-20250127-0002
  - Unique per org_id

### AC 3: LP Auto-creation from GRN Items

**Given** GRN created
**When** processing each grn_item
**Then** for each item, system creates license_plates:
- Auto-generate lp_number (format: `LP-YYYYMMDD-NNNN`, creation date = GRN date)
- Set qty = received_qty
- Set product_id (from grn_item)
- Set supplier_batch_number (from grn_item, for FDA traceability)
- Set manufacture_date (from grn_item, optional)
- Set expiry_date (from grn_item, optional)
- Set location_id (from grn_item)
- Set qa_status (from grn_item)
- Set status = 'available'
- Set org_id, created_by_user_id, warehouse_id

### AC 4: Link LP to GRN

**Given** LP created from GRN
**When** storing in database
**Then**:
- grn_item references lp_id
- LP can be traced back to GRN via grn_item.grn_id
- LP detail shows: "Created from GRN-20250127-0001"

### AC 5: Data Validation (Basic)

**Given** form data entered
**When** validating before submit
**Then**:
- Product must be selected (required)
- Received qty must be > 0 (required)
- Expiry date >= manufacture date (if both provided)
- Location must be selected (required)
- Show error messages inline for invalid fields

### AC 6: Success Feedback

**Given** GRN + LPs created successfully
**When** operation completes
**Then**:
- Show success message: "GRN-20250127-0001 created with 3 LPs"
- Display GRN summary:
  - GRN number
  - Item count
  - LP numbers created
- Option to: "View GRN Detail" or "Continue Receiving"

---

## Technical Tasks

### Backend

- [ ] Create `POST /api/warehouse/grns` endpoint (BASIC, no atomicity yet)
  - Accept: source ('asn', 'po', 'adhoc'), source_id, grn_items[], notes (optional)
  - Validate basic data (product exists, qty > 0)
  - Auto-generate GRN number using grn_number_sequence table
  - INSERT grn record with:
    - grn_number (auto-generated)
    - org_id, warehouse_id
    - receiving_date = today
    - source_type ('asn', 'po', 'adhoc')
    - source_id (nullable)
    - status = 'created' (not updated yet)
    - created_by_user_id
  - For each grn_item:
    - Validate: product_id exists, qty > 0
    - Auto-generate lp_number using lp_number_sequence
    - INSERT license_plates record with all fields
    - INSERT grn_item record with lp_id
  - Return: GRN with created LP details

- [ ] Create grn_number_sequence table
  - Similar to lp_number_sequence
  - Columns: org_id, warehouse_id, sequence_date, next_sequence
  - INSERT row on first GRN of day
  - Increment on each GRN creation

- [ ] Add basic error handling
  - Product not found: "Product SKU 'ABC123' does not exist"
  - Invalid qty: "Received quantity must be > 0"
  - Location not found: "Location 'WH-A-01' does not exist"

### Database

- [ ] Create grn table:
  ```sql
  CREATE TABLE grns (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id UUID NOT NULL REFERENCES organizations(id),
    warehouse_id UUID NOT NULL REFERENCES warehouses(id),
    grn_number VARCHAR(50) NOT NULL,
    source_type VARCHAR(20) NOT NULL, -- 'asn', 'po', 'adhoc'
    source_id UUID,  -- asn_id or po_id (nullable for adhoc)
    receiving_date DATE NOT NULL,
    status VARCHAR(20) NOT NULL DEFAULT 'created',
    notes TEXT,
    created_by_user_id UUID NOT NULL REFERENCES users(id),
    created_at TIMESTAMPTZ DEFAULT now(),
    updated_at TIMESTAMPTZ DEFAULT now(),
    UNIQUE(org_id, grn_number)
  );
  ```

- [ ] Create grn_items table:
  ```sql
  CREATE TABLE grn_items (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    grn_id UUID NOT NULL REFERENCES grns(id),
    lp_id UUID NOT NULL REFERENCES license_plates(id),
    product_id UUID NOT NULL REFERENCES products(id),
    qty DECIMAL(10,3) NOT NULL,
    uom VARCHAR(20),
    supplier_batch_number VARCHAR(100),
    manufacture_date DATE,
    expiry_date DATE,
    location_id UUID REFERENCES warehouse_locations(id),
    qa_status VARCHAR(20) DEFAULT 'pass',
    created_at TIMESTAMPTZ DEFAULT now()
  );
  ```

- [ ] Create grn_number_sequence table:
  ```sql
  CREATE TABLE grn_number_sequence (
    id SERIAL PRIMARY KEY,
    org_id UUID NOT NULL REFERENCES organizations(id),
    warehouse_id UUID NOT NULL REFERENCES warehouses(id),
    sequence_date DATE NOT NULL,
    next_sequence INT DEFAULT 1,
    UNIQUE(org_id, warehouse_id, sequence_date)
  );
  ```

- [ ] Add indexes:
  - grns: (org_id, grn_number), (warehouse_id), (source_id), (receiving_date)
  - grn_items: (grn_id), (lp_id), (product_id)

- [ ] Add RLS policies:
  - Users can only see GRNs in their org

### Frontend

- [ ] Create `GrnReceiveModal` component:
  - Source selector: Radio buttons (ASN / PO / Ad-hoc)
  - Conditional fields:
    - If ASN: Show ASN number autocomplete
    - If PO: Show PO number autocomplete
    - If Ad-hoc: No source field
  - GRN items table (repeating form fields):
    - Product: Dropdown/autocomplete (searchable)
    - Qty: Number input (required, > 0)
    - Supplier batch: Text input
    - Mfg date: Date picker (optional)
    - Expiry date: Date picker (optional)
    - Location: Dropdown (required, pre-filled with default)
    - QA Status: Dropdown (required, pre-filled with default)
    - "Add Item" button to add more rows
    - "Remove" button per item
  - Notes: Text area (optional)
  - Error display (inline for form fields, summary at top)
  - Buttons: "Create GRN" (disabled if invalid), "Cancel"

- [ ] Create GRN list page (`/warehouse/grns`):
  - Columns: GRN number, Source (ASN/PO/Ad-hoc), Receiving Date, Items, Status, Actions
  - Filters: Date range, Source type
  - Actions: View Detail, Delete (if not yet integrated)
  - Link to GRN detail on click

- [ ] Create GRN detail page (`/warehouse/grns/:id`):
  - GRN header: GRN number, Source link, Receiving date, Notes
  - Items table: Product, Qty, UoM, Batch, Expiry, Location, LP Number
  - LP links: Click "LP-XXXX" to open LP detail modal
  - "Back to GRNs" link

---

## Testing

### Unit Tests

- GRN number generation: correct format `GRN-YYYYMMDD-NNNN`
- GRN number uniqueness per org_id
- LP number generation: correct format `LP-YYYYMMDD-NNNN`
- Quantity validation: 0, negative → error; positive → success
- Product validation: invalid product_id → error; valid → success
- Location validation: invalid location → error; valid → success

### Integration Tests

- `POST /api/warehouse/grns` with valid ASN source:
  - Verify: grn record created with source_id
  - Verify: 3 grn_items created
  - Verify: 3 license_plates created with auto-generated numbers
  - Verify: grn_item.lp_id populated
  - Verify: GRN status = 'created'

- `POST /api/warehouse/grns` with ad-hoc source:
  - Verify: grn record created with source_id = NULL
  - Verify: items and LPs created

- `POST /api/warehouse/grns` with invalid product:
  - Verify: 400 error
  - Verify: No GRN, items, or LPs created

### E2E Tests

- Open warehouse → GRNs → "New Receive" → Select ASN
- ASN pre-fills with items
- Modify qty/location as needed
- Click "Create GRN"
- Verify: Success message with GRN number and LP list
- Navigate to GRN detail → verify all items displayed with LP numbers
- Click on LP number → LP detail modal opens

---

## Acceptance Criteria Checklist

- ✅ Receive modal opens with source selector
- ✅ GRN number auto-generated in correct format
- ✅ GRN number unique per org
- ✅ LP number auto-generated for each item
- ✅ GRN linked to source (ASN/PO/ad-hoc)
- ✅ Basic validation prevents invalid submissions
- ✅ GRN list displays all created GRNs
- ✅ GRN detail shows items with LP numbers
- ✅ Success message shows GRN number and items

---

## Dependencies

**Requires:**
- Story 5.1 (LP Creation - structure)
- Story 5.4 (LP Number Generation - lp_number_sequence)
- Story 5.3 (Batch/Expiry - supplier_batch_number)

**Enables:**
- Story 5.11b (GRN Integration - ASN/PO updates)
- Story 5.11c (Transaction Atomicity)

**Blocked By:** None

---

## Notes

- Part 1 of 3: Focus on happy path (valid data)
- No transaction atomicity yet (added in 5.11c)
- No PO/ASN status updates yet (added in 5.11b)
- Simple error handling (detailed handling in 5.11c)
- GRN status remains 'created' until integration (5.11b)
