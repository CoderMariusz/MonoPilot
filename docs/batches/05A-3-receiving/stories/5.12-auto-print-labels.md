# Story 5.12: Auto-Print Labels

**ID:** 5.12
**Batch:** 5A-3 (Receiving)
**Story Points:** 5
**Effort:** 5-6 hours
**Status:** Todo

---

## User Story

> As a **Warehouse user**, I want labels to print automatically, so that I can label inventory quickly.

---

## Acceptance Criteria

### AC 1: Auto-Print on LP Creation
- **Given** LP is created during receiving
- **When** warehouse_settings.auto_print_on_receive = true
- **Then** ZPL label automatically sent to configured printer

### AC 2: Label Content
- **Given** LP created during receiving
- **When** label prints
- **Then** label includes:
  - LP number (barcode - Code128)
  - Product code and name
  - Batch number
  - Expiry date (if present)
  - Quantity and UoM
  - Location code
  - Manufacturing date (if present)

### AC 3: ZPL Format
- **Given** label printing
- **When** formatting label
- **Then** use ZPL (Zebra Programming Language):
  - Product code/name in 18pt font
  - LP number in 36pt font (large)
  - Batch and expiry in 18pt font
  - Barcode 100px height
  - 4x6 label size (standard Zebra label)

### AC 4: Printer Configuration
- **Given** Admin navigates to /settings/warehouse
- **When** viewing label settings
- **Then** can configure:
  - Printer IP address (e.g., 192.168.1.100)
  - Printer port (default 9100 for Zebra)
  - Copies per label (1-5, default 1)
  - Auto-print enabled/disabled toggle

### AC 5: Error Handling
- **Given** label print fails (printer offline, network error)
- **When** error occurs
- **Then**:
  - Error logged to system
  - User notified: "Label print failed. Printer {printer_ip} unreachable."
  - LP still created (receiving not blocked)
  - User can manually print label later via "Print Label" button

---

## Technical Tasks

### Backend

- [ ] Create label generation service
  - Input: LP object (lp_number, product, batch, expiry, location, qty, uom)
  - Generate ZPL template
  - Return: ZPL string

- [ ] Create printer communication service
  - Accept: ZPL string, printer_ip, printer_port, copies
  - Send ZPL to printer via TCP socket
  - Handle connection timeouts and errors
  - Return: success/error status

- [ ] Update GRN creation endpoint
  - After LP created: call label generation + printer service
  - If auto_print = true: send to printer
  - Log any print errors but don't block receiving

- [ ] Create `POST /api/warehouse/license-plates/:id/print-label` endpoint
  - Allow manual label printing for existing LPs
  - Accept: copies (optional)
  - Send to printer

- [ ] Add error logging
  - Log all printer errors with details
  - Include: printer_ip, error_message, timestamp

### Database

- [ ] Update warehouse_settings table (per tech-spec)
  - printer_ip: VARCHAR(20)
  - printer_port: INTEGER DEFAULT 9100
  - copies_per_label: INTEGER (1-5) DEFAULT 1
  - auto_print_on_receive: BOOLEAN DEFAULT true

### Frontend

- [ ] Update LP detail page: Add "Print Label" button
  - Button visible for all LPs
  - Click to print label manually
  - Shows: "Printing..." → "Sent to printer" or error

- [ ] Update GRN detail page: Add "Print All Labels" button
  - Print all LPs created from this GRN at once
  - Shows progress: "Printing 3 of 5..."

- [ ] Update warehouse settings page: `/settings/warehouse`
  - Add label settings section:
    - Printer IP input field
    - Printer port input field
    - Copies per label slider (1-5)
    - Auto-print toggle: "Automatically print labels on receiving"
    - Test button: "Print Test Label"
  - Validation: Valid IP address format

---

## Testing

### Unit Tests
- ZPL generation: all fields included
- ZPL format: valid Zebra syntax
- Label layout: 4x6 dimensions, fonts correct

### Integration Tests
- Print label via POST /api/warehouse/license-plates/:id/print-label
- Mock printer: Verify ZPL sent to TCP socket
- Printer offline: Verify error logged, LP still exists
- Auto-print on receiving: Verify labels sent when setting enabled

### E2E Tests
- Configure printer IP in settings
- Create LP during receiving with auto_print = true
- Verify: Label sent to printer automatically
- Create LP with auto_print = false
- Verify: Label NOT sent to printer
- Click "Print Label" on LP detail
- Verify: Label sent to printer

---

## Acceptance Criteria Checklist

- ✅ Labels print automatically on LP creation (if enabled)
- ✅ Label includes all required fields (LP#, product, batch, expiry, qty, location)
- ✅ ZPL format valid for Zebra printers
- ✅ Printer IP and settings configurable
- ✅ Manual print button available for existing LPs
- ✅ Error handling: printer offline doesn't block receiving

---

## Dependencies

**Requires:** Story 5.11 (GRN and LP Creation)

**Enables:** None directly (end of receiving workflow)

---

## Notes

- ZPL is Zebra's native printer language
- 4x6 labels standard for warehouse barcode labels
- TCP socket connection to printer (port 9100)
- Auto-print improves efficiency by eliminating manual printing step
- Manual print fallback for when auto-print unavailable
- Printer must be on network (IP addressable)
