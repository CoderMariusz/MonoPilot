<?xml version="1.0" encoding="UTF-8"?>
<story>
  <metadata>
    <id>3.22</id>
    <title>Planning Settings Configuration</title>
    <batch>03C-3</batch>
    <points>5</points>
    <effort_hours>4-6</effort_hours>
    <status>todo</status>
  </metadata>

  <description>
    Centralized configuration page for all Planning module settings.
    Includes PO, TO, and WO settings with status management.
  </description>

  <dependencies>
    <blocks>
      <story id="3.5">Configurable PO Statuses</story>
      <story id="3.15">Configurable WO Statuses</story>
    </blocks>
    <requires>
      <epic id="1">Settings Infrastructure</epic>
    </requires>
  </dependencies>

  <technical_context>
    <tables>
      <table>
        <name>planning_settings</name>
        <columns>
          <column name="id" type="UUID" pk="true"/>
          <column name="org_id" type="UUID" fk="organizations.id" unique="true"/>
          <column name="po_statuses" type="JSONB"/>
          <column name="po_default_status" type="VARCHAR(50)"/>
          <column name="po_require_approval" type="BOOLEAN"/>
          <column name="po_approval_threshold" type="NUMERIC(15,2)"/>
          <column name="to_statuses" type="JSONB"/>
          <column name="to_default_status" type="VARCHAR(50)"/>
          <column name="to_allow_partial" type="BOOLEAN"/>
          <column name="to_require_lp_selection" type="BOOLEAN"/>
          <column name="wo_statuses" type="JSONB"/>
          <column name="wo_default_status" type="VARCHAR(50)"/>
          <column name="wo_status_expiry_days" type="INTEGER"/>
          <column name="wo_material_check" type="BOOLEAN"/>
          <column name="wo_copy_routing" type="BOOLEAN"/>
          <column name="wo_source_of_demand" type="BOOLEAN"/>
          <column name="po_payment_terms_visible" type="BOOLEAN"/>
          <column name="po_shipping_method_visible" type="BOOLEAN"/>
          <column name="po_notes_visible" type="BOOLEAN"/>
          <column name="created_at" type="TIMESTAMPTZ"/>
          <column name="updated_at" type="TIMESTAMPTZ"/>
        </columns>
      </table>
    </tables>

    <api_endpoints>
      <endpoint method="GET" path="/api/planning/settings">
        <response>
          <field name="po_statuses" type="array"/>
          <field name="po_default_status" type="string"/>
          <field name="po_require_approval" type="boolean"/>
          <field name="po_approval_threshold" type="number"/>
          <field name="to_statuses" type="array"/>
          <field name="to_default_status" type="string"/>
          <field name="to_allow_partial" type="boolean"/>
          <field name="to_require_lp_selection" type="boolean"/>
          <field name="wo_statuses" type="array"/>
          <field name="wo_default_status" type="string"/>
          <field name="wo_status_expiry_days" type="number"/>
          <field name="wo_material_check" type="boolean"/>
          <field name="wo_copy_routing" type="boolean"/>
          <field name="wo_source_of_demand" type="boolean"/>
        </response>
      </endpoint>
      <endpoint method="PUT" path="/api/planning/settings">
        <request>All fields from GET response</request>
      </endpoint>
    </api_endpoints>

    <components_to_create>
      <component name="PlanningSettingsPage" path="app/(authenticated)/settings/planning/page.tsx"/>
      <component name="StatusListConfig" path="components/settings/StatusListConfig.tsx"/>
      <component name="POSettingsTab" path="components/settings/POSettingsTab.tsx"/>
      <component name="TOSettingsTab" path="components/settings/TOSettingsTab.tsx"/>
      <component name="WOSettingsTab" path="components/settings/WOSettingsTab.tsx"/>
    </components_to_create>
  </technical_context>

  <acceptance_criteria>
    <criterion id="AC-1">
      <description>Settings Page</description>
      <given>Admin navigates to /settings/planning</given>
      <then>can configure all planning settings</then>
    </criterion>
    <criterion id="AC-2">
      <description>PO Settings</description>
      <can_configure>
        <item>PO statuses (add/remove/rename, set default)</item>
        <item>require_approval toggle</item>
        <item>approval_threshold amount</item>
        <item>Field visibility toggles</item>
      </can_configure>
    </criterion>
    <criterion id="AC-3">
      <description>TO Settings</description>
      <can_configure>
        <item>TO statuses</item>
        <item>allow_partial toggle</item>
        <item>require_lp_selection toggle</item>
      </can_configure>
    </criterion>
    <criterion id="AC-4">
      <description>WO Settings</description>
      <can_configure>
        <item>WO statuses</item>
        <item>status_expiry_days</item>
        <item>source_of_demand toggle</item>
        <item>material_check toggle</item>
        <item>copy_routing toggle</item>
      </can_configure>
    </criterion>
    <criterion id="AC-5">
      <description>Save and Apply</description>
      <when>saving settings</when>
      <then>changes applied immediately to new orders</then>
    </criterion>
    <criterion id="AC-6">
      <description>Validation</description>
      <rules>
        <rule>Cannot remove status if orders exist with that status</rule>
        <rule>Must have exactly one default status per type</rule>
      </rules>
    </criterion>
  </acceptance_criteria>

  <test_plan>
    <unit_tests>
      <test>Settings validation logic</test>
      <test>Default status enforcement</test>
    </unit_tests>
    <integration_tests>
      <test>API saves settings correctly</test>
      <test>Cannot delete in-use status</test>
      <test>Settings applied to new orders</test>
    </integration_tests>
    <e2e_tests>
      <test>Navigate to Planning Settings</test>
      <test>Update PO settings and verify</test>
      <test>Add custom status and verify in order creation</test>
      <test>Toggle approval and verify workflow</test>
    </e2e_tests>
  </test_plan>

  <implementation_notes>
    <note priority="medium">Settings are per-organization (org_id)</note>
    <note priority="medium">Create default settings row on first access</note>
    <note priority="low">Consider settings export/import (future)</note>
  </implementation_notes>
</story>
