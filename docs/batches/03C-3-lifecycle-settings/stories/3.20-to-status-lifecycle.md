# Story 3.20: TO Status Lifecycle

**ID:** 3.20
**Batch:** 03C-3
**Story Points:** 3
**Effort:** 2-3 hours
**Status:** Todo

## User Story

> As a **Warehouse user**,
> I want to move TO through statuses,
> So that I can track transfer progress.

## Acceptance Criteria

### AC 1: Ship Action

**Given** TO exists with status = 'Planned'
**When** clicking "Ship"
**Then** status → 'Shipped'
**And** actual_ship_date set to now

### AC 2: Receive Action

**Given** TO status = 'Shipped'
**When** clicking "Receive"
**Then** status → 'Received'
**And** actual_receive_date set to now

### AC 3: Status Flow

**Flow:** Draft → Planned → Shipped → Received

### AC 4: Audit Trail

**And** status changes logged with timestamps and user

### AC 5: Partial Status

**Given** partial shipments enabled
**When** partial quantity shipped
**Then** status → 'Partially Shipped'

## Technical Tasks

### Backend
- [ ] API: `PUT /api/planning/transfer-orders/:id/status`
- [ ] Set actual_ship_date / actual_receive_date
- [ ] Handle partial shipment status
- [ ] Log to audit trail

### Frontend
- [ ] Ship/Receive action buttons
- [ ] Status badges with colors
- [ ] Confirmation dialogs
- [ ] Date display for ship/receive

### Database

```sql
-- Add status tracking columns if not exist
ALTER TABLE transfer_orders ADD COLUMN IF NOT EXISTS actual_ship_date TIMESTAMPTZ;
ALTER TABLE transfer_orders ADD COLUMN IF NOT EXISTS actual_receive_date TIMESTAMPTZ;
ALTER TABLE transfer_orders ADD COLUMN IF NOT EXISTS shipped_by UUID REFERENCES users(id);
ALTER TABLE transfer_orders ADD COLUMN IF NOT EXISTS received_by UUID REFERENCES users(id);

-- Audit trail
CREATE TABLE IF NOT EXISTS to_status_history (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  org_id UUID NOT NULL REFERENCES organizations(id),
  to_id UUID NOT NULL REFERENCES transfer_orders(id) ON DELETE CASCADE,
  from_status VARCHAR(50),
  to_status VARCHAR(50) NOT NULL,
  changed_by UUID REFERENCES users(id),
  changed_at TIMESTAMPTZ DEFAULT NOW(),
  notes TEXT
);

CREATE INDEX idx_to_status_history_to ON to_status_history(to_id);
```

## Testing

### Unit Tests
- [ ] Status transition logic
- [ ] Date setting on ship/receive

### Integration Tests
- [ ] API updates status correctly
- [ ] Dates set automatically
- [ ] Audit trail created

### E2E Tests
- [ ] Full TO lifecycle: Draft → Planned → Shipped → Received
- [ ] Verify dates displayed correctly

## Dependencies

- **Requires:** Story 3.6 (TO CRUD)
- **Blocks:** Epic 5 (Receiving workflow)

## Notes

- actual_ship_date and actual_receive_date are automatic
- Consider partial shipment tracking (Story 3.8)
