# Story 3.7: TO Line Management

**Epic:** 3 - Planning Operations
**Batch:** 03B-1
**Story ID:** 3.7
**Priority:** P0
**Effort:** 3 points
**Status:** Ready for Development

---

## User Story

**As a** Warehouse user,
**I want to** add products to transfer orders with quantities,
**So that** I can specify what inventory to move between warehouses.

---

## Acceptance Criteria

### AC-3.7.1: TO Lines Table Display

**When** viewing TO detail page
**Then** see "Transfer Order Lines" section with:
- Columns: Product Code, Product Name, Planned Qty, UoM, Shipped Qty, Received Qty, Actions
- "Add Line" button (if status = 'draft')
- Empty state if no lines

### AC-3.7.2: Add TO Line Modal

**When** clicking "Add Line" on draft TO
**Then** modal opens with:
- Product (required, searchable dropdown)
- Quantity (required, number > 0)
- UoM (read-only, from product)
- Notes (optional, max 200 chars)

### AC-3.7.3: Save TO Line

**When** saving valid line data
**Then** line created with:
- UoM inherited from product
- shipped_qty = 0
- received_qty = 0

**And** line appears in table

### AC-3.7.4: Edit TO Line

**When** editing line on draft TO
**Then** drawer opens with:
- Product (read-only)
- Quantity (editable)
- Notes (editable)

**Blocked** if TO status ≠ 'draft'

### AC-3.7.5: Delete TO Line

**When** deleting line on draft TO
**Then** confirmation dialog shown
**And** line deleted
**And** table refreshes

**Blocked** if TO status ≠ 'draft'

### AC-3.7.6: TO Lines Summary

**When** viewing TO with multiple lines
**Then** see summary:
- Total Lines count
- Shipped Status: X% (Y/Z products)
- Received Status: X% (Y/Z products)

### AC-3.7.7: Duplicate Product Allowed

**Given** product already on TO
**When** adding same product again
**Then** allowed (separate lines)

### AC-3.7.8: Cannot Plan Without Lines

**When** trying to change status to 'planned' with 0 lines
**Then** error: "Cannot plan TO without lines"

---

## Technical Tasks

1. Database migration (to_lines table)
2. API routes (GET, POST, PUT, DELETE)
3. Validation schemas
4. TO lines table component
5. Add/Edit line modal

---

## Definition of Done

- [ ] Database migration applied
- [ ] RLS policy enabled
- [ ] API endpoints implemented
- [ ] UI components implemented
- [ ] UoM inheritance working
- [ ] All tests passing

---

## Dependencies

- Story 3.6 (TO CRUD)
- Epic 2 (Products)
