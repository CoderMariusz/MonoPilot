<?xml version="1.0" encoding="UTF-8"?>
<story-context id="3-7-to-line-management" v="1.0">
  <metadata>
    <epicId>3</epicId>
    <storyId>3.7</storyId>
    <title>TO Line Management</title>
    <batch>03B-1</batch>
    <points>3</points>
    <effort_hours>4-6</effort_hours>
    <status>ready-for-dev</status>
    <generatedAt>2025-11-28</generatedAt>
  </metadata>

  <description>
    Add, edit, and delete TO lines (products to transfer) with quantity tracking
    and UoM inheritance from products.
  </description>

  <dependencies>
    <requires>
      <story id="3.6">TO CRUD</story>
      <epic id="2">Products</epic>
    </requires>
  </dependencies>

  <technical_context>
    <tables>
      <table>
        <name>to_lines</name>
        <columns>
          <column name="id" type="UUID" pk="true"/>
          <column name="transfer_order_id" type="UUID" fk="transfer_orders.id" on_delete="CASCADE"/>
          <column name="product_id" type="UUID" fk="products.id"/>
          <column name="quantity" type="NUMERIC(10,2)" check="quantity > 0"/>
          <column name="uom" type="VARCHAR(20)"/>
          <column name="shipped_qty" type="NUMERIC(10,2)" default="0"/>
          <column name="received_qty" type="NUMERIC(10,2)" default="0"/>
          <column name="notes" type="TEXT" nullable="true"/>
          <column name="created_at" type="TIMESTAMPTZ"/>
          <column name="updated_at" type="TIMESTAMPTZ"/>
        </columns>
      </table>
    </tables>

    <api_endpoints>
      <endpoint method="GET" path="/api/planning/transfer-orders/:id/lines">
        <description>List TO lines with product info</description>
      </endpoint>
      <endpoint method="POST" path="/api/planning/transfer-orders/:id/lines">
        <description>Add TO line</description>
        <request_body>{ product_id, quantity, notes? }</request_body>
      </endpoint>
      <endpoint method="PUT" path="/api/planning/transfer-orders/:id/lines/:lineId">
        <description>Update TO line (draft only)</description>
      </endpoint>
      <endpoint method="DELETE" path="/api/planning/transfer-orders/:id/lines/:lineId">
        <description>Delete TO line (draft only)</description>
      </endpoint>
    </api_endpoints>

    <components_to_create>
      <component name="TOLinesTable" path="components/planning/"/>
      <component name="TOLineFormModal" path="components/planning/"/>
    </components_to_create>
  </technical_context>

  <acceptance_criteria>
    <criterion id="AC-3.7.1">TO Lines Table with shipped/received qty display</criterion>
    <criterion id="AC-3.7.2">Add TO Line Modal with product search and UoM auto-fill</criterion>
    <criterion id="AC-3.7.3">Save line with UoM inherited from product</criterion>
    <criterion id="AC-3.7.4">Edit line (draft only, product read-only)</criterion>
    <criterion id="AC-3.7.5">Delete line (draft only)</criterion>
    <criterion id="AC-3.7.6">Summary section (total lines, shipped/received %)</criterion>
    <criterion id="AC-3.7.7">Duplicate products allowed</criterion>
    <criterion id="AC-3.7.8">Cannot plan TO without lines</criterion>
  </acceptance_criteria>

  <validation_rules>
    <rule field="product_id" type="required">Valid UUID</rule>
    <rule field="quantity" type="positive">Must be > 0</rule>
    <rule field="quantity" type="max" value="999999">Max 999,999</rule>
    <rule field="notes" type="maxLength" value="200">Max 200 chars</rule>
  </validation_rules>

  <test_plan>
    <unit_tests>
      <test>Validation schema (quantity > 0)</test>
      <test>UoM inheritance from product</test>
    </unit_tests>
    <integration_tests>
      <test>Create line - UoM inherited</test>
      <test>Edit line - blocked if TO not draft</test>
      <test>Delete line - blocked if TO not draft</test>
      <test>Plan TO - requires at least 1 line</test>
    </integration_tests>
    <e2e_tests>
      <test>Add multiple lines to TO</test>
      <test>Add duplicate product lines</test>
    </e2e_tests>
  </test_plan>
</story-context>
