# Story 4.8: Material Reservation (Scanner)

**Epic:** 4 - Production Execution | **Status:** Todo | **Priority:** P0 | **Story Points:** 3 | **Effort:** 1.5 days | **Updated:** 2025-11-28

## User Story

**As an** Operator
**I want** to reserve materials via scanner on the production floor
**So that** I can allocate them efficiently without needing desktop interface (actual consumption happens when output is registered)

---

## Problem Statement

Scanner-based material reservation enables:
1. Fast material allocation directly on production floor
2. Barcode-driven workflow (minimal typing, keyboard-free)
3. Large, touch-friendly UI (44px+ buttons)
4. Real-time feedback (visual + audio cues)
5. Mobile-first design (tablets/devices)
6. Same API as desktop (Story 4.7) for consistency

---

## Acceptance Criteria

### AC-4.8.1: Scanner Home Screen

**Given** user navigates to /scanner/reserve
**When** page loads
**Then** displays:
- Large "Scan WO Barcode" button (48px height, green background)
- Search field (backup: type WO number manually)
- Recent WOs list (last 5 scanned, for quick access)
- Settings button (optional: barcode reader config, audio feedback toggle)

**Success Criteria:**
- ✅ Large button prominently displayed
- ✅ Portrait orientation optimized
- ✅ Touch target ≥ 48px (WCAG AA minimum)
- ✅ No requirement for keyboard input

---

### AC-4.8.2: WO Lookup & Material Display

**Given** user scans or enters WO barcode/number
**When** barcode scanned or search executed
**Then** system:
1. Validates WO exists and is in_progress
2. Fetches materials from WO BOM
3. Shows materials needing reservation:

**Display Format:**
```
┌─────────────────────────────────────────┐
│ WO-001 | Flour Production (40% done)    │
├─────────────────────────────────────────┤
│ Material 1: Flour                       │
│ Required: 200kg | Reserved: 80kg        │
│ Progress: ████░░░░░░ (40%)              │
│                                         │
│ Material 2: Water                       │
│ Required: 50L | Reserved: 0L            │
│ Progress: ░░░░░░░░░░ (0%)               │
│                                         │
│ Material 3: Yeast                       │
│ Required: 5kg | Reserved: 5kg           │
│ Progress: ██████████ (100%) ✅ DONE     │
│                                         │
│ [Next Material ↓]                       │
└─────────────────────────────────────────┘
```

**Success Criteria:**
- ✅ All materials displayed with progress
- ✅ Color-coded: Green (complete), Yellow (partial), Red (not started)
- ✅ Large text (18px+) for readability
- ✅ One material per screen (scrollable or paginated)
- ✅ Easy navigation between materials

---

### AC-4.8.3: LP Barcode Scanning (Material-Specific)

**Given** viewing material screen
**When** tapping "Scan LP Barcode" button
**Then** barcode input active (focus on input field, cursor ready)

**When** LP barcode scanned:
**Then** system:
1. Validates LP exists
2. Validates LP product = material product
3. Validates LP UoM = material UoM
4. Validates LP available qty > 0
5. If all valid: Show quantity entry screen
6. If any validation fails: Show large red error message

**Error Display:**
```
┌──────────────────────────────────────┐
│ ❌ ERROR                              │
│                                      │
│ LP-001 product mismatch:             │
│ Contains: RICE                       │
│ Expected: FLOUR                      │
│                                      │
│ [Scan Different LP]  [Go Back]       │
└──────────────────────────────────────┘
```

**Success Criteria:**
- ✅ Real-time barcode capture (no enter key needed)
- ✅ Validation specific + actionable
- ✅ Large error text (red, 18px+)
- ✅ Easy retry (rescan or go back)

---

### AC-4.8.4: Quantity Entry (Story 4.9 Integration)

**Given** LP scanned and validated
**When** quantity entry screen displays
**Then** conditional input based on consume_whole_lp:

**If consume_whole_lp = false:**
```
┌─────────────────────────────────────────┐
│ Reserve Flour - Batch 2 of 3            │
│ LP-A-001: 120kg available               │
├─────────────────────────────────────────┤
│ Enter Quantity (kg):                    │
│ ┌────────────────────────────────────┐  │
│ │ 80                    [⌫ Clear]    │  │
│ └────────────────────────────────────┘  │
│ Available: 120kg  Remaining: 80kg       │
│                                         │
│ [- Decrease] [+ Increase]               │
│ [← Back] [Reserve! ✓]                   │
└─────────────────────────────────────────┘
```

**If consume_whole_lp = true:**
```
┌─────────────────────────────────────────┐
│ Reserve Flour - Batch 2 of 3            │
│ LP-A-001: Must use entire LP            │
├─────────────────────────────────────────┤
│ Quantity (read-only):                   │
│ ┌────────────────────────────────────┐  │
│ │ 120 kg  (Entire LP)                │  │
│ └────────────────────────────────────┘  │
│                                         │
│ [← Back] [Reserve Full LP! ✓]           │
└─────────────────────────────────────────┘
```

**Success Criteria:**
- ✅ Qty input conditional on consume_whole_lp
- ✅ +/- buttons for easy adjustment
- ✅ Clear availability display
- ✅ Large buttons (48px+) for touch
- ✅ No keyboard required (numeric pad optional)

---

### AC-4.8.5: Reservation Confirmation & Next Material

**Given** operator enters qty and confirms
**When** tapping "Reserve!" or "Reserve Full LP!"
**Then** system:
1. Calls POST /api/production/work-orders/:id/materials/reserve (same as Story 4.7)
2. On success: Shows "✅ Reserved successfully" toast (2s auto-dismiss)
3. Updates materials list (reduce Remaining qty, increment Reserved)
4. Moves to next unreserved material (if any)
5. On error: Shows error message with retry option

**Material Navigation:**
- After reserve: Go to next material with Remaining > 0
- If all materials complete: Show "All Materials Reserved ✅"
- "Previous Material" button: Go back (for corrections)

**Success Criteria:**
- ✅ Uses exact same API as Story 4.7
- ✅ Success feedback clear (toast + visual)
- ✅ Smooth transition to next material
- ✅ Navigation between materials working

---

### AC-4.8.6: Material Complete Detection

**When** all materials have Reserved >= Required qty
**Then** system detects and displays:

```
┌──────────────────────────────────────┐
│          ✅ ALL MATERIALS RESERVED    │
│                                      │
│ Flour:    200kg / 200kg ✓            │
│ Water:    50L / 50L ✓                │
│ Yeast:    5kg / 5kg ✓                │
│                                      │
│ Ready to proceed to production!      │
│                                      │
│ [← Go Back to WO] [Start Prod ▶]    │
└──────────────────────────────────────┘
```

**Auto-detection logic:**
```
FOR each material IN wo.materials:
  IF SUM(reserved_qty) >= required_qty:
    material.status = "complete" ✓
  ELSE:
    material.status = "pending"

IF all materials.status == "complete":
  Show completion screen
```

**Success Criteria:**
- ✅ Automatic detection (no manual confirmation needed)
- ✅ Green checkmark per material
- ✅ Clear "Ready to proceed" message
- ✅ Option to navigate back or start production

---

### AC-4.8.7: Skip Material Option (Error Recovery)

**Given** operator scanned wrong LP 3 times
**When** long-press error message (2+ seconds)
**Then** show "Skip This Material?" dialog:

```
┌──────────────────────────────────────┐
│ ⚠️ Skip Water Material?               │
│                                      │
│ Note: Mark material as manual entry  │
│ (Will need desktop follow-up)        │
│                                      │
│ Required: 50L                        │
│ Reserved: 0L                         │
│                                      │
│ [No, Retry]  [Yes, Skip]             │
└──────────────────────────────────────┘
```

**On skip:**
- Mark material as 'manual_entry_pending'
- Move to next material
- Log event: "Material skipped on scanner"
- Alert: Show on desktop for operator to handle

**Success Criteria:**
- ✅ Recovery option for stuck materials
- ✅ Audit trail (logged for follow-up)
- ✅ Don't block WO reservation process

---

### AC-4.8.8: Touch Optimization & Accessibility

**Button Sizing:**
- All action buttons: 48px+ height
- Tap target area: 44px minimum (WCAG AA)
- Spacing between buttons: 16px (avoid accidental taps)

**Text & Readability:**
- Primary text: 18px+ (body text)
- Headings: 24px+ (section headers)
- Color contrast: WCAG AA minimum (4.5:1 text/background)
- Font: Sans-serif (Roboto, system font)

**Orientation:**
- Portrait-first design (match tablet/phone orientation)
- Responsive: 768px width minimum
- Landscape supported (but portrait preferred)

**Interaction:**
- Single-tap or double-tap (not swipe gestures)
- Buttons: Visual feedback (color change on tap)
- Confirmation modals: Yes/No (not OK/Cancel)
- No long-press required (except AC-4.8.7 recovery)

**Optional Audio Feedback:**
- Success: Short beep (200ms)
- Error: Double beep (error tone)
- Toggleable in settings
- Haptic feedback on modern devices

**Success Criteria:**
- ✅ All buttons ≥ 48px
- ✅ Text ≥ 18px
- ✅ Color contrast ≥ 4.5:1 (WCAG AA)
- ✅ Portrait-optimized layout
- ✅ Tap-based interaction (no swipe)

---

### AC-4.8.9: Offline Support (Phase 1: Queue, Phase 2: Sync)

**Phase 1 (Story 4.8):**
**When** network unavailable (offline detected)
**Then** queue reservation request:
- Store in localStorage: { wo_id, material_id, lp_id, reserved_qty, timestamp }
- Show banner: "⚠️ Offline - Reservation queued"
- Allow operator to continue
- No API call until network restored

**When** network restored:
**Then** sync queued operations:
- Attempt POST /api/production/work-orders/:id/materials/reserve
- Show progress: "Syncing... (1/3)"
- On success: Remove from queue, update UI
- On conflict: Show specific error (LP already reserved, qty changed)

**Phase 2 (Story 5.36):**
- Conflict resolution strategies
- Merge/retry logic
- Full offline queue management

**Success Criteria:**
- ✅ Queue working locally
- ✅ Clear offline indicator
- ✅ Auto-sync on reconnect
- ✅ No data loss

---

### AC-4.8.10: Same API as Desktop (Story 4.7 Reuse)

**POST /api/production/work-orders/:id/materials/reserve**

Scanner uses **exact same endpoint** as desktop Story 4.7:
```
Request: {
  material_id: uuid,
  lp_id: uuid,
  reserved_qty: number,
  notes?: string
}

Response (200): {
  data: { id, wo_id, material_id, ... },
  message: "Material reserved successfully"
}

Error (400/403/404): {
  error: string,
  message: string
}
```

**No API duplication:**
- ✅ Single implementation (backend)
- ✅ Multiple consumers (desktop + scanner)
- ✅ Consistency guaranteed

---

### AC-4.8.11: Error Handling (Large, Clear Display)

**Error Message Format:**
```
┌──────────────────────────────────────┐
│ ❌ CANNOT RESERVE                     │
│                                      │
│ Error: LP_ALREADY_RESERVED           │
│                                      │
│ LP-001 is already reserved for       │
│ this work order. Check the materials │
│ list for duplicate.                  │
│                                      │
│ [Scan Different LP]  [See All LPs]   │
└──────────────────────────────────────┘
```

**Error Matrix:**

| Scenario | Error Code | Message | Action |
|----------|-----------|---------|--------|
| LP not found | LP_NOT_FOUND | "LP-001 not found in system" | Rescan |
| Product mismatch | PRODUCT_MISMATCH | "LP contains Rice, expected Flour" | Rescan |
| UoM mismatch | UOM_MISMATCH | "LP in kg, expected units" | Rescan |
| Insufficient qty | INSUFFICIENT_QTY | "LP has 10kg, need 15kg" | Reduce qty or rescan |
| Already reserved | LP_ALREADY_RESERVED | "LP-001 already reserved for this WO" | Scan different LP |
| WO not in progress | WO_NOT_IN_PROGRESS | "WO must be in progress" | Return to home, rescan WO |
| consume_whole_lp violation | CONSUME_WHOLE_LP_VIOLATION | "Must reserve all 50kg, not partial" | Adjust qty or rescan |

**Success Criteria:**
- ✅ All errors displayed clearly
- ✅ Red background + white text (high contrast)
- ✅ Font ≥ 18px
- ✅ Simple recovery action shown

---

### AC-4.8.12: Complete Workflow Example

**User Journey:**
1. Navigate to `/scanner/reserve` (home screen)
2. Tap "Scan WO Barcode" button
3. Scan WO barcode (beep sound)
4. System shows: "WO-001: Flour Production (40% complete)"
5. First material displayed: "Flour - 200kg required, 80kg reserved, 40%"
6. Tap "Scan LP Barcode" button
7. Scan LP barcode (beep sound)
8. System validates → Shows quantity entry
9. System pre-fills: "80kg remaining" (reduce from 200-80)
10. Operator confirms → "Reserve! ✓"
11. Success toast: "✅ Reserved successfully"
12. Next material displayed: "Water - 50L required, 0L reserved"
13. Repeat steps 6-11
14. After 3rd material reserved: "✅ All Materials Reserved ✅"
15. Operator taps "Start Prod ▶" or returns to WO detail

## Technical Tasks

### Frontend

- [x] Task 1: Scanner Home Screen Component
  - [x] Large "Scan WO Barcode" button (48px height)
  - [x] WO search/lookup input field
  - [x] Recent WOs list (last 5 scanned)
  - [x] Settings button (audio feedback toggle)
  - [x] Responsive layout (portrait-first)

- [x] Task 2: Material Display Screen
  - [x] Show all materials with progress bars
  - [x] Color-coded status (green/yellow/red)
  - [x] Navigation between materials (Next/Previous)
  - [x] Material complete indicator (✅)
  - [x] Large text (18px+) for readability

- [x] Task 3: Barcode Scanner Integration
  - [x] Barcode input field (auto-focus)
  - [x] LP validation (product, UoM, qty)
  - [x] Large error messages (red, 18px+)
  - [x] Real-time capture (no Enter key needed)
  - [x] Clear/Retry buttons

- [x] Task 4: Quantity Entry (Story 4.9 Integration)
  - [x] Conditional qty input (consume_whole_lp flag)
  - [x] +/- buttons for adjustment
  - [x] Read-only qty for consume_whole_lp=true
  - [x] Clear availability display
  - [x] "Reserve!" and "Reserve Full LP!" buttons

- [x] Task 5: Material Complete & Navigation
  - [x] Auto-detect all materials reserved
  - [x] Show completion screen
  - [x] "All Materials Reserved ✅" screen
  - [x] Navigation: Previous Material, Start Prod, Go Back
  - [x] Realtime progress updates

- [x] Task 6: Offline Support (Phase 1)
  - [x] Detect network unavailable
  - [x] Queue reservations to localStorage
  - [x] Show offline banner
  - [x] Auto-sync on reconnect
  - [x] Conflict handling (show errors)

- [x] Task 7: Accessibility & Touch Optimization
  - [x] All buttons ≥ 48px
  - [x] Text ≥ 18px
  - [x] WCAG AA color contrast (4.5:1)
  - [x] Touch-friendly spacing (16px between buttons)
  - [x] Portrait-optimized layout (768px min)

- [x] Task 8: Audio Feedback (Optional)
  - [x] Success beep (200ms, toggleable)
  - [x] Error double-beep (toggleable)
  - [ ] Haptic feedback on modern devices (deferred)
  - [x] Settings to enable/disable

### Backend

- [x] Task 9: Reuse Story 4.7 API
  - [x] POST /api/production/work-orders/:id/materials/reserve
  - [x] No new API needed (scanner uses same endpoint)
  - [x] Verify error handling matches scanner needs
  - [x] Verify auth/role checks (Operator, Production Manager)

### Testing

- [x] Task 10: Unit Tests
  - [x] Test material display logic
  - [x] Test quantity calculation (remaining)
  - [x] Test complete detection (all reserved >= required)
  - [x] Test offline queue (localStorage)
  - [x] Target 90% coverage

- [x] Task 11: Integration Tests
  - [x] Test scanner WO lookup
  - [x] Test barcode validation (product, UoM)
  - [x] Test reservation API call (POST)
  - [x] Test error handling (all error codes)
  - [x] Test offline queue + sync
  - [x] Target 70% coverage

- [x] Task 12: E2E Tests
  - [x] Full scanner workflow: Home → WO Scan → Material 1 → LP Scan → Qty Entry → Reserve → Material 2 → ... → Complete
  - [x] Test error scenarios (product mismatch, insufficient qty, already reserved)
  - [x] Test offline: queue 2 reservations, reconnect, verify sync
  - [x] Test touch interactions (tap, not swipe)
  - [x] Test audio feedback (beep on success/error)
  - [x] Target 100% critical path coverage

## Dev Notes

### Architecture Patterns
- **Scanner-First Design**: Mobile-optimized, touch-friendly, keyboard-avoiding
- **API Reuse**: Uses same POST endpoint as Story 4.7 (no duplication)
- **Offline-Ready**: LocalStorage queue for offline operations
- **Real-time Feedback**: Visual + audio cues for user confirmation
- **Accessibility**: WCAG AA compliance (touch targets, color contrast, text size)

### Key Design Decisions
- **Barcode-driven**: Minimize keyboard input, maximize scanning
- **One material per screen**: Avoid information overload
- **Conditional qty input**: Based on consume_whole_lp flag (Story 4.9)
- **Large buttons (48px)**: WCAG AA touch target minimum
- **Portrait orientation**: Match typical production floor tablet usage
- **Audio feedback optional**: Toggle in settings (respect user preference)

### Learnings from Story 4.7
- Uses exact same API (POST /api/production/work-orders/:id/materials/reserve)
- Same error codes and validation logic
- Same genealogy recording
- Same wo_material_reservations table

### Constraints & Decisions
- **No keyboard requirement**: All interactions via touch + barcode scanner
- **Network-aware**: Queue when offline, sync when back online
- **No swipe gestures**: Use tap only (simpler, more reliable)
- **Sequence preservation**: Materials reserved in order (same as desktop)
- **Manual skip option**: Allow recovery from stuck materials (skip + follow-up on desktop)

### Critical Data Model
```typescript
// LocalStorage offline queue (Phase 1)
scanner_queue = [
  {
    wo_id: uuid,
    material_id: uuid,
    lp_id: uuid,
    reserved_qty: number,
    timestamp: ISO8601,
    status: 'pending' | 'syncing' | 'done' | 'error'
  }
]

// Material state in scanner
current_material = {
  material_id: uuid,
  material_name: string,
  required_qty: number,
  reserved_qty: number,  // updated realtime
  remaining_qty: number, // required - reserved
  status: 'pending' | 'in_progress' | 'complete'
}
```

## Status

- **Created:** 2025-11-27
- **Updated:** 2025-12-03 (Code review fixes applied)
- **Current Status:** Done
- **Completed:** 2025-12-03

## Implementation Notes (2025-12-03)

### Files Implemented
- `app/(authenticated)/scanner/reserve/page.tsx` - Complete scanner page (~650 lines)
- `e2e/story-4.8-scanner-reservation.spec.ts` - E2E tests

### Key Features
- **Home Screen:** Large scan button, WO search, recent WOs list
- **Material Display:** Progress bars, navigation, color-coded status
- **LP Scanning:** Auto-focus input, product/UoM validation
- **Quantity Entry:** +/- buttons, consume_whole_lp conditional
- **Complete Screen:** All materials summary, navigation options
- **Offline Support:** localStorage queue, auto-sync on reconnect
- **Audio Feedback:** Success/error beeps, toggleable
- **Touch Optimization:** 48px+ buttons, 18px+ text, portrait-first

### API Reuse (Story 4.7)
- Same POST /api/production/work-orders/:id/materials/reserve
- Same error codes and validation
- No backend changes needed

---

## Future Improvements

The following features are documented for potential future implementation:

### 1. Skip Material Long-Press (AC-4.8.7 Enhancement)
**Current:** Not implemented
**Proposed:** Allow operator to long-press (2+ seconds) on error message to trigger "Skip This Material?" dialog
- Mark material as `manual_entry_pending`
- Move to next material
- Log event for desktop follow-up
- Useful for stuck materials without blocking WO reservation

### 2. Start Production Navigation
**Current:** Complete screen shows "Done" button returning to home
**Proposed:** Add "Start Production ▶" button on completion screen
- Navigate directly to production execution page
- Pre-select current WO
- Streamline workflow from reservation → production

### 3. Haptic Feedback
**Current:** Audio beeps only (success/error)
**Proposed:** Add vibration feedback on modern devices
- Short vibration on success (50ms)
- Double vibration on error (100ms + 50ms + 100ms)
- Toggle in settings alongside audio
- Uses Vibration API (`navigator.vibrate()`)
