<?xml version="1.0" encoding="UTF-8"?>
<story>
  <metadata>
    <id>5.36b</id>
    <title>Scanner Offline Queue - Advanced Features</title>
    <batch>05C-3</batch>
    <status>drafted</status>
    <predecessor>5.36</predecessor>
    <sprint>Gap 5</sprint>
  </metadata>

  <description>Advanced offline queue features: failure handling, manual sync, multi-user isolation, conflict resolution</description>

  <dependencies>
    <requires>
      <story id="5.36">Scanner Offline Queue Core</story>
    </requires>
  </dependencies>

  <technical_context>
    <features>
      <feature name="partial_sync">Continue syncing after individual operation failures</feature>
      <feature name="failed_queue">Separate queue for failed operations with retry/discard</feature>
      <feature name="manual_sync">Manual "Sync Now" button trigger</feature>
      <feature name="dependency_resolution">Topological sort for operation dependencies</feature>
      <feature name="multi_user_isolation">Separate queues per user_id</feature>
      <feature name="conflict_resolution">Detect concurrent updates to same LP</feature>
    </features>

    <indexeddb_keys>
      <key>scanner_offline_queue_{org_id}_{user_id}</key>
      <key>scanner_failed_queue_{org_id}_{user_id}</key>
    </indexeddb_keys>

    <dependency_graph>
      <note>Build DAG from operation payloads</note>
      <note>Topological sort ensures correct execution order</note>
      <note>If parent fails, child operations blocked</note>
    </dependency_graph>

    <conflict_detection>
      <note>Server compares operation.parent_lp_id with current state</note>
      <note>If parent state changed: conflict detected</note>
      <note>Optimistic locking with version numbers</note>
    </conflict_detection>

    <performance>
      <note>Web Workers for sync processing</note>
      <note>Background sync via Service Worker</note>
      <note>Auto-purge failed operations after 7 days</note>
      <note>Archive synced operations after 30 days</note>
    </performance>
  </technical_context>

  <acceptance_criteria>
    <ac id="1">Partial sync with failure handling (failed queue separate)</ac>
    <ac id="2">Manual sync trigger button visible with queue count</ac>
    <ac id="3">Offline operation dependency resolution (DAG topological sort)</ac>
    <ac id="4">Multi-user queue isolation (per user_id)</ac>
    <ac id="5">Conflict detection with user-friendly errors</ac>
    <ac id="6">Performance optimization (background sync, Web Workers)</ac>
    <ac id="7">Failed queue UI with retry/discard actions</ac>
  </acceptance_criteria>

  <functional_requirements>
    <fr id="SC-FR-36">System shall provide advanced offline queue features</fr>
  </functional_requirements>
</story>
