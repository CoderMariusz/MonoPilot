# Story 5.36: Scanner Offline Queue Management

**ID:** 5.36
**Batch:** 5C-3 (Offline Queue)
**Story Points:** 13
**Effort:** 36-45 hours
**Status:** Todo
**Sprint:** 0 (Gap 5)

---

## User Story

> As an **Operator**, I want the scanner to queue operations while offline, so that I can continue working during network outages without losing data.

---

## Acceptance Criteria

### AC 1: Offline Queue Capacity Limits

**Given** Scanner PWA is offline (network disconnected)
**And** Operator performing warehouse operations (receive, consume, move)

**When** operations are executed while offline
**Then** verify queue management:
- ‚úÖ Operations stored in IndexedDB (browser local storage)
- ‚úÖ Max capacity: 100 offline operations
- ‚ö†Ô∏è Warning at 80 operations: **"80/100 offline operations queued. Reconnect to sync soon."**
- ‚ùå Block at 100 operations: **"Offline queue full (100/100). Please reconnect to sync before continuing."**
- ‚úÖ Each operation stores: operation_type, payload, timestamp, user_id, retry_count

**Operation Types Supported Offline:**
- Receive (GRN + LP creation)
- Consume (WO material consumption)
- Output (WO output recording)
- LP Move (location change)
- LP Split
- Inventory Count

**Technical Notes:**
- IndexedDB key: `scanner_offline_queue_{org_id}_{user_id}`
- Queue structure: Array of operation objects with timestamps
- Warning threshold: 80%, Block threshold: 100%

---

### AC 2: Offline Queue UI Indicators

**Given** Scanner PWA with queued offline operations

**When** viewing scanner interface
**Then** verify UI indicators:
- ‚úÖ Network status badge: **"üî¥ Offline"** (red) or **"üü¢ Online"** (green)
- ‚úÖ Queue counter badge: **"üì¶ Queue: 23"** (always visible when offline operations exist)
- ‚úÖ Sync status indicator: **"‚è≥ Syncing..."** (during sync) or **"‚úÖ Synced"** (when complete)
- ‚ö†Ô∏è Warning banner at 80 operations: **"80/100 operations queued. Reconnect to sync."**
- ‚ùå Error banner at 100 operations: **"Queue full. Sync required before continuing."**

**UI Placement:**
- Network status: Top-right corner (persistent)
- Queue counter: Top-center (persistent when >0 operations)
- Sync status: Top-center (during sync only)
- Warning/error banners: Full-width at top

**Technical Notes:**
- Real-time queue count updates (on every operation)
- Network status via `navigator.onLine` + periodic ping to server

---

### AC 3: Automatic Sync on Reconnect

**Given** Scanner PWA with 50 queued offline operations
**And** Network connection restored

**When** connection detected
**Then** verify automatic sync:
- ‚úÖ Sync starts within 2 seconds of reconnection
- ‚úÖ UI shows: **"‚è≥ Syncing 50 operations..."**
- ‚úÖ Operations synced in order (FIFO: First In First Out)
- ‚úÖ Progress indicator: **"Syncing 10/50... 20/50... 30/50..."**
- ‚úÖ Sync completes: **"‚úÖ All 50 operations synced successfully"**
- ‚úÖ Queue cleared after successful sync
- ‚úÖ IndexedDB offline queue emptied

**Sync Strategy:**
- Batch size: 10 operations per API call (for performance)
- Retry on failure: 3 attempts with exponential backoff (2s, 4s, 8s)
- If batch fails after 3 attempts: Mark operations as failed, continue with next batch

**Technical Notes:**
- API: POST /api/scanner/sync-offline-queue (bulk endpoint)
- Request payload: Array of operations (max 10 per request)
- Connection detection: `window.addEventListener('online', handleOnline)`

---

### AC 4: Partial Sync with Failure Handling

**Given** Scanner PWA with 100 queued operations
**And** Network reconnects but some operations fail validation (e.g., LP no longer exists)

**When** sync executes
**Then** verify failure handling:
- ‚úÖ Operations 1-70: Sync successfully
- ‚ùå Operation 71: Fails (LP-001 no longer exists) ‚Üí Marked as failed, moved to failed queue
- ‚úÖ Operations 72-100: Continue syncing (don't block entire queue)
- ‚úÖ UI shows: **"‚ö†Ô∏è 70/100 synced. 1 failed. 29 remaining."**
- ‚úÖ Failed operations shown in "Failed Queue" section (separate UI)
- ‚úÖ User can review failed operations and retry manually or discard

**Failed Queue UI:**
- Shows: Operation type, timestamp, error message, payload
- Actions: "Retry" or "Discard"
- Example: **"‚ùå LP Move failed: LP-001 no longer exists. (2025-01-20 14:32)"**

**Technical Notes:**
- Failed operations stored in separate IndexedDB key: `scanner_failed_queue`
- Max failed queue size: 50 operations (auto-purge oldest after 7 days)

---

### AC 5: Manual Sync Trigger

**Given** Scanner PWA with queued operations
**And** Network connection available

**When** Operator clicks "Sync Now" button
**Then** verify manual sync:
- ‚úÖ Sync starts immediately (even if <80 operations)
- ‚úÖ UI shows progress indicator
- ‚úÖ Sync completes with success/failure summary
- ‚úÖ Button disabled during sync (prevent double-click)
- ‚úÖ Button re-enabled after sync complete

**Button Placement:**
- Top-right corner next to network status badge
- Only visible when offline queue has >0 operations

**Technical Notes:**
- Same sync logic as AC 3 (automatic sync)
- Button: "Sync Now (23)" showing queue count

---

### AC 6: Queue Persistence Across App Restarts

**Given** Scanner PWA with 30 queued operations
**And** Operator closes browser/app

**When** Operator reopens scanner
**Then** verify queue persistence:
- ‚úÖ All 30 operations still in queue (loaded from IndexedDB)
- ‚úÖ UI shows: **"üì¶ Queue: 30"** (restored state)
- ‚úÖ Operations maintain order (FIFO preserved)
- ‚úÖ If online: Auto-sync starts within 5 seconds

**Technical Notes:**
- IndexedDB persists across app restarts (browser storage)
- On app load: Check IndexedDB for pending operations, restore queue state

---

### AC 7: Offline Operation Timestamps

**Given** Scanner PWA offline for 2 hours
**And** Operator performs 50 operations during offline period

**When** operations sync
**Then** verify timestamps:
- ‚úÖ Each operation records: `performed_at` (when operator executed) and `synced_at` (when uploaded to server)
- ‚úÖ Server respects `performed_at` timestamp for audit trail (not `synced_at`)
- ‚úÖ Example: Operation performed at 10:00 AM, synced at 12:00 PM ‚Üí Audit log shows 10:00 AM
- ‚úÖ UI shows both timestamps in Failed Queue: **"Performed: 10:00 AM, Synced: 12:00 PM"**

**Technical Notes:**
- Timestamps stored in ISO 8601 format with timezone
- Server validates: `performed_at` cannot be in future

---

### AC 8: Multi-User Queue Isolation

**Given** 2 operators using same scanner device with different user accounts
**And** User A has 20 queued operations, User B has 15 queued operations

**When** each user logs in
**Then** verify queue isolation:
- ‚úÖ User A sees: **"üì¶ Queue: 20"** (only their operations)
- ‚úÖ User B sees: **"üì¶ Queue: 15"** (only their operations)
- ‚úÖ Queues stored separately: `scanner_offline_queue_{org_id}_UserA`, `scanner_offline_queue_{org_id}_UserB`
- ‚úÖ On sync: Only current user's queue synced (not other users)

**Technical Notes:**
- Queue keys include user_id for isolation
- On logout: Queue persists (not cleared)

---

### AC 9: Queue Size Warning in Settings

**Given** Admin navigates to /settings/scanner
**Then** verify configurable queue settings:
- ‚úÖ Max queue size (default: 100, range: 50-500)
- ‚úÖ Warning threshold % (default: 80%, range: 50-90%)
- ‚úÖ Auto-sync on reconnect (default: enabled, toggle)
- ‚úÖ Sync batch size (default: 10, range: 5-50)
- ‚úÖ Failed queue retention days (default: 7, range: 1-30)

**When** Admin changes max queue size to 200
**Then** verify:
- ‚úÖ Scanner now allows 200 operations before blocking
- ‚úÖ Warning threshold updates: 80% of 200 = 160 operations

**Technical Notes:**
- Settings stored in `warehouse_settings` table
- Settings synced to scanner on load

---

### AC 10: E2E Test - 100 Offline Operations + Sync

**Test Scenario: Full Queue Capacity**

**Given** Scanner PWA offline
**When** Operator performs 100 consecutive operations:
1. Receive 50 LPs (from PO)
2. Consume 30 LPs (for WO)
3. Move 15 LPs (location change)
4. Split 5 LPs

**Then** verify offline queue:
- ‚úÖ All 100 operations stored in IndexedDB
- ‚úÖ UI shows: **"‚ö†Ô∏è Queue full (100/100). Sync required."**
- ‚ùå 101st operation blocked: **"Offline queue full. Please reconnect."**

**When** network reconnects
**Then** verify sync:
- ‚úÖ Auto-sync starts within 2 seconds
- ‚úÖ UI shows: **"‚è≥ Syncing 100 operations..."**
- ‚úÖ Progress updates: 10/100, 20/100, ..., 100/100
- ‚úÖ All 100 operations synced successfully within 30 seconds
- ‚úÖ Database verification:
  - 50 GRNs created with 50 LPs (receive operations)
  - 30 wo_consumption records created (consume operations)
  - 15 lp_movements records created (move operations)
  - 5 LP split records + genealogy (split operations)
- ‚úÖ Queue cleared: UI shows **"‚úÖ All operations synced"**
- ‚úÖ IndexedDB offline queue empty

**Performance Target:**
- ‚úÖ 100 operations sync in <30 seconds (batches of 10 = 10 API calls)
- ‚úÖ No data loss (100% success rate for valid operations)

**Technical Notes:**
- E2E test file: `tests/e2e/integration/scanner-offline-queue.spec.ts`
- Mock network offline: `page.context().setOffline(true)`
- Mock network online: `page.context().setOffline(false)`

---

## Technical Tasks

### IndexedDB Service

**Task 1:** Create IndexedDBService
- Methods: addOperation(), getQueue(), clearQueue()
- Methods: addFailedOperation(), getFailedQueue(), retryFailedOperation()
- Handle DB initialization, versioning, schema

**Task 2:** Create DB schema
- Store: `scanner_offline_queue_{org_id}_{user_id}`
- Store: `scanner_failed_queue_{org_id}_{user_id}`
- Indexes: by timestamp, operation_type, sync status

### Sync Engine

**Task 1:** Create SyncEngine
- Method: syncQueue() - orchestrates sync
- Handles batching, retries, progress updates
- Moves failed operations to failed queue

**Task 2:** Implement retry logic
- Exponential backoff: 2s, 4s, 8s
- Max 3 retries per batch
- Continue with next batch on failure

**Task 3:** Create POST /api/scanner/sync-offline-queue
- Endpoint to sync operations
- Validates payloads
- Returns success/failed counts

### Frontend Components

**Task 1:** OfflineQueueIndicator.tsx
- Network badge (online/offline)
- Queue counter
- Sync status
- Warning/error banners

**Task 2:** OfflineQueueManager.tsx
- Main component managing queue state
- Handles settings
- Integrates with SyncEngine

**Task 3:** FailedQueueUI.tsx
- List failed operations
- Show error details
- Retry/Discard actions

### NetworkMonitor

**Task 1:** Create NetworkMonitor service
- Listen to online/offline events
- Periodic ping (30s) to detect stale connection
- Trigger auto-sync on reconnect

### Integration

**Task 1:** Integrate with existing warehouse services
- ReceiveService, WOService, LPService, InventoryService
- Redirect operations to queue if offline
- Execute normally if online

**Task 2:** Update warehouse settings
- Add offline queue configuration columns
- Admin interface in /settings/scanner

---

## Testing

### Unit Tests
```typescript
// tests/unit/services/offline-queue.test.ts
- Queue add/remove/clear operations
- Capacity validation (max 100)
- Warning/error threshold checks (80%, 100%)
- FIFO ordering
- Retry logic (exponential backoff)
- Failed queue operations
- Multi-user queue isolation
```

### Integration Tests
```typescript
// tests/integration/offline-queue.spec.ts
- Offline operation ‚Üí IndexedDB stored
- Network reconnect ‚Üí auto-sync triggered
- Sync progress updates correctly
- Failed operations moved to failed queue
- Queue persistence across restart
- Multi-user isolation verified
```

### E2E Tests
```typescript
// tests/e2e/integration/scanner-offline-queue.spec.ts
- Full offline‚Üíonline workflow (AC 10)
- 100 operations offline ‚Üí sync all in <30s
- Failure handling with partial success
- Manual sync trigger
- Settings configuration in /settings/scanner
```

---

## Acceptance Criteria Checklist

- [ ] Operations stored in IndexedDB with timestamps
- [ ] Max 100 operations enforced
- [ ] Warning at 80%, block at 100%
- [ ] Network status badge displays correctly
- [ ] Queue counter updates in real-time
- [ ] Auto-sync starts within 2 seconds of reconnect
- [ ] Operations synced in FIFO order
- [ ] Failed operations moved to separate queue
- [ ] Manual sync trigger available
- [ ] Queue persists across app restart
- [ ] Timestamps preserved (performed_at vs synced_at)
- [ ] Multi-user queues isolated
- [ ] Settings configurable in /settings/scanner
- [ ] 100 operations sync in <30 seconds
- [ ] E2E test passes: full offline‚Üíonline workflow

---

## Dependencies

### Requires
- Story 5.23: Scanner Guided Workflows (scanner base)
- Story 5.31: Warehouse Settings (for configuration)
- Story 5.11: GRN & LP Creation (receive operations)
- Story 4.7: WO Material Consumption (consume operations)
- Story 5.14: LP Location Move (move operations)
- Story 5.5: LP Split (split operations)
- Story 5.35: Inventory Count (count operations)

### Blocks
- None (final story for Epic 5)

---

## Notes

- **Critical Feature:** Enables dock operations during network outages
- **Sprint 0 Gap 5:** This story addresses offline capability gap
- **Performance Critical:** 100 ops in <30s is hard requirement
- **Data Integrity:** Timestamps must be accurate for audit trail
- **Security:** Multi-user isolation essential for shared devices
- **User Experience:** Real-time queue counter and progress updates critical
- **Offline-Only:** Never queue sensitive data (auth, passwords)

---

## Success Criteria

- ‚úÖ All 10 ACs implemented and tested
- ‚úÖ Max 100 offline operations enforced (configurable)
- ‚úÖ Warning at 80% capacity (configurable threshold)
- ‚úÖ UI shows queue size, sync status, network status
- ‚úÖ Auto-sync on reconnect within 2 seconds
- ‚úÖ Manual sync trigger available
- ‚úÖ Queue persists across app restarts
- ‚úÖ Failed operations moved to separate queue for manual review
- ‚úÖ E2E test: 100 offline ops ‚Üí sync ‚Üí 100% success
- ‚úÖ Performance: 100 operations sync in <30 seconds

---

## Reference

**Sprint 0 Gap 5:** Scanner Offline Queue Management
- docs/readiness-assessment/3-gaps-and-risks.md
- Critical for warehouse operations continuity during network outages

---
