<?xml version="1.0" encoding="UTF-8"?>
<story>
  <metadata>
    <id>6.19</id>
    <title>Certificate of Analysis Upload</title>
    <batch>06C-1</batch>
    <status>drafted</status>
  </metadata>

  <description>Upload and store supplier CoAs for tracking</description>

  <dependencies>
    <blocks>
      <story id="6.20">Require CoA on Receipt</story>
      <story id="6.21">CoA Verification Tracking</story>
    </blocks>
    <requires>
      <epic id="5">GRN (Goods Received Notes)</epic>
    </requires>
  </dependencies>

  <technical_context>
    <tables>
      <table>
        <name>certificates_of_analysis</name>
        <columns>
          <column>id uuid PRIMARY KEY</column>
          <column>organization_id uuid NOT NULL REFERENCES organizations(id)</column>
          <column>grn_id uuid REFERENCES goods_received_notes(id)</column>
          <column>supplier_id uuid REFERENCES suppliers(id)</column>
          <column>product_id uuid NOT NULL REFERENCES products(id)</column>
          <column>batch_number text</column>
          <column>file_path text NOT NULL</column>
          <column>file_name text NOT NULL</column>
          <column>file_size int</column>
          <column>verification_status text DEFAULT 'pending' CHECK (verification_status IN ('pending', 'verified', 'rejected'))</column>
          <column>verified_by uuid REFERENCES profiles(id)</column>
          <column>verified_at timestamptz</column>
          <column>verification_notes text</column>
          <column>uploaded_by uuid NOT NULL REFERENCES profiles(id)</column>
          <column>created_at timestamptz DEFAULT now()</column>
        </columns>
      </table>
    </tables>

    <storage>
      <bucket>coa-documents</bucket>
      <path>{org_id}/{product_id}/{filename}</path>
    </storage>

    <api_endpoints>
      <endpoint method="POST" path="/api/quality/coas">Upload CoA with file</endpoint>
      <endpoint method="GET" path="/api/quality/coas/download/:id">Download CoA file</endpoint>
    </api_endpoints>
  </technical_context>

  <acceptance_criteria>
    <ac id="1">During GRN, upload CoA file (PDF, image)</ac>
    <ac id="2">CoA linked to: GRN, Supplier, Product, Batch number</ac>
    <ac id="3">LP detail shows linked CoA for download</ac>
  </acceptance_criteria>

  <functional_requirements>
    <fr id="QC-FR-21">System shall upload and store CoAs</fr>
  </functional_requirements>
</story>
