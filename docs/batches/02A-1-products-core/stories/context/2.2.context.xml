<?xml version="1.0" encoding="UTF-8"?>
<story>
  <metadata>
    <id>2.2</id>
    <title>Product Versioning</title>
    <batch>02A-1</batch>
    <points>3</points>
    <effort_hours>4-5</effort_hours>
    <status>pending</status>
  </metadata>

  <description>Automatic version tracking for products using X.Y format with database triggers.</description>

  <dependencies>
    <blocks>
      <story id="2.3">Product History</story>
    </blocks>
    <requires>
      <story id="2.1">Product CRUD</story>
    </requires>
  </dependencies>

  <technical_context>
    <database_functions>
      <function name="increment_product_version">
        <description>Increments version from X.Y to X.(Y+1), rolls over at .9 to (X+1).0</description>
        <sql>
CREATE OR REPLACE FUNCTION increment_product_version(current_version NUMERIC)
RETURNS NUMERIC AS $$
DECLARE
  major_ver INTEGER;
  minor_ver INTEGER;
BEGIN
  major_ver := floor(current_version);
  minor_ver := round((current_version - major_ver) * 10);
  IF minor_ver >= 9 THEN
    RETURN (major_ver + 1.0);
  ELSE
    RETURN (major_ver + (minor_ver + 1) * 0.1);
  END IF;
END;
$$ LANGUAGE plpgsql IMMUTABLE;
        </sql>
      </function>
      <trigger name="trigger_track_product_version">
        <description>Before UPDATE on products - increments version and logs to history</description>
        <fires_on>BEFORE UPDATE ON products</fires_on>
      </trigger>
    </database_functions>

    <version_format>
      <rule>Initial version: 1.0</rule>
      <rule>Minor changes: 1.0 → 1.1 → 1.2 → ... → 1.9</rule>
      <rule>Major rollover: 1.9 → 2.0</rule>
      <rule>No manual override allowed</rule>
    </version_format>

    <frontend_updates>
      <update>ProductEditDrawer shows current version</update>
      <update>Save button shows "New version will be X.Y"</update>
      <update>ProductTable displays version column</update>
    </frontend_updates>
  </technical_context>

  <acceptance_criteria>
    <ac id="2.2.1">Version Auto-Increment - any business field change triggers version bump</ac>
    <ac id="2.2.2">Version Display - current version shown in edit drawer</ac>
    <ac id="2.2.3">Version Preview - show new version before saving</ac>
    <ac id="2.2.4">Version Rollover - 1.9 becomes 2.0</ac>
  </acceptance_criteria>

  <test_plan>
    <unit_tests>
      <test>increment_product_version(1.0) returns 1.1</test>
      <test>increment_product_version(1.9) returns 2.0</test>
      <test>increment_product_version(5.5) returns 5.6</test>
    </unit_tests>
    <integration_tests>
      <test>Update product name → version incremented</test>
      <test>Update product description → version incremented</test>
      <test>Soft delete → version NOT incremented</test>
    </integration_tests>
  </test_plan>

  <implementation_notes>
    <note priority="critical">Trigger handles version logic - frontend should NOT send version</note>
    <note priority="high">Audit columns (updated_at, updated_by) excluded from version tracking</note>
  </implementation_notes>
</story>
