# Story 5.1: License Plate Creation

**ID:** 5.1
**Batch:** 5A-1 (LP Core)
**Story Points:** 8
**Effort:** 8-10 hours
**Status:** Todo

---

## User Story

> As a **Warehouse user**, I want to create license plates, so that inventory is tracked atomically.

---

## Acceptance Criteria

### AC 1: LP Creation Modal
- **Given** user navigates to `/warehouse/license-plates`
- **When** clicking "Create License Plate"
- **Then** modal opens with form containing:
  - `lp_number` (auto-generated, read-only unless override)
  - `product_id` (required, dropdown with search)
  - `batch_number` (required, text)
  - `supplier_batch_number` (optional)
  - `quantity` (required, decimal, positive)
  - `uom` (auto-filled from product, display-only)
  - `manufacture_date` (optional, date picker)
  - `expiry_date` (optional, date picker)
  - `location_id` (required, dropdown)
  - `qa_status` (optional, dropdown)

### AC 2: Auto-Generate LP Number
- **Given** `lp_number` not provided
- **When** saving LP
- **Then** auto-generate: `LP-YYYYMMDD-NNNN`
  - Example: `LP-20250127-0001`
  - Globally unique within org_id
  - Daily sequence reset at midnight

### AC 3: Save LP
- **Given** form filled with required fields
- **When** clicking "Save"
- **Then**:
  - Validate required fields (product_id, location_id, batch_number, qty)
  - Validate qty > 0
  - Validate product exists (FK)
  - Validate location exists and is active (FK)
  - Create LP record with status = 'available'
  - Return success: "LP LP-20250127-0001 created"
  - Close modal, refresh LP list

### AC 4: List License Plates
- **Given** navigating to `/warehouse/license-plates`
- **When** page loads
- **Then** display table with:
  - LP Number (sortable)
  - Product (name + SKU)
  - Batch Number
  - Quantity + UoM
  - Expiry Date
  - Status (badge: available=ðŸŸ¢, reserved=ðŸŸ¡, consumed=âš«, quarantine=ðŸ”´, shipped=ðŸ”µ)
  - Location
  - Created Date
  - Actions (View, Edit, Delete)

### AC 5: Validation Errors
- **Given** invalid form data
- **When** clicking "Save"
- **Then** show error messages:
  - "Product is required"
  - "Location is required or inactive"
  - "Quantity must be greater than 0"
  - "Location no longer exists"

---

## Technical Tasks

### Backend

- [ ] **POST /api/warehouse/license-plates**
  - Generate lp_number using lp_number_sequence
  - Validate FKs: product_id, location_id
  - Validate org_id from JWT
  - Insert license_plates record
  - Return created LP object

- [ ] **GET /api/warehouse/license-plates**
  - Filter by: product_id, status, location_id, batch_number
  - Sort by: lp_number, created_at, expiry_date
  - Paginate (50 per page)
  - RLS: filter by org_id

- [ ] **GET /api/warehouse/license-plates/:id**
  - Return single LP detail
  - Include related data (product, location)

- [ ] **PATCH /api/warehouse/license-plates/:id**
  - Update status, location, qa_status only
  - Return updated LP

- [ ] **DELETE /api/warehouse/license-plates/:id**
  - Delete LP (or soft delete if policy requires)

### Database

- [ ] Create `license_plates` table (see tech-spec)
- [ ] Create `lp_number_sequence` table
- [ ] Create unique index on `(org_id, lp_number)`
- [ ] Create indexes for filters: `(org_id, status)`, `(org_id, product_id)`
- [ ] Create RLS policies:
  - SELECT: org_id isolation
  - INSERT: org_id from JWT
  - UPDATE: org_id isolation
  - DELETE: org_id isolation

### Frontend

- [ ] **Create `/app/warehouse/license-plates/page.tsx`**
  - Table with LP list
  - Filters (product, status, location, batch)
  - "Create License Plate" button

- [ ] **Create `/app/warehouse/license-plates/create-modal.tsx`**
  - Form with Zod validation
  - Product dropdown with search
  - Location dropdown
  - Date pickers
  - Submit handler to POST /api/warehouse/license-plates

- [ ] **Create `hooks/useCreateLP.ts`**
  - useMutation for POST LP
  - useFetch for list LPs
  - Error handling

- [ ] **Create components:**
  - `LPTable` - table with columns and filters
  - `LPForm` - form component
  - `StatusBadge` - color-coded status badge

---

## Testing

### Unit Tests
- LP CRUD operations
- Number generation (format, daily reset)
- Validation logic (qty > 0, FK checks)
- Status transitions (valid states)

### Integration Tests
- POST LP with FKs â†’ verify record created
- POST LP duplicate number â†’ verify unique constraint
- GET LP with filters â†’ verify correct results
- DELETE LP â†’ verify soft/hard delete

### E2E Tests
- Create LP via UI â†’ verify in list
- Create LP with invalid data â†’ see error message
- Delete LP â†’ verify removed from list

**Test File:** `./__tests__/api/warehouse/license-plates.test.ts`

---

## Acceptance Criteria Checklist

- âœ… LP creation modal opens with all required fields
- âœ… LP number auto-generated in correct format
- âœ… LP created with status = 'available'
- âœ… Can list all LPs with filters
- âœ… Validation errors shown clearly
- âœ… Foreign key constraints enforced
- âœ… RLS policies tested (org isolation)
- âœ… E2E: create LP â†’ see in list â†’ verify all fields correct

---

## Dependencies

**Requires:**
- Epic 1: Organizations, Users, Locations
- Epic 2: Products with UoM

**Blocks:**
- Story 5.2 (Status Tracking)
- Story 5.3 (Batch/Expiry)
- Story 5.4 (Numbering)
- Batch 5A-2 (Split/Merge)
- Batch 5A-3 (Receiving)

**Related:**
- Story 5.11 (GRN creates LPs)
- Story 5.14 (Move LPs)

---

## Notes

- LP is the **atomic unit of inventory** in warehouse module
- Each LP has unique number per organization
- Status drives availability for consumption
- Must integrate with product master data (UoM)
- Must integrate with location hierarchy
