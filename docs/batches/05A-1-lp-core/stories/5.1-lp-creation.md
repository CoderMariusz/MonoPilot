# Story 5.1: License Plate Creation

**ID:** 5.1
**Batch:** 5A-1 (LP Core)
**Story Points:** 8
**Effort:** 10-12 hours (updated: added detail page + warehouse context)
**Status:** Todo
**Updated:** 2025-11-28 (PO decisions applied)

---

## User Story

> As a **Warehouse user**, I want to create license plates, so that inventory is tracked atomically.

---

## Acceptance Criteria

### AC 1: LP Creation Modal
- **Given** user navigates to LP list or clicks "Create LP" in receiving workflow
- **When** clicking "Create License Plate"
- **Then** modal opens with form containing:
  - `lp_number` (auto-generated, read-only in this story; override added in 5.4)
  - `product_id` (required, dropdown with search)
  - `supplier_batch_number` (required, text - supplier's lot number)
  - `quantity` (required, decimal, positive)
  - `uom` (auto-filled from product, display-only)
  - `manufacture_date` (optional, date picker)
  - `expiry_date` (optional, date picker)
  - `location_id` (required, dropdown)
  - `qa_status` (optional, dropdown; defaults from warehouse_settings)
  - `warehouse_id` (derived from user's default warehouse or receiving context)

### AC 2: Auto-Generate LP Number
- **Given** `lp_number` not provided
- **When** saving LP
- **Then** auto-generate per warehouse format: `LP-{WH}-YYYYMMDD-NNNN`
  - Example: `LP-WH01-20250127-0001`
  - Unique within org_id + warehouse_id
  - Daily sequence reset at midnight
  - Format configurable in `warehouse_settings.lp_number_format`

### AC 3: Save LP
- **Given** form filled with required fields
- **When** clicking "Save"
- **Then**:
  - Validate required fields (product_id, location_id, supplier_batch_number, qty, warehouse_id)
  - Validate qty > 0
  - Validate product exists (FK)
  - Validate location exists and is active (FK)
  - Validate warehouse_id exists (FK)
  - Create LP record with:
    - status = 'available'
    - warehouse_id from form
    - created_by = current user
    - deleted_at = NULL (active LP)
  - Return success: "LP LP-20250127-0001 created"
  - Close modal, refresh LP list

### AC 4: List License Plates (Table View)
- **Given** navigating to `/warehouse/license-plates`
- **When** page loads
- **Then** display table with:
  - LP Number (sortable, clickable â†’ opens detail modal)
  - Product (name + SKU)
  - Supplier Batch (supplier_batch_number)
  - Quantity + UoM
  - Expiry Date
  - Status (badge: available=ğŸŸ¢, reserved=ğŸŸ¡, consumed=âš«, quarantine=ğŸ”´, shipped=ğŸ”µ, merged=ğŸŸ£, deleted=âšª)
  - Location
  - Created Date
  - Actions: (View/Click modal) or context menu (Edit, Delete)

### AC 5: Validation Errors
- **Given** invalid form data
- **When** clicking "Save"
- **Then** show error messages:
  - "Product is required"
  - "Supplier Batch Number is required"
  - "Location is required or inactive"
  - "Quantity must be greater than 0"
  - "Warehouse is required"
  - "Location no longer exists"
  - "Expiry date cannot be before manufacture date"

---

## Technical Tasks

### Backend

- [ ] **POST /api/warehouse/license-plates**
  - Generate lp_number using lp_number_sequence
  - Validate FKs: product_id, location_id
  - Validate org_id from JWT
  - Insert license_plates record
  - Return created LP object

- [ ] **GET /api/warehouse/license-plates**
  - Filter by: product_id, status, location_id, supplier_batch_number, warehouse_id
  - Sort by: lp_number, created_at, expiry_date
  - Paginate (50 per page)
  - RLS: filter by org_id
  - Exclude deleted LPs (deleted_at IS NULL)

- [ ] **GET /api/warehouse/license-plates/:id**
  - Return single LP detail
  - Include related data (product, location)

- [ ] **PATCH /api/warehouse/license-plates/:id**
  - Update status, location, qa_status only
  - Return updated LP

- [ ] **DELETE /api/warehouse/license-plates/:id**
  - Delete LP (or soft delete if policy requires)

### Database

**Note:** `license_plates` table already exists as STUB from Epic 2. This story EXTENDS it.

- [ ] **Extend `license_plates` table** (see tech-spec migration SQL):
  - âœ… Remove `batch_number` (if exists) - LP number plays this role
  - Add `supplier_batch_number VARCHAR(50)` (if not exists)
  - Add `qa_status VARCHAR(20) DEFAULT 'pending'` with CHECK (if not exists)
  - Add `updated_by UUID REFERENCES users(id)`
  - Add `warehouse_id UUID REFERENCES warehouses(id)` (required)
  - Add `deleted_at TIMESTAMPTZ` (soft delete support)
  - Add `created_by UUID REFERENCES users(id)`
  - Update status CHECK to include: 'available', 'reserved', 'consumed', 'quarantine', 'shipped', 'recalled', 'merged', 'deleted'
- [ ] Create `warehouse_settings` table (1:1 with warehouses)
- [ ] Create `lp_number_sequence` table (per org + warehouse)
- [ ] Create indexes:
  - `(org_id, status)`
  - `(org_id, product_id)`
  - `(warehouse_id)`
  - `(expiry_date)`
- [ ] Verify RLS policies on extended table

### Frontend

- [ ] **Warehouse Context Setup**
  - Add `warehouse_id` to user profile (users table)
  - Story 5.1: Retrieve current user's default warehouse
  - In receiving workflow: warehouse_id from context (passed to modal)
  - In settings: allow user to switch default warehouse

- [ ] **Create `/app/warehouse/license-plates/page.tsx`**
  - Table with LP list
  - Filters (product, status, location, supplier_batch, warehouse, expiry)
  - "Create License Plate" button
  - Click LP â†’ opens detail modal (not page)

- [ ] **Create `/app/warehouse/license-plates/create-modal.tsx`**
  - Form with Zod validation
  - Product dropdown with search
  - Supplier Batch Number (required, text)
  - Location dropdown
  - Date pickers (manufacture, expiry)
  - QA Status (optional)
  - warehouse_id (derived from user/context)
  - Submit handler to POST /api/warehouse/license-plates

- [ ] **Create `/app/warehouse/license-plates/detail-modal.tsx`** â­ NEW
  - Modal (not page) - scrollable, max 85% window size
  - Tab 1: LP Overview (read-only display, edit mode from 5.2)
  - Tab 2: Genealogy (from 5.7, if genealogy exists)
  - Tab 3: History (status changes, movements)
  - Action buttons: Edit (5.2), Move, Split (5.5), Merge (5.6)
  - Close button, responsive design

- [ ] **Create `hooks/useCreateLP.ts`**
  - useMutation for POST LP
  - useFetch for list LPs
  - Error handling
  - Warehouse context injection

- [ ] **Create components:**
  - `LPTable` - table with columns and filters
  - `LPCreateForm` - form component (in modal)
  - `LPDetailModal` - detail view modal
  - `StatusBadge` - color-coded status badge (including 'merged', 'deleted')

---

## Testing

### Unit Tests
- LP CRUD operations
- Number generation (format, daily reset)
- Validation logic (qty > 0, FK checks)
- Status transitions (valid states)

### Integration Tests
- POST LP with FKs â†’ verify record created
- POST LP duplicate number â†’ verify unique constraint
- GET LP with filters â†’ verify correct results
- DELETE LP â†’ verify soft/hard delete

### E2E Tests
- Create LP via UI â†’ verify in list
- Create LP with invalid data â†’ see error message
- Delete LP â†’ verify removed from list

**Test File:** `./__tests__/api/warehouse/license-plates.test.ts`

---

## Acceptance Criteria Checklist

- âœ… LP creation modal opens with all required fields
- âœ… LP number auto-generated in correct format
- âœ… LP created with status = 'available'
- âœ… Can list all LPs with filters
- âœ… Validation errors shown clearly
- âœ… Foreign key constraints enforced
- âœ… RLS policies tested (org isolation)
- âœ… E2E: create LP â†’ see in list â†’ verify all fields correct

---

## Dependencies

**Requires:**
- Epic 1: Organizations, Users, Warehouses, Locations
- Epic 2: Products with UoM
- âš ï¸ **STUB exists**: `license_plates` table (Epic 2) - will be EXTENDED

**Blocks:**
- Story 5.2 (Status Tracking)
- Story 5.3 (Batch/Expiry)
- Story 5.4 (Numbering)
- Batch 5A-2 (Split/Merge)
- Batch 5A-3 (Receiving)

**Related:**
- Story 5.11 (GRN creates LPs via grn_items.lp_id)
- Story 5.14 (Move LPs)

---

## Notes

- LP is the **atomic unit of inventory** in warehouse module
- Each LP has unique number per organization + warehouse
- Status drives availability for consumption
- **Batch role is played by LP number** (not separate batch_number field)
- **Supplier Batch** (supplier_batch_number) is for FDA traceability only
- Must integrate with product master data (UoM)
- Must integrate with location hierarchy
- **Warehouse context**: derived from user's default warehouse (set in settings/profile)
- **LP Detail Modal** (new in 5.1 update): modal-based detail view, not separate page
- **Soft Delete**: deleted_at timestamp used for soft deletes (genealogy preserved)
- **PO Decision**: batch_number field REMOVED (LP plays batch role)
