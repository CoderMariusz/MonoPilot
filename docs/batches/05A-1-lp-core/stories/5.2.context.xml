<?xml version="1.0" encoding="UTF-8"?>
<story>
  <id>5.2</id>
  <name>LP Status Tracking</name>
  <batch>5A-1 (LP Core)</batch>
  <updated>2025-11-28</updated>
  <status>Todo</status>

  <context>
    <description>
      Defines LP status lifecycle and transitions. Critical for workflow coordination
      across split, merge, consume, and receive operations. New merged/deleted states added.
    </description>

    <key-changes>
      <change type="ADDED">merged status (immutable, source LPs after merge operation)</change>
      <change type="ADDED">deleted status (soft delete, can be restored)</change>
      <change type="UPDATED">status transitions expanded to include merged/deleted flows</change>
      <change type="ADDED">status badge colors for UI (merged=purple, deleted=white)</change>
    </key-changes>

    <critical-requirements>
      <!-- Status Transitions -->
      available → reserved/consumed/quarantine/merged/deleted
      merged → IMMUTABLE (cannot change, archive only)
      deleted → can be restored via hard delete (UI admin function)
      Any status → shipped (final state for shipped inventory)

      <!-- Status Immutability -->
      'merged' status is permanent and immutable.
      Source LPs after merge cannot be moved, consumed, or further merged.
      Only result LP from merge has 'available' status.
    </critical-requirements>

    <related-stories>
      <requires>5.1 (LP Creation)</requires>
      <used-by>5.5 (Split), 5.6 (Merge), 5.7a (Genealogy Recording)</used-by>
    </related-stories>

    <effort-estimate>
      <updated>2025-11-28</updated>
      <hours>5-6</hours>
      <points>5</points>
    </effort-estimate>

    <implementation-notes>
      - Status transitions enforced via CHECK constraint in database
      - StatusBadge component: colors per status (available=green, merged=purple, deleted=white)
      - Status filter added to LP list (important for finding merged/deleted LPs)
      - Audit trail: updated_by_user_id, updated_at on all status changes
      - ChangeStatusModal: shows allowed transitions dynamically
    </implementation-notes>
  </context>
</story>
