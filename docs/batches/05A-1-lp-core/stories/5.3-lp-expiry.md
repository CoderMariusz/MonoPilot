# Story 5.3: LP Batch/Expiry Tracking

**ID:** 5.3
**Batch:** 5A-1 (LP Core)
**Story Points:** 5
**Effort:** 5-6 hours
**Status:** Todo

---

## User Story

> As a **Warehouse user**, I want to track batch and expiry dates, so that I can manage FIFO/FEFO.

---

## Acceptance Criteria

### AC 1: Batch Number Required
- **Given** creating LP
- **When** saving
- **Then** batch_number is required field
- **And** supplier_batch_number is optional

### AC 2: Expiry Date Display
- **Given** viewing LP list
- **When** LP has expiry_date
- **Then** show in format: "2025-12-31" in dedicated column
- **And** if expiry_date < today, highlight row in light red background

### AC 3: Expired LP Warning
- **Given** LP with expiry_date < today
- **When** viewing LP detail or list
- **Then** show warning banner: "⚠️ This LP is expired (Expired on 2025-01-20)"

### AC 4: FEFO Sorting
- **Given** user navigates to LP list
- **When** clicking "Expiry Date" column header to sort
- **Then** LPs sorted by expiry_date (earliest first)
- **And** expired LPs appear at top

### AC 5: Filter by Expiry Range
- **Given** LP list page
- **When** setting date range filter (e.g., "Expiring in 30 days")
- **Then** show only LPs with expiry_date between now and +30 days

---

## Technical Tasks

### Backend

- [ ] Add expiry_date validation to license_plates table
- [ ] Create endpoint filter: `?expiry_from=YYYY-MM-DD&expiry_to=YYYY-MM-DD`
- [ ] Implement FEFO sorting in queries
- [ ] Add query helper: `getExpiringSoonLPs(org_id, days=30)`
- [ ] Add validation: expired LP cannot move to 'available' status

### Database

- [ ] Create index on expiry_date for sorting performance
- [ ] Add CHECK constraint: `manufacture_date < expiry_date` (if both provided)

### Frontend

- [ ] Add date picker filters to LP list page
- [ ] Highlight expired rows with CSS background-color: #fee
- [ ] Add "Expiring Soon" badge next to expiry date
- [ ] Show warning banner on LP detail if expired
- [ ] Update sort logic for expiry_date column

---

## Testing

### Unit Tests
- FEFO sorting with mixed dates
- Expired LP validation

### E2E Tests
- Create LP with past expiry → see warning
- Sort by expiry date → correct order
- Filter expiring in 30 days → correct results

---

## Acceptance Criteria Checklist

- ✅ Batch number displayed in list and detail
- ✅ Expired LPs highlighted
- ✅ FEFO sorting works
- ✅ Expiry filter works

---

## Dependencies

**Requires:** Story 5.1 (License Plate Creation)

---

## Notes

- FEFO = First Expired First Out (critical for perishables)
- Expiry tracking essential for food/pharma industry
