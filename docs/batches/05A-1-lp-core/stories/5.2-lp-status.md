# Story 5.2: LP Status Tracking

**ID:** 5.2
**Batch:** 5A-1 (LP Core)
**Story Points:** 5
**Effort:** 5-6 hours
**Status:** Todo

---

## User Story

> As a **Warehouse user**, I want to track LP status, so that I know availability.

---

## Acceptance Criteria

### AC 1: Status Lifecycle
- **Given** LP is created
- **When** checking status
- **Then** has status = 'available'

- **Given** LP status can be changed
- **When** updating status
- **Then** valid transitions are:
  - `available` â†’ `reserved` (for WO/TO allocation)
  - `available` â†’ `consumed` (fully used)
  - `available` â†’ `quarantine` (QA hold)
  - `reserved` â†’ `available` (unreserve)
  - `reserved` â†’ `consumed` (after WO consumption)
  - `quarantine` â†’ `available` (QA pass)
  - `quarantine` â†’ `consumed` (rejected)
  - Any status â†’ `shipped` (final state)

### AC 2: Status Update UI
- **Given** LP detail view
- **When** clicking "Change Status" button
- **Then** modal shows:
  - Current status (read-only)
  - Status dropdown with allowed next states
  - Reason field (optional, text)
  - "Update" button

### AC 3: Audit Trail
- **Given** status changes
- **When** updating status
- **Then** record:
  - `updated_by_user_id` (current user)
  - `updated_at` (timestamp)

### AC 4: Status List Display
- **Given** viewing LP list
- **When** status column visible
- **Then** show status with color badges:
  - available = ðŸŸ¢ Green
  - reserved = ðŸŸ¡ Yellow
  - consumed = âš« Gray
  - quarantine = ðŸ”´ Red
  - shipped = ðŸ”µ Blue

---

## Technical Tasks

### Backend

- [ ] Add status transition validation to LP update endpoint
- [ ] Create validation rules in database CHECK constraint
- [ ] Implement PATCH /api/warehouse/license-plates/:id/status
  - Accept new_status and reason (optional)
  - Validate transition is allowed
  - Update status + updated_by + updated_at
  - Return updated LP

### Database

- [ ] Update license_plates table: add status enum validation
- [ ] Create lp_status_history table (optional, for full audit):
  ```sql
  CREATE TABLE lp_status_history (
    id UUID PRIMARY KEY,
    lp_id UUID NOT NULL REFERENCES license_plates(id),
    old_status VARCHAR(20),
    new_status VARCHAR(20),
    reason TEXT,
    changed_at TIMESTAMP DEFAULT now(),
    changed_by_user_id UUID REFERENCES users(id)
  );
  ```

### Frontend

- [ ] Create StatusBadge component (color-coded)
- [ ] Create ChangeStatusModal component
- [ ] Update LP detail page to show status history
- [ ] Add status filter to LP list

---

## Testing

### Unit Tests
- Status transition validation (all valid paths)
- Invalid transition rejection

### Integration Tests
- Update status via API
- Verify updated_by and updated_at recorded

### E2E Tests
- Change status, see updated badge
- Verify status history displayed

---

## Acceptance Criteria Checklist

- âœ… All status transitions validated
- âœ… Invalid transitions rejected with error message
- âœ… Audit trail (updated_by_user_id, updated_at) recorded
- âœ… UI shows color badges correctly
- âœ… Status filter works in list view

---

## Dependencies

**Requires:** Story 5.1 (License Plate Creation)

**Blocks:** None directly (Story 5.2 is independent)

---

## Notes

- Status drives LP availability for operations
- Transitions are **not fully restrictive** (for flexibility)
- Color coding important for quick visual scanning
