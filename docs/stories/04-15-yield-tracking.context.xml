<?xml version="1.0" encoding="UTF-8"?>
<story-context id="4-15-yield-tracking" v="1.0">
  <metadata>
    <epicId>4</epicId>
    <storyId>15</storyId>
    <title>Yield Tracking</title>
    <status>drafted</status>
    <generatedAt>2025-11-27</generatedAt>
    <template>Analytics Pattern - Metric Calculation and Display</template>
    <estimatedTokens>4800</estimatedTokens>
    <estimatedEffort>0.5 days</estimatedEffort>
  </metadata>

  <story>
    <asA>Production Manager</asA>
    <iWant>to see yield metrics</iWant>
    <soThat>I can identify efficiency issues</soThat>
    <tasks>
      <task id="1" ac="AC-4.15.3">Implement yield calculation logic (Output Yield, Material Yield, Operation Yields)</task>
      <task id="2" ac="AC-4.15.4">Create GET /api/production/work-orders/:id/yield endpoint</task>
      <task id="3" ac="AC-4.15.1, AC-4.15.2">Frontend YieldSummary component with color-coded metrics</task>
      <task id="4" ac="AC-4.15.5">Integrate yield metrics into production dashboard KPIs</task>
      <task id="5" ac="AC-4.15.6, AC-4.15.7">Add warning indicators and variance analysis</task>
      <task id="6" ac="ALL">Tests (unit, integration, E2E) - yield calculations, color coding, edge cases</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC-4.15.1">Given viewing WO detail, When status is in_progress or completed, Then display yield summary: Output Yield (actual_output / planned Ã— 100%), Material Yield (planned_material / consumed Ã— 100%), Operation Yields (from each operation)</criterion>
    <criterion id="AC-4.15.2">Then Color coded: Green >= 95%, Yellow 80-95%, Red &lt; 80%</criterion>
    <criterion id="AC-4.15.3">Calculation Logic: Output Yield = (actual_output_qty / wo.quantity) Ã— 100% (if wo.quantity = 0, yield = N/A), Material Yield = (wo_materials.required_qty / wo_materials.consumed_qty) Ã— 100% (if consumed_qty = 0, yield = 0%), Operation Yield = (operation.actual_yield_percent) (default 0% if not recorded)</criterion>
    <criterion id="AC-4.15.4">API Endpoint: GET /api/production/work-orders/:id/yield returns: {output_yield: 87.5, material_yield: 92.3, operation_yields: [{operation_id, name, yield}]}</criterion>
    <criterion id="AC-4.15.5">Then Yield metrics appear on production dashboard (Story 4.1) KPIs</criterion>
    <criterion id="AC-4.15.6">When yield &lt; 80%, Then warning indicator on dashboard</criterion>
    <criterion id="AC-4.15.7">Then Track variance: target (95%) vs actual</criterion>
    <criterion id="AC-4.15.8">Then Requires Stories 4.5, 4.12 (operation and output completion)</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/epics/04-production.md</path>
        <title>Epic 4: Production Execution</title>
        <section>Story 4.15: Yield Tracking</section>
        <snippet>Enable production managers to track yield metrics across output, materials, and operations. Calculate Output Yield (actual vs planned), Material Yield (required vs consumed), Operation Yields (from actual_yield_percent). Color-coded display (Green >=95%, Yellow 80-95%, Red &lt;80%), Dashboard integration with warnings, Variance analysis against targets</snippet>
      </doc>
      <doc>
        <path>docs/ux-design/ux-design-production-module.md</path>
        <title>Production Module UX Design</title>
        <section>WO Details Modal - Yield Tab / KPI Cards</section>
        <snippet>Production dashboard shows 5 KPI cards including Avg Yield. Per-operation breakdown shows actual vs expected yield with color-coded indicators. Operations summary: âœ“ Op1 Grinding (92% yield, target 90%, Completed), â— Op2 Mixing (78.3% yield âš ï¸, target 95%). Low yield alerts: Red Low Yield - Op2 Mixing (78.3% &lt; 95% target), Impact: -140 kg output lost</snippet>
      </doc>
      <doc>
        <path>docs/ux-design/ux-design-shared-system.md</path>
        <title>Shared UI Design System</title>
        <section>Stats Cards Component &amp; Color Palette</section>
        <snippet>Stats Cards: 120px height, 2Ã—2 grid layout, Icon + Label (12px) + Value (18px). Status badges: Active/Confirmed (green-200 bg + green-800 text), Warning (yellow-200 bg + yellow-800 text), Error/Expired (red-200 bg + red-800 text). Accents: Info (blue-500), Warning (amber-500), Success (green-500)</snippet>
      </doc>
    </docs>

    <code>
      <artifact>
        <path>apps/frontend/lib/supabase/migrations/028_create_work_orders_stub.sql</path>
        <kind>migration</kind>
        <symbol>work_orders table - quantity and output fields</symbol>
        <content>
          CREATE TABLE IF NOT EXISTS public.work_orders (
            id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
            org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
            wo_number VARCHAR(50) NOT NULL UNIQUE,
            product_id UUID NOT NULL REFERENCES products(id) ON DELETE RESTRICT,

            -- Quantities for Output Yield calculation
            planned_quantity DECIMAL(12,3) NOT NULL,
            produced_quantity DECIMAL(12,3) DEFAULT 0,
            uom VARCHAR(10) NOT NULL,

            status VARCHAR(20) NOT NULL DEFAULT 'draft',
            -- Values: draft, released, in_progress, completed, closed, cancelled

            -- NOTE: Story 4.15 calculates Output Yield = (produced_quantity / planned_quantity) Ã— 100%
            -- produced_quantity updated from Story 4.12 (output completion)
          );
        </content>
        <reason>Output Yield calculation requires work_orders.planned_quantity and produced_quantity (actual output)</reason>
      </artifact>
      <artifact>
        <path>docs/stories/04-5-operation-complete.context.xml</path>
        <kind>context</kind>
        <symbol>wo_operations table - actual_yield_percent field</symbol>
        <content>
          -- wo_operations table schema (from Story 4.5)
          -- id UUID PRIMARY KEY
          -- wo_id UUID REFERENCES work_orders(id)
          -- sequence_number INT
          -- operation_name VARCHAR(100)
          -- status VARCHAR(20) -- 'not_started', 'in_progress', 'completed'
          -- expected_yield_percent DECIMAL(5,2) DEFAULT 100
          -- actual_yield_percent DECIMAL(5,2)  -- Recorded by Story 4.5 Operation Complete
          -- expected_output DECIMAL(12,3)
          -- actual_output DECIMAL(12,3)
          -- completed_at TIMESTAMP WITH TIME ZONE

          -- Story 4.15 reads actual_yield_percent for Operation Yields display
        </content>
        <reason>Operation Yield metrics sourced from wo_operations.actual_yield_percent (Story 4.5)</reason>
      </artifact>
      <artifact>
        <path>packages/shared/types.ts</path>
        <kind>types</kind>
        <symbol>WOMaterial type - consumed_qty and required_qty</symbol>
        <content>
          export interface WOMaterial {
            item_code?: string;
            item_name?: string;
            standard_qty?: number;
            consumed_qty?: number;  // Updated by consumption stories (4.7-4.9)
            uom?: string;
            yield_percentage?: number;
          }

          // NOTE: For Material Yield calculation in Story 4.15:
          // required_qty comes from BOM (standard_qty * wo.planned_quantity)
          // consumed_qty comes from wo_consumption records (sum of consumed amounts)
          // Material Yield = (required_qty / consumed_qty) Ã— 100%
        </content>
        <reason>Material Yield calculation requires wo_materials.required_qty and consumed_qty</reason>
      </artifact>
      <artifact>
        <path>docs/stories/04-1-production-dashboard.context.xml</path>
        <kind>context</kind>
        <symbol>Production Dashboard KPI Cards - Avg Yield metric</symbol>
        <content>
          AC-4.1.1 Dashboard KPI Cards:
          - Orders Today: COUNT(work_orders WHERE completed_at >= TODAY)
          - Units Produced: SUM(production_outputs.quantity WHERE created_at >= TODAY)
          - Avg Yield: Weighted SUM(actual_output)/SUM(planned_qty) Ã— 100% for WOs completed today
          - Active WOs: COUNT(work_orders WHERE status IN ['in_progress', 'paused'])
          - Material Shortages: COUNT(wo_materials WHERE available_qty &lt; required_qty)
          Color coding: Green >=95%, Yellow 80-95%, Red &lt;80%

          // Story 4.15 adds per-WO yield details that feed into dashboard Avg Yield KPI
        </content>
        <reason>Story 4.15 yield metrics integrate with Story 4.1 dashboard KPIs</reason>
      </artifact>
      <artifact>
        <path>apps/frontend/components/planning/PlanningStatsCard.tsx</path>
        <kind>component</kind>
        <symbol>Stats Card component pattern</symbol>
        <reason>Story 4.15 can reuse StatsCard pattern for yield display (2Ã—2 grid, color-coded values)</reason>
      </artifact>
    </code>

    <dependencies>
      <node>
        <package name="@supabase/supabase-js" version="^2.84.0" usage="Query work_orders, wo_operations, wo_materials for yield calculations" />
        <package name="zod" version="^3.25.76" usage="Validation schemas for yield API response" />
        <package name="lucide-react" version="^0.x" usage="Icons for yield indicators (CheckCircle, AlertCircle, XCircle)" />
      </node>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="architecture">Analytics Pattern - Read-only endpoint (GET /api/production/work-orders/:id/yield), no mutations. Calculations server-side for consistency</constraint>
    <constraint type="business">Output Yield - Calculated as (actual_output_qty / wo.quantity) Ã— 100%. If wo.quantity = 0, display "N/A"</constraint>
    <constraint type="business">Material Yield - Calculated as (wo_materials.required_qty / wo_materials.consumed_qty) Ã— 100%. If consumed_qty = 0, yield = 0% (not N/A)</constraint>
    <constraint type="business">Operation Yield - Read directly from wo_operations.actual_yield_percent (recorded by Story 4.5). Default 0% if not recorded</constraint>
    <constraint type="business">Color Coding - Green: >= 95%, Yellow: 80-95%, Red: &lt; 80%. Consistent with dashboard KPI color thresholds (Story 4.1)</constraint>
    <constraint type="business">Dashboard Integration - Yield metrics appear on production dashboard (Story 4.1) as Avg Yield KPI and in alerts panel if yield &lt; 80%</constraint>
    <constraint type="business">Variance Analysis - Track variance between target yield (default 95%) and actual yield. Display as "+2.5%" (above) or "-4.8%" (below)</constraint>
    <constraint type="business">Prerequisites - Requires Stories 4.5 (operation completion with actual_yield_percent) and 4.12 (output completion with produced_quantity)</constraint>
    <constraint type="testing">Test pyramid - 95% unit (yield calculations, edge cases: 0 qty, null values, division by zero), 70% integration (API endpoint, org isolation), 100% E2E (full workflow: view WO detail â†’ see yield metrics â†’ verify color coding)</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>GET /api/production/work-orders/:id/yield</name>
      <kind>API route</kind>
      <signature>
        GET /api/production/work-orders/:id/yield
        Response 200: {
          output_yield: number | null,    // 87.5 or null if wo.quantity = 0
          material_yield: number,          // 92.3 (0 if consumed_qty = 0)
          operation_yields: [
            {
              operation_id: uuid,
              name: string,                 // "Cut"
              sequence: number,             // 1
              actual_yield: number,         // 98.0
              expected_yield: number,       // 95.0
              variance: number,             // +3.0
              status: string,               // "completed"
              color: string                 // "green" | "yellow" | "red"
            }
          ]
        }
        Error Response 404/403: {
          error: string,                    // "NOT_FOUND" | "ORG_ISOLATION" | "FORBIDDEN"
          message: string
        }
      </signature>
      <path>apps/frontend/app/api/production/work-orders/[id]/yield/route.ts</path>
    </interface>
    <interface>
      <name>calculateYieldMetrics</name>
      <kind>service method</kind>
      <signature>
        async function calculateYieldMetrics(
          woId: string,
          orgId: string
        ): Promise&lt;YieldMetrics&gt;
        - Queries: work_orders (planned_quantity, produced_quantity)
        - Queries: wo_materials (required_qty, consumed_qty) - aggregate for Material Yield
        - Queries: wo_operations (actual_yield_percent, expected_yield_percent) - per operation
        - Calculates: Output Yield = (produced_quantity / planned_quantity) Ã— 100 (null if planned = 0)
        - Calculates: Material Yield = (SUM(required_qty) / SUM(consumed_qty)) Ã— 100 (0 if consumed = 0)
        - Reads: Operation Yields directly from actual_yield_percent (default 0 if null)
        - Calculates: Variance = actual - expected for each metric
        - Assigns: Color coding (green/yellow/red) based on thresholds (>=95, 80-95, &lt;80)
        - Returns: YieldMetrics object
        - Throws: Error with code NOT_FOUND, ORG_ISOLATION, FORBIDDEN
      </signature>
      <path>apps/frontend/lib/services/yield-tracking-service.ts</path>
    </interface>
    <interface>
      <name>YieldSummary</name>
      <kind>React component</kind>
      <signature>
        interface YieldSummaryProps {
          woId: string
        }
        - Fetches: GET /api/production/work-orders/:id/yield
        - Displays: 3 sections (Output Yield, Material Yield, Operation Yields)
        - Output Yield: Value + color badge + variance vs target (default 95%)
        - Material Yield: Value + color badge + variance vs target
        - Operation Yields: Table with columns (Seq, Operation, Actual%, Expected%, Variance, Status)
        - Color Coding: Green (>=95%), Yellow (80-95%), Red (&lt;80%) - consistent with dashboard
        - Edge Cases: Output Yield shows "N/A" if planned_qty = 0, Material Yield shows "0%" if consumed_qty = 0
        - Loading State: Skeleton for 3 sections
        - Error State: "Failed to load yield metrics" with retry button
      </signature>
      <path>apps/frontend/components/production/YieldSummary.tsx</path>
    </interface>
  </interfaces>

  <tests>
    <standards>Test Pyramid: unit tests (95%), integration tests (70%), E2E tests (100% critical paths)</standards>
    <locations>
      <location>apps/frontend/lib/services/__tests__/yield-tracking-service.test.ts</location>
      <location>apps/frontend/app/api/production/work-orders/[id]/yield/__tests__/route.test.ts</location>
      <location>tests/e2e/production-yield-tracking.spec.ts</location>
    </locations>
    <ideas>
      <idea ac="AC-4.15.3">Unit test: calculateYieldMetrics() - Output Yield calculation (100 planned, 87.5 produced â†’ 87.5% yield)</idea>
      <idea ac="AC-4.15.3">Unit test: calculateYieldMetrics() - Output Yield with 0 planned_qty â†’ returns null (N/A)</idea>
      <idea ac="AC-4.15.3">Unit test: calculateYieldMetrics() - Material Yield calculation (100 required, 92.3 consumed â†’ 108.3% yield)</idea>
      <idea ac="AC-4.15.3">Unit test: calculateYieldMetrics() - Material Yield with 0 consumed_qty â†’ returns 0%</idea>
      <idea ac="AC-4.15.3">Unit test: calculateYieldMetrics() - Operation Yield reads actual_yield_percent (98% recorded â†’ 98% displayed)</idea>
      <idea ac="AC-4.15.3">Unit test: calculateYieldMetrics() - Operation Yield with null actual_yield_percent â†’ defaults to 0%</idea>
      <idea ac="AC-4.15.2">Unit test: Color coding logic - yield 96% â†’ green, 85% â†’ yellow, 75% â†’ red</idea>
      <idea ac="AC-4.15.7">Unit test: Variance calculation - actual 87.5%, target 95% â†’ variance -7.5%</idea>
      <idea ac="AC-4.15.4">Integration test: GET /api/production/work-orders/:id/yield (200) - returns output_yield, material_yield, operation_yields with correct structure</idea>
      <idea ac="AC-4.15.4">Integration test: GET /api/production/work-orders/:id/yield with non-existent WO - returns 404</idea>
      <idea ac="AC-4.15.4">Integration test: GET /api/production/work-orders/:id/yield with wrong org_id - returns 403 (org isolation)</idea>
      <idea ac="AC-4.15.5">Integration test: Dashboard KPI integration - verify Avg Yield KPI updates when WO yield changes</idea>
      <idea ac="AC-4.15.6">Integration test: Dashboard alert for low yield - yield &lt; 80% triggers warning indicator</idea>
      <idea ac="ALL">E2E test: Full workflow - create WO with 2 operations, complete operation 1 with yield 92%, complete operation 2 with yield 78%, complete WO output with 85 units (planned 100), navigate to WO detail, verify yield summary shows: Output Yield 85% (yellow), Material Yield calculated, Op1 92% (green), Op2 78% (red)</idea>
      <idea ac="AC-4.15.1, AC-4.15.2">E2E test: Yield display - verify color coding (green/yellow/red) matches thresholds, verify variance displayed correctly</idea>
      <idea ac="AC-4.15.5">E2E test: Dashboard integration - verify Avg Yield KPI on dashboard shows aggregate yield, verify low yield warning appears in alerts panel</idea>
    </ideas>
  </tests>

  <learnings>
    <learning from="Story 4.5 (Operation Complete)">actual_yield_percent recorded per operation when completing. Story 4.15 reads these values for Operation Yield display. Default 0% if operation not completed or yield not recorded</learning>
    <learning from="Story 4.12 (Output Completion)">produced_quantity (actual output) recorded when completing WO output. Story 4.15 uses this for Output Yield calculation vs planned_quantity</learning>
    <learning from="Story 4.1 (Production Dashboard)">Dashboard KPI color thresholds: Green >=95%, Yellow 80-95%, Red &lt;80%. Story 4.15 uses same thresholds for consistency. Avg Yield KPI aggregates all WO yields</learning>
    <learning from="Stories 4.7-4.9 (Consumption)">consumed_qty tracked in wo_materials via wo_consumption records. Story 4.15 aggregates consumed_qty for Material Yield calculation</learning>
    <learning from="Shared UI Design System">Stats Cards 120px height, 2Ã—2 grid. Color palette: green-600 (success), yellow-600 (warning), red-600 (error). Consistent across all modules</learning>
  </learnings>

  <ux-design>
    <section name="Yield Summary Layout (WO Detail Page)">
      <content>
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ WO-001 Detail - Yield Summary                [Refresh]   â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
        â”‚ â”‚ Output Yield     â”‚ â”‚ Material Yield   â”‚                â”‚
        â”‚ â”‚ 87.5%  ğŸŸ¡       â”‚ â”‚ 92.3%  ğŸŸ¢       â”‚                â”‚
        â”‚ â”‚ Target: 95%      â”‚ â”‚ Target: 95%      â”‚                â”‚
        â”‚ â”‚ Variance: -7.5%  â”‚ â”‚ Variance: -2.7%  â”‚                â”‚
        â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
        â”‚                                                          â”‚
        â”‚ Operation Yields                                         â”‚
        â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
        â”‚ â”‚ Seq â”‚ Operation â”‚ Actual â”‚ Target â”‚ Variance â”‚ ğŸ¨ â”‚  â”‚
        â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
        â”‚ â”‚ 1   â”‚ Cut       â”‚ 98.0%  â”‚ 95.0%  â”‚ +3.0%    â”‚ ğŸŸ¢ â”‚  â”‚
        â”‚ â”‚ 2   â”‚ Mix       â”‚ 85.0%  â”‚ 95.0%  â”‚ -10.0%   â”‚ ğŸŸ¡ â”‚  â”‚
        â”‚ â”‚ 3   â”‚ Pack      â”‚ 78.0%  â”‚ 95.0%  â”‚ -17.0%   â”‚ ğŸ”´ â”‚  â”‚
        â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
        â”‚                                                          â”‚
        â”‚ âš ï¸ Low Yield Alert: Op3 Pack (78% &lt; 80% threshold)    â”‚
        â”‚    Impact: -22 units output lost                        â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

        Color Coding:
        - ğŸŸ¢ Green: >= 95% (green-200 bg + green-800 text)
        - ğŸŸ¡ Yellow: 80-95% (yellow-200 bg + yellow-800 text)
        - ğŸ”´ Red: &lt; 80% (red-200 bg + red-800 text)

        Typography (Shared System):
        - Section title: Text-xl (20px), SemiBold (600)
        - Yield values: Text-3xl (30px), Bold (700)
        - Labels: Text-sm (14px), Medium (500)
        - Variance: Text-base (16px), Regular (400)
        - Table headers: Text-sm (14px), SemiBold (600)
        - Table data: Text-base (16px), Regular (400)

        Spacing:
        - Card padding: p-4 (16px)
        - Section gap: gap-6 (24px)
        - Grid gap: gap-4 (16px between Output/Material cards)
      </content>
    </section>
    <section name="Dashboard Integration (Story 4.1)">
      <content>
        Production Dashboard - KPI Cards Row:
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Orders     â”‚ â”‚ Units      â”‚ â”‚ Avg Yield  â”‚ â”‚ Active WOs â”‚ â”‚ Shortages  â”‚
        â”‚ Today      â”‚ â”‚ Produced   â”‚ â”‚            â”‚ â”‚            â”‚ â”‚            â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚ Total: 12  â”‚ â”‚ Total:     â”‚ â”‚ Overall:   â”‚ â”‚ Total: 5   â”‚ â”‚ Total: 2   â”‚
        â”‚ Complete:8 â”‚ â”‚ 2,450 kg   â”‚ â”‚ 88.7% ğŸŸ¡  â”‚ â”‚ Active: 3  â”‚ â”‚ Critical:1 â”‚
        â”‚ Active: 4  â”‚ â”‚ Target:    â”‚ â”‚ Target:95% â”‚ â”‚ Paused: 2  â”‚ â”‚ Warning:1  â”‚
        â”‚            â”‚ â”‚ 2,600 kg   â”‚ â”‚ Var: -6.3% â”‚ â”‚            â”‚ â”‚            â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

        Alerts Panel:
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ âš ï¸ Active Alerts                                   â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚ ğŸ”´ Low Yield - WO-001 Op3 Pack (78% &lt; 80%)       â”‚
        â”‚    Impact: -22 units output lost                  â”‚
        â”‚ ğŸŸ¡ Material Shortage - WO-002 (Sugar: 50kg short) â”‚
        â”‚ ğŸŸ¡ WO Delayed - WO-003 (4.5h overdue)             â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

        Story 4.15 provides:
        - Per-WO yield metrics for Avg Yield KPI aggregation
        - Low yield alerts (&lt;80%) for Alerts Panel
        - Variance tracking for performance analysis
      </content>
    </section>
    <section name="Yield Calculation Logic">
      <content>
        Output Yield Calculation:
        ```typescript
        // Server-side calculation
        const output_yield = wo.planned_quantity > 0
          ? (wo.produced_quantity / wo.planned_quantity) * 100
          : null  // N/A if planned = 0

        // Display logic
        const displayValue = output_yield !== null
          ? `${output_yield.toFixed(1)}%`
          : 'N/A'
        ```

        Material Yield Calculation:
        ```typescript
        // Aggregate from wo_materials
        const total_required = wo_materials.reduce((sum, m) => sum + m.required_qty, 0)
        const total_consumed = wo_materials.reduce((sum, m) => sum + m.consumed_qty, 0)

        const material_yield = total_consumed > 0
          ? (total_required / total_consumed) * 100
          : 0  // 0% if nothing consumed (not N/A)

        // Note: Material Yield > 100% possible if under-consumption occurred
        ```

        Operation Yield Calculation:
        ```typescript
        // Read directly from wo_operations (recorded by Story 4.5)
        const operation_yields = wo_operations.map(op => ({
          operation_id: op.id,
          name: op.operation_name,
          sequence: op.sequence_number,
          actual_yield: op.actual_yield_percent ?? 0,  // Default 0 if null
          expected_yield: op.expected_yield_percent ?? 95,
          variance: (op.actual_yield_percent ?? 0) - (op.expected_yield_percent ?? 95),
          status: op.status,
          color: getYieldColor(op.actual_yield_percent ?? 0)
        }))

        function getYieldColor(yield: number): string {
          if (yield >= 95) return 'green'
          if (yield >= 80) return 'yellow'
          return 'red'
        }
        ```

        Variance Analysis:
        ```typescript
        // Variance = Actual - Target
        const target_yield = 95  // Default, could be configurable
        const variance = actual_yield - target_yield

        // Display with sign
        const varianceDisplay = variance >= 0
          ? `+${variance.toFixed(1)}%`
          : `${variance.toFixed(1)}%`

        // Color coding
        const varianceColor = variance >= 0 ? 'green' : 'red'
        ```
      </content>
    </section>
    <section name="Edge Cases &amp; Error Handling">
      <content>
        Edge Case 1: Planned Quantity = 0 (Output Yield)
        - Calculation: N/A (cannot divide by zero)
        - Display: "N/A" (not 0%, not error)
        - Color: Gray (neutral, no color coding)

        Edge Case 2: Consumed Quantity = 0 (Material Yield)
        - Calculation: 0% (nothing consumed yet)
        - Display: "0.0%" (not N/A)
        - Color: Red (indicates issue - no consumption recorded)

        Edge Case 3: Operation Not Completed (actual_yield_percent = null)
        - Calculation: Default to 0%
        - Display: "0.0%" with status badge "Not Started" or "In Progress"
        - Color: Gray (neutral, operation not yet completed)

        Edge Case 4: Material Yield > 100%
        - Calculation: Valid (under-consumption occurred)
        - Display: e.g., "108.3%" (show actual value)
        - Color: Green if > 100% (efficiency gain)

        Edge Case 5: WO Not Found or Wrong Org
        - API Response: 404 NOT_FOUND or 403 ORG_ISOLATION
        - Display: Error message "Work order not found" or "Access denied"
        - Retry: Show retry button

        Loading State:
        - Skeleton: 2 cards (Output/Material) + table (3 rows)
        - Duration: Until API response received
        - No data flash (use suspense boundary)

        Empty State:
        - If WO has no operations: Show only Output and Material Yield
        - If WO has no materials: Material Yield shows "N/A"
        - If WO draft status: Show message "Yield metrics available after WO starts"
      </content>
    </section>
  </ux-design>
</story-context>
