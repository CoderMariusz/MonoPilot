<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>1.8</storyId>
    <title>Production Line Configuration</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-11-20</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/1-8-production-line-configuration.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>Admin</asA>
    <iWant>define production lines</iWant>
    <soThat>I can organize production by line</soThat>
    <tasks>
      - Task 1: Database Schema - Production Lines Table (with RLS, warehouse FK, default output location)
      - Task 2: Production Line Service - Core Logic (create, update, get, delete with validation)
      - Task 3: Zod Validation Schemas (CreateLineSchema with output location validation)
      - Task 4: API Endpoints (GET, POST, PUT, DELETE for /api/settings/lines)
      - Task 5: Frontend Production Lines List Page (/settings/production → Lines tab)
      - Task 6: Line Form Modal (with warehouse, output location, machine assignments)
      - Task 7: Line Detail Page (with warehouse, machines, output location links)
      - Task 8: Machine Assignment Sync (bidirectional with Story 1.7)
      - Task 9: Cache Invalidation & Events (line.updated for Epic 3, 4)
      - Task 10: Integration & Testing (Unit, Integration, E2E tests)
      - Task 11: Output Location Validation (warehouse match enforcement)
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC-007.1">
      <title>Admin może stworzyć production line</title>
      <details>
        - Navigate to /settings/production → "Lines" tab
        - Form fields: code (required, unique per org), name (required, max 100 chars), warehouse_id (required dropdown), default_output_location_id (optional dropdown, filtered by selected warehouse), machine_ids (multi-select dropdown, optional)
        - Validation: code unique per org, output location must belong to selected warehouse
        - On save: line created, machine assignments saved in machine_line_assignments table
      </details>
    </criterion>

    <criterion id="AC-007.2">
      <title>default_output_location_id purpose</title>
      <details>
        - Where WO production output goes by default (Epic 4)
        - Must be location within the line's warehouse
        - Optional (can select output location per WO)
        - Type suggestion: location type = 'production' or 'storage'
      </details>
    </criterion>

    <criterion id="AC-007.3">
      <title>Line-machine many-to-many assignment</title>
      <details>
        - Line can have multiple machines (e.g., Line 1: mixer, filler, capper)
        - Machine can be assigned to multiple lines (shared resources)
        - Assignment table: machine_line_assignments (same as Story 1.7)
        - Can assign from line side (this story) or machine side (Story 1.7)
      </details>
    </criterion>

    <criterion id="AC-007.4">
      <title>Lines list view</title>
      <details>
        - Table columns: Code, Name, Warehouse, Machines (count), Output Location, Actions
        - Machines column: count + comma-separated names or "No machines"
        - Output Location column: location code or "Not set"
        - Search by code or name
        - Filter by warehouse
        - Sort by code, name, warehouse, created_at
      </details>
    </criterion>

    <criterion id="AC-007.5">
      <title>Cannot delete line with constraints</title>
      <details>
        - FK constraint ON DELETE RESTRICT prevents deletion if line has active WOs (Epic 3, 4)
        - Error message: "Cannot delete line - it has X active WOs. Archive it instead."
        - Archive option: add is_deleted flag or soft delete
      </details>
    </criterion>

    <criterion id="AC-007.6">
      <title>Edit line</title>
      <details>
        - Click Edit action → drawer opens with form
        - All fields editable (code, name, warehouse, output location, machine assignments)
        - Warehouse change: warn if has WOs, requires output location update
        - Machine assignments: multi-select dropdown
        - On save: line updated, assignments updated
      </details>
    </criterion>

    <criterion id="AC-007.7">
      <title>Line detail page</title>
      <details>
        - Navigate to /settings/lines/:id
        - Display: code, name, warehouse (link), output location (link), assigned machines (links)
        - Actions: Edit, View WOs (Epic 3 link)
        - Related entities: Active WOs on this line, historical throughput stats
      </details>
    </criterion>

    <criterion id="AC-007.8">
      <title>Cache invalidation events</title>
      <details>
        - On line create/update/delete: emit 'line.updated' event
        - Epic 3, 4 refetch line list on event
        - Redis cache TTL: 5 min
        - Cache key: `lines:{org_id}`
      </details>
    </criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-1.md</path>
        <title>Technical Specification - Epic 1 (Foundation & Settings)</title>
        <section>FR-SET-007: Production Line Configuration</section>
        <snippet>Production line configuration with warehouse assignment, default output location, and bidirectional machine assignments.</snippet>
      </doc>

      <doc>
        <path>docs/epics/epic-1-settings.md</path>
        <title>Epic 1: Foundation & Settings</title>
        <section>Story 1.8: Production Line Configuration</section>
        <snippet>Production line definition with warehouse relationship and default output location for WO execution.</snippet>
      </doc>
    </docs>

    <code>
      <artifact>
        <path>app/lib/supabase/server.ts</path>
        <kind>lib</kind>
        <symbol>createClient</symbol>
        <lines>all</lines>
        <reason>Supabase server client for database operations and realtime events</reason>
      </artifact>

      <artifact>
        <path>app/lib/types.ts</path>
        <kind>types</kind>
        <symbol>Database types</symbol>
        <lines>all</lines>
        <reason>TypeScript types for database tables - will be updated after production_lines table migration</reason>
      </artifact>

      <artifact>
        <path>packages/shared/schemas.ts</path>
        <kind>schemas</kind>
        <symbol>Zod schemas</symbol>
        <lines>all</lines>
        <reason>Shared validation schemas - add CreateLineSchema and UpdateLineSchema</reason>
      </artifact>

      <artifact>
        <path>packages/shared/types.ts</path>
        <kind>types</kind>
        <symbol>Shared types</symbol>
        <lines>all</lines>
        <reason>Shared TypeScript types - add ProductionLine interface</reason>
      </artifact>
    </code>

    <dependencies>
      <ecosystem name="node">
        <package name="@supabase/supabase-js" version="latest">Supabase client for database and realtime</package>
        <package name="zod" version="latest">Schema validation (CreateLineSchema, UpdateLineSchema)</package>
        <package name="react-hook-form" version="latest">Form state management</package>
        <package name="swr" version="latest">Data fetching and caching</package>
        <package name="ioredis" version="latest">Redis client for caching</package>
      </ecosystem>

      <ecosystem name="shadcn">
        <component name="table">Production lines table component</component>
        <component name="dialog">Line form modal, confirmation dialogs</component>
        <component name="drawer">Edit line drawer</component>
        <component name="badge">Status badges, count badges</component>
        <component name="toast">Success/error notifications</component>
        <component name="select">Warehouse, location, machine dropdowns</component>
        <component name="input">Form fields</component>
      </ecosystem>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="architecture">
      <rule>Multi-tenancy: RLS policy on production_lines table (org_id isolation)</rule>
      <rule>Line-Warehouse Relationship: Each line belongs to one warehouse</rule>
      <rule>Default Output Location: Must be within line's warehouse, optional field</rule>
      <rule>Many-to-Many Machines: Same machine_line_assignments table as Story 1.7 (bidirectional)</rule>
      <rule>Cache Invalidation: Events emitted on mutations, consumed by Epic 3, 4</rule>
      <rule>FK Constraints: ON DELETE RESTRICT prevents deletion if line has WOs</rule>
    </constraint>

    <constraint type="security">
      <rule>RLS Policy REQUIRED: org_id = (auth.jwt() ->> 'org_id')::uuid on production_lines table</rule>
      <rule>Admin Only: Only Admin role can create/edit/delete production lines</rule>
      <rule>Cross-Org Isolation: Users cannot access lines from other organizations</rule>
      <rule>Audit Trail: created_by, updated_by tracked on all mutations</rule>
    </constraint>

    <constraint type="data">
      <rule>Unique Constraint: (org_id, code) - line code unique per organization</rule>
      <rule>Indexes REQUIRED: org_id, warehouse_id for query performance</rule>
      <rule>FK Constraint: warehouse_id → warehouses (ON DELETE RESTRICT)</rule>
      <rule>FK Constraint: default_output_location_id → locations (nullable, ON DELETE SET NULL)</rule>
      <rule>Output Location Validation: output location warehouse_id must match line warehouse_id (app logic or trigger)</rule>
    </constraint>

    <constraint type="performance">
      <rule>Line list load (100 lines): &lt;200ms p95</rule>
      <rule>Create line: &lt;300ms</rule>
      <rule>Update line: &lt;250ms</rule>
      <rule>Cache hit rate: &gt;80%</rule>
    </constraint>

    <constraint type="testing">
      <rule>RLS Testing: MUST add to RLS test suite (Sprint 0 Gap 4)</rule>
      <rule>Integration Tests: MUST verify output location validation, machine assignment sync</rule>
      <rule>E2E Tests: MUST test line creation, warehouse change warnings</rule>
    </constraint>
  </constraints>

  <interfaces>
    <interface name="GET /api/settings/lines">
      <kind>REST endpoint</kind>
      <signature>
        Query: { warehouse_id?, search? }
        Response: ProductionLine[] (with warehouse, location, machine names)
        Auth: Authenticated user
        Cache: 5 min TTL (Redis)
      </signature>
      <path>app/api/settings/lines/route.ts (NEW)</path>
    </interface>

    <interface name="POST /api/settings/lines">
      <kind>REST endpoint</kind>
      <signature>
        Body: CreateLineInput { code, name, warehouse_id, default_output_location_id?, machine_ids? }
        Response: ProductionLine
        Auth: Admin only
        Validation: Code unique, output location belongs to warehouse
        Side effects: Insert line, insert machine assignments, emit line.created event
      </signature>
      <path>app/api/settings/lines/route.ts (NEW)</path>
    </interface>

    <interface name="PUT /api/settings/lines/:id">
      <kind>REST endpoint</kind>
      <signature>
        Params: { id: UUID }
        Body: UpdateLineInput { code?, name?, warehouse_id?, default_output_location_id?, machine_ids? }
        Response: ProductionLine
        Auth: Admin only
        Validation: Warehouse change warnings if has WOs, output location validation
        Side effects: Update line, update machine assignments, emit line.updated event
      </signature>
      <path>app/api/settings/lines/[id]/route.ts (NEW)</path>
    </interface>

    <interface name="ProductionLineService.createLine">
      <kind>Service method</kind>
      <signature>
        async createLine(input: CreateLineInput): Promise&lt;ProductionLine&gt;
        Validation: Code unique per org, output location belongs to warehouse
        Side effects: Insert line, insert machine assignments (if machine_ids provided), emit cache event
      </signature>
      <path>lib/services/ProductionLineService.ts (NEW)</path>
    </interface>

    <interface name="ProductionLineService.updateLine">
      <kind>Service method</kind>
      <signature>
        async updateLine(id: string, input: UpdateLineInput): Promise&lt;ProductionLine&gt;
        Validation: Line exists + belongs to org, output location belongs to warehouse, warehouse change warnings
        Side effects: Update line, update machine assignments (delete old, insert new), emit cache event
      </signature>
      <path>lib/services/ProductionLineService.ts (NEW)</path>
    </interface>

    <interface name="CreateLineSchema">
      <kind>Zod schema</kind>
      <signature>
        z.object({
          code: z.string().regex(/^[A-Z0-9-]+$/).min(2).max(50),
          name: z.string().min(1).max(100),
          warehouse_id: z.string().uuid(),
          default_output_location_id: z.string().uuid().optional(),
          machine_ids: z.array(z.string().uuid()).optional()
        })
        Custom refinement: output location must belong to warehouse
      </signature>
      <path>packages/shared/schemas.ts</path>
    </interface>

    <interface name="Cache Event: line.updated">
      <kind>Event emitter</kind>
      <signature>
        Event: 'line.created' | 'line.updated' | 'line.deleted'
        Payload: { type: string, org_id: string, line_id: string, timestamp: Date }
        Consumers: Epic 3 (WO creation), Epic 4 (WO execution)
        Action: Invalidate Redis cache key `lines:{org_id}`, refetch line list
      </signature>
      <path>Server: ProductionLineService, Consumers: Epic 3/4 services</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Testing stack: Vitest for unit/integration tests, Playwright for E2E tests.
      Unit tests in same directory as source files (*.test.ts).
      Integration tests in tests/integration/.
      E2E tests in tests/e2e/ using Playwright.
      RLS tests MUST be added to tests/integration/rls/ suite (Sprint 0 Gap 4).
    </standards>

    <locations>
      - lib/services/ProductionLineService.test.ts (Line CRUD, validation logic)
      - packages/shared/schemas.test.ts (Zod schema validation tests)
      - app/api/settings/lines/**/*.test.ts (API endpoint tests)
      - tests/integration/lines/ (Integration tests: output location validation, machine sync)
      - tests/integration/rls/lines-rls.test.ts (RLS policy tests)
      - tests/e2e/settings/lines.spec.ts (E2E line management flow)
    </locations>

    <ideas>
      <test id="AC-007.1" type="integration">
        - POST /api/settings/lines → line created with machine assignments
        - Verify output location belongs to warehouse validation
        - RLS: User A (Org 1) creates line → User B (Org 2) cannot see it
      </test>

      <test id="AC-007.2" type="integration">
        - Create line with output location from different warehouse → validation error
        - Output location type suggestion: 'production' or 'storage'
      </test>

      <test id="AC-007.3" type="integration">
        - Assign line to multiple machines → assignments saved
        - Bidirectional sync: assign from line side matches machine side (Story 1.7)
      </test>

      <test id="AC-007.5" type="integration">
        - DELETE line with active WOs → FK constraint error
      </test>

      <test id="AC-007.6" type="integration">
        - PUT /api/settings/lines/:id → warehouse changed, warn if has WOs
        - Update machine assignments → old deleted, new inserted
      </test>

      <test id="all" type="e2e">
        - E2E: Create line → appears in list with warehouse and machines
        - E2E: Edit line → change warehouse → warning shown if has WOs
        - E2E: Filter lines by warehouse → correct results
        - E2E: Cannot delete line with WOs → error shown
      </test>
    </ideas>
  </tests>
</story-context>
