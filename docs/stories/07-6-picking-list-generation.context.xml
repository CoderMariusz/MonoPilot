<story-context id="7-6-picking-list-generation" v="1.0">
  <metadata>
    <epicId>7</epicId>
    <storyId>6</storyId>
    <title>Picking List Generation</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-11-24</generatedAt>
    <template>Custom</template>
    <estimatedTokens>5000</estimatedTokens>
    <estimatedEffort>1.5 days</estimatedEffort>
  </metadata>

  <story>
    <asA>Warehouse user</asA>
    <iWant>to generate pick lists from sales orders</iWant>
    <soThat>pickers know what to collect</soThat>
    <tasks>
      <task id="1" ac="AC-7.6.1">Pick Lists Table Schema - pick_lists table with so_id, status, assigned_to, generated_at</task>
      <task id="2" ac="AC-7.6.2">Pick List Items Table - pick_list_items table with product_id, qty_to_pick, suggested_lp_id, location_id</task>
      <task id="3" ac="AC-7.6.3">LP Suggestion Algorithm - Implement FIFO/FEFO picking strategy to suggest LPs for picking</task>
      <task id="4" ac="AC-7.6.4">Pick List Generation Service - generatePickList() with LP suggestions and location sorting</task>
      <task id="5" ac="AC-7.6.5">API Route - POST /api/shipping/pick-lists endpoint</task>
      <task id="6" ac="AC-7.6.6">Pick List UI - Display pick list with product, qty, suggested LP, location, picker assignment</task>
      <task id="7" ac="AC-7.6.7">QA Status Filter - Only suggest LPs with qa_status = 'passed'</task>
      <task id="8" ac="ALL">Unit & Integration Tests - Pick list generation tests, LP suggestion tests, FIFO/FEFO tests</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC-7.6.1">Given SO or shipment with status confirmed, When clicking "Generate Pick List", Then pick list created showing: Product, qty, location, suggested LPs (by FIFO/FEFO), picker assignment (optional)</criterion>
    <criterion id="AC-7.6.2">LP suggestion strategy: When picking_strategy = FIFO, Then LPs sorted by created_at ASC; When picking_strategy = FEFO, Then LPs sorted by expiry_date ASC; Only passed LPs suggested (qa_status = 'passed'); Sufficient qty for order</criterion>
    <criterion id="AC-7.6.3">Pick list items include: product_id, qty_to_pick, suggested_lp_id, location_id, picked_qty (default: 0), status (pending/picked/short)</criterion>
    <criterion id="AC-7.6.4">API: POST /api/shipping/pick-lists - Request body: { so_id: string, assigned_to?: string } - Response: { data: PickList with items[] } with status 201</criterion>
    <criterion id="AC-7.6.5">Service validates: SO exists and status = confirmed, SO has lines, sufficient inventory available for all lines</criterion>
    <criterion id="AC-7.6.6">Pick list can be printed or viewed on scanner with location-optimized sorting for efficient picking</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/epics/epic-7-shipping.md</path>
        <title>Epic 7: Shipping & Order Fulfillment</title>
        <section>Story 7.9: Generate Pick Lists</section>
        <snippet>Generate pick lists from SOs/shipments. pick_lists table. Suggested LPs by FIFO/FEFO. Picker assignment optional. Can print or view on scanner. Prerequisites: Story 7.5.</snippet>
      </doc>
      <doc>
        <path>docs/epics/epic-7-shipping.md</path>
        <title>Epic 7: Shipping & Order Fulfillment</title>
        <section>Story 7.10: LP Picking Strategy (FIFO/FEFO)</section>
        <snippet>Suggest LPs based on picking strategy. FIFO: sort by created_at ASC. FEFO: sort by expiry_date ASC. Only passed LPs. Configurable in shipping_settings.picking_strategy.</snippet>
      </doc>
    </docs>

    <code>
      <artifact>
        <path>app/api/shipping/pick-lists</path>
        <kind>directory</kind>
        <symbol>Pick Lists API route location</symbol>
        <reason>Story requires creating route.ts for POST /api/shipping/pick-lists endpoint</reason>
      </artifact>
      <artifact>
        <path>lib/services/pick-list-service.ts</path>
        <kind>file</kind>
        <symbol>Pick List service layer</symbol>
        <reason>Story requires generatePickList() method with LP suggestion algorithm and location sorting</reason>
      </artifact>
      <artifact>
        <path>lib/utils/suggest-lps-for-picking.ts</path>
        <kind>utility</kind>
        <symbol>LP suggestion algorithm</symbol>
        <reason>Story requires suggestLPsForPicking() function implementing FIFO/FEFO strategy with qa_status filtering</reason>
      </artifact>
      <artifact>
        <path>lib/validation/pick-list-schemas.ts</path>
        <kind>file</kind>
        <symbol>Pick List Zod schemas</symbol>
        <reason>Story requires generatePickListSchema for validating pick list generation input</reason>
      </artifact>
      <artifact>
        <path>components/shipping/PickListView.tsx</path>
        <kind>component</kind>
        <symbol>PickListView</symbol>
        <reason>Story requires component displaying pick list with product, qty, suggested LP, location, picker</reason>
      </artifact>
      <artifact>
        <path>app/shipping/pick-lists/[id]/page.tsx</path>
        <kind>page</kind>
        <symbol>Pick List Detail page</symbol>
        <reason>Story requires page for viewing pick list details</reason>
      </artifact>
    </code>

    <dependencies>
      <node>
        <package name="@supabase/supabase-js" version="^2.84.0" usage="Supabase client for pick list generation and LP queries" />
        <package name="zod" version="^3.25.76" usage="Validation schemas for pick list generation input" />
        <package name="next" version="^15.1.4" usage="Next.js framework with App Router for API routes and pages" />
      </node>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="business">LP suggestion strategy - FIFO (created_at ASC) or FEFO (expiry_date ASC), configurable in shipping_settings</constraint>
    <constraint type="business">QA status filter - ONLY suggest LPs with qa_status = 'passed'</constraint>
    <constraint type="business">Sufficient inventory - validate sufficient qty available before generating pick list</constraint>
    <constraint type="business">Location sorting - sort pick list items by location for efficient picking route</constraint>
    <constraint type="business">Multi-tenancy - all pick list operations scoped by org_id</constraint>
    <constraint type="validation">SO status validation - SO must have status = 'confirmed' before pick list generation</constraint>
    <constraint type="testing">Test pyramid - 95% unit coverage for pick list service and LP suggestion, 70% integration coverage, 100% E2E coverage</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>POST /api/shipping/pick-lists</name>
      <kind>API route</kind>
      <signature>POST /api/shipping/pick-lists - Request body: { so_id: string, assigned_to?: string } - Response: { data: PickList with items[] } or error 400</signature>
      <path>app/api/shipping/pick-lists/route.ts</path>
    </interface>
    <interface>
      <name>GET /api/shipping/pick-lists</name>
      <kind>API route</kind>
      <signature>GET /api/shipping/pick-lists?status=pending&assigned_to=user123 - Response: { data: PickList[] } - Supports filtering by status, assigned_to</signature>
      <path>app/api/shipping/pick-lists/route.ts</path>
    </interface>
    <interface>
      <name>generatePickList</name>
      <kind>service function</kind>
      <signature>async function generatePickList(input: GeneratePickListInput): Promise&lt;ServiceResult&lt;PickList&gt;&gt; - Validates SO, suggests LPs by FIFO/FEFO, creates pick list with items</signature>
      <path>lib/services/pick-list-service.ts</path>
    </interface>
    <interface>
      <name>suggestLPsForPicking</name>
      <kind>utility function</kind>
      <signature>async function suggestLPsForPicking(productId: string, qtyNeeded: number, strategy: 'FIFO'|'FEFO', orgId: string): Promise&lt;LPSuggestion[]&gt; - Returns suggested LPs with qa_status='passed', sorted by strategy</signature>
      <path>lib/utils/suggest-lps-for-picking.ts</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Testing strategy follows Test Pyramid: unit tests for pick list service and LP suggestion (95% coverage), integration tests for API route (70% coverage), E2E tests for pick list generation flow (100% user flows). Mock Supabase in unit tests.
    </standards>
    <locations>
      <location>lib/services/__tests__/pick-list-service.test.ts (Pick list generation unit tests)</location>
      <location>lib/utils/__tests__/suggest-lps-for-picking.test.ts (LP suggestion algorithm unit tests)</location>
      <location>app/api/shipping/pick-lists/__tests__/route.test.ts (API route integration tests)</location>
      <location>e2e/shipping/pick-list-generation.e2e.ts (Pick list generation E2E tests)</location>
    </locations>
    <ideas>
      <idea ac="AC-7.6.5">Unit test: generatePickList() with SO status != confirmed - returns error "SO must be confirmed"</idea>
      <idea ac="AC-7.6.5">Unit test: generatePickList() with insufficient inventory - returns error "Insufficient inventory"</idea>
      <idea ac="AC-7.6.2">Unit test: suggestLPsForPicking() with FIFO strategy - returns LPs sorted by created_at ASC</idea>
      <idea ac="AC-7.6.2">Unit test: suggestLPsForPicking() with FEFO strategy - returns LPs sorted by expiry_date ASC</idea>
      <idea ac="AC-7.6.7">Unit test: suggestLPsForPicking() - excludes LPs with qa_status != 'passed'</idea>
      <idea ac="AC-7.6.4">Integration test: POST /pick-lists with valid SO - returns 201 with pick list and suggested LPs</idea>
      <idea ac="AC-7.6.4">Integration test: POST /pick-lists with invalid SO - returns 400 error</idea>
      <idea ac="AC-7.6.1">E2E test: Click "Generate Pick List" on SO page, pick list created with suggested LPs</idea>
      <idea ac="AC-7.6.6">E2E test: View pick list, items sorted by location for efficient picking</idea>
    </ideas>
  </tests>
</story-context>
