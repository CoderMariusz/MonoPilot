<story-context id="bmad/bmm/workflows/4-implementation/story-context/5-1-lp-creation" v="1.0">
  <metadata>
    <epicId>5</epicId>
    <storyId>1</storyId>
    <title>License Plate Creation</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-11-24</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/epics/epic-5-warehouse.md</sourceStoryPath>
    <template>Template A - CRUD Pattern</template>
    <estimatedTokens>5000</estimatedTokens>
    <estimatedEffort>1 day</estimatedEffort>
  </metadata>

  <story>
    <asA>Warehouse user</asA>
    <iWant>to create license plates</iWant>
    <soThat>inventory is tracked atomically</soThat>
    <tasks>
      <task id="1" ac="AC-5.1.1">LP Creation Modal - Display fields: lp_number (auto-generated), product_id, qty, uom, batch_number, manufacture_date, expiry_date, location_id</task>
      <task id="2" ac="AC-5.1.2">API Route - POST /api/warehouse/license-plates for LP creation</task>
      <task id="3" ac="AC-5.1.3">Service Layer - createLicensePlate() with org isolation, validation, audit trail</task>
      <task id="4" ac="AC-5.1.4">UoM Auto-Fill - Populate uom from product when product selected</task>
      <task id="5" ac="AC-5.1.5">LP Number Generation - Auto-generate lp_number format (configurable), allow manual override</task>
      <task id="6" ac="AC-5.1.6">Status Initialization - Set LP status = 'available' on creation</task>
      <task id="7" ac="AC-5.1.7">Validation - Require product_id, qty > 0, batch_number, location_id</task>
      <task id="8" ac="ALL">Unit & Integration Tests - Service layer tests, API route tests, validation tests</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC-5.1.1">Given user navigates to /warehouse/license-plates, When clicking "Create LP", Then modal opens with fields: lp_number (auto-generated, can override), product_id (required dropdown), qty (required number), uom (from product, read-only), batch_number (required text), manufacture_date (optional date), expiry_date (optional date), location_id (required dropdown)</criterion>
    <criterion id="AC-5.1.2">When saving LP, Then LP created with status = 'available' and org_id from current user</criterion>
    <criterion id="AC-5.1.3">And LP number format is configurable (default: LP-YYYYMMDD-NNNN), can be manually overridden in modal</criterion>
    <criterion id="AC-5.1.4">And UoM field auto-fills from selected product's default UoM (read-only)</criterion>
    <criterion id="AC-5.1.5">Validation rules: product_id required (must exist in products table), qty > 0 required, batch_number required (min 1 char), location_id required (must exist in locations table), manufacture_date <= current date (if provided), expiry_date >= manufacture_date (if both provided)</criterion>
    <criterion id="AC-5.1.6">API: POST /api/warehouse/license-plates - Request body: { product_id, qty, batch_number, manufacture_date?, expiry_date?, location_id, lp_number? } - Response: { data: LicensePlate } with status 201 or error 400/500</criterion>
    <criterion id="AC-5.1.7">Service layer uses createServerSupabaseAdmin() for database operations (Service Role pattern), validates org_id isolation, checks product/location existence, records created_by audit trail</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/epics/epic-5-warehouse.md</path>
        <title>Epic 5: Warehouse & Scanner</title>
        <section>Story 5.1: License Plate Creation</section>
        <snippet>Create LPs with lp_number (auto-generated, can override), product, qty, uom (from product), batch, manufacture/expiry dates, location. Status set to 'available'. LP number format configurable. Prerequisites: Epic 1 (Settings), Epic 2 (Products).</snippet>
      </doc>
      <doc>
        <path>docs/templates/context/template-a-crud-pattern.md</path>
        <title>Template A: CRUD Pattern</title>
        <section>Overview</section>
        <snippet>Standard CRUD implementation: Component (Modal) → API Route → Service Layer → Database (Supabase). Multi-tenancy (org_id isolation), Service Role pattern (admin client), dual validation (client + server), audit trail (created_by), cache invalidation, error handling.</snippet>
      </doc>
      <doc>
        <path>docs/templates/context/template-a-crud-pattern.md</path>
        <title>Template A: CRUD Pattern</title>
        <section>Service Layer - Create Operation</section>
        <snippet>createResource() function with org isolation, unique constraint checks, INSERT with admin client, audit trail (created_by), cache invalidation, ServiceResult return type with success/error/code.</snippet>
      </doc>
      <doc>
        <path>docs/architecture/patterns/api.md</path>
        <title>API Architecture</title>
        <section>Error Handling - RFC 7807 Problem Details</section>
        <snippet>Structured error responses with type, title, status, detail, errors fields. APIError class with toProblemDetails() method. handleAPIError() function for consistent error formatting.</snippet>
      </doc>
    </docs>

    <code>
      <artifact>
        <path>app/api/warehouse/license-plates</path>
        <kind>directory</kind>
        <symbol>LP Creation API route location</symbol>
        <reason>Story requires creating route.ts for POST /api/warehouse/license-plates endpoint</reason>
      </artifact>
      <artifact>
        <path>lib/services/license-plate-service.ts</path>
        <kind>file</kind>
        <symbol>License Plate service layer</symbol>
        <reason>Story requires createLicensePlate() method with org isolation, validation, audit trail</reason>
      </artifact>
      <artifact>
        <path>lib/validation/license-plate-schemas.ts</path>
        <kind>file</kind>
        <symbol>License Plate Zod schemas</symbol>
        <reason>Story requires createLicensePlateSchema for validating LP creation input</reason>
      </artifact>
      <artifact>
        <path>components/warehouse/LicensePlateFormModal.tsx</path>
        <kind>component</kind>
        <symbol>LicensePlateFormModal</symbol>
        <reason>Story requires modal with fields: lp_number, product_id, qty, batch_number, dates, location_id</reason>
      </artifact>
      <artifact>
        <path>lib/services/product-service.ts</path>
        <kind>file</kind>
        <symbol>Product service</symbol>
        <reason>Story requires getProductById() to fetch product UoM for auto-fill</reason>
      </artifact>
      <artifact>
        <path>lib/services/location-service.ts</path>
        <kind>file</kind>
        <symbol>Location service</symbol>
        <reason>Story requires listLocations() for location dropdown in modal</reason>
      </artifact>
      <artifact>
        <path>lib/utils/lp-number-generator.ts</path>
        <kind>file</kind>
        <symbol>LP number generator utility</symbol>
        <reason>Story requires generateLPNumber() function with configurable format (LP-YYYYMMDD-NNNN)</reason>
      </artifact>
    </code>

    <dependencies>
      <node>
        <package name="@supabase/supabase-js" version="^2.84.0" usage="Supabase client for database operations (LP creation, FK validation)" />
        <package name="@supabase/ssr" version="^0.7.0" usage="SSR helpers for Next.js (createServerClient, createServerSupabaseAdmin)" />
        <package name="react-hook-form" version="^7.66.1" usage="Form state management for LP Creation modal" />
        <package name="zod" version="^3.25.76" usage="Validation schemas for LP creation request (createLicensePlateSchema)" />
        <package name="@hookform/resolvers" version="^5.2.2" usage="Zod resolver for react-hook-form integration" />
        <package name="next" version="^15.1.4" usage="Next.js framework with App Router for API routes" />
        <package name="react" version="^19.0.0" usage="React 19 for UI components (modal)" />
        <package name="date-fns" version="^4.1.0" usage="Date utilities for manufacture/expiry date validation" />
        <package name="lucide-react" version="^0.554.0" usage="Icons for modal (package icon for LP, calendar for dates)" />
        <package name="@radix-ui/react-dialog" version="^1.1.15" usage="Dialog component for LP Creation modal" />
        <package name="@radix-ui/react-select" version="^2.2.6" usage="Select component for product_id and location_id dropdowns" />
        <package name="@radix-ui/react-toast" version="^1.2.15" usage="Toast notifications for success/error messages" />
      </node>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="architecture">Template A CRUD Pattern - use standard CRUD implementation with Component → API Route → Service Layer → Database</constraint>
    <constraint type="architecture">Next.js 15 App Router - use app/ directory structure, server components by default, client component for modal</constraint>
    <constraint type="architecture">Service Role pattern - use createServerSupabaseAdmin() for all database operations (bypass RLS)</constraint>
    <constraint type="business">Org isolation - MUST set org_id from current user on LP creation, validate FK (product, location) within same org</constraint>
    <constraint type="business">LP number format - default LP-YYYYMMDD-NNNN (configurable in warehouse_settings), allow manual override in modal</constraint>
    <constraint type="business">UoM auto-fill - populate from product.default_uom when product selected (read-only field)</constraint>
    <constraint type="business">Status initialization - set status = 'available' on LP creation (other statuses set via separate operations)</constraint>
    <constraint type="validation">Zod validation - required on BOTH client and server for LP creation (createLicensePlateSchema)</constraint>
    <constraint type="validation">Required fields - product_id, qty > 0, batch_number (min 1 char), location_id</constraint>
    <constraint type="validation">Date validation - manufacture_date <= current date, expiry_date >= manufacture_date (if both provided)</constraint>
    <constraint type="database">FK validation - product_id must exist in products table, location_id must exist in locations table (same org)</constraint>
    <constraint type="database">Unique constraint - lp_number must be unique per org (enforced at DB level)</constraint>
    <constraint type="ux">Shadcn/UI components - use Dialog, Select, Input, DatePicker, Button, Toast for consistency</constraint>
    <constraint type="ux">Modal layout - lp_number input (pre-filled, editable), product dropdown, qty input, batch input, date pickers, location dropdown, create button</constraint>
    <constraint type="testing">Test pyramid - 95% unit coverage for service layer (FK validation, org isolation), 70% integration coverage for API route, 100% E2E coverage for LP creation flow</constraint>
    <constraint type="security">Authorization - verify user has Warehouse role or higher before allowing LP creation</constraint>
    <constraint type="security">RLS policies - ensure org_id scoping on license_plates table for read operations (create uses admin client)</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>POST /api/warehouse/license-plates</name>
      <kind>API route</kind>
      <signature>POST /api/warehouse/license-plates - Request body: { lp_number?: string, product_id: string, qty: number, batch_number: string, manufacture_date?: string, expiry_date?: string, location_id: string } - Response: { data: LicensePlate } or error 400/500</signature>
      <path>app/api/warehouse/license-plates/route.ts</path>
    </interface>
    <interface>
      <name>createLicensePlate</name>
      <kind>service function</kind>
      <signature>async function createLicensePlate(input: CreateLicensePlateInput): Promise&lt;ServiceResult&lt;LicensePlate&gt;&gt; - Validates org isolation, FK existence, generates lp_number if not provided, sets status = 'available', records created_by</signature>
      <path>lib/services/license-plate-service.ts</path>
    </interface>
    <interface>
      <name>createLicensePlateSchema</name>
      <kind>Zod schema</kind>
      <signature>z.object({ lp_number: z.string().min(5).optional(), product_id: z.string().uuid(), qty: z.number().positive(), batch_number: z.string().min(1), manufacture_date: z.string().datetime().optional(), expiry_date: z.string().datetime().optional(), location_id: z.string().uuid() }).refine(data => !data.manufacture_date || new Date(data.manufacture_date) <= new Date(), "Manufacture date cannot be in future").refine(data => !data.expiry_date || !data.manufacture_date || new Date(data.expiry_date) >= new Date(data.manufacture_date), "Expiry must be after manufacture")</signature>
      <path>lib/validation/license-plate-schemas.ts</path>
    </interface>
    <interface>
      <name>LicensePlateFormModal</name>
      <kind>React component</kind>
      <signature>LicensePlateFormModal: FC&lt;{ open: boolean, onClose: () =&gt; void, onSuccess: () =&gt; void }&gt; - Displays LP creation form with lp_number (pre-filled), product dropdown, qty input, batch input, date pickers, location dropdown, create button. Calls createLicensePlate API.</signature>
      <path>components/warehouse/LicensePlateFormModal.tsx</path>
    </interface>
    <interface>
      <name>generateLPNumber</name>
      <kind>utility function</kind>
      <signature>async function generateLPNumber(orgId: string, format?: string): Promise&lt;string&gt; - Generates unique LP number based on configurable format (default: LP-YYYYMMDD-NNNN with daily sequence)</signature>
      <path>lib/utils/lp-number-generator.ts</path>
    </interface>
    <interface>
      <name>getProductById</name>
      <kind>service function</kind>
      <signature>async function getProductById(productId: string): Promise&lt;ServiceResult&lt;Product&gt;&gt; - Fetches product with default_uom for UoM auto-fill</signature>
      <path>lib/services/product-service.ts</path>
    </interface>
    <interface>
      <name>listLocations</name>
      <kind>service function</kind>
      <signature>async function listLocations(filters?: { warehouse_id?: string, type?: string }): Promise&lt;ServiceResult&lt;Location[]&gt;&gt; - Lists active locations for dropdown</signature>
      <path>lib/services/location-service.ts</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Testing strategy follows Test Pyramid: unit tests for service layer (95% coverage, mock Supabase client with vitest, test FK validation, org isolation, lp_number generation), integration tests for API route (70% coverage, Vitest + Supabase Test Client), E2E tests for complete LP creation flow (100% user flows, Playwright). All tests in __tests__ directories colocated with source. Test files follow pattern: service.test.ts (unit), route.test.ts (integration), lp-creation-flow.e2e.ts (E2E). Fixtures in __fixtures__. Mock Supabase in unit tests.
    </standards>
    <locations>
      <location>lib/services/__tests__/license-plate-service.test.ts (createLicensePlate unit tests with mocked Supabase)</location>
      <location>lib/utils/__tests__/lp-number-generator.test.ts (LP number generation unit tests)</location>
      <location>app/api/warehouse/license-plates/__tests__/route.test.ts (API route integration tests)</location>
      <location>components/warehouse/__tests__/LicensePlateFormModal.test.tsx (Modal component unit tests)</location>
      <location>e2e/warehouse/lp-creation.e2e.ts (Complete LP creation flow E2E tests)</location>
    </locations>
    <ideas>
      <idea ac="AC-5.1.1">Unit test: createLicensePlate() with valid input - creates LP with status = 'available' and org_id from user</idea>
      <idea ac="AC-5.1.2">Unit test: createLicensePlate() with invalid product_id - returns error "Product not found"</idea>
      <idea ac="AC-5.1.3">Unit test: createLicensePlate() with invalid location_id - returns error "Location not found"</idea>
      <idea ac="AC-5.1.4">Unit test: createLicensePlate() with qty = 0 - returns validation error "Qty must be positive"</idea>
      <idea ac="AC-5.1.5">Unit test: createLicensePlate() with manufacture_date in future - returns error "Manufacture date cannot be in future"</idea>
      <idea ac="AC-5.1.5">Unit test: createLicensePlate() with expiry_date < manufacture_date - returns error "Expiry must be after manufacture"</idea>
      <idea ac="AC-5.1.3">Unit test: generateLPNumber() with default format - generates LP-20250124-0001 (daily sequence)</idea>
      <idea ac="AC-5.1.3">Unit test: generateLPNumber() with custom format from settings - generates custom format</idea>
      <idea ac="AC-5.1.3">Unit test: createLicensePlate() without lp_number - auto-generates unique lp_number</idea>
      <idea ac="AC-5.1.3">Unit test: createLicensePlate() with manual lp_number override - uses provided lp_number</idea>
      <idea ac="AC-5.1.6">Integration test: POST /api/warehouse/license-plates with valid input - returns 201 with created LP</idea>
      <idea ac="AC-5.1.6">Integration test: POST /api/warehouse/license-plates with invalid product - returns 400 error</idea>
      <idea ac="AC-5.1.7">Integration test: POST /api/warehouse/license-plates with missing batch_number - returns 400 validation error</idea>
      <idea ac="AC-5.1.7">Integration test: POST /api/warehouse/license-plates enforces org_id isolation - cannot create LP with product from different org</idea>
      <idea ac="AC-5.1.1">E2E test: Navigate to /warehouse/license-plates, click "Create LP", modal opens with all fields</idea>
      <idea ac="AC-5.1.4">E2E test: Select product in modal, UoM field auto-fills from product.default_uom (read-only)</idea>
      <idea ac="AC-5.1.3">E2E test: LP number field pre-filled with generated number, can be manually edited</idea>
      <idea ac="AC-5.1.2">E2E test: Fill all required fields, submit form, success toast shown, LP created with status = 'available'</idea>
      <idea ac="AC-5.1.5">E2E test: Enter manufacture_date in future, validation error displayed, form submission blocked</idea>
      <idea ac="AC-5.1.5">E2E test: Enter expiry_date before manufacture_date, validation error displayed</idea>
      <idea ac="ALL">E2E test: Create LP, verify in database: org_id matches user, created_by set, status = 'available'</idea>
    </ideas>
  </tests>
</story-context>
