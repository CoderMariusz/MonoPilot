<story-context id="3-15-configurable-wo-statuses" v="1.0">
  <metadata>
    <epicId>3</epicId>
    <storyId>15</storyId>
    <title>Configurable WO Statuses</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-11-24</generatedAt>
    <template>Template C - Settings Pattern</template>
    <estimatedTokens>3000</estimatedTokens>
    <estimatedEffort>0.5 day</estimatedEffort>
  </metadata>

  <story>
    <asA>Admin</asA>
    <iWant>to configure WO status lifecycle</iWant>
    <soThat>it matches our process</soThat>
    <tasks>
      <task id="1" ac="AC-3.15.1">WO Statuses Configuration UI - Settings page for adding/removing/renaming WO statuses</task>
      <task id="2" ac="AC-3.15.2">JSONB Storage - Store statuses in planning_settings.wo_statuses JSONB field</task>
      <task id="3" ac="AC-3.15.3">Status Expiry Configuration - Set status expiry (auto-close after X days)</task>
      <task id="4" ac="AC-3.15.4">API Routes - GET/PUT /api/planning/settings endpoints (same as Story 3.5)</task>
      <task id="5" ac="ALL">Unit & Integration Tests - Settings configuration tests</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC-3.15.1">Given Admin navigates to /settings/planning, When viewing WO Statuses, Then can add/remove/rename statuses And set status expiry (auto-close after X days)</criterion>
    <criterion id="AC-3.15.2">Default statuses: Draft, Planned, Released, In Progress, Completed, Closed; Optional statuses: On Hold, Cancelled, Quality Hold</criterion>
    <criterion id="AC-3.15.3">Statuses stored in planning_settings.wo_statuses JSONB field as array; Status expiry in planning_settings.wo_status_expiry_days</criterion>
    <criterion id="AC-3.15.4">API: GET/PUT /api/planning/settings - same endpoint as Story 3.5</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/epics/epic-3-planning.md</path>
        <title>Epic 3: Planning Operations</title>
        <section>Story 3.15: Configurable WO Statuses</section>
        <snippet>Configure WO status lifecycle. Admin can add/remove/rename statuses, set status expiry. Default: Draft, Planned, Released, In Progress, Completed, Closed. Optional: On Hold, Cancelled, Quality Hold. Stored in planning_settings.wo_statuses JSONB. Prerequisites: Epic 1.</snippet>
      </doc>
    </docs>

    <code>
      <artifact>
        <path>app/api/planning/settings</path>
        <kind>directory</kind>
        <symbol>Planning Settings API route</symbol>
        <reason>Story uses same endpoint as Story 3.5 for GET/PUT /api/planning/settings</reason>
      </artifact>
      <artifact>
        <path>app/settings/planning/page.tsx</path>
        <kind>page</kind>
        <symbol>Planning Settings page</symbol>
        <reason>Story requires settings page for configuring WO statuses (same page as Story 3.5)</reason>
      </artifact>
    </code>

    <dependencies>
      <node>
        <package name="@supabase/supabase-js" version="^2.84.0" usage="Supabase client for settings CRUD" />
      </node>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="architecture">Template C Settings Pattern - JSONB storage for flexible configuration</constraint>
    <constraint type="business">WO statuses stored as JSONB array with label, value, expiry_days</constraint>
    <constraint type="testing">Test pyramid - 95% unit, 70% integration, 100% E2E</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>GET /api/planning/settings</name>
      <kind>API route</kind>
      <signature>GET /api/planning/settings - Response: { data: { wo_statuses: array, wo_status_expiry_days: number, ... } }</signature>
      <path>app/api/planning/settings/route.ts</path>
    </interface>
  </interfaces>

  <tests>
    <standards>Test Pyramid: unit tests (95%), integration tests (70%), E2E tests (100%)</standards>
    <locations>
      <location>app/api/planning/settings/__tests__/route.test.ts</location>
    </locations>
    <ideas>
      <idea ac="AC-3.15.4">Integration test: PUT /settings with new WO status - updates planning_settings.wo_statuses</idea>
    </ideas>
  </tests>
</story-context>
