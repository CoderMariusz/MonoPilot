<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>1.12</storyId>
    <title>Settings Wizard (UX Design)</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-11-20</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/1-12-settings-wizard-ux-design.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>new Admin</asA>
    <iWant>a guided wizard to set up my organization</iWant>
    <soThat>I don't miss any important configuration</soThat>
    <tasks>
      - Task 1: Database Schema - Wizard Tracking (wizard_completed, wizard_progress JSONB columns)
      - Task 2: Wizard Data Model (WizardData interface with 6 steps)
      - Task 3: Wizard Service - Core Logic (save progress, complete wizard with transactions)
      - Task 4: API Endpoints (GET/POST /api/settings/wizard/progress, POST /api/settings/wizard/complete)
      - Task 5: Frontend Wizard Component (modal or full-page with 6 steps)
      - Task 6: Step Validation (Zod schemas per step, react-hook-form)
      - Task 7: Wizard Progress Auto-Save (save on each Next click)
      - Task 8: Wizard Skip and Resume (dashboard banner, Settings menu item)
      - Task 9: Circular Dependency Resolution (warehouse → locations → update warehouse defaults)
      - Task 10: Wizard Completion (all-or-nothing transaction, success modal)
      - Task 11: Module Selection UI (8 module checkboxes, at least one required)
      - Task 12: User Invitation UI (multi-row form, add/remove rows)
      - Task 13: Wizard Re-run from Settings (review mode, pre-filled data)
      - Task 14: Progress Indicator (stepper or progress bar)
      - Task 15: Error Handling (API errors, network errors, validation, rollback)
      - Task 16: Integration & Testing (Unit, Integration, E2E tests, transaction rollback)
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC-012.1">
      <title>6-step wizard triggered on first login</title>
      <details>
        - After Admin first logs in and organizations.wizard_completed = false
        - Modal or full-page wizard with progress indicator (1/6, 2/6, ...)
        - Steps: 1. Organization Basics, 2. Regional Settings, 3. First Warehouse, 4. Key Locations, 5. Module Selection, 6. Invite First Users
        - Cannot skip to step N without completing step N-1
        - Can dismiss wizard (button: "Skip wizard, do this later")
      </details>
    </criterion>

    <criterion id="AC-012.2">
      <title>Each step validates before proceeding</title>
      <details>
        - Step 1: company_name required (min 2 chars)
        - Step 2: timezone, currency, language required
        - Step 3: warehouse code and name required
        - Step 4: at least Receiving and Shipping locations required
        - Step 5: at least one module must be enabled
        - Step 6: optional (can skip user invitations)
        - On validation error: show inline error, prevent next step
      </details>
    </criterion>

    <criterion id="AC-012.3">
      <title>Wizard completion status tracked</title>
      <details>
        - organizations.wizard_completed: BOOLEAN (default false)
        - On wizard completion: set wizard_completed = true
        - Progress saved per step: organizations.wizard_progress: JSON { step: 3, data: {...} }
        - If user dismisses wizard: wizard_completed = false, can resume later
        - Button in Settings: "Resume Setup Wizard" (visible if wizard_completed = false)
      </details>
    </criterion>

    <criterion id="AC-012.4">
      <title>Wizard skip and resume functionality</title>
      <details>
        - "Skip wizard" button: dismiss modal, redirect to dashboard
        - Banner on dashboard: "Complete your organization setup" with "Resume" button
        - Resume: opens wizard at last completed step
        - Once completed: banner hidden, wizard not shown on login
      </details>
    </criterion>

    <criterion id="AC-012.5">
      <title>Wizard flow handles circular dependencies</title>
      <details>
        - Step 3: Create warehouse with default locations = NULL
        - Step 4: Create 4 locations (Receiving, Shipping, Transit, Production)
        - After step 4: auto-update warehouse defaults with created location IDs
        - Resolves circular dependency: warehouse ← locations ← warehouse defaults
      </details>
    </criterion>

    <criterion id="AC-012.6">
      <title>Module selection with descriptions</title>
      <details>
        - Step 5 shows 8 modules with checkboxes (not toggles)
        - Each module: name, description, icon, default state
        - Defaults: Technical, Planning, Production, Warehouse checked
        - Can check/uncheck any module
        - At least one module required (validation)
      </details>
    </criterion>

    <criterion id="AC-012.7">
      <title>User invitation with role assignment</title>
      <details>
        - Step 6 has form: add multiple users
        - Each user row: email, first_name, last_name, role (dropdown)
        - "+ Add Another User" button
        - Remove user button (X icon)
        - On wizard completion: send invitations to all users
        - Users receive email with signup link
      </details>
    </criterion>

    <criterion id="AC-012.8">
      <title>Progress indicator and navigation</title>
      <details>
        - Progress bar or stepper: shows current step (1-6)
        - Each step: "Back" and "Next" buttons (Back disabled on step 1)
        - Step 6: "Next" → "Complete Setup"
        - On completion: success modal, redirect to dashboard
      </details>
    </criterion>

    <criterion id="AC-012.9">
      <title>Wizard data validation and error handling</title>
      <details>
        - All form fields use Zod validation schemas from previous stories
        - API errors shown as toast or inline
        - If API fails (e.g., warehouse creation): show error, allow retry
        - Network errors: show "Retry" button
        - Data auto-saved per step (wizard_progress JSON)
      </details>
    </criterion>

    <criterion id="AC-012.10">
      <title>Wizard can be accessed later from Settings</title>
      <details>
        - Navigate to /settings → "Setup Wizard" menu item
        - If wizard_completed = true: show "Re-run Setup Wizard" (for templates or multi-warehouse setup)
        - Opens wizard in review mode: all data pre-filled, can edit and re-save
        - Use case: Create 2nd warehouse, invite more users, etc.
      </details>
    </criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-1.md</path>
        <title>Technical Specification - Epic 1 (Foundation & Settings)</title>
        <section>Onboarding Wizard</section>
        <snippet>6-step guided wizard for organization setup with circular dependency resolution, progress tracking, and all-or-nothing transactions.</snippet>
      </doc>

      <doc>
        <path>docs/epics/epic-1-settings.md</path>
        <title>Epic 1: Foundation & Settings</title>
        <section>Story 1.12: Settings Wizard (UX Design)</section>
        <snippet>Onboarding wizard integrating all previous stories (1.1-1.11) into guided 6-step setup flow.</snippet>
      </doc>
    </docs>

    <code>
      <artifact>
        <path>app/lib/supabase/server.ts</path>
        <kind>lib</kind>
        <symbol>createClient</symbol>
        <lines>all</lines>
        <reason>Supabase server client for database operations and transactions</reason>
      </artifact>

      <artifact>
        <path>app/lib/types.ts</path>
        <kind>types</kind>
        <symbol>Database types</symbol>
        <lines>all</lines>
        <reason>TypeScript types for database tables - will be updated after wizard columns added</reason>
      </artifact>

      <artifact>
        <path>packages/shared/schemas.ts</path>
        <kind>schemas</kind>
        <symbol>Zod schemas</symbol>
        <lines>all</lines>
        <reason>Reuse existing validation schemas from Stories 1.1-1.6 for wizard steps</reason>
      </artifact>

      <artifact>
        <path>packages/shared/types.ts</path>
        <kind>types</kind>
        <symbol>Shared types</symbol>
        <lines>all</lines>
        <reason>Shared TypeScript types - add WizardData interface</reason>
      </artifact>
    </code>

    <dependencies>
      <ecosystem name="node">
        <package name="@supabase/supabase-js" version="latest">Supabase client for database and transactions</package>
        <package name="zod" version="latest">Schema validation (reuse from Stories 1.1-1.6)</package>
        <package name="react-hook-form" version="latest">Form state management per step</package>
        <package name="swr" version="latest">Data fetching and caching</package>
      </ecosystem>

      <ecosystem name="shadcn">
        <component name="dialog">Wizard modal or success modal</component>
        <component name="toast">Success/error notifications</component>
        <component name="input">Form fields</component>
        <component name="select">Dropdowns (timezone, currency, language, role)</component>
        <component name="checkbox">Module selection checkboxes</component>
        <component name="progress">Progress bar or stepper</component>
        <component name="button">Navigation buttons (Back, Next, Complete)</component>
      </ecosystem>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="architecture">
      <rule>Wizard Trigger: On first Admin login, check organizations.wizard_completed = false</rule>
      <rule>Progress Persistence: organizations.wizard_progress JSONB stores current step + form data</rule>
      <rule>Circular Dependency Resolution: Create warehouse (defaults NULL) → create 4 locations → update warehouse defaults</rule>
      <rule>All-or-Nothing: Use database transaction for wizard completion, rollback on any step failure</rule>
      <rule>Integration: Wizard calls APIs from Stories 1.1-1.6 (organizations, warehouses, locations, modules, users)</rule>
    </constraint>

    <constraint type="security">
      <rule>Admin Only: Wizard accessible only to Admin role</rule>
      <rule>Transaction Security: All wizard operations in single transaction, rollback on failure prevents partial data</rule>
      <rule>Skip Protection: Skipping wizard sets wizard_completed = false, can resume later</rule>
    </constraint>

    <constraint type="data">
      <rule>wizard_completed Column: BOOLEAN DEFAULT false on organizations table</rule>
      <rule>wizard_progress Column: JSONB (stores { step: number, data: Partial&lt;WizardData&gt; })</rule>
      <rule>Default Modules: ['technical', 'planning', 'production', 'warehouse'] checked in Step 5</rule>
      <rule>Required Locations: Receiving and Shipping (minimum) in Step 4</rule>
    </constraint>

    <constraint type="performance">
      <rule>Wizard completion: &lt;2s for all 6 steps (transaction)</rule>
      <rule>Progress save: &lt;200ms per step</rule>
      <rule>Resume wizard: &lt;300ms to load saved progress</rule>
    </constraint>

    <constraint type="testing">
      <rule>Transaction Testing: MUST verify rollback on warehouse/location creation failure</rule>
      <rule>Integration Tests: MUST verify circular dependency resolution</rule>
      <rule>E2E Tests: MUST test complete wizard flow, skip/resume functionality</rule>
    </constraint>
  </constraints>

  <interfaces>
    <interface name="POST /api/settings/wizard/progress">
      <kind>REST endpoint</kind>
      <signature>
        Body: { step: number, data: Partial&lt;WizardData&gt; }
        Response: { success: boolean }
        Auth: Admin only
        Side effects: Update organizations.wizard_progress (merge new data with existing)
      </signature>
      <path>app/api/settings/wizard/progress/route.ts (NEW)</path>
    </interface>

    <interface name="GET /api/settings/wizard/progress">
      <kind>REST endpoint</kind>
      <signature>
        Response: { step: number, data: Partial&lt;WizardData&gt; }
        Returns: Current wizard progress from organizations.wizard_progress
        Auth: Admin only
      </signature>
      <path>app/api/settings/wizard/progress/route.ts (NEW)</path>
    </interface>

    <interface name="POST /api/settings/wizard/complete">
      <kind>REST endpoint</kind>
      <signature>
        Body: WizardData (all 6 steps data)
        Response: { success: boolean }
        Auth: Admin only
        Logic: Execute all steps in transaction (update org → create warehouse → create 4 locations → update warehouse defaults → update modules → create users)
        Side effects: Set wizard_completed = true, clear wizard_progress
        Transaction: All-or-nothing (rollback on any failure)
      </signature>
      <path>app/api/settings/wizard/complete/route.ts (NEW)</path>
    </interface>

    <interface name="WizardService.completeWizard">
      <kind>Service method</kind>
      <signature>
        async completeWizard(orgId: string, data: WizardData): Promise&lt;{ success: boolean }&gt;
        Steps:
        1. Update organization (company_name, logo, address, etc.)
        2. Update regional settings (timezone, currency, language)
        3. Create warehouse (POST /api/settings/warehouses) - defaults NULL
        4. Create 4 locations (POST /api/settings/locations x4)
        5. Update warehouse defaults with location IDs
        6. Update modules_enabled
        7. Create users and send invitations (POST /api/settings/users x N)
        8. Set wizard_completed = true
        Transaction: All operations in single transaction, rollback on error
      </signature>
      <path>lib/services/WizardService.ts (NEW)</path>
    </interface>

    <interface name="WizardData">
      <kind>TypeScript interface</kind>
      <signature>
        interface WizardData {
          step: number
          organization: { company_name, logo?, address, city, postal_code, country }
          regional: { timezone, currency, language, date_format, number_format }
          warehouse: { code, name, address? }
          locations: {
            receiving: { code, name },
            shipping: { code, name },
            transit: { code, name },
            production: { code, name }
          }
          modules: string[]
          users: Array&lt;{ email, first_name, last_name, role }&gt;
        }
      </signature>
      <path>packages/shared/types.ts</path>
    </interface>

    <interface name="SetupWizard Component">
      <kind>React component</kind>
      <signature>
        State: currentStep (1-6), wizardData (WizardData)
        Navigation: Back, Next, Skip, Complete buttons
        Step rendering: switch currentStep (Step1OrganizationBasics, Step2RegionalSettings, ...)
        Validation: Per-step Zod schemas from Stories 1.1-1.6
        Progress save: POST /api/settings/wizard/progress on Next
        Completion: POST /api/settings/wizard/complete on step 6 Complete
      </signature>
      <path>app/onboarding/wizard/page.tsx (NEW)</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Testing stack: Vitest for unit/integration tests, Playwright for E2E tests.
      Transaction tests critical for all-or-nothing wizard completion.
      Circular dependency tests verify warehouse → locations → warehouse defaults flow.
      Skip/resume tests verify wizard_progress persistence and reload.
    </standards>

    <locations>
      - lib/services/WizardService.test.ts (Wizard completion logic, transaction rollback)
      - app/api/settings/wizard/**/*.test.ts (API endpoint tests)
      - tests/integration/wizard/ (Integration tests: circular dependency, transaction atomicity)
      - tests/e2e/onboarding/wizard.spec.ts (E2E wizard flow, skip/resume)
    </locations>

    <ideas>
      <test id="AC-012.1" type="e2e">
        - E2E: First login → wizard opens automatically
        - E2E: Complete all 6 steps → redirect to dashboard
        - E2E: Cannot skip to step 4 without completing steps 1-3
      </test>

      <test id="AC-012.2" type="unit">
        - Validate Step 1: company_name required, min 2 chars
        - Validate Step 4: at least Receiving and Shipping locations required
        - Validate Step 5: at least one module required
      </test>

      <test id="AC-012.3" type="integration">
        - Save wizard progress → wizard_progress JSONB updated
        - Complete wizard → wizard_completed = true, wizard_progress cleared
      </test>

      <test id="AC-012.4" type="e2e">
        - E2E: Skip wizard → dashboard banner shown
        - E2E: Resume wizard → opens at last completed step, data pre-filled
        - E2E: Complete wizard → banner hidden
      </test>

      <test id="AC-012.5" type="integration">
        - Create warehouse (step 3) → defaults NULL
        - Create 4 locations (step 4) → warehouse_id set
        - Update warehouse defaults → default_receiving_location_id, default_shipping_location_id set
        - Circular dependency resolved without FK errors
      </test>

      <test id="AC-012.6" type="e2e">
        - E2E: Step 5 → 4 modules pre-checked (Technical, Planning, Production, Warehouse)
        - E2E: Uncheck all modules → validation error
        - E2E: Check Quality module → modules_enabled includes 'quality'
      </test>

      <test id="AC-012.7" type="e2e">
        - E2E: Step 6 → add 3 users → users created, invitations sent
        - E2E: Step 6 → skip (no users) → wizard still completes
      </test>

      <test id="transaction" type="integration">
        - Warehouse creation succeeds, location creation fails → rollback warehouse (transaction atomicity)
        - All operations succeed → wizard_completed = true, all entities created
        - Network error during user creation → all-or-nothing rollback
      </test>

      <test id="all" type="e2e">
        - E2E: Complete wizard flow → organization, warehouse, 4 locations, modules, users created
        - E2E: Re-run wizard from Settings → data pre-filled, can create 2nd warehouse
        - E2E: Progress indicator updates on each step
        - E2E: Back button works, data persists on navigation
      </test>
    </ideas>
  </tests>
</story-context>
