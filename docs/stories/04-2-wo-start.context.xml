<story-context id="4-2-wo-start" v="1.0">
  <metadata>
    <epicId>4</epicId>
    <storyId>2</storyId>
    <title>WO Start</title>
    <status>drafted</status>
    <generatedAt>2025-11-27</generatedAt>
    <template>Action Pattern - Status Transition</template>
    <estimatedTokens>4200</estimatedTokens>
    <estimatedEffort>0.5 days</estimatedEffort>
  </metadata>

  <story>
    <asA>Operator</asA>
    <iWant>to start a released work order</iWant>
    <soThat>I can begin production and track when work actually starts</soThat>
    <tasks>
      <task id="1" ac="AC-4.2.2">Verify work_orders table has started_at, started_by_user_id columns</task>
      <task id="2" ac="AC-4.2.2, AC-4.2.6">Create WorkOrderStartService with startWorkOrder() method</task>
      <task id="3" ac="AC-4.2.5">Create POST /api/production/work-orders/:id/start endpoint</task>
      <task id="4" ac="AC-4.2.1, AC-4.2.8">Create WOStartModal component with material availability check</task>
      <task id="5" ac="AC-4.2.1, AC-4.2.2">Integrate Start Production button on WO detail page</task>
      <task id="6" ac="AC-4.2.3">Update dashboard to show started WOs in Active list</task>
      <task id="7" ac="ALL">Unit, Integration, E2E tests - status transition, role check, material warnings</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC-4.2.1">Given I navigate to a released work order detail page, When clicking "Start Production" button, Then a modal appears with: WO summary, Line/Machine, Material Availability (with warnings if shortage), Cancel and Confirm Start buttons</criterion>
    <criterion id="AC-4.2.2">Given the modal is open and user confirms, When clicking "Confirm Start", Then system validates (status = 'released', user has Production/Manager/Admin role), updates work_orders (status → 'in_progress', started_at → NOW(), started_by_user_id → current_user.id), returns updated WO object</criterion>
    <criterion id="AC-4.2.3">Given WO is successfully started, When user returns to production dashboard, Then WO appears in "Active Work Orders" table (Story 4.1) with status "In Progress" and progress bar at 0%</criterion>
    <criterion id="AC-4.2.4">Given there are conditions preventing WO start (already in_progress, not released, etc.), When clicking "Confirm Start", Then system shows appropriate error: 400 if invalid status, 404 if not found, 403 if wrong org or insufficient permissions</criterion>
    <criterion id="AC-4.2.5">API Endpoint: POST /api/production/work-orders/:id/start - No request body - Response 200: { data: { id, wo_number, status: 'in_progress', started_at, started_by_user_id, started_by_user: {name} }, message: "Work order started successfully" } - Error codes: INVALID_STATUS, NOT_FOUND, ORG_ISOLATION, FORBIDDEN</criterion>
    <criterion id="AC-4.2.6">Audit Trail: started_by_user_id stored on work_orders, started_at timestamp (server-side), updated_at auto-updated via trigger, audit info accessible via admin endpoint (future)</criterion>
    <criterion id="AC-4.2.7">Role-Based Authorization: Production Manager ✅, Operator ✅, Admin ✅ - Planner ❌, Quality Manager ❌, Other ❌ - 403 error for unauthorized roles with message "Insufficient permissions to start work orders"</criterion>
    <criterion id="AC-4.2.8">Modal Validation States: Loading (spinner, "Starting..."), Success (green checkmark, auto-close 1s), Error (red message, "Try Again"), Validating (disabled button)</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/epics/04-production.md</path>
        <title>Epic 4: Production Execution</title>
        <section>Story 4.2: WO Start</section>
        <snippet>Enable operators to start released work orders and transition them to "in_progress" status with proper validation and audit logging. Start modal with WO summary and confirmations, Status transition with proper validation, Timestamp recording (started_at), Audit trail (operator who started, timestamp), Real-time updates on dashboard (Story 4.1)</snippet>
      </doc>
      <doc>
        <path>docs/ux-design/ux-design-production-module.md</path>
        <title>Production Module UX Design</title>
        <section>WO Details Modal</section>
        <snippet>6 tabs: Overview (Status, Progress, Operations summary, Materials summary, Issues & Alerts), Operations (per-operation breakdown), Materials (BOM snapshot vs actual), Yield (trend chart), Trace (genealogy tree), History (audit log timeline). In-modal chat, Create Action Item button. Modal pattern consistent with other modals from Stories 3.1-3.8</snippet>
      </doc>
      <doc>
        <path>docs/ux-design/ux-design-shared-system.md</path>
        <title>Shared UI Design System</title>
        <section>Interaction Patterns - Notifications & Feedback</section>
        <snippet>Toast Notifications: Position center-bottom, Duration 3-5s auto-dismiss, Types: Success (green), Error (red), Warning (yellow), Info (blue). Loading States: Spinner in button while loading, Skeleton screens for tables, Progress bar for long operations. Inline Validation: Form fields show error state on blur/submit, Red border + error message below field</snippet>
      </doc>
    </docs>

    <code>
      <artifact>
        <path>apps/frontend/lib/supabase/migrations/028_create_work_orders_stub.sql</path>
        <kind>migration</kind>
        <symbol>work_orders table schema</symbol>
        <content>
          -- Work Orders Table columns relevant to Story 4.2:
          id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
          org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
          wo_number VARCHAR(50) NOT NULL UNIQUE,
          product_id UUID NOT NULL REFERENCES products(id) ON DELETE RESTRICT,
          planned_quantity DECIMAL(12,3) NOT NULL,
          produced_quantity DECIMAL(12,3) DEFAULT 0,
          uom VARCHAR(10) NOT NULL,
          status VARCHAR(20) NOT NULL DEFAULT 'draft',
          -- Values: draft, released, in_progress, completed, closed, cancelled
          planned_start_date DATE,
          planned_end_date DATE,
          actual_start_date DATE,
          actual_end_date DATE,
          production_line_id UUID REFERENCES machines(id) ON DELETE SET NULL,
          routing_id UUID,
          created_by UUID REFERENCES users(id),
          created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,
          updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,

          -- NOTE: Story 4.2 requires adding:
          -- started_at TIMESTAMP WITH TIME ZONE (when WO was started)
          -- started_by_user_id UUID REFERENCES users(id) (who started the WO)

          -- RLS Policies:
          -- SELECT: Users can view WOs in their organization
          -- INSERT: Production/Technical/Admin can create WOs
          -- UPDATE: Production/Technical/Admin can update WOs (needed for starting WO)
          -- DELETE: Admin only
        </content>
        <reason>Story 4.2 needs to verify/add started_at and started_by_user_id columns to work_orders table</reason>
      </artifact>
      <artifact>
        <path>apps/frontend/app/api/planning/dashboard/stats/route.ts</path>
        <kind>api-pattern</kind>
        <symbol>Dashboard API pattern for work_orders stats</symbol>
        <content>
          // Pattern for querying work_orders stats (lines 64-90):
          const { data: woData, error: woError } = await supabase
            .from('work_orders')
            .select('status, actual_end_date')
            .eq('org_id', org_id)

          const woStats = {
            total: woData.length,
            active: woData.filter((wo: any) => wo.status === 'in_progress').length,
            paused: woData.filter((wo: any) => wo.status === 'paused').length,
            completed_today: woData.filter((wo: any) =>
              wo.status === 'completed' && wo.actual_end_date && wo.actual_end_date.startsWith(today)
            ).length,
            released: woData.filter((wo: any) => wo.status === 'released').length,
          }

          // Story 4.2 should follow this pattern:
          // - Use createServerSupabase() from @/lib/supabase/server
          // - Extract org_id from session via auth.getUser() -> users table
          // - Query work_orders with .eq('org_id', org_id) for isolation
          // - Return NextResponse.json() with appropriate status codes
        </content>
        <reason>Story 4.2 API endpoint follows same org isolation and error handling pattern</reason>
      </artifact>
      <artifact>
        <path>apps/frontend/components/planning/WorkOrdersTable.tsx</path>
        <kind>component</kind>
        <symbol>Work Orders Table component (reusable)</symbol>
        <reason>Story 4.2 can reference this component for WO table patterns (status badges, action buttons, etc.)</reason>
      </artifact>
    </code>

    <dependencies>
      <node>
        <package name="@supabase/supabase-js" version="^2.84.0" usage="Supabase client for WO status updates and queries" />
        <package name="zod" version="^3.25.76" usage="Validation schemas for WO start request" />
        <package name="react-hook-form" version="^7.x" usage="Form state management in WOStartModal" />
      </node>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="architecture">Action Pattern - One-way operation endpoint (POST /api/production/work-orders/:id/start), not CRUD. Similar to cancel, pause, resume operations</constraint>
    <constraint type="business">Status validation - Only 'released' WOs can be started (not draft, not already in progress)</constraint>
    <constraint type="business">Timestamps - Server-side (not client) to ensure consistency. Use NOW() in SQL, not client-provided timestamp</constraint>
    <constraint type="business">Material check - Warning only (not blocking) - allows operators to start even with shortages. Calculation: available_qty = SUM(license_plates.qty) WHERE product = material.product AND status NOT IN ('consumed', 'discarded')</constraint>
    <constraint type="business">Audit trail - started_by_user_id + started_at stored on work_orders (not separate audit table yet). Audit record will be created in future audit_logs table</constraint>
    <constraint type="testing">Test pyramid - 95% unit (status transition, validation, timestamp), 70% integration (API endpoint, org isolation, role-based auth), 100% E2E (full workflow: navigate → modal → confirm → verify status change)</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>POST /api/production/work-orders/:id/start</name>
      <kind>API route</kind>
      <signature>
        POST /api/production/work-orders/:id/start
        Request Body: {} (empty - just :id in URL)
        Response 200: {
          data: {
            id: uuid,
            wo_number: string,          // "WO-20251127-0001"
            status: string,             // "in_progress"
            started_at: timestamp,      // "2025-11-27T10:30:00Z"
            started_by_user_id: uuid,
            started_by_user: {
              id: uuid,
              name: string              // "John Operator"
            }
          },
          message: "Work order started successfully"
        }
        Error Response 400/403/404: {
          error: string,                // "INVALID_STATUS" | "NOT_FOUND" | "ORG_ISOLATION" | "FORBIDDEN"
          message: string               // User-friendly message
        }
      </signature>
      <path>apps/frontend/app/api/production/work-orders/[id]/start/route.ts</path>
    </interface>
    <interface>
      <name>startWorkOrder</name>
      <kind>service method</kind>
      <signature>
        async function startWorkOrder(woId: string, userId: string, orgId: string): Promise&lt;WorkOrder&gt;
        - Validates: WO exists, org_id matches, status = 'released', user has Production/Manager/Admin role
        - Updates work_orders: status → 'in_progress', started_at → NOW(), started_by_user_id → userId
        - Returns: Updated WO object with started_by_user join
        - Throws: Error with code INVALID_STATUS, NOT_FOUND, ORG_ISOLATION, FORBIDDEN
      </signature>
      <path>apps/frontend/lib/services/production-wo-start-service.ts</path>
    </interface>
    <interface>
      <name>WOStartModal</name>
      <kind>React component</kind>
      <signature>
        interface WOStartModalProps {
          woId: string
          onSuccess: () => void
          onClose: () => void
        }
        - Displays: WO summary (number, product, quantity, scheduled date), Line/Machine (read-only), Material Availability (with warnings if shortage)
        - Buttons: Cancel (closes modal), Confirm Start (calls POST /api/production/work-orders/:id/start)
        - States: Loading (spinner, "Starting..."), Success (green checkmark, auto-close 1s), Error (red message, "Try Again")
      </signature>
      <path>apps/frontend/components/production/WOStartModal.tsx</path>
    </interface>
  </interfaces>

  <tests>
    <standards>Test Pyramid: unit tests (95%), integration tests (70%), E2E tests (100% critical paths)</standards>
    <locations>
      <location>apps/frontend/lib/services/__tests__/production-wo-start-service.test.ts</location>
      <location>apps/frontend/app/api/production/work-orders/[id]/start/__tests__/route.test.ts</location>
      <location>tests/e2e/production-wo-start.spec.ts</location>
    </locations>
    <ideas>
      <idea ac="AC-4.2.2">Unit test: startWorkOrder() with valid WO - status transitions from 'released' → 'in_progress', started_at timestamp set, started_by_user_id recorded</idea>
      <idea ac="AC-4.2.4">Unit test: startWorkOrder() with WO already in progress - throws error INVALID_STATUS</idea>
      <idea ac="AC-4.2.4">Unit test: startWorkOrder() with WO in draft status - throws error INVALID_STATUS</idea>
      <idea ac="AC-4.2.4">Unit test: startWorkOrder() with WO not found - throws error NOT_FOUND</idea>
      <idea ac="AC-4.2.4">Unit test: startWorkOrder() with wrong org_id - throws error ORG_ISOLATION</idea>
      <idea ac="AC-4.2.5">Integration test: POST /api/production/work-orders/:id/start (200) - returns updated WO with started_at and started_by_user</idea>
      <idea ac="AC-4.2.5">Integration test: POST /api/production/work-orders/:id/start with WO already in progress - returns 400 with error "Cannot start WO: Work Order is already in progress."</idea>
      <idea ac="AC-4.2.5">Integration test: POST /api/production/work-orders/:id/start with WO not released - returns 400 with error "Cannot start WO: Work Order is in Draft status. Release first."</idea>
      <idea ac="AC-4.2.7">Integration test: POST /api/production/work-orders/:id/start with insufficient role permissions - returns 403 with error "You don't have permission to start work orders."</idea>
      <idea ac="ALL">E2E test: Full workflow - create test WO in 'released' status, navigate to WO detail page, click "Start Production" button, verify modal opens with correct content, verify material shortage warning shows (if applicable), click Confirm Start, verify loading spinner shows, verify success toast shows, verify status changes to "In Progress", verify WO appears in dashboard "Active WOs" table</idea>
      <idea ac="AC-4.2.4">E2E test: Error scenario - click Start again on already started WO, verify error toast "Cannot start WO: Work Order is already in progress."</idea>
    </ideas>
  </tests>

  <learnings>
    <learning from="Story 4.1 (Production Dashboard)">Dashboard consumes 'started' WOs from GET /api/production/dashboard/active-wos. Story 4.2 must ensure WO appears in this endpoint after status transition to 'in_progress'</learning>
    <learning from="Story 3.10 (Work Order CRUD)">WO schema established with status field (draft, released, in_progress, completed, cancelled). WO queries and updates use org_id isolation pattern. Modal patterns from Story 3.10 create/edit flows can be reused for WOStartModal</learning>
    <learning from="Shared UI Design System">Modal pattern: consistent with other modals (PO/TO from Stories 3.1-3.8). Props: woId, onSuccess, onClose. Loading states: spinner in button, success toast, error toast with retry</learning>
  </learnings>

  <ux-design>
    <section name="WO Start Modal Layout">
      <content>
        ┌──────────────────────────────────────────────────────┐
        │ Start Work Order: WO-20251127-0001          [X Close] │
        ├──────────────────────────────────────────────────────┤
        │ WO Summary                                           │
        │   WO Number:      WO-20251127-0001                  │
        │   Product:        Flour 50kg                         │
        │   Quantity:       1000 kg                            │
        │   Scheduled Date: 2025-11-27                         │
        │                                                       │
        │ Line/Machine                                         │
        │   Production Line: Line A (Grinding & Mixing)       │
        │   Machine:         Machine A1                        │
        │                                                       │
        │ Material Availability                                │
        │   ⚠️ Material 'Flour': Need 100kg, have 80kg (80%)  │
        │   ✅ Material 'Salt': Need 10kg, have 15kg (150%)   │
        │   ⚠️ Material 'Sugar': Need 20kg, have 18kg (90%)   │
        │                                                       │
        │   Note: Shortages are warnings only. You can start  │
        │   production and add materials during execution.     │
        │                                                       │
        │ [Cancel]                    [Confirm Start ⏵]       │
        └──────────────────────────────────────────────────────┘

        States:
        - Loading: "Confirm Start" → "Starting..." with spinner
        - Success: Green checkmark, "Work order started successfully" toast, auto-close 1s
        - Error: Red error message, "Try Again" button
      </content>
    </section>
    <section name="Material Availability Calculation">
      <content>
        For each wo_materials entry:
        1. Get required_qty (from BOM snapshot in wo_materials table)
        2. Calculate available_qty:
           SELECT SUM(license_plates.qty)
           FROM license_plates
           WHERE product_id = wo_materials.product_id
             AND status NOT IN ('consumed', 'discarded')
             AND org_id = work_orders.org_id
        3. Calculate available_pct = (available_qty / required_qty) × 100%
        4. Display:
           - ✅ Green if available_pct >= 100%
           - ⚠️ Yellow if available_pct < 100%
           - Show: "Material 'Name': Need Xkg, have Ykg (Z%)"
      </content>
    </section>
    <section name="Color Palette (from Shared System)">
      <content>
        Primary Colors:
        - Create/CTA:     green-600   (#16a34a) - "Confirm Start" button
        - Secondary:      gray-600    (#4b5563) - "Cancel" button
        - Danger:         red-600     (#dc2626) - Error messages

        Status Badges:
        - Active/Confirmed: green-200 bg + green-800 text - "In Progress" status
        - Warning:          yellow-200 bg + yellow-800 text - Material shortage warnings
        - Error:            red-200 bg + red-800 text - Critical alerts

        Typography:
        - Modal title:     Text-xl (20px), Bold (700)
        - Section headers: Text-base (16px), SemiBold (600)
        - Body text:       Text-sm (14px), Regular (400)
        - Labels:          Text-xs (12px), Medium (500)

        Spacing:
        - Modal padding:   p-6 (24px all sides)
        - Section gap:     gap-4 (16px between sections)
        - Button gap:      gap-3 (12px between Cancel and Confirm)
      </content>
    </section>
  </ux-design>
</story-context>
