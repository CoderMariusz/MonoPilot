<story-context id="5-4-lp-number-generation" v="1.0">
  <metadata>
    <epicId>5</epicId>
    <storyId>4</storyId>
    <title>LP Number Generation</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-11-24</generatedAt>
    <template>Custom</template>
    <estimatedTokens>2500</estimatedTokens>
    <estimatedEffort>0.5 day</estimatedEffort>
  </metadata>

  <story>
    <asA>System</asA>
    <iWant>to auto-generate LP numbers</iWant>
    <soThat>they are unique and meaningful</soThat>
    <tasks>
      <task id="1" ac="AC-5.4.1">Auto-Generate Format - Default LP-{date}-{sequence} format (LP-20250124-0001)</task>
      <task id="2" ac="AC-5.4.2">Daily Sequence Reset - Reset sequence counter daily (per org)</task>
      <task id="3" ac="AC-5.4.3">Global Uniqueness - Ensure LP numbers are globally unique across org</task>
      <task id="4" ac="AC-5.4.4">Format Configuration - Admin can configure format in Settings (/settings/warehouse)</task>
      <task id="5" ac="AC-5.4.5">Manual Override - Allow manual LP number input in creation modal (validate uniqueness)</task>
      <task id="6" ac="ALL">Unit & Integration Tests - Generation tests, uniqueness tests, format config tests</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC-5.4.1">Given new LP is created, When lp_number not provided, Then auto-generate format: LP-{YYYYMMDD}-{sequence} (e.g., LP-20250124-0001)</criterion>
    <criterion id="AC-5.4.2">And sequence resets daily (per org): LP-20250124-0001, LP-20250124-0002, ..., LP-20250125-0001</criterion>
    <criterion id="AC-5.4.3">And LP numbers are globally unique across org (enforced by unique constraint)</criterion>
    <criterion id="AC-5.4.4">Admin can configure format in /settings/warehouse: prefix (default 'LP'), date format (YYYYMMDD), sequence length (4 digits)</criterion>
    <criterion id="AC-5.4.5">User can manually override LP number in creation modal (validated for uniqueness)</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/epics/epic-5-warehouse.md</path>
        <title>Epic 5: Warehouse & Scanner</title>
        <section>Story 5.4: LP Number Generation</section>
        <snippet>Auto-generate LP numbers: LP-{date}-{sequence}. Sequence per day, globally unique. Format configurable in warehouse_settings. Prerequisites: Story 5.1.</snippet>
      </doc>
    </docs>

    <code>
      <artifact>
        <path>lib/utils/lp-number-generator.ts</path>
        <kind>file</kind>
        <symbol>LP number generator</symbol>
        <reason>Story requires generateLPNumber() with configurable format and daily sequence</reason>
      </artifact>
      <artifact>
        <path>app/api/settings/warehouse</path>
        <kind>directory</kind>
        <symbol>Warehouse settings API</symbol>
        <reason>Story requires GET/PUT /api/settings/warehouse for LP number format configuration</reason>
      </artifact>
      <artifact>
        <path>components/settings/WarehouseSettingsPage.tsx</path>
        <kind>component</kind>
        <symbol>Warehouse settings page</symbol>
        <reason>Story requires UI for configuring LP number format (prefix, date format, sequence length)</reason>
      </artifact>
    </code>

    <dependencies>
      <node>
        <package name="date-fns" version="^4.1.0" usage="Date formatting for LP number generation (format(new Date(), 'yyyyMMdd'))" />
        <package name="@supabase/supabase-js" version="^2.84.0" usage="Supabase client for LP number queries and settings" />
      </node>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="business">Default format - LP-{YYYYMMDD}-{sequence} with daily reset</constraint>
    <constraint type="business">Sequence padding - 4 digits (0001, 0002, ...)</constraint>
    <constraint type="database">Unique constraint - lp_number unique per org</constraint>
    <constraint type="configuration">Format configurable - prefix, date format, sequence length stored in warehouse_settings</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>generateLPNumber</name>
      <kind>utility function</kind>
      <signature>async function generateLPNumber(orgId: string, format?: LPNumberFormat): Promise&lt;string&gt; - Generates unique LP number with configurable format and daily sequence</signature>
      <path>lib/utils/lp-number-generator.ts</path>
    </interface>
    <interface>
      <name>GET /api/settings/warehouse</name>
      <kind>API route</kind>
      <signature>GET /api/settings/warehouse - Response: { data: { lp_number_format: { prefix: string, date_format: string, sequence_length: number } } }</signature>
      <path>app/api/settings/warehouse/route.ts</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Testing strategy: unit tests for LP number generation (95% coverage), integration tests for settings API (70% coverage), E2E tests for format configuration (100% user flows).
    </standards>
    <locations>
      <location>lib/utils/__tests__/lp-number-generator.test.ts (Generation unit tests)</location>
      <location>app/api/settings/warehouse/__tests__/route.test.ts (Settings API integration tests)</location>
      <location>e2e/settings/warehouse-settings.e2e.ts (Format configuration E2E tests)</location>
    </locations>
    <ideas>
      <idea ac="AC-5.4.1">Unit test: generateLPNumber() with default format returns LP-20250124-0001</idea>
      <idea ac="AC-5.4.2">Unit test: generateLPNumber() on new day resets sequence to 0001</idea>
      <idea ac="AC-5.4.3">Unit test: generateLPNumber() enforces uniqueness (queries existing LPs)</idea>
      <idea ac="AC-5.4.4">Integration test: PUT /settings/warehouse updates LP number format</idea>
      <idea ac="AC-5.4.5">E2E test: Create LP without number, auto-generated number displayed</idea>
      <idea ac="AC-5.4.5">E2E test: Manually enter LP number, validation checks uniqueness</idea>
    </ideas>
  </tests>
</story-context>
