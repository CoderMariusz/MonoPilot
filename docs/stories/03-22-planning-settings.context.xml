<story-context id="3-22-planning-settings" v="1.0">
  <metadata>
    <epicId>3</epicId>
    <storyId>22</storyId>
    <title>Planning Settings Configuration</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-11-24</generatedAt>
    <template>Template C - Settings Pattern</template>
    <estimatedTokens>3000</estimatedTokens>
    <estimatedEffort>0.5 day</estimatedEffort>
  </metadata>

  <story>
    <asA>Admin</asA>
    <iWant>to configure Planning module settings</iWant>
    <soThat>PO/TO/WO behavior matches our process</soThat>
    <tasks>
      <task id="1" ac="AC-3.22.1">Planning Settings UI - Comprehensive settings page for PO/TO/WO configuration</task>
      <task id="2" ac="AC-3.22.2">PO Settings - Statuses, require_approval, field toggles</task>
      <task id="3" ac="AC-3.22.3">TO Settings - Statuses, allow_partial, require_lp_selection</task>
      <task id="4" ac="AC-3.22.4">WO Settings - Statuses, status_expiry, source_of_demand, material_check, copy_routing</task>
      <task id="5" ac="AC-3.22.5">API Routes - GET/PUT /api/planning/settings endpoints (same as Stories 3.5, 3.15)</task>
      <task id="6" ac="ALL">Unit & Integration Tests - Settings configuration tests</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC-3.22.1">Given Admin navigates to /settings/planning, Then can configure: PO (statuses, require_approval, field toggles), TO (statuses, allow_partial, require_lp_selection), WO (statuses, status_expiry, source_of_demand, material_check, copy_routing)</criterion>
    <criterion id="AC-3.22.2">All settings stored in planning_settings table with org_id isolation</criterion>
    <criterion id="AC-3.22.3">API: GET /api/planning/settings - Response: { data: PlanningSettings }; PUT /api/planning/settings - Request: { po_require_approval?, to_allow_partial?, wo_material_check?, ... }</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/epics/epic-3-planning.md</path>
        <title>Epic 3: Planning Operations</title>
        <section>Story 3.22: Planning Settings Configuration</section>
        <snippet>Configure Planning module settings. PO: statuses, require_approval, field toggles. TO: statuses, allow_partial, require_lp_selection. WO: statuses, status_expiry, source_of_demand, material_check, copy_routing. planning_settings table. Prerequisites: Epic 1.</snippet>
      </doc>
    </docs>

    <code>
      <artifact>
        <path>app/api/planning/settings</path>
        <kind>directory</kind>
        <symbol>Planning Settings API route</symbol>
        <reason>Story uses same endpoint as Stories 3.5, 3.15 for GET/PUT /api/planning/settings</reason>
      </artifact>
      <artifact>
        <path>app/settings/planning/page.tsx</path>
        <kind>page</kind>
        <symbol>Planning Settings page</symbol>
        <reason>Story requires comprehensive settings page for PO/TO/WO configuration</reason>
      </artifact>
    </code>

    <dependencies>
      <node>
        <package name="@supabase/supabase-js" version="^2.84.0" usage="Supabase client for settings CRUD" />
      </node>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="architecture">Template C Settings Pattern - centralized settings configuration</constraint>
    <constraint type="business">All settings stored in planning_settings table with org_id isolation</constraint>
    <constraint type="testing">Test pyramid - 95% unit, 70% integration, 100% E2E</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>GET /api/planning/settings</name>
      <kind>API route</kind>
      <signature>GET /api/planning/settings - Response: { data: PlanningSettings }</signature>
      <path>app/api/planning/settings/route.ts</path>
    </interface>
    <interface>
      <name>PUT /api/planning/settings</name>
      <kind>API route</kind>
      <signature>PUT /api/planning/settings - Request: { po_require_approval?, to_allow_partial?, wo_material_check?, ... } - Response: { data: PlanningSettings }</signature>
      <path>app/api/planning/settings/route.ts</path>
    </interface>
  </interfaces>

  <tests>
    <standards>Test Pyramid: unit tests (95%), integration tests (70%), E2E tests (100%)</standards>
    <locations>
      <location>app/api/planning/settings/__tests__/route.test.ts</location>
    </locations>
    <ideas>
      <idea ac="AC-3.22.3">Integration test: PUT /settings - updates all planning settings</idea>
    </ideas>
  </tests>
</story-context>
