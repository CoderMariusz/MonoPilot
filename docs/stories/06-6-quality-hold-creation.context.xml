<story-context id="6-6-quality-hold-creation" v="1.0">
  <metadata>
    <epicId>6</epicId>
    <storyId>6</storyId>
    <title>Quality Hold Creation</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-11-24</generatedAt>
    <template>Template A - CRUD Pattern</template>
    <estimatedTokens>5000</estimatedTokens>
    <estimatedEffort>1 day</estimatedEffort>
  </metadata>

  <story>
    <asA>QC user</asA>
    <iWant>to create quality holds on LPs</iWant>
    <soThat>problematic inventory is flagged</soThat>
    <tasks>
      <task id="1" ac="AC-6.6.1">Quality Holds Table Schema - quality_holds table with hold_reason, description, severity</task>
      <task id="2" ac="AC-6.6.2">Hold Creation Service - createQualityHold() with LP quarantine status update</task>
      <task id="3" ac="AC-6.6.3">Hold Number Generation - Auto-generate hold_number (QH-YYYYMMDD-NNNN)</task>
      <task id="4" ac="AC-6.6.4">API Route - POST /api/quality/holds endpoint</task>
      <task id="5" ac="AC-6.6.5">Hold Creation Modal - Modal for creating holds with reason, description, severity, notify_users</task>
      <task id="6" ac="AC-6.6.6">Validation - Zod schema for hold creation with required fields</task>
      <task id="7" ac="AC-6.6.7">LP Status Integration - Auto-update LP.qa_status → quarantine when hold created</task>
      <task id="8" ac="ALL">Unit & Integration Tests - Hold creation tests, LP status update tests</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC-6.6.1">Given QC user identifies issue, When clicking "Create Hold" on LP, Then modal opens with fields: hold_reason (required, dropdown + custom), description (required, text), severity (Low/Medium/High/Critical), notify_users (optional, multi-select)</criterion>
    <criterion id="AC-6.6.2">When saving, Then quality_hold created with hold_number (auto-generated QH-YYYYMMDD-NNNN), And LP.qa_status → quarantine, And LP blocked from use</criterion>
    <criterion id="AC-6.6.3">Hold reasons dropdown includes: Material Defect, Process Issue, Contamination, Damage, Labeling Error, Documentation Issue, Other (custom)</criterion>
    <criterion id="AC-6.6.4">Severity levels: Low (informational), Medium (minor issue), High (major issue), Critical (product safety/regulatory risk)</criterion>
    <criterion id="AC-6.6.5">API: POST /api/quality/holds - Request body: { lp_id: string, hold_reason: string, description: string, severity: string, notify_users?: string[] } - Response: { data: QualityHold } with status 201</criterion>
    <criterion id="AC-6.6.6">Service validates LP exists and belongs to org before creating hold</criterion>
    <criterion id="AC-6.6.7">Hold creation automatically updates LP.qa_status to 'quarantine' (atomic operation)</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/epics/epic-6-quality.md</path>
        <title>Epic 6: Quality Control & Compliance</title>
        <section>Story 6.6: Quality Hold Creation</section>
        <snippet>Create quality holds on LPs. Hold creation modal with hold_reason, description, severity, notify_users. quality_holds table. Auto-update LP.qa_status → quarantine. Prerequisites: Story 6.1.</snippet>
      </doc>
      <doc>
        <path>docs/TEMPLATE_LIBRARY_INDEX.md</path>
        <title>Template Library Index</title>
        <section>Template A: CRUD Pattern</section>
        <snippet>Standard CRUD pattern: Component → API Route → Service Layer → Database. POST/GET/PUT/DELETE endpoints. Zod validation on client and server.</snippet>
      </doc>
    </docs>

    <code>
      <artifact>
        <path>app/api/quality/holds</path>
        <kind>directory</kind>
        <symbol>Quality Holds API route location</symbol>
        <reason>Story requires creating route.ts for POST/GET /api/quality/holds endpoints</reason>
      </artifact>
      <artifact>
        <path>lib/services/quality-hold-service.ts</path>
        <kind>file</kind>
        <symbol>Quality Hold service layer</symbol>
        <reason>Story requires createQualityHold() method with LP quarantine status update</reason>
      </artifact>
      <artifact>
        <path>lib/validation/quality-hold-schemas.ts</path>
        <kind>file</kind>
        <symbol>Quality Hold Zod schemas</symbol>
        <reason>Story requires createQualityHoldSchema for validating hold creation input</reason>
      </artifact>
      <artifact>
        <path>components/quality/CreateHoldModal.tsx</path>
        <kind>component</kind>
        <symbol>CreateHoldModal</symbol>
        <reason>Story requires modal for creating quality holds with reason, description, severity, notify_users</reason>
      </artifact>
      <artifact>
        <path>lib/utils/generate-hold-number.ts</path>
        <kind>utility</kind>
        <symbol>Hold number generation utility</symbol>
        <reason>Story requires generateHoldNumber() function for auto-generating QH-YYYYMMDD-NNNN format</reason>
      </artifact>
    </code>

    <dependencies>
      <node>
        <package name="@supabase/supabase-js" version="^2.84.0" usage="Supabase client for quality hold CRUD operations" />
        <package name="zod" version="^3.25.76" usage="Validation schemas for quality hold creation" />
        <package name="react-hook-form" version="^7.66.1" usage="Form state management for hold creation modal" />
        <package name="next" version="^15.1.4" usage="Next.js framework with App Router for API routes" />
      </node>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="architecture">Template A CRUD Pattern - Component → API Route → Service Layer → Database</constraint>
    <constraint type="business">Hold number generation - auto-generate QH-YYYYMMDD-NNNN with daily sequence reset per org</constraint>
    <constraint type="business">LP status integration - creating hold MUST atomically update LP.qa_status to 'quarantine'</constraint>
    <constraint type="business">Multi-tenancy - all quality hold operations scoped by org_id</constraint>
    <constraint type="validation">Zod validation - required on BOTH client and server for hold creation input</constraint>
    <constraint type="validation">Parent validation - validate LP exists and belongs to org before creating hold</constraint>
    <constraint type="testing">Test pyramid - 95% unit coverage for hold service, 70% integration coverage, 100% E2E coverage</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>POST /api/quality/holds</name>
      <kind>API route</kind>
      <signature>POST /api/quality/holds - Request body: { lp_id: string, hold_reason: string, description: string, severity: 'Low'|'Medium'|'High'|'Critical', notify_users?: string[] } - Response: { data: QualityHold } or error 400</signature>
      <path>app/api/quality/holds/route.ts</path>
    </interface>
    <interface>
      <name>GET /api/quality/holds</name>
      <kind>API route</kind>
      <signature>GET /api/quality/holds?status=open&severity=High - Response: { data: QualityHold[] } - Supports filtering by status, severity, lp_id</signature>
      <path>app/api/quality/holds/route.ts</path>
    </interface>
    <interface>
      <name>createQualityHold</name>
      <kind>service function</kind>
      <signature>async function createQualityHold(input: CreateQualityHoldInput): Promise&lt;ServiceResult&lt;QualityHold&gt;&gt; - Creates hold, updates LP status to quarantine, generates hold_number</signature>
      <path>lib/services/quality-hold-service.ts</path>
    </interface>
    <interface>
      <name>generateHoldNumber</name>
      <kind>utility function</kind>
      <signature>async function generateHoldNumber(orgId: string): Promise&lt;string&gt; - Generates unique hold number in format QH-YYYYMMDD-NNNN</signature>
      <path>lib/utils/generate-hold-number.ts</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Testing strategy follows Test Pyramid: unit tests for quality hold service (95% coverage), integration tests for API route (70% coverage), E2E tests for hold creation flow (100% user flows). Mock Supabase in unit tests.
    </standards>
    <locations>
      <location>lib/services/__tests__/quality-hold-service.test.ts (Hold creation unit tests)</location>
      <location>app/api/quality/holds/__tests__/route.test.ts (API route integration tests)</location>
      <location>e2e/quality/hold-creation.e2e.ts (Hold creation flow E2E tests)</location>
    </locations>
    <ideas>
      <idea ac="AC-6.6.6">Unit test: createQualityHold() with invalid lp_id - returns error "LP not found"</idea>
      <idea ac="AC-6.6.2">Unit test: createQualityHold() with valid input - creates hold, updates LP.qa_status to quarantine</idea>
      <idea ac="AC-6.6.3">Unit test: Hold number generation follows QH-YYYYMMDD-NNNN format with daily sequence</idea>
      <idea ac="AC-6.6.5">Integration test: POST /holds with valid input - returns 201 with created hold</idea>
      <idea ac="AC-6.6.5">Integration test: POST /holds with missing required fields - returns 400 error</idea>
      <idea ac="AC-6.6.7">Integration test: Creating hold updates LP.qa_status to 'quarantine' atomically</idea>
      <idea ac="AC-6.6.1">E2E test: Click "Create Hold" on LP page, modal opens, submit, hold created</idea>
      <idea ac="AC-6.6.2">E2E test: After hold creation, LP status shows 'quarantine', LP blocked from use</idea>
    </ideas>
  </tests>
</story-context>
