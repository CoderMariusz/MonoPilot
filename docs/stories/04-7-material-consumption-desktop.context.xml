<story-context id="bmad/bmm/workflows/4-implementation/story-context/4-7-material-consumption-desktop" v="1.0">
  <metadata>
    <epicId>4</epicId>
    <storyId>7</storyId>
    <title>Material Consumption (Desktop)</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-11-24</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/epics/epic-4-production.md</sourceStoryPath>
    <template>Template H - Transaction Workflow</template>
    <estimatedTokens>5500</estimatedTokens>
    <estimatedEffort>1.5 days</estimatedEffort>
  </metadata>

  <story>
    <asA>Operator</asA>
    <iWant>to consume materials from desktop</iWant>
    <soThat>I can track what was used in production</soThat>
    <tasks>
      <task id="1" ac="AC-4.7.1">Materials Table Display - Show Product, Required Qty, Consumed Qty, Remaining for WO materials</task>
      <task id="2" ac="AC-4.7.2">Consume Material Modal - LP search/scan input, product/UoM/qty validation, qty to consume input</task>
      <task id="3" ac="AC-4.7.3">Transaction Workflow - Implement multi-step consumption using Template H pattern</task>
      <task id="4" ac="AC-4.7.4">LP Validation Steps - Validate product match, UoM match, qty available</task>
      <task id="5" ac="AC-4.7.5">Consumption Recording - Create consumption record with wo_id, material_id, lp_id, qty, timestamp</task>
      <task id="6" ac="AC-4.7.6">LP Qty Decrease - Atomically decrease LP qty, update status to consumed if qty = 0</task>
      <task id="7" ac="AC-4.7.7">Genealogy Record Creation - Link consumed LP to WO for traceability</task>
      <task id="8" ac="AC-4.7.8">Rollback Handlers - Implement rollback for consumption, LP update, genealogy on failure</task>
      <task id="9" ac="ALL">Unit & Integration Tests - Transaction workflow tests, rollback scenarios, validation tests</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC-4.7.1">Given user views WO consumption page, Then they see materials table with columns: Product, Required Qty, Consumed Qty, Remaining (Required - Consumed)</criterion>
    <criterion id="AC-4.7.2">When clicking "Consume" on a material, Then modal opens with LP search/scan input field</criterion>
    <criterion id="AC-4.7.3">System validates selected LP: product matches material, UoM matches, qty available >= requested consumption qty</criterion>
    <criterion id="AC-4.7.4">Operator enters qty to consume, system displays remaining LP qty after consumption</criterion>
    <criterion id="AC-4.7.5">When confirming consumption, Then system executes atomic transaction: (1) validate WO status = In Progress, (2) validate LP exists and sufficient qty, (3) create consumption record, (4) decrease LP qty, (5) update LP status if qty = 0, (6) create genealogy link</criterion>
    <criterion id="AC-4.7.6">And consumption is recorded in wo_consumptions table with wo_id, material_id, lp_id, consumed_qty, consumed_by, consumed_at</criterion>
    <criterion id="AC-4.7.7">And LP qty is decreased by consumed amount atomically (no negative stock allowed)</criterion>
    <criterion id="AC-4.7.8">And genealogy record is created linking consumed LP (parent) to WO for future output LPs (child)</criterion>
    <criterion id="AC-4.7.9">If ANY step in transaction fails (validation error, insufficient qty, FK violation), Then entire transaction is rolled back with NO partial updates and user sees specific error message</criterion>
    <criterion id="AC-4.7.10">Material consumption follows Template H Transaction Workflow pattern with rollback handlers for each step</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/epics/epic-4-production.md</path>
        <title>Epic 4: Production Execution</title>
        <section>Story 4.7: Material Consumption (Desktop)</section>
        <snippet>Desktop UI for material consumption from WOs. Displays materials table with required/consumed/remaining. Modal with LP search/scan, validation (product, UoM, qty), consumption recording, LP qty decrease, genealogy creation. Prerequisites: Story 3.12 (WO Materials), Epic 5 (License Plates).</snippet>
      </doc>
      <doc>
        <path>docs/templates/template-h-transaction-workflow.md</path>
        <title>Template H: Transaction Workflow Pattern</title>
        <section>Pattern Overview</section>
        <snippet>Multi-step business transactions with transaction safety (BEGIN/COMMIT/ROLLBACK), rollback handlers, status transitions, related record creation, inventory updates. TransactionStep interface with execute() and rollback() methods. Transaction executor with sequential step execution and reverse-order rollback on failure.</snippet>
      </doc>
      <doc>
        <path>docs/templates/template-h-transaction-workflow.md</path>
        <title>Template H: Transaction Workflow Pattern</title>
        <section>Example: Work Order Execution (Material Consumption)</section>
        <snippet>Complete example of material consumption workflow with steps: (1) validate WO in progress, (2) validate LPs exist and sufficient qty, (3) deduct LP qty, (4) record consumption, (5) update WO consumed quantities. Each step has execute() and rollback() handlers. Transaction pattern: executeTransaction({ steps, context }).</snippet>
      </doc>
      <doc>
        <path>docs/architecture/patterns/api.md</path>
        <title>API Architecture</title>
        <section>Error Handling - RFC 7807 Problem Details</section>
        <snippet>Structured error responses with type, title, status, detail, errors fields. APIError class with toProblemDetails() method. handleAPIError() function for consistent error formatting. Covers validation errors, not found, conflict, forbidden, rate limit, internal errors.</snippet>
      </doc>
      <doc>
        <path>docs/epics/epic-4-production.md</path>
        <title>Epic 4: Production Execution</title>
        <section>Story 4.11: Over-Consumption Control - AC: Transaction Atomicity</section>
        <snippet>Material consumption transaction flow with atomicity guarantees. Steps: (1) START transaction, (2) validate WO in progress, (3) validate LP qty, (4) check over-consumption limit, (5) INSERT consumption, (6) UPDATE LP qty, (7) UPDATE LP status if qty = 0, (8) INSERT movement, (9) UPDATE wo_materials, (10) CALCULATE variance, (11) COMMIT. Rollback scenarios with specific error messages. Concurrency handling with row locks (SELECT FOR UPDATE).</snippet>
      </doc>
    </docs>

    <code>
      <artifact>
        <path>app/api/production/work-orders/[id]/consume</path>
        <kind>directory</kind>
        <symbol>Material Consumption API route location</symbol>
        <reason>Story requires creating route.ts for POST /api/production/work-orders/:id/consume endpoint</reason>
      </artifact>
      <artifact>
        <path>lib/services/transaction-executor.ts</path>
        <kind>file</kind>
        <symbol>Transaction executor (Template H core)</symbol>
        <reason>Story requires using executeTransaction() from Template H for atomic consumption workflow</reason>
      </artifact>
      <artifact>
        <path>lib/services/consumption-workflow.ts</path>
        <kind>file</kind>
        <symbol>Material consumption workflow</symbol>
        <reason>Story requires creating consumeMaterialsWorkflow() implementing Template H pattern with steps: validate WO, validate LP, create consumption, update LP, create genealogy</reason>
      </artifact>
      <artifact>
        <path>lib/validation/consumption-schemas.ts</path>
        <kind>file</kind>
        <symbol>Consumption Zod schemas</symbol>
        <reason>Story requires consumeMaterialSchema for validating consumption request (wo_id, material_id, lp_id, consumed_qty)</reason>
      </artifact>
      <artifact>
        <path>components/production/MaterialsConsumptionTable.tsx</path>
        <kind>component</kind>
        <symbol>MaterialsConsumptionTable</symbol>
        <reason>Story requires table displaying Product, Required Qty, Consumed Qty, Remaining with "Consume" action button</reason>
      </artifact>
      <artifact>
        <path>components/production/ConsumeMaterialModal.tsx</path>
        <kind>component</kind>
        <symbol>ConsumeMaterialModal</symbol>
        <reason>Story requires modal with LP search/scan, product/UoM/qty validation display, qty to consume input, confirm/cancel buttons</reason>
      </artifact>
      <artifact>
        <path>lib/api/LicensePlatesAPI.ts</path>
        <kind>file</kind>
        <symbol>LicensePlatesAPI class</symbol>
        <reason>Story requires searchLPs() method for LP search by number/product in consumption modal</reason>
      </artifact>
      <artifact>
        <path>lib/services/genealogy-service.ts</path>
        <kind>file</kind>
        <symbol>Genealogy service</symbol>
        <reason>Story requires createGenealogyLink() method to link consumed LP (parent) to WO for traceability</reason>
      </artifact>
    </code>

    <dependencies>
      <node>
        <package name="@supabase/supabase-js" version="^2.84.0" usage="Supabase client for database transactions (consumption, LP updates, genealogy)" />
        <package name="@supabase/ssr" version="^0.7.0" usage="SSR helpers for Next.js (createServerClient for API routes)" />
        <package name="react-hook-form" version="^7.66.1" usage="Form state management for Consume Material modal (LP selection, qty input)" />
        <package name="zod" version="^3.25.76" usage="Validation schemas for consumption request (consumeMaterialSchema)" />
        <package name="@hookform/resolvers" version="^5.2.2" usage="Zod resolver for react-hook-form integration in modal" />
        <package name="next" version="^15.1.4" usage="Next.js framework with App Router for API routes (consume endpoint)" />
        <package name="react" version="^19.0.0" usage="React 19 for UI components (table, modal)" />
        <package name="lucide-react" version="^0.554.0" usage="Icons for table actions (consume icon), modal (search, scan, alert icons)" />
        <package name="@radix-ui/react-dialog" version="^1.1.15" usage="Dialog component for Consume Material modal" />
        <package name="@radix-ui/react-toast" version="^1.2.15" usage="Toast notifications for success/error messages after consumption" />
      </node>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="architecture">Template H Transaction Workflow - use executeTransaction() pattern with TransactionStep[] for atomic consumption</constraint>
    <constraint type="architecture">Next.js 15 App Router - use app/ directory structure, server components for table, client component for modal</constraint>
    <constraint type="business">Transaction atomicity - consumption, LP update, genealogy creation MUST be atomic (all-or-nothing)</constraint>
    <constraint type="business">Validation sequence - (1) WO status = In Progress, (2) LP exists + sufficient qty, (3) product match, (4) UoM match</constraint>
    <constraint type="database">Row-level locking - use SELECT ... FOR UPDATE on license_plates during consumption to prevent concurrent updates</constraint>
    <constraint type="database">Negative stock prevention - CHECK constraint on license_plates.qty >= 0, rollback transaction if violated</constraint>
    <constraint type="rollback">Rollback handlers required - each step (create consumption, update LP, create genealogy) must have rollback() method</constraint>
    <constraint type="validation">Zod validation - required on BOTH client and server for consumption request (consumeMaterialSchema)</constraint>
    <constraint type="ux">Shadcn/UI components - use Dialog, Table, Button, Input, Toast for consistency</constraint>
    <constraint type="ux">Modal layout - LP search input, validation status (green checkmarks for valid, red X for invalid), qty input with unit display, remaining qty calculation</constraint>
    <constraint type="testing">Test pyramid - 95% unit coverage for transaction workflow (mock Supabase), 70% integration coverage for API route, 100% E2E coverage for consumption flow</constraint>
    <constraint type="security">Authorization - verify user has Operator role or higher before allowing consumption</constraint>
    <constraint type="security">RLS policies - ensure org_id scoping on work_orders, license_plates, wo_consumptions tables</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>POST /api/production/work-orders/:id/consume</name>
      <kind>API route</kind>
      <signature>POST /api/production/work-orders/{wo_id}/consume - Request body: { material_id: string, lp_id: string, consumed_qty: number } - Response: { data: { consumption: WOConsumption, lp: LicensePlate } } or Problem Details error</signature>
      <path>app/api/production/work-orders/[id]/consume/route.ts</path>
    </interface>
    <interface>
      <name>consumeMaterialsWorkflow</name>
      <kind>transaction workflow function</kind>
      <signature>async function consumeMaterialsWorkflow(input: ConsumeMaterialInput): Promise&lt;{ success: boolean; data?: any; error?: string }&gt; - Executes Template H transaction with steps: validate_wo, validate_lp, create_consumption, update_lp_qty, update_wo_materials, create_genealogy. Each step has execute() and rollback().</signature>
      <path>lib/services/consumption-workflow.ts</path>
    </interface>
    <interface>
      <name>consumeMaterialSchema</name>
      <kind>Zod schema</kind>
      <signature>z.object({ wo_id: z.string().uuid(), material_id: z.string().uuid(), lp_id: z.string().uuid(), consumed_qty: z.number().positive() })</signature>
      <path>lib/validation/consumption-schemas.ts</path>
    </interface>
    <interface>
      <name>TransactionStep</name>
      <kind>TypeScript interface (Template H)</kind>
      <signature>interface TransactionStep { name: string; execute: (context: TransactionContext) =&gt; Promise&lt;StepResult&gt;; rollback?: (context: TransactionContext, result: StepResult) =&gt; Promise&lt;void&gt; }</signature>
      <path>lib/services/transaction-executor.ts</path>
    </interface>
    <interface>
      <name>executeTransaction</name>
      <kind>function (Template H core)</kind>
      <signature>async function executeTransaction(config: TransactionConfig): Promise&lt;{ success: boolean; data?: any; error?: string }&gt; - Executes steps sequentially, stores results, rolls back in reverse order on failure</signature>
      <path>lib/services/transaction-executor.ts</path>
    </interface>
    <interface>
      <name>MaterialsConsumptionTable</name>
      <kind>React component</kind>
      <signature>MaterialsConsumptionTable: FC&lt;{ woId: string, materials: WOMaterial[] }&gt; - Displays materials with Required Qty, Consumed Qty, Remaining, Consume button. Refreshes on consumption success.</signature>
      <path>components/production/MaterialsConsumptionTable.tsx</path>
    </interface>
    <interface>
      <name>ConsumeMaterialModal</name>
      <kind>React component</kind>
      <signature>ConsumeMaterialModal: FC&lt;{ woId: string, material: WOMaterial, open: boolean, onClose: () =&gt; void, onSuccess: () =&gt; void }&gt; - LP search input, validation display, qty input, confirm button. Calls consumeMaterialsWorkflow API.</signature>
      <path>components/production/ConsumeMaterialModal.tsx</path>
    </interface>
    <interface>
      <name>LicensePlatesAPI.searchLPs</name>
      <kind>API class method</kind>
      <signature>static async searchLPs(query: string, filters?: { product_id?: string, status?: string }): Promise&lt;LicensePlate[]&gt; - Searches LPs by number or product name, filters by product_id and status</signature>
      <path>lib/api/LicensePlatesAPI.ts</path>
    </interface>
    <interface>
      <name>createGenealogyLink</name>
      <kind>service function</kind>
      <signature>async function createGenealogyLink(parentLpId: string, woId: string): Promise&lt;ServiceResult&lt;GenealogyLink&gt;&gt; - Creates lp_genealogy record linking consumed LP (parent) to WO for future output LPs (child)</signature>
      <path>lib/services/genealogy-service.ts</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Testing strategy follows Test Pyramid: unit tests for transaction workflow (95% coverage, mock Supabase client with vitest, test each step's execute() and rollback()), integration tests for API route (70% coverage, Vitest + Supabase Test Client), E2E tests for complete consumption flow (100% user flows, Playwright). All tests in __tests__ directories colocated with source. Test files follow pattern: workflow.test.ts (unit), route.test.ts (integration), consumption-flow.e2e.ts (E2E). Fixtures in __fixtures__. Mock Supabase and transaction executor in unit tests.
    </standards>
    <locations>
      <location>lib/services/__tests__/consumption-workflow.test.ts (Transaction workflow unit tests with mocked Supabase)</location>
      <location>app/api/production/work-orders/[id]/consume/__tests__/route.test.ts (API route integration tests)</location>
      <location>components/production/__tests__/MaterialsConsumptionTable.test.tsx (Table component unit tests)</location>
      <location>components/production/__tests__/ConsumeMaterialModal.test.tsx (Modal component unit tests)</location>
      <location>e2e/production/material-consumption.e2e.ts (Complete consumption flow E2E tests)</location>
    </locations>
    <ideas>
      <idea ac="AC-4.7.3">Unit test: consumeMaterialsWorkflow validate_wo step - validates WO status = In Progress, rejects Draft/Released/Completed</idea>
      <idea ac="AC-4.7.3">Unit test: consumeMaterialsWorkflow validate_lp step - validates LP exists, sufficient qty, product match, UoM match</idea>
      <idea ac="AC-4.7.5">Unit test: consumeMaterialsWorkflow create_consumption step - creates wo_consumptions record with correct fields</idea>
      <idea ac="AC-4.7.6">Unit test: consumeMaterialsWorkflow update_lp_qty step - decreases LP qty atomically, sets status to consumed if qty = 0</idea>
      <idea ac="AC-4.7.7">Unit test: consumeMaterialsWorkflow create_genealogy step - creates genealogy link parent_lp_id = consumed LP, wo_id = current WO</idea>
      <idea ac="AC-4.7.8">Unit test: Rollback handler for create_consumption - deletes consumption record on failure</idea>
      <idea ac="AC-4.7.8">Unit test: Rollback handler for update_lp_qty - restores original LP qty on failure</idea>
      <idea ac="AC-4.7.9">Unit test: Transaction fails at step 3 (create_consumption) - rollback steps 1-2 executed, NO partial updates</idea>
      <idea ac="AC-4.7.9">Integration test: POST /consume with insufficient LP qty - returns 400 error "Insufficient qty on LP: has 10, need 15"</idea>
      <idea ac="AC-4.7.9">Integration test: POST /consume with WO not in progress - returns 400 error "Cannot consume: Work Order is not in progress"</idea>
      <idea ac="AC-4.7.5">Integration test: POST /consume with valid input - returns 200, consumption created, LP qty decreased, genealogy created</idea>
      <idea ac="AC-4.7.1">E2E test: Navigate to WO consumption page, see materials table with Required/Consumed/Remaining columns</idea>
      <idea ac="AC-4.7.2">E2E test: Click "Consume" on material, modal opens with LP search input</idea>
      <idea ac="AC-4.7.3">E2E test: Search for LP, select LP, system validates product/UoM match (green checkmarks displayed)</idea>
      <idea ac="AC-4.7.4">E2E test: Enter qty to consume, remaining LP qty calculated and displayed</idea>
      <idea ac="AC-4.7.6">E2E test: Confirm consumption, success toast shown, materials table refreshes with updated Consumed Qty</idea>
      <idea ac="AC-4.7.9">E2E test: Attempt to consume with insufficient LP qty, error toast "Insufficient qty" shown, NO consumption created</idea>
      <idea ac="AC-4.7.9">E2E test: Concurrent consumption - two operators consume same LP simultaneously, one succeeds, other gets error "LP qty changed by another user"</idea>
    </ideas>
  </tests>
</story-context>
