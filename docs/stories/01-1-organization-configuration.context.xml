<story-context id="bmad/bmm/workflows/4-implementation/story-context/1-1-organization-configuration" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>1.1</storyId>
    <title>Organization Configuration</title>
    <status>drafted</status>
    <generatedAt>2025-11-20</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/1-1-organization-configuration.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>Admin</asA>
    <iWant>to configure my organization's basic settings</iWant>
    <soThat>the system reflects my company's identity and preferences</soThat>
    <tasks>
      <task id="1" ac="001.1,001.3">Database Schema &amp; Migrations - Create organizations table with all required fields</task>
      <task id="2" ac="001.2">Supabase Storage Configuration - Setup organization-logos bucket with authenticated access</task>
      <task id="3" ac="001.1,001.2,001.3">API Endpoints - Implement GET/PUT /api/settings/organization and POST .../logo</task>
      <task id="4" ac="001.1,001.2,001.3,001.4">Zod Validation Schemas - Create UpdateOrganizationSchema and LogoUploadSchema</task>
      <task id="5" ac="001.1,001.3,001.4">Frontend Organization Settings Page - Create /app/settings/organization with 3-section form</task>
      <task id="6" ac="001.2,001.4">Logo Upload Component - File input with preview, validation, progress indicator</task>
      <task id="7" ac="ALL">Integration &amp; Testing - Unit/integration/E2E tests for complete flow</task>
      <task id="8">Documentation &amp; Cleanup - Type definitions, API docs, README updates</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC-001.1">User może wypełnić i zapisać organization form z wymaganymi polami: company_name (required, max 100 chars), address, city, postal_code, country, NIP/VAT number (optional)</criterion>
    <criterion id="AC-001.2">Logo upload akceptuje tylko jpg/png/webp, max 2MB, upload do Supabase Storage, zwraca signed URL</criterion>
    <criterion id="AC-001.3">Regional settings zapisywane i applied globally: timezone, default_currency (PLN/EUR/USD/GBP), default_language (PL/EN), date_format, number_format, unit_system (metric/imperial)</criterion>
    <criterion id="AC-001.4">Validation errors pokazywane inline on blur, success toast po zapisie. Form sections: Basic Data, Business Settings, Regional</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-1.md</path>
        <title>Epic 1 Technical Specification</title>
        <section>FR-SET-001: Organization Configuration</section>
        <snippet>Complete technical specification for Epic 1 Foundation &amp; Settings module. Contains authoritative acceptance criteria AC-001.1 through AC-001.4, data models (Organizations table with all fields), API endpoints (GET/PUT organization, POST logo), Zod schemas, NFRs (performance &lt;500ms, security with authenticated storage, 99.9% uptime), and integration requirements.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-1.md</path>
        <title>Epic 1 Technical Specification</title>
        <section>Data Models - Organizations Table</section>
        <snippet>TypeScript interface Organization with fields: id (UUID PK), company_name (string, required, max 100), logo_url (optional, Supabase Storage signed URL), street_address, city, postal_code, country, nip_vat_number, timezone (default UTC), default_currency (PLN), default_language (PL), fiscal_year_start (January), date_format, number_format, unit_system (metric), created_at, updated_at. No unique constraints beyond PK. Multi-tenancy via org_id isolation.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-1.md</path>
        <title>Epic 1 Technical Specification</title>
        <section>APIs and Interfaces - Organization Settings</section>
        <snippet>GET /api/settings/organization (Response: Organization, Auth: Authenticated). PUT /api/settings/organization (Body: UpdateOrganizationInput, Response: Organization, Auth: Admin only, Validation: Zod schema client + server). POST /api/settings/organization/logo (Body: FormData file, Response: { logo_url: string }, Auth: Admin only, Validation: Max 2MB jpg/png/webp, Storage: Supabase authenticated bucket signed URLs 1h TTL).</snippet>
      </doc>
      <doc>
        <path>docs/epics/epic-1-settings.md</path>
        <title>Epic 1: Foundation &amp; Settings</title>
        <section>Story 1.1: Organization Configuration</section>
        <snippet>User story with complete acceptance criteria: Admin navigates to /settings/organization, sees 3-section form (Basic Data, Business Settings, Regional), all fields validated (company_name required max 100, logo max 2MB jpg/png/webp, country/timezone/currency dropdowns), changes saved immediately with success toast, validation errors inline on blur. Technical notes: create organizations table, upload logo to Supabase storage, use react-hook-form with Zod, API GET/PUT.</snippet>
      </doc>
      <doc>
        <path>docs/prd/modules/settings.md</path>
        <title>PRD - Settings Module</title>
        <section>FR-SET-001: Organization Configuration</section>
        <snippet>Organization configuration allows Admin to set up company identity and operational defaults. Required fields: company_name, address. Optional: logo (uploaded to storage). Business settings include fiscal year start (affects reporting), regional settings (timezone/currency/language/formats affect all modules), unit system (metric vs imperial for production quantities). All settings stored in organizations table, applied globally across MonoPilot.</snippet>
      </doc>
      <doc>
        <path>docs/architecture/modules/settings.md</path>
        <title>Architecture - Settings Module</title>
        <section>Organization Settings Architecture</section>
        <snippet>Settings module is foundation for all other modules - provides org_id for multi-tenancy, user management for audit trails, master data (warehouses, locations, allergens, tax codes) consumed by Epics 2-8. Logo upload uses Supabase Storage authenticated bucket with signed URLs (1h TTL). Organization data cached 10 min (Upstash Redis). API layer enforces Admin-only access for mutations. Client-side + server-side Zod validation prevents invalid data. RLS policies ensure org_id isolation.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>supabase/migrations</path>
        <kind>directory</kind>
        <symbol>Database migrations location</symbol>
        <reason>Story requires creating organizations table migration here</reason>
      </artifact>
      <artifact>
        <path>app/api/settings/organization</path>
        <kind>directory</kind>
        <symbol>API routes</symbol>
        <reason>Story requires implementing route.ts for GET/PUT endpoints</reason>
      </artifact>
      <artifact>
        <path>app/api/settings/organization/logo</path>
        <kind>directory</kind>
        <symbol>API route</symbol>
        <reason>Story requires implementing route.ts for POST logo upload</reason>
      </artifact>
      <artifact>
        <path>app/settings/organization</path>
        <kind>directory</kind>
        <symbol>Frontend page</symbol>
        <reason>Story requires implementing page.tsx for organization settings UI</reason>
      </artifact>
      <artifact>
        <path>lib/validation/schemas.ts</path>
        <kind>file</kind>
        <symbol>Zod schemas</symbol>
        <reason>Story requires adding UpdateOrganizationSchema and LogoUploadSchema</reason>
      </artifact>
      <artifact>
        <path>components/settings</path>
        <kind>directory</kind>
        <symbol>Settings components</symbol>
        <reason>Story requires creating OrganizationForm.tsx and LogoUpload.tsx</reason>
      </artifact>
    </code>
    <dependencies>
      <node>
        <package name="@supabase/supabase-js" version="^2.x" usage="Database client, Storage client for logo uploads"/>
        <package name="react-hook-form" version="^7.x" usage="Form state management"/>
        <package name="zod" version="^3.x" usage="Validation schemas (client + server)"/>
        <package name="@hookform/resolvers" version="^3.x" usage="Zod resolver for react-hook-form"/>
        <package name="shadcn/ui" version="latest" usage="UI components (Form, Input, Select, Toast, Button)"/>
        <package name="sharp" version="^0.33.x" usage="Optional: image resizing on server (resize to 1024x1024)"/>
        <package name="world-countries" version="latest" usage="Country list for dropdown"/>
        <package name="date-fns-tz" version="^2.x" usage="Timezone list for dropdown"/>
      </node>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="architecture">Next.js 15 App Router - use app/ directory structure, server components by default, client components with 'use client' directive</constraint>
    <constraint type="architecture">Multi-tenancy via org_id from JWT - all org data must be isolated, RLS policies enforce separation</constraint>
    <constraint type="validation">Zod schemas required on BOTH client and server - prevent invalid data at all layers</constraint>
    <constraint type="security">Admin-only mutations - GET /api/settings/organization allows authenticated users, PUT requires Admin role check in middleware</constraint>
    <constraint type="storage">Supabase Storage authenticated bucket - logos NOT publicly accessible, signed URLs with 1h TTL</constraint>
    <constraint type="performance">Settings page load &lt;500ms p95 - critical for good UX, cache org data 10 min in Redis</constraint>
    <constraint type="testing">Test pyramid: 95% unit coverage, 70% integration, 100% E2E user flows - follow established patterns from Sprint 0</constraint>
    <constraint type="database">PostgreSQL 15 via Supabase - use migrations for schema changes, created_at/updated_at timestamps on all business tables</constraint>
    <constraint type="ui">Shadcn/UI components - use existing design system, maintain consistency with Settings module UX design</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>GET /api/settings/organization</name>
      <kind>REST endpoint</kind>
      <signature>GET /api/settings/organization → Response: Organization | null (200), Error (401/500)</signature>
      <path>app/api/settings/organization/route.ts</path>
    </interface>
    <interface>
      <name>PUT /api/settings/organization</name>
      <kind>REST endpoint</kind>
      <signature>PUT /api/settings/organization, Body: UpdateOrganizationInput → Response: Organization (200), ValidationError (400), Unauthorized (401/403), Error (500)</signature>
      <path>app/api/settings/organization/route.ts</path>
    </interface>
    <interface>
      <name>POST /api/settings/organization/logo</name>
      <kind>REST endpoint</kind>
      <signature>POST /api/settings/organization/logo, Body: FormData { file: File } → Response: { logo_url: string } (200), ValidationError (400), Unauthorized (401/403), Error (500)</signature>
      <path>app/api/settings/organization/logo/route.ts</path>
    </interface>
    <interface>
      <name>Organization</name>
      <kind>TypeScript interface</kind>
      <signature>interface Organization { id: string; company_name: string; logo_url?: string; street_address: string; city: string; postal_code: string; country: string; nip_vat_number?: string; timezone: string; default_currency: string; default_language: string; fiscal_year_start: string; date_format: string; number_format: string; unit_system: string; created_at: Date; updated_at: Date; }</signature>
      <path>lib/types/organization.ts (to be created)</path>
    </interface>
    <interface>
      <name>UpdateOrganizationSchema</name>
      <kind>Zod schema</kind>
      <signature>z.object({ company_name: z.string().min(1).max(100), logo: z.instanceof(File).refine(size &lt;= 2MB).refine(type in [jpg,png,webp]).optional(), country: z.enum([...]), timezone: z.string(), default_currency: z.enum(['PLN','EUR','USD','GBP']), default_language: z.enum(['PL','EN']), fiscal_year_start: z.enum(['January','April','July','October']), date_format: z.enum([...]), number_format: z.enum([...]), unit_system: z.enum(['metric','imperial']) })</signature>
      <path>lib/validation/schemas.ts</path>
    </interface>
    <interface>
      <name>OrganizationForm</name>
      <kind>React component</kind>
      <signature>OrganizationForm: FC&lt;{ organization?: Organization }&gt; - uses react-hook-form + Zod, 3 sections (Basic, Business, Regional), inline validation on blur, success/error toasts</signature>
      <path>components/settings/OrganizationForm.tsx (to be created)</path>
    </interface>
    <interface>
      <name>LogoUpload</name>
      <kind>React component</kind>
      <signature>LogoUpload: FC&lt;{ currentLogoUrl?: string; onUpload: (url: string) =&gt; void }&gt; - file input, preview, drag-drop, client validation, progress, error handling</signature>
      <path>components/settings/LogoUpload.tsx (to be created)</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Testing strategy follows Test Pyramid: 150 unit tests (95% coverage), 45 integration tests (70% coverage), 15 E2E tests (100% user flows). Use Vitest for unit/integration, Playwright for E2E. All tests in __tests__ directories colocated with source. Integration tests use Supabase Test Client for database. E2E tests run against local dev environment (pnpm dev). Test files follow pattern: ComponentName.spec.tsx (unit), api-route.test.ts (integration), user-flow.e2e.ts (E2E). Fixtures in __fixtures__. Mock Supabase Storage in tests.
    </standards>
    <locations>
      <location>lib/validation/__tests__/schemas.spec.ts (Zod schema unit tests)</location>
      <location>app/api/settings/__tests__/organization.test.ts (API integration tests)</location>
      <location>components/settings/__tests__/OrganizationForm.spec.tsx (component unit tests)</location>
      <location>e2e/settings/org-settings.e2e.ts (E2E user flow tests)</location>
    </locations>
    <ideas>
      <idea ac="AC-001.1">Unit test: UpdateOrganizationSchema validates required fields (company_name, address), rejects invalid (empty name, name >100 chars)</idea>
      <idea ac="AC-001.2">Unit test: LogoUploadSchema validates file size (reject 3MB), file type (reject .pdf, accept .jpg/.png/.webp)</idea>
      <idea ac="AC-001.2">Integration test: POST /api/settings/organization/logo uploads file to Supabase Storage, returns signed URL, updates organizations.logo_url</idea>
      <idea ac="AC-001.3">Integration test: PUT /api/settings/organization persists all regional settings, GET returns updated values</idea>
      <idea ac="AC-001.4">E2E test: Navigate to /settings/organization, fill form with invalid data (empty name), blur → see inline error, submit disabled</idea>
      <idea ac="AC-001.4">E2E test: Fill form with valid data, upload 2MB logo, submit → success toast, refresh page → data persisted, logo displayed</idea>
      <idea ac="AC-001.1">Integration test: Admin updates organization → success, non-Admin attempts PUT → 403 Forbidden</idea>
      <idea ac="AC-001.2">E2E test: Upload 3MB logo → client validation error shown, upload not attempted</idea>
      <idea ac="AC-001.3">Unit test: Country/timezone/currency dropdowns populated correctly, valid selections accepted</idea>
    </ideas>
  </tests>
</story-context>
