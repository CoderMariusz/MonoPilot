<story-context id="3-5-configurable-po-statuses" v="1.0">
  <metadata>
    <epicId>3</epicId>
    <storyId>5</storyId>
    <title>Configurable PO Statuses</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-11-24</generatedAt>
    <template>Template C - Settings Pattern</template>
    <estimatedTokens>3000</estimatedTokens>
    <estimatedEffort>0.5 day</estimatedEffort>
  </metadata>

  <story>
    <asA>Admin</asA>
    <iWant>to configure PO status workflow</iWant>
    <soThat>it matches our process</soThat>
    <tasks>
      <task id="1" ac="AC-3.5.1">PO Statuses Configuration UI - Settings page for adding/removing/renaming PO statuses</task>
      <task id="2" ac="AC-3.5.2">JSONB Storage - Store statuses in planning_settings.po_statuses JSONB field</task>
      <task id="3" ac="AC-3.5.3">Default Status Configuration - Set default status for new POs</task>
      <task id="4" ac="AC-3.5.4">API Routes - GET/PUT /api/planning/settings endpoints</task>
      <task id="5" ac="ALL">Unit & Integration Tests - Settings configuration tests</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC-3.5.1">Given Admin navigates to /settings/planning, When viewing PO Statuses, Then can add/remove/rename statuses And set default status for new POs</criterion>
    <criterion id="AC-3.5.2">Default statuses: Draft, Submitted, Confirmed, Receiving, Closed; Optional statuses: Approved, Partially Received, Cancelled</criterion>
    <criterion id="AC-3.5.3">Statuses stored in planning_settings.po_statuses JSONB field as array: [{ label: 'Draft', value: 'draft', is_default: true }, ...]</criterion>
    <criterion id="AC-3.5.4">API: GET /api/planning/settings - Response: { data: { po_statuses: [...], wo_statuses: [...], ... } }; PUT /api/planning/settings - Request: { po_statuses: [...] }</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/epics/epic-3-planning.md</path>
        <title>Epic 3: Planning Operations</title>
        <section>Story 3.5: Configurable PO Statuses</section>
        <snippet>Configure PO status workflow. Admin can add/remove/rename statuses, set default. Default: Draft, Submitted, Confirmed, Receiving, Closed. Optional: Approved, Partially Received, Cancelled. Stored in planning_settings.po_statuses JSONB. Prerequisites: Epic 1.</snippet>
      </doc>
    </docs>

    <code>
      <artifact>
        <path>app/api/planning/settings</path>
        <kind>directory</kind>
        <symbol>Planning Settings API route</symbol>
        <reason>Story requires route.ts for GET/PUT /api/planning/settings</reason>
      </artifact>
      <artifact>
        <path>app/settings/planning/page.tsx</path>
        <kind>page</kind>
        <symbol>Planning Settings page</symbol>
        <reason>Story requires settings page for configuring PO statuses</reason>
      </artifact>
    </code>

    <dependencies>
      <node>
        <package name="@supabase/supabase-js" version="^2.84.0" usage="Supabase client for settings CRUD" />
      </node>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="architecture">Template C Settings Pattern - JSONB storage for flexible configuration</constraint>
    <constraint type="business">PO statuses stored as JSONB array with label, value, is_default</constraint>
    <constraint type="testing">Test pyramid - 95% unit, 70% integration, 100% E2E</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>GET /api/planning/settings</name>
      <kind>API route</kind>
      <signature>GET /api/planning/settings - Response: { data: { po_statuses: array, wo_statuses: array, ... } }</signature>
      <path>app/api/planning/settings/route.ts</path>
    </interface>
  </interfaces>

  <tests>
    <standards>Test Pyramid: unit tests (95%), integration tests (70%), E2E tests (100%)</standards>
    <locations>
      <location>app/api/planning/settings/__tests__/route.test.ts</location>
    </locations>
    <ideas>
      <idea ac="AC-3.5.4">Integration test: PUT /settings with new PO status - updates planning_settings.po_statuses</idea>
    </ideas>
  </tests>
</story-context>
