<story-context id="6-2-qa-status-transition-rules" v="1.0">
  <metadata>
    <epicId>6</epicId>
    <storyId>2</storyId>
    <title>QA Status Transition Rules</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-11-24</generatedAt>
    <template>Custom</template>
    <estimatedTokens>3000</estimatedTokens>
    <estimatedEffort>0.5 day</estimatedEffort>
  </metadata>

  <story>
    <asA>System</asA>
    <iWant>to enforce QA status transitions</iWant>
    <soThat>invalid changes are prevented</soThat>
    <tasks>
      <task id="1" ac="AC-6.2.1">Transition Rules Definition - Define allowed state transitions for qa_status</task>
      <task id="2" ac="AC-6.2.2">State Machine Validator - isValidQATransition() function with transition matrix</task>
      <task id="3" ac="AC-6.2.3">Service Layer Integration - Integrate transition validation into updateQAStatus()</task>
      <task id="4" ac="AC-6.2.4">Manager Override - Allow Manager/Admin role to override passed → * transitions</task>
      <task id="5" ac="AC-6.2.5">Error Messages - Clear error messages for blocked transitions</task>
      <task id="6" ac="ALL">Unit & Integration Tests - Transition validation tests, override tests</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC-6.2.1">Given LP has qa_status, Then only these transitions allowed: pending → passed/failed/quarantine, quarantine → passed/failed, failed → quarantine (only), passed → no changes (except Manager override)</criterion>
    <criterion id="AC-6.2.2">When invalid transition attempted (e.g., passed → pending), Then system blocks with error message "Invalid QA status transition: passed → pending"</criterion>
    <criterion id="AC-6.2.3">Transition validation logic: isValidQATransition(from: QAStatus, to: QAStatus, userRole?: string) - Returns { valid: boolean, reason?: string }</criterion>
    <criterion id="AC-6.2.4">Manager override: Users with role = 'Manager' or 'Admin' can override 'passed' status to any other status (with mandatory reason)</criterion>
    <criterion id="AC-6.2.5">Blocked transition error includes: old status, new status, and helpful message explaining allowed transitions</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/epics/epic-6-quality.md</path>
        <title>Epic 6: Quality Control & Compliance</title>
        <section>Story 6.2: QA Status Transition Rules</section>
        <snippet>Enforce QA status transitions. State machine validation: pending → passed/failed/quarantine, quarantine → passed/failed, failed → quarantine only, passed → no changes (Manager override). Prerequisites: Story 6.1.</snippet>
      </doc>
    </docs>

    <code>
      <artifact>
        <path>lib/validation/qa-transition-rules.ts</path>
        <kind>file</kind>
        <symbol>QA transition validation logic</symbol>
        <reason>Story requires isValidQATransition() function with transition matrix and role-based override logic</reason>
      </artifact>
      <artifact>
        <path>lib/services/license-plate-service.ts</path>
        <kind>file</kind>
        <symbol>License Plate service</symbol>
        <reason>Story requires integrating transition validation into updateQAStatus() method</reason>
      </artifact>
      <artifact>
        <path>lib/types/qa-status.ts</path>
        <kind>file</kind>
        <symbol>QA status types</symbol>
        <reason>Story requires QATransitionResult type definition</reason>
      </artifact>
    </code>

    <dependencies>
      <node>
        <package name="zod" version="^3.25.76" usage="Validation schemas for QA status transitions" />
      </node>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="business">State machine - enforce transition rules (pending → passed/failed/quarantine, quarantine → passed/failed, failed → quarantine, passed → Manager override only)</constraint>
    <constraint type="business">Manager override - only Manager/Admin roles can override 'passed' status, with mandatory reason</constraint>
    <constraint type="validation">Transition validation - MUST occur BEFORE database update in updateQAStatus()</constraint>
    <constraint type="ux">Error messages - clear, specific error messages for blocked transitions explaining allowed transitions</constraint>
    <constraint type="testing">Test pyramid - 95% unit coverage for transition validation, 70% integration coverage</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>isValidQATransition</name>
      <kind>validation function</kind>
      <signature>function isValidQATransition(from: QAStatus, to: QAStatus, userRole?: string): { valid: boolean; reason?: string } - Validates QA status transition with role-based override logic</signature>
      <path>lib/validation/qa-transition-rules.ts</path>
    </interface>
    <interface>
      <name>QA_TRANSITION_MATRIX</name>
      <kind>constant</kind>
      <signature>const QA_TRANSITION_MATRIX: Record&lt;QAStatus, QAStatus[]&gt; - Defines allowed transitions for each QA status</signature>
      <path>lib/validation/qa-transition-rules.ts</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Testing strategy: comprehensive unit tests for all transition scenarios (95% coverage), integration tests for API route validation (70% coverage).
    </standards>
    <locations>
      <location>lib/validation/__tests__/qa-transition-rules.test.ts (Transition validation unit tests)</location>
      <location>lib/services/__tests__/license-plate-service.test.ts (updateQAStatus with transition validation)</location>
      <location>app/api/warehouse/license-plates/[id]/qa-status/__tests__/route.test.ts (API route with blocked transitions)</location>
    </locations>
    <ideas>
      <idea ac="AC-6.2.1">Unit test: isValidQATransition(pending → passed) - returns valid: true</idea>
      <idea ac="AC-6.2.1">Unit test: isValidQATransition(pending → failed) - returns valid: true</idea>
      <idea ac="AC-6.2.1">Unit test: isValidQATransition(passed → pending) - returns valid: false with reason</idea>
      <idea ac="AC-6.2.1">Unit test: isValidQATransition(failed → quarantine) - returns valid: true</idea>
      <idea ac="AC-6.2.1">Unit test: isValidQATransition(failed → passed) - returns valid: false</idea>
      <idea ac="AC-6.2.4">Unit test: isValidQATransition(passed → pending, role=Manager) - returns valid: true (override)</idea>
      <idea ac="AC-6.2.4">Unit test: isValidQATransition(passed → pending, role=User) - returns valid: false</idea>
      <idea ac="AC-6.2.2">Integration test: PUT /qa-status with invalid transition - returns 400 with clear error message</idea>
      <idea ac="AC-6.2.4">Integration test: Manager override passed → quarantine - succeeds with reason</idea>
    </ideas>
  </tests>
</story-context>
