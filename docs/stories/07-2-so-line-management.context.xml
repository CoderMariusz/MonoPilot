<story-context id="7-2-so-line-management" v="1.0">
  <metadata>
    <epicId>7</epicId>
    <storyId>2</storyId>
    <title>SO Line Management</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-11-24</generatedAt>
    <template>Template B - Line Items Pattern</template>
    <estimatedTokens>4500</estimatedTokens>
    <estimatedEffort>1 day</estimatedEffort>
  </metadata>

  <story>
    <asA>Sales user</asA>
    <iWant>to add products to sales orders</iWant>
    <soThat>I specify what to ship</soThat>
    <tasks>
      <task id="1" ac="AC-7.2.1">SO Lines Table Schema - so_lines table with product_id, ordered_qty, unit_price, line_total</task>
      <task id="2" ac="AC-7.2.2">SO Lines CRUD Service - addSOLine(), updateSOLine(), deleteSOLine() with parent validation</task>
      <task id="3" ac="AC-7.2.3">Line Total Calculation - Auto-calculate line_total = ordered_qty × unit_price × (1 - discount_percent/100)</task>
      <task id="4" ac="AC-7.2.4">SO Totals Update - Auto-update SO totals when lines added/updated/deleted</task>
      <task id="5" ac="AC-7.2.5">API Routes - POST/PUT/DELETE /api/shipping/sales-orders/:id/lines endpoints</task>
      <task id="6" ac="AC-7.2.6">SO Lines Table UI - Table displaying product, qty, price, discount, total with add/edit/delete actions</task>
      <task id="7" ac="AC-7.2.7">SO Line Form Modal - Modal for adding/editing SO lines with product, qty, price, discount</task>
      <task id="8" ac="ALL">Unit & Integration Tests - SO line CRUD tests, calculation tests, totals update tests</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC-7.2.1">Given SO is created, When adding a line, Then modal opens with fields: product_id (required, dropdown with search), quantity (required, number), unit_price (editable, pre-filled from product price), discount_percent (optional, 0-100)</criterion>
    <criterion id="AC-7.2.2">When saving line, Then line_total calculated as: ordered_qty × unit_price × (1 - discount_percent/100) And SO totals updated (subtotal, tax, total)</criterion>
    <criterion id="AC-7.2.3">Line has status field (same as SO status): draft, confirmed, picking, picked, packed, shipped</criterion>
    <criterion id="AC-7.2.4">API: POST /api/shipping/sales-orders/:id/lines - Request body: { product_id: string, ordered_qty: number, unit_price: number, discount_percent?: number } - Response: { data: SOLine } with status 201</criterion>
    <criterion id="AC-7.2.5">Service validates: SO exists and belongs to org, product exists and belongs to org, ordered_qty > 0, unit_price >= 0</criterion>
    <criterion id="AC-7.2.6">When SO lines change, SO totals auto-updated: subtotal (sum of line_total), tax (subtotal × tax_rate), total (subtotal + tax)</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/epics/epic-7-shipping.md</path>
        <title>Epic 7: Shipping & Order Fulfillment</title>
        <section>Story 7.3: SO Line Management</section>
        <snippet>Add products to sales orders. so_lines table with product_id, quantity, unit_price, discount_percent. Line total calculated. SO totals updated. Prerequisites: Story 7.1.</snippet>
      </doc>
      <doc>
        <path>docs/TEMPLATE_LIBRARY_INDEX.md</path>
        <title>Template Library Index</title>
        <section>Template B: Line Items Pattern</section>
        <snippet>Parent-child relationship (SO → SO Lines). API route: POST /lines. Service: validate parent, insert line. Pattern for PO Lines, BOM Items, ASN Items, SO Lines.</snippet>
      </doc>
    </docs>

    <code>
      <artifact>
        <path>app/api/shipping/sales-orders/[id]/lines</path>
        <kind>directory</kind>
        <symbol>SO Lines API route location</symbol>
        <reason>Story requires creating route.ts for POST/PUT/DELETE /api/shipping/sales-orders/:id/lines endpoints</reason>
      </artifact>
      <artifact>
        <path>lib/services/so-line-service.ts</path>
        <kind>file</kind>
        <symbol>SO Line service layer</symbol>
        <reason>Story requires addSOLine(), updateSOLine(), deleteSOLine() methods with parent and product validation</reason>
      </artifact>
      <artifact>
        <path>lib/validation/so-line-schemas.ts</path>
        <kind>file</kind>
        <symbol>SO Line Zod schemas</symbol>
        <reason>Story requires createSOLineSchema for validating SO line input</reason>
      </artifact>
      <artifact>
        <path>components/shipping/SOLinesTable.tsx</path>
        <kind>component</kind>
        <symbol>SOLinesTable</symbol>
        <reason>Story requires table displaying product, qty, price, discount, total with add/edit/delete actions</reason>
      </artifact>
      <artifact>
        <path>components/shipping/SOLineFormModal.tsx</path>
        <kind>component</kind>
        <symbol>SOLineFormModal</symbol>
        <reason>Story requires modal for adding/editing SO lines with product, qty, price, discount</reason>
      </artifact>
      <artifact>
        <path>lib/utils/calculate-line-total.ts</path>
        <kind>utility</kind>
        <symbol>Line total calculation utility</symbol>
        <reason>Story requires calculateLineTotal() function for line_total = qty × price × (1 - discount/100)</reason>
      </artifact>
      <artifact>
        <path>lib/services/sales-order-service.ts</path>
        <kind>file</kind>
        <symbol>Sales Order service</symbol>
        <reason>Story requires updateSOTotals() method to recalculate SO totals when lines change</reason>
      </artifact>
    </code>

    <dependencies>
      <node>
        <package name="@supabase/supabase-js" version="^2.84.0" usage="Supabase client for SO line CRUD operations" />
        <package name="zod" version="^3.25.76" usage="Validation schemas for SO line creation/update" />
        <package name="react-hook-form" version="^7.66.1" usage="Form state management for SO line form modal" />
        <package name="next" version="^15.1.4" usage="Next.js framework with App Router for API routes" />
      </node>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="architecture">Template B Line Items Pattern - parent-child relationship (SO → SO Lines)</constraint>
    <constraint type="business">Line total calculation - line_total = ordered_qty × unit_price × (1 - discount_percent/100)</constraint>
    <constraint type="business">SO totals update - auto-update SO subtotal, tax, total when lines change</constraint>
    <constraint type="business">Multi-tenancy - all SO line operations scoped by org_id via SO.org_id</constraint>
    <constraint type="validation">Parent validation - validate SO exists and belongs to org before line operations</constraint>
    <constraint type="validation">Product validation - validate product exists and belongs to org</constraint>
    <constraint type="validation">Zod validation - required on BOTH client and server for SO line input</constraint>
    <constraint type="testing">Test pyramid - 95% unit coverage for SO line service, 70% integration coverage, 100% E2E coverage</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>POST /api/shipping/sales-orders/:id/lines</name>
      <kind>API route</kind>
      <signature>POST /api/shipping/sales-orders/{so_id}/lines - Request body: { product_id: string, ordered_qty: number, unit_price: number, discount_percent?: number } - Response: { data: SOLine } or error 400</signature>
      <path>app/api/shipping/sales-orders/[id]/lines/route.ts</path>
    </interface>
    <interface>
      <name>GET /api/shipping/sales-orders/:id/lines</name>
      <kind>API route</kind>
      <signature>GET /api/shipping/sales-orders/{so_id}/lines - Response: { data: SOLine[] } - Returns all lines for a sales order</signature>
      <path>app/api/shipping/sales-orders/[id]/lines/route.ts</path>
    </interface>
    <interface>
      <name>addSOLine</name>
      <kind>service function</kind>
      <signature>async function addSOLine(soId: string, input: CreateSOLineInput): Promise&lt;ServiceResult&lt;SOLine&gt;&gt; - Validates SO and product, calculates line_total, updates SO totals</signature>
      <path>lib/services/so-line-service.ts</path>
    </interface>
    <interface>
      <name>calculateLineTotal</name>
      <kind>utility function</kind>
      <signature>function calculateLineTotal(qty: number, price: number, discountPercent: number = 0): number - Calculates line_total = qty × price × (1 - discount/100)</signature>
      <path>lib/utils/calculate-line-total.ts</path>
    </interface>
    <interface>
      <name>updateSOTotals</name>
      <kind>service function</kind>
      <signature>async function updateSOTotals(soId: string): Promise&lt;ServiceResult&gt; - Recalculates SO subtotal, tax, total based on all lines</signature>
      <path>lib/services/sales-order-service.ts</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Testing strategy follows Test Pyramid: unit tests for SO line service (95% coverage), integration tests for API route (70% coverage), E2E tests for SO line management flow (100% user flows). Mock Supabase in unit tests.
    </standards>
    <locations>
      <location>lib/services/__tests__/so-line-service.test.ts (SO line CRUD unit tests)</location>
      <location>app/api/shipping/sales-orders/[id]/lines/__tests__/route.test.ts (API route integration tests)</location>
      <location>e2e/shipping/so-line-management.e2e.ts (SO line management E2E tests)</location>
    </locations>
    <ideas>
      <idea ac="AC-7.2.5">Unit test: addSOLine() with invalid so_id - returns error "Sales order not found"</idea>
      <idea ac="AC-7.2.5">Unit test: addSOLine() with invalid product_id - returns error "Product not found"</idea>
      <idea ac="AC-7.2.2">Unit test: addSOLine() with valid input - creates line, calculates line_total correctly</idea>
      <idea ac="AC-7.2.3">Unit test: calculateLineTotal(10, 50, 10) - returns 450 (qty × price × 0.9)</idea>
      <idea ac="AC-7.2.6">Unit test: addSOLine() - updates SO totals (subtotal, tax, total)</idea>
      <idea ac="AC-7.2.4">Integration test: POST /lines with valid input - returns 201 with created line</idea>
      <idea ac="AC-7.2.4">Integration test: POST /lines with invalid SO - returns 404 error</idea>
      <idea ac="AC-7.2.1">E2E test: Click "Add Line" on SO page, modal opens, submit, line added to table</idea>
      <idea ac="AC-7.2.2">E2E test: Add line with discount, line_total calculated correctly, SO total updated</idea>
      <idea ac="AC-7.2.6">E2E test: Delete line, SO totals recalculated</idea>
    </ideas>
  </tests>
</story-context>
