<story-context id="bmad/bmm/workflows/4-implementation/story-context/4-6-wo-complete" v="1.0">
  <metadata>
    <epicId>4</epicId>
    <storyId>6</storyId>
    <title>WO Complete</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-11-24</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/epics/epic-4-production.md</sourceStoryPath>
    <template>Template H - Transaction Workflow</template>
    <estimatedTokens>5000</estimatedTokens>
    <estimatedEffort>1.5 days</estimatedEffort>
    <gapReference>Sprint 0 Gap 6 - Transaction Atomicity</gapReference>
  </metadata>

  <story>
    <asA>Operator</asA>
    <iWant>to complete a work order with validation and atomic operations</iWant>
    <soThat>I can finish production safely with data integrity guarantees</soThat>
    <tasks>
      <task id="1" ac="AC-4.6.1">Complete WO Modal - Display validation summary, confirm completion action</task>
      <task id="2" ac="AC-4.6.2">Transaction Workflow - Implement multi-step WO completion using Template H pattern with Transaction Atomicity (Sprint 0 Gap 6)</task>
      <task id="3" ac="AC-4.6.3">Validation Step - Verify all operations completed (if required), at least one output registered, by-products registered (if in BOM)</task>
      <task id="4" ac="AC-4.6.4">Status Transition - Update WO status from In Progress/Paused → Completed</task>
      <task id="5" ac="AC-4.6.5">Timestamp Recording - Set completed_at timestamp, completed_by_user_id</task>
      <task id="6" ac="AC-4.6.6">Operations Completion - Update all pending wo_operations.status → completed</task>
      <task id="7" ac="AC-4.6.7">LP Status Update - Update output LPs status from in_production → available</task>
      <task id="8" ac="AC-4.6.8">Genealogy Tree Insertion - Insert genealogy_tree records linking output LPs to consumed input LPs</task>
      <task id="9" ac="AC-4.6.9">Rollback Handlers - Implement rollback for each step on failure (all-or-nothing guarantee)</task>
      <task id="10" ac="AC-4.6.10">Concurrency Handling - Use row-level lock (SELECT FOR UPDATE) to prevent duplicate completion</task>
      <task id="11" ac="AC-4.6.11">Auto-Complete Logic - If enabled in settings, auto-complete when output_qty >= planned_qty</task>
      <task id="12" ac="ALL">Unit & Integration Tests - Transaction workflow tests, rollback scenarios, validation tests, concurrency tests</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC-4.6.1">Given WO is In Progress or Paused, When clicking "Complete WO", Then modal opens displaying completion validation summary (operations status, output status, by-products status)</criterion>
    <criterion id="AC-4.6.2">When confirming completion, Then system executes atomic transaction (Sprint 0 Gap 6): (1) START transaction, (2) VALIDATE pre-conditions, (3) UPDATE work_orders status, (4) UPDATE completed_at/completed_by, (5) UPDATE wo_operations status, (6) UPDATE output LPs status, (7) INSERT genealogy_tree records, (8) COMMIT transaction</criterion>
    <criterion id="AC-4.6.3">Validation pre-conditions (must ALL pass): WO status = in_progress or paused, All required operations completed (if enforce_operations = true), At least one output LP registered (output_qty > 0), All by-products registered (if by_products exist in BOM), No pending consumption corrections</criterion>
    <criterion id="AC-4.6.4">And WO status transitions from In Progress/Paused → Completed atomically</criterion>
    <criterion id="AC-4.6.5">And completed_at timestamp set to current UTC datetime, completed_by_user_id set to current user</criterion>
    <criterion id="AC-4.6.6">And all wo_operations with status != completed are updated to status = completed</criterion>
    <criterion id="AC-4.6.7">And all output LPs with status = in_production are updated to status = available</criterion>
    <criterion id="AC-4.6.8">And genealogy_tree records are inserted linking output LPs (child) to consumed input LPs (parent) for traceability</criterion>
    <criterion id="AC-4.6.9">Rollback Scenarios (Sprint 0 Gap 6): If ANY step fails (validation error, FK violation, update conflict), Then transaction ROLLBACK with NO partial updates (WO status unchanged, operations unchanged, LP status unchanged, no genealogy records), And error message displayed to user with specific failure reason</criterion>
    <criterion id="AC-4.6.10">Concurrency Handling: Use row-level lock (SELECT ... FOR UPDATE) on work_orders during completion to prevent duplicate completion if multiple operators click "Complete" simultaneously. If concurrent completion detected, error message: "WO #1234 is already being completed. Please refresh."</criterion>
    <criterion id="AC-4.6.11">Auto-Complete Feature: Given auto-complete enabled in production_settings, When output_qty >= planned_qty, Then system automatically completes WO without manual action</criterion>
    <criterion id="AC-4.6.12">Data Integrity Guarantees (Sprint 0 Gap 6): ✅ WO completed → All required operations completed, ✅ WO completed → At least one output LP exists, ✅ WO completed → All by-products registered (if BOM requires), ✅ WO completed → Genealogy tree created, ❌ NEVER: WO completed without output LPs, ❌ NEVER: WO completed with incomplete operations (if enforced), ❌ NEVER: Output LPs in in_production status after WO completion</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/epics/epic-4-production.md</path>
        <title>Epic 4: Production Execution</title>
        <section>Story 4.6: WO Complete - AC: Transaction Atomicity (Sprint 0 Gap 6)</section>
        <snippet>WO completion is atomic with all-or-nothing guarantee. Transaction flow: (1) START, (2) VALIDATE pre-conditions (WO in progress, operations completed, output registered, by-products registered), (3-7) UPDATE work_orders, operations, LP status, (8) INSERT genealogy_tree, (9) COMMIT. Rollback scenarios with specific error messages. Concurrency handling with row-level locks. Data integrity guarantees. Prerequisites: Story 4.2 (WO Start).</snippet>
      </doc>
      <doc>
        <path>docs/templates/template-h-transaction-workflow.md</path>
        <title>Template H: Transaction Workflow Pattern</title>
        <section>Pattern Overview</section>
        <snippet>Multi-step business transactions with transaction safety (BEGIN/COMMIT/ROLLBACK), rollback handlers, status transitions, related record creation. TransactionStep interface with execute() and rollback() methods. Transaction executor with sequential step execution and reverse-order rollback on failure. Atomic operations guarantee.</snippet>
      </doc>
      <doc>
        <path>docs/templates/template-h-transaction-workflow.md</path>
        <title>Template H: Transaction Workflow Pattern</title>
        <section>Transaction Executor (Core Pattern)</section>
        <snippet>executeTransaction() function executing steps sequentially, storing results in context.results for next steps. On failure, rolls back in reverse order using step.rollback() handlers. Returns { success: boolean, data?: any, error?: string }. Catches errors and ensures rollback even if rollback fails.</snippet>
      </doc>
      <doc>
        <path>docs/architecture/patterns/api.md</path>
        <title>API Architecture</title>
        <section>Error Handling - RFC 7807 Problem Details</section>
        <snippet>Structured error responses with type, title, status, detail, errors fields. APIError class with toProblemDetails() method. handleAPIError() function for consistent error formatting. Validation errors, not found, conflict, forbidden, rate limit, internal errors.</snippet>
      </doc>
      <doc>
        <path>.bmad/templates/ac-template-checklist.md</path>
        <title>AC Template Checklist</title>
        <section>§ 6: Transaction Atomicity</section>
        <snippet>For stories with multi-step transactions (consumption, output, completion), include: Transaction flow (START → steps → COMMIT), Rollback scenarios (IF ANY step fails → ROLLBACK), Specific error messages per failure point, Concurrency handling (row locks, duplicate prevention), Data integrity guarantees (what MUST be true, what NEVER happens). Reference template for Sprint 0 Gap 6 stories.</snippet>
      </doc>
    </docs>

    <code>
      <artifact>
        <path>app/api/production/work-orders/[id]/complete</path>
        <kind>directory</kind>
        <symbol>Complete WO API route location</symbol>
        <reason>Story requires creating route.ts for POST /api/production/work-orders/:id/complete endpoint</reason>
      </artifact>
      <artifact>
        <path>lib/services/transaction-executor.ts</path>
        <kind>file</kind>
        <symbol>Transaction executor (Template H core)</symbol>
        <reason>Story requires using executeTransaction() from Template H for atomic WO completion workflow</reason>
      </artifact>
      <artifact>
        <path>lib/services/wo-completion-workflow.ts</path>
        <kind>file</kind>
        <symbol>WO completion workflow</symbol>
        <reason>Story requires creating completeWorkOrderWorkflow() implementing Template H pattern with steps: validate_preconditions, update_wo_status, update_timestamps, complete_operations, update_lp_status, insert_genealogy_tree</reason>
      </artifact>
      <artifact>
        <path>lib/validation/wo-completion-schemas.ts</path>
        <kind>file</kind>
        <symbol>WO completion Zod schemas</symbol>
        <reason>Story requires completeWOSchema for validating completion request (wo_id, optional notes)</reason>
      </artifact>
      <artifact>
        <path>components/production/CompleteWorkOrderModal.tsx</path>
        <kind>component</kind>
        <symbol>CompleteWorkOrderModal</symbol>
        <reason>Story requires modal displaying validation summary (operations checklist, output status, by-products status), confirm/cancel buttons</reason>
      </artifact>
      <artifact>
        <path>lib/services/wo-validation-service.ts</path>
        <kind>file</kind>
        <symbol>WO validation service</symbol>
        <reason>Story requires validateWOCompletionPreconditions() method to check operations, outputs, by-products before completion</reason>
      </artifact>
      <artifact>
        <path>lib/services/genealogy-service.ts</path>
        <kind>file</kind>
        <symbol>Genealogy service</symbol>
        <reason>Story requires insertGenealogyTree() method to create genealogy_tree records linking consumed LPs to output LPs</reason>
      </artifact>
    </code>

    <dependencies>
      <node>
        <package name="@supabase/supabase-js" version="^2.84.0" usage="Supabase client for database transactions (WO status update, operations update, LP status update, genealogy insertion) with row-level locking" />
        <package name="@supabase/ssr" version="^0.7.0" usage="SSR helpers for Next.js (createServerClient for API routes)" />
        <package name="react-hook-form" version="^7.66.1" usage="Form state management for Complete WO modal (optional notes input)" />
        <package name="zod" version="^3.25.76" usage="Validation schemas for completion request (completeWOSchema)" />
        <package name="@hookform/resolvers" version="^5.2.2" usage="Zod resolver for react-hook-form integration in modal" />
        <package name="next" version="^15.1.4" usage="Next.js framework with App Router for API routes (complete endpoint)" />
        <package name="react" version="^19.0.0" usage="React 19 for UI components (modal, validation checklist)" />
        <package name="lucide-react" version="^0.554.0" usage="Icons for modal (check icon for valid, X icon for invalid, alert for warnings)" />
        <package name="@radix-ui/react-dialog" version="^1.1.15" usage="Dialog component for Complete WO modal" />
        <package name="@radix-ui/react-toast" version="^1.2.15" usage="Toast notifications for success/error messages after completion" />
      </node>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="architecture">Template H Transaction Workflow - use executeTransaction() pattern with TransactionStep[] for atomic WO completion (Sprint 0 Gap 6 requirement)</constraint>
    <constraint type="architecture">Next.js 15 App Router - use app/ directory structure, server components by default, client component for modal</constraint>
    <constraint type="business">Transaction atomicity (Sprint 0 Gap 6) - all steps (status update, timestamp, operations, LP status, genealogy) MUST be atomic (all-or-nothing)</constraint>
    <constraint type="business">Validation pre-conditions - ALL must pass: (1) WO in progress/paused, (2) operations completed (if enforced), (3) at least one output, (4) by-products registered (if required), (5) no pending corrections</constraint>
    <constraint type="database">Row-level locking (Sprint 0 Gap 6) - use SELECT ... FOR UPDATE on work_orders during completion to prevent concurrent completion</constraint>
    <constraint type="database">Concurrency handling - detect and reject duplicate completion attempts with error "WO already being completed. Please refresh."</constraint>
    <constraint type="rollback">Rollback handlers required (Sprint 0 Gap 6) - each step (update WO, update operations, update LPs, insert genealogy) must have rollback() method</constraint>
    <constraint type="business">Data integrity guarantees (Sprint 0 Gap 6) - ✅ WO completed → operations done + output exists + by-products registered + genealogy created. ❌ NEVER: WO completed without outputs or with incomplete operations (if enforced).</constraint>
    <constraint type="business">Auto-complete feature - if production_settings.auto_complete_wo = true AND output_qty >= planned_qty, auto-complete without manual action</constraint>
    <constraint type="validation">Zod validation - required on BOTH client and server for completion request (completeWOSchema)</constraint>
    <constraint type="ux">Shadcn/UI components - use Dialog, Checkbox (for validation checklist), Button, Toast for consistency</constraint>
    <constraint type="ux">Modal layout - validation summary section (operations checklist, output status, by-products status) with checkmarks/X icons, optional notes textarea, confirm/cancel buttons</constraint>
    <constraint type="testing">Test pyramid (Sprint 0 Gap 6) - 95% unit coverage for transaction workflow (test each step, rollback scenarios, validation), 70% integration coverage for API route (test concurrency, error cases), 100% E2E coverage for completion flow</constraint>
    <constraint type="security">Authorization - verify user has Operator role or higher before allowing WO completion</constraint>
    <constraint type="security">RLS policies - ensure org_id scoping on work_orders, wo_operations, license_plates, genealogy_tree tables</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>POST /api/production/work-orders/:id/complete</name>
      <kind>API route</kind>
      <signature>POST /api/production/work-orders/{wo_id}/complete - Request body: { notes?: string } - Response: { data: { wo: WorkOrder, completed_operations: number, updated_lps: number, genealogy_records: number } } or Problem Details error</signature>
      <path>app/api/production/work-orders/[id]/complete/route.ts</path>
    </interface>
    <interface>
      <name>completeWorkOrderWorkflow</name>
      <kind>transaction workflow function</kind>
      <signature>async function completeWorkOrderWorkflow(input: CompleteWOInput): Promise&lt;{ success: boolean; data?: any; error?: string }&gt; - Executes Template H transaction (Sprint 0 Gap 6) with steps: validate_preconditions, lock_wo_row, update_wo_status, update_timestamps, complete_operations, update_lp_status, insert_genealogy_tree. Each step has execute() and rollback().</signature>
      <path>lib/services/wo-completion-workflow.ts</path>
    </interface>
    <interface>
      <name>completeWOSchema</name>
      <kind>Zod schema</kind>
      <signature>z.object({ wo_id: z.string().uuid(), notes: z.string().max(500).optional() })</signature>
      <path>lib/validation/wo-completion-schemas.ts</path>
    </interface>
    <interface>
      <name>validateWOCompletionPreconditions</name>
      <kind>service function</kind>
      <signature>async function validateWOCompletionPreconditions(woId: string): Promise&lt;{ valid: boolean; errors: string[] }&gt; - Checks: (1) WO status in progress/paused, (2) operations completed (if required), (3) at least one output, (4) by-products registered (if required). Returns validation result with specific error messages.</signature>
      <path>lib/services/wo-validation-service.ts</path>
    </interface>
    <interface>
      <name>TransactionStep</name>
      <kind>TypeScript interface (Template H)</kind>
      <signature>interface TransactionStep { name: string; execute: (context: TransactionContext) =&gt; Promise&lt;StepResult&gt;; rollback?: (context: TransactionContext, result: StepResult) =&gt; Promise&lt;void&gt; }</signature>
      <path>lib/services/transaction-executor.ts</path>
    </interface>
    <interface>
      <name>executeTransaction</name>
      <kind>function (Template H core)</kind>
      <signature>async function executeTransaction(config: TransactionConfig): Promise&lt;{ success: boolean; data?: any; error?: string }&gt; - Executes steps sequentially, stores results, rolls back in reverse order on failure (Sprint 0 Gap 6 atomicity guarantee)</signature>
      <path>lib/services/transaction-executor.ts</path>
    </interface>
    <interface>
      <name>CompleteWorkOrderModal</name>
      <kind>React component</kind>
      <signature>CompleteWorkOrderModal: FC&lt;{ woId: string, open: boolean, onClose: () =&gt; void, onSuccess: () =&gt; void }&gt; - Displays validation summary (operations checklist, output status, by-products status) with check/X icons, optional notes textarea, confirm button (disabled if validation fails). Calls completeWorkOrderWorkflow API.</signature>
      <path>components/production/CompleteWorkOrderModal.tsx</path>
    </interface>
    <interface>
      <name>insertGenealogyTree</name>
      <kind>service function</kind>
      <signature>async function insertGenealogyTree(woId: string, outputLpIds: string[], consumedLpIds: string[]): Promise&lt;ServiceResult&lt;number&gt;&gt; - Inserts genealogy_tree records linking consumed LPs (parents) to output LPs (children) for traceability. Returns count of inserted records.</signature>
      <path>lib/services/genealogy-service.ts</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Testing strategy follows Test Pyramid with emphasis on Sprint 0 Gap 6 Transaction Atomicity: unit tests for transaction workflow (95% coverage, mock Supabase client with vitest, test each step's execute() and rollback(), test validation pre-conditions, test concurrency scenarios with mocked locks), integration tests for API route (70% coverage, Vitest + Supabase Test Client, test rollback scenarios with real database, test concurrent completion attempts), E2E tests for complete completion flow (100% user flows, Playwright). All tests in __tests__ directories colocated with source. Test files follow pattern: workflow.test.ts (unit), route.test.ts (integration), wo-completion-flow.e2e.ts (E2E). Fixtures in __fixtures__. Mock Supabase and transaction executor in unit tests.
    </standards>
    <locations>
      <location>lib/services/__tests__/wo-completion-workflow.test.ts (Transaction workflow unit tests with mocked Supabase, Sprint 0 Gap 6 rollback scenarios)</location>
      <location>lib/services/__tests__/wo-validation-service.test.ts (Validation pre-conditions unit tests)</location>
      <location>app/api/production/work-orders/[id]/complete/__tests__/route.test.ts (API route integration tests, concurrency tests)</location>
      <location>components/production/__tests__/CompleteWorkOrderModal.test.tsx (Modal component unit tests, validation display)</location>
      <location>e2e/production/wo-completion.e2e.ts (Complete WO completion flow E2E tests, Sprint 0 Gap 6 scenarios)</location>
    </locations>
    <ideas>
      <idea ac="AC-4.6.3">Unit test: validateWOCompletionPreconditions() with WO in Draft status - returns { valid: false, errors: ["WO must be in In Progress or Paused status"] }</idea>
      <idea ac="AC-4.6.3">Unit test: validateWOCompletionPreconditions() with no output registered - returns { valid: false, errors: ["At least one output LP must be registered"] }</idea>
      <idea ac="AC-4.6.3">Unit test: validateWOCompletionPreconditions() with incomplete operations (enforce = true) - returns { valid: false, errors: ["2 operations not completed: Cut, Mix"] }</idea>
      <idea ac="AC-4.6.3">Unit test: validateWOCompletionPreconditions() with missing by-products - returns { valid: false, errors: ["By-product 'Scrap Metal' not registered"] }</idea>
      <idea ac="AC-4.6.2">Unit test: completeWorkOrderWorkflow validate_preconditions step - validates all pre-conditions, rejects if any fail</idea>
      <idea ac="AC-4.6.4">Unit test: completeWorkOrderWorkflow update_wo_status step - updates status from In Progress → Completed</idea>
      <idea ac="AC-4.6.5">Unit test: completeWorkOrderWorkflow update_timestamps step - sets completed_at to current datetime, completed_by_user_id to user</idea>
      <idea ac="AC-4.6.6">Unit test: completeWorkOrderWorkflow complete_operations step - updates all pending wo_operations to status = completed</idea>
      <idea ac="AC-4.6.7">Unit test: completeWorkOrderWorkflow update_lp_status step - updates output LPs from in_production → available</idea>
      <idea ac="AC-4.6.8">Unit test: completeWorkOrderWorkflow insert_genealogy_tree step - inserts genealogy_tree records linking consumed LPs to output LPs</idea>
      <idea ac="AC-4.6.9">Unit test: Rollback handler for update_wo_status - restores original WO status on failure (Sprint 0 Gap 6)</idea>
      <idea ac="AC-4.6.9">Unit test: Rollback handler for update_lp_status - restores original LP status on failure (Sprint 0 Gap 6)</idea>
      <idea ac="AC-4.6.9">Unit test: Rollback handler for insert_genealogy_tree - deletes inserted genealogy records on failure (Sprint 0 Gap 6)</idea>
      <idea ac="AC-4.6.9">Unit test: Transaction fails at step 5 (update_lp_status) - rollback steps 1-4 executed, NO partial updates (Sprint 0 Gap 6)</idea>
      <idea ac="AC-4.6.10">Unit test: Row-level lock on work_orders during completion - uses SELECT ... FOR UPDATE to prevent concurrent completion</idea>
      <idea ac="AC-4.6.2">Integration test: POST /complete with valid WO (all validations pass) - returns 200, WO completed, operations updated, LPs updated, genealogy inserted (Sprint 0 Gap 6)</idea>
      <idea ac="AC-4.6.9">Integration test: POST /complete with WO missing output - returns 400 error "Cannot complete: No output has been registered", NO partial updates (Sprint 0 Gap 6)</idea>
      <idea ac="AC-4.6.9">Integration test: POST /complete with incomplete operations (enforce = true) - returns 400 error "Cannot complete: 2 operations not completed", NO partial updates (Sprint 0 Gap 6)</idea>
      <idea ac="AC-4.6.10">Integration test: Concurrent completion - two operators call POST /complete simultaneously on same WO, one succeeds, other gets error "WO already being completed. Please refresh." (Sprint 0 Gap 6 concurrency)</idea>
      <idea ac="AC-4.6.9">Integration test: Database error during genealogy insertion - entire transaction rolled back, WO status unchanged, operations unchanged, LP status unchanged (Sprint 0 Gap 6 rollback)</idea>
      <idea ac="AC-4.6.11">Integration test: Auto-complete enabled, output_qty >= planned_qty - WO auto-completes without manual action</idea>
      <idea ac="AC-4.6.1">E2E test: Navigate to WO detail page (In Progress), click "Complete WO", modal opens with validation summary (operations, outputs, by-products)</idea>
      <idea ac="AC-4.6.3">E2E test: Complete WO modal displays validation checklist with green checkmarks for valid items, red X for invalid items</idea>
      <idea ac="AC-4.6.4">E2E test: Confirm completion in modal, success toast shown, WO status transitions to Completed on WO detail page</idea>
      <idea ac="AC-4.6.9">E2E test: Attempt to complete WO without output registered, modal displays error "At least one output LP must be registered", confirm button disabled (Sprint 0 Gap 6 validation)</idea>
      <idea ac="AC-4.6.10">E2E test: Two operators attempt to complete same WO simultaneously, one succeeds, other sees error toast "WO already being completed. Please refresh." (Sprint 0 Gap 6 concurrency)</idea>
      <idea ac="AC-4.6.12">E2E test: After completion, verify data integrity: WO status = Completed, operations status = completed, output LPs status = available, genealogy_tree records exist (Sprint 0 Gap 6 guarantees)</idea>
    </ideas>
  </tests>
</story-context>
