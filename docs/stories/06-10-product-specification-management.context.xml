<story-context id="6-10-product-specification-management" v="1.0">
  <metadata>
    <epicId>6</epicId>
    <storyId>10</storyId>
    <title>Product Specification Management</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-11-24</generatedAt>
    <template>Template B - Line Items Pattern</template>
    <estimatedTokens>4500</estimatedTokens>
    <estimatedEffort>1.5 days</estimatedEffort>
  </metadata>

  <story>
    <asA>QC user</asA>
    <iWant>to define specifications per product</iWant>
    <soThat>test limits are clear</soThat>
    <tasks>
      <task id="1" ac="AC-6.10.1">Product Specifications Table Schema - product_specifications table with test_name, spec_type, min/max/expected values</task>
      <task id="2" ac="AC-6.10.2">Specifications CRUD Service - addProductSpec(), updateProductSpec(), deleteProductSpec() with parent validation</task>
      <task id="3" ac="AC-6.10.3">API Routes - POST/PUT/DELETE /api/quality/specifications endpoints</task>
      <task id="4" ac="AC-6.10.4">Specifications Tab UI - Product detail page with Specifications tab showing spec list</task>
      <task id="5" ac="AC-6.10.5">Spec Form Modal - Modal for adding/editing specs with test_name, spec_type, limits, test_method</task>
      <task id="6" ac="AC-6.10.6">Validation - Zod schema for spec creation with conditional validation by spec_type</task>
      <task id="7" ac="ALL">Unit & Integration Tests - Spec CRUD tests, parent validation tests, conditional validation tests</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC-6.10.1">Given viewing product detail, When navigating to Specifications tab, Then can add specs with fields: test_name (required, e.g., "pH", "Moisture %"), spec_type (numeric/text/boolean), min_value + max_value (for numeric), expected_value (for text/boolean), is_required (toggle), test_method (optional text)</criterion>
    <criterion id="AC-6.10.2">Spec types: 'numeric' (min/max range validation), 'text' (exact match or regex), 'boolean' (pass/fail checkbox)</criterion>
    <criterion id="AC-6.10.3">When saving spec, Then linked to product And shown in spec list And available for test result entry</criterion>
    <criterion id="AC-6.10.4">API: POST /api/quality/specifications - Request body: { product_id: string, test_name: string, spec_type: 'numeric'|'text'|'boolean', min_value?: number, max_value?: number, expected_value?: string, is_required: boolean, test_method?: string } - Response: { data: ProductSpecification } with status 201</criterion>
    <criterion id="AC-6.10.5">Service validates product exists and belongs to org before adding spec</criterion>
    <criterion id="AC-6.10.6">Conditional validation: spec_type=numeric requires min_value OR max_value, spec_type=text/boolean requires expected_value</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/epics/epic-6-quality.md</path>
        <title>Epic 6: Quality Control & Compliance</title>
        <section>Story 6.10: Product Specification Management</section>
        <snippet>Define specifications per product. product_specifications table with test_name, spec_type (numeric/text/boolean), min/max/expected values, is_required, test_method. Prerequisites: Epic 2 (Products).</snippet>
      </doc>
      <doc>
        <path>docs/TEMPLATE_LIBRARY_INDEX.md</path>
        <title>Template Library Index</title>
        <section>Template B: Line Items Pattern</section>
        <snippet>Parent-child relationship (Product → Product Specifications). API route: POST /specifications. Service: validate parent, insert line. Pattern for PO Lines, BOM Items, ASN Items, Product Specs.</snippet>
      </doc>
    </docs>

    <code>
      <artifact>
        <path>app/api/quality/specifications</path>
        <kind>directory</kind>
        <symbol>Product Specifications API route location</symbol>
        <reason>Story requires creating route.ts for POST/PUT/DELETE /api/quality/specifications endpoints</reason>
      </artifact>
      <artifact>
        <path>lib/services/product-specification-service.ts</path>
        <kind>file</kind>
        <symbol>Product Specification service layer</symbol>
        <reason>Story requires addProductSpec(), updateProductSpec(), deleteProductSpec() methods with parent validation</reason>
      </artifact>
      <artifact>
        <path>lib/validation/product-spec-schemas.ts</path>
        <kind>file</kind>
        <symbol>Product Specification Zod schemas</symbol>
        <reason>Story requires createProductSpecSchema with conditional validation by spec_type</reason>
      </artifact>
      <artifact>
        <path>components/quality/ProductSpecsTable.tsx</path>
        <kind>component</kind>
        <symbol>ProductSpecsTable</symbol>
        <reason>Story requires table displaying product specs with add/edit/delete actions</reason>
      </artifact>
      <artifact>
        <path>components/quality/ProductSpecFormModal.tsx</path>
        <kind>component</kind>
        <symbol>ProductSpecFormModal</symbol>
        <reason>Story requires modal for adding/editing specs with test_name, spec_type, limits, test_method</reason>
      </artifact>
    </code>

    <dependencies>
      <node>
        <package name="@supabase/supabase-js" version="^2.84.0" usage="Supabase client for product spec CRUD operations" />
        <package name="zod" version="^3.25.76" usage="Validation schemas with conditional validation by spec_type" />
        <package name="react-hook-form" version="^7.66.1" usage="Form state management for spec form modal" />
        <package name="next" version="^15.1.4" usage="Next.js framework with App Router for API routes" />
      </node>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="architecture">Template B Line Items Pattern - parent-child relationship (Product → Product Specifications)</constraint>
    <constraint type="business">Parent validation - validate product exists and belongs to org before spec operations</constraint>
    <constraint type="business">Spec types - numeric (min/max range), text (exact match or regex), boolean (pass/fail)</constraint>
    <constraint type="validation">Conditional validation - spec_type=numeric requires min_value OR max_value, spec_type=text/boolean requires expected_value</constraint>
    <constraint type="validation">Zod validation - required on BOTH client and server for spec input</constraint>
    <constraint type="business">Multi-tenancy - all spec operations scoped by org_id via product.org_id</constraint>
    <constraint type="testing">Test pyramid - 95% unit coverage for spec service, 70% integration coverage, 100% E2E coverage</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>POST /api/quality/specifications</name>
      <kind>API route</kind>
      <signature>POST /api/quality/specifications - Request body: { product_id: string, test_name: string, spec_type: 'numeric'|'text'|'boolean', min_value?: number, max_value?: number, expected_value?: string, is_required: boolean, test_method?: string } - Response: { data: ProductSpecification } or error 400</signature>
      <path>app/api/quality/specifications/route.ts</path>
    </interface>
    <interface>
      <name>GET /api/quality/specifications</name>
      <kind>API route</kind>
      <signature>GET /api/quality/specifications?product_id=X - Response: { data: ProductSpecification[] } - Returns all specs for a product</signature>
      <path>app/api/quality/specifications/route.ts</path>
    </interface>
    <interface>
      <name>addProductSpec</name>
      <kind>service function</kind>
      <signature>async function addProductSpec(input: CreateProductSpecInput): Promise&lt;ServiceResult&lt;ProductSpecification&gt;&gt; - Validates product exists, adds spec with conditional validation</signature>
      <path>lib/services/product-specification-service.ts</path>
    </interface>
    <interface>
      <name>updateProductSpec</name>
      <kind>service function</kind>
      <signature>async function updateProductSpec(specId: string, input: UpdateProductSpecInput): Promise&lt;ServiceResult&lt;ProductSpecification&gt;&gt; - Updates spec fields with conditional validation</signature>
      <path>lib/services/product-specification-service.ts</path>
    </interface>
    <interface>
      <name>deleteProductSpec</name>
      <kind>service function</kind>
      <signature>async function deleteProductSpec(specId: string): Promise&lt;ServiceResult&gt; - Deletes product specification</signature>
      <path>lib/services/product-specification-service.ts</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Testing strategy follows Test Pyramid: unit tests for product spec service (95% coverage), integration tests for API route (70% coverage), E2E tests for spec management flow (100% user flows). Mock Supabase in unit tests.
    </standards>
    <locations>
      <location>lib/services/__tests__/product-specification-service.test.ts (Spec CRUD unit tests)</location>
      <location>app/api/quality/specifications/__tests__/route.test.ts (API route integration tests)</location>
      <location>e2e/quality/product-spec-management.e2e.ts (Spec management E2E tests)</location>
    </locations>
    <ideas>
      <idea ac="AC-6.10.5">Unit test: addProductSpec() with invalid product_id - returns error "Product not found"</idea>
      <idea ac="AC-6.10.2">Unit test: addProductSpec() with spec_type=numeric and min/max - creates spec</idea>
      <idea ac="AC-6.10.6">Unit test: addProductSpec() with spec_type=numeric but no min/max - returns validation error</idea>
      <idea ac="AC-6.10.6">Unit test: addProductSpec() with spec_type=text and expected_value - creates spec</idea>
      <idea ac="AC-6.10.4">Integration test: POST /specifications with valid numeric spec - returns 201 with created spec</idea>
      <idea ac="AC-6.10.4">Integration test: POST /specifications with invalid conditional validation - returns 400 error</idea>
      <idea ac="AC-6.10.1">E2E test: Navigate to product Specifications tab, add spec, spec appears in table</idea>
      <idea ac="AC-6.10.3">E2E test: Edit spec, update test_name and limits, changes saved</idea>
      <idea ac="AC-6.10.2">E2E test: Delete spec, spec removed from table</idea>
    </ideas>
  </tests>
</story-context>
