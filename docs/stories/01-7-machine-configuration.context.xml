<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>1.7</storyId>
    <title>Machine Configuration</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-11-20</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/1-7-machine-configuration.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>Admin</asA>
    <iWant>define production machines</iWant>
    <soThat>I can track which machines are used in production</soThat>
    <tasks>
      - Task 1: Database Schema - Machines & Assignments Tables (with RLS, machine_line_assignments join table)
      - Task 2: Machine Service - Core Logic (create, update, get, delete with constraints)
      - Task 3: Zod Validation Schemas (CreateMachineSchema with status enum and line_ids array)
      - Task 4: API Endpoints (GET, POST, PUT, DELETE for /api/settings/machines)
      - Task 5: Frontend Machines List Page (/settings/production → Machines tab)
      - Task 6: Machine Form Modal (with status dropdown and multi-select lines)
      - Task 7: Machine Status Change (with active WO warnings)
      - Task 8: Machine Detail Page (with assigned lines and WO links)
      - Task 9: Line Assignment Management (many-to-many bidirectional sync)
      - Task 10: Cache Invalidation & Events (machine.updated for Epic 4)
      - Task 11: Integration & Testing (Unit, Integration, E2E tests)
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC-006.1">
      <title>Admin może stworzyć machine</title>
      <details>
        - Navigate to /settings/production → "Machines" tab
        - Form fields: code (required, unique per org, uppercase alphanumeric + hyphens), name (required, max 100 chars), status (dropdown: Active, Down, Maintenance, default Active), capacity_per_hour (optional, decimal), line_ids (multi-select dropdown, optional)
        - Validation: code unique constraint checked
        - On save: machine created, line assignments saved in machine_line_assignments table
      </details>
    </criterion>

    <criterion id="AC-006.2">
      <title>Machine status affects availability</title>
      <details>
        - Active: Available for WO assignment (Epic 4)
        - Down: Not available, show warning if assigned to active WOs
        - Maintenance: Scheduled unavailability, show maintenance schedule
        - Status change triggers validation: warn if has active WOs
        - Status badge color: Active (green), Down (red), Maintenance (yellow)
      </details>
    </criterion>

    <criterion id="AC-006.3">
      <title>Machine-line many-to-many assignment</title>
      <details>
        - Machine can be assigned to multiple lines (e.g., packaging machine shared across 2 lines)
        - Line can have multiple machines (e.g., Line 1 has mixer, filler, capper)
        - Assignment table: machine_line_assignments (machine_id, line_id)
        - Unique constraint: (machine_id, line_id) - prevents duplicate assignments
        - Can assign from machine side (this story) or line side (Story 1.8)
      </details>
    </criterion>

    <criterion id="AC-006.4">
      <title>Machines list view</title>
      <details>
        - Table columns: Code, Name, Status, Lines (count/names), Capacity, Actions
        - Lines column: show comma-separated line codes or "No lines assigned"
        - Search by code or name
        - Filter by status (All, Active, Down, Maintenance)
        - Sort by code, name, status, created_at
      </details>
    </criterion>

    <criterion id="AC-006.5">
      <title>Cannot delete machine with constraints</title>
      <details>
        - FK constraint ON DELETE RESTRICT prevents deletion if machine assigned to active WOs (Epic 4)
        - Error message: "Cannot delete machine - it has X active WOs. Archive it instead."
        - Archive option: set status = 'maintenance' or soft delete
        - Recommendation: Archive, not delete (preserve history)
      </details>
    </criterion>

    <criterion id="AC-006.6">
      <title>Edit machine</title>
      <details>
        - Click Edit action → drawer opens with form
        - All fields editable (code, name, status, capacity, line assignments)
        - Line assignments: multi-select dropdown shows all lines
        - Can add/remove line assignments
        - On save: machine updated, assignments updated (delete old, insert new)
      </details>
    </criterion>

    <criterion id="AC-006.7">
      <title>Machine detail page</title>
      <details>
        - Navigate to /settings/machines/:id
        - Display: code, name, status, capacity, assigned lines (with links)
        - Actions: Edit, Change Status, View WOs (Epic 4 link)
        - Related entities: Active WOs using this machine (Epic 4), historical usage stats
      </details>
    </criterion>

    <criterion id="AC-006.8">
      <title>Cache invalidation events</title>
      <details>
        - On machine create/update/delete: emit 'machine.updated' event
        - Epic 4 refetches machine list on event
        - Redis cache TTL: 5 min
        - Cache key: `machines:{org_id}`
      </details>
    </criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-1.md</path>
        <title>Technical Specification - Epic 1 (Foundation & Settings)</title>
        <section>FR-SET-006: Machine Configuration</section>
        <snippet>Production machine configuration with status lifecycle, capacity tracking, many-to-many line assignments via machine_line_assignments table.</snippet>
      </doc>

      <doc>
        <path>docs/epics/epic-1-settings.md</path>
        <title>Epic 1: Foundation & Settings</title>
        <section>Story 1.7: Machine Configuration</section>
        <snippet>Machine definition with status tracking (Active, Down, Maintenance) and capacity per hour for production planning.</snippet>
      </doc>
    </docs>

    <code>
      <artifact>
        <path>app/lib/supabase/server.ts</path>
        <kind>lib</kind>
        <symbol>createClient</symbol>
        <lines>all</lines>
        <reason>Supabase server client for database operations and realtime events</reason>
      </artifact>

      <artifact>
        <path>app/lib/types.ts</path>
        <kind>types</kind>
        <symbol>Database types</symbol>
        <lines>all</lines>
        <reason>TypeScript types for database tables - will be updated after machines table migration</reason>
      </artifact>

      <artifact>
        <path>packages/shared/schemas.ts</path>
        <kind>schemas</kind>
        <symbol>Zod schemas</symbol>
        <lines>all</lines>
        <reason>Shared validation schemas - add CreateMachineSchema and UpdateMachineSchema</reason>
      </artifact>

      <artifact>
        <path>packages/shared/types.ts</path>
        <kind>types</kind>
        <symbol>Shared types</symbol>
        <lines>all</lines>
        <reason>Shared TypeScript types - add Machine interface and MachineStatus enum</reason>
      </artifact>
    </code>

    <dependencies>
      <ecosystem name="node">
        <package name="@supabase/supabase-js" version="latest">Supabase client for database and realtime</package>
        <package name="zod" version="latest">Schema validation (CreateMachineSchema, UpdateMachineSchema)</package>
        <package name="react-hook-form" version="latest">Form state management</package>
        <package name="swr" version="latest">Data fetching and caching</package>
        <package name="ioredis" version="latest">Redis client for caching</package>
      </ecosystem>

      <ecosystem name="shadcn">
        <component name="table">Machines table component</component>
        <component name="dialog">Machine form modal, confirmation dialogs</component>
        <component name="drawer">Edit machine drawer</component>
        <component name="badge">Status badges (Active, Down, Maintenance)</component>
        <component name="toast">Success/error notifications</component>
        <component name="select">Status dropdown, multi-select for line assignments</component>
        <component name="input">Form fields</component>
      </ecosystem>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="architecture">
      <rule>Multi-tenancy: RLS policy on machines table (org_id isolation)</rule>
      <rule>Many-to-Many: machine_line_assignments join table for bidirectional assignments</rule>
      <rule>Status Lifecycle: Active → Down → Maintenance (affects WO assignment in Epic 4)</rule>
      <rule>Soft Delete: Status = 'maintenance' instead of hard delete (preserve history)</rule>
      <rule>Cache Invalidation: Events emitted on mutations, consumed by Epic 4</rule>
      <rule>FK Constraints: ON DELETE RESTRICT prevents accidental machine deletion if has WOs</rule>
    </constraint>

    <constraint type="security">
      <rule>RLS Policy REQUIRED: org_id = (auth.jwt() ->> 'org_id')::uuid on machines table</rule>
      <rule>Admin Only: Only Admin role can create/edit/delete machines</rule>
      <rule>Cross-Org Isolation: Users cannot access machines from other organizations</rule>
      <rule>Audit Trail: created_by, updated_by tracked on all mutations</rule>
    </constraint>

    <constraint type="data">
      <rule>Unique Constraint: (org_id, code) - machine code unique per organization</rule>
      <rule>Unique Constraint: (machine_id, line_id) on machine_line_assignments - prevents duplicate assignments</rule>
      <rule>Indexes REQUIRED: org_id, status, machine_id, line_id for query performance</rule>
      <rule>Machine Status: active, down, maintenance (3 status values)</rule>
      <rule>Capacity: decimal(10,2) - supports fractional units (e.g., 1000.5 units/hour)</rule>
    </constraint>

    <constraint type="performance">
      <rule>Machine list load (100 machines): &lt;200ms p95</rule>
      <rule>Create machine: &lt;300ms</rule>
      <rule>Update machine: &lt;250ms</rule>
      <rule>Cache hit rate: &gt;80%</rule>
    </constraint>

    <constraint type="testing">
      <rule>RLS Testing: MUST add to RLS test suite (Sprint 0 Gap 4)</rule>
      <rule>Integration Tests: MUST verify status change warnings, line assignment sync</rule>
      <rule>E2E Tests: MUST test machine creation, status change, line assignments</rule>
    </constraint>
  </constraints>

  <interfaces>
    <interface name="GET /api/settings/machines">
      <kind>REST endpoint</kind>
      <signature>
        Query: { status?, search? }
        Response: Machine[] (with line names from JOIN)
        Auth: Authenticated user
        Cache: 5 min TTL (Redis)
        Filters: org_id (from JWT), status, search (code/name case-insensitive)
      </signature>
      <path>app/api/settings/machines/route.ts (NEW)</path>
    </interface>

    <interface name="POST /api/settings/machines">
      <kind>REST endpoint</kind>
      <signature>
        Body: CreateMachineInput { code, name, status, capacity_per_hour?, line_ids? }
        Response: Machine
        Auth: Admin only
        Validation: Unique code per org, valid status
        Side effects: Insert machine, insert line assignments, emit machine.created event
      </signature>
      <path>app/api/settings/machines/route.ts (NEW)</path>
    </interface>

    <interface name="GET /api/settings/machines/:id">
      <kind>REST endpoint</kind>
      <signature>
        Params: { id: UUID }
        Response: Machine (with assigned lines)
        Auth: Authenticated user
      </signature>
      <path>app/api/settings/machines/[id]/route.ts (NEW)</path>
    </interface>

    <interface name="PUT /api/settings/machines/:id">
      <kind>REST endpoint</kind>
      <signature>
        Params: { id: UUID }
        Body: UpdateMachineInput { code?, name?, status?, capacity_per_hour?, line_ids? }
        Response: Machine
        Auth: Admin only
        Validation: Status change warnings if has active WOs
        Side effects: Update machine, update line assignments (delete old, insert new), emit machine.updated event
      </signature>
      <path>app/api/settings/machines/[id]/route.ts (NEW)</path>
    </interface>

    <interface name="DELETE /api/settings/machines/:id">
      <kind>REST endpoint</kind>
      <signature>
        Params: { id: UUID }
        Response: { success: boolean } or { error: string }
        Auth: Admin only
        Note: FK constraints prevent deletion if has active WOs
        Alternative: Archive (status = 'maintenance')
        Side effects: Emit machine.deleted event, invalidate cache
      </signature>
      <path>app/api/settings/machines/[id]/route.ts (NEW)</path>
    </interface>

    <interface name="MachineService.createMachine">
      <kind>Service method</kind>
      <signature>
        async createMachine(input: CreateMachineInput): Promise&lt;Machine&gt;
        Validation: Code unique per org, status is valid enum
        Side effects: Insert machine, insert line assignments (if line_ids provided), emit cache event
      </signature>
      <path>lib/services/MachineService.ts (NEW)</path>
    </interface>

    <interface name="MachineService.updateMachine">
      <kind>Service method</kind>
      <signature>
        async updateMachine(id: string, input: UpdateMachineInput): Promise&lt;Machine&gt;
        Validation: Machine exists + belongs to org, code unique, status change warnings
        Side effects: Update machine, update line assignments (delete old, insert new), emit cache event
      </signature>
      <path>lib/services/MachineService.ts (NEW)</path>
    </interface>

    <interface name="MachineService.getMachines">
      <kind>Service method</kind>
      <signature>
        async getMachines(orgId: string, filters?: MachineFilters): Promise&lt;Machine[]&gt;
        Returns: Machines array with line names (JOIN machine_line_assignments → production_lines)
        Filters: status, search (code/name)
        Sort: By specified column (code, name, status, created_at)
      </signature>
      <path>lib/services/MachineService.ts (NEW)</path>
    </interface>

    <interface name="CreateMachineSchema">
      <kind>Zod schema</kind>
      <signature>
        z.object({
          code: z.string().regex(/^[A-Z0-9-]+$/).min(2).max(50),
          name: z.string().min(1).max(100),
          status: z.enum(['active', 'down', 'maintenance']).default('active'),
          capacity_per_hour: z.number().positive().optional(),
          line_ids: z.array(z.string().uuid()).optional()
        })
      </signature>
      <path>packages/shared/schemas.ts</path>
    </interface>

    <interface name="Cache Event: machine.updated">
      <kind>Event emitter</kind>
      <signature>
        Event: 'machine.created' | 'machine.updated' | 'machine.deleted'
        Payload: { type: string, org_id: string, machine_id: string, timestamp: Date }
        Consumers: Epic 4 (WO operation assignment)
        Action: Invalidate Redis cache key `machines:{org_id}`, refetch machine list
      </signature>
      <path>Server: MachineService, Consumers: Epic 4 services</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Testing stack: Vitest for unit/integration tests, Playwright for E2E tests.
      Unit tests in same directory as source files (*.test.ts).
      Integration tests in tests/integration/.
      E2E tests in tests/e2e/ using Playwright.
      Use @faker-js/faker for test data generation.
      RLS tests MUST be added to tests/integration/rls/ suite (Sprint 0 Gap 4).
    </standards>

    <locations>
      - lib/services/MachineService.test.ts (Machine CRUD, line assignment logic)
      - packages/shared/schemas.test.ts (Zod schema validation tests)
      - app/api/settings/machines/**/*.test.ts (API endpoint tests)
      - tests/integration/machines/ (Integration tests: DB operations, status change warnings)
      - tests/integration/rls/machines-rls.test.ts (RLS policy tests)
      - tests/e2e/settings/machines.spec.ts (E2E machine management flow)
    </locations>

    <ideas>
      <test id="AC-006.1" type="integration">
        - POST /api/settings/machines → machine created with line assignments
        - Verify unique constraint (org_id, code) - duplicate code in same org fails
        - RLS: User A (Org 1) creates machine → User B (Org 2) cannot see it
      </test>

      <test id="AC-006.2" type="integration">
        - Change status to Down → warn if has active WOs
        - Status badge colors: Active (green), Down (red), Maintenance (yellow)
      </test>

      <test id="AC-006.3" type="integration">
        - Assign machine to multiple lines → assignments saved
        - Unique constraint (machine_id, line_id) prevents duplicates
        - Bidirectional sync: assign from machine side matches line side
      </test>

      <test id="AC-006.5" type="integration">
        - DELETE machine with active WOs → FK constraint error
        - Archive machine (status = maintenance) → succeeds
      </test>

      <test id="AC-006.6" type="integration">
        - PUT /api/settings/machines/:id → line assignments updated (old deleted, new inserted)
      </test>

      <test id="all" type="e2e">
        - E2E: Create machine → appears in list with assigned lines
        - E2E: Edit machine → change line assignments → saved
        - E2E: Change status → warning shown if active WOs
        - E2E: Filter machines by status → correct results
        - E2E: Cannot delete machine with WOs → error shown
      </test>
    </ideas>
  </tests>
</story-context>
