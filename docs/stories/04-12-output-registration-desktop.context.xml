<story-context id="4-12-output-registration-desktop" v="1.0">
  <metadata>
    <epicId>4</epicId>
    <storyId>12</storyId>
    <title>Output Registration (Desktop)</title>
    <status>drafted</status>
    <generatedAt>2025-11-27</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <template>CRUD with Modal Pattern + Genealogy Integration</template>
    <estimatedEffort>1 day</estimatedEffort>
    <priority>P0</priority>
  </metadata>

  <story>
    <asA>Operator</asA>
    <iWant>to register production output from desktop</iWant>
    <soThat>finished goods are tracked with automatic material consumption and genealogy</soThat>
    <tasks>
      <task id="1" ac="AC-4.12.1,AC-4.12.2">Create output registration modal with LP auto-generation</task>
      <task id="2" ac="AC-4.12.3">Implement automatic sequential material consumption logic</task>
      <task id="3" ac="AC-4.12.4">Update genealogy records linking consumed LPs to output LP</task>
      <task id="4" ac="AC-4.12.5,AC-4.12.6">Progress tracking and QA status recording</task>
      <task id="5" ac="AC-4.12.7,AC-4.12.8">API endpoint and error handling</task>
      <task id="6" ac="AC-4.12.9">Over-production handling with operator material source selection</task>
      <task id="7">E2E tests for output registration flow</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC-4.12.1">
      Main Output Registration Modal:
      - Triggered when clicking "Register Output" on WO in progress
      - Fields: quantity (required), qa_status (if required in settings), location_id (default from line), notes
      - Note: By-product registration is separate (Story 4.14), comes AFTER main output
    </criterion>
    <criterion id="AC-4.12.2">
      Output LP Creation:
      - product from WO
      - batch_number from WO.wo_number
      - expiry_date calculated from product.shelf_life_days
      - status = 'available'
      - quantity = entered value
    </criterion>
    <criterion id="AC-4.12.3">
      Automatic Material Consumption (Output-Driven, Sequential LP Allocation):
      - Track cumulative output qty across all outputs registered for this WO
      - Consume reserved LPs in order (A → B → C) as cumulative output increases
      - Handle consume_whole_lp enforcement (entire LP consumed when reached in sequence)
      - Create consumption audit record: wo_consumption entries for each LP consumed
      - Example: Output-1 (70kg) → consumes LP-A (80kg), Output-2 (20kg) → consumes LP-B (40kg)
    </criterion>
    <criterion id="AC-4.12.4">
      WO Output Tracking &amp; Genealogy Update:
      - work_orders.output_qty += registered_qty
      - Update consumed lp_genealogy records (from AC-4.12.3) by setting:
        * child_lp_id = output LP (now that output LP exists)
        * produced_at = current timestamp
        * consumed_qty = actual qty consumed per LP
      - Result: Each consumed input LP (parent) now links to this output LP (child)
    </criterion>
    <criterion id="AC-4.12.5">
      Progress Tracking: Cumulative output tracked, progress = output_qty / planned_qty × 100%
    </criterion>
    <criterion id="AC-4.12.6">
      QA Status Recording: If qa_status required in Settings, license_plates.qa_status set to entered value
    </criterion>
    <criterion id="AC-4.12.7">
      API Endpoint: POST /api/production/work-orders/:id/outputs with {qty, qa_status, location_id, notes}
    </criterion>
    <criterion id="AC-4.12.8">
      Error Handling:
      - qty &lt;= 0 → 400 error: "Output quantity must be &gt; 0"
      - WO not in progress → 400 error: "WO not in progress"
      - Over-production (output_qty &gt; total_reserved_qty) AND allow_over_consumption=false → warn: "Output would consume all reserved materials. Continue?"
    </criterion>
    <criterion id="AC-4.12.9">
      Over-Production Handling (Material Source Selection):
      - When output qty would exceed all reserved LPs (AC-4.12.8 case)
      - Show warning: "All reserved LPs consumed. This output is over-production."
      - Show dropdown: "Which reserved LP is source for this output?" with options
      - Operator selects source LP
      - System creates lp_genealogy_allocation record with is_over_production = true
      - Create lp_genealogy record linking selected LP → over-production output
    </criterion>
    <criterion id="AC-4.12.10">
      Prerequisites: Requires Story 4.7 (Material Reservation) and Story 4.19 (Genealogy)
    </criterion>
  </acceptanceCriteria>

  <uxDesign>
    <designSystem>
      <reference>
        <doc>docs/ux-design/ux-design-shared-system.md</doc>
        <section>3. Component Library - 3.4 DataTable</section>
        <note>Use shared modal pattern with form validation</note>
      </reference>
      <reference>
        <doc>docs/ux-design/ux-design-shared-system.md</doc>
        <section>4. Interaction Patterns - 4.3 Notifications &amp; Feedback</section>
        <note>Toast notifications for success/error, inline validation for form fields</note>
      </reference>
    </designSystem>
    <components>
      <component>
        <name>OutputRegistrationModal</name>
        <path>apps/frontend/components/production/OutputRegistrationModal.tsx</path>
        <kind>Modal with Form</kind>
        <fields>
          <field name="quantity" type="number" required="true" validation="&gt; 0" />
          <field name="qa_status" type="select" required="conditional" note="Required if Settings.production_settings.require_qa_status = true" />
          <field name="location_id" type="select" required="false" default="from production_lines.default_output_location_id" />
          <field name="notes" type="textarea" required="false" maxLength="500" />
        </fields>
        <actions>
          <action label="Register Output" color="green-600" type="submit" />
          <action label="Cancel" color="gray-600" type="button" />
        </actions>
      </component>
      <component>
        <name>OverProductionWarningModal</name>
        <path>apps/frontend/components/production/OverProductionWarningModal.tsx</path>
        <kind>Warning Modal with Selection</kind>
        <fields>
          <field name="source_lp_id" type="select" required="true" note="Dropdown of all reserved LPs with remaining qty displayed" />
        </fields>
        <note>Only shown when over-production detected (AC-4.12.9)</note>
      </component>
    </components>
    <colorPalette>
      <color name="Primary (Create/CTA)" value="green-600" hex="#16a34a" />
      <color name="Secondary (Actions)" value="gray-600" hex="#4b5563" />
      <color name="Danger (Delete)" value="red-600" hex="#dc2626" />
      <color name="Warning (Over-production)" value="amber-500" hex="#f59e0b" />
      <color name="Success (Output registered)" value="green-200" hex="#dcfce7" bg="true" textColor="green-800" />
    </colorPalette>
    <reference>
      <doc>docs/ux-design/ux-design-shared-system.md</doc>
      <section>2. Design System - Visual Foundation</section>
      <note>All colors from Tailwind palette, no custom hex overrides</note>
    </reference>
  </uxDesign>

  <databaseSchema>
    <tables>
      <table name="license_plates">
        <description>Stores output LPs created during output registration</description>
        <relevantColumns>
          <column name="id" type="uuid" pk="true" />
          <column name="org_id" type="uuid" fk="organizations.id" />
          <column name="lp_number" type="varchar" unique="true" note="Unique LP identifier (e.g., LP-2024-001)" />
          <column name="batch_number" type="varchar" note="Batch number for traceability, copied from WO.wo_number" />
          <column name="product_id" type="uuid" fk="products.id" />
          <column name="quantity" type="numeric" check="&gt; 0" />
          <column name="uom" type="varchar" />
          <column name="status" type="varchar" values="available|consumed|shipped|quarantine|recalled" default="available" />
          <column name="location_id" type="uuid" fk="locations.id" nullable="true" />
          <column name="manufacturing_date" type="date" nullable="true" />
          <column name="expiry_date" type="date" nullable="true" note="Calculated from product.shelf_life_days" />
          <column name="qa_status" type="varchar" nullable="true" note="Set if Settings require_qa_status = true (not in current schema, will be added)" />
          <column name="created_by" type="uuid" fk="users.id" />
          <column name="created_at" type="timestamptz" default="now()" />
        </relevantColumns>
        <note>Table exists (stub from Epic 2), will be used for output LP creation</note>
      </table>
      <table name="production_outputs">
        <description>NEW TABLE - Tracks each output registration event</description>
        <schema>
          <column name="id" type="uuid" pk="true" default="gen_random_uuid()" />
          <column name="org_id" type="uuid" fk="organizations.id" />
          <column name="wo_id" type="uuid" fk="work_orders.id" />
          <column name="output_lp_id" type="uuid" fk="license_plates.id" note="Output LP created for this registration" />
          <column name="quantity" type="numeric" check="&gt; 0" />
          <column name="uom" type="varchar" />
          <column name="registered_at" type="timestamptz" default="now()" />
          <column name="registered_by" type="uuid" fk="users.id" />
          <column name="notes" type="text" nullable="true" />
          <column name="created_at" type="timestamptz" default="now()" />
        </schema>
        <note>To be created in Task 1 migration</note>
      </table>
      <table name="wo_consumption">
        <description>NEW TABLE - Audit trail for material consumption triggered by output registration</description>
        <schema>
          <column name="id" type="uuid" pk="true" default="gen_random_uuid()" />
          <column name="org_id" type="uuid" fk="organizations.id" />
          <column name="wo_id" type="uuid" fk="work_orders.id" />
          <column name="material_id" type="uuid" fk="products.id" note="Material product consumed" />
          <column name="lp_id" type="uuid" fk="license_plates.id" note="LP consumed" />
          <column name="consumed_qty" type="numeric" check="&gt; 0" />
          <column name="uom" type="varchar" />
          <column name="consumed_at" type="timestamptz" default="now()" />
          <column name="output_id" type="uuid" fk="production_outputs.id" note="Which output triggered this consumption" />
          <column name="created_at" type="timestamptz" default="now()" />
        </schema>
        <note>Created automatically during output registration (AC-4.12.3)</note>
      </table>
      <table name="lp_genealogy">
        <description>Genealogy graph linking input LPs (parents) to output LPs (children)</description>
        <relevantColumns>
          <column name="id" type="uuid" pk="true" />
          <column name="parent_lp_id" type="uuid" fk="license_plates.id" note="Input LP (material consumed)" />
          <column name="child_lp_id" type="uuid" fk="license_plates.id" nullable="true" note="Output LP (NULL during reservation, filled during output registration)" />
          <column name="relationship_type" type="varchar" values="split|combine|transform" note="Use 'transform' for WO production" />
          <column name="work_order_id" type="uuid" fk="work_orders.id" nullable="true" />
          <column name="quantity_from_parent" type="numeric" check="&gt; 0" note="Qty consumed from parent LP" />
          <column name="uom" type="varchar" />
          <column name="reserved_at" type="timestamptz" nullable="true" note="Set during reservation (Story 4.7)" />
          <column name="produced_at" type="timestamptz" nullable="true" note="Set during output registration (AC-4.12.4)" />
          <column name="consumed_qty" type="numeric" nullable="true" note="Actual qty consumed, set during output registration" />
          <column name="created_by" type="uuid" fk="users.id" />
          <column name="created_at" type="timestamptz" default="now()" />
        </relevantColumns>
        <note>Table exists, updated during output registration to link input → output</note>
      </table>
      <table name="lp_genealogy_allocation">
        <description>NEW TABLE - Tracks over-production material source allocation (AC-4.12.9)</description>
        <schema>
          <column name="id" type="uuid" pk="true" default="gen_random_uuid()" />
          <column name="org_id" type="uuid" fk="organizations.id" />
          <column name="parent_lp_id" type="uuid" fk="license_plates.id" note="Source LP selected by operator" />
          <column name="child_lp_id" type="uuid" fk="license_plates.id" note="Over-production output LP" />
          <column name="allocated_qty" type="numeric" check="&gt; 0" />
          <column name="is_over_production" type="boolean" default="false" />
          <column name="allocation_type" type="varchar" values="automatic|operator_selected" default="operator_selected" />
          <column name="created_at" type="timestamptz" default="now()" />
        </schema>
        <note>To be created in Task 1 migration for over-production traceability</note>
      </table>
      <table name="work_orders">
        <description>Work orders table (existing)</description>
        <relevantColumns>
          <column name="id" type="uuid" pk="true" />
          <column name="org_id" type="uuid" fk="organizations.id" />
          <column name="wo_number" type="varchar" unique="true" />
          <column name="product_id" type="uuid" fk="products.id" />
          <column name="planned_quantity" type="numeric" check="&gt; 0" />
          <column name="produced_quantity" type="numeric" default="0" check="&gt;= 0" note="Will be renamed to output_qty for consistency" />
          <column name="uom" type="varchar" />
          <column name="status" type="varchar" values="draft|released|in_progress|completed|closed|cancelled" />
          <column name="production_line_id" type="uuid" fk="production_lines.id" nullable="true" />
          <column name="created_at" type="timestamptz" default="now()" />
        </relevantColumns>
        <note>Update output_qty during registration (AC-4.12.4)</note>
      </table>
      <table name="products">
        <description>Products master data (existing)</description>
        <relevantColumns>
          <column name="id" type="uuid" pk="true" />
          <column name="code" type="text" unique="per org" />
          <column name="name" type="text" />
          <column name="uom" type="text" />
          <column name="shelf_life_days" type="integer" nullable="true" check="&gt; 0" note="Used to calculate expiry_date" />
        </relevantColumns>
      </table>
      <table name="production_lines">
        <description>Production lines (existing)</description>
        <relevantColumns>
          <column name="id" type="uuid" pk="true" />
          <column name="default_output_location_id" type="uuid" fk="locations.id" nullable="true" note="Default location for WO output" />
        </relevantColumns>
      </table>
    </tables>
    <migrations>
      <migration name="create_production_outputs_table" file="supabase/migrations/XXX_create_production_outputs.sql">
        <action>CREATE TABLE production_outputs</action>
        <action>CREATE TABLE wo_consumption</action>
        <action>CREATE TABLE lp_genealogy_allocation</action>
        <action>ALTER TABLE work_orders RENAME COLUMN produced_quantity TO output_qty</action>
        <action>ADD COLUMN qa_status to license_plates (if not exists)</action>
      </migration>
    </migrations>
  </databaseSchema>

  <apiPatterns>
    <endpoint>
      <method>POST</method>
      <path>/api/production/work-orders/:id/outputs</path>
      <requestBody>
        {
          "qty": "number (required, &gt; 0)",
          "qa_status": "string (optional, required if Settings.require_qa_status)",
          "location_id": "uuid (optional, defaults to line.default_output_location_id)",
          "notes": "string (optional, max 500 chars)"
        }
      </requestBody>
      <responseBody>
        {
          "success": true,
          "data": {
            "output_lp_id": "uuid",
            "lp_number": "string",
            "consumed_lps": ["lp_id1", "lp_id2"],
            "cumulative_output_qty": "number",
            "progress_percent": "number"
          }
        }
      </responseBody>
      <implementation>
        <file>apps/frontend/app/api/production/work-orders/[id]/outputs/route.ts</file>
        <pattern>
          - Validate WO status = 'in_progress'
          - Validate qty &gt; 0
          - Create output LP (license_plates)
          - Create production_outputs record
          - Calculate cumulative output qty
          - Consume reserved LPs sequentially (wo_consumption records)
          - Update lp_genealogy records (child_lp_id, produced_at, consumed_qty)
          - Update work_orders.output_qty
          - Handle over-production (AC-4.12.9)
          - Return output LP details + consumed LPs
        </pattern>
      </implementation>
      <errorHandling>
        <error code="400" condition="qty &lt;= 0">Output quantity must be &gt; 0</error>
        <error code="400" condition="WO status != 'in_progress'">WO not in progress</error>
        <error code="400" condition="qa_status required but missing">QA status is required</error>
        <error code="409" condition="Over-production detected">Output would consume all reserved materials. Continue?</error>
      </errorHandling>
    </endpoint>
    <reference>
      <existingPattern>apps/frontend/app/api/planning/purchase-orders/route.ts</existingPattern>
      <note>Follow same pattern: validate input, create records, return detailed response</note>
    </reference>
  </apiPatterns>

  <services>
    <service>
      <name>OutputService</name>
      <file>apps/frontend/lib/services/output-service.ts</file>
      <methods>
        <method name="registerOutput">
          <description>Register production output, create LP, consume materials, update genealogy</description>
          <parameters>woId: string, qty: number, qa_status?: string, location_id?: string, notes?: string</parameters>
          <returns>Promise&lt;{ output_lp_id, lp_number, consumed_lps, cumulative_output_qty, progress_percent }&gt;</returns>
          <logic>
            1. Create output LP (license_plates)
            2. Calculate expiry_date from product.shelf_life_days
            3. Create production_outputs record
            4. Get reserved LPs for WO (ordered by sequence)
            5. Calculate cumulative output qty (sum all previous outputs + current)
            6. Consume LPs sequentially based on cumulative qty (AC-4.12.3)
            7. Create wo_consumption records
            8. Update lp_genealogy: set child_lp_id, produced_at, consumed_qty
            9. Update work_orders.output_qty
            10. Return output details
          </logic>
        </method>
        <method name="handleOverProduction">
          <description>Handle over-production case when all reserved LPs consumed (AC-4.12.9)</description>
          <parameters>woId: string, overProductionQty: number, selectedLpId: string</parameters>
          <returns>Promise&lt;void&gt;</returns>
          <logic>
            1. Validate selected LP belongs to WO reservations
            2. Create lp_genealogy_allocation record
            3. Create lp_genealogy record linking selected LP → over-production output
          </logic>
        </method>
        <method name="calculateExpiryDate">
          <description>Calculate expiry date from manufacturing date + shelf_life_days</description>
          <parameters>manufacturingDate: Date, shelfLifeDays: number</parameters>
          <returns>Date | null</returns>
        </method>
      </methods>
    </service>
    <reference>
      <existingService>apps/frontend/lib/services/production-line-service.ts</existingService>
      <note>Follow same service pattern: async methods, error handling, Supabase client</note>
    </reference>
  </services>

  <testingStrategy>
    <e2eTests>
      <testFile>tests/e2e/output-registration.spec.ts</testFile>
      <scenarios>
        <scenario name="Output registration creates LP and consumes materials">
          <steps>
            1. Create test organization + user
            2. Create test product with shelf_life_days
            3. Create test WO in 'in_progress' status
            4. Create 2 reserved LPs for WO (LP-A: 80kg, LP-B: 40kg)
            5. Navigate to WO detail page
            6. Click "Register Output" button
            7. Fill output modal: qty=70kg, notes="First output"
            8. Confirm output
            9. Verify toast: "Output registered successfully"
            10. Verify output LP created with correct batch_number, expiry_date
            11. Verify LP-A status changed to 'consumed'
            12. Verify wo_consumption record created for LP-A (70kg)
            13. Verify lp_genealogy updated: child_lp_id set, produced_at set
            14. Verify work_orders.output_qty = 70kg
            15. Verify progress bar shows 70/200 (35%)
          </steps>
        </scenario>
        <scenario name="Sequential consumption - second output consumes next LP">
          <steps>
            1. (After scenario 1) Register second output: qty=20kg
            2. Verify LP-B status changed to 'consumed'
            3. Verify wo_consumption record created for LP-B (20kg)
            4. Verify work_orders.output_qty = 90kg (cumulative)
            5. Verify progress bar shows 90/200 (45%)
          </steps>
        </scenario>
        <scenario name="Over-production triggers material source selection">
          <steps>
            1. (After scenario 2) Register third output: qty=120kg (exceeds remaining reserved)
            2. Verify warning modal: "All reserved LPs consumed. This output is over-production."
            3. Select source LP from dropdown (LP-A)
            4. Confirm
            5. Verify lp_genealogy_allocation record created with is_over_production=true
            6. Verify lp_genealogy record created linking LP-A → over-production output
          </steps>
        </scenario>
        <scenario name="QA status required validation">
          <steps>
            1. Enable Settings.require_qa_status
            2. Register output without qa_status
            3. Verify error: "QA status is required"
            4. Fill qa_status = "pass"
            5. Verify output LP has qa_status = "pass"
          </steps>
        </scenario>
        <scenario name="Error handling - invalid qty">
          <steps>
            1. Try to register output with qty = 0
            2. Verify error: "Output quantity must be &gt; 0"
            3. Try to register output with qty = -10
            4. Verify error: "Output quantity must be &gt; 0"
          </steps>
        </scenario>
      </scenarios>
    </e2eTests>
    <unitTests>
      <testFile>tests/unit/services/output-service.test.ts</testFile>
      <scenarios>
        <test name="calculateExpiryDate returns correct date">
          manufacturingDate: 2025-01-01, shelfLifeDays: 30 → expiryDate: 2025-01-31
        </test>
        <test name="calculateExpiryDate returns null if shelfLifeDays null">
          manufacturingDate: 2025-01-01, shelfLifeDays: null → expiryDate: null
        </test>
      </scenarios>
    </unitTests>
    <fixtures>
      <fixture name="createTestWO">
        <file>tests/e2e/fixtures/test-setup.ts</file>
        <returns>{ woId, wo_number, product_id, planned_qty }</returns>
      </fixture>
      <fixture name="createTestReservedLPs">
        <file>tests/e2e/fixtures/test-setup.ts</file>
        <returns>{ lp_ids, lp_numbers, quantities }</returns>
      </fixture>
    </fixtures>
  </testingStrategy>

  <integrationPoints>
    <dependency>
      <storyId>4.7</storyId>
      <title>Material Reservation (Desktop)</title>
      <reason>Output registration consumes reserved LPs in sequence order</reason>
      <tables>wo_material_reservations, lp_genealogy (partial records)</tables>
    </dependency>
    <dependency>
      <storyId>4.19</storyId>
      <title>Genealogy Tracking</title>
      <reason>Output registration updates genealogy records linking input → output LPs</reason>
      <tables>lp_genealogy</tables>
    </dependency>
    <dependency>
      <storyId>4.14</storyId>
      <title>By-Product Registration</title>
      <reason>By-products registered AFTER main output, separate modal</reason>
      <note>Story 4.12 handles main output only</note>
    </dependency>
    <dependency>
      <epicId>5</epicId>
      <title>Warehouse - License Plates</title>
      <reason>Output LP created in license_plates table</reason>
      <tables>license_plates</tables>
    </dependency>
  </integrationPoints>

  <businessLogic>
    <rule name="Sequential LP Consumption">
      <description>
        Reserved LPs consumed in order (A → B → C) based on cumulative output qty.
        Example:
        - WO requires 200kg total
        - Reserved: LP-A (80kg), LP-B (40kg), LP-C (80kg)
        - Output-1 (70kg): cumulative=70kg → Consume LP-A (80kg) fully
        - Output-2 (20kg): cumulative=90kg → Consume LP-B (40kg) fully
        - Output-3 (80kg): cumulative=170kg → Consume LP-C (80kg) fully
        - Output-4 (30kg): cumulative=200kg → Over-production (all LPs consumed)
      </description>
    </rule>
    <rule name="Genealogy Record Lifecycle">
      <description>
        Genealogy records created in 2 stages:
        1. Reservation (Story 4.7): parent_lp_id set, child_lp_id = NULL, reserved_at set
        2. Output Registration (Story 4.12): child_lp_id set, produced_at set, consumed_qty set
        Result: Full traceability from input LP → output LP
      </description>
    </rule>
    <rule name="Over-Production Traceability">
      <description>
        When output qty exceeds all reserved LPs:
        1. Warn operator: "All reserved LPs consumed. This output is over-production."
        2. Operator selects which reserved LP is source for over-production output
        3. Create lp_genealogy_allocation record (is_over_production=true, allocation_type='operator_selected')
        4. Create genealogy record linking selected LP → over-production output
        Result: Over-production traced back through allocation table
      </description>
    </rule>
    <rule name="Expiry Date Calculation">
      <description>
        If product.shelf_life_days exists:
        - expiry_date = manufacturing_date + shelf_life_days
        Otherwise:
        - expiry_date = NULL
      </description>
    </rule>
    <rule name="Batch Number">
      <description>
        Output LP batch_number = WO.wo_number (e.g., "WO-2024-001")
        Ensures all outputs from same WO have same batch for traceability
      </description>
    </rule>
  </businessLogic>

  <relatedStories>
    <story id="4.7" title="Material Reservation (Desktop)" relationship="prerequisite" />
    <story id="4.13" title="Output Registration (Scanner)" relationship="parallel" note="Same logic, different UI" />
    <story id="4.14" title="By-Product Registration" relationship="follows" note="Registered AFTER main output" />
    <story id="4.16" title="Multiple Outputs per WO" relationship="extends" note="Handles cumulative output tracking" />
    <story id="4.19" title="Genealogy Tracking" relationship="integrates" note="Updates genealogy records" />
  </relatedStories>

  <technicalNotes>
    <note>Use Supabase transactions for atomic operations (create LP + update genealogy + update WO)</note>
    <note>LP number generation: AUTO from sequence (e.g., LP-2024-001, LP-2024-002)</note>
    <note>Default location_id from production_lines.default_output_location_id if not provided</note>
    <note>QA status conditional: Only shown in modal if Settings.production_settings.require_qa_status = true</note>
    <note>Progress calculation: (cumulative output_qty / planned_qty) × 100%</note>
    <note>Over-production detection: cumulative output_qty &gt; sum(all reserved LPs qty)</note>
  </technicalNotes>

  <references>
    <doc>docs/stories/04-12-output-registration-desktop.md</doc>
    <doc>docs/ux-design/ux-design-shared-system.md</doc>
    <doc>docs/epics/04-production.md</doc>
    <doc>docs/stories/04-7-material-reservation-desktop.md</doc>
  </references>
</story-context>
