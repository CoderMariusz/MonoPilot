<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>0</epicId>
    <storyId>7</storyId>
    <title>Automated Validation Tests (PREVENTION)</title>
    <status>drafted</status>
    <generatedAt>2025-11-14</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/0-7-automated-validation-tests.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>Development Team / DevOps Engineer</asA>
    <iWant>automated validation scripts that verify DB ↔ TypeScript ↔ API consistency in CI/CD pipeline</iWant>
    <soThat>future data integrity issues are caught before they reach production</soThat>
    <tasks>
      - Schema Validation Script (8h): Parse migrations and TS enums, compare, generate report
      - API Contract Tests (6h): Verify API signatures match types, RPC functions use correct columns
      - Enum Consistency Tests (4h): Unit tests comparing DB values with TS enums
      - Pre-Commit Hook (3h): Integrate schema validation into git hooks
      - CI/CD Integration (4h): Add validation to GitHub Actions, block merge on failure
      - Documentation (3h): Create AUTOMATED_VALIDATION.md, update README
      - Developer Experience (2h): Clear error messages, quick-fix suggestions
      - Testing & Rollout (3h): Test with existing enums, install hooks on all dev machines
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC-1">
      <title>Schema Validation Script</title>
      <description>Script compares DB CHECK constraints with TS enums, detects mismatches, exits with error if found</description>
    </criterion>
    <criterion id="AC-2">
      <title>API Contract Tests</title>
      <description>Tests verify API signatures match TS types, RPC functions use correct columns</description>
    </criterion>
    <criterion id="AC-3">
      <title>Enum Consistency Tests</title>
      <description>Unit tests compare enum values with DB query results, fail if out of sync</description>
    </criterion>
    <criterion id="AC-4">
      <title>Pre-Commit Hook Integration</title>
      <description>Git hook runs schema validation, blocks commit if inconsistencies detected</description>
    </criterion>
    <criterion id="AC-5">
      <title>CI/CD Pipeline Integration</title>
      <description>Validation runs in GitHub Actions, blocks merge on failure</description>
    </criterion>
    <criterion id="AC-6">
      <title>Documentation</title>
      <description>AUTOMATED_VALIDATION.md created, README updated, Pattern 18 documented in architecture.md</description>
    </criterion>
    <criterion id="AC-7">
      <title>Developer Experience</title>
      <description>Clear error messages, fast execution (&lt;5s), easy to run locally</description>
    </criterion>
    <criterion id="AC-8">
      <title>Quality Gates</title>
      <description>All validation scripts working, zero false positives</description>
    </criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/bmm-roadmap-epic-0-p0-fixes.md</path>
        <title>Epic 0 Roadmap</title>
        <section>Story 0.7 Summary</section>
        <snippet>Schema validation script, API contract tests, CI/CD integration, pre-commit hooks. Prevents future inconsistencies.</snippet>
      </doc>
      <doc>
        <path>docs/P0-MODULES-AUDIT-REPORT-2025-11-14.md</path>
        <title>P0 Audit Report</title>
        <section>All 7 Problems</section>
        <snippet>Epic 0 discovered 7 critical inconsistencies. Story 0.7 creates automated prevention to catch issues before commit.</snippet>
      </doc>
    </docs>

    <code>
      <artifact>
        <path>scripts/validate-schema.ts (NEW)</path>
        <kind>Validation Script</kind>
        <symbol>validateSchema()</symbol>
        <lines>all</lines>
        <reason>NEW script - parses migrations for CHECK constraints, parses types.ts for enums, compares, generates report</reason>
      </artifact>
      <artifact>
        <path>__tests__/api-contracts.test.ts (NEW)</path>
        <kind>Unit Test</kind>
        <symbol>API contract tests</symbol>
        <lines>all</lines>
        <reason>NEW tests - verify API method signatures match TypeScript types</reason>
      </artifact>
      <artifact>
        <path>__tests__/enum-consistency.test.ts (NEW)</path>
        <kind>Unit Test</kind>
        <symbol>Enum consistency tests</symbol>
        <lines>all</lines>
        <reason>NEW tests - query DB for valid values, compare with TS enums</reason>
      </artifact>
      <artifact>
        <path>.husky/pre-commit</path>
        <kind>Git Hook</kind>
        <symbol>pre-commit hook</symbol>
        <lines>all</lines>
        <reason>UPDATE to run schema validation before allowing commit</reason>
      </artifact>
      <artifact>
        <path>.github/workflows/ci.yml</path>
        <kind>CI/CD Config</kind>
        <symbol>GitHub Actions workflow</symbol>
        <lines>all</lines>
        <reason>UPDATE to add schema validation job, block merge on failure</reason>
      </artifact>
    </code>

    <dependencies>
      <ecosystem name="Node.js/pnpm">
        <package name="typescript" version="^5.7.2" />
        <package name="ts-morph" version="latest (NEW)" note="TypeScript AST parser for extracting enums" />
        <package name="@supabase/supabase-js" version="^2.75.0" />
        <package name="vitest" version="^4.0.6" />
      </ecosystem>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="performance">
      Script must execute in &lt;5 seconds. Use caching, parallel processing, skip unchanged files (git diff).
    </constraint>
    <constraint type="false-positives">
      Zero false positives. Provide whitelist file (schema-validation-ignore.json) for known exceptions. Support inline comments: // schema-validation-ignore
    </constraint>
    <constraint type="developer-experience">
      Error messages MUST be actionable: show exact file:line to fix, suggest which value to add/remove. Developer workflow: modify DB → hook blocks commit → update TS → hook passes → commit succeeds.
    </constraint>
    <constraint type="root-cause-prevention">
      Epic 0 found 7 inconsistencies manually. Story 0.7 prevents future occurrences. This is the FINAL story in Epic 0 - closes the loop.
    </constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>Schema Validation API</name>
      <kind>TypeScript Function</kind>
      <signature>async function validateSchema(): Promise&lt;ValidationReport&gt; { /* parse migrations, parse TS, compare, report */ }</signature>
      <path>scripts/validate-schema.ts (NEW)</path>
      <usage>Called by pre-commit hook and CI/CD pipeline</usage>
    </interface>
    <interface>
      <name>Validation Report</name>
      <kind>TypeScript Interface</kind>
      <signature>interface ValidationReport { mismatches: Mismatch[], passed: boolean }</signature>
      <path>scripts/validate-schema.ts (NEW)</path>
      <usage>Output format for schema validation script</usage>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Script itself needs testing. Create test cases: (1) Intentional mismatch → script detects it, (2) Perfect sync → script passes, (3) Case mismatch → script catches it. Test pre-commit hook blocks bad commits.
    </standards>

    <locations>
      - Validation script tests: scripts/__tests__/validate-schema.test.ts (NEW)
      - API contract tests: apps/frontend/__tests__/api-contracts.test.ts (NEW)
      - Enum consistency tests: apps/frontend/__tests__/enum-consistency.test.ts (NEW)
    </locations>

    <ideas>
      <test ac="AC-1">
        Test: Create migration with CHECK constraint, create TS enum missing a value → script detects mismatch
      </test>
      <test ac="AC-1">
        Test: DB and TS perfectly synced → script passes with zero errors
      </test>
      <test ac="AC-1">
        Test: Case mismatch (DB lowercase, TS PascalCase) → script detects and reports
      </test>
      <test ac="AC-4">
        Test: Pre-commit hook blocks commit when validation fails
      </test>
      <test ac="AC-7">
        Test: Script executes in &lt;5 seconds on full codebase
      </test>
    </ideas>
  </tests>
</story-context>
