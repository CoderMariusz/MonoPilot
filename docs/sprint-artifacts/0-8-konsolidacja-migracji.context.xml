<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>0</epicId>
    <storyId>0.8</storyId>
    <title>Konsolidacja Migracji (64 → 1 Master) (CRITICAL)</title>
    <status>drafted</status>
    <generatedAt>2025-11-15</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/0-8-konsolidacja-migracji.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>Developer / Database Administrator</asA>
    <iWant>all 64 migration files consolidated into 1 master migration file with dual validation</iWant>
    <soThat>database schema can be reset with 100% confidence and future maintenance is simplified</soThat>
    <tasks>
### Task 1: AI Generation from Architecture.md (AC-1) - 3 hours
- [ ] 1.1: Mary reads complete Architecture.md
- [ ] 1.2: Extract all SQL CREATE TABLE snippets
- [ ] 1.3: Generate complete schema with proper ordering
- [ ] 1.4: Add indexes, constraints, comments
- [ ] 1.5: Save as `master_migration_ai.sql`

### Task 2: Manual Merge of 64 Migrations (AC-1) - 4 hours
- [ ] 2.1: List all 64 migration files in order
- [ ] 2.2: Concatenate CREATE TABLE statements
- [ ] 2.3: Merge ALTER TABLE changes into CREATE statements
- [ ] 2.4: Consolidate indexes, constraints, comments
- [ ] 2.5: Save as `master_migration_manual.sql`

### Task 3: Diff Analysis (AC-2) - 2 hours
- [ ] 3.1: Run diff tool: `master_migration_ai.sql` vs `master_migration_manual.sql`
- [ ] 3.2: Categorize differences (missing table, column, type mismatch, etc.)
- [ ] 3.3: Document each discrepancy with context
- [ ] 3.4: Generate diff report

### Task 4: Human Review & Reconciliation (AC-2, AC-4) - 3 hours
- [ ] 4.1: Review diff report line by line
- [ ] 4.2: For each discrepancy, decide: AI version, manual version, or hybrid
- [ ] 4.3: Verify Epic 0 audit issues are addressed
- [ ] 4.4: Create final `master_migration.sql`

### Task 5: Quality Check (AC-3, AC-5) - 2 hours
- [ ] 5.1: Verify all 40+ tables present
- [ ] 5.2: Check proper ordering (no FK before table exists)
- [ ] 5.3: Validate SQL syntax (dry run parse)
- [ ] 5.4: Add header comments and documentation
- [ ] 5.5: Section organization and readability

### Task 6: Validation Report (AC-6) - 1 hour
- [ ] 6.1: Write diff report with all findings
- [ ] 6.2: Document decisions made
- [ ] 6.3: Save to `docs/sprint-artifacts/0-8-migration-diff-report.md`
- [ ] 6.4: Mark story as ready for review
    </tasks>
  </story>

  <acceptanceCriteria>
### AC-1: Dual Generation Process
- AI (Mary) generates master migration FROM Architecture.md
- Manual merge of 64 existing migration files into single file
- Both approaches produce complete schema definitions
- All CREATE TABLE, INDEX, COMMENT, CONSTRAINT statements included

### AC-2: Diff Validation
- Automated diff between AI-generated vs manually-merged
- Identify discrepancies (missing tables, columns, constraints)
- Document differences with explanations
- Human review decides correct version for each discrepancy

### AC-3: Master Migration Quality
- Single file: `master_migration.sql` (~2000-3000 lines)
- Proper ordering: tables before foreign keys, types before tables
- All 40+ tables included with complete definitions
- Comments preserved from original migrations
- Readable structure with clear sections

### AC-4: Schema Completeness Verification
- All tables from DATABASE_SCHEMA.md present
- All columns from TypeScript types present
- All known issues from Epic 0 audit addressed:
  - to_line.notes (Pattern A)
  - locations.zone (Pattern B)
  - po_header.warehouse_id (Pattern C)
  - license_plates.status enum (Pattern C)

### AC-5: Documentation
- Migration header with purpose, date, Epic 0 reference
- Section comments for each module (Planning, Warehouse, Technical, etc.)
- Cross-reference to Architecture.md sections
- Rollback strategy documented

### AC-6: Validation Report
- Diff report saved to `docs/sprint-artifacts/0-8-migration-diff-report.md`
- List of all discrepancies found
- Decisions made for each discrepancy
- Final master migration approved and ready for 0.9
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/architecture.md</path>
        <title>MonoPilot MES - Architecture Document</title>
        <section>Decision #1: Squash Migrations Periodically</section>
        <snippet>Currently 85+ migration files. Squash quarterly to baseline for faster new env setup. This story implements the first consolidation (64 → 1 master).</snippet>
      </doc>
      <doc>
        <path>docs/bmm-roadmap-epic-0-p0-fixes.md</path>
        <title>Epic 0 - P0 Modules Data Integrity Fixes</title>
        <section>Audit Findings</section>
        <snippet>Pattern A: Migrations written but not executed. Pattern B: TypeScript updated but migrations not. Pattern C: Fix migrations status unclear. Solution: Reset DB with 1 master migration.</snippet>
      </doc>
      <doc>
        <path>docs/DATABASE_SCHEMA.md</path>
        <title>Database Schema Documentation (Auto-generated)</title>
        <section>40+ tables</section>
        <snippet>Validation source for master migration - ensures all tables, columns, constraints, indexes are included.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>apps/frontend/lib/supabase/migrations/</path>
        <kind>directory</kind>
        <symbol>64 migration files (000-059)</symbol>
        <lines>-</lines>
        <reason>Source files to be consolidated. Sequential migrations from 000_enums.sql to 059_uom_master_table.sql. Includes table creations, alterations, indexes, RPC functions.</reason>
      </artifact>
      <artifact>
        <path>apps/frontend/lib/types.ts</path>
        <kind>types</kind>
        <symbol>Database type definitions</symbol>
        <lines>all</lines>
        <reason>TypeScript types must match database schema. Used to verify column types and enums in master migration.</reason>
      </artifact>
      <artifact>
        <path>apps/frontend/lib/supabase/generated.types.ts</path>
        <kind>generated-types</kind>
        <symbol>Auto-generated from Supabase schema</symbol>
        <lines>all</lines>
        <reason>Generated via pnpm gen-types. Secondary validation source for schema completeness.</reason>
      </artifact>
    </code>
    <dependencies>
      <ecosystem name="node">
        <package name="@supabase/supabase-js" version="^2.x" />
        <package name="typescript" version="5.7" />
        <package name="next" version="15" />
      </ecosystem>
      <ecosystem name="database">
        <package name="PostgreSQL" version="15" />
        <package name="Supabase" version="cloud" />
      </ecosystem>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>SQL ordering: ENUMs and TYPEs before tables, base tables before tables with FKs, triggers after tables</constraint>
    <constraint>Multi-tenancy: All business tables MUST have org_id column with RLS policies</constraint>
    <constraint>Audit trail: created_by, updated_by, created_at, updated_at on most tables</constraint>
    <constraint>Epic 0 fixes MUST be included: po_header.warehouse_id, locations.zone, to_line.notes, license_plates.status enum (10 values)</constraint>
    <constraint>Migration file size: ~2000-3000 lines (if exceeds 4000, split into logical modules)</constraint>
    <constraint>Comments required: Table purpose, module grouping, critical business rules</constraint>
    <constraint>Rollback strategy: Document in header - likely requires full DB reset for master migration</constraint>
  </constraints>
  <interfaces>
    <interface>
      <name>PostgreSQL Schema DDL</name>
      <kind>SQL</kind>
      <signature>CREATE TABLE, ALTER TABLE, CREATE INDEX, CREATE FUNCTION, CREATE TRIGGER, COMMENT ON</signature>
      <path>apps/frontend/lib/supabase/migrations/*.sql</path>
    </interface>
    <interface>
      <name>Supabase Row Level Security</name>
      <kind>SQL Policy</kind>
      <signature>CREATE POLICY, ALTER POLICY, GRANT/REVOKE</signature>
      <path>apps/frontend/lib/supabase/migrations/*.sql</path>
    </interface>
    <interface>
      <name>TypeScript Database Types</name>
      <kind>TypeScript Interface</kind>
      <signature>export interface TableName { columns... }</signature>
      <path>apps/frontend/lib/types.ts</path>
    </interface>
  </interfaces>
  <tests>
    <standards>Testing approach for migration consolidation: (1) SQL Syntax Validation with PostgreSQL parser, (2) Schema Comparison old vs new, (3) Data Migration Test on test DB, (4) Type Validation via pnpm gen-types, (5) E2E Smoke Tests for regressions</standards>
    <locations>apps/frontend/__tests__/ (unit tests), apps/frontend/e2e/ (Playwright E2E tests), apps/frontend/lib/supabase/migrations/ (migration files)</locations>
    <ideas>
      <idea ac="AC-1">Test: AI generation produces valid SQL syntax (PostgreSQL parser)</idea>
      <idea ac="AC-1">Test: Manual merge produces valid SQL syntax</idea>
      <idea ac="AC-2">Test: Diff tool identifies all discrepancies between AI vs manual</idea>
      <idea ac="AC-3">Test: Master migration executes successfully on fresh test DB</idea>
      <idea ac="AC-4">Test: All 40+ tables from DATABASE_SCHEMA.md present in master migration</idea>
      <idea ac="AC-4">Test: Epic 0 fixes verified (po_header.warehouse_id, locations.zone, etc.)</idea>
      <idea ac="AC-5">Test: Migration header contains required documentation</idea>
      <idea ac="AC-6">Test: Diff report saved to correct location with all required sections</idea>
    </ideas>
  </tests>
</story-context>
