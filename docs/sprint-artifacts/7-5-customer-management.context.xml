<story-context id="7-5-customer-management" v="1.0">
  <metadata>
    <epicId>7</epicId>
    <storyId>5</storyId>
    <title>Customer Management</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-11-24</generatedAt>
    <template>Template A - CRUD Pattern</template>
    <estimatedTokens>5000</estimatedTokens>
    <estimatedEffort>1 day</estimatedEffort>
  </metadata>

  <story>
    <asA>Sales user</asA>
    <iWant>to manage customer master data</iWant>
    <soThat>customer information is tracked for sales orders</soThat>
    <tasks>
      <task id="1" ac="AC-7.5.1">Customers Table Schema - customers table with code, name, address, tax_code, payment_terms</task>
      <task id="2" ac="AC-7.5.2">Customer CRUD Service - createCustomer(), updateCustomer(), deleteCustomer() with validation</task>
      <task id="3" ac="AC-7.5.3">Customer Code Generation - Auto-generate customer_code (CUST-NNNN) or manual entry</task>
      <task id="4" ac="AC-7.5.4">API Routes - GET/POST/PUT/DELETE /api/settings/customers endpoints</task>
      <task id="5" ac="AC-7.5.5">Customers List Page - Table displaying Code, Name, Address, Tax Code, Status with filters</task>
      <task id="6" ac="AC-7.5.6">Customer Form Modal - Modal for creating/editing customers with code, name, address, tax info</task>
      <task id="7" ac="AC-7.5.7">Validation - Zod schema for customer creation with unique code validation</task>
      <task id="8" ac="ALL">Unit & Integration Tests - Customer CRUD tests, code uniqueness tests, API tests</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC-7.5.1">Given user has Sales or Admin role, When they navigate to /settings/customers, Then they see table with: Code, Name, Address, Tax Code, Status</criterion>
    <criterion id="AC-7.5.2">When clicking "Add Customer", Then modal opens with fields: customer_code (required, auto-generated or manual), name (required), address (street, city, state, postal_code, country), tax_code (dropdown, reference to tax_codes table), payment_terms (text, e.g., "Net 30"), is_active (toggle, default: true)</criterion>
    <criterion id="AC-7.5.3">When saving customer, Then customer created with unique customer_code And default is_active = true</criterion>
    <criterion id="AC-7.5.4">API: POST /api/settings/customers - Request body: { customer_code: string, name: string, address: object, tax_code?: string, payment_terms?: string, is_active?: boolean } - Response: { data: Customer } with status 201</criterion>
    <criterion id="AC-7.5.5">Service validates: customer_code is unique within org, name is not empty, tax_code exists if provided</criterion>
    <criterion id="AC-7.5.6">Customers table supports filtering by: name (search), is_active (toggle), and sorting by code, name</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/epics/epic-7-shipping.md</path>
        <title>Epic 7: Shipping & Order Fulfillment</title>
        <section>Story 7.1: Sales Order CRUD</section>
        <snippet>Prerequisites: Epic 1 (Customers table). Customer management is prerequisite for sales orders.</snippet>
      </doc>
      <doc>
        <path>docs/TEMPLATE_LIBRARY_INDEX.md</path>
        <title>Template Library Index</title>
        <section>Template A: CRUD Pattern</section>
        <snippet>Standard CRUD pattern: Component → API Route → Service Layer → Database. POST/GET/PUT/DELETE endpoints. Zod validation on client and server.</snippet>
      </doc>
    </docs>

    <code>
      <artifact>
        <path>app/api/settings/customers</path>
        <kind>directory</kind>
        <symbol>Customers API route location</symbol>
        <reason>Story requires creating route.ts for GET/POST/PUT/DELETE /api/settings/customers endpoints</reason>
      </artifact>
      <artifact>
        <path>lib/services/customer-service.ts</path>
        <kind>file</kind>
        <symbol>Customer service layer</symbol>
        <reason>Story requires createCustomer(), updateCustomer(), deleteCustomer() methods with code uniqueness validation</reason>
      </artifact>
      <artifact>
        <path>lib/validation/customer-schemas.ts</path>
        <kind>file</kind>
        <symbol>Customer Zod schemas</symbol>
        <reason>Story requires createCustomerSchema for validating customer creation input</reason>
      </artifact>
      <artifact>
        <path>components/settings/CustomersTable.tsx</path>
        <kind>component</kind>
        <symbol>CustomersTable</symbol>
        <reason>Story requires table displaying Code, Name, Address, Tax Code, Status with filters</reason>
      </artifact>
      <artifact>
        <path>components/settings/CustomerFormModal.tsx</path>
        <kind>component</kind>
        <symbol>CustomerFormModal</symbol>
        <reason>Story requires modal for creating/editing customers with code, name, address, tax info</reason>
      </artifact>
      <artifact>
        <path>app/settings/customers/page.tsx</path>
        <kind>page</kind>
        <symbol>Customers List page</symbol>
        <reason>Story requires page at /settings/customers with customer list table</reason>
      </artifact>
    </code>

    <dependencies>
      <node>
        <package name="@supabase/supabase-js" version="^2.84.0" usage="Supabase client for customer CRUD operations" />
        <package name="zod" version="^3.25.76" usage="Validation schemas for customer creation/update" />
        <package name="react-hook-form" version="^7.66.1" usage="Form state management for customer form modal" />
        <package name="next" version="^15.1.4" usage="Next.js framework with App Router for API routes and pages" />
      </node>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="architecture">Template A CRUD Pattern - Component → API Route → Service Layer → Database</constraint>
    <constraint type="business">Customer code uniqueness - customer_code must be unique within org</constraint>
    <constraint type="business">Status initialization - new customers created with is_active = true</constraint>
    <constraint type="business">Multi-tenancy - all customer operations scoped by org_id</constraint>
    <constraint type="validation">Zod validation - required on BOTH client and server for customer input</constraint>
    <constraint type="validation">Tax code validation - if tax_code provided, validate it exists in tax_codes table</constraint>
    <constraint type="testing">Test pyramid - 95% unit coverage for customer service, 70% integration coverage, 100% E2E coverage</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>POST /api/settings/customers</name>
      <kind>API route</kind>
      <signature>POST /api/settings/customers - Request body: { customer_code: string, name: string, address: object, tax_code?: string, payment_terms?: string, is_active?: boolean } - Response: { data: Customer } or error 400</signature>
      <path>app/api/settings/customers/route.ts</path>
    </interface>
    <interface>
      <name>GET /api/settings/customers</name>
      <kind>API route</kind>
      <signature>GET /api/settings/customers?search=name&is_active=true - Response: { data: Customer[] } - Supports filtering by name, is_active, sorting</signature>
      <path>app/api/settings/customers/route.ts</path>
    </interface>
    <interface>
      <name>createCustomer</name>
      <kind>service function</kind>
      <signature>async function createCustomer(input: CreateCustomerInput): Promise&lt;ServiceResult&lt;Customer&gt;&gt; - Validates code uniqueness, tax_code existence, creates customer with is_active=true</signature>
      <path>lib/services/customer-service.ts</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Testing strategy follows Test Pyramid: unit tests for customer service (95% coverage), integration tests for API route (70% coverage), E2E tests for customer management flow (100% user flows). Mock Supabase in unit tests.
    </standards>
    <locations>
      <location>lib/services/__tests__/customer-service.test.ts (Customer CRUD unit tests)</location>
      <location>app/api/settings/customers/__tests__/route.test.ts (API route integration tests)</location>
      <location>e2e/settings/customer-management.e2e.ts (Customer management E2E tests)</location>
    </locations>
    <ideas>
      <idea ac="AC-7.5.5">Unit test: createCustomer() with duplicate customer_code - returns error "Customer code already exists"</idea>
      <idea ac="AC-7.5.3">Unit test: createCustomer() with valid input - creates customer with is_active=true</idea>
      <idea ac="AC-7.5.5">Unit test: createCustomer() with invalid tax_code - returns error "Tax code not found"</idea>
      <idea ac="AC-7.5.4">Integration test: POST /customers with valid input - returns 201 with created customer</idea>
      <idea ac="AC-7.5.4">Integration test: POST /customers with duplicate code - returns 400 error</idea>
      <idea ac="AC-7.5.1">E2E test: Navigate to /settings/customers, table displays customers</idea>
      <idea ac="AC-7.5.2">E2E test: Click "Add Customer", modal opens, submit, customer created</idea>
      <idea ac="AC-7.5.6">E2E test: Filter customers by name, is_active toggle</idea>
    </ideas>
  </tests>
</story-context>
