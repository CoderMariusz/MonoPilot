# Story 1.6.3: Allergen Matrix Visualization

Status: completed

## Story

As a **Quality Manager / Technical Manager**,
I want **allergen cross-contamination matrix heatmap with export to PDF**,
so that **allergen audits take 15 minutes (vs 2 hours manual spreadsheet) and 100% audit coverage is enforced**.

## Acceptance Criteria

### AC-1: Allergen Matrix Heatmap
- 14×N matrix: Rows = 14 EU allergens (Gluten, Milk, Eggs, Fish, etc.), Columns = Production lines (A, B, C, D)
- Cell color coding: Green (allergen-free), Yellow (minor risk), Red (high risk - allergen present)
- Cell click → drill-down modal: Show products with this allergen on this line
- Tooltip on hover: "Line A: 12 products contain Gluten"

### AC-2: Risk Scoring
- Risk score calculation: (# products with allergen on line) × (allergen severity weight)
- Severity weights: Gluten=1, Peanuts=3 (high severity), Fish=2, etc.
- Risk levels: 0-5 (Green), 6-15 (Yellow), 16+ (Red)

### AC-3: Cross-Contamination Warnings
- Auto-detect potential cross-contamination: If Line A runs Gluten product AND Gluten-free product → Warning
- Warning modal: "Line A runs both WHEAT-BREAD (contains Gluten) and RICE-CRACKERS (Gluten-free). Risk of cross-contamination!"
- Suggest mitigation: "Run Gluten-free products first, then Gluten products" OR "Assign Gluten-free to Line B only"

### AC-4: Allergen Audit Report (PDF Export)
- Generate PDF report: Allergen Matrix + Cross-Contamination Warnings + Product List per Allergen
- PDF sections: Cover page, Matrix heatmap (visual), Warnings (text), Product Details (table)
- PDF metadata: Generated date, generated by (user), org name

### AC-5: Line Allergen Rules
- Define allergen rules per line: "Line B is Gluten-free ONLY" → Block scheduling Gluten products on Line B
- Rule enforcement: WO creation validates product allergens vs line rules → reject if violation
- Override permission: Admin/Manager can override with signature (Story 1.2 E-Signatures integration)

## Tasks / Subtasks

### Task 1: Matrix Heatmap Component (6h)
- [ ] Create 14×N matrix grid (rows=allergens, columns=lines)
- [ ] Color coding (green/yellow/red based on risk score)
- [ ] Cell click → drill-down modal (products with allergen on line)
- [ ] Tooltip on hover (count + allergen name)

### Task 2: Risk Scoring (4h)
- [ ] Calculate risk score per cell (# products × severity weight)
- [ ] Define severity weights (Gluten=1, Peanuts=3, etc.)
- [ ] Risk level thresholds (0-5 green, 6-15 yellow, 16+ red)

### Task 3: Cross-Contamination Detection (5h)
- [ ] Auto-detect mixed allergen/allergen-free on same line
- [ ] Warning modal (show conflicting products)
- [ ] Mitigation suggestions (run order, line assignment)

### Task 4: PDF Export (5h)
- [ ] Generate PDF report (jsPDF or similar)
- [ ] Sections: Matrix heatmap, Warnings, Product Details
- [ ] PDF metadata (date, user, org)

### Task 5: Line Allergen Rules (4h)
- [ ] Define rules UI (Settings page: "Line B is Gluten-free ONLY")
- [ ] WO creation validation (check product allergens vs line rules)
- [ ] Override with e-signature (integrate Story 1.2)

### Task 6: E2E Tests (4h)
- [ ] E2E: View matrix → cell colors correct (green/yellow/red)
- [ ] E2E: Click cell → drill-down shows products
- [ ] E2E: Cross-contamination detected → warning shown
- [ ] E2E: Export PDF → file downloaded

### Task 7: Documentation (2h)
- [ ] Update architecture.md with allergen matrix workflow

**Total Estimated Effort:** 30 hours (~4 days)

## Dev Notes

**14 EU Allergens (Regulation 1169/2011):**
1. Gluten (wheat, rye, barley, oats)
2. Crustaceans
3. Eggs
4. Fish
5. Peanuts
6. Soybeans
7. Milk (lactose)
8. Nuts (almonds, hazelnuts, walnuts, etc.)
9. Celery
10. Mustard
11. Sesame
12. Sulphur dioxide/sulphites
13. Lupin
14. Molluscs

**Risk Score Formula:**
```typescript
function calculateRiskScore(lineId: number, allergen: string): number {
  const productsWithAllergen = getProductsOnLine(lineId).filter(p => p.allergens.includes(allergen));
  const severityWeight = allergenSeverityWeights[allergen]; // Peanuts=3, Gluten=1, etc.
  return productsWithAllergen.length * severityWeight;
}
```

**MVP Scope:**
✅ Matrix heatmap, risk scoring, cross-contamination warnings, PDF export, line rules
❌ Growth: Allergen trend analysis (over time), supplier allergen tracking, batch testing integration

**Dependencies:** Story 1.2 (E-Signatures) for rule override permission

## Dev Agent Record
### Context Reference
<!-- Will be added by story-context workflow -->
