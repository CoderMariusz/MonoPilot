<story-context id="5-8-asn-creation" v="1.0">
  <metadata>
    <epicId>5</epicId>
    <storyId>8</storyId>
    <title>ASN Creation</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-11-24</generatedAt>
    <template>Template A - CRUD Pattern</template>
    <estimatedTokens>5000</estimatedTokens>
    <estimatedEffort>1 day</estimatedEffort>
  </metadata>

  <story>
    <asA>Warehouse user</asA>
    <iWant>to create ASN for incoming shipments</iWant>
    <soThat>I can prepare for receiving</soThat>
    <tasks>
      <task id="1" ac="AC-5.8.1">ASN Creation Modal - Fields: po_id, expected_arrival_date, carrier, tracking_number</task>
      <task id="2" ac="AC-5.8.2">API Route - POST /api/warehouse/asns for ASN creation</task>
      <task id="3" ac="AC-5.8.3">Service Layer - createASN() with PO validation, org isolation, audit trail</task>
      <task id="4" ac="AC-5.8.4">ASN Items Auto-Fill - Pre-fill ASN items from PO lines on creation</task>
      <task id="5" ac="AC-5.8.5">PO Status Validation - Verify PO status = Confirmed or higher before allowing ASN creation</task>
      <task id="6" ac="AC-5.8.6">ASN Number Generation - Auto-generate asn_number format (ASN-YYYYMMDD-NNNN)</task>
      <task id="7" ac="ALL">Unit & Integration Tests - Service layer tests, API route tests, validation tests</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC-5.8.1">Given PO exists with status Confirmed+, When clicking "Create ASN" on PO detail page, Then modal opens with fields: po_id (pre-filled, read-only), expected_arrival_date (required date picker), carrier (optional text), tracking_number (optional text)</criterion>
    <criterion id="AC-5.8.2">And ASN items auto-populated from PO lines (product, ordered_qty, uom)</criterion>
    <criterion id="AC-5.8.3">When saving, Then ASN created with status = 'draft', linked to PO via po_id</criterion>
    <criterion id="AC-5.8.4">And asn_number auto-generated format: ASN-YYYYMMDD-NNNN with daily sequence</criterion>
    <criterion id="AC-5.8.5">PO validation: PO must exist, status must be 'confirmed' or higher (not Draft/Cancelled), PO must belong to current org</criterion>
    <criterion id="AC-5.8.6">API: POST /api/warehouse/asns - Request body: { po_id, expected_arrival_date, carrier?, tracking_number? } - Response: { data: ASN } with status 201 or error 400</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/epics/epic-5-warehouse.md</path>
        <title>Epic 5: Warehouse & Scanner</title>
        <section>Story 5.8: ASN Creation</section>
        <snippet>Create ASN (Advanced Shipment Notice) for incoming shipments. Link to PO, expected arrival date, carrier, tracking. ASN items from PO lines. Prerequisites: Story 3.1 (PO CRUD).</snippet>
      </doc>
      <doc>
        <path>docs/templates/context/template-a-crud-pattern.md</path>
        <title>Template A: CRUD Pattern</title>
        <section>Overview</section>
        <snippet>Standard CRUD implementation: Component (Modal) → API Route → Service Layer → Database. Multi-tenancy, Service Role pattern, dual validation, audit trail.</snippet>
      </doc>
    </docs>

    <code>
      <artifact>
        <path>app/api/warehouse/asns</path>
        <kind>directory</kind>
        <symbol>ASN API route location</symbol>
        <reason>Story requires creating route.ts for POST /api/warehouse/asns endpoint</reason>
      </artifact>
      <artifact>
        <path>lib/services/asn-service.ts</path>
        <kind>file</kind>
        <symbol>ASN service layer</symbol>
        <reason>Story requires createASN() method with PO validation, org isolation, audit trail</reason>
      </artifact>
      <artifact>
        <path>lib/validation/asn-schemas.ts</path>
        <kind>file</kind>
        <symbol>ASN Zod schemas</symbol>
        <reason>Story requires createASNSchema for validating ASN creation input</reason>
      </artifact>
      <artifact>
        <path>components/warehouse/ASNFormModal.tsx</path>
        <kind>component</kind>
        <symbol>ASNFormModal</symbol>
        <reason>Story requires modal with fields: po_id, expected_arrival_date, carrier, tracking_number</reason>
      </artifact>
      <artifact>
        <path>lib/services/purchase-order-service.ts</path>
        <kind>file</kind>
        <symbol>Purchase Order service</symbol>
        <reason>Story requires getPOById() to validate PO status before ASN creation</reason>
      </artifact>
    </code>

    <dependencies>
      <node>
        <package name="@supabase/supabase-js" version="^2.84.0" usage="Supabase client for ASN creation, PO validation" />
        <package name="zod" version="^3.25.76" usage="Validation schemas for ASN creation request" />
        <package name="react-hook-form" version="^7.66.1" usage="Form state management for ASN creation modal" />
        <package name="date-fns" version="^4.1.0" usage="Date utilities for expected_arrival_date validation" />
      </node>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="architecture">Template A CRUD Pattern - standard CRUD implementation</constraint>
    <constraint type="business">PO validation - PO must exist, status >= Confirmed, same org</constraint>
    <constraint type="business">ASN items auto-fill - populate from PO lines on creation</constraint>
    <constraint type="business">ASN number format - ASN-YYYYMMDD-NNNN with daily sequence</constraint>
    <constraint type="validation">Zod validation - required on BOTH client and server</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>POST /api/warehouse/asns</name>
      <kind>API route</kind>
      <signature>POST /api/warehouse/asns - Request body: { po_id: string, expected_arrival_date: string, carrier?: string, tracking_number?: string } - Response: { data: ASN } or error 400</signature>
      <path>app/api/warehouse/asns/route.ts</path>
    </interface>
    <interface>
      <name>createASN</name>
      <kind>service function</kind>
      <signature>async function createASN(input: CreateASNInput): Promise&lt;ServiceResult&lt;ASN&gt;&gt; - Validates PO, creates ASN with status = 'draft', auto-fills items from PO lines</signature>
      <path>lib/services/asn-service.ts</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Testing strategy: unit tests for ASN service (95% coverage), integration tests for API route (70% coverage), E2E tests for ASN creation flow (100% user flows).
    </standards>
    <locations>
      <location>lib/services/__tests__/asn-service.test.ts (createASN unit tests)</location>
      <location>app/api/warehouse/asns/__tests__/route.test.ts (API route integration tests)</location>
      <location>e2e/warehouse/asn-creation.e2e.ts (ASN creation flow E2E tests)</location>
    </locations>
    <ideas>
      <idea ac="AC-5.8.5">Unit test: createASN() with invalid PO - returns error "PO not found"</idea>
      <idea ac="AC-5.8.5">Unit test: createASN() with PO status = Draft - returns error "PO must be Confirmed"</idea>
      <idea ac="AC-5.8.4">Unit test: createASN() auto-fills ASN items from PO lines</idea>
      <idea ac="AC-5.8.6">Integration test: POST /asns with valid input - returns 201 with created ASN</idea>
      <idea ac="AC-5.8.1">E2E test: Click "Create ASN" on PO page, modal opens with PO pre-filled</idea>
      <idea ac="AC-5.8.3">E2E test: Submit ASN form, ASN created with status = 'draft'</idea>
    </ideas>
  </tests>
</story-context>
