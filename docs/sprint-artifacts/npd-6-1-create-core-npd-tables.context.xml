<?xml version="1.0" encoding="UTF-8"?>
<story-context>
  <metadata>
    <story_key>npd-6-1-create-core-npd-tables</story_key>
    <epic_id>NPD-6</epic_id>
    <story_id>6.1</story_id>
    <title>Create Core NPD Tables</title>
    <generated>2025-11-16</generated>
  </metadata>

  <user_story>
    <as_a>database administrator</as_a>
    <i_want>core NPD tables created with proper schema</i_want>
    <so_that>NPD application can store projects, formulations, and related data</so_that>
  </user_story>

  <acceptance_criteria>
    <criterion id="AC-1">
      <given>Supabase PostgreSQL 15+ database</given>
      <when>migration 100 executes</when>
      <then>3 core tables created: npd_projects, npd_formulations, npd_formulation_items</then>
      <details>
        - npd_projects: id, org_id, project_number, project_name, description, status, current_gate, priority, portfolio_category, owner_id, target_launch_date, created_at, updated_at, created_by, updated_by
        - npd_formulations: id, org_id, npd_project_id, version, effective_from, effective_to, status, locked_at, locked_by, parent_formulation_id, created_at, updated_at, created_by, updated_by
        - npd_formulation_items: id, npd_formulation_id, product_id, qty, uom, sequence, notes, created_at, updated_at
      </details>
    </criterion>
    <criterion id="AC-2">
      <description>Status enums defined</description>
      <details>
        - npd_project_status: idea, concept, development, testing, on_hold, launched, cancelled
        - npd_formulation_status: draft, approved, superseded
        - npd_project_priority: high, medium, low
      </details>
    </criterion>
    <criterion id="AC-3">
      <description>Foreign keys configured</description>
      <details>
        - npd_formulations.npd_project_id → npd_projects.id (CASCADE)
        - npd_formulation_items.npd_formulation_id → npd_formulations.id (CASCADE)
        - npd_formulation_items.product_id → products.id (RESTRICT)
      </details>
    </criterion>
    <criterion id="AC-4">
      <description>Indexes created for performance</description>
      <details>
        - idx_npd_projects_org_id_status
        - idx_npd_formulations_project_id_version
        - idx_npd_formulation_items_formulation_id
      </details>
    </criterion>
  </acceptance_criteria>

  <tasks>
    <task id="T-1">Create migration file 100_create_npd_core_tables.sql</task>
    <task id="T-2">Define npd_projects table with all columns and constraints</task>
    <task id="T-3">Define npd_formulations table with all columns and constraints</task>
    <task id="T-4">Define npd_formulation_items table with all columns and constraints</task>
    <task id="T-5">Create status CHECK constraints (TEXT CHECK pattern, not ENUM)</task>
    <task id="T-6">Create foreign keys with appropriate CASCADE/RESTRICT rules</task>
    <task id="T-7">Create performance indexes</task>
    <task id="T-8">Create sequence for auto-generating project_number</task>
    <task id="T-9">Run pnpm gen-types to generate TypeScript types</task>
    <task id="T-10">Run pnpm docs:update to update DATABASE_SCHEMA.md</task>
  </tasks>

  <artifacts>
    <docs>
      <doc>
        <path>docs/NPD-Module-Epics.md</path>
        <title>NPD Module Epic Breakdown</title>
        <section>Epic NPD-6: Database Schema & Infrastructure</section>
        <snippet>Foundation epic establishing database tables (7 npd_* tables), RLS policies, temporal versioning, and Edge Functions CI/CD for NPD Module.</snippet>
      </doc>
      <doc>
        <path>docs/NPD-Module-Architecture-2025-11-15.md</path>
        <title>NPD Module Architecture</title>
        <section>Database Design</section>
        <snippet>Bounded Context with npd_* tables, optional foreign keys to MonoPilot core, event sourcing with outbox pattern, temporal versioning with EXCLUDE constraints.</snippet>
      </doc>
      <doc>
        <path>docs/MonoPilot-NPD-Module-PRD-2025-11-15.md</path>
        <title>NPD Module PRD</title>
        <section>FR1-FR16: Core NPD Workflow & Formulation Management</section>
        <snippet>Functional requirements for NPD projects (74 FRs total), Stage-Gate methodology (G0-G4), formulation versioning with effective dates.</snippet>
      </doc>
    </docs>

    <code>
      <artifact>
        <path>apps/frontend/lib/supabase/migrations</path>
        <kind>directory</kind>
        <symbol>Migration files</symbol>
        <reason>Existing migration pattern to follow (sequential numbering, SQL structure)</reason>
      </artifact>
      <artifact>
        <path>apps/frontend/lib/supabase/migrations/025_license_plates.sql</path>
        <kind>migration</kind>
        <symbol>License Plates table</symbol>
        <reason>Example of MonoPilot table with TEXT CHECK constraints for status enums</reason>
      </artifact>
      <artifact>
        <path>apps/frontend/lib/supabase/client.ts</path>
        <kind>service</kind>
        <symbol>Supabase client setup</symbol>
        <reason>Database client configuration for MonoPilot</reason>
      </artifact>
    </code>

    <dependencies>
      <node>
        <package>@supabase/supabase-js</package>
        <version>^2.x</version>
      </node>
      <database>
        <package>PostgreSQL</package>
        <version>15+</version>
        <note>Required for tstzrange and EXCLUDE constraints (used in Story 6.5)</note>
      </database>
    </dependencies>
  </artifacts>

  <interfaces>
    <interface>
      <name>products table</name>
      <kind>database-table</kind>
      <signature>Existing MonoPilot table that npd_formulation_items.product_id references</signature>
      <path>apps/frontend/lib/supabase/migrations</path>
    </interface>
  </interfaces>

  <constraints>
    <constraint>Use sequential migration numbering: 100_create_npd_core_tables.sql</constraint>
    <constraint>All tables MUST include org_id column for RLS policies (implemented in Story 6.3)</constraint>
    <constraint>Auto-generate project_number: 'NPD-' || LPAD(nextval('npd_project_number_seq')::text, 5, '0')</constraint>
    <constraint>Status fields use TEXT CHECK constraints (NOT ENUM types for easier modification)</constraint>
    <constraint>Follow MonoPilot conventions: snake_case table/column names, UUID primary keys</constraint>
    <constraint>Include audit columns: created_at, updated_at, created_by, updated_by</constraint>
  </constraints>

  <tests>
    <standards>
      MonoPilot uses Playwright for E2E tests and Vitest for unit tests. Database migrations are tested by running them against staging Supabase instance. TypeScript type generation (pnpm gen-types) validates schema correctness.
    </standards>
    <locations>
      - apps/frontend/e2e/ (Playwright E2E tests)
      - apps/frontend/__tests__/ (Vitest unit tests)
      - Migrations tested via staging deployment
    </locations>
    <ideas>
      <idea criterion="AC-1">Verify migration 100 creates 3 tables with correct columns</idea>
      <idea criterion="AC-2">Test TEXT CHECK constraints allow only valid status values</idea>
      <idea criterion="AC-3">Verify foreign keys CASCADE/RESTRICT behavior</idea>
      <idea criterion="AC-4">Verify indexes exist using pg_indexes system view</idea>
      <idea>Test project_number auto-generation produces 'NPD-00001' format</idea>
      <idea>Verify pnpm gen-types generates TypeScript types for npd_* tables</idea>
    </ideas>
  </tests>

  <technical_notes>
    <note>Migration 100 is the FIRST NPD migration - establishes foundation</note>
    <note>RLS policies will be added in Story 6.3 - tables functional but not secured yet</note>
    <note>Temporal versioning constraints added in Story 6.5 (EXCLUDE on effective dates)</note>
    <note>This story has NO prerequisites - safe to implement first</note>
  </technical_notes>

  <prerequisites>
    <prerequisite>None - this is the first story in Epic NPD-6</prerequisite>
  </prerequisites>
</story-context>
