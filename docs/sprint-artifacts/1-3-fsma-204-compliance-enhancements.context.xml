<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>3</storyId>
    <title>FSMA 204 Compliance Enhancements</title>
    <status>drafted</status>
    <generatedAt>2025-11-16</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/1-3-fsma-204-compliance-enhancements.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>Quality Manager / Compliance Officer</asA>
    <iWant>FSMA 204-compliant traceability with Critical Tracking Events (CTEs) and Key Data Elements (KDEs)</iWant>
    <soThat>recall simulation can be executed in &lt;30 seconds and FDA traceability requirements are met by 2028 deadline</soThat>
    <tasks>See source story for 9 tasks covering: Data model extensions, CTE auto-logging, recall simulation engine, compliance reporting, FTL management UI, KDE validation, compliance dashboard, E2E tests, documentation. Total: 46 hours (~6 days)</tasks>
  </story>

  <acceptanceCriteria>8 ACs: (1) FSMA 204 data model extensions (fsma_tracking_events, fsma_ftl_products tables, LP table KDE columns), (2) CTE auto-logging on 4 operations (receiving, transformation, shipping, creation), (3) Recall simulation engine (&lt;30s performance), (4) FSMA 204 compliance report with PDF export, (5) FTL management UI at /settings/fsma-compliance, (6) KDE validation blocking operations, (7) Compliance dashboard widget, (8) Documentation updates</acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="docs/MonoPilot-PRD-2025-11-13.md" title="Main PRD" section="LP Genealogy &amp; FSMA 204">
        FSMA 204 requirements: LP-based genealogy, forward/backward traceability, recall simulation &lt;30s, Critical Tracking Events (4 types: creation, transformation, shipping, receiving), Key Data Elements for Food Traceability List products. Compliance deadline: Jan 2026 (large), Jan 2027 (small).
      </doc>
      <doc path="docs/architecture.md" title="Architecture" section="LP Genealogy">
        Existing LP genealogy pattern with recursive CTEs for traceability. Decision #3: Recursive Queries (PostgreSQL CTE) - meets &lt;1 min requirement for 100+ LP tree. Story 1.3 extends this for FSMA 204 compliance.
      </doc>
    </docs>
    <code>
      <artifact path="apps/frontend/lib/api/traceability.ts" kind="API Class" symbol="TraceabilityAPI">
        Existing traceability methods - extend with simulateRecall() and generateFSMA204Report()
      </artifact>
      <artifact path="apps/frontend/lib/api/grns.ts" kind="API Class" symbol="GRNsAPI.create()">
        Update to log CTE_RECEIVING event when GRN created
      </artifact>
      <artifact path="apps/frontend/lib/api/workOrders.ts" kind="API Class" symbol="WorkOrdersAPI.registerOutput()">
        Update to log CTE_TRANSFORMATION event when output registered
      </artifact>
      <artifact path="apps/frontend/lib/api/transferOrders.ts" kind="API Class" symbol="TransferOrdersAPI.ship()">
        Update to log CTE_SHIPPING event when TO shipped
      </artifact>
    </code>
    <dependencies>
      <framework>PostgreSQL recursive CTEs (Common Table Expressions)</framework>
      <framework>jsPDF or similar for PDF export</framework>
      <testing>Playwright E2E for recall simulation and compliance workflows</testing>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="performance">Recall simulation must complete &lt;30 seconds for 100+ LP genealogy tree. Use recursive CTE optimization.</constraint>
    <constraint type="compliance">FDA FSMA 204 requirements: TLC (traceability lot code), harvest_date for produce, cooling_date for fresh-cut, first_land_date for seafood. KDEs must be validated before operations.</constraint>
    <constraint type="architectural">CTEs must be logged automatically (no manual entry). Integrate into existing API operations (GRN, WO output, TO ship, LP creation).</constraint>
    <constraint type="validation">FTL products require KDE validation. Block GRN/WO operations if required fields missing.</constraint>
  </constraints>

  <interfaces>
    <interface name="TraceabilityAPI.simulateRecall()" kind="Method">
      <signature>static async simulateRecall(lp_number: string, reason: string): Promise&lt;RecallReport&gt;</signature>
      <path>apps/frontend/lib/api/traceability.ts</path>
    </interface>
    <interface name="TraceabilityAPI.generateFSMA204Report()" kind="Method">
      <signature>static async generateFSMA204Report(start_date: Date, end_date: Date, product_id?: number): Promise&lt;FSMA204Report&gt;</signature>
      <path>apps/frontend/lib/api/traceability.ts</path>
    </interface>
    <interface name="fsma_tracking_events table" kind="Database Table">
      <signature>Columns: id, org_id, event_type (creation/transformation/shipping/receiving), lp_id, location_id, timestamp, reference_doc, created_by. RLS enabled.</signature>
      <path>apps/frontend/lib/supabase/migrations/XXX_fsma_204_compliance.sql</path>
    </interface>
  </interfaces>

  <tests>
    <standards>Risk-Based E2E: HIGH RISK (recall simulation, KDE validation) + COMPLEX (CTE auto-logging) require E2E tests. Performance test: recall &lt;30s for 100+ LPs.</standards>
    <locations>
      <e2e>apps/frontend/e2e/fsma-204-compliance.spec.ts</e2e>
      <unit>apps/frontend/__tests__/traceability.test.ts</unit>
    </locations>
    <ideas>
      <test ac="AC-6" risk="CRITICAL">E2E: Receive FTL product without lot code → blocked with validation error</test>
      <test ac="AC-2" risk="HIGH">E2E: Receive GRN → verify CTE_RECEIVING logged automatically</test>
      <test ac="AC-2" risk="HIGH">E2E: Register WO output → verify CTE_TRANSFORMATION logged</test>
      <test ac="AC-3" risk="CRITICAL">E2E: Recall simulation on LP → verify affected LPs identified in &lt;30 seconds</test>
      <test ac="AC-4" risk="MEDIUM">E2E: Generate FSMA 204 report → PDF exported with correct data</test>
    </ideas>
  </tests>
</story-context>
