<story-context id="3-18-supplier-contact-management" v="1.0">
  <metadata>
    <epicId>3</epicId>
    <storyId>18</storyId>
    <title>Supplier-Product Assignments</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-11-24</generatedAt>
    <template>Template B - Line Items Pattern</template>
    <estimatedTokens>3500</estimatedTokens>
    <estimatedEffort>1 day</estimatedEffort>
  </metadata>

  <story>
    <asA>Purchasing user</asA>
    <iWant>to assign products to suppliers</iWant>
    <soThat>I know where to order each product</soThat>
    <tasks>
      <task id="1" ac="AC-3.18.1">Supplier Products Table Schema - supplier_products table with supplier_id, product_id, is_default, supplier_product_code, unit_price, moq</task>
      <task id="2" ac="AC-3.18.2">Supplier Product Assignment Service - assignProductToSupplier(), updateSupplierProduct(), removeSupplierProduct()</task>
      <task id="3" ac="AC-3.18.3">Default Supplier Logic - Only one default supplier per product (UNIQUE constraint or validation)</task>
      <task id="4" ac="AC-3.18.4">API Routes - PUT /api/planning/suppliers/:id/products endpoint</task>
      <task id="5" ac="AC-3.18.5">Supplier Products Tab UI - Products tab on supplier detail page showing assigned products</task>
      <task id="6" ac="ALL">Unit & Integration Tests - Product assignment tests, default supplier tests</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC-3.18.1">Given supplier exists, When viewing supplier detail, Then see Products tab with assigned products</criterion>
    <criterion id="AC-3.18.2">When clicking "Assign Products", Then modal shows available products And can set per product: is_default (only one default per product), supplier_product_code, lead_time_days (override), unit_price, moq</criterion>
    <criterion id="AC-3.18.3">When bulk creating PO, Then uses default supplier per product</criterion>
    <criterion id="AC-3.18.4">supplier_products table with UNIQUE (supplier_id, product_id); is_default logic ensures only one default per product</criterion>
    <criterion id="AC-3.18.5">API: PUT /api/planning/suppliers/:id/products - Request: { products: [{ product_id, is_default, supplier_product_code?, unit_price?, moq? }] } - Response: { data: SupplierProduct[] }</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/epics/epic-3-planning.md</path>
        <title>Epic 3: Planning Operations</title>
        <section>Story 3.18: Supplier-Product Assignments</section>
        <snippet>Assign products to suppliers. supplier_products table with supplier_id, product_id, is_default, supplier_product_code, lead_time_days, unit_price, moq. Only one default per product. Bulk PO uses default supplier. UNIQUE (supplier_id, product_id). Prerequisites: Story 3.17, Story 2.1.</snippet>
      </doc>
    </docs>

    <code>
      <artifact>
        <path>app/api/planning/suppliers/[id]/products</path>
        <kind>directory</kind>
        <symbol>Supplier Products API route</symbol>
        <reason>Story requires route.ts for PUT /api/planning/suppliers/:id/products</reason>
      </artifact>
      <artifact>
        <path>lib/services/supplier-product-service.ts</path>
        <kind>file</kind>
        <symbol>Supplier Product service layer</symbol>
        <reason>Story requires assignProductToSupplier(), updateSupplierProduct(), removeSupplierProduct()</reason>
      </artifact>
    </code>

    <dependencies>
      <node>
        <package name="@supabase/supabase-js" version="^2.84.0" usage="Supabase client for supplier-product assignments" />
      </node>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="architecture">Template B Line Items Pattern - parent-child (Supplier â†’ Supplier Products)</constraint>
    <constraint type="business">Only one default supplier per product - validation or UNIQUE constraint</constraint>
    <constraint type="business">UNIQUE (supplier_id, product_id) - prevent duplicate assignments</constraint>
    <constraint type="testing">Test pyramid - 95% unit, 70% integration, 100% E2E</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>PUT /api/planning/suppliers/:id/products</name>
      <kind>API route</kind>
      <signature>PUT /api/planning/suppliers/{supplier_id}/products - Request: { products: array } - Response: { data: SupplierProduct[] }</signature>
      <path>app/api/planning/suppliers/[id]/products/route.ts</path>
    </interface>
  </interfaces>

  <tests>
    <standards>Test Pyramid: unit tests (95%), integration tests (70%), E2E tests (100%)</standards>
    <locations>
      <location>lib/services/__tests__/supplier-product-service.test.ts</location>
    </locations>
    <ideas>
      <idea ac="AC-3.18.3">Unit test: assignProductToSupplier() with is_default=true - validates only one default per product</idea>
    </ideas>
  </tests>
</story-context>
