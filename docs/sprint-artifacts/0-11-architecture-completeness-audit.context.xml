<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>0</epicId>
    <storyId>11</storyId>
    <title>Architecture.md Completeness Audit</title>
    <status>drafted</status>
    <generatedAt>2025-11-15</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/0-11-architecture-completeness-audit.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>Developer / Technical Writer</asA>
    <iWant>Architecture.md to contain complete and accurate schema definitions for all 40+ tables</iWant>
    <soThat>it can serve as the single source of truth for future migration generation</soThat>
    <tasks>
### Task 1: Inventory Current Documentation (AC-1) - 2 hours
- [ ] 1.1: Read Architecture.md completely
- [ ] 1.2: List all tables documented with SQL snippets
- [ ] 1.3: List all tables mentioned but without full definition
- [ ] 1.4: Compare with DATABASE_SCHEMA.md table list
- [ ] 1.5: Create missing tables list

### Task 2: Column-by-Column Audit (AC-2) - 4 hours
- [ ] 2.1: For each documented table, list all columns in Architecture.md
- [ ] 2.2: Compare with DATABASE_SCHEMA.md column list
- [ ] 2.3: Identify missing columns per table
- [ ] 2.4: Identify type mismatches (VARCHAR vs TEXT, etc.)
- [ ] 2.5: Document missing constraints (FK, CHECK, UNIQUE)

### Task 3: SQL Snippet Validation (AC-3) - 3 hours
- [ ] 3.1: Extract all CREATE TABLE snippets from Architecture.md
- [ ] 3.2: Run syntax validation (parse with PostgreSQL parser or AI)
- [ ] 3.3: Identify syntax errors, typos, incorrect types
- [ ] 3.4: Compare constraints with actual DB
- [ ] 3.5: Document corrections needed

### Task 4: Gap Analysis (AC-4) - 2 hours
- [ ] 4.1: Compile comprehensive gaps list (tables, columns, snippets)
- [ ] 4.2: Categorize by severity: CRITICAL, HIGH, MEDIUM, LOW
- [ ] 4.3: Estimate effort to fill each gap
- [ ] 4.4: Prioritize gaps for immediate vs future fix

### Task 5: Documentation Quality Review (AC-5) - 2 hours
- [ ] 5.1: Check section organization and headers
- [ ] 5.2: Verify formatting consistency
- [ ] 5.3: Identify missing examples or explanations
- [ ] 5.4: Review cross-references and links
- [ ] 5.5: Note areas needing improvement

### Task 6: Comparison Report (AC-6) - 2 hours
- [ ] 6.1: Create side-by-side comparison table
- [ ] 6.2: For each discrepancy, determine correct source
- [ ] 6.3: Document action plan:
  - Add missing tables to Architecture.md
  - Add missing columns to existing table docs
  - Correct SQL snippets
  - Improve documentation quality
- [ ] 6.4: Save report to `docs/sprint-artifacts/0-11-architecture-audit-report.md`

**Total Estimated Effort:** 15 hours (~2 days)
    </tasks>
  </story>

  <acceptanceCriteria>
### AC-1: Table Coverage Verification
- All 40+ tables documented in Architecture.md
- Each table has SQL CREATE TABLE snippet or clear definition
- No tables from DATABASE_SCHEMA.md missing in Architecture.md
- Module organization clear (Planning, Warehouse, Technical, etc.)

### AC-2: Column Completeness
- All columns from actual schema present in Architecture docs
- Column types, constraints, defaults documented
- Foreign keys and relationships described
- No missing columns compared to runtime DB

### AC-3: SQL Snippet Accuracy
- SQL snippets are syntactically correct
- Types match PostgreSQL conventions
- Constraints match actual DB (CHECK, NOT NULL, UNIQUE)
- Comments and descriptions accurate

### AC-4: Gap Identification
- Document list of missing tables (if any)
- Document list of incomplete table definitions
- Document SQL snippets that need correction
- Prioritize gaps by importance (critical vs nice-to-have)

### AC-5: Documentation Quality
- Clear section headers for each module
- Consistent formatting across all tables
- Cross-references to business logic where relevant
- Examples provided for complex patterns

### AC-6: Comparison Report
- Generate comparison: Architecture.md vs DATABASE_SCHEMA.md
- Identify discrepancies (missing tables, columns, types)
- Document which source is correct for each discrepancy
- Create action plan for filling gaps
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/architecture.md</path>
        <title>MonoPilot MES - Architecture Document</title>
        <section>Database Schema & Table Definitions</section>
        <snippet>Main architecture document with Novel Patterns, Tech Stack (Next.js 15, React 19, Supabase PostgreSQL 15), Database Schema sections. Contains SOME SQL snippets for tables but completeness unknown. Referenced as "single source of truth" target.</snippet>
      </doc>
      <doc>
        <path>docs/DATABASE_SCHEMA.md</path>
        <title>Database Schema Documentation</title>
        <section>Complete Table Listing (40+ tables)</section>
        <snippet>Auto-generated from migrations. Lists ALL tables with columns, types, constraints, FK relationships, indexes. Updated 2025-11-15. This is the COMPARISON SOURCE to verify Architecture.md completeness.</snippet>
      </doc>
      <doc>
        <path>docs/DATABASE_RELATIONSHIPS.md</path>
        <title>Database Relationships Documentation</title>
        <section>FK Relationships & Entity Diagram</section>
        <snippet>Auto-generated FK relationships between tables. Shows which tables reference which (e.g., license_plates.product_id â†’ products.id). Useful for understanding table dependencies during audit.</snippet>
      </doc>
      <doc>
        <path>docs/bmm-roadmap-epic-0-p0-fixes.md</path>
        <title>Epic 0 - P0 Modules Data Integrity Fixes</title>
        <section>Context for Why Architecture.md Audit Is Critical</section>
        <snippet>Epic 0 discovered critical inconsistencies between DB schema vs TypeScript vs API vs UI. Stories 0.11-0.12 aim to make Architecture.md the "single source of truth" for future migration generation, preventing such inconsistencies.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>apps/frontend/scripts/update-docs.ts</path>
        <kind>script</kind>
        <symbol>parseSQLMigrations(), generateDatabaseSchemaMarkdown()</symbol>
        <lines>1-607</lines>
        <reason>Auto-generates DATABASE_SCHEMA.md from migrations. This script is the SOURCE OF TRUTH for how schema docs should be structured. Audit task will compare Architecture.md against the output of this script.</reason>
      </artifact>
      <artifact>
        <path>apps/frontend/lib/supabase/migrations</path>
        <kind>directory</kind>
        <symbol>85+ SQL migration files</symbol>
        <lines>-</lines>
        <reason>Complete migration history (001-085+). These migrations are the GROUND TRUTH for actual database schema. Architecture.md must match what these migrations create.</reason>
      </artifact>
    </code>
    <dependencies>
      <node>
        <package>tsx</package>
        <version>^4.20.6</version>
        <purpose>TypeScript execution for update-docs.ts script</purpose>
      </node>
      <node>
        <package>pg</package>
        <version>^8.16.3</version>
        <purpose>PostgreSQL client for runtime DB verification</purpose>
      </node>
      <node>
        <package>@supabase/supabase-js</package>
        <version>^2.75.0</version>
        <purpose>Supabase client for database queries during audit</purpose>
      </node>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>Architecture.md MUST match runtime DB schema after Story 0.9 (database reset)</constraint>
    <constraint>SQL snippets in Architecture.md must be syntactically correct PostgreSQL 15</constraint>
    <constraint>All 40+ tables from DATABASE_SCHEMA.md must be documented in Architecture.md</constraint>
    <constraint>Use consistent lowercase naming for enum values (per Epic 0 fixes)</constraint>
    <constraint>Report must be saved to docs/sprint-artifacts/0-11-architecture-audit-report.md</constraint>
    <constraint>This is AUDIT ONLY story - no code changes, no Architecture.md updates (that's Story 0.12)</constraint>
  </constraints>
  <interfaces>
    <interface>
      <name>pnpm docs:update</name>
      <kind>CLI command</kind>
      <signature>pnpm docs:update</signature>
      <path>apps/frontend/package.json:28</path>
      <purpose>Regenerate DATABASE_SCHEMA.md from migrations - use this as comparison baseline</purpose>
    </interface>
  </interfaces>
  <tests>
    <standards>Story 0.11 is primarily manual audit work with verification scripts. No E2E tests required. Validation consists of: 1) Comparing Architecture.md vs DATABASE_SCHEMA.md tables, 2) Column-by-column comparison, 3) SQL syntax validation, 4) Gap analysis, 5) Final audit report review.</standards>
    <locations>
      - docs/sprint-artifacts/0-11-architecture-audit-report.md (output)
      - apps/frontend/scripts/update-docs.ts (validation reference)
    </locations>
    <ideas>
      <test ac="AC-1">
        <id>T1-table-coverage</id>
        <description>Compare table list from Architecture.md vs DATABASE_SCHEMA.md - identify missing tables</description>
      </test>
      <test ac="AC-2">
        <id>T2-column-completeness</id>
        <description>For each table, compare columns Architecture.md vs DATABASE_SCHEMA.md - identify missing columns</description>
      </test>
      <test ac="AC-3">
        <id>T3-sql-syntax</id>
        <description>Extract SQL snippets from Architecture.md and validate syntax (manually or with PostgreSQL parser)</description>
      </test>
      <test ac="AC-4">
        <id>T4-gap-prioritization</id>
        <description>Categorize all gaps by severity (CRITICAL/HIGH/MEDIUM/LOW) and estimate effort to fix</description>
      </test>
      <test ac="AC-5">
        <id>T5-quality-review</id>
        <description>Review Architecture.md for consistent formatting, clear headers, complete cross-references</description>
      </test>
      <test ac="AC-6">
        <id>T6-comparison-report</id>
        <description>Generate final side-by-side comparison table and action plan for Story 0.12</description>
      </test>
    </ideas>
  </tests>
</story-context>
