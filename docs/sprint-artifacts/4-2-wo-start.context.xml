<story-context id="bmad/bmm/workflows/4-implementation/story-context/4-2-wo-start" v="1.0">
  <metadata>
    <epicId>4</epicId>
    <storyId>2</storyId>
    <title>WO Start</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-11-24</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/epics/epic-4-production.md</sourceStoryPath>
    <template>Custom</template>
    <estimatedTokens>4000</estimatedTokens>
    <estimatedEffort>0.5 day</estimatedEffort>
  </metadata>

  <story>
    <asA>Operator</asA>
    <iWant>to start a released work order</iWant>
    <soThat>I can begin production</soThat>
    <tasks>
      <task id="1" ac="AC-4.2.1">Start Production API - POST /api/production/work-orders/:id/start</task>
      <task id="2" ac="AC-4.2.2">WO Status Validation - Verify WO is in Released status before allowing start</task>
      <task id="3" ac="AC-4.2.3">Start Production Modal - Display WO summary, line/machine confirmation, material availability warning</task>
      <task id="4" ac="AC-4.2.4">Status Transition - Update WO status from Released → In Progress</task>
      <task id="5" ac="AC-4.2.5">Timestamp Recording - Set started_at timestamp when WO starts</task>
      <task id="6" ac="AC-4.2.6">Active WO List Update - WO appears in Active WOs list after start</task>
      <task id="7" ac="ALL">Unit & Integration Tests - Service layer validation, API route tests, status transition tests</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC-4.2.1">Given WO is in Released status, When clicking "Start Production", Then modal shows WO summary (number, product, quantity), line/machine confirmation, material availability (warning only, not blocking)</criterion>
    <criterion id="AC-4.2.2">When confirming start, Then WO status transitions from Released → In Progress</criterion>
    <criterion id="AC-4.2.3">And started_at timestamp is set to current UTC datetime</criterion>
    <criterion id="AC-4.2.4">And WO appears in Active WOs list on Production Dashboard</criterion>
    <criterion id="AC-4.2.5">Given WO is NOT in Released status (e.g., Draft, In Progress, Completed), When clicking "Start Production", Then system displays error "Cannot start: Work Order must be in Released status" and blocks action</criterion>
    <criterion id="AC-4.2.6">Material availability check is informational only - displays warning if materials are insufficient but does not block start action</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/epics/epic-4-production.md</path>
        <title>Epic 4: Production Execution</title>
        <section>Story 4.2: WO Start</section>
        <snippet>WO Start allows operators to transition Released WOs to In Progress status. Modal displays summary, line/machine confirmation, and material availability warning. Status transitions to In Progress with started_at timestamp. Prerequisites: Story 3.10 (WO Release).</snippet>
      </doc>
      <doc>
        <path>docs/architecture/patterns/api.md</path>
        <title>API Architecture</title>
        <section>API Pattern - Class-Based Services</section>
        <snippet>WorkOrdersAPI class with static methods for CRUD operations. Validation with Zod schemas. Status transition logic with validateStatusTransition(). Error handling with APIError class and RFC 7807 Problem Details format.</snippet>
      </doc>
      <doc>
        <path>docs/architecture/patterns/api.md</path>
        <title>API Architecture</title>
        <section>Error Handling - RFC 7807 Problem Details</section>
        <snippet>Structured error responses with type, title, status, detail, errors fields. APIError class with toProblemDetails() method. handleAPIError() function for consistent error formatting.</snippet>
      </doc>
      <doc>
        <path>docs/templates/template-h-transaction-workflow.md</path>
        <title>Template H: Transaction Workflow Pattern</title>
        <section>Pattern Overview</section>
        <snippet>Multi-step transaction execution with validation, rollback handlers, status transitions. Transaction executor pattern with TransactionStep interface. Atomic operations with BEGIN/COMMIT/ROLLBACK. Reference for implementing WO start workflow.</snippet>
      </doc>
    </docs>

    <code>
      <artifact>
        <path>app/api/production/work-orders/[id]/start</path>
        <kind>directory</kind>
        <symbol>Start Production API route location</symbol>
        <reason>Story requires creating route.ts for POST /api/production/work-orders/:id/start endpoint</reason>
      </artifact>
      <artifact>
        <path>lib/services/work-order-service.ts</path>
        <kind>file</kind>
        <symbol>Work Order service layer</symbol>
        <reason>Story requires adding startWorkOrder() method to service for status transition logic and validation</reason>
      </artifact>
      <artifact>
        <path>lib/validation/work-order-schemas.ts</path>
        <kind>file</kind>
        <symbol>Work Order Zod schemas</symbol>
        <reason>Story may require startWorkOrderSchema for validating start request input</reason>
      </artifact>
      <artifact>
        <path>components/production/StartWorkOrderModal.tsx</path>
        <kind>component</kind>
        <symbol>StartWorkOrderModal</symbol>
        <reason>Story requires creating modal component displaying WO summary, line/machine confirmation, material availability warning</reason>
      </artifact>
      <artifact>
        <path>components/production/ActiveWorkOrdersList.tsx</path>
        <kind>component</kind>
        <symbol>ActiveWorkOrdersList</symbol>
        <reason>Story requires Active WOs list to display newly started WO after status transition</reason>
      </artifact>
      <artifact>
        <path>lib/api/WorkOrdersAPI.ts</path>
        <kind>file</kind>
        <symbol>WorkOrdersAPI class</symbol>
        <reason>Story requires adding start() method to API class for client-side WO start operations</reason>
      </artifact>
    </code>

    <dependencies>
      <node>
        <package name="@supabase/supabase-js" version="^2.84.0" usage="Supabase client for database operations (WO status updates, timestamp recording)" />
        <package name="@supabase/ssr" version="^0.7.0" usage="SSR helpers for Next.js (createServerClient)" />
        <package name="react-hook-form" version="^7.66.1" usage="Form state management for Start Production modal" />
        <package name="zod" version="^3.25.76" usage="Validation schemas for start request (startWorkOrderSchema)" />
        <package name="@hookform/resolvers" version="^5.2.2" usage="Zod resolver for react-hook-form integration" />
        <package name="next" version="^15.1.4" usage="Next.js framework with App Router for API routes" />
        <package name="react" version="^19.0.0" usage="React 19 for UI components (StartWorkOrderModal)" />
        <package name="lucide-react" version="^0.554.0" usage="Icons for modal (play icon for start, alert for warnings)" />
        <package name="@radix-ui/react-dialog" version="^1.1.15" usage="Dialog component for Start Production modal" />
        <package name="@radix-ui/react-toast" version="^1.2.15" usage="Toast notifications for success/error messages" />
      </node>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="architecture">Next.js 15 App Router - use app/ directory structure, server components by default, client components with 'use client' directive for modal</constraint>
    <constraint type="architecture">Class-based API pattern - use WorkOrdersAPI class with static methods, handle errors with APIError class</constraint>
    <constraint type="business">Status validation - ONLY allow start transition from Released status, block all other statuses with clear error message</constraint>
    <constraint type="business">Material availability - check is informational only (warning), does not block start action</constraint>
    <constraint type="database">Atomic status update - use transaction for status change + timestamp update to prevent race conditions</constraint>
    <constraint type="validation">Zod validation - required on BOTH client and server for start request input</constraint>
    <constraint type="ux">Shadcn/UI components - use Dialog, Button, Toast for consistency with existing design system</constraint>
    <constraint type="ux">Modal layout - centered card, WO summary section, line/machine confirmation, material availability warning (yellow alert), confirm/cancel buttons</constraint>
    <constraint type="testing">Test pyramid - 95% unit coverage for service layer (status validation, timestamp logic), 70% integration coverage for API route, 100% E2E coverage for start flow</constraint>
    <constraint type="security">Authorization - verify user has Operator role or higher before allowing WO start</constraint>
    <constraint type="security">RLS policies - ensure org_id scoping on work_orders table prevents cross-org access</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>POST /api/production/work-orders/:id/start</name>
      <kind>API route</kind>
      <signature>POST /api/production/work-orders/{wo_id}/start - Request body: { line_id?: string, machine_id?: string } - Response: { data: WorkOrder } or Problem Details error</signature>
      <path>app/api/production/work-orders/[id]/start/route.ts</path>
    </interface>
    <interface>
      <name>startWorkOrder</name>
      <kind>service function</kind>
      <signature>async function startWorkOrder(woId: string, input: StartWOInput): Promise&lt;ServiceResult&lt;WorkOrder&gt;&gt; - Validates status = Released, updates status → In Progress, sets started_at timestamp</signature>
      <path>lib/services/work-order-service.ts</path>
    </interface>
    <interface>
      <name>startWorkOrderSchema</name>
      <kind>Zod schema</kind>
      <signature>z.object({ wo_id: z.string().uuid(), line_id: z.string().uuid().optional(), machine_id: z.string().uuid().optional() })</signature>
      <path>lib/validation/work-order-schemas.ts</path>
    </interface>
    <interface>
      <name>WorkOrdersAPI.start</name>
      <kind>API class method</kind>
      <signature>static async start(woId: string, input: StartWOInput): Promise&lt;WorkOrder&gt; - Client-side method calling POST /api/production/work-orders/:id/start</signature>
      <path>lib/api/WorkOrdersAPI.ts</path>
    </interface>
    <interface>
      <name>StartWorkOrderModal</name>
      <kind>React component</kind>
      <signature>StartWorkOrderModal: FC&lt;{ woId: string, open: boolean, onClose: () =&gt; void, onSuccess: () =&gt; void }&gt; - Displays WO summary, line/machine fields, material warning, confirm button</signature>
      <path>components/production/StartWorkOrderModal.tsx</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Testing strategy follows Test Pyramid: unit tests for service layer (95% coverage, mock Supabase client with vitest), integration tests for API route (70% coverage, Vitest + Supabase Test Client), E2E tests for complete start flow (100% user flows, Playwright). All tests in __tests__ directories colocated with source. Test files follow pattern: service.test.ts (unit), route.test.ts (integration), start-wo-flow.e2e.ts (E2E). Fixtures in __fixtures__. Mock Supabase in unit tests.
    </standards>
    <locations>
      <location>lib/services/__tests__/work-order-service.test.ts (startWorkOrder unit tests with mocked Supabase)</location>
      <location>app/api/production/work-orders/[id]/start/__tests__/route.test.ts (API route integration tests)</location>
      <location>components/production/__tests__/StartWorkOrderModal.test.tsx (Modal component unit tests)</location>
      <location>e2e/production/start-work-order.e2e.ts (Complete start flow E2E tests)</location>
    </locations>
    <ideas>
      <idea ac="AC-4.2.1">Unit test: startWorkOrder() validates WO status = Released, rejects Draft/In Progress/Completed with error</idea>
      <idea ac="AC-4.2.2">Unit test: startWorkOrder() updates status from Released → In Progress successfully</idea>
      <idea ac="AC-4.2.3">Unit test: startWorkOrder() sets started_at timestamp to current UTC datetime</idea>
      <idea ac="AC-4.2.4">Integration test: POST /api/production/work-orders/:id/start with Released WO returns 200 and updated WO</idea>
      <idea ac="AC-4.2.5">Integration test: POST /api/production/work-orders/:id/start with non-Released WO returns 400 error "Cannot start: Work Order must be in Released status"</idea>
      <idea ac="AC-4.2.6">Unit test: Material availability check returns warning but does not block start action</idea>
      <idea ac="AC-4.2.1">E2E test: Navigate to WO detail page with Released WO, click "Start Production", modal opens with summary/line/machine fields</idea>
      <idea ac="AC-4.2.2">E2E test: In Start Production modal, confirm start, WO status transitions to In Progress, success toast shown</idea>
      <idea ac="AC-4.2.4">E2E test: After start, WO appears in Active WOs list on Production Dashboard</idea>
      <idea ac="AC-4.2.5">E2E test: Attempt to start WO in Completed status, error message "Cannot start: Work Order must be in Released status" displayed</idea>
      <idea ac="AC-4.2.6">E2E test: Material availability warning displayed in modal but does not prevent start action</idea>
      <idea ac="ALL">Unit test: StartWorkOrderModal component renders summary, fields, buttons correctly</idea>
    </ideas>
  </tests>
</story-context>
