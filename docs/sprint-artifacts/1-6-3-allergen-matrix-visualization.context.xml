<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1.6</epicId>
    <storyId>3</storyId>
    <title>Allergen Matrix Visualization</title>
    <status>drafted</status>
    <generatedAt>2025-11-16</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/1-6-3-allergen-matrix-visualization.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>Quality Manager / Technical Manager</asA>
    <iWant>Allergen cross-contamination matrix heatmap with export to PDF</iWant>
    <soThat>allergen audits take 15 minutes (vs 2 hours manual spreadsheet) and 100% audit coverage is enforced</soThat>
    <tasks>7 tasks: Matrix heatmap component (14×N grid), risk scoring algorithm, cross-contamination detection, PDF export, line allergen rules, E2E tests, documentation. Total: 30h (~4 days)</tasks>
  </story>

  <acceptanceCriteria>5 ACs covering: (1) 14×N matrix heatmap (rows=14 EU allergens, columns=production lines, color coding: green/yellow/red), (2) Risk scoring (# products × severity weight, levels: 0-5 green, 6-15 yellow, 16+ red), (3) Cross-contamination warnings (Line runs both Gluten + Gluten-free → warning + mitigation suggestions), (4) PDF export (matrix + warnings + product list), (5) Line allergen rules (e.g., "Line B is Gluten-free ONLY" → block Gluten products, override with e-signature)</acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="docs/ux-design-technical-module.md" title="Technical Module UX" section="Allergen Matrix Visualization">
        14×N allergen heatmap. Features: Risk scoring, cross-contamination detection, PDF export. Time savings: 87% (15min vs 2h). ROI: 100% audit coverage.
      </doc>
      <doc path="docs/MonoPilot-PRD-2025-11-13.md" title="Main PRD" section="Allergens">
        14 EU allergens (Regulation 1169/2011): Gluten, Crustaceans, Eggs, Fish, Peanuts, Soybeans, Milk, Nuts, Celery, Mustard, Sesame, Sulphur dioxide, Lupin, Molluscs.
      </doc>
    </docs>
    <code>
      <artifact path="apps/frontend/lib/api/allergens.ts" kind="API Class">
        Query products by allergen and line for matrix population
      </artifact>
    </code>
    <dependencies>
      <framework>jsPDF for PDF export</framework>
      <framework>Canvas API for heatmap rendering</framework>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="allergens">14 EU allergens per Regulation 1169/2011</constraint>
    <constraint type="risk">Risk score = (# products with allergen on line) × severity weight. Peanuts=3, Gluten=1, etc.</constraint>
    <constraint type="rules">Line allergen rules enforced at WO creation. Override requires e-signature (Story 1.2)</constraint>
  </constraints>

  <interfaces>
    <interface name="AllergenMatrix component" kind="React Component">
      <signature>&lt;AllergenMatrix onCellClick={(allergen, line) =&gt; showDrillDown()} /&gt;</signature>
    </interface>
    <interface name="calculateRiskScore()" kind="Function">
      <signature>function calculateRiskScore(lineId: number, allergen: string): number</signature>
    </interface>
  </interfaces>

  <tests>
    <standards>E2E required for: Matrix rendering, risk scoring accuracy, cross-contamination detection, PDF export</standards>
    <locations>
      <e2e>apps/frontend/e2e/allergen-matrix.spec.ts</e2e>
    </locations>
    <ideas>
      <test ac="AC-1" risk="MEDIUM">E2E: Matrix cell colors match risk levels (green/yellow/red)</test>
      <test ac="AC-3" risk="HIGH">E2E: Line runs Gluten + Gluten-free products → cross-contamination warning shown</test>
      <test ac="AC-4" risk="MEDIUM">E2E: Export PDF → file downloaded with matrix visual</test>
    </ideas>
  </tests>
</story-context>
