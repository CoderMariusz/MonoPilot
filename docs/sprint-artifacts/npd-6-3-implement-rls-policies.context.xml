<?xml version="1.0" encoding="UTF-8"?>
<story-context>
  <metadata>
    <story_key>npd-6-3-implement-rls-policies</story_key>
    <epic_id>NPD-6</epic_id>
    <story_id>6.3</story_id>
    <title>Implement RLS Policies for NPD Tables</title>
    <generated>2025-11-16</generated>
  </metadata>

  <user_story>
    <as_a>security administrator</as_a>
    <i_want>Row Level Security policies on all npd_* tables</i_want>
    <so_that>organizations can only access their own NPD data (multi-tenant isolation)</so_that>
  </user_story>

  <acceptance_criteria>
    <criterion id="AC-1">
      <given>all 7 npd_* tables exist (Stories 6.1, 6.2 complete)</given>
      <when>migration 102 executes</when>
      <then>RLS enabled on all npd_* tables</then>
    </criterion>
    <criterion id="AC-2">
      <description>SELECT policies enforce org_id isolation</description>
      <example>CREATE POLICY npd_projects_select_own_org ON npd_projects FOR SELECT USING (org_id = current_setting('app.org_id')::UUID);</example>
    </criterion>
    <criterion id="AC-3">
      <description>INSERT policies enforce org_id</description>
      <example>CREATE POLICY npd_projects_insert_own_org ON npd_projects FOR INSERT WITH CHECK (org_id = current_setting('app.org_id')::UUID);</example>
    </criterion>
    <criterion id="AC-4">
      <description>UPDATE/DELETE policies restrict to own org</description>
    </criterion>
    <criterion id="AC-5">
      <description>Role-based policies added</description>
      <details>
        - NPD Lead: full access (SELECT, INSERT, UPDATE, DELETE)
        - R&D: read-only on projects, full access on formulations
        - Finance: read-only + UPDATE on npd_costing
        - Regulatory: read-only + INSERT/UPDATE on npd_documents
        - Production: read-only on all npd_* tables
      </details>
    </criterion>
    <criterion id="AC-6">
      <description>Session variable app.org_id set in middleware</description>
      <path>apps/frontend/middleware.ts</path>
    </criterion>
  </acceptance_criteria>

  <tasks>
    <task id="T-1">Create migration file 102_create_npd_rls_policies.sql</task>
    <task id="T-2">Enable RLS on all 7 npd_* tables (ALTER TABLE ... ENABLE ROW LEVEL SECURITY)</task>
    <task id="T-3">Create SELECT policies for org_id isolation (all tables)</task>
    <task id="T-4">Create INSERT policies enforcing org_id (all tables)</task>
    <task id="T-5">Create UPDATE policies (all tables)</task>
    <task id="T-6">Create DELETE policies (all tables)</task>
    <task id="T-7">Create role-based policies for NPD Lead, R&D, Finance, Regulatory, Production</task>
    <task id="T-8">Verify middleware sets app.org_id session variable</task>
    <task id="T-9">Test RLS with 2 test orgs (verify isolation)</task>
    <task id="T-10">Run pnpm docs:update to document RLS policies</task>
  </tasks>

  <artifacts>
    <docs>
      <doc>
        <path>docs/NPD-Module-Architecture-2025-11-15.md</path>
        <title>NPD Module Architecture</title>
        <section>Multi-Tenant Isolation</section>
        <snippet>RLS policies on all npd_* tables enforce org_id filtering. Reuses MonoPilot RLS pattern (40+ tables). Session variable app.org_id set in middleware.</snippet>
      </doc>
    </docs>

    <code>
      <artifact>
        <path>apps/frontend/lib/supabase/migrations</path>
        <kind>directory</kind>
        <symbol>Existing RLS migration patterns</symbol>
        <reason>MonoPilot has 40+ tables with RLS - follow same pattern</reason>
      </artifact>
      <artifact>
        <path>apps/frontend/middleware.ts</path>
        <kind>middleware</kind>
        <symbol>Session management</symbol>
        <reason>Sets app.org_id session variable for RLS enforcement</reason>
      </artifact>
    </code>
  </artifacts>

  <constraints>
    <constraint>Use sequential migration numbering: 102_create_npd_rls_policies.sql</constraint>
    <constraint>Reuse existing RLS pattern from MonoPilot (40+ tables already use this)</constraint>
    <constraint>Test RLS with multiple orgs: CREATE 2 test orgs, verify isolation</constraint>
    <constraint>Document RLS policies in docs/DATABASE_SCHEMA.md (auto-generated)</constraint>
  </constraints>

  <tests>
    <standards>
      RLS tested by creating 2 organizations, inserting data, and verifying queries only return own org's data.
    </standards>
    <locations>
      - apps/frontend/e2e/ (E2E tests with multi-org scenarios)
    </locations>
    <ideas>
      <idea criterion="AC-1">Verify RLS enabled on all 7 npd_* tables using pg_tables system view</idea>
      <idea criterion="AC-2">Test SELECT: org_id=1 user cannot see org_id=2 projects</idea>
      <idea criterion="AC-3">Test INSERT: user cannot insert with different org_id</idea>
      <idea criterion="AC-4">Test UPDATE: user cannot update other org's records</idea>
      <idea criterion="AC-5">Test role-based: Finance user can UPDATE npd_costing but not DELETE</idea>
      <idea criterion="AC-6">Verify middleware sets app.org_id from session</idea>
    </ideas>
  </tests>

  <technical_notes>
    <note>RLS enforces at PostgreSQL level - impossible to bypass from application layer</note>
    <note>app.org_id session variable must be set BEFORE any queries execute</note>
    <note>RLS policies apply to ALL queries, including Supabase Admin API (unless bypassed)</note>
  </technical_notes>

  <prerequisites>
    <prerequisite>Stories 6.1, 6.2 (all 7 npd_* tables must exist)</prerequisite>
  </prerequisites>
</story-context>
