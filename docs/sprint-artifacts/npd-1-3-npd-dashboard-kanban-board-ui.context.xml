<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>NPD-1</epicId>
    <storyId>3</storyId>
    <title>NPD Dashboard - Kanban Board UI</title>
    <status>drafted</status>
    <generatedAt>2025-11-16</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/npd-1-3-npd-dashboard-kanban-board-ui.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>R&D user</asA>
    <iWant>visualize NPD pipeline as Kanban board</iWant>
    <soThat>I can see project distribution across gates</soThat>
    <tasks>
- Task 1: Setup NPD Route and Layout (AC-1)
  - 1.1: Create /npd route group at apps/frontend/app/(authenticated)/npd/page.tsx
  - 1.2: Create NPD layout component with Innovation Light theme overrides
  - 1.3: Add NPD navigation item to sidebar (icon: Lightbulb, route: /npd)
  - 1.4: Implement middleware check for NPD feature flag (org_settings.enabled_modules)

- Task 2: Install shadcn/ui Components (AC-2, AC-6)
  - 2.1: Run `npx shadcn-ui@latest init` (if not already installed)
  - 2.2: Add shadcn components: `npx shadcn-ui@latest add card badge toast`
  - 2.3: Install react-beautiful-dnd: `pnpm add react-beautiful-dnd @types/react-beautiful-dnd`
  - 2.4: Configure Tailwind for Innovation Light theme colors

- Task 3: Create Kanban Board Components (AC-1, AC-2)
  - 3.1: Create components/NPD/dashboard/KanbanBoard.tsx with 5 columns
  - 3.2: Create components/NPD/dashboard/KanbanColumn.tsx with header (gate name, badge, count)
  - 3.3: Create components/NPD/dashboard/KanbanCard.tsx extending shadcn Card
  - 3.4: Implement card gradient backgrounds per gate (G0 red-500 → G4 green-600)
  - 3.5: Add risk indicator circle (H=red, M=yellow, L=green)
  - 3.6: Add progress badges (formulation version, compliance docs)

- Task 4: Implement Drag-and-Drop Logic (AC-3)
  - 4.1: Wrap KanbanBoard in DragDropContext from react-beautiful-dnd
  - 4.2: Wrap each column in Droppable component
  - 4.3: Wrap each card in Draggable component
  - 4.4: Implement onDragEnd handler with sequential gate validation
  - 4.5: Call NPDProjectsAPI.advanceGate() on valid drop
  - 4.6: Implement optimistic update + revert on error
  - 4.7: Add drag visual feedback (shadow, placeholder, drop zone highlight)

- Task 5: Create Stats Bar Component (AC-4)
  - 5.1: Create components/NPD/dashboard/StatsBar.tsx
  - 5.2: Calculate metrics from projects array (Active, G0, G1, G2-G3, Ready for Handoff)
  - 5.3: Display metrics as cards with icons and counts
  - 5.4: Update stats in real-time when projects change

- Task 6: Implement Filters (AC-5)
  - 6.1: Create components/NPD/dashboard/FilterControls.tsx
  - 6.2: Add Portfolio Category dropdown (populate from unique project categories)
  - 6.3: Add Priority dropdown (All, High, Medium, Low)
  - 6.4: Add Owner dropdown (populate from unique project owners)
  - 6.5: Implement filter logic (filter projects array before rendering)
  - 6.6: Persist filter state in URL query params (useSearchParams)

- Task 7: Setup SWR Data Fetching (AC-6)
  - 7.1: Create hooks/useNPDProjects.ts with SWR
  - 7.2: Configure SWR: 60s revalidation, optimistic updates enabled
  - 7.3: Implement loading skeleton (matches final Kanban layout)
  - 7.4: Implement error boundary for failed fetches
  - 7.5: Add toast notifications for gate advancement (success/error)

- Task 8: Performance Optimization (AC-7)
  - 8.1: Implement React.memo for KanbanCard component
  - 8.2: Add skeleton loading (no layout shift)
  - 8.3: Measure dashboard load time with Playwright Performance API
  - 8.4: Optimize re-renders (useMemo for filtered projects, useCallback for handlers)

- Task 9: E2E Tests (AC-3, AC-6)
  - 9.1: Create e2e/npd-dashboard.spec.ts
  - 9.2: Test: Dashboard loads with 5 columns
  - 9.3: Test: Drag-drop card from G0 to G1 (valid)
  - 9.4: Test: Drag-drop card from G0 to G3 (invalid, should revert)
  - 9.5: Test: Filter by portfolio category
  - 9.6: Test: Stats bar updates after gate advancement
  - 9.7: Test: Performance (&lt;500ms load for 50 projects)

- Task 10: Documentation Update
  - 10.1: Run `pnpm docs:update` to regenerate API_REFERENCE.md
  - 10.2: Add screenshots to docs/screenshots/npd-dashboard-kanban.png
  - 10.3: Update docs/03_APP_GUIDE.md with NPD Dashboard section
</tasks>
  </story>

  <acceptanceCriteria>
1. AC-1: Kanban Board Layout
   - Implement /npd page with 5 Kanban columns: G0 (Idea), G1 (Concept), G2 (Development), G3 (Testing), G4 (Launch)
   - Column headers display gate name, gate badge (color-coded), and project count
   - Columns are equal width, horizontally scrollable on mobile
   - Background: Innovation Light theme (gray-50 main background, white card surfaces)

2. AC-2: Project Cards
   - Display NPD projects as cards using shadcn/ui Card component
   - Card design: Header (Project number bold, risk indicator), Body (name + description), Footer (progress badges), Gradient background by gate
   - Cards sorted by priority (High → Medium → Low) within each column

3. AC-3: Drag-and-Drop Functionality
   - Implement drag-and-drop using react-beautiful-dnd
   - Users can drag cards between ADJACENT gates only (G0→G1, G1→G2, not G0→G3)
   - Visual feedback: shadow increases, drop zones highlighted, placeholder shown
   - On drop: Call NPDProjectsAPI.advanceGate(id, toGate) to persist change
   - If validation fails, revert card position and show error toast

4. AC-4: Stats Bar
   - Display metrics above Kanban: Active Projects, G0 count, G1 count, G2-G3 combined, Ready for Handoff count
   - Stats update in real-time when cards move

5. AC-5: Filters
   - Add filter controls: Portfolio Category, Priority, Owner dropdowns
   - Filtered cards update Kanban immediately
   - Filter state persisted in URL query params

6. AC-6: Real-Time Updates
   - Use SWR with 60-second revalidation interval
   - Optimistic updates on drag-drop (revert on error)
   - Show loading skeleton on initial load
   - Toast notifications for success/error

7. AC-7: Performance
   - Dashboard loads in &lt;500ms (p95) for 50 projects
   - Drag-drop animations smooth (60fps)
   - No layout shift during initial load
</acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/ux-design-npd-module-2025-11-16.md</path>
        <title>MonoPilot NPD Module - UX Design Specification</title>
        <section>Direction 1: Kanban Dashboard</section>
        <snippet>NPD Module dashboard with 5-column Kanban board (G0→G4), drag-drop cards, stats bar (5 metrics), color-coded gates (red→green), shadcn/ui Card components, Innovation Light theme</snippet>
      </doc>
      <doc>
        <path>docs/NPD-Module-Architecture-2025-11-15.md</path>
        <title>NPD Module Architecture Document</title>
        <section>Component Library Strategy</section>
        <snippet>NPD route group /npd uses shadcn/ui (Tailwind-native, Radix UI). Components: KanbanBoard (react-beautiful-dnd), FormulationTable, Stepper. Bounded context architecture allows separate design system from MonoPilot core</snippet>
      </doc>
      <doc>
        <path>docs/NPD-Module-Epics.md</path>
        <title>NPD Module Epics</title>
        <section>Story NPD-1.3</section>
        <snippet>Implement /npd dashboard page with Kanban visualization of NPD pipeline. 5 columns (G0-G4), drag-drop cards, filters (category/priority/owner), real-time updates via SWR, &lt;500ms p95 load time for 50 projects</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/npd-1-2-stage-gate-workflow-logic.md</path>
        <title>Story NPD-1.2: Stage-Gate Workflow Logic</title>
        <section>Learnings from Previous Story</section>
        <snippet>NPDProjectsAPI.advanceGate() method available at apps/frontend/lib/api/npdProjects.ts:319-395. Sequential gate validation using GATE_SEQUENCE array. GATE_STATUS_MAP for automatic status updates. Perfect for drag-drop integration</snippet>
      </doc>
    </docs>

    <code>
      <artifact>
        <path>apps/frontend/lib/api/npdProjects.ts</path>
        <kind>API service</kind>
        <symbol>NPDProjectsAPI</symbol>
        <lines>80-400</lines>
        <reason>Main API class for NPD projects. Provides advanceGate() method (lines 319-395) for drag-drop gate transitions. Also includes GATE_SEQUENCE (line 64) and GATE_STATUS_MAP (lines 67-74) constants needed for Kanban columns</reason>
      </artifact>
      <artifact>
        <path>apps/frontend/lib/api/npdProjects.ts</path>
        <kind>interface</kind>
        <symbol>NPDProject</symbol>
        <lines>12-28</lines>
        <reason>TypeScript interface defining NPD project structure with all fields needed for Kanban cards (project_number, project_name, current_gate, priority, portfolio_category, owner_id)</reason>
      </artifact>
      <artifact>
        <path>apps/frontend/lib/supabase/client-browser.ts</path>
        <kind>service</kind>
        <symbol>supabase</symbol>
        <lines>all</lines>
        <reason>Browser Supabase client used by all API classes. NPDProjectsAPI imports from this file</reason>
      </artifact>
      <artifact>
        <path>apps/frontend/lib/hooks/useSupabaseData.ts</path>
        <kind>hook</kind>
        <symbol>useSupabaseData</symbol>
        <lines>all</lines>
        <reason>Custom SWR hook pattern for Supabase data fetching. Can be referenced for creating useNPDProjects hook with real-time updates</reason>
      </artifact>
      <artifact>
        <path>apps/frontend/components/layout/Sidebar.tsx</path>
        <kind>component</kind>
        <symbol>Sidebar</symbol>
        <lines>all</lines>
        <reason>Main navigation sidebar component. Need to add NPD menu item here with Lightbulb icon and /npd route</reason>
      </artifact>
      <artifact>
        <path>apps/frontend/middleware.ts</path>
        <kind>middleware</kind>
        <symbol>middleware</symbol>
        <lines>all</lines>
        <reason>Next.js middleware handling authentication and session. Need to add NPD feature flag check (org_settings.enabled_modules includes 'npd')</reason>
      </artifact>
      <artifact>
        <path>apps/frontend/tailwind.config.ts</path>
        <kind>config</kind>
        <symbol>tailwind config</symbol>
        <lines>all</lines>
        <reason>Tailwind CSS configuration. Need to add Innovation Light theme colors (gray-50 background, blue-500 primary, gate colors: red-500, orange-600, amber-500, lime-500, green-600)</reason>
      </artifact>
      <artifact>
        <path>packages/shared/schemas.ts</path>
        <kind>schema</kind>
        <symbol>advanceGateSchema</symbol>
        <lines>60-63</lines>
        <reason>Zod validation schema for advanceGate() API call. Used for validating drag-drop gate transitions</reason>
      </artifact>
    </code>

    <dependencies>
      <node>
        <package name="react" version="^19.0.0" />
        <package name="react-dom" version="^19.0.0" />
        <package name="next" version="^15.5.4" />
        <package name="typescript" version="^5.7.2" />
        <package name="tailwindcss" version="^3.4.17" />
        <package name="swr" version="^2.2.6" />
        <package name="@supabase/supabase-js" version="^2.75.0" />
        <package name="@supabase/ssr" version="^0.7.0" />
        <package name="zod" version="^3.24.1" />
        <package name="lucide-react" version="^0.469.0" />
        <note>Need to install: react-beautiful-dnd, @types/react-beautiful-dnd (for drag-drop), shadcn/ui components (card, badge, toast)</note>
      </node>
      <testing>
        <package name="@playwright/test" version="^1.56.1" />
        <package name="vitest" version="^4.0.6" />
      </testing>
    </dependencies>
  </artifacts>

  <constraints>
- **TypeScript Strict Mode**: 0 errors required. All components must be fully typed
- **Next.js 15 App Router**: Use (authenticated) route group at apps/frontend/app/(authenticated)/npd/
- **Component Location**: NPD components in apps/frontend/components/NPD/dashboard/ (new directory)
- **Tailwind CSS Only**: No CSS modules or styled-components. Use Tailwind utility classes
- **Innovation Light Theme**: gray-50 background, white card surfaces, blue-500 primary color
- **Gate Colors**: G0 red-500, G1 orange-600, G2 amber-500, G3 lime-500, G4 green-600 (from UX spec)
- **shadcn/ui Integration**: Use shadcn Card component for Kanban cards, Badge for status, Toast for notifications
- **React 19 Patterns**: Use hooks, functional components only (no class components)
- **SWR for Data Fetching**: 60s revalidation, optimistic updates, automatic revalidation on focus
- **Supabase RLS**: All queries automatically filtered by org_id (no manual org_id filtering needed)
- **Sequential Gate Validation**: Only adjacent gate transitions allowed (enforced by NPDProjectsAPI.advanceGate())
- **Performance Target**: Dashboard load &lt;500ms p95 for 50 projects, 60fps drag animations
- **Accessibility**: WCAG 2.1 AA compliance, keyboard navigation, screen reader support
- **Testing Coverage**: All acceptance criteria must have E2E tests. Unit tests for hooks and utilities
- **JSDoc Required**: All public components, hooks, and functions must have JSDoc comments
  </constraints>

  <interfaces>
    <interface>
      <name>NPDProjectsAPI.advanceGate</name>
      <kind>Static async method</kind>
      <signature>static async advanceGate(id: string, toGate: NPDProjectGate): Promise&lt;NPDProject&gt;</signature>
      <path>apps/frontend/lib/api/npdProjects.ts:319-395</path>
      <description>Advances NPD project to next sequential gate. Validates gate sequence (G0→G1, not G0→G3), updates status automatically, throws error if validation fails. Perfect for drag-drop integration</description>
    </interface>

    <interface>
      <name>NPDProjectsAPI.getAll</name>
      <kind>Static async method</kind>
      <signature>static async getAll(filters?: NPDProjectFilters): Promise&lt;NPDProject[]&gt;</signature>
      <path>apps/frontend/lib/api/npdProjects.ts:88-120</path>
      <description>Fetches all NPD projects with optional filters (current_gate, status, owner_id, priority). Automatically filtered by org_id via RLS</description>
    </interface>

    <interface>
      <name>GATE_SEQUENCE</name>
      <kind>Constant array</kind>
      <signature>const GATE_SEQUENCE: NPDProjectGate[] = ['G0', 'G1', 'G2', 'G3', 'G4', 'Launched']</signature>
      <path>apps/frontend/lib/api/npdProjects.ts:64</path>
      <description>Array defining valid gate progression sequence. Use to dynamically generate 5 Kanban columns</description>
    </interface>

    <interface>
      <name>GATE_STATUS_MAP</name>
      <kind>Constant object</kind>
      <signature>const GATE_STATUS_MAP: Record&lt;NPDProjectGate, NPDProjectStatus&gt; = { G0: 'idea', G1: 'concept', G2: 'development', G3: 'testing', G4: 'testing', Launched: 'launched' }</signature>
      <path>apps/frontend/lib/api/npdProjects.ts:67-74</path>
      <description>Maps gates to project status. Used for displaying status badges on Kanban cards</description>
    </interface>

    <interface>
      <name>NPDProject</name>
      <kind>TypeScript interface</kind>
      <signature>interface NPDProject { id, org_id, project_number, project_name, description, status, current_gate, priority, portfolio_category, owner_id, target_launch_date, created_at, updated_at, created_by, updated_by }</signature>
      <path>apps/frontend/lib/api/npdProjects.ts:12-28</path>
      <description>Complete NPD project type with all fields needed for Kanban card display</description>
    </interface>
  </interfaces>

  <tests>
    <standards>
MonoPilot uses Playwright for E2E tests and Vitest for unit tests. All tests must be deterministic and independent. E2E tests use real Supabase database with test data seeding. Test patterns:
- **E2E**: Full user flows with authentication, navigation, interactions, assertions on UI state
- **Unit**: Component logic, hooks, utilities with mocked dependencies
- **Coverage**: All acceptance criteria must have E2E test coverage
- **Performance**: Playwright Performance API to measure dashboard load time (&lt;500ms p95)
- **Visual**: Screenshot tests for UI states (optional but recommended for Kanban board)
    </standards>

    <locations>
- **E2E Tests**: apps/frontend/e2e/*.spec.ts (new file: npd-dashboard.spec.ts)
- **Unit Tests**: apps/frontend/lib/**/__tests__/*.test.ts (co-located with source files)
- **Test Utilities**: apps/frontend/e2e/seed-test-data.ts (for seeding test NPD projects)
    </locations>

    <ideas>
**E2E Test Scenarios for NPD-1.3:**

1. **AC-1: Kanban Board Layout** (Test: Dashboard loads with 5 columns)
   - Navigate to /npd route
   - Assert 5 columns visible: G0, G1, G2, G3, G4
   - Assert column headers show gate name, badge, project count
   - Assert Innovation Light theme applied (gray-50 background)

2. **AC-2: Project Cards** (Test: Cards display correctly)
   - Create test NPD project in G0
   - Assert card shows project number, name, risk indicator
   - Assert gradient background (red for G0)
   - Assert progress badges displayed

3. **AC-3: Drag-and-Drop** (Test: Valid gate advancement G0→G1)
   - Drag card from G0 column to G1 column
   - Assert card moves to G1 column
   - Assert success toast displayed
   - Assert project current_gate updated in database

4. **AC-3: Drag-and-Drop** (Test: Invalid gate skip G0→G3 rejected)
   - Drag card from G0 column to G3 column
   - Assert card reverts to G0 column
   - Assert error toast displayed with message "Can only advance to next sequential gate"
   - Assert project remains at G0 in database

5. **AC-4: Stats Bar** (Test: Stats update after gate advancement)
   - Assert initial G0 count = 1, G1 count = 0
   - Drag card from G0 to G1
   - Assert G0 count = 0, G1 count = 1
   - Assert Active Projects count unchanged

6. **AC-5: Filters** (Test: Filter by portfolio category)
   - Create 2 projects: one category "Vegan", one category "Premium"
   - Select "Vegan" from category filter dropdown
   - Assert only Vegan project visible in Kanban
   - Assert filter persisted in URL query params

7. **AC-6: Real-Time Updates** (Test: Loading skeleton displayed)
   - Navigate to /npd
   - Assert skeleton visible during initial load
   - Assert skeleton matches final Kanban layout (no layout shift)

8. **AC-7: Performance** (Test: Dashboard load time &lt;500ms)
   - Seed 50 test NPD projects across all gates
   - Use Playwright Performance API to measure page load
   - Navigate to /npd
   - Assert p95 load time &lt; 500ms
   - Assert drag-drop animation smooth (60fps)
    </ideas>
  </tests>
</story-context>
