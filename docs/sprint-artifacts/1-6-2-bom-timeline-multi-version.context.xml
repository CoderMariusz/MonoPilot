<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1.6</epicId>
    <storyId>2</storyId>
    <title>BOM Timeline Multi-Version</title>
    <status>drafted</status>
    <generatedAt>2025-11-16</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/1-6-2-bom-timeline-multi-version.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>Technical Manager / Production Planner</asA>
    <iWant>Visual BOM version timeline with overlap detection and drag-drop date adjustments</iWant>
    <soThat>version selection takes 30 seconds (vs 5 minutes date guessing) and version conflicts are eliminated (90% reduction)</soThat>
    <tasks>6 tasks: Timeline component (Gantt-style), drag-drop dates (left/right edges), overlap detection algorithm, version lifecycle (Draft/Active/Phased Out/Inactive), BOM comparison modal, E2E tests, documentation. Total: 30h (~4 days)</tasks>
  </story>

  <acceptanceCriteria>4 ACs covering: (1) Gantt-style timeline (X=dates, Y=BOM versions), overlap detection, color coding by status, (2) Drag-drop date adjustment (left edge = effective_from, right edge = effective_to), (3) Version lifecycle auto-calculation (when new version created → previous version effective_to = new effective_from - 1 day), (4) BOM comparison modal (side-by-side diff with quantity deltas, PDF export)</acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="docs/ux-design-technical-module.md" title="Technical Module UX" section="BOM Timeline Multi-Version">
        Visual timeline for BOM versions. Features: Drag-drop dates, overlap detection, version comparison. Time savings: 83% (30s vs 5min). ROI: 90% reduction in version conflicts.
      </doc>
      <doc path="docs/architecture.md" title="Architecture" section="Multi-Version BOM">
        Database trigger prevents overlapping dates for same product. BOM lifecycle: Draft → Active → Phased Out → Inactive.
      </doc>
    </docs>
    <code>
      <artifact path="apps/frontend/lib/api/boms.ts" kind="API Class">
        Update BOM effective_from/effective_to via drag-drop
      </artifact>
    </code>
    <dependencies>
      <framework>Gantt chart library (dhtmlx-gantt or custom)</framework>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="validation">Database trigger prevents overlapping BOM versions for same product</constraint>
    <constraint type="lifecycle">Status transitions: Draft → Active (drag effective_from to past), Active → Phased Out (drag effective_to to past)</constraint>
    <constraint type="auto-calculation">When new version created → previous version effective_to = new effective_from - 1 day</constraint>
  </constraints>

  <interfaces>
    <interface name="BOMTimeline component" kind="React Component">
      <signature>&lt;BOMTimeline productId={123} onVersionUpdate={handleUpdate} /&gt;</signature>
    </interface>
    <interface name="detectOverlaps()" kind="Function">
      <signature>function detectOverlaps(versions: BOMVersion[]): { version1: number, version2: number }[]</signature>
    </interface>
  </interfaces>

  <tests>
    <standards>E2E required for: Drag-drop date adjustment, overlap detection, version comparison modal</standards>
    <locations>
      <e2e>apps/frontend/e2e/bom-timeline.spec.ts</e2e>
    </locations>
    <ideas>
      <test ac="AC-2" risk="HIGH">E2E: Drag BOM version left edge → effective_from updated</test>
      <test ac="AC-1" risk="CRITICAL">E2E: Create overlapping version → red outline + warning shown</test>
      <test ac="AC-4" risk="MEDIUM">E2E: Ctrl+Click two versions → comparison modal shows diff</test>
    </ideas>
  </tests>
</story-context>
