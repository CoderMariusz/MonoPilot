<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>0</epicId>
    <storyId>1</storyId>
    <title>Fix PO Header warehouse_id (CRITICAL)</title>
    <status>drafted</status>
    <generatedAt>2025-11-14</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/0-1-fix-po-header-warehouse-id.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>Planner/Purchasing Officer</asA>
    <iWant>create Purchase Orders with destination warehouse explicitly specified</iWant>
    <soThat>materials are correctly routed to the intended warehouse upon receiving (GRN)</soThat>
    <tasks>
      <task id="1" name="Database Migration" acs="AC-1" hours="4">
        <subtask id="1.1">Create migration file 0XX_add_warehouse_id_to_po_header.sql</subtask>
        <subtask id="1.2">Add precondition check (warehouses table not empty)</subtask>
        <subtask id="1.3">Add NULLABLE warehouse_id column with FK constraint</subtask>
        <subtask id="1.4">Create index CONCURRENTLY idx_po_header_warehouse_id</subtask>
        <subtask id="1.5">Set default warehouse_id for existing PO rows</subtask>
        <subtask id="1.6">Test migration on local database</subtask>
        <subtask id="1.7">Test migration on staging environment</subtask>
      </task>
      <task id="2" name="TypeScript Types Update" acs="AC-2" hours="1">
        <subtask id="2.1">Run pnpm gen-types to regenerate Supabase types</subtask>
        <subtask id="2.2">Update lib/types.ts POHeader interface (add warehouse_id, warehouse)</subtask>
        <subtask id="2.3">Verify no TypeScript compilation errors</subtask>
      </task>
      <task id="3" name="API Validation" acs="AC-3" hours="2">
        <subtask id="3.1">Add validation in PurchaseOrdersAPI.quickCreate() method</subtask>
        <subtask id="3.2">Throw error if warehouse_id is undefined or null</subtask>
        <subtask id="3.3">Verify RPC function quick_create_pos handles warehouse_id correctly</subtask>
      </task>
      <task id="4" name="UI Form Updates" acs="AC-4" hours="6">
        <subtask id="4.1">Add warehouse dropdown to PO create form</subtask>
        <subtask id="4.2">Mark dropdown as REQUIRED (red asterisk)</subtask>
        <subtask id="4.3">Add inline help text explaining warehouse purpose</subtask>
        <subtask id="4.4">Implement smart pre-select (if only 1 warehouse)</subtask>
        <subtask id="4.5">Add client-side validation</subtask>
        <subtask id="4.6">Add error state handling (empty warehouse list)</subtask>
        <subtask id="4.7">Test form submission with/without warehouse</subtask>
      </task>
      <task id="5" name="Unit Tests" acs="AC-5" hours="2">
        <subtask id="5.1">Write test: API rejects missing warehouse_id</subtask>
        <subtask id="5.2">Write test: API rejects null warehouse_id</subtask>
        <subtask id="5.3">Write test: API creates PO with valid warehouse_id</subtask>
        <subtask id="5.4">Run pnpm test:unit and verify all pass</subtask>
      </task>
      <task id="6" name="E2E Tests" acs="AC-6" hours="3">
        <subtask id="6.1">Write E2E test: Quick PO Entry requires warehouse</subtask>
        <subtask id="6.2">Write E2E test: Shows error when warehouse not selected</subtask>
        <subtask id="6.3">Write E2E test: Creates PO successfully with warehouse</subtask>
        <subtask id="6.4">Write E2E test: Handles empty warehouse list</subtask>
        <subtask id="6.5">Use test fixtures (create warehouse in beforeEach)</subtask>
        <subtask id="6.6">Run pnpm test:e2e:critical and verify all pass</subtask>
      </task>
      <task id="7" name="Documentation Updates" acs="AC-7" hours="2">
        <subtask id="7.1">Run pnpm docs:update to regenerate API_REFERENCE.md</subtask>
        <subtask id="7.2">Update docs/04_PLANNING.md with warehouse requirement</subtask>
        <subtask id="7.3">Add new section to docs/architecture.md: Required Business Context Pattern</subtask>
        <subtask id="7.4">Document business rule: warehouse_id is required (no defaults)</subtask>
      </task>
      <task id="8" name="Deployment and Verification" acs="AC-8" hours="3">
        <subtask id="8.1">Follow deployment checklist (migration → code deploy)</subtask>
        <subtask id="8.2">Verify migration on staging</subtask>
        <subtask id="8.3">Run full E2E suite on staging</subtask>
        <subtask id="8.4">Deploy to production</subtask>
        <subtask id="8.5">Verify Quick PO Entry works in production</subtask>
        <subtask id="8.6">Monitor for NULL warehouse_id rows (should be zero)</subtask>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <ac id="AC-1" title="Database Migration">
      <criterion>Column warehouse_id added to po_header table</criterion>
      <criterion>Column is NULLABLE (for migration safety)</criterion>
      <criterion>Foreign key constraint to warehouses(id) exists</criterion>
      <criterion>Index idx_po_header_warehouse_id created using CONCURRENTLY</criterion>
      <criterion>Migration includes precondition check (warehouses table not empty)</criterion>
      <criterion>Existing PO rows have default warehouse_id set</criterion>
    </ac>
    <ac id="AC-2" title="TypeScript Types">
      <criterion>POHeader interface includes warehouse_id?: number</criterion>
      <criterion>POHeader interface includes warehouse?: Warehouse relationship</criterion>
      <criterion>Supabase generated types include warehouse_id (via pnpm gen-types)</criterion>
    </ac>
    <ac id="AC-3" title="API Validation (ENHANCED BY TEAM)">
      <criterion>PurchaseOrdersAPI.quickCreate() validates warehouse_id is provided</criterion>
      <criterion>API throws error "warehouse_id is required" if missing or null</criterion>
      <criterion>RPC function quick_create_pos correctly inserts warehouse_id</criterion>
    </ac>
    <ac id="AC-4" title="UI Form (ENHANCED BY TEAM)">
      <criterion>PO create form has warehouse dropdown (REQUIRED field with red asterisk)</criterion>
      <criterion>Dropdown pre-selects if only 1 warehouse exists</criterion>
      <criterion>Inline help text: "Where should materials be received? This determines GRN routing."</criterion>
      <criterion>Client-side validation shows error if warehouse not selected</criterion>
      <criterion>Error message: "Please select a destination warehouse"</criterion>
    </ac>
    <ac id="AC-5" title="Unit Tests">
      <criterion>API test: Rejects when warehouse_id is missing</criterion>
      <criterion>API test: Rejects when warehouse_id is null</criterion>
      <criterion>API test: Creates PO successfully with valid warehouse_id</criterion>
    </ac>
    <ac id="AC-6" title="E2E Tests">
      <criterion>E2E test: Quick PO Entry requires warehouse selection</criterion>
      <criterion>E2E test: Shows error when warehouse not selected</criterion>
      <criterion>E2E test: Creates PO successfully with warehouse selected</criterion>
      <criterion>E2E test: Handles empty warehouse list gracefully</criterion>
    </ac>
    <ac id="AC-7" title="Documentation (ENHANCED BY TEAM)">
      <criterion>docs/API_REFERENCE.md marks warehouse_id as REQUIRED</criterion>
      <criterion>docs/04_PLANNING.md updated with warehouse requirement</criterion>
      <criterion>docs/architecture.md new section: "Required Business Context Pattern"</criterion>
    </ac>
    <ac id="AC-8" title="Quality Gates">
      <criterion>All E2E tests passing</criterion>
      <criterion>No TypeScript compilation errors</criterion>
      <criterion>Migration tested on staging before production</criterion>
      <criterion>Quick PO Entry workflow works end-to-end</criterion>
    </ac>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="docs/bmm-roadmap-epic-0-p0-fixes.md" title="Epic 0 Roadmap" section="Story 0.1: Fix PO Header warehouse_id">
        <snippet>Critical bug fix - API quick_create_pos tries to INSERT warehouse_id into po_header but column doesn't exist. SQL error blocks Quick PO Entry workflow. Solution: Add NULLABLE warehouse_id column via migration, update TypeScript, validate in API, add UI dropdown.</snippet>
      </doc>
      <doc path="docs/MonoPilot-PRD-2025-11-13.md" title="MonoPilot PRD" section="Epic 0: Critical Prerequisite">
        <snippet>Epic 0 addresses 7 critical data integrity issues discovered during solutioning gate check. Story 0.1 fixes missing warehouse_id column preventing Quick PO Entry from functioning. Must complete before Phase 1.</snippet>
      </doc>
      <doc path="docs/architecture.md" title="System Architecture" section="Database Schema &amp; API Design">
        <snippet>Architecture patterns include multi-tenant RLS, audit trails, status lifecycles, and foreign key relationships. Story 0.1 establishes "Required Business Context Pattern" - critical business context must be explicit in API calls.</snippet>
      </doc>
      <doc path="docs/P0-MODULES-AUDIT-REPORT-2025-11-14.md" title="P0 Modules Audit Report" section="Problem #1: PO Header Missing warehouse_id">
        <snippet>Comprehensive audit findings: Migration 016 created po_header without warehouse_id. RPC function 039 added later assumes column exists. Result: SQL error on Quick PO Entry. Includes failure scenarios, prevention strategies, and root cause analysis.</snippet>
      </doc>
    </docs>
    <code>
      <artifact path="apps/frontend/lib/supabase/migrations/016_po_header.sql" kind="migration" symbol="CREATE TABLE po_header" lines="1-50" reason="Current po_header schema WITHOUT warehouse_id column - needs ALTER TABLE to add it">
        <note>Original migration creating po_header table. Story 0.1 will create new migration (057) to add warehouse_id column.</note>
      </artifact>
      <artifact path="apps/frontend/lib/supabase/migrations/039_rpc_functions.sql" kind="rpc-function" symbol="quick_create_pos" lines="304" reason="RPC function tries to INSERT warehouse_id but column doesn't exist - causes SQL error">
        <note>RPC already expects warehouse_id parameter. After migration, this will work correctly.</note>
      </artifact>
      <artifact path="apps/frontend/lib/api/purchaseOrders.ts" kind="api-class" symbol="PurchaseOrdersAPI" lines="1-100" reason="API class for PO operations - needs validation added to quickCreate() method">
        <interface name="QuickPOCreateRequest" lines="9-12">
          <property name="warehouse_id" type="number | undefined" note="Already defined - API accepts it but doesn't validate (Story 0.1 adds validation)" />
        </interface>
        <method name="quickCreate" lines="285-310" note="Needs validation: throw error if warehouse_id missing/null" />
      </artifact>
      <artifact path="apps/frontend/lib/types.ts" kind="type-definitions" symbol="POHeader" lines="414-440" reason="POHeader interface missing warehouse_id and warehouse relationship fields">
        <note>Needs two additions: warehouse_id?: number and warehouse?: Warehouse</note>
      </artifact>
      <artifact path="apps/frontend/__tests__/purchaseOrders.test.ts" kind="unit-test" symbol="PurchaseOrdersAPI tests" reason="Existing unit tests - Story 0.1 adds 3 new tests for warehouse_id validation">
        <note>Add tests: rejects missing warehouse_id, rejects null warehouse_id, accepts valid warehouse_id</note>
      </artifact>
      <artifact path="apps/frontend/e2e/02-purchase-orders/" kind="e2e-test-dir" reason="E2E test directory for PO workflows - Story 0.1 adds Quick PO Entry tests">
        <note>Create new test file for Quick PO Entry workflow with warehouse validation scenarios</note>
      </artifact>
    </code>
    <dependencies>
      <node>
        <dep name="next" version="^15.5.4" />
        <dep name="react" version="^19.0.0" />
        <dep name="typescript" version="^5.7.2" />
        <dep name="@supabase/supabase-js" version="^2.75.0" />
        <dep name="@supabase/ssr" version="^0.7.0" />
        <dep name="tailwindcss" version="^3.4.17" />
        <dep name="zod" version="^3.24.1" />
        <dep name="swr" version="^2.2.6" />
      </node>
      <devDependencies>
        <dep name="@playwright/test" version="^1.56.1" note="E2E testing framework" />
        <dep name="vitest" version="^4.0.6" note="Unit testing framework" />
        <dep name="prettier" version="^3.3.3" />
        <dep name="eslint-config-next" version="^15.5.4" />
        <dep name="tsx" version="^4.20.6" note="TypeScript execution for scripts" />
      </devDependencies>
      <frameworks>
        <framework name="Next.js" version="15" note="App Router architecture with React Server Components" />
        <framework name="Supabase" note="PostgreSQL database, Auth, RLS, Real-time subscriptions" />
        <framework name="Tailwind CSS" version="3.4" note="Utility-first styling" />
      </frameworks>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="migration">
      <rule>Migration numbering must be sequential - next number is 057</rule>
      <rule>Use CREATE INDEX CONCURRENTLY to avoid table locks on production</rule>
      <rule>Add precondition check: HALT if warehouses table is empty</rule>
      <rule>Column must be NULLABLE for migration safety (existing PO rows)</rule>
      <rule>Set default warehouse_id for existing rows before making NOT NULL (if ever)</rule>
    </constraint>
    <constraint type="database">
      <rule>All business tables have org_id with RLS policies for multi-tenancy</rule>
      <rule>Foreign keys use ON DELETE RESTRICT by default</rule>
      <rule>Audit columns: created_by, updated_by, created_at, updated_at on most tables</rule>
    </constraint>
    <constraint type="api">
      <rule>API validation: warehouse_id is REQUIRED - reject if missing/null</rule>
      <rule>Error message: "warehouse_id is required"</rule>
      <rule>No magic defaults - explicit business context required</rule>
      <rule>Establishes pattern: Required Business Context Pattern for future stories</rule>
    </constraint>
    <constraint type="ui">
      <rule>Warehouse dropdown is REQUIRED field (marked with red asterisk *)</rule>
      <rule>Smart pre-select: If only 1 warehouse, pre-select it but keep dropdown visible</rule>
      <rule>Inline help text: "Where should materials be received? This determines GRN routing."</rule>
      <rule>Client-side validation before form submit</rule>
      <rule>Error state: "No warehouses found. Please create a warehouse first."</rule>
    </constraint>
    <constraint type="testing">
      <rule>Unit tests use Vitest - location: apps/frontend/__tests__/</rule>
      <rule>E2E tests use Playwright - location: apps/frontend/e2e/</rule>
      <rule>Critical E2E tests run in CI/CD: pnpm test:e2e:critical</rule>
      <rule>Use test fixtures - create warehouse in beforeEach, don't hardcode IDs</rule>
      <rule>All tests must pass before marking story complete</rule>
    </constraint>
    <constraint type="deployment">
      <rule>Deployment order: Run migration FIRST, then deploy code</rule>
      <rule>Test migration on local DB, then staging, then production</rule>
      <rule>Verify pnpm gen-types after migration to sync TypeScript types</rule>
      <rule>Run pnpm docs:update to regenerate API/DB documentation</rule>
      <rule>Monitor for NULL warehouse_id rows after deployment</rule>
    </constraint>
  </constraints>

  <interfaces>
    <interface name="QuickPOCreateRequest" kind="TypeScript interface" path="apps/frontend/lib/api/purchaseOrders.ts" lines="9-12">
      <signature>
        interface QuickPOCreateRequest {
          lines: QuickPOEntryLine[];
          warehouse_id?: number;  // Already present - Story 0.1 adds validation
        }
      </signature>
      <note>API already accepts warehouse_id. Story 0.1 adds validation to enforce it's required.</note>
    </interface>
    <interface name="POHeader" kind="TypeScript interface" path="apps/frontend/lib/types.ts" lines="414-440">
      <signature>
        export interface POHeader {
          id: number;
          number: string;
          supplier_id: number;
          status: POStatus;
          // ... other fields
          // ❌ MISSING: warehouse_id?: number
          // ❌ MISSING: warehouse?: Warehouse
        }
      </signature>
      <note>Story 0.1 adds two fields: warehouse_id?: number and warehouse?: Warehouse</note>
    </interface>
    <interface name="PurchaseOrdersAPI.quickCreate" kind="Static method" path="apps/frontend/lib/api/purchaseOrders.ts" lines="285-310">
      <signature>
        static async quickCreate(request: QuickPOCreateRequest): Promise&lt;QuickPOCreateResponse&gt;
      </signature>
      <note>Story 0.1 adds validation at start: if (!request.warehouse_id) throw new Error('warehouse_id is required')</note>
    </interface>
    <interface name="quick_create_pos" kind="PostgreSQL RPC function" path="apps/frontend/lib/supabase/migrations/039_rpc_functions.sql" lines="290-350">
      <signature>
        CREATE OR REPLACE FUNCTION quick_create_pos(
          p_product_entries jsonb,
          p_user_id uuid,
          p_warehouse_id integer  -- Already expects this parameter
        ) RETURNS jsonb
      </signature>
      <note>RPC function already tries to use warehouse_id. After migration adds column, this will work correctly.</note>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Testing framework: Vitest for unit tests (apps/frontend/__tests__/), Playwright for E2E tests (apps/frontend/e2e/). Test patterns: Use test fixtures with beforeEach for data setup, avoid hardcoded IDs, mock Supabase client for unit tests, use real database for E2E. Critical test suite (pnpm test:e2e:critical) runs auth, PO, and TO tests. All tests must pass before story marked complete. Risk-based testing: High-risk scenarios (migration rollback, empty warehouse list, FK failures) require E2E tests; medium-risk (type mismatches, API validation) covered by unit tests.
    </standards>
    <locations>
      <location pattern="apps/frontend/__tests__/**/*.test.ts" description="Unit tests (Vitest)" />
      <location pattern="apps/frontend/lib/api/__tests__/**/*.test.ts" description="API unit tests" />
      <location pattern="apps/frontend/e2e/**/*.spec.ts" description="E2E tests (Playwright)" />
      <location pattern="apps/frontend/e2e/02-purchase-orders/**/*.spec.ts" description="PO E2E tests - add Quick PO Entry here" />
    </locations>
    <ideas>
      <idea ac="AC-5" description="Unit test: API rejects when warehouse_id is missing">
        <code>
          test('should reject when warehouse_id is missing', async () => {
            const request = { lines: [{ product_code: 'BEEF001', quantity: 100 }] };
            await expect(PurchaseOrdersAPI.quickCreate(request)).rejects.toThrow('warehouse_id is required');
          });
        </code>
      </idea>
      <idea ac="AC-5" description="Unit test: API rejects when warehouse_id is null">
        <code>
          test('should reject when warehouse_id is null', async () => {
            const request = { lines: [...], warehouse_id: null };
            await expect(PurchaseOrdersAPI.quickCreate(request)).rejects.toThrow('warehouse_id is required');
          });
        </code>
      </idea>
      <idea ac="AC-6" description="E2E test: Quick PO Entry requires warehouse selection">
        <code>
          test('Quick PO Entry requires warehouse selection', async ({ page }) => {
            await page.goto('/planning/quick-po-entry');
            // Try submit without warehouse
            await page.fill('#product-0', 'BEEF001');
            await page.click('button[type="submit"]');
            await expect(page.locator('.error-message')).toContainText('warehouse_id is required');
          });
        </code>
      </idea>
      <idea ac="AC-6" description="E2E test: Creates PO successfully with warehouse">
        <code>
          test('Creates PO with warehouse', async ({ page }) => {
            await page.goto('/planning/quick-po-entry');
            await page.selectOption('#warehouse', { label: 'Main Warehouse' });
            await page.fill('#product-0', 'BEEF001');
            await page.click('button[type="submit"]');
            await expect(page.locator('.success-message')).toContainText('PO created successfully');
          });
        </code>
      </idea>
      <idea ac="AC-6" description="E2E test: Handles empty warehouse list gracefully">
        <code>
          test('Shows error when no warehouses exist', async ({ page }) => {
            // Setup: Delete all warehouses in test fixture
            await page.goto('/planning/quick-po-entry');
            await expect(page.locator('.error-message')).toContainText('No warehouses found');
          });
        </code>
      </idea>
    </ideas>
  </tests>
</story-context>
