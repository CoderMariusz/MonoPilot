<story-context id="bmad/bmm/workflows/4-implementation/story-context/4-13-actual-yield-tracking" v="1.0">
  <metadata>
    <epicId>4</epicId>
    <storyId>13</storyId>
    <title>Actual Yield Tracking</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-11-24</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/epics/epic-4-production.md</sourceStoryPath>
    <template>Custom</template>
    <estimatedTokens>3000</estimatedTokens>
    <estimatedEffort>0.5 day</estimatedEffort>
  </metadata>

  <story>
    <asA>Production Manager</asA>
    <iWant>to record actual vs planned quantity and see yield metrics</iWant>
    <soThat>I can identify efficiency issues and optimize production</soThat>
    <tasks>
      <task id="1" ac="AC-4.13.1">Yield Calculation API - GET /api/production/work-orders/:id/yield returns yield summary</task>
      <task id="2" ac="AC-4.13.2">Output Yield Calculation - Calculate (actual_output / planned_qty) Ã— 100%</task>
      <task id="3" ac="AC-4.13.3">Material Yield Calculation - Calculate (planned_material / consumed_qty) Ã— 100%</task>
      <task id="4" ac="AC-4.13.4">Operation Yields - Calculate yield % for each operation from wo_operations</task>
      <task id="5" ac="AC-4.13.5">Yield Summary Display - Show Output Yield, Material Yield, Operation Yields with color coding</task>
      <task id="6" ac="AC-4.13.6">Color Coding Logic - Green >= 95%, Yellow 80-95%, Red < 80%</task>
      <task id="7" ac="AC-4.13.7">WO Detail Integration - Display yield summary section on WO detail page</task>
      <task id="8" ac="ALL">Unit & Integration Tests - Yield calculation tests, color coding tests, API route tests</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC-4.13.1">Given viewing WO detail page with completed or in-progress WO, Then see Yield Summary section displaying: Output Yield, Material Yield, Operation Yields (if operations exist)</criterion>
    <criterion id="AC-4.13.2">Output Yield calculation: (actual_output_qty / planned_qty) Ã— 100%. Example: planned 100 kg, actual 95 kg â†’ 95% output yield</criterion>
    <criterion id="AC-4.13.3">Material Yield calculation: (planned_material_qty / actual_consumed_qty) Ã— 100% for each material. Example: planned 50 kg flour, consumed 55 kg â†’ 90.9% material yield (over-consumption)</criterion>
    <criterion id="AC-4.13.4">Operation Yields: For each operation in wo_operations, calculate (actual_yield_percent / 100%) if recorded, otherwise display "N/A"</criterion>
    <criterion id="AC-4.13.5">Color coding for yield metrics: Green badge (bg-green-100 text-green-800) if yield >= 95%, Yellow badge (bg-yellow-100 text-yellow-800) if 80% <= yield < 95%, Red badge (bg-red-100 text-red-800) if yield < 80%</criterion>
    <criterion id="AC-4.13.6">Display format: "Output Yield: [95.0%] ðŸŸ¢" with badge styling and emoji indicator</criterion>
    <criterion id="AC-4.13.7">Yield Summary section positioned below WO header, above Materials/Operations tabs on WO detail page</criterion>
    <criterion id="AC-4.13.8">If no output registered yet (actual_output_qty = 0), display "No output registered yet" message instead of 0% yield to avoid confusion</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/epics/epic-4-production.md</path>
        <title>Epic 4: Production Execution</title>
        <section>Story 4.15: Yield Tracking</section>
        <snippet>Production Manager views WO detail to see yield summary: Output Yield (actual_output / planned Ã— 100%), Material Yield (planned_material / consumed Ã— 100%), Operation Yields from each operation. Color coding: Green >= 95%, Yellow 80-95%, Red < 80%. Prerequisites: Story 4.12 (Output Registration).</snippet>
      </doc>
      <doc>
        <path>docs/architecture/patterns/api.md</path>
        <title>API Architecture</title>
        <section>API Pattern - Class-Based Services</section>
        <snippet>WorkOrdersAPI class with static methods for CRUD operations and business logic. Example: getAll(), getById(), create(), updateStatus() methods. Error handling with APIError class. Validation with Zod schemas.</snippet>
      </doc>
      <doc>
        <path>docs/architecture/patterns/api.md</path>
        <title>API Architecture</title>
        <section>Response Patterns - Single Resource</section>
        <snippet>Single resource responses wrapped in ResourceResponse&lt;T&gt; with data field. Example: { data: WorkOrder } or Problem Details error on failure.</snippet>
      </doc>
    </docs>

    <code>
      <artifact>
        <path>app/api/production/work-orders/[id]/yield</path>
        <kind>directory</kind>
        <symbol>Yield Calculation API route location</symbol>
        <reason>Story requires creating route.ts for GET /api/production/work-orders/:id/yield endpoint</reason>
      </artifact>
      <artifact>
        <path>lib/services/yield-calculation-service.ts</path>
        <kind>file</kind>
        <symbol>Yield calculation service</symbol>
        <reason>Story requires service with methods: calculateOutputYield(), calculateMaterialYields(), calculateOperationYields(), getYieldSummary()</reason>
      </artifact>
      <artifact>
        <path>lib/api/WorkOrdersAPI.ts</path>
        <kind>file</kind>
        <symbol>WorkOrdersAPI class</symbol>
        <reason>Story requires adding getYieldSummary() method to API class for client-side yield data fetching</reason>
      </artifact>
      <artifact>
        <path>components/production/YieldSummary.tsx</path>
        <kind>component</kind>
        <symbol>YieldSummary</symbol>
        <reason>Story requires component displaying Output Yield, Material Yields, Operation Yields with color-coded badges</reason>
      </artifact>
      <artifact>
        <path>components/production/YieldBadge.tsx</path>
        <kind>component</kind>
        <symbol>YieldBadge</symbol>
        <reason>Story requires reusable badge component with color coding logic (green/yellow/red based on yield %)</reason>
      </artifact>
      <artifact>
        <path>lib/utils/yield-calculator.ts</path>
        <kind>file</kind>
        <symbol>Yield calculation utilities</symbol>
        <reason>Story requires utility functions: calculatePercentage(), getYieldColor(), formatYieldDisplay()</reason>
      </artifact>
    </code>

    <dependencies>
      <node>
        <package name="@supabase/supabase-js" version="^2.84.0" usage="Supabase client for fetching WO data, materials, operations for yield calculations" />
        <package name="@supabase/ssr" version="^0.7.0" usage="SSR helpers for Next.js (createServerClient for API routes)" />
        <package name="next" version="^15.1.4" usage="Next.js framework with App Router for API routes (yield endpoint)" />
        <package name="react" version="^19.0.0" usage="React 19 for UI components (YieldSummary, YieldBadge)" />
        <package name="zod" version="^3.25.76" usage="Validation schemas for yield calculation input (optional)" />
        <package name="lucide-react" version="^0.554.0" usage="Icons for yield display (trending-up, trending-down, activity icons)" />
        <package name="clsx" version="^2.1.1" usage="Utility for conditional className construction for color-coded badges" />
      </node>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="architecture">Next.js 15 App Router - use app/ directory structure, server components by default for WO detail page, client component for YieldSummary</constraint>
    <constraint type="architecture">Class-based API pattern - add getYieldSummary() method to WorkOrdersAPI class</constraint>
    <constraint type="business">Output Yield formula - (actual_output_qty / planned_qty) Ã— 100%</constraint>
    <constraint type="business">Material Yield formula - (planned_material_qty / actual_consumed_qty) Ã— 100% for each material</constraint>
    <constraint type="business">Operation Yield - use actual_yield_percent from wo_operations if recorded, otherwise display "N/A"</constraint>
    <constraint type="business">Color coding thresholds - Green >= 95%, Yellow 80-95%, Red < 80%</constraint>
    <constraint type="business">Zero output handling - If actual_output_qty = 0, display "No output registered yet" instead of 0% to avoid confusion</constraint>
    <constraint type="ux">Shadcn/UI components - use Badge (or custom YieldBadge) for color-coded yield display</constraint>
    <constraint type="ux">Yield Summary layout - Card component with title "Yield Summary", grid layout for Output/Material/Operation yields, badges with % and emoji indicators</constraint>
    <constraint type="ux">Responsive design - yield summary responsive on mobile (stack vertically), desktop (grid layout)</constraint>
    <constraint type="testing">Test pyramid - 95% unit coverage for yield calculation service (edge cases: 0 output, 0 consumption, over-consumption), 70% integration coverage for API route, 100% E2E coverage for yield display on WO page</constraint>
    <constraint type="performance">Yield calculation caching - consider caching yield summary for completed WOs (immutable after completion)</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>GET /api/production/work-orders/:id/yield</name>
      <kind>API route</kind>
      <signature>GET /api/production/work-orders/{wo_id}/yield - Response: { data: YieldSummary } where YieldSummary = { output_yield: number, material_yields: MaterialYield[], operation_yields: OperationYield[] } or Problem Details error</signature>
      <path>app/api/production/work-orders/[id]/yield/route.ts</path>
    </interface>
    <interface>
      <name>getYieldSummary</name>
      <kind>service function</kind>
      <signature>async function getYieldSummary(woId: string): Promise&lt;ServiceResult&lt;YieldSummary&gt;&gt; - Fetches WO, calculates output yield, material yields, operation yields, returns summary object</signature>
      <path>lib/services/yield-calculation-service.ts</path>
    </interface>
    <interface>
      <name>calculateOutputYield</name>
      <kind>utility function</kind>
      <signature>function calculateOutputYield(actualQty: number, plannedQty: number): number - Returns (actualQty / plannedQty) Ã— 100, handles division by zero</signature>
      <path>lib/utils/yield-calculator.ts</path>
    </interface>
    <interface>
      <name>calculateMaterialYield</name>
      <kind>utility function</kind>
      <signature>function calculateMaterialYield(plannedQty: number, consumedQty: number): number - Returns (plannedQty / consumedQty) Ã— 100, handles division by zero</signature>
      <path>lib/utils/yield-calculator.ts</path>
    </interface>
    <interface>
      <name>getYieldColor</name>
      <kind>utility function</kind>
      <signature>function getYieldColor(yieldPercent: number): 'green' | 'yellow' | 'red' - Returns color based on thresholds: >= 95% green, 80-95% yellow, < 80% red</signature>
      <path>lib/utils/yield-calculator.ts</path>
    </interface>
    <interface>
      <name>WorkOrdersAPI.getYieldSummary</name>
      <kind>API class method</kind>
      <signature>static async getYieldSummary(woId: string): Promise&lt;YieldSummary&gt; - Client-side method calling GET /api/production/work-orders/:id/yield</signature>
      <path>lib/api/WorkOrdersAPI.ts</path>
    </interface>
    <interface>
      <name>YieldSummary</name>
      <kind>React component</kind>
      <signature>YieldSummary: FC&lt;{ woId: string }&gt; - Fetches yield data via SWR, displays Output Yield, Material Yields, Operation Yields with color-coded YieldBadge components</signature>
      <path>components/production/YieldSummary.tsx</path>
    </interface>
    <interface>
      <name>YieldBadge</name>
      <kind>React component</kind>
      <signature>YieldBadge: FC&lt;{ label: string, value: number | null, unit?: string }&gt; - Displays yield value with color coding (green/yellow/red badge), emoji indicator (ðŸŸ¢/ðŸŸ¡/ðŸ”´), formatted percentage</signature>
      <path>components/production/YieldBadge.tsx</path>
    </interface>
    <interface>
      <name>YieldSummary type</name>
      <kind>TypeScript type</kind>
      <signature>type YieldSummary = { output_yield: number | null, material_yields: { material_id: string, material_name: string, planned_qty: number, consumed_qty: number, yield_percent: number }[], operation_yields: { operation_id: string, operation_name: string, yield_percent: number | null }[] }</signature>
      <path>lib/types.ts</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Testing strategy follows Test Pyramid: unit tests for yield calculation service and utilities (95% coverage, mock Supabase client with vitest, test edge cases: 0 output, 0 consumption, over-consumption, division by zero), integration tests for API route (70% coverage, Vitest + Supabase Test Client), E2E tests for yield display on WO detail page (100% user flows, Playwright). All tests in __tests__ directories colocated with source. Test files follow pattern: service.test.ts (unit), route.test.ts (integration), yield-display.e2e.ts (E2E). Fixtures in __fixtures__. Mock Supabase in unit tests.
    </standards>
    <locations>
      <location>lib/services/__tests__/yield-calculation-service.test.ts (Yield calculation service unit tests with mocked Supabase)</location>
      <location>lib/utils/__tests__/yield-calculator.test.ts (Yield calculation utility unit tests)</location>
      <location>app/api/production/work-orders/[id]/yield/__tests__/route.test.ts (API route integration tests)</location>
      <location>components/production/__tests__/YieldSummary.test.tsx (YieldSummary component unit tests)</location>
      <location>components/production/__tests__/YieldBadge.test.tsx (YieldBadge component unit tests with color coding)</location>
      <location>e2e/production/yield-tracking.e2e.ts (Yield display on WO detail page E2E tests)</location>
    </locations>
    <ideas>
      <idea ac="AC-4.13.2">Unit test: calculateOutputYield(95, 100) returns 95.0</idea>
      <idea ac="AC-4.13.2">Unit test: calculateOutputYield(0, 100) returns 0 (no output registered yet)</idea>
      <idea ac="AC-4.13.2">Unit test: calculateOutputYield(100, 0) handles division by zero (returns null or Infinity)</idea>
      <idea ac="AC-4.13.3">Unit test: calculateMaterialYield(50, 55) returns 90.9 (over-consumption scenario)</idea>
      <idea ac="AC-4.13.3">Unit test: calculateMaterialYield(50, 50) returns 100.0 (perfect material usage)</idea>
      <idea ac="AC-4.13.3">Unit test: calculateMaterialYield(50, 0) handles division by zero (returns null or Infinity)</idea>
      <idea ac="AC-4.13.5">Unit test: getYieldColor(96) returns 'green' (>= 95%)</idea>
      <idea ac="AC-4.13.5">Unit test: getYieldColor(87) returns 'yellow' (80-95%)</idea>
      <idea ac="AC-4.13.5">Unit test: getYieldColor(75) returns 'red' (< 80%)</idea>
      <idea ac="AC-4.13.1">Integration test: GET /api/production/work-orders/:id/yield with completed WO returns 200 and yield summary object</idea>
      <idea ac="AC-4.13.1">Integration test: GET /yield with WO not found returns 404 error</idea>
      <idea ac="AC-4.13.8">Unit test: getYieldSummary() with actual_output_qty = 0 returns output_yield = null and message "No output registered yet"</idea>
      <idea ac="AC-4.13.1">E2E test: Navigate to WO detail page with completed WO, see Yield Summary section with Output Yield, Material Yields, Operation Yields</idea>
      <idea ac="AC-4.13.5">E2E test: WO with 96% output yield displays green badge with ðŸŸ¢ emoji</idea>
      <idea ac="AC-4.13.5">E2E test: WO with 85% material yield displays yellow badge with ðŸŸ¡ emoji</idea>
      <idea ac="AC-4.13.5">E2E test: WO with 70% operation yield displays red badge with ðŸ”´ emoji</idea>
      <idea ac="AC-4.13.7">E2E test: Yield Summary section positioned below WO header, above Materials/Operations tabs on WO detail page</idea>
      <idea ac="AC-4.13.8">E2E test: WO with no output registered yet displays "No output registered yet" message instead of 0% yield</idea>
      <idea ac="ALL">Unit test: YieldBadge component renders correct color class (bg-green-100, bg-yellow-100, bg-red-100) based on yield value</idea>
      <idea ac="ALL">Unit test: YieldBadge component renders emoji indicator (ðŸŸ¢, ðŸŸ¡, ðŸ”´) based on yield value</idea>
    </ideas>
  </tests>
</story-context>
