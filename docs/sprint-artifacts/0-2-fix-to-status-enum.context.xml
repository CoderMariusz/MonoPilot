<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>0</epicId>
    <storyId>2</storyId>
    <title>Fix TO Status enum (MEDIUM)</title>
    <status>drafted</status>
    <generatedAt>2025-11-14</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/0-2-fix-to-status-enum.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>Warehouse Manager / Planner</asA>
    <iWant>Transfer Orders to support 'closed' status in the TypeScript type system</iWant>
    <soThat>the UI correctly handles and displays closed Transfer Orders matching the database schema</soThat>
    <tasks>
      - TypeScript Enum Update (1 hour): Add 'closed' to TOStatus type in lib/types.ts
      - UI Component Updates (2 hours): Update status badges and filters to handle 'closed' status
      - Unit Tests (1.5 hours): Verify TOStatus enum includes all 6 values
      - E2E Tests (1.5 hours): Test display and filtering of 'closed' status
      - Documentation Updates (1 hour): Regenerate API docs and update Planning Module docs
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC-1">
      <title>TypeScript Enum Update</title>
      <description>TOStatus type includes 'closed' value and matches DB schema exactly: draft, submitted, in_transit, received, closed, cancelled</description>
      <verification>No TypeScript compilation errors after update</verification>
    </criterion>
    <criterion id="AC-2">
      <title>UI Component Updates</title>
      <description>Status badge/display components handle 'closed' status with appropriate color (green, matching 'received')</description>
      <verification>Status filter dropdowns include 'closed' option, all TO views display 'closed' correctly</verification>
    </criterion>
    <criterion id="AC-3">
      <title>Unit Tests</title>
      <description>Unit tests verify TOStatus enum includes all 6 values and type system recognizes 'closed'</description>
      <verification>All unit tests passing</verification>
    </criterion>
    <criterion id="AC-4">
      <title>E2E Tests</title>
      <description>E2E tests verify TO with 'closed' status displays in UI, filtering works, badge shows correct color/text</description>
      <verification>All E2E tests passing</verification>
    </criterion>
    <criterion id="AC-5">
      <title>Documentation</title>
      <description>API_REFERENCE.md regenerated, PLANNING_MODULE.md updated with 'closed' status in TO lifecycle</description>
      <verification>Documentation reflects updated enum</verification>
    </criterion>
    <criterion id="AC-6">
      <title>Quality Gates</title>
      <description>All unit and E2E tests passing, no TypeScript errors, no regression in existing TO workflows</description>
      <verification>Full test suite passes</verification>
    </criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/bmm-roadmap-epic-0-p0-fixes.md</path>
        <title>Epic 0 Roadmap - P0 Modules Data Integrity Fixes</title>
        <section>Story 0.2: Fix TO Status enum (MEDIUM)</section>
        <snippet>DB schema allows status='closed' (migrations/019_to_header.sql:9) but TypeScript TOStatus enum does NOT include 'closed' (lib/types.ts:406-411). Impact: UI won't recognize closed TOs, filters won't work.</snippet>
      </doc>
      <doc>
        <path>docs/P0-MODULES-AUDIT-REPORT-2025-11-14.md</path>
        <title>P0 Modules Audit Report</title>
        <section>Problem #2: DB status 'closed' not in TypeScript enum</section>
        <snippet>Tabela to_header ma CHECK constraint ze statusem 'closed', ale TypeScript TOStatus nie zawiera tego statusu. Możliwa niespójność danych jeśli kod SQL ustawia status='closed'.</snippet>
      </doc>
      <doc>
        <path>docs/PLANNING_MODULE.md</path>
        <title>Planning Module Documentation</title>
        <section>Transfer Orders (TO) - Business Rules</section>
        <snippet>Transfer Orders operate at warehouse level, NOT location level. Status lifecycle: draft → submitted → in_transit → received → closed/cancelled.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture Documentation</title>
        <section>Database ↔ TypeScript ↔ UI Consistency (Epic 0 Theme)</section>
        <snippet>Epic 0 addresses critical inconsistencies between DB schema, TypeScript types, API, and UI. Pattern 15 (Story 0.1) established Required Business Context principle.</snippet>
      </doc>
    </docs>

    <code>
      <artifact>
        <path>apps/frontend/lib/types.ts</path>
        <kind>TypeScript Types</kind>
        <symbol>TOStatus</symbol>
        <lines>405-411</lines>
        <reason>Current enum definition missing 'closed' - PRIMARY FILE TO MODIFY. Note: Line 405 comment incorrectly states "no 'closed' status in DB" but DB actually has 'closed' in CHECK constraint.</reason>
      </artifact>
      <artifact>
        <path>apps/frontend/lib/supabase/migrations/019_to_header.sql</path>
        <kind>SQL Migration</kind>
        <symbol>to_header table</symbol>
        <lines>8</lines>
        <reason>Database CHECK constraint defining allowed status values including 'closed': CHECK (status IN ('draft', 'submitted', 'in_transit', 'received', 'closed', 'cancelled'))</reason>
      </artifact>
      <artifact>
        <path>apps/frontend/components/ConditionalBadge.tsx</path>
        <kind>React Component</kind>
        <symbol>ConditionalBadge</symbol>
        <lines>all</lines>
        <reason>Status badge component - likely handles TO status display. Need to verify and add 'closed' status color mapping (should be green like 'received').</reason>
      </artifact>
      <artifact>
        <path>apps/frontend/app/planning/page.tsx</path>
        <kind>Next.js Page</kind>
        <symbol>Planning Page</symbol>
        <lines>all</lines>
        <reason>Main planning page likely contains Transfer Orders tab/section. Need to verify status filter includes 'closed' option.</reason>
      </artifact>
      <artifact>
        <path>apps/frontend/lib/api/transferOrders.ts</path>
        <kind>API Service</kind>
        <symbol>TransferOrdersAPI</symbol>
        <lines>all</lines>
        <reason>Transfer Orders API - verify if any methods reference TOStatus type or handle status transitions.</reason>
      </artifact>
      <artifact>
        <path>apps/frontend/__tests__/transferOrders.test.ts</path>
        <kind>Unit Test</kind>
        <symbol>Transfer Orders Tests</symbol>
        <lines>all</lines>
        <reason>Existing unit tests for Transfer Orders - need to add test verifying TOStatus enum includes 'closed'.</reason>
      </artifact>
      <artifact>
        <path>apps/frontend/e2e/03-transfer-orders.spec.ts</path>
        <kind>E2E Test</kind>
        <symbol>Transfer Orders E2E Tests</symbol>
        <lines>all</lines>
        <reason>Existing E2E tests for TO workflows - need to add tests for 'closed' status display and filtering.</reason>
      </artifact>
    </code>

    <dependencies>
      <ecosystem name="Node.js/pnpm">
        <package name="next" version="^15.5.4" />
        <package name="react" version="^19.0.0" />
        <package name="typescript" version="^5.7.2" />
        <package name="@supabase/supabase-js" version="^2.75.0" />
        <package name="tailwindcss" version="^3.4.17" />
        <package name="vitest" version="^4.0.6" />
        <package name="@playwright/test" version="^1.56.1" />
      </ecosystem>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="database-sync">
      Database schema is authoritative source of truth. TypeScript types must match DB CHECK constraints exactly. Do not invent new status values - only add missing ones from DB.
    </constraint>
    <constraint type="implementation-order">
      Sequential implementation: 1) Type update → 2) UI update → 3) Tests → 4) Documentation. Run `pnpm type-check` after enum update to catch issues early.
    </constraint>
    <constraint type="no-migration-needed">
      Database already supports 'closed' status (migration 019, line 8). This is pure TypeScript/UI synchronization - NO database migration required.
    </constraint>
    <constraint type="testing-coverage">
      Both unit tests (type validation) and E2E tests (UI workflow) required. Follow testing patterns from Story 0.1.
    </constraint>
    <constraint type="color-consistency">
      Status badge color for 'closed' should match 'received' (green) - both represent successful completion states.
    </constraint>
    <constraint type="lifecycle-clarity">
      TO Status Lifecycle: draft → submitted → in_transit → received → closed. Document when/how TOs transition to 'closed' (after inventory reconciled, audit complete).
    </constraint>
    <constraint type="rollback-safety">
      Safe to deploy - additive change only. Enum addition doesn't break existing code. No rollback needed.
    </constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>TOStatus Type</name>
      <kind>TypeScript Type Alias</kind>
      <signature>export type TOStatus = 'draft' | 'submitted' | 'in_transit' | 'received' | 'closed' | 'cancelled';</signature>
      <path>apps/frontend/lib/types.ts</path>
      <usage>Used by TOHeader interface, TransferOrdersAPI, UI components rendering TO status</usage>
    </interface>
    <interface>
      <name>TOHeader Interface</name>
      <kind>TypeScript Interface</kind>
      <signature>interface TOHeader { status: TOStatus; ... }</signature>
      <path>apps/frontend/lib/types.ts</path>
      <usage>Type for Transfer Order header records from to_header table</usage>
    </interface>
    <interface>
      <name>TransferOrdersAPI</name>
      <kind>API Service Class</kind>
      <signature>class TransferOrdersAPI { static async getAll(), getById(), create(), markShipped(), markReceived() }</signature>
      <path>apps/frontend/lib/api/transferOrders.ts</path>
      <usage>API methods for Transfer Order CRUD operations - may need status transition methods</usage>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Testing follows MonoPilot standards: Unit tests (Vitest) for type validation and API logic, E2E tests (Playwright) for user-facing workflows. Tests must cover all acceptance criteria. Follow patterns from Story 0.1: both unit tests (type system) and E2E tests (UI workflow). Run `pnpm test:unit` and `pnpm test:e2e:critical` before committing.
    </standards>

    <locations>
      - Unit tests: apps/frontend/__tests__/transferOrders.test.ts
      - E2E tests: apps/frontend/e2e/03-transfer-orders.spec.ts
      - Test commands: pnpm test:unit, pnpm test:e2e:to, pnpm test:e2e:critical
    </locations>

    <ideas>
      <test ac="AC-1">
        Unit test: Verify TOStatus type includes all 6 values (draft, submitted, in_transit, received, closed, cancelled). Use type assertion or array validation.
      </test>
      <test ac="AC-1">
        Unit test: Verify 'closed' status type-checks correctly in TOHeader interface. No TypeScript compilation errors.
      </test>
      <test ac="AC-2">
        Unit test: If status badge component has color mapping function, verify it returns correct color for 'closed' status.
      </test>
      <test ac="AC-4">
        E2E test: Create test TO with status='closed' in database, navigate to Planning page, verify it displays correctly in TO list.
      </test>
      <test ac="AC-4">
        E2E test: Use status filter dropdown, select 'closed', verify only closed TOs are shown.
      </test>
      <test ac="AC-4">
        E2E test: Verify status badge for 'closed' TO shows correct color (green) and text.
      </test>
      <test ac="AC-6">
        Regression test: Verify existing TO statuses (draft, submitted, etc.) still work correctly after enum update.
      </test>
    </ideas>
  </tests>
</story-context>
