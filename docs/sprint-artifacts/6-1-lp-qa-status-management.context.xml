<story-context id="6-1-lp-qa-status-management" v="1.0">
  <metadata>
    <epicId>6</epicId>
    <storyId>1</storyId>
    <title>LP QA Status Management</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-11-24</generatedAt>
    <template>Custom</template>
    <estimatedTokens>4000</estimatedTokens>
    <estimatedEffort>1 day</estimatedEffort>
  </metadata>

  <story>
    <asA>QC user</asA>
    <iWant>to assign and track QA status on every LP</iWant>
    <soThat>quality state is clear</soThat>
    <tasks>
      <task id="1" ac="AC-6.1.1">QA Status Enum - Define qa_status enum: pending, passed, failed, quarantine</task>
      <task id="2" ac="AC-6.1.2">Status Update Service - updateQAStatus() with validation and audit trail</task>
      <task id="3" ac="AC-6.1.3">Status Change Tracking - Record timestamp and user in qa_status_changes table</task>
      <task id="4" ac="AC-6.1.4">API Route - PUT /api/warehouse/license-plates/:id/qa-status endpoint</task>
      <task id="5" ac="AC-6.1.5">UI Status Badge - Display color-coded QA status badges (green/red/yellow/gray)</task>
      <task id="6" ac="AC-6.1.6">Audit Trail API - GET endpoint for viewing QA status history</task>
      <task id="7" ac="ALL">Unit & Integration Tests - Status update tests, audit trail tests, API tests</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC-6.1.1">Given LP exists, Then has qa_status enum: 'pending' (awaiting inspection), 'passed' (QA approved), 'failed' (QA rejected), 'quarantine' (under investigation)</criterion>
    <criterion id="AC-6.1.2">When QC user changes status, Then status updated And timestamp recorded And user recorded And audit trail entry created in qa_status_changes table</criterion>
    <criterion id="AC-6.1.3">Audit trail record includes: lp_id, old_status, new_status, changed_at (timestamp), changed_by (user_id), reason (optional text)</criterion>
    <criterion id="AC-6.1.4">API: PUT /api/warehouse/license-plates/:id/qa-status - Request body: { qa_status: 'pending'|'passed'|'failed'|'quarantine', reason?: string } - Response: { data: LicensePlate } or error 400</criterion>
    <criterion id="AC-6.1.5">UI displays QA status with color-coded badges: pending (yellow), passed (green), failed (red), quarantine (gray/orange)</criterion>
    <criterion id="AC-6.1.6">QA status change history available via API: GET /api/warehouse/license-plates/:id/qa-history - Response: { data: QAStatusChange[] } with full audit trail</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/epics/epic-6-quality.md</path>
        <title>Epic 6: Quality Control & Compliance</title>
        <section>Story 6.1: LP QA Status Management</section>
        <snippet>Assign and track QA status on every LP: pending, passed, failed, quarantine. Record timestamp and user on status changes. Audit trail in qa_status_changes table. Prerequisites: Epic 5 (LP).</snippet>
      </doc>
      <doc>
        <path>docs/architecture/patterns/api.md</path>
        <title>API Architecture</title>
        <section>Error Handling</section>
        <snippet>Structured error responses with type, title, status, detail. APIError class with toProblemDetails() method.</snippet>
      </doc>
    </docs>

    <code>
      <artifact>
        <path>app/api/warehouse/license-plates/[id]/qa-status</path>
        <kind>directory</kind>
        <symbol>QA Status Update API route location</symbol>
        <reason>Story requires creating route.ts for PUT /api/warehouse/license-plates/:id/qa-status endpoint</reason>
      </artifact>
      <artifact>
        <path>app/api/warehouse/license-plates/[id]/qa-history</path>
        <kind>directory</kind>
        <symbol>QA History API route location</symbol>
        <reason>Story requires GET endpoint for viewing QA status history</reason>
      </artifact>
      <artifact>
        <path>lib/services/license-plate-service.ts</path>
        <kind>file</kind>
        <symbol>License Plate service</symbol>
        <reason>Story requires updateQAStatus() method with validation and audit trail recording</reason>
      </artifact>
      <artifact>
        <path>lib/validation/qa-schemas.ts</path>
        <kind>file</kind>
        <symbol>QA Zod schemas</symbol>
        <reason>Story requires updateQAStatusSchema for validating QA status change requests</reason>
      </artifact>
      <artifact>
        <path>components/warehouse/QAStatusBadge.tsx</path>
        <kind>component</kind>
        <symbol>QAStatusBadge</symbol>
        <reason>Story requires QA status badge component with color coding (green/red/yellow/gray)</reason>
      </artifact>
      <artifact>
        <path>lib/types/qa-status.ts</path>
        <kind>file</kind>
        <symbol>QA status types</symbol>
        <reason>Story requires QAStatus enum type definition</reason>
      </artifact>
    </code>

    <dependencies>
      <node>
        <package name="@supabase/supabase-js" version="^2.84.0" usage="Supabase client for QA status updates and audit trail recording" />
        <package name="zod" version="^3.25.76" usage="Validation schemas for QA status change requests" />
        <package name="next" version="^15.1.4" usage="Next.js framework with App Router for API routes" />
        <package name="react" version="^19.0.0" usage="React 19 for UI components (QA status badge)" />
        <package name="clsx" version="^2.1.1" usage="Utility for conditional className construction for status badges" />
      </node>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="business">QA Status enum - pending, passed, failed, quarantine (4 states)</constraint>
    <constraint type="business">Audit trail - record ALL QA status changes in qa_status_changes table with timestamp, user, reason</constraint>
    <constraint type="business">Multi-tenancy - all QA operations scoped by org_id</constraint>
    <constraint type="validation">Zod validation - qa_status must be valid enum value</constraint>
    <constraint type="ux">Color coding - pending (yellow), passed (green), failed (red), quarantine (gray/orange)</constraint>
    <constraint type="testing">Test pyramid - 95% unit coverage for QA status updates, 70% integration coverage, 100% E2E coverage</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>PUT /api/warehouse/license-plates/:id/qa-status</name>
      <kind>API route</kind>
      <signature>PUT /api/warehouse/license-plates/{lp_id}/qa-status - Request body: { qa_status: 'pending'|'passed'|'failed'|'quarantine', reason?: string } - Response: { data: LicensePlate } or error 400</signature>
      <path>app/api/warehouse/license-plates/[id]/qa-status/route.ts</path>
    </interface>
    <interface>
      <name>GET /api/warehouse/license-plates/:id/qa-history</name>
      <kind>API route</kind>
      <signature>GET /api/warehouse/license-plates/{lp_id}/qa-history - Response: { data: QAStatusChange[] } - Returns full audit trail of QA status changes for LP</signature>
      <path>app/api/warehouse/license-plates/[id]/qa-history/route.ts</path>
    </interface>
    <interface>
      <name>updateQAStatus</name>
      <kind>service function</kind>
      <signature>async function updateQAStatus(lpId: string, newStatus: QAStatus, reason?: string): Promise&lt;ServiceResult&lt;LicensePlate&gt;&gt; - Updates QA status, records audit trail</signature>
      <path>lib/services/license-plate-service.ts</path>
    </interface>
    <interface>
      <name>QAStatusBadge</name>
      <kind>React component</kind>
      <signature>QAStatusBadge: FC&lt;{ status: QAStatus }&gt; - Displays color-coded QA status badge with icon</signature>
      <path>components/warehouse/QAStatusBadge.tsx</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Testing strategy follows Test Pyramid: unit tests for QA status update logic (95% coverage), integration tests for API route (70% coverage), E2E tests for QA status change flow (100% user flows). Mock Supabase in unit tests.
    </standards>
    <locations>
      <location>lib/services/__tests__/license-plate-service.test.ts (updateQAStatus unit tests)</location>
      <location>app/api/warehouse/license-plates/[id]/qa-status/__tests__/route.test.ts (API route integration tests)</location>
      <location>e2e/quality/qa-status-change.e2e.ts (QA status change flow E2E tests)</location>
    </locations>
    <ideas>
      <idea ac="AC-6.1.2">Unit test: updateQAStatus() with valid status - updates LP, creates audit trail record</idea>
      <idea ac="AC-6.1.1">Unit test: updateQAStatus() with invalid status - returns error "Invalid QA status"</idea>
      <idea ac="AC-6.1.3">Unit test: Audit trail record includes all fields: old_status, new_status, changed_at, changed_by, reason</idea>
      <idea ac="AC-6.1.4">Integration test: PUT /qa-status with valid status - returns 200 with updated LP</idea>
      <idea ac="AC-6.1.4">Integration test: PUT /qa-status with invalid status - returns 400 error</idea>
      <idea ac="AC-6.1.6">Integration test: GET /qa-history - returns audit trail for LP</idea>
      <idea ac="AC-6.1.5">E2E test: LP detail page displays QA status badge with correct color</idea>
      <idea ac="AC-6.1.2">E2E test: Change QA status from modal, audit trail updated</idea>
    </ideas>
  </tests>
</story-context>
