<?xml version="1.0" encoding="UTF-8"?>
<story-context>
  <metadata>
    <story_key>npd-6-2-create-supporting-npd-tables</story_key>
    <epic_id>NPD-6</epic_id>
    <story_id>6.2</story_id>
    <title>Create Supporting NPD Tables</title>
    <generated>2025-11-16</generated>
  </metadata>

  <user_story>
    <as_a>database administrator</as_a>
    <i_want>supporting tables for costing, risks, documents, and events</i_want>
    <so_that>NPD application can track compliance, events, and analytics</so_that>
  </user_story>

  <acceptance_criteria>
    <criterion id="AC-1">
      <given>core NPD tables exist (Story 6.1 complete)</given>
      <when>migration 101 executes</when>
      <then>4 supporting tables created: npd_costing, npd_risks, npd_documents, npd_events</then>
      <details>
        - npd_costing: id, npd_project_id, target_cost, estimated_cost, actual_cost, variance_pct GENERATED ALWAYS AS, currency, notes, created_at, updated_at
        - npd_risks: id, npd_project_id, risk_description, likelihood, impact, risk_score GENERATED ALWAYS AS, mitigation_plan, status, created_at, updated_at
        - npd_documents: id, org_id, npd_project_id, file_name, file_type, file_path, version, file_size, mime_type, uploaded_by, uploaded_at
        - npd_events: id, org_id, type, payload JSONB, status, retry_count, error_message, sequence_number BIGSERIAL, created_at, processed_at
      </details>
    </criterion>
    <criterion id="AC-2">
      <description>Computed columns defined</description>
      <details>
        - npd_costing.variance_pct: ((actual_cost - target_cost) / NULLIF(target_cost, 0) * 100) STORED
        - npd_risks.risk_score: (CASE likelihood WHEN 'high' THEN 3 WHEN 'medium' THEN 2 ELSE 1 END * CASE impact WHEN 'high' THEN 3 WHEN 'medium' THEN 2 ELSE 1 END) STORED
      </details>
    </criterion>
    <criterion id="AC-3">
      <description>Foreign keys configured</description>
      <details>
        - npd_costing.npd_project_id → npd_projects.id (CASCADE)
        - npd_risks.npd_project_id → npd_projects.id (CASCADE)
        - npd_documents.npd_project_id → npd_projects.id (CASCADE)
      </details>
    </criterion>
    <criterion id="AC-4">
      <description>Event status enum: pending, processing, completed, failed</description>
    </criterion>
  </acceptance_criteria>

  <tasks>
    <task id="T-1">Create migration file 101_create_npd_supporting_tables.sql</task>
    <task id="T-2">Define npd_costing table with GENERATED ALWAYS AS variance_pct column</task>
    <task id="T-3">Define npd_risks table with GENERATED ALWAYS AS risk_score column</task>
    <task id="T-4">Define npd_documents table with Supabase Storage path format</task>
    <task id="T-5">Define npd_events table with JSONB payload and BIGSERIAL sequence_number</task>
    <task id="T-6">Create foreign keys with CASCADE rules</task>
    <task id="T-7">Create CHECK constraint for event status enum</task>
    <task id="T-8">Run pnpm gen-types to generate TypeScript types</task>
    <task id="T-9">Run pnpm docs:update to update DATABASE_SCHEMA.md</task>
  </tasks>

  <artifacts>
    <docs>
      <doc>
        <path>docs/NPD-Module-Epics.md</path>
        <title>NPD Module Epic Breakdown</title>
        <section>Story NPD-6.2</section>
        <snippet>Supporting tables for costing (target/estimated/actual with variance), risks (likelihood×impact matrix), documents (Supabase Storage metadata), events (outbox pattern for event sourcing).</snippet>
      </doc>
      <doc>
        <path>docs/NPD-Module-Architecture-2025-11-15.md</path>
        <title>NPD Module Architecture</title>
        <section>ADR-002: Event Sourcing for Handoff</section>
        <snippet>Outbox pattern with npd_events table, pg_notify triggers, Edge Function processor with retry logic. Ensures transactional integrity for handoff workflow.</snippet>
      </doc>
    </docs>

    <code>
      <artifact>
        <path>apps/frontend/lib/supabase/migrations/025_license_plates.sql</path>
        <kind>migration</kind>
        <symbol>License Plates table</symbol>
        <reason>Example of GENERATED ALWAYS AS computed columns in MonoPilot</reason>
      </artifact>
    </code>

    <dependencies>
      <database>
        <package>PostgreSQL</package>
        <version>15+</version>
        <note>GENERATED ALWAYS AS STORED columns, JSONB, BIGSERIAL</note>
      </database>
    </dependencies>
  </artifacts>

  <interfaces>
    <interface>
      <name>npd_projects table</name>
      <kind>database-table</kind>
      <signature>Created in Story 6.1 - referenced by all supporting tables</signature>
      <path>Migration 100</path>
    </interface>
  </interfaces>

  <constraints>
    <constraint>Use sequential migration numbering: 101_create_npd_supporting_tables.sql</constraint>
    <constraint>GENERATED ALWAYS AS columns auto-calculate on INSERT/UPDATE</constraint>
    <constraint>JSONB payload for events enables flexible event schemas</constraint>
    <constraint>sequence_number ensures event ordering (critical for event sourcing)</constraint>
    <constraint>file_path format: npd/{org_id}/{project_id}/{file_type}/{file_name}</constraint>
  </constraints>

  <tests>
    <standards>
      Database migrations tested via staging deployment. Computed columns validated by INSERT operations.
    </standards>
    <locations>
      - Migrations tested via staging Supabase deployment
    </locations>
    <ideas>
      <idea criterion="AC-1">Verify migration 101 creates 4 supporting tables</idea>
      <idea criterion="AC-2">Test variance_pct auto-calculates: target=100, actual=120 → variance_pct=20</idea>
      <idea criterion="AC-2">Test risk_score auto-calculates: likelihood=high, impact=medium → risk_score=6</idea>
      <idea criterion="AC-3">Verify foreign keys CASCADE behavior (delete project → cascades to costing/risks/documents)</idea>
      <idea criterion="AC-4">Test event status CHECK constraint allows only: pending, processing, completed, failed</idea>
      <idea>Test JSONB payload accepts flexible event schemas</idea>
      <idea>Verify sequence_number increments automatically</idea>
    </ideas>
  </tests>

  <technical_notes>
    <note>GENERATED ALWAYS AS columns cannot be manually set - PostgreSQL calculates them</note>
    <note>BIGSERIAL for sequence_number ensures strict ordering for event replay</note>
    <note>npd_events table is foundation for Epic NPD-3 Story 6 (Event Sourcing)</note>
  </technical_notes>

  <prerequisites>
    <prerequisite>Story 6.1 (npd_projects table must exist for foreign keys)</prerequisite>
  </prerequisites>
</story-context>
