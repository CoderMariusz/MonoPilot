<?xml version="1.0" encoding="UTF-8"?>
<story-context>
  <metadata>
    <story_key>npd-6-5-create-temporal-versioning-constraints</story_key>
    <epic_id>NPD-6</epic_id>
    <story_id>6.5</story_id>
    <title>Create Temporal Versioning Constraints & Triggers</title>
    <generated>2025-11-16</generated>
  </metadata>

  <user_story>
    <as_a>database administrator</as_a>
    <i_want>EXCLUDE constraints and triggers for formulation versioning</i_want>
    <so_that>overlapping effective dates are prevented and version history is immutable</so_that>
  </user_story>

  <acceptance_criteria>
    <criterion id="AC-1">
      <given>npd_formulations table exists (Story 6.1 complete)</given>
      <when>migration 104 executes</when>
      <then>EXCLUDE constraint prevents overlapping effective dates</then>
      <example>ALTER TABLE npd_formulations ADD CONSTRAINT npd_formulations_no_overlap EXCLUDE USING gist (npd_project_id WITH =, tstzrange(effective_from, effective_to, '[)') WITH &&) WHERE (status != 'superseded');</example>
    </criterion>
    <criterion id="AC-2">
      <description>Trigger prevents editing locked formulations</description>
      <example>CREATE TRIGGER npd_formulation_immutable_on_lock BEFORE UPDATE ON npd_formulations FOR EACH ROW WHEN (OLD.locked_at IS NOT NULL) EXECUTE FUNCTION prevent_locked_formulation_edit();</example>
    </criterion>
    <criterion id="AC-3">
      <description>Trigger function blocks edits to locked formulations</description>
      <example>CREATE FUNCTION prevent_locked_formulation_edit() RETURNS TRIGGER - raises exception if locked_at IS NOT NULL</example>
    </criterion>
    <criterion id="AC-4">
      <description>Computed column for current version</description>
      <example>ADD COLUMN is_current_version BOOLEAN GENERATED ALWAYS AS (effective_to IS NULL AND status = 'approved') STORED;</example>
    </criterion>
    <criterion id="AC-5">
      <description>Index for current version queries</description>
      <details>idx_npd_formulations_current (WHERE is_current_version = TRUE)</details>
    </criterion>
  </acceptance_criteria>

  <tasks>
    <task id="T-1">Create migration file 104_create_npd_temporal_versioning.sql</task>
    <task id="T-2">Create EXCLUDE constraint using gist index + tstzrange</task>
    <task id="T-3">Create prevent_locked_formulation_edit() function</task>
    <task id="T-4">Create BEFORE UPDATE trigger on npd_formulations</task>
    <task id="T-5">Add is_current_version GENERATED ALWAYS AS column</task>
    <task id="T-6">Create partial index for current versions</task>
    <task id="T-7">Test: Attempt to create overlapping versions → expect constraint violation</task>
    <task id="T-8">Test: Attempt to edit locked formulation → expect trigger exception</task>
    <task id="T-9">Run pnpm gen-types to update TypeScript types</task>
  </tasks>

  <artifacts>
    <docs>
      <doc>
        <path>docs/NPD-Module-Architecture-2025-11-15.md</path>
        <title>NPD Module Architecture</title>
        <section>ADR-004: Temporal Versioning Service (Novel Pattern #1)</section>
        <snippet>EXCLUDE constraints with tstzrange prevent overlapping formulation versions. Immutability triggers ensure compliance (FDA 21 CFR Part 11). PostgreSQL 15+ required.</snippet>
      </doc>
      <doc>
        <path>docs/MonoPilot-NPD-Module-PRD-2025-11-15.md</path>
        <title>NPD Module PRD</title>
        <section>FR11-FR13: Formulation Versioning</section>
        <snippet>Set effective dates (effective_from/to) with overlap detection, prevent overlapping versions via database trigger, lock formulation on approval (draft → approved → immutable).</snippet>
      </doc>
    </docs>

    <code>
      <artifact>
        <path>apps/frontend/lib/supabase/migrations</path>
        <kind>directory</kind>
        <symbol>PostgreSQL functions and triggers</symbol>
        <reason>Examples of trigger patterns in MonoPilot</reason>
      </artifact>
    </code>

    <dependencies>
      <database>
        <package>PostgreSQL</package>
        <version>15+</version>
        <note>EXCLUDE constraint requires gist index + tstzrange (not available in PostgreSQL 14)</note>
      </database>
    </dependencies>
  </artifacts>

  <interfaces>
    <interface>
      <name>npd_formulations table</name>
      <kind>database-table</kind>
      <signature>Created in Story 6.1 - modified here to add versioning constraints</signature>
      <path>Migration 100</path>
    </interface>
  </interfaces>

  <constraints>
    <constraint>Use sequential migration numbering: 104_create_npd_temporal_versioning.sql</constraint>
    <constraint>EXCLUDE constraint uses gist index + tstzrange (PostgreSQL 15+ required)</constraint>
    <constraint>Immutability trigger = compliance (FDA 21 CFR Part 11 electronic records)</constraint>
    <constraint>Document in Architecture: Decision 4 (Temporal Versioning Service - Novel Pattern #1)</constraint>
  </constraints>

  <tests>
    <standards>
      Constraint violations tested by attempting to create overlapping versions. Trigger tested by attempting to edit locked formulations.
    </standards>
    <locations>
      - Migrations tested via staging Supabase deployment
      - apps/frontend/e2e/ (E2E tests for formulation versioning)
    </locations>
    <ideas>
      <idea criterion="AC-1">Test: Create formulation v1.0 (2025-01-01 to 2025-06-30), attempt v1.1 (2025-06-01 to NULL) → expect overlap error</idea>
      <idea criterion="AC-2">Test: Lock formulation (set locked_at), attempt UPDATE → expect trigger exception</idea>
      <idea criterion="AC-3">Verify trigger function raises exception with formulation version and locked_at timestamp</idea>
      <idea criterion="AC-4">Test: formulation with effective_to=NULL and status='approved' → is_current_version=TRUE</idea>
      <idea criterion="AC-5">Verify partial index exists and is used for current version queries</idea>
    </ideas>
  </tests>

  <technical_notes>
    <note>tstzrange '[)' notation = inclusive start, exclusive end (half-open interval)</note>
    <note>EXCLUDE constraint fires BEFORE INSERT/UPDATE - prevents invalid data</note>
    <note>Immutability trigger ensures compliance - once locked, formulation cannot be changed</note>
    <note>This enables FR12 (Prevent overlapping versions) and FR13 (Lock on approval)</note>
  </technical_notes>

  <prerequisites>
    <prerequisite>Story 6.1 (npd_formulations table must exist)</prerequisite>
  </prerequisites>
</story-context>
