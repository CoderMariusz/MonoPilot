<?xml version="1.0" encoding="UTF-8"?>
<story-context>
  <metadata>
    <story_key>npd-6-6-setup-edge-functions-cicd</story_key>
    <epic_id>NPD-6</epic_id>
    <story_id>6.6</story_id>
    <title>Setup Edge Functions CI/CD Pipeline (Prerequisite)</title>
    <generated>2025-11-16</generated>
  </metadata>

  <user_story>
    <as_a>DevOps engineer</as_a>
    <i_want>Edge Functions CI/CD pipeline configured</i_want>
    <so_that>Epic NPD-1 can deploy NPD event processor without manual setup</so_that>
  </user_story>

  <acceptance_criteria>
    <criterion id="AC-1">
      <description>Supabase CLI installation in CI environment</description>
      <details>
        - Supabase CLI installed in GitHub Actions runner
        - CLI version verified: >= 1.50.0
        - Installation documented in .github/workflows/deploy-edge-functions.yml
      </details>
    </criterion>
    <criterion id="AC-2">
      <description>Authentication configuration</description>
      <details>
        - SUPABASE_ACCESS_TOKEN secret configured in GitHub repository settings
        - SUPABASE_PROJECT_ID environment variable set
        - Authentication tested: supabase login succeeds in CI
      </details>
    </criterion>
    <criterion id="AC-3">
      <description>Edge Function deployment script</description>
      <details>
        - Deployment script created: scripts/deploy-edge-function.sh
        - Script validates Edge Function exists before deploying
        - Script handles deployment errors gracefully (exit codes)
        - Script outputs deployment URL for verification
      </details>
    </criterion>
    <criterion id="AC-4">
      <description>CI/CD Workflow integration</description>
      <details>
        - GitHub Actions workflow created: .github/workflows/deploy-edge-functions.yml
        - Workflow triggers on: push to main branch, manual trigger (workflow_dispatch)
        - Workflow runs scripts/deploy-edge-function.sh
        - Workflow reports deployment status (success/failure)
      </details>
    </criterion>
    <criterion id="AC-5">
      <description>Staging environment testing</description>
      <details>
        - Edge Function deployed successfully to staging Supabase project
        - Function responds to HTTP requests (even if auth required)
        - Function logs visible in Supabase Dashboard
        - Deployment takes <2 minutes
      </details>
    </criterion>
    <criterion id="AC-6">
      <description>Documentation updates</description>
      <details>
        - Deployment process documented in docs/13_DATABASE_MIGRATIONS.md
        - Edge Function deployment added to runbook
        - Rollback procedure documented (redeploy previous version)
        - Troubleshooting section added (common errors)
      </details>
    </criterion>
  </acceptance_criteria>

  <tasks>
    <task id="T-1">Create scripts/deploy-edge-function.sh with validation and error handling</task>
    <task id="T-2">Create .github/workflows/deploy-edge-functions.yml workflow</task>
    <task id="T-3">Configure SUPABASE_ACCESS_TOKEN secret in GitHub repository</task>
    <task id="T-4">Configure SUPABASE_PROJECT_ID environment variable</task>
    <task id="T-5">Test deployment to staging Supabase project</task>
    <task id="T-6">Verify Edge Function responds to HTTP requests</task>
    <task id="T-7">Document deployment process in docs/13_DATABASE_MIGRATIONS.md</task>
    <task id="T-8">Document rollback procedure</task>
    <task id="T-9">Add troubleshooting section for common errors</task>
  </tasks>

  <artifacts>
    <docs>
      <doc>
        <path>docs/sprint-artifacts/NPD-6-prerequisite-edge-functions-setup.md</path>
        <title>NPD-6 Prerequisite: Edge Functions Deployment Pipeline</title>
        <section>Full Story Specification</section>
        <snippet>Detailed specification created during Solutioning Gate Check Condition 2. Includes script templates, workflow YAML, verification steps, rollback procedures.</snippet>
      </doc>
      <doc>
        <path>docs/NPD-Module-Architecture-2025-11-15.md</path>
        <title>NPD Module Architecture</title>
        <section>ADR-002: Event Sourcing for Handoff</section>
        <snippet>Edge Function (npd-event-processor) processes events from npd_events table with retry logic. Deployed via CI/CD pipeline.</snippet>
      </doc>
    </docs>

    <code>
      <artifact>
        <path>.github/workflows</path>
        <kind>directory</kind>
        <symbol>GitHub Actions workflows</symbol>
        <reason>Examples of CI/CD workflow patterns in MonoPilot</reason>
      </artifact>
      <artifact>
        <path>scripts</path>
        <kind>directory</kind>
        <symbol>Deployment scripts</symbol>
        <reason>Location for deployment automation scripts</reason>
      </artifact>
    </code>

    <dependencies>
      <cicd>
        <package>Supabase CLI</package>
        <version>>=1.50.0</version>
        <note>Installed via GitHub Actions: uses: supabase/setup-cli@v1</note>
      </cicd>
      <cicd>
        <package>GitHub Actions</package>
        <note>CI/CD platform for automated deployments</note>
      </cicd>
    </dependencies>
  </artifacts>

  <interfaces>
    <interface>
      <name>npd_events table</name>
      <kind>database-table</kind>
      <signature>Created in Story 6.2 - Edge Function consumes events from this table</signature>
      <path>Migration 101</path>
    </interface>
    <interface>
      <name>Supabase Edge Functions runtime</name>
      <kind>platform</kind>
      <signature>Deno runtime for serverless functions</signature>
      <note>Edge Function code will be created in Epic NPD-1 Story 4 (Event Sourcing Implementation)</note>
    </interface>
  </interfaces>

  <constraints>
    <constraint>Edge Function code will be created in Epic NPD-1 Story 4 - this story only sets up deployment infrastructure</constraint>
    <constraint>Deployment triggers on push to main branch (after migrations run)</constraint>
    <constraint>Deployment order: Migrations (100-113) â†’ Edge Function deployment</constraint>
    <constraint>Supabase keeps previous versions for 7 days (rollback capability)</constraint>
  </constraints>

  <tests>
    <standards>
      CI/CD workflows tested by triggering manual deployment. Edge Function tested by HTTP request.
    </standards>
    <locations>
      - .github/workflows/deploy-edge-functions.yml (workflow definition)
      - scripts/deploy-edge-function.sh (deployment script)
    </locations>
    <ideas>
      <idea criterion="AC-1">Test: Run workflow, verify Supabase CLI version >= 1.50.0</idea>
      <idea criterion="AC-2">Test: Workflow authenticates successfully with SUPABASE_ACCESS_TOKEN</idea>
      <idea criterion="AC-3">Test: Script exits with error if function directory missing</idea>
      <idea criterion="AC-4">Test: Workflow triggers on push to main, manual trigger</idea>
      <idea criterion="AC-5">Test: curl Edge Function URL, verify HTTP response (200 or 401)</idea>
      <idea criterion="AC-6">Verify documentation includes deployment, rollback, troubleshooting</idea>
    </ideas>
  </tests>

  <technical_notes>
    <note>This is a prerequisite for Epic NPD-1 Story 4 (Event Sourcing Implementation)</note>
    <note>Edge Function location: apps/frontend/supabase/functions/npd-event-processor/</note>
    <note>Deployment time: <2 minutes (cold start latency <500ms, warm latency <100ms)</note>
    <note>Security: JWT verification initially disabled (--no-verify-jwt) for development, enable in production</note>
    <note>Estimated effort: 4 hours</note>
  </technical_notes>

  <prerequisites>
    <prerequisite>Story 6.2 complete (npd_events table exists for Edge Function to consume)</prerequisite>
  </prerequisites>
</story-context>
