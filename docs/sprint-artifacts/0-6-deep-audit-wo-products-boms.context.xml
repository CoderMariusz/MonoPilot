<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>0</epicId>
    <storyId>6</storyId>
    <title>Deep Audit - Work Orders, Products, BOMs (VERIFICATION)</title>
    <status>drafted</status>
    <generatedAt>2025-11-14</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/0-6-deep-audit-wo-products-boms.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>Development Team / System Architect</asA>
    <iWant>a comprehensive audit of remaining P0 modules (Work Orders, Products, BOMs) to identify any DB ↔ TypeScript ↔ API ↔ UI inconsistencies</iWant>
    <soThat>all data integrity issues are discovered and documented before starting Phase 1 development</soThat>
    <tasks>
      - Audit Preparation (3h): Create checklist, define methodology
      - Database Schema Audit (6h): Extract schemas for all WO/Product/BOM tables
      - TypeScript Type Audit (4h): Extract all interfaces, compare with DB
      - API Contract Audit (5h): Inventory all API methods, verify signatures
      - UI Component Audit (4h): Find all components rendering audited data
      - Inconsistency Report (3h): Compile findings, categorize by severity
      - Create Fix Stories (3h): Draft new stories for CRITICAL findings
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC-1">
      <title>Audit Scope Definition</title>
      <description>Checklist created, methodology documented, 8 target tables identified</description>
    </criterion>
    <criterion id="AC-2">
      <title>Database Schema Analysis</title>
      <description>All CHECK constraints extracted, foreign keys verified</description>
    </criterion>
    <criterion id="AC-3">
      <title>TypeScript Type Analysis</title>
      <description>All interfaces compared with DB, enum mismatches identified</description>
    </criterion>
    <criterion id="AC-4">
      <title>API Contract Analysis</title>
      <description>All API methods inventoried, signatures verified</description>
    </criterion>
    <criterion id="AC-5">
      <title>UI Component Analysis</title>
      <description>All components inventoried, hardcoded values found</description>
    </criterion>
    <criterion id="AC-6">
      <title>Inconsistency Report</title>
      <description>Detailed report with location, impact, proposed fix for each finding</description>
    </criterion>
    <criterion id="AC-7">
      <title>Fix Stories Created</title>
      <description>New stories created for CRITICAL findings, backlog items for MEDIUM</description>
    </criterion>
    <criterion id="AC-8">
      <title>Quality Gates</title>
      <description>Audit report reviewed, all findings documented</description>
    </criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/bmm-roadmap-epic-0-p0-fixes.md</path>
        <title>Epic 0 Roadmap</title>
        <section>Story 0.6 Summary</section>
        <snippet>Comprehensive audit of remaining P0 modules. Compare DB schema vs TypeScript vs API vs UI. Fix additional inconsistencies found. Focus: work_orders, products, boms, bom_items, wo_materials, wo_by_products.</snippet>
      </doc>
      <doc>
        <path>docs/P0-MODULES-AUDIT-REPORT-2025-11-14.md</path>
        <title>P0 Audit Report (Template)</title>
        <section>All Problems</section>
        <snippet>Template for audit methodology and report structure. Stories 0.1-0.5 already addressed 5 problems. Story 0.6 looks for more.</snippet>
      </doc>
    </docs>

    <code>
      <artifact>
        <path>apps/frontend/lib/supabase/migrations/</path>
        <kind>SQL Migrations</kind>
        <symbol>work_orders, products, boms, bom_items, wo_materials, wo_operations, wo_by_products, routings tables</symbol>
        <lines>all</lines>
        <reason>Audit all CREATE TABLE statements, CHECK constraints, ENUM types for these 8 tables</reason>
      </artifact>
      <artifact>
        <path>apps/frontend/lib/types.ts</path>
        <kind>TypeScript Types</kind>
        <symbol>WorkOrder, Product, BOM, BOMItem, WOMaterial, WOOperation, WOByProduct, Routing interfaces</symbol>
        <lines>all</lines>
        <reason>Extract all interfaces/types for audited tables, compare with DB schema</reason>
      </artifact>
      <artifact>
        <path>apps/frontend/lib/api/workOrders.ts</path>
        <kind>API Service</kind>
        <symbol>WorkOrdersAPI</symbol>
        <lines>all</lines>
        <reason>Inventory all methods, verify signatures match types, check RPC functions</reason>
      </artifact>
      <artifact>
        <path>apps/frontend/lib/api/products.ts</path>
        <kind>API Service</kind>
        <symbol>ProductsAPI</symbol>
        <lines>all</lines>
        <reason>Inventory all methods, verify signatures</reason>
      </artifact>
      <artifact>
        <path>apps/frontend/lib/api/boms.ts</path>
        <kind>API Service</kind>
        <symbol>BomsAPI</symbol>
        <lines>all</lines>
        <reason>Inventory all methods, verify signatures</reason>
      </artifact>
    </code>

    <dependencies>
      <ecosystem name="Node.js/pnpm">
        <package name="typescript" version="^5.7.2" />
      </ecosystem>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="systematic-approach">
      Follow Stories 0.1-0.5 audit methodology: DB → TS → API → UI. Use grep for comprehensive searches. Document findings in structured format.
    </constraint>
    <constraint type="expected-findings">
      Based on Stories 0.1-0.5 patterns, expect: (1) Status enum mismatches, (2) Case inconsistencies, (3) Missing DB columns, (4) Orphaned TS types.
    </constraint>
    <constraint type="prioritization">
      Categorize ALL findings by severity: CRITICAL (breaks workflow), MEDIUM (inconsistency but works), LOW (cosmetic). Only create stories for CRITICAL/MEDIUM.
    </constraint>
    <constraint type="no-assumptions">
      Do NOT assume modules are correct. Audit EVERYTHING systematically. Prior stories found critical issues in "working" modules.
    </constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>Audit Report Template</name>
      <kind>Markdown Document</kind>
      <signature>Per-finding: Location, DB Schema, TypeScript State, Impact, Proposed Fix, Priority</signature>
      <path>docs/audits/deep-audit-wo-products-boms-2025-11-14.md (NEW)</path>
      <usage>Structured report documenting all audit findings</usage>
    </interface>
  </interfaces>

  <tests>
    <standards>
      This is an audit/discovery story, not implementation. No new tests required. Output is audit report and new story files for findings.
    </standards>

    <locations>
      - No new tests (audit story)
      - Output: Audit report in docs/audits/
    </locations>

    <ideas>
      <test ac="none">
        This story produces documentation and new story files, not code changes.
      </test>
    </ideas>
  </tests>
</story-context>
