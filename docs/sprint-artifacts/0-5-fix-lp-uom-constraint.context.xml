<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>0</epicId>
    <storyId>5</storyId>
    <title>Fix License Plate UoM Constraint (MEDIUM)</title>
    <status>drafted</status>
    <generatedAt>2025-11-14</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/0-5-fix-lp-uom-constraint.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>Product Manager / Warehouse Manager</asA>
    <iWant>License Plates to support additional units of measure beyond the current 4 limited options</iWant>
    <soThat>products using units like GALLON, POUND, BOX, PALLET, CASE, DRUM can be tracked in the system</soThat>
    <tasks>
      - Architectural Decision (2h): Evaluate options (remove CHECK vs master table), document decision
      - Database Migration (4h): Create uom_master table, INSERT standard units, ADD FK constraint
      - TypeScript Update (1.5h): Update UoM type definition
      - API Updates (2h): Add UoM validation, create API to fetch valid UoMs
      - UI Updates (3h): Update LP creation form dropdown to fetch UoMs from DB
      - Tests (2h): Unit + E2E tests for new UoMs
      - Documentation (1.5h): Document UoM strategy (Pattern 17), update warehouse docs
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC-1">
      <title>Architectural Decision</title>
      <description>Decision documented: UoM master table (recommended) vs remove CHECK constraint</description>
    </criterion>
    <criterion id="AC-2">
      <title>Database Migration</title>
      <description>Create uom_master table with ~20 standard units (weight, volume, length, count, container categories)</description>
    </criterion>
    <criterion id="AC-3">
      <title>TypeScript Type Update</title>
      <description>UoM type updated to match DB (enum or string based on architecture decision)</description>
    </criterion>
    <criterion id="AC-4">
      <title>API Validation</title>
      <description>LP creation validates UoM, API provides list of valid UoMs</description>
    </criterion>
    <criterion id="AC-5">
      <title>UI Updates</title>
      <description>UoM dropdown shows all supported units, fetches from DB</description>
    </criterion>
    <criterion id="AC-6">
      <title>Testing</title>
      <description>Tests verify UoM validation, LP creation with new units (GALLON, PALLET, etc.)</description>
    </criterion>
    <criterion id="AC-7">
      <title>Documentation</title>
      <description>Architecture.md documents UoM strategy (Pattern 17), warehouse docs updated</description>
    </criterion>
    <criterion id="AC-8">
      <title>Quality Gates</title>
      <description>All tests passing, no TS errors, no regression</description>
    </criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/bmm-roadmap-epic-0-p0-fixes.md</path>
        <title>Epic 0 Roadmap</title>
        <section>Story 0.5 Summary</section>
        <snippet>Decision: Remove CHECK constraint OR create UoM master table. Allow more units: GALLON, POUND, BOX, PALLET, CASE, DRUM. Update UI dropdown.</snippet>
      </doc>
      <doc>
        <path>docs/P0-MODULES-AUDIT-REPORT-2025-11-14.md</path>
        <title>P0 Audit Report</title>
        <section>Problem #5: LP UoM constraint too restrictive</section>
        <snippet>DB CHECK limits uom to only 4 values: KG, EACH, METER, LITER. Cannot create LPs for products using GALLON, POUND, BOX, PALLET.</snippet>
      </doc>
    </docs>

    <code>
      <artifact>
        <path>apps/frontend/lib/supabase/migrations/025_license_plates.sql</path>
        <kind>SQL Migration</kind>
        <symbol>uom CHECK constraint</symbol>
        <lines>10</lines>
        <reason>Current restrictive CHECK constraint - will be replaced with FK to uom_master table</reason>
      </artifact>
      <artifact>
        <path>apps/frontend/lib/types.ts</path>
        <kind>TypeScript Types</kind>
        <symbol>UoM type</symbol>
        <lines>TBD</lines>
        <reason>Define UoM type matching DB (if using master table, may use enum or string)</reason>
      </artifact>
      <artifact>
        <path>apps/frontend/lib/api/licensePlates.ts</path>
        <kind>API Service</kind>
        <symbol>LicensePlatesAPI</symbol>
        <lines>all</lines>
        <reason>Add UoM validation, create method to fetch valid UoMs from uom_master table</reason>
      </artifact>
    </code>

    <dependencies>
      <ecosystem name="Node.js/pnpm">
        <package name="@supabase/supabase-js" version="^2.75.0" />
        <package name="typescript" version="^5.7.2" />
      </ecosystem>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="architectural-decision-required">
      MUST decide: (A) UoM master table (recommended - validates, extensible) OR (B) Remove CHECK constraint (flexible but no DB validation). Decision impacts implementation approach.
    </constraint>
    <constraint type="extensibility">
      Solution MUST allow adding new UoM values without code changes. Master table approach: INSERT new row. Enum approach: requires code change.
    </constraint>
    <constraint type="standard-units">
      Initial UoM list should include ISO and industry-standard units. ~20 units across categories: weight (KG, POUND, GRAM, TON), volume (LITER, GALLON, MILLILITER, BARREL), length (METER, FOOT, INCH), count (EACH, DOZEN), container (BOX, CASE, PALLET, DRUM, BAG).
    </constraint>
    <constraint type="display-labels">
      UoM codes (KG, GALLON) should have display-friendly labels (Kilograms, US Gallon) for UI.
    </constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>UoM Master Table (NEW)</name>
      <kind>Database Table</kind>
      <signature>CREATE TABLE uom_master (code VARCHAR(20) PRIMARY KEY, display_name VARCHAR(50), category VARCHAR(20), created_at TIMESTAMPTZ);</signature>
      <path>New migration file</path>
      <usage>Reference table for valid UoM codes, supports metadata like display names and categories</usage>
    </interface>
    <interface>
      <name>UoMAPI (NEW)</name>
      <kind>API Service</kind>
      <signature>class UoMAPI { static async getAll(): Promise<UoM[]> }</signature>
      <path>apps/frontend/lib/api/uom.ts (NEW)</path>
      <usage>Fetch valid UoM values for UI dropdowns</usage>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Test UoM validation (reject invalid UoM), test LP creation with new units (GALLON, PALLET), test UI dropdown shows all UoMs.
    </standards>

    <locations>
      - Unit tests: apps/frontend/__tests__/
      - E2E tests: apps/frontend/e2e/04-license-plates.spec.ts
    </locations>

    <ideas>
      <test ac="AC-4">
        Unit test: LP creation with valid UoM succeeds, invalid UoM rejected
      </test>
      <test ac="AC-6">
        E2E test: Create LP with GALLON unit, verify it saves correctly
      </test>
      <test ac="AC-5">
        E2E test: UoM dropdown in LP creation form shows all ~20 units
      </test>
    </ideas>
  </tests>
</story-context>
