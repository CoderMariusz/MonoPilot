================================================================================
STORY 03.11a - WO MATERIALS (BOM SNAPSHOT) - TEST DELIVERY
================================================================================

DATE: 2025-12-31
PHASE: RED (Test-First Development)
AGENT: TEST-WRITER
STATUS: COMPLETE

================================================================================
DELIVERABLES
================================================================================

TEST FILES CREATED (5):

1. UNIT TESTS: wo-snapshot-service.test.ts
   Location: apps/frontend/lib/services/__tests__/wo-snapshot-service.test.ts
   Size: 293 lines
   Tests: 14 (all failing)

2. INTEGRATION TEST: GET /materials
   Location: apps/frontend/app/api/planning/work-orders/[id]/materials/__tests__/route.test.ts
   Size: 372 lines
   Tests: 6 (all failing)

3. INTEGRATION TEST: POST /snapshot
   Location: apps/frontend/app/api/planning/work-orders/[id]/snapshot/__tests__/route.test.ts
   Size: 382 lines
   Tests: 10 (all failing)

4. RLS POLICY TESTS
   Location: supabase/tests/wo-materials-rls.test.sql
   Size: 329 lines
   Tests: 6 (all failing)

5. E2E TESTS: wo-materials.spec.ts
   Location: apps/frontend/__tests__/e2e/planning/wo-materials.spec.ts
   Size: 362 lines
   Tests: 8 (all skipped, awaiting UI implementation)

DOCUMENTATION FILES (3):

1. TEST-EXECUTION-SUMMARY.md
   Location: docs/2-MANAGEMENT/epics/current/03-planning/context/03.11a/TEST-EXECUTION-SUMMARY.md

2. HANDOFF-TO-DEV.md
   Location: docs/2-MANAGEMENT/epics/current/03-planning/context/03.11a/HANDOFF-TO-DEV.md

3. TEST-WRITER-SESSION-SUMMARY.md
   Location: TEST-WRITER-SESSION-SUMMARY.md (root)

================================================================================
TEST STATISTICS
================================================================================

Total Test Cases: 44 (ALL FAILING - Expected for RED phase)
  - Unit Tests: 14
  - Integration GET: 6
  - Integration POST: 10
  - RLS Tests: 6
  - E2E Tests: 8

Acceptance Criteria: 13/13 covered (100%)
  - AC-1 through AC-10b: All tested
  - AC-5, AC-9, AC-9b, AC-10: Performance metrics

================================================================================
HOW TO VERIFY
================================================================================

Unit Tests:
  grep -c "it(" apps/frontend/lib/services/__tests__/wo-snapshot-service.test.ts
  Expected: 14

Integration GET:
  grep -c "it(" apps/frontend/app/api/planning/work-orders/[id]/materials/__tests__/route.test.ts
  Expected: 6

Integration POST:
  grep -c "it(" apps/frontend/app/api/planning/work-orders/[id]/snapshot/__tests__/route.test.ts
  Expected: 10

E2E Tests:
  grep -c "test(" apps/frontend/__tests__/e2e/planning/wo-materials.spec.ts
  Expected: 10+

RLS Tests:
  grep "TEST [0-9]:" supabase/tests/wo-materials-rls.test.sql | wc -l
  Expected: 6

================================================================================
PHASE TRANSITION
================================================================================

RED Phase (TEST-WRITER): COMPLETE

GREEN Phase (DEV): READY FOR HANDOFF
  - Create wo_materials database table
  - Implement wo-snapshot-service.ts
  - Implement GET /materials endpoint
  - Implement POST /snapshot endpoint
  - Make all 44 tests PASS

REFACTOR Phase (SENIOR-DEV): AWAITING
  - Code optimization
  - Test coverage review
  - Documentation update

================================================================================
KEY NOTES FOR DEV
================================================================================

Scaling Formula:
  (wo_qty / bom_output_qty) * item_qty * (1 + scrap_percent / 100)
  Example: (250 / 100) * 50 * (1 + 5/100) = 131.25
  Round to 6 decimal places to avoid floating point errors

By-Products:
  - required_qty = 0 (not scaled)
  - yield_percent preserved from BOM item
  - is_by_product = true flag

RLS Security:
  - All queries filter by: organization_id = (SELECT org_id FROM users WHERE id = auth.uid())
  - Return 404 (not 403) for cross-org access
  - Tests verify security hiding

Error Responses:
  - 404: WO not found or org mismatch
  - 400: No BOM selected
  - 409: WO is released/in_progress (immutable)

================================================================================
SUCCESS CRITERIA FOR GREEN PHASE
================================================================================

All 44 tests should PASS:
  - 14 unit tests (scaleQuantity, canModifySnapshot)
  - 6 integration tests (GET /materials)
  - 10 integration tests (POST /snapshot)
  - 6 RLS policy tests
  - 8 E2E tests

Coverage Targets:
  - scaleQuantity: 90%+
  - canModifySnapshot: 100%
  - materials endpoint: 80%+
  - snapshot endpoint: 80%+

Performance Targets:
  - GET /materials: < 500ms
  - POST /snapshot: < 2 seconds (100 item BOM)

================================================================================
COMPLETE FILE LIST
================================================================================

Test Files:
  C:\Users\Mariusz K\Documents\Programowanie\MonoPilot\apps\frontend\lib\services\__tests__\wo-snapshot-service.test.ts
  C:\Users\Mariusz K\Documents\Programowanie\MonoPilot\apps\frontend\app\api\planning\work-orders\[id]\materials\__tests__\route.test.ts
  C:\Users\Mariusz K\Documents\Programowanie\MonoPilot\apps\frontend\app\api\planning\work-orders\[id]\snapshot\__tests__\route.test.ts
  C:\Users\Mariusz K\Documents\Programowanie\MonoPilot\apps\frontend\__tests__\e2e\planning\wo-materials.spec.ts
  C:\Users\Mariusz K\Documents\Programowanie\MonoPilot\supabase\tests\wo-materials-rls.test.sql

Documentation Files:
  C:\Users\Mariusz K\Documents\Programowanie\MonoPilot\docs\2-MANAGEMENT\epics\current\03-planning\context\03.11a\TEST-EXECUTION-SUMMARY.md
  C:\Users\Mariusz K\Documents\Programowanie\MonoPilot\docs\2-MANAGEMENT\epics\current\03-planning\context\03.11a\HANDOFF-TO-DEV.md
  C:\Users\Mariusz K\Documents\Programowanie\MonoPilot\TEST-WRITER-SESSION-SUMMARY.md
  C:\Users\Mariusz K\Documents\Programowanie\MonoPilot\TEST-WRITER-DELIVERY.txt

================================================================================
READY FOR DEV PHASE
================================================================================

All test files created and failing (RED phase complete).
All documentation prepared for handoff.
Clear success criteria defined for GREEN phase.

Next: DEV agent implements functionality to make tests PASS.
