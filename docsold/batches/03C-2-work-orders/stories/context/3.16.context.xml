<?xml version="1.0" encoding="UTF-8"?>
<story>
  <metadata>
    <id>3.16</id>
    <title>WO Source of Demand</title>
    <batch>03C-2</batch>
    <points>3</points>
    <effort_hours>2-3</effort_hours>
    <status>todo</status>
  </metadata>

  <description>
    Track why a WO was created (PO, Customer Order, Manual, Forecast).
    Enables demand traceability for planning and MRP purposes.
    Optional feature controlled by Settings toggle.
  </description>

  <dependencies>
    <blocks/>
    <requires>
      <story id="3.10">Work Order CRUD</story>
    </requires>
  </dependencies>

  <technical_context>
    <tables>
      <table>
        <name>work_orders</name>
        <columns>
          <column name="source_type" type="VARCHAR(50)" nullable="true"/>
          <column name="source_reference" type="VARCHAR(100)" nullable="true"/>
          <column name="source_id" type="UUID" nullable="true"/>
        </columns>
        <indexes>
          <index name="idx_work_orders_source" columns="org_id, source_type"/>
        </indexes>
      </table>
      <table>
        <name>planning_settings</name>
        <columns>
          <column name="wo_source_of_demand" type="BOOLEAN" default="false"/>
        </columns>
      </table>
    </tables>

    <api_endpoints>
      <endpoint method="POST" path="/api/planning/work-orders">
        <request>
          <field name="source_type" type="string" optional="true"/>
          <field name="source_reference" type="string" optional="true"/>
          <field name="source_id" type="string" optional="true"/>
        </request>
      </endpoint>
      <endpoint method="GET" path="/api/planning/work-orders">
        <query_params>
          <param name="source_type" type="string" optional="true"/>
          <param name="source_reference" type="string" optional="true"/>
        </query_params>
      </endpoint>
    </api_endpoints>

    <services>
      <service name="WorkOrderService">
        <method name="createWithSource">
          <param name="woData" type="CreateWOInput"/>
          <param name="sourceType" type="SourceType" optional="true"/>
          <param name="sourceReference" type="string" optional="true"/>
          <returns>WorkOrder</returns>
        </method>
      </service>
    </services>

    <components_to_create>
      <component name="WOSourceSelector" path="components/planning/WOSourceSelector.tsx">
        <props>
          <prop name="value" type="SourceType"/>
          <prop name="reference" type="string"/>
          <prop name="onChange" type="(type: SourceType, ref: string) => void"/>
        </props>
      </component>
    </components_to_create>

    <types>
      <enum name="SourceType">
        <value code="po" label="Purchase Order"/>
        <value code="customer_order" label="Customer Order"/>
        <value code="manual" label="Manual"/>
        <value code="forecast" label="Forecast"/>
        <value code="stock_replenishment" label="Stock Replenishment"/>
      </enum>
    </types>
  </technical_context>

  <acceptance_criteria>
    <criterion id="AC-1">
      <description>Source Selection</description>
      <given>source_of_demand enabled in Settings</given>
      <when>creating WO</when>
      <then>can select source type: PO Number, Customer Order, Manual, Forecast</then>
    </criterion>
    <criterion id="AC-2">
      <description>Source Reference</description>
      <then>can enter source_reference (e.g., "PO-001", "ORD-123")</then>
      <note>field is optional but recommended</note>
    </criterion>
    <criterion id="AC-3">
      <description>Display on WO</description>
      <when>viewing WO</when>
      <then>source shown in header/detail area</then>
    </criterion>
    <criterion id="AC-4">
      <description>Filter by Source</description>
      <when>filtering WO list</when>
      <then>can filter by source type and search by source_reference</then>
    </criterion>
  </acceptance_criteria>

  <test_plan>
    <unit_tests>
      <test>Source type enum validation</test>
      <test>Optional fields handling</test>
    </unit_tests>
    <integration_tests>
      <test>WO created with source data</test>
      <test>Filter by source type works</test>
      <test>Settings toggle enables/disables</test>
    </integration_tests>
    <e2e_tests>
      <test>Create WO with PO source â†’ verify displayed</test>
      <test>Filter WOs by source type</test>
      <test>Search by source reference</test>
    </e2e_tests>
  </test_plan>

  <implementation_notes>
    <note priority="medium">Helps with demand traceability (future MRP)</note>
    <note priority="low">Source links useful for customer order tracking</note>
    <note priority="low">Consider audit trail for source changes</note>
  </implementation_notes>
</story>
