# Story 3.16: WO Source of Demand

**ID:** 3.16
**Batch:** 03C-2
**Story Points:** 3
**Effort:** 2-3 hours
**Status:** Todo

## User Story

> As a **Planner**,
> I want to track why a WO was created,
> So that I can trace demand.

## Acceptance Criteria

### AC 1: Source Selection

**Given** `source_of_demand` enabled in Settings
**When** creating WO
**Then** can select source type:
- PO Number
- Customer Order
- Manual
- Forecast

### AC 2: Source Reference

**And** can enter `source_reference` (e.g., "PO-001", "ORD-123")
**And** field is optional but recommended

### AC 3: Display on WO

**When** viewing WO
**Then** source shown in header/detail area
**And** links to source document if applicable (PO, Order)

### AC 4: Filter by Source

**When** filtering WO list
**Then** can filter by source type
**And** can search by source_reference

## Technical Tasks

### Backend
- [ ] Add columns to `work_orders` table (see schema)
- [ ] Toggle in `planning_settings.wo_source_of_demand`
- [ ] API: Include source fields in WO CRUD
- [ ] Add filter support for source_type

### Frontend
- [ ] Add source section to WO create modal (when enabled)
- [ ] Dropdown for source type
- [ ] Text input for source reference
- [ ] Display in WO detail header
- [ ] Filter dropdown in WO list

### Database

```sql
-- Add to work_orders table
ALTER TABLE work_orders ADD COLUMN source_type VARCHAR(50);
ALTER TABLE work_orders ADD COLUMN source_reference VARCHAR(100);
ALTER TABLE work_orders ADD COLUMN source_id UUID; -- FK to source document if applicable

-- Add to planning_settings
ALTER TABLE planning_settings ADD COLUMN wo_source_of_demand BOOLEAN DEFAULT false;

-- Index for filtering
CREATE INDEX idx_work_orders_source ON work_orders(org_id, source_type);
```

## Source Types

| Code | Label | Use Case |
|------|-------|----------|
| `po` | Purchase Order | WO triggered by incoming materials |
| `customer_order` | Customer Order | WO for specific customer demand |
| `manual` | Manual | Ad-hoc production decision |
| `forecast` | Forecast | WO from demand forecasting |
| `stock_replenishment` | Stock Replenishment | Min stock level triggered |

## Testing

### Unit Tests
- [ ] Source type enum validation
- [ ] Optional fields handling

### Integration Tests
- [ ] WO created with source data
- [ ] Filter by source type works
- [ ] Settings toggle enables/disables

### E2E Tests
- [ ] Create WO with PO source â†’ verify displayed
- [ ] Filter WOs by source type
- [ ] Search by source reference

## Dependencies

- **Requires:** Story 3.10 (WO CRUD)
- **Blocks:** None (optional traceability enhancement)

## Notes

- Helps with demand traceability (future MRP)
- Source links useful for customer order tracking
- Consider audit trail for source changes
