# Story 3.19: PO Status Lifecycle

**ID:** 3.19
**Batch:** 03C-3
**Story Points:** 3
**Effort:** 2-3 hours
**Status:** Todo

## User Story

> As a **Purchasing user**,
> I want to move PO through statuses,
> So that I can track procurement progress.

## Acceptance Criteria

### AC 1: Status Change Button

**Given** PO exists
**When** clicking status change button
**Then** PO moves to next status in sequence

### AC 2: Typical Flow

**Flow:** Draft → Submitted → Confirmed → Receiving → Closed

### AC 3: Audit Trail

**And** status change logged in audit trail
**And** timestamps updated (status_changed_at, updated_by)

### AC 4: Status Badge

**When** viewing PO list or detail
**Then** status shown with color badge from configuration

### AC 5: Transition Validation

**Given** PO status = 'Closed'
**When** attempting to change status
**Then** show error: "Cannot change status of closed PO"

## Technical Tasks

### Backend
- [ ] API: `PUT /api/planning/purchase-orders/:id/status`
- [ ] Validate status transitions (cannot go backwards without permission)
- [ ] Log status change to audit table
- [ ] Update timestamps

### Frontend
- [ ] Status change button/dropdown on PO detail
- [ ] Color-coded status badges
- [ ] Confirmation dialog for critical transitions
- [ ] Toast notification on status change

### Database

```sql
-- Audit trail for status changes
CREATE TABLE IF NOT EXISTS po_status_history (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  org_id UUID NOT NULL REFERENCES organizations(id),
  po_id UUID NOT NULL REFERENCES purchase_orders(id) ON DELETE CASCADE,
  from_status VARCHAR(50),
  to_status VARCHAR(50) NOT NULL,
  changed_by UUID REFERENCES users(id),
  changed_at TIMESTAMPTZ DEFAULT NOW(),
  notes TEXT
);

CREATE INDEX idx_po_status_history_po ON po_status_history(po_id);
```

## Testing

### Unit Tests
- [ ] Status transition validation
- [ ] Audit log creation

### Integration Tests
- [ ] API changes status correctly
- [ ] Audit trail created
- [ ] Timestamps updated

### E2E Tests
- [ ] Change PO status through full lifecycle
- [ ] Verify audit trail in history

## Dependencies

- **Requires:** Story 3.1 (PO CRUD), Story 3.5 (Configurable Statuses)
- **Blocks:** None

## Notes

- Status badges should use colors from planning_settings.po_statuses
- Consider status transition rules (future enhancement)
