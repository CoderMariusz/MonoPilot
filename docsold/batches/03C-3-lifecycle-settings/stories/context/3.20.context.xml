<?xml version="1.0" encoding="UTF-8"?>
<story>
  <metadata>
    <id>3.20</id>
    <title>TO Status Lifecycle</title>
    <batch>03C-3</batch>
    <points>3</points>
    <effort_hours>2-3</effort_hours>
    <status>todo</status>
  </metadata>

  <description>
    Move TO through status lifecycle with automatic date tracking.
    Flow: Draft → Planned → Shipped → Received
  </description>

  <dependencies>
    <blocks>
      <epic id="5">Receiving Workflow</epic>
    </blocks>
    <requires>
      <story id="3.6">TO CRUD</story>
    </requires>
  </dependencies>

  <technical_context>
    <tables>
      <table>
        <name>transfer_orders</name>
        <columns_to_add>
          <column name="actual_ship_date" type="TIMESTAMPTZ" nullable="true"/>
          <column name="actual_receive_date" type="TIMESTAMPTZ" nullable="true"/>
          <column name="shipped_by" type="UUID" fk="users.id" nullable="true"/>
          <column name="received_by" type="UUID" fk="users.id" nullable="true"/>
        </columns_to_add>
      </table>
      <table>
        <name>to_status_history</name>
        <columns>
          <column name="id" type="UUID" pk="true"/>
          <column name="org_id" type="UUID" fk="organizations.id"/>
          <column name="to_id" type="UUID" fk="transfer_orders.id" on_delete="CASCADE"/>
          <column name="from_status" type="VARCHAR(50)" nullable="true"/>
          <column name="to_status" type="VARCHAR(50)"/>
          <column name="changed_by" type="UUID" fk="users.id"/>
          <column name="changed_at" type="TIMESTAMPTZ"/>
          <column name="notes" type="TEXT" nullable="true"/>
        </columns>
        <indexes>
          <index name="idx_to_status_history_to" columns="to_id"/>
        </indexes>
      </table>
    </tables>

    <api_endpoints>
      <endpoint method="PUT" path="/api/planning/transfer-orders/:id/status">
        <request>
          <field name="status" type="string"/>
          <field name="notes" type="string" optional="true"/>
        </request>
        <response>
          <field name="id" type="string"/>
          <field name="status" type="string"/>
          <field name="actual_ship_date" type="string" nullable="true"/>
          <field name="actual_receive_date" type="string" nullable="true"/>
        </response>
      </endpoint>
    </api_endpoints>

    <components_to_create>
      <component name="TOShipButton" path="components/planning/TOShipButton.tsx"/>
      <component name="TOReceiveButton" path="components/planning/TOReceiveButton.tsx"/>
    </components_to_create>
  </technical_context>

  <acceptance_criteria>
    <criterion id="AC-1">
      <description>Ship Action</description>
      <given>TO status = 'Planned'</given>
      <when>clicking "Ship"</when>
      <then>status → 'Shipped' AND actual_ship_date set</then>
    </criterion>
    <criterion id="AC-2">
      <description>Receive Action</description>
      <given>TO status = 'Shipped'</given>
      <when>clicking "Receive"</when>
      <then>status → 'Received' AND actual_receive_date set</then>
    </criterion>
    <criterion id="AC-3">
      <description>Status Flow</description>
      <flow>Draft → Planned → Shipped → Received</flow>
    </criterion>
    <criterion id="AC-4">
      <description>Audit Trail</description>
      <then>status changes logged with timestamps and user</then>
    </criterion>
    <criterion id="AC-5">
      <description>Partial Status</description>
      <given>partial shipments enabled</given>
      <when>partial quantity shipped</when>
      <then>status → 'Partially Shipped'</then>
    </criterion>
  </acceptance_criteria>

  <test_plan>
    <unit_tests>
      <test>Status transition logic</test>
      <test>Date setting on ship/receive</test>
    </unit_tests>
    <integration_tests>
      <test>API updates status correctly</test>
      <test>Dates set automatically</test>
      <test>Audit trail created</test>
    </integration_tests>
    <e2e_tests>
      <test>Full TO lifecycle</test>
      <test>Verify dates displayed correctly</test>
    </e2e_tests>
  </test_plan>

  <implementation_notes>
    <note priority="medium">actual_ship_date and actual_receive_date are automatic</note>
    <note priority="low">Consider partial shipment tracking (Story 3.8)</note>
  </implementation_notes>
</story>
