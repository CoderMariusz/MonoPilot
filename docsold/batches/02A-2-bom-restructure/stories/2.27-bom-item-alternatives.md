# Story 2.27: BOM Item Alternatives

**Epic:** 2 - Technical/Products
**Batch:** 02A-2-bom-restructure
**Status:** Todo
**Priority:** P1 (Important for flexible production)
**Story Points:** 2
**Created:** 2025-11-30
**Effort Estimate:** 1 day

---

## Goal

Enable BOM items to have alternative components that can be used as substitutes during production, with optional priority ordering.

## User Story

**As a** Production Planner
**I want** to define alternative components for BOM items
**So that** production can substitute materials when primary component is unavailable

---

## Problem Statement

Current BOM items have single component assignment:
1. No substitution options during shortages
2. Production halts if primary material unavailable
3. Cannot leverage equivalent materials from different suppliers

New structure enables:
1. Multiple alternative components per BOM item
2. Priority ordering for selection preference
3. Quantity conversion if UOMs differ
4. Production can select from available alternatives

---

## Acceptance Criteria

### AC-2.27.1: Create BOM Item Alternatives Table
**Given** bom_items table exists (Story 2.26)
**When** migration runs
**Then** `bom_item_alternatives` table is created:
```sql
CREATE TABLE bom_item_alternatives (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  bom_item_id UUID NOT NULL REFERENCES bom_items(id) ON DELETE CASCADE,
  alternative_component_id UUID NOT NULL REFERENCES products(id),
  priority INTEGER NOT NULL DEFAULT 1,
  quantity_ratio DECIMAL(10,4) NOT NULL DEFAULT 1.0000,
  notes TEXT,
  created_at TIMESTAMPTZ DEFAULT now(),
  UNIQUE(bom_item_id, alternative_component_id)
);

CREATE INDEX idx_bom_item_alternatives_item ON bom_item_alternatives(bom_item_id);
CREATE INDEX idx_bom_item_alternatives_component ON bom_item_alternatives(alternative_component_id);
```

**Columns:**
- `bom_item_id`: Parent BOM item
- `alternative_component_id`: Alternative product
- `priority`: Selection order (1 = first choice, 2 = second, etc.)
- `quantity_ratio`: Conversion factor (1.0 = same qty, 1.1 = 10% more needed)
- `notes`: Usage notes for operators

**Success Criteria:**
- ✅ Table created with all columns
- ✅ ON DELETE CASCADE from bom_items
- ✅ UNIQUE constraint on (bom_item_id, alternative_component_id)
- ✅ Indexes for query performance

---

### AC-2.27.2: RLS Policy
**Given** table is created
**When** RLS configured
**Then** policy enables authenticated access:
```sql
ALTER TABLE bom_item_alternatives ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Enable all for authenticated" ON bom_item_alternatives
  FOR ALL TO authenticated USING (true) WITH CHECK (true);
```

**Success Criteria:**
- ✅ RLS enabled
- ✅ Authenticated users have full CRUD

---

### AC-2.27.3: Get Item Alternatives Endpoint
**Given** BOM item exists
**When** fetching alternatives
**Then** endpoint returns list:

**GET /api/technical/boms/:bomId/items/:itemId/alternatives**
```typescript
Response (200): {
  data: [{
    id: uuid,
    bom_item_id: uuid,
    alternative_component_id: uuid,
    alternative_component: {           // Joined product data
      id: uuid,
      sku: string,
      name: string,
      uom: string,
      type: string
    },
    priority: number,
    quantity_ratio: number,
    notes: string | null,
    created_at: timestamp
  }]
}
// Ordered by priority ASC

Error (404): { error: "BOM_NOT_FOUND" }
Error (404): { error: "ITEM_NOT_FOUND" }
```

**Success Criteria:**
- ✅ Returns all alternatives for item
- ✅ Includes product details
- ✅ Ordered by priority

---

### AC-2.27.4: Add Alternative Endpoint
**Given** BOM item exists
**When** adding alternative
**Then** endpoint creates record:

**POST /api/technical/boms/:bomId/items/:itemId/alternatives**
```typescript
Request: {
  alternative_component_id: uuid,      // Required - alternative product
  priority?: number,                   // Default: next available
  quantity_ratio?: number,             // Default: 1.0
  notes?: string
}

Response (201): {
  data: {
    id: uuid,
    alternative_component_id: uuid,
    alternative_component: { id, sku, name, uom, type },
    priority: number,
    quantity_ratio: number,
    notes: string | null
  }
}

Error (400): { error: "INVALID_COMPONENT", message: "Component not found" }
Error (400): { error: "DUPLICATE_ALTERNATIVE", message: "Alternative already exists" }
Error (400): { error: "SAME_AS_PRIMARY", message: "Cannot add primary component as alternative" }
Error (404): { error: "ITEM_NOT_FOUND" }
```

**Success Criteria:**
- ✅ Creates alternative record
- ✅ Auto-assigns priority if not provided
- ✅ Validates component exists
- ✅ Prevents duplicate alternatives
- ✅ Prevents adding primary component as alternative

---

### AC-2.27.5: Update Alternative Endpoint
**Given** alternative exists
**When** updating
**Then** endpoint updates record:

**PUT /api/technical/boms/:bomId/items/:itemId/alternatives/:altId**
```typescript
Request: {
  priority?: number,
  quantity_ratio?: number,
  notes?: string | null
}

Response (200): {
  data: { ... updated alternative ... }
}

Error (404): { error: "ALTERNATIVE_NOT_FOUND" }
```

**Note:** Cannot change alternative_component_id - delete and recreate instead.

**Success Criteria:**
- ✅ Updates only provided fields
- ✅ Cannot change component (immutable)

---

### AC-2.27.6: Delete Alternative Endpoint
**Given** alternative exists
**When** deleting
**Then** endpoint removes record:

**DELETE /api/technical/boms/:bomId/items/:itemId/alternatives/:altId**
```typescript
Response (200): { message: "Alternative removed successfully" }
Error (404): { error: "ALTERNATIVE_NOT_FOUND" }
```

**Success Criteria:**
- ✅ Alternative removed from database

---

### AC-2.27.7: Bulk Update Alternatives Endpoint
**Given** BOM item exists
**When** bulk updating alternatives
**Then** endpoint replaces all:

**PUT /api/technical/boms/:bomId/items/:itemId/alternatives**
```typescript
Request: {
  alternatives: [{
    alternative_component_id: uuid,
    priority: number,
    quantity_ratio?: number,
    notes?: string
  }]
}

Response (200): {
  data: [...all alternatives...],
  message: "Alternatives updated successfully"
}

Error (400): { error: "DUPLICATE_IN_REQUEST" }
Error (400): { error: "INVALID_COMPONENT" }
```

**Behavior:**
1. DELETE all existing alternatives for item
2. INSERT new alternatives from request
3. Return updated list

**Success Criteria:**
- ✅ Bulk replace approach
- ✅ Validates all components exist
- ✅ Validates no duplicates in request
- ✅ Atomic transaction

---

### AC-2.27.8: Include Alternatives in BOM Item Response
**Given** BOM item has alternatives
**When** GET /api/technical/boms/:id/items
**Then** alternatives included:
```typescript
Response: {
  data: [{
    id: uuid,
    component_id: uuid,
    component: { ... },
    // ... other item fields ...
    alternatives: [{                   // NEW: Include alternatives
      id: uuid,
      alternative_component_id: uuid,
      alternative_component: { id, sku, name },
      priority: number,
      quantity_ratio: number
    }]
  }]
}
```

**Optional:** Use query param `?include_alternatives=true` to control loading.

**Success Criteria:**
- ✅ Alternatives included in item response
- ✅ Optional loading for performance
- ✅ Ordered by priority

---

### AC-2.27.9: Validation Rules
**Given** API receives alternative data
**When** validating
**Then** following rules enforced:

| Field | Rule | Error Code |
|-------|------|------------|
| alternative_component_id | Required, must exist | INVALID_COMPONENT |
| alternative_component_id | Cannot = item's component_id | SAME_AS_PRIMARY |
| alternative_component_id | Unique per bom_item | DUPLICATE_ALTERNATIVE |
| priority | Positive integer | INVALID_PRIORITY |
| quantity_ratio | > 0, max 100 | INVALID_RATIO |

**Success Criteria:**
- ✅ All validations return specific error codes
- ✅ Primary component protected
- ✅ Ratio range enforced

---

### AC-2.27.10: BomItemAlternativeService Implementation
**Given** API routes exist
**When** business logic needed
**Then** service provides:

```typescript
// lib/services/bom-item-alternative-service.ts
class BomItemAlternativeService {
  // CRUD
  async list(bomItemId: string): Promise<BomItemAlternative[]>
  async create(bomItemId: string, data: CreateAlternativeInput): Promise<BomItemAlternative>
  async update(altId: string, data: UpdateAlternativeInput): Promise<BomItemAlternative>
  async delete(altId: string): Promise<void>
  async bulkReplace(bomItemId: string, alternatives: CreateAlternativeInput[]): Promise<BomItemAlternative[]>

  // Helpers
  async getNextPriority(bomItemId: string): Promise<number>
  async calculateAlternativeQuantity(
    originalQty: number,
    quantityRatio: number
  ): Promise<number>

  // Production use
  async getAvailableAlternatives(
    bomItemId: string,
    warehouseId: string
  ): Promise<Array<{
    alternative: BomItemAlternative,
    availableQty: number,
    requiredQty: number
  }>>
}
```

**Success Criteria:**
- ✅ Service encapsulates all operations
- ✅ Priority auto-increment helper
- ✅ Quantity calculation helper
- ✅ Stock check helper for production

---

### AC-2.27.11: TypeScript Types
**Given** schema is defined
**When** types generated
**Then** following types exist:

```typescript
// types/bom-item-alternative.ts
interface BomItemAlternative {
  id: string
  bom_item_id: string
  alternative_component_id: string
  alternative_component?: Product
  priority: number
  quantity_ratio: number
  notes: string | null
  created_at: string
}

interface CreateAlternativeInput {
  alternative_component_id: string
  priority?: number
  quantity_ratio?: number
  notes?: string
}

interface UpdateAlternativeInput {
  priority?: number
  quantity_ratio?: number
  notes?: string | null
}

// Extended BomItem with alternatives
interface BomItemWithAlternatives extends BomItem {
  alternatives: BomItemAlternative[]
}
```

**Success Criteria:**
- ✅ All types defined
- ✅ Extended type for items with alternatives

---

### AC-2.27.12: Zod Validation Schemas
**Given** API needs validation
**When** Zod schemas defined
**Then** following schemas exist:

```typescript
// lib/validation/bom-item-alternative-schemas.ts
import { z } from 'zod'

export const createAlternativeSchema = z.object({
  alternative_component_id: z.string().uuid(),
  priority: z.number().int().positive().optional(),
  quantity_ratio: z.number().positive().max(100).optional().default(1.0),
  notes: z.string().max(500).optional()
})

export const updateAlternativeSchema = z.object({
  priority: z.number().int().positive().optional(),
  quantity_ratio: z.number().positive().max(100).optional(),
  notes: z.string().max(500).nullable().optional()
})

export const bulkAlternativesSchema = z.object({
  alternatives: z.array(
    z.object({
      alternative_component_id: z.string().uuid(),
      priority: z.number().int().positive(),
      quantity_ratio: z.number().positive().max(100).optional().default(1.0),
      notes: z.string().max(500).optional()
    })
  ).refine(
    (alts) => {
      const ids = alts.map(a => a.alternative_component_id)
      return new Set(ids).size === ids.length
    },
    { message: "Duplicate alternative_component_id values" }
  )
})
```

**Success Criteria:**
- ✅ Schemas validate all fields
- ✅ Bulk schema checks for duplicates

---

## Technical Tasks

### Database

- [ ] Task 1: Create migration for bom_item_alternatives
  - [ ] Subtask 1.1: CREATE bom_item_alternatives table
  - [ ] Subtask 1.2: CREATE indexes
  - [ ] Subtask 1.3: Enable RLS and create policy

### Backend

- [ ] Task 2: Create BomItemAlternativeService
  - [ ] Subtask 2.1: Implement list() with product join
  - [ ] Subtask 2.2: Implement create() with validations
  - [ ] Subtask 2.3: Implement update()
  - [ ] Subtask 2.4: Implement delete()
  - [ ] Subtask 2.5: Implement bulkReplace() with transaction
  - [ ] Subtask 2.6: Implement getNextPriority()
  - [ ] Subtask 2.7: Implement calculateAlternativeQuantity()
  - [ ] Subtask 2.8: Implement getAvailableAlternatives()

- [ ] Task 3: Create TypeScript types
  - [ ] Subtask 3.1: Define BomItemAlternative interface
  - [ ] Subtask 3.2: Define input/update types
  - [ ] Subtask 3.3: Define BomItemWithAlternatives

- [ ] Task 4: Create Zod validation schemas
  - [ ] Subtask 4.1: createAlternativeSchema
  - [ ] Subtask 4.2: updateAlternativeSchema
  - [ ] Subtask 4.3: bulkAlternativesSchema

- [ ] Task 5: Create API endpoints
  - [ ] Subtask 5.1: GET /api/technical/boms/:bomId/items/:itemId/alternatives
  - [ ] Subtask 5.2: POST /api/technical/boms/:bomId/items/:itemId/alternatives
  - [ ] Subtask 5.3: PUT /api/technical/boms/:bomId/items/:itemId/alternatives/:altId
  - [ ] Subtask 5.4: DELETE /api/technical/boms/:bomId/items/:itemId/alternatives/:altId
  - [ ] Subtask 5.5: PUT /api/technical/boms/:bomId/items/:itemId/alternatives (bulk)

- [ ] Task 6: Update BOM items endpoint
  - [ ] Subtask 6.1: Add ?include_alternatives query param
  - [ ] Subtask 6.2: Include alternatives in response when enabled

### Testing

- [ ] Task 7: Unit tests - BomItemAlternativeService
  - [ ] Subtask 7.1: Test list() returns ordered by priority
  - [ ] Subtask 7.2: Test create() with all fields
  - [ ] Subtask 7.3: Test create() auto-priority assignment
  - [ ] Subtask 7.4: Test create() rejects duplicate
  - [ ] Subtask 7.5: Test create() rejects same as primary
  - [ ] Subtask 7.6: Test update() updates fields
  - [ ] Subtask 7.7: Test delete() removes record
  - [ ] Subtask 7.8: Test bulkReplace() replaces all
  - [ ] Subtask 7.9: Test calculateAlternativeQuantity()
  - [ ] Subtask 7.10: Target 95% coverage

- [ ] Task 8: Integration tests - API endpoints
  - [ ] Subtask 8.1: Test GET alternatives (200)
  - [ ] Subtask 8.2: Test POST create alternative (201)
  - [ ] Subtask 8.3: Test POST duplicate (400)
  - [ ] Subtask 8.4: Test POST same as primary (400)
  - [ ] Subtask 8.5: Test PUT update (200)
  - [ ] Subtask 8.6: Test DELETE remove (200)
  - [ ] Subtask 8.7: Test PUT bulk replace (200)
  - [ ] Subtask 8.8: Test item not found (404)
  - [ ] Subtask 8.9: Test auth required (401)
  - [ ] Subtask 8.10: Target 70% coverage

- [ ] Task 9: E2E tests - Full workflow
  - [ ] Subtask 9.1: Create BOM with items
  - [ ] Subtask 9.2: Add 2 alternatives to item
  - [ ] Subtask 9.3: Verify priority ordering
  - [ ] Subtask 9.4: Update alternative quantity_ratio
  - [ ] Subtask 9.5: Delete one alternative
  - [ ] Subtask 9.6: Verify remaining alternative
  - [ ] Subtask 9.7: Bulk replace alternatives
  - [ ] Subtask 9.8: Verify alternatives in item response

---

## Dependencies

### Requires (must exist before this story)
- Story 2.26: BOM Items with Operation Assignment (bom_items table)
- Batch 02A-1: Products Core (products table for FK)

### Blocks (cannot start until this story done)
- Story 2.29: Update existing BOM/Routing UI (UI for alternatives)
- Epic 4: Production Execution (alternative selection during consumption)

---

## Dev Notes

### Architecture Patterns
- **Junction table**: Many-to-many via bom_item_alternatives
- **Priority-based selection**: Lower number = higher priority
- **Quantity conversion**: quantity_ratio handles different yields

### Key Decisions
- **Cannot change component**: Update priority/ratio only, delete to change component
- **Auto-priority**: If not provided, assign next available
- **Ratio semantics**: ratio > 1 means MORE alternative needed

### Constraints
- Cannot add primary component as alternative
- Unique alternative per item
- priority must be positive integer
- quantity_ratio: 0.01 - 100 (practical limits)

### Quantity Calculation
```typescript
// Example: Primary needs 10kg, alternative has ratio 1.1
// Required alternative qty = 10 * 1.1 = 11kg
const alternativeQty = primaryQty * quantityRatio
```

### Production Use Case
```
BOM Item: Flour (10 kg, priority 0 - primary)
├── Alternative 1: Bread Flour (priority 1, ratio 1.0)
├── Alternative 2: All-Purpose Flour (priority 2, ratio 1.05)
└── Alternative 3: Wheat Flour (priority 3, ratio 0.95)

During production:
1. Check stock for Flour → Not enough
2. Check Alternative 1 (Bread Flour) → Available → Use this
3. Calculate qty: 10 * 1.0 = 10 kg
```

---

## Status

- **Created:** 2025-11-30
- **Current Status:** Todo
- **Blocked By:** Story 2.26 (BOM Items table)
