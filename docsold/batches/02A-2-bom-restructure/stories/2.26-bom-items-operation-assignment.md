# Story 2.26: BOM Items with Operation Assignment

**Epic:** 2 - Technical/Products
**Batch:** 02A-2-bom-restructure
**Status:** Todo
**Priority:** P0 (Required for production material tracking)
**Story Points:** 5
**Created:** 2025-11-30
**Effort Estimate:** 2-3 days

---

## Goal

Restructure BOM items to support operation assignment, output items (byproducts), consumption sequencing, and line-specific item configurations.

## User Story

**As a** Production Engineer
**I want** to assign BOM items to specific operations with sequence numbers and line assignments
**So that** production knows when to consume each material and which lines can use which items

---

## Problem Statement

Current BOM items structure lacks:
1. Operation assignment (which step consumes the material)
2. Output items (byproducts/co-products)
3. Consumption sequence within operation
4. Line-specific item assignments
5. Whole LP consumption flag

New structure enables:
1. `operation_seq` - which routing operation consumes/produces item
2. `is_output` - marks byproducts/co-products
3. `sequence` - consumption order within operation
4. `line_ids` - array of production lines this item applies to
5. `consume_whole_lp` - must consume entire license plate

---

## Breaking Changes

**CRITICAL:** This story involves schema changes:
- DROP existing `bom_items` table CASCADE
- CREATE new `bom_items` table with extended columns
- Existing BOM item data will be lost (acceptable for dev)

---

## Acceptance Criteria

### AC-2.26.1: Drop and Create BOM Items Table
**Given** existing bom_items table may exist
**When** migration runs
**Then** new `bom_items` table is created:
```sql
DROP TABLE IF EXISTS bom_items CASCADE;

CREATE TABLE bom_items (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  bom_id UUID NOT NULL REFERENCES boms(id) ON DELETE CASCADE,
  component_id UUID NOT NULL REFERENCES products(id),
  operation_seq INTEGER NOT NULL DEFAULT 1,
  is_output BOOLEAN DEFAULT false,
  quantity DECIMAL(15,4) NOT NULL,
  uom TEXT NOT NULL,
  scrap_percent DECIMAL(5,2) DEFAULT 0,
  sequence INTEGER DEFAULT 1,
  line_ids UUID[],
  consume_whole_lp BOOLEAN DEFAULT false,
  notes TEXT,
  created_at TIMESTAMPTZ DEFAULT now()
);

CREATE INDEX idx_bom_items_bom ON bom_items(bom_id);
CREATE INDEX idx_bom_items_component ON bom_items(component_id);
CREATE INDEX idx_bom_items_operation ON bom_items(bom_id, operation_seq);
CREATE INDEX idx_bom_items_line_ids ON bom_items USING GIN(line_ids);
```

**Success Criteria:**
- ✅ Table created with all new columns
- ✅ bom_id FK with ON DELETE CASCADE
- ✅ component_id FK to products
- ✅ **New columns:**
  - operation_seq (integer, default 1)
  - is_output (boolean, default false)
  - sequence (integer, default 1)
  - line_ids (UUID array, nullable)
  - consume_whole_lp (boolean, default false)
- ✅ GIN index on line_ids for array queries
- ✅ Index on (bom_id, operation_seq) for grouping

---

### AC-2.26.2: RLS Policy
**Given** table is created
**When** RLS configured
**Then** policy enables authenticated access:
```sql
ALTER TABLE bom_items ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Enable all for authenticated" ON bom_items
  FOR ALL TO authenticated USING (true) WITH CHECK (true);
```

**Success Criteria:**
- ✅ RLS enabled
- ✅ Authenticated users have full CRUD

---

### AC-2.26.3: Get BOM Items Endpoint
**Given** BOM exists with items
**When** fetching items
**Then** endpoint returns items grouped by operation:

**GET /api/technical/boms/:id/items**
```typescript
Request: Query params: ?group_by_operation=true (optional)

Response (200) - Flat list (default):
{
  data: [{
    id: uuid,
    bom_id: uuid,
    component_id: uuid,
    component: {                       // Joined product data
      id: uuid,
      sku: string,
      name: string,
      uom: string,
      type: string                     // raw_material, semi_finished, etc.
    },
    operation_seq: number,             // Which operation uses this
    operation?: {                      // If BOM has routing
      sequence: number,
      name: string
    },
    is_output: boolean,                // true = byproduct/co-product
    quantity: number,
    uom: string,
    scrap_percent: number,
    sequence: number,                  // Order within operation
    line_ids: uuid[] | null,           // Specific lines or all if null
    lines?: Array<{ id: uuid, name: string }>,  // Joined line names
    consume_whole_lp: boolean,
    notes: string | null,
    created_at: timestamp
  }]
}

Response (200) - Grouped by operation:
{
  data: {
    operations: [{
      operation_seq: number,
      operation_name: string | null,   // From routing
      inputs: [...],                   // Items where is_output = false
      outputs: [...]                   // Items where is_output = true
    }]
  }
}

Error (404): { error: "BOM_NOT_FOUND" }
```

**Success Criteria:**
- ✅ Returns all items for BOM
- ✅ Includes component product details
- ✅ Includes operation details if routing assigned
- ✅ Includes line names if line_ids set
- ✅ Optional grouping by operation
- ✅ Ordered by operation_seq, then sequence

---

### AC-2.26.4: Create BOM Item Endpoint
**Given** BOM exists
**When** adding item
**Then** endpoint creates item:

**POST /api/technical/boms/:id/items**
```typescript
Request: {
  component_id: uuid,                  // Required - product to consume/produce
  operation_seq: number,               // Required - routing operation sequence
  is_output?: boolean,                 // Default false (input)
  quantity: number,                    // Required - qty per batch
  uom: string,                         // Required - unit of measure
  scrap_percent?: number,              // Default 0
  sequence?: number,                   // Default 1 (order within operation)
  line_ids?: uuid[],                   // Optional - specific lines
  consume_whole_lp?: boolean,          // Default false
  notes?: string
}

Response (201): {
  data: {
    id: uuid,
    component_id: uuid,
    component: { id, sku, name, uom, type },
    operation_seq: number,
    is_output: boolean,
    quantity: number,
    uom: string,
    scrap_percent: number,
    sequence: number,
    line_ids: uuid[] | null,
    lines: Array<{ id, name }> | null,
    consume_whole_lp: boolean,
    notes: string | null
  }
}

Error (400): { error: "INVALID_COMPONENT", message: "Component not found" }
Error (400): { error: "INVALID_OPERATION_SEQ", message: "Operation sequence not found in routing" }
Error (400): { error: "INVALID_LINE", message: "Line {id} not found" }
Error (400): { error: "DUPLICATE_ITEM", message: "Component already exists for this operation" }
Error (404): { error: "BOM_NOT_FOUND" }
```

**Success Criteria:**
- ✅ Creates item with all fields
- ✅ Validates component_id exists
- ✅ Validates operation_seq if BOM has routing
- ✅ Validates all line_ids exist
- ✅ Returns created item with joined data

---

### AC-2.26.5: Update BOM Item Endpoint
**Given** BOM item exists
**When** updating item
**Then** endpoint updates item:

**PUT /api/technical/boms/:id/items/:itemId**
```typescript
Request: {
  component_id?: uuid,
  operation_seq?: number,
  is_output?: boolean,
  quantity?: number,
  uom?: string,
  scrap_percent?: number,
  sequence?: number,
  line_ids?: uuid[] | null,            // null = applies to all lines
  consume_whole_lp?: boolean,
  notes?: string | null
}

Response (200): {
  data: { ... updated item with joins ... }
}

Error (400): { error: "INVALID_COMPONENT" }
Error (400): { error: "INVALID_OPERATION_SEQ" }
Error (400): { error: "INVALID_LINE" }
Error (404): { error: "ITEM_NOT_FOUND" }
```

**Success Criteria:**
- ✅ Updates only provided fields
- ✅ Validates changed fields
- ✅ Can set line_ids to null (all lines)
- ✅ Returns updated item

---

### AC-2.26.6: Delete BOM Item Endpoint
**Given** BOM item exists
**When** deleting item
**Then** endpoint removes item:

**DELETE /api/technical/boms/:id/items/:itemId**
```typescript
Response (200): { message: "BOM item deleted successfully" }
Error (404): { error: "ITEM_NOT_FOUND" }
```

**Success Criteria:**
- ✅ Item removed from database
- ✅ No cascade effects (item standalone)

---

### AC-2.26.7: Validation Rules
**Given** API receives item data
**When** validating
**Then** following rules enforced:

| Field | Rule | Error Code |
|-------|------|------------|
| component_id | Required, must exist | INVALID_COMPONENT |
| component_id | Cannot be same as BOM's product | SELF_REFERENCE |
| operation_seq | Required, positive integer | INVALID_OPERATION_SEQ |
| operation_seq | Must exist in routing (if BOM has routing) | OPERATION_NOT_FOUND |
| quantity | Required, > 0 | INVALID_QUANTITY |
| uom | Required, 1-10 chars | INVALID_UOM |
| scrap_percent | 0-100 | INVALID_SCRAP |
| sequence | Positive integer | INVALID_SEQUENCE |
| line_ids | All must exist | INVALID_LINE |
| line_ids | Must be assigned to BOM | LINE_NOT_IN_BOM |

**Special Validations:**
- If is_output=true and component_id = BOM product_id → allowed (main output)
- If is_output=false and component_id = BOM product_id → error (SELF_REFERENCE)
- line_ids must be subset of BOM's production_lines

**Success Criteria:**
- ✅ All validations return specific error codes
- ✅ Self-reference prevented for inputs
- ✅ line_ids validated against BOM's assigned lines

---

### AC-2.26.8: Operation Sequence Validation
**Given** BOM has routing assigned
**When** adding/updating item with operation_seq
**Then** validate operation exists:

```typescript
// Logic
const bom = await getBom(bomId)
if (bom.routing_id) {
  const operations = await getRoutingOperations(bom.routing_id)
  const validSeqs = operations.map(op => op.sequence)
  if (!validSeqs.includes(operation_seq)) {
    throw new Error("OPERATION_NOT_FOUND")
  }
}
// If no routing, any positive integer allowed
```

**Success Criteria:**
- ✅ operation_seq validated if routing exists
- ✅ Error if sequence not in routing
- ✅ Any sequence allowed if no routing

---

### AC-2.26.9: Line Assignment Validation
**Given** item has line_ids set
**When** validating line assignment
**Then** validate lines belong to BOM:

```typescript
// Logic
const bomLines = await getBomProductionLines(bomId)
const bomLineIds = bomLines.map(l => l.line_id)

for (const lineId of item.line_ids) {
  if (!bomLineIds.includes(lineId)) {
    throw new Error("LINE_NOT_IN_BOM")
  }
}
```

**Use Cases:**
- `line_ids = null` → item used on ALL lines assigned to BOM
- `line_ids = [uuid1, uuid2]` → item only for specific lines
- `line_ids = []` → NOT ALLOWED (must be null or have values)

**Success Criteria:**
- ✅ line_ids subset of BOM's production_lines
- ✅ Empty array rejected
- ✅ null means all lines

---

### AC-2.26.10: BomItemService Implementation
**Given** API routes exist
**When** business logic needed
**Then** BomItemService provides:

```typescript
// lib/services/bom-item-service.ts
class BomItemService {
  // CRUD
  async list(bomId: string, options?: { groupByOperation?: boolean }): Promise<BomItem[]>
  async create(bomId: string, data: CreateBomItemInput): Promise<BomItem>
  async update(bomId: string, itemId: string, data: UpdateBomItemInput): Promise<BomItem>
  async delete(bomId: string, itemId: string): Promise<void>

  // Helpers
  async getInputsForOperation(bomId: string, operationSeq: number): Promise<BomItem[]>
  async getOutputsForOperation(bomId: string, operationSeq: number): Promise<BomItem[]>
  async getItemsForLine(bomId: string, lineId: string): Promise<BomItem[]>
  async calculateScrapQuantity(quantity: number, scrapPercent: number): Promise<number>

  // Validation
  async validateOperationSeq(bomId: string, operationSeq: number): Promise<boolean>
  async validateLineIds(bomId: string, lineIds: string[]): Promise<boolean>
}
```

**Success Criteria:**
- ✅ Service encapsulates all DB operations
- ✅ Helper methods for production use cases
- ✅ Validation methods reusable

---

### AC-2.26.11: TypeScript Types
**Given** schema is defined
**When** types generated
**Then** following types exist:

```typescript
// types/bom-item.ts
interface BomItem {
  id: string
  bom_id: string
  component_id: string
  component?: Product
  operation_seq: number
  operation?: { sequence: number; name: string }
  is_output: boolean
  quantity: number
  uom: string
  scrap_percent: number
  sequence: number
  line_ids: string[] | null
  lines?: Array<{ id: string; name: string }>
  consume_whole_lp: boolean
  notes: string | null
  created_at: string
}

interface CreateBomItemInput {
  component_id: string
  operation_seq: number
  is_output?: boolean
  quantity: number
  uom: string
  scrap_percent?: number
  sequence?: number
  line_ids?: string[]
  consume_whole_lp?: boolean
  notes?: string
}

interface UpdateBomItemInput {
  component_id?: string
  operation_seq?: number
  is_output?: boolean
  quantity?: number
  uom?: string
  scrap_percent?: number
  sequence?: number
  line_ids?: string[] | null
  consume_whole_lp?: boolean
  notes?: string | null
}

interface BomItemsByOperation {
  operation_seq: number
  operation_name: string | null
  inputs: BomItem[]
  outputs: BomItem[]
}
```

**Success Criteria:**
- ✅ All types defined
- ✅ Nullable fields properly typed
- ✅ Grouped response type defined

---

### AC-2.26.12: Zod Validation Schemas
**Given** API needs validation
**When** Zod schemas defined
**Then** following schemas exist:

```typescript
// lib/validation/bom-item-schemas.ts
import { z } from 'zod'

export const createBomItemSchema = z.object({
  component_id: z.string().uuid(),
  operation_seq: z.number().int().positive(),
  is_output: z.boolean().optional().default(false),
  quantity: z.number().positive(),
  uom: z.string().min(1).max(10),
  scrap_percent: z.number().min(0).max(100).optional().default(0),
  sequence: z.number().int().positive().optional().default(1),
  line_ids: z.array(z.string().uuid()).min(1).optional(),
  consume_whole_lp: z.boolean().optional().default(false),
  notes: z.string().max(500).optional()
})

export const updateBomItemSchema = z.object({
  component_id: z.string().uuid().optional(),
  operation_seq: z.number().int().positive().optional(),
  is_output: z.boolean().optional(),
  quantity: z.number().positive().optional(),
  uom: z.string().min(1).max(10).optional(),
  scrap_percent: z.number().min(0).max(100).optional(),
  sequence: z.number().int().positive().optional(),
  line_ids: z.array(z.string().uuid()).min(1).nullable().optional(),
  consume_whole_lp: z.boolean().optional(),
  notes: z.string().max(500).nullable().optional()
})
```

**Success Criteria:**
- ✅ Schemas validate all fields
- ✅ line_ids requires min 1 if provided (not empty array)
- ✅ Default values set

---

## Technical Tasks

### Database

- [ ] Task 1: Create migration for bom_items restructure
  - [ ] Subtask 1.1: DROP IF EXISTS bom_items CASCADE
  - [ ] Subtask 1.2: CREATE bom_items table with new columns
  - [ ] Subtask 1.3: CREATE indexes (including GIN for line_ids)
  - [ ] Subtask 1.4: Enable RLS and create policy

### Backend

- [ ] Task 2: Create BomItemService
  - [ ] Subtask 2.1: Implement list() with optional grouping
  - [ ] Subtask 2.2: Implement create() with all validations
  - [ ] Subtask 2.3: Implement update() with validations
  - [ ] Subtask 2.4: Implement delete()
  - [ ] Subtask 2.5: Implement getInputsForOperation()
  - [ ] Subtask 2.6: Implement getOutputsForOperation()
  - [ ] Subtask 2.7: Implement getItemsForLine()
  - [ ] Subtask 2.8: Implement validateOperationSeq()
  - [ ] Subtask 2.9: Implement validateLineIds()
  - [ ] Subtask 2.10: Add component join in queries
  - [ ] Subtask 2.11: Add operation join in queries
  - [ ] Subtask 2.12: Add lines join in queries

- [ ] Task 3: Create TypeScript types
  - [ ] Subtask 3.1: Define BomItem interface
  - [ ] Subtask 3.2: Define CreateBomItemInput interface
  - [ ] Subtask 3.3: Define UpdateBomItemInput interface
  - [ ] Subtask 3.4: Define BomItemsByOperation interface

- [ ] Task 4: Create Zod validation schemas
  - [ ] Subtask 4.1: createBomItemSchema
  - [ ] Subtask 4.2: updateBomItemSchema

- [ ] Task 5: Create API endpoints
  - [ ] Subtask 5.1: GET /api/technical/boms/:id/items
  - [ ] Subtask 5.2: POST /api/technical/boms/:id/items
  - [ ] Subtask 5.3: PUT /api/technical/boms/:id/items/:itemId
  - [ ] Subtask 5.4: DELETE /api/technical/boms/:id/items/:itemId

### Testing

- [ ] Task 6: Unit tests - BomItemService
  - [ ] Subtask 6.1: Test list() returns items ordered by operation_seq, sequence
  - [ ] Subtask 6.2: Test list() with groupByOperation
  - [ ] Subtask 6.3: Test create() with all fields
  - [ ] Subtask 6.4: Test create() with is_output=true
  - [ ] Subtask 6.5: Test create() validates component exists
  - [ ] Subtask 6.6: Test create() validates operation_seq in routing
  - [ ] Subtask 6.7: Test create() validates line_ids in BOM
  - [ ] Subtask 6.8: Test create() rejects self-reference (input)
  - [ ] Subtask 6.9: Test create() allows self-reference (output)
  - [ ] Subtask 6.10: Test create() rejects empty line_ids array
  - [ ] Subtask 6.11: Test update() with partial data
  - [ ] Subtask 6.12: Test update() can clear line_ids to null
  - [ ] Subtask 6.13: Test delete() removes item
  - [ ] Subtask 6.14: Test getInputsForOperation()
  - [ ] Subtask 6.15: Test getOutputsForOperation()
  - [ ] Subtask 6.16: Test getItemsForLine()
  - [ ] Subtask 6.17: Target 95% coverage

- [ ] Task 7: Integration tests - API endpoints
  - [ ] Subtask 7.1: Test GET /api/technical/boms/:id/items (200)
  - [ ] Subtask 7.2: Test GET with group_by_operation (200)
  - [ ] Subtask 7.3: Test POST /api/technical/boms/:id/items (201)
  - [ ] Subtask 7.4: Test POST with invalid component (400)
  - [ ] Subtask 7.5: Test POST with invalid operation_seq (400)
  - [ ] Subtask 7.6: Test POST with invalid line_id (400)
  - [ ] Subtask 7.7: Test PUT /api/technical/boms/:id/items/:itemId (200)
  - [ ] Subtask 7.8: Test DELETE (200)
  - [ ] Subtask 7.9: Test BOM not found (404)
  - [ ] Subtask 7.10: Test item not found (404)
  - [ ] Subtask 7.11: Test auth required (401)
  - [ ] Subtask 7.12: Target 70% coverage

- [ ] Task 8: E2E tests - Full workflow
  - [ ] Subtask 8.1: Create BOM with routing
  - [ ] Subtask 8.2: Assign production lines to BOM
  - [ ] Subtask 8.3: Add input item to operation 1
  - [ ] Subtask 8.4: Add input item to operation 2
  - [ ] Subtask 8.5: Add output item (byproduct) to operation 2
  - [ ] Subtask 8.6: Verify items grouped by operation
  - [ ] Subtask 8.7: Update item with line_ids
  - [ ] Subtask 8.8: Verify line filter works
  - [ ] Subtask 8.9: Delete item
  - [ ] Subtask 8.10: Verify deleted

---

## Dependencies

### Requires (must exist before this story)
- Story 2.24: Routing Restructure (creates routing_operations for validation)
- Story 2.25: BOM Production Lines (creates bom_production_lines for validation)
- Batch 02A-1: Products Core (products table for component FK)

### Blocks (cannot start until this story done)
- Story 2.27: BOM Item Alternatives (alternative components)
- Story 2.29: Update existing BOM/Routing UI (UI for item management)
- Epic 4: Production Execution (material consumption per operation)

---

## Dev Notes

### Architecture Patterns
- **Operation grouping**: Items grouped by operation_seq for UI display
- **Input/Output separation**: is_output flag distinguishes consumption vs production
- **Line filtering**: line_ids enables line-specific BOM configurations
- **Array column**: line_ids as UUID[] with GIN index

### Key Decisions
- **operation_seq validation**: Only if BOM has routing assigned
- **Self-reference**: Allowed only for output items (main product)
- **line_ids null vs empty**: null = all lines, empty = invalid
- **sequence within operation**: For ordering multiple inputs per operation

### Constraints
- component_id must exist in products
- operation_seq must exist in routing (if routing assigned)
- line_ids must be subset of BOM's production_lines
- quantity > 0 for all items
- scrap_percent: 0-100 (percentage)

### Query Patterns
```sql
-- Get items for specific line
SELECT * FROM bom_items
WHERE bom_id = $1
  AND (line_ids IS NULL OR $2 = ANY(line_ids))
ORDER BY operation_seq, sequence;

-- Get inputs for operation
SELECT * FROM bom_items
WHERE bom_id = $1
  AND operation_seq = $2
  AND is_output = false
ORDER BY sequence;
```

### Production Use Case
```
BOM: Product A
├── Operation 1: Mixing
│   ├── INPUT: Raw Material X (qty: 10 kg)
│   ├── INPUT: Raw Material Y (qty: 5 kg, line_ids: [Line1])
│   └── OUTPUT: Semi-finished Z (byproduct)
├── Operation 2: Packaging
│   ├── INPUT: Semi-finished (from op 1)
│   ├── INPUT: Packaging Material (consume_whole_lp: true)
│   └── OUTPUT: Product A (main product)
```

---

## Status

- **Created:** 2025-11-30
- **Current Status:** Todo
- **Blocked By:** Stories 2.24, 2.25 (schema dependencies)
