<?xml version="1.0" encoding="UTF-8"?>
<story>
  <metadata>
    <id>2.26</id>
    <title>BOM Items with Operation Assignment</title>
    <batch>02A-2-bom-restructure</batch>
    <points>5</points>
    <effort_hours>16-24</effort_hours>
    <priority>P0</priority>
    <status>todo</status>
  </metadata>

  <description>
    Restructure BOM items to support operation assignment, output items (byproducts),
    consumption sequencing, and line-specific item configurations.
    BREAKING CHANGE: Drops and recreates bom_items table with extended columns.
  </description>

  <dependencies>
    <blocks>
      <story id="2.27">BOM Item Alternatives</story>
      <story id="2.29">Update existing BOM/Routing UI</story>
    </blocks>
    <requires>
      <story id="2.24">Routing Restructure (routing_operations for validation)</story>
      <story id="2.25">BOM Production Lines (for line_ids validation)</story>
    </requires>
  </dependencies>

  <technical_context>
    <tables>
      <table>
        <name>bom_items</name>
        <action>DROP CASCADE then CREATE</action>
        <columns>
          <column name="id" type="UUID" nullable="false" default="gen_random_uuid()" pk="true"/>
          <column name="bom_id" type="UUID" nullable="false" fk="boms(id) ON DELETE CASCADE"/>
          <column name="component_id" type="UUID" nullable="false" fk="products(id)"/>
          <column name="operation_seq" type="INTEGER" nullable="false" default="1"/>
          <column name="is_output" type="BOOLEAN" nullable="false" default="false"/>
          <column name="quantity" type="DECIMAL(15,4)" nullable="false"/>
          <column name="uom" type="TEXT" nullable="false"/>
          <column name="scrap_percent" type="DECIMAL(5,2)" nullable="false" default="0"/>
          <column name="sequence" type="INTEGER" nullable="false" default="1"/>
          <column name="line_ids" type="UUID[]" nullable="true"/>
          <column name="consume_whole_lp" type="BOOLEAN" nullable="false" default="false"/>
          <column name="notes" type="TEXT" nullable="true"/>
          <column name="created_at" type="TIMESTAMPTZ" nullable="false" default="now()"/>
        </columns>
        <indexes>
          <index name="idx_bom_items_bom" columns="bom_id"/>
          <index name="idx_bom_items_component" columns="component_id"/>
          <index name="idx_bom_items_operation" columns="bom_id, operation_seq"/>
          <index name="idx_bom_items_line_ids" columns="line_ids" type="GIN"/>
        </indexes>
        <rls enabled="true">
          <policy name="Enable all for authenticated" operation="ALL" role="authenticated"/>
        </rls>
        <notes>
          NEW columns: operation_seq, is_output, sequence, line_ids, consume_whole_lp
          line_ids uses GIN index for array containment queries
        </notes>
      </table>
    </tables>

    <api_endpoints>
      <endpoint method="GET" path="/api/technical/boms/:id/items">
        <description>List items for BOM, optionally grouped by operation</description>
        <query_params>
          <param name="group_by_operation" type="boolean" required="false" default="false"/>
        </query_params>
        <response status="200">
          <when condition="group_by_operation=false">Array of BomItem objects</when>
          <when condition="group_by_operation=true">
            <field name="operations" type="array">
              <item>
                <field name="operation_seq" type="number"/>
                <field name="operation_name" type="string | null"/>
                <field name="inputs" type="BomItem[]"/>
                <field name="outputs" type="BomItem[]"/>
              </item>
            </field>
          </when>
        </response>
      </endpoint>

      <endpoint method="POST" path="/api/technical/boms/:id/items">
        <description>Add item to BOM</description>
        <body>
          <field name="component_id" type="uuid" required="true"/>
          <field name="operation_seq" type="integer" required="true" min="1"/>
          <field name="is_output" type="boolean" required="false" default="false"/>
          <field name="quantity" type="decimal" required="true" min="0.0001"/>
          <field name="uom" type="string" required="true" max="10"/>
          <field name="scrap_percent" type="decimal" required="false" default="0" max="100"/>
          <field name="sequence" type="integer" required="false" default="1"/>
          <field name="line_ids" type="uuid[]" required="false"/>
          <field name="consume_whole_lp" type="boolean" required="false" default="false"/>
          <field name="notes" type="string" required="false"/>
        </body>
        <response status="201">Created BomItem with joined component/lines</response>
        <errors>
          <error code="INVALID_COMPONENT" status="400"/>
          <error code="INVALID_OPERATION_SEQ" status="400" message="Operation not found in routing"/>
          <error code="INVALID_LINE" status="400"/>
          <error code="LINE_NOT_IN_BOM" status="400"/>
          <error code="SELF_REFERENCE" status="400" message="Cannot use BOM product as input"/>
          <error code="BOM_NOT_FOUND" status="404"/>
        </errors>
      </endpoint>

      <endpoint method="PUT" path="/api/technical/boms/:id/items/:itemId">
        <description>Update BOM item</description>
        <body>
          <field name="component_id" type="uuid" required="false"/>
          <field name="operation_seq" type="integer" required="false"/>
          <field name="is_output" type="boolean" required="false"/>
          <field name="quantity" type="decimal" required="false"/>
          <field name="uom" type="string" required="false"/>
          <field name="scrap_percent" type="decimal" required="false"/>
          <field name="sequence" type="integer" required="false"/>
          <field name="line_ids" type="uuid[] | null" required="false"/>
          <field name="consume_whole_lp" type="boolean" required="false"/>
          <field name="notes" type="string | null" required="false"/>
        </body>
        <response status="200">Updated BomItem</response>
        <errors>
          <error code="ITEM_NOT_FOUND" status="404"/>
        </errors>
      </endpoint>

      <endpoint method="DELETE" path="/api/technical/boms/:id/items/:itemId">
        <description>Delete BOM item</description>
        <response status="200">Success message</response>
        <errors>
          <error code="ITEM_NOT_FOUND" status="404"/>
        </errors>
      </endpoint>
    </api_endpoints>

    <services>
      <service name="BomItemService" path="lib/services/bom-item-service.ts">
        <method name="list" params="bomId: string, options?: { groupByOperation?: boolean }" returns="Promise&lt;BomItem[] | BomItemsByOperation[]&gt;"/>
        <method name="create" params="bomId: string, data: CreateBomItemInput" returns="Promise&lt;BomItem&gt;"/>
        <method name="update" params="bomId: string, itemId: string, data: UpdateBomItemInput" returns="Promise&lt;BomItem&gt;"/>
        <method name="delete" params="bomId: string, itemId: string" returns="Promise&lt;void&gt;"/>
        <method name="getInputsForOperation" params="bomId: string, operationSeq: number" returns="Promise&lt;BomItem[]&gt;"/>
        <method name="getOutputsForOperation" params="bomId: string, operationSeq: number" returns="Promise&lt;BomItem[]&gt;"/>
        <method name="getItemsForLine" params="bomId: string, lineId: string" returns="Promise&lt;BomItem[]&gt;"/>
        <method name="validateOperationSeq" params="bomId: string, operationSeq: number" returns="Promise&lt;boolean&gt;"/>
        <method name="validateLineIds" params="bomId: string, lineIds: string[]" returns="Promise&lt;boolean&gt;"/>
      </service>
    </services>

    <types>
      <type name="BomItem">
        <field name="id" type="string"/>
        <field name="bom_id" type="string"/>
        <field name="component_id" type="string"/>
        <field name="component" type="Product" optional="true"/>
        <field name="operation_seq" type="number"/>
        <field name="operation" type="{ sequence: number; name: string }" optional="true"/>
        <field name="is_output" type="boolean"/>
        <field name="quantity" type="number"/>
        <field name="uom" type="string"/>
        <field name="scrap_percent" type="number"/>
        <field name="sequence" type="number"/>
        <field name="line_ids" type="string[] | null"/>
        <field name="lines" type="Array&lt;{ id: string; name: string }&gt;" optional="true"/>
        <field name="consume_whole_lp" type="boolean"/>
        <field name="notes" type="string | null"/>
        <field name="created_at" type="string"/>
      </type>

      <type name="BomItemsByOperation">
        <field name="operation_seq" type="number"/>
        <field name="operation_name" type="string | null"/>
        <field name="inputs" type="BomItem[]"/>
        <field name="outputs" type="BomItem[]"/>
      </type>

      <type name="CreateBomItemInput">
        <field name="component_id" type="string"/>
        <field name="operation_seq" type="number"/>
        <field name="is_output" type="boolean" optional="true"/>
        <field name="quantity" type="number"/>
        <field name="uom" type="string"/>
        <field name="scrap_percent" type="number" optional="true"/>
        <field name="sequence" type="number" optional="true"/>
        <field name="line_ids" type="string[]" optional="true"/>
        <field name="consume_whole_lp" type="boolean" optional="true"/>
        <field name="notes" type="string" optional="true"/>
      </type>
    </types>

    <validation_schemas>
      <schema name="createBomItemSchema">
        <field name="component_id" rule="z.string().uuid()"/>
        <field name="operation_seq" rule="z.number().int().positive()"/>
        <field name="is_output" rule="z.boolean().optional().default(false)"/>
        <field name="quantity" rule="z.number().positive()"/>
        <field name="uom" rule="z.string().min(1).max(10)"/>
        <field name="scrap_percent" rule="z.number().min(0).max(100).optional().default(0)"/>
        <field name="sequence" rule="z.number().int().positive().optional().default(1)"/>
        <field name="line_ids" rule="z.array(z.string().uuid()).min(1).optional()"/>
        <field name="consume_whole_lp" rule="z.boolean().optional().default(false)"/>
        <field name="notes" rule="z.string().max(500).optional()"/>
      </schema>
    </validation_schemas>

    <query_patterns>
      <pattern name="items_for_line">
        <sql>
          SELECT * FROM bom_items
          WHERE bom_id = $1
            AND (line_ids IS NULL OR $2 = ANY(line_ids))
          ORDER BY operation_seq, sequence
        </sql>
        <description>Get items applicable to specific line (null = all lines)</description>
      </pattern>

      <pattern name="inputs_for_operation">
        <sql>
          SELECT * FROM bom_items
          WHERE bom_id = $1
            AND operation_seq = $2
            AND is_output = false
          ORDER BY sequence
        </sql>
      </pattern>
    </query_patterns>
  </technical_context>

  <acceptance_criteria>
    <ac id="2.26.1">Drop and create bom_items table with all new columns</ac>
    <ac id="2.26.2">Enable RLS with authenticated policy</ac>
    <ac id="2.26.3">GET /api/technical/boms/:id/items with optional grouping</ac>
    <ac id="2.26.4">POST /api/technical/boms/:id/items with all validations</ac>
    <ac id="2.26.5">PUT /api/technical/boms/:id/items/:itemId updates item</ac>
    <ac id="2.26.6">DELETE /api/technical/boms/:id/items/:itemId removes item</ac>
    <ac id="2.26.7">Validation: component exists, operation in routing, lines in BOM</ac>
    <ac id="2.26.8">operation_seq validated against routing if BOM has routing</ac>
    <ac id="2.26.9">line_ids must be subset of BOM's production_lines</ac>
    <ac id="2.26.10">Implement BomItemService with all methods</ac>
    <ac id="2.26.11">Define TypeScript types for BomItem and grouped response</ac>
    <ac id="2.26.12">Create Zod validation schemas</ac>
  </acceptance_criteria>

  <test_plan>
    <unit_tests target="95%">
      <test>list() returns items ordered by operation_seq, sequence</test>
      <test>list() with groupByOperation groups correctly</test>
      <test>create() with all fields succeeds</test>
      <test>create() with is_output=true allowed</test>
      <test>create() validates component exists</test>
      <test>create() validates operation_seq in routing</test>
      <test>create() validates line_ids in BOM</test>
      <test>create() rejects self-reference for input</test>
      <test>create() allows self-reference for output</test>
      <test>create() rejects empty line_ids array</test>
      <test>update() with partial data</test>
      <test>update() can clear line_ids to null</test>
      <test>delete() removes item</test>
      <test>getInputsForOperation() returns only inputs</test>
      <test>getOutputsForOperation() returns only outputs</test>
      <test>getItemsForLine() filters correctly</test>
    </unit_tests>

    <integration_tests target="70%">
      <test>All item endpoints return correct status codes</test>
      <test>Invalid component returns 400</test>
      <test>Invalid operation_seq returns 400</test>
      <test>Invalid line_id returns 400</test>
      <test>BOM not found returns 404</test>
      <test>Item not found returns 404</test>
      <test>Auth required (401)</test>
    </integration_tests>

    <e2e_tests>
      <test>Create BOM with routing</test>
      <test>Assign production lines to BOM</test>
      <test>Add input item to operation 1</test>
      <test>Add input item to operation 2</test>
      <test>Add output item (byproduct) to operation 2</test>
      <test>Verify items grouped by operation</test>
      <test>Update item with line_ids</test>
      <test>Verify line filter works</test>
      <test>Delete item</test>
    </e2e_tests>
  </test_plan>

  <implementation_notes>
    <note type="breaking">BREAKING migration - all existing bom_items data will be lost</note>
    <note type="pattern">Operation grouping: items grouped by operation_seq for UI display</note>
    <note type="validation">operation_seq only validated if BOM has routing assigned</note>
    <note type="validation">Self-reference: allowed only for output items (main product)</note>
    <note type="validation">line_ids null = all lines, empty array = invalid</note>
    <note type="index">GIN index on line_ids for array containment queries</note>
  </implementation_notes>
</story>
