# Story 2.25: BOM Production Lines

**Epic:** 2 - Technical/Products
**Batch:** 02A-2-bom-restructure
**Status:** Todo
**Priority:** P0 (Required for multi-line production)
**Story Points:** 3
**Created:** 2025-11-30
**Effort Estimate:** 1-2 days

---

## Goal

Enable BOMs to be assigned to multiple production lines, allowing the same product to be manufactured on different lines with line-specific labor costs.

## User Story

**As a** Production Engineer
**I want** to assign a BOM to multiple production lines with optional labor costs per line
**So that** I can plan production on any available line and track line-specific labor costs

---

## Problem Statement

Current BOM structure doesn't support:
1. Multi-line production (one product, multiple possible lines)
2. Line-specific labor cost overrides
3. Flexible production scheduling across lines

New structure enables:
1. Many-to-many relationship: BOM ↔ Production Lines
2. Optional labor_cost_per_hour override per line assignment
3. BOM items can specify which lines they apply to (Story 2.26)

---

## Breaking Changes

**CRITICAL:** This story involves schema changes:
- DROP existing `bom_production_lines` table if exists
- CREATE new `bom_production_lines` junction table
- Existing BOM-line assignments will be lost (acceptable for dev)

---

## Acceptance Criteria

### AC-2.25.1: Create BOM Production Lines Table
**Given** boms table exists (after restructure)
**When** migration runs
**Then** `bom_production_lines` table is created:
```sql
CREATE TABLE bom_production_lines (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  bom_id UUID NOT NULL REFERENCES boms(id) ON DELETE CASCADE,
  line_id UUID NOT NULL REFERENCES production_lines(id),
  labor_cost_per_hour DECIMAL(10,2),
  created_at TIMESTAMPTZ DEFAULT now(),
  UNIQUE(bom_id, line_id)
);

CREATE INDEX idx_bom_production_lines_bom ON bom_production_lines(bom_id);
CREATE INDEX idx_bom_production_lines_line ON bom_production_lines(line_id);
```

**Success Criteria:**
- ✅ Junction table created with all columns
- ✅ bom_id FK with ON DELETE CASCADE
- ✅ line_id FK to production_lines
- ✅ UNIQUE constraint on (bom_id, line_id)
- ✅ labor_cost_per_hour optional (nullable)
- ✅ Indexes for query performance

---

### AC-2.25.2: RLS Policy
**Given** table is created
**When** RLS configured
**Then** policy enables authenticated access:
```sql
ALTER TABLE bom_production_lines ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Enable all for authenticated" ON bom_production_lines
  FOR ALL TO authenticated USING (true) WITH CHECK (true);
```

**Success Criteria:**
- ✅ RLS enabled
- ✅ Authenticated users have full CRUD
- ✅ Anonymous users blocked

---

### AC-2.25.3: Get BOM Lines Endpoint
**Given** BOM exists with line assignments
**When** fetching BOM lines
**Then** endpoint returns assigned lines:

**GET /api/technical/boms/:id/lines**
```typescript
Response (200): {
  data: [{
    id: uuid,                          // bom_production_lines.id
    bom_id: uuid,
    line_id: uuid,
    line: {                            // Joined production_lines data
      id: uuid,
      name: string,
      warehouse_id: uuid,
      warehouse: { id: uuid, name: string }
    },
    labor_cost_per_hour: number | null, // Override cost
    created_at: timestamp
  }]
}
Error (404): { error: "BOM_NOT_FOUND" }
```

**Success Criteria:**
- ✅ Returns all lines assigned to BOM
- ✅ Includes production_line details (join)
- ✅ Includes warehouse info for context
- ✅ labor_cost_per_hour shown if set

---

### AC-2.25.4: Update BOM Lines Endpoint (Bulk Replace)
**Given** BOM exists
**When** updating line assignments
**Then** endpoint replaces all assignments:

**PUT /api/technical/boms/:id/lines**
```typescript
Request: {
  lines: [{
    line_id: uuid,                     // Required
    labor_cost_per_hour?: number       // Optional override
  }]
}

Response (200): {
  data: [{
    id: uuid,
    line_id: uuid,
    line: { id: uuid, name: string, ... },
    labor_cost_per_hour: number | null
  }],
  message: "BOM lines updated successfully"
}

Error (400): { error: "INVALID_LINE", message: "Line {id} not found" }
Error (400): { error: "DUPLICATE_LINE", message: "Line {id} appears multiple times" }
Error (404): { error: "BOM_NOT_FOUND" }
```

**Behavior:**
1. DELETE all existing bom_production_lines for this BOM
2. INSERT new records from request
3. Return updated list with joined line data

**Success Criteria:**
- ✅ Bulk replace (not add/remove)
- ✅ Validates all line_ids exist
- ✅ Validates no duplicate line_ids in request
- ✅ labor_cost_per_hour stored if provided
- ✅ Atomic transaction (all or nothing)

---

### AC-2.25.5: Validation Rules
**Given** API receives line assignments
**When** validating data
**Then** following rules enforced:

| Field | Rule | Error Code |
|-------|------|------------|
| line_id | Required, must exist | INVALID_LINE |
| line_id | No duplicates in request | DUPLICATE_LINE |
| line_id | Must belong to same org | INVALID_LINE_ORG |
| labor_cost_per_hour | 0-9999.99 if provided | INVALID_LABOR_COST |
| lines array | Can be empty (removes all) | - |

**Success Criteria:**
- ✅ All validations return specific error codes
- ✅ Cross-org assignment prevented
- ✅ Empty array clears all assignments

---

### AC-2.25.6: Include Lines in BOM Response
**Given** BOM is fetched with details
**When** GET /api/technical/boms/:id
**Then** response includes production lines:
```typescript
Response (200): {
  data: {
    id: uuid,
    product_id: uuid,
    routing_id: uuid | null,
    // ... other BOM fields ...
    production_lines: [{              // NEW: Include lines
      id: uuid,
      line_id: uuid,
      line: { id: uuid, name: string },
      labor_cost_per_hour: number | null
    }],
    items: [...]                      // Existing items
  }
}
```

**Success Criteria:**
- ✅ production_lines included in BOM detail
- ✅ Eager loaded in single query (JOIN)
- ✅ Optional in list endpoint (for performance)

---

### AC-2.25.7: BOM Service Methods
**Given** BomService exists
**When** line operations needed
**Then** following methods available:

```typescript
// lib/services/bom-service.ts (additions)
class BomService {
  // Existing methods...

  // Production Lines
  async getProductionLines(bomId: string): Promise<BomProductionLine[]>
  async setProductionLines(
    bomId: string,
    lines: Array<{ line_id: string; labor_cost_per_hour?: number }>
  ): Promise<BomProductionLine[]>

  // Helper: Get labor cost for specific line
  async getLaborCostForLine(bomId: string, lineId: string): Promise<number | null>

  // Helper: Get all lines available for BOM (org-filtered)
  async getAvailableLines(orgId: string): Promise<ProductionLine[]>
}
```

**Success Criteria:**
- ✅ Service methods implemented
- ✅ org_id isolation enforced
- ✅ Transaction support for setProductionLines
- ✅ Helper methods for common queries

---

### AC-2.25.8: TypeScript Types
**Given** schema is defined
**When** types generated
**Then** following types exist:

```typescript
// types/bom.ts (additions)
interface BomProductionLine {
  id: string
  bom_id: string
  line_id: string
  line?: ProductionLine
  labor_cost_per_hour: number | null
  created_at: string
}

interface SetBomLinesInput {
  lines: Array<{
    line_id: string
    labor_cost_per_hour?: number
  }>
}

// Extended BOM interface
interface BomWithLines extends Bom {
  production_lines: BomProductionLine[]
}
```

**Success Criteria:**
- ✅ BomProductionLine type defined
- ✅ Input type for update operation
- ✅ Extended BOM type with lines

---

### AC-2.25.9: Zod Validation Schema
**Given** API needs validation
**When** Zod schema defined
**Then** following schema exists:

```typescript
// lib/validation/bom-schemas.ts (additions)
import { z } from 'zod'

export const bomProductionLineItemSchema = z.object({
  line_id: z.string().uuid(),
  labor_cost_per_hour: z.number().min(0).max(9999.99).optional()
})

export const setBomLinesSchema = z.object({
  lines: z.array(bomProductionLineItemSchema)
    .refine(
      (lines) => {
        const ids = lines.map(l => l.line_id)
        return new Set(ids).size === ids.length
      },
      { message: "Duplicate line_id values not allowed" }
    )
})
```

**Success Criteria:**
- ✅ Schema validates line_id format
- ✅ Schema validates labor_cost range
- ✅ Schema checks for duplicate line_ids

---

### AC-2.25.10: Labor Cost Calculation Helper
**Given** BOM is assigned to multiple lines
**When** calculating production costs
**Then** helper function available:

```typescript
// lib/services/bom-service.ts
async calculateLaborCost(
  bomId: string,
  lineId: string,
  batchSize: number
): Promise<{
  total_labor_cost: number,
  breakdown: Array<{
    operation_seq: number,
    operation_name: string,
    duration_minutes: number,
    cost_per_hour: number,
    cost: number
  }>
}>
```

**Logic:**
1. Get BOM's routing operations
2. Get labor_cost_per_hour from:
   - bom_production_lines.labor_cost_per_hour (line override), OR
   - routing_operations.labor_cost_per_hour (default)
3. Calculate: `(duration_minutes / 60) * labor_cost_per_hour * batchSize`

**Success Criteria:**
- ✅ Line-specific cost used if set
- ✅ Falls back to routing operation cost
- ✅ Breakdown by operation provided
- ✅ Handles null costs (0)

---

## Technical Tasks

### Database

- [ ] Task 1: Create migration for bom_production_lines
  - [ ] Subtask 1.1: DROP IF EXISTS bom_production_lines CASCADE
  - [ ] Subtask 1.2: CREATE bom_production_lines table
  - [ ] Subtask 1.3: CREATE indexes
  - [ ] Subtask 1.4: Enable RLS and create policy

### Backend

- [ ] Task 2: Update BomService with line methods
  - [ ] Subtask 2.1: Implement getProductionLines()
  - [ ] Subtask 2.2: Implement setProductionLines() with transaction
  - [ ] Subtask 2.3: Implement getLaborCostForLine()
  - [ ] Subtask 2.4: Implement getAvailableLines()
  - [ ] Subtask 2.5: Implement calculateLaborCost()
  - [ ] Subtask 2.6: Add validation for line_id existence
  - [ ] Subtask 2.7: Add validation for org_id match

- [ ] Task 3: Create TypeScript types
  - [ ] Subtask 3.1: Define BomProductionLine interface
  - [ ] Subtask 3.2: Define SetBomLinesInput interface
  - [ ] Subtask 3.3: Define BomWithLines interface
  - [ ] Subtask 3.4: Update Bom interface with optional production_lines

- [ ] Task 4: Create Zod validation schemas
  - [ ] Subtask 4.1: bomProductionLineItemSchema
  - [ ] Subtask 4.2: setBomLinesSchema with duplicate check

- [ ] Task 5: Create API endpoints
  - [ ] Subtask 5.1: GET /api/technical/boms/:id/lines
  - [ ] Subtask 5.2: PUT /api/technical/boms/:id/lines
  - [ ] Subtask 5.3: Update GET /api/technical/boms/:id to include lines

### Testing

- [ ] Task 6: Unit tests - BomService (line methods)
  - [ ] Subtask 6.1: Test getProductionLines() returns correct data
  - [ ] Subtask 6.2: Test setProductionLines() replaces all lines
  - [ ] Subtask 6.3: Test setProductionLines() with empty array
  - [ ] Subtask 6.4: Test setProductionLines() with labor_cost override
  - [ ] Subtask 6.5: Test invalid line_id error
  - [ ] Subtask 6.6: Test duplicate line_id error
  - [ ] Subtask 6.7: Test cross-org line assignment blocked
  - [ ] Subtask 6.8: Test calculateLaborCost() with line override
  - [ ] Subtask 6.9: Test calculateLaborCost() with routing default
  - [ ] Subtask 6.10: Target 95% coverage

- [ ] Task 7: Integration tests - API endpoints
  - [ ] Subtask 7.1: Test GET /api/technical/boms/:id/lines (200)
  - [ ] Subtask 7.2: Test PUT /api/technical/boms/:id/lines (200)
  - [ ] Subtask 7.3: Test PUT with invalid line_id (400)
  - [ ] Subtask 7.4: Test PUT with duplicate line_id (400)
  - [ ] Subtask 7.5: Test BOM not found (404)
  - [ ] Subtask 7.6: Test org_id isolation
  - [ ] Subtask 7.7: Test auth required (401)
  - [ ] Subtask 7.8: Target 70% coverage

- [ ] Task 8: E2E tests - Full workflow
  - [ ] Subtask 8.1: Create BOM
  - [ ] Subtask 8.2: Assign 2 production lines via PUT
  - [ ] Subtask 8.3: Verify GET returns both lines
  - [ ] Subtask 8.4: Update to 1 line (remove one)
  - [ ] Subtask 8.5: Verify only 1 line remains
  - [ ] Subtask 8.6: Clear all lines (empty array)
  - [ ] Subtask 8.7: Verify no lines assigned
  - [ ] Subtask 8.8: Test labor_cost_per_hour override

---

## Dependencies

### Requires (must exist before this story)
- Story 2.24: Routing Restructure (boms table with new schema)
- Story 1.8: Production Line Configuration (production_lines table)

### Blocks (cannot start until this story done)
- Story 2.26: BOM Items with Operation Assignment (uses line_ids)
- Story 2.29: Update existing BOM/Routing UI (UI for line selection)

---

## Dev Notes

### Architecture Patterns
- **Junction table**: Many-to-many via bom_production_lines
- **Bulk replace**: PUT replaces all, not PATCH individual
- **Optional override**: labor_cost_per_hour overrides routing default
- **Cascade delete**: Lines removed when BOM deleted

### Key Decisions
- **Bulk replace approach**: Simpler than add/remove/update individual
- **Labor cost hierarchy**: Line override > Routing operation default > 0
- **Empty lines allowed**: BOM can have no assigned lines
- **Line validation**: Must belong to same org as BOM

### Constraints
- line_id must exist in production_lines
- line_id must belong to same org as BOM
- No duplicate (bom_id, line_id) combinations
- labor_cost_per_hour: decimal(10,2), 0-9999.99

### Data Flow
```
BOM Creation → Assign Lines → WO uses BOM → WO copies line options
              ↓
         labor_cost calculated from:
         1. bom_production_lines.labor_cost_per_hour (if set)
         2. routing_operations.labor_cost_per_hour (fallback)
```

---

## Status

- **Created:** 2025-11-30
- **Current Status:** Todo
- **Blocked By:** Story 2.24 (Routing Restructure - creates boms table)
