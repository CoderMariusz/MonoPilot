<?xml version="1.0" encoding="UTF-8"?>
<story>
  <metadata>
    <id>5.14</id>
    <title>LP Location Move</title>
    <batch>5B-1</batch>
    <points>5</points>
    <effort_hours>5-6</effort_hours>
    <status>todo</status>
  </metadata>

  <description>Record LP movements between locations with immutable audit trail and movement type classification</description>

  <dependencies>
    <requires>
      <story id="5.1">License Plate Creation</story>
      <story id="5.11">GRN and LP Creation</story>
    </requires>
    <enables>
      <story id="5.15">Movement Audit Trail</story>
      <story id="5.16">Partial Move</story>
      <story id="5.21">Pallet Move</story>
    </enables>
  </dependencies>

  <technical_context>
    <tables>
      <table>
        <name>stock_moves</name>
        <columns>
          <column name="id" type="UUID" constraint="PK, DEFAULT gen_random_uuid()"/>
          <column name="org_id" type="UUID" constraint="NOT NULL, FK organizations(id)"/>
          <column name="lp_id" type="UUID" constraint="NOT NULL, FK license_plates(id)"/>
          <column name="from_location_id" type="UUID" constraint="FK locations(id)"/>
          <column name="to_location_id" type="UUID" constraint="NOT NULL, FK locations(id)"/>
          <column name="movement_type" type="VARCHAR(20)" constraint="NOT NULL, CHECK IN ('receiving','put_away','pick','transfer','adjustment')"/>
          <column name="quantity" type="DECIMAL(15,4)" constraint="NOT NULL"/>
          <column name="uom" type="VARCHAR(10)" constraint="NOT NULL"/>
          <column name="reason" type="TEXT"/>
          <column name="moved_at" type="TIMESTAMP" constraint="DEFAULT now()"/>
          <column name="moved_by_user_id" type="UUID" constraint="NOT NULL, FK users(id)"/>
          <column name="created_at" type="TIMESTAMP" constraint="DEFAULT now()"/>
        </columns>
        <indexes>
          <index name="idx_stock_moves_org_id" columns="org_id"/>
          <index name="idx_stock_moves_lp_id" columns="lp_id"/>
          <index name="idx_stock_moves_from_location" columns="from_location_id"/>
          <index name="idx_stock_moves_to_location" columns="to_location_id"/>
          <index name="idx_stock_moves_movement_type" columns="movement_type"/>
          <index name="idx_stock_moves_moved_at" columns="moved_at DESC"/>
          <index name="idx_stock_moves_moved_by" columns="moved_by_user_id"/>
        </indexes>
      </table>
      <table>
        <name>locations</name>
        <columns>
          <column name="id" type="UUID" constraint="PK"/>
          <column name="org_id" type="UUID" constraint="NOT NULL, FK organizations(id)"/>
          <column name="code" type="VARCHAR(50)" constraint="NOT NULL, UNIQUE(org_id, code)"/>
          <column name="name" type="VARCHAR(100)" constraint="NOT NULL"/>
          <column name="location_type" type="VARCHAR(20)" constraint="CHECK IN ('receiving','storage','production','shipping','quarantine')"/>
          <column name="warehouse_id" type="UUID" constraint="NOT NULL, FK warehouses(id)"/>
          <column name="is_active" type="BOOLEAN" constraint="DEFAULT true"/>
          <column name="allows_storage" type="BOOLEAN" constraint="DEFAULT true"/>
        </columns>
      </table>
    </tables>

    <api_endpoints>
      <endpoint method="POST" path="/api/warehouse/stock-moves">
        <description>Record LP movement between locations with validation</description>
        <auth>authenticated</auth>
        <request>
          <field name="lp_id" type="UUID" required="true"/>
          <field name="to_location_id" type="UUID" required="true"/>
          <field name="movement_type" type="enum" required="true" constraint="receiving|put_away|pick|transfer|adjustment"/>
          <field name="reason" type="string" required="false"/>
          <field name="quantity" type="decimal" required="false" constraint="if provided, <= current LP qty"/>
        </request>
        <response status="201">
          <field name="stock_move_id" type="UUID"/>
          <field name="lp_id" type="UUID"/>
          <field name="from_location" type="object">
            <field name="id" type="UUID"/>
            <field name="code" type="string"/>
            <field name="name" type="string"/>
          </field>
          <field name="to_location" type="object">
            <field name="id" type="UUID"/>
            <field name="code" type="string"/>
            <field name="name" type="string"/>
          </field>
          <field name="movement_type" type="string"/>
          <field name="quantity" type="decimal"/>
          <field name="moved_at" type="timestamp"/>
          <field name="moved_by_user_id" type="UUID"/>
        </response>
        <response status="400">
          <field name="error" type="string" example="Location WH-A-01 does not allow destination movements"/>
        </response>
      </endpoint>
      <endpoint method="POST" path="/api/warehouse/license-plates/:id/move">
        <description>Alternative endpoint: Move LP via license-plates resource</description>
        <request>to_location_id, movement_type, reason (optional)</request>
        <response>stock_move_id, location update confirmation</response>
      </endpoint>
    </api_endpoints>

    <validation_rules>
      <rule id="lp_exists">LP must exist in database</rule>
      <rule id="lp_org">LP must belong to current org_id</rule>
      <rule id="location_exists">to_location_id must exist</rule>
      <rule id="location_org">Location must belong to current org_id</rule>
      <rule id="location_active">Location.is_active = true</rule>
      <rule id="location_type_valid">Location type must match movement_type:
        - put_away: type = 'storage'
        - pick: type IN ('production', 'shipping')
        - transfer: type = 'storage'
        - adjustment: any type allowed
      </rule>
      <rule id="movement_type_valid">movement_type must be valid enum</rule>
      <rule id="qty_valid">quantity (if provided) must be > 0 and <= current LP qty</rule>
    </validation_rules>

    <components>
      <component name="MoveLocationModal">
        <props>lp: LicensePlate, onMove: callback</props>
        <fields>
          - Current LP (read-only)
          - Current location (read-only)
          - Destination location (required, dropdown filtered by is_active=true, location_type)
          - Movement type (required, selector with descriptions)
          - Reason (optional, text field)
        </fields>
        <actions>validate, submit, onSuccess (close modal, show toast)</actions>
      </component>
    </components>

    <hooks>
      <hook name="useMoveLP">
        <accepts>lp_id, to_location_id, movement_type, reason (optional)</accepts>
        <returns>{ stock_move, loading, error }</returns>
        <api_call>POST /api/warehouse/stock-moves</api_call>
      </hook>
    </hooks>

    <movement_type_constraints>
      <type name="receiving">
        <from>Receiving dock</from>
        <to>Storage location</to>
        <validation>from_location.type='receiving', to_location.type='storage'</validation>
      </type>
      <type name="put_away">
        <from>Receiving area</from>
        <to>Storage</to>
        <validation>to_location.type = 'storage'</validation>
        <note>Auto-assigned when GRN created</note>
      </type>
      <type name="pick">
        <from>Storage</from>
        <to>Production or Shipping</to>
        <validation>to_location.type IN ('production', 'shipping')</validation>
      </type>
      <type name="transfer">
        <from>Storage</from>
        <to>Storage (same warehouse)</to>
        <validation>both type='storage', same warehouse_id</validation>
      </type>
      <type name="adjustment">
        <from>Any</from>
        <to>Any</to>
        <validation>reason required (damage, sample, recount)</validation>
      </type>
    </movement_type_constraints>

    <rls_policies>
      <policy table="stock_moves">
        <select>WHERE org_id = current_user.org_id</select>
        <insert>WHERE org_id = current_user.org_id</insert>
        <update>WHERE org_id = current_user.org_id</update>
      </policy>
    </rls_policies>
  </technical_context>

  <acceptance_criteria>
    <ac id="1" title="Move Modal">
      <test>Open LP detail, click Move → modal shows current LP, location, destination selector</test>
    </ac>
    <ac id="2" title="Location Validation">
      <test>Try to move to inactive location → filtered from dropdown</test>
      <test>Try to move to wrong location type for movement_type → error</test>
    </ac>
    <ac id="3" title="Stock Move Record">
      <test>Submit move → stock_moves record created with lp_id, from/to locations, movement_type, qty</test>
    </ac>
    <ac id="4" title="LP Location Update">
      <test>After move, LP.location_id updated to new location</test>
    </ac>
    <ac id="5" title="Success Feedback">
      <test>After move succeeds, toast shows "LP-001 moved from WH-A to WH-B"</test>
    </ac>
    <ac id="6" title="Movement Type Logic">
      <test>put_away: destination must be storage</test>
      <test>pick: destination must be production/shipping</test>
      <test>transfer: both must be storage, same warehouse</test>
    </ac>
  </acceptance_criteria>

  <test_plan>
    <unit_tests>
      <test>Movement type validation: each type enforces correct location types</test>
      <test>Location validation: active check, type check</test>
      <test>Stock_move record: all fields populated correctly</test>
    </unit_tests>
    <integration_tests>
      <test>POST /api/warehouse/stock-moves with valid LP and location</test>
      <test>Verify stock_moves record created and LP location updated</test>
      <test>POST with invalid location_type for movement_type → 400 error</test>
    </integration_tests>
    <e2e_tests>
      <test>Open LP detail, click Move, select destination, choose movement_type, submit</test>
      <test>Verify: LP list shows updated location, audit trail shows move</test>
    </e2e_tests>
  </test_plan>

  <implementation_notes>
    <note priority="critical">stock_moves is immutable audit trail - INSERT only, no UPDATE/DELETE</note>
    <note priority="high">from_location_id can be NULL for initial placement from receiving</note>
    <note priority="high">Location type validation prevents invalid movement workflows</note>
    <note priority="medium">Indexes on lp_id, moved_at critical for fast audit trail queries</note>
    <note priority="medium">Consider: is current location stored in LP or derived from latest stock_move</note>
  </implementation_notes>
</story>
