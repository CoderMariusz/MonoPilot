<?xml version="1.0" encoding="UTF-8"?>
<story>
  <metadata>
    <id>5.16</id>
    <title>Partial Move (Split on Move)</title>
    <batch>5B-1</batch>
    <points>5</points>
    <effort_hours>5-6</effort_hours>
    <status>todo</status>
  </metadata>
  <description>Move partial LP quantity by splitting and moving child LP to destination, combining LP split operation with movement</description>
  <dependencies>
    <requires><story id="5.14">LP Location Move</story><story id="5.5">LP Split</story></requires>
    <enables><story id="5.35">Inventory Count</story></enables>
  </dependencies>
  <technical_context>
    <api_endpoints>
      <endpoint method="POST" path="/api/warehouse/stock-moves">
        <description>Enhanced to support partial quantity moves with automatic split</description>
        <auth>authenticated</auth>
        <request>
          <field name="lp_id" type="UUID" required="true">License plate to move</field>
          <field name="to_location_id" type="UUID" required="true">Destination location</field>
          <field name="movement_type" type="string" required="true">Type: receiving, put_away, pick, transfer, adjustment</field>
          <field name="quantity" type="decimal" required="false">Partial quantity to move (if provided, must be > 0 and < current LP qty). If omitted, full LP moved.</field>
          <field name="reason" type="string" required="false">Optional reason for movement</field>
        </request>
        <response status="201">
          <field name="original_move" type="object" comment="Stock move for original LP or null if full move">
            <field name="stock_move_id" type="UUID"/>
            <field name="lp_id" type="UUID"/>
            <field name="quantity" type="decimal"/>
            <field name="moved_at" type="timestamp"/>
          </field>
          <field name="split_move" type="object" comment="Stock move for split LP (only if partial move)">
            <field name="stock_move_id" type="UUID"/>
            <field name="lp_id" type="UUID"/>
            <field name="quantity" type="decimal"/>
            <field name="moved_at" type="timestamp"/>
          </field>
          <field name="genealogy_id" type="UUID" comment="Parent-child genealogy link (only if partial move)"/>
          <field name="original_lp" type="object">
            <field name="id" type="UUID"/>
            <field name="lp_number" type="string"/>
            <field name="quantity" type="decimal" comment="Updated remaining quantity"/>
            <field name="location_id" type="UUID" comment="Original location (unchanged)"/>
          </field>
          <field name="split_lp" type="object" comment="Only if partial move">
            <field name="id" type="UUID"/>
            <field name="lp_number" type="string"/>
            <field name="quantity" type="decimal" comment="Split quantity"/>
            <field name="location_id" type="UUID" comment="Destination location"/>
          </field>
        </response>
        <response status="400">
          <field name="error" type="string" example="Split quantity must be less than LP quantity (100 kg)"/>
        </response>
      </endpoint>
    </api_endpoints>
    <logic>
      <operation name="move_with_split">
        <steps>
          IF quantity parameter provided:
            1. Validate quantity > 0 AND quantity < current_lp_qty (not equal, not more)
            2. Validate destination location (Story 5.17 validation)
            3. Call LP split operation (Story 5.5):
               - Create new LP with split quantity
               - Update original LP: qty -= split_qty
               - Record genealogy: parent → child
            4. Create stock_move for split LP:
               - from_location: current location (same as original)
               - to_location: destination
               - quantity: split_qty
               - movement_type: as specified
            5. Optional: Create stock_move for original LP:
               - from_location: current location
               - to_location: current location (qty adjustment record)
               - quantity: current LP quantity after split
               - movement_type: 'adjustment'
               - reason: "Qty adjustment on split"
            6. Return both LPs and moves
          ELSE (full move):
            - Proceed with normal move (Story 5.14 logic)
            - Return single move record
        </steps>
      </operation>
      <transaction_flow>
        - START transaction
        - VALIDATE split quantity (> 0, < current_qty)
        - VALIDATE destination (location, type, org)
        - INSERT new LP with split quantity (from Story 5.5)
        - INSERT genealogy record (parent_lp_id, child_lp_id, operation='split')
        - UPDATE original LP: quantity -= split_qty
        - INSERT stock_move for child LP (moved to destination)
        - INSERT stock_move for parent LP (qty adjustment, optional)
        - COMMIT
        - Return all created records
        - ROLLBACK on any error with specific message
      </transaction_flow>
    </logic>
    <database_tables>
      <table>
        <name>stock_moves</name>
        <changes>No schema changes, only new records created</changes>
        <important>
          - Multiple moves per LP tracked over time
          - Partial move creates 2 stock_move records (optional: one for parent adjustment)
          - Both moves have same timestamp (or very close) for atomic operation
        </important>
      </table>
      <table>
        <name>lp_genealogy</name>
        <changes>Uses existing genealogy table from Story 5.5</changes>
        <important>
          - Creates parent → child link with operation='split'
          - Parent LP ID remains unchanged (quantity updated)
          - Child LP ID is new (split quantity)
        </important>
      </table>
    </database_tables>
    <queries>
      <query name="validate_split_qty">
        SELECT quantity FROM license_plates WHERE id = $1 AND org_id = $2
      </query>
      <query name="create_split_lp">
        INSERT INTO license_plates (id, org_id, lp_number, product_id, quantity, batch_number, expiry_date, uom, location_id, status, qa_status, created_by_user_id, created_at)
        SELECT gen_random_uuid(), org_id, (SELECT get_next_lp_number(org_id)), product_id, $2, batch_number, expiry_date, uom, location_id, status, qa_status, $3, NOW()
        FROM license_plates WHERE id = $1
        RETURNING *
      </query>
      <query name="update_parent_qty">
        UPDATE license_plates SET quantity = quantity - $2 WHERE id = $1 AND org_id = $3
      </query>
      <query name="insert_genealogy">
        INSERT INTO lp_genealogy (id, org_id, parent_lp_id, child_lp_id, operation_type, created_by_user_id, created_at)
        VALUES (gen_random_uuid(), $1, $2, $3, 'split', $4, NOW())
      </query>
    </queries>
    <components>
      <component name="MoveLocationModal">
        <location>src/components/warehouse/stock-moves/MoveLocationModal.tsx</location>
        <changes>Enhanced from Story 5.14 to support partial moves</changes>
        <fields>
          - Current LP (read-only)
          - Current location (read-only)
          - Current quantity (read-only) e.g., "100 kg"
          - Movement type (required)
          - Destination location (required, filtered)
          - **NEW: Move mode selector:**
            - Radio button 1: "Move full LP (100 kg)" [default]
            - Radio button 2: "Move partial qty: ___ kg input"
          - **NEW: Qty input field (conditional):**
            - Shows only when "Move partial qty" selected
            - Input validation: must be > 0 and < current_qty
            - Shows: "Remaining after move: X kg"
            - Shows: "New LP will have: X kg"
          - Reason (optional)
        </fields>
        <validation>
          - If partial move: qty > 0 AND qty < current_qty (not >= current_qty)
          - Destination valid for movement_type
          - Show error if qty invalid: "Qty must be between 1 and 99 kg"
        </validation>
      </component>
      <component name="PartialMoveConfirmation">
        <location>src/components/warehouse/stock-moves/PartialMoveConfirmation.tsx</location>
        <description>Success confirmation showing split result</description>
        <displays>
          - "LP Split & Moved Successfully!"
          - Original LP details:
            - LP number (unchanged)
            - Remaining quantity
            - Location (unchanged)
          - Arrow or visual separator
          - New LP details:
            - New LP number
            - Split quantity
            - Destination location
          - Action buttons:
            - "View Original LP"
            - "View New LP"
            - "View Movements"
            - "Close"
        </displays>
      </component>
    </components>
    <hooks>
      <hook name="useMoveLP">
        <accepts>lp_id, to_location_id, movement_type, quantity (optional), reason (optional)</accepts>
        <returns>{ stockMove, genealogy, originalLP, splitLP, loading, error }</returns>
        <api_call>POST /api/warehouse/stock-moves</api_call>
        <enhancement>Now handles both full and partial moves, returns additional genealogy and LP details</enhancement>
      </hook>
    </hooks>
    <validation_rules>
      <rule id="qty_positive">If quantity provided: quantity > 0</rule>
      <rule id="qty_less_than_current">If quantity provided: quantity < current_lp_qty (not equal)</rule>
      <rule id="qty_precision">Quantity must respect UoM precision (e.g., whole units, decimal places)</rule>
      <rule id="destination_valid">Destination location must pass Story 5.17 validation</rule>
      <rule id="genealogy_chain">Genealogy cannot be circular (from Story 5.5)</rule>
      <rule id="lp_immutable">Original LP ID never changes (only quantity decreases)</rule>
      <rule id="child_immutable">New child LP cannot be split further (until move recorded)</rule>
    </validation_rules>
    <rls_policies>
      <policy table="stock_moves">
        <select>WHERE org_id = current_user.org_id</select>
        <insert>WHERE org_id = current_user.org_id (both original and split moves)</insert>
      </policy>
      <policy table="license_plates">
        <select>WHERE org_id = current_user.org_id</select>
        <update>WHERE org_id = current_user.org_id (for partial move qty update)</update>
      </policy>
      <policy table="lp_genealogy">
        <insert>WHERE org_id = current_user.org_id</insert>
      </policy>
    </rls_policies>
  </technical_context>
  <acceptance_criteria>
    <ac id="1" title="Partial Move Option">
      <test>Open move modal → see radio buttons for full vs partial move options</test>
    </ac>
    <ac id="2" title="Split on Partial Move">
      <test>Select partial move, enter qty 40 of 100 kg LP → submit → new LP created with 40 kg</test>
    </ac>
    <ac id="3" title="Original LP Retained">
      <test>After split → original LP still exists with remaining qty (60 kg)</test>
    </ac>
    <ac id="4" title="New LP at Destination">
      <test>New LP created and moved to destination location with split qty</test>
    </ac>
    <ac id="5" title="Genealogy Link">
      <test>Check LP genealogy → parent → child link created with operation='split'</test>
    </ac>
    <ac id="6" title="Stock Moves Recorded">
      <test>Audit trail shows stock_move for moved child LP, potentially stock_move for parent qty adjustment</test>
    </ac>
  </acceptance_criteria>
  <test_plan>
    <unit_tests>
      <test>Qty validation: qty=0 → error "Quantity must be greater than 0"</test>
      <test>Qty validation: qty > current_qty → error "Cannot split more than available"</test>
      <test>Qty validation: qty = current_qty → error "Use full move option"</test>
      <test>Qty calculation: 100 - 40 = 60 remaining ✓</test>
      <test>Child LP auto-numbering: new LP gets next sequence number</test>
    </unit_tests>
    <integration_tests>
      <test>POST /api/warehouse/stock-moves with quantity < current_qty</test>
      <test>Verify: parent LP qty reduced, child LP created, genealogy record inserted</test>
      <test>Verify: stock_move created for child with to_location = destination</test>
      <test>Verify: UoM, batch, expiry inherited from parent to child</test>
      <test>POST with invalid qty → 400 error with specific message</test>
      <test>POST with qty >= current_qty → 400 error</test>
    </integration_tests>
    <e2e_tests>
      <test>Open LP with 100 kg</test>
      <test>Click Move → select "Move partial qty"</test>
      <test>Enter 40 kg, select destination WH-B-05, choose movement_type='pick'</test>
      <test>Submit → confirmation shows: Original at WH-A-01 (60 kg), New at WH-B-05 (40 kg)</test>
      <test>Verify: Original LP list shows 60 kg, New LP exists with 40 kg</test>
      <test>Verify: Stock moves audit trail shows both movements</test>
      <test>Verify: Genealogy tree shows parent → child relationship</test>
    </e2e_tests>
  </test_plan>
</story>
