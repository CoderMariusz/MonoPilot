# Story 5.17: Destination Validation (Technical Foundation)

**ID:** 5.17
**Batch:** 5B-1 (Stock Moves)
**Story Points:** 3
**Effort:** 3-4 hours
**Status:** Todo
**Type:** Technical Foundation Story (reused by Stories 5.14, 5.18, 5.21)

---

## User Story

> As a **System**, I want to provide location validation rules, so that Stories 5.14 (LP Move), 5.18 (Movement Types), and 5.21 (Pallet Move) can enforce consistent destination constraints.

---

## Acceptance Criteria

### AC 1: Location Existence Check
- **Given** destination location selected
- **When** validating
- **Then**:
  - Location must exist in locations table
  - Location must belong to same org_id
  - If location not found: Show error "Location WH-B-05 does not exist"

### AC 2: Location Active Check
- **Given** destination location selected
- **When** validating
- **Then**:
  - Location.is_active must be true
  - If inactive: Show error "Location WH-B-05 is inactive. Please select different location"
  - Inactive locations filtered from dropdown

### AC 3: Location Type Validation
- **Given** moving LP with specific movement_type
- **When** validating destination location
- **Then** validate location_type matches movement:
  - **put_away**: to_location.type must be 'storage' (not receiving, shipping, etc)
  - **pick**: to_location.type must be 'production' or 'shipping' (not storage)
  - **transfer**: to_location.type must be 'storage' (both from and to)
  - **adjustment**: Any location type allowed
  - **receiving**: to_location.type must be 'storage' (from receiving dock)

### AC 4: Storage Capacity Check (Optional)
- **Given** location has capacity limits (optional feature)
- **When** moving LP to location
- **Then** validate location has available capacity
- If not: Show warning "Location WH-B-05 approaching capacity (95%)"

### AC 5: Warehouse Validation (Cross-warehouse moves)
- **Given** destination in different warehouse
- **When** validating move
- **Then**:
  - If movement_type = 'transfer': Block cross-warehouse move
  - If movement_type = 'pick': Allow (moving to shipping dock in another warehouse)
  - Error message: "Cannot transfer to different warehouse. Use Transfer Order instead"

### AC 6: Location Availability (Optional)
- **Given** moving to quarantine location
- **When** validating
- **Then**:
  - Quarantine locations restricted to QA holds
  - Alert: "This location is for QA holds only"

---

## Technical Tasks

### Backend

- [ ] Create location validation function
  ```
  validate_destination_location(org_id, location_id, movement_type)
    - Check: location exists
    - Check: location.is_active = true
    - Check: location.org_id = requested org_id
    - Check: location_type matches movement_type
    - Check: location not quarantine (unless appropriate)
    - Check: cross-warehouse allowed for this movement_type
    - Return: Valid or specific error
  ```

- [ ] Enhance move endpoint validation
  - Call validate_destination_location before INSERT
  - Return 400 with specific error message if invalid

- [ ] Add validation rules per movement_type
  ```
  CASE movement_type
    WHEN 'put_away' THEN location_type = 'storage'
    WHEN 'pick' THEN location_type IN ('production', 'shipping')
    WHEN 'transfer' THEN location_type = 'storage' AND same_warehouse
    WHEN 'adjustment' THEN location_type IN ('storage', 'quarantine', 'production')
    WHEN 'receiving' THEN location_type = 'storage'
  END
  ```

### Database

- [ ] Verify locations table has:
  - location_type (enum: receiving, storage, production, shipping, quarantine)
  - is_active (boolean, default true)
  - warehouse_id (FK, for cross-warehouse validation)

- [ ] Create indexes:
  - idx_locations_warehouse_id (for cross-warehouse checks)
  - idx_locations_location_type (for filtering)

### Frontend

- [ ] Update MoveLocationModal location dropdown
  - Filter locations: is_active = true
  - Filter by location_type based on selected movement_type
  - Show only locations in same warehouse (unless movement_type allows)
  - Display location code and name: "WH-B-05 - Storage Bin 5"
  - Show location_type as hint: "(Storage)"

- [ ] Add validation feedback
  - Show error message if location invalid
  - Disable Move button until valid location selected
  - Show warning for near-capacity locations

- [ ] Add location search/autocomplete
  - Type location code to filter dropdown
  - Show recent locations at top

---

## Testing

### Unit Tests
- Active check: is_active = false → error
- Type check: put_away to receiving → error
- Type check: pick to production → success
- Cross-warehouse: transfer to different warehouse → error
- Cross-warehouse: pick to shipping in different warehouse → success

### Integration Tests
- GET /api/warehouse/locations?movement_type=put_away → returns only storage locations
- POST /api/warehouse/stock-moves with invalid location → 400 error with specific message
- POST with valid location → 201 success

### E2E Tests
- Open move modal
- Try to select inactive location → filtered out (not in dropdown)
- Try to select wrong location type for movement → error shown, can't move
- Select valid location → Move succeeds

---

## Acceptance Criteria Checklist

- ✅ Location existence validated
- ✅ Location active status checked
- ✅ Location type matches movement_type
- ✅ Storage capacity warning (optional)
- ✅ Cross-warehouse restrictions enforced
- ✅ Quarantine location restrictions (optional)
- ✅ Error messages specific to validation failure

---

## Dependencies

**Requires:** Epic 1 (Locations infrastructure)

**Used by (Technical Foundation):**
- Story 5.14 (LP Location Move) - delegates location validation to this story
- Story 5.18 (Movement Types) - uses validation rules from this story
- Story 5.21 (Pallet Move) - reuses validation for batch operations

---

## Notes

- Location validation critical for inventory accuracy
- Movement_type constrains valid destination types
- Inactive locations prevent moves to obsolete/closed areas
- Cross-warehouse moves require Transfer Orders (different process)
