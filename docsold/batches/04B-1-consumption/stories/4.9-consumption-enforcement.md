# Story 4.9: 1:1 Consumption Enforcement

**Epic:** 4 - Production Execution | **Status:** Done | **Priority:** P0 | **Story Points:** 1 | **Effort:** 0.5 day

## User Story

**As a** System
**I want** to enforce full LP consumption when flagged
**So that** allergen control is maintained

## Acceptance Criteria

### AC-4.9.1: Whole LP Flag ✅
**Given** material has consume_whole_lp = true (from BOM)
**When** operator tries to consume partial
**Then** system blocks: "Must consume entire LP"

### AC-4.9.2: Scanner UI ✅
**When** consuming via scanner
**Then** qty input disabled, shows "Full LP: 50 kg" (read-only)

### AC-4.9.3: Desktop UI ✅
**When** consuming via desktop (Story 4.7)
**Then** qty field shows full LP qty, cannot change, only "Consume All" button

### AC-4.9.4: Validation Check Locations ✅
**Then** consume_whole_lp flag from wo_materials (copied from BOM in Story 3.10)
- **Desktop UI** (Story 4.7): qty field disabled, "Consume All" button only
- **Scanner UI** (Story 4.8): qty input disabled, shows full LP qty (read-only)
- **API Layer**: POST /api/production/work-orders/:id/consume validates consume_whole_lp

### AC-4.9.5: API Validation ✅
**Then** POST /api/production/work-orders/:id/consume:
- Checks consume_whole_lp flag
- If true: validates qty == LP.qty (entire LP)
- If qty != LP.qty when flag=true: rejects with 400 error

### AC-4.9.6: Error Message ✅
**When** attempting partial consumption
**Then** 400 error: "Material 'Flour' must be consumed entirely (50 kg). Cannot consume partial amounts."

### AC-4.9.7: Prerequisites ✅
**Then** Requires Story 3.10 (BOM snapshot with consume_whole_lp flag)

### AC-4.9.8: Testing ✅
**Then** Test with both whole and partial consumption BOM items

## Tasks / Subtasks

- [x] Task 1: Verify wo_materials has consume_whole_lp column
- [x] Task 2: API validation logic
- [x] Task 3: Scanner UI (disable qty input)
- [x] Task 4: Desktop UI (read-only qty)
- [x] Task 5: Error messages
- [x] Task 6: Tests

## Status

- **Created:** 2025-11-27
- **Updated:** 2025-12-03
- **Current Status:** Done
- **Completed:** 2025-12-03

## Implementation Notes (2025-12-03)

### Files Implemented/Modified
- `lib/supabase/migrations/038_add_consume_whole_lp_to_wo_materials.sql` - Migration
- `lib/services/material-reservation-service.ts` - Updated to use wo_materials.consume_whole_lp
- `lib/services/work-order-service.ts` - copyBOMToWOMaterials includes consume_whole_lp
- `app/api/production/work-orders/[id]/consume/route.ts` - API validation
- `app/(authenticated)/scanner/reserve/page.tsx` - Scanner UI
- `components/production/MaterialReservationModal.tsx` - Desktop UI
- `components/production/ConsumeConfirmDialog.tsx` - Consume confirmation
- `e2e/story-4.9-consumption-enforcement.spec.ts` - E2E tests

### Key Implementation Details

**Database:**
- Added `consume_whole_lp` column to wo_materials table
- Added `consumed_qty` column for tracking
- Backfill from bom_items for existing records

**API Validation (lines 147-161 in consume route):**
```typescript
if (material.consume_whole_lp === true) {
  const reservedQty = Number(reservation.reserved_qty)
  if (Math.abs(qty - reservedQty) > 0.0001) {
    return NextResponse.json({
      error: `Material '${material.material_name}' must be consumed entirely...`,
      code: ERROR_CODES.CONSUME_WHOLE_LP_REQUIRED,
    }, { status: 400 })
  }
}
```

**Scanner UI (lines 878-916):**
- Shows "Entire LP Required" message when consume_whole_lp=true
- Qty input disabled, displays full LP quantity
- "Reserve Full LP!" button variant

**Desktop UI:**
- MaterialReservationModal: qty field read-only when consume_whole_lp=true
- ConsumeConfirmDialog: Shows warning "Whole LP consumption required"

### BOM Snapshot Flow
1. BOM items have `consume_whole_lp` flag (bom_items table)
2. When WO created, `copyBOMToWOMaterials()` copies flag to wo_materials
3. Material reservation/consumption reads from wo_materials.consume_whole_lp
4. Both Scanner and Desktop UI enforce the flag
5. API validates on consume attempt

---

## Senior Developer Review (AI)

**Reviewer:** Mariusz
**Date:** 2025-12-03
**Outcome:** ✅ APPROVE

### Summary
Story 4.9 implementuje wymuszanie pełnej konsumpcji LP. Wszystkie AC zaimplementowane z dowodami w kodzie.

### Acceptance Criteria Coverage

| AC# | Opis | Status | Evidence |
|-----|------|--------|----------|
| AC-4.9.1 | Whole LP Flag | ✅ | `consume/route.ts:147-161` |
| AC-4.9.2 | Scanner UI | ✅ | `scanner/reserve/page.tsx:415,709,878-916` |
| AC-4.9.3 | Desktop UI | ✅ | `MaterialReservationModal.tsx:149-155,176-178` |
| AC-4.9.4 | Validation locations | ✅ | Desktop, Scanner, API |
| AC-4.9.5 | API 400 error | ✅ | `consume/route.ts:151-159` |
| AC-4.9.6 | Error message | ✅ | `consume/route.ts:153` |
| AC-4.9.7 | Prerequisites | ✅ | `work-order-service.ts:616,654` |
| AC-4.9.8 | Testing | ✅ | `story-4.9-consumption-enforcement.spec.ts` |

**8/8 AC implemented**

### Task Completion Validation

| Task | Status | Evidence |
|------|--------|----------|
| Task 1: wo_materials column | ✅ | `038_*.sql:9-10` |
| Task 2: API validation | ✅ | `consume/route.ts:147-161` |
| Task 3: Scanner UI | ✅ | `page.tsx:878-916` |
| Task 4: Desktop UI | ✅ | `Modal.tsx:149-155` |
| Task 5: Error messages | ✅ | `route.ts:153` |
| Task 6: Tests | ✅ | `spec.ts` |

**6/6 tasks verified**

### Action Items
- None required

### Change Log
- 2025-12-03: Senior Developer Review - APPROVED
