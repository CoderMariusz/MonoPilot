<?xml version="1.0" encoding="UTF-8"?>
<story-context>
  <metadata>
    <story-id>1.14</story-id>
    <story-title>Epic 1 - Polish &amp; Cleanup</story-title>
    <epic>1 - Foundation &amp; Settings</epic>
    <batch>01D - Dashboards &amp; UX</batch>
    <status>ready-for-dev</status>
    <priority>P1</priority>
    <story-points>5</story-points>
    <estimated-effort>24-37 hours (3-5 days)</estimated-effort>
  </metadata>

  <story-content>
    <description>
      As a Developer/Product Owner, I want to complete all deferred tasks and polish items from Epic 1 stories,
      so that Epic 1 is production-ready with full feature coverage and quality assurance.
    </description>

    <purpose>
      This story collects all deferred tasks, missing UI components, test gaps, and technical debt items from Epic 1 stories.
      It serves as the final polish pass before marking Epic 1 as complete.
    </purpose>

    <user-story>
      As a **Developer/Product Owner**,
      I want to complete all deferred tasks and polish items from Epic 1 stories,
      so that Epic 1 is production-ready with full feature coverage and quality assurance.
    </user-story>
  </story-content>

  <acceptance-criteria>
    <ac id="AC-1" category="Story 1.3 User Invitations - Deferred Items">
      <ac-item id="AC-1.1" title="Invitations Tab UI" status="pending">
        <requirement>Navigate to /settings/users → "Invitations" tab visible</requirement>
        <requirement>Table columns: Email, Role, Invited By, Sent Date, Expires At, Status, Actions</requirement>
        <requirement>Status badges: Pending (blue), Accepted (green), Expired (red), Cancelled (gray)</requirement>
        <requirement>Search by email functionality</requirement>
        <requirement>Filter by status dropdown</requirement>
        <requirement>Resend button → POST /api/settings/invitations/:id/resend</requirement>
        <requirement>Cancel button → confirmation modal → DELETE /api/settings/invitations/:id</requirement>
        <requirement>Real-time refresh after actions</requirement>
        <deferred-from>Story 1.3 Task 7, AC-003.1</deferred-from>
      </ac-item>

      <ac-item id="AC-1.2" title="Invitation Modal" status="pending">
        <requirement>Triggered after successful user creation</requirement>
        <requirement>Display sections:
          - Success message: "User invited successfully!"
          - Email sent to: {email}
          - QR code for mobile scanning (generated client-side)
          - Copy signup link button (clipboard API)
          - Expiry notice: "Expires in 7 days"
        </requirement>
        <requirement>Actions: Close, "Send another invitation"</requirement>
        <deferred-from>Story 1.3 Task 8, AC-003.5</deferred-from>
      </ac-item>

      <ac-item id="AC-1.3" title="Expired Invitations Visual Indicators" status="pending">
        <requirement>Expires At column shows "Expired" badge (red) if past expiry</requirement>
        <requirement>Status automatically updated to "Expired"</requirement>
        <requirement>Resend button enabled for expired invitations</requirement>
        <requirement>Cancel button disabled for expired invitations</requirement>
        <deferred-from>Story 1.3 AC-003.4</deferred-from>
      </ac-item>

      <ac-item id="AC-1.4" title="Signup Status Automation (HIGH PRIORITY)" status="completed">
        <requirement>Database trigger `trigger_auto_activate_user` deployed (Migration 015)</requirement>
        <requirement>Trigger fires on `auth.users INSERT` event automatically</requirement>
        <requirement>Validates invitation token from `raw_user_meta_data.invitation_token`</requirement>
        <requirement>Updates `users.status = 'active'` after successful signup</requirement>
        <requirement>Updates `user_invitations.status = 'accepted', accepted_at = NOW()`</requirement>
        <requirement>Logs activity in `activity_logs` table</requirement>
        <requirement>Graceful handling if invitation not found/expired</requirement>
        <cost-savings>FREE database trigger replaces $20/month Vercel webhook</cost-savings>
        <deferred-from>Story 1.3 AC-002.8</deferred-from>
      </ac-item>

      <ac-item id="AC-1.5" title="Auto-Cleanup Cron Job" status="completed">
        <requirement>Weekly cron job configured (Sunday 2am UTC)</requirement>
        <requirement>Endpoint: `/api/cron/cleanup-invitations` (GET)</requirement>
        <requirement>Deletes invitations WHERE status = 'expired' AND expires_at &lt; NOW() - 30 days</requirement>
        <requirement>Logs deleted count for monitoring (console + response JSON)</requirement>
        <requirement>Configured in vercel.json crons array</requirement>
        <requirement>Authorization via CRON_SECRET (Bearer token)</requirement>
        <requirement>Returns: deleted_count, cutoff_date, timestamp</requirement>
        <deferred-from>Story 1.3 Task 9, AC-003.4</deferred-from>
      </ac-item>

      <ac-item id="AC-1.6" title="Invitation Flow Tests" status="completed">
        <requirement>Unit Tests (__tests__/unit/invitation-utils.test.ts): 12 tests passing
          - Token format validation (UUID v4 regex)
          - Token expiry detection (client-side check)
          - Days until expiry calculation
          - QR code generation (data URL format)
          - QR code consistency (same input → same output)
          - Signup link generation (with/without email param)
          - Status badge variant logic (pending/accepted/expired/cancelled)
          - Resend button disabled logic
          - Cancel button disabled logic
          - Expiry date calculation (7 days from now)
          - Clipboard write validation
        </requirement>
        <requirement>Integration Tests (__tests__/api/settings/invitations.test.ts): 7 test suites
          - Token generation with 7-day expiry validation
          - Token validation with expired tokens (expires_at in past)
          - Invitation record created with all required fields
          - Resend invitation → new token, old invalidated
          - Signup with valid token → user.status = 'active' (via trigger)
          - Invitation status lifecycle (pending → cancelled/accepted/expired)
          - Cleanup old expired invitations (&gt;30 days)
        </requirement>
        <requirement>E2E Tests (Playwright): Deferred to future story (not blocking)
          - Complete flow: create user → email sent → signup → dashboard
          - Expired token handling
          - Resend/cancel invitation flows
        </requirement>
        <deferred-from>Story 1.3 Tasks 10-11</deferred-from>
      </ac-item>
    </ac>

    <ac id="AC-2" category="Story 1.7 Machine Configuration - Deferred Items">
      <ac-item id="AC-2.1" title="E2E Tests for Machine CRUD" status="completed">
        <requirement>Playwright E2E tests for machine creation flow (4 tests)</requirement>
        <requirement>Playwright E2E tests for machine editing flow (2 tests)</requirement>
        <requirement>Playwright E2E tests for machine deletion with FK constraints (2 tests)</requirement>
        <requirement>Playwright E2E tests for filter/search functionality (3 tests)</requirement>
        <requirement>Playwright E2E tests for sort functionality (2 tests)</requirement>
        <requirement>Authorization tests (2 tests)</requirement>
        <requirement>Line assignment integration test (1 test for AC-2.3)</requirement>
        <requirement>Total: 16 E2E test cases covering all Machine CRUD workflows</requirement>
        <file>tests/e2e/machines.spec.ts</file>
        <deferred-from>Story 1.7 Tasks 11</deferred-from>
      </ac-item>

      <ac-item id="AC-2.2" title="Redis Cache Integration" status="moved-to-epic-9">
        <decision>Moved to Epic 9 "Performance &amp; Optimization" - not required for MVP</decision>
        <reason>Backend cache invalidation events already emitted ('machine.updated')</reason>
        <reason>Performance optimizations will be evaluated post-MVP</reason>
        <reason>Epic 9 will collect all performance enhancements and prioritize based on actual usage data</reason>
        <reason>Currently works without cache, acceptable performance for MVP</reason>
        <deferred-from>Story 1.7 Task 10, AC-006.8</deferred-from>
      </ac-item>

      <ac-item id="AC-2.3" title="Line Assignment UI" status="completed">
        <requirement>Story 1.8 completed - production_lines table exists</requirement>
        <requirement>Production lines API integration (/api/settings/lines)</requirement>
        <requirement>Multi-select dropdown with available lines</requirement>
        <requirement>Selected lines displayed as removable badges</requirement>
        <requirement>Add/remove line functionality</requirement>
        <requirement>Backend logic already complete (machine-service.ts)</requirement>
        <requirement>UI integrated in MachineFormModal component</requirement>
        <deferred-from>Story 1.7 Task 9, AC-006.3</deferred-from>
      </ac-item>

      <ac-item id="AC-2.4" title="Machine Detail Page" status="completed">
        <requirement>Created /settings/machines/[id]/page.tsx - Machine detail page</requirement>
        <requirement>Display machine basic info (code, name, status, capacity)</requirement>
        <requirement>Display assigned production lines with navigation links</requirement>
        <requirement>Show metadata (created_at, updated_at)</requirement>
        <requirement>Added View button (Eye icon) to machines list table</requirement>
        <requirement>Back navigation to machines list</requirement>
        <requirement>Edit button redirects to machines list with edit modal</requirement>
        <future-work>Active WOs section (Epic 4 integration placeholder)</future-work>
        <deferred-from>Story 1.7 Task 8, AC-006.7</deferred-from>
      </ac-item>
    </ac>

    <ac id="AC-3" category="Other Epic 1 Stories - Deferred Items">
      <ac-item id="AC-3.1" title="Collect and track deferred items" status="pending">
        <requirement>Review all completed stories for deferred tasks</requirement>
        <requirement>Add to this story's task list</requirement>
        <requirement>Prioritize based on production impact</requirement>
      </ac-item>

      <ac-item id="AC-3.2" title="Final integration testing" status="pending">
        <requirement>All Epic 1 features work together seamlessly</requirement>
        <requirement>No breaking interactions between stories</requirement>
        <requirement>Performance acceptable under realistic load</requirement>
      </ac-item>
    </ac>
  </acceptance-criteria>

  <deferred-items>
    <item source="Story 1.3" priority="HIGH">
      <title>Invitations Tab UI (AC-1.1)</title>
      <reason>Deferred to maintain velocity while ensuring core functionality works</reason>
      <decision>Option B - Defer UI to Story 1.14</decision>
      <reference>Code Review Report: 1-3-user-invitations.md - Senior Developer Review</reference>
    </item>

    <item source="Story 1.3" priority="MEDIUM">
      <title>Invitation Modal (AC-1.2)</title>
      <reason>UX enhancement - not blocking core functionality</reason>
    </item>

    <item source="Story 1.3" priority="CRITICAL" status="completed">
      <title>Signup Status Automation (AC-1.4)</title>
      <reason>HIGH PRIORITY - blocks production use</reason>
      <solution>Database trigger `trigger_auto_activate_user` deployed (Migration 015)</solution>
      <cost-impact>FREE database trigger replaces $20/month Vercel webhook</cost-impact>
    </item>

    <item source="Story 1.3" priority="LOW" status="completed">
      <title>Auto-Cleanup Cron Job (AC-1.5)</title>
      <reason>Maintenance automation</reason>
      <solution>Weekly cron job configured (Sunday 2am UTC) via vercel.json</solution>
    </item>

    <item source="Story 1.3" priority="MEDIUM" status="completed">
      <title>Invitation Flow Tests (AC-1.6)</title>
      <reason>Quality assurance</reason>
      <solution>12 unit tests + 7 integration tests - all passing</solution>
      <deferred>E2E tests (Playwright) deferred to future story (not blocking)</deferred>
    </item>

    <item source="Story 1.7" priority="MEDIUM" status="completed">
      <title>E2E Tests for Machine CRUD (AC-2.1)</title>
      <reason>Quality assurance before production</reason>
      <solution>16 Playwright E2E tests covering all Machine CRUD workflows</solution>
    </item>

    <item source="Story 1.7" priority="LOW" status="moved-to-epic-9">
      <title>Redis Cache Integration (AC-2.2)</title>
      <reason>Optimization for scale - not MVP blocker</reason>
      <decision>Moved to Epic 9 "Performance &amp; Optimization"</decision>
      <justification>Current performance acceptable without caching, backend events ready for future integration</justification>
    </item>

    <item source="Story 1.7" priority="MEDIUM" status="completed">
      <title>Line Assignment UI (AC-2.3)</title>
      <reason>Blocked by Story 1.8 (production_lines table)</reason>
      <solution>Story 1.8 completed, multi-select dropdown integrated in MachineFormModal</solution>
    </item>

    <item source="Story 1.7" priority="OPTIONAL" status="completed">
      <title>Machine Detail Page (AC-2.4)</title>
      <reason>Enhancement - not required for MVP</reason>
      <solution>/settings/machines/[id]/page.tsx created with full machine details and navigation</solution>
    </item>
  </deferred-items>

  <testing-strategy>
    <unit-tests>
      <test-suite file="__tests__/unit/invitation-utils.test.ts" status="completed">
        <description>12 tests passing for invitation utilities</description>
        <test>Token format validation (UUID v4 regex)</test>
        <test>Token expiry detection (client-side check)</test>
        <test>Days until expiry calculation</test>
        <test>QR code generation (data URL format)</test>
        <test>QR code consistency (same input → same output)</test>
        <test>Signup link generation (with/without email param)</test>
        <test>Status badge variant logic (pending/accepted/expired/cancelled)</test>
        <test>Resend button disabled logic</test>
        <test>Cancel button disabled logic</test>
        <test>Expiry date calculation (7 days from now)</test>
        <test>Clipboard write validation</test>
      </test-suite>

      <test-suite file="lib/services/__tests__/invitation-service.test.ts" status="pending">
        <description>Unit tests for invitation services</description>
        <test>Token generation/validation</test>
        <test>QR code generation</test>
      </test-suite>

      <test-suite file="apps/frontend/components/planning/__tests__/InvitationsTable.test.tsx" status="pending">
        <description>Unit tests for InvitationsTable component</description>
        <test>Table rendering with data</test>
        <test>Search functionality</test>
        <test>Filter by status</test>
        <test>Resend/Cancel actions</test>
      </test-suite>
    </unit-tests>

    <integration-tests>
      <test-suite file="__tests__/api/settings/invitations.test.ts" status="completed">
        <description>7 integration test suites for invitation API</description>
        <test>Token generation with 7-day expiry validation</test>
        <test>Token validation with expired tokens (expires_at in past)</test>
        <test>Invitation record created with all required fields</test>
        <test>Resend invitation → new token, old invalidated</test>
        <test>Signup with valid token → user.status = 'active' (via trigger)</test>
        <test>Invitation status lifecycle (pending → cancelled/accepted/expired)</test>
        <test>Cleanup old expired invitations (&gt;30 days)</test>
      </test-suite>

      <test-suite file="__tests__/api/invitations.test.ts" status="pending">
        <description>Additional integration tests for invitation flow</description>
        <test>POST user → invitation sent within 5s</test>
        <test>Resend/cancel flows</test>
      </test-suite>
    </integration-tests>

    <e2e-tests>
      <test-suite file="tests/e2e/machines.spec.ts" status="completed">
        <description>16 Playwright E2E tests for Machine CRUD</description>
        <test>Create machine flow (4 tests: required fields, capacity, uniqueness, format validation)</test>
        <test>Edit machine flow (2 tests: status update, capacity update)</test>
        <test>Delete machine (2 tests: FK constraints error, successful deletion)</test>
        <test>Filter/search (3 tests: filter by status, search by code, search by name)</test>
        <test>Sort (2 tests: sort by code, sort by name)</test>
        <test>Authorization (2 tests: manager view-only, non-admin access denied)</test>
        <test>Line assignment (1 test: integration with AC-2.3 production lines)</test>
      </test-suite>

      <test-suite file="tests/e2e/invitations.spec.ts" status="deferred">
        <description>E2E tests for invitation flow (deferred to future story)</description>
        <test>Complete user invitation flow</test>
        <test>Expired token handling</test>
        <test>Resend/cancel flows</test>
        <reason>Not blocking - unit and integration tests provide sufficient coverage</reason>
      </test-suite>
    </e2e-tests>

    <coverage-target>
      <requirement>Test coverage &gt;80% for critical paths</requirement>
      <current-status>
        - AC-1.4: Database trigger tested via integration tests (7 suites)
        - AC-1.5: Cron job tested via integration tests
        - AC-1.6: 12 unit tests + 7 integration tests
        - AC-2.1: 16 E2E tests
        - AC-2.3: Backend + frontend integration tested
        - AC-2.4: Manual testing (E2E tests deferred)
      </current-status>
    </coverage-target>
  </testing-strategy>

  <technical-stack>
    <frontend>
      <framework>Next.js 15</framework>
      <language>TypeScript 5.7</language>
      <ui-library>Tailwind CSS + Shadcn/UI (Tabs, Table, Dialog, Badge)</ui-library>
      <libraries>
        <library name="qrcode" version="^1.5.3" purpose="QR code generation (AC-1.2)" />
        <library name="@types/qrcode" version="^1.5.5" purpose="TypeScript types" />
        <library name="react-hook-form" version="^7.48.0" purpose="Form validation (existing)" />
        <library name="zod" version="^3.22.0" purpose="Schema validation (existing)" />
        <library name="lucide-react" version="^0.294.0" purpose="Icons (existing)" />
      </libraries>
    </frontend>

    <testing>
      <unit>Vitest</unit>
      <e2e>Playwright</e2e>
    </testing>

    <external-services>
      <service name="Supabase Auth" purpose="Signup webhooks (replaced by database trigger)" />
      <service name="Vercel Cron" purpose="Weekly cleanup job (Sunday 2am UTC)" />
      <service name="SendGrid" purpose="Resend invitation emails" />
    </external-services>
  </technical-stack>

  <priority-order>
    <task priority="CRITICAL" status="completed">Task 3: Signup status automation (AC-1.4) - blocks production use</task>
    <task priority="HIGH">Task 1: Invitations Tab UI (AC-1.1) - completes AC-003.1</task>
    <task priority="MEDIUM" status="completed">Task 7: Story 1.7 E2E Tests (AC-2.1) - quality assurance</task>
    <task priority="MEDIUM" status="completed">Task 5: Story 1.3 Tests (AC-1.6) - quality assurance</task>
    <task priority="MEDIUM">Task 2: Invitation Modal (AC-1.2) - UX enhancement</task>
    <task priority="LOW" status="completed">Task 4: Auto-cleanup cron (AC-1.5) - maintenance automation</task>
    <task priority="LOW" status="moved-to-epic-9">Task 8: Story 1.7 Redis Cache (AC-2.2) - optimization for scale</task>
    <task priority="LOW">Task 6: Documentation (AC-1.X) - operational readiness</task>
    <task priority="BLOCKED" status="completed">Task 9: Story 1.7 Line Assignment UI (AC-2.3) - blocked by Story 1.8</task>
    <task priority="OPTIONAL" status="completed">Task 10: Story 1.7 Machine Detail Page (AC-2.4) - enhancement</task>
  </priority-order>

  <success-criteria>
    <criterion>All Epic 1 ACs fully satisfied (no partial implementations)</criterion>
    <criterion>All deferred items completed or explicitly postponed with justification</criterion>
    <criterion>Test coverage &gt;80% for critical paths</criterion>
    <criterion>All documentation up to date</criterion>
    <criterion>Epic 1 ready for production deployment</criterion>
  </success-criteria>

  <related-documentation>
    <document type="story" path="./1-3-user-invitations.md" title="Story 1.3: User Invitations" />
    <document type="story" path="./1-7-machine-configuration.md" title="Story 1.7: Machine Configuration" />
    <document type="code-review" title="1-3-user-invitations.md - Senior Developer Review" />
    <document type="epic" path="../tech-spec-epic-1.md" title="Epic 1 Tech Spec" />
    <document type="external" url="https://supabase.com/docs/guides/auth/auth-hooks" title="Supabase Auth Webhooks" />
    <document type="external" url="https://vercel.com/docs/cron-jobs" title="Vercel Cron Jobs" />
  </related-documentation>

  <change-log>
    <change date="2025-11-22" author="System">
      Story created to collect Epic 1 deferred items (primarily from Story 1.3).
      Added all deferred tasks from Story 1.3 code review.
      Prioritized based on production impact.
      Estimated effort: 15-22 hours.
    </change>

    <change date="2025-11-22" author="System">
      Added Story 1.7 deferred items (AC-2.1 through AC-2.4, Tasks 7-10).
      - AC-2.1: E2E Tests for Machine CRUD (MEDIUM priority)
      - AC-2.2: Redis Cache Integration (LOW priority)
      - AC-2.3: Line Assignment UI (BLOCKED by Story 1.8)
      - AC-2.4: Machine Detail Page (OPTIONAL)
      Updated effort estimate: 24-37 hours (3-5 days).
    </change>

    <change date="2025-11-22" author="System">
      Completed AC-2.3 - Line Assignment UI (Task 9).
      Story 1.8 completed, production_lines table available.
      Implemented multi-select dropdown in MachineFormModal.
      Production lines fetched from /api/settings/lines API.
      Selected lines displayed as removable badges.
      Add/remove functionality integrated.
      Backend logic already complete from Story 1.7.
    </change>

    <change date="2025-11-22" author="System">
      Sprint decisions - AC scope adjustments.
      - AC-2.1: E2E Tests for Machine CRUD - APPROVED (implementing now)
      - AC-2.2: Redis Cache Integration - SKIPPED (not required for MVP, acceptable performance)
      - AC-2.4: Machine Detail Page - DEFERRED TO POST-MVP (enhancement, not required)
    </change>

    <change date="2025-11-22" author="System">
      Completed AC-2.1 - E2E Tests for Machine CRUD (Task 7).
      Created tests/e2e/machines.spec.ts with 16 comprehensive E2E tests.
      - Create machine flow: 4 tests (required fields, capacity, uniqueness, format validation)
      - Edit machine flow: 2 tests (status update, capacity update)
      - Delete machine: 2 tests (FK constraints error, successful deletion)
      - Filter/search: 3 tests (filter by status, search by code, search by name)
      - Sort: 2 tests (sort by code, sort by name)
      - Authorization: 2 tests (manager view-only, non-admin access denied)
      - Line assignment: 1 test (integration with AC-2.3 production lines)
      All Machine CRUD workflows fully covered with E2E tests.
    </change>

    <change date="2025-11-22" author="System">
      Completed AC-2.4 - Machine Detail Page (Task 10).
      Created /settings/machines/[id]/page.tsx - Machine detail page.
      Displays machine basic info (code, name, status, capacity).
      Shows assigned production lines with clickable navigation.
      Added View button (Eye icon) to machines list table.
      Includes metadata display (created_at, updated_at).
      Back navigation and edit functionality integrated.
      Active WOs placeholder for Epic 4 integration.
    </change>

    <change date="2025-11-22" author="System">
      Moved AC-2.2 Redis Cache to Epic 9 "Performance &amp; Optimization".
      Decision: Performance optimizations should be evaluated post-MVP with real usage data.
      Epic 9 will collect all performance enhancements (Redis, query optimization, etc.).
      Backend events already emit cache invalidation hooks for future implementation.
      Current performance acceptable for MVP without caching.
    </change>
  </change-log>

  <remaining-work>
    <task id="Task-1" title="Invitations Tab UI (AC-1.1)" priority="HIGH">
      <subtask>Create InvitationsTable component</subtask>
      <subtask>Table with required columns</subtask>
      <subtask>Status badges (color-coded)</subtask>
      <subtask>Search input (email filter)</subtask>
      <subtask>Status dropdown filter</subtask>
      <subtask>Resend button with API integration</subtask>
      <subtask>Cancel button with confirmation modal</subtask>
      <subtask>Add "Invitations" tab to /app/settings/users/page.tsx</subtask>
      <subtask>Tab navigation component</subtask>
      <subtask>Route to invitations table</subtask>
      <subtask>Proper loading states</subtask>
      <subtask>Integrate with GET /api/settings/invitations</subtask>
      <subtask>SWR for data fetching</subtask>
      <subtask>Automatic refresh after mutations</subtask>
      <subtask>Test UI components</subtask>
      <subtask>Unit tests for InvitationsTable</subtask>
      <subtask>E2E test for tab navigation</subtask>
      <estimated-effort>4-6 hours</estimated-effort>
    </task>

    <task id="Task-2" title="Invitation Modal (AC-1.2)" priority="MEDIUM">
      <subtask>Create InvitationModal component</subtask>
      <subtask>Success message display</subtask>
      <subtask>QR code generation (client-side)</subtask>
      <subtask>Copy link to clipboard functionality</subtask>
      <subtask>Expiry notice</subtask>
      <subtask>Close and "Send another" actions</subtask>
      <subtask>Trigger modal after user creation</subtask>
      <subtask>Modify user creation flow</subtask>
      <subtask>Pass invitation data to modal</subtask>
      <subtask>Test modal functionality</subtask>
      <subtask>Unit test for clipboard copy</subtask>
      <subtask>E2E test for modal appearance</subtask>
      <estimated-effort>2-3 hours</estimated-effort>
    </task>

    <task id="Task-6" title="Documentation Updates" priority="LOW">
      <subtask>Update .env.example with all required vars (JWT_SECRET, SendGrid config documented)</subtask>
      <subtask>Document setup instructions (Vercel cron setup for auto-cleanup, SendGrid API key setup)</subtask>
      <subtask>Update README with invitation flow</subtask>
      <note>Migration 015: Auto-activate users trigger deployed (completed)</note>
      <estimated-effort>1 hour</estimated-effort>
    </task>

    <task id="Task-11" title="Review Other Epic 1 Stories for Deferred Items">
      <subtask>Story 1.7 deferred items collected (Tasks 7-10 above - COMPLETED)</subtask>
      <subtask>Check Stories 1.0-1.6, 1.8-1.13 for deferred tasks</subtask>
      <subtask>Add discovered items to this story</subtask>
      <subtask>Prioritize based on production readiness</subtask>
      <estimated-effort>2-3 hours</estimated-effort>
    </task>

    <task id="Task-12" title="Final Epic 1 Integration Testing">
      <subtask>Test all Epic 1 features together</subtask>
      <subtask>Performance testing</subtask>
      <subtask>Cross-story integration validation</subtask>
      <estimated-effort>2-3 hours</estimated-effort>
    </task>
  </remaining-work>

  <completed-work>
    <completed-task id="AC-1.4" title="Signup Status Automation" date="2025-11-22">
      <description>Database trigger `trigger_auto_activate_user` deployed (Migration 015)</description>
      <impact>FREE database trigger replaces $20/month Vercel webhook</impact>
      <solution>Trigger fires on auth.users INSERT, validates invitation token, updates user/invitation status, logs activity</solution>
    </completed-task>

    <completed-task id="AC-1.5" title="Auto-Cleanup Cron Job" date="2025-11-22">
      <description>Weekly cron job configured (Sunday 2am UTC)</description>
      <solution>Endpoint /api/cron/cleanup-invitations, deletes expired invitations &gt;30 days old, configured in vercel.json</solution>
    </completed-task>

    <completed-task id="AC-1.6" title="Invitation Flow Tests" date="2025-11-22">
      <description>12 unit tests + 7 integration tests - all passing</description>
      <coverage>Token validation, expiry detection, QR generation, status badges, signup flow, cleanup logic</coverage>
      <deferred>E2E tests (Playwright) deferred to future story (not blocking)</deferred>
    </completed-task>

    <completed-task id="AC-2.1" title="E2E Tests for Machine CRUD" date="2025-11-22">
      <description>16 Playwright E2E tests covering all Machine CRUD workflows</description>
      <file>tests/e2e/machines.spec.ts</file>
      <coverage>Create (4), Edit (2), Delete (2), Filter/Search (3), Sort (2), Authorization (2), Line assignment (1)</coverage>
    </completed-task>

    <completed-task id="AC-2.3" title="Line Assignment UI" date="2025-11-22">
      <description>Multi-select dropdown integrated in MachineFormModal</description>
      <solution>Production lines fetched from /api/settings/lines API, selected lines displayed as removable badges</solution>
    </completed-task>

    <completed-task id="AC-2.4" title="Machine Detail Page" date="2025-11-22">
      <description>/settings/machines/[id]/page.tsx created with full machine details</description>
      <features>Basic info, assigned production lines, metadata, View button in list, back navigation, edit functionality</features>
      <future-work>Active WOs section (Epic 4 integration placeholder)</future-work>
    </completed-task>
  </completed-work>

  <known-issues>
    <issue severity="NONE" status="resolved">
      <title>Redis Cache Integration (AC-2.2)</title>
      <description>Performance optimization deferred to Epic 9</description>
      <justification>Current performance acceptable for MVP, backend events ready for future integration</justification>
      <action>Moved to Epic 9 "Performance &amp; Optimization"</action>
    </issue>

    <issue severity="LOW" status="deferred">
      <title>E2E Tests for Invitation Flow</title>
      <description>Playwright E2E tests for complete invitation flow deferred</description>
      <justification>Unit tests (12) + integration tests (7) provide sufficient coverage for MVP</justification>
      <action>Deferred to future story (not blocking production)</action>
    </issue>
  </known-issues>
</story-context>
