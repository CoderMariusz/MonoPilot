# Story 4.7: Material Reservation (Desktop)

**Epic:** 4 - Production Execution | **Status:** Todo | **Priority:** P0 | **Story Points:** 3 | **Effort:** 1.5 days | **Updated:** 2025-11-28

## User Story

**As an** Operator
**I want** to reserve/allocate materials from desktop
**So that** I can track which LPs will be used for production (actual consumption happens when output is registered - Story 4.12/4.13)

---

## Problem Statement

Materials need to be pre-allocated to WO in the order they will be consumed. This reservation:
1. Locks LP sequence (A → B → C order cannot change)
2. Enables consume_whole_lp enforcement (entire LP consumed when output triggers it)
3. Creates audit trail for material traceability
4. Actual consumption happens automatically when output is registered (4.12/4.13) based on output qty
5. Genealogy records created with parent_lp_id, waiting for child_lp_id (output LP)
6. Supports LP splitting on partial consumption (Phase 2)
7. Tracks reserved state separate from consumed state (two tables: wo_material_reservations + wo_consumption)

## Acceptance Criteria

### AC-4.7.1: Materials Table Display

**Given** viewing WO material reservation page
**When** page loads
**Then** table displays all required materials from BOM snapshot with:
- Product name + SKU
- Required Qty (from BOM)
- Reserved Qty (sum of all reserved LPs for this material)
- Remaining Qty (Required - Reserved)
- Reserved LPs list in sequence order: "LP-A (80kg #1) → LP-B (40kg #2)"
- Progress bar: (Reserved / Required) × 100%
- Status badge: "Complete" (green) if Reserved >= Required, "In Progress" (yellow) if partial, "Not Started" (gray) if none reserved
- Actions: "Reserve" button (enabled if Remaining > 0), "Unreserve" button (enabled if Reserved > 0)

**Success Criteria:**
- ✅ All materials from BOM displayed
- ✅ Progress calculation accurate
- ✅ Sequence order preserved
- ✅ Action buttons conditional on reservation state

---

### AC-4.7.2: Material Reservation Modal

**Given** clicking "Reserve" on material with Remaining qty
**When** modal opens
**Then** displays:
- Material name + required qty (read-only header)
- LP search/scan input field (search by barcode, LP number, or product name)
  - Auto-suggest dropdown as operator types
  - Scan barcode button (triggers barcode input)
- **Conditional qty input** (from Story 4.9):
  - **If consume_whole_lp = false**:
    - Qty input field enabled, default to "Remaining" qty
    - Unit display (e.g., "kg", "units")
    - "Reserve" button
  - **If consume_whole_lp = true**:
    - Qty field shows read-only: "Entire LP: [LP.qty] [UOM]"
    - Only "Reserve Full LP" button (no qty override)
- Sequence indicator: "This will be LP #X for [Material]"
- Notes field (optional, max 500 chars)
- "Cancel" and "Reserve" buttons

**Validation:**
- [ ] LP must exist in system
- [ ] LP product must match material product
- [ ] LP UoM must match material UoM
- [ ] LP available qty >= requested reservation qty
- [ ] LP not already reserved for this WO

**Success Criteria:**
- ✅ LP search works (barcode + name)
- ✅ Qty input conditional on consume_whole_lp
- ✅ Sequence number displayed correctly
- ✅ Validation errors shown clearly

---

### AC-4.7.3: Material Reservation Recording & Genealogy Initialization

**Given** operator confirms reservation in modal
**When** clicking "Reserve"
**Then** system performs atomic transaction:

```
1. VALIDATE:
   - WO status = 'in_progress'
   - LP exists, product matches, UoM matches
   - LP available qty >= reserved qty
   - LP not already reserved for this WO
   - consume_whole_lp constraint (if true, reserved_qty = LP.qty)

2. CREATE wo_material_reservations record:
   - wo_id
   - material_id (from BOM)
   - lp_id (selected LP)
   - reserved_qty (user input or full LP qty)
   - sequence_number (auto-increment per material: 1, 2, 3...)
   - status = 'reserved'
   - reserved_at = NOW()
   - reserved_by_user_id = current_user.id
   - notes (optional)

3. UPDATE license_plates:
   - status → 'reserved' (locked for this WO)
   - updated_at → NOW()

4. CREATE lp_genealogy record:
   - parent_lp_id = lp_id
   - child_lp_id = NULL (will be filled in Story 4.12 output registration)
   - wo_id
   - wo_material_reservation_id = FK to wo_material_reservations record just created
   - reserved_at = NOW()
   - reserved_by_user_id = current_user.id

5. EMIT EVENT: "material.reserved" (for realtime dashboard)

6. COMMIT transaction
```

**Success Criteria:**
- ✅ wo_material_reservations record created
- ✅ LP status changed to 'reserved'
- ✅ lp_genealogy record created with FK link
- ✅ No partial updates on error (full rollback)
- ✅ Audit trail recorded (user_id, timestamp)

---

### AC-4.7.4: Progress Tracking

**When** material reservations are updated
**Then** Materials table updates in realtime:
- Reserved Qty = SUM(reserved_qty) for all reservations of this material
- Remaining Qty = Required Qty - Reserved Qty
- Progress bar updates: (Reserved / Required) × 100%
- Status badge updates: "Complete" if >= 100%, "In Progress" if 1-99%, "Not Started" if 0%
- Reserved LPs list updates with new LP added in sequence order

**Example:**
- Material: "Flour", Required: 200kg
- Reserve LP-A: 80kg → Reserved: 80kg, Remaining: 120kg, Progress: 40%, Status: "In Progress"
- Reserve LP-B: 40kg → Reserved: 120kg, Remaining: 80kg, Progress: 60%, Status: "In Progress"
- Reserve LP-C: 80kg → Reserved: 200kg, Remaining: 0kg, Progress: 100%, Status: "Complete"

**Success Criteria:**
- ✅ Progress calculation accurate
- ✅ Updates in realtime
- ✅ Sequence order maintained

---

### AC-4.7.5: Unreservation Capability

**Given** material has reserved LPs
**When** clicking "Unreserve" button on material
**Then** allows operator to cancel reservation:
- Shows list of reserved LPs in reverse sequence order (most recent first)
- "Unreserve" button next to each LP
- Confirmation modal before removing

**When** confirming unreservation of LP:
**Then** system performs atomic transaction:

```
1. FIND wo_material_reservations record (wo_id, material_id, lp_id)
2. DELETE wo_material_reservations record
3. UPDATE license_plates: status → 'available' (unlocks LP)
4. DELETE lp_genealogy record (or mark as void)
5. EMIT EVENT: "material.unreserved"
6. COMMIT
```

**Success Criteria:**
- ✅ Unreservation removes reservation
- ✅ LP status reverts to 'available'
- ✅ Genealogy record removed
- ✅ Sequence numbers re-calculated for remaining reservations

---

### AC-4.7.6: API Endpoint - Reserve Material

**POST /api/production/work-orders/:id/materials/reserve**

```typescript
Request: {
  material_id: uuid,
  lp_id: uuid,
  reserved_qty: number,
  notes?: string
}

Response (200): {
  data: {
    id: uuid,
    wo_id: uuid,
    material_id: uuid,
    material_name: string,
    lp_id: uuid,
    lp_number: string,
    reserved_qty: number,
    uom: string,
    sequence_number: number,
    status: string,                    // "reserved"
    reserved_at: timestamp,
    reserved_by_user: {
      id: uuid,
      name: string
    }
  },
  message: "Material reserved successfully"
}

Error (400/403/404): {
  error: string,                       // Error code
  message: string,                     // User-friendly message
  details?: object
}
```

**Error Codes (AC-4.7.6):**
1. LP_NOT_FOUND - "License plate not found"
2. PRODUCT_MISMATCH - "LP product does not match material"
3. UOM_MISMATCH - "LP UoM does not match material"
4. INSUFFICIENT_QTY - "LP has 10kg available, requested 15kg for reservation"
5. LP_ALREADY_RESERVED - "LP already reserved for this WO"
6. WO_NOT_IN_PROGRESS - "WO must be in_progress to reserve materials"
7. CONSUME_WHOLE_LP_VIOLATION - "Material must use entire LP (50kg). Cannot reserve partial."
8. MATERIAL_NOT_IN_BOM - "Material not in WO BOM"
9. WO_NOT_FOUND - "Work order not found"
10. ORG_ISOLATION - (no details)
11. FORBIDDEN - "Insufficient permissions"
12. UNAUTHORIZED - (standard auth error)
13. VALIDATION_ERROR - (field-level validation)
14. CONCURRENCY_ERROR - "Material reservation modified by another user"

---

### AC-4.7.7: Unreservation API Endpoint

**DELETE /api/production/work-orders/:id/materials/reservations/:reservationId**

```typescript
Request: {}

Response (200): {
  data: {
    material_id: uuid,
    material_name: string,
    reserved_qty: number,
    lp_id: uuid,
    lp_number: string
  },
  message: "Reservation cancelled successfully"
}

Error (400/403/404): {
  error: string,
  message: string
}
```

---

### AC-4.7.8: Role-Based Access

**Given** I have specific role
**When** attempting to reserve materials
**Then** permissions:

| Role | Can Reserve | Can Unreserve |
|------|------------|---------------|
| Production Manager | ✅ Yes | ✅ Yes |
| Operator | ✅ Yes | ✅ Yes |
| Planner | ❌ No | ❌ No |
| Quality Manager | ❌ No | ❌ No |
| Admin | ✅ Yes | ✅ Yes |

**Success Criteria:**
- ✅ Role check on both APIs
- ✅ "Reserve" button hidden for non-authorized roles
- ✅ 403 error if unauthorized

---

### AC-4.7.9: Partial Consumption & LP Splitting (Phase 2 Preview)

**Context:** When material consumption happens (Story 4.12), if actual_consumed_qty < reserved_qty, LP is split:

```
Example: Reserved LP-A (100kg), only 60kg consumed
→ Create new LP-A-remainder (40kg, status='available')
→ Genealogy tracks: parent LP-A → child output LP (60kg consumed)
→ Remaining 40kg available for other WOs
```

**This AC describes the data model that enables Phase 2 splitting:**
- lp_genealogy.wo_material_reservation_id links genealogy to specific reservation
- Allows tracking partial consumption per reservation
- Enables LP splitting logic in Story 4.12

---

### AC-4.7.10: Genealogy Linking

**Given** material reservation created (AC-4.7.3)
**When** lp_genealogy record created
**Then** linking structure:

```sql
lp_genealogy:
  id = uuid
  parent_lp_id = lp_id (the reserved LP)
  child_lp_id = NULL (filled in Story 4.12)
  wo_id = wo_id
  wo_material_reservation_id = FK to wo_material_reservations (THIS ENABLES TRACEABILITY)
  reserved_at = timestamp
  reserved_by_user_id = user_id
```

**This enables:**
- [ ] Query: "Which materials went into WO?"
- [ ] Query: "Which output LP came from this reserved material?"
- [ ] Query: "What's the genealogy trail for this output?"
- [ ] Phase 2: LP splitting with partial consumption tracking

**Success Criteria:**
- ✅ FK to wo_material_reservations established
- ✅ Genealogy traceable back to specific reservation
- ✅ Supports Phase 2 partial consumption queries

---

### AC-4.7.11: Dashboard Integration

**Given** material reservations occur
**When** viewing production dashboard (Story 4.1)
**Then** displays:
- Materials tab showing all WOs with material reservation progress
- Color-coded by status: Green (complete), Yellow (in progress), Red (not started)
- Realtime updates via "material.reserved" event
- Material shortage alerts if remaining qty > available LPs

**Success Criteria:**
- ✅ Dashboard shows material reservations
- ✅ Realtime updates
- ✅ Shortage alerts visible

---

### AC-4.7.12: Validation & Error Messages

**Matrix of validation scenarios:**

| Scenario | Error Code | HTTP Status | Message |
|----------|-----------|------------|---------|
| LP barcode not found | LP_NOT_FOUND | 404 | "License plate LP-001 not found" |
| LP product ≠ material | PRODUCT_MISMATCH | 400 | "LP contains Flour, but material requires Rice" |
| LP UoM ≠ material | UOM_MISMATCH | 400 | "LP quantity in kg, but material requires units" |
| LP qty: 10kg, request 15kg | INSUFFICIENT_QTY | 400 | "LP-001 has 10kg available. Requested 15kg for reservation" |
| LP already reserved for WO | LP_ALREADY_RESERVED | 400 | "LP-001 already reserved for this WO" |
| WO status ≠ in_progress | WO_NOT_IN_PROGRESS | 400 | "WO must be in_progress to reserve materials" |
| consume_whole_lp=true, qty<LP.qty | CONSUME_WHOLE_LP_VIOLATION | 400 | "Material must use entire LP (50kg). Cannot reserve 30kg partial" |

**Success Criteria:**
- ✅ All error codes specific and actionable
- ✅ Error messages show affected values
- ✅ Large, readable error display (production floor context)

## Technical Tasks

### Backend

- [x] Task 1: Database Schema
  - [x] Verify wo_material_reservations table:
    - wo_id, material_id, lp_id, reserved_qty, sequence_number
    - status, reserved_at, reserved_by_user_id, notes
    - FK: wo_material_reservation_id on lp_genealogy
  - [x] Verify lp_genealogy table has wo_material_reservation_id FK
  - [x] Create RLS policies (org_id isolation)

- [x] Task 2: MaterialReservationService
  - [x] Implement reserveMaterial() with atomic transaction
  - [x] Implement unreserveMaterial() with atomic transaction
  - [x] Implement validation: LP exists, product match, UoM match, qty check, consume_whole_lp constraint
  - [x] Implement event emission: "material.reserved", "material.unreserved"
  - [x] All 14 error codes with specific messages

- [x] Task 3: API Endpoints
  - [x] POST /api/production/work-orders/:id/materials/reserve
  - [x] DELETE /api/production/work-orders/:id/materials/reservations/:reservationId
  - [x] Add auth & role checks (Production Manager, Operator, Admin only)
  - [x] Add error handling with specific codes

### Frontend

- [x] Task 4: Material Reservations Page
  - [x] Create WO Materials Table component
  - [x] Show all BOM materials with Required/Reserved/Remaining/Progress
  - [x] Show Reserved LPs in sequence order
  - [x] "Reserve" and "Unreserve" action buttons (conditional)

- [x] Task 5: Material Reservation Modal
  - [x] Create MaterialReservationModal component
  - [x] LP search/scan input with auto-suggest
  - [x] Conditional qty input (based on consume_whole_lp flag)
  - [x] Sequence indicator display
  - [x] Notes field
  - [x] Validation error messages
  - [x] Loading/Success/Error states

- [x] Task 6: Unreservation UI
  - [x] Show list of reserved LPs for material
  - [x] "Unreserve" button per LP (reverse order)
  - [x] Confirmation modal before deleting

### Testing

- [x] Task 7: Unit Tests
  - [x] Test reserveMaterial with valid data
  - [x] Test all 14 error scenarios
  - [x] Test atomic transaction rollback
  - [x] Test sequence number auto-increment
  - [x] Test consume_whole_lp validation
  - [x] Target 95% coverage

- [x] Task 8: Integration Tests
  - [x] Test POST /api/production/work-orders/:id/materials/reserve (200)
  - [x] Test all error codes (400/403/404)
  - [x] Test org isolation
  - [x] Test role-based access
  - [x] Test DELETE unreservation
  - [x] Target 70% coverage

- [x] Task 9: E2E Tests
  - [x] Create test WO in_progress
  - [x] Navigate to materials page
  - [x] Reserve LP-A for material 1
  - [x] Verify progress bar updates
  - [x] Reserve LP-B for material 1
  - [x] Verify material marked "Complete"
  - [x] Unreserve LP-A
  - [x] Verify progress reverts
  - [x] Test error scenarios (insufficient qty, product mismatch, etc.)

## Dev Notes

### Architecture Patterns
- **Two-Table Pattern**: wo_material_reservations (reserved state) + wo_consumption (consumed state)
- **Genealogy Linking**: FK wo_material_reservation_id enables traceability
- **Atomic Transactions**: No partial updates, full rollback on error
- **Event-Driven**: Events for realtime dashboard updates
- **LP Splitting Ready**: Data model supports Phase 2 partial consumption & splitting

### Learnings from Previous Stories
- Sequence enforcement from Story 4.4
- Genealogy creation from Story 4.6
- WO status validation (must be in_progress)
- Modal patterns from Story 4.2

### Constraints & Decisions
- **WO must be in_progress**: No reservations once WO completed
- **Sequence per material**: LP #1, #2, #3 for specific material
- **consume_whole_lp integration**: From Story 4.9 (conditional qty input)
- **Partial consumption deferred to Phase 2**: Phase 1 assumes full LP consumption
- **Genealogy created immediately**: Not waiting for output registration

### Critical Data Model
```sql
wo_material_reservations:
  id (PK)
  wo_id (FK)
  material_id (FK from BOM)
  lp_id (FK)
  reserved_qty (decimal)
  sequence_number (int) -- per material
  status = 'reserved'
  reserved_at (timestamp)
  reserved_by_user_id (FK)

lp_genealogy:
  parent_lp_id = lp_id (reserved LP)
  child_lp_id = NULL (filled in Story 4.12)
  wo_material_reservation_id (FK) ← ENABLES TRACEABILITY
```

## Status

- **Created:** 2025-11-27
- **Updated:** 2025-12-03 (Code Review APPROVED - all 12 ACs verified)
- **Current Status:** Done
- **Completion Date:** 2025-12-03

## Code Review Notes (2025-12-03)

**Reviewer:** AI Senior Developer
**Outcome:** ✅ APPROVED

### AC Verification: 12/12 PASSED
### Task Verification: 9/9 VERIFIED

### Advisory Notes:
- Note: Manual rollback pattern is correct (Supabase limitation)
- Note: `Number()` precision OK for typical production quantities
- Note: Consider rate limiting in future

## Implementation Notes (2025-12-03)

### Files Implemented
- `lib/supabase/migrations/037_create_wo_material_reservations.sql` - DB schema
- `lib/services/material-reservation-service.ts` - Service layer
- `app/api/production/work-orders/[id]/materials/reserve/route.ts` - Reserve API
- `app/api/production/work-orders/[id]/materials/reservations/[reservationId]/route.ts` - Unreserve API
- `app/api/production/work-orders/[id]/materials/available-lps/route.ts` - LP search API
- `components/production/MaterialReservationsTable.tsx` - Materials table
- `components/production/MaterialReservationModal.tsx` - Reserve modal
- `components/production/UnreserveConfirmDialog.tsx` - Unreserve confirmation
- `e2e/story-4.7-material-reservation.spec.ts` - E2E tests

### Key Implementation Details
- All 14 error codes implemented with specific messages
- Atomic transaction with manual rollback on error
- Genealogy record created at reservation time (child_lp_id = NULL until output)
- Sequence number auto-increment per material
- consume_whole_lp validation enforced
- Real-time event emission for dashboard updates
