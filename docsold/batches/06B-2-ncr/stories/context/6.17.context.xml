<?xml version="1.0" encoding="UTF-8"?>
<story>
  <metadata>
    <id>6.17</id>
    <title>Link NCRs to Source Documents</title>
    <batch>06B-2</batch>
    <status>drafted</status>
  </metadata>

  <description>Link NCRs to LPs/WOs/POs for root cause traceability</description>

  <dependencies>
    <requires>
      <story id="6.15">NCR Creation</story>
    </requires>
  </dependencies>

  <technical_context>
    <tables>
      <table>
        <name>ncr_links</name>
        <columns>
          <column>id uuid PRIMARY KEY</column>
          <column>ncr_id uuid NOT NULL REFERENCES non_conformance_reports(id) ON DELETE CASCADE</column>
          <column>link_type text NOT NULL CHECK (link_type IN ('lp', 'wo', 'po', 'supplier'))</column>
          <column>link_id uuid NOT NULL</column>
          <column>created_at timestamptz DEFAULT now()</column>
        </columns>
      </table>
    </tables>

    <api_endpoints>
      <endpoint method="POST" path="/api/quality/ncrs/:id/links">Add link to NCR</endpoint>
    </api_endpoints>
  </technical_context>

  <acceptance_criteria>
    <ac id="1">Link to: LP (material defect), WO (process), PO (supplier)</ac>
    <ac id="2">Multiple links allowed</ac>
    <ac id="3">Linked documents show related NCRs</ac>
  </acceptance_criteria>

  <functional_requirements>
    <fr id="QC-FR-19">System shall link NCRs to LPs, WOs, POs</fr>
  </functional_requirements>
</story>
