<story-context id="4-14-by-product-registration" v="1.0">
  <metadata>
    <epicId>4</epicId>
    <storyId>14</storyId>
    <title>By-Product Registration</title>
    <status>drafted</status>
    <generatedAt>2025-11-27</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <template>Sequential Modal Pattern + Auto-Create Toggle</template>
    <estimatedEffort>0.5 day</estimatedEffort>
    <priority>P0</priority>
  </metadata>

  <story>
    <asA>Operator</asA>
    <iWant>to register by-products</iWant>
    <soThat>all outputs are tracked</soThat>
    <tasks>
      <task id="1" ac="AC-4.14.1">By-product detection logic after main output registration</task>
      <task id="2" ac="AC-4.14.1,AC-4.14.2,AC-4.14.3">By-product registration modal/form with expected qty calculation</task>
      <task id="3" ac="AC-4.14.4,AC-4.14.5">LP auto-creation and genealogy linking for by-products</task>
      <task id="4" ac="AC-4.14.6">Auto-create toggle implementation (production_settings)</task>
      <task id="5" ac="AC-4.14.7">API endpoint POST /api/production/work-orders/:id/by-products</task>
      <task id="6">E2E tests for by-product registration flow</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC-4.14.1">
      By-Product Detection &amp; Sequential Prompting:
      - After main output registration (Story 4.12) completes
      - System checks: are there by-products defined in wo_materials (from BOM snapshot, Story 3.10)?
      - If yes &amp; auto_create_by_product_lp = false (default): Display by-product registration dialog for each by-product
        * Operator enters by-product qty
        * System auto-consumes reserved materials for by-product using sequential allocation (same as main output)
        * Over-consumption check applies (Story 4.11)
      - If yes &amp; auto_create_by_product_lp = true: Auto-create by-product LPs with calculated qty (no prompt, auto-consume applies)
      - If no by-products: Registration complete, return to WO detail
    </criterion>
    <criterion id="AC-4.14.2">
      Expected Qty Calculation:
      - Shows expected qty: wo_qty × yield_percent / 100
      - Example: WO qty = 1000kg, by-product yield_percent = 15 → expected qty = 150kg
    </criterion>
    <criterion id="AC-4.14.3">
      Qty Adjustment:
      - Operator can adjust actual qty from expected qty
      - By-product LP created with adjusted qty
    </criterion>
    <criterion id="AC-4.14.4">
      By-Product LP Creation:
      - By-product LP created same as main output (Story 4.12):
        * product_id = by-product product_id (from wo_materials)
        * batch_number = WO.wo_number (same batch as main output)
        * expiry_date calculated from by-product.shelf_life_days
        * status = 'available'
        * location_id = line.default_output_location_id
    </criterion>
    <criterion id="AC-4.14.5">
      Genealogy Linking:
      - By-product LP linked to same genealogy as main output
      - lp_genealogy record: parent_lp_id = consumed material LP, child_lp_id = by-product LP
      - Same consumed materials used for both main output &amp; by-products (shared genealogy)
    </criterion>
    <criterion id="AC-4.14.6">
      Auto-Create Option:
      - If production_settings.auto_create_by_product_lp = true
      - When main output registered, by-product LPs auto-created (no prompt)
      - Qty calculated from expected formula (wo_qty × yield_percent / 100)
      - Same genealogy, LP creation, and consumption logic
    </criterion>
    <criterion id="AC-4.14.7">
      API Endpoint:
      - POST /api/production/work-orders/:id/by-products
      - Request body: { product_id, qty, qa_status? }
      - Response: { by_product_lp_id, lp_number, consumed_lps }
    </criterion>
    <criterion id="AC-4.14.8">
      Prerequisites:
      - Requires Story 4.12 (Output Registration) for main output flow
      - Requires Story 3.10 (WO BOM snapshot) for by-product definitions in wo_materials
    </criterion>
  </acceptanceCriteria>

  <uxDesign>
    <designSystem>
      <reference>
        <doc>docs/ux-design/ux-design-shared-system.md</doc>
        <section>3. Component Library - Modal Pattern</section>
        <note>Use shared modal pattern with form validation, same as Story 4.12</note>
      </reference>
      <reference>
        <doc>docs/ux-design/ux-design-production-module.md</doc>
        <section>Real-Time Production Board - WO Details Modal</section>
        <note>By-product registration triggered after main output registration completes</note>
      </reference>
    </designSystem>
    <components>
      <component>
        <name>ByProductRegistrationModal</name>
        <path>apps/frontend/components/production/ByProductRegistrationModal.tsx</path>
        <kind>Sequential Modal (displayed after main output modal)</kind>
        <fields>
          <field name="product_id" type="readonly" note="Pre-filled from wo_materials by-product" />
          <field name="product_name" type="readonly" note="Display only, shows by-product name" />
          <field name="expected_qty" type="readonly" note="Calculated: wo_qty × yield_percent / 100" />
          <field name="actual_qty" type="number" required="true" default="expected_qty" validation="&gt; 0" />
          <field name="qa_status" type="select" required="conditional" note="Required if Settings.production_settings.require_qa_status = true" />
          <field name="notes" type="textarea" required="false" maxLength="500" />
        </fields>
        <actions>
          <action label="Register By-Product" color="green-600" type="submit" />
          <action label="Skip" color="gray-600" type="button" note="Skip this by-product, move to next (if multiple)" />
        </actions>
        <note>If multiple by-products, modal shows sequentially (one after another)</note>
      </component>
      <component>
        <name>ByProductAutoCreateIndicator</name>
        <path>apps/frontend/components/production/OutputRegistrationModal.tsx</path>
        <kind>Inline info badge</kind>
        <note>
          If auto_create_by_product_lp = true, show badge in main output modal:
          "ℹ By-products will be auto-created after registration"
        </note>
      </component>
    </components>
    <colorPalette>
      <color name="Primary (Create/CTA)" value="green-600" hex="#16a34a" />
      <color name="Secondary (Skip)" value="gray-600" hex="#4b5563" />
      <color name="Info (Auto-create badge)" value="blue-500" hex="#3b82f6" />
    </colorPalette>
    <workflow>
      <step>1. Main output registration completes (Story 4.12)</step>
      <step>2. System checks wo_materials for is_by_product = true entries</step>
      <step>3. If found AND auto_create_by_product_lp = false: Show ByProductRegistrationModal for each by-product</step>
      <step>4. If found AND auto_create_by_product_lp = true: Auto-create by-product LPs, show toast "2 by-products auto-created"</step>
      <step>5. If not found: Return to WO detail page</step>
    </workflow>
  </uxDesign>

  <databaseSchema>
    <tables>
      <table name="wo_materials">
        <description>WO BOM snapshot with by-product definitions (from Story 3.10)</description>
        <relevantColumns>
          <column name="id" type="uuid" pk="true" />
          <column name="wo_id" type="uuid" fk="work_orders.id" />
          <column name="product_id" type="uuid" fk="products.id" note="Material product (main) or by-product product" />
          <column name="quantity_required" type="numeric" check="&gt; 0" />
          <column name="uom" type="varchar" />
          <column name="is_by_product" type="boolean" default="false" note="TRUE = by-product (output), FALSE = material (input)" />
          <column name="yield_percent" type="numeric" check="0-100" nullable="true" note="Required if is_by_product = true, e.g., 15 = 15% of main output" />
          <column name="consume_whole_lp" type="boolean" default="false" />
        </relevantColumns>
        <note>Table exists from Epic 3, populated during WO BOM snapshot creation (Story 3.10)</note>
      </table>
      <table name="production_outputs">
        <description>Tracks both main outputs and by-product outputs</description>
        <relevantColumns>
          <column name="id" type="uuid" pk="true" />
          <column name="org_id" type="uuid" fk="organizations.id" />
          <column name="wo_id" type="uuid" fk="work_orders.id" />
          <column name="output_lp_id" type="uuid" fk="license_plates.id" />
          <column name="output_type" type="varchar" values="main|by-product" default="main" note="NEW COLUMN - distinguishes main vs by-product outputs" />
          <column name="by_product_product_id" type="uuid" fk="products.id" nullable="true" note="NEW COLUMN - product_id if output_type = 'by-product'" />
          <column name="quantity" type="numeric" check="&gt; 0" />
          <column name="uom" type="varchar" />
          <column name="registered_at" type="timestamptz" default="now()" />
          <column name="registered_by" type="uuid" fk="users.id" />
          <column name="notes" type="text" nullable="true" />
        </relevantColumns>
        <note>Extend table from Story 4.12 to support by-product outputs</note>
      </table>
      <table name="license_plates">
        <description>Stores by-product output LPs</description>
        <relevantColumns>
          <column name="id" type="uuid" pk="true" />
          <column name="lp_number" type="varchar" unique="true" />
          <column name="batch_number" type="varchar" note="Same as main output: WO.wo_number" />
          <column name="product_id" type="uuid" fk="products.id" note="By-product product_id" />
          <column name="quantity" type="numeric" check="&gt; 0" />
          <column name="uom" type="varchar" />
          <column name="status" type="varchar" default="available" />
          <column name="expiry_date" type="date" nullable="true" note="Calculated from by_product.shelf_life_days" />
          <column name="qa_status" type="varchar" nullable="true" />
        </relevantColumns>
        <note>Same table as main output LPs, product_id differentiates by-product vs main product</note>
      </table>
      <table name="lp_genealogy">
        <description>Genealogy graph linking consumed materials → by-product outputs</description>
        <relevantColumns>
          <column name="id" type="uuid" pk="true" />
          <column name="parent_lp_id" type="uuid" fk="license_plates.id" note="Consumed material LP (same as main output)" />
          <column name="child_lp_id" type="uuid" fk="license_plates.id" note="By-product output LP" />
          <column name="relationship_type" type="varchar" values="split|combine|transform" note="Use 'transform' for by-product production" />
          <column name="work_order_id" type="uuid" fk="work_orders.id" />
          <column name="quantity_from_parent" type="numeric" check="&gt; 0" />
          <column name="produced_at" type="timestamptz" note="Set during by-product registration" />
        </relevantColumns>
        <note>By-products share same consumed materials as main output (genealogy linking)</note>
      </table>
      <table name="production_settings">
        <description>Production module settings (NEW TABLE or extend organization_settings)</description>
        <schema>
          <column name="id" type="uuid" pk="true" default="gen_random_uuid()" />
          <column name="org_id" type="uuid" fk="organizations.id" unique="true" />
          <column name="auto_create_by_product_lp" type="boolean" default="false" note="If TRUE, auto-create by-product LPs without prompting operator" />
          <column name="require_qa_status" type="boolean" default="false" note="If TRUE, qa_status required for all outputs" />
          <column name="created_at" type="timestamptz" default="now()" />
          <column name="updated_at" type="timestamptz" default="now()" />
        </schema>
        <note>To be created in Task 4 migration (or extend existing organization_settings table)</note>
      </table>
    </tables>
    <migrations>
      <migration name="add_by_product_support_to_production_outputs" file="supabase/migrations/XXX_add_by_product_support.sql">
        <action>ALTER TABLE production_outputs ADD COLUMN output_type VARCHAR DEFAULT 'main'</action>
        <action>ALTER TABLE production_outputs ADD COLUMN by_product_product_id UUID REFERENCES products(id)</action>
        <action>CREATE TABLE production_settings (if not exists, or extend organization_settings)</action>
        <action>ADD COLUMN auto_create_by_product_lp BOOLEAN DEFAULT false to production_settings</action>
      </migration>
    </migrations>
  </databaseSchema>

  <apiPatterns>
    <endpoint>
      <method>POST</method>
      <path>/api/production/work-orders/:id/by-products</path>
      <requestBody>
        {
          "product_id": "uuid (required, by-product product_id from wo_materials)",
          "qty": "number (required, &gt; 0)",
          "qa_status": "string (optional, required if Settings.require_qa_status)"
        }
      </requestBody>
      <responseBody>
        {
          "success": true,
          "data": {
            "by_product_lp_id": "uuid",
            "lp_number": "string",
            "consumed_lps": ["lp_id1", "lp_id2"],
            "qty": "number"
          }
        }
      </responseBody>
      <implementation>
        <file>apps/frontend/app/api/production/work-orders/[id]/by-products/route.ts</file>
        <pattern>
          - Validate WO status = 'in_progress'
          - Validate product_id exists in wo_materials with is_by_product = true
          - Validate qty &gt; 0
          - Create by-product LP (license_plates): product_id, batch_number = WO.wo_number, expiry_date from shelf_life
          - Create production_outputs record: output_type = 'by-product', by_product_product_id = product_id
          - Use same consumed materials as main output (shared genealogy)
          - Create lp_genealogy records linking consumed LPs → by-product LP
          - Return by-product LP details
        </pattern>
      </implementation>
      <errorHandling>
        <error code="400" condition="qty &lt;= 0">By-product quantity must be &gt; 0</error>
        <error code="400" condition="WO status != 'in_progress'">WO not in progress</error>
        <error code="400" condition="product_id not in wo_materials as by-product">Product is not a by-product for this WO</error>
        <error code="400" condition="qa_status required but missing">QA status is required</error>
      </errorHandling>
    </endpoint>
    <reference>
      <existingPattern>apps/frontend/app/api/production/work-orders/[id]/outputs/route.ts (Story 4.12)</existingPattern>
      <note>Follow same pattern as main output registration, reuse LP creation &amp; genealogy logic</note>
    </reference>
  </apiPatterns>

  <services>
    <service>
      <name>ByProductService</name>
      <file>apps/frontend/lib/services/by-product-service.ts</file>
      <methods>
        <method name="detectByProducts">
          <description>Detect if WO has by-products defined in wo_materials</description>
          <parameters>woId: string</parameters>
          <returns>Promise&lt;{ product_id, product_name, expected_qty, yield_percent }[]&gt;</returns>
          <logic>
            1. Query wo_materials WHERE wo_id = woId AND is_by_product = true
            2. For each by-product: calculate expected_qty = wo_qty × yield_percent / 100
            3. Return array of by-products with expected qty
          </logic>
        </method>
        <method name="registerByProduct">
          <description>Register by-product output, create LP, link genealogy</description>
          <parameters>woId: string, productId: string, qty: number, qa_status?: string</parameters>
          <returns>Promise&lt;{ by_product_lp_id, lp_number, consumed_lps }&gt;</returns>
          <logic>
            1. Create by-product LP (license_plates): product_id, batch_number = WO.wo_number, expiry_date
            2. Create production_outputs record: output_type = 'by-product', by_product_product_id
            3. Get consumed LPs from main output (lp_genealogy WHERE work_order_id = woId)
            4. Create lp_genealogy records linking consumed LPs → by-product LP
            5. Return by-product LP details
          </logic>
        </method>
        <method name="autoCreateByProducts">
          <description>Auto-create by-product LPs without operator prompt (if auto_create_by_product_lp = true)</description>
          <parameters>woId: string</parameters>
          <returns>Promise&lt;{ by_product_lp_ids: string[], count: number }&gt;</returns>
          <logic>
            1. Detect by-products (detectByProducts)
            2. For each by-product: registerByProduct with expected_qty (no prompt)
            3. Return array of created by-product LP IDs
          </logic>
        </method>
        <method name="calculateExpectedQty">
          <description>Calculate expected by-product qty from WO qty &amp; yield_percent</description>
          <parameters>woQty: number, yieldPercent: number</parameters>
          <returns>number</returns>
          <logic>woQty × yieldPercent / 100</logic>
        </method>
      </methods>
    </service>
    <reference>
      <existingService>apps/frontend/lib/services/output-service.ts (Story 4.12)</existingService>
      <note>Reuse LP creation &amp; genealogy logic from output-service.ts</note>
    </reference>
  </services>

  <testingStrategy>
    <e2eTests>
      <testFile>tests/e2e/by-product-registration.spec.ts</testFile>
      <scenarios>
        <scenario name="By-product registration after main output">
          <steps>
            1. Create test organization + user
            2. Create test WO with main product (Product-A) + by-product (Product-B, yield_percent = 15)
            3. Populate wo_materials: Product-A (main), Product-B (is_by_product = true, yield_percent = 15)
            4. Create reserved LPs for WO
            5. Register main output: qty = 1000kg
            6. Verify by-product modal appears
            7. Verify expected_qty = 1000 × 15 / 100 = 150kg
            8. Adjust actual_qty = 140kg
            9. Confirm by-product registration
            10. Verify by-product LP created: product_id = Product-B, qty = 140kg, batch_number = WO.wo_number
            11. Verify lp_genealogy record created linking consumed LP → by-product LP
            12. Verify production_outputs record: output_type = 'by-product', by_product_product_id = Product-B
          </steps>
        </scenario>
        <scenario name="Multiple by-products sequential registration">
          <steps>
            1. Create WO with 2 by-products (Product-B, Product-C)
            2. Register main output
            3. Verify first by-product modal (Product-B)
            4. Register Product-B, click "Register By-Product"
            5. Verify second by-product modal (Product-C)
            6. Register Product-C
            7. Verify both by-product LPs created
          </steps>
        </scenario>
        <scenario name="Skip by-product registration">
          <steps>
            1. Create WO with by-product
            2. Register main output
            3. Verify by-product modal
            4. Click "Skip"
            5. Verify modal closes, no by-product LP created
            6. Verify can manually register by-product later from WO detail page
          </steps>
        </scenario>
        <scenario name="Auto-create by-products (no prompt)">
          <steps>
            1. Enable production_settings.auto_create_by_product_lp = true
            2. Create WO with by-product (yield_percent = 15)
            3. Register main output: qty = 1000kg
            4. Verify NO by-product modal shown
            5. Verify by-product LP auto-created: qty = 150kg (expected_qty)
            6. Verify toast: "1 by-product auto-created"
          </steps>
        </scenario>
        <scenario name="By-product genealogy shared with main output">
          <steps>
            1. Create WO with reserved LPs: LP-A (80kg), LP-B (40kg)
            2. Register main output: qty = 100kg (consumes LP-A + partial LP-B)
            3. Register by-product: qty = 15kg
            4. Verify by-product genealogy: parent_lp_id = LP-A &amp; LP-B (same as main output)
            5. Verify both main output LP &amp; by-product LP linked to same consumed LPs
          </steps>
        </scenario>
        <scenario name="Error handling - invalid by-product product_id">
          <steps>
            1. Try to register by-product with product_id NOT in wo_materials
            2. Verify error: "Product is not a by-product for this WO"
          </steps>
        </scenario>
      </scenarios>
    </e2eTests>
    <unitTests>
      <testFile>tests/unit/services/by-product-service.test.ts</testFile>
      <scenarios>
        <test name="calculateExpectedQty returns correct value">
          woQty: 1000, yieldPercent: 15 → expectedQty: 150
        </test>
        <test name="calculateExpectedQty handles decimal yield_percent">
          woQty: 1000, yieldPercent: 12.5 → expectedQty: 125
        </test>
        <test name="detectByProducts returns empty array if no by-products">
          wo_materials has no is_by_product = true → []
        </test>
      </scenarios>
    </unitTests>
    <fixtures>
      <fixture name="createTestWOWithByProducts">
        <file>tests/e2e/fixtures/test-setup.ts</file>
        <returns>{ woId, main_product_id, by_product_ids, yield_percents }</returns>
      </fixture>
    </fixtures>
  </testingStrategy>

  <integrationPoints>
    <dependency>
      <storyId>4.12</storyId>
      <title>Output Registration (Desktop)</title>
      <reason>By-product registration triggered AFTER main output registration completes</reason>
      <tables>production_outputs, lp_genealogy</tables>
    </dependency>
    <dependency>
      <storyId>3.10</storyId>
      <title>WO BOM Snapshot</title>
      <reason>By-products defined in wo_materials with is_by_product = true, yield_percent</reason>
      <tables>wo_materials</tables>
    </dependency>
    <dependency>
      <epicId>2</epicId>
      <title>Technical - BOM By-Products</title>
      <reason>BOM defines by-products with yield_percent, copied to wo_materials during WO creation</reason>
      <tables>bom_items (is_by_product, yield_percent)</tables>
    </dependency>
    <dependency>
      <storyId>4.17</storyId>
      <title>Production Settings</title>
      <reason>Auto-create toggle: production_settings.auto_create_by_product_lp</reason>
      <tables>production_settings</tables>
    </dependency>
  </integrationPoints>

  <businessLogic>
    <rule name="By-Product Detection">
      <description>
        After main output registration (Story 4.12), system checks wo_materials for:
        - is_by_product = true
        If found, prompts operator to register each by-product (unless auto-create enabled)
      </description>
    </rule>
    <rule name="Expected Qty Calculation">
      <description>
        Expected by-product qty = wo_qty × yield_percent / 100
        Example: WO qty = 1000kg, yield_percent = 15 → expected qty = 150kg
        Operator can adjust actual qty from expected qty
      </description>
    </rule>
    <rule name="Sequential By-Product Registration">
      <description>
        If WO has multiple by-products (e.g., Product-B, Product-C):
        1. Register main output
        2. Show modal for Product-B → register → close
        3. Show modal for Product-C → register → close
        4. Return to WO detail page
        Modals shown sequentially, not all at once
      </description>
    </rule>
    <rule name="Shared Genealogy">
      <description>
        By-products share same consumed materials as main output:
        - Main output consumes LP-A (80kg) + LP-B (40kg)
        - By-product also linked to LP-A + LP-B in lp_genealogy
        Result: Both main output LP &amp; by-product LP have same parent LPs (full traceability)
      </description>
    </rule>
    <rule name="Auto-Create Logic">
      <description>
        If production_settings.auto_create_by_product_lp = true:
        1. Main output registered
        2. System detects by-products
        3. Auto-create by-product LPs with expected_qty (no operator prompt)
        4. Show toast: "N by-products auto-created"
        Result: Faster workflow, no manual registration
      </description>
    </rule>
    <rule name="Batch Number Consistency">
      <description>
        By-product LP batch_number = WO.wo_number (same as main output)
        Ensures all outputs from same WO (main + by-products) have same batch for traceability
      </description>
    </rule>
  </businessLogic>

  <relatedStories>
    <story id="4.12" title="Output Registration (Desktop)" relationship="prerequisite" note="By-products registered AFTER main output" />
    <story id="3.10" title="WO BOM Snapshot" relationship="prerequisite" note="wo_materials populated with by-product definitions" />
    <story id="4.13" title="Output Registration (Scanner)" relationship="parallel" note="Scanner version also supports by-product registration" />
    <story id="4.17" title="Production Settings" relationship="integrates" note="Auto-create toggle in production_settings" />
    <story id="2.7" title="BOM By-Products" relationship="upstream" note="BOM defines by-products, copied to wo_materials" />
  </relatedStories>

  <technicalNotes>
    <note>Use Supabase transactions for atomic operations (create by-product LP + genealogy + production_outputs)</note>
    <note>By-product LP number auto-generated from sequence (e.g., LP-2024-001, LP-2024-002)</note>
    <note>By-product expiry_date calculated from by-product.shelf_life_days (not main product)</note>
    <note>By-product modal shown sequentially if multiple by-products (not all at once)</note>
    <note>Auto-create uses expected_qty (no operator adjustment)</note>
    <note>Operator can skip by-product registration via "Skip" button</note>
    <note>By-products can be manually registered later from WO detail page if skipped</note>
    <note>production_outputs.output_type = 'by-product' distinguishes from main outputs</note>
  </technicalNotes>

  <references>
    <doc>docs/stories/04-14-by-product-registration.md</doc>
    <doc>docs/stories/04-12-output-registration-desktop.md</doc>
    <doc>docs/epics/04-production.md</doc>
    <doc>docs/epics/02-technical.md (BOM by-products)</doc>
    <doc>docs/ux-design/ux-design-shared-system.md</doc>
    <doc>docs/ux-design/ux-design-production-module.md</doc>
  </references>
</story-context>
