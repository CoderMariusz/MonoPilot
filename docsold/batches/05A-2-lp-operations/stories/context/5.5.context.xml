<?xml version="1.0" encoding="UTF-8"?>
<story>
  <metadata>
    <id>5.5</id>
    <title>LP Split</title>
    <batch>5A-2</batch>
    <points>5</points>
    <effort_hours>5-6</effort_hours>
    <status>todo</status>
  </metadata>

  <description>Allow warehouse users to split an LP into smaller quantities with automatic genealogy tracking</description>

  <dependencies>
    <requires>
      <story id="5.1">License Plate Creation</story>
      <story id="5.4">LP Number Generation</story>
    </requires>
    <enables>
      <story id="5.7">LP Genealogy Tracking</story>
      <story id="5.16">Partial Move</story>
    </enables>
  </dependencies>

  <technical_context>
    <tables>
      <table>
        <name>license_plates</name>
        <columns>
          <column name="id" type="UUID" constraint="PK"/>
          <column name="org_id" type="UUID" constraint="FK organizations(id)"/>
          <column name="lp_number" type="VARCHAR(50)" constraint="UNIQUE(org_id, lp_number)"/>
          <column name="product_id" type="UUID" constraint="FK products(id)"/>
          <column name="quantity" type="DECIMAL(15,4)" constraint="NOT NULL"/>
          <column name="uom" type="VARCHAR(10)" constraint="NOT NULL"/>
          <column name="batch_number" type="VARCHAR(50)" constraint="NOT NULL"/>
          <column name="supplier_batch_number" type="VARCHAR(50)"/>
          <column name="manufacture_date" type="DATE"/>
          <column name="expiry_date" type="DATE"/>
          <column name="location_id" type="UUID" constraint="FK locations(id)"/>
          <column name="status" type="VARCHAR(20)" constraint="DEFAULT 'available'"/>
          <column name="created_at" type="TIMESTAMP" constraint="DEFAULT now()"/>
          <column name="updated_at" type="TIMESTAMP" constraint="DEFAULT now()"/>
        </columns>
      </table>
      <table>
        <name>lp_genealogy</name>
        <columns>
          <column name="id" type="UUID" constraint="PK"/>
          <column name="org_id" type="UUID" constraint="FK organizations(id)"/>
          <column name="parent_lp_id" type="UUID" constraint="FK license_plates(id)"/>
          <column name="child_lp_id" type="UUID" constraint="FK license_plates(id)"/>
          <column name="operation_type" type="VARCHAR(20)" constraint="NOT NULL, CHECK operation_type IN ('split','merge','consume','produce')"/>
          <column name="created_at" type="TIMESTAMP" constraint="DEFAULT now()"/>
          <column name="created_by_user_id" type="UUID" constraint="FK users(id)"/>
        </columns>
        <unique_constraint>UNIQUE(parent_lp_id, child_lp_id)</unique_constraint>
        <indexes>
          <index name="idx_lp_genealogy_org_id" columns="org_id"/>
          <index name="idx_lp_genealogy_parent" columns="parent_lp_id"/>
          <index name="idx_lp_genealogy_child" columns="child_lp_id"/>
          <index name="idx_lp_genealogy_created_at" columns="created_at"/>
        </indexes>
      </table>
      <table>
        <name>lp_number_sequence</name>
        <columns>
          <column name="id" type="UUID" constraint="PK"/>
          <column name="org_id" type="UUID" constraint="FK organizations(id)"/>
          <column name="sequence_date" type="DATE" constraint="NOT NULL"/>
          <column name="next_sequence" type="INT" constraint="DEFAULT 1"/>
        </columns>
        <unique_constraint>UNIQUE(org_id, sequence_date)</unique_constraint>
      </table>
    </tables>

    <api_endpoints>
      <endpoint method="POST" path="/api/warehouse/license-plates/:id/split">
        <description>Split LP into smaller quantity with new LP creation and genealogy tracking</description>
        <auth>authenticated</auth>
        <request>
          <field name="split_qty" type="decimal" required="true" constraint="split_qty > 0 AND split_qty < parent_qty"/>
          <field name="location_id" type="UUID" required="false" description="Destination location (defaults to parent location)"/>
          <field name="override_format" type="string" required="false" description="Custom LP number format"/>
        </request>
        <response status="200">
          <field name="parent_lp_id" type="UUID"/>
          <field name="parent_lp_number" type="string" example="LP-20250120-0001"/>
          <field name="parent_remaining_qty" type="decimal"/>
          <field name="child_lp_id" type="UUID"/>
          <field name="child_lp_number" type="string" example="LP-20250120-0002"/>
          <field name="child_qty" type="decimal"/>
          <field name="genealogy_id" type="UUID"/>
          <field name="success_message" type="string" example="LP split successfully"/>
        </response>
        <response status="400">
          <field name="error" type="string" example="Split qty must be between 1 and 100"/>
        </response>
        <response status="404">
          <field name="error" type="string" example="License Plate not found"/>
        </response>
      </endpoint>
    </api_endpoints>

    <frontend_routes>
      <route path="/warehouse/license-plates/:id" component="LicensePlatePage">
        <feature name="SplitButton">
          <description>Split button in LP detail actions</description>
          <action>Opens SplitLPModal</action>
          <visible_when>LP status is 'available' or 'reserved'</visible_when>
        </feature>
        <feature name="GenealogyTab">
          <description>Shows parent/child relationships</description>
          <action>Displays genealogy tree for this LP</action>
        </feature>
      </route>
      <route path="/warehouse/license-plates" component="LicensePlatePage">
        <feature name="SplitContextMenu">
          <description>Right-click context menu with Split option</description>
          <action>Opens SplitLPModal for selected LP</action>
        </feature>
      </route>
    </frontend_routes>

    <components_to_create>
      <component name="SplitLPModal">
        <description>Modal for splitting LP</description>
        <props>
          <prop name="lp" type="LicensePlate" required="true"/>
          <prop name="onSplit" type="callback" required="true"/>
        </props>
        <fields>
          <field name="currentQty" type="decimal" readonly="true"/>
          <field name="splitQty" type="decimal" required="true" validation="splitQty > 0 AND splitQty < currentQty"/>
          <field name="locationId" type="UUID" optional="true"/>
          <field name="overrideFormat" type="string" optional="true"/>
        </fields>
        <actions>
          <action name="validate">Check split_qty is valid</action>
          <action name="submit">Call POST /api/warehouse/license-plates/:id/split</action>
          <action name="onSuccess">Show toast, close modal, refresh LP list</action>
          <action name="onError">Show error message</action>
        </actions>
      </component>
    </components_to_create>

    <hooks_to_create>
      <hook name="useSplitLP">
        <description>Hook for splitting LP</description>
        <accepts>lp_id, split_qty, location_id (optional)</accepts>
        <returns>{ parent_lp, child_lp, genealogy_id, loading, error }</returns>
        <api_call>POST /api/warehouse/license-plates/:id/split</api_call>
      </hook>
      <hook name="useLicensePlates">
        <description>Fetch list of LPs (from 5.1)</description>
        <accepts>org_id, filters (optional)</accepts>
        <returns>{ lps, loading, error, refetch }</returns>
        <api_call>GET /api/warehouse/license-plates</api_call>
      </hook>
    </hooks_to_create>

    <validation_rules>
      <rule id="split_qty_positive">split_qty must be > 0</rule>
      <rule id="split_qty_less_than_parent">split_qty must be < parent_lp.quantity</rule>
      <rule id="parent_status_valid">Parent LP status must be 'available' or 'reserved'</rule>
      <rule id="parent_not_expired">Cannot split expired LP</rule>
      <rule id="child_inherits_product">Child LP inherits product_id from parent</rule>
      <rule id="child_inherits_batch">Child LP inherits batch_number from parent</rule>
      <rule id="child_inherits_expiry">Child LP inherits expiry_date from parent</rule>
      <rule id="child_inherits_uom">Child LP inherits uom from parent</rule>
      <rule id="child_new_lp_number">Child LP gets new auto-generated lp_number</rule>
      <rule id="child_location_default">Child location defaults to parent location or uses override_location</rule>
      <rule id="child_status_available">Child LP status = 'available'</rule>
      <rule id="parent_qty_updated">Parent LP qty -= split_qty</rule>
      <rule id="genealogy_recorded">Genealogy record created with operation_type='split'</rule>
    </validation_rules>

    <rls_policies>
      <policy table="license_plates">
        <select>
          <statement>SELECT * WHERE org_id = current_user.org_id</statement>
          <applies_to>authenticated</applies_to>
        </select>
        <insert>
          <statement>INSERT WHERE org_id = current_user.org_id</statement>
          <applies_to>authenticated</applies_to>
        </insert>
        <update>
          <statement>UPDATE WHERE org_id = current_user.org_id</statement>
          <applies_to>authenticated</applies_to>
        </update>
      </policy>
      <policy table="lp_genealogy">
        <select>
          <statement>SELECT * WHERE org_id = current_user.org_id</statement>
          <applies_to>authenticated</applies_to>
        </select>
        <insert>
          <statement>INSERT WHERE org_id = current_user.org_id</statement>
          <applies_to>authenticated</applies_to>
        </insert>
      </policy>
    </rls_policies>

    <database_operations>
      <operation type="transaction">
        <name>LP Split Transaction</name>
        <steps>
          <step>1. Validate split_qty > 0 AND split_qty < parent_qty</step>
          <step>2. Validate parent_lp_id exists</step>
          <step>3. BEGIN TRANSACTION</step>
          <step>4. UPDATE license_plates SET quantity = quantity - split_qty WHERE id = parent_lp_id</step>
          <step>5. INSERT license_plates (new child LP with split_qty)</step>
          <step>6. INSERT lp_genealogy (parent_lp_id, child_lp_id, operation_type='split')</step>
          <step>7. COMMIT TRANSACTION</step>
          <step>8. Return parent + child LP details</step>
        </steps>
        <rollback_condition>Any validation failure or INSERT failure</rollback_condition>
      </operation>
    </database_operations>
  </technical_context>

  <acceptance_criteria>
    <ac id="1" title="Split Modal">
      <test>Open LP detail page, click Split button → modal shows current LP number, qty, split qty input</test>
    </ac>
    <ac id="2" title="Quantity Validation">
      <test>Enter split_qty = 0 → error "must be > 0"</test>
      <test>Enter split_qty > parent_qty → error "cannot exceed parent"</test>
      <test>Enter valid split_qty (0 < split_qty < parent_qty) → no error</test>
    </ac>
    <ac id="3" title="Split Creation">
      <test>Split 100 qty LP by 50 → parent = 50, child = 50, both exist with separate LP numbers</test>
    </ac>
    <ac id="4" title="Genealogy Recording">
      <test>After split, genealogy record exists with parent_lp_id, child_lp_id, operation_type='split'</test>
    </ac>
    <ac id="5" title="Success Feedback">
      <test>After split, success toast shown: "LP split: LP-0001 (50 kg) → LP-0002 (50 kg)"</test>
    </ac>
  </acceptance_criteria>

  <test_plan>
    <unit_tests>
      <test>Split qty validation: 0, negative, > parent → error</test>
      <test>Parent qty decrement: 100 - 50 = 50 ✓</test>
      <test>Child LP created with correct qty</test>
      <test>Genealogy record created with correct fields</test>
      <test>Child inherits: product_id, batch_number, expiry_date, uom</test>
    </unit_tests>
    <integration_tests>
      <test>POST /api/warehouse/license-plates/:id/split with valid qty</test>
      <test>Verify parent updated, child created, genealogy recorded in transaction</test>
      <test>Verify child LP auto-numbered correctly using lp_number_sequence</test>
    </integration_tests>
    <e2e_tests>
      <test>Create LP with 100 qty in /warehouse/license-plates</test>
      <test>Click Split button on LP detail page</test>
      <test>Enter split_qty = 50</test>
      <test>Verify: parent.qty = 50, child.qty = 50, both visible in LP list</test>
      <test>Navigate to genealogy tab, verify parent → child relationship</test>
    </e2e_tests>
  </test_plan>

  <implementation_notes>
    <note priority="critical">Split operation must be atomic - if ANY step fails, rollback all changes (parent qty, child LP, genealogy)</note>
    <note priority="critical">Child LP must get NEW lp_number, not a copy of parent</note>
    <note priority="critical">LP number generation uses lp_number_sequence table - increment correctly for daily reset</note>
    <note priority="high">Child LP inherits product, batch, expiry, UoM from parent - immutable relationship</note>
    <note priority="high">Split can only happen on 'available' or 'reserved' LPs - prevent split of consumed/merged LPs</note>
    <note priority="medium">Consider UI for suggesting split qty based on existing quantities in warehouse</note>
    <note priority="medium">Add audit trail: record user_id and timestamp of split operation</note>
  </implementation_notes>
</story>
