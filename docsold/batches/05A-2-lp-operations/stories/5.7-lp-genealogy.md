# Story 5.7: LP Genealogy Tracking

**ID:** 5.7
**Batch:** 5A-2 (LP Operations)
**Story Points:** 8
**Effort:** 8-10 hours
**Status:** Todo

---

## User Story

> As a **System**, I want to track LP relationships, so that traceability is complete.

---

## Acceptance Criteria

### AC 1: Genealogy Recording
- **Given** LP operations occur (split, merge, consume, produce)
- **When** operation completes
- **Then** lp_genealogy records:
  - `parent_lp_id`: Source LP
  - `child_lp_id`: Result LP
  - `wo_id`: Work Order ID (if from production)
  - `operation_type`: 'split', 'merge', 'consume', 'produce'
  - `created_at`: Timestamp
  - `created_by_user_id`: Current user

### AC 2: Forward Trace
- **Given** viewing LP detail
- **When** clicking "Trace Forward"
- **Then** shows all child LPs and descendants:
  - Direct children (depth 1)
  - Grandchildren (depth 2)
  - Great-grandchildren (depth 3)
  - Up to max_depth = 10
  - Shows LP number, operation type, timestamp

### AC 3: Backward Trace
- **Given** viewing LP detail
- **When** clicking "Trace Backward"
- **Then** shows all parent LPs and ancestors:
  - Direct parent (depth 1)
  - Grandparent (depth 2)
  - Great-grandparent (depth 3)
  - Up to max_depth = 10
  - Shows LP number, operation type, timestamp

### AC 4: Genealogy Integrity & Atomicity (Sprint 0 Gap 2)

LP genealogy tracking ensures **FDA-compliant traceability** with guaranteed data integrity:

**Transaction Flow (Atomic Genealogy Creation):**

1. **START** database transaction
2. **VALIDATE** pre-conditions:
   - parent_lp_id exists in license_plates table (FK validation)
   - child_lp_id exists in license_plates table (FK validation)
   - Both LPs belong to same org_id (multi-tenant isolation)
   - wo_id exists if provided (FK validation)
   - operation_type is valid enum: 'split', 'merge', 'consume', 'produce'
   - No duplicate genealogy link (parent → child already exists)
3. **CHECK** for circular dependencies:
   - child_lp_id cannot be ancestor of parent_lp_id (prevent cycles)
   - Use recursive CTE to validate genealogy tree integrity
4. **INSERT** lp_genealogy record:
   - parent_lp_id, child_lp_id, wo_id, operation_type, created_at, created_by_user_id
5. **VERIFY** trace integrity:
   - Forward trace: parent → all descendants reachable
   - Backward trace: child → all ancestors reachable
6. **COMMIT** transaction

**Rollback Scenarios:**

**If ANY step fails** (FK violation, circular dependency, duplicate link):
- Transaction **ROLLBACK**
- **No genealogy record created** (maintain clean traceability tree)
- **Error message** displayed with specific failure reason

**Error Examples:**

| Failure Point | Error Message |
|---------------|---------------|
| Parent LP not exists | "Cannot create genealogy: Parent License Plate LP-001234 does not exist. Verify LP number." |
| Child LP not exists | "Cannot create genealogy: Child License Plate LP-005678 does not exist. Verify LP number." |
| Different orgs | "Cannot create genealogy: Parent and child LPs belong to different organizations. Cross-org genealogy not allowed." |
| Circular dependency | "Cannot create genealogy: Circular dependency detected. LP-001234 is already a descendant of LP-005678." |
| Duplicate link | "Cannot create genealogy: Link already exists between Parent LP-001234 and Child LP-005678." |
| Invalid WO | "Cannot create genealogy: Work Order #9999 does not exist or is not related to these LPs." |
| Invalid operation type | "Cannot create genealogy: Operation type 'transform' is invalid. Use: split, merge, consume, or produce." |

### AC 5: Trace Verification Integrity (Gap 2)

After every genealogy insert, system verifies:

1. **Forward Traceability:**
   - FROM parent_lp → trace all descendants (children, grandchildren, etc.)
   - Verify no broken links (all descendants reachable via recursive query)

2. **Backward Traceability:**
   - FROM child_lp → trace all ancestors (parents, grandparents, etc.)
   - Verify no broken links (all ancestors reachable via recursive query)

3. **Orphan Detection:**
   - If parent LP is deleted → children become orphans
   - System flags orphaned LPs in UI: "⚠️ LP-005678: Parent LP-001234 no longer exists (orphaned)"
   - Orphaned LPs still tracked for audit purposes (do not cascade delete genealogy)

### AC 6: Operation Type Semantics

| Operation Type | Parent LP | Child LP | WO Required | Use Case |
|---|---|---|---|---|
| **split** | Original LP | New split LPs | No | Split 100kg pallet → 2x 50kg pallets |
| **merge** | Multiple source LPs | New merged LP | No | Merge 2x 50kg pallets → 1x 100kg pallet |
| **consume** | Input material LP | Output finished good LP | Yes | WO consumes Flour LP → produces Bread LP |
| **produce** | Input material LP | Output finished good LP | Yes | Same as consume (legacy alias) |

### AC 7: Data Integrity Guarantees (FDA Compliance)

- ✅ Every consumed LP → linked to output LP via genealogy (full traceability)
- ✅ Every output LP → linked to all input LPs (backward trace)
- ✅ LP split → all child LPs linked to parent (forward trace)
- ✅ LP merge → all parent LPs linked to merged child (backward trace)
- ✅ Genealogy records immutable (no DELETE, no UPDATE, only INSERT)
- ✅ No circular dependencies (tree structure enforced)
- ✅ No cross-org genealogy (multi-tenant isolation)
- ❌ NEVER: Output LP without input LP genealogy (consumption)
- ❌ NEVER: Genealogy link without valid parent AND child LPs
- ❌ NEVER: Circular dependencies (A → B → C → A)
- ❌ NEVER: Broken traces (missing intermediate links)

### AC 8: Recall Simulation (Forward + Backward Trace)

**Scenario:** Recall all products affected by contaminated Flour batch LP-001234

1. **Forward Trace (Impact Analysis):**
   - Use recursive CTE to find all descendants
   - Result: All downstream LPs (Bread, Pastry, etc.) that used contaminated Flour

2. **Backward Trace (Root Cause Analysis):**
   - Use recursive CTE to find all ancestors
   - Result: All upstream LPs (Flour, Yeast, etc.) that contributed to contaminated Bread

---

## Technical Tasks

### Backend

- [ ] Implement genealogy creation logic in API
  - Validate all FK constraints
  - Check for duplicate links (idempotent)
  - Detect circular dependencies using recursive CTE
  - Insert genealogy record within transaction
  - Verify trace integrity post-insert

- [ ] Implement `/api/warehouse/license-plates/genealogy/trace` endpoint
  - Accept: lp_id, direction (forward|backward), max_depth
  - Return: genealogy tree with LP details
  - Handle circular dependency gracefully (cap depth)

- [ ] Add error handling with specific error messages
  - FK validation errors
  - Circular dependency errors
  - Duplicate link detection (silent success)

### Database

- [ ] Create lp_genealogy table (if not exists):
  - id, org_id, parent_lp_id, child_lp_id, wo_id, operation_type, created_at, created_by_user_id
  - UNIQUE(parent_lp_id, child_lp_id)
  - Indexes: org_id, parent_lp_id, child_lp_id, created_at

- [ ] Implement circular dependency detection CTE
  - Query: `SELECT ancestors_of_X WHERE X = target_child`
  - If includes target_parent: Circular detected

- [ ] Implement forward/backward trace CTEs
  - Recursive: descendants starting from parent
  - Recursive: ancestors starting from child

### Frontend

- [ ] Add "Genealogy" tab to LP detail page
  - Shows parent/child information
  - "Trace Forward" button → opens tree view
  - "Trace Backward" button → opens tree view

- [ ] Create `GenealogyTree` component
  - Visual tree of parent-child relationships
  - Nodes: LP number, operation type, timestamp
  - Edges: Show operation_type label
  - Expandable nodes for deep genealogies
  - Color-coded by operation type (split=blue, merge=green, consume=orange, produce=red)

- [ ] Add error UI for orphaned LPs
  - Warning banner: "⚠️ Parent LP no longer exists (orphaned)"
  - Show last known parent LP number

---

## Testing

### Unit Tests
- Circular dependency detection: A → B → A → error
- Circular dependency: A → B, B → C, C → A → error
- Valid genealogy: A → B → C (no error)
- FK validation: Parent LP not exists → error
- Duplicate link: Insert same parent-child twice → idempotent (silent success)

### Integration Tests
- POST genealogy with valid parent/child/wo_id
- Verify genealogy record created
- Verify forward trace returns descendants
- Verify backward trace returns ancestors
- Circular dependency detection with 3-level genealogy
- Orphan detection: Delete parent LP, verify child shows orphan warning

### E2E Tests
- Create split genealogy: LP-001 → LP-002
- Click "Trace Forward" on LP-001 → shows LP-002
- Click "Trace Backward" on LP-002 → shows LP-001
- Create complex genealogy: LP-001 split → LP-002, LP-003, LP-002 + LP-003 merged → LP-004
- Forward trace LP-001: shows LP-002, LP-003, LP-004
- Backward trace LP-004: shows LP-001, LP-002, LP-003
- Delete parent LP, verify orphan warning on children

---

## Acceptance Criteria Checklist

- ✅ Genealogy records created for split/merge/consume/produce operations
- ✅ Forward trace returns all descendants
- ✅ Backward trace returns all ancestors
- ✅ Transaction atomicity enforced (all-or-nothing)
- ✅ FK validation prevents invalid links
- ✅ Circular dependency detection prevents cycles
- ✅ Duplicate link detection (silent success)
- ✅ Orphan detection flags broken parent references
- ✅ Error messages specific to failure reason
- ✅ FDA compliance: No broken traces, all operations linked

---

## Dependencies

**Requires:** Story 5.5 (LP Split), Story 5.6 (LP Merge)

**Enables:** Story 5.28 (Forward/Backward Traceability), Story 5.29 (Genealogy Recording), Story 4.7 (WO Consumption)

**Blocks:** None directly (but essential for traceability features)

---

## Notes

- **Critical for FDA Compliance**: Genealogy is immutable audit trail
- **Sprint 0 Gap 2**: Complex transaction handling required for atomicity
- **Performance**: Recursive CTEs can be slow with deep genealogy (>10 levels). Consider depth limits.
- **Concurrency**: INSERT-only operations (no UPDATEs), so concurrency safe with unique constraint
- **Audit**: Never delete genealogy records (even if LPs deleted)
