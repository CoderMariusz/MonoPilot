<?xml version="1.0" encoding="UTF-8"?>
<story>
  <metadata>
    <id>2.14</id>
    <title>Allergen Inheritance</title>
    <batch>02B-2</batch>
    <points>3</points>
    <effort_hours>4-5</effort_hours>
    <status>pending</status>
  </metadata>

  <description>Auto-calculate BOM allergens as union of all component allergens with mismatch warning.</description>

  <dependencies>
    <requires>
      <story id="2.4">Product Allergens</story>
      <story id="2.7">BOM Items</story>
    </requires>
  </dependencies>

  <technical_context>
    <api_endpoints>
      <endpoint method="GET" path="/api/technical/boms/:id/allergens">
        <response>
          {
            contains: Allergen[],     // Union of all items' Contains
            may_contain: Allergen[],  // Union of all items' May Contain
            mismatch_warning?: string // If differs from product allergens
          }
        </response>
        <algorithm>
          1. Fetch all bom_items.product_id
          2. Fetch product_allergens for each
          3. Union Contains allergens
          4. Union May Contain allergens
          5. Compare vs output product allergens â†’ warning if mismatch
        </algorithm>
      </endpoint>
    </api_endpoints>

    <ui_elements>
      <element name="AllergenTab">Shows inherited allergens in BOM detail</element>
      <element name="MismatchWarning">Banner offering to update product allergens</element>
    </ui_elements>
  </technical_context>

  <acceptance_criteria>
    <ac id="2.14.1">Allergens tab in BOM detail</ac>
    <ac id="2.14.2">Shows rolled-up Contains and May Contain</ac>
    <ac id="2.14.3">Warning if BOM allergens differ from product</ac>
    <ac id="2.14.4">Click Yes updates product_allergens</ac>
    <ac id="2.14.5">Calculated on-the-fly (not cached)</ac>
  </acceptance_criteria>
</story>
