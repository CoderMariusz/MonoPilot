# Story 3.8: Partial TO Shipments

**Epic:** 3 - Planning Operations
**Batch:** 03B-1
**Story ID:** 3.8
**Priority:** P0
**Effort:** 5 points
**Status:** Ready for Development

---

## User Story

**As a** Warehouse user,
**I want to** ship transfer orders in multiple partial shipments,
**So that** I can handle scenarios where full inventory is not available at once.

---

## Acceptance Criteria

### AC-3.8.1: Ship TO Button

**Given** TO with status = 'planned' or 'partially_shipped'
**When** viewing TO detail page
**Then** see "Ship Transfer Order" button

**Hidden** if status = 'shipped', 'received', 'cancelled'

### AC-3.8.2: Ship TO Modal

**When** clicking "Ship Transfer Order"
**Then** modal opens with:
- Actual Ship Date (default: today)
- Lines table: Product, Planned, Already Shipped, Remaining, Ship Now (input)

### AC-3.8.3: Enter Partial Quantities

**When** entering Ship Now quantities
**Then** validate:
- 0 ≤ Ship Now ≤ Remaining
- Decimals allowed
- Disabled if line fully shipped

### AC-3.8.4: Confirm Shipment

**When** confirming shipment with ≥1 line > 0
**Then** update:
- to_lines.shipped_qty += Ship Now (cumulative)
- transfer_orders.actual_ship_date (first shipment only)
- transfer_orders.status (auto-calculated)

### AC-3.8.5: Second Partial Shipment

**Given** partially_shipped TO
**When** shipping again
**Then** modal shows:
- Fully shipped lines disabled
- Remaining qty updated

### AC-3.8.6: Status Calculation

**After** shipment:
- ALL lines fully shipped → status = 'shipped'
- SOME lines partial → status = 'partially_shipped'

### AC-3.8.7: Cannot Over-Ship

**When** trying to ship > remaining
**Then** error: "Cannot ship more than remaining"

### AC-3.8.8: At Least One Line Required

**When** all Ship Now = 0
**Then** error: "At least one line must have Ship Now > 0"

### AC-3.8.9: Actual Ship Date Immutability

**When** second shipment recorded
**Then** actual_ship_date NOT overwritten (set on first shipment only)

### AC-3.8.10: Shipped Qty Display

**In** TO lines table:
- Fully shipped: "10 / 10 kg ✅" (green)
- Partially shipped: "3 / 5 kg ⏳" (yellow)
- Not shipped: "0 / 10 kg ⏳" (gray)

---

## Technical Tasks

1. Database constraints (shipped_qty ≤ quantity)
2. API route (POST /ship)
3. Validation schemas
4. Ship TO modal component
5. Status calculation logic
6. Shipped qty display with icons

---

## Definition of Done

- [ ] Database constraints applied
- [ ] API endpoint implemented
- [ ] Validation working
- [ ] Ship modal UI implemented
- [ ] Status calculation correct
- [ ] Cumulative shipped_qty working
- [ ] All tests passing

---

## Dependencies

- Story 3.6 (TO CRUD)
- Story 3.7 (TO Lines)
