<?xml version="1.0" encoding="UTF-8"?>
<story-context id="3-6-transfer-order-crud" v="1.0">
  <metadata>
    <epicId>3</epicId>
    <storyId>3.6</storyId>
    <title>Transfer Order CRUD</title>
    <batch>03B-1</batch>
    <points>5</points>
    <effort_hours>6-8</effort_hours>
    <status>ready-for-dev</status>
    <generatedAt>2025-11-28</generatedAt>
  </metadata>

  <description>
    Create and manage Transfer Orders for moving inventory between warehouses,
    with auto-generated TO numbers and status-based workflow.
  </description>

  <dependencies>
    <blocks>
      <story id="3.7">TO Line Management</story>
      <story id="3.8">Partial Shipments</story>
      <story id="3.9">LP Selection</story>
    </blocks>
    <requires>
      <epic id="1">Organizations, Warehouses</epic>
    </requires>
  </dependencies>

  <technical_context>
    <tables>
      <table>
        <name>transfer_orders</name>
        <columns>
          <column name="id" type="UUID" pk="true"/>
          <column name="org_id" type="UUID" fk="organizations.id"/>
          <column name="to_number" type="VARCHAR(20)" unique="true"/>
          <column name="from_warehouse_id" type="UUID" fk="warehouses.id"/>
          <column name="to_warehouse_id" type="UUID" fk="warehouses.id"/>
          <column name="status" type="VARCHAR(50)" default="draft"/>
          <column name="planned_ship_date" type="DATE"/>
          <column name="planned_receive_date" type="DATE"/>
          <column name="actual_ship_date" type="DATE" nullable="true"/>
          <column name="actual_receive_date" type="DATE" nullable="true"/>
          <column name="notes" type="TEXT" nullable="true"/>
          <column name="created_by" type="UUID" fk="users.id"/>
          <column name="updated_by" type="UUID" nullable="true"/>
          <column name="created_at" type="TIMESTAMPTZ"/>
          <column name="updated_at" type="TIMESTAMPTZ"/>
        </columns>
        <constraints>
          <constraint type="check" name="check_different_warehouses">from_warehouse_id != to_warehouse_id</constraint>
          <constraint type="check" name="check_receive_after_ship">planned_receive_date >= planned_ship_date</constraint>
        </constraints>
      </table>
    </tables>

    <api_endpoints>
      <endpoint method="GET" path="/api/planning/transfer-orders">
        <description>List TOs with filters</description>
        <query_params>status, from_warehouse_id, to_warehouse_id, search</query_params>
      </endpoint>
      <endpoint method="POST" path="/api/planning/transfer-orders">
        <description>Create TO</description>
        <request_body>{ from_warehouse_id, to_warehouse_id, planned_ship_date, planned_receive_date, notes? }</request_body>
      </endpoint>
      <endpoint method="GET" path="/api/planning/transfer-orders/:id">
        <description>Get TO detail with lines</description>
      </endpoint>
      <endpoint method="PUT" path="/api/planning/transfer-orders/:id">
        <description>Update TO (draft only)</description>
      </endpoint>
      <endpoint method="DELETE" path="/api/planning/transfer-orders/:id">
        <description>Delete TO (draft only)</description>
      </endpoint>
      <endpoint method="PUT" path="/api/planning/transfer-orders/:id/status">
        <description>Change TO status</description>
        <request_body>{ status: 'planned' | 'shipped' | 'received' | 'cancelled' }</request_body>
      </endpoint>
    </api_endpoints>

    <frontend_routes>
      <route path="/planning/transfer-orders" component="TransferOrdersPage"/>
      <route path="/planning/transfer-orders/:id" component="TransferOrderDetailPage"/>
    </frontend_routes>

    <components_to_create>
      <component name="TransferOrdersTable" path="components/planning/"/>
      <component name="TOCreateModal" path="components/planning/"/>
      <component name="TOEditDrawer" path="components/planning/"/>
    </components_to_create>
  </technical_context>

  <acceptance_criteria>
    <criterion id="AC-3.6.1">TO List Page with filters and search</criterion>
    <criterion id="AC-3.6.2">Create TO Modal with warehouse selection and date validation</criterion>
    <criterion id="AC-3.6.3">TO Number auto-generation (TO-YYYY-NNN)</criterion>
    <criterion id="AC-3.6.4">TO Detail View with header and actions</criterion>
    <criterion id="AC-3.6.5">Edit TO (draft only, warehouses read-only)</criterion>
    <criterion id="AC-3.6.6">Delete TO (draft only, with confirmation)</criterion>
    <criterion id="AC-3.6.7">Change Status to 'planned' (requires lines)</criterion>
    <criterion id="AC-3.6.8">TO Number sequential, unique per org, resets yearly</criterion>
  </acceptance_criteria>

  <validation_rules>
    <rule field="from_warehouse_id" type="required">Valid UUID</rule>
    <rule field="to_warehouse_id" type="required">Valid UUID, different from from_warehouse</rule>
    <rule field="planned_ship_date" type="required">Valid date</rule>
    <rule field="planned_receive_date" type="required">Must be >= ship date</rule>
    <rule field="notes" type="maxLength" value="500">Max 500 chars</rule>
  </validation_rules>

  <test_plan>
    <unit_tests>
      <test>TO number generation format and sequence</test>
      <test>Validation schema (different warehouses, dates)</test>
    </unit_tests>
    <integration_tests>
      <test>Create TO - generates unique number</test>
      <test>Edit TO - blocked if not draft</test>
      <test>Delete TO - cascade to lines</test>
      <test>Change status - requires lines</test>
    </integration_tests>
    <e2e_tests>
      <test>Full TO creation flow</test>
      <test>Filter and search TOs</test>
    </e2e_tests>
  </test_plan>
</story-context>
