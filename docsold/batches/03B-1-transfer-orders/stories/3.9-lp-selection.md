# Story 3.9: LP Selection for TO

**Epic:** 3 - Planning Operations
**Batch:** 03B-1
**Story ID:** 3.9
**Priority:** P1 (Optional)
**Effort:** 3 points
**Status:** Ready for Development

---

## User Story

**As a** Warehouse user,
**I want to** pre-select specific License Plates for transfer,
**So that** I can reserve inventory and ensure correct batches are transferred.

---

## Acceptance Criteria

### AC-3.9.1: Feature Toggle

**Given** Admin at `/settings/planning`
**Then** see toggle: "Require LP Selection for Transfer Orders"
- Stored in `planning_settings.to_require_lp_selection`
- Default: false

### AC-3.9.2: Select LPs Button

**Given** LP Selection enabled AND TO status = 'planned'
**When** viewing TO lines table
**Then** each line shows "Select LPs" button

**Hidden** if feature disabled or TO shipped

### AC-3.9.3: LP Selection Modal

**When** clicking "Select LPs"
**Then** modal opens with:
- Available LPs table (from from_warehouse, matching product)
- Columns: LP ID, Batch, Expiry, Available Qty, Select (checkbox), Reserved Qty (input)
- Summary: "Total Reserved: X / Y needed"

### AC-3.9.4: Select and Reserve

**When** selecting LPs and entering reserved quantities
**Then** validate:
- reserved_qty ≤ LP available_qty
- Total reserved ≤ line quantity (warning if under, error if over)

### AC-3.9.5: Total Reserved Validation

- Over quantity → Error (cannot save)
- Under quantity → Warning (can proceed)
- Equal quantity → Success

### AC-3.9.6: Save LP Selection

**When** saving selection
**Then**:
- Delete existing to_line_lps records (replace)
- Insert new records
- Update LP status to 'reserved' (Epic 5 integration)

### AC-3.9.7: Display Selected LPs

**In** TO line detail:
- Expandable row showing selected LPs
- "Edit LPs" button to modify selection

### AC-3.9.8: Edit LP Selection

**When** clicking "Edit LPs"
**Then** modal pre-fills with current selection
**And** can add/remove/modify LPs

### AC-3.9.9: LP Must Be Available

**When** selecting LP
**Then** only status='available' LPs shown
**And** server validates LP still available before save

### AC-3.9.10: Cannot Select After Shipment

**When** TO status = 'shipped' or 'received'
**Then** "Select LPs" button hidden

### AC-3.9.11: Optional Feature

**If** feature disabled:
- "Select LPs" buttons hidden
- Can ship without LP selection
- No validation errors

**If** feature enabled AND required:
- Cannot ship without LP selection for all lines

---

## Technical Tasks

1. Database migration (to_line_lps table)
2. Planning settings update (to_require_lp_selection)
3. API routes (GET, PUT lps)
4. Validation schemas
5. LP Selection modal component
6. Expandable row for selected LPs
7. LP status integration (Epic 5)

---

## Definition of Done

- [ ] Database migration applied
- [ ] RLS policy enabled
- [ ] API endpoints implemented
- [ ] Feature toggle working
- [ ] LP selection modal UI implemented
- [ ] Selected LPs display working
- [ ] Validation working
- [ ] All tests passing

---

## Dependencies

- Story 3.6 (TO CRUD)
- Story 3.7 (TO Lines)
- Epic 5 (License Plates - for LP availability and status)

---

## Notes

- This is an **optional** feature (default: disabled)
- Integrates with Epic 5 License Plates for inventory reservation
- LP status updated to 'reserved' when selected
