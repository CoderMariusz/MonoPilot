<?xml version="1.0" encoding="UTF-8"?>
<story>
  <metadata>
    <id>5.34</id>
    <title>Scanner Receive Workflow</title>
    <batch>5C-2</batch>
    <points>8</points>
    <effort_hours>8-10</effort_hours>
    <status>todo</status>
  </metadata>

  <description>Guided scanner workflow for dock receiving: PO scan → product validation → qty → batch → location → LP creation</description>

  <dependencies>
    <requires>
      <story id="5.23">Scanner Guided Workflows</story>
      <story id="5.24">Barcode Validation</story>
      <story id="5.11">GRN and LP Creation</story>
      <story id="5.12">Auto-Print Labels</story>
    </requires>
    <enables>
      <story id="5.36">Scanner Offline Queue</story>
    </enables>
  </dependencies>

  <technical_context>
    <api_endpoints>
      <endpoint method="POST" path="/api/scanner/receive/validate-po">
        <description>Validate PO barcode and return lines</description>
        <request>
          <field name="po_barcode" type="string"/>
        </request>
      </endpoint>
      <endpoint method="POST" path="/api/scanner/receive/validate-product">
        <description>Validate product barcode matches PO line</description>
        <request>
          <field name="po_line_id" type="UUID"/>
          <field name="product_barcode" type="string"/>
        </request>
      </endpoint>
      <endpoint method="POST" path="/api/scanner/receive/validate-location">
        <description>Validate location barcode</description>
        <request>
          <field name="location_barcode" type="string"/>
        </request>
      </endpoint>
      <endpoint method="POST" path="/api/scanner/receive/create-lp">
        <description>Create GRN and LP from receiving data</description>
        <request>
          <field name="po_line_id" type="UUID"/>
          <field name="qty" type="decimal"/>
          <field name="batch_number" type="string"/>
          <field name="location_id" type="UUID"/>
        </request>
      </endpoint>
    </api_endpoints>

    <services>
      <service name="ScannerReceiveService">
        <method name="validatePO" params="barcode" return="PO"/>
        <method name="validateProduct" params="po_line_id, barcode" return="Match"/>
        <method name="validateLocation" params="barcode" return="Location"/>
        <method name="createLP" params="po_line_id, qty, batch, expiry, location_id" return="LP"/>
      </service>
    </services>

    <components_to_create>
      <component name="ScannerReceiveWorkflow.tsx">
        <description>State machine: menu → PO scan → product → qty → batch → location → confirm</description>
        <states>menu|po_scan|product|qty|batch|location|confirm</states>
      </component>
      <component name="BarcodeInput.tsx">
        <description>Auto-focus scanner input with validation feedback</description>
      </component>
    </components_to_create>
  </technical_context>

  <acceptance_criteria>
    <criterion id="AC1">Scanner menu with Receive from PO option</criterion>
    <criterion id="AC2">Scan PO barcode loads PO details</criterion>
    <criterion id="AC3">Scan product with validation (green✓/red✗)</criterion>
    <criterion id="AC4">Enter quantity with numeric input</criterion>
    <criterion id="AC5">Enter batch and expiry with date pickers</criterion>
    <criterion id="AC6">Scan location barcode with validation</criterion>
    <criterion id="AC7">Confirm creates LP, shows success</criterion>
    <criterion id="AC8">Next item or done options</criterion>
  </acceptance_criteria>

  <test_plan>
    <e2e_tests>
      <test name="Full receive workflow: scan PO → scan product → enter qty/batch → scan location → confirm LP created"/>
    </e2e_tests>
  </test_plan>

  <implementation_notes>
    <note priority="critical">Atomicity: LP must be created with GRN or both fail</note>
    <note priority="high">Scanner is touch-optimized: large inputs, minimal typing</note>
    <note priority="high">Batch number required (traceability compliance)</note>
  </implementation_notes>
</story>
