# Story 5.32: Receive from PO (Desktop)

**ID:** 5.32
**Batch:** 5C-2 (Traceability & Workflows)
**Story Points:** 8
**Effort:** 8-10 hours
**Status:** Todo

---

## User Story

> As a **Warehouse user**, I want to receive goods against PO from desktop, so that I can process deliveries.

---

## Acceptance Criteria

### AC 1: Navigate to Receiving Page
- **Given** navigating to `/warehouse/receiving`
- **When** page loads
- **Then** show:
  - PO search/filter
  - List of POs in Confirmed+ status (ready to receive)
  - Columns: PO#, Supplier, Date, Items, Received, Remaining

### AC 2: Select PO
- **Given** viewing PO list
- **When** clicking on PO
- **Then** expand to show:
  - PO details (supplier, date, etc.)
  - Line items with: product, unit price, ordered qty, received qty, remaining
  - "Receive" button for each line or bulk receive

### AC 3: Receive Line Item
- **Given** clicking "Receive" on line item
- **When** modal opens
- **Then** display:
  - Product name and SKU (read-only)
  - Ordered quantity (read-only)
  - Already received (read-only)
  - Remaining to receive (read-only)
  - Quantity input (default: remaining)
  - Batch number input (required)
  - Manufacture date (optional)
  - Expiry date (optional)
  - Location selector (required, filtered to receiving/storage)
  - "Receive" button

### AC 4: Multi-line Bulk Receive
- **Given** PO with multiple lines
- **When** clicking "Receive All" or selecting multiple lines
- **Then** show form to receive all selected at once:
  - Line summary: product, qty, remaining
  - Can adjust quantities per line
  - Single batch number (apply to all or per-line)
  - Single location or per-line location
  - "Receive" button

### AC 5: Over-Receipt Validation
- **Given** receiving more than ordered
- **When** qty_received > ordered_qty
- **Then**:
  - If allow_over_receipt = false: Block, show error
  - If allow_over_receipt = true: Show warning, allow proceed
  - Show: "Ordered: 100, Receiving: 105 (+5%)"

### AC 6: Create GRN and LPs
- **Given** valid receive parameters
- **When** clicking "Receive"
- **Then**:
  - Create GRN record (atomic transaction)
  - Create LP for each line item
  - Update PO line received_qty
  - Update PO status if all lines received
  - Show success: "GRN #54321 created with 3 LPs"
  - Close modal and refresh PO list

### AC 7: Partial Receive
- **Given** receiving less than remaining
- **When** qty_received < remaining_qty
- **Then**:
  - Receive is recorded
  - Remaining qty still available for future GRN
  - PO stays in "Confirmed" status (not Closed)
  - Can receive again later

### AC 8: Success Confirmation
- **Given** GRN created successfully
- **When** operation completes
- **Then** display GRN with:
  - GRN number
  - LP numbers created
  - Batch numbers
  - Location assigned
  - Option to print labels

---

## Technical Tasks

### Backend

**Task 1:** API: GET `/api/warehouse/po-for-receiving`
- Return POs with status in [Confirmed, PartiallyReceived]
- Include: po_number, supplier, po_lines with ordered/received/remaining
- Filter by org_id (RLS)

**Task 2:** API: POST `/api/warehouse/receiving/from-po`
- Request:
  ```json
  {
    "po_id": "uuid",
    "items": [
      {
        "po_line_id": "uuid",
        "qty_received": 100,
        "batch_number": "BATCH-001",
        "manufacture_date": "2025-01-10",
        "expiry_date": "2025-02-15",
        "location_id": "uuid"
      }
    ]
  }
  ```
- Create GRN + GRN items + LPs (atomic transaction)
- Update PO line received_qty
- Update PO status
- Return: GRN details with LP numbers

**Task 3:** ReceivingService
```typescript
export class ReceivingService {
  async getPOsForReceiving(org_id): Promise<PO[]>
  async receiveFromPO(po_id, items): Promise<GRN>
  async validateReceive(po_id, items): Promise<ValidationError[]>
}
```

### Frontend

**Task 1:** Create `ReceivingPage.tsx`
- List POs with status filter
- Expand PO to show lines
- Click line → open receive modal

**Task 2:** Create `ReceiveModalComponent.tsx`
- Form for single/multiple lines
- Quantity inputs
- Batch/expiry date pickers
- Location dropdown (auto-filter to receiving/storage)
- Validate on submit

**Task 3:** Use `ReceivingService` for API calls
- Call `getPOsForReceiving()` on page load
- Call `receiveFromPO()` on submit
- Handle errors and show validation messages

---

## Testing

### Unit Tests
- Over-receipt validation logic
- GRN number generation
- Status transition (Confirmed → Closed)

### Integration Tests
- Create GRN + LPs from PO (atomic transaction)
- Update PO received_qty correctly
- Status transition on full receive
- Partial receive keeps PO in Confirmed

### E2E Tests
- Navigate to receiving page
- Find and click on PO
- Receive single line item
- Verify GRN created and LPs visible
- Verify PO status updated

---

## Dependencies

### Requires
- Story 5.11: GRN & LP Creation (creates GRN, LPs)
- Story 3.1: Purchase Order (PO must exist)
- Story 5.31: Warehouse Settings (for over-receipt tolerance)

### Blocks
- Story 5.35: Inventory Count (counts LPs created here)

---

## Notes

- Atomic transaction: GRN + all LPs must succeed together or rollback
- Over-receipt depends on warehouse_settings.allow_over_receipt
- Location must be active and allow storage
- Batch number required (traceability compliance)
