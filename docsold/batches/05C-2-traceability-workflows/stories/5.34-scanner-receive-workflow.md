# Story 5.34: Scanner Receive Workflow

**ID:** 5.34
**Batch:** 5C-2 (Traceability & Workflows)
**Story Points:** 8
**Effort:** 8-10 hours
**Status:** Todo

---

## User Story

> As an **Operator**, I want to receive via scanner, so that I can work on the dock.

---

## Acceptance Criteria

### AC 1: Scanner Receiving Menu
- **Given** opening scanner on /scanner/receive
- **When** workflow starts
- **Then** show menu:
  - "Receive from PO"
  - "Receive from Transfer Order"
  - "Manual Receive" (ad-hoc)
  - "Cancel"

### AC 2: Scan PO Barcode
- **Given** selecting "Receive from PO"
- **When** workflow starts
- **Then** show: "Scan PO Barcode"
- **And** wait for barcode scan
- **When** valid PO scanned:
  - Load PO details
  - Show: "PO-001234: 5 items to receive"
  - Proceed to next step
- **When** invalid barcode:
  - Show error: "PO not found"
  - Retry scan

### AC 3: Product Validation
- **Given** PO loaded, showing first item
- **When** showing step: "Scan Product"
- **Then** display:
  - Expected product name and code
  - Barcode field (auto-focus)
- **When** correct product scanned:
  - Show ✅ green confirmation
  - Proceed to quantity
- **When** wrong product scanned:
  - Show ❌ red error: "Expected {product}, got {scanned}"
  - Block progress until correct product

### AC 4: Enter Quantity
- **Given** product validated
- **When** step shows "Enter Quantity"
- **Then** display:
  - Remaining to receive: {qty}
  - Number input (pre-filled with remaining)
  - Keypad for numeric input
- **When** quantity entered:
  - Allow 0 < qty ≤ remaining
  - Proceed to next step

### AC 5: Enter Batch & Expiry
- **Given** quantity entered
- **When** step shows "Batch & Expiry"
- **Then** display:
  - Batch number input (required)
  - Manufacture date (optional, date picker)
  - Expiry date (optional, date picker)
- **When** batch entered:
  - Validate not empty
  - Proceed to location scan

### AC 6: Scan Location
- **Given** batch/expiry entered
- **When** step shows "Scan Location"
- **Then** display:
  - Location barcode field
  - List of valid locations (receiving/storage)
- **When** location scanned:
  - Validate location active and type
  - Show ✅ if valid
- **When** invalid location:
  - Show ❌ error: "Invalid location"
  - Retry scan

### AC 7: Confirm Receipt
- **Given** all fields entered
- **When** step shows "Confirm"
- **Then** display summary:
  - Product, Qty, Batch, Expiry, Location
  - "Confirm" button
- **When** confirming:
  - Create GRN + LP
  - Trigger label print (if enabled)
  - Show success: "✅ LP-20250120-0001 created"
  - Ask: "Next item?" or "Done?"

### AC 8: Next Item or Done
- **Given** item received successfully
- **When** asking "Next item?"
- **Then**:
  - "Next": Return to product scan (next PO line or new PO)
  - "Done": Complete receiving workflow
- **When** Done selected:
  - Show GRN summary: "GRN-001234: 5 LPs received"
  - Return to scanner menu

### AC 9: Error Handling
- **Given** any step fails (LP creation error, invalid data)
- **When** error occurs
- **Then** display error message with:
  - What failed: "Unable to create LP"
  - Reason: "Batch number already used"
  - Option: "Retry" or "Skip"

---

## Technical Tasks

### Backend

**Task 1:** API: POST `/api/scanner/receive/validate-po`
- Input: po_barcode
- Return: PO details + lines

**Task 2:** API: POST `/api/scanner/receive/validate-product`
- Input: po_line_id, product_barcode
- Validate matches expected product
- Return: match (true/false) + product details

**Task 3:** API: POST `/api/scanner/receive/validate-location`
- Input: location_barcode
- Validate location active and type
- Return: match (true/false) + location details

**Task 4:** API: POST `/api/scanner/receive/create-lp`
- Input: po_line_id, qty, batch, dates, location_id
- Create GRN + LP
- Return: LP number, GRN number

**Task 5:** ScannerReceiveService
```typescript
export class ScannerReceiveService {
  async validatePO(barcode): Promise<PO>
  async validateProduct(po_line_id, barcode): Promise<Match>
  async validateLocation(barcode): Promise<Location>
  async createLP(po_line_id, qty, batch, expiry, location_id): Promise<LP>
}
```

### Frontend

**Task 1:** Create `ScannerReceiveWorkflow.tsx`
- State machine: menu → PO scan → product → qty → batch → location → confirm → next/done
- Each step waits for input
- Back button to previous step

**Task 2:** Create reusable scan components:
- `BarcodeInput.tsx` - Auto-focus scanner input
- `ConfirmationStep.tsx` - Summary + confirmation
- `ErrorDisplay.tsx` - Error with retry/skip

**Task 3:** Barcode input handling
- Auto-focus on barcode input field
- Trigger validation on Enter key
- Show immediate visual feedback (green/red)

**Task 4:** State management
```typescript
interface ReceiveState {
  step: 'menu' | 'po_scan' | 'product' | 'qty' | 'batch' | 'location' | 'confirm';
  po_id: UUID;
  po_lines: POLine[];
  current_line_index: number;
  received_items: ReceivedItem[];
}
```

---

## Testing

### Unit Tests
- Barcode validation logic
- PO line validation
- Location validation

### Integration Tests
- Scan PO → load lines
- Scan product → validate against PO line
- Scan location → validate active/type
- Create LP → GRN created

### E2E Tests
- Full receive workflow:
  1. Scan PO barcode
  2. Scan product barcode (validation)
  3. Enter quantity
  4. Enter batch number
  5. Scan location barcode
  6. Confirm
  7. LP created, label printed
  8. Next item → repeat for remaining
  9. Done → GRN summary shown

---

## Dependencies

### Requires
- Story 5.23: Scanner Guided Workflows (scanner foundation)
- Story 5.24: Barcode Validation (barcode matching)
- Story 5.11: GRN & LP Creation (creates GRN+LP)
- Story 5.12: Auto-Print Labels (print ZPL)

### Blocks
- Story 5.36: Scanner Offline Queue (uses receive workflow)

---

## Notes

- Scanner is touch-optimized: large inputs, minimal typing
- Barcode scanning faster than manual entry
- Operator works on dock: need clear visual feedback
- FDA compliance: Batch number required for traceability
- Atomicity: LP must be created with GRN or both fail
