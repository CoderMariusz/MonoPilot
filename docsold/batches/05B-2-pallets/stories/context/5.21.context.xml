<?xml version="1.0" encoding="UTF-8"?>
<story>
  <metadata>
    <id>5.21</id>
    <title>Pallet Move</title>
    <batch>5B-2</batch>
    <points>5</points>
    <effort_hours>5-6</effort_hours>
    <status>todo</status>
  </metadata>
  <description>Move entire pallets to new locations with all license plates in atomic batch operation</description>
  <dependencies>
    <requires><story id="5.19">Pallet Creation</story><story id="5.20">Pallet LP Management</story><story id="5.14">LP Location Move</story><story id="5.17">Destination Validation</story></requires>
    <enables><story id="5.22">Pallet Status</story></enables>
  </dependencies>
  <technical_context>
    <api_endpoints>
      <endpoint method="POST" path="/api/warehouse/pallets/:id/move">
        <description>Move pallet and all LPs to new location in atomic transaction</description>
        <auth>authenticated</auth>
        <request>
          <field name="to_location_id" type="UUID" required="true">Destination location</field>
          <field name="movement_type" type="string" required="true">Type: receiving, put_away, pick, transfer, adjustment</field>
        </request>
        <response status="200">
          <field name="pallet_id" type="UUID"/>
          <field name="pallet_number" type="string"/>
          <field name="from_location" type="object">
            <field name="id" type="UUID"/>
            <field name="code" type="string"/>
            <field name="name" type="string"/>
          </field>
          <field name="to_location" type="object">
            <field name="id" type="UUID"/>
            <field name="code" type="string"/>
            <field name="name" type="string"/>
          </field>
          <field name="movement_type" type="string"/>
          <field name="lps_moved" type="integer" comment="Count of LPs moved"/>
          <field name="stock_moves_created" type="array">
            <field name="id" type="UUID"/>
            <field name="lp_id" type="UUID"/>
            <field name="lp_number" type="string"/>
            <field name="moved_at" type="timestamp"/>
          </field>
          <field name="moved_at" type="timestamp"/>
        </response>
        <response status="400">
          <field name="error" type="string" example="Cannot move closed pallet"/>
        </response>
      </endpoint>
    </api_endpoints>
    <transaction_flow>
      <step number="1">START transaction</step>
      <step number="2">Validate pallet exists and status='open'</step>
      <step number="3">Validate destination location exists and is active</step>
      <step number="4">Validate destination location type matches movement_type</step>
      <step number="5">Validate warehouse (for transfer type: same warehouse)</step>
      <step number="6">GET all pallet_items for this pallet</step>
      <step number="7">FOR EACH pallet_item:
        - Get LP details
        - Validate LP destination (reuse Story 5.17 logic)
        - UPDATE license_plates SET location_id = destination
        - INSERT stock_moves record (from current location to destination)
      </step>
      <step number="8">UPDATE pallets SET location_id = destination_location_id</step>
      <step number="9">COMMIT transaction</step>
      <step number="10">ON ERROR: ROLLBACK (all or nothing)</step>
    </transaction_flow>
    <database_operations>
      <operation name="get_pallet_items">
        SELECT lp_id FROM pallet_items WHERE pallet_id = $1 ORDER BY position_order
      </operation>
      <operation name="update_lp_location">
        UPDATE license_plates SET location_id = $2, updated_at = NOW()
        WHERE id = $1 AND org_id = $3
      </operation>
      <operation name="create_stock_move">
        INSERT INTO stock_moves (id, org_id, lp_id, from_location_id, to_location_id, movement_type, quantity, uom, moved_at, moved_by_user_id, created_at)
        VALUES (gen_random_uuid(), $1, $2, $3, $4, $5, (SELECT quantity FROM license_plates WHERE id = $2), (SELECT uom FROM license_plates WHERE id = $2), NOW(), $6, NOW())
      </operation>
      <operation name="update_pallet_location">
        UPDATE pallets SET location_id = $2, updated_at = NOW() WHERE id = $1
      </operation>
    </database_operations>
    <components>
      <component name="PalletMoveModal">
        <location>src/components/warehouse/pallets/PalletMoveModal.tsx</location>
        <description>Modal for moving pallet to new location</description>
        <fields>
          - Current location (read-only): "WH-A-05 - Storage Bin 5"
          - Destination location selector (required, dropdown)
          - Movement type selector (required, radio buttons): receiving, put_away, pick, transfer, adjustment
          - Move button with loading state
          - Cancel button
        </fields>
        <validation>
          - Location exists and active
          - Location type matches movement_type
          - Cross-warehouse transfer blocked for transfer type
        </validation>
      </component>
      <component name="LocationDestinationSelector">
        <location>src/components/warehouse/LocationDestinationSelector.tsx</location>
        <description>Filtered location dropdown based on movement_type</description>
        <features>
          - Show only valid location types for movement_type
          - Filter to active locations
          - Show location code, name, warehouse
          - Autocomplete search
        </features>
      </component>
      <component name="MovementTypeSelector">
        <location>src/components/warehouse/MovementTypeSelector.tsx</location>
        <description>Movement type selection with descriptions</description>
        <features>
          - Radio buttons for 5 types
          - Icons and descriptions per type
          - Help text on hover/tooltip
        </features>
      </component>
    </components>
    <hooks>
      <hook name="useMovePallet">
        <accepts>pallet_id, to_location_id, movement_type</accepts>
        <returns>{ pallet, stock_moves, lps_moved, loading, error }</returns>
        <api_call>POST /api/warehouse/pallets/:id/move</api_call>
      </hook>
    </hooks>
    <validation_rules>
      <rule id="pallet_exists">Pallet must exist in database</rule>
      <rule id="pallet_open">Pallet status must = 'open' (cannot move closed/shipped)</rule>
      <rule id="location_exists">Destination location must exist</rule>
      <rule id="location_active">Destination location.is_active = true</rule>
      <rule id="location_type_valid">Location type must match movement_type (reuse Story 5.17 logic)</rule>
      <rule id="warehouse_transfer">For transfer type: source and destination must be same warehouse</rule>
      <rule id="empty_pallet_allowed">Empty pallet (0 items) can be moved</rule>
    </validation_rules>
    <atomic_guarantees>
      <guarantee name="all_or_nothing">Either ALL LPs move or NONE move (no partial updates)</guarantee>
      <guarantee name="timestamp_sync">All stock_moves for pallet move have same moved_at timestamp</guarantee>
      <guarantee name="lp_consistency">LP.location_id and stock_move records always in sync</guarantee>
      <guarantee name="pallet_consistency">Pallet.location_id matches all contained LP locations after move</guarantee>
    </atomic_guarantees>
    <error_scenarios>
      <scenario name="invalid_location">
        - Error: "Location does not exist or is inactive"
        - Rollback: All changes reverted
      </scenario>
      <scenario name="type_mismatch">
        - Error: "Cannot move pick movement to storage location"
        - Rollback: All changes reverted
      </scenario>
      <scenario name="cross_warehouse_transfer">
        - Error: "Cannot transfer between warehouses"
        - Rollback: All changes reverted
      </scenario>
      <scenario name="closed_pallet">
        - Error: "Cannot move closed pallet. Use reopen or create new pallet"
        - Rollback: No changes attempted
      </scenario>
      <scenario name="lp_validation_fails">
        - Error: "LP validation failed: [specific error]"
        - Rollback: All LP updates and stock_moves reverted
      </scenario>
    </error_scenarios>
    <rls_policies>
      <policy table="stock_moves">
        <insert>WHERE org_id = current_user.org_id (for created stock_moves)</insert>
      </policy>
      <policy table="pallets">
        <update>WHERE org_id = current_user.org_id</update>
      </policy>
      <policy table="license_plates">
        <update>WHERE org_id = current_user.org_id (for location updates)</update>
      </policy>
    </rls_policies>
  </technical_context>
  <acceptance_criteria>
    <ac id="1" title="Pallet Move Modal">
      <test>Open pallet detail → click "Move Pallet" → modal opens with location selector and movement type options</test>
    </ac>
    <ac id="2" title="Location and Type Selection">
      <test>Current location shown as read-only</test>
      <test>Select destination location → filtered by movement_type</test>
      <test>Select movement_type → location dropdown filtered accordingly</test>
    </ac>
    <ac id="3" title="Batch LP Move">
      <test>Pallet with 5 LPs submitted → all 5 LPs move to new location</test>
      <test>All LP.location_id updated to destination</test>
      <test>All 5 stock_moves created (one per LP)</test>
    </ac>
    <ac id="4" title="Atomic Operation">
      <test>If any LP move fails (location invalid, etc) → ROLLBACK all changes</test>
      <test>Either all succeed or all fail (no partial updates)</test>
    </ac>
    <ac id="5" title="Pallet Location Update">
      <test>Pallet.location_id updated to destination</test>
      <test>Pallet detail page shows new location</test>
    </ac>
    <ac id="6" title="Stock Move Records">
      <test>Each LP has corresponding stock_move with correct from/to locations</test>
      <test>All stock_moves have same moved_at timestamp (indicates atomic operation)</test>
      <test>movement_type recorded as specified in request</test>
    </ac>
    <ac id="7" title="Success Feedback">
      <test>Show confirmation: "Pallet P-20250127-0001 moved to WH-B-10"</test>
      <test>Show count: "5 LPs moved"</test>
      <test>Pallet detail page refreshed with new location</test>
    </ac>
  </acceptance_criteria>
  <test_plan>
    <unit_tests>
      <test>Movement validation: location type matches movement_type</test>
      <test>Warehouse validation: transfer blocks cross-warehouse</test>
      <test>Stock move creation per LP</test>
    </unit_tests>
    <integration_tests>
      <test>POST /api/warehouse/pallets/:id/move with valid location → 200 OK</test>
      <test>Pallet.location_id updated, stock_moves created (one per LP)</test>
      <test>All stock_moves have same timestamp</test>
      <test>POST with invalid location → 400 error, no changes</test>
      <test>POST with closed pallet → 400 error</test>
      <test>Empty pallet move succeeds (no LP updates)</test>
    </integration_tests>
    <e2e_tests>
      <test>Open pallet with 3 LPs</test>
      <test>Click "Move Pallet" → modal opens</test>
      <test>Current location shown (read-only)</test>
      <test>Select destination location WH-B-05</test>
      <test>Select movement_type='transfer'</test>
      <test>Submit → confirmation "3 LPs moved"</test>
      <test>Pallet detail refreshed, location changed to WH-B-05</test>
      <test>Audit trail shows 3 stock_moves for pallet LPs</test>
    </e2e_tests>
  </test_plan>
</story>
