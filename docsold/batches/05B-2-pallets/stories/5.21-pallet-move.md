# Story 5.21: Pallet Move

**ID:** 5.21
**Batch:** 5B-2 (Pallet Management)
**Story Points:** 5
**Effort:** 5-6 hours
**Status:** Todo

---

## User Story

> As a **Warehouse user**, I want to move entire pallets to different locations, so that I can reorganize grouped inventory.

---

## Acceptance Criteria

### AC 1: Pallet Move Modal
- **Given** pallet detail page
- **When** clicking "Move Pallet" button
- **Then** modal opens with:
  - Current location (read-only)
  - Destination location selector (required)
  - Movement type selector (required): transfer, pick, receiving (default: transfer)
  - Move button

### AC 2: Location Validation
- **Given** selecting destination
- **When** validating location
- **Then** ensure:
  - Location exists and is active
  - Location type matches movement_type (storage for transfer, etc)
  - Cross-warehouse transfer blocked for transfer type

### AC 3: Batch LP Move
- **Given** pallet with 5 LPs to move
- **When** confirming pallet move
- **Then**:
  - Update pallet.location_id to destination
  - For EACH LP in pallet:
    - Update lp.location_id to destination
    - Create stock_move record (from current to destination)
  - Return: 5 stock_moves created + pallet location updated

### AC 4: Atomic Operation
- **Given** pallet move in progress
- **When** any LP move fails (location invalid, FK error, etc)
- **Then** ROLLBACK all changes (pallet + all LP moves)
- **And** show specific error message

### AC 5: Success Feedback
- **Given** pallet move succeeds
- **When** operation completes
- **Then** show confirmation:
  - "Pallet P-20250127-0001 moved to WH-B-10"
  - Show count: "5 LPs moved"
  - Redirect to pallet detail (new location shown)

### AC 6: Stock Move Records
- **Given** pallet moved
- **When** checking audit trail
- **Then** find 5 stock_moves (one per LP):
  - movement_type from request (transfer, pick, etc)
  - from_location: original pallet location
  - to_location: destination
  - moved_at: same timestamp for all (atomic)

### AC 7: Pallet with No Items
- **Given** empty pallet
- **When** moving
- **Then** allow move (no LPs to update)
- **And** update pallet.location_id only

---

## Technical Tasks

### Backend

- [ ] Create `POST /api/warehouse/pallets/:id/move` endpoint
  - Accept: to_location_id (required), movement_type (required)
  - Validate: pallet exists, location exists and valid
  - Get: all pallet_items for this pallet
  - START transaction

  - [ ] For each pallet_item:
    - Get LP details
    - Validate destination for movement_type
    - Update LP.location_id
    - INSERT stock_move record

  - [ ] Update pallet.location_id
  - COMMIT transaction
  - ROLLBACK on any error
  - Return: pallet + list of created stock_moves

- [ ] Create location validation for movement_type
  - Reuse Story 5.17 validation logic
  - Check: type matches, warehouse matches, etc

- [ ] Create stock_move creation helper
  - Reuse Story 5.14 logic
  - Accept: lp_id, from_loc, to_loc, movement_type
  - Return: created stock_move

### Database

- [ ] No schema changes from Story 5.19-5.20
- [ ] Verify stock_moves table has necessary FKs

### Frontend

- [ ] Create PalletMoveModal component
  - Current location display (read-only)
  - Destination location dropdown (filtered)
  - Movement type selector (radio buttons)
  - Move button with loading state
  - Validation feedback

- [ ] Enhance pallet detail page
  - "Move Pallet" button (enabled if status='open')
  - On successful move: show toast with count
  - Refresh pallet location display

- [ ] Create destination location filter
  - Based on movement_type selection
  - Show only valid location types
  - Show warehouse info

---

## Testing

### Unit Tests
- Movement validation: location type matches movement_type
- Warehouse validation: transfer blocks cross-warehouse
- Stock move creation for each LP

### Integration Tests
- POST /api/warehouse/pallets/:id/move with valid location → 200 OK
- Pallet.location_id updated
- Stock_moves created (one per LP)
- All stock_moves have same timestamp
- POST with invalid location → 400 error, no changes
- POST with closed pallet → 400 error (cannot move if not open)
- Empty pallet move succeeds (no LPs updated)

### E2E Tests
- Open pallet with 3 LPs
- Click "Move Pallet" → modal opens
- Current location shown (read-only)
- Select destination location
- Select movement_type='transfer'
- Submit → confirmation shows "3 LPs moved"
- Pallet detail page refreshed, location changed
- Audit trail shows 3 stock_moves for pallet LPs

---

## Acceptance Criteria Checklist

- ✅ Move pallet modal with location and type selection
- ✅ Update pallet.location_id to destination
- ✅ Create stock_move for each LP in pallet
- ✅ Update all LP.location_id to destination
- ✅ Atomic transaction (all succeed or all fail)
- ✅ Success feedback with LP count
- ✅ Location validation per movement_type
- ✅ Stock move records created (one per LP)

---

## Dependencies

**Requires:** Story 5.19 (Pallet Creation), Story 5.20 (Add LPs), Story 5.14 (Stock Moves), Story 5.17 (Destination Validation)

**Enables:** Story 5.22 (Pallet Status)

---

## Notes

- Pallet move is a **batch operation**: all LPs move together atomically
- If any LP fails validation, entire pallet move fails (no partial updates)
- Stock moves inherit movement_type from request (transfer, pick, etc)
- All stock_moves for pallet move have same timestamp (indicates atomic operation)
- Closed/shipped pallets cannot be moved (validate status='open')
- Empty pallets can be moved (no LP location updates)
- Movement type validation reuses Story 5.17 logic
