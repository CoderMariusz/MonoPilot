# Story 5.8: ASN Creation

**ID:** 5.8
**Batch:** 5A-3 (Receiving)
**Story Points:** 5
**Effort:** 5-6 hours
**Status:** Todo

---

## User Story

> As a **Warehouse user**, I want to create ASN for incoming shipments, so that I can prepare for receiving.

---

## Acceptance Criteria

### AC 1: ASN Creation Modal
- **Given** viewing Purchase Order
- **When** clicking "Create ASN" button
- **Then** modal opens with form:
  - PO number (read-only, pre-filled)
  - Expected arrival date (required)
  - Carrier (optional)
  - Tracking number (optional)
  - ASN items (pre-filled from PO lines)

### AC 2: ASN Items Pre-filled
- **Given** ASN modal opens
- **When** loading PO items
- **Then** ASN items show:
  - Product name and code
  - Ordered quantity
  - UoM
  - Supplier batch number (optional, editable)
  - Manufacture date (optional, editable)
  - Expiry date (optional, editable)

### AC 3: ASN Number Auto-generated
- **Given** saving ASN
- **When** submitting form
- **Then** system auto-generates ASN number:
  - Format: ASN-YYYYMMDD-NNNN (e.g., ASN-20250120-0001)
  - Daily sequence reset
  - Unique per org_id

### AC 4: ASN Linked to PO
- **Given** ASN created
- **When** saving
- **Then**:
  - ASN linked to PO via po_id
  - ASN items linked to PO lines via po_line_id
  - Can view PO from ASN detail page
  - Can view ASN from PO detail page

### AC 5: ASN Status Tracking
- **Given** ASN created
- **When** checking status
- **Then** ASN has status:
  - 'pending': ASN created, awaiting goods
  - 'received': Some/all items received (GRN created)
  - 'completed': All items received

---

## Technical Tasks

### Backend

- [ ] Create `POST /api/warehouse/asns` endpoint
  - Accept: po_id, expected_arrival_date, carrier, tracking_number
  - Pre-fill asn_items from PO lines
  - Auto-generate asn_number using asn_number_sequence
  - Validate PO exists and belongs to org_id
  - Return: ASN with items

- [ ] Create `GET /api/warehouse/asns` endpoint
  - Filter by: status, supplier_id, date_from, date_to
  - Return: List of ASNs with item count

- [ ] Create `GET /api/warehouse/asns/:id` endpoint
  - Return: Full ASN with items and PO link

- [ ] Create asn_number_sequence table (similar to lp_number_sequence)
  - org_id, sequence_date, next_sequence

### Database

- [ ] Create asn table with columns per tech-spec
- [ ] Create asn_items table with columns per tech-spec
- [ ] Create asn_number_sequence table
- [ ] Create indexes on org_id, po_id, status, expected_arrival_date
- [ ] Verify RLS policies

### Frontend

- [ ] Update PO detail page: Add "Create ASN" button
- [ ] Create `CreateASNModal` component
  - Form fields: expected_arrival_date, carrier, tracking_number
  - Auto-populated asn_items from PO lines
  - Validation: expected_arrival_date is in future

- [ ] Create ASN list page: `/warehouse/asns`
  - Columns: ASN number, PO, supplier, expected arrival, status, items count
  - Filters: status, supplier, date range
  - Actions: View detail, create GRN

- [ ] Create ASN detail page: `/warehouse/asns/:id`
  - Show: ASN number, PO link, supplier, arrival date, carrier, tracking
  - Items table: product, qty, supplier batch, manufacture date, expiry
  - Button: "Receive Goods" (opens receive modal for GRN creation)

---

## Testing

### Unit Tests
- ASN number generation: format, uniqueness, daily reset
- PO line pre-fill: all items included
- Status defaults to 'pending'

### Integration Tests
- POST /api/warehouse/asns with valid PO
- Verify asn_items created from po_lines
- GET /api/warehouse/asns - filtering by status, date range

### E2E Tests
- Create PO with 3 items
- Click "Create ASN" on PO detail
- Enter arrival date, carrier, tracking
- Verify: ASN created with auto-number, items pre-filled, link to PO
- View ASN list, verify ASN visible with status 'pending'

---

## Acceptance Criteria Checklist

- ✅ ASN creation modal opens from PO
- ✅ ASN items pre-filled from PO lines
- ✅ ASN number auto-generated (ASN-YYYYMMDD-NNNN)
- ✅ ASN linked to PO and PO lines
- ✅ ASN status tracks: pending → received → completed
- ✅ Can view ASN from list and detail
- ✅ Carrier and tracking number optional

---

## Dependencies

**Requires:** Story 3.1 (Purchase Orders)

**Enables:** Story 5.9 (ASN Item Management), Story 5.11 (GRN Creation)

---

## Notes

- ASN is pre-arrival notification from supplier
- Allows warehouse to prepare for receiving
- Pre-fill from supplier metadata improves data quality
- Tracking number enables shipment tracking integration (future)
