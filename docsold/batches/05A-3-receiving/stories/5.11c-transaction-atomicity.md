# Story 5.11c: Transaction Atomicity & Over-Receipt Validation

**ID:** 5.11c
**Batch:** 5A-3 (Receiving) - SPLIT from 5.11 (Part 3)
**Story Points:** 2
**Effort:** 3-4 hours
**Status:** Todo
**Created:** 2025-11-28 (split from complex 5.11, merged from 5.10 over-receipt)
**Priority:** ðŸ”´ CRITICAL (Gap 2 Sprint 0 requirement - Transaction Atomicity)

---

## User Story

> As a **System**, I want to guarantee atomic GRN + LP creation with rollback on ANY failure, so that database integrity is never compromised.

---

## Goal

Implement **transaction atomicity** (all-or-nothing guarantee), **specific error handling**, and **over-receipt validation** per warehouse settings.

---

## Acceptance Criteria

### AC 1: Transaction Atomicity (All-or-Nothing) â­ CRITICAL

**Given** GRN creation initiated (from 5.11a/b)
**When** any step fails
**Then** ENTIRE transaction rolls back:
- âŒ No GRN record
- âŒ No GRN items
- âŒ No LP records (no incomplete LPs)
- âŒ No ASN status update (reverted if partial)
- âŒ No PO received_qty update (reverted if partial)
- âŒ No status_history records

**Guarantee:** Either ALL succeed or ALL fail. Never partial updates.

**Transaction Wrapper:**

```
BEGIN TRANSACTION
  STEP 1: Validate all FK constraints (async check before commit)
  STEP 2: Insert GRN record
  STEP 3: For each grn_item:
    - Validate quantity > 0
    - Validate product_id exists (FK)
    - Check over-receipt tolerance (AC3)
    - Insert GRN item record
    - Auto-generate LP number
    - Insert license_plates record
  STEP 4: Update ASN.status (if from ASN)
  STEP 5: Update PO_line.received_qty (if from PO)
  STEP 6: Check PO completion, update PO.status (if complete)
  STEP 7: Update TO.status (if from TO)
  STEP 8: Insert status_history records (audit)
COMMIT TRANSACTION (if all success)
or
ROLLBACK TRANSACTION (if any step fails)
```

**Failure â†’ Rollback Map:**

| Failure Point | Trigger | Rollback Action |
|---|---|---|
| FK constraint (ASN not found) | Step 1 | ROLLBACK all |
| Invalid product_id | Step 3 (product FK) | ROLLBACK all |
| Invalid location_id | Step 3 (location FK) | ROLLBACK all |
| Qty = 0 or negative | Step 3 (validation) | ROLLBACK all |
| Over-receipt exceeded | Step 3 (AC3 check) | ROLLBACK all |
| Duplicate LP# (rare) | Step 3 (unique constraint) | ROLLBACK and RETRY with next LP# |
| PO update fails | Step 5 (PO FK or constraint) | ROLLBACK all |
| Status history insert fails | Step 8 (audit) | ROLLBACK all |

### AC 2: Specific Error Messages (User-Friendly)

**Given** transaction fails
**When** rollback completes
**Then** display error message specific to failure point:

**Error Message Catalog:**

| Failure | Message | User Action |
|---|---|---|
| ASN not found | "Cannot create GRN: ASN #12345 no longer exists. Please refresh and try again." | Reload ASN list |
| Invalid supplier | "Cannot create GRN: Supplier is inactive or does not exist. Please select a valid supplier." | Fix supplier |
| Invalid product | "Cannot create LP: Product SKU 'ABC123' no longer exists. Please verify product catalog." | Update product in form |
| Invalid location | "Cannot create LP: Location 'WH-A-01' is inactive. Please select a different location." | Change location |
| Qty invalid | "Cannot create GRN: Received quantity must be > 0. Line item rejected." | Fix quantity |
| Over-receipt | "Cannot create GRN: Receiving 150kg exceeds PO tolerance (tolerance: 5%, max allowed: 105kg). Contact supervisor." | Reduce qty or request approval |
| Duplicate LP# | "System detected duplicate LP number. Retrying with next sequence... Success: LP-20250127-0002 created." | (automatic, transparent) |
| PO update fails | "GRN created but unable to update PO received quantity. Transaction rolled back. Contact IT." | Contact support |

### AC 3: Over-Receipt Validation (from Story 5.10, MERGED here)

**Given** GRN item with quantity provided
**When** validating before insert
**Then** check warehouse over-receipt settings:

**Scenario 1: No Over-Receipt Allowed (tolerance = 0%)**
- received_qty must = ordered_qty exactly
- If received 101kg (ordered 100kg): Error "Cannot exceed ordered quantity"

**Scenario 2: 5% Over-Receipt Allowed (tolerance = 5%)**
- Max allowed = ordered_qty * 1.05
- Example: ordered 100kg, max = 105kg
- If received 104kg: âœ… Pass
- If received 106kg: âŒ Error "Exceeds tolerance"

**Scenario 3: No Order Reference (Ad-hoc Receiving)**
- No over-receipt check (no ordered qty to compare)
- Any positive qty accepted

**Tolerance Determination:**
1. Check warehouse_settings.over_receipt_tolerance_percent
2. Default: 5% (if not configured)
3. Per-warehouse configurable (Story 5.31)

**Error Example:**
```
Warehouse "Main Warehouse" configured with 5% tolerance.
PO Line: ordered 100kg
GRN Item: received 150kg
Error: "Over-receipt: 150kg exceeds tolerance.
        Ordered: 100kg, Tolerance: 5% (105kg max), Received: 150kg.
        Difference: +45kg. Approve exception or reduce qty."
```

### AC 4: Idempotency (Retry Safety)

**Given** duplicate LP# generated (rare race condition)
**When** unique constraint violation detected
**Then**:
- Catch duplicate constraint error
- Auto-retry LP generation with next sequence number
- Insert succeeds on retry
- User sees transparent success: "LP-20250127-0002 created"
- No manual retry needed

**Implementation:**
```
Try:
  INSERT license_plates (lp_number, ...)
Catch UniqueConstraintError:
  Increment lp_number_sequence counter
  Regenerate lp_number
  Try INSERT again (max 3 attempts)
If all fail:
  ROLLBACK entire transaction
  Error: "Cannot generate unique LP number. Contact IT."
```

### AC 5: Concurrent Receiving Protection

**Given** multiple users receiving same PO simultaneously
**When** GRN creation races occur
**Then**:
- SELECT FOR UPDATE on po_line before reading received_qty
- Ensures consistent read of received_qty before increment
- Prevents double-counting quantities

**SQL Example:**
```sql
BEGIN;
  SELECT received_qty FROM po_line
  WHERE id = $1 AND po_id = $2
  FOR UPDATE;  -- Locks this row until transaction ends

  -- Now safe to read and increment
  new_received_qty = received_qty + $3;
  UPDATE po_line SET received_qty = new_received_qty WHERE id = $1;
COMMIT;
```

---

## Technical Tasks

### Backend (CRITICAL)

- [ ] Implement transaction wrapper for entire GRN creation (from 5.11a):
  - Wrap 5.11a `POST /api/warehouse/grns` endpoint with database transaction
  - Wrap 5.11b status updates within same transaction
  - Use database transaction API (BEGIN/COMMIT/ROLLBACK)

- [ ] Add FK validation before insert:
  - Query all referenced entities (ASN, PO, supplier, warehouse, products, locations)
  - If ANY missing: return 400 error with specific message
  - Do validation within transaction before INSERT statements

- [ ] Implement over-receipt validation (from 5.10):
  - Query warehouse_settings.over_receipt_tolerance_percent
  - If source_type = 'po': Calculate tolerance = ordered_qty * (1 + tolerance_percent/100)
  - If received_qty > tolerance: Return 400 error with message (AC3)
  - If source_type = 'asn': Similar logic to PO
  - If source_type = 'adhoc': Skip check (no reference qty)

- [ ] Add error handling with specific messages:
  - Catch each FK violation, validation error, constraint error
  - Return 400 with context-specific message (per AC2)
  - Log full error to server logs for debugging

- [ ] Implement idempotent LP# generation (AC4):
  - Try INSERT license_plates
  - If UniqueConstraintError: increment sequence, retry (max 3 times)
  - All attempts within same transaction
  - If all fail: ROLLBACK with error

- [ ] Add concurrency protection (AC5):
  - Before reading/updating po_line.received_qty:
    - SELECT FOR UPDATE on po_line row
  - Before reading/updating asn status:
    - SELECT FOR UPDATE on asn row
  - Prevents race conditions

- [ ] Comprehensive logging:
  - Log transaction start: "GRN transaction START for org_id={org}, user={user}"
  - Log each step: "Step 3.1: Validating product SKU-ABC..."
  - Log on success: "GRN transaction COMMIT: GRN-20250127-0001 with 3 LPs"
  - Log on failure: "GRN transaction ROLLBACK: FK violation on product_id"

### Database (CRITICAL)

- [ ] Verify transaction support:
  - PostgreSQL has ACID transactions (default)
  - Ensure isolation level = READ COMMITTED (default, sufficient)
  - Consider SERIALIZABLE if needed for high concurrency

- [ ] Add SELECT FOR UPDATE support:
  - Ensure po_line can be selected with FOR UPDATE
  - Ensure asn can be selected with FOR UPDATE
  - No special config needed (PostgreSQL default)

- [ ] Create warehouse_settings fields (if not exist):
  - over_receipt_tolerance_percent (DECIMAL, default 5.0)
  - Example: warehouse_settings (warehouse_id, over_receipt_tolerance_percent, ...)

- [ ] Verify unique constraints:
  - license_plates(lp_number, org_id) - UNIQUE
  - grns(grn_number, org_id) - UNIQUE
  - Ensure these exist for idempotency detection

- [ ] Add indexes for performance:
  - po_line: (po_id, product_id, status) - for order lookup
  - asn_item: (asn_id, product_id) - for ASN lookup
  - license_plates: (org_id, lp_number) - for uniqueness check

### Frontend

- [ ] Update GRN receive modal (from 5.11a):
  - Add transaction status indicator (optional):
    - Show spinner while "Creating GRN..."
    - Show "Validating over-receipt..." step
  - On error: Display specific error message with actionable advice
  - On retry-needed errors: Offer "Retry" button (transparent to user)

- [ ] Error display improvements:
  - Show detailed error: "Over-receipt: 150kg exceeds 105kg max"
  - Suggest fix: "Reduce qty to 105kg or contact supervisor"
  - Link to settings (if admin): "View tolerance settings"

- [ ] Success feedback:
  - Show GRN confirmation with all details:
    - GRN number
    - Items created: "3 items, 3 LPs"
    - Qty totals
    - Status updates: "ASN marked completed"

---

## Testing (CRITICAL)

### Unit Tests

- Transaction rollback scenarios:
  - FK violation (invalid product) â†’ ROLLBACK, no records created
  - Validation error (qty = 0) â†’ ROLLBACK
  - Constraint error (duplicate LP#) â†’ Retry and succeed

- Over-receipt tolerance:
  - No tolerance (0%): ordered 100, received 101 â†’ error
  - 5% tolerance: ordered 100, received 105 â†’ success; 106 â†’ error
  - Ad-hoc (no order): any qty â†’ success
  - Negative tolerance handling

- Idempotency:
  - Duplicate LP# (mock rare race) â†’ retry succeeds
  - After retry: LP# incremented correctly

### Integration Tests

- **Atomicity Test 1: FK Violation**
  - Valid GRN, invalid product_id in one item
  - Verify: ROLLBACK, no GRN, no LPs, no ASN update
  - Verify: Error message specific to product

- **Atomicity Test 2: Validation Failure**
  - Valid GRN, one item with qty = 0
  - Verify: ROLLBACK, no records created
  - Verify: Error message "qty must be > 0"

- **Atomicity Test 3: Over-Receipt Exceeded**
  - PO ordered 100kg, over-receipt tolerance 5%
  - GRN attempted with 150kg
  - Verify: ROLLBACK
  - Verify: Error message with tolerance details

- **Atomicity Test 4: PO Update Fails** (inject error)
  - GRN created, PO update fails (mock FK error)
  - Verify: Entire transaction ROLLBACK
  - Verify: GRN, LPs, ASN all rolled back

- **Concurrency Test: Race Condition**
  - Thread 1: Receive 50kg on PO (ordered 100kg)
  - Thread 2: Receive 60kg on same PO (race with Thread 1)
  - Verify: One succeeds, received_qty correct (50 or 110 depending on order)
  - Verify: No double-counting

- **Idempotency Test: Duplicate LP#**
  - Mock: lp_number_sequence increments incorrectly
  - GRN creation attempts: gets duplicate LP#
  - Verify: Auto-retry with next LP# succeeds
  - Verify: User sees single success message

### E2E Tests

- **Happy Path (Full Atomicity)**
  - Create ASN with 3 items
  - Receive all items with valid data
  - Verify: GRN created, 3 LPs created, ASN marked completed, PO updated
  - Verify: All in single transaction (no partial state)

- **Error Path (Full Rollback)**
  - Create GRN with invalid product in middle item
  - Submit form
  - Verify: Error displayed (specific to product)
  - Verify: GRN list shows NO new GRN (complete rollback)
  - Verify: No partial LPs created

- **Over-Receipt Path**
  - Create PO: 100kg with 5% tolerance
  - Attempt GRN with 150kg
  - Verify: Error with tolerance explanation
  - Modify to 105kg, submit
  - Verify: Success (within tolerance)

- **Concurrent Receiving**
  - 2 users receive from same PO simultaneously
  - User 1: 50kg â†’ GRN created
  - User 2: 60kg â†’ GRN created (while User 1 committing)
  - Verify: Total received_qty = 110kg (both received, order preserved)
  - Verify: No race condition (SELECT FOR UPDATE ensures this)

---

## Acceptance Criteria Checklist

- âœ… Transaction atomicity: all-or-nothing guarantee
- âœ… Specific error messages for each failure point
- âœ… Over-receipt validation with tolerance check
- âœ… Idempotent LP# generation (auto-retry on duplicate)
- âœ… Concurrent receiving protection (SELECT FOR UPDATE)
- âœ… Complete rollback on ANY failure
- âœ… Audit trail (status_history) transactional
- âœ… Zero partial updates

---

## Dependencies

**Requires:**
- Story 5.1 (LP Creation - structure)
- Story 5.11a (GRN & LP Creation - basic implementation)
- Story 5.11b (GRN Integration - status updates)
- Story 5.4 (LP Number Sequence)
- Story 5.3 (warehouse_settings - for tolerance)

**Enables:**
- Story 5.12 (Auto-Print Labels - uses created LPs)
- Story 5.13 (PO Dashboard - uses updated statuses)

**Critical For:** Gap 2 Sprint 0 (Transaction Atomicity)

---

## Notes

- Part 3 of 3: **CRITICAL for data integrity**
- Over-receipt merged from Story 5.10 (simplifies workflow)
- Atomicity is non-negotiable (all-or-nothing)
- Rollback logic every failure point
- Error messages help users understand what failed
- FK validation prevents orphaned records
- Concurrency protection prevents race conditions
- Gap 2 Sprint 0: **This story is prerequisite for production release**
