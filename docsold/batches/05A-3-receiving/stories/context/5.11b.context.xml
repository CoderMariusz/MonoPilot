<?xml version="1.0" encoding="UTF-8"?>
<story>
  <id>5.11b</id>
  <name>GRN Integration (ASN/PO Updates)</name>
  <batch>5A-3 (Receiving) - SPLIT from 5.11</batch>
  <part>2 of 3</part>
  <updated>2025-11-28</updated>
  <status>Todo</status>

  <context>
    <description>
      Part 2 of GRN implementation. Updates ASN, PO, and TO statuses
      based on received quantities. Tracks receiving progress in procurement.
    </description>

    <scope>
      - ASN status update (open → received/completed)
      - PO line received_qty tracking
      - PO line status update (pending → partial → received)
      - PO header status update (completion check)
      - TO status update (if Transfer Order)
      - Status history audit trail
    </scope>

    <what-is-not-included>
      - Transaction atomicity (see 5.11c)
      - Over-receipt validation (see 5.11c)
      - Error handling (see 5.11c)
    </what-is-not-included>

    <critical-requirements>
      ASN STATUS:
      All items fully received → 'completed'
      Some items partially received → 'received'

      PO RECEIVED_QTY:
      Incremented for each GRN from same PO
      Supports multi-shipment receiving

      PO STATUS:
      All lines 'received' → PO 'received'
      Any line 'pending' → PO 'open'
      Updates po.received_date when complete

      AUDIT TRAIL:
      Record status changes with user, timestamp, operation_type
    </critical-requirements>

    <related-stories>
      <requires>5.11a (GRN & LP Creation)</requires>
      <followed-by>5.11c (Transaction Atomicity - wraps this logic)</followed-by>
      <enables>5.13 (PO Dashboard)</enables>
    </related-stories>

    <effort-estimate>
      <hours>4-5</hours>
      <points>3</points>
    </effort-estimate>

    <implementation-notes>
      - Extend GRN creation endpoint with integration logic
      - Check source_type (asn/po/to) and call appropriate handler
      - ASN handler: calculate totals vs ordered, update status
      - PO handler: iterate lines, increment received_qty, update line status, check completion
      - TO handler: similar to ASN
      - Status history table: track all status changes
      - UI: display impact on ASN/PO in GRN detail (e.g., "ASN marked completed")
      - Audit trail essential for compliance
    </implementation-notes>
  </context>
</story>
