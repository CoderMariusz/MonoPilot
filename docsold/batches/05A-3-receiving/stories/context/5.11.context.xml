<?xml version="1.0" encoding="UTF-8"?>
<story>
  <metadata>
    <id>5.11</id>
    <title>GRN and LP Creation</title>
    <batch>5A-3</batch>
    <points>8</points>
    <effort_hours>8-10</effort_hours>
    <status>todo</status>
    <gap_reference>Sprint 0 Gap 6: Transaction Atomicity</gap_reference>
  </metadata>

  <description>Create GRN with atomic LP creation - all-or-nothing transaction guaranteeing data consistency and preventing orphaned records</description>

  <dependencies>
    <requires>
      <story id="5.1">License Plate Creation</story>
      <story id="5.4">LP Number Generation</story>
      <story id="5.8">ASN Creation</story>
      <story id="5.10">Over-Receipt Validation</story>
    </requires>
    <enables>
      <story id="5.12">Auto-Print Labels</story>
      <story id="5.13">Update PO/TO Received Qty</story>
      <story id="5.28">Forward/Backward Traceability</story>
    </enables>
  </dependencies>

  <technical_context>
    <tables>
      <table>
        <name>grn</name>
        <columns>
          <column name="id" type="UUID" constraint="PK, DEFAULT gen_random_uuid()"/>
          <column name="org_id" type="UUID" constraint="NOT NULL, FK organizations(id)"/>
          <column name="grn_number" type="VARCHAR(50)" constraint="NOT NULL, UNIQUE(org_id, grn_number)"/>
          <column name="asn_id" type="UUID" constraint="FK asn(id)"/>
          <column name="po_id" type="UUID" constraint="FK purchase_orders(id)"/>
          <column name="to_id" type="UUID" constraint="FK transfer_orders(id)"/>
          <column name="supplier_id" type="UUID" constraint="NOT NULL, FK suppliers(id)"/>
          <column name="warehouse_id" type="UUID" constraint="NOT NULL, FK warehouses(id)"/>
          <column name="receiving_date" type="TIMESTAMP" constraint="DEFAULT now()"/>
          <column name="status" type="VARCHAR(20)" constraint="DEFAULT 'received'"/>
          <column name="notes" type="TEXT"/>
          <column name="created_at" type="TIMESTAMP" constraint="DEFAULT now()"/>
          <column name="created_by_user_id" type="UUID" constraint="NOT NULL, FK users(id)"/>
        </columns>
        <indexes>
          <index name="idx_grn_org_id" columns="org_id"/>
          <index name="idx_grn_asn_id" columns="asn_id"/>
          <index name="idx_grn_po_id" columns="po_id"/>
          <index name="idx_grn_supplier_id" columns="supplier_id"/>
          <index name="idx_grn_warehouse_id" columns="warehouse_id"/>
          <index name="idx_grn_receiving_date" columns="receiving_date"/>
        </indexes>
      </table>
      <table>
        <name>grn_items</name>
        <columns>
          <column name="id" type="UUID" constraint="PK, DEFAULT gen_random_uuid()"/>
          <column name="org_id" type="UUID" constraint="NOT NULL, FK organizations(id)"/>
          <column name="grn_id" type="UUID" constraint="NOT NULL, FK grn(id)"/>
          <column name="po_line_id" type="UUID" constraint="FK po_lines(id)"/>
          <column name="asn_item_id" type="UUID" constraint="FK asn_items(id)"/>
          <column name="product_id" type="UUID" constraint="NOT NULL, FK products(id)"/>
          <column name="received_qty" type="DECIMAL(15,4)" constraint="NOT NULL"/>
          <column name="uom" type="VARCHAR(10)" constraint="NOT NULL"/>
          <column name="lp_id" type="UUID" constraint="FK license_plates(id)"/>
        </columns>
        <indexes>
          <index name="idx_grn_items_org_id" columns="org_id"/>
          <index name="idx_grn_items_grn_id" columns="grn_id"/>
          <index name="idx_grn_items_product_id" columns="product_id"/>
          <index name="idx_grn_items_po_line_id" columns="po_line_id"/>
        </indexes>
      </table>
      <table>
        <name>grn_number_sequence</name>
        <columns>
          <column name="id" type="UUID" constraint="PK"/>
          <column name="org_id" type="UUID" constraint="NOT NULL, UNIQUE"/>
          <column name="sequence_date" type="DATE" constraint="NOT NULL"/>
          <column name="next_sequence" type="INT" constraint="DEFAULT 1"/>
        </columns>
        <unique_constraint>UNIQUE(org_id, sequence_date)</unique_constraint>
      </table>
    </tables>

    <api_endpoints>
      <endpoint method="POST" path="/api/warehouse/grns">
        <description>Create GRN with atomic LP creation (Gap 6: all-or-nothing transaction)</description>
        <auth>authenticated</auth>
        <request>
          <field name="asn_id" type="UUID" required="false" constraint="asn_id OR po_id required"/>
          <field name="po_id" type="UUID" required="false" constraint="po_id OR asn_id required"/>
          <field name="grn_items" type="array" required="true" constraint="min 1 item">
            <item>
              <field name="asn_item_id" type="UUID" required="false"/>
              <field name="po_line_id" type="UUID" required="false"/>
              <field name="product_id" type="UUID" required="true"/>
              <field name="received_qty" type="decimal" required="true" constraint="&gt; 0"/>
              <field name="batch_number" type="string" required="true"/>
              <field name="supplier_batch_number" type="string" required="false"/>
              <field name="manufacture_date" type="date" required="false"/>
              <field name="expiry_date" type="date" required="false"/>
              <field name="location_id" type="UUID" required="true"/>
              <field name="qa_status" type="enum" required="false" constraint="pending|passed, default pending"/>
            </item>
          </field>
          <field name="notes" type="string" required="false"/>
        </request>
        <response status="201">
          <field name="grn_id" type="UUID"/>
          <field name="grn_number" type="string" example="GRN-20250120-0001"/>
          <field name="grn_items" type="array"/>
          <field name="license_plates" type="array">
            <item>
              <field name="lp_id" type="UUID"/>
              <field name="lp_number" type="string" example="LP-20250120-0001"/>
              <field name="product_id" type="UUID"/>
              <field name="qty" type="decimal"/>
              <field name="location_id" type="UUID"/>
            </item>
          </field>
          <field name="asn_status_updated" type="string" example="completed"/>
          <field name="po_received_qty_updated" type="boolean"/>
        </response>
        <response status="400">
          <field name="error" type="string"/>
          <field name="error_code" type="string" constraint="PARENT_NOT_FOUND|INVALID_LOCATION|INVALID_PRODUCT|DUPLICATE_LP_NUMBER|PO_UPDATE_FAILED|etc"/>
          <field name="failed_step" type="integer" example="4 (FK validation, INSERT location, etc)"/>
        </response>
      </endpoint>
    </api_endpoints>

    <transaction_flow>
      <name>GRN + LP Creation (Atomic - Gap 6)</name>
      <step number="1" name="BEGIN TRANSACTION"/>
      <step number="2" name="VALIDATE pre-conditions">
        <validation>asn_id exists OR po_id exists (FK check)</validation>
        <validation>supplier_id valid (FK check)</validation>
        <validation>warehouse_id valid (FK check)</validation>
        <validation>All product_ids exist (FK check)</validation>
        <validation>All location_ids exist and active (FK check)</validation>
      </step>
      <step number="3" name="INSERT grn record">
        <fields>grn_number (auto-generated), org_id, asn_id, po_id, supplier_id, warehouse_id, receiving_date, status, created_by_user_id</fields>
        <on_failure>ROLLBACK: No GRN created</on_failure>
      </step>
      <step number="4" name="FOR each grn_item:">
        <substep>Validate: quantity > 0</substep>
        <substep>Validate: product_id exists (FK check)</substep>
        <substep>INSERT grn_item record</substep>
        <substep>Auto-generate lp_number using lp_number_sequence</substep>
        <substep>INSERT license_plates record with lp_number, qty, product_id, batch, expiry, location, status='available'</substep>
        <substep>UPDATE grn_item.lp_id = created_lp_id</substep>
        <on_failure>ROLLBACK: No grn_items, no LPs, no GRN</on_failure>
      </step>
      <step number="5" name="UPDATE asn.status ‚Üí 'completed'">
        <condition>IF grn created from asn_id</condition>
        <on_failure>ROLLBACK: Transaction aborted</on_failure>
      </step>
      <step number="6" name="UPDATE po_line.received_qty += grn_item.received_qty">
        <condition>IF grn created from po_id</condition>
        <on_failure>ROLLBACK: Transaction aborted</on_failure>
      </step>
      <step number="7" name="CHECK PO completion">
        <logic>IF all po_lines have received_qty >= ordered_qty THEN UPDATE po.status ‚Üí 'closed'</logic>
        <on_failure>ROLLBACK: Transaction aborted</on_failure>
      </step>
      <step number="8" name="COMMIT transaction"/>
      <step number="9" name="Return GRN + LPs on success"/>
    </transaction_flow>

    <error_scenarios>
      <error code="ASN_NOT_FOUND">
        <message>Cannot create GRN: ASN #{asn_id} no longer exists. Please refresh and try again.</message>
        <step_failed>2</step_failed>
        <http_status>400</http_status>
        <rollback>Yes - No GRN created</rollback>
      </error>
      <error code="INVALID_SUPPLIER">
        <message>Cannot create GRN: Supplier is inactive or does not exist. Please select a valid supplier.</message>
        <step_failed>2</step_failed>
        <http_status>400</http_status>
        <rollback>Yes</rollback>
      </error>
      <error code="INVALID_LOCATION">
        <message>Cannot create LP: Location 'WH-A-01' is inactive. Please select a different location.</message>
        <step_failed>4</step_failed>
        <http_status>400</http_status>
        <rollback>Yes - No GRN, no LPs, no asn/po updates</rollback>
      </error>
      <error code="INVALID_PRODUCT">
        <message>Cannot create LP: Product SKU 'ABC123' no longer exists. Please verify product catalog.</message>
        <step_failed>4</step_failed>
        <http_status>400</http_status>
        <rollback>Yes</rollback>
      </error>
      <error code="DUPLICATE_LP_NUMBER">
        <message>Cannot create LP: License Plate #{lp_number} already exists. System will retry with next number.</message>
        <step_failed>4</step_failed>
        <http_status>400</http_status>
        <rollback>Yes - Retry with next sequence number</rollback>
        <retry_logic>Auto-retry with next lp_number, max 3 attempts</retry_logic>
      </error>
      <error code="PO_UPDATE_FAILED">
        <message>GRN creation aborted: Unable to update PO received quantity. Transaction rolled back.</message>
        <step_failed>6</step_failed>
        <http_status>400</http_status>
        <rollback>Yes - COMPLETE rollback of entire transaction</rollback>
      </error>
      <error code="QUANTITY_INVALID">
        <message>Cannot create GRN: Received quantity must be > 0. Line item rejected.</message>
        <step_failed>4</step_failed>
        <http_status>400</http_status>
        <rollback>Yes</rollback>
      </error>
    </error_scenarios>

    <data_integrity_guarantees>
      <guarantee name="Consistency">‚úÖ GRN exists ‚Üí All LPs exist (no orphaned items)</guarantee>
      <guarantee name="FK Integrity">‚úÖ LP exists ‚Üí Parent GRN exists</guarantee>
      <guarantee name="ASN Completion">‚úÖ ASN marked 'completed' ‚Üí GRN exists with all items</guarantee>
      <guarantee name="PO Tracking">‚úÖ PO received_qty updated ‚Üí GRN exists</guarantee>
      <guarantee name="Atomicity">‚úÖ All-or-nothing: Either complete transaction or complete rollback</guarantee>
      <violation name="Never">‚ùå NEVER: GRN without LPs</violation>
      <violation name="Never">‚ùå NEVER: LP without GRN</violation>
      <violation name="Never">‚ùå NEVER: ASN 'completed' without GRN</violation>
      <violation name="Never">‚ùå NEVER: Partial updates (must be all-or-nothing)</violation>
    </data_integrity_guarantees>

    <validation_rules>
      <rule id="asn_or_po_required">Either asn_id OR po_id must be provided (not both, not neither)</rule>
      <rule id="fk_asn_exists">If asn_id provided, ASN must exist in database</rule>
      <rule id="fk_po_exists">If po_id provided, PO must exist in database</rule>
      <rule id="fk_supplier_valid">supplier_id must exist and be active</rule>
      <rule id="fk_warehouse_valid">warehouse_id must exist and be active</rule>
      <rule id="fk_product_valid">Each product_id must exist in products table</rule>
      <rule id="fk_location_valid">Each location_id must exist and be active</rule>
      <rule id="qty_positive">received_qty must be > 0 for all items</rule>
      <rule id="qty_not_overage">If warehouse_settings.allow_over_receipt = false, check over-receipt</rule>
      <rule id="manufacture_before_expiry">If both provided: manufacture_date < expiry_date</rule>
      <rule id="org_isolation">All records must belong to same org_id (multi-tenant)</rule>
    </validation_rules>

    <rls_policies>
      <policy table="grn">
        <select>WHERE org_id = current_user.org_id</select>
        <insert>WHERE org_id = current_user.org_id</insert>
        <update>WHERE org_id = current_user.org_id</update>
      </policy>
      <policy table="grn_items">
        <select>WHERE org_id = current_user.org_id</select>
        <insert>WHERE org_id = current_user.org_id</insert>
      </policy>
    </rls_policies>
  </technical_context>

  <acceptance_criteria>
    <ac id="1" title="GRN Creation Modal">
      <test>Open ASN detail, click "Receive Goods" ‚Üí modal opens with grn_items form</test>
    </ac>
    <ac id="2" title="Auto-generated GRN Number">
      <test>Submit GRN ‚Üí grn_number = GRN-20250120-0001 (auto-generated, unique)</test>
    </ac>
    <ac id="3" title="LP Auto-creation">
      <test>After GRN saved, 3 LPs created ‚Üí each has auto-generated lp_number, qty, product, batch</test>
    </ac>
    <ac id="4" title="Link LP to GRN">
      <test>LP detail shows GRN link, can navigate back to GRN</test>
    </ac>
    <ac id="5" title="ASN Status Update">
      <test>After GRN created, ASN status ‚Üí 'completed'</test>
    </ac>
    <ac id="6" title="Transaction Atomicity (Gap 6)">
      <test>If LP creation fails (duplicate number), entire transaction rolls back ‚Üí no GRN created</test>
      <test>If PO update fails, entire transaction rolls back ‚Üí no GRN, no LPs</test>
      <test>All validations happen atomically ‚Üí one failure = complete rollback</test>
    </ac>
  </acceptance_criteria>

  <test_plan>
    <unit_tests>
      <test>Validation: qty > 0 ‚Üí pass/fail</test>
      <test>Validation: product_id exists ‚Üí pass/fail</test>
      <test>GRN number generation: format GRN-YYYYMMDD-NNNN</test>
      <test>LP number generation: each item gets unique lp_number</test>
    </unit_tests>
    <integration_tests>
      <test>POST /api/warehouse/grns with valid ASN ‚Üí GRN + 3 LPs created</test>
      <test>POST with FK violation ‚Üí 400 error, no data created (rollback)</test>
      <test>POST with duplicate LP ‚Üí auto-retry, success</test>
      <test>Verify: grn, grn_items, license_plates all created in transaction</test>
      <test>Verify: asn.status updated to 'completed'</test>
      <test>Verify: po_line.received_qty incremented</test>
    </integration_tests>
    <e2e_tests>
      <test>Create ASN, click Receive, modal opens, enter items/locations</test>
      <test>Submit ‚Üí GRN created, 3 LPs created, ASN status 'completed'</test>
      <test>View GRN detail ‚Üí see all LPs with links</test>
      <test>View each LP ‚Üí see GRN link in LP detail</test>
    </e2e_tests>
  </test_plan>

  <implementation_notes>
    <note priority="critical">üö® Sprint 0 Gap 6: Transaction atomicity is MANDATORY. If ANY validation fails, entire transaction must rollback with no partial updates.</note>
    <note priority="critical">Use database-level transactions (BEGIN/COMMIT/ROLLBACK) for guarantee. Cannot rely on application-level logic alone.</note>
    <note priority="critical">FK validation must happen BEFORE any INSERTs. Prevent orphaned records.</note>
    <note priority="high">Duplicate LP# handling: auto-retry mechanism to get next sequence number. Max 3 retries before failing.</note>
    <note priority="high">Error messages must be specific to failure point so user knows what went wrong.</note>
    <note priority="high">Test thoroughly: Create test case with FK violation at step 6 (PO update) to verify complete rollback.</note>
    <note priority="medium">Log all transaction attempts (success and failure) for audit trail.</note>
  </implementation_notes>
</story>
