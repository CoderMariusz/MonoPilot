# Story 5.11: GRN and LP Creation

**ID:** 5.11
**Batch:** 5A-3 (Receiving)
**Story Points:** 8
**Effort:** 8-10 hours
**Status:** Todo

---

## User Story

> As a **Warehouse user**, I want to receive goods and create LPs, so that inventory is recorded.

---

## Acceptance Criteria

### AC 1: GRN Creation Modal
- **Given** ASN exists (or ad-hoc receiving without ASN)
- **When** clicking "Receive" button
- **Then** receive modal opens with:
  - ASN number (read-only if from ASN)
  - GRN items table (editable)
  - For each item: product, qty, batch, expiry, location, qa_status
  - Notes field (optional)

### AC 2: Auto-generate GRN Number
- **Given** saving GRN
- **When** submitting receive form
- **Then** system auto-generates GRN number:
  - Format: GRN-YYYYMMDD-NNNN (e.g., GRN-20250120-0001)
  - Daily sequence reset
  - Unique per org_id

### AC 3: LP Auto-creation
- **Given** GRN created
- **When** processing each grn_item
- **Then** system auto-creates license_plates:
  - Auto-generate lp_number for each item
  - Set qty = received_qty
  - Set product_id, batch_number, expiry_date
  - Set location_id from grn_item location
  - Set status = 'available'
  - Set qa_status from warehouse default or override

### AC 4: Link LP to GRN
- **Given** LP created
- **When** during receiving
- **Then** LP linked to GRN:
  - grn_items references lp_id
  - Can trace LP back to GRN

### AC 5: ASN Status Update
- **Given** GRN created from ASN
- **When** receiving completes
- **Then** ASN status updated:
  - If all items received: asn.status → 'completed'
  - If partial items: asn.status → 'received'

### AC 6: Transaction Atomicity (Sprint 0 Gap 6) ⭐ CRITICAL

**GRN + LP creation is atomic (all-or-nothing guarantee):**

**Transaction Flow:**

1. **START** database transaction
2. **VALIDATE** pre-conditions:
   - asn_id exists (if from ASN) → FK check
   - po_id exists (if ad-hoc) → FK check
   - supplier_id valid → FK check
   - warehouse_id valid → FK check
   - All grn_items have valid product_id → FK check
   - Location IDs valid → FK check
3. **INSERT** grn record with:
   - grn_number (auto-generated)
   - org_id, asn_id, po_id, supplier_id, warehouse_id
   - receiving_date = now()
   - status = 'received'
4. **FOR each grn_item:**
   - Validate: quantity > 0
   - Validate: product_id exists
   - INSERT grn_item record
   - Auto-generate lp_number
   - INSERT license_plates record
   - Store lp_id in grn_item
5. **UPDATE** asn.status → 'completed' (if from ASN)
6. **UPDATE** po_line.received_qty += grn_qty (if from PO)
7. **CHECK** PO completion:
   - If all lines received >= ordered: UPDATE po.status → 'closed'
8. **COMMIT** transaction

**Rollback Scenarios:**

**If ANY step fails** (FK violation, validation error, unique constraint):
- Transaction **ROLLBACK**
- **No partial records created:**
  - No GRN record
  - No GRN items
  - No LP records
  - No ASN status update
  - No PO quantity update
- **Error message** displayed with specific failure reason

**Error Examples:**

| Failure Point | Error Message |
|---|---|
| ASN not found | "Cannot create GRN: ASN #12345 no longer exists. Please refresh and try again." |
| Invalid supplier | "Cannot create GRN: Supplier is inactive or does not exist. Please select a valid supplier." |
| Invalid location | "Cannot create LP: Location 'WH-A-01' is inactive. Please select a different location." |
| Invalid product | "Cannot create LP: Product SKU 'ABC123' no longer exists. Please verify product catalog." |
| Duplicate LP# | "Cannot create LP: License Plate LP-001234 already exists. System will retry with next number." |
| PO update fails | "GRN creation aborted: Unable to update PO received quantity. Transaction rolled back." |
| Quantity invalid | "Cannot create GRN: Received quantity must be > 0. Line item rejected." |

**Data Integrity Guarantees:**
- ✅ GRN exists → All LPs exist (no orphaned items)
- ✅ LP exists → Parent GRN exists
- ✅ ASN marked Completed → GRN exists with all items
- ✅ PO received_qty updated → GRN exists
- ❌ NEVER: GRN without LPs
- ❌ NEVER: LP without GRN
- ❌ NEVER: ASN Completed without GRN
- ❌ NEVER: Partial updates (all-or-nothing)

---

## Technical Tasks

### Backend

- [ ] Create `POST /api/warehouse/grns` endpoint (ATOMIC)
  - Accept: asn_id OR po_id, grn_items[], notes (optional)
  - Validate all FK constraints in transaction
  - Auto-generate GRN number using grn_number_sequence
  - For each grn_item: auto-generate LP number
  - INSERT grn, grn_items, license_plates in single transaction
  - UPDATE asn.status, po_line.received_qty in same transaction
  - Handle rollback with specific error messages
  - Return: GRN with created LPs

- [ ] Create grn_number_sequence table
  - org_id, sequence_date, next_sequence
  - Similar to lp_number_sequence

- [ ] Add error handling with specific messages
  - FK validation errors
  - Quantity validation errors
  - Duplicate LP# detection (retry with next number)

- [ ] Implement transaction with proper rollback
  - Use database transaction semantics (BEGIN/COMMIT/ROLLBACK)
  - Ensure atomicity: if ANY step fails, entire transaction rolls back

### Database

- [ ] Create grn table (per tech-spec)
- [ ] Create grn_items table (per tech-spec)
- [ ] Create grn_number_sequence table
- [ ] Add foreign keys with constraints
- [ ] Create indexes on org_id, asn_id, po_id, status, receiving_date
- [ ] Verify RLS policies

### Frontend

- [ ] Update ASN detail: Add "Receive Goods" button
  - Opens receive modal (GrnReceiveModal)

- [ ] Create `GrnReceiveModal` component
  - Form: ASN/PO selector, grn_items table
  - For each item: product (readonly), qty (editable), batch (editable), expiry (editable), location (dropdown), qa_status (dropdown)
  - Over-receipt validation (if configured)
  - Notes field (optional)
  - Buttons: "Receive" (submit), "Cancel"
  - Error display for failed receipt

- [ ] Create GRN list page: `/warehouse/grns`
  - Columns: GRN number, supplier, receiving_date, item_count, status, actions
  - Filters: date range, supplier
  - Actions: View detail, print labels (future)

- [ ] Create GRN detail page: `/warehouse/grns/:id`
  - Show: GRN number, ASN/PO link, supplier, receiving date
  - Items table: product, qty, batch, expiry, location, lp_number
  - LP links: Click to view LP detail
  - Notes display

---

## Testing

### Unit Tests
- GRN number generation: format, uniqueness, daily reset
- LP number auto-generation for each item
- Transaction atomicity: FK violation → complete rollback
- Quantity validation: 0, negative → error
- Over-receipt calculation (if applicable)

### Integration Tests
- POST /api/warehouse/grns with valid ASN
- Verify: grn, grn_items, license_plates all created
- Verify: asn.status updated to 'completed'
- Verify: po_line.received_qty incremented
- POST /api/warehouse/grns with FK violation → 400, no data created
- POST with duplicate LP# → auto-retry, success

### E2E Tests
- Create ASN with 3 items
- Click "Receive Goods" on ASN
- Modal opens with items pre-filled
- Enter quantities, locations, batch/expiry data
- Click "Receive"
- Verify: GRN created with auto-number
- Verify: 3 LPs created with auto-numbers
- Verify: ASN status → 'completed'
- Verify: LP numbers visible in GRN detail
- Verify: LPs visible in LP list
- Verify: PO received_qty updated

---

## Acceptance Criteria Checklist

- ✅ Receive modal opens from ASN
- ✅ GRN number auto-generated (GRN-YYYYMMDD-NNNN)
- ✅ LP number auto-generated for each item
- ✅ GRN linked to ASN/PO
- ✅ ASN status updated on receipt
- ✅ **Transaction atomicity: all-or-nothing guarantee (Gap 6)**
- ✅ Specific error messages for each failure point
- ✅ No partial updates: rollback on ANY failure
- ✅ Data integrity: GRN → LPs → ASN/PO updates

---

## Dependencies

**Requires:** Story 5.1 (LP Creation), Story 5.4 (LP Number Generation), Story 5.8 (ASN Creation), Story 5.10 (Over-Receipt Validation)

**Enables:** Story 5.12 (Auto-Print Labels), Story 5.13 (Update PO/TO Qty), Story 5.28 (Traceability)

**Blocks:** None directly

---

## Notes

- **CRITICAL Sprint 0 Gap 6:** This story requires careful transaction handling
- **Atomicity is non-negotiable:** All-or-nothing guarantee for data consistency
- **Rollback logic:** Every failure point must trigger complete transaction rollback
- **Error messages:** Specific to failure point helps users understand what went wrong
- **FK validation:** Prevents orphaned records (GRN without LPs, LP without GRN)
- **Idempotency:** Duplicate LP# should trigger retry with next sequence number
