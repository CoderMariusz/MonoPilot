# Story 4.6: WO Complete

**Epic:** 4 - Production Execution
**Status:** Todo
**Priority:** P0 (MVP)
**Story Points:** 3
**Created:** 2025-11-27
**Updated:** 2025-11-28 (expanded ACs, transaction atomicity, genealogy validation, concurrency handling)
**Effort Estimate:** 1 day

---

## Goal

Enable operators to complete work orders atomically after all operations and outputs are registered, with full transaction protection and genealogy validation.

## User Story

**As an** Operator
**I want** to complete a work order
**So that** I can finish production and close the manufacturing cycle

---

## Problem Statement

Work orders need a final completion step that:
1. Validates all prerequisites (operations done, outputs registered, genealogy linked)
2. Performs atomic status transition with concurrent access protection
3. Handles genealogy completion verification (warn, don't block if incomplete)
4. Logs completion audit trail
5. Prevents duplicate completions

---

## Acceptance Criteria

### AC-4.6.1: Complete Modal & Validation

**Given** WO is in_progress or paused
**When** operator clicks "Complete WO" on WO detail page
**Then** modal opens showing:
- WO number (read-only)
- Planned qty and output qty summary (e.g., "Planned: 1000 units, Output: 980 units")
- All operations status (✅ Mixing complete, ✅ Fermentation complete, ⚠️ Curing in progress)
- Output LPs count (e.g., "3 production LPs created")
- By-products status if in BOM (optional indicator)
- Genealogy completion status (⚠️ warning if incomplete)
- "Cancel" and "Complete WO" buttons

**Validation performed before modal shows:**
- [ ] AC-4.6.1a: WO status is in_progress or paused
- [ ] AC-4.6.1b: All operations (wo_operations) have status='completed'
- [ ] AC-4.6.1c: At least one output LP exists (wo_output_lps table, status='in_production')
- [ ] AC-4.6.1d: By-products registered if in BOM (optional, no error if missing)

**Success Criteria:**
- ✅ Modal displays WO summary correctly
- ✅ Operations status clearly shown
- ✅ Genealogy warning shown if incomplete (does not block completion)
- ✅ "Complete WO" button enabled if all mandatory validations pass

---

### AC-4.6.2: Status Transition (Atomic)

**Given** operator confirms completion in modal
**When** confirming
**Then** system performs atomic update with transaction:
```
1. ACQUIRE row-level lock: SELECT...FOR UPDATE on work_orders
   (Hold lock through entire transaction until COMMIT)

2. RE-VALIDATE (check again for race conditions):
   - WO status is still in_progress or paused
   - All operations are completed
   - At least one output exists
   - WO not already completed

3. UPDATE work_orders:
   - status → 'completed'
   - completed_at → current_timestamp (server time)
   - completed_by_user_id → current_user.id
   - updated_at → current_timestamp

4. UPDATE wo_operations:
   - For all operations: updated_at → current_timestamp
   - (status stays 'completed', don't re-update)

5. UPDATE output LPs (wo_output_lps):
   - For all LPs with status='in_production': status → 'available'
   - updated_at → current_timestamp

6. VALIDATE genealogy:
   - For all lp_genealogy records with wo_id = this WO:
     - IF child_lp_id IS NULL: Add WARNING (genealogy incomplete)
     - IF all have child_lp_id: All genealogy linked ✅
   - (Do NOT block completion if incomplete, just log warning)

7. EMIT EVENT: "work_order.completed" (for dashboard realtime updates)

8. COMMIT transaction (lock released)
```

**Success Criteria:**
- ✅ Status transitions: in_progress → completed
- ✅ completed_at timestamp recorded (server time)
- ✅ completed_by_user_id recorded for audit
- ✅ Output LPs status changed: in_production → available
- ✅ Genealogy validated but not blocking
- ✅ No partial updates (atomic)
- ✅ Event emitted for dashboard

---

### AC-4.6.3: Genealogy Validation (Warning Pattern)

**Given** WO completion is processed
**When** genealogy records are validated in step 6 above
**Then** system checks genealogy completion:

| Scenario | Genealogy State | Action | Message |
|----------|-----------------|--------|---------|
| All linked | All child_lp_id filled | Proceed ✅ | "Genealogy complete" |
| Some incomplete | Some child_lp_id NULL | Proceed with ⚠️ | "⚠️ Warning: 2 genealogy records incomplete (material not fully linked to outputs)" |
| Not created | No records | Proceed with ⚠️ | "⚠️ Warning: No genealogy records for this WO" |

**Genealogy Completion Timeline (from previous stories):**
- Created in Story 4.7 (material reservation): parent_lp_id set, child_lp_id = NULL
- Updated in Story 4.12 (output registration): child_lp_id filled with output LP
- Validated in Story 4.6 (this story): Warning if incomplete, but WO can still complete

**Success Criteria:**
- ✅ Genealogy validation does NOT block WO completion
- ✅ Warning message shown in modal if incomplete
- ✅ Warning logged in audit trail
- ✅ Completion proceeds regardless of genealogy state

---

### AC-4.6.4: By-Products Validation (Optional)

**Given** product's BOM includes by-products
**When** WO completion is validated
**Then** check if by-products registered:

**Logic:**
```
IF product_id has by_products in BOM:
  FOR each by_product:
    IF NOT registered in wo_output_lps (by_product_id != null):
      Add to warnings (do not block)
      Message: "By-product 'X' not registered"
    ELSE:
      Status: ✅ Registered
ELSE:
  No by-product validation needed
```

**Success Criteria:**
- ✅ By-product registration is optional
- ✅ Missing by-products shown as warning only
- ✅ Completion not blocked if by-products missing
- ✅ Operator can see which by-products are missing before completion

---

### AC-4.6.5: Error Handling & Atomicity

**When** any MANDATORY validation fails (in AC-4.6.1 or step 2 of AC-4.6.2)
**Then** return 400 error with specific code and message, NO partial updates:

| Condition | Error Code | HTTP | Message |
|-----------|-----------|---------|---------|
| Already completed | ALREADY_COMPLETED | 400 | "Work order #WO-001 is already completed" |
| Status not in_progress/paused | INVALID_WO_STATUS | 400 | "WO must be in_progress or paused to complete" |
| Operations pending | OPERATIONS_INCOMPLETE | 400 | "Cannot complete: 2 operations not completed (Mixing, Curing)" |
| No output registered | NO_OUTPUT | 400 | "Register at least one output LP before completing" |
| WO not found | NOT_FOUND | 404 | "Work order not found" |
| Wrong org_id | ORG_ISOLATION | 403 | (no details for security) |
| Not authenticated | UNAUTHORIZED | 401 | (standard auth error) |
| Insufficient role | FORBIDDEN | 403 | "Insufficient permissions to complete work orders" |
| Concurrency conflict | CONCURRENCY_ERROR | 409 | "WO was modified by another user, please refresh and try again" |

**Success Criteria:**
- ✅ All error codes specific and actionable
- ✅ Error messages show affected items (operation names, counts)
- ✅ No partial updates on error (full rollback)
- ✅ Concurrency conflicts handled gracefully

---

### AC-4.6.6: API Endpoint

**POST /api/production/work-orders/:id/complete**

```typescript
Request: {}  // No body needed

Response (200): {
  data: {
    id: uuid,
    wo_number: string,                    // "WO-001"
    status: string,                       // "completed"
    completed_at: timestamp,              // "2025-11-28T15:45:00Z"
    completed_by_user_id: uuid,
    completed_by_user: {
      id: uuid,
      name: string                        // "John Operator"
    },
    output_qty: number,                   // 980
    planned_qty: number,                  // 1000
    output_lps_count: number,             // 3
    genealogy_warnings: string[] | null,  // ["2 genealogy records incomplete"] or null
    by_product_warnings: string[] | null  // ["By-product Y not registered"] or null
  },
  message: "Work order completed successfully"
}

Error (400/403/404/409): {
  error: string,                          // Error code
  message: string,                        // User-friendly message
  details?: object                        // Additional context (e.g., incomplete operations)
}
```

**Success Criteria:**
- ✅ POST endpoint at `/api/production/work-orders/:id/complete`
- ✅ Returns 200 with updated WO object
- ✅ Returns error codes with specific details
- ✅ Auth & org isolation enforced
- ✅ Warnings included in response (genealogy, by-products)

---

### AC-4.6.7: Concurrency Protection (SELECT FOR UPDATE)

**Given** multiple operators click "Complete WO" simultaneously
**When** both requests reach the backend
**Then** database row-level locking prevents race conditions:

**Implementation:**
```sql
BEGIN TRANSACTION;
  SELECT * FROM work_orders WHERE id = :wo_id FOR UPDATE;
  -- Lock acquired, all other requests wait

  -- Re-validate (check step 2 in AC-4.6.2)
  -- All validation and updates happen here
  -- If any validation fails: ROLLBACK (lock released, other request unblocks)

  -- If validation passes: UPDATE and COMMIT (lock released)
COMMIT;
```

**Lock Behavior:**
- First request acquires lock
- Second request waits (not blocked, just queued)
- First request completes → COMMIT → lock released
- Second request acquires lock → checks status again
- If already completed: Returns ALREADY_COMPLETED error (409 or 400)

**Success Criteria:**
- ✅ SELECT...FOR UPDATE lock held through entire transaction (until COMMIT)
- ✅ Re-validation prevents duplicate completions
- ✅ Second request fails gracefully with ALREADY_COMPLETED error
- ✅ No deadlock conditions

---

### AC-4.6.8: Role-Based Access

**Given** I have specific role
**When** attempting to complete WO
**Then** I have appropriate permissions:

| Role | Can Complete | Notes |
|------|-------------|-------|
| Production Manager | ✅ Yes | Primary user |
| Operator | ✅ Yes | Can complete own operations |
| Planner | ❌ No | Planning only |
| Quality Manager | ❌ No | Quality only |
| Admin | ✅ Yes | Full access |

**Success Criteria:**
- ✅ Role check on API endpoint
- ✅ 403 error if unauthorized
- ✅ "Complete WO" button hidden in UI for non-authorized roles

---

### AC-4.6.9: Dashboard Integration

**Given** work order is completed
**When** viewing production dashboard (Story 4.1)
**Then** dashboard updates in realtime:
- WO removed from "Active Work Orders" section
- WO appears in "Completed Today" summary (KPI cards update)
- Completed WO shows: WO#, Qty, Completion time, Operator

**Success Criteria:**
- ✅ Completed WOs hidden from active list
- ✅ Dashboard shows completed count update
- ✅ Completed WOs appear in daily summary
- ✅ Realtime update via event listener

---

### AC-4.6.10: Modal States & Feedback

**Given** WO completion modal is open
**When** user confirms
**Then** proper states shown:

| State | Trigger | UI | Button |
|-------|---------|----|----|
| Loading | API call in progress | Spinner, disabled | "Completing..." |
| Success | WO completed | Green checkmark, auto-close | N/A |
| Error | API error (400/409) | Red message with error code | "Try Again" |
| Warning | Genealogy incomplete but WO completed | Yellow banner | "OK" |

**Success Criteria:**
- ✅ Loading spinner during API call
- ✅ Button text changes during states
- ✅ Success toast: "Work order completed successfully"
- ✅ Error toast with specific error code and message
- ✅ Warning banner for incomplete genealogy (no retry needed)
- ✅ Modal auto-closes on success
- ✅ Navigation to WO summary or production dashboard

---

## Technical Tasks

### Backend

- [ ] Task 1: Verify work_orders table schema
  - [ ] Subtask 1.1: Verify completed_at TIMESTAMPTZ field
  - [ ] Subtask 1.2: Verify completed_by_user_id FK to users
  - [ ] Subtask 1.3: Verify RLS policy for org_id

- [ ] Task 2: Create WOCompleteService
  - [ ] Subtask 2.1: Implement completeWorkOrder(woId, userId, orgId) method
  - [ ] Subtask 2.2: Implement SELECT...FOR UPDATE lock pattern
  - [ ] Subtask 2.3: Implement operation completion validation
  - [ ] Subtask 2.4: Implement output LP existence check
  - [ ] Subtask 2.5: Implement genealogy validation (warn, not block)
  - [ ] Subtask 2.6: Implement by-product check (optional)
  - [ ] Subtask 2.7: Atomic transaction wrapper with full rollback
  - [ ] Subtask 2.8: Emit "work_order.completed" event
  - [ ] Subtask 2.9: Error handling (all error codes from AC 4.6.5)

- [ ] Task 3: Create API endpoint
  - [ ] Subtask 3.1: POST /api/production/work-orders/:id/complete
  - [ ] Subtask 3.2: Add auth & role checks
  - [ ] Subtask 3.3: Add error handling with specific codes
  - [ ] Subtask 3.4: Verify response format (warnings included)

### Frontend

- [ ] Task 4: Create WO Complete Modal component
  - [ ] Subtask 4.1: Display WO summary (planned qty, output qty)
  - [ ] Subtask 4.2: Display operations status list
  - [ ] Subtask 4.3: Display output LPs count
  - [ ] Subtask 4.4: Display genealogy warning if incomplete
  - [ ] Subtask 4.5: Display by-product warnings if missing
  - [ ] Subtask 4.6: "Cancel" and "Complete WO" buttons
  - [ ] Subtask 4.7: Loading/success/error states
  - [ ] Subtask 4.8: Auto-close on success
  - [ ] Subtask 4.9: Retry logic on error

- [ ] Task 5: Integrate with WO detail page
  - [ ] Subtask 5.1: Add "Complete WO" button (visible if WO in_progress/paused)
  - [ ] Subtask 5.2: Disable button if operations pending (with reason)
  - [ ] Subtask 5.3: Show completion time on WO summary after complete

### Testing

- [ ] Task 6: Unit tests - WOCompleteService
  - [ ] Subtask 6.1: Test completeWorkOrder with valid WO
  - [ ] Subtask 6.2: Test status transition: in_progress → completed
  - [ ] Subtask 6.3: Test completed_at timestamp recorded
  - [ ] Subtask 6.4: Test error: already completed
  - [ ] Subtask 6.5: Test error: operations incomplete
  - [ ] Subtask 6.6: Test error: no output registered
  - [ ] Subtask 6.7: Test genealogy warning (incomplete)
  - [ ] Subtask 6.8: Test by-product warning (optional)
  - [ ] Subtask 6.9: Test org_id isolation
  - [ ] Subtask 6.10: Target 95% coverage

- [ ] Task 7: Integration tests - API endpoint & concurrency
  - [ ] Subtask 7.1: Test POST /api/production/work-orders/:id/complete (200)
  - [ ] Subtask 7.2: Test 400 if already completed
  - [ ] Subtask 7.3: Test 400 if operations incomplete (show count)
  - [ ] Subtask 7.4: Test 400 if no output registered
  - [ ] Subtask 7.5: Test SELECT...FOR UPDATE concurrency (two concurrent requests)
  - [ ] Subtask 7.6: Test second request gets ALREADY_COMPLETED error
  - [ ] Subtask 7.7: Test 403 if wrong org
  - [ ] Subtask 7.8: Test 401 if not authenticated
  - [ ] Subtask 7.9: Test 403 if insufficient role
  - [ ] Subtask 7.10: Target 70% coverage

- [ ] Task 8: E2E tests - WO completion workflow
  - [ ] Subtask 8.1: Create test WO with 2 operations
  - [ ] Subtask 8.2: Start and complete Operation 1
  - [ ] Subtask 8.3: Start and complete Operation 2
  - [ ] Subtask 8.4: Register 2 output LPs
  - [ ] Subtask 8.5: Navigate to WO detail
  - [ ] Subtask 8.6: Click "Complete WO"
  - [ ] Subtask 8.7: Verify modal opens with WO summary
  - [ ] Subtask 8.8: Verify operations shown as complete
  - [ ] Subtask 8.9: Verify output LPs count shown
  - [ ] Subtask 8.10: Click "Complete WO" button
  - [ ] Subtask 8.11: Verify WO status = completed
  - [ ] Subtask 8.12: Verify completed_at timestamp
  - [ ] Subtask 8.13: Verify modal auto-closes
  - [ ] Subtask 8.14: Verify WO removed from active list on dashboard
  - [ ] Subtask 8.15: Verify output LPs status changed to available
  - [ ] Subtask 8.16: Target 100% critical path coverage

---

## Dev Notes

### Architecture Patterns
- **Status-based workflow**: WO completion as final state transition
- **Optimistic locking**: SELECT...FOR UPDATE for concurrency control
- **Audit trail**: completed_by_user_id + timestamps
- **Event-driven**: Emit "work_order.completed" for realtime updates
- **Warning pattern**: Genealogy/by-products warn but don't block

### Learnings from Previous Stories
- WO status enum from Story 3.10
- Modal patterns from Story 4.2 (WO Start)
- Dashboard integration from Story 4.1
- Operation completion from Story 4.5
- Genealogy linking from Story 4.7 (created) and 4.12 (updated)

### Constraints & Decisions
- **WO can complete from in_progress or paused** (can resume then complete, or complete while paused)
- **All operations must be completed** (mandatory validation)
- **At least one output must exist** (mandatory validation)
- **Genealogy incomplete = WARN, not BLOCK** (per PO clarification)
- **By-products optional** (no error if missing)
- **Auto-complete deferred to Phase 2** (not in Phase 1)

### Testing Strategy
- **Unit Tests** (95%): status transitions, validation logic, error scenarios, atomicity
- **Integration Tests** (70%): API endpoints, org isolation, role checks, concurrency with SELECT FOR UPDATE
- **E2E Tests** (100% critical): complete WO workflow with genealogy and outputs, concurrent completion attempts

---

## Status

- **Created:** 2025-11-27
- **Updated:** 2025-11-28 (expanded with 10 detailed ACs, transaction atomicity, genealogy validation, concurrency handling)
- **Current Status:** Todo
- **Target Status:** Done (after all ACs met + tests pass)
