# Story 4.4: Operation Start

**Epic:** 4 - Production Execution
**Status:** Todo
**Priority:** P0 (MVP)
**Story Points:** 2
**Created:** 2025-11-27
**Updated:** 2025-11-28 (detailed ACs, operation schema, sequence enforcement)
**Effort Estimate:** 1 day

---

## Goal

Enable operators to start work order operations, tracking progress through production steps with sequence enforcement.

## User Story

**As an** Operator
**I want** to start a WO operation
**So that** I can track step-by-step production progress

---

## Problem Statement

Operations are created during WO creation (Story 3.10) with status 'not_started'. Operators need to:
1. View available operations
2. Start operation with validation
3. Track operation progress
4. Enforce sequential operations (if configured)
5. Move to next operation seamlessly

---

## Acceptance Criteria

### AC-4.4.1: Operation Status Enum Definition

**Operation Status Lifecycle:**
```
not_started ‚Üí in_progress ‚Üí completed
```

**Status Details:**
- **not_started**: Initial state (set when operations created in Story 3.10)
- **in_progress**: After operator starts operation (this story)
- **completed**: After operator completes operation (Story 4.5)

**No other states** (no cancelled, blocked, or skipped - future Phase 2)

---

### AC-4.4.2: Operation Start Modal
**Given** WO is in_progress/paused and has operations with status='not_started'
**When** operator clicks "Start" on operation in WO detail page
**Then** modal opens showing:
- WO number (read-only)
- Operation sequence number (e.g., "Operation 1 of 3")
- Operation name/description (read-only, from routing)
- Expected duration (from routing recipe)
- Next operation name (preview what comes next)
- Status: "Not Started"
- "Cancel" and "Confirm Start" buttons

**Success Criteria:**
- ‚úÖ Modal shows operation details clearly
- ‚úÖ Sequence context shown ("Op 1 of 3")
- ‚úÖ Clear action buttons

---

### AC-4.4.3: Sequence Enforcement (Configurable)
**Given** production_settings.require_operation_sequence = TRUE
**When** operator tries to start operation N
**Then** system validates:
- Operation N-1 (previous) must be status='completed'
- If not completed: Error 400 "Cannot start: Operation 1 (Mixing) must be completed first"

**Given** production_settings.require_operation_sequence = FALSE
**When** operator tries to start any operation
**Then** no sequence validation (can start in any order)

**Configuration:**
```
production_settings.require_operation_sequence:
  Type: BOOLEAN
  Default: TRUE (per warehouse)
  Description: "Enforce sequential operation completion"
```

**Success Criteria:**
- ‚úÖ Sequence check on config setting
- ‚úÖ Specific error message if blocked
- ‚úÖ Allows bypass if disabled

---

### AC-4.4.4: Operation Start Transition (Atomic)
**Given** operator confirms start in modal
**When** confirming
**Then** system performs atomic update:
```
1. VALIDATE:
   - Operation exists and belongs to WO
   - Operation status = 'not_started' (not already started)
   - WO status = 'in_progress' or 'paused' (can start ops from these states)
   - org_id matches
   - If require_operation_sequence: previous op is 'completed'

2. UPDATE wo_operations:
   - status ‚Üí 'in_progress'
   - started_at ‚Üí current_timestamp
   - started_by_user_id ‚Üí current_user.id
   - updated_at ‚Üí current_timestamp

3. EMIT EVENT: "operation.started" (for dashboard/realtime updates)

4. RETURN: Updated operation object
```

**Success Criteria:**
- ‚úÖ Status transitions: not_started ‚Üí in_progress
- ‚úÖ started_at timestamp recorded (server time)
- ‚úÖ started_by_user_id recorded for audit
- ‚úÖ No partial updates (atomic)
- ‚úÖ Event emitted for dashboard

---

### AC-4.4.5: Error Handling & Messages

**When** operation start fails
**Then** return specific error message:

| Condition | Error Code | HTTP | Message |
|-----------|-----------|------|---------|
| Already in progress | ALREADY_IN_PROGRESS | 400 | "Operation is already in progress" |
| Not in 'not_started' status | INVALID_STATUS | 400 | "Operation must be in 'not started' status" |
| Previous op not completed | SEQUENCE_BLOCKED | 400 | "Cannot start: Operation 1 (Mixing) must be completed first" |
| WO not in progress | INVALID_WO_STATUS | 400 | "Cannot start operation: Work order is not in progress" |
| Operation not found | NOT_FOUND | 404 | "Operation not found" |
| Wrong org_id | ORG_ISOLATION | 403 | (no details for security) |
| Not authenticated | UNAUTHORIZED | 401 | (standard auth error) |
| Insufficient role | FORBIDDEN | 403 | "Insufficient permissions to start operations" |

**Success Criteria:**
- ‚úÖ All error codes specific and actionable
- ‚úÖ Error messages user-friendly
- ‚úÖ No partial updates on error

---

### AC-4.4.6: API Endpoint

**POST /api/production/work-orders/:id/operations/:opId/start**

```typescript
Request: {}  // No body needed

Response (200): {
  data: {
    id: uuid,
    wo_id: uuid,
    operation_sequence: number,      // 1, 2, 3, ...
    status: string,                   // "in_progress"
    started_at: timestamp,            // "2025-11-28T14:30:00Z"
    started_by_user_id: uuid,
    started_by_user: {
      id: uuid,
      name: string                    // "John Operator"
    },
    expected_duration_minutes: number
  },
  message: "Operation started successfully"
}

Error (400/403/404): {
  error: string,                      // Error code
  message: string                     // User-friendly message
}
```

**Success Criteria:**
- ‚úÖ POST endpoint at `/api/production/work-orders/:id/operations/:opId/start`
- ‚úÖ Returns 200 with updated operation
- ‚úÖ Returns 400/403/404 with error details
- ‚úÖ Auth & org isolation enforced

---

### AC-4.4.7: Role-Based Access
**Given** I have specific role
**When** attempting to start operation
**Then** I have appropriate permissions:

| Role | Can Start | Notes |
|------|-----------|-------|
| Production Manager | ‚úÖ Yes | Primary user |
| Operator | ‚úÖ Yes | Can start operations |
| Planner | ‚ùå No | Planning only |
| Quality Manager | ‚ùå No | Quality only |
| Admin | ‚úÖ Yes | Full access |

**Success Criteria:**
- ‚úÖ Role check on API endpoint
- ‚úÖ 403 error if unauthorized
- ‚úÖ "Start" button hidden in UI for non-authorized roles

---

### AC-4.4.8: WO Operations Table Schema

```sql
CREATE TABLE wo_operations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  wo_id UUID NOT NULL REFERENCES work_orders(id),

  -- Operation details (from routing recipe)
  operation_sequence INT NOT NULL,        -- 1, 2, 3, ...
  operation_name VARCHAR(255),            -- "Mixing", "Fermentation", etc.
  description TEXT,                       -- Operation description
  expected_duration_minutes INT,          -- Estimated time

  -- Status tracking
  status VARCHAR(20) NOT NULL DEFAULT 'not_started',  -- not_started, in_progress, completed
  started_at TIMESTAMPTZ,                 -- NULL until started
  started_by_user_id UUID REFERENCES users(id),
  completed_at TIMESTAMPTZ,               -- NULL until completed (Story 4.5)
  actual_duration_minutes INT,            -- Calculated on complete
  actual_yield_percent DECIMAL(5,2),      -- Yield % from BOM (Story 4.5)

  -- Audit
  notes TEXT,
  org_id UUID NOT NULL REFERENCES organizations(id),
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now(),

  -- Constraints
  UNIQUE(wo_id, operation_sequence),
  CHECK (status IN ('not_started', 'in_progress', 'completed'))
);
```

**Indexes:**
- (wo_id, operation_sequence)
- (wo_id, status)
- (org_id, status)

**RLS Policy:**
- Users can only see operations in their org

---

### AC-4.4.9: Dashboard Integration
**Given** operation is started
**When** viewing production dashboard (Story 4.1)
**Then** active operations list shows:
- Operation sequence number
- Operation name
- Status: "In Progress" (üîµ Blue)
- Started time
- Link to WO detail

**Success Criteria:**
- ‚úÖ Started operations visible on dashboard
- ‚úÖ Status clearly shown
- ‚úÖ Navigation to WO detail available

---

### AC-4.4.10: Modal Validation States
**Given** operation start modal is open
**When** user confirms
**Then** proper states shown:

| State | Trigger | UI | Button |
|-------|---------|----|----|
| Loading | API call in progress | Spinner, disabled | "Starting..." |
| Success | Op started | Green checkmark, auto-close | N/A |
| Error | API error | Red message | "Try Again" |

**Success Criteria:**
- ‚úÖ Loading spinner during API call
- ‚úÖ Button text changes during states
- ‚úÖ Success toast: "Operation started successfully"
- ‚úÖ Error toast with retry option
- ‚úÖ Modal auto-closes on success

---

## Technical Tasks

### Backend

- [ ] Task 1: Verify wo_operations table schema
  - [ ] Subtask 1.1: Verify all columns exist (see AC 4.4.8)
  - [ ] Subtask 1.2: Verify CHECK constraint on status
  - [ ] Subtask 1.3: Verify UNIQUE constraint on (wo_id, operation_sequence)
  - [ ] Subtask 1.4: Verify RLS policy

- [ ] Task 2: Update production_settings table
  - [ ] Subtask 2.1: Add require_operation_sequence BOOLEAN (default TRUE, per warehouse)

- [ ] Task 3: Create OperationStartService
  - [ ] Subtask 3.1: Implement startOperation(woId, opId, userId, orgId)
  - [ ] Subtask 3.2: Validate operation status = 'not_started'
  - [ ] Subtask 3.3: Validate WO status = 'in_progress' or 'paused'
  - [ ] Subtask 3.4: Implement sequence enforcement check
  - [ ] Subtask 3.5: Add atomic transaction wrapper
  - [ ] Subtask 3.6: Error handling (all error codes from AC 4.4.5)
  - [ ] Subtask 3.7: Emit "operation.started" event

- [ ] Task 4: Create API endpoint
  - [ ] Subtask 4.1: POST /api/production/work-orders/:id/operations/:opId/start
  - [ ] Subtask 4.2: Add auth & role checks
  - [ ] Subtask 4.3: Add error handling with specific codes
  - [ ] Subtask 4.4: Verify response format

### Database

- [ ] Verify wo_operations schema (from Story 3.10)
- [ ] Update production_settings: add require_operation_sequence

### Frontend

- [ ] Task 5: Create OperationStartModal component
  - [ ] Subtask 5.1: Display operation details (seq, name, duration, next op)
  - [ ] Subtask 5.2: "Cancel" and "Confirm Start" buttons
  - [ ] Subtask 5.3: Loading/success/error states
  - [ ] Subtask 5.4: Auto-close on success

- [ ] Task 6: Integrate with WO detail page
  - [ ] Subtask 6.1: Display operations list/timeline
  - [ ] Subtask 6.2: "Start" button per operation (visible if not_started + WO in_progress)
  - [ ] Subtask 6.3: Show operation progress (started_at, status)
  - [ ] Subtask 6.4: Disable "Start" if sequence blocked (show reason)

- [ ] Task 7: Update dashboard (Story 4.1)
  - [ ] Subtask 7.1: Add active operations section
  - [ ] Subtask 7.2: Show started operations
  - [ ] Subtask 7.3: Link to WO detail

### Testing

- [ ] Task 8: Unit tests - OperationStartService
  - [ ] Subtask 8.1: Test startOperation with valid op
  - [ ] Subtask 8.2: Test status transition: not_started ‚Üí in_progress
  - [ ] Subtask 8.3: Test started_at timestamp recorded
  - [ ] Subtask 8.4: Test error: already in progress
  - [ ] Subtask 8.5: Test error: sequence blocked
  - [ ] Subtask 8.6: Test org_id isolation
  - [ ] Subtask 8.7: Test with require_operation_sequence on/off
  - [ ] Subtask 8.8: Target 95% coverage

- [ ] Task 9: Integration tests - API endpoint
  - [ ] Subtask 9.1: Test POST /api/production/work-orders/:id/operations/:opId/start (200)
  - [ ] Subtask 9.2: Test 400 if already in progress
  - [ ] Subtask 9.3: Test 400 if previous op not completed (with sequence=true)
  - [ ] Subtask 9.4: Test 400 if WO not in progress
  - [ ] Subtask 9.5: Test 403 if wrong org
  - [ ] Subtask 9.6: Test 401 if not authenticated
  - [ ] Subtask 9.7: Test 403 if insufficient role
  - [ ] Subtask 9.8: Target 70% coverage

- [ ] Task 10: E2E tests - Operation start workflow
  - [ ] Subtask 10.1: Create test WO with 3 operations
  - [ ] Subtask 10.2: Navigate to WO detail
  - [ ] Subtask 10.3: View operations list
  - [ ] Subtask 10.4: Click "Start" on Operation 1
  - [ ] Subtask 10.5: Verify modal opens
  - [ ] Subtask 10.6: Click "Confirm Start"
  - [ ] Subtask 10.7: Verify operation status = in_progress
  - [ ] Subtask 10.8: Verify started_at timestamp recorded
  - [ ] Subtask 10.9: Try to start Operation 2 (should fail if sequence=true)
  - [ ] Subtask 10.10: Verify error message shows "Op 1 must be completed"
  - [ ] Subtask 10.11: Complete Operation 1 (Story 4.5 test)
  - [ ] Subtask 10.12: Start Operation 2 (should succeed)
  - [ ] Subtask 10.13: Verify dashboard shows active operations
  - [ ] Subtask 10.14: Target 100% critical path coverage

---

## Dev Notes

### Architecture Patterns
- **Status-based workflow**: Operation status transitions
- **Sequence enforcement**: Configurable per warehouse
- **Audit trail**: started_by_user_id + timestamps
- **Event-driven**: Emit "operation.started" for realtime updates

### Learnings from Previous Stories
- WO status enum from Story 3.10
- Modal patterns from Story 4.2 (WO Start)
- Dashboard integration from Story 4.1
- Production settings pattern
- Operations created in Story 3.10 with status='not_started'

### Constraints & Decisions
- **Operations created during WO creation** (Story 3.10)
- **Sequence enforcement configurable** per warehouse (default TRUE)
- **Can start from in_progress or paused** WO states
- **No cancel/skip operations** in Phase 1 (Phase 2 feature)

### Testing Strategy
- **Unit Tests** (95%): status transitions, sequence enforcement, error scenarios
- **Integration Tests** (70%): API endpoints, org isolation, role checks, sequence logic
- **E2E Tests** (100% critical): operation start workflow, sequence blocking, dashboard

---

## Status

- **Created:** 2025-11-27
- **Updated:** 2025-11-28 (expanded with 10 detailed ACs, schema, sequence logic)
- **Current Status:** Todo
- **Target Status:** Done (after all ACs met + tests pass)
