# Story 4.3: WO Pause/Resume

**Epic:** 4 - Production Execution
**Status:** Todo
**Priority:** P0 (MVP)
**Story Points:** 2
**Created:** 2025-11-27
**Updated:** 2025-11-28 (detailed ACs, pause reason configuration, downtime tracking)
**Effort Estimate:** 1 day

---

## Goal

Enable operators to pause/resume work orders during issues with configurable pause reasons and detailed downtime tracking.

## User Story

**As an** Operator
**I want** to pause a WO when there's an issue (and resume later)
**So that** we can track downtime and report on production delays

---

## Problem Statement

Operators need ability to temporarily halt production:
1. Pause with optional documented reason (configurable: breakdown, break, material wait, etc.)
2. Track pause duration and reasons
3. Resume seamlessly to continue production
4. Report on downtime causes and durations
5. Prevent double-pausing (warning if LP already paused)

---

## Acceptance Criteria

### AC-4.3.1: Pause Modal
**Given** WO is in 'in_progress' status and pause enabled in production_settings.allow_pause_wo
**When** clicking "Pause" button on WO detail or dashboard
**Then** modal opens with:
- WO number (read-only)
- **Pause reason dropdown** (configurable options from production_settings.pause_reasons)
  - Default options: Breakdown, Break, Material Wait, Other
  - Examples: "Breakdown" = equipment failure, "Break" = operator break, "Material Wait" = waiting for material
  - Reason is **OPTIONAL** (operator can skip)
- Notes field (optional, text area)
- "Cancel" and "Confirm Pause" buttons

**Success Criteria:**
- âœ… Modal shows WO details clearly
- âœ… Pause reason dropdown populated from settings
- âœ… Operator can submit with or without reason
- âœ… Modal styled consistently with other modals

---

### AC-4.3.2: Pause Status Transition (Atomic)
**Given** operator confirms pause in modal
**When** confirming
**Then** system performs atomic update:
```
1. VALIDATE:
   - WO status = 'in_progress' (not already paused)
   - WO not already in paused status
   - org_id matches

2. UPDATE work_orders:
   - status â†’ 'paused'
   - paused_at â†’ current_timestamp
   - paused_by_user_id â†’ current_user.id

3. INSERT wo_pauses record:
   - wo_id, pause_reason, notes, paused_at, paused_by_user_id, org_id
   - resumed_at = NULL (until resume)

4. RETURN: Updated WO with paused status
```

**Success Criteria:**
- âœ… Status transitions: in_progress â†’ paused
- âœ… paused_at timestamp recorded (server time)
- âœ… paused_by_user_id recorded for audit
- âœ… wo_pauses table records pause event
- âœ… No partial updates (atomic)

---

### AC-4.3.3: Resume Operation (Atomic)
**Given** WO is in 'paused' status
**When** clicking "Resume" button and confirming
**Then** system performs atomic update:
```
1. VALIDATE:
   - WO status = 'paused' (must be paused to resume)
   - org_id matches

2. UPDATE work_orders:
   - status â†’ 'in_progress'
   - resumed_at â†’ current_timestamp (on WO? or in wo_pauses?)

3. UPDATE wo_pauses (last record):
   - resumed_at â†’ current_timestamp
   - duration_minutes â†’ (resumed_at - paused_at) / 60

4. RETURN: Updated WO with in_progress status
```

**Success Criteria:**
- âœ… Status transitions: paused â†’ in_progress
- âœ… resumed_at timestamp recorded
- âœ… Pause duration calculated in wo_pauses
- âœ… No partial updates (atomic)

---

### AC-4.3.4: Pause Duration Tracking & Display
**Given** WO has multiple pause/resume cycles
**When** viewing WO detail page
**Then** display pause history section:
- Table showing: Pause Reason, Notes, Paused At, Duration (minutes), Resumed At
- Total downtime: "Total pause time: 2h 45m (Breakdown: 1h 30m, Break: 1h 15m)"
- Breakdown by reason with duration sum

**Example:**
```
Pause History:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Reason      â”‚ Notes    â”‚ Paused At        â”‚ Duration â”‚ Resumed At  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Breakdown   â”‚ Motor    â”‚ 10:00 2025-11-28 â”‚ 90 min   â”‚ 11:30       â”‚
â”‚ Break       â”‚ Lunch    â”‚ 12:00 2025-11-28 â”‚ 60 min   â”‚ 13:00       â”‚
â”‚ Material W. â”‚          â”‚ 14:00 2025-11-28 â”‚ 15 min   â”‚ 14:15       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

TOTAL DOWNTIME: 2h 45m
â”œâ”€ Breakdown: 1h 30m
â”œâ”€ Break: 1h 0m
â””â”€ Material Wait: 15m
```

**Success Criteria:**
- âœ… Pause history table displays all pauses
- âœ… Duration calculated in minutes
- âœ… Total downtime calculated and displayed
- âœ… Breakdown by reason summarized

---

### AC-4.3.5: Pause Reason Configuration
**Given** admin is in Settings â†’ Production Settings
**When** configuring pause reasons
**Then** admin can:
- View/edit available pause reason options (e.g., "Breakdown", "Break", "Material Wait", "Other")
- Add custom pause reasons
- Mark reasons as enabled/disabled
- Set reasons **per-warehouse** (allow_pause_wo is per-warehouse setting)

**Configuration (in production_settings):**
```
allow_pause_wo: BOOLEAN (default TRUE, per warehouse)
pause_reasons: JSON array [
  { id: 1, label: "Breakdown", enabled: true },
  { id: 2, label: "Break", enabled: true },
  { id: 3, label: "Material Wait", enabled: true },
  { id: 4, label: "Other", enabled: true }
]
```

**Success Criteria:**
- âœ… Pause reasons configurable per warehouse
- âœ… Dropdown populated from settings
- âœ… Disabled reasons not shown in dropdown

---

### AC-4.3.6: API Endpoints

**POST /api/production/work-orders/:id/pause**
```typescript
Request: {
  pause_reason?: string,     // optional (from enum)
  notes?: string             // optional
}

Response (200): {
  data: {
    id: uuid,
    wo_number: string,        // "WO-20251127-0001"
    status: string,           // "paused"
    paused_at: timestamp,
    paused_by_user_id: uuid,
    paused_by_user: {
      id: uuid,
      name: string
    }
  },
  message: "Work order paused successfully"
}

Error (400): {
  error: string,              // "INVALID_STATUS" | "ALREADY_PAUSED"
  message: string             // User-friendly message
}
```

**POST /api/production/work-orders/:id/resume**
```typescript
Request: {}  // No body needed

Response (200): {
  data: {
    id: uuid,
    wo_number: string,
    status: string,           // "in_progress"
    pause_history: [          // Last pause cycle
      {
        pause_reason: string,
        notes: string,
        paused_at: timestamp,
        resumed_at: timestamp,
        duration_minutes: number
      }
    ]
  },
  message: "Work order resumed successfully"
}

Error (400): {
  error: string,              // "INVALID_STATUS" | "NOT_PAUSED"
  message: string
}
```

**Success Criteria:**
- âœ… POST /api/production/work-orders/:id/pause available
- âœ… POST /api/production/work-orders/:id/resume available
- âœ… Both enforce org_id isolation
- âœ… Both enforce authentication (401 if not logged in)
- âœ… Error responses include specific error codes

---

### AC-4.3.7: Role-Based Access
**Given** I have specific role
**When** attempting to pause/resume WO
**Then** I have appropriate permissions:

| Role | Can Pause | Can Resume | Notes |
|------|-----------|-----------|-------|
| Production Manager | âœ… Yes | âœ… Yes | Primary user |
| Operator | âœ… Yes | âœ… Yes | Can pause own WOs |
| Planner | âŒ No | âŒ No | Planning only |
| Quality Manager | âŒ No | âŒ No | Quality only |
| Admin | âœ… Yes | âœ… Yes | Full access |

**Success Criteria:**
- âœ… Role check on both API endpoints
- âœ… 403 error if unauthorized
- âœ… Pause/Resume buttons hidden in UI for non-authorized roles

---

### AC-4.3.8: Configuration Toggle (Per Warehouse)
**Given** admin sets allow_pause_wo = false in production_settings
**When** viewing WO detail or dashboard
**Then** "Pause" button is hidden (no option to pause)

**Success Criteria:**
- âœ… Button visibility controlled by production_settings.allow_pause_wo
- âœ… Default: allow_pause_wo = TRUE

---

### AC-4.3.9: Modal Validation States
**Given** pause modal is open
**When** user interacts
**Then** proper states shown:

| State | Trigger | UI | Button |
|-------|---------|----|----|
| Loading | API call in progress | Spinner, disabled buttons | "Pausing..." |
| Success | WO paused | Green checkmark, auto-close | N/A |
| Error | API error | Red error message | "Try Again" |

**Success Criteria:**
- âœ… Loading spinner during API call
- âœ… Button text changes during states
- âœ… Success toast: "Work order paused successfully"
- âœ… Error toast with retry option
- âœ… Modal auto-closes on success (1 second delay)

---

### AC-4.3.10: Dashboard Integration
**Given** WO is paused
**When** viewing production dashboard (Story 4.1)
**Then** WO appears in Active list with:
- Status badge: "Paused" (ğŸŸ  Orange)
- "Resume" button visible (instead of "Pause")
- Pause reason shown if provided (e.g., "Paused: Breakdown")
- Duration since pause started (e.g., "Paused for 15 minutes")

**Success Criteria:**
- âœ… Paused WOs visible in dashboard active list
- âœ… Resume button available
- âœ… Pause reason/duration displayed

---

## Technical Tasks

### Backend

- [ ] Task 1: Create wo_pauses table
  - [ ] Subtask 1.1: Schema design
    ```sql
    CREATE TABLE wo_pauses (
      id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
      wo_id UUID NOT NULL REFERENCES work_orders(id),
      pause_reason VARCHAR(100),           -- optional
      notes TEXT,
      paused_at TIMESTAMPTZ NOT NULL DEFAULT now(),
      paused_by_user_id UUID NOT NULL REFERENCES users(id),
      resumed_at TIMESTAMPTZ,              -- NULL until resumed
      org_id UUID NOT NULL REFERENCES organizations(id),
      created_at TIMESTAMPTZ DEFAULT now()
    );
    ```
  - [ ] Subtask 1.2: Add indexes (wo_id, org_id, paused_at)
  - [ ] Subtask 1.3: Add RLS policy

- [ ] Task 2: Update production_settings table
  - [ ] Subtask 2.1: Add allow_pause_wo BOOLEAN (per warehouse)
  - [ ] Subtask 2.2: Add pause_reasons JSON array config

- [ ] Task 3: Create PauseResumeService
  - [ ] Subtask 3.1: Implement pauseWorkOrder(woId, reason, notes, userId, orgId)
  - [ ] Subtask 3.2: Implement resumeWorkOrder(woId, userId, orgId)
  - [ ] Subtask 3.3: Calculate pause duration
  - [ ] Subtask 3.4: Add atomic transaction wrapper
  - [ ] Subtask 3.5: Error handling (INVALID_STATUS, ALREADY_PAUSED, NOT_PAUSED)

- [ ] Task 4: Create API endpoints
  - [ ] Subtask 4.1: POST /api/production/work-orders/:id/pause
  - [ ] Subtask 4.2: POST /api/production/work-orders/:id/resume
  - [ ] Subtask 4.3: Add auth & role checks
  - [ ] Subtask 4.4: Add error handling with specific codes

- [ ] Task 5: Implement pause history query
  - [ ] Subtask 5.1: GET pause history for WO
  - [ ] Subtask 5.2: Calculate total downtime
  - [ ] Subtask 5.3: Group by pause reason

### Database

- [ ] Verify work_orders table has: paused_at, paused_by_user_id fields
- [ ] Create wo_pauses table (Schema in Task 1)
- [ ] Update production_settings with: allow_pause_wo, pause_reasons
- [ ] Add CHECK constraints on work_orders for valid status transitions

### Frontend

- [ ] Task 6: Create PauseModal component
  - [ ] Subtask 6.1: Display WO number, pause reason dropdown
  - [ ] Subtask 6.2: Notes field (textarea)
  - [ ] Subtask 6.3: Cancel/Confirm buttons
  - [ ] Subtask 6.4: Loading/error/success states
  - [ ] Subtask 6.5: Auto-close on success

- [ ] Task 7: Create ResumeModal component
  - [ ] Subtask 7.1: Show current pause info
  - [ ] Subtask 7.2: Confirm/Cancel buttons
  - [ ] Subtask 7.3: Display last pause duration

- [ ] Task 8: Integrate pause/resume with WO detail page
  - [ ] Subtask 8.1: Add "Pause" button (visible if in_progress + pause enabled)
  - [ ] Subtask 8.2: Add "Resume" button (visible if paused)
  - [ ] Subtask 8.3: Display pause history table on WO detail
  - [ ] Subtask 8.4: Show total downtime summary
  - [ ] Subtask 8.5: Show downtime breakdown by reason

- [ ] Task 9: Update dashboard (Story 4.1)
  - [ ] Subtask 9.1: Show paused WOs in active list
  - [ ] Subtask 9.2: Display "Paused" status badge (orange)
  - [ ] Subtask 9.3: Show pause reason if provided
  - [ ] Subtask 9.4: Show "Resume" button
  - [ ] Subtask 9.5: Show pause duration ("Paused for X minutes")

### Testing

- [ ] Task 10: Unit tests - PauseResumeService
  - [ ] Subtask 10.1: Test pauseWorkOrder with valid WO
  - [ ] Subtask 10.2: Test status transition: in_progress â†’ paused
  - [ ] Subtask 10.3: Test resumeWorkOrder with valid WO
  - [ ] Subtask 10.4: Test status transition: paused â†’ in_progress
  - [ ] Subtask 10.5: Test duration calculation
  - [ ] Subtask 10.6: Test error: WO already paused
  - [ ] Subtask 10.7: Test error: WO not paused
  - [ ] Subtask 10.8: Test org_id isolation
  - [ ] Subtask 10.9: Target 95% coverage

- [ ] Task 11: Integration tests - API endpoints
  - [ ] Subtask 11.1: Test POST /api/production/work-orders/:id/pause (200)
  - [ ] Subtask 11.2: Test POST /api/production/work-orders/:id/resume (200)
  - [ ] Subtask 11.3: Test 400 if already paused
  - [ ] Subtask 11.4: Test 400 if not paused (on resume)
  - [ ] Subtask 11.5: Test 403 if wrong org_id
  - [ ] Subtask 11.6: Test 401 if not authenticated
  - [ ] Subtask 11.7: Test 403 if insufficient role
  - [ ] Subtask 11.8: Target 70% coverage

- [ ] Task 12: E2E tests - Full user workflow
  - [ ] Subtask 12.1: Create test WO in in_progress status
  - [ ] Subtask 12.2: Navigate to WO detail
  - [ ] Subtask 12.3: Click "Pause" button
  - [ ] Subtask 12.4: Verify pause modal opens
  - [ ] Subtask 12.5: Select pause reason + add notes
  - [ ] Subtask 12.6: Click "Confirm Pause"
  - [ ] Subtask 12.7: Verify loading spinner
  - [ ] Subtask 12.8: Verify success toast
  - [ ] Subtask 12.9: Verify status changes to "Paused"
  - [ ] Subtask 12.10: Verify pause reason displayed
  - [ ] Subtask 12.11: Click "Resume" button
  - [ ] Subtask 12.12: Verify resume modal opens
  - [ ] Subtask 12.13: Click "Confirm Resume"
  - [ ] Subtask 12.14: Verify status returns to "In Progress"
  - [ ] Subtask 12.15: Verify pause history displays on detail page
  - [ ] Subtask 12.16: Verify duration calculated correctly
  - [ ] Subtask 12.17: Verify dashboard shows resumed WO in active list
  - [ ] Subtask 12.18: Target 100% critical path coverage

---

## Dev Notes

### Architecture Patterns
- **Status-based workflow**: WO status transitions include paused state
- **Audit trail**: paused_by_user_id + wo_pauses table tracks all pauses
- **Downtime tracking**: wo_pauses table stores pause history for reporting
- **Similar to Story 4.2** (WO Start) - action endpoints with status transitions

### Learnings from Previous Stories
- WO status enum from Story 3.10: draft, released, in_progress, paused, completed, cancelled
- Modal patterns from Story 4.2 (WO Start)
- Dashboard integration from Story 4.1 (Production Dashboard)
- Production settings pattern from existing settings tables

### Constraints & Decisions
- **Pause only** if WO in_progress (not from other states)
- **Resume only** if WO paused
- **Pause reason optional** (operator can skip)
- **Pause reasons configurable** per warehouse
- **Multiple pauses allowed** in single WO (supports multiple pause/resume cycles)
- **Downtime calculated** on resume (not predicted)

### Testing Strategy
- **Unit Tests** (95%): pause/resume logic, duration calculation, error scenarios
- **Integration Tests** (70%): API endpoints, org isolation, role checks
- **E2E Tests** (100% critical): full pause/resume workflow, dashboard integration

---

## Status

- **Created:** 2025-11-27
- **Updated:** 2025-11-28 (expanded with 10 detailed ACs)
- **Current Status:** Todo
- **Target Status:** Done (after all ACs met + tests pass)

## Dev Notes

### Architecture Patterns
- **Status-based workflow**: Use WO status transitions (in_progress â†’ paused â†’ in_progress)
- **Downtime tracking**: wo_pauses table stores pause history for audit and reporting
- **Pattern reuse**: Similar to Story 4.2 (WO Start) - simple status transition with audit

### Key Decisions
- **Status field**: WO status becomes 'paused' (not separate field)
- **Multiple pauses**: Support multiple pause/resume cycles in one WO
- **Downtime calc**: resume_at - paused_at per wo_pauses record

### Constraints
- Pause only available if WO in_progress
- Resume requires WO in paused status
- Configuration toggle (Story 4.17) controls visibility
- Toggle default: allow_pause_wo = true

### Testing Strategy
- Unit: Pause/resume service logic, duration calculations
- Integration: API endpoints, status transitions, org isolation
- E2E: Full workflow - start â†’ pause â†’ resume â†’ complete

---

## Status

- **Created:** 2025-11-27
- **Current Status:** drafted
