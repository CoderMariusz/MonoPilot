<?xml version="1.0" encoding="UTF-8"?>
<story>
  <metadata>
    <id>5.23</id>
    <title>Scanner Guided Workflows</title>
    <batch>5C-1</batch>
    <points>5</points>
    <effort_hours>5-6</effort_hours>
    <status>todo</status>
  </metadata>
  <description>Step-by-step guided workflows on mobile device with state machines for warehouse operations (receive, put_away, pick, consume, output, move, count)</description>
  <dependencies>
    <requires><story id="5.1">License Plate Creation</story><story id="5.24">Scanner Barcode Validation</story></requires>
    <enables><story id="5.24">Scanner Barcode Validation</story><story id="5.25">Scanner Feedback</story><story id="5.26">Scanner Operations Menu</story><story id="5.27">Scanner Session Timeout</story></enables>
  </dependencies>
  <technical_context>
    <api_endpoints>
      <endpoint method="POST" path="/api/scanner/sessions">
        <description>Create new scanner session with workflow initialization</description>
        <auth>authenticated</auth>
        <request>
          <field name="workflow_type" type="string" required="true">receive, put_away, pick, consume, output, move, or count</field>
          <field name="device_id" type="string" required="true">Unique device identifier</field>
          <field name="idle_duration_seconds" type="integer" required="false">Default 300 (5 minutes)</field>
        </request>
        <response status="201">
          <field name="session_id" type="UUID"/>
          <field name="session_key" type="string" comment="For client caching"/>
          <field name="device_id" type="string"/>
          <field name="workflow_type" type="string"/>
          <field name="current_step" type="integer" default="1"/>
          <field name="expires_at" type="timestamp"/>
          <field name="workflow_config" type="object">
            <field name="steps" type="array"/>
            <field name="enable_haptic" type="boolean"/>
            <field name="enable_audio" type="boolean"/>
            <field name="auto_proceed_delay_ms" type="integer"/>
          </field>
        </response>
      </endpoint>
      <endpoint method="PATCH" path="/api/scanner/sessions/:id/step">
        <description>Advance workflow to next step</description>
        <auth>authenticated</auth>
        <request>
          <field name="step_number" type="integer" required="true">Next step number</field>
          <field name="step_data" type="object" required="false">Context-specific step data</field>
        </request>
        <response status="200">
          <field name="current_step" type="integer"/>
          <field name="step_action" type="string" comment="scan, confirm, select, input, navigate"/>
          <field name="validation_required" type="boolean"/>
        </response>
      </endpoint>
      <endpoint method="DELETE" path="/api/scanner/sessions/:id">
        <description>Manually close session</description>
        <auth>authenticated</auth>
        <response status="200">
          <field name="session_id" type="UUID"/>
          <field name="closed_at" type="timestamp"/>
          <field name="steps_completed" type="integer"/>
        </response>
      </endpoint>
    </api_endpoints>
    <database_tables>
      <table>
        <name>scanner_sessions</name>
        <columns>
          <column name="id" type="UUID" constraint="PK, DEFAULT gen_random_uuid()"/>
          <column name="org_id" type="UUID" constraint="NOT NULL, FK organizations(id)"/>
          <column name="user_id" type="UUID" constraint="NOT NULL, FK users(id)"/>
          <column name="device_id" type="VARCHAR(255)" constraint="NOT NULL"/>
          <column name="session_key" type="VARCHAR(255)" constraint="NOT NULL UNIQUE"/>
          <column name="workflow_type" type="VARCHAR(50)" constraint="NOT NULL, CHECK IN (receive, put_away, pick, consume, output, move, count)"/>
          <column name="current_step" type="INTEGER" constraint="DEFAULT 1"/>
          <column name="status" type="VARCHAR(20)" constraint="DEFAULT 'active', CHECK IN (active, paused, completed, timeout)"/>
          <column name="last_activity_at" type="TIMESTAMP" constraint="DEFAULT NOW()"/>
          <column name="idle_duration_seconds" type="INTEGER" constraint="DEFAULT 300"/>
          <column name="warning_threshold_seconds" type="INTEGER" constraint="DEFAULT 30"/>
          <column name="created_at" type="TIMESTAMP" constraint="DEFAULT NOW()"/>
          <column name="expires_at" type="TIMESTAMP"/>
        </columns>
      </table>
      <table>
        <name>scanner_workflow_configs</name>
        <columns>
          <column name="id" type="UUID" constraint="PK, DEFAULT gen_random_uuid()"/>
          <column name="org_id" type="UUID" constraint="NOT NULL, FK organizations(id)"/>
          <column name="workflow_type" type="VARCHAR(50)" constraint="NOT NULL"/>
          <column name="steps" type="JSONB" constraint="NOT NULL" comment="Array of {step_number, action, validation, feedback_type}"/>
          <column name="require_confirmation" type="BOOLEAN" constraint="DEFAULT true"/>
          <column name="auto_proceed_delay_ms" type="INTEGER" constraint="DEFAULT 1500"/>
          <column name="enable_haptic" type="BOOLEAN" constraint="DEFAULT true"/>
          <column name="enable_audio" type="BOOLEAN" constraint="DEFAULT true"/>
          <column name="vibration_pattern" type="VARCHAR(50)" constraint="DEFAULT 'success'"/>
          <column name="audio_file_path" type="VARCHAR(255)"/>
          <column name="created_at" type="TIMESTAMP" constraint="DEFAULT NOW()"/>
          <column name="updated_at" type="TIMESTAMP" constraint="DEFAULT NOW()"/>
          <column name="constraint" name="unique_workflow_config" constraint="UNIQUE(org_id, workflow_type)"/>
        </columns>
      </table>
    </database_tables>
    <queries>
      <query name="get_workflow_config">
        SELECT * FROM scanner_workflow_configs WHERE org_id = $1 AND workflow_type = $2
      </query>
      <query name="create_session">
        INSERT INTO scanner_sessions (org_id, user_id, device_id, session_key, workflow_type, idle_duration_seconds, expires_at)
        VALUES ($1, $2, $3, $4, $5, $6, NOW() + ($6 || ' seconds')::INTERVAL)
        RETURNING *
      </query>
      <query name="update_step">
        UPDATE scanner_sessions SET current_step = $2, last_activity_at = NOW()
        WHERE id = $1 AND org_id = $3
        RETURNING *
      </query>
    </queries>
    <indexes>
      <index name="idx_scanner_sessions_org_id">On column: org_id (org filtering)</index>
      <index name="idx_scanner_sessions_user_id">On column: user_id (user sessions)</index>
      <index name="idx_scanner_sessions_session_key">On column: session_key (fast lookup)</index>
      <index name="idx_scanner_sessions_status">On column: status (active/completed filtering)</index>
      <index name="idx_scanner_workflow_configs_org_id">On column: org_id (org filtering)</index>
    </indexes>
    <components>
      <component name="WorkflowGuidePanel">
        <location>src/components/scanner/WorkflowGuidePanel.tsx</location>
        <description>Main instruction panel with current step and action</description>
        <displays>
          - Step instruction (large, centered): "Scan Purchase Order Barcode"
          - Progress bar: "Step 1 of 5"
          - Input field (hidden, focus on mount)
          - Step-specific validation feedback
        </displays>
      </component>
      <component name="BarcodeInputField">
        <location>src/components/scanner/BarcodeInputField.tsx</location>
        <description>Hidden input capturing hardware barcode scan events</description>
        <features>
          - Auto-focus on mount (keyboard visible on mobile)
          - Validate on every keystroke against pattern
          - Emit validation result to parent
          - Clear on Enter key (scan completion)
          - No autocomplete
        </features>
      </component>
      <component name="StepProgressBar">
        <location>src/components/scanner/StepProgressBar.tsx</location>
        <description>Visual progress through workflow steps</description>
        <displays>
          - Progress indicator: completed (green), current (blue), remaining (gray)
          - Text: "Step 2 of 5 - Confirm Location"
          - Prevent backwards navigation
        </displays>
      </component>
      <component name="WorkflowSelectionModal">
        <location>src/components/scanner/WorkflowSelectionModal.tsx</location>
        <description>Modal for choosing workflow type</description>
        <displays>
          - 7 workflow buttons: Receive, Put Away, Pick, Consume, Output, Move, Count
          - Icons per workflow
          - Large 60px buttons for touch
          - On selection: create session and navigate to guide
        </displays>
      </component>
      <component name="WorkflowCompletionScreen">
        <location>src/components/scanner/WorkflowCompletionScreen.tsx</location>
        <description>Screen shown when all workflow steps completed</description>
        <displays>
          - Checkmark icon (animated)
          - Message: "Receive Completed!"
          - Summary: "5 items processed"
          - Timestamp: workflow completion time
          - Operator name: who ran workflow
          - Buttons: "Start New Workflow", "Back to Menu"
        </displays>
      </component>
    </components>
    <hooks>
      <hook name="useWorkflowState">
        <accepts>workflow_type, session_id</accepts>
        <returns>{ current_step, steps_completed, advance_step, is_complete, error }</returns>
        <description>Manages state machine progression, prevents backwards navigation</description>
      </hook>
      <hook name="useSessionInit">
        <accepts>workflow_type, device_id</accepts>
        <returns>{ session_id, session_key, workflow_config, loading, error }</returns>
        <api_call>POST /api/scanner/sessions</api_call>
      </hook>
    </hooks>
    <state_machine>
      <definition name="receive_workflow">
        <step number="1">
          <action>scan</action>
          <validation>
            <type>barcode</type>
            <expected_pattern>PO\d{6}</expected_pattern>
          </validation>
          <feedback_type>success</feedback_type>
          <next_step>2</next_step>
        </step>
        <step number="2">
          <action>select</action>
          <validation>
            <type>location</type>
            <location_type>storage</location_type>
          </validation>
          <feedback_type>success</feedback_type>
          <next_step>3</next_step>
        </step>
        <step number="3">
          <action>scan</action>
          <validation>
            <type>barcode</type>
            <expected_pattern>LP\d{6}</expected_pattern>
          </validation>
          <feedback_type>success</feedback_type>
          <next_step>4</next_step>
        </step>
        <step number="4">
          <action>input</action>
          <validation>
            <type>quantity</type>
            <required>true</required>
          </validation>
          <feedback_type>success</feedback_type>
          <next_step>5</next_step>
        </step>
        <step number="5">
          <action>navigate</action>
          <validation>
            <type>none</type>
          </validation>
          <feedback_type>completion</feedback_type>
        </step>
      </definition>
    </state_machine>
    <validation_rules>
      <rule id="workflow_exists">Workflow type must be valid (receive, put_away, pick, consume, output, move, count)</rule>
      <rule id="step_sequence">Current step + 1 must be next valid step (no skip)</rule>
      <rule id="step_validation">Step validation must pass before advancement</rule>
      <rule id="no_backwards">Cannot go backwards in workflow (unidirectional)</rule>
      <rule id="session_active">Session status must be 'active' for progression</rule>
      <rule id="device_id_required">Device ID must be provided for session tracking</rule>
    </validation_rules>
    <rls_policies>
      <policy table="scanner_sessions">
        <select>WHERE org_id = current_user.org_id</select>
        <insert>WHERE org_id = current_user.org_id</insert>
        <update>WHERE org_id = current_user.org_id</update>
      </policy>
      <policy table="scanner_workflow_configs">
        <select>WHERE org_id = current_user.org_id</select>
      </policy>
    </rls_policies>
  </technical_context>
  <acceptance_criteria>
    <ac id="1" title="Workflow Selection Modal">
      <test>Open scanner app → show modal with 7 workflow options (Receive, Put Away, Pick, Consume, Output, Move, Count)</test>
    </ac>
    <ac id="2" title="Workflow State Machine">
      <test>Select workflow type → create scanner_session → display first step instruction</test>
      <test>Progress bar shows: "Step 1 of 5"</test>
    </ac>
    <ac id="3" title="Step Progression">
      <test>Complete step validation → success feedback → auto-advance after 1.5s</test>
      <test>Progress bar updates: "Step 2 of 5"</test>
    </ac>
    <ac id="4" title="Validation-First Flow">
      <test>Step requires barcode scan → focus input field (keyboard visible)</test>
      <test>Show hint: "Scan LP Barcode"</test>
      <test>Validate on keystroke, block progress until valid</test>
    </ac>
    <ac id="5" title="Touchscreen Optimization">
      <test>All touch targets >= 44px × 44px (WCAG 2.1 AAA)</test>
      <test>No hover states (touch only)</test>
      <test>Landscape orientation support</test>
      <test>Large readable font (18px+ for instructions)</test>
    </ac>
    <ac id="6" title="Error Recovery">
      <test>Invalid barcode scan → error message shown</test>
      <test>Stay on same step (don't advance)</test>
      <test>Clear input for retry</test>
    </ac>
    <ac id="7" title="Workflow Completion">
      <test>All steps completed → completion screen shown</test>
      <test>Summary: "5 items processed"</test>
      <test>Session closed with status='completed'</test>
    </ac>
  </acceptance_criteria>
  <test_plan>
    <unit_tests>
      <test>State machine transitions: valid paths only</test>
      <test>Step validation: barcode pattern matching</test>
      <test>Progress tracking: step numbers increment correctly</test>
      <test>Completion detection: all steps checked</test>
      <test>No backwards navigation: cannot go to previous step</test>
    </unit_tests>
    <integration_tests>
      <test>POST /api/scanner/sessions creates session with correct workflow_type</test>
      <test>PATCH /api/scanner/sessions/:id/step increments step correctly</test>
      <test>Step progression blocked if validation fails</test>
      <test>DELETE /api/scanner/sessions/:id closes session</test>
      <test>Multiple sessions don't interfere (org isolation)</test>
    </integration_tests>
    <e2e_tests>
      <test>Open scanner app → select "Receive" → workflow guide shows Step 1</test>
      <test>Scan valid PO barcode → success feedback → auto-advance to Step 2</test>
      <test>Step 2: "Confirm Location" shown with dropdown</test>
      <test>Select location → auto-advance to Step 3</test>
      <test>Step 3: "Scan LP Barcode" shown</test>
      <test>Scan invalid barcode → error feedback, stay on Step 3</test>
      <test>Scan valid LP → auto-advance to Step 4</test>
      <test>Step 4: "Confirm Quantity" shown with input</test>
      <test>Enter valid quantity → auto-advance to Step 5</test>
      <test>Step 5: Completion screen shown with summary</test>
      <test>Progress bar shows 5/5 steps completed</test>
      <test>Click "Start New Workflow" → return to workflow selection modal</test>
    </e2e_tests>
  </test_plan>
</story>
