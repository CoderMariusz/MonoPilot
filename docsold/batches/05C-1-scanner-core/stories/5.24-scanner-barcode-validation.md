# Story 5.24: Scanner Barcode Validation

**ID:** 5.24
**Batch:** 5C-1 (Scanner Core)
**Story Points:** 3
**Effort:** 3-4 hours
**Status:** Todo

---

## User Story

> As a **Warehouse user**, I want instant visual feedback (green/red) when scanning barcodes, so that I know immediately if the scan is correct without reading a message.

---

## Acceptance Criteria

### AC 1: Valid Barcode Feedback
- **Given** scanning correct LP barcode
- **When** validation succeeds
- **Then**:
  - Display green screen (background color)
  - Show green checkmark icon (large, 80px)
  - Display LP details: "LP-001 | 50kg Sugar"
  - Green border around input field
  - Play success audio (upward beep)
  - Haptic: double-tap vibration pattern

### AC 2: Invalid Barcode Feedback
- **Given** scanning barcode not in system
- **When** validation fails
- **Then**:
  - Display red screen (background color)
  - Show red X icon (large, 80px)
  - Display error: "Barcode not found"
  - Red border around input field
  - Play error audio (downward beep)
  - Haptic: warning vibration (longer, continuous)
  - Don't auto-advance, remain on step

### AC 3: Expected vs. Scanned Display
- **Given** step expects specific LP (e.g., LP-001)
- **When** scanning LP-002 instead
- **Then**:
  - Show validation status: "Invalid"
  - Display in two columns:
    - Expected: "LP-001 | 50kg"
    - Scanned: "LP-002 | 30kg"
  - Highlight mismatch in red
  - Message: "Wrong item. Expected LP-001, scanned LP-002."
  - Error feedback (red screen, X icon)

### AC 4: Partial Match Warning
- **Given** barcode scanner returns fuzzy match (90% confidence)
- **When** displaying match details
- **Then**:
  - Show yellow/orange screen (warning)
  - Display confidence score: "90% match"
  - Show both expected and matched: "Expected: LP-001 | Matched: LP-0010"
  - Offer options: "Confirm" or "Rescan"
  - On "Confirm": treat as valid (advance)
  - On "Rescan": clear input, stay on step

### AC 5: Blocking Until Correct
- **Given** invalid scan on required barcode field
- **When** validation fails
- **Then**:
  - Disable "Next" button (if present)
  - Don't allow workflow progression
  - Message: "Fix error to continue"
  - Input field remains focused for immediate retry

### AC 6: Quantity Validation (If Applicable)
- **Given** scanning multiple units of same LP
- **When** quantity input required after scan
- **Then**:
  - Accept scan: "Scanned LP-001 ✓"
  - Show input: "How many? [  1  ]"
  - Validate: quantity > 0 and <= available stock
  - If qty exceeds available: show warning "Only 10 available"
  - On valid qty: green feedback + advance

### AC 7: Validation History
- **Given** completing workflow with 5 scans
- **When** viewing workflow summary
- **Then**:
  - Show "Scan Log":
    - 1. LP-001 ✓ 10:23:45
    - 2. LP-002 ✓ 10:23:52
    - 3. LP-003 ✗ (retry)
    - 4. LP-003 ✓ 10:24:01
    - 5. LP-004 ✓ 10:24:08
  - Count: 5 scans, 4 items, 1 retry

---

## Technical Tasks

### Backend

- [ ] Create `POST /api/scanner/validate-barcode` endpoint
  - Accept: session_id, scanned_barcode, expected_lp_id (optional)
  - Query license_plates by barcode (exact or fuzzy match)
  - If exact match found: return valid status + LP details
  - If no match: return invalid status + error message
  - If fuzzy match: return partial_match status + confidence score
  - Log validation to barcode_validations table
  - Return: lp_id, lp_number, product_name, quantity, uom, confidence_score (if fuzzy)

- [ ] Create barcode fuzzy matching logic
  - Implement Levenshtein distance for fuzzy match
  - Configurable threshold per org (default 0.8 = 80%)
  - Returns top match with confidence score
  - Handles common barcode errors: missing digit, extra digit, transposed digits

- [ ] Create `GET /api/scanner/sessions/:id/validations` endpoint
  - Return: array of barcode_validations with timestamps
  - Include: scanned_barcode, validation_status, lp_number, error_message
  - Order by scan_timestamp DESC

- [ ] Create quantity validation logic
  - If quantity_requested > license_plates.quantity: return warning
  - If quantity_requested > available_stock (not on pallet, not in transfer): error
  - Return: available_quantity for display

- [ ] Implement barcode normalization
  - Remove whitespace, leading zeros (configurable per org)
  - Case-insensitive matching
  - Support multiple barcode formats (GS1, custom)

### Frontend

- [ ] Create BarcodeValidationResult component
  - Props: validationStatus, lp, expected, scannedBarcode, confidenceScore
  - Render green (valid), red (invalid), or yellow (partial match) screen
  - Display checkmark/X icon with animation
  - Show LP details (number, product, quantity)
  - Conditional expected vs. scanned display

- [ ] Enhance BarcodeInputField component
  - On scan event: call validateBarcode API
  - Display BarcodeValidationResult immediately
  - Clear input for next scan
  - No manual keyboard input (hardware scan only)

- [ ] Create PartialMatchModal component
  - Show "90% confidence match"
  - Display expected vs. matched in side-by-side
  - Large buttons: "Confirm (Accept)" and "Rescan (Try Again)"
  - On confirm: proceed as valid
  - On rescan: hide modal, refocus input

- [ ] Create ScanLogDisplay component
  - List all scans with status indicator (✓/✗)
  - Show timestamp for each
  - Show retry attempts
  - Display summary: "5 scans, 4 items, 1 retry"

- [ ] Implement validation result caching
  - Cache barcode_validations in IndexedDB offline
  - Sync with backend when online
  - Prevent duplicate validations (same barcode within 5 seconds)

- [ ] Create feedback triggers
  - On valid: green screen + beep + double-tap haptic
  - On invalid: red screen + beep + warning haptic
  - On partial: yellow screen + beep + single-tap haptic

### Database

- [ ] Ensure barcode_validations table exists
- [ ] Add composite index: (session_id, validation_status)
- [ ] Add index: (scanned_barcode, org_id) for fast lookup

---

## Testing

### Unit Tests
- Fuzzy matching: "LP001" matches "LP-001" with >= 80%
- Fuzzy matching: "LP0001" matches "LP001" with < threshold (no match)
- Exact match: "LP-001" matches "LP-001" with 100%
- Barcode normalization: removes whitespace and leading zeros
- Quantity validation: qty <= available passes, qty > available fails

### Integration Tests
- POST /api/scanner/validate-barcode with valid barcode → 200 valid status
- POST with invalid barcode → 200 invalid status
- POST with fuzzy match (90%) → 200 partial_match status with confidence
- GET /api/scanner/sessions/:id/validations returns history ordered by timestamp
- barcode_validations table logged correctly

### E2E Tests
- Scan valid LP barcode → green screen, checkmark, beep
- Scan invalid barcode → red screen, X, error message
- Scan barcode when expecting specific LP → show expected vs. scanned
- Fuzzy match 90% → yellow screen, offer confirm/rescan buttons
- Click "Confirm" on fuzzy match → accept, auto-advance
- Click "Rescan" on fuzzy match → clear input, stay on step
- Invalid scan blocks "Next" button (if present)
- Rescan same barcode → green (second attempt)
- View summary → scan log shows 2 attempts for that LP

---

## Acceptance Criteria Checklist

- ✅ Green screen + checkmark for valid barcode
- ✅ Red screen + X for invalid barcode
- ✅ Display expected vs. scanned barcodes
- ✅ Partial match yellow screen with confidence score
- ✅ Blocking until correct (don't allow advance)
- ✅ Quantity validation if applicable
- ✅ Validation history with scan log
- ✅ Haptic + audio feedback for all statuses
- ✅ Fuzzy matching for barcode typos
- ✅ Barcode normalization (whitespace, zeros)

---

## Dependencies

**Requires:** Story 5.23 (Guided Workflows)

**Enables:** Story 5.25 (Feedback), Story 5.27 (Session Timeout)

---

## Notes

- Barcode validation is **blocking**: cannot proceed until valid
- Fuzzy matching allows operator typos (1-2 character differences)
- Validation history helps with error analysis (repeated failures on specific items)
- Haptic + audio feedback creates multi-sensory confirmation (important in loud warehouse)
- Barcode patterns configurable per org (GS1 vs. custom formats)
- Offline mode: validation cache stored in IndexedDB, synced when online
- Performance critical: validation must complete < 300ms (perceived as instant)
