# Story 5.25: Scanner Feedback

**ID:** 5.25
**Batch:** 5C-1 (Scanner Core)
**Story Points:** 3
**Effort:** 3-4 hours
**Status:** Todo

---

## User Story

> As a **Warehouse user**, I want haptic (vibration) and audio feedback for every scan result, so that I know immediately if the operation succeeded without looking at the screen.

---

## Acceptance Criteria

### AC 1: Success Feedback
- **Given** barcode validation succeeds
- **When** result received
- **Then**:
  - Haptic: two short vibrations [100ms, 50ms pause, 100ms]
  - Audio: upward beep tone (800Hz, 150ms)
  - Visual: green background flash
  - Auto-advance after 1.5 seconds

### AC 2: Error Feedback
- **Given** barcode validation fails (not found)
- **When** result received
- **Then**:
  - Haptic: two long vibrations [200ms, 100ms pause, 200ms]
  - Audio: downward beep tone (400Hz, 200ms)
  - Visual: red background flash
  - Stay on step (don't advance)
  - Message: "Barcode not found. Try again."

### AC 3: Warning Feedback
- **Given** barcode matches with partial confidence (90%)
- **When** result received
- **Then**:
  - Haptic: one medium vibration [150ms]
  - Audio: mid-range beep tone (600Hz, 100ms)
  - Visual: yellow/orange background flash
  - Display confirmation modal: "90% match. Confirm?"
  - User must decide: confirm or rescan

### AC 4: Haptic Pattern Configuration
- **Given** warehouse manager configuring scanner
- **When** opening scanner settings
- **Then**:
  - Show toggle: "Enable Haptic Feedback" (default on)
  - Show pattern selector:
    - ○ Light (single tap)
    - ● Standard (double tap) [selected]
    - ○ Strong (continuous buzz)
  - On device test: "Test Haptic" button triggers pattern
  - Saves to scanner_workflow_configs

### AC 5: Audio Configuration
- **Given** warehouse manager configuring scanner
- **When** opening scanner settings
- **Then**:
  - Show toggle: "Enable Audio Feedback" (default on)
  - Show volume slider (0-100%, default 70%)
  - Show tone selector:
    - ● Beep (default)
    - ○ Chime
    - ○ Bell
  - Test button: plays selected tone at configured volume
  - Audio level respects device volume settings
  - All tones < 60dB (warehouse-safe)

### AC 6: Auto-Advance Configuration
- **Given** warehouse manager configuring scanner
- **When** opening scanner settings
- **Then**:
  - Show auto-advance toggle (default on)
  - Show delay selector: 1000ms, 1500ms [default], 2000ms, 3000ms
  - Longer delays allow operator to perceive feedback
  - Shorter delays for fast-paced environments

### AC 7: Accessibility
- **Given** operator with hearing impairment
- **When** disabling audio feedback
- **Then**:
  - Haptic feedback still works (sufficient for operation)
  - Visual feedback (color changes) always enabled
  - Screen reader compatible: announces validation result

### AC 8: Offline Capability
- **Given** offline or low connectivity
- **When** triggering feedback
- **Then**:
  - Haptic feedback works (device hardware, no internet needed)
  - Audio feedback works (cached locally)
  - Visual feedback works (DOM rendering)
  - No dependency on API calls for feedback

---

## Technical Tasks

### Backend

- [ ] Create `POST /api/scanner/feedback` endpoint
  - Accept: session_id, feedback_type (success/error/warning), haptic_pattern, audio_played
  - Log to scanner_feedback_logs table
  - Return: feedback_id, created_at

- [ ] Create `GET /api/scanner/workflow-config/:type` enhancement
  - Return: enable_haptic, enable_audio, vibration_pattern, audio_file_path, auto_proceed_delay_ms
  - Allow org-level configuration overrides

- [ ] Create `PUT /api/scanner/workflow-config/:type` endpoint (for settings)
  - Accept: enable_haptic, enable_audio, vibration_pattern, audio_file_path, auto_proceed_delay_ms
  - Update scanner_workflow_configs
  - Only organization admins can update
  - Validate patterns are known types

### Frontend

- [ ] Create ScannerFeedbackService
  - Method: triggerHapticFeedback(pattern: 'success' | 'error' | 'warning' | 'custom')
  - Method: playAudioFeedback(tone: 'beep' | 'chime' | 'bell', volume: 0-100)
  - Method: showVisualFeedback(type, message)
  - Check browser support: navigator.vibrate or navigator.webkitVibrate
  - Check audio support: Web Audio API

- [ ] Create haptic feedback implementation
  - Success pattern: [100, 50, 100] ms vibration array
  - Error pattern: [200, 100, 200] ms vibration array
  - Warning pattern: [150] ms vibration array
  - Custom pattern: parameterized array
  - Fallback for browsers without vibration support

- [ ] Create audio feedback implementation
  - Use Web Audio API (OscillatorNode + GainNode)
  - Generate tones on-the-fly (no files to download):
    - Beep: 800Hz (success), 400Hz (error), 600Hz (warning)
    - Chime: 1000Hz + 1500Hz harmonics
    - Bell: complex waveform (harmonics)
  - Duration: 150ms (success), 200ms (error), 100ms (warning)
  - Volume envelope: attack 10ms, decay 50ms, release 50ms
  - All tones < 60dB SPL

- [ ] Create ScannerSettingsModal component
  - Haptic toggle + pattern selector + test button
  - Audio toggle + volume slider + tone selector + test button
  - Auto-advance toggle + delay selector
  - Accessibility: color-blind friendly, screen reader labels
  - Save button: update scanner_workflow_configs

- [ ] Implement feedback logging
  - On every scan: log to scanner_feedback_logs
  - Include: feedback_type, haptic_pattern, audio_played, auto_proceeded
  - Used for analytics: which feedback patterns most effective?

- [ ] Create FeedbackDisplay component enhancement
  - Show visual feedback: colored background flash (100ms)
  - Trigger haptic: call ScannerFeedbackService
  - Trigger audio: call ScannerFeedbackService
  - Auto-advance: setTimeout based on auto_proceed_delay_ms

- [ ] Implement offline feedback
  - Haptic/audio work offline (no network needed)
  - Cache audio synthesis parameters in service worker
  - Test suite includes offline scenarios

### Database

- [ ] Ensure scanner_feedback_logs table exists
- [ ] Ensure scanner_workflow_configs has columns:
  - enable_haptic, enable_audio, vibration_pattern, audio_file_path, auto_proceed_delay_ms

---

## Testing

### Unit Tests
- Haptic pattern generation: correct durations [100, 50, 100]
- Audio tone generation: correct frequency (800Hz success, 400Hz error)
- Feedback config loading: returns correct defaults
- Volume calculation: volume envelope correct (attack/decay/release)

### Integration Tests
- POST /api/scanner/feedback logs correctly to database
- GET /api/scanner/workflow-config/:type returns haptic/audio settings
- PUT /api/scanner/workflow-config/:type updates settings
- Haptic vibrates (if device supports)
- Audio plays (tested with Web Audio API mock)

### E2E Tests
- Valid barcode scan → haptic triggers (double-tap felt)
- Valid barcode scan → audio plays (upward beep heard)
- Valid barcode scan → visual feedback flashes green
- Valid barcode scan → auto-advance after 1.5 seconds
- Invalid barcode scan → haptic triggers (longer vibration)
- Invalid barcode scan → audio plays (downward beep)
- Invalid barcode scan → visual feedback flashes red
- Invalid barcode scan → stays on step (no auto-advance)
- Open settings → toggle haptic off → scan → no haptic
- Open settings → change tone to "chime" → test → chime plays
- Open settings → change delay to 3000ms → scan → slower advancement
- Offline mode → disable internet → scan → haptic/audio still work
- Accessibility: disable audio → haptic still works
- Accessibility: screen reader announces validation result

---

## Acceptance Criteria Checklist

- ✅ Success feedback: haptic double-tap + upward beep + green flash + auto-advance
- ✅ Error feedback: haptic long vibration + downward beep + red flash + no advance
- ✅ Warning feedback: haptic medium tap + mid-tone beep + yellow flash + confirm modal
- ✅ Haptic pattern configuration (light/standard/strong)
- ✅ Audio tone configuration (beep/chime/bell)
- ✅ Auto-advance delay configuration (1000-3000ms)
- ✅ Accessibility: works without audio (haptic sufficient)
- ✅ Offline capability: haptic/audio work without internet
- ✅ Feedback logging for analytics
- ✅ Test buttons for settings validation

---

## Dependencies

**Requires:** Story 5.23 (Guided Workflows), Story 5.24 (Barcode Validation)

**Enables:** Story 5.26 (Operations Menu), Story 5.27 (Session Timeout)

---

## Notes

- **Multi-sensory feedback**: Important in loud warehouse environment (audio may not be heard)
- **Haptic patterns**: Different patterns create tactile "language" (user learns meanings)
- **Audio synthesis**: Generate tones on-the-fly (no network, no file loading)
- **Volume levels**: All tones < 60dB to respect OSHA guidelines in warehouse
- **Configuration flexibility**: Orgs can customize feedback per workflow type
- **Offline-first**: Feedback is client-side only (never depends on internet)
- **Browser support**: Graceful degradation for browsers without vibration API
- **Accessibility**: Haptic feedback enables operation for hearing-impaired users
- **Performance**: Feedback triggers < 50ms after validation (feels immediate)
