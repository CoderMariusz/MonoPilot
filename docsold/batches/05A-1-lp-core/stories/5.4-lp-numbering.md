# Story 5.4: LP Number Generation

**ID:** 5.4
**Batch:** 5A-1 (LP Core)
**Story Points:** 5
**Effort:** 5-8 hours
**Status:** Todo

---

## User Story

> As a **System**, I want to auto-generate LP numbers, so that they are unique and meaningful.

---

## Acceptance Criteria

### AC 1: Default Format
- **Given** LP created without explicit lp_number
- **When** saving
- **Then** auto-generate: `LP-YYYYMMDD-NNNN`
  - YYYY = year (e.g., 2025)
  - MMDD = month-day (e.g., 0127)
  - NNNN = 4-digit sequence (0001, 0002, ..., 9999)
  - Example: `LP-20250127-0001`, `LP-20250127-0002`

### AC 2: Daily Sequence Reset
- **Given** LP created on 2025-01-27
- **When** sequence reaches 9999
- **Then** sequence resets to 0001 on next day
- **And** date changes to 2025-01-28

### AC 3: Configurable Format
- **Given** Admin navigates to /settings/warehouse
- **When** editing "LP Number Format"
- **Then** can set custom format:
  - Default: `LP-YYYYMMDD-NNNN`
  - Alternative: `{org_code}-{date}-{seq}` (e.g., ACME-20250127-0001)
  - Alternative: `{warehouse_code}{seq}` (e.g., WHA0001)

### AC 4: Admin Override
- **Given** creating LP via UI
- **When** admin provides explicit lp_number
- **Then** system validates:
  - Format matches warehouse_settings.lp_number_format
  - Uniqueness within org_id
  - If valid: use provided number
  - If invalid: reject with error

### AC 5: Global Uniqueness
- **Given** lp_number already exists in org
- **When** creating new LP with same lp_number
- **Then** reject with error: "License Plate LP-20250127-0001 already exists"
- **And** suggest next available: "Try LP-20250127-0002"

---

## Technical Tasks

### Backend

- [ ] Create lp_number_sequence table:
  ```sql
  CREATE TABLE lp_number_sequence (
    id UUID PRIMARY KEY,
    org_id UUID NOT NULL,
    sequence_date DATE NOT NULL,
    next_sequence INT DEFAULT 1,
    UNIQUE(org_id, sequence_date)
  );
  ```

- [ ] Implement generateLPNumber(org_id, format) function
  - Fetch current sequence for today
  - Increment counter
  - Format using warehouse_settings.lp_number_format
  - Return formatted number

- [ ] Add endpoint POST /api/warehouse/license-plates/generate-number
  - Query param: ?override_format (optional)
  - Return: next_lp_number, all_recent_numbers

### Database

- [ ] Create unique index on (org_id, lp_number)
- [ ] Create index on (org_id, created_at) for daily sequence queries

### Frontend

- [ ] Update license_plates create modal to show "Auto-generated: LP-20250127-0001"
- [ ] Add "Override" checkbox to allow custom number entry
- [ ] Validate custom format matches pattern

---

## Testing

### Unit Tests
- Sequence increment and daily reset
- Format generation with different templates

### Integration Tests
- Concurrent LP creation (sequence consistency)

### E2E Tests
- Create 5 LPs, verify sequencing
- Create with custom format, verify validation

---

## Acceptance Criteria Checklist

- ✅ LP numbers auto-generated correctly
- ✅ Daily sequence reset working
- ✅ Configurable format from settings
- ✅ Admin override with validation
- ✅ Uniqueness enforced

---

## Dependencies

**Requires:** Story 5.1 (License Plate Creation)

---

## Notes

- LP numbering is **critical for traceability**
- Sequence must be **atomic** (prevent duplicates under concurrent load)
- Format configurability important for different warehouse strategies
