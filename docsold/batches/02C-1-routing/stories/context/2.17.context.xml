<?xml version="1.0" encoding="UTF-8"?>
<story>
  <metadata>
    <id>2.17</id>
    <title>Routing-Product Assignment</title>
    <batch>02C-1</batch>
    <points>3</points>
    <effort_hours>4-5</effort_hours>
    <status>pending</status>
  </metadata>

  <description>Many-to-many assignment of routings to products with default routing selection.</description>

  <dependencies>
    <requires>
      <story id="2.15">Routing CRUD</story>
      <batch id="02A-1">Products Core</batch>
    </requires>
  </dependencies>

  <technical_context>
    <tables>
      <table>
        <name>product_routings</name>
        <columns>
          <column name="id" type="UUID" pk="true"/>
          <column name="product_id" type="UUID" fk="products.id" cascade="true"/>
          <column name="routing_id" type="UUID" fk="routings.id" cascade="true"/>
          <column name="is_default" type="BOOLEAN" default="false"/>
          <column name="created_at" type="TIMESTAMPTZ"/>
        </columns>
        <constraints>
          <unique>product_id, routing_id</unique>
        </constraints>
      </table>
    </tables>

    <api_endpoints>
      <endpoint method="GET" path="/api/technical/routings/:id/products">Products assigned to routing</endpoint>
      <endpoint method="PUT" path="/api/technical/routings/:id/products">Update assignments</endpoint>
      <endpoint method="GET" path="/api/technical/products/:id/routings">Routings assigned to product</endpoint>
      <endpoint method="PUT" path="/api/technical/products/:id/routings">Update assignments</endpoint>
    </api_endpoints>

    <business_rules>
      <rule>Reusable routing can be assigned to multiple products</rule>
      <rule>Non-reusable routing can only be assigned to 1 product</rule>
      <rule>Only 1 routing can be default per product</rule>
    </business_rules>
  </technical_context>

  <acceptance_criteria>
    <ac id="2.17.1">Reusable routing assignable to multiple products</ac>
    <ac id="2.17.2">Non-reusable routing limited to 1 product</ac>
    <ac id="2.17.3">Set one routing as default per product</ac>
    <ac id="2.17.4">Routing detail shows assigned products</ac>
    <ac id="2.17.5">Product edit shows assigned routings</ac>
    <ac id="2.17.6">Bi-directional assignment UI</ac>
  </acceptance_criteria>
</story>
