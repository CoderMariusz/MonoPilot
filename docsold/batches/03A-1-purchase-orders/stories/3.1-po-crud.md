# Story 3.1: Purchase Order CRUD

**Epic:** 3 - Planning Operations
**Batch:** 03A-1
**Story ID:** 3.1
**Priority:** P0
**Effort:** 8 points
**Status:** Ready for Development

---

## User Story

**As a** Purchasing user,
**I want to** create, edit, and view purchase orders,
**So that** I can manage procurement efficiently.

---

## Acceptance Criteria

### AC-1.1: PO List View

**Given** the user has Purchasing role or higher
**When** they navigate to `/planning/purchase-orders`
**Then** they see a table with columns:
- PO Number
- Supplier
- Status
- Expected Date
- Total (with currency badge)

**And** can search by PO number/supplier name
**And** can filter by:
  - Status (dropdown: all statuses from planning_settings)
  - Supplier (multi-select dropdown)
  - Warehouse (dropdown)
  - Date range (from/to date pickers)

**And** table is paginated (50 per page) if >100 POs
**And** table is sortable by all columns

### AC-1.2: PO Creation Flow

**When** clicking "Add PO" button
**Then** Create modal opens with:

**Step 1: Select Supplier** (required)
- Supplier dropdown (shows only active suppliers)
- On selection → Auto-populate:
  - Currency (badge shown on all amount fields)
  - Tax Code (used dla line tax calculation)
  - Payment Terms (editable)

**Step 2: PO Header Fields**
- `warehouse_id`: Dropdown (required) - dla receiving location reference
- `expected_delivery_date`: Date picker (required, cannot be in past)
- `payment_terms`: Text input (pre-filled from supplier, editable)
- `shipping_method`: Text input (optional, visible if enabled in settings)
- `notes`: Textarea (optional, visible if enabled in settings, max 1000 chars)

**Step 3: Review & Save**
- Show summary: Supplier, Warehouse, Date, Currency
- Click "Create" → API call
- Loading state shown
- Success → Redirect to PO detail page
- Error → Show error message inline

### AC-1.3: PO Number Generation

**When** PO is created
**Then** PO number auto-generated with format: `PO-YYYY-NNNN`
**Examples:**
- First PO in 2025 → `PO-2025-0001`
- Second PO in 2025 → `PO-2025-0002`
- First PO in 2026 → `PO-2026-0001` (resets each year)

**And** PO number is unique per org
**And** PO number is immutable (never changes)

### AC-1.4: Currency Inheritance

**When** supplier is selected
**Then** PO inherits `currency` from supplier
**And** currency badge shown on all amount fields (subtotal, tax, total)
**And** currency **cannot be changed** after PO creation (locked)

**Example:**
- Supplier has currency = EUR
- PO shows: "Subtotal: €1,000", "Tax: €230", "Total: €1,230"

### AC-1.5: Default Status Assignment

**When** PO is created
**Then** status set to `planning_settings.po_default_status` (usually "Draft")
**And** if `po_require_approval = true` AND `total > po_approval_threshold`:
  - Set `approval_status = 'pending'`
  - PO shown in "Pending Approval" list (Story 3.4)
**Else**:
  - `approval_status = null` (no approval needed)

### AC-1.6: PO Detail View

**When** clicking on PO row
**Then** navigate to `/planning/purchase-orders/:id`
**And** show PO detail page with tabs:
- **Overview**: Header fields, totals, status
- **Lines**: PO lines table (Story 3.2)
- **Approval**: Approval history (Story 3.4)
- **Activity**: Audit log (created_by, updated_by, status changes)

**Header Section:**
- PO Number (badge)
- Status (badge with color)
- Supplier name (link to supplier detail)
- Warehouse name
- Expected Delivery Date
- Currency badge

**Totals Section:**
- Subtotal
- Tax Amount
- Total
- All amounts with currency badge

**Actions:**
- Edit button (if status allows)
- Delete button (if status = Draft and no lines)
- Change Status dropdown (Story 3.5)
- Approve/Reject buttons (if pending approval, Story 3.4)

### AC-1.7: PO Edit

**When** clicking Edit button
**Then** Edit Drawer opens with same fields as Create modal

**Can Edit:**
- `expected_delivery_date`
- `payment_terms`
- `shipping_method`
- `notes`

**Cannot Edit:**
- `supplier_id` (locked after creation)
- `warehouse_id` (locked after creation)
- `currency` (inherited from supplier, locked)
- `po_number` (immutable)

**Validation:**
- If status = 'Closed' OR 'Receiving' → Block edit, show error: "Cannot edit PO in Closed or Receiving status"
- If PO has received lines (Epic 5) → Block edit, show warning

**When** saving changes
**Then** PO updated
**And** `updated_by`, `updated_at` recorded
**And** audit log entry created

### AC-1.8: PO Delete

**When** clicking Delete button
**Then** show confirmation dialog: "Are you sure? This action cannot be undone."

**Validation:**
- If PO has lines → Block delete, show error: "Cannot delete PO with lines. Delete lines first."
- If status != 'Draft' → Block delete, show error: "Can only delete POs in Draft status"
- If PO has been partially received (Epic 5) → Block delete

**When** confirmed
**Then** hard delete PO (no soft delete)
**And** redirect to PO list
**And** show success toast: "PO deleted successfully"

---

## Technical Tasks

### Backend

1. **Database Migration**
   - Create `purchase_orders` table
   - Create indexes
   - Enable RLS policies

2. **PO Number Generator**
   - `lib/utils/po-number-generator.ts`
   - Format: `PO-YYYY-NNNN`
   - Org-scoped unique constraint

3. **API Routes**
   - `GET /api/planning/purchase-orders` - List with filters
   - `POST /api/planning/purchase-orders` - Create
   - `GET /api/planning/purchase-orders/:id` - Detail
   - `PUT /api/planning/purchase-orders/:id` - Update
   - `DELETE /api/planning/purchase-orders/:id` - Delete

4. **Validation Schemas**
   - `purchaseOrderSchema` in `lib/validation/planning-schemas.ts`

### Frontend

5. **PO List Page**
   - `app/(authenticated)/planning/purchase-orders/page.tsx`
   - Search, filters, pagination, sorting

6. **PO Create Modal**
   - `components/planning/POCreateModal.tsx`
   - Multi-step form

7. **PO Detail Page**
   - `app/(authenticated)/planning/purchase-orders/[id]/page.tsx`
   - Tabs: Overview, Lines, Approval, Activity

8. **PO Edit Drawer**
   - `components/planning/POEditDrawer.tsx`

---

## Testing Requirements

### Unit Tests
- PO number generation (format, year rollover, concurrency)
- Validation schema (required fields, date validation)

### Integration Tests
- Create PO → currency inherited, status assigned
- Update PO → blocked if closed/receiving
- Delete PO → blocked if has lines

### E2E Tests
- Full PO creation flow
- Edit PO flow
- Delete draft PO

---

## Definition of Done

- [ ] Database migration created and applied
- [ ] RLS policies enabled and tested
- [ ] PO number generator implemented and tested
- [ ] API routes implemented (GET, POST, PUT, DELETE)
- [ ] Zod validation schemas created
- [ ] Frontend components created (List, Create Modal, Detail Page)
- [ ] Currency inheritance logic implemented
- [ ] Unit tests written
- [ ] Integration tests written
- [ ] E2E tests written
- [ ] Code reviewed and approved

---

## Dependencies

### Requires
- Story 3.17 (Supplier Management) - must be completed first
- Epic 1: warehouses, tax_codes, users tables
- Epic 2: products table (dla lines in Story 3.2)

### Blocks
- Story 3.2 (PO Lines) - requires PO header
- Story 3.3 (Bulk PO) - uses PO creation logic
- Story 3.4 (Approval) - requires PO base
- Story 3.5 (Statuses) - requires PO base

---

## Notes

- PO number format is **immutable** (never changes)
- Currency is **locked** to supplier (inherited, cannot change)
- Status transitions defined in Story 3.5
- Approval logic defined in Story 3.4
- PO receiving handled in Epic 5 (Warehouse Module)
