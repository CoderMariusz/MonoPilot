# Story 3.2: PO Line Management

**Epic:** 3 - Planning Operations
**Batch:** 03A-1
**Story ID:** 3.2
**Priority:** P0
**Effort:** 8 points
**Status:** Ready for Development

---

## User Story

**As a** Purchasing user,
**I want to** add and manage PO lines with automatic tax calculation,
**So that** I can specify what to order and see accurate totals.

---

## Acceptance Criteria

### AC-2.1: Add PO Line

**Given** PO exists in Draft status
**When** clicking "Add Line" button
**Then** Add Line modal opens with fields:

**Required:**
- `product_id`: Searchable dropdown (all active products)
- `quantity`: Number input (must be > 0)
- `unit_price`: Number input (pre-filled from supplier_products or product default, editable)

**Auto-populated:**
- `uom`: From product (read-only, displayed)

**Optional:**
- `discount_percent`: Number input (0-100, default 0)
- `expected_delivery_date`: Date picker (defaults to PO header date)

**Calculation (real-time as user types):**
```
line_subtotal = quantity × unit_price
discount_amount = line_subtotal × (discount_percent / 100)
line_total = line_subtotal - discount_amount
tax_amount = line_total × (tax_rate / 100)  // tax_rate from supplier.tax_code_id
line_total_with_tax = line_total + tax_amount
```

**When** saving line
**Then** line created with auto-incremented `sequence`
**And** PO totals recalculated via database trigger
**And** line added to PO Lines table

### AC-2.2: PO Lines Table Display

**Given** PO has lines
**Then** Lines tab shows table with columns:
- Sequence (#)
- Product Code
- Product Name
- Quantity
- UoM
- Unit Price (with currency badge)
- Discount %
- Line Total (with currency badge)
- Tax Amount (with currency badge)
- Total with Tax (with currency badge)
- Actions (Edit, Delete icons)

**And** table shows all lines sorted by sequence
**And** footer row shows PO totals:
  - **Subtotal**: SUM(line_total)
  - **Tax**: SUM(tax_amount)
  - **Total**: subtotal + tax
  - All with currency badge (from PO.currency)

### AC-2.3: Edit PO Line

**When** clicking Edit icon on line
**Then** Edit Line modal opens (same fields as Add Line)

**Can Edit:**
- quantity
- unit_price
- discount_percent
- expected_delivery_date

**Cannot Edit:**
- product_id (locked after creation, delete and re-add instead)
- uom (from product)
- sequence (auto-managed)

**When** saving changes
**Then** line updated
**And** calculations re-run
**And** PO totals recalculated
**And** `updated_at` timestamp updated

### AC-2.4: Delete PO Line

**When** clicking Delete icon on line
**Then** show confirmation dialog: "Delete this line?"

**When** confirmed
**Then** line deleted
**And** remaining lines re-sequenced (1, 2, 3, ...)
**And** PO totals recalculated
**And** if this was the last line → PO totals = 0

### AC-2.5: Tax Calculation Logic

**Tax Rate Source:**
- PO.supplier_id → suppliers.tax_code_id → tax_codes.rate

**Example:**
- Supplier has tax_code_id = "VAT 23%" (rate = 23.00)
- Line: quantity = 10, unit_price = 100, discount = 0%
- Calculations:
  - line_subtotal = 10 × 100 = 1,000
  - discount_amount = 1,000 × 0% = 0
  - line_total = 1,000 - 0 = 1,000
  - tax_amount = 1,000 × 23% = 230
  - line_total_with_tax = 1,000 + 230 = 1,230

### AC-2.6: PO Totals Recalculation Trigger

**When** line is added, edited, or deleted
**Then** database trigger fires and updates PO totals instantly
**And** no API roundtrip needed (database handles it)

### AC-2.7: Unit Price Pre-fill Logic

**When** user selects product
**Then** system looks up unit_price in this order:
1. Check `supplier_products` table for supplier-specific price
2. If not found, use `products.unit_price` (default from product)
3. If still null, set to 0 (user must enter manually)

**And** user can always edit the pre-filled price

### AC-2.8: Validation Rules

1. **Quantity**: Must be > 0
2. **Unit Price**: Must be >= 0 (can be 0 for free samples)
3. **Discount**: Must be 0-100 (percentage)
4. **Product**: Cannot add duplicate product to same PO (block or show warning)
5. **Status Check**: Cannot add/edit/delete lines if PO status = 'Closed' or 'Receiving'

---

## Technical Tasks

### Backend

1. **Database Migration**
   - Create `po_lines` table
   - Create PO totals recalculation trigger
   - Enable RLS policies

2. **API Routes**
   - `GET /api/planning/purchase-orders/:id/lines` - List lines
   - `POST /api/planning/purchase-orders/:id/lines` - Add line
   - `PUT /api/planning/purchase-orders/:id/lines/:lineId` - Update line
   - `DELETE /api/planning/purchase-orders/:id/lines/:lineId` - Delete line

3. **Validation Schemas**
   - `poLineSchema` in `lib/validation/planning-schemas.ts`

### Frontend

4. **PO Lines Table**
   - `components/planning/POLinesTable.tsx`
   - Sortable by sequence, footer with totals

5. **Line Form Modal**
   - `components/planning/POLineFormModal.tsx`
   - Real-time calculation preview

---

## Testing Requirements

### Unit Tests
- Line calculation logic (subtotal, discount, tax)
- Tax rate lookup
- Unit price pre-fill logic

### Integration Tests
- Create line → totals recalculated
- Edit line → totals updated
- Delete line → totals updated, re-sequence

### E2E Tests
- Add multiple lines to PO
- Edit line → verify totals
- Delete line → verify totals

---

## Definition of Done

- [ ] Database migration with trigger
- [ ] API routes (GET, POST, PUT, DELETE)
- [ ] Frontend components (Add/Edit Line modals, Lines table)
- [ ] Calculation logic tested
- [ ] Trigger tested (totals recalc)
- [ ] E2E test (line management flow)
- [ ] Code reviewed and approved

---

## Dependencies

- Story 3.1 (PO CRUD) - requires PO header
- Story 3.17 (Suppliers) - requires tax_code_id
- Epic 2 (Products) - requires products table

---

## Notes

- Tax calculation uses supplier.tax_code_id (fixed per PO)
- Totals recalculated via database trigger (no API call)
- Product cannot be changed after line creation (delete and re-add)
