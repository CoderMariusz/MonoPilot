<?xml version="1.0" encoding="UTF-8"?>
<story-context id="3-1-purchase-order-crud" v="1.0">
  <metadata>
    <epicId>3</epicId>
    <storyId>3.1</storyId>
    <title>Purchase Order CRUD</title>
    <batch>03A-1</batch>
    <points>8</points>
    <effort_hours>8-10</effort_hours>
    <status>ready-for-dev</status>
    <generatedAt>2025-11-28</generatedAt>
  </metadata>

  <description>
    Create, edit, and view purchase orders with auto-generated PO numbers,
    currency inheritance from supplier, and configurable status workflow.
  </description>

  <dependencies>
    <blocks>
      <story id="3.2">PO Line Management</story>
      <story id="3.3">Bulk PO Creation</story>
      <story id="3.4">PO Approval Workflow</story>
      <story id="3.5">Configurable PO Statuses</story>
    </blocks>
    <requires>
      <story id="3.17">Supplier Management</story>
      <epic id="1">Organizations, Users, Warehouses</epic>
      <epic id="2">Products (Batch 2A)</epic>
    </requires>
  </dependencies>

  <technical_context>
    <tables>
      <table>
        <name>purchase_orders</name>
        <columns>
          <column name="id" type="UUID" pk="true"/>
          <column name="org_id" type="UUID" fk="organizations.id"/>
          <column name="po_number" type="VARCHAR(20)" unique="true"/>
          <column name="supplier_id" type="UUID" fk="suppliers.id"/>
          <column name="warehouse_id" type="UUID" fk="warehouses.id"/>
          <column name="status" type="VARCHAR(50)"/>
          <column name="expected_delivery_date" type="DATE"/>
          <column name="actual_delivery_date" type="DATE" nullable="true"/>
          <column name="payment_terms" type="VARCHAR(100)" nullable="true"/>
          <column name="shipping_method" type="VARCHAR(100)" nullable="true"/>
          <column name="notes" type="TEXT" nullable="true"/>
          <column name="currency" type="VARCHAR(3)"/>
          <column name="subtotal" type="NUMERIC(15,2)" default="0"/>
          <column name="tax_amount" type="NUMERIC(15,2)" default="0"/>
          <column name="total" type="NUMERIC(15,2)" default="0"/>
          <column name="approval_status" type="VARCHAR(20)" nullable="true"/>
          <column name="approved_by" type="UUID" fk="users.id" nullable="true"/>
          <column name="approved_at" type="TIMESTAMPTZ" nullable="true"/>
          <column name="rejection_reason" type="TEXT" nullable="true"/>
          <column name="created_by" type="UUID" fk="users.id"/>
          <column name="updated_by" type="UUID" fk="users.id"/>
          <column name="created_at" type="TIMESTAMPTZ"/>
          <column name="updated_at" type="TIMESTAMPTZ"/>
        </columns>
        <indexes>
          <index name="idx_po_org_number" columns="org_id, po_number" unique="true"/>
          <index name="idx_po_supplier" columns="supplier_id"/>
          <index name="idx_po_warehouse" columns="warehouse_id"/>
          <index name="idx_po_status" columns="status"/>
        </indexes>
      </table>
    </tables>

    <api_endpoints>
      <endpoint method="GET" path="/api/planning/purchase-orders">
        <description>List POs with filters (search, status, supplier, warehouse, date range)</description>
        <query_params>search, status, supplier_id, warehouse_id, date_from, date_to</query_params>
        <response>PurchaseOrder[] with supplier and warehouse joined</response>
      </endpoint>
      <endpoint method="POST" path="/api/planning/purchase-orders">
        <description>Create new PO</description>
        <request_body>{ supplier_id, warehouse_id, expected_delivery_date, payment_terms?, shipping_method?, notes? }</request_body>
        <response>PurchaseOrder with auto-generated po_number</response>
      </endpoint>
      <endpoint method="GET" path="/api/planning/purchase-orders/:id">
        <description>Get PO detail with lines</description>
        <response>PurchaseOrder with supplier, warehouse, po_lines joined</response>
      </endpoint>
      <endpoint method="PUT" path="/api/planning/purchase-orders/:id">
        <description>Update PO (blocked if status=closed/receiving)</description>
        <request_body>{ expected_delivery_date?, payment_terms?, shipping_method?, notes? }</request_body>
      </endpoint>
      <endpoint method="DELETE" path="/api/planning/purchase-orders/:id">
        <description>Delete PO (only if status=draft and no lines)</description>
      </endpoint>
    </api_endpoints>

    <frontend_routes>
      <route path="/planning/purchase-orders" component="PurchaseOrdersPage"/>
      <route path="/planning/purchase-orders/:id" component="PurchaseOrderDetailPage"/>
    </frontend_routes>

    <components_to_create>
      <component name="PurchaseOrdersTable" path="components/planning/"/>
      <component name="POCreateModal" path="components/planning/"/>
      <component name="POEditDrawer" path="components/planning/"/>
      <component name="PODetailPage" path="app/(authenticated)/planning/purchase-orders/[id]/"/>
    </components_to_create>

    <utilities>
      <utility name="generatePONumber" path="lib/utils/po-number-generator.ts">
        <signature>async function generatePONumber(supabase, org_id): Promise&lt;string&gt;</signature>
        <description>Generates PO number in format PO-YYYY-NNNN, resets each year</description>
      </utility>
    </utilities>
  </technical_context>

  <acceptance_criteria>
    <criterion id="AC-1.1">PO List View - Table with PO Number, Supplier, Status, Expected Date, Total; search and filters</criterion>
    <criterion id="AC-1.2">PO Creation Flow - Multi-step modal: supplier selection, header fields, review</criterion>
    <criterion id="AC-1.3">PO Number Generation - Format PO-YYYY-NNNN, unique per org, immutable</criterion>
    <criterion id="AC-1.4">Currency Inheritance - From supplier, locked after creation</criterion>
    <criterion id="AC-1.5">Default Status Assignment - From planning_settings.po_default_status</criterion>
    <criterion id="AC-1.6">PO Detail View - Tabs: Overview, Lines, Approval, Activity</criterion>
    <criterion id="AC-1.7">PO Edit - Can edit dates/terms/notes; cannot edit supplier/warehouse/currency</criterion>
    <criterion id="AC-1.8">PO Delete - Only if status=draft and no lines</criterion>
  </acceptance_criteria>

  <validation_rules>
    <rule field="supplier_id" type="required">Must be valid UUID of existing supplier</rule>
    <rule field="warehouse_id" type="required">Must be valid UUID of existing warehouse</rule>
    <rule field="expected_delivery_date" type="date">Cannot be in the past</rule>
    <rule field="notes" type="maxLength" value="1000">Max 1000 characters</rule>
  </validation_rules>

  <test_plan>
    <unit_tests>
      <test>PO number generation - format validation</test>
      <test>PO number generation - year rollover</test>
      <test>PO number generation - concurrent creation no duplicates</test>
      <test>Validation schema - required fields</test>
      <test>Validation schema - date in past rejection</test>
    </unit_tests>
    <integration_tests>
      <test>Create PO - currency inherited from supplier</test>
      <test>Create PO - status from planning_settings</test>
      <test>Update PO - blocked if status closed/receiving</test>
      <test>Delete PO - blocked if has lines</test>
      <test>Delete PO - blocked if status not draft</test>
    </integration_tests>
    <e2e_tests>
      <test>Full PO creation flow - supplier selection to detail page</test>
      <test>PO edit flow - update dates and notes</test>
      <test>PO delete flow - draft PO without lines</test>
    </e2e_tests>
  </test_plan>

  <implementation_notes>
    <note type="critical">PO number is immutable - never changes after creation</note>
    <note type="critical">Currency locked to supplier - cannot be changed</note>
    <note type="important">Use database trigger for totals recalculation (Story 3.2)</note>
    <note type="important">Approval workflow handled in Story 3.4</note>
    <note type="future">PO receiving handled in Epic 5 (Warehouse Module)</note>
  </implementation_notes>
</story-context>
