<?xml version="1.0" encoding="UTF-8"?>
<story-context id="3-5-configurable-po-statuses" v="1.0">
  <metadata>
    <epicId>3</epicId>
    <storyId>3.5</storyId>
    <title>Configurable PO Statuses</title>
    <batch>03A-1</batch>
    <points>5</points>
    <effort_hours>4-6</effort_hours>
    <status>ready-for-dev</status>
    <generatedAt>2025-11-28</generatedAt>
  </metadata>

  <description>
    Admin-configurable PO status workflow with customizable labels, colors,
    and ordering stored as JSONB in planning_settings.
  </description>

  <dependencies>
    <requires>
      <story id="3.1">PO CRUD</story>
      <epic id="1">Settings infrastructure</epic>
    </requires>
  </dependencies>

  <technical_context>
    <tables>
      <table>
        <name>planning_settings</name>
        <columns>
          <column name="id" type="UUID" pk="true"/>
          <column name="org_id" type="UUID" fk="organizations.id" unique="true"/>
          <column name="po_statuses" type="JSONB">
            <default>[
              {"code": "draft", "label": "Draft", "color": "gray", "is_default": true, "sequence": 1},
              {"code": "submitted", "label": "Submitted", "color": "blue", "is_default": false, "sequence": 2},
              {"code": "confirmed", "label": "Confirmed", "color": "green", "is_default": false, "sequence": 3},
              {"code": "receiving", "label": "Receiving", "color": "yellow", "is_default": false, "sequence": 4},
              {"code": "closed", "label": "Closed", "color": "purple", "is_default": false, "sequence": 5}
            ]</default>
          </column>
          <column name="po_default_status" type="VARCHAR(50)" default="draft"/>
          <column name="created_at" type="TIMESTAMPTZ"/>
          <column name="updated_at" type="TIMESTAMPTZ"/>
        </columns>
      </table>
    </tables>

    <api_endpoints>
      <endpoint method="GET" path="/api/planning/settings">
        <description>Get planning settings for org</description>
        <response>{ po_statuses: Status[], po_default_status: string, ... }</response>
      </endpoint>
      <endpoint method="PUT" path="/api/planning/settings">
        <description>Update planning settings</description>
        <request_body>{ po_statuses: Status[], po_default_status?: string }</request_body>
        <validation>Exactly one status must have is_default=true</validation>
      </endpoint>
      <endpoint method="PUT" path="/api/planning/purchase-orders/:id/status">
        <description>Change PO status</description>
        <request_body>{ status: string }</request_body>
        <validation>Status must exist in po_statuses, PO not closed</validation>
      </endpoint>
    </api_endpoints>

    <frontend_routes>
      <route path="/settings/planning" component="PlanningSettingsPage"/>
    </frontend_routes>

    <components_to_create>
      <component name="POStatusesSettings" path="components/settings/" description="Drag-drop status management"/>
      <component name="POStatusFormModal" path="components/settings/"/>
      <component name="POStatusBadge" path="components/planning/"/>
    </components_to_create>

    <status_schema>
      <field name="code" type="string" editable="false">Immutable, used in business logic</field>
      <field name="label" type="string" editable="true">Display name</field>
      <field name="color" type="enum" editable="true">gray, blue, green, yellow, red, purple, orange</field>
      <field name="is_default" type="boolean" editable="true">Only one can be true</field>
      <field name="sequence" type="number" editable="true">Order in dropdowns</field>
    </status_schema>
  </technical_context>

  <acceptance_criteria>
    <criterion id="AC-5.1">Settings Page - Table with code, label, color badge, default checkbox, drag-drop reorder</criterion>
    <criterion id="AC-5.2">Add Status - Modal with code, label, color, is_default, sequence</criterion>
    <criterion id="AC-5.3">Edit Status - Can edit label/color/default/sequence; code immutable</criterion>
    <criterion id="AC-5.4">Delete Status - Blocked if POs exist with that status</criterion>
    <criterion id="AC-5.5">Reorder - Drag-drop to change sequence</criterion>
    <criterion id="AC-5.6">Default Logic - Only one default; auto-unset previous when setting new</criterion>
    <criterion id="AC-5.7">Status Change - Dropdown in PO detail; creates audit log</criterion>
    <criterion id="AC-5.8">Status Badge - Dynamic color from configuration</criterion>
  </acceptance_criteria>

  <validation_rules>
    <rule field="code" type="format">lowercase, no spaces, unique</rule>
    <rule field="label" type="required">Non-empty string</rule>
    <rule field="color" type="enum">One of: gray, blue, green, yellow, red, purple, orange</rule>
    <rule field="is_default" type="unique">Exactly one status must be default</rule>
  </validation_rules>

  <test_plan>
    <unit_tests>
      <test>Status validation - exactly one default</test>
      <test>Status reorder - sequence updates correctly</test>
    </unit_tests>
    <integration_tests>
      <test>Add status - saved to JSONB</test>
      <test>Edit status - label/color updated, PO badges reflect change</test>
      <test>Delete status with POs - returns error</test>
      <test>Delete status without POs - success</test>
    </integration_tests>
    <e2e_tests>
      <test>Add custom status via UI</test>
      <test>Reorder statuses - verify dropdown order</test>
      <test>Change PO status via dropdown</test>
    </e2e_tests>
  </test_plan>

  <implementation_notes>
    <note type="critical">Code is immutable - used in business logic</note>
    <note type="important">JSONB allows flexible status configuration</note>
    <note type="important">Drag-drop for better UX</note>
    <note type="warning">Cannot delete status if POs exist with it</note>
  </implementation_notes>
</story-context>
