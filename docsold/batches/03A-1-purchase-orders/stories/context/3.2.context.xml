<?xml version="1.0" encoding="UTF-8"?>
<story-context id="3-2-po-line-management" v="1.0">
  <metadata>
    <epicId>3</epicId>
    <storyId>3.2</storyId>
    <title>PO Line Management</title>
    <batch>03A-1</batch>
    <points>8</points>
    <effort_hours>8-10</effort_hours>
    <status>ready-for-dev</status>
    <generatedAt>2025-11-28</generatedAt>
  </metadata>

  <description>
    Add and manage PO lines with automatic tax calculation, real-time totals,
    and database trigger for PO totals recalculation.
  </description>

  <dependencies>
    <requires>
      <story id="3.1">PO CRUD</story>
      <story id="3.17">Supplier Management (tax_code_id)</story>
      <epic id="2">Products</epic>
    </requires>
  </dependencies>

  <technical_context>
    <tables>
      <table>
        <name>po_lines</name>
        <columns>
          <column name="id" type="UUID" pk="true"/>
          <column name="org_id" type="UUID" fk="organizations.id"/>
          <column name="po_id" type="UUID" fk="purchase_orders.id" on_delete="CASCADE"/>
          <column name="product_id" type="UUID" fk="products.id" on_delete="RESTRICT"/>
          <column name="sequence" type="INTEGER"/>
          <column name="quantity" type="NUMERIC(15,3)"/>
          <column name="uom" type="VARCHAR(20)"/>
          <column name="unit_price" type="NUMERIC(15,2)"/>
          <column name="discount_percent" type="NUMERIC(5,2)" default="0"/>
          <column name="line_subtotal" type="NUMERIC(15,2)"/>
          <column name="discount_amount" type="NUMERIC(15,2)" default="0"/>
          <column name="line_total" type="NUMERIC(15,2)"/>
          <column name="tax_amount" type="NUMERIC(15,2)" default="0"/>
          <column name="line_total_with_tax" type="NUMERIC(15,2)"/>
          <column name="expected_delivery_date" type="DATE" nullable="true"/>
          <column name="received_qty" type="NUMERIC(15,3)" default="0"/>
          <column name="created_at" type="TIMESTAMPTZ"/>
          <column name="updated_at" type="TIMESTAMPTZ"/>
        </columns>
        <indexes>
          <index name="idx_po_lines_sequence" columns="po_id, sequence" unique="true"/>
          <index name="idx_po_lines_po" columns="po_id"/>
          <index name="idx_po_lines_product" columns="product_id"/>
        </indexes>
      </table>
    </tables>

    <triggers>
      <trigger name="trigger_recalc_po_totals" table="po_lines" events="INSERT, UPDATE, DELETE">
        <description>Recalculates PO subtotal, tax_amount, total when lines change</description>
        <function>recalculate_po_totals()</function>
      </trigger>
    </triggers>

    <api_endpoints>
      <endpoint method="GET" path="/api/planning/purchase-orders/:id/lines">
        <description>List all lines for a PO</description>
        <response>POLine[] with product joined</response>
      </endpoint>
      <endpoint method="POST" path="/api/planning/purchase-orders/:id/lines">
        <description>Add line to PO</description>
        <request_body>{ product_id, quantity, unit_price, discount_percent?, expected_delivery_date? }</request_body>
        <response>POLine with calculated amounts</response>
      </endpoint>
      <endpoint method="PUT" path="/api/planning/purchase-orders/:id/lines/:lineId">
        <description>Update PO line</description>
        <request_body>{ quantity?, unit_price?, discount_percent?, expected_delivery_date? }</request_body>
      </endpoint>
      <endpoint method="DELETE" path="/api/planning/purchase-orders/:id/lines/:lineId">
        <description>Delete PO line and re-sequence remaining</description>
      </endpoint>
    </api_endpoints>

    <components_to_create>
      <component name="POLinesTable" path="components/planning/"/>
      <component name="POLineFormModal" path="components/planning/"/>
    </components_to_create>

    <calculation_logic>
      <formula name="line_subtotal">quantity * unit_price</formula>
      <formula name="discount_amount">line_subtotal * (discount_percent / 100)</formula>
      <formula name="line_total">line_subtotal - discount_amount</formula>
      <formula name="tax_amount">line_total * (tax_rate / 100)</formula>
      <formula name="line_total_with_tax">line_total + tax_amount</formula>
    </calculation_logic>
  </technical_context>

  <acceptance_criteria>
    <criterion id="AC-2.1">Add PO Line - Modal with product, quantity, unit_price, discount, date</criterion>
    <criterion id="AC-2.2">PO Lines Table - Columns: Seq, Product, Qty, UoM, Price, Discount, Totals; Footer with sums</criterion>
    <criterion id="AC-2.3">Edit PO Line - Can edit qty/price/discount; cannot edit product</criterion>
    <criterion id="AC-2.4">Delete PO Line - Re-sequence remaining lines</criterion>
    <criterion id="AC-2.5">Tax Calculation - From supplier.tax_code_id</criterion>
    <criterion id="AC-2.6">PO Totals Trigger - Database trigger recalculates instantly</criterion>
    <criterion id="AC-2.7">Unit Price Pre-fill - From supplier_products or product default</criterion>
    <criterion id="AC-2.8">Validation - qty > 0, price >= 0, discount 0-100</criterion>
  </acceptance_criteria>

  <validation_rules>
    <rule field="product_id" type="required">Must be valid UUID</rule>
    <rule field="quantity" type="positive">Must be greater than 0</rule>
    <rule field="unit_price" type="min" value="0">Must be >= 0</rule>
    <rule field="discount_percent" type="range" min="0" max="100">Percentage 0-100</rule>
  </validation_rules>

  <test_plan>
    <unit_tests>
      <test>Line calculation - subtotal, discount, tax, total</test>
      <test>Tax rate lookup from supplier.tax_code_id</test>
      <test>Unit price pre-fill logic</test>
    </unit_tests>
    <integration_tests>
      <test>Create line - PO totals recalculated via trigger</test>
      <test>Update line - PO totals updated</test>
      <test>Delete line - PO totals updated, re-sequence</test>
      <test>Status check - blocked if PO closed/receiving</test>
    </integration_tests>
    <e2e_tests>
      <test>Add multiple lines to PO</test>
      <test>Edit line - verify totals update</test>
      <test>Delete line - verify totals and sequence</test>
    </e2e_tests>
  </test_plan>

  <implementation_notes>
    <note type="critical">Use database trigger for totals - no API roundtrip</note>
    <note type="critical">Product cannot be changed after line creation</note>
    <note type="important">Tax rate from supplier.tax_code_id - fixed per PO</note>
    <note type="future">received_qty updated in Epic 5</note>
  </implementation_notes>
</story-context>
