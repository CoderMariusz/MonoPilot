<?xml version="1.0" encoding="UTF-8"?>
<story>
  <metadata>
    <id>5.36</id>
    <title>Scanner Offline Queue Management</title>
    <batch>5C-3</batch>
    <points>13</points>
    <effort_hours>36-45</effort_hours>
    <status>todo</status>
    <sprint>0</sprint>
    <gap>Gap 5</gap>
  </metadata>

  <description>PWA offline queue with IndexedDB persistence, automatic sync on reconnection, failure handling, and multi-user isolation for warehouse dock operations</description>

  <dependencies>
    <requires>
      <story id="5.23">Scanner Guided Workflows</story>
      <story id="5.31">Warehouse Settings Configuration</story>
      <story id="5.11">GRN and LP Creation</story>
      <story id="4.7">WO Material Consumption</story>
      <story id="5.14">LP Location Move</story>
      <story id="5.5">LP Split</story>
      <story id="5.35">Inventory Count</story>
    </requires>
    <enables>
      <note>Final story for Epic 5 - Warehouse &amp; Scanner module complete</note>
    </enables>
  </dependencies>

  <technical_context>
    <database>
      <storage type="IndexedDB">
        <description>Browser local storage for offline operations</description>
        <stores>
          <store name="scanner_offline_queue_{org_id}_{user_id}">
            <field name="id" type="UUID"/>
            <field name="operation_type" type="enum" constraint="receive|consume|output|move|split|count"/>
            <field name="payload" type="object"/>
            <field name="performed_at" type="ISO8601"/>
            <field name="synced_at" type="ISO8601" nullable="true"/>
            <field name="retry_count" type="int"/>
            <field name="user_id" type="UUID"/>
            <field name="org_id" type="UUID"/>
            <indexes>
              <index name="performed_at"/>
              <index name="operation_type"/>
            </indexes>
          </store>
          <store name="scanner_failed_queue_{org_id}_{user_id}">
            <field name="id" type="UUID"/>
            <field name="operation" type="object"/>
            <field name="error_message" type="string"/>
            <field name="failed_at" type="ISO8601"/>
            <field name="retry_attempts" type="int"/>
          </store>
        </stores>
      </storage>

      <table name="warehouse_settings">
        <columns_to_add>
          <column name="max_offline_operations" type="INT" constraint="DEFAULT 100, CHECK (50-500)"/>
          <column name="offline_warning_threshold_pct" type="INT" constraint="DEFAULT 80, CHECK (50-90)"/>
          <column name="auto_sync_on_reconnect" type="BOOLEAN" constraint="DEFAULT true"/>
          <column name="sync_batch_size" type="INT" constraint="DEFAULT 10, CHECK (5-50)"/>
          <column name="failed_queue_retention_days" type="INT" constraint="DEFAULT 7, CHECK (1-30)"/>
        </columns_to_add>
      </table>

      <optional_table name="scanner_sync_logs">
        <description>Audit trail for offline queue syncs</description>
        <columns>
          <column name="id" type="UUID" constraint="PK"/>
          <column name="org_id" type="UUID" constraint="FK organizations(id)"/>
          <column name="user_id" type="UUID" constraint="FK users(id)"/>
          <column name="sync_started_at" type="TIMESTAMP"/>
          <column name="sync_completed_at" type="TIMESTAMP"/>
          <column name="operations_queued" type="INT"/>
          <column name="operations_synced" type="INT"/>
          <column name="operations_failed" type="INT"/>
          <column name="status" type="VARCHAR(20)" constraint="success|partial|failed"/>
        </columns>
      </optional_table>
    </database>

    <api_endpoints>
      <endpoint method="POST" path="/api/scanner/sync-offline-queue">
        <description>Bulk sync offline operations with retry logic</description>
        <auth>authenticated</auth>
        <request>
          <field name="operations" type="array" constraint="max 10 items">
            <item>
              <field name="id" type="UUID"/>
              <field name="operation_type" type="string"/>
              <field name="payload" type="object"/>
              <field name="performed_at" type="ISO8601"/>
            </item>
          </field>
        </request>
        <response status="200">
          <field name="synced_count" type="int"/>
          <field name="failed_count" type="int"/>
          <field name="failed_operations" type="array">
            <item>
              <field name="id" type="UUID"/>
              <field name="error" type="string"/>
            </item>
          </field>
        </response>
        <strategy>
          <batching>10 operations per request</batching>
          <retry>3 attempts with exponential backoff (2s, 4s, 8s)</retry>
          <failure_handling>Move to failed queue, continue with next batch</failure_handling>
        </strategy>
      </endpoint>

      <endpoint method="GET" path="/api/scanner/settings/offline">
        <description>Get offline queue settings for client caching</description>
        <auth>authenticated</auth>
        <response status="200">
          <field name="max_offline_operations" type="int"/>
          <field name="offline_warning_threshold_pct" type="int"/>
          <field name="auto_sync_on_reconnect" type="boolean"/>
          <field name="sync_batch_size" type="int"/>
          <field name="failed_queue_retention_days" type="int"/>
        </response>
      </endpoint>
    </api_endpoints>

    <services>
      <service name="IndexedDBService">
        <description>Manage IndexedDB stores for offline queue and failed queue</description>
        <methods>
          <method name="addOperation" params="operation: OfflineOperation" return="Promise&lt;void&gt;"/>
          <method name="getQueue" params="" return="Promise&lt;OfflineOperation[]&gt;"/>
          <method name="removeOperation" params="id: UUID" return="Promise&lt;void&gt;"/>
          <method name="clearQueue" params="" return="Promise&lt;void&gt;"/>
          <method name="addFailedOperation" params="operation, error" return="Promise&lt;void&gt;"/>
          <method name="getFailedQueue" params="" return="Promise&lt;FailedOperation[]&gt;"/>
          <method name="discardFailedOperation" params="id: UUID" return="Promise&lt;void&gt;"/>
        </methods>
      </service>

      <service name="SyncEngine">
        <description>Orchestrate offline queue sync with batching and retry logic</description>
        <methods>
          <method name="syncOfflineQueue" params="" return="Promise&lt;SyncResult&gt;">
            <flow>
              1. Load queue from IndexedDB
              2. Batch into groups of 10
              3. Send each batch via POST /api/scanner/sync-offline-queue
              4. Handle responses (success/failure)
              5. Move failures to failed queue
              6. Clear synced operations
              7. Update UI with progress
            </flow>
          </method>
          <method name="manualSync" params="" return="Promise&lt;void&gt;">
            <description>User-triggered sync (same logic as automatic)</description>
          </method>
        </methods>
        <retry_strategy>
          <max_retries>3</max_retries>
          <backoff>exponential: 2s, 4s, 8s</backoff>
          <on_failure>mark batch as failed, continue with next</on_failure>
        </retry_strategy>
      </service>

      <service name="NetworkMonitor">
        <description>Monitor network connectivity and trigger sync</description>
        <methods>
          <method name="isOnline" return="boolean">
            <logic>navigator.onLine AND last_ping_success</logic>
          </method>
          <method name="startMonitoring" return="void">
            <listeners>
              window.addEventListener('online', onOnline)
              window.addEventListener('offline', onOffline)
              periodic ping every 30s
            </listeners>
          </method>
        </methods>
        <auto_sync>
          <trigger>When 'online' event fired OR ping succeeds</trigger>
          <delay>2 seconds (grace period)</delay>
        </auto_sync>
      </service>
    </services>

    <frontend_routes>
      <route path="/settings/scanner" method="GET" description="Scanner offline settings admin page"/>
    </frontend_routes>

    <components_to_create>
      <component name="OfflineQueueIndicator.tsx" path="src/components/warehouse/">
        <description>Status badges for network, queue, sync</description>
        <elements>
          <element name="network_badge">üî¥ Offline / üü¢ Online (top-right)</element>
          <element name="queue_counter">üì¶ Queue: 23 (top-center, if >0)</element>
          <element name="sync_status">‚è≥ Syncing... / ‚úÖ Synced (during sync)</element>
          <element name="warning_banner">80/100 queued at 80%</element>
          <element name="error_banner">Queue full at 100%</element>
        </elements>
      </component>

      <component name="OfflineQueueManager.tsx" path="src/components/warehouse/">
        <description>Main component managing queue state and integration</description>
        <responsibilities>
          <item>Load settings from warehouse_settings</item>
          <item>Manage IndexedDB queue</item>
          <item>Integrate NetworkMonitor</item>
          <item>Coordinate SyncEngine</item>
          <item>Display OfflineQueueIndicator</item>
        </responsibilities>
      </component>

      <component name="FailedQueueUI.tsx" path="src/components/warehouse/">
        <description>Display and manage failed operations</description>
        <displays>
          <item>List of failed operations with error details</item>
          <item>Operation type, timestamp, error message</item>
          <item>Actions: Retry, Discard</item>
          <item>Auto-purge indicator (7-day retention)</item>
        </displays>
      </component>

      <component name="ScannerOfflineSettings.tsx" path="src/components/settings/">
        <description>Admin interface for offline queue configuration</description>
        <fields>
          <field name="max_offline_operations" type="int" constraint="50-500"/>
          <field name="offline_warning_threshold_pct" type="int" constraint="50-90"/>
          <field name="auto_sync_on_reconnect" type="boolean"/>
          <field name="sync_batch_size" type="int" constraint="5-50"/>
          <field name="failed_queue_retention_days" type="int" constraint="1-30"/>
        </fields>
      </component>
    </components_to_create>

    <hooks_to_create>
      <hook name="useOfflineQueue" path="src/hooks/">
        <signature>useOfflineQueue()</signature>
        <return>{queueCount: number, isOnline: boolean, isSyncing: boolean, syncProgress?: {current, total}, failedQueue: FailedOperation[]}</return>
      </hook>

      <hook name="useNetworkMonitor" path="src/hooks/">
        <signature>useNetworkMonitor()</signature>
        <return>{isOnline: boolean, lastPingTime: Date}</return>
      </hook>
    </hooks_to_create>
  </technical_context>

  <acceptance_criteria>
    <criterion id="AC1">Operations stored in IndexedDB, max 100 with 80/100 warning and block</criterion>
    <criterion id="AC2">Network status, queue counter, sync indicator badges display correctly</criterion>
    <criterion id="AC3">Auto-sync starts within 2 seconds of reconnection, FIFO order, batch 10 ops per request</criterion>
    <criterion id="AC4">Failed operations moved to separate queue, sync continues with remaining</criterion>
    <criterion id="AC5">Manual "Sync Now" button available, disabled during sync</criterion>
    <criterion id="AC6">Queue persists across app restart, FIFO order maintained</criterion>
    <criterion id="AC7">performed_at and synced_at timestamps recorded and audited correctly</criterion>
    <criterion id="AC8">Multi-user queue isolation with per-user IndexedDB stores</criterion>
    <criterion id="AC9">Offline queue settings configurable in /settings/scanner by admin</criterion>
    <criterion id="AC10">E2E: 100 operations queued offline ‚Üí reconnect ‚Üí all synced in &lt;30 seconds with 100% success</criterion>
  </acceptance_criteria>

  <test_plan>
    <unit_tests>
      <test name="Queue add/remove/clear operations"/>
      <test name="Capacity validation (max 100)"/>
      <test name="Warning/error threshold checks (80%, 100%)"/>
      <test name="FIFO queue ordering"/>
      <test name="Retry logic with exponential backoff"/>
      <test name="Failed queue operations"/>
      <test name="Multi-user queue isolation"/>
    </unit_tests>
    <integration_tests>
      <test name="Offline operation ‚Üí IndexedDB stored"/>
      <test name="Network reconnect ‚Üí auto-sync triggered within 2s"/>
      <test name="Sync progress updates correctly"/>
      <test name="Failed operations moved to failed queue"/>
      <test name="Queue persistence across app restart"/>
      <test name="Multi-user isolation verified"/>
      <test name="Timestamps preserved (performed_at vs synced_at)"/>
    </integration_tests>
    <e2e_tests>
      <test name="Full offline‚Üíonline workflow (AC 10): 100 operations queued, reconnect, all synced &lt;30s"/>
      <test name="Failure handling with partial success"/>
      <test name="Manual sync trigger and progress display"/>
      <test name="Settings configuration in /settings/scanner"/>
      <test name="Failed queue UI with retry/discard actions"/>
    </e2e_tests>
  </test_plan>

  <performance_targets>
    <target metric="Max queue operations">100</target>
    <target metric="Sync time for 100 operations">&lt;30 seconds</target>
    <target metric="Auto-sync delay">&lt;2 seconds after reconnect</target>
    <target metric="Operations per batch">10</target>
    <target metric="Manual sync response">&lt;5 seconds</target>
    <target metric="Failed queue retention">7 days</target>
  </performance_targets>

  <implementation_notes>
    <note priority="critical">100 ops in &lt;30s is hard requirement for dock productivity</note>
    <note priority="critical">Multi-user isolation essential for shared scanner devices</note>
    <note priority="critical">Timestamps must be accurate (performed_at) for audit compliance</note>
    <note priority="high">Never queue sensitive data (auth, passwords)</note>
    <note priority="high">Real-time queue counter and progress updates critical for UX</note>
    <note priority="medium">Consider Service Worker for background sync (future enhancement)</note>
    <note priority="medium">Monitor IndexedDB storage quota (typically 50MB+)</note>
  </implementation_notes>

  <references>
    <reference type="gap">Sprint 0 Gap 5: Scanner Offline Queue Management</reference>
    <reference type="docs">docs/readiness-assessment/3-gaps-and-risks.md</reference>
    <reference type="mdn">https://developer.mozilla.org/en-US/docs/Web/API/IndexedDB_API</reference>
    <reference type="pwa">https://web.dev/offline-fallback-page/</reference>
  </references>
</story>
