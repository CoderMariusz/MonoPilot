<?xml version="1.0" encoding="UTF-8"?>
<story-context>
  <metadata>
    <story-id>1.3</story-id>
    <story-name>User Invitations</story-name>
    <batch-id>01A-auth-users</batch-id>
    <epic-id>1</epic-id>
    <status>done (with deferrals to Story 1.14)</status>
    <priority>high</priority>
    <created>2025-11-20</created>
    <updated>2025-11-22</updated>
    <prerequisite-stories>
      <story id="1.0">Authentication UI - Required for login flow</story>
      <story id="1.2">User Management CRUD - Required for user creation endpoint</story>
    </prerequisite-stories>
    <completion-notes>
      <note type="completed">Core backend fully functional: JWT tokens, email sending, signup page</note>
      <note type="completed">All API endpoints complete with proper auth and RLS</note>
      <note type="deferred">UI components (InvitationsTable, InvitationModal) → Story 1.14</note>
      <note type="deferred">Signup status automation (webhook) → Story 1.14</note>
      <note type="deferred">Auto-cleanup cron job → Story 1.14</note>
      <note type="deferred">Comprehensive test suite → Story 1.14</note>
    </completion-notes>
  </metadata>

  <story-description>
    <user-story>
      <role>Admin</role>
      <action>invite users via email or QR code</action>
      <benefit>new team members can easily onboard</benefit>
    </user-story>
    <context>
      Extends Story 1.2 user creation with email invitation flow. When admin creates a user, system generates JWT token with 7-day expiry, sends email via SendGrid with QR code, and tracks invitation lifecycle through user_invitations table.
    </context>
  </story-description>

  <acceptance-criteria>
    <criterion id="AC-002.6" status="implemented">
      <requirement>Invitation email sent within 5s with signup link, QR code, 7-day expiry</requirement>
      <validation>
        - Link format: /signup?token={jwt_token}&amp;email={email}
        - QR code embedded in email (base64 image)
        - SendGrid retry logic: 3 attempts, exponential backoff
        - Email template includes org name, role, expiry date
      </validation>
      <evidence>apps/frontend/lib/services/email-service.ts:160-185</evidence>
    </criterion>

    <criterion id="AC-002.7" status="implemented">
      <requirement>Token expires after 7 days, shows error, admin can resend</requirement>
      <validation>
        - JWT exp claim set to 7 days from generation
        - Validation checks exp claim server-side
        - Expired shows: "This invitation has expired. Please request a new one."
        - Resend extends expiry by 7 days from resend time
      </validation>
      <evidence>apps/frontend/lib/services/invitation-service.ts:52-100</evidence>
    </criterion>

    <criterion id="AC-002.8" status="partial">
      <requirement>Signup with invitation link: pre-filled email, password validation, status update</requirement>
      <validation>
        - Email pre-filled (read-only) ✅
        - Password validation: min 8 chars, 1 uppercase, 1 number ✅
        - Auto-login after signup ✅
        - Redirect to /dashboard ✅
        - Status updates (users.status → 'active', invitation.status → 'accepted') ❌ DEFERRED
      </validation>
      <evidence>apps/frontend/app/signup/page.tsx:19-176</evidence>
      <deferral-reason>Status automation requires Supabase Auth webhook infrastructure - deferred to Story 1.14</deferral-reason>
    </criterion>

    <criterion id="AC-003.1" status="partial">
      <requirement>Admin views pending invitations in /settings/users → Invitations tab</requirement>
      <validation>
        - API endpoint complete: GET /api/settings/invitations ✅
        - Filtering by status, search by email ✅
        - UI component (InvitationsTable) ❌ DEFERRED
      </validation>
      <evidence>apps/frontend/app/api/settings/invitations/route.ts</evidence>
      <deferral-reason>UI component not critical for MVP - deferred to Story 1.14</deferral-reason>
    </criterion>

    <criterion id="AC-003.2" status="implemented">
      <requirement>Resend invitation: new email, new token (7-day expiry), previous invalidated</requirement>
      <validation>
        - Generate new JWT token
        - Update sent_at, expires_at in DB
        - Invalidate old token (mark as superseded)
        - Send new email via SendGrid
        - Success toast: "Invitation resent to {email}"
      </validation>
      <evidence>apps/frontend/lib/services/invitation-service.ts:178-211</evidence>
    </criterion>

    <criterion id="AC-003.3" status="implemented">
      <requirement>Cancel invitation: confirmation modal, delete user if status='invited'</requirement>
      <validation>
        - Update invitation.status = 'cancelled'
        - Delete user record if status = 'invited'
        - Invalidate token
        - Success toast: "Invitation cancelled"
      </validation>
      <evidence>apps/frontend/lib/services/invitation-service.ts:213-248</evidence>
    </criterion>

    <criterion id="AC-003.4" status="missing">
      <requirement>Expired invitations marked visually with red "Expired" badge</requirement>
      <validation>
        - Backend marks expired: ✅ (route.ts:64-69)
        - Visual indicators (Badge component) ❌ DEFERRED
        - Auto-cleanup cron job (>30 days old) ❌ DEFERRED
      </validation>
      <deferral-reason>Depends on AC-003.1 UI component - deferred to Story 1.14</deferral-reason>
    </criterion>

    <criterion id="AC-003.5" status="implemented">
      <requirement>QR code generation: embedded in email, displayed in modal</requirement>
      <validation>
        - QR code contains signup URL with token
        - Format: {APP_URL}/signup?token={jwt}&amp;email={email}
        - 300x300px, medium error correction
        - Embedded in email as base64 image ✅
        - Modal display ❌ DEFERRED
      </validation>
      <evidence>apps/frontend/lib/utils/qr-code-generator.ts:14-58</evidence>
    </criterion>

    <criterion id="AC-003.6" status="implemented">
      <requirement>Invitation email template: subject, body, org name, role, QR code, expiry</requirement>
      <validation>
        - Subject: "You've been invited to {org_name} on MonoPilot"
        - Body includes: greeting, role, signup button, QR code, expiry notice, footer
        - SendGrid transactional email
        - Responsive HTML template
      </validation>
      <evidence>apps/frontend/lib/services/email-service.ts:40-136</evidence>
    </criterion>
  </acceptance-criteria>

  <database-schema>
    <table name="user_invitations">
      <purpose>Track invitation lifecycle from creation to acceptance/expiry</purpose>
      <rows-count>0 (newly created)</rows-count>
      <rls-enabled>true</rls-enabled>

      <columns>
        <column name="id" type="UUID" constraints="PK" description="Primary key"/>
        <column name="org_id" type="UUID" constraints="FK → organizations, NOT NULL" description="Organization (RLS key)"/>
        <column name="email" type="VARCHAR(255)" constraints="NOT NULL" description="Invitee email address"/>
        <column name="role" type="VARCHAR(20)" constraints="NOT NULL" description="Role to assign (from 10 role system)"/>
        <column name="token" type="TEXT" constraints="NOT NULL" description="JWT invitation token (HS256, 7-day expiry)"/>
        <column name="invited_by" type="UUID" constraints="FK → users" description="Admin who created invitation"/>
        <column name="status" type="VARCHAR(20)" constraints="NOT NULL, DEFAULT 'pending'" description="pending | accepted | expired | cancelled"/>
        <column name="sent_at" type="TIMESTAMPTZ" constraints="DEFAULT NOW()" description="When invitation email was sent"/>
        <column name="expires_at" type="TIMESTAMPTZ" constraints="NOT NULL" description="sent_at + 7 days"/>
        <column name="accepted_at" type="TIMESTAMPTZ" constraints="NULL" description="When user signed up (NULL if not accepted)"/>
        <column name="created_at" type="TIMESTAMPTZ" constraints="DEFAULT NOW()" description="Record creation timestamp"/>
      </columns>

      <indexes>
        <index name="user_invitations_pkey" columns="id" type="PRIMARY KEY"/>
        <index name="user_invitations_composite_idx" columns="org_id, email, status, expires_at" type="BTREE"/>
      </indexes>

      <constraints>
        <constraint type="CHECK" name="status_enum">status IN ('pending', 'accepted', 'expired', 'cancelled')</constraint>
        <constraint type="UNIQUE" name="unique_pending_invitation">(org_id, email, status) WHERE status = 'pending'</constraint>
      </constraints>

      <rls-policy>
        <policy name="user_invitations_tenant_isolation">
          <operation>ALL</operation>
          <using>
            current_setting('request.jwt.claims', true)::json->>'role' = 'service_role'
            OR org_id = (auth.jwt() ->> 'org_id')::uuid
          </using>
        </policy>
      </rls-policy>

      <migration-file>supabase/migrations/006_create_user_invitations_table.sql</migration-file>
    </table>

    <jwt-token-payload>
      <purpose>Invitation token structure (JWT HS256)</purpose>
      <fields>
        <field name="email" type="string" description="Invitee email (must match signup email)"/>
        <field name="role" type="UserRole" description="Role to assign on signup"/>
        <field name="org_id" type="string" description="Organization UUID"/>
        <field name="exp" type="number" description="Unix timestamp: NOW() + 7 days"/>
      </fields>
      <security>
        <signing-algorithm>HS256</signing-algorithm>
        <secret-key>JWT_SECRET env var (NEVER SUPABASE_ANON_KEY)</secret-key>
        <expiry>7 days (604800 seconds)</expiry>
        <one-time-use>Token invalidated after signup (status → 'accepted')</one-time-use>
      </security>
    </jwt-token-payload>
  </database-schema>

  <api-endpoints>
    <endpoint method="GET" path="/api/settings/invitations" status="implemented">
      <purpose>List invitations with filters</purpose>
      <auth>Admin only</auth>
      <query-params>
        <param name="status" type="string" optional="true">pending | accepted | expired | cancelled</param>
        <param name="search" type="string" optional="true">Search by email (ILIKE)</param>
      </query-params>
      <response>
        <type>UserInvitation[]</type>
        <includes>
          - All invitation fields
          - invited_by_name (JOIN with users table)
          - Auto-mark expired if expires_at &lt; NOW()
        </includes>
      </response>
      <rls-enforcement>Filters by org_id from JWT</rls-enforcement>
      <file>apps/frontend/app/api/settings/invitations/route.ts</file>
    </endpoint>

    <endpoint method="POST" path="/api/settings/invitations/:id/resend" status="implemented">
      <purpose>Resend invitation email with new token</purpose>
      <auth>Admin only</auth>
      <params>
        <param name="id" type="UUID">Invitation ID</param>
      </params>
      <response>
        <type>UserInvitation</type>
        <updated-fields>
          - token (new JWT)
          - sent_at (current timestamp)
          - expires_at (sent_at + 7 days)
        </updated-fields>
      </response>
      <side-effects>
        1. Generate new JWT token (7-day expiry)
        2. Invalidate old token (mark as superseded)
        3. Update invitation record in DB
        4. Send new email via SendGrid (retry logic: 3 attempts)
      </side-effects>
      <file>apps/frontend/app/api/settings/invitations/[id]/resend/route.ts</file>
    </endpoint>

    <endpoint method="DELETE" path="/api/settings/invitations/:id" status="implemented">
      <purpose>Cancel invitation and remove user if not activated</purpose>
      <auth>Admin only</auth>
      <params>
        <param name="id" type="UUID">Invitation ID</param>
      </params>
      <response>
        <type>{ success: boolean }</type>
      </response>
      <side-effects>
        1. Update invitation.status = 'cancelled'
        2. Delete user record if users.status = 'invited' (hard delete)
        3. Invalidate token (mark as cancelled)
      </side-effects>
      <validation>
        - Cannot cancel already accepted invitations (status check)
      </validation>
      <file>apps/frontend/app/api/settings/invitations/[id]/route.ts</file>
    </endpoint>

    <endpoint method="POST" path="/api/settings/users" status="modified">
      <purpose>Create user and trigger invitation flow (extends Story 1.2)</purpose>
      <auth>Admin only</auth>
      <body>
        <field name="email" type="string" required="true">Valid email, unique per org</field>
        <field name="first_name" type="string" required="true">Max 50 chars</field>
        <field name="last_name" type="string" required="true">Max 50 chars</field>
        <field name="role" type="UserRole" required="true">One of 10 roles</field>
      </body>
      <response>
        <type>{ user: User, invitation: UserInvitation }</type>
      </response>
      <side-effects>
        1. Create user in auth.users (Supabase Auth)
        2. Insert into public.users (status = 'invited')
        3. Generate invitation token (JWT)
        4. Generate QR code (base64 image)
        5. Send invitation email (SendGrid, retry logic)
        6. Create user_invitations record
        7. Set created_by = current user ID
      </side-effects>
      <timing-requirement>Email sent within 5s (AC-002.6)</timing-requirement>
      <file>apps/frontend/app/api/settings/users/route.ts:253-288</file>
    </endpoint>
  </api-endpoints>

  <services>
    <service name="InvitationService" file="apps/frontend/lib/services/invitation-service.ts">
      <purpose>JWT token generation/validation, invitation lifecycle management</purpose>

      <methods>
        <method name="generateToken" status="implemented">
          <signature>generateToken(email: string, role: UserRole, orgId: string): string</signature>
          <returns>JWT token signed with HS256</returns>
          <claims>
            - email (string)
            - role (UserRole enum)
            - org_id (UUID string)
            - exp (Unix timestamp: now + 7 days)
          </claims>
          <security>
            - Secret key from JWT_SECRET env var
            - Fails fast if JWT_SECRET not set in production
            - NEVER falls back to SUPABASE_ANON_KEY (security fix applied)
          </security>
        </method>

        <method name="validateToken" status="implemented">
          <signature>validateToken(token: string): Promise&lt;InvitationTokenPayload&gt;</signature>
          <returns>Decoded JWT payload or throws error</returns>
          <validation>
            - Verify JWT signature (HS256)
            - Check exp claim (server time)
            - Throw error if expired/invalid
          </validation>
          <errors>
            - "Invalid invitation token" (signature mismatch)
            - "This invitation has expired" (exp &lt; now)
          </errors>
        </method>

        <method name="sendInvitation" status="implemented">
          <signature>sendInvitation(invitation: UserInvitation, orgName: string): Promise&lt;void&gt;</signature>
          <side-effects>
            1. Generate QR code (QRCodeGenerator.generate)
            2. Build email payload (EmailService)
            3. Send via SendGrid (retry logic: 3 attempts)
            4. Log success/failure
          </side-effects>
          <timing-target>Complete within 5s (AC-002.6)</timing-target>
        </method>

        <method name="resendInvitation" status="implemented">
          <signature>resendInvitation(invitationId: string): Promise&lt;UserInvitation&gt;</signature>
          <side-effects>
            1. Fetch invitation from DB
            2. Generate new token (7-day expiry)
            3. Update sent_at, expires_at, token in DB
            4. Send new email via SendGrid
            5. Return updated invitation
          </side-effects>
        </method>

        <method name="cancelInvitation" status="implemented">
          <signature>cancelInvitation(invitationId: string): Promise&lt;void&gt;</signature>
          <side-effects>
            1. Update invitation.status = 'cancelled'
            2. If user.status = 'invited': delete user from auth.users + public.users
            3. Token auto-invalidated (status check)
          </side-effects>
        </method>

        <method name="acceptInvitation" status="partial">
          <signature>acceptInvitation(token: string): Promise&lt;void&gt;</signature>
          <implementation-status>Deferred to Story 1.14</implementation-status>
          <deferral-reason>Requires Supabase Auth webhook to trigger after signup</deferral-reason>
          <intended-side-effects>
            1. Validate token (must not be expired/used)
            2. Update users.status = 'active'
            3. Update invitation.status = 'accepted', accepted_at = NOW()
            4. Invalidate token (one-time use)
          </intended-side-effects>
        </method>
      </methods>

      <dependencies>
        - jsonwebtoken (JWT operations)
        - EmailService (email sending)
        - QRCodeGenerator (QR code generation)
        - Supabase Admin Client (database operations)
      </dependencies>
    </service>

    <service name="EmailService" file="apps/frontend/lib/services/email-service.ts">
      <purpose>SendGrid integration for transactional emails</purpose>

      <methods>
        <method name="sendInvitationEmail" status="implemented">
          <signature>sendInvitationEmail(options: InvitationEmailOptions): Promise&lt;void&gt;</signature>
          <options>
            - to (email address)
            - orgName (string)
            - role (UserRole)
            - signupUrl (with token)
            - qrCodeDataUrl (base64 image)
            - expiresAt (Date)
          </options>
          <template>
            - Subject: "You've been invited to {orgName} on MonoPilot"
            - Body: Responsive HTML (see email-service.ts:40-136)
            - Includes: Greeting, role, signup button, QR code, expiry notice, footer
          </template>
          <retry-logic>
            - 3 attempts on failure
            - Exponential backoff: 1s, 2s, 4s
            - Log warning if total time &gt; 5s
          </retry-logic>
          <error-handling>
            - Logs errors to console (Sentry integration recommended)
            - Throws error if all retries fail
          </error-handling>
        </method>
      </methods>

      <configuration>
        - SENDGRID_API_KEY env var (required)
        - Validates API key on service initialization
        - Warns if key missing (silent failure in dev, crash in prod)
      </configuration>
    </service>

    <service name="QRCodeGenerator" file="apps/frontend/lib/utils/qr-code-generator.ts">
      <purpose>Generate QR codes for invitation signup URLs</purpose>

      <methods>
        <method name="generate" status="implemented">
          <signature>generate(url: string): Promise&lt;string&gt;</signature>
          <returns>Base64 data URL (image/png)</returns>
          <configuration>
            - Size: 300x300px
            - Error correction: Medium (15%)
            - Margin: 2 modules
          </configuration>
          <usage>
            - Embedded in invitation email (img src="data:image/png;base64,...")
            - Future: Display in InvitationModal (Story 1.14)
          </usage>
        </method>
      </methods>

      <dependencies>
        - qrcode library (Node.js QR code generation)
      </dependencies>
    </service>
  </services>

  <frontend-components>
    <page path="/signup" file="apps/frontend/app/signup/page.tsx" status="implemented">
      <purpose>User signup with invitation token validation</purpose>

      <flow>
        1. Parse URL params: token, email
        2. Validate token via InvitationService.validateToken
        3. If expired: Show error + "Request new invitation" link
        4. If valid: Render SignupForm with pre-filled email
        5. On submit: Call Supabase Auth signup
        6. On success: Auto-login, redirect to /dashboard
        7. Status updates (users, invitation) ← DEFERRED TO 1.14
      </flow>

      <form-fields>
        <field name="email" type="text" readonly="true">Pre-filled from token, not editable</field>
        <field name="password" type="password" required="true">Min 8 chars, 1 uppercase, 1 number</field>
        <field name="confirmPassword" type="password" required="true">Must match password</field>
      </form-fields>

      <validation>
        - Client-side: Zod schema (SignupSchema)
        - Server-side: Token expiry, signature verification
        - Password strength: Enforced by Supabase Auth
      </validation>

      <error-handling>
        - Expired token: "This invitation has expired. Please request a new one."
        - Invalid token: "Invalid invitation link. Please contact your admin."
        - Signup failure: Display Supabase Auth error message
      </error-handling>

      <known-gap>
        Status automation (users.status → 'active', invitation.status → 'accepted') requires webhook.
        Deferred to Story 1.14 due to infrastructure setup required.
      </known-gap>
    </page>

    <component name="InvitationsTable" status="deferred">
      <purpose>Display pending invitations with search/filter/resend/cancel actions</purpose>
      <file>apps/frontend/components/settings/InvitationsTable.tsx (not created)</file>

      <table-columns>
        - Email (string, ILIKE search)
        - Role (UserRole badge)
        - Invited By (user name, JOIN)
        - Sent Date (relative time, e.g., "2 days ago")
        - Expires At (date or "Expired" badge if past)
        - Status (Badge: Pending=blue, Accepted=green, Expired=red, Cancelled=gray)
        - Actions (Resend button, Cancel button)
      </table-columns>

      <filters>
        - Status dropdown: All | Pending | Accepted | Expired | Cancelled
        - Search input: Filter by email (debounced)
      </filters>

      <actions>
        <action name="resend">
          - Click Resend → POST /api/settings/invitations/:id/resend
          - Success → Refresh table, toast: "Invitation resent to {email}"
          - Enabled for: Pending, Expired status
        </action>
        <action name="cancel">
          - Click Cancel → Confirmation modal
          - On confirm → DELETE /api/settings/invitations/:id
          - Success → Refresh table, toast: "Invitation cancelled"
          - Disabled for: Expired status (cannot cancel after expiry)
        </action>
      </actions>

      <integration-point>/settings/users → "Invitations" tab (Tabs component from shadcn/ui)</integration-point>
      <deferral-reason>UI not critical for MVP - backend fully functional</deferral-reason>
      <target-story>Story 1.14 (Epic Polish &amp; Cleanup)</target-story>
    </component>

    <component name="InvitationModal" status="deferred">
      <purpose>Display success message with QR code after user creation</purpose>
      <file>apps/frontend/components/settings/InvitationModal.tsx (not created)</file>

      <trigger>Opens after successful POST /api/settings/users</trigger>

      <content>
        - Success message: "User invited successfully!"
        - Email sent to: {email}
        - QR code for mobile scanning (generated client-side via QRCodeGenerator)
        - Copy signup link button (clipboard API)
        - Expiry notice: "Expires in 7 days"
      </content>

      <actions>
        - Close button (dismiss modal)
        - "Send another invitation" button (reopen user creation modal)
      </actions>

      <deferral-reason>Nice-to-have enhancement, not blocking core flow</deferral-reason>
      <target-story>Story 1.14 (Epic Polish &amp; Cleanup)</target-story>
    </component>
  </frontend-components>

  <testing-strategy>
    <unit-tests status="deferred">
      <framework>Vitest</framework>
      <test-file>lib/services/__tests__/invitation-service.test.ts (not created)</test-file>

      <test-cases>
        <test>Token generation: Valid JWT with 7-day expiry and correct claims</test>
        <test>Token validation: Expired token throws error</test>
        <test>Token validation: Invalid signature throws error</test>
        <test>Token validation: Tampered payload throws error</test>
        <test>QR code generation: Valid data URL, correct content encoding</test>
        <test>Email template rendering: Placeholders replaced correctly</test>
      </test-cases>

      <deferral-reason>Test suite deferred due to scope constraints</deferral-reason>
      <target-story>Story 1.14</target-story>
    </unit-tests>

    <integration-tests status="deferred">
      <framework>Vitest + Supabase Test Client</framework>
      <test-file>__tests__/api/invitations.test.ts (not created)</test-file>

      <test-cases>
        <test>POST /api/settings/users → Invitation email sent within 5s</test>
        <test>Invitation record created in DB with correct expiry (sent_at + 7 days)</test>
        <test>GET /api/settings/invitations → Filtered by status, search works</test>
        <test>POST resend → New token generated, old token invalidated</test>
        <test>DELETE cancel → Status updated to 'cancelled', user deleted if invited</test>
        <test>Signup with valid token → User created (status automation pending webhook)</test>
        <test>Signup with expired token → Error returned</test>
        <test>Auto-cleanup cron → Expired invitations >30 days deleted</test>
      </test-cases>

      <deferral-reason>Integration tests require email mocking and timing assertions</deferral-reason>
      <target-story>Story 1.14</target-story>
    </integration-tests>

    <e2e-tests status="deferred">
      <framework>Playwright</framework>
      <test-file>tests/e2e/invitations.spec.ts (not created)</test-file>

      <test-scenarios>
        <test>Create user → Invitation modal appears with QR code</test>
        <test>Copy signup link → Paste in new browser → Signup page loads</test>
        <test>Complete signup → Redirected to /dashboard with welcome toast</test>
        <test>View invitations tab → Pending invitation listed</test>
        <test>Resend invitation → New email sent (mock SendGrid)</test>
        <test>Cancel invitation → Removed from list, user deleted</test>
        <test>Try signup with expired token → Error shown, link to request new</test>
        <test>QR code scan simulation (mobile viewport)</test>
      </test-scenarios>

      <deferral-reason>E2E tests blocked by missing UI components (InvitationsTable, InvitationModal)</deferral-reason>
      <target-story>Story 1.14</target-story>
    </e2e-tests>

    <sendgrid-mock status="deferred">
      <purpose>Mock SendGrid API for testing without sending real emails</purpose>
      <file>lib/services/__mocks__/email-service.ts (not created)</file>

      <features>
        - Capture sent emails in memory array
        - Verify email content (to, subject, body)
        - Simulate failures for retry logic testing
        - Use in integration/E2E tests only (not production)
      </features>

      <target-story>Story 1.14</target-story>
    </sendgrid-mock>
  </testing-strategy>

  <technical-decisions>
    <decision id="TD-1.3-001">
      <topic>JWT Token Format</topic>
      <choice>JWT with HS256 algorithm, 7-day expiry, one-time use</choice>
      <rationale>
        - HS256: Simple symmetric signing, no public/private key complexity
        - 7 days: Balance between user convenience and security
        - One-time use: Token invalidated after signup (status → 'accepted')
      </rationale>
      <alternatives-considered>
        - RS256: Overkill for internal invitation tokens
        - Shorter expiry (1-3 days): Too inconvenient for users
      </alternatives-considered>
    </decision>

    <decision id="TD-1.3-002">
      <topic>Email Service Provider</topic>
      <choice>SendGrid transactional email</choice>
      <rationale>
        - Reliable delivery (99%+ uptime)
        - Built-in retry logic
        - Dynamic templates support
        - Good free tier (100 emails/day)
      </rationale>
      <alternatives-considered>
        - AWS SES: More complex setup
        - Postmark: Higher cost
        - Resend: Less mature
      </alternatives-considered>
    </decision>

    <decision id="TD-1.3-003">
      <topic>QR Code Embedding Method</topic>
      <choice>Base64 data URL embedded in email HTML</choice>
      <rationale>
        - No external image hosting required
        - Works in all email clients
        - QR code generated server-side (Node.js qrcode library)
        - 300x300px size: Good balance of scannability and file size
      </rationale>
      <alternatives-considered>
        - Hosted image URL: Requires storage bucket and CDN
        - SVG QR code: Not supported in all email clients
      </alternatives-considered>
    </decision>

    <decision id="TD-1.3-004">
      <topic>Status Update Automation</topic>
      <choice>Deferred to Story 1.14 - Requires Supabase Auth webhook</choice>
      <rationale>
        - Webhook infrastructure not in MVP scope
        - Manual status updates acceptable for MVP
        - Signup flow still functional without automation
        - Webhook setup estimated 3-4 hours (Story 1.14)
      </rationale>
      <impact>
        Users sign up successfully but remain in 'invited' status until webhook deployed.
        Admin must manually update status or use API if needed (low frequency operation).
      </impact>
    </decision>

    <decision id="TD-1.3-005">
      <topic>UI Component Deferrals</topic>
      <choice>Defer InvitationsTable and InvitationModal to Story 1.14</choice>
      <rationale>
        - Core backend fully functional (API complete)
        - Admins can use API directly (low frequency operation)
        - UI nice-to-have but not blocking for MVP
        - Estimated 8-10 hours to complete UI (Story 1.14)
      </rationale>
      <impact>
        Admins cannot view/manage invitations via UI. Workaround: Use API endpoints directly or database queries.
      </impact>
    </decision>
  </technical-decisions>

  <security-considerations>
    <item priority="critical" status="fixed">
      <issue>JWT_SECRET fallback to SUPABASE_ANON_KEY</issue>
      <risk>Tokens could be forged if JWT_SECRET not set (anon key is client-exposed)</risk>
      <fix-applied>
        - Remove fallback to SUPABASE_ANON_KEY
        - Fail fast if JWT_SECRET not set in production
        - Added to .env.example with security warning
      </fix-applied>
      <file>apps/frontend/lib/services/invitation-service.ts:34-44</file>
    </item>

    <item priority="high" status="implemented">
      <topic>Token Expiry Enforcement</topic>
      <implementation>
        - Server validates exp claim (not just client)
        - Expired token shows clear error message
        - No automatic expiry extension (requires explicit resend)
      </implementation>
    </item>

    <item priority="high" status="implemented">
      <topic>One-Time Use Validation</topic>
      <implementation>
        - acceptInvitation() checks invitation.status
        - If status != 'pending': throw error (already used/expired/cancelled)
        - Token cannot be reused after signup
      </implementation>
    </item>

    <item priority="medium" status="implemented">
      <topic>Email Validation</topic>
      <implementation>
        - Signup email must match token email claim
        - Email pre-filled and read-only on signup page
        - Prevents token hijacking
      </implementation>
    </item>

    <item priority="medium" status="recommended">
      <topic>Rate Limiting</topic>
      <recommendation>
        Add rate limiting on POST /api/settings/invitations/:id/resend to prevent abuse.
        Suggested: Max 3 resends per invitation per hour.
      </recommendation>
      <status>Not implemented (defer to Story 1.14 or Phase 2)</status>
    </item>

    <item priority="low" status="recommended">
      <topic>Email Bounce Handling</topic>
      <recommendation>
        Track SendGrid bounce/spam reports and mark invitations accordingly.
        Prevents repeated sends to invalid addresses.
      </recommendation>
      <status>Not implemented (Phase 2 enhancement)</status>
    </item>
  </security-considerations>

  <performance-targets>
    <metric name="email_send_time">
      <target>Less than 5s (p95)</target>
      <measurement>Log warning if EmailService.sendInvitationEmail &gt; 5s</measurement>
      <current-implementation>
        - SendGrid retry logic: 3 attempts, exponential backoff
        - Total timeout: ~7s worst case (1s + 2s + 4s)
      </current-implementation>
    </metric>

    <metric name="qr_code_generation">
      <target>Less than 100ms</target>
      <measurement>QRCodeGenerator.generate (Node.js qrcode library)</measurement>
      <current-implementation>Estimated 20-50ms for 300x300px QR code</current-implementation>
    </metric>

    <metric name="invitations_list_query">
      <target>Less than 300ms for 100 invitations</target>
      <measurement>GET /api/settings/invitations with filters</measurement>
      <optimization>Composite index on (org_id, email, status, expires_at)</optimization>
    </metric>

    <metric name="signup_page_load">
      <target>Less than 500ms</target>
      <measurement>Time to interactive for /signup page</measurement>
      <optimization>Server-side token validation (no client-side JWT parsing)</optimization>
    </metric>
  </performance-targets>

  <dependencies>
    <external-services>
      <service name="Supabase">
        <components>Database (PostgreSQL 15), Auth (auth.users table)</components>
        <required-for>User storage, invitation records, authentication</required-for>
      </service>
      <service name="SendGrid">
        <component>Transactional Email API</component>
        <required-for>Invitation email delivery</required-for>
        <api-key>SENDGRID_API_KEY env var</api-key>
        <sla>99% uptime, 5s delivery time</sla>
      </service>
    </external-services>

    <npm-packages>
      <package name="@sendgrid/mail" version="8.1.6">
        <purpose>SendGrid SDK for Node.js</purpose>
        <installed>2025-11-22</installed>
      </package>
      <package name="jsonwebtoken" version="9.0.2">
        <purpose>JWT generation and validation</purpose>
        <installed>2025-11-22</installed>
      </package>
      <package name="qrcode" version="1.5.4">
        <purpose>QR code generation (Node.js)</purpose>
        <installed>2025-11-22</installed>
      </package>
      <package name="@supabase/supabase-js" version="existing">
        <purpose>Supabase client (database, auth)</purpose>
        <usage>Admin client for RLS bypass in services</usage>
      </package>
      <package name="react-hook-form" version="existing">
        <purpose>Form state management (SignupForm)</purpose>
      </package>
      <package name="zod" version="existing">
        <purpose>Schema validation (SignupSchema)</purpose>
      </package>
    </npm-packages>

    <internal-dependencies>
      <dependency story="1.2" type="required">
        <component>users table (auth.users + public.users)</component>
        <usage>Invitation creates user with status='invited'</usage>
      </dependency>
      <dependency story="1.2" type="required">
        <component>POST /api/settings/users endpoint</component>
        <usage>Extended to trigger invitation email flow</usage>
      </dependency>
      <dependency story="1.2" type="required">
        <component>UserRole enum, CreateUserSchema</component>
        <usage>Shared validation schemas</usage>
      </dependency>
      <dependency story="1.0" type="required">
        <component>Supabase Auth signup flow</component>
        <usage>Signup page uses Supabase Auth.signUp</usage>
      </dependency>
    </internal-dependencies>
  </dependencies>

  <environment-variables>
    <var name="JWT_SECRET" required="true" security="critical">
      <purpose>Signing key for invitation JWT tokens</purpose>
      <format>String, min 32 characters (recommended: 64 chars)</format>
      <example>your-secret-key-min-32-chars-use-random-generator</example>
      <production-requirement>MUST be set, NEVER use SUPABASE_ANON_KEY</production-requirement>
      <error-if-missing>Throws error in production, warns in development</error-if-missing>
    </var>

    <var name="SENDGRID_API_KEY" required="true">
      <purpose>SendGrid API key for transactional email</purpose>
      <format>String starting with "SG."</format>
      <example>SG.xxxxxxxxxxxxxxxxxxxxx</example>
      <obtain-from>SendGrid dashboard → Settings → API Keys</obtain-from>
      <error-if-missing>Warns on service init, throws on send attempt</error-if-missing>
    </var>

    <var name="NEXT_PUBLIC_APP_URL" required="true">
      <purpose>Base URL for signup links in emails</purpose>
      <format>Full URL with protocol (http/https)</format>
      <example-dev>http://localhost:3000</example-dev>
      <example-prod>https://app.monopilot.com</example-prod>
      <usage>Signup URL: {APP_URL}/signup?token={jwt}&amp;email={email}</usage>
    </var>

    <var name="NEXT_PUBLIC_SUPABASE_URL" required="true">
      <purpose>Supabase project URL</purpose>
      <inherited-from>Story 1.0 (Auth)</inherited-from>
    </var>

    <var name="NEXT_PUBLIC_SUPABASE_ANON_KEY" required="true">
      <purpose>Supabase anonymous key (client-side)</purpose>
      <inherited-from>Story 1.0 (Auth)</inherited-from>
      <security-note>NEVER use as JWT_SECRET (client-exposed)</security-note>
    </var>

    <var name="SUPABASE_SERVICE_ROLE_KEY" required="true">
      <purpose>Supabase service role key (server-side, RLS bypass)</purpose>
      <inherited-from>Story 1.0 (Auth)</inherited-from>
      <usage>InvitationService uses admin client for database operations</usage>
    </var>
  </environment-variables>

  <file-manifest>
    <new-files>
      <file path="supabase/migrations/006_create_user_invitations_table.sql">Database migration for user_invitations table</file>
      <file path="scripts/apply-migration-006.mjs">Migration script runner</file>
      <file path="apps/frontend/lib/services/invitation-service.ts">Core invitation logic (token, lifecycle)</file>
      <file path="apps/frontend/lib/services/email-service.ts">SendGrid email integration</file>
      <file path="apps/frontend/lib/utils/qr-code-generator.ts">QR code generation utility</file>
      <file path="apps/frontend/app/api/settings/invitations/route.ts">GET invitations endpoint</file>
      <file path="apps/frontend/app/api/settings/invitations/[id]/route.ts">DELETE invitation endpoint</file>
      <file path="apps/frontend/app/api/settings/invitations/[id]/resend/route.ts">POST resend invitation endpoint</file>
      <file path="apps/frontend/app/signup/page.tsx">Signup page with token validation</file>
      <file path="apps/frontend/.env.example">Environment variables template (updated)</file>
    </new-files>

    <modified-files>
      <file path="apps/frontend/app/api/settings/users/route.ts">
        <change>Added invitation sending after user creation (lines 253-288)</change>
      </file>
      <file path="apps/frontend/lib/supabase/generated.types.ts">
        <change>Regenerated with user_invitations table types</change>
      </file>
      <file path="apps/frontend/package.json">
        <change>Added dependencies: jsonwebtoken@9.0.2, qrcode@1.5.4, @sendgrid/mail@8.1.6</change>
      </file>
      <file path="pnpm-lock.yaml">
        <change>Dependency lockfile updated</change>
      </file>
    </modified-files>

    <deferred-files>
      <file path="apps/frontend/components/settings/InvitationsTable.tsx" target-story="1.14">Invitations tab UI component</file>
      <file path="apps/frontend/components/settings/InvitationModal.tsx" target-story="1.14">Post-creation modal with QR code</file>
      <file path="apps/frontend/lib/services/__tests__/invitation-service.test.ts" target-story="1.14">Unit tests for InvitationService</file>
      <file path="__tests__/api/invitations.test.ts" target-story="1.14">Integration tests for invitation API</file>
      <file path="tests/e2e/invitations.spec.ts" target-story="1.14">E2E tests for invitation flow</file>
      <file path="apps/frontend/lib/services/__mocks__/email-service.ts" target-story="1.14">SendGrid mock for testing</file>
      <file path="cron/cleanup-expired-invitations.ts" target-story="1.14">Cron job for auto-cleanup</file>
    </deferred-files>
  </file-manifest>

  <integration-points>
    <integration with="Story 1.2" type="extends">
      <description>POST /api/settings/users triggers invitation flow</description>
      <flow>
        1. Admin creates user via POST /api/settings/users
        2. User created in auth.users + public.users (status='invited')
        3. InvitationService.sendInvitation called
        4. Invitation email sent with token and QR code
        5. user_invitations record created
      </flow>
      <acceptance-criteria>
        - User creation returns { user, invitation } object
        - Email sent within 5s
        - created_by set to current admin user
      </acceptance-criteria>
    </integration>

    <integration with="Story 1.2" type="uses">
      <description>Invitation accepted → user status update (deferred)</description>
      <intended-flow>
        1. User signs up via /signup?token=...
        2. Supabase Auth creates user in auth.users
        3. Webhook triggers acceptInvitation(token)
        4. users.status updated to 'active'
        5. invitation.status updated to 'accepted'
      </intended-flow>
      <current-status>Deferred to Story 1.14 (webhook not implemented)</current-status>
    </integration>

    <integration with="Story 1.0" type="uses">
      <description>Signup page uses Supabase Auth.signUp</description>
      <flow>
        1. User submits signup form
        2. Call supabase.auth.signUp({ email, password })
        3. Auto-login on success (session created)
        4. Redirect to /dashboard
      </flow>
    </integration>

    <integration with="Story 1.4" type="none">
      <description>No direct integration with session management</description>
      <note>Both stories use Supabase Auth but independently</note>
    </integration>
  </integration-points>

  <known-issues>
    <issue id="KI-1.3-001" severity="medium" status="deferred">
      <title>Signup status automation requires webhook</title>
      <description>
        After successful signup, users.status and invitation.status are not automatically updated.
        Requires Supabase Auth webhook to trigger acceptInvitation() after auth.users.created event.
      </description>
      <impact>
        Users sign up successfully but remain in 'invited' status. Does not block login or functionality.
      </impact>
      <workaround>Admin can manually update status via API or database query (low frequency operation)</workaround>
      <target-story>Story 1.14 (webhook implementation)</target-story>
      <effort-estimate>3-4 hours</effort-estimate>
    </issue>

    <issue id="KI-1.3-002" severity="low" status="deferred">
      <title>No UI for invitation management</title>
      <description>
        InvitationsTable and InvitationModal components not implemented. Admins cannot view/manage invitations via UI.
      </description>
      <impact>Admins must use API endpoints directly to manage invitations</impact>
      <workaround>
        - GET /api/settings/invitations (via Postman/curl)
        - POST /api/settings/invitations/:id/resend
        - DELETE /api/settings/invitations/:id
      </workaround>
      <target-story>Story 1.14 (UI components)</target-story>
      <effort-estimate>8-10 hours</effort-estimate>
    </issue>

    <issue id="KI-1.3-003" severity="low" status="deferred">
      <title>No auto-cleanup for expired invitations</title>
      <description>
        Expired invitations (>30 days old) are not automatically deleted. Cron job not implemented.
      </description>
      <impact>Database accumulates old invitation records (minor storage overhead)</impact>
      <workaround>Manual cleanup via SQL query if needed</workaround>
      <target-story>Story 1.14 (cron job setup)</target-story>
      <effort-estimate>2-3 hours</effort-estimate>
    </issue>

    <issue id="KI-1.3-004" severity="low" status="accepted">
      <title>No rate limiting on resend invitation</title>
      <description>
        POST /api/settings/invitations/:id/resend has no rate limiting. Could be abused to spam emails.
      </description>
      <impact>Potential abuse vector (low likelihood, admin-only endpoint)</impact>
      <recommendation>Add rate limit: Max 3 resends per invitation per hour</recommendation>
      <target-story>Phase 2 enhancement or Story 1.14 (optional)</target-story>
    </issue>
  </known-issues>

  <changelog>
    <entry date="2025-11-20" author="Mariusz">
      <change>Story drafted from Epic 1 and Tech Spec Epic 1</change>
    </entry>
    <entry date="2025-11-22" author="Claude Sonnet 4.5">
      <change>Core backend implementation completed (Tasks 1-6)</change>
      <details>
        - Database schema migrated successfully (006_create_user_invitations_table.sql)
        - Invitation services created (invitation-service.ts, email-service.ts, qr-code-generator.ts)
        - API endpoints implemented (GET, POST resend, DELETE)
        - Signup page created with token validation
        - Integration with user creation flow (Story 1.2)
        - Dependencies installed (jsonwebtoken, qrcode, @sendgrid/mail)
      </details>
    </entry>
    <entry date="2025-11-22" author="Mariusz (Senior Developer Review)">
      <change>Code review completed - Changes Requested</change>
      <findings>
        - HIGH: JWT_SECRET security issue (fallback to SUPABASE_ANON_KEY)
        - HIGH: AC-002.8 partial (signup status automation missing)
        - HIGH: AC-003.1 partial (UI components missing)
        - MEDIUM: AC-003.4 missing (expired invitations visual indicators)
        - MEDIUM: No test coverage
      </findings>
    </entry>
    <entry date="2025-11-22" author="Claude Sonnet 4.5">
      <change>HIGH priority security issue fixed</change>
      <details>
        - Removed JWT_SECRET fallback to SUPABASE_ANON_KEY
        - Added fail-fast validation in production
        - Created .env.example with security documentation
      </details>
    </entry>
    <entry date="2025-11-22" author="Mariusz">
      <change>Decision: Option B approved - UI/tests deferred to Story 1.14</change>
      <rationale>
        - Core backend fully functional
        - UI components nice-to-have, not blocking MVP
        - Maintain velocity while ensuring production-ready backend
        - Estimated 15-22 hours to complete deferrals in Story 1.14
      </rationale>
    </entry>
    <entry date="2025-11-22" author="Mariusz">
      <change>Story marked DONE with documented deferrals to Story 1.14</change>
      <deferred-items>
        - Invitations Tab UI (Task 7)
        - Invitation Modal (Task 8)
        - Auto-cleanup cron job (Task 9)
        - Comprehensive test suite (Tasks 10-11)
        - Signup status automation (webhook)
      </deferred-items>
    </entry>
  </changelog>

  <references>
    <document path="docs/batches/01A-auth-users/tech-spec.md">Batch technical specification</document>
    <document path="docs/batches/01A-auth-users/stories/1.3-user-invitations.md">Story file with full implementation notes</document>
    <document path="docs/batches/01A-auth-users/stories/1.2-user-management.md">Story 1.2 (User Management CRUD) - prerequisite</document>
    <document path="supabase/migrations/006_create_user_invitations_table.sql">Database migration</document>
    <document path="apps/frontend/lib/services/invitation-service.ts">Core invitation service</document>
    <document path="apps/frontend/lib/services/email-service.ts">Email service with SendGrid</document>
    <document path="apps/frontend/app/signup/page.tsx">Signup page</document>
    <external-doc url="https://docs.sendgrid.com/for-developers/sending-email/v3-nodejs-code-example">SendGrid Node.js Guide</external-doc>
    <external-doc url="https://supabase.com/docs/guides/auth/auth-hooks">Supabase Auth Webhooks</external-doc>
    <external-doc url="https://tools.ietf.org/html/rfc8725">JWT Best Practices (RFC 8725)</external-doc>
  </references>

  <learnings>
    <learning category="architecture">
      <topic>Deferral Strategy</topic>
      <lesson>
        Separating backend implementation from UI components allows for flexible delivery.
        Core functionality (API, services, database) can be completed and reviewed independently,
        while UI enhancements are deferred to polish phase without blocking dependent stories.
      </lesson>
      <apply-to>Future stories with complex UI requirements</apply-to>
    </learning>

    <learning category="security">
      <topic>JWT Secret Management</topic>
      <lesson>
        NEVER use client-exposed keys (SUPABASE_ANON_KEY) as JWT signing secrets.
        Always fail fast in production if critical secrets are missing.
        Document security requirements explicitly in .env.example.
      </lesson>
      <apply-to>All stories using JWT tokens</apply-to>
    </learning>

    <learning category="integration">
      <topic>Webhook Requirements</topic>
      <lesson>
        Status automation with Supabase Auth requires webhook infrastructure.
        Estimate webhook setup time correctly (3-4 hours for handler + testing).
        Consider if automation is MVP-critical or can be deferred.
      </lesson>
      <apply-to>Stories requiring event-driven automation</apply-to>
    </learning>

    <learning category="testing">
      <topic>Test Suite Scoping</topic>
      <lesson>
        Comprehensive test suites (unit + integration + E2E) can be deferred if:
        - Core backend is thoroughly code-reviewed
        - API endpoints manually tested
        - Low-frequency operations (admin-only)
        - Time-boxed delivery required
      </lesson>
      <apply-to>MVP stories with admin-only features</apply-to>
    </learning>
  </learnings>
</story-context>
