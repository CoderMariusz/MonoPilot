name: TypeScript Validation

on:
  push:
    branches: [main, develop]
    paths:
      - 'apps/frontend/**/*.ts'
      - 'apps/frontend/**/*.tsx'
      - 'apps/frontend/tsconfig.json'
      - 'package.json'
      - 'pnpm-lock.yaml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'apps/frontend/**/*.ts'
      - 'apps/frontend/**/*.tsx'
      - 'apps/frontend/tsconfig.json'
  workflow_dispatch:
    inputs:
      output_mode:
        description: 'Output mode for type-check monitor'
        required: false
        default: 'ci'
        type: choice
        options:
          - ci
          - full
          - summary
      enforcement_mode:
        description: 'Enforcement mode override'
        required: false
        default: 'warn'
        type: choice
        options:
          - warn
          - prevent-regression
          - strict

env:
  # Default enforcement mode - Phase 1: Warning Only
  # Change to 'prevent-regression' for Phase 2, 'strict' for Phase 3
  ENFORCEMENT_MODE: ${{ github.event.inputs.enforcement_mode || 'warn' }}
  BASELINE_ERRORS: 298
  STRICT_MODE_THRESHOLD: 50

jobs:
  typecheck:
    name: TypeScript Type Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8.15.0

      - name: Get pnpm store directory
        id: pnpm-cache
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

      - name: Setup pnpm cache
        uses: actions/cache@v3
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run TypeScript Monitor
        id: typecheck
        run: |
          chmod +x scripts/type-check-monitor.sh
          OUTPUT_MODE="${{ github.event.inputs.output_mode || 'ci' }}"

          # Run type-check and capture exit code
          set +e
          ./scripts/type-check-monitor.sh "$OUTPUT_MODE"
          TSC_EXIT=$?
          set -e

          # Extract error count from cache
          CACHE_DIR="apps/frontend/.type-check-cache"
          ERROR_COUNT=0

          if [ -f "$CACHE_DIR/error-trends.json" ]; then
            LAST_LINE=$(tail -1 "$CACHE_DIR/error-trends.json" 2>/dev/null || echo "")
            if [ -n "$LAST_LINE" ]; then
              ERROR_COUNT=$(echo "$LAST_LINE" | grep -o '"total":[0-9]*' | cut -d: -f2 | head -1 || echo "0")
            fi
          fi

          echo "error_count=$ERROR_COUNT" >> $GITHUB_OUTPUT
          echo "tsc_exit=$TSC_EXIT" >> $GITHUB_OUTPUT

          # Report counts
          echo ""
          echo "============================================"
          echo "TypeScript Error Summary"
          echo "============================================"
          echo "Current Errors: $ERROR_COUNT"
          echo "Baseline: $BASELINE_ERRORS"
          echo "Enforcement Mode: $ENFORCEMENT_MODE"
          echo "============================================"

      - name: Check Enforcement Policy
        id: enforcement
        env:
          ERROR_COUNT: ${{ steps.typecheck.outputs.error_count }}
          TSC_EXIT: ${{ steps.typecheck.outputs.tsc_exit }}
        run: |
          echo ""
          echo "============================================"
          echo "Enforcement Policy Check"
          echo "============================================"

          SHOULD_FAIL=false
          MESSAGE=""

          case "$ENFORCEMENT_MODE" in
            warn)
              echo "Mode: WARNING ONLY (Phase 1)"
              echo "TypeScript errors are reported but do not block the build."
              echo ""
              if [ "$ERROR_COUNT" -gt 0 ]; then
                MESSAGE="[Warning] $ERROR_COUNT TypeScript errors found. Build NOT blocked (Phase 1: Warning Mode)."
                echo "::warning::$MESSAGE"
              fi
              ;;

            prevent-regression)
              echo "Mode: PREVENT REGRESSION (Phase 2)"
              echo "Build fails only if error count increased from baseline."
              echo ""
              if [ "$ERROR_COUNT" -gt "$BASELINE_ERRORS" ]; then
                INCREASE=$((ERROR_COUNT - BASELINE_ERRORS))
                MESSAGE="TypeScript error count increased by $INCREASE (from $BASELINE_ERRORS to $ERROR_COUNT)"
                echo "::error::$MESSAGE"
                SHOULD_FAIL=true
              elif [ "$ERROR_COUNT" -lt "$BASELINE_ERRORS" ]; then
                DECREASE=$((BASELINE_ERRORS - ERROR_COUNT))
                MESSAGE="TypeScript errors decreased by $DECREASE (from $BASELINE_ERRORS to $ERROR_COUNT)"
                echo "::notice::$MESSAGE"
              else
                MESSAGE="TypeScript error count unchanged at $ERROR_COUNT"
                echo "::notice::$MESSAGE"
              fi
              ;;

            strict)
              echo "Mode: STRICT (Phase 3)"
              echo "Build fails if any TypeScript errors exist."
              echo ""
              if [ "$ERROR_COUNT" -gt 0 ]; then
                MESSAGE="$ERROR_COUNT TypeScript errors found. Strict mode requires zero errors."
                echo "::error::$MESSAGE"
                SHOULD_FAIL=true
              else
                MESSAGE="Zero TypeScript errors - strict mode passed!"
                echo "::notice::$MESSAGE"
              fi
              ;;

            *)
              echo "Unknown enforcement mode: $ENFORCEMENT_MODE"
              echo "Defaulting to warning mode."
              ;;
          esac

          echo ""
          echo "should_fail=$SHOULD_FAIL" >> $GITHUB_OUTPUT
          echo "message=$MESSAGE" >> $GITHUB_OUTPUT

      - name: Upload error report
        if: steps.typecheck.outputs.tsc_exit != '0'
        uses: actions/upload-artifact@v3
        with:
          name: typescript-errors-${{ github.sha }}
          path: apps/frontend/.type-check-cache/categorized-*.json
          retention-days: 30

      - name: Comment PR with results
        if: github.event_name == 'pull_request' && steps.typecheck.outputs.error_count > 0
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            const errorCount = parseInt('${{ steps.typecheck.outputs.error_count }}') || 0;
            const baseline = parseInt('${{ env.BASELINE_ERRORS }}') || 298;
            const mode = '${{ env.ENFORCEMENT_MODE }}';
            const shouldFail = '${{ steps.enforcement.outputs.should_fail }}' === 'true';

            // Find latest categorized file
            const cacheDir = 'apps/frontend/.type-check-cache';
            let topCategories = 'Unable to determine';
            let topFiles = 'Unable to determine';

            if (fs.existsSync(cacheDir)) {
              const files = fs.readdirSync(cacheDir)
                .filter(f => f.startsWith('categorized-') && f.endsWith('.json'))
                .sort()
                .reverse();

              if (files.length > 0) {
                const latest = files[0];
                const filePath = path.join(cacheDir, latest);
                const errors = JSON.parse(fs.readFileSync(filePath, 'utf8'));

                if (errors.length > 0) {
                  // Get top categories
                  const categories = {};
                  errors.forEach(e => {
                    categories[e.category] = (categories[e.category] || 0) + 1;
                  });
                  topCategories = Object.entries(categories)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5)
                    .map(([cat, count]) => `- **${cat}**: ${count} errors`)
                    .join('\n');

                  // Get top files
                  const files_map = {};
                  errors.forEach(e => {
                    const shortFile = e.file.replace(/.*apps\/frontend\//, '');
                    files_map[shortFile] = (files_map[shortFile] || 0) + 1;
                  });
                  topFiles = Object.entries(files_map)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 10)
                    .map(([file, count]) => `- **${count}** errors in \`${file}\``)
                    .join('\n');
                }
              }
            }

            // Determine status emoji and message
            let statusEmoji = '';
            let statusMessage = '';
            let progressMessage = '';

            if (mode === 'warn') {
              statusEmoji = 'Warning';
              statusMessage = 'TypeScript Validation (Warning Mode - Phase 1)';
              progressMessage = '> **Note:** This check is in warning mode and does not block the PR. Errors are tracked for visibility.';
            } else if (mode === 'prevent-regression') {
              if (errorCount > baseline) {
                statusEmoji = 'Error';
                statusMessage = 'TypeScript Validation Failed - Errors Increased';
                progressMessage = `> **Error:** Error count increased from ${baseline} to ${errorCount}. Please fix the new errors.`;
              } else {
                statusEmoji = 'Warning';
                statusMessage = 'TypeScript Validation (Prevent Regression Mode - Phase 2)';
                progressMessage = `> **Note:** Error count has not increased. Current: ${errorCount}, Baseline: ${baseline}`;
              }
            } else {
              statusEmoji = shouldFail ? 'Error' : 'Success';
              statusMessage = shouldFail ? 'TypeScript Validation Failed' : 'TypeScript Validation Passed';
            }

            const changeIndicator = errorCount < baseline
              ? `(${baseline - errorCount} fixed since baseline)`
              : errorCount > baseline
                ? `(+${errorCount - baseline} since baseline)`
                : '(unchanged from baseline)';

            const body = `## ${statusEmoji} ${statusMessage}

            **Enforcement Mode:** ${mode}
            **Total Errors:** ${errorCount} ${changeIndicator}
            **Baseline:** ${baseline}

            ${progressMessage}

            ### Top Error Categories
            ${topCategories}

            ### Most Affected Files
            ${topFiles}

            ---
            **Local debugging:**
            - View summary: \`pnpm type-check:monitor\`
            - View full details: \`pnpm type-check:full\`
            - Check status: \`pnpm type-check:status\`

            **Detailed error report** has been uploaded as an artifact.
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Fail build if enforcement requires it
        if: steps.enforcement.outputs.should_fail == 'true'
        run: |
          echo "::error::${{ steps.enforcement.outputs.message }}"
          exit 1

      - name: Report success
        if: steps.enforcement.outputs.should_fail != 'true'
        run: |
          echo ""
          echo "============================================"
          echo "TypeScript Validation Complete"
          echo "============================================"
          echo "Mode: $ENFORCEMENT_MODE"
          echo "Errors: ${{ steps.typecheck.outputs.error_count }}"
          echo "Status: Passed (according to enforcement policy)"
          echo "============================================"
