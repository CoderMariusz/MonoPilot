{
  "response": "# SupplierProductService - RED Phase Tests\n\n```typescript\nimport { describe, it, expect, beforeEach, vi } from 'vitest';\nimport type { SupplierProduct } from '../types/supplier-product';\nimport type { SupplierProductCreateInput, SupplierProductUpdateInput } from '../types/supplier-product-input';\nimport type { SupplierProductFilter, SortBy } from '../types/supplier-product-filter';\n\n// Mock the database/repository layer\nconst mockSupplierProductRepository = {\n  create: vi.fn(),\n  findById: vi.fn(),\n  listBySupplier: vi.fn(),\n  listByProduct: vi.fn(),\n  update: vi.fn(),\n  delete: vi.fn(),\n  findBySupplierAndProduct: vi.fn(),\n  findCheapestSupplier: vi.fn(),\n  isUsedInActivePOs: vi.fn(),\n};\n\n// Import the service (will be implemented in GREEN phase)\nimport { SupplierProductService } from '../supplier-product-service';\n\ndescribe('SupplierProductService - RED Phase', () => {\n  let service: SupplierProductService;\n\n  beforeEach(() => {\n    // Clear all mocks before each test\n    vi.clearAllMocks();\n    \n    // Create a new instance of the service with mocked repository\n    service = new SupplierProductService(mockSupplierProductRepository as any);\n  });\n\n  describe('create', () => {\n    it('should fail when supplier_id is missing', async () => {\n      const input: SupplierProductCreateInput = {\n        product_id: 'product-1',\n        supplier_product_code: 'SUP-001',\n        supplier_price: 10.99,\n        currency: 'USD',\n        lead_time_days: 5,\n        min_order_qty: 1,\n      };\n\n      await expect(service.create(input)).rejects.toThrow();\n    });\n\n    it('should fail when product_id is missing', async () => {\n      const input: SupplierProductCreateInput = {\n        supplier_id: 'supplier-1',\n        supplier_product_code: 'SUP-001',\n        supplier_price: 10.99,\n        currency: 'USD',\n        lead_time_days: 5,\n        min_order_qty: 1,\n      };\n\n      await expect(service.create(input)).rejects.toThrow();\n    });\n\n    it('should fail when supplier_price is not positive', async () => {\n      const input: SupplierProductCreateInput = {\n        supplier_id: 'supplier-1',\n        product_id: 'product-1',\n        supplier_product_code: 'SUP-001',\n        supplier_price: -10.99,\n        currency: 'USD',\n        lead_time_days: 5,\n        min_order_qty: 1,\n      };\n\n      await expect(service.create(input)).rejects.toThrow();\n    });\n\n    it('should fail when lead_time_days is negative', async () => {\n      const input: SupplierProductCreateInput = {\n        supplier_id: 'supplier-1',\n        product_id: 'product-1',\n        supplier_product_code: 'SUP-001',\n        supplier_price: 10.99,\n        currency: 'USD',\n        lead_time_days: -5,\n        min_order_qty: 1,\n      };\n\n      await expect(service.create(input)).rejects.toThrow();\n    });\n\n    it('should fail when min_order_qty is negative', async () => {\n      const input: SupplierProductCreateInput = {\n        supplier_id: 'supplier-1',\n        product_id: 'product-1',\n        supplier_product_code: 'SUP-001',\n        supplier_price: 10.99,\n        currency: 'USD',\n        lead_time_days: 5,\n        min_order_qty: -1,\n      };\n\n      await expect(service.create(input)).rejects.toThrow();\n    });\n\n    it('should fail when supplier-product combination already exists', async () => {\n      const input: SupplierProductCreateInput = {\n        supplier_id: 'supplier-1',\n        product_id: 'product-1',\n        supplier_product_code: 'SUP-001',\n        supplier_price: 10.99,\n        currency: 'USD',\n        lead_time_days: 5,\n        min_order_qty: 1,\n      };\n\n      mockSupplierProductRepository.findBySupplierAndProduct.mockResolvedValue({\n        id: 'existing-id',\n        supplier_id: 'supplier-1',\n        product_id: 'product-1',\n        supplier_product_code: 'SUP-001',\n        supplier_price: 10.99,\n        currency: 'USD',\n        lead_time_days: 5,\n        min_order_qty: 1,\n        is_preferred: false,\n        created_at: new Date(),\n        updated_at: new Date(),\n        deleted_at: null,\n      });\n\n      await expect(service.create(input)).rejects.toThrow('Supplier-Product combination already exists');\n    });\n\n    it('should create a new supplier-product link successfully', async () => {\n      const input: SupplierProductCreateInput = {\n        supplier_id: 'supplier-1',\n        product_id: 'product-1',\n        supplier_product_code: 'SUP-001',\n        supplier_price: 10.99,\n        currency: 'USD',\n        lead_time_days: 5,\n        min_order_qty: 1,\n        is_preferred: true,\n      };\n\n      const expectedOutput: SupplierProduct = {\n        id: 'new-id',\n        supplier_id: 'supplier-1',\n        product_id: 'product-1',\n        supplier_product_code: 'SUP-001',\n        supplier_price: 10.99,\n        currency: 'USD',\n        lead_time_days: 5,\n        min_order_qty: 1,\n        is_preferred: true,\n        created_at: new Date(),\n        updated_at: new Date(),\n        deleted_at: null,\n      };\n\n      mockSupplierProductRepository.findBySupplierAndProduct.mockResolvedValue(null);\n      mockSupplierProductRepository.create.mockResolvedValue(expectedOutput);\n\n      const result = await service.create(input);\n\n      expect(result).toEqual(expectedOutput);\n      expect(mockSupplierProductRepository.create).toHaveBeenCalledWith(input);\n    });\n  });\n\n  describe('listBySupplier', () => {\n    it('should return empty array when no products found for supplier', async () => {\n      const supplierId = 'supplier-1';\n      const filters: SupplierProductFilter = {};\n\n      mockSupplierProductRepository.listBySupplier.mockResolvedValue([]);\n\n      const result = await service.listBySupplier(supplierId, filters);\n\n      expect(result).toEqual([]);\n      expect(mockSupplierProductRepository.listBySupplier).toHaveBeenCalledWith(supplierId, filters);\n    });\n\n    it('should return products for supplier with applied filters', async () => {\n      const supplierId = 'supplier-1';\n      const filters: SupplierProductFilter = {\n        is_preferred: true,\n        min_price: 5.0,\n        max_price: 20.0,\n      };\n\n      const mockProducts: SupplierProduct[] = [\n        {\n          id: 'sp-1',\n          supplier_id: 'supplier-1',\n          product_id: 'product-1',\n          supplier_product_code: 'SUP-001',\n          supplier_price: 10.99,\n          currency: 'USD',\n          lead_time_days: 5,\n          min_order_qty: 1,\n          is_preferred: true,\n          created_at: new Date(),\n          updated_at: new Date(),\n          deleted_at: null,\n        },\n      ];\n\n      mockSupplierProductRepository.listBySupplier.mockResolvedValue(mockProducts);\n\n      const result = await service.listBySupplier(supplierId, filters);\n\n      expect(result).toEqual(mockProducts);\n      expect(mockSupplierProductRepository.listBySupplier).toHaveBeenCalledWith(supplierId, filters);\n    });\n\n    it('should sort products by price in ascending order when sortBy is price_asc', async () => {\n      const supplierId = 'supplier-1';\n      const filters: SupplierProductFilter = {\n        sortBy: 'price_asc' as SortBy,\n      };\n\n      mockSupplierProductRepository.listBySupplier.mockResolvedValue([]);\n\n      await service.listBySupplier(supplierId, filters);\n\n      expect(mockSupplierProductRepository.listBySupplier).toHaveBeenCalledWith(supplierId, {\n        ...filters,\n        sortBy: 'price_asc',\n      });\n    });\n\n    it('should sort products by price in descending order when sortBy is price_desc', async () => {\n      const supplierId = 'supplier-1';\n      const filters: SupplierProductFilter = {\n        sortBy: 'price_desc' as SortBy,\n      };\n\n      mockSupplierProductRepository.listBySupplier.mockResolvedValue([]);\n\n      await service.listBySupplier(supplierId, filters);\n\n      expect(mockSupplierProductRepository.listBySupplier).toHaveBeenCalledWith(supplierId, {\n        ...filters,\n        sortBy: 'price_desc',\n      });\n    });\n  });\n\n  describe('listByProduct', () => {\n    it('should return empty array when no suppliers found for product', async () => {\n      const productId = 'product-1';\n\n      mockSupplierProductRepository.listByProduct.mockResolvedValue([]);\n\n      const result = await service.listByProduct(productId);\n\n      expect(result).toEqual([]);\n      expect(mockSupplierProductRepository.listByProduct).toHaveBeenCalledWith(productId);\n    });\n\n    it('should return all suppliers for a given product', async () => {\n      const productId = 'product-1';\n      const mockSuppliers: SupplierProduct[] = [\n        {\n          id: 'sp-1',\n          supplier_id: 'supplier-1',\n          product_id: 'product-1',\n          supplier_product_code: 'SUP-001',\n          supplier_price: 10.99,\n          currency: 'USD',\n          lead_time_days: 5,\n          min_order_qty: 1,\n          is_preferred: false,\n          created_at: new Date(),\n          updated_at: new Date(),\n          deleted_at: null,\n        },\n        {\n          id: 'sp-2',\n          supplier_id: 'supplier-2',\n          product_id: 'product-1',\n          supplier_product_code: 'SUP-002',\n          supplier_price: 9.99,\n          currency: 'USD',\n          lead_time_days: 3,\n          min_order_qty: 2,\n          is_preferred: true,\n          created_at: new Date(),\n          updated_at: new Date(),\n          deleted_at: null,\n        },\n      ];\n\n      mockSupplierProductRepository.listByProduct.mockResolvedValue(mockSuppliers);\n\n      const result = await service.listByProduct(productId);\n\n      expect(result).toEqual(mockSuppliers);\n      expect(mockSupplierProductRepository.listByProduct).toHaveBeenCalledWith(productId);\n    });\n  });\n\n  describe('update', () => {\n    it('should fail when trying to update supplier_id', async () => {\n      const id = 'sp-1';\n      const changes: SupplierProductUpdateInput = {\n        supplier_id: 'supplier-2', // This should not be allowed\n      };\n\n      await expect(service.update(id, changes)).rejects.toThrow('Cannot update supplier_id after creation');\n    });\n\n    it('should fail when trying to update product_id', async () => {\n      const id = 'sp-1';\n      const changes: SupplierProductUpdateInput = {\n        product_id: 'product-2', // This should not be allowed\n      };\n\n      await expect(service.update(id, changes)).rejects.toThrow('Cannot update product_id after creation');\n    });\n\n    it('should fail when supplier_price is not positive', async () => {\n      const id = 'sp-1';\n      const changes: SupplierProductUpdateInput = {\n        supplier_price: -10.99,\n      };\n\n      await expect(service.update(id, changes)).rejects.toThrow('Price must be positive');\n    });\n\n    it('should fail when lead_time_days is negative', async () => {\n      const id = 'sp-1';\n      const changes: SupplierProductUpdateInput = {\n        lead_time_days: -5,\n      };\n\n      await expect(service.update(id, changes)).rejects.toThrow('Lead time must be >= 0');\n    });\n\n    it('should fail when min_order_qty is negative', async () => {\n      const id = 'sp-1';\n      const changes: SupplierProductUpdateInput = {\n        min_order_qty: -1,\n      };\n\n      await expect(service.update(id, changes)).rejects.toThrow('Min order quantity must be >= 0');\n",
  "usage": {
    "completion_tokens": 2500,
    "prompt_tokens": 516,
    "total_tokens": 3016
  },
  "model": "glm-4-plus",
  "finish_reason": "length"
}