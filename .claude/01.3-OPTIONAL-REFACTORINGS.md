# Story 01.3: Optional Refactorings

This document provides ready-to-apply refactorings for minor code improvements. These are **optional** and maintain 100% backward compatibility.

## Refactoring Option 1: Extract Step Constants

**File**: `apps/frontend/lib/services/onboarding-service.ts`
**Impact**: Code maintenance improvement
**Complexity**: Very Low
**Test Impact**: None (constants don't affect logic)

### Changes Required

Add after imports (line 16):

```typescript
/**
 * Onboarding step range constants
 */
const STEP_RANGE = { MIN: 1, MAX: 6, FINAL: 6, INITIAL: 0 } as const
```

Then update 3 locations:

**Location 1**: Line 188-189 in `updateProgress()` method
```diff
- if (step < 1 || step > 6 || !Number.isInteger(step)) {
-   throw new Error('Invalid step number (must be 1-6)')
+ if (step < STEP_RANGE.MIN || step > STEP_RANGE.MAX || !Number.isInteger(step)) {
+   throw new Error(`Invalid step number (must be ${STEP_RANGE.MIN}-${STEP_RANGE.MAX})`)
```

**Location 2**: Line 147 in `skipWizard()` method
```diff
- onboarding_step: 6, // Set to final step
+ onboarding_step: STEP_RANGE.FINAL, // Set to final step
```

**Location 3**: Line 211 in `updateProgress()` method
```diff
- if (step === 6) {
+ if (step === STEP_RANGE.FINAL) {
```

### Also Update Progress Route

**File**: `apps/frontend/app/api/v1/settings/onboarding/progress/route.ts`

Add constant at top (after imports):
```typescript
const STEP_RANGE = { MIN: 1, MAX: 6 } as const
```

Update line 69:
```diff
- if (typeof step !== 'number' || step < 1 || step > 6) {
+ if (typeof step !== 'number' || step < STEP_RANGE.MIN || step > STEP_RANGE.MAX) {
```

## Refactoring Option 2: Extract Demo Data Constants

**File**: `apps/frontend/lib/services/onboarding-service.ts`
**Impact**: Single source of truth for demo data specs
**Complexity**: Very Low
**Test Impact**: None (constants don't affect logic)

### Changes Required

Add after STEP_RANGE constant (around line 19):

```typescript
/**
 * Demo data configuration
 */
const DEMO_DATA = {
  WAREHOUSE: {
    code: 'DEMO-WH',
    name: 'Main Warehouse',
    type: 'general',
  },
  LOCATION: {
    code: 'DEFAULT',
    name: 'Default Location',
    type: 'zone',
  },
  PRODUCT: {
    code: 'SAMPLE-001',
    name: 'Sample Product',
    uom: 'EA',
    status: 'active',
  },
} as const
```

Then update `createDemoData()` method:

**Location 1**: Lines 259-264 (warehouse creation)
```diff
  const { data: warehouse, error: warehouseError } = await supabase
    .from('warehouses')
    .insert({
      org_id: orgId,
-     code: 'DEMO-WH',
-     name: 'Main Warehouse',
-     type: 'general',
+     code: DEMO_DATA.WAREHOUSE.code,
+     name: DEMO_DATA.WAREHOUSE.name,
+     type: DEMO_DATA.WAREHOUSE.type,
      is_default: true,
      is_active: true,
    })
```

**Location 2**: Lines 277-282 (location creation)
```diff
  const { data: location, error: locationError } = await supabase
    .from('locations')
    .insert({
      org_id: orgId,
      warehouse_id: warehouse.id,
-     code: 'DEFAULT',
-     name: 'Default Location',
-     type: 'zone',
+     code: DEMO_DATA.LOCATION.code,
+     name: DEMO_DATA.LOCATION.name,
+     type: DEMO_DATA.LOCATION.type,
      is_active: true,
    })
```

**Location 3**: Lines 295-300 (product creation)
```diff
  const { data: product, error: productError } = await supabase
    .from('products')
    .insert({
      org_id: orgId,
-     code: 'SAMPLE-001',
-     name: 'Sample Product',
-     uom: 'EA',
-     status: 'active',
+     code: DEMO_DATA.PRODUCT.code,
+     name: DEMO_DATA.PRODUCT.name,
+     uom: DEMO_DATA.PRODUCT.uom,
+     status: DEMO_DATA.PRODUCT.status,
      is_active: true,
    })
```

## Refactoring Option 3: Improve Type Safety

**File**: `apps/frontend/lib/services/onboarding-service.ts`
**Impact**: Better type safety and IDE autocomplete
**Complexity**: Very Low
**Test Impact**: None (type-only change)

### Changes Required

Add new type definition after interfaces (around line 42):

```typescript
/**
 * Update data for organization onboarding fields
 */
interface OnboardingUpdateData {
  onboarding_step?: number
  onboarding_started_at?: string
  onboarding_completed_at?: string
  onboarding_skipped?: boolean
}
```

Then update `updateProgress()` method at line 201:

```diff
- const updateData: Record<string, any> = {
+ const updateData: OnboardingUpdateData = {
    onboarding_step: step,
  }
```

Also update skipWizard() method around line 144:

```diff
  const { error: updateError } = await supabase
    .from('organizations')
    .update({
+   // Type-safe: all fields are optional for partial updates
      onboarding_completed_at: new Date().toISOString(),
      onboarding_skipped: true,
      onboarding_step: STEP_RANGE.FINAL,
    })
```

## Refactoring Option 4: Extract Shared Org Context Logic

**Complexity**: MEDIUM (requires careful testing)
**Not Recommended**: API routes benefit from explicit, linear flow

Current pattern in all 3 routes:
```typescript
const userId = await deriveUserIdFromSession()
const context = await getOrgContext(userId)
```

### Why This Should NOT Be Refactored

1. **Explicitness**: API routes should be easy to follow step-by-step
2. **Error Boundaries**: Each route handles its own errors independently
3. **Debugging**: Stack traces are clearer with explicit flow
4. **No Performance Gain**: Negligible code reduction
5. **Architectural Pattern**: Matches other route handlers in codebase

**Recommendation**: SKIP this refactoring

## Suggested Refactoring Order (If Proceeding)

1. **First**: Option 3 (Type Safety) - Lowest risk, highest value
2. **Second**: Option 1 (Step Constants) - Used in 2 files
3. **Third**: Option 2 (Demo Data) - Self-contained, low risk

Each refactoring should be:
- Applied to one file at a time
- Tested (yarn test)
- Committed separately
- Verified with git diff

## Commit Messages (If Proceeding)

```
refactor(story-01.3): Extract onboarding step constants
- STEP_RANGE.MIN, STEP_RANGE.MAX, STEP_RANGE.FINAL
- Improves maintainability if step range changes
- No behavior changes

refactor(story-01.3): Extract demo data configuration constants
- Single source of truth for WAREHOUSE, LOCATION, PRODUCT specs
- Easier to update demo data in future
- No behavior changes

refactor(story-01.3): Improve type safety in onboarding updates
- OnboardingUpdateData interface for partial org updates
- Better IDE autocomplete and type checking
- No behavior changes
```

## Verification Checklist (If Proceeding)

After each refactoring:
- [ ] Code still compiles without errors: `yarn build`
- [ ] Tests still pass (or fail for same reason): `yarn test`
- [ ] Git diff shows only constants/type changes
- [ ] No function signatures changed
- [ ] No new dependencies added
- [ ] JSDoc comments still accurate

## Rollback

If any refactoring causes issues:
```bash
git checkout -- apps/frontend/lib/services/onboarding-service.ts
git checkout -- apps/frontend/app/api/v1/settings/onboarding/progress/route.ts
```

---

**Assessment**: All 3 refactorings are safe and low-risk. However, current code is production-ready without them.
